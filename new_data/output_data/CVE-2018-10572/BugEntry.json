{"buggy_code": ["<?php\n// This program is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License\n// as published by the Free Software Foundation; either version 2\n// of the License, or (at your option) any later version.\n\nrequire_once(dirname(__FILE__) . \"/../globals.php\");\nrequire_once $GLOBALS['OE_SITE_DIR'] . \"/config.php\";\n\n$content_type = \"text/plain\";\n$claim_file_dir = $GLOBALS['OE_SITE_DIR'] . \"/edi/\";\n\n$fname = $_GET['key'];\n$fname = preg_replace(\"[/]\", \"\", $fname);\n$fname = preg_replace(\"[\\.\\.]\", \"\", $fname);\n$fname = preg_replace(\"[\\\\\\\\]\", \"\", $fname);\n\nif (strtolower(substr($fname, (strlen($fname)-4))) == \".pdf\") {\n    $content_type = \"application/pdf\";\n}\n\n$fname = $claim_file_dir . $fname;\n\nif (!file_exists($fname)) {\n    echo xl(\"The claim file: \") . $_GET['key'] . xl(\" could not be accessed.\");\n} else {\n    $fp = fopen($fname, 'r');\n\n    header(\"Pragma: public\");\n    header(\"Expires: 0\");\n    header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n    header(\"Content-Type: $content_type\");\n    header(\"Content-Length: \" . filesize($fname));\n    header(\"Content-Disposition: attachment; filename=\" . basename($fname));\n\n    // dump the picture and stop the script\n    fpassthru($fp);\n}\n\nexit;\n", "<?php\n    // Copyright (C) 2006-2010 Rod Roark <rod@sunsetsystems.com>\n    //\n    // This program is free software; you can redistribute it and/or\n    // modify it under the terms of the GNU General Public License\n    // as published by the Free Software Foundation; either version 2\n    // of the License, or (at your option) any later version.\n\n    // This processes X12 835 remittances and produces a report.\n\n    // Buffer all output so we can archive it to a file.\n    ob_start();\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/invoice_summary.inc.php\");\nrequire_once(\"$srcdir/sl_eob.inc.php\");\nrequire_once(\"$srcdir/parse_era.inc.php\");\nrequire_once(\"claim_status_codes.php\");\nrequire_once(\"adjustment_reason_codes.php\");\nrequire_once(\"remark_codes.php\");\nrequire_once(\"$srcdir/billing.inc\");\n\n    $debug = $_GET['debug'] ? 1 : 0; // set to 1 for debugging mode\n    $paydate = parse_date($_GET['paydate']);\n    $encount = 0;\n\n    $last_ptname = '';\n    $last_invnumber = '';\n    $last_code = '';\n    $invoice_total = 0.00;\n    $InsertionId;//last inserted ID of\n\n///////////////////////// Assorted Functions /////////////////////////\n\nfunction parse_date($date)\n{\n    $date = substr(trim($date), 0, 10);\n    if (preg_match('/^(\\d\\d\\d\\d)\\D*(\\d\\d)\\D*(\\d\\d)$/', $date, $matches)) {\n        return $matches[1] . '-' . $matches[2] . '-' . $matches[3];\n    }\n\n    return '';\n}\n\nfunction writeMessageLine($bgcolor, $class, $description)\n{\n    $dline =\n    \" <tr bgcolor='$bgcolor'>\\n\" .\n    \"  <td class='$class' colspan='4'>&nbsp;</td>\\n\" .\n    \"  <td class='$class'>$description</td>\\n\" .\n    \"  <td class='$class' colspan='2'>&nbsp;</td>\\n\" .\n    \" </tr>\\n\";\n    echo $dline;\n}\n\nfunction writeDetailLine(\n    $bgcolor,\n    $class,\n    $ptname,\n    $invnumber,\n    $code,\n    $date,\n    $description,\n    $amount,\n    $balance\n) {\n\n    global $last_ptname, $last_invnumber, $last_code;\n    if ($ptname == $last_ptname) {\n        $ptname = '&nbsp;';\n    } else {\n        $last_ptname = $ptname;\n    }\n\n    if ($invnumber == $last_invnumber) {\n        $invnumber = '&nbsp;';\n    } else {\n        $last_invnumber = $invnumber;\n    }\n\n    if ($code == $last_code) {\n        $code = '&nbsp;';\n    } else {\n        $last_code = $code;\n    }\n\n    if ($amount) {\n        $amount  = sprintf(\"%.2f\", $amount);\n    }\n\n    if ($balance) {\n        $balance = sprintf(\"%.2f\", $balance);\n    }\n\n    $dline =\n    \" <tr bgcolor='$bgcolor'>\\n\" .\n    \"  <td class='$class'>$ptname</td>\\n\" .\n    \"  <td class='$class'>$invnumber</td>\\n\" .\n    \"  <td class='$class'>$code</td>\\n\" .\n    \"  <td class='$class'>\" . text(oeFormatShortDate($date)) . \"</td>\\n\" .\n    \"  <td class='$class'>$description</td>\\n\" .\n    \"  <td class='$class' align='right'>\" . oeFormatMoney($amount) . \"</td>\\n\" .\n    \"  <td class='$class' align='right'>\" . oeFormatMoney($balance) . \"</td>\\n\" .\n    \" </tr>\\n\";\n    echo $dline;\n}\n\n    // This writes detail lines that were already in SQL-Ledger for a given\n    // charge item.\n    //\nfunction writeOldDetail(&$prev, $ptname, $invnumber, $dos, $code, $bgcolor)\n{\n    global $invoice_total;\n    // $prev['total'] = 0.00; // to accumulate total charges\n    ksort($prev['dtl']);\n    foreach ($prev['dtl'] as $dkey => $ddata) {\n        $ddate = substr($dkey, 0, 10);\n        $description = $ddata['src'] . $ddata['rsn'];\n        if ($ddate == '          ') { // this is the service item\n            $ddate = $dos;\n            $description = 'Service Item';\n        }\n\n        $amount = sprintf(\"%.2f\", $ddata['chg'] - $ddata['pmt']);\n        $invoice_total = sprintf(\"%.2f\", $invoice_total + $amount);\n        writeDetailLine(\n            $bgcolor,\n            'olddetail',\n            $ptname,\n            $invnumber,\n            $code,\n            $ddate,\n            $description,\n            $amount,\n            $invoice_total\n        );\n    }\n}\n\n    // This is called back by parse_era() once per claim.\n    //\nfunction era_callback_check(&$out)\n{\n    global $InsertionId;//last inserted ID of\n    global $StringToEcho,$debug;\n\n    if ($_GET['original']=='original') {\n        $StringToEcho=\"<br/><br/><br/><br/><br/><br/>\";\n        $StringToEcho.=\"<table border='1' cellpadding='0' cellspacing='0'  width='750'>\";\n        $StringToEcho.=\"<tr bgcolor='#cccccc'><td width='50'></td><td class='dehead' width='150' align='center'>\".htmlspecialchars(xl('Check Number'), ENT_QUOTES).\"</td><td class='dehead' width='400'  align='center'>\".htmlspecialchars(xl('Payee Name'), ENT_QUOTES).\"</td><td class='dehead'  width='150' align='center'>\".htmlspecialchars(xl('Check Amount'), ENT_QUOTES).\"</td></tr>\";\n        $WarningFlag=false;\n        for ($check_count=1; $check_count<=$out['check_count']; $check_count++) {\n            if ($check_count%2==1) {\n                $bgcolor='#ddddff';\n            } else {\n                $bgcolor='#ffdddd';\n            }\n\n             $rs=sqlQ(\"select reference from ar_session where reference='\".$out['check_number'.$check_count].\"'\");\n            if (sqlNumRows($rs)>0) {\n                $bgcolor='#ff0000';\n                $WarningFlag=true;\n            }\n\n            $StringToEcho.=\"<tr bgcolor='$bgcolor'>\";\n            $StringToEcho.=\"<td><input type='checkbox'  name='chk\".$out['check_number'.$check_count].\"' value='\".$out['check_number'.$check_count].\"'/></td>\";\n            $StringToEcho.=\"<td>\".htmlspecialchars($out['check_number'.$check_count]).\"</td>\";\n            $StringToEcho.=\"<td>\".htmlspecialchars($out['payee_name'.$check_count]).\"</td>\";\n            $StringToEcho.=\"<td align='right'>\".htmlspecialchars(number_format($out['check_amount'.$check_count], 2)).\"</td>\";\n            $StringToEcho.=\"</tr>\";\n        }\n\n        $StringToEcho.=\"<tr bgcolor='#cccccc'><td colspan='4' align='center'><input type='submit'  name='CheckSubmit' value='Submit'/></td></tr>\";\n        if ($WarningFlag==true) {\n            $StringToEcho.=\"<tr bgcolor='#ff0000'><td colspan='4' align='center'>\".htmlspecialchars(xl('Warning, Check Number already exist in the database'), ENT_QUOTES).\"</td></tr>\";\n        }\n\n        $StringToEcho.=\"</table>\";\n    } else {\n        for ($check_count=1; $check_count<=$out['check_count']; $check_count++) {\n            $chk_num=$out['check_number'.$check_count];\n            $chk_num=str_replace(' ', '_', $chk_num);\n            if (isset($_REQUEST['chk'.$chk_num])) {\n                $check_date=$out['check_date'.$check_count]?$out['check_date'.$check_count]:$_REQUEST['paydate'];\n                $post_to_date=$_REQUEST['post_to_date']!=''?$_REQUEST['post_to_date']:date('Y-m-d');\n                $deposit_date=$_REQUEST['deposit_date']!=''?$_REQUEST['deposit_date']:date('Y-m-d');\n                $InsertionId[$out['check_number'.$check_count]]=arPostSession($_REQUEST['InsId'], $out['check_number'.$check_count], $out['check_date'.$check_count], $out['check_amount'.$check_count], $post_to_date, $deposit_date, $debug);\n            }\n        }\n    }\n}\nfunction era_callback(&$out)\n{\n    global $encount, $debug, $claim_status_codes, $adjustment_reasons, $remark_codes;\n    global $invoice_total, $last_code, $paydate;\n    global $InsertionId;//last inserted ID of\n\n\n    // Some heading information.\n    $chk_123=$out['check_number'];\n    $chk_123=str_replace(' ', '_', $chk_123);\n    if (isset($_REQUEST['chk'.$chk_123])) {\n        if ($encount == 0) {\n            writeMessageLine(\n                '#ffffff',\n                'infdetail',\n                \"Payer: \" . htmlspecialchars($out['payer_name'], ENT_QUOTES)\n            );\n            if ($debug) {\n                writeMessageLine(\n                    '#ffffff',\n                    'infdetail',\n                    \"WITHOUT UPDATE is selected; no changes will be applied.\"\n                );\n            }\n        }\n\n        $last_code = '';\n        $invoice_total = 0.00;\n        $bgcolor = (++$encount & 1) ? \"#ddddff\" : \"#ffdddd\";\n        list($pid, $encounter, $invnumber) = slInvoiceNumber($out);\n\n        // Get details, if we have them, for the invoice.\n        $inverror = true;\n        $codes = array();\n        if ($pid && $encounter) {\n            // Get invoice data into $arrow or $ferow.\n            $ferow = sqlQuery(\"SELECT e.*, p.fname, p.mname, p.lname \" .\n            \"FROM form_encounter AS e, patient_data AS p WHERE \" .\n            \"e.pid = '$pid' AND e.encounter = '$encounter' AND \".\n            \"p.pid = e.pid\");\n            if (empty($ferow)) {\n                  $pid = $encounter = 0;\n                  $invnumber = $out['our_claim_id'];\n            } else {\n                  $inverror = false;\n                  $codes = ar_get_invoice_summary($pid, $encounter, true);\n                  // $svcdate = substr($ferow['date'], 0, 10);\n            }\n        }\n\n        // Show the claim status.\n        $csc = $out['claim_status_code'];\n        $inslabel = 'Ins1';\n        if ($csc == '1' || $csc == '19') {\n            $inslabel = 'Ins1';\n        }\n\n        if ($csc == '2' || $csc == '20') {\n            $inslabel = 'Ins2';\n        }\n\n        if ($csc == '3' || $csc == '21') {\n            $inslabel = 'Ins3';\n        }\n\n        $primary = ($inslabel == 'Ins1');\n        writeMessageLine(\n            $bgcolor,\n            'infdetail',\n            \"Claim status $csc: \" . $claim_status_codes[$csc]\n        );\n\n    // Show an error message if the claim is missing or already posted.\n        if ($inverror) {\n            writeMessageLine(\n                $bgcolor,\n                'errdetail',\n                \"The following claim is not in our database\"\n            );\n        } else {\n            // Skip this test. Claims can get multiple CLPs from the same payer!\n            //\n            // $insdone = strtolower($arrow['shipvia']);\n            // if (strpos($insdone, 'ins1') !== false) {\n            //  $inverror = true;\n            //  writeMessageLine($bgcolor, 'errdetail',\n            //   \"Primary insurance EOB was already posted for the following claim\");\n            // }\n        }\n\n        if ($csc == '4') {//Denial case, code is stored in the claims table for display in the billing manager screen with reason explained.\n            $inverror = true;\n            if (!$debug) {\n                if ($pid && $encounter) {\n                    $code_value = '';\n                    foreach ($out['svc'] as $svc) {\n                        foreach ($svc['adj'] as $adj) {//Per code and modifier the reason will be showed in the billing manager.\n                            $code_value .= $svc['code'].'_'.$svc['mod'].'_'.$adj['group_code'].'_'.$adj['reason_code'].',';\n                        }\n                    }\n\n                    $code_value = substr($code_value, 0, -1);\n                    //We store the reason code to display it with description in the billing manager screen.\n                    //process_file is used as for the denial case file name will not be there, and extra field(to store reason) can be avoided.\n                    updateClaim(true, $pid, $encounter, $_REQUEST['InsId'], substr($inslabel, 3), 7, 0, $code_value);\n                }\n            }\n\n            writeMessageLine(\n                $bgcolor,\n                'errdetail',\n                \"Not posting adjustments for denied claims, please follow up manually!\"\n            );\n        } else if ($csc == '22') {\n            $inverror = true;\n            writeMessageLine(\n                $bgcolor,\n                'errdetail',\n                \"Payment reversals are not automated, please enter manually!\"\n            );\n        }\n\n        if ($out['warnings']) {\n            writeMessageLine($bgcolor, 'infdetail', nl2br(rtrim($out['warnings'])));\n        }\n\n    // Simplify some claim attributes for cleaner code.\n        $service_date = parse_date($out['dos']);\n        $check_date      = $paydate ? $paydate : parse_date($out['check_date']);\n        $production_date = $paydate ? $paydate : parse_date($out['production_date']);\n\n        $insurance_id = arGetPayerID($pid, $service_date, substr($inslabel, 3));\n        if (empty($ferow['lname'])) {\n              $patient_name = $out['patient_fname'] . ' ' . $out['patient_lname'];\n        } else {\n            $patient_name = $ferow['fname'] . ' ' . $ferow['lname'];\n        }\n\n        $error = $inverror;\n\n    // This loops once for each service item in this claim.\n        foreach ($out['svc'] as $svc) {\n          // Treat a modifier in the remit data as part of the procedure key.\n          // This key will then make its way into SQL-Ledger.\n            $codekey = $svc['code'];\n            if ($svc['mod']) {\n                $codekey .= ':' . $svc['mod'];\n            }\n\n            $prev = $codes[$codekey];\n            $codetype = ''; //will hold code type, if exists\n\n            // This reports detail lines already on file for this service item.\n            if ($prev) {\n                $codetype = $codes[$codekey]['code_type']; //store code type\n                writeOldDetail($prev, $patient_name, $invnumber, $service_date, $codekey, $bgcolor);\n                // Check for sanity in amount charged.\n                $prevchg = sprintf(\"%.2f\", $prev['chg'] + $prev['adj']);\n                if ($prevchg != abs($svc['chg'])) {\n                    writeMessageLine(\n                        $bgcolor,\n                        'errdetail',\n                        \"EOB charge amount \" . $svc['chg'] . \" for this code does not match our invoice\"\n                    );\n                    $error = true;\n                }\n\n                // Check for already-existing primary remittance activity.\n                // Removed this check because it was not allowing for copays manually\n                // entered into the invoice under a non-copay billing code.\n                /****\n            if ((sprintf(\"%.2f\",$prev['chg']) != sprintf(\"%.2f\",$prev['bal']) ||\n                $prev['adj'] != 0) && $primary)\n            {\n                writeMessageLine($bgcolor, 'errdetail',\n                    \"This service item already has primary payments and/or adjustments!\");\n                $error = true;\n            }\n                ****/\n\n                unset($codes[$codekey]);\n            } // If the service item is not in our database...\n            else {\n                // This is not an error. If we are not in error mode and not debugging,\n                // insert the service item into SL.  Then display it (in green if it\n                // was inserted, or in red if we are in error mode).\n                $description = \"CPT4:$codekey Added by $inslabel $production_date\";\n                if (!$error && !$debug) {\n                    arPostCharge(\n                        $pid,\n                        $encounter,\n                        0,\n                        $svc['chg'],\n                        1,\n                        $service_date,\n                        $codekey,\n                        $description,\n                        $debug,\n                        '',\n                        $codetype\n                    );\n                    $invoice_total += $svc['chg'];\n                }\n\n                $class = $error ? 'errdetail' : 'newdetail';\n                writeDetailLine(\n                    $bgcolor,\n                    $class,\n                    $patient_name,\n                    $invnumber,\n                    $codekey,\n                    $production_date,\n                    $description,\n                    $svc['chg'],\n                    ($error ? '' : $invoice_total)\n                );\n            }\n\n            $class = $error ? 'errdetail' : 'newdetail';\n\n            // Report Allowed Amount.\n            if ($svc['allowed']) {\n                // A problem here is that some payers will include an adjustment\n                // reflecting the allowed amount, others not.  So here we need to\n                // check if the adjustment exists, and if not then create it.  We\n                // assume that any nonzero CO (Contractual Obligation) or PI\n            // (Payer Initiated) adjustment is good enough.\n                $contract_adj = sprintf(\"%.2f\", $svc['chg'] - $svc['allowed']);\n                foreach ($svc['adj'] as $adj) {\n                    if (($adj['group_code'] == 'CO' || $adj['group_code'] == 'PI') && $adj['amount'] != 0) {\n                        $contract_adj = 0;\n                    }\n                }\n\n                if ($contract_adj > 0) {\n                    $svc['adj'][] = array('group_code' => 'CO', 'reason_code' => 'A2',\n                    'amount' => $contract_adj);\n                }\n\n                writeMessageLine(\n                    $bgcolor,\n                    'infdetail',\n                    'Allowed amount is ' . sprintf(\"%.2f\", $svc['allowed'])\n                );\n            }\n\n            // Report miscellaneous remarks.\n            if ($svc['remark']) {\n                $rmk = $svc['remark'];\n                writeMessageLine($bgcolor, 'infdetail', \"$rmk: \" . $remark_codes[$rmk]);\n            }\n\n            // Post and report the payment for this service item from the ERA.\n            // By the way a 'Claim' level payment is probably going to be negative,\n            // i.e. a payment reversal.\n            if ($svc['paid']) {\n                if (!$error && !$debug) {\n                    arPostPayment(\n                        $pid,\n                        $encounter,\n                        $InsertionId[$out['check_number']],\n                        $svc['paid'], //$InsertionId[$out['check_number']] gives the session id\n                        $codekey,\n                        substr($inslabel, 3),\n                        $out['check_number'],\n                        $debug,\n                        '',\n                        $codetype\n                    );\n                    $invoice_total -= $svc['paid'];\n                }\n\n                $description = \"$inslabel/\" . $out['check_number'] . ' payment';\n                if ($svc['paid'] < 0) {\n                    $description .= ' reversal';\n                }\n\n                writeDetailLine(\n                    $bgcolor,\n                    $class,\n                    $patient_name,\n                    $invnumber,\n                    $codekey,\n                    $check_date,\n                    $description,\n                    0 - $svc['paid'],\n                    ($error ? '' : $invoice_total)\n                );\n            }\n\n            // Post and report adjustments from this ERA.  Posted adjustment reasons\n            // must be 25 characters or less in order to fit on patient statements.\n            foreach ($svc['adj'] as $adj) {\n                $description = $adj['reason_code'] . ': ' . $adjustment_reasons[$adj['reason_code']];\n                if ($adj['group_code'] == 'PR' || !$primary) {\n                    // Group code PR is Patient Responsibility.  Enter these as zero\n                    // adjustments to retain the note without crediting the claim.\n                    if ($primary) {\n                /****\n                    $reason = 'Pt resp: '; // Reasons should be 25 chars or less.\n                    if ($adj['reason_code'] == '1') $reason = 'To deductible: ';\n                    else if ($adj['reason_code'] == '2') $reason = 'Coinsurance: ';\n                    else if ($adj['reason_code'] == '3') $reason = 'Co-pay: ';\n                ****/\n                        $reason = \"$inslabel ptresp: \"; // Reasons should be 25 chars or less.\n                        if ($adj['reason_code'] == '1') {\n                            $reason = \"$inslabel dedbl: \";\n                        } else if ($adj['reason_code'] == '2') {\n                            $reason = \"$inslabel coins: \";\n                        } else if ($adj['reason_code'] == '3') {\n                            $reason = \"$inslabel copay: \";\n                        }\n                    } // Non-primary insurance adjustments are garbage, either repeating\n                    // the primary or are not adjustments at all.  Report them as notes\n                    // but do not post any amounts.\n                    else {\n                        $reason = \"$inslabel note \" . $adj['reason_code'] . ': ';\n                /****\n                    $reason .= sprintf(\"%.2f\", $adj['amount']);\n                ****/\n                    }\n\n                    $reason .= sprintf(\"%.2f\", $adj['amount']);\n                    // Post a zero-dollar adjustment just to save it as a comment.\n                    if (!$error && !$debug) {\n                        arPostAdjustment(\n                            $pid,\n                            $encounter,\n                            $InsertionId[$out['check_number']],\n                            0,\n                            $codekey, //$InsertionId[$out['check_number']] gives the session id\n                            substr($inslabel, 3),\n                            $reason,\n                            $debug,\n                            '',\n                            $codetype\n                        );\n                    }\n\n                    writeMessageLine($bgcolor, $class, $description . ' ' .\n                    sprintf(\"%.2f\", $adj['amount']));\n                } // Other group codes for primary insurance are real adjustments.\n                else {\n                    if (!$error && !$debug) {\n                        arPostAdjustment(\n                            $pid,\n                            $encounter,\n                            $InsertionId[$out['check_number']],\n                            $adj['amount'], //$InsertionId[$out['check_number']] gives the session id\n                            $codekey,\n                            substr($inslabel, 3),\n                            \"Adjust code \" . $adj['reason_code'],\n                            $debug,\n                            '',\n                            $codetype\n                        );\n                        $invoice_total -= $adj['amount'];\n                    }\n\n                    writeDetailLine(\n                        $bgcolor,\n                        $class,\n                        $patient_name,\n                        $invnumber,\n                        $codekey,\n                        $production_date,\n                        $description,\n                        0 - $adj['amount'],\n                        ($error ? '' : $invoice_total)\n                    );\n                }\n            }\n        } // End of service item\n\n    // Report any existing service items not mentioned in the ERA, and\n    // determine if any of them are still missing an insurance response\n    // (if so, then insurance is not yet done with the claim).\n        $insurance_done = true;\n        foreach ($codes as $code => $prev) {\n          // writeOldDetail($prev, $arrow['name'], $invnumber, $service_date, $code, $bgcolor);\n            writeOldDetail($prev, $patient_name, $invnumber, $service_date, $code, $bgcolor);\n            $got_response = false;\n            foreach ($prev['dtl'] as $ddata) {\n                if ($ddata['pmt'] || $ddata['rsn']) {\n                    $got_response = true;\n                }\n            }\n\n            if (!$got_response) {\n                $insurance_done = false;\n            }\n        }\n\n    // Cleanup: If all is well, mark Ins<x> done and check for secondary billing.\n        if (!$error && !$debug && $insurance_done) {\n            $level_done = 0 + substr($inslabel, 3);\n\n            if ($out['crossover']==1) {//Automatic forward case.So need not again bill from the billing manager screen.\n                sqlStatement(\"UPDATE form_encounter \" .\n                \"SET last_level_closed = $level_done,last_level_billed=\".$level_done.\" WHERE \" .\n                \"pid = '$pid' AND encounter = '$encounter'\");\n                writeMessageLine(\n                    $bgcolor,\n                    'infdetail',\n                    'This claim is processed by Insurance '.$level_done.' and automatically forwarded to Insurance '.($level_done+1) .' for processing. '\n                );\n            } else {\n                sqlStatement(\"UPDATE form_encounter \" .\n                \"SET last_level_closed = $level_done WHERE \" .\n                \"pid = '$pid' AND encounter = '$encounter'\");\n            }\n\n            // Check for secondary insurance.\n            if ($primary && arGetPayerID($pid, $service_date, 2)) {\n                arSetupSecondary($pid, $encounter, $debug, $out['crossover']);\n\n                if ($out['crossover']<>1) {\n                    writeMessageLine(\n                        $bgcolor,\n                        'infdetail',\n                        'This claim is now re-queued for secondary paper billing'\n                    );\n                }\n            }\n        }\n    }\n}\n\n/////////////////////////// End Functions ////////////////////////////\n\n    $info_msg = \"\";\n\n    $eraname = $_GET['eraname'];\nif (! $eraname) {\n    die(xl(\"You cannot access this page directly.\"));\n}\n\n    // Open the output file early so that in case it fails, we do not post a\n    // bunch of stuff without saving the report.  Also be sure to retain any old\n    // report files.  Do not save the report if this is a no-update situation.\n    //\nif (!$debug) {\n    $nameprefix = $GLOBALS['OE_SITE_DIR'] . \"/era/$eraname\";\n    $namesuffix = '';\n    for ($i = 1; is_file(\"$nameprefix$namesuffix.html\"); ++$i) {\n        $namesuffix = \"_$i\";\n    }\n\n    $fnreport = \"$nameprefix$namesuffix.html\";\n    $fhreport = fopen($fnreport, 'w');\n    if (!$fhreport) {\n        die(xl(\"Cannot create\") . \" '$fnreport'\");\n    }\n}\n\n?>\n<html>\n<head>\n<?php html_header_show();?>\n<link rel=stylesheet href=\"<?php echo $css_header;?>\" type=\"text/css\">\n<style type=\"text/css\">\n body       { font-family:sans-serif; font-size:8pt; font-weight:normal }\n .dehead    { color:#000000; font-family:sans-serif; font-size:9pt; font-weight:bold }\n .olddetail { color:#000000; font-family:sans-serif; font-size:9pt; font-weight:normal }\n .newdetail { color:#00dd00; font-family:sans-serif; font-size:9pt; font-weight:normal }\n .errdetail { color:#dd0000; font-family:sans-serif; font-size:9pt; font-weight:normal }\n .infdetail { color:#0000ff; font-family:sans-serif; font-size:9pt; font-weight:normal }\n</style>\n<title><?php xl('EOB Posting - Electronic Remittances', 'e')?></title>\n<script language=\"JavaScript\">\n</script>\n</head>\n<body leftmargin='0' topmargin='0' marginwidth='0' marginheight='0'>\n<form action=\"sl_eob_process.php\" method=\"get\" >\n<center>\n<?php\nif ($_GET['original']=='original') {\n    $alertmsg = parse_era_for_check($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\", 'era_callback');\n    echo $StringToEcho;\n} else {\n    ?>\n    <table border='0' cellpadding='2' cellspacing='0' width='100%'>\n\n     <tr bgcolor=\"#cccccc\">\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Patient'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Invoice'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Code'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Date'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Description'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\" align=\"right\">\n    <?php echo htmlspecialchars(xl('Amount'), ENT_QUOTES) ?>&nbsp;\n      </td>\n      <td class=\"dehead\" align=\"right\">\n    <?php echo htmlspecialchars(xl('Balance'), ENT_QUOTES) ?>&nbsp;\n      </td>\n     </tr>\n\n    <?php\n    global $InsertionId;\n\n    $eraname=$_REQUEST['eraname'];\n    $alertmsg = parse_era_for_check($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\");\n    $alertmsg = parse_era($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\", 'era_callback');\n    if (!$debug) {\n          $StringIssue=htmlspecialchars(xl(\"Total Distribution for following check number is not full\"), ENT_QUOTES).': ';\n          $StringPrint='No';\n        foreach ($InsertionId as $key => $value) {\n            $rs= sqlQ(\"select pay_total from ar_session where session_id='$value'\");\n            $row=sqlFetchArray($rs);\n            $pay_total=$row['pay_total'];\n            $rs= sqlQ(\"select sum(pay_amount) sum_pay_amount from ar_activity where session_id='$value'\");\n            $row=sqlFetchArray($rs);\n            $pay_amount=$row['sum_pay_amount'];\n\n            if (($pay_total-$pay_amount)<>0) {\n                $StringIssue.=$key.' ';\n                $StringPrint='Yes';\n            }\n        }\n\n        if ($StringPrint=='Yes') {\n            echo \"<script>alert('$StringIssue')</script>\";\n        }\n    }\n\n\n    ?>\n    </table>\n<?php\n}\n?>\n</center>\n<script language=\"JavaScript\">\n<?php\nif ($alertmsg) {\n    echo \" alert('\" . htmlspecialchars($alertmsg, ENT_QUOTES) . \"');\\n\";\n}\n?>\n</script>\n<input type=\"hidden\" name=\"paydate\" value=\"<?php echo DateToYYYYMMDD($_REQUEST['paydate']);?>\" />\n<input type=\"hidden\" name=\"post_to_date\" value=\"<?php echo DateToYYYYMMDD($_REQUEST['post_to_date']);?>\" />\n<input type=\"hidden\" name=\"deposit_date\" value=\"<?php echo DateToYYYYMMDD($_REQUEST['deposit_date']);?>\" />\n<input type=\"hidden\" name=\"debug\" value=\"<?php echo $_REQUEST['debug'];?>\" />\n<input type=\"hidden\" name=\"InsId\" value=\"<?php echo $_REQUEST['InsId'];?>\" />\n<input type=\"hidden\" name=\"eraname\" value=\"<?php echo $eraname?>\" />\n</form>\n</body>\n</html>\n<?php\n    // Save all of this script's output to a report file.\nif (!$debug) {\n    fwrite($fhreport, ob_get_contents());\n    fclose($fhreport);\n}\n\n    ob_end_flush();\n?>\n", "<?php\n/**\n * This the first of two pages to support posting of EOBs.\n * The second is sl_eob_invoice.php.\n * Windows compatibility and statement downloading:\n *      2009 Bill Cernansky and Tony McCormick [mi-squared.com]\n *\n * Copyright (C) 2005-2010 Rod Roark <rod@sunsetsystems.com>\n *\n * LICENSE: This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; either version 2\n * of the License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU General Public License for more details.\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <http://opensource.org/licenses/gpl-license.php>;.\n *\n * @package OpenEMR\n * @author  Rod Roark <rod@sunsetsystems.com>\n * @author  Roberto Vasquez <robertogagliotta@gmail.com>\n * @author  Jerry Padgett <sjpadgett@gmail.com>\n * @link    http://www.open-emr.org\n */\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/invoice_summary.inc.php\");\nrequire_once(\"$srcdir/appointments.inc.php\");\nrequire_once($GLOBALS['OE_SITE_DIR'] . \"/statement.inc.php\");\nrequire_once(\"$srcdir/parse_era.inc.php\");\nrequire_once(\"$srcdir/sl_eob.inc.php\");\nrequire_once(\"$srcdir/api.inc\");\nrequire_once(\"$srcdir/forms.inc\");\nrequire_once(\"$srcdir/../controllers/C_Document.class.php\");\nrequire_once(\"$srcdir/documents.php\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/acl.inc\");\n\n$DEBUG = 0; // set to 0 for production, 1 to test\n\n$alertmsg = '';\n$where = '';\n$eraname = '';\n$eracount = 0;\n/* Load dependencies only if we need them */\nif (! empty($GLOBALS['portal_onsite_two_enable'])) {\n    /* Addition of onsite portal patient notify of invoice and reformated invoice - sjpadgett 01/2017 */\n    require_once(\"../../portal/lib/portal_mail.inc\");\n    require_once(\"../../portal/lib/appsql.class.php\");\n\n    function is_auth_portal($pid = 0)\n    {\n        if ($pData = sqlQuery(\"SELECT * FROM `patient_data` WHERE `pid` = ?\", array(\n            $pid\n        ))) {\n            if ($pData['allow_patient_portal'] != \"YES\") {\n                return false;\n            } else {\n                $_SESSION['portalUser'] = strtolower($pData['fname']) . $pData['id'];\n                return true;\n            }\n        } else {\n            return false;\n        }\n    }\n\n    function notify_portal($thispid, array $invoices, $template, $invid)\n    {\n        $builddir = $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/' . $thispid;\n        if (! is_dir($builddir)) {\n            mkdir($builddir, 0755, true);\n        }\n\n        if (fixup_invoice($template, $builddir . '/invoice' . $invid . '.tpl') != true) {\n            return false;\n        }\n\n        if (SavePatientAudit($thispid, $invoices) != true) {\n            return false;\n        } // this is all the invoice data for portal auditing\n        $note = xl('You have an invoice due for payment in your Patient Documents. There you may pay, download or print the invoice. Thank you.');\n        if (sendMail($_SESSION['authUser'], $note, xlt('Bill/Collect'), '', '0', $_SESSION['authUser'], $_SESSION['authUser'], $_SESSION['portalUser'], $invoices[0]['patient'], \"New\", '0') == 1) { // remind admin this was sent\n            sendMail($_SESSION['portalUser'], $note, xlt('Bill/Collect'), '', '0', $_SESSION['authUser'], $_SESSION['authUser'], $_SESSION['portalUser'], $invoices[0]['patient'], \"New\", '0'); // notify patient\n        } else {\n            return false;\n        }\n\n        return true;\n    }\n\n    function fixup_invoice($template, $ifile)\n    {\n        $data = file_get_contents($template);\n        if ($data == \"\") {\n            return false;\n        }\n\n        if (! file_put_contents($ifile, $data)) {\n            return false;\n        }\n\n        return true;\n    }\n\n    function SavePatientAudit($pid, $invs)\n    {\n        $appsql = new ApplicationTable();\n        try {\n            $audit = array();\n            $audit['patient_id'] = $pid;\n            $audit['activity'] = \"invoice\";\n            $audit['require_audit'] = \"0\";\n            $audit['pending_action'] = \"payment\";\n            $audit['action_taken'] = \"\";\n            $audit['status'] = \"waiting transaction\";\n            $audit['narrative'] = \"Request patient online payment.\";\n            $audit['table_action'] = '';\n            $audit['table_args'] = json_encode($invs);\n            $audit['action_user'] = $pid;\n            $audit['action_taken_time'] = \"\";\n            $audit['checksum'] = \"\";\n            $edata = $appsql->getPortalAudit($pid, 'payment', 'invoice', \"waiting transaction\", 0);\n            if ($edata['id'] > 0) {\n                $appsql->portalAudit('update', $edata['id'], $audit);\n            } else {\n                $appsql->portalAudit('insert', '', $audit);\n            }\n        } catch (Exception $ex) {\n            return $ex;\n        }\n\n        return true;\n    }\n}\n\n// This is called back by parse_era() if we are processing X12 835's.\nfunction era_callback(&$out)\n{\n    global $where, $eracount, $eraname;\n  // print_r($out); // debugging\n    ++$eracount;\n  // $eraname = $out['isa_control_number'];\n    $eraname = $out['gs_date'] . '_' . ltrim($out['isa_control_number'], '0') .\n    '_' . ltrim($out['payer_id'], '0');\n    list($pid, $encounter, $invnumber) = slInvoiceNumber($out);\n\n    if ($pid && $encounter) {\n        if ($where) {\n            $where .= ' OR ';\n        }\n\n        $where .= \"( f.pid = '$pid' AND f.encounter = '$encounter' )\";\n    }\n}\n\nfunction bucks($amount)\n{\n    if ($amount) {\n        echo oeFormatMoney($amount);\n    }\n}\n\nfunction validEmail($email)\n{\n    if (preg_match(\"^[_a-z0-9-]+(\\.[_a-z0-9-]+)*@[a-z0-9-]+(\\.[a-z0-9-]+)*(\\.[a-z]{2,3})$^\", $email)) {\n        return true;\n    }\n\n    return false;\n}\n\nfunction emailLogin($patient_id, $message)\n{\n    $patientData = sqlQuery(\"SELECT * FROM `patient_data` WHERE `pid`=?\", array($patient_id));\n    if ($patientData['hipaa_allowemail'] != \"YES\" || empty($patientData['email']) || empty($GLOBALS['patient_reminder_sender_email'])) {\n        return false;\n    }\n\n    if (!(validEmail($patientData['email']))) {\n        return false;\n    }\n\n    if (!(validEmail($GLOBALS['patient_reminder_sender_email']))) {\n        return false;\n    }\n\n    if ($_SESSION['pc_facility']) {\n        $sql = \"select * from facility where id=?\";\n        $facility = sqlQuery($sql, array($_SESSION['pc_facility']));\n    } else {\n        $sql = \"SELECT * FROM facility ORDER BY billing_location DESC LIMIT 1\";\n        $facility = sqlQuery($sql);\n    }\n\n    $mail = new MyMailer();\n    $pt_name=$patientData['fname'].' '.$patientData['lname'];\n    $pt_email=$patientData['email'];\n    $email_subject=($facility['name'] . ' ' . xl('Patient Statement Bill'));\n    $email_sender=$GLOBALS['patient_reminder_sender_email'];\n    $mail->AddReplyTo($email_sender, $email_sender);\n    $mail->SetFrom($email_sender, $email_sender);\n    $mail->AddAddress($pt_email, $pt_name);\n    $mail->Subject = $email_subject;\n    $mail->MsgHTML(\"<html><body><div class='wrapper'>\".$message.\"</div></body></html>\");\n    $mail->IsHTML(true);\n    $mail->AltBody = $message;\n\n    if ($mail->Send()) {\n        return true;\n    } else {\n        $email_status = $mail->ErrorInfo;\n        error_log(\"EMAIL ERROR: \".$email_status, 0);\n        return false;\n    }\n}\n\n// Upload a file to the client's browser\n//\nfunction upload_file_to_client($file_to_send)\n{\n    header(\"Pragma: public\");\n    header(\"Expires: 0\");\n    header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n    header(\"Content-Type: application/force-download\");\n    header(\"Content-Length: \" . filesize($file_to_send));\n    header(\"Content-Disposition: attachment; filename=\" . basename($file_to_send));\n    header(\"Content-Description: File Transfer\");\n    readfile($file_to_send);\n  // flush the content to the browser. If you don't do this, the text from the subsequent\n  // output from this script will be in the file instead of sent to the browser.\n    flush();\n    exit(); //added to exit from process properly in order to stop bad html code -ehrlive\n  // sleep one second to ensure there's no follow-on.\n    sleep(1);\n}\n\nfunction upload_file_to_client_email($ppid, $file_to_send)\n{\n    $message = \"\";\n    global $STMT_TEMP_FILE_PDF;\n    $file = fopen($file_to_send, \"r\");//this file contains the text to be converted to pdf.\n    while (!feof($file)) {\n        $OneLine=fgets($file);//one line is read\n\n         $message = $message.$OneLine.'<br>';\n\n        $countline++;\n    }\n\n    emailLogin($ppid, $message);\n}\n\nfunction upload_file_to_client_pdf($file_to_send, $aPatFirstName = '', $aPatID = null, $flagCFN = false)\n{\n //modified for statement title name\n  //Function reads a HTML file and converts to pdf.\n\n    $aPatFName = convert_safe_file_dir_name($aPatFirstName); //modified for statement title name\n    if ($flagCFN) {\n        $STMT_TEMP_FILE_PDF = $GLOBALS['temporary_files_dir'] . \"/Stmt_{$aPatFName}_{$aPatID}.pdf\";\n    } else {\n        global $STMT_TEMP_FILE_PDF;\n    }\n\n    global $srcdir;\n\n    if ($GLOBALS['statement_appearance'] == '1') {\n        require_once(\"$srcdir/html2pdf/vendor/autoload.php\");\n        $pdf2 = new HTML2PDF(\n            $GLOBALS['pdf_layout'],\n            $GLOBALS['pdf_size'],\n            $GLOBALS['pdf_language'],\n            true, // default unicode setting is true\n            'UTF-8', // default encoding setting is UTF-8\n            array($GLOBALS['pdf_left_margin'],$GLOBALS['pdf_top_margin'],$GLOBALS['pdf_right_margin'],$GLOBALS['pdf_bottom_margin']),\n            $_SESSION['language_direction'] == 'rtl' ? true : false\n        );\n        ob_start();\n        readfile($file_to_send, \"r\");//this file contains the HTML to be converted to pdf.\n        //echo $file;\n        $content = ob_get_clean();\n\n        // Fix a nasty html2pdf bug - it ignores document root!\n        global $web_root, $webserver_root;\n        $i = 0;\n        $wrlen = strlen($web_root);\n        $wsrlen = strlen($webserver_root);\n        while (true) {\n              $i = stripos($content, \" src='/\", $i + 1);\n            if ($i === false) {\n                break;\n            }\n\n            if (substr($content, $i+6, $wrlen) === $web_root &&\n              substr($content, $i+6, $wsrlen) !== $webserver_root) {\n                $content = substr($content, 0, $i + 6) . $webserver_root . substr($content, $i + 6 + $wrlen);\n            }\n        }\n\n        $pdf2->WriteHTML($content);\n        $temp_filename = $STMT_TEMP_FILE_PDF;\n        $content_pdf = $pdf2->Output($STMT_TEMP_FILE_PDF, 'F');\n    } else {\n        $pdf = new Cezpdf('LETTER');//pdf creation starts\n        $pdf->ezSetMargins(45, 9, 36, 10);\n        $pdf->selectFont('Courier');\n        $pdf->ezSetY($pdf->ez['pageHeight'] - $pdf->ez['topMargin']);\n        $countline=1;\n        $file = fopen($file_to_send, \"r\");//this file contains the text to be converted to pdf.\n        while (!feof($file)) {\n            $OneLine=fgets($file);//one line is read\n            if (stristr($OneLine, \"\\014\") == true && !feof($file)) {//form feed means we should start a new page.\n                $pdf->ezNewPage();\n                $pdf->ezSetY($pdf->ez['pageHeight'] - $pdf->ez['topMargin']);\n                str_replace(\"\\014\", \"\", $OneLine);\n            }\n\n            if (stristr($OneLine, 'REMIT TO') == true || stristr($OneLine, 'Visit Date') == true || stristr($OneLine, 'Future Appointments') == true || stristr($OneLine, 'Current') == true) { //lines are made bold when 'REMIT TO' or 'Visit Date' is there.\n                $pdf->ezText('<b>'.$OneLine.'</b>', 12, array('justification' => 'left', 'leading' => 6));\n            } else {\n                $pdf->ezText($OneLine, 12, array('justification' => 'left', 'leading' => 6));\n            }\n\n            $countline++;\n        }\n\n        $fh = @fopen($STMT_TEMP_FILE_PDF, 'w');//stored to a pdf file\n        if ($fh) {\n            fwrite($fh, $pdf->ezOutput());\n            fclose($fh);\n        }\n    }\n\n    header(\"Pragma: public\");//this section outputs the pdf file to browser\n    header(\"Expires: 0\");\n    header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n    header(\"Content-Type: application/force-download\");\n    header(\"Content-Length: \" . filesize($STMT_TEMP_FILE_PDF));\n    header(\"Content-Disposition: attachment; filename=\" . basename($STMT_TEMP_FILE_PDF));\n    header(\"Content-Description: File Transfer\");\n    readfile($STMT_TEMP_FILE_PDF);\n  // flush the content to the browser. If you don't do this, the text from the subsequent\n  // output from this script will be in the file instead of sent to the browser.\n    flush();\n    exit(); //added to exit from process properly in order to stop bad html code -ehrlive\n  // sleep one second to ensure there's no follow-on.\n    sleep(1);\n}\n\n\n$today = date(\"Y-m-d\");\n  // Print or download statements if requested.\n  //\nif (($_POST['form_print'] || $_POST['form_download'] || $_POST['form_email'] || $_POST['form_pdf']) || $_POST['form_portalnotify'] && $_POST['form_cb']) {\n    $fhprint = fopen($STMT_TEMP_FILE, 'w');\n\n    $sqlBindArray = array();\n    $where = \"\";\n    foreach ($_POST['form_cb'] as $key => $value) {\n        $where .= \" OR f.id = ?\";\n        array_push($sqlBindArray, $key);\n    }\n\n    if (!empty($where)) {\n        $where = substr($where, 4);\n        $where = '( ' . $where . ' ) AND';\n    }\n\n    $res = sqlStatement(\"SELECT \" .\n    \"f.id, f.date, f.pid, f.encounter, f.stmt_count, f.last_stmt_date, f.last_level_closed, f.last_level_billed, f.billing_note as enc_billing_note, \" .\n    \"p.fname, p.mname, p.lname, p.street, p.city, p.state, p.postal_code, p.billing_note as pat_billing_note \" .\n    \"FROM form_encounter AS f, patient_data AS p \" .\n    \"WHERE $where \" .\n    \"p.pid = f.pid \" .\n    \"ORDER BY p.lname, p.fname, f.pid, f.date, f.encounter\", $sqlBindArray);\n\n    $stmt = array();\n    $stmt_count = 0;\n\n    $flagT = true;\n    $aPatientFirstName = '';\n    $aPatientID = null;\n    $multiplePatients = false;\n    $usePatientNamePdf = false;\n\n    // get pids for delimits\n    // need to only use summary invoice for multi visits\n    $inv_pid = array();\n    $inv_count = -1;\n    if ($_POST['form_portalnotify']) {\n        foreach ($_POST['form_invpids'] as $key => $v) {\n            if ($_POST['form_cb'][$key]) {\n                array_push($inv_pid, key($v));\n            }\n        }\n    }\n    $rcnt = 0;\n    while ($row = sqlFetchArray($res)) {\n        $rows[] = $row;\n        if (!$inv_pid[$rcnt]) {\n            array_push($inv_pid, $row['pid']);\n        }\n        $rcnt++;\n    }\n   // This loops once for each invoice/encounter.\n   //\n    $rcnt = 0;\n    while ($row = $rows[$rcnt++]) {\n        $svcdate = substr($row['date'], 0, 10);\n        $duedate = $svcdate; // TBD?\n        $duncount = $row['stmt_count'];\n        $enc_note = $row['enc_billing_note'];\n\n        if ($flagT) {\n            $flagT = false;\n            $aPatientFirstName = $row['fname'];\n            $aPatientID = $row['pid'];\n            $usePatientNamePdf = true;\n        } elseif (!$multiplePatients) {\n            if ($aPatientID != $row['pid']) {\n                $multiplePatients = true;\n                $aPatientFirstName = '';\n                $aPatientID = null;\n                $usePatientNamePdf = false;\n            }\n        }\n\n       // If this is a new patient then print the pending statement\n       // and start a new one.  This is an associative array:\n       //\n       //  cid     = same as pid\n       //  pid     = OpenEMR patient ID\n       //  patient = patient name\n       //  amount  = total amount due\n       //  adjust  = adjustments (already applied to amount)\n       //  duedate = due date of the oldest included invoice\n       //  age     = number of days from duedate to today\n       //  to      = array of addressee name/address lines\n       //  lines   = array of:\n       //    dos     = date of service \"yyyy-mm-dd\"\n       //    desc    = description\n       //    amount  = charge less adjustments\n       //    paid    = amount paid\n       //    notice  = 1 for first notice, 2 for second, etc.\n       //    detail  = array of details, see invoice_summary.inc.php\n       //\n        if ($stmt['cid'] != $row['pid']) {\n            if (!empty($stmt)) {\n                ++$stmt_count;\n            }\n\n            $stmt['cid'] = $row['pid'];\n            $stmt['pid'] = $row['pid'];\n            $stmt['dun_count'] = $row['stmt_count'];\n            $stmt['bill_note'] = $row['pat_billing_note'];\n            $stmt['enc_bill_note'] = $row['enc_billing_note'];\n            $stmt['bill_level'] = $row['last_level_billed'];\n            $stmt['level_closed'] = $row['last_level_closed'];\n            $stmt['patient'] = $row['fname'] . ' ' . $row['lname'];\n            $stmt['encounter'] = $row['encounter'];\n            #If you use the field in demographics layout called\n            #guardiansname this will allow you to send statements to the parent\n            #of a child or a guardian etc\n            if (strlen($row['guardiansname']) == 0) {\n                $stmt['to'] = array($row['fname'] . ' ' . $row['lname']);\n            } else {\n                $stmt['to'] = array($row['guardiansname']);\n            }\n\n            if ($row['street']) {\n                $stmt['to'][] = $row['street'];\n            }\n\n            $stmt['to'][] = $row['city'] . \", \" . $row['state'] . \" \" . $row['postal_code'];\n            $stmt['lines'] = array();\n            $stmt['amount'] = '0.00';\n            $stmt['ins_paid'] = 0;\n            $stmt['today'] = $today;\n            $stmt['duedate'] = $duedate;\n        } else {\n            // Report the oldest due date.\n            if ($duedate < $stmt['duedate']) {\n                $stmt['duedate'] = $duedate;\n            }\n        }\n\n        // Recompute age at each invoice.\n        $stmt['age'] = round((strtotime($today) - strtotime($stmt['duedate'])) / (24 * 60 * 60));\n\n        $invlines = ar_get_invoice_summary($row['pid'], $row['encounter'], true);\n        foreach ($invlines as $key => $value) {\n            $line = array();\n            $line['dos']     = $svcdate;\n            if ($GLOBALS['use_custom_statement']) {\n                $line['desc']    = ($key == 'CO-PAY') ? \"Patient Payment\" : $value['code_text'];\n            } else {\n                $line['desc']    = ($key == 'CO-PAY') ? \"Patient Payment\" : \"Procedure $key\";\n            }\n\n             $line['amount']  = sprintf(\"%.2f\", $value['chg']);\n             $line['adjust']  = sprintf(\"%.2f\", $value['adj']);\n             $line['paid']    = sprintf(\"%.2f\", $value['chg'] - $value['bal']);\n             $line['notice']  = $duncount + 1;\n             $line['detail']  = $value['dtl'];\n             $stmt['lines'][] = $line;\n             $stmt['amount']  = sprintf(\"%.2f\", $stmt['amount'] + $value['bal']);\n             $stmt['ins_paid']  = $stmt['ins_paid'] + $value['ins'];\n        }\n\n        // Record that this statement was run.\n        if (! $DEBUG && ! $_POST['form_without']) {\n            sqlStatement(\"UPDATE form_encounter SET \" .\n            \"last_stmt_date = '$today', stmt_count = stmt_count + 1 \" .\n            \"WHERE id = \" . $row['id']);\n        }\n        $inv_count += 1;\n        if ($_POST['form_portalnotify']) {\n            if (! is_auth_portal($stmt['pid'])) {\n                $alertmsg = xlt('Notification FAILED: Not Portal Authorized');\n                break;\n            }\n            $pvoice[] = $stmt;\n            // we don't want to send the portal multiple invoices, thus this. Last invoice for pid is summary.\n            if ($inv_pid[$inv_count] != $inv_pid[$inv_count + 1]) {\n                fwrite($fhprint, make_statement($stmt));\n                if (! notify_portal($stmt['pid'], $pvoice, $STMT_TEMP_FILE, $stmt['pid'] . \"-\" . $stmt['encounter'])) {\n                    $alertmsg = xlt('Notification FAILED');\n                    break;\n                }\n\n                $pvoice = array();\n                flush();\n                ftruncate($fhprint, 0);\n            } else {\n                continue;\n            }\n        } else {\n            if ($inv_pid[$inv_count] != $inv_pid[$inv_count + 1]) {\n                $tmp = make_statement($stmt);\n                if (empty($tmp)) {\n                    $tmp = xlt(\"This EOB item does not meet minimum print requirements setup in Globals or there is an unknown error.\") . \" \" . xlt(\"EOB Id\") . \":\" . $inv_pid[$inv_count] . \" \" . xlt(\"Encounter\") . \":\" . $stmt[encounter] . \"\\n\";\n                    $tmp .= \"<br />\\n\\014<br /><br />\";\n                }\n                fwrite($fhprint, $tmp);\n            }\n        }\n    } // end while\n\n    if (!empty($stmt)) {\n        ++$stmt_count;\n    }\n\n    fclose($fhprint);\n    sleep(1);\n    // Download or print the file, as selected\n    if ($_POST['form_download']) {\n        upload_file_to_client($STMT_TEMP_FILE);\n    } elseif ($_POST['form_pdf']) {\n        upload_file_to_client_pdf($STMT_TEMP_FILE, $aPatientFirstName, $aPatientID, $usePatientNamePdf);\n    } elseif ($_POST['form_email']) {\n                upload_file_to_client_email($stmt['pid'], $STMT_TEMP_FILE);\n    } elseif ($_POST['form_portalnotify']) {\n        if ($alertmsg == \"\") {\n            $alertmsg = xl('Sending Invoice to Patient Portal Completed');\n        }\n    } else { // Must be print!\n        if ($DEBUG) {\n            $alertmsg = xl(\"Printing skipped; see test output in\") .' '. $STMT_TEMP_FILE;\n        } else {\n            exec(\"$STMT_PRINT_CMD $STMT_TEMP_FILE\");\n            if ($_POST['form_without']) {\n                $alertmsg = xl('Now printing') .' '. $stmt_count .' '. xl('statements; invoices will not be updated.');\n            } else {\n                $alertmsg = xl('Now printing') .' '. $stmt_count .' '. xl('statements and updating invoices.');\n            }\n        } // end not debug\n    } // end not form_download\n} // end statements requested\n    ?>\n  <html>\n  <head>\n    <?php html_header_show(); ?>\n    <link rel=stylesheet href=\"<?php echo $css_header;?>\" type=\"text/css\">\n    <title><?php xl('EOB Posting - Search', 'e'); ?></title>\n    <script type=\"text/javascript\" src=\"../../library/textformat.js\"></script>\n\n    <script language=\"JavaScript\">\n\n    var mypcc = '1';\n\n    function checkAll(checked) {\n     var f = document.forms[0];\n     for (var i = 0; i < f.elements.length; ++i) {\n      var ename = f.elements[i].name;\n      if (ename.indexOf('form_cb[') == 0)\n       f.elements[i].checked = checked;\n   }\n }\n\n function npopup(pid) {\n   window.open('sl_eob_patient_note.php?patient_id=' + pid, '_blank', 'width=500,height=250,resizable=1');\n   return false;\n }\n\n </script>\n\n</head>\n\n<body leftmargin='0' topmargin='0' marginwidth='0' marginheight='0'>\n  <center>\n\n    <form method='post' action='sl_eob_search.php' enctype='multipart/form-data'>\n\n      <table border='0' cellpadding='5' cellspacing='0'>\n       <tr>\n\n        <?php\n  // Identify the payer to support resumable posting sessions.\n        echo \"  <td>\\n\";\n        echo \"   \" . xl('Payer') . \":\\n\";\n        echo \"  </td>\\n\";\n        echo \"  <td>\\n\";\n        $insurancei = getInsuranceProviders();\n        echo \"   <select name='form_payer_id'>\\n\";\n        echo \"    <option value='0'>-- \" . xl('Patient') . \" --</option>\\n\";\n        foreach ($insurancei as $iid => $iname) {\n            echo \"<option value='$iid'\";\n            if ($iid == $_POST['form_payer_id']) {\n                echo \" selected\";\n            }\n\n            echo \">\" . $iname . \"</option>\\n\";\n        }\n\n        echo \"   </select>\\n\";\n        echo \"  </td>\\n\";\n        ?>\n\n        <td>\n            <?php xl('Source:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_source' size='10' value='<?php echo $_POST['form_source']; ?>'\n         title='<?php xl(\"A check number or claim number to identify the payment\", \"e\"); ?>'>\n       </td>\n       <td>\n            <?php xl('Pay Date:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_paydate' size='10' value='<?php echo $_POST['form_paydate']; ?>'\n         onkeyup='datekeyup(this,mypcc)' onblur='dateblur(this,mypcc)'\n         title='<?php xl(\"Date of payment yyyy-mm-dd\", \"e\"); ?>'>\n       </td>\n\n       <td>\n            <?php xl('Deposit Date:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_deposit_date' size='10' value='<?php echo $_POST['form_deposit_date']; ?>'\n         onkeyup='datekeyup(this,mypcc)' onblur='dateblur(this,mypcc)'\n         title='<?php xl(\"Date of bank deposit yyyy-mm-dd\", \"e\"); ?>'>\n       </td>\n\n       <td>\n            <?php xl('Amount:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_amount' size='10' value='<?php echo $_POST['form_amount']; ?>'\n         title='<?php xl(\"Paid amount that you will allocate\", \"e\"); ?>'>\n       </td>\n       <td align='right'>\n         <a href='sl_eob_help.php' target='_blank'><?php xl('Help', 'e'); ?></a>\n       </td>\n\n     </tr>\n   </table>\n\n   <table border='0' cellpadding='5' cellspacing='0'>\n\n     <tr bgcolor='#ddddff'>\n      <td>\n        <?php xl('Name:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_name' size='10' value='<?php echo $_POST['form_name']; ?>'\n       title='<?php xl(\"Any part of the patient name, or \\\"last,first\\\", or \\\"X-Y\\\"\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('Chart ID:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_pid' size='10' value='<?php echo $_POST['form_pid']; ?>'\n       title='<?php xl(\"Patient chart ID\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('Encounter:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_encounter' size='10' value='<?php echo $_POST['form_encounter']; ?>'\n       title='<?php xl(\"Encounter number\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('Svc Date:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_date' size='10' value='<?php echo $_POST['form_date']; ?>'\n       title='<?php xl(\"Date of service mm/dd/yyyy\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('To:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_to_date' size='10' value='<?php echo $_POST['form_to_date']; ?>'\n       title='<?php xl(\"Ending DOS mm/dd/yyyy if you wish to enter a range\", \"e\"); ?>'>\n     </td>\n     <td>\n       <select name='form_category'>\n        <?php\n        foreach (array(xl('Open'), xl('All'), xl('Due Pt'), xl('Due Ins')) as $value) {\n            echo \"    <option value='$value'\";\n            if ($_POST['form_category'] == $value) {\n                echo \" selected\";\n            }\n\n            echo \">$value</option>\\n\";\n        }\n        ?>\n      </select>\n    </td>\n    <td>\n     <input type='submit' name='form_search' value='<?php xl(\"Search\", \"e\"); ?>'>\n   </td>\n </tr>\n       <!-- Filter - only show those who have debt -->\n       <tr bgcolor='#ddddff'>\n           <td colspan='12'>\n\n               <span><?php echo xlt('Patients with debt');?>\n                <input <?php echo $_POST['only_with_debt']?'checked=checked':'';?> type=\"checkbox\" name=\"only_with_debt\"  />\n               </span>\n\n           </td>\n       </tr>\n <!-- Support for X12 835 upload -->\n <tr bgcolor='#ddddff'>\n  <td colspan='12'>\n    <?php xl('Or upload ERA file:', 'e'); ?>\n   <input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"5000000\" />\n   <input name=\"form_erafile\" type=\"file\" />\n </td>\n</tr>\n\n<tr>\n  <td height=\"1\" colspan=\"10\">\n  </td>\n</tr>\n\n</table>\n\n<?php\nif ($_POST['form_search'] || $_POST['form_print']) {\n    $form_name      = trim($_POST['form_name']);\n    $form_pid       = trim($_POST['form_pid']);\n    $form_encounter = trim($_POST['form_encounter']);\n    $form_date      = fixDate($_POST['form_date'], \"\");\n    $form_to_date   = fixDate($_POST['form_to_date'], \"\");\n\n    $where = \"\";\n\n  // Handle X12 835 file upload.\n  //\n    if ($_FILES['form_erafile']['size']) {\n        $tmp_name = $_FILES['form_erafile']['tmp_name'];\n\n        // Handle .zip extension if present.  Probably won't work on Windows.\n        if (strtolower(substr($_FILES['form_erafile']['name'], -4)) == '.zip') {\n            rename($tmp_name, \"$tmp_name.zip\");\n            exec(\"unzip -p $tmp_name.zip > $tmp_name\");\n            unlink(\"$tmp_name.zip\");\n        }\n\n        echo \"<!-- Notes from ERA upload processing:\\n\";\n        $alertmsg .= parse_era($tmp_name, 'era_callback');\n        echo \"-->\\n\";\n        $erafullname = $GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\";\n\n        if (is_file($erafullname)) {\n            $alertmsg .= \"Warning: Set $eraname was already uploaded \";\n            if (is_file($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.html\")) {\n                $alertmsg .= \"and processed. \";\n            } else {\n                $alertmsg .= \"but not yet processed. \";\n            }\n        }\n\n        rename($tmp_name, $erafullname);\n    } // End 835 upload\n\n    if ($eracount) {\n        // Note that parse_era() modified $eracount and $where.\n        if (! $where) {\n            $where = '1 = 2';\n        }\n    } else {\n        if ($form_name) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            // Allow the last name to be followed by a comma and some part of a first name.\n            if (preg_match('/^(.*\\S)\\s*,\\s*(.*)/', $form_name, $matches)) {\n                $where .= \"p.lname LIKE '\" . $matches[1] . \"%' AND p.fname LIKE '\" . $matches[2] . \"%'\";\n                // Allow a filter like \"A-C\" on the first character of the last name.\n            } else if (preg_match('/^(\\S)\\s*-\\s*(\\S)$/', $form_name, $matches)) {\n                $tmp = '1 = 2';\n                while (ord($matches[1]) <= ord($matches[2])) {\n                    $tmp .= \" OR p.lname LIKE '\" . $matches[1] . \"%'\";\n                    $matches[1] = chr(ord($matches[1]) + 1);\n                }\n\n                $where .= \"( $tmp ) \";\n            } else {\n                $where .= \"p.lname LIKE '%$form_name%'\";\n            }\n        }\n\n        if ($form_pid) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            $where .= \"f.pid = '$form_pid'\";\n        }\n\n        if ($form_encounter) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            $where .= \"f.encounter = '$form_encounter'\";\n        }\n\n        if ($form_date) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            if ($form_to_date) {\n                $where .= \"f.date >= '$form_date' AND f.date <= '$form_to_date'\";\n            } else {\n                $where .= \"f.date = '$form_date'\";\n            }\n        }\n\n        if (! $where) {\n            if ($_POST['form_category'] == 'All') {\n                die(xl(\"At least one search parameter is required if you select All.\"));\n            } else {\n                $where = \"1 = 1\";\n            }\n        }\n    }\n\n    // Notes that as of release 4.1.1 the copays are stored\n    // in the ar_activity table marked with a PCP in the account_code column.\n    $query = \"SELECT f.id, f.pid, f.encounter, f.date, \" .\n    \"f.last_level_billed, f.last_level_closed, f.last_stmt_date, f.stmt_count, \" .\n    \"p.fname, p.mname, p.lname, p.pubpid, p.billing_note, \" .\n    \"( SELECT SUM(b.fee) FROM billing AS b WHERE \" .\n    \"b.pid = f.pid AND b.encounter = f.encounter AND \" .\n    \"b.activity = 1 AND b.code_type != 'COPAY' ) AS charges, \" .\n    \"( SELECT SUM(a.pay_amount) FROM ar_activity AS a WHERE \" .\n    \"a.pid = f.pid AND a.encounter = f.encounter AND a.payer_type = 0 AND a.account_code = 'PCP')*-1 AS copays, \" .\n    \"( SELECT SUM(a.pay_amount) FROM ar_activity AS a WHERE \" .\n    \"a.pid = f.pid AND a.encounter = f.encounter AND a.account_code != 'PCP') AS payments, \" .\n    \"( SELECT SUM(a.adj_amount) FROM ar_activity AS a WHERE \" .\n    \"a.pid = f.pid AND a.encounter = f.encounter ) AS adjustments \" .\n    \"FROM form_encounter AS f \" .\n    \"JOIN patient_data AS p ON p.pid = f.pid \" .\n    \"WHERE $where \" .\n    \"ORDER BY p.lname, p.fname, p.mname, f.pid, f.encounter\";\n\n    // Note that unlike the SQL-Ledger case, this query does not weed\n    // out encounters that are paid up.  Also the use of sub-selects\n    // will require MySQL 4.1 or greater.\n\n    // echo \"<!-- $query -->\\n\"; // debugging\n\n    $t_res = sqlStatement($query);\n\n    $num_invoices = sqlNumRows($t_res);\n    if ($eracount && $num_invoices != $eracount) {\n          $alertmsg .= \"Of $eracount remittances, there are $num_invoices \" .\n          \"matching encounters in OpenEMR. \";\n    }\n?>\n\n<table border='0' cellpadding='1' cellspacing='2' width='98%'>\n\n <tr bgcolor=\"#dddddd\">\n  <td class=\"id\">\n        <?php xl('id', 'e');?>\n  </td>\n  <td class=\"dehead\">\n   &nbsp;<?php xl('Patient', 'e'); ?>\n </td>\n <td class=\"dehead\">\n   &nbsp;<?php xl('Invoice', 'e'); ?>\n </td>\n <td class=\"dehead\">\n   &nbsp;<?php xl('Svc Date', 'e'); ?>\n </td>\n <td class=\"dehead\">\n   &nbsp;<?php xl('Last Stmt', 'e'); ?>\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Charge', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Adjust', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Paid', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Balance', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"center\">\n    <?php xl('Prv', 'e'); ?>\n </td>\n    <?php if (!$eracount) { ?>\n <td class=\"dehead\" align=\"left\">\n    <?php xl('Sel', 'e'); ?>\n </td>\n  <td class=\"dehead\" align=\"center\">\n    <?php xl('Email', 'e'); ?>\n  </td>\n\n    <?php } ?>\n</tr>\n\n<?php\n$orow = -1;\n\nwhile ($row = sqlFetchArray($t_res)) {\n    $balance = sprintf(\"%.2f\", $row['charges'] + $row['copays'] - $row['payments'] - $row['adjustments']);\n  //new filter only patients with debt.\n    if ($_POST['only_with_debt'] && $balance <= 0) {\n        continue;\n    }\n\n\n    if ($_POST['form_category'] != 'All' && $eracount == 0 && $balance == 0) {\n        continue;\n    }\n\n      // $duncount was originally supposed to be the number of times that\n      // the patient was sent a statement for this invoice.\n      //\n    $duncount = $row['stmt_count'];\n\n      // But if we have not yet billed the patient, then compute $duncount as a\n      // negative count of the number of insurance plans for which we have not\n      // yet closed out insurance.\n      //\n    if (! $duncount) {\n        for ($i = 1; $i <= 3 && arGetPayerID($row['pid'], $row['date'], $i);\n        ++$i) {\n        }\n\n        $duncount = $row['last_level_closed'] + 1 - $i;\n    }\n\n    $isdueany = ($balance > 0);\n\n      // An invoice is now due from the patient if money is owed and we are\n      // not waiting for insurance to pay.\n      //\n    $isduept = ($duncount >= 0 && $isdueany) ? \" checked\" : \"\";\n\n      // Skip invoices not in the desired \"Due...\" category.\n      //\n    if (substr($_POST['form_category'], 0, 3) == 'Due' && !$isdueany) {\n        continue;\n    }\n\n    if ($_POST['form_category'] == 'Due Ins' && ($duncount >= 0 || !$isdueany)) {\n        continue;\n    }\n\n    if ($_POST['form_category'] == 'Due Pt'  && ($duncount <  0 || !$isdueany)) {\n        continue;\n    }\n\n    $bgcolor = ((++$orow & 1) ? \"#ffdddd\" : \"#ddddff\");\n\n    $svcdate = substr($row['date'], 0, 10);\n    $last_stmt_date = empty($row['last_stmt_date']) ? '' : $row['last_stmt_date'];\n\n      // Determine if customer is in collections.\n      //\n    $billnote = $row['billing_note'];\n    $in_collections = stristr($billnote, 'IN COLLECTIONS') !== false;\n    ?>\n  <tr bgcolor='<?php echo $bgcolor ?>'>\n      <td class=\"detail\">\n        <a href=\"\" onclick=\"return npopup(<?php echo $row['pid'] ?>)\"><?php echo $row['pid'];?></a>\n      </td>\n    <td class=\"detail\">\n     &nbsp;<a href=\"\" onclick=\"return npopup(<?php echo $row['pid'] ?>)\"\n     ><?php echo $row['lname'] . ', ' . $row['fname']; ?></a>\n   </td>\n   <td class=\"detail\">\n     &nbsp;<a href=\"sl_eob_invoice.php?id=<?php echo $row['id'] ?>\"\n     target=\"_blank\"><?php echo $row['pid'] . '.' . $row['encounter']; ?></a>\n   </td>\n   <td class=\"detail\">\n     &nbsp;<?php echo text(oeFormatShortDate($svcdate)); ?>\n   </td>\n   <td class=\"detail\">\n     &nbsp;<?php echo text(oeFormatShortDate($last_stmt_date)); ?>\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($row['charges']) ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($row['adjustments']) ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($row['payments'] - $row['copays']); ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($balance); ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"center\">\n        <?php echo $duncount ? $duncount : \"&nbsp;\" ?>\n   </td>\n    <?php if (!$eracount) { ?>\n   <td class=\"detail\" align=\"left\">\n     <input type='checkbox' name='form_cb[<?php echo($row['id']) ?>]'<?php echo $isduept ?> />\n        <?php if ($in_collections) {\n            echo \"<b><font color='red'>IC</font></b>\";\n} ?>\n        <?php if (function_exists('is_auth_portal') ? is_auth_portal($row['pid']) : false) {\n            echo(' PPt');\n            echo(\"<input type='hidden' name='form_invpids[\". $row['id'] .\"][\". $row['pid'] .\"]' />\");\n            $is_portal = true;\n}?>\n   </td>\n    <?php } ?>\n  <td class=\"detail\" align=\"left\">\n    <?php\n    $patientData = sqlQuery(\"SELECT * FROM `patient_data` WHERE `pid`=?\", array($row['pid']));\n    if ($patientData['hipaa_allowemail'] == \"YES\" && $patientData['allow_patient_portal'] == \"YES\" && $patientData['hipaa_notice'] == \"YES\" && validEmail($patientData['email'])) {\n        echo xlt(\"YES\");\n    } else {\n        echo xlt(\"NO\");\n    }\n    ?>\n  </td>\n\n </tr>\n    <?php\n} // end while\n} // end search/print logic\n\n?>\n\n</table>\n\n<p>\n    <?php if ($eracount) { ?>\n  <input type='button' value='<?php xl('Process ERA File', 'e')?>' onclick='processERA()' /> &nbsp;\n    <?php } else { ?>\n  <input type='button' value='<?php xl('Select All', 'e')?>' onclick='checkAll(true)' /> &nbsp;\n  <input type='button' value='<?php xl('Clear All', 'e')?>' onclick='checkAll(false)' /> &nbsp;\n    <?php if ($GLOBALS['statement_appearance'] != '1') { ?>\n    <input type='submit' name='form_print' value='<?php xl('Print Selected Statements', 'e'); ?>' /> &nbsp;\n    <input type='submit' name='form_download' value='<?php xl('Download Selected Statements', 'e'); ?>' /> &nbsp;\n    <?php } ?>\n  <input type='submit' name='form_pdf' value='<?php xl('PDF Download Selected Statements', 'e'); ?>' /> &nbsp;\n  <input type='submit' name='form_email' value='<?php xl('Email Selected Statements', 'e'); ?>' /> &nbsp;\n<?php if ($is_portal) {?>\n  <input type='submit' name='form_portalnotify' value='<?php xl('Notify via Patient Portal', 'e'); ?>' /> &nbsp;\n<?php }\n}?>\n  <input type='checkbox' name='form_without' value='1' /> <?php xl('Without Update', 'e'); ?>\n</p>\n\n</form>\n</center>\n<script language=\"JavaScript\">\nfunction processERA() {\n  var f = document.forms[0];\n  var debug = f.form_without.checked ? '1' : '0';\n  var paydate = f.form_paydate.value;\n  window.open('sl_eob_process.php?eraname=<?php echo $eraname ?>&debug=' + debug + '&paydate=' + paydate + '&original=original', '_blank');\n  return false;\n}\n<?php\nif ($alertmsg) {\n    echo \"alert('\" . htmlentities($alertmsg) . \"');\\n\";\n}\n\n?>\n</script>\n</body>\n</html>\n", "<?php\n/********************************************************************************\\\n * Copyright (C) ViCarePlus, Visolve (vicareplus_engg@visolve.com)              *\n *                                                                              *\n * This program is free software; you can redistribute it and/or                *\n * modify it under the terms of the GNU General Public License                  *\n * as published by the Free Software Foundation; either version 2               *\n * of the License, or (at your option) any later version.                       *\n *                                                                              *\n * This program is distributed in the hope that it will be useful,              *\n * but WITHOUT ANY WARRANTY; without even the implied warranty of               *\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                *\n * GNU General Public License for more details.                                 *\n *                                                                              *\n * You should have received a copy of the GNU General Public License            *\n * along with this program; if not, write to the Free Software                  *\n * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.  *\n \\********************************************************************************/\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"../../custom/code_types.inc.php\");\n\n$info_msg = \"\";\n$codetype = $_REQUEST['codetype'];\n$form_code_type = $_POST['form_code_type'];\n?>\n<html>\n<head>\n<?php html_header_show(); ?>\n<title><?php xl('Code Finder', 'e'); ?></title>\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n\n<style>\ntd { font-size:10pt; }\n</style>\n\n<script language=\"JavaScript\">\n//pass value selected to the parent window\n function window_submit(chk)\n { \n  var str;\n  var len=chk.length;\n  if (len==undefined && chk.checked==1) \n  {\n    if(!str)\n      str = chk.value;\n    else  \n    str = \"#\"+chk.value;\n  }\n  else\n  {\n  for (pr = 0; pr < chk.length; pr++)\n   {\n    if(chk[pr].checked == 1)\n    {\n     if(!str)\n      str = chk[pr].value;\n     else \n      str = str+\"#\"+chk[pr].value;\n    }\n   }\n  }\n  if(!str)\n    alert('<?php echo xl(\"Select Diagnosis\");?>');\n  if (opener.closed || ! opener.set_related)\n   alert(\"<?php echo xl('The destination form was closed');?>\");\n  else\n   opener.set_related(str,\"diagnosis\");\n   \n  window.close();\n  \n }\n \nfunction window_close(chk)\n{\n window.close();\n}\n \nfunction chkbox_select_none(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=false;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=false;\n  }\n }\n}\n\nfunction chkbox_select_all(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=true;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=true;\n  }\n }\n}\n\nfunction check_search_str()\n{\n var search_str = document.getElementById('search_term').value;\n if(search_str.length < 3)\n {\n  alert('<?php echo xl(\"Search string should have at least three characters\");?>');\n  return false;\n }\n top.restoreSession();\n return true; \n}\n\n</script>\n</head>\n<body class=\"body_top\">\n<form method='post' name='theform'  action='find_code_popup.php' onsubmit=\"return check_search_str();\">\n<center>\n <input type=\"hidden\" name=\"search_status\" id=\"search_status\" value=1;>\n<table border='0' cellpadding='5' cellspacing='0'>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n <tr>\n  <td>\n   <b>\n<?php\nif ($codetype) {\n    echo \"<input type='text' name='form_code_type' value='$codetype' size='5' readonly>\\n\";\n} else {\n    echo \"   <select name='form_code_type'\";\n    echo \">\\n\";\n    foreach ($code_types as $key => $value) {\n        echo \"    <option value='$key'\";\n        if ($codetype == $key || $form_code_type == $key) {\n            echo \" selected\";\n        }\n\n        echo \">$key</option>\\n\";\n    }\n\n    echo \"    <option value='PROD'\";\n    if ($codetype == 'PROD' || $form_code_type == 'PROD') {\n        echo \" selected\";\n    }\n\n    echo \">Product</option>\\n\";\n    echo \"   </select>&nbsp;&nbsp;\\n\";\n}\n?>\n    <?php xl('Search for', 'e'); ?>\n   <input type='text' name='search_term' id='search_term' size='12' value='<?php echo $_REQUEST['search_term']; ?>'\n    title='<?php xl('Any part of the desired code or its description', 'e'); ?>' />\n   &nbsp;  \n   <input type='submit' name='bn_search' id='bn_search' value='<?php xl('Search', 'e'); ?>' />   \n   </b>\n  </td>\n </tr>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n</table>\n</center>\n</form>\n<form method='post' name='select_diagonsis'>\n<table border='0'>\n <tr>\n <td colspan=\"4\">\n<?php if ($_REQUEST['bn_search']) {\n    $search_term = $_REQUEST['search_term'];\n    if ($form_code_type == 'PROD') {\n        $query = \"SELECT dt.drug_id, dt.selector, d.name \" .\n        \"FROM drug_templates AS dt, drugs AS d WHERE \" .\n        \"( d.name LIKE '%$search_term%' OR \" .\n        \"dt.selector LIKE '%$search_term%' ) \" .\n        \"AND d.drug_id = dt.drug_id \" .\n        \"ORDER BY d.name, dt.selector, dt.drug_id\";\n        $res = sqlStatement($query);\n        $row_count = 0;\n        while ($row = sqlFetchArray($res)) {\n            $row_count = $row_count + 1;\n            $drug_id = addslashes($row['drug_id']);\n            $selector = addslashes($row['selector']);\n            $desc = addslashes($row['name']);\n            ?>    \n             <input type=\"checkbox\" name=\"diagnosis[row_count]\" value= \"<?php echo $desc; ?>\" > <?php echo $drug_id.\"    \".$selector.\"     \".$desc.\"</br>\";\n        }\n    } else {\n        $query = \"SELECT count(*) as count FROM codes \" .\n        \"WHERE (code_text LIKE '%$search_term%' OR \" .\n        \"code LIKE '%$search_term%') \" ;\n        $res = sqlStatement($query);\n        if ($row = sqlFetchArray($res)) {\n            $no_of_items = addslashes($row['count']);\n            if ($no_of_items < 1) {\n                ?>\n             <script language='JavaScript'>\n            alert(\"<?php echo xl('Search string does not match with list in database');\n            echo '\\n';\n            echo xl('Please enter new search string');?>\");\n          document.theform.search_term.value=\" \";\n             document.theform.search_term.focus();\n             </script>    \n                <?php\n            }\n\n            $query = \"SELECT code_type, code, modifier, code_text FROM codes \" .\n            \"WHERE (code_text LIKE '%$search_term%' OR \" .\n            \"code LIKE '%$search_term%') \" .\n            \"ORDER BY code\";\n          // echo \"\\n<!-- $query -->\\n\"; // debugging\n            $res = sqlStatement($query);\n            $row_count = 0;\n            while ($row = sqlFetchArray($res)) {\n                $row_count = $row_count + 1;\n                $itercode = addslashes($row['code']);\n                $itertext = addslashes(ucfirst(strtolower(trim($row['code_text']))));\n                ?>\n                 <input type=\"checkbox\" id=\"chkbox\" value= \"<?php echo $form_code_type.\":\".$itercode.\"-\".$itertext; ?>\" > <?php echo $itercode.\"    \".$itertext.\"</br>\";\n            }\n        }\n    }\n    ?>\n  </td>\n </tr>\n </table>\n<center>\n</br>\n <input type='button' id='select_all' value='<?php xl('Select All', 'e'); ?>' onclick=\"chkbox_select_all(document.select_diagonsis.chkbox);\"/>\n \n <input type='button' id='unselect_all' value='<?php xl('Unselect All', 'e'); ?>' onclick=\"chkbox_select_none(document.select_diagonsis.chkbox);\"/>\n \n <input type='button' id='submit' value='<?php xl('Submit', 'e'); ?>' onclick=\"window_submit(document.select_diagonsis.chkbox);\"/>\n \n <input type='button' id='cancel' value='<?php xl('Cancel', 'e'); ?>' onclick=\"window_close();\"/>\n \n</center> \n<?php } ?>\n</form>\n</body>\n</html>\n", "<?php\n/********************************************************************************\\\n * Copyright (C) ViCarePlus, Visolve (vicareplus_engg@visolve.com)              *\n *                                                                              *\n * This program is free software; you can redistribute it and/or                *\n * modify it under the terms of the GNU General Public License                  *\n * as published by the Free Software Foundation; either version 2               *\n * of the License, or (at your option) any later version.                       *\n *                                                                              *\n * This program is distributed in the hope that it will be useful,              *\n * but WITHOUT ANY WARRANTY; without even the implied warranty of               *\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                *\n * GNU General Public License for more details.                                 *\n *                                                                              *\n * You should have received a copy of the GNU General Public License            *\n * along with this program; if not, write to the Free Software                  *\n * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.  *\n \\********************************************************************************/\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"../../custom/code_types.inc.php\");\n\n$info_msg = \"\";\n$codetype = $_REQUEST['codetype'];\n$form_code_type = $_POST['form_code_type'];\n?>\n<html>\n<head>\n<?php html_header_show(); ?>\n<title><?php xl('Immunization', 'e'); ?></title>\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n<style>\ntd { font-size:10pt; }\n</style>\n<script language=\"JavaScript\">\n//pass value selected to the parent window\n function window_submit(chk)\n { \n  var str;\n  var len=chk.length;\n  if (len==undefined && chk.checked==1) \n  {\n    if(!str)\n      str = chk.value;\n    else  \n    str = \"#\"+chk.value;\n  }\n  else\n  {\n  for (pr = 0; pr < chk.length; pr++)\n   {\n    if(chk[pr].checked == 1)\n    {\n     if(!str)\n      str = chk[pr].value;\n     else \n      str = str+\"#\"+chk[pr].value;\n    }\n   }\n  }\n  if(!str)\n    alert('<?php echo xl(\"Select Immunizations\");?>');\n  if (opener.closed || ! opener.set_related)\n   alert(\"<?php echo xl('The destination form was closed');?>\");\n  else\n   opener.set_related(str,\"immunizations\");\n   \n  window.close();\n  \n }\n \nfunction window_close(chk)\n{\n window.close();\n}\n \nfunction chkbox_select_none(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=false;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=false;\n  }\n }\n}\n\nfunction chkbox_select_all(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=true;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=true;\n  }\n }\n}\n\nfunction check_search_str()\n{\n var search_str = document.getElementById('search_term').value;\n if(search_str.length < 3)\n {\n  alert('<?php echo xl(\"Search string should have at least three characters\");?>');\n  return false;\n }\n top.restoreSession();\n return true;\n}   \n</script>\n</head>\n<body class=\"body_top\">\n<form method='post' name='theform'  action='find_immunization_popup.php' onsubmit=\"return check_search_str();\">\n<center>\n<table border='0' cellpadding='5' cellspacing='0'>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n <tr>\n  <td>\n   <b>\n    <?php xl('Search for', 'e'); ?>\n   <input type='text' name='search_term' id='search_term' size='12' value='<?php echo $_REQUEST['search_term']; ?>'\n    title='<?php xl('Any part of the immunization id or immunization name', 'e'); ?>' />\n   &nbsp;\n   <input type='submit' name='bn_search' value='<?php xl('Search', 'e'); ?>' />  \n   </b>\n  </td>\n </tr>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n</table>\n</center>\n</form>\n<form method='post' name='select_immunization'>\n<?php if ($_REQUEST['bn_search']) { ?>\n<table border='0'>\n <tr>\n  <td colspan=\"4\">  \n<?php\n  $search_term = $_REQUEST['search_term'];\n  {\n    $query = \"SELECT count(*) as count FROM list_options \" .\n      \"WHERE (list_id = 'immunizations' and title LIKE '%$search_term%' AND activity = 1) \" ;\n    $res = sqlStatement($query);\nif ($row = sqlFetchArray($res)) {\n    $no_of_items = addslashes($row['count']);\n    if ($no_of_items < 1) {\n        ?>\n     <script language='JavaScript'>\n        alert(\"<?php echo xl('Search string does not match with list in database');\n        echo '\\n';\n        echo xl('Please enter new search string');?>\");\n     document.theform.search_term.value=\" \";\n     document.theform.search_term.focus();\n     </script>    \n        <?php\n    }\n\n    $query = \"SELECT option_id,title FROM list_options \" .\n    \"WHERE (list_id = 'immunizations' and title LIKE '%$search_term%' AND activity = 1) \" .\n    \"ORDER BY title\";\n    $res = sqlStatement($query);\n    $row_count = 0;\n    while ($row = sqlFetchArray($res)) {\n        $row_count = $row_count + 1;\n        $itercode = addslashes($row['option_id']);\n        $itertext = addslashes(ucfirst(strtolower(trim($row['title']))));\n        ?>\n       <input type=\"checkbox\" id=\"chkbox\" value= \"<?php echo $itercode.\"-\".$itertext; ?>\" > <?php echo $itercode.\"    \".$itertext.\"</br>\";\n    }\n}\n\n  }\n?>\n</td>\n</tr>\n </table>\n<center>\n <input type='button' name='select_all' value='<?php xl('Select All', 'e'); ?>' onclick=\"chkbox_select_all(document.select_immunization.chkbox);\"/>\n \n <input type='button' name='select_none' value='<?php xl('Unselect All', 'e'); ?>' onclick=\"chkbox_select_none(document.select_immunization.chkbox);\"/>\n \n <input type='button' name='submit' value='<?php xl('Submit', 'e'); ?>' onclick=\"window_submit(document.select_immunization.chkbox);\"/>\n \n <input type='button' name='cancel' value='<?php xl('Cancel', 'e'); ?>' onclick=\"window_close();\"/>\n \n </center>\n<?php } ?>\n</form>\n</body>\n</html>\n", "<?php\n/**\n * fax dispatch\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2006-2010 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2017 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/pnotes.inc\");\nrequire_once(\"$srcdir/forms.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/gprelations.inc.php\");\n\nif ($_GET['file']) {\n    $mode = 'fax';\n    $filename = $_GET['file'];\n\n  // ensure the file variable has no illegal characters\n    check_file_dir_name($filename);\n\n    $filepath = $GLOBALS['hylafax_basedir'] . '/recvq/' . $filename;\n} else if ($_GET['scan']) {\n    $mode = 'scan';\n    $filename = $_GET['scan'];\n    $filepath = $GLOBALS['scanner_output_directory'] . '/' . $filename;\n} else {\n    die(\"No filename was given.\");\n}\n\n$ext = substr($filename, strrpos($filename, '.'));\n$filebase = basename(\"/$filename\", $ext);\n$faxcache = $GLOBALS['OE_SITE_DIR'] . \"/faxcache/$mode/$filebase\";\n\n$info_msg = \"\";\n\n// This function builds an array of document categories recursively.\n// Kittens are the children of cats, you know.  :-)getKittens\n//\nfunction getKittens($catid, $catstring, &$categories)\n{\n    $cres = sqlStatement(\"SELECT id, name FROM categories \" .\n    \"WHERE parent = $catid ORDER BY name\");\n    $childcount = 0;\n    while ($crow = sqlFetchArray($cres)) {\n        ++$childcount;\n        getKittens($crow['id'], ($catstring ? \"$catstring / \" : \"\") .\n        ($catid ? $crow['name'] : ''), $categories);\n    }\n\n  // If no kitties, then this is a leaf node and should be listed.\n    if (!$childcount) {\n        $categories[$catid] = $catstring;\n    }\n}\n\n// This merges the tiff files for the selected pages into one tiff file.\n//\nfunction mergeTiffs()\n{\n    global $faxcache;\n    $msg = '';\n    $inames = '';\n    $tmp1 = array();\n    $tmp2 = 0;\n  // form_images are the checkboxes to the right of the images.\n    foreach ($_POST['form_images'] as $inbase) {\n        $inames .= ' ' . escapeshellarg(\"$inbase.tif\");\n    }\n\n    if (!$inames) {\n        die(xl(\"Internal error - no pages were selected!\"));\n    }\n\n    $tmp0 = exec(\"cd '$faxcache'; tiffcp $inames temp.tif\", $tmp1, $tmp2);\n    if ($tmp2) {\n        $msg .= \"tiffcp returned $tmp2: $tmp0 \";\n    }\n\n    return $msg;\n}\n\n// If we are submitting...\n//\nif ($_POST['form_save']) {\n    $action_taken = false;\n    $tmp1 = array();\n    $tmp2 = 0;\n\n    if ($_POST['form_cb_copy']) {\n        $patient_id = (int) $_POST['form_pid'];\n        if (!$patient_id) {\n            die(xl('Internal error - patient ID was not provided!'));\n        }\n\n        // Compute the name of the target directory and make sure it exists.\n        $docdir = $GLOBALS['OE_SITE_DIR'] . \"/documents/$patient_id\";\n        exec(\"mkdir -p '$docdir'\");\n\n        // If copying to patient documents...\n        //\n        if ($_POST['form_cb_copy_type'] == 1) {\n            // Compute a target filename that does not yet exist.\n            $ffname = check_file_dir_name(trim($_POST['form_filename']));\n            $i = strrpos($ffname, '.');\n            if ($i) {\n                $ffname = trim(substr($ffname, 0, $i));\n            }\n\n            if (!$ffname) {\n                $ffname = $filebase;\n            }\n\n            $ffmod  = '';\n            $ffsuff = '.pdf';\n            // If the target filename exists, modify it until it doesn't.\n            $count = 0;\n            while (is_file(\"$docdir/$ffname$ffmod$ffsuff\")) {\n                ++$count;\n                $ffmod = \"_$count\";\n            }\n\n            $target = \"$docdir/$ffname$ffmod$ffsuff\";\n            $docdate = fixDate($_POST['form_docdate']);\n\n            // Create the target PDF.  Note that we are relying on the .tif files for\n            // the individual pages to already exist in the faxcache directory.\n            //\n            $info_msg .= mergeTiffs();\n            // The -j option here requires that libtiff is configured with libjpeg.\n            // It could be omitted, but the output PDFs would then be quite large.\n            $tmp0 = exec(\"tiff2pdf -j -p letter -o '$target' '$faxcache/temp.tif'\", $tmp1, $tmp2);\n\n            if ($tmp2) {\n                $info_msg .= \"tiff2pdf returned $tmp2: $tmp0 \";\n            } else {\n                $newid = generate_id();\n                $fsize = filesize($target);\n                $catid = (int) $_POST['form_category'];\n                // Update the database.\n                $query = \"INSERT INTO documents ( \" .\n                \"id, type, size, date, url, mimetype, foreign_id, docdate\" .\n                \" ) VALUES ( \" .\n                \"'$newid', 'file_url', '$fsize', NOW(), 'file://$target', \" .\n                \"'application/pdf', $patient_id, '$docdate' \" .\n                \")\";\n                sqlStatement($query);\n                $query = \"INSERT INTO categories_to_documents ( \" .\n                \"category_id, document_id\" .\n                \" ) VALUES ( \" .\n                \"'$catid', '$newid' \" .\n                \")\";\n                sqlStatement($query);\n            } // end not error\n\n            // If we are posting a note...\n            if ($_POST['form_cb_note'] && !$info_msg) {\n                // Build note text in a way that identifies the new document.\n                // See pnotes_full.php which uses this to auto-display the document.\n                $note = \"$ffname$ffmod$ffsuff\";\n                for ($tmp = $catid; $tmp;) {\n                    $catrow = sqlQuery(\"SELECT name, parent FROM categories WHERE id = '$tmp'\");\n                    $note = $catrow['name'] . \"/$note\";\n                    $tmp = $catrow['parent'];\n                }\n\n                $note = \"New scanned document $newid: $note\";\n                $form_note_message = trim($_POST['form_note_message']);\n                $form_note_message = strip_escape_custom($form_note_message);\n                if ($form_note_message) {\n                    $note .= \"\\n\" . $form_note_message;\n                }\n\n                // addPnote() will do its own addslashes().\n                $noteid = addPnote(\n                    $_POST['form_pid'],\n                    $note,\n                    $userauthorized,\n                    '1',\n                    $_POST['form_note_type'],\n                    $_POST['form_note_to']\n                );\n                // Link the new patient note to the document.\n                setGpRelation(1, $newid, 6, $noteid);\n            } // end post patient note\n        } // end copy to documents\n\n        // Otherwise creating a scanned encounter note...\n        //\n        else {\n            // Get desired $encounter_id.\n            $encounter_id = 0;\n            if (empty($_POST['form_copy_sn_visit'])) {\n                $info_msg .= \"This patient has no visits! \";\n            } else {\n                $encounter_id = 0 + $_POST['form_copy_sn_visit'];\n            }\n\n            if (!$info_msg) {\n                // Merge the selected pages.\n                $info_msg .= mergeTiffs();\n                $tmp_name = \"$faxcache/temp.tif\";\n            }\n\n            if (!$info_msg) {\n                // The following is cloned from contrib/forms/scanned_notes/new.php:\n                //\n                $query = \"INSERT INTO form_scanned_notes ( \" .\n                \"notes \" .\n                \") VALUES ( \" .\n                \"'\" . $_POST['form_copy_sn_comments'] . \"' \" .\n                \")\";\n                $formid = sqlInsert($query);\n                addForm(\n                    $encounter_id,\n                    \"Scanned Notes\",\n                    $formid,\n                    \"scanned_notes\",\n                    $patient_id,\n                    $userauthorized\n                );\n                //\n                $imagedir = $GLOBALS['OE_SITE_DIR'] . \"/documents/$patient_id/encounters\";\n                $imagepath = \"$imagedir/${encounter_id}_$formid.jpg\";\n                if (! is_dir($imagedir)) {\n                        $tmp0 = exec('mkdir -p \"' . $imagedir . '\"', $tmp1, $tmp2);\n                    if ($tmp2) {\n                        die(\"mkdir returned $tmp2: $tmp0\");\n                    }\n\n                        exec(\"touch '$imagedir/index.html'\");\n                }\n\n                if (is_file($imagepath)) {\n                    unlink($imagepath);\n                }\n\n                // TBD: There may be a faster way to create this file, given that\n                // we already have a jpeg for each page in faxcache.\n                $cmd = \"convert -resize 800 -density 96 '$tmp_name' -append '$imagepath'\";\n                $tmp0 = exec($cmd, $tmp1, $tmp2);\n                if ($tmp2) {\n                    die(\"\\\"$cmd\\\" returned $tmp2: $tmp0\");\n                }\n            }\n\n            // If we are posting a patient note...\n            if ($_POST['form_cb_note'] && !$info_msg) {\n                $note = \"New scanned encounter note for visit on \" . substr($erow['date'], 0, 10);\n                $form_note_message = trim($_POST['form_note_message']);\n                $form_note_message = strip_escape_custom($form_note_message);\n                if ($form_note_message) {\n                    $note .= \"\\n\" . $form_note_message;\n                }\n\n                // addPnote() will do its own addslashes().\n                addPnote(\n                    $patient_id,\n                    $note,\n                    $userauthorized,\n                    '1',\n                    $_POST['form_note_type'],\n                    $_POST['form_note_to']\n                );\n            } // end post patient note\n        }\n\n        $action_taken = true;\n    } // end copy to chart\n\n    if ($_POST['form_cb_forward']) {\n        $form_from     = trim($_POST['form_from']);\n        $form_to       = trim($_POST['form_to']);\n        $form_fax      = trim($_POST['form_fax']);\n        $form_message  = trim($_POST['form_message']);\n        $form_finemode = $_POST['form_finemode'] ? '-m' : '-l';\n\n        $form_from    = strip_escape_custom($form_from);\n        $form_to      = strip_escape_custom($form_to);\n        $form_message = strip_escape_custom($form_message);\n\n        // Generate a cover page using enscript.  This can be a cool thing\n        // to do, as enscript is very powerful.\n        //\n        $tmp1 = array();\n        $tmp2 = 0;\n        $tmpfn1 = tempnam(\"/tmp\", \"fax1\");\n        $tmpfn2 = tempnam(\"/tmp\", \"fax2\");\n        $tmph = fopen($tmpfn1, \"w\");\n        $cpstring = '';\n        $fh = fopen($GLOBALS['OE_SITE_DIR'] . \"/faxcover.txt\", 'r');\n        while (!feof($fh)) {\n            $cpstring .= fread($fh, 8192);\n        }\n\n        fclose($fh);\n        $cpstring = str_replace('{CURRENT_DATE}', date('F j, Y'), $cpstring);\n        $cpstring = str_replace('{SENDER_NAME}', $form_from, $cpstring);\n        $cpstring = str_replace('{RECIPIENT_NAME}', $form_to, $cpstring);\n        $cpstring = str_replace('{RECIPIENT_FAX}', $form_fax, $cpstring);\n        $cpstring = str_replace('{MESSAGE}', $form_message, $cpstring);\n        fwrite($tmph, $cpstring);\n        fclose($tmph);\n        $tmp0 = exec(\"cd $webserver_root/custom; \" . $GLOBALS['hylafax_enscript'] .\n        \" -o $tmpfn2 $tmpfn1\", $tmp1, $tmp2);\n        if ($tmp2) {\n              $info_msg .= \"enscript returned $tmp2: $tmp0 \";\n        }\n\n        unlink($tmpfn1);\n\n        // Send the fax as the cover page followed by the selected pages.\n        $info_msg .= mergeTiffs();\n        $tmp0 = exec(\n            \"sendfax -A -n $form_finemode -d \" .\n            escapeshellarg($form_fax) . \" $tmpfn2 '$faxcache/temp.tif'\",\n            $tmp1,\n            $tmp2\n        );\n        if ($tmp2) {\n              $info_msg .= \"sendfax returned $tmp2: $tmp0 \";\n        }\n\n        unlink($tmpfn2);\n\n        $action_taken = true;\n    } // end forward\n\n    $form_cb_delete = $_POST['form_cb_delete'];\n\n  // If deleting selected, do it and then check if any are left.\n    if ($form_cb_delete == '1' && !$info_msg) {\n        foreach ($_POST['form_images'] as $inbase) {\n            unlink(\"$faxcache/$inbase.jpg\");\n            $action_taken = true;\n        }\n\n        // Check if any .jpg files remain... if not we'll clean up.\n        if ($action_taken) {\n            $dh = opendir($faxcache);\n            if (! $dh) {\n                die(\"Cannot read $faxcache\");\n            }\n\n            $form_cb_delete = '2';\n            while (false !== ($jfname = readdir($dh))) {\n                if (preg_match('/\\.jpg$/', $jfname)) {\n                    $form_cb_delete = '1';\n                }\n            }\n\n            closedir($dh);\n        }\n    } // end delete 1\n\n    if ($form_cb_delete == '2' && !$info_msg) {\n        // Delete the tiff file, with archiving if desired.\n        if ($GLOBALS['hylafax_archdir'] && $mode == 'fax') {\n            rename($filepath, $GLOBALS['hylafax_archdir'] . '/' . $filename);\n        } else {\n            unlink($filepath);\n        }\n\n        // Erase its cache.\n        if (is_dir($faxcache)) {\n            $dh = opendir($faxcache);\n            while (($tmp = readdir($dh)) !== false) {\n                if (is_file(\"$faxcache/$tmp\")) {\n                    unlink(\"$faxcache/$tmp\");\n                }\n            }\n\n            closedir($dh);\n            rmdir($faxcache);\n        }\n\n        $action_taken = true;\n    } // end delete 2\n\n    if (!$action_taken && !$info_msg) {\n        $info_msg = xl('You did not choose any actions.');\n    }\n\n    if ($info_msg || $form_cb_delete != '1') {\n        // Close this window and refresh the fax list.\n        echo \"<html>\\n<body>\\n<script language='JavaScript'>\\n\";\n        if ($info_msg) {\n            echo \" alert('$info_msg');\\n\";\n        }\n\n        echo \" if (!opener.closed && opener.refreshme) opener.refreshme();\\n\";\n        echo \" window.close();\\n\";\n        echo \"</script>\\n</body>\\n</html>\\n\";\n        exit();\n    }\n} // end submit logic\n\n// If we get this far then we are displaying the form.\n\n// Find out if the scanned_notes form is installed and active.\n//\n$tmp = sqlQuery(\"SELECT count(*) AS count FROM registry WHERE \" .\n  \"directory LIKE 'scanned_notes' AND state = 1 AND sql_run = 1\");\n$using_scanned_notes = $tmp['count'];\n\n// If the image cache does not yet exist for this fax, build it.\n// This will contain a .tif image as well as a .jpg image for each page.\n//\nif (! is_dir($faxcache)) {\n    $tmp0 = exec('mkdir -p \"' . $faxcache . '\"', $tmp1, $tmp2);\n    if ($tmp2) {\n        die(\"mkdir returned $tmp2: $tmp0\");\n    }\n\n    if (strtolower($ext) != '.tif') {\n        // convert's default density for PDF-to-TIFF conversion is 72 dpi which is\n        // not very good, so we upgrade it to \"fine mode\" fax quality.  It's really\n        // better and faster if the scanner produces TIFFs instead of PDFs.\n        $tmp0 = exec(\"convert -density 203x196 '$filepath' '$faxcache/deleteme.tif'\", $tmp1, $tmp2);\n        if ($tmp2) {\n            die(\"convert returned $tmp2: $tmp0\");\n        }\n\n        $tmp0 = exec(\"cd '$faxcache'; tiffsplit 'deleteme.tif'; rm -f 'deleteme.tif'\", $tmp1, $tmp2);\n        if ($tmp2) {\n            die(\"tiffsplit/rm returned $tmp2: $tmp0\");\n        }\n    } else {\n        $tmp0 = exec(\"cd '$faxcache'; tiffsplit '$filepath'\", $tmp1, $tmp2);\n        if ($tmp2) {\n            die(\"tiffsplit returned $tmp2: $tmp0\");\n        }\n    }\n\n    $tmp0 = exec(\"cd '$faxcache'; mogrify -resize 750x970 -format jpg *.tif\", $tmp1, $tmp2);\n    if ($tmp2) {\n        die(\"mogrify returned $tmp2: $tmp0; ext is '$ext'; filepath is '$filepath'\");\n    }\n}\n\n// Get the categories list.\n$categories = array();\ngetKittens(0, '', $categories);\n\n// Get the users list.\n$ures = sqlStatement(\"SELECT username, fname, lname FROM users \" .\n  \"WHERE active = 1 AND ( info IS NULL OR info NOT LIKE '%Inactive%' ) \" .\n  \"ORDER BY lname, fname\");\n?>\n<html>\n<head>\n<?php if (function_exists(html_header_show)) {\n    html_header_show();\n} ?>\n<title><?php xl('Dispatch Received Document', 'e'); ?></title>\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n<link rel=\"stylesheet\" href=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-datetimepicker-2-5-4/build/jquery.datetimepicker.min.css\">\n\n<style>\n\ntd, input, select, textarea {\n font-size: 10pt;\n}\n\n.itemtitle {\n font-weight: bold;\n}\n\ndiv.section {\n border: solid;\n border-width: 1px;\n border-color: #0000ff;\n margin-left: 2em;\n padding: 1em;\n}\n\n</style>\n\n<script type=\"text/javascript\" src=\"../../library/topdialog.js?v=<?php echo $v_js_includes; ?>\"></script>\n<script type=\"text/javascript\" src=\"../../library/dialog.js?v=<?php echo $v_js_includes; ?>\"></script>\n<script type=\"text/javascript\" src=\"../../library/textformat.js?v=<?php echo $v_js_includes; ?>\"></script>\n<script type=\"text/javascript\" src=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-min-1-7-2/index.js\"></script>\n<script type=\"text/javascript\" src=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-datetimepicker-2-5-4/build/jquery.datetimepicker.full.min.js\"></script>\n\n<script language=\"JavaScript\">\n\n<?php require($GLOBALS['srcdir'] . \"/restoreSession.php\"); ?>\n\n function divclick(cb, divid) {\n  var divstyle = document.getElementById(divid).style;\n  if (cb.checked) {\n   if (divid == 'div_copy_doc') {\n    document.getElementById('div_copy_sn').style.display = 'none';\n   }\n   else if (divid == 'div_copy_sn') {\n    document.getElementById('div_copy_doc').style.display = 'none';\n   }\n   divstyle.display = 'block';\n  } else {\n   divstyle.display = 'none';\n  }\n  return true;\n }\n\n // This is for callback by the find-patient popup.\n function setpatient(pid, lname, fname, dob) {\n  var f = document.forms[0];\n  f.form_patient.value = lname + ', ' + fname;\n  f.form_pid.value = pid;\n<?php if ($using_scanned_notes) { ?>\n  // This loads the patient's list of recent encounters:\n  f.form_copy_sn_visit.options.length = 0;\n  f.form_copy_sn_visit.options[0] = new Option('Loading...', '0');\n  $.getScript(\"fax_dispatch_newpid.php?p=\" + pid);\n<?php } ?>\n }\n\n // This invokes the find-patient popup.\n function sel_patient() {\n  dlgopen('../main/calendar/find_patient_popup.php', '_blank', 500, 400);\n }\n\n // Check for errors when the form is submitted.\n function validate() {\n  var f = document.forms[0];\n\n  if (f.form_cb_copy.checked) {\n   if (! f.form_pid.value) {\n    alert('You have not selected a patient!');\n    return false;\n   }\n  }\n\n  if (f.form_cb_forward.checked) {\n   var s = f.form_fax.value;\n   if (! s) {\n    alert('A fax number is required!');\n    return false;\n   }\n   var digcount = 0;\n   for (var i = 0; i < s.length; ++i) {\n    var c = s.charAt(i);\n    if (c >= '0' && c <= '9') {\n     ++digcount;\n    }\n    else if (digcount == 0 || c != '-') {\n     alert('Invalid character(s) in fax number!');\n     return false;\n    }\n   }\n   if (digcount == 7) {\n    if (s.charAt(0) < '2') {\n     alert('Local phone number starts with an invalid digit!');\n     return false;\n    }\n   }\n   else if (digcount == 11) {\n    if (s.charAt(0) != '1') {\n     alert('11-digit number must begin with 1!');\n     return false;\n    }\n   }\n   else if (digcount == 10) {\n    if (s.charAt(0) < '2') {\n     alert('10-digit number starts with an invalid digit!');\n     return false;\n    }\n    f.form_fax.value = '1' + s;\n   }\n   else {\n    alert('Invalid number of digits in fax telephone number!');\n    return false;\n   }\n  }\n\n  if (f.form_cb_copy.checked || f.form_cb_forward.checked) {\n   var check_count = 0;\n   for (var i = 0; i < f.elements.length; ++i) {\n    if (f.elements[i].name == 'form_images[]' && f.elements[i].checked)\n     ++check_count;\n   }\n   if (check_count == 0) {\n    alert('No pages have been selected!');\n    return false;\n   }\n  }\n\n  top.restoreSession();\n  return true;\n }\n\n function allCheckboxes(issel) {\n  var f = document.forms[0];\n  for (var i = 0; i < f.elements.length; ++i) {\n   if (f.elements[i].name == 'form_images[]') f.elements[i].checked = issel;\n  }\n }\n\n    $(document).ready(function(){\n        $('.datepicker').datetimepicker({\n            <?php $datetimepicker_timepicker = false; ?>\n            <?php $datetimepicker_showseconds = false; ?>\n            <?php $datetimepicker_formatInput = false; ?>\n            <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n            <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n        });\n    });\n</script>\n\n</head>\n\n<body class=\"body_top\" onunload='imclosing()'>\n\n<center><h2><?php xl('Dispatch Received Document', 'e'); ?></h2></center>\n\n<form method='post' name='theform'\n action='fax_dispatch.php?<?php echo ($mode == 'fax') ? 'file' : 'scan'; ?>=<?php echo $filename ?>' onsubmit='return validate()'>\n\n<p><input type='checkbox' name='form_cb_copy' value='1'\n onclick='return divclick(this,\"div_copy\");' />\n<b><?php xl('Copy Pages to Patient Chart', 'e'); ?></b></p>\n\n<div id='div_copy' class='section' style='display:none;'>\n <table>\n  <tr>\n   <td class='itemtitle' width='1%' nowrap><?php xl('Patient', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_patient' style='width:100%'\n     value=' (<?php xl('Click to select'); ?>)' onclick='sel_patient()'\n     title='Click to select patient' readonly />\n    <input type='hidden' name='form_pid' value='0' />\n   </td>\n  </tr>\n  <tr>\n   <td colspan='2' style='padding-top:0.5em;'>\n    <input type='radio' name='form_cb_copy_type' value='1'\n     onclick='return divclick(this,\"div_copy_doc\");' checked />\n    <b><?php xl('Patient Document', 'e'); ?></b>&nbsp;\n<?php if ($using_scanned_notes) { ?>\n    <input type='radio' name='form_cb_copy_type' value='2'\n     onclick='return divclick(this,\"div_copy_sn\");' />\n    <b><?php xl('Scanned Encounter Note', 'e'); ?></b>\n<?php } ?>\n    <div id='div_copy_doc' class='section' style='margin-top:0.5em;'>\n     <table width='100%'>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Category', 'e'); ?></td>\n       <td>\n        <select name='form_category' style='width:100%'>\n<?php\nforeach ($categories as $catkey => $catname) {\n    echo \"         <option value='$catkey'\";\n    echo \">$catname</option>\\n\";\n}\n?>\n        </select>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Filename', 'e'); ?></td>\n       <td>\n        <input type='text' size='10' name='form_filename' style='width:100%'\n        value='<?php  echo \"$filebase.pdf\" ?>'\n        title='Name for this document in the patient chart' />\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Document Date', 'e'); ?></td>\n       <td>\n        <input type='text' class='datepicker' size='10' name='form_docdate' id='form_docdate'\n        value='<?php echo date('Y-m-d'); ?>'\n        title='<?php xl('yyyy-mm-dd date associated with this document', 'e'); ?>' />\n       </td>\n      </tr>\n     </table>\n    </div><!-- end div_copy_doc -->\n    <div id='div_copy_sn' class='section' style='display:none;margin-top:0.5em;'>\n     <table width='100%'>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap><?php xl('Visit Date', 'e'); ?></td>\n       <td>\n        <select name='form_copy_sn_visit' style='width:100%'>\n        </select>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap><?php xl('Comments', 'e'); ?></td>\n       <td>\n        <textarea name='form_copy_sn_comments' rows='3' cols='30' style='width:100%'\n         title='Comments associated with this scanned note'\n         /></textarea>\n       </td>\n      </tr>\n     </table>\n    </div><!-- end div_copy_sn -->\n   </td>\n  </tr>\n  <tr>\n   <td colspan='2' style='padding-top:0.5em;'>\n    <input type='checkbox' name='form_cb_note' value='1'\n     onclick='return divclick(this,\"div_note\");' />\n    <b><?php xl('Create Patient Note', 'e'); ?></b>\n    <div id='div_note' class='section' style='display:none;margin-top:0.5em;'>\n     <table>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap><?php xl('Type', 'e'); ?></td>\n       <td>\n        <?php\n         // Added 6/2009 by BM to incorporate the patient notes into the list_options listings\n         generate_form_field(array('data_type'=>1,'field_id'=>'note_type','list_id'=>'note_type','empty_title'=>'SKIP'), '');\n        ?>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap>To</td>\n       <td>\n        <select name='form_note_to' style='width:100%'>\n<?php\nwhile ($urow = sqlFetchArray($ures)) {\n    echo \"         <option value='\" . $urow['username'] . \"'\";\n    echo \">\" . $urow['lname'];\n    if ($urow['fname']) {\n        echo \", \" . $urow['fname'];\n    }\n\n    echo \"</option>\\n\";\n}\n?>\n         <option value=''>** <?php  xl('Close', 'e'); ?> **</option>\n        </select>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Message', 'e'); ?></td>\n       <td>\n        <textarea name='form_note_message' rows='3' cols='30' style='width:100%'\n         title='Your comments' /></textarea>\n       </td>\n      </tr>\n     </table>\n    </div><!-- end div_note -->\n   </td>\n  </tr>\n </table>\n</div><!-- end div_copy -->\n\n<p><input type='checkbox' name='form_cb_forward' value='1'\n onclick='return divclick(this,\"div_forward\");' />\n<b><?php xl('Forward Pages via Fax', 'e'); ?></b></p>\n\n<div id='div_forward' class='section' style='display:none;'>\n <table>\n  <tr>\n   <td class='itemtitle' width='1%' nowrap><?php xl('From', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_from' style='width:100%'\n     title='Type your name here' />\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('To', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_to' style='width:100%'\n     title='Type the recipient name here' />\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('Fax', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_fax' style='width:100%'\n     title='The fax phone number to send this to' />\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('Message', 'e'); ?></td>\n   <td>\n    <textarea name='form_message' rows='3' cols='30' style='width:100%'\n     title='Your comments to include with this message' /></textarea>\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('Quality', 'e'); ?></td>\n   <td>\n    <input type='radio' name='form_finemode' value='' /><?php xl('Normal', 'e'); ?> &nbsp;\n    <input type='radio' name='form_finemode' value='1' checked /><?php xl('Fine', 'e'); ?> &nbsp;\n   </td>\n  </tr>\n </table>\n</div><!-- end div_forward -->\n\n<p><b><?php xl('Delete Pages', 'e'); ?>:</b>&nbsp;\n<input type='radio' name='form_cb_delete' value='2' />All&nbsp;\n<input type='radio' name='form_cb_delete' value='1' checked />Selected&nbsp;\n<input type='radio' name='form_cb_delete' value='0' />None\n</p>\n\n<center>\n<p>\n<input type='submit' name='form_save' value='<?php xl('OK', 'e'); ?>' />\n&nbsp; &nbsp;\n<input type='button' value='<?php xl('Cancel', 'e'); ?>' onclick='window.close()' />\n&nbsp; &nbsp;\n<input type='button' value='<?php xl('Select All', 'e'); ?>' onclick='allCheckboxes(true)' />\n&nbsp; &nbsp;\n<input type='button' value='<?php xl('Clear All', 'e'); ?>' onclick='allCheckboxes(false)' />\n</p>\n\n<p><br /><b><?php xl('Please select the desired pages to copy or forward:', 'e'); ?></b></p>\n<table>\n\n<?php\n$dh = opendir($faxcache);\nif (! $dh) {\n    die(\"Cannot read $faxcache\");\n}\n\n$jpgarray = array();\nwhile (false !== ($jfname = readdir($dh))) {\n    if (preg_match(\"/^(.*)\\.jpg/\", $jfname, $matches)) {\n        $jpgarray[$matches[1]] = $jfname;\n    }\n}\n\nclosedir($dh);\n// readdir does not read in any particular order, we must therefore sort\n// by filename so the display order matches the original document.\nksort($jpgarray);\n$page = 0;\nforeach ($jpgarray as $jfnamebase => $jfname) {\n    ++$page;\n    echo \" <tr>\\n\";\n    echo \"  <td valign='top'>\\n\";\n    echo \"   <img src='../../sites/\" . $_SESSION['site_id'] . \"/faxcache/$mode/$filebase/$jfname' />\\n\";\n    echo \"  </td>\\n\";\n    echo \"  <td align='center' valign='top'>\\n\";\n    echo \"   <input type='checkbox' name='form_images[]' value='$jfnamebase' checked />\\n\";\n    echo \"   <br />$page\\n\";\n    echo \"  </td>\\n\";\n    echo \" </tr>\\n\";\n}\n?>\n\n</table>\n</center>\n</form>\n</body>\n</html>\n", "<?php\n/**\n * Generated DocBlock\n *\n * @package OpenEMR\n * @link    http://www.open-emr.org\n * @author  markleeds <markleeds>\n * @author  fndtn357 <fndtn357@gmail.com>\n * @author  cornfeed <jdough823@gmail.com>\n * @author  cfapress <cfapress>\n * @author  Wakie87 <scott@npclinics.com.au>\n * @author  Robert Down <robertdown@live.com>\n * @author  Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2009 markleeds <markleeds>\n * @copyright Copyright (c) 2012 fndtn357 <fndtn357@gmail.com>\n * @copyright Copyright (c) 2011 cornfeed <jdough823@gmail.com>\n * @copyright Copyright (c) 2008 cfapress <cfapress>\n * @copyright Copyright (c) 2016 Wakie87 <scott@npclinics.com.au>\n * @copyright Copyright (c) 2017 Robert Down <robertdown@live.com>\n * @copyright Copyright (c) 2016 Brady Miller <brady.g.miller@gmail.com>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n?>\n<!-- view.php -->\n<?php\ninclude_once(\"../../globals.php\");\ninclude_once(\"../../../library/api.inc\");\nformHeader(\"Form: CAMOS\");\n$textarea_rows = 22;\n$textarea_cols = 90;\n?>\n<html><head>\n<link rel=stylesheet href=\"<?php echo $css_header;?>\" type=\"text/css\">\n<script type=\"text/javascript\">\nfunction checkall(){\n  var f = document.my_form;\n  var x = f.elements.length;\n  var i;\n  for(i=0;i<x;i++) {\n    if (f.elements[i].type == 'checkbox') {\n      f.elements[i].checked = true;\n    }\n  }\n}\nfunction uncheckall(){\n  var f = document.my_form;\n  var x = f.elements.length;\n  var i;\n  for(i=0;i<x;i++) {\n    if (f.elements[i].type == 'checkbox') {\n      f.elements[i].checked = false;\n    }\n  }\n}\nfunction content_focus() {\n}\nfunction content_blur() {\n}\nfunction show_edit(t) {\n  var e = document.getElementById(t);\n  if (e.style.display == 'none') {\n    e.style.display = 'inline';\n    return;\n  }\n  else {\n    e.style.display = 'none';\n  }\n}\n</script>\n<?php html_header_show();?>\n<link rel=\"stylesheet\" href=\"<?php echo $css_header;?>\" type=\"text/css\">\n</head>\n<body class=\"body_top\">\n<form method=post action=\"<?php echo $rootdir?>/forms/CAMOS/save.php?mode=delete&id=<?php echo $_GET[\"id\"];?>\" name=\"my_form\">\n<h1> <?php xl('CAMOS', 'e'); ?> </h1>\n<input type=\"submit\" name=\"delete\" value=\"<?php xl('Delete Selected Items', 'e'); ?>\" />\n<input type=\"submit\" name=\"update\" value=\"<?php xl('Update Selected Items', 'e'); ?>\" />\n<?php\necho \"<a href='{$GLOBALS['form_exit_url']}'>[\" . xlt('do nothing') . \"]</a>\";\n?>\n<br/><br/>\n<input type='button' value='<?php xl('Select All', 'e'); ?>'\n  onClick='checkall()'>\n<input type='button' value='<?php xl('Unselect All', 'e'); ?>'\n  onClick='uncheckall()'>\n<br/><br/>\n<?php\n//experimental code start\n\n$pid = $GLOBALS['pid'];\n$encounter = $GLOBALS['encounter'];\n\n$query = \"select t1.id, t1.content from \".mitigateSqlTableUpperCase(\"form_CAMOS\").\" as t1 join forms as t2 \" .\n  \"on (t1.id = t2.form_id) where t2.form_name like 'CAMOS%' \" .\n  \"and t2.encounter like $encounter and t2.pid = $pid\";\n\n$statement = sqlStatement($query);\nwhile ($result = sqlFetchArray($statement)) {\n    print \"<input type=button value='\" . xl('Edit') . \"' onClick='show_edit(\\\"id_textarea_\".$result['id'].\"\\\")'>\";\n    print \"<input type=checkbox name='ch_\".$result['id'].\"'> \".$result['content'].\"<br/>\";\n    print \"<div id=id_textarea_\".$result['id'].\" style='display:none'>\";\n    print \"<textarea name=textarea_\".$result['id'].\" cols=$textarea_cols rows= $textarea_rows onFocus='content_focus()' onBlur='content_blur()' >\".$result['content'].\"</textarea><br/>\";\n    print \"</div>\";\n}\n\n\n//experimental code end\n?>\n</form>\n<?php\n\nformFooter();\n", "<?php\n/**\n * Review of Systems Checks form\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    cfapress <cfapress>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @author    Robert Down <robertdown@live.com>\n * @copyright Copyright (c) 2008 cfapress <cfapress>\n * @copyright Copyright (c) 2016-2017 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017 Robert Down <robertdown@live.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../../globals.php\");\nrequire_once(\"$srcdir/api.inc\");\n\nuse OpenEMR\\Core\\Header;\n\n$returnurl = 'encounter_top.php';\n?>\n<html>\n<head>\n    <title><?php echo xlt(\"Review of Systems Checks\"); ?></title>\n\n    <?php Header::setupHeader();?>\n</head>\n<?php\n$obj = formFetch(\"form_reviewofs\", $_GET[\"id\"]);\n?>\n<body class=\"body_top\">\n    <div class=\"container\">\n        <div class=\"row\">\n            <div class=\"\">\n                <div class=\"page-header\">\n                    <h2><?php echo xlt(\"Review of Systems Checks\");?></h2>\n                </div>\n            </div>\n        </div>\n        <div class=\"row\">\n            <form method=post action=\"<?php echo $rootdir; ?>/forms/reviewofs/save.php?mode=update&id=<?php echo $_GET[\"id\"]; ?>\" name=\"my_form\" onsubmit=\"return top.restoreSession()\">\n                <fieldset>\n                    <legend><?php echo xlt('General')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"fever\" <?php echo ($obj{\"fever\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Fever');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"chills\" <?php echo ($obj{\"chills\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Chills');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"night_sweats\" <?php echo ($obj{\"night_sweats\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Night Sweats');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"weight_loss\" <?php echo ($obj{\"weight_loss\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Weight Loss');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"poor_appetite\" <?php echo ($obj{\"poor_appetite\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Poor Appetite');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"insomnia\" <?php echo ($obj{\"insomnia\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Insomnia');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"fatigued\" <?php echo ($obj{\"fatigued\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Fatigued');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"depressed\" <?php echo ($obj{\"depressed\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Depressed');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hyperactive\" <?php echo ($obj{\"hyperactive\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hyperactive');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"exposure_to_foreign_countries\" <?php echo ($obj{\"exposure_to_foreign_countries\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Exposure to Foreign Countries');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Skin')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"rashes\" <?php echo ($obj{\"rashes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Rashes');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"infections\" <?php echo ($obj{\"infections\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Infections');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ulcerations\" <?php echo ($obj{\"ulcerations\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ulcerations');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"pemphigus\" <?php echo ($obj{\"pemphigus\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Pemphigus');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"herpes\" <?php echo ($obj{\"herpes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Herpes');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('HEENT')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cataracts\" <?php echo ($obj{\"cataracts\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cataracts');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cataract_surgery\" <?php echo ($obj{\"cataract_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cataract Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"glaucoma\" <?php echo ($obj{\"glaucoma\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Glaucoma');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"double_vision\" <?php echo ($obj{\"double_vision\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Double Vision');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"blurred_vision\" <?php echo ($obj{\"blurred_vision\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Blurred Vision');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"poor_hearing\" <?php echo ($obj{\"poor_hearing\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Poor Hearing');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"headaches\" <?php echo ($obj{\"headaches\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Headaches');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ringing_in_ears\" <?php echo ($obj{\"ringing_in_ears\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ringing in Ears');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"bloody_nose\" <?php echo ($obj{\"bloody_nose\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Bloody Nose');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"sinusitis\" <?php echo ($obj{\"sinusitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Sinusitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"sinus_surgery\" <?php echo ($obj{\"sinus_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Sinus Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"dry_mouth\" <?php echo ($obj{\"dry_mouth\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Dry Mouth');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"strep_throat\" <?php echo ($obj{\"strep_throat\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Strep Throat');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"tonsillectomy\" <?php echo ($obj{\"tonsillectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Tonsillectomy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"swollen_lymph_nodes\" <?php echo ($obj{\"swollen_lymph_nodes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Swollen Lymph Nodes');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"throat_cancer\" <?php echo ($obj{\"throat_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Throat Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"throat_cancer_surgery\" <?php echo ($obj{\"throat_cancer_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Throat Cancer Surgery');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Pulmonary')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"emphysema\" <?php echo ($obj{\"emphysema\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Emphysema');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"chronic_bronchitis\" <?php echo ($obj{\"chronic_bronchitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Chronic Bronchitis');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"interstitial_lung_disease\" <?php echo ($obj{\"interstitial_lung_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Interstitial Lung Disease');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"shortness_of_breath_2\" <?php echo ($obj{\"shortness_of_breath_2\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Shortness of Breath');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"lung_cancer\" <?php echo ($obj{\"lung_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Lung Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"lung_cancer_surgery\" <?php echo ($obj{\"lung_cancer_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Lung Cancer Surgery');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"pheumothorax\" <?php echo ($obj{\"pheumothorax\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Pheumothorax');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Cardiovascular')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"heart_attack\" <?php echo ($obj{\"heart_attack\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Heart Attack');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"irregular_heart_beat\" <?php echo ($obj{\"irregular_heart_beat\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Irregular Heart Beat');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"chest_pains\" <?php echo ($obj{\"chest_pains\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Chest Pains');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"shortness_of_breath\" <?php echo ($obj{\"shortness_of_breath\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Shortness of Breath');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"high_blood_pressure\" <?php echo ($obj{\"high_blood_pressure\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('High Blood Pressure');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"heart_failure\" <?php echo ($obj{\"heart_failure\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Heart Failure');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"poor_circulation\" <?php echo ($obj{\"poor_circulation\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Poor Circulation');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"vascular_surgery\" <?php echo ($obj{\"vascular_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Vascular Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cardiac_catheterization\" <?php echo ($obj{\"cardiac_catheterization\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cardiac Catheterization');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"heart_transplant\" <?php echo ($obj{\"heart_transplant\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Heart Transplant');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stress_test\" <?php echo ($obj{\"stress_test\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stress Test');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stress_test\" <?php echo ($obj{\"stress_test\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stress Test');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Gastrointestinal')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stomach_pains\" <?php echo ($obj{\"stomach_pains\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stomach Pains');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"peptic_ulcer_disease\" <?php echo ($obj{\"peptic_ulcer_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Peptic Ulcer Disease');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"gastritis\" <?php echo ($obj{\"gastritis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Gastritis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"endoscopy\" <?php echo ($obj{\"endoscopy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Endoscopy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"polyps\" <?php echo ($obj{\"polyps\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Polyps');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"colonoscopy\" <?php echo ($obj{\"colonoscopy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Colonoscopy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"colon_cancer\" <?php echo ($obj{\"colon_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Colon Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"colon_cancer_surgery\" <?php echo ($obj{\"colon_cancer_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Colon Cancer Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ulcerative_colitis\" <?php echo ($obj{\"ulcerative_colitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ulcerative Colitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"crohns_disease\" <?php echo ($obj{\"crohns_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Crohn\\'s Disease');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"appendectomy\" <?php echo ($obj{\"appendectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Appendectomy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"divirticulitis\" <?php echo ($obj{\"divirticulitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Divirticulitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"divirticulitis_surgery\" <?php echo ($obj{\"divirticulitis_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Diverticulitis Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"gall_stones\" <?php echo ($obj{\"gall_stones\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Gall Stones');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cholecystectomy\" <?php echo ($obj{\"cholecystectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cholecystectomy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hepatitis\" <?php echo ($obj{\"hepatitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hepatitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cirrhosis_of_the_liver\" <?php echo ($obj{\"cirrhosis_of_the_liver\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cirrhosis of the Liver');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"splenectomy\" <?php echo ($obj{\"splenectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Splenectomy');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Genitourinary')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_failure\" <?php echo ($obj{\"kidney_failure\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Failure');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_stones\" <?php echo ($obj{\"kidney_stones\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Stones');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_cancer\" <?php echo ($obj{\"kidney_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Cancer');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_infections\" <?php echo ($obj{\"kidney_infections\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Infections');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"bladder_infections\" <?php echo ($obj{\"bladder_infections\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Bladder Infections');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"bladder_cancer\" <?php echo ($obj{\"bladder_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Bladder Cancer');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"prostate_problems\" <?php echo ($obj{\"prostate_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Prostate Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"prostate_cancer\" <?php echo ($obj{\"prostate_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Prostate Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_transplant\" <?php echo ($obj{\"kidney_transplant\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Transplant');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"sexually_transmitted_disease\" <?php echo ($obj{\"sexually_transmitted_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Sexually Transmitted Disease');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"burning_with_urination\" <?php echo ($obj{\"burning_with_urination\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Burning with Urination');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"discharge_from_urethra\" <?php echo ($obj{\"discharge_from_urethra\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Discharge From Urethra');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Musculoskeletal')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"osetoarthritis\" <?php echo ($obj{\"osetoarthritis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Osetoarthritis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"rheumotoid_arthritis\" <?php echo ($obj{\"rheumotoid_arthritis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Rheumatoid Arthritis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"lupus\" <?php echo ($obj{\"lupus\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Lupus');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ankylosing_sondlilitis\" <?php echo ($obj{\"ankylosing_sondlilitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ankylosing Sondlilitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"swollen_joints\" <?php echo ($obj{\"swollen_joints\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Swollen Joints');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stiff_joints\" <?php echo ($obj{\"stiff_joints\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stiff Joints');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"broken_bones\" <?php echo ($obj{\"broken_bones\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Broken Bones');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"neck_problems\" <?php echo ($obj{\"neck_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Neck Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"back_problems\" <?php echo ($obj{\"back_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Back Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"back_surgery\" <?php echo ($obj{\"back_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Back Surgery');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"scoliosis\" <?php echo ($obj{\"scoliosis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Scoliosis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"herniated_disc\" <?php echo ($obj{\"herniated_disc\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Herniated Disc');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"shoulder_problems\" <?php echo ($obj{\"shoulder_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Shoulder Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"elbow_problems\" <?php echo ($obj{\"elbow_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Elbow Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"wrist_problems\" <?php echo ($obj{\"wrist_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Wrist Problems');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hand_problems\" <?php echo ($obj{\"hand_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hand Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hip_problems\" <?php echo ($obj{\"hip_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hip Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"knee_problems\" <?php echo ($obj{\"knee_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Knee Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ankle_problems\" <?php echo ($obj{\"ankle_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ankle Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"foot_problems\" <?php echo ($obj{\"foot_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Foot Problems');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Endocrine')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"insulin_dependent_diabetes\" <?php echo ($obj{\"insulin_dependent_diabetes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Insulin Dependent Diabetes');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"noninsulin_dependent_diabetes\" <?php echo ($obj{\"noninsulin_dependent_diabetes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Non-Insulin Dependent Diabetes');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hypothyroidism\" <?php echo ($obj{\"hypothyroidism\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hypothyroidism');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hyperthyroidism\" <?php echo ($obj{\"hyperthyroidism\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hyperthyroidism');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cushing_syndrom\" <?php echo ($obj{\"cushing_syndrom\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cushing Syndrome');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"addison_syndrom\" <?php echo ($obj{\"addison_syndrom\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Addison Syndrome');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                        <legend class=\"\"><?php echo xlt('Additional Notes');?></legend>\n                            <div class=\"form-group\">\n                                <div class=\"col-sm-10 col-sm-offset-1\">\n                                    <textarea name=\"additional_notes\" class=\"form-control\" cols=\"80\" rows=\"5\" ><?php echo text($obj{\"additional_notes\"}); ?></textarea>\n                                </div>\n                            </div>\n                </fieldset>\n                    <div class=\"form-group clearfix\">\n                        <div class=\"col-sm-12 col-sm-offset-1 position-override\">\n                            <div class=\"btn-group oe-opt-btn-group-pinch\" role=\"group\">\n                            <button type=\"submit\" onclick=\"top.restoreSession()\" class=\"btn btn-default btn-save\"><?php echo xlt('Save'); ?></button>\n                            <button type=\"button\" class=\"btn btn-link btn-cancel oe-opt-btn-separate-left\" onclick=\"top.restoreSession(); parent.closeTab(window.name, false);\"><?php echo xlt('Cancel');?></button>\n                        </div>\n                    </div>\n                </div>\n            </form>\n        </div>\n    </div>\n</body>\n</html>\n", "<?php\ninclude_once(\"../../globals.php\");\n?>\n\n<html>\n<head>\n<?php html_header_show();?>\n<title>Navigation</title>\n\n<link rel=\"stylesheet\" href=\"<?php echo $css_header;?>\" type=\"text/css\">\n\n</head>\n<body class=\"body_nav\">\n\n<div id=\"nav_topmenu\">\n<form method='post' target=\"_top\" name=\"find_patient\" action=\"<?php echo $rootdir?>/main/finder/patient_finder.php\" onsubmit=\"return top.restoreSession()\">\n\n<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" height=\"100%\">\n<tr>\n\n<td style=\"text-align:left; width: 250px; white-space: nowrap;\">\n<input type=\"textbox\" size=\"10\" name=\"patient\" value=\"<?php echo $_REQUEST['patient']; ?>\" >\n<select name=\"findBy\">\n<option value=\"Last\" <?php if ($_REQUEST['findBy'] == 'Last') {\n    echo 'selected';\n} ?>><?php xl('Name', 'e');?></option>\n<option value=\"Phone\" <?php if ($_REQUEST['findBy'] == 'Phone') {\n    echo 'selected';\n} ?>><?php xl('Phone', 'e');?></option>\n<option value=\"ID\" <?php if ($_REQUEST['findBy'] == 'ID') {\n    echo 'selected';\n} ?>><?php xl('ID', 'e');?></option>\n<option value=\"SSN\" <?php if ($_REQUEST['findBy'] == 'SSN') {\n    echo 'selected';\n} ?>><?php xl('SSN', 'e');?></option>\n<option value=\"DOB\" <?php if ($_REQUEST['findBy'] == 'DOB') {\n    echo 'selected';\n} ?>><?php xl('DOB', 'e');?></option>\n</select>\n<a href=\"javascript:top.restoreSession();document.find_patient.action='<?php echo $rootdir?>/main/finder/patient_finder.php';document.find_patient.submit();\" class=\"link\">&nbsp;<?php xl('Find Patient', 'e');?></a>\n</td>\n\n<td style=\"text-align:left\">\n&nbsp;&nbsp;&nbsp;<a class=\"menu\" target=\"_top\" href=\"../../new/new_patient.php\" onclick=\"top.restoreSession()\">\n<?php xl('New Patient', 'e');?></a>&nbsp;\n</td>\n\n<td style=\"text-align:right\">\n&nbsp;<a href=\"../main_screen.php\" target=\"_top\" class=\"logout\" onclick=\"top.restoreSession()\">\n<?php xl('Back', 'e');?></a>&nbsp;&nbsp;\n</td>\n</tr>\n</table>\n\n</form>\n</div>\n\n</body>\n</html>\n", "<?php\n/**\n * Copyright (C) 2010-2012 Rod Roark <rod@sunsetsystems.com>\n *\n * This program is free software; you can redistribute it and/or\n * modify it under the terms of the GNU General Public License\n * as published by the Free Software Foundation; either version 2\n * of the License, or (at your option) any later version.\n */\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/acl.inc\");\n\n// This script can be run either inside the OpenEMR frameset for order catalog\n// maintenance, or as a popup window for selecting an item to order.  In the\n// popup case the GET variables 'popup' (a boolean) and 'order' (an optional\n// item ID to select) will be provided, and maintenance may also be permitted.\n\n$popup = empty($_GET['popup']) ? 0 : 1;\n$order = isset($_GET['order']) ? $_GET['order'] + 0 : 0;\n$labid = isset($_GET['labid']) ? $_GET['labid'] + 0 : 0;\n\n// If Save was clicked, set the result, close the window and exit.\n//\nif ($popup && $_POST['form_save']) {\n    $form_order = isset($_GET['form_order']) ? $_GET['form_order'] + 0 : 0;\n    $ptrow = sqlQuery(\"SELECT name FROM procedure_type WHERE \" .\n    \"procedure_type_id = '$form_order'\");\n    $name = addslashes($ptrow['name']);\n?>\n<script type=\"text/javascript\" src=\"<?php echo $webroot ?>/interface/main/tabs/js/include_opener.js\"></script>\n<script language=\"JavaScript\">\nif (opener.closed || ! opener.set_proc_type) {\n alert('<?php xl('The destination form was closed; I cannot act on your selection.', 'e'); ?>');\n}\nelse {\n opener.set_proc_type(<?php echo \"$form_order, '$name'\" ?>);\n<?php\n// This is to generate the \"Questions at Order Entry\" for the Procedure Order form.\n// GET parms needed for this are: formid, formseq.\nif (isset($_GET['formid'])) {\n    require_once(\"qoe.inc.php\");\n    $qoe_init_javascript = '';\n    echo ' opener.set_proc_html(\"';\n    echo generate_qoe_html($form_order, intval($_GET['formid']), 0, intval($_GET['formseq']));\n    echo '\", \"' . $qoe_init_javascript .  '\");' . \"\\n\";\n}\n?>\n}\nwindow.close(); // comment out for debugging\n</script>\n<?php\n  exit();\n}\n\n// end Save logic\n\n?>\n<html>\n\n<head>\n\n<title><?php xl('Order and Result Types', 'e'); ?></title>\n\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n\n<style type=\"text/css\">\nbody {\n font-family:sans-serif;\n font-size:9pt;\n font-weight:normal;\n padding: 5px 3px 5px 3px;\n}\n#con0 table {\n margin:0;\n padding:0;\n width:100%;\n}\n#con0 td {\n padding:0pt;\n font-family:sans-serif;\n font-size:9pt;\n}\n.plusminus {\n font-family:monospace;\n font-size:10pt;\n}\n.haskids {\n color:#0000dd;\n cursor:pointer;\n cursor:hand;\n}\ntr.head {\nfont-size:10pt;\nbackground-color:#cccccc;\nfont-weight:bold;\n}\ntr.evenrow {\n background-color:#ddddff;\n}\ntr.oddrow {\n background-color:#ffffff;\n}\n\n.col1 {width:35%}\n.col2 {width:8%}\n.col3 {width:12%}\n.col4 {width:35%}\n.col5 {width:10%}\n</style>\n\n<script src=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-min-1-2-2/index.js\" type=\"text/javascript\"></script>\n<?php if ($popup) { ?>\n<script type=\"text/javascript\" src=\"../../library/topdialog.js\"></script>\n<?php } ?>\n<script type=\"text/javascript\" src=\"../../library/dialog.js?v=<?php echo $v_js_includes; ?>\"></script>\n\n<script language=\"JavaScript\">\n\n<?php if ($popup) {\n    require($GLOBALS['srcdir'] . \"/restoreSession.php\");\n} ?>\n\n<?php\n// Create array of IDs to pre-select, leaf to top.\necho \"preopen = [\";\necho $order > 0 ? $order : 0;\nfor ($parentid = $order; $parentid > 0;) {\n    $row = sqlQuery(\"SELECT parent FROM procedure_type WHERE procedure_type_id = '$parentid'\");\n    $parentid = $row['parent'] + 0;\n    echo \", $parentid\";\n}\n\necho \"];\\n\";\n?>\n\n// initiate by loading the top-level nodes\n$(document).ready(function(){\n nextOpen();\n});\n\n// This is called repeatedly at initialization until all desired nodes\n// have been opened.\nfunction nextOpen() {\n if (preopen.length) {\n  var thisid = preopen.pop();\n  if (thisid == 0 || preopen.length > 0) {\n   if (thisid > 0)\n    toggle(thisid);\n   else\n    $.getScript('types_ajax.php?id=' + thisid + '&order=<?php echo $order; ?>' + '&labid=<?php echo $labid; ?>');\n  }\n  else {\n   recolor();\n  }\n }\n else {\n  recolor();\n }\n}\n\n// toggle expansion indicator from + to - or vice versa\nfunction swapsign(td1, from, to) {\n var s = td1.html();\n var i = s.indexOf('>' + from + '<');\n if (i >= 0) td1.html(s.substring(0,i+1) + to + s.substring(i+2));\n}\n\n// onclick handler to expand or collapse a node\nfunction toggle(id) {\n var td1 = $('#td' + id);\n if (!td1.hasClass('haskids')) return;\n if (td1.hasClass('isExpanded')) {\n  $('#con' + id).remove();\n  td1.removeClass('isExpanded');\n  swapsign(td1, '-', '+');\n  recolor();\n }\n else {\n  td1.parent().after('<tr class=\"outertr\"><td colspan=\"5\" id=\"con' + id + '\" style=\"padding:0\">Loading...</td></tr>');\n  td1.addClass('isExpanded');\n  swapsign(td1, '+', '-');\n  $.getScript('types_ajax.php?id=' + id + '&order=<?php echo $order; ?>' + '&labid=<?php echo $labid; ?>');\n }\n}\n\n// Called by the edit window to refresh a given node's children\nfunction refreshFamily(id, haskids) {\n if (id) { // id == 0 means top level\n  var td1 = $('#td' + id);\n  if (td1.hasClass('isExpanded')) {\n   $('#con' + id).remove();\n   td1.removeClass('isExpanded');\n   swapsign(td1, '-', '+');\n  }\n  if (td1.hasClass('haskids') && !haskids) {\n   td1.removeClass('haskids');\n   // swapsign(td1, '+', '.');\n   swapsign(td1, '+', '|');\n   return;\n  }\n  if (!td1.hasClass('haskids') && haskids) {\n   td1.addClass('haskids');\n   // swapsign(td1, '.', '+');\n   swapsign(td1, '|', '+');\n  }\n  if (haskids) {\n   td1.parent().after('<tr class=\"outertr\"><td colspan=\"5\" id=\"con' + id + '\" style=\"padding:0\">Loading...</td></tr>');\n   td1.addClass('isExpanded');\n   swapsign(td1, '+', '-');\n  }\n }\n if (haskids)\n  $.getScript('types_ajax.php?id=' + id + '&order=<?php echo $order; ?>' + '&labid=<?php echo $labid; ?>');\n else\n  recolor();\n}\n\n// edit a node\nfunction enode(id) {\n dlgopen('types_edit.php?parent=0&typeid=' + id, '_blank', 700, 550);\n}\n\n// add a node\nfunction anode(id) {\n dlgopen('types_edit.php?typeid=0&parent=' + id, '_blank', 700, 550);\n}\n\n// call this to alternate row colors when anything changes the number of rows\nfunction recolor() {\n var i = 0;\n $('#con0 tr').each(function(index) {\n  // skip any row that contains other rows\n  if ($(this).hasClass('outertr')) return;\n  this.className = (i++ & 1) ? \"evenrow\" : \"oddrow\";\n });\n}\n\n</script>\n\n</head>\n\n<body class=\"body_nav\">\n<center>\n\n<h3 style='margin-top:0'><?php xl('Types of Orders and Results', 'e') ?></h3>\n\n<form method='post' name='theform' action='types.php?popup=<?php echo $popup ?>&order=<?php\necho $order;\nif (isset($_GET['formid' ])) {\n    echo '&formid='  . $_GET['formid'];\n}\n\nif (isset($_GET['formseq'])) {\n    echo '&formseq=' . $_GET['formseq'];\n}\n?>'>\n\n<table width='100%' cellspacing='0' cellpadding='0' border='0'>\n <tr class='head'>\n  <th class='col1' align='left'>&nbsp;&nbsp;<?php xl('Name', 'e') ?></th>\n  <th class='col2' align='left'><?php xl('Order', 'e') ?></th>\n  <th class='col3' align='left'><?php xl('Code', 'e') ?></th>\n  <th class='col4' align='left'><?php xl('Description', 'e') ?></th>\n  <th class='col5' align='left'>&nbsp;</th>\n </tr>\n</table>\n\n<div id=\"con0\">\n</div>\n\n<p>\n<?php if ($popup) { ?>\n<input type='submit' name='form_save' value='<?php xl('Save', 'e'); ?>' />\n&nbsp;\n<input type='button' value=<?php xl('Cancel', 'e'); ?> onclick='window.close()' />\n&nbsp;\n<?php } ?>\n<input type='button' value='<?php xl('Add Top Level', 'e'); ?>' onclick='anode(0)' />\n</p>\n\n</form>\n\n</center>\n\n</body>\n</html>\n\n", "<?php\n// Copyright (C) 2007-2011 Rod Roark <rod@sunsetsystems.com>\n//\n// This program is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License\n// as published by the Free Software Foundation; either version 2\n// of the License, or (at your option) any later version.\n\nuse OpenEMR\\Core\\Header;\n\ninclude_once(\"../globals.php\");\ninclude_once($GLOBALS['srcdir'] . \"/patient.inc\");\n\n$template_dir = $GLOBALS['OE_SITE_DIR'] . \"/letter_templates\";\n\n// array of field name tags to allow internationalization\n//  of templates\n$FIELD_TAG = array(\n    'DATE'             => xl('DATE'),\n    'FROM_TITLE'       => xl('FROM_TITLE'),\n    'FROM_FNAME'       => xl('FROM_FNAME'),\n    'FROM_LNAME'       => xl('FROM_LNAME'),\n    'FROM_MNAME'       => xl('FROM_MNAME'),\n    'FROM_STREET'      => xl('FROM_STREET'),\n    'FROM_CITY'        => xl('FROM_CITY'),\n    'FROM_STATE'       => xl('FROM_STATE'),\n    'FROM_POSTAL'      => xl('FROM_POSTAL'),\n    'FROM_VALEDICTORY' => xl('FROM_VALEDICTORY'),\n    'FROM_PHONE'       => xl('FROM_PHONE'),\n    'FROM_PHONECELL'   => xl('FROM_PHONECELL'),\n    'FROM_EMAIL'       => xl('FROM_EMAIL'),\n    'TO_TITLE'         => xl('TO_TITLE'),\n    'TO_FNAME'         => xl('TO_FNAME'),\n    'TO_LNAME'         => xl('TO_LNAME'),\n    'TO_MNAME'         => xl('TO_MNAME'),\n    'TO_STREET'        => xl('TO_STREET'),\n    'TO_CITY'          => xl('TO_CITY'),\n    'TO_STATE'         => xl('TO_STATE'),\n    'TO_POSTAL'        => xl('TO_POSTAL'),\n    'TO_VALEDICTORY'   => xl('TO_VALEDICTORY'),\n    'TO_PHONE'         => xl('TO_PHONE'),\n    'TO_PHONECELL'     => xl('TO_PHONECELL'),\n    'TO_FAX'           => xl('TO_FAX'),\n    'TO_ORGANIZATION'  => xl('TO_ORGANIZATION'),\n    'PT_FNAME'         => xl('PT_FNAME'),\n    'PT_LNAME'         => xl('PT_LNAME'),\n    'PT_MNAME'         => xl('PT_MNAME'),\n    'PT_STREET'        => xl('PT_STREET'),\n    'PT_CITY'          => xl('PT_CITY'),\n    'PT_STATE'         => xl('PT_STATE'),\n    'PT_POSTAL'        => xl('PT_POSTAL'),\n    'PT_PHONE_HOME'    => xl('PT_PHONE_HOME'),\n    'PT_PHONE_CELL'    => xl('PT_PHONE_CELL'),\n    'PT_SSN'           => xl('PT_SSN'),\n    'PT_EMAIL'         => xl('PT_EMAIL'),\n    'PT_DOB'           => xl('PT_DOB')\n\n);\n\n$patdata = sqlQuery(\"SELECT \" .\n  \"p.fname, p.mname, p.lname, p.pubpid, p.DOB, \" .\n  \"p.street, p.city, p.state, p.phone_home, p.phone_cell, p.ss, p.email, p.postal_code \" .\n  \"FROM patient_data AS p \" .\n  \"WHERE p.pid = ? LIMIT 1\", array($pid));\n\n$alertmsg = ''; // anything here pops up in an alert box\n\n// If the Generate button was clicked...\nif ($_POST['formaction']==\"generate\") {\n    $form_pid      = $_POST['form_pid'];\n    $form_from     = $_POST['form_from'];\n    $form_to       = $_POST['form_to'];\n    $form_date     = $_POST['form_date'];\n    $form_template = $_POST['form_template'];\n    $form_format   = $_POST['form_format'];\n    $form_body     = $_POST['form_body'];\n\n    $frow = sqlQuery(\"SELECT * FROM users WHERE id = ?\", array($form_from));\n    $trow = sqlQuery(\"SELECT * FROM users WHERE id = ?\", array($form_to));\n\n    $datestr = $form_date;\n    $from_title = $frow['title'] ? $frow['title'] . ' ' : '';\n    $to_title   = $trow['title'] ? $trow['title'] . ' ' : '';\n\n    $cpstring = $_POST['form_body'];\n\n    // attempt to save to the autosaved template\n    $fh = fopen(\"$template_dir/autosaved\", 'w');\n    // translate from definition to the constant\n    $temp_bodytext = $cpstring;\n    foreach ($FIELD_TAG as $key => $value) {\n        $temp_bodytext = str_replace(\"{\".$value.\"}\", \"{\".$key.\"}\", $temp_bodytext);\n    }\n\n    if (! fwrite($fh, $temp_bodytext)) {\n        echo xl('Error while saving to the file', '', '', ' ') . $template_dir.\"/autosaved\" .\n             xl('Ensure OpenEMR has write privileges to directory', '', ' . ', ' ') . $template_dir  . \"/ .\" ;\n        die;\n    }\n\n    fclose($fh);\n\n    $cpstring = str_replace('{'.$FIELD_TAG['DATE'].'}', $datestr, $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_TITLE'].'}', $from_title, $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_FNAME'].'}', $frow['fname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_LNAME'].'}', $frow['lname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_MNAME'].'}', $frow['mname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_STREET'].'}', $frow['street'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_CITY'].'}', $frow['city'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_STATE'].'}', $frow['state'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_POSTAL'].'}', $frow['zip'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_VALEDICTORY'].'}', $frow['valedictory'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_PHONECELL'].'}', $frow['phonecell'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_PHONE'].'}', $frow['phone'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_EMAIL'].'}', $frow['email'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_TITLE'].'}', $to_title, $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_FNAME'].'}', $trow['fname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_LNAME'].'}', $trow['lname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_MNAME'].'}', $trow['mname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_STREET'].'}', $trow['street'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_CITY'].'}', $trow['city'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_STATE'].'}', $trow['state'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_POSTAL'].'}', $trow['zip'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_VALEDICTORY'].'}', $trow['valedictory'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_FAX'].'}', $trow['fax'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_PHONE'].'}', $trow['phone'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_PHONECELL'].'}', $trow['phonecell'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_ORGANIZATION'].'}', $trow['organization'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_FNAME'].'}', $patdata['fname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_LNAME'].'}', $patdata['lname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_MNAME'].'}', $patdata['mname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_STREET'].'}', $patdata['street'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_CITY'].'}', $patdata['city'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_STATE'].'}', $patdata['state'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_POSTAL'].'}', $patdata['postal_code'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_PHONE_HOME'].'}', $patdata['phone_home'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_PHONE_CELL'].'}', $patdata['phone_cell'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_SSN'].'}', $patdata['ss'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_EMAIL'].'}', $patdata['email'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_DOB'].'}', $patdata['DOB'], $cpstring);\n\n    if ($form_format == \"pdf\") {\n        $pdf = new Cezpdf($GLOBALS['rx_paper_size']);\n        $pdf->ezSetMargins($GLOBALS['rx_top_margin'], $GLOBALS['rx_bottom_margin'], $GLOBALS['rx_left_margin'], $GLOBALS['rx_right_margin']);\n        if (file_exists(\"$template_dir/custom_pdf.php\")) {\n            include(\"$template_dir/custom_pdf.php\");\n        } else {\n            $pdf->selectFont('Helvetica');\n            $pdf->ezText($cpstring, 12);\n        }\n\n        $pdf->ezStream();\n        exit;\n    } else { // $form_format = html\n        $cpstring = text($cpstring); //escape to prevent stored cross script attack\n        $cpstring = str_replace(\"\\n\", \"<br>\", $cpstring);\n        $cpstring = str_replace(\"\\t\", \"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\", $cpstring);\n        ?>\n        <html>\n        <head>\n        <style>\n        body {\n     font-family: sans-serif;\n     font-weight: normal;\n     font-size: 12pt;\n     background: white;\n     color: black;\n    }\n    .paddingdiv {\n     width: 524pt;\n     padding: 0pt;\n     margin-top: 50pt;\n    }\n    .navigate {\n     margin-top: 2.5em;\n    }\n    @media print {\n     .navigate {\n      display: none;\n     }\n    }\n    </style>\n    <title><?php echo xlt('Letter'); ?></title>\n    </head>\n        <body>\n    <div class='paddingdiv'>\n    <?php echo $cpstring; ?>\n        <div class=\"navigate\">\n    <a href='<?php echo $GLOBALS['rootdir'] . '/patient_file/letter.php?template=autosaved'; ?>' onclick='top.restoreSession()'>(<?php echo xlt('Back'); ?>)</a>\n    </div>\n    <script language='JavaScript'>\n    window.print();\n    </script>\n    </body>\n    </div>\n    <?php\n    exit;\n    }\n} else if (isset($_GET['template']) && $_GET['template'] != \"\") {\n    // utilized to go back to autosaved template\n    $bodytext = \"\";\n    $fh = fopen(\"$template_dir/\".$_GET['template'], 'r');\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n} else if ($_POST['formaction'] == \"loadtemplate\" && $_POST['form_template'] != \"\") {\n    $bodytext = \"\";\n    $fh = fopen(\"$template_dir/\".$_POST['form_template'], 'r');\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n} else if ($_POST['formaction'] == \"newtemplate\" && $_POST['newtemplatename'] != \"\") {\n    // attempt to save the template\n    $fh = fopen(\"$template_dir/\".$_POST['newtemplatename'], 'w');\n    // translate from definition to the constant\n    $temp_bodytext = $_POST['form_body'];\n    foreach ($FIELD_TAG as $key => $value) {\n        $temp_bodytext = str_replace(\"{\".$value.\"}\", \"{\".$key.\"}\", $temp_bodytext);\n    }\n\n    if (! fwrite($fh, $temp_bodytext)) {\n        echo xlt('Error while writing to file') . ' ' . $template_dir.\"/\".$_POST['newtemplatename'];\n        die;\n    }\n\n    fclose($fh);\n\n    // read the saved file back\n    $_POST['form_template'] = $_POST['newtemplatename'];\n    $fh = fopen(\"$template_dir/\".$_POST['form_template'], 'r');\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n} else if ($_POST['formaction'] == \"savetemplate\" && $_POST['form_template'] != \"\") {\n    // attempt to save the template\n    $fh = fopen(\"$template_dir/\".$_POST['form_template'], 'w');\n    // translate from definition to the constant\n    $temp_bodytext = $_POST['form_body'];\n    foreach ($FIELD_TAG as $key => $value) {\n        $temp_bodytext = str_replace(\"{\".$value.\"}\", \"{\".$key.\"}\", $temp_bodytext);\n    }\n\n    if (! fwrite($fh, $temp_bodytext)) {\n        echo xlt('Error while writing to file') . ' ' . $template_dir.\"/\".$_POST['form_template'];\n        die;\n    }\n\n    fclose($fh);\n\n    // read the saved file back\n    $fh = fopen(\"$template_dir/\".$_POST['form_template'], 'r');\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n}\n\n// This is the case where we display the form for data entry.\n// Get the users list.\n$ures = sqlStatement(\"SELECT id, fname, lname, specialty FROM users \" .\n  \"WHERE active = 1 AND ( info IS NULL OR info NOT LIKE '%Inactive%' ) \" .\n  \"ORDER BY lname, fname\");\n$i = 0;\n$optfrom = '';\n$optto = '';\n$ulist = \"var ulist = new Array();\\n\";\nwhile ($urow = sqlFetchArray($ures)) {\n    $uname = $urow['lname'];\n    if ($urow['fname']) {\n        $uname .= \", \" . $urow['fname'];\n    }\n\n    $tmp1 = \" <option value='\" . attr($urow['id']) . \"'\";\n    $tmp2 = \">\" . text($uname) . \"</option>\\n\";\n    $optto .= $tmp1 . $tmp2;\n    if ($urow['id'] == $_SESSION['authUserID']) {\n        $tmp1 .= \" selected\";\n    }\n\n    $optfrom .= $tmp1 . $tmp2;\n    $ulist .= \"ulist[$i] = '\" . attr($uname) . \"|\" .\n    attr($urow['id']) . \"|\" . attr($urow['specialty']) . \"';\\n\";\n    ++$i;\n}\n\n// Get the unique specialties.\n$sres = sqlStatement(\"SELECT DISTINCT specialty FROM users \" .\n  \"WHERE active = 1 AND ( info IS NULL OR info NOT LIKE '%Inactive%' ) \" .\n  \"ORDER BY specialty\");\n$optspec = \"<option value='All'>\" . xlt('All') . \"</option>\\n\";\nwhile ($srow = sqlFetchArray($sres)) {\n    $optspec .= \" <option value='\" . attr($srow['specialty']) . \"'>\" .\n    text($srow['specialty']) . \"</option>\\n\";\n}\n?>\n\n<html>\n<head>\n<title><?php echo xlt('Letter Generator'); ?></title>\n<?php Header::setupHeader(['datetime-picker', 'topdialog']); ?>\n\n<script language=\"JavaScript\">\n<?php echo $ulist; ?>\n\n// React to selection of a specialty.  This rebuilds the \"to\" users list\n// with users having that specialty, or all users if \"All\" is selected.\nfunction newspecialty() {\n    var f = document.forms[0];\n    var s = f.form_specialty.value;\n    var theopts = f.form_to.options;\n    theopts.length = 0;\n    var j = 0;\n    for (var i = 0; i < ulist.length; ++i) {\n        tmp = ulist[i].split(\"|\");\n        if (s != 'All' && s != tmp[2]) continue;\n        theopts[j++] = new Option(tmp[0], tmp[1], false, false);\n    }\n}\n\n\n// insert text into a textarea where the cursor is\nfunction insertAtCaret(areaId,text) {\n    var txtarea = document.getElementById(areaId);\n    var scrollPos = txtarea.scrollTop;\n    var strPos = 0;\n    var br = ((txtarea.selectionStart || txtarea.selectionStart == '0') ?\n            \"ff\" : (document.selection ? \"ie\" : false ) );\n    if (br == \"ie\") {\n        txtarea.focus();\n        var range = document.selection.createRange();\n        range.moveStart ('character', -txtarea.value.length);\n        strPos = range.text.length;\n    }\n    else if (br == \"ff\") strPos = txtarea.selectionStart;\n\n    var front = (txtarea.value).substring(0,strPos);\n    var back = (txtarea.value).substring(strPos,txtarea.value.length);\n    txtarea.value=front+text+back;\n    strPos = strPos + text.length;\n    if (br == \"ie\") {\n        txtarea.focus();\n        var range = document.selection.createRange();\n        range.moveStart ('character', -txtarea.value.length);\n        range.moveStart ('character', strPos);\n        range.moveEnd ('character', 0);\n        range.select();\n    }\n    else if (br == \"ff\") {\n        txtarea.selectionStart = strPos;\n        txtarea.selectionEnd = strPos;\n        txtarea.focus();\n    }\n    txtarea.scrollTop = scrollPos;\n}\n\nfunction insertAtCursor(myField, myValue) {\n    //IE support\n    if (document.selection) {\n        myField.focus();\n        sel = document.selection.createRange();\n        sel.text = myValue;\n    }\n    //MOZILLA/NETSCAPE support\n    else if (myField.selectionStart || myField.selectionStart == '0') {\n        var startPos = myField.selectionStart;\n        var endPos = myField.selectionEnd;\n        myField.value = myField.value.substring(0, startPos)\n                        + myValue\n                        + myField.value.substring(endPos, myField.value.length);\n    } else {\n        myField.value += myValue;\n    }\n}\n\n\n</script>\n\n</head>\n\n<body class=\"body_top\" onunload='imclosing()'>\n\n<!-- <form method='post' action='letter.php' onsubmit='return top.restoreSession()'> -->\n<form method='post' action='letter.php' id=\"theform\" name=\"theform\" onsubmit=\"return top.restoreSession()\">\n<input type=\"hidden\" name=\"formaction\" id=\"formaction\" value=\"\">\n<input type='hidden' name='form_pid' value='<?php echo attr($pid) ?>' />\n\n<center>\n<p>\n<table width='98%'>\n\n <tr>\n  <td colspan='4' align='center'>\n   &nbsp;<br>\n   <b><?php echo xlt('Generate Letter regarding ') . text($patdata['fname']) . \" \" .\n    text($patdata['lname']) . \" (\" . text($patdata['pubpid']) . \")\" ?></b>\n    <br>&nbsp;\n  </td>\n </tr>\n\n <tr>\n\n  <td class='control-label'>\n    <?php echo xlt('From'); ?>:\n  </td>\n\n  <td>\n   <select name='form_from' class='form-control'>\n<?php echo $optfrom; ?>\n   </select>\n  </td>\n\n  <td class='control-label'>\n    <?php echo xlt('Date'); ?>:\n  </td>\n\n  <td>\n   <input type='text' size='10' name='form_date' id='form_date' class='datepicker form-control'\n    value='<?php echo attr(oeFormatShortDate(date('Y-m-d'))); ?>'\n    title='<?php echo xlt('Date of this letter'); ?>' />\n  </td>\n\n </tr>\n\n <tr>\n\n  <td class='control-label'>\n    <?php echo xlt('Specialty'); ?>:\n  </td>\n\n  <td>\n   <select name='form_specialty' onchange='newspecialty()' class='form-control'>\n<?php echo $optspec; ?>\n   </select>\n  </td>\n\n  <td class='control-label'>\n    <?php echo xlt('Template'); ?>:\n  </td>\n\n  <td>\n   <select name=\"form_template\" id=\"form_template\" class='form-control'>\n   <option value=\"\">(<?php echo xlt('none'); ?>)</option>\n<?php\n$tpldir = $GLOBALS['OE_SITE_DIR'] . \"/letter_templates\";\n$dh = opendir($tpldir);\nif (! $dh) {\n    die(xlt('Cannot read') . ' ' . $tpldir);\n}\n\nwhile (false !== ($tfname = readdir($dh))) {\n  // skip dot-files, scripts and images\n    if (preg_match(\"/^\\./\", $tfname)) {\n        continue;\n    }\n\n    if (preg_match(\"/\\.php$/\", $tfname)) {\n        continue;\n    }\n\n    if (preg_match(\"/\\.jpg$/\", $tfname)) {\n        continue;\n    }\n\n    if (preg_match(\"/\\.png$/\", $tfname)) {\n        continue;\n    }\n\n    echo \"<option value='\" . attr($tfname) . \"'\";\n    if (($tfname == $_POST['form_template']) || ($tfname == $_GET['template'])) {\n        echo \" SELECTED\";\n    }\n\n    echo \">\";\n    if ($tfname == 'autosaved') {\n        echo xlt($tfname);\n    } else {\n        echo text($tfname);\n    }\n\n    echo \"</option>\";\n}\n\nclosedir($dh);\n?>\n   </select>\n  </td>\n\n </tr>\n\n </tr>\n\n <tr>\n\n  <td class='control-label'>\n    <?php echo xlt('To'); ?>:\n  </td>\n\n  <td>\n   <select name='form_to' class='form-control'>\n<?php echo $optto; ?>\n   </select>\n  </td>\n\n  <td class='control-label'>\n    <?php echo xlt('Print Format'); ?>:\n  </td>\n\n  <td>\n   <select name='form_format' class='form-control'>\n    <option value='html'><?php echo xlt('HTML'); ?></option>\n    <option value='pdf'><?php echo xlt('PDF'); ?></option>\n   </select>\n  </td>\n\n </tr>\n\n <tr>\n  <td colspan='4'>\n    <div id=\"letter_toolbar\" class='text' style=\"width: 100%; background-color: #ddd; padding: 5px; margin: 0px;\">\n    <span class='control-label'><?php echo xlt('Insert special field'); ?>:</span>\n    <select id=\"letter_field\" class='form-control'>\n    <option value=\"\">- <?php echo xlt('Choose'); ?> -</option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['DATE'].'}'; ?>\"><?php echo xlt('Today\\'s Date'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_TITLE'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Title'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_FNAME'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('First name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_MNAME'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Middle name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_LNAME'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Last name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_STREET'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Street'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_CITY'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('City'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_STATE'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('State'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_POSTAL'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Postal Code'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_VALEDICTORY'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Valedictory'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_PHONECELL'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Cell Phone'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_PHONE'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Phone'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_EMAIL'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('email'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_TITLE'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Title'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_FNAME'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('First name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_MNAME'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Middle name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_LNAME'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Last name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_STREET'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Street'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_CITY'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('City'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_STATE'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('State'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_POSTAL'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Postal Code'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_VALEDICTORY'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Valedictory'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_ORGANIZATION'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Organization'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_FAX'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Fax number'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_PHONE'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Phone number'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_PHONECELL'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Cell phone number'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_FNAME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('First name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_MNAME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Middle name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_LNAME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Last name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_STREET'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Street'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_CITY'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('City'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_STATE'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('State'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_POSTAL'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Postal Code'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_PHONE_HOME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Phone Home'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_PHONE_CELL'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Phone Cell'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_SSN'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('SSN'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_DOB'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Date of birth'); ?></option>\n    </select>\n    </div>\n   <textarea name='form_body' id=\"form_body\" class='form-control' rows='20' cols='30' style='width:100%'\n    title='<?php echo xla('Enter body of letter here'); ?>' /><?php echo text($bodytext); ?></textarea>\n  </td>\n </tr>\n\n</table>\n\n<div class=\"btn-group\" role=\"group\">\n    <button type='button' class='addtemplate btn btn-default btn-save'><?php echo xlt('Save as New'); ?></button>\n    <button type='button' class='btn btn-default btn-save' name='savetemplate' id=\"savetemplate\"><?php echo xlt('Save Changes'); ?></button>\n    <button type='button' class='btn btn-default btn-transmit' name='form_generate' id=\"form_generate\"><?php echo xlt('Generate Letter'); ?></button>\n</div>\n\n</center>\n\n<!-- template DIV that appears when user chooses to add a new letter template -->\n<div id=\"newtemplatedetail\" style=\"margin-top: 4em; display: none; visibility: hidden;\">\n    <span class='control-label'><?php echo xlt('Template Name'); ?>:</span> <input type=\"textbox\" size=\"20\" maxlength=\"30\" name=\"newtemplatename\" id=\"newtemplatename\" class=\"form-control\">\n    <br>\n    <div class=\"btn-group\" role=\"group\">\n        <button type=\"button\" class=\"savenewtemplate btn btn-default btn-save\"><?php echo xlt('Save new template'); ?></button>\n        <button type=\"button\" class=\"cancelnewtemplate btn btn-link btn-cancel\"><?php echo xlt('Cancel'); ?></button>\n    </div>\n</div>\n\n</form>\n</body>\n\n<script language='JavaScript'>\n\n// jQuery stuff to make the page a little easier to use\n\n$(document).ready(function(){\n    $(\"#form_generate\").click(function() { $(\"#formaction\").val(\"generate\"); $(\"#theform\").submit(); });\n    $(\"#form_template\").change(function() { $(\"#formaction\").val(\"loadtemplate\"); $(\"#theform\").submit(); });\n\n    $(\"#savetemplate\").click(function() { SaveTemplate(this); });\n\n    $(\"#letter_field\").change(function() { insertAtCursor(document.getElementById(\"form_body\"), $(this).val()); $(this).attr(\"selectedIndex\", \"0\"); });\n\n    $(\".addtemplate\").click(function() { AddTemplate(this); });\n    $(\".savenewtemplate\").click(function() { SaveNewTemplate(this); });\n    $(\".deletetemplate\").click(function() { DeleteTemplate(this); });\n    $(\".cancelnewtemplate\").click(function() { CancelNewTemplate(this); });\n\n    $('.datepicker').datetimepicker({\n        <?php $datetimepicker_timepicker = false; ?>\n        <?php $datetimepicker_showseconds = false; ?>\n        <?php $datetimepicker_formatInput = true; ?>\n        <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n        <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n    });\n\n    // display the 'new group' DIV\n    var AddTemplate = function(btnObj) {\n        // show the field details DIV\n        $('#newtemplatedetail').css('visibility', 'visible');\n        $('#newtemplatedetail').css('display', 'block');\n        $(btnObj).parent().append($(\"#newtemplatedetail\"));\n        $('#newtemplatedetail > #newtemplatename').focus();\n        $(window).scrollTop($(document).height());\n    };\n\n    // save the new template\n    var SaveNewTemplate = function(btnObj) {\n        // the template name can only have letters, numbers, spaces and underscores\n        // AND it cannot start with a number\n        if ($(\"#newtemplatename\").val().match(/^\\d+/)) {\n            alert(\"<?php echo xls('Template names cannot start with numbers.'); ?>\");\n            return false;\n        }\n        var validname = $(\"#newtemplatename\").val().replace(/[^A-za-z0-9]/g, \"_\"); // match any non-word characters and replace them\n        $(\"#newtemplatename\").val(validname);\n\n        // submit the form to add a new field to a specific group\n        $(\"#formaction\").val(\"newtemplate\");\n        $(\"#theform\").submit();\n    }\n\n    // actually delete a template file\n/*\n    var DeleteTemplate = function(btnObj) {\n        var parts = $(btnObj).attr(\"id\");\n        var groupname = parts.replace(/^\\d+/, \"\");\n        if (confirm(\"WARNING - This action cannot be undone.\\n Are you sure you wish to delete the entire group named '\"+groupname+\"'?\")) {\n            // submit the form to add a new field to a specific group\n            $(\"#formaction\").val(\"deletegroup\");\n            $(\"#deletegroupname\").val(parts);\n            $(\"#theform\").submit();\n        }\n    };\n*/\n\n    // just hide the new template DIV\n    var CancelNewTemplate = function(btnObj) {\n        // hide the field details DIV\n        $('#newtemplatedetail').css('visibility', 'hidden');\n        $('#newtemplatedetail').css('display', 'none');\n        // reset the new group values to a default\n        $('#newtemplatedetail > #newtemplatename').val(\"\");\n    };\n\n\n    // save the template, overwriting the older version\n    var SaveTemplate = function(btnObj) {\n        if (! confirm(\"<?php echo xls('You are about to permanently replace the existing template. Are you sure you wish to continue?'); ?>\")) {\n            return false;\n        }\n        $(\"#formaction\").val(\"savetemplate\");\n        $(\"#theform\").submit();\n    }\n});\n\n</script>\n\n</html>\n", "<?php\n/**\n * add_transaction is a misnomer, as this script will now also edit\n * existing transactions.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../../globals.php\");\nrequire_once(\"$srcdir/transactions.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/amc.php\");\n\nuse OpenEMR\\Core\\Header;\n\n// This can come from the URL if it's an Add.\n$title   = empty($_REQUEST['title']) ? 'LBTref' : $_REQUEST['title'];\n$form_id = $title;\n\n// Plugin support.\n$fname = $GLOBALS['OE_SITE_DIR'] . \"/LBF/$form_id.plugin.php\";\nif (file_exists($fname)) {\n    include_once($fname);\n}\n\n$transid = empty($_REQUEST['transid']) ? 0 : $_REQUEST['transid'] + 0;\n$mode    = empty($_POST['mode' ]) ? '' : $_POST['mode' ];\n// $inmode    = $_GET['inmode'];\n$body_onload_code = \"\";\n\n// Load array of properties for this layout and its groups.\n$grparr = array();\ngetLayoutProperties($form_id, $grparr);\n\nif ($mode) {\n    $sets = \"title = ?, user = ?, groupname = ?, authorized = ?, date = NOW()\";\n    $sqlBindArray = array($form_id, $_SESSION['authUser'], $_SESSION['authProvider'], $userauthorized);\n\n    if ($transid) {\n        array_push($sqlBindArray, $transid);\n        sqlStatement(\"UPDATE transactions SET $sets WHERE id = ?\", $sqlBindArray);\n    } else {\n        array_push($sqlBindArray, $pid);\n        $sets .= \", pid = ?\";\n        $newid = sqlInsert(\"INSERT INTO transactions SET $sets\", $sqlBindArray);\n    }\n\n    $fres = sqlStatement(\"SELECT * FROM layout_options \" .\n    \"WHERE form_id = ? AND uor > 0 AND field_id != '' \" .\n    \"ORDER BY group_id, seq\", array($form_id));\n\n    while ($frow = sqlFetchArray($fres)) {\n        $data_type = $frow['data_type'];\n        $field_id  = $frow['field_id'];\n        $value = get_layout_form_value($frow);\n\n        if ($transid) { // existing form\n            if ($value === '') {\n                $query = \"DELETE FROM lbt_data WHERE \" .\n                \"form_id = ? AND field_id = ?\";\n                sqlStatement($query, array($transid, $field_id));\n            } else {\n                $query = \"REPLACE INTO lbt_data SET field_value = ?, \" .\n                \"form_id = ?, field_id = ?\";\n                sqlStatement($query, array($value, $transid, $field_id));\n            }\n        } else { // new form\n            if ($value !== '') {\n                sqlStatement(\n                    \"INSERT INTO lbt_data \" .\n                    \"( form_id, field_id, field_value ) VALUES ( ?, ?, ? )\",\n                    array($newid, $field_id, $value)\n                );\n            }\n        }\n    }\n\n    if (!$transid) {\n        $transid = $newid;\n    }\n\n  // Set the AMC sent records flag\n    if (!(empty($_POST['send_sum_flag']))) {\n        // add the sent records flag\n        processAmcCall('send_sum_amc', true, 'add', $pid, 'transactions', $transid);\n        if (!(empty($_POST['send_sum_elec_flag']))) {\n            processAmcCall('send_sum_elec_amc', true, 'add', $pid, 'transactions', $transid);\n        }\n    } else {\n        // remove the sent records flags\n        processAmcCall('send_sum_amc', true, 'remove', $pid, 'transactions', $transid);\n        processAmcCall('send_sum_elec_amc', true, 'remove', $pid, 'transactions', $transid);\n    }\n\n    $body_onload_code = \"javascript:location.href='transactions.php';\";\n}\n\n$CPR = 4; // cells per row\n\nfunction end_cell()\n{\n    global $item_count, $cell_count;\n    if ($item_count > 0) {\n        echo \"</td>\";\n        $item_count = 0;\n    }\n}\n\nfunction end_row()\n{\n    global $cell_count, $CPR;\n    end_cell();\n    if ($cell_count > 0) {\n        for (; $cell_count < $CPR;\n        ++$cell_count) {\n            echo \"<td></td>\";\n        }\n\n        echo \"</tr>\\n\";\n        $cell_count = 0;\n    }\n}\n\nfunction end_group()\n{\n    global $last_group;\n    if (strlen($last_group) > 0) {\n        end_row();\n        echo \" </table>\\n\";\n        echo \"</div>\\n\";\n    }\n}\n\n// If we are editing a transaction, get its ID and data.\n$trow = $transid ? getTransById($transid) : array();\n?>\n<html>\n<head>\n\n<title><?php echo xlt('Add/Edit Patient Transaction'); ?></title>\n\n<?php Header::setupHeader(['common','datetime-picker']); ?>\n\n<?php include_once(\"{$GLOBALS['srcdir']}/options.js.php\"); ?>\n\n<script type=\"text/javascript\">\n$(document).ready(function() {\n  if(window.tabbify){\n    tabbify();\n  }\n  if (window.checkSkipConditions) {\n    checkSkipConditions();\n  }\n});\n\nvar mypcc = '<?php echo htmlspecialchars($GLOBALS['phone_country_code'], ENT_QUOTES); ?>';\n\n$(document).ready(function(){\n  $(\"#send_sum_flag\").click(function() {\n    if ( $('#send_sum_flag').prop('checked') ) {\n      // Enable the send_sum_elec_flag checkbox\n      $(\"#send_sum_elec_flag\").removeAttr(\"disabled\");\n    }\n    else {\n      //Disable the send_sum_elec_flag checkbox (also uncheck it if applicable)\n      $(\"#send_sum_elec_flag\").attr(\"disabled\", true);\n      $(\"#send_sum_elec_flag\").prop(\"checked\", false);\n    }\n  });\n\n  $('.datepicker').datetimepicker({\n    <?php $datetimepicker_timepicker = false; ?>\n    <?php $datetimepicker_showseconds = false; ?>\n    <?php $datetimepicker_formatInput = true; ?>\n    <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n    <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n  });\n  $('.datetimepicker').datetimepicker({\n    <?php $datetimepicker_timepicker = true; ?>\n    <?php $datetimepicker_showseconds = false; ?>\n    <?php $datetimepicker_formatInput = true; ?>\n    <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n    <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n  });\n});\n\nfunction titleChanged() {\n var sel = document.forms[0].title;\n // Layouts must not interfere with each other. Reload the document in Add mode.\n top.restoreSession();\n location.href = 'add_transaction.php?title=' + sel.value;\n return true;\n}\n\nfunction divclick(cb, divid) {\n var divstyle = document.getElementById(divid).style;\n if (cb.checked) {\n  divstyle.display = 'block';\n } else {\n  divstyle.display = 'none';\n }\n return true;\n}\n\n// The ID of the input element to receive a found code.\nvar current_sel_name = '';\n\n// This is for callback by the find-code popup.\n// Appends to or erases the current list of related codes.\nfunction set_related(codetype, code, selector, codedesc) {\n var frc = document.forms[0][current_sel_name];\n var s = frc.value;\n if (code) {\n  if (s.length > 0) s += ';';\n  s += codetype + ':' + code;\n } else {\n  s = '';\n }\n frc.value = s;\n}\n\n// This invokes the find-code popup.\nfunction sel_related(e) {\n current_sel_name = e.name;\n dlgopen('../encounter/find_code_popup.php<?php if ($GLOBALS['ippf_specific']) {\n        echo '?codetype=REF';\n} ?>', '_blank', 500, 400);\n}\n\n// Process click on Delete link.\nfunction deleteme() {\n// onclick='return deleteme()'\n dlgopen('../deleter.php?transaction=<?php echo htmlspecialchars($transid, ENT_QUOTES); ?>', '_blank', 500, 450);\n return false;\n}\n\n// Called by the deleteme.php window on a successful delete.\nfunction imdeleted() {\n top.restoreSession();\n location.href = 'transaction/transactions.php';\n}\n\n// Compute the length of a string without leading and trailing spaces.\nfunction trimlen(s) {\n var i = 0;\n var j = s.length - 1;\n for (; i <= j && s.charAt(i) == ' '; ++i);\n for (; i <= j && s.charAt(j) == ' '; --j);\n if (i > j) return 0;\n return j + 1 - i;\n}\n\n// Validation logic for form submission.\nfunction validate(f) {\n var errCount = 0;\n var errMsgs = new Array();\n\n    <?php generate_layout_validation($form_id); ?>\n\n var msg = \"\";\n msg += \"<?php echo xla('The following fields are required'); ?>:\\n\\n\";\n for ( var i = 0; i < errMsgs.length; i++ ) {\n    msg += errMsgs[i] + \"\\n\";\n }\n msg += \"\\n<?php echo xla('Please fill them in before continuing.'); ?>\";\n\n if ( errMsgs.length > 0 ) {\n    alert(msg);\n }\n\n return errMsgs.length < 1;\n}\n\nfunction submitme() {\n var f = document.forms['new_transaction'];\n if (validate(f)) {\n  top.restoreSession();\n  f.submit();\n }\n}\n\n<?php if (function_exists($form_id . '_javascript')) {\n    call_user_func($form_id . '_javascript');\n} ?>\n\n</script>\n\n<style type=\"text/css\">\n.form-control {\n    width: auto;\n    display: inline;\n    height: auto;\n}\ndiv.tab {\n    height: auto;\n    width: auto;\n}\n</style>\n\n</head>\n<body class=\"body_top\" onload=\"<?php echo $body_onload_code; ?>\" >\n<form name='new_transaction' method='post' action='add_transaction.php?transid=<?php echo attr($transid); ?>' onsubmit='return validate(this)'>\n<input type='hidden' name='mode' value='add'>\n\n    <div class=\"container-fluid\">\n        <div class=\"row\">\n            <div class=\"col-xs-12\">\n                <div class=\"page-header\">\n                    <h1><?php echo xlt('Add/Edit Patient Transaction');?></h1>\n                </div>\n            </div>\n            <div class=\"col-xs-12\">\n                <div class=\"btn-group\">\n                    <a href=\"#\" class=\"btn btn-default btn-save\" onclick=\"submitme();\">\n                        <?php echo xlt('Save'); ?>\n                    </a>\n                    <a href=\"transactions.php\" class=\"btn btn-link btn-cancel\" onclick=\"top.restoreSession()\">\n                        <?php echo xlt('Cancel'); ?>\n                    </a>\n                </div>\n                <hr>\n            </div>\n        </div>\n    </div>\n\n    <table class=\"text\">\n        <tr><td>\n        <?php echo xlt('Transaction Type'); ?>:&nbsp;</td><td>\n<?php\n$ttres = sqlStatement(\"SELECT grp_form_id, grp_title \" .\n  \"FROM layout_group_properties WHERE \" .\n  \"grp_form_id LIKE 'LBT%' AND grp_group_id = '' ORDER BY grp_seq, grp_title\");\necho \"<select name='title' id='title' onchange='titleChanged()'>\\n\";\nwhile ($ttrow = sqlFetchArray($ttres)) {\n    $thisid = $ttrow['grp_form_id'];\n    echo \"<option value='\" . attr($thisid) . \"'\";\n    if ($thisid == $form_id) {\n        echo ' selected';\n    }\n    echo \">\" . text($ttrow['grp_title']) . \"</option>\\n\";\n}\necho \"</select>\\n\";\n?>\n        </td></tr>\n    </table>\n\n<div id='referdiv'>\n\n    <?php if ($GLOBALS['enable_amc_prompting'] && 'LBTref' == $form_id) { ?>\n        <div style='float:right;margin-right:25px;border-style:solid;border-width:1px;'>\n            <div style='float:left;margin:5px 5px 5px 5px;'>\n\n                <?php // Display the send records checkboxes (AMC prompting)\n                    $itemAMC = amcCollect(\"send_sum_amc\", $pid, 'transactions', $transid);\n                    $itemAMC_elec = amcCollect(\"send_sum_elec_amc\", $pid, 'transactions', $transid);\n                ?>\n\n                <?php if (!(empty($itemAMC))) { ?>\n                    <input type=\"checkbox\" id=\"send_sum_flag\" name=\"send_sum_flag\" checked>\n                <?php } else { ?>\n                    <input type=\"checkbox\" id=\"send_sum_flag\" name=\"send_sum_flag\">\n                <?php } ?>\n\n                <span class=\"text\"><?php echo xlt('Sent Summary of Care?') ?></span><br>\n\n                <?php if (!(empty($itemAMC)) && !(empty($itemAMC_elec))) { ?>\n                    &nbsp;&nbsp;<input type=\"checkbox\" id=\"send_sum_elec_flag\" name=\"send_sum_elec_flag\" checked>\n                <?php } else if (!(empty($itemAMC))) { ?>\n                    &nbsp;&nbsp;<input type=\"checkbox\" id=\"send_sum_elec_flag\" name=\"send_sum_elec_flag\">\n                <?php } else { ?>\n                    &nbsp;&nbsp;<input type=\"checkbox\" id=\"send_sum_elec_flag\" name=\"send_sum_elec_flag\" disabled>\n                <?php } ?>\n\n                <span class=\"text\"><?php echo xlt('Sent Summary of Care Electronically?') ?></span><br>\n\n            </div>\n        </div>\n    <?php } ?>\n\n                    <div id=\"DEM\">\n                        <ul class=\"tabNav\">\n<?php\n$fres = sqlStatement(\"SELECT * FROM layout_options \" .\n  \"WHERE form_id = ? AND uor > 0 \" .\n  \"ORDER BY group_id, seq\", array($form_id));\n$last_group = '';\n\nwhile ($frow = sqlFetchArray($fres)) {\n    $this_group = $frow['group_id'];\n    // Handle a data category (group) change.\n    if (strcmp($this_group, $last_group) != 0) {\n        $group_seq  = substr($this_group, 0, 1);\n        $group_name = $grparr[$this_group]['grp_title'];\n        $last_group = $this_group;\n        if ($group_seq == 1) {\n            echo \"<li class='current'>\";\n        } else {\n            echo \"<li class=''>\";\n        }\n\n        $group_seq_esc = attr($group_seq);\n        $group_name_show = text(xl_layout_label($group_name));\n        echo \"<a href='#' id='div_$group_seq_esc'>\" .\n        \"$group_name_show</a></li>\";\n    }\n}\n?>\n                        </ul>\n                        <div class=\"tabContainer\">\n<?php\n$fres = sqlStatement(\"SELECT * FROM layout_options \" .\n  \"WHERE form_id = ? AND uor > 0 \" .\n  \"ORDER BY group_id, seq\", array($form_id));\n\n$last_group = '';\n$cell_count = 0;\n$item_count = 0;\n$display_style = 'block';\n$condition_str = '';\n\nwhile ($frow = sqlFetchArray($fres)) {\n    $this_group = $frow['group_id'];\n    $titlecols  = $frow['titlecols'];\n    $datacols   = $frow['datacols'];\n    $data_type  = $frow['data_type'];\n    $field_id   = $frow['field_id'];\n    $list_id    = $frow['list_id'];\n\n    // Accumulate action conditions into a JSON expression for the browser side.\n    accumActionConditions($field_id, $condition_str, $frow['conditions']);\n\n    $currvalue  = '';\n    if (isset($trow[$field_id])) {\n        $currvalue = $trow[$field_id];\n    }\n\n    // Handle special-case default values.\n    if (!$currvalue && !$transid && $form_id == 'LBTref') {\n        if ($field_id == 'refer_date') {\n            $currvalue = date('Y-m-d');\n        } else if ($field_id == 'body' && $transid > 0) {\n             $tmp = sqlQuery(\"SELECT reason FROM form_encounter WHERE \" .\n              \"pid = ? ORDER BY date DESC LIMIT 1\", array($pid));\n            if (!empty($tmp)) {\n                $currvalue = $tmp['reason'];\n            }\n        }\n    }\n\n    // Handle a data category (group) change.\n    if (strcmp($this_group, $last_group) != 0) {\n        end_group();\n        $group_seq  = substr($this_group, 0, 1);\n        $group_name = $grparr[$this_group]['grp_title'];\n        $last_group = $this_group;\n        $group_seq_esc = attr($group_seq);\n        if ($group_seq == 1) {\n            echo \"<div class='tab current' id='div_$group_seq_esc'>\";\n        } else {\n            echo \"<div class='tab' id='div_$group_seq_esc'>\";\n        }\n\n        echo \" <table border='0' cellpadding='0'>\\n\";\n        $display_style = 'none';\n    }\n\n    // Handle starting of a new row.\n    if (($titlecols > 0 && $cell_count >= $CPR) || $cell_count == 0) {\n        end_row();\n        echo \" <tr>\";\n    }\n\n    if ($item_count == 0 && $titlecols == 0) {\n        $titlecols = 1;\n    }\n\n    // Handle starting of a new label cell.\n    if ($titlecols > 0) {\n        end_cell();\n        $titlecols_esc = attr($titlecols);\n        echo \"<td width='70' valign='top' colspan='$titlecols_esc'\";\n        echo ($frow['uor'] == 2) ? \" class='required'\" : \" class='bold'\";\n        if ($cell_count == 2) {\n            echo \" style='padding-left:10pt'\";\n        }\n\n        // This ID is used by action conditions.\n        echo \" id='label_id_\" . attr($field_id) . \"'\";\n        echo \">\";\n        $cell_count += $titlecols;\n    }\n\n    ++$item_count;\n\n    echo \"<b>\";\n\n    // Modified 6-09 by BM - Translate if applicable\n    if ($frow['title']) {\n        echo (text(xl_layout_label($frow['title'])) . \":\");\n    } else {\n        echo \"&nbsp;\";\n    }\n\n     echo \"</b>\";\n\n    // Handle starting of a new data cell.\n    if ($datacols > 0) {\n        end_cell();\n        $datacols_esc = attr($datacols);\n        echo \"<td valign='top' colspan='$datacols_esc' class='text'\";\n        // This ID is used by action conditions.\n        echo \" id='value_id_\" . attr($field_id) . \"'\";\n        if ($cell_count > 0) {\n            echo \" style='padding-left:5pt'\";\n        }\n\n        echo \">\";\n        $cell_count += $datacols;\n    }\n\n    ++$item_count;\n    generate_form_field($frow, $currvalue);\n    echo \"</div>\";\n}\n\nend_group();\n?>\n</div></div>\n</div>\n</form>\n<p />\n\n<!-- include support for the list-add selectbox feature -->\n<?php include $GLOBALS['fileroot'].\"/library/options_listadd.inc\"; ?>\n\n</body>\n\n<script language=\"JavaScript\">\n\n// Array of action conditions for the checkSkipConditions() function.\nvar skipArray = [\n<?php echo $condition_str; ?>\n];\n\n<?php echo $date_init; ?>\n// titleChanged();\n<?php\nif (function_exists($form_id . '_javascript_onload')) {\n    call_user_func($form_id . '_javascript_onload');\n}\n?>\n\n</script>\n\n</html>\n", "<?php\n// +-----------------------------------------------------------------------------+\n// Copyright (C) 2011 Z&H Consultancy Services Private Limited <sam@zhservices.com>\n//\n//\n// This program is free software; you can redistribute it and/or\n// modify it under the terms of the GNU General Public License\n// as published by the Free Software Foundation; either version 2\n// of the License, or (at your option) any later version.\n//\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n//\n// A copy of the GNU General Public License is included along with this program:\n// openemr/interface/login/GnuGPL.html\n// For more information write to the Free Software\n// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.\n//\n// Author:   Eldho Chacko <eldho@zhservices.com>\n//           Jacob T Paul <jacob@zhservices.com>\n//\n// +------------------------------------------------------------------------------+\n\n\nrequire_once(\"../../interface/globals.php\");\n$list_id = $_REQUEST['list_id'] ? $_REQUEST['list_id'] : $_REQUEST['filter_context'];\n\nuse OpenEMR\\Core\\Header;\n\nfunction Delete_Rows($id)\n{\n    sqlStatement(\"DELETE FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($id, $_SESSION['authId']));\n}\n\nfunction Insert_Rows($id, $order = \"\")\n{\n    sqlStatement(\"REPLACE INTO template_users (tu_template_id,tu_user_id,tu_template_order) VALUES (?,?,?)\", array($id, $_SESSION['authId'], $order));\n}\n\nif (isset($_REQUEST['submitform']) && $_REQUEST['submitform'] == 'save') {\n    $topersonalized = $_REQUEST['topersonalized'];\n    $personalized = $_REQUEST['personalized'];\n    foreach ($topersonalized as $key => $value) {\n        $arr = explode(\"|\", $value);\n        $res = sqlStatement(\"SELECT * FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($arr[0], $_SESSION['authId']));\n        if (sqlNumRows($res)) {\n            Delete_Rows($arr[0]);\n            $qry = sqlStatement(\"SELECT * FROM customlists WHERE cl_list_id=? AND cl_deleted=0\", array($arr[0]));\n            while ($row = sqlFetchArray($qry)) {\n                Delete_Rows($row['cl_list_slno']);\n            }\n        }\n    }\n\n    //Add new Categories\n    foreach ($personalized as $key => $value) {\n        $arr = explode(\"|\", $value);\n        if ($arr[1]) {\n            $res = sqlStatement(\"SELECT * FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($arr[0], $_SESSION['authId']));\n            Insert_Rows($arr[0]);\n            $qry = sqlStatement(\"SELECT * FROM customlists WHERE cl_list_id=? AND cl_deleted=0\", array($arr[0]));\n            while ($row = sqlFetchArray($qry)) {\n                $qryTU = sqlStatement(\"SELECT * FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($row['cl_list_slno'], $arr[1]));\n                while ($rowTU = sqlFetchArray($qryTU)) {\n                    Insert_Rows($rowTU['tu_template_id'], $rowTU['tu_template_order']);\n                }\n            }\n        } else {\n            Insert_Rows($arr[0]);\n            $qry = sqlStatement(\"SELECT * FROM customlists WHERE cl_list_id=? AND cl_deleted=0\", array($arr[0]));\n            while ($row = sqlFetchArray($qry)) {\n                Insert_Rows($row['cl_list_slno'], $row['cl_order']);\n            }\n        }\n    }\n}\n?>\n<html>\n<head>\n\n    <?php Header::setupHeader(['common', 'opener', 'jquery-ui',]); ?>\n\n    <script type=\"text/javascript\">\n\n        function refreshme() {\n            top.restoreSession();\n            document.location.reload();\n        }\n\n        $(document).ready(function () {\n\n            tabbify();\n\n            $(\".iframe_small\").on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                dlgopen('', '', 400, 170, '', '', {\n                    buttons: [\n                        {text: '<?php echo xla('Close'); ?>', close: true, style: 'default btn-sm'}\n                    ],\n                    onClosed: 'refreshme',\n                    type: 'iframe',\n                    url: $(this).attr('href')\n                });\n            });\n\n            $(\".iframe_medium\").on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                dlgopen('', '', 450, 250, '', '', {\n                    buttons: [\n                        {text: '<?php echo xla('Close'); ?>', close: true, style: 'default btn-sm'}\n                    ],\n                    onClosed: 'refreshme',\n                    type: 'iframe',\n                    url: $(this).attr('href')\n                });\n            });\n\n            $(\".iframe_abvmedium\").on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                dlgopen('', '', 700, 500, '', '', {\n                    buttons: [\n                        {text: '<?php echo xla('Close'); ?>', close: true, style: 'default btn-sm'}\n                    ],\n                    onClosed: 'refreshme',\n                    type: 'iframe',\n                    url: $(this).attr('href')\n                });\n            });\n\n        });\n\n        function check_user_category(form, selectFrom, selectedList) {\n            top.restoreSession();\n            var total_selected = form.elements[selectedList].length - 1;\n            var msg = '';\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    if (document.getElementById('filter_users').value) {\n                        $.ajax({\n                            type: \"POST\",\n                            url: \"ajax_code.php\",\n                            dataType: \"html\",\n                            data: {\n                                item: form.elements[selectedList].options[total_selected].value,\n                                list_id: document.getElementById('filter_users').value,\n                                source: \"check_item\"\n                            },\n                            async: false,\n                            success: function (thedata) {\n                                if (thedata == 'OK') {\n                                    total_clients = form.elements[selectFrom].length;\n                                    opt = new Option(form.elements[selectedList].options[total_selected].text, form.elements[selectedList].options[total_selected].value);\n                                    form.elements[selectFrom].options[total_clients] = opt;\n                                    form.elements[selectedList].options[total_selected] = null;\n                                }\n                                else {\n                                    msg += form.elements[selectedList].options[total_selected].text + \"\\n\";\n                                }\n                            },\n                            error: function () {\n                                alert(\"fail\");\n                            }\n                        });\n                    }\n                    else {\n                        total_clients = form.elements[selectFrom].length;\n                        opt = new Option(form.elements[selectedList].options[total_selected].text, form.elements[selectedList].options[total_selected].value);\n                        form.elements[selectFrom].options[total_clients] = opt;\n                        form.elements[selectedList].options[total_selected] = null;\n                    }\n                }\n            }\n            jsub_sortNow(form.elements[selectFrom]);\n            if (msg != '') {\n                if (confirm(\"<?php echo addslashes(xl('The following categories will be removed from your category List'));?> \\n\" + msg + \"\\n <?php echo addslashes(xl('Do you want to continue?'));?>\")) {\n                    remove_selected(form, selectedList);\n                }\n            }\n            return;\n        }\n\n        function remove_selected(form, selectedList) {\n            top.restoreSession();\n            var total_selected = form.elements[selectedList].length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    form.elements[selectedList].options[total_selected] = null;\n                }\n            }\n            jsub_sortNow(form.elements[selectFrom]);\n            return;\n        }\n\n        function all_selected(selectedList) {\n            top.restoreSession();\n            var total_selected = document.getElementById(selectedList).length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                document.getElementById(selectedList).options[total_selected].selected = true;\n            }\n        }\n\n        function all_deselected(selectedList) {\n            top.restoreSession();\n            var total_selected = document.getElementById(selectedList).length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                document.getElementById(selectedList).options[total_selected].selected = false;\n            }\n        }\n\n        function jsub_selected(form, selectFrom, selectedList) {\n            top.restoreSession();\n            var total_selected = form.elements[selectedList].length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    total_clients = form.elements[selectFrom].length;\n                    opt = new Option(form.elements[selectedList].options[total_selected].text, form.elements[selectedList].options[total_selected].value);\n                    form.elements[selectFrom].options[total_clients] = opt;\n                    form.elements[selectedList].options[total_selected] = null;\n                }\n            }\n            jsub_sortNow(form.elements[selectFrom]);\n            return;\n        }\n\n        function display_category_item(form, selectedList) {\n            top.restoreSession();\n            var len = 0;\n            var selectedval = '';\n            var total_selected = form.elements[selectedList].length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    selectedval = form.elements[selectedList].options[total_selected].value;\n                    len++;\n                }\n            }\n            if (len > 1) {\n                document.getElementById('itemdiv').style.display = 'none';\n            }\n            else if (len == 1) {\n                document.getElementById('itemdiv').style.display = '';\n                $.ajax({\n                    type: \"POST\",\n                    url: \"ajax_code.php\",\n                    dataType: \"html\",\n                    data: {\n                        list_id: selectedval,\n                        source: \"item_show\"\n                    },\n                    async: false,\n                    success: function (thedata) {\n                        document.getElementById('itemdiv').innerHTML = thedata;\n                    },\n                    error: function () {\n                        alert(\"fail\");\n                    }\n                });\n                return;\n            }\n        }\n\n        function jsub_sortNow(obj) {\n            top.restoreSession();\n            var len = obj.length - 1;\n            var text = new Array();\n            var values = new Array();\n            var sortarr = new Array();\n            for (var i = len; i >= 0; i--) {\n                text[i] = obj.options[i].text;\n                values[i] = obj.options[i].value;\n                sortarr[i] = obj.options[i].text;\n            }\n            sortarr.sort();\n            obj.length = 0;\n            for (i = 0; i <= len; i++) {\n                for (j = 0; j <= len; j++) {\n                    if (sortarr[i] == text[j]) {\n                        break;\n                    }\n                }\n                opt = new Option(text[j], values[j]);\n                obj.options[i] = opt;\n            }\n        }\n\n        function personalize_save() {\n            top.restoreSession();\n            document.getElementById('submitform').value = 'save';\n            all_selected('topersonalized');\n            all_selected('personalized');\n            document.myform.submit();\n        }\n    </script>\n</head>\n<body class=\"body_top\">\n<form name=\"myform\" method=\"post\" onsubmit=\"top.restoreSession();\">\n    <fieldset>\n        <legend><span class=\"text\"><?php echo htmlspecialchars(xl('Filter'), ENT_QUOTES); ?></span></legend>\n        <table>\n            <tr class=\"text\">\n                <td><?php echo htmlspecialchars(xl('Context'), ENT_QUOTES); ?></td>\n                <td>\n                    <select name='filter_context' id='filter_context' onchange='javascript:document.myform.submit();'>\n                        <option value=''><?php echo htmlspecialchars(xl('Select a Context'), ENT_QUOTES); ?></option>\n                        <?php\n                        $context_sql = \"SELECT * FROM customlists WHERE cl_list_type=2 AND cl_deleted=0\";\n                        $context_res = sqlStatement($context_sql);\n                        while ($context_row = sqlFetchArray($context_res)) {\n                            echo \"<option value='\" . htmlspecialchars($context_row['cl_list_slno'], ENT_QUOTES) . \"' \";\n                            echo ($_REQUEST['filter_context'] == $context_row['cl_list_slno']) ? 'selected' : '';\n                            echo \">\" . htmlspecialchars($context_row['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                        }\n                        ?>\n                    </select>\n                </td>\n                <td><?php echo htmlspecialchars(xl('Users'), ENT_QUOTES); ?></td>\n                <td>\n                    <select name='filter_users' id='filter_users' onchange='javascript:document.myform.submit();'>\n                        <option value=''><?php echo htmlspecialchars(xl('Select a User'), ENT_QUOTES); ?></option>\n                        <?php\n                        $user_sql = \"SELECT DISTINCT(tu.tu_user_id),u.fname,u.lname FROM template_users AS tu LEFT OUTER JOIN users AS u ON tu.tu_user_id=u.id WHERE tu.tu_user_id!=?\";\n                        $user_res = sqlStatement($user_sql, array($_SESSION['authId']));\n                        while ($user_row = sqlFetchArray($user_res)) {\n                            echo \"<option value='\" . htmlspecialchars($user_row['tu_user_id'], ENT_QUOTES) . \"' \";\n                            echo ($_REQUEST['filter_users'] == $user_row['tu_user_id']) ? 'selected' : '';\n                            echo \">\" . htmlspecialchars($user_row['fname'] . \" \" . $user_row['lname'], ENT_QUOTES) . \"</option>\";\n                        }\n                        ?>\n                    </select>\n                </td>\n            </tr>\n        </table>\n    </fieldset>\n    <table align=\"center\" width=\"100%\">\n        <tr class=\"text\">\n            <td colspan=\"3\">\n                <a href=# class=\"css_button\"\n                   onclick=\"top.restoreSession();personalize_save()\"><span><?php echo htmlspecialchars(xl('Save'), ENT_QUOTES); ?></span></a>\n                <?php\n                if (acl_check('nationnotes', 'nn_configure')) {\n                    ?>\n                    <a href=\"delete_category.php\" id=\"share_link\" class=\"iframe_medium css_button\"\n                       onclick=\"top.restoreSession();\"><span><?php echo htmlspecialchars(xl('Delete Category'), ENT_QUOTES); ?></span></a>\n                    <?php\n                }\n                ?>\n                <?php\n                if (acl_check('nationnotes', 'nn_configure')) {\n                    ?>\n                    <a href=\"add_template.php?list_id=<?php echo $_REQUEST['list_id']; ?>\"\n                       onclick=\"top.restoreSession();\" class=\"iframe_small css_button\"\n                       title=\"<?php echo htmlspecialchars(xl('Add Category'), ENT_QUOTES); ?>\"><span><?php echo htmlspecialchars(xl('Add Category'), ENT_QUOTES); ?></span></a>\n                    <?php\n                }\n                ?>\n                <?php\n                if (acl_check('nationnotes', 'nn_configure')) {\n                    ?>\n                    <a href=\"add_context.php\" class=\"iframe_medium css_button\" onclick=\"top.restoreSession();\"\n                       title=\"<?php echo htmlspecialchars(xl('Add Context'), ENT_QUOTES); ?>\"><span><?php echo htmlspecialchars(xl('Add Context'), ENT_QUOTES); ?></span></a>\n                    <?php\n                }\n                ?>\n        <tr class=\"text\">\n            <th><?php echo htmlspecialchars(xl('Available categories'), ENT_QUOTES); ?></th>\n            <th>&nbsp;</th>\n            <?php\n            $user = sqlQuery(\"SELECT * FROM users WHERE id=?\", array($_SESSION['authId']));\n            ?>\n            <th><?php echo htmlspecialchars(xl('Categories for') . \" \" . $user['fname'] . \" \" . $user['lname'], ENT_QUOTES); ?></th>\n        </tr>\n        <tr class=\"text\">\n            <td align=right>\n                <select multiple name=\"topersonalized[]\" id=\"topersonalized\" size=\"6\" style=\"width:220px\"\n                        onchange=\"display_category_item(document.myform,'topersonalized');\">\n                    <?php\n                    $where = '';\n                    $join = '';\n                    $arval = array($_SESSION['authId']);\n                    $arval1 = array($_REQUEST['filter_users'], $_SESSION['authId']);\n                    if ($_REQUEST['filter_context']) {\n                        $where .= \" AND cl_list_id=?\";\n                        array_push($arval, $_REQUEST['filter_context']);\n                        array_push($arval1, $_REQUEST['filter_context']);\n                    }\n                    $sql = \"SELECT * FROM template_users AS tu LEFT OUTER JOIN customlists AS c ON tu.tu_template_id=c.cl_list_slno\n                                    WHERE cl_list_type=3 AND cl_deleted=0 AND tu.tu_template_id NOT IN (SELECT tu_template_id FROM template_users AS tuser WHERE\n                                    tu_user_id=?) \" .\n                        $where .\n                        \" ORDER BY cl_list_id,tu_user_id,cl_list_item_long\";\n                    $resTemplates = sqlStatement($sql, $arval);\n                    if ($_REQUEST['filter_users']) {\n                        $sql = \" SELECT * FROM template_users AS tu LEFT OUTER JOIN customlists AS c ON tu.tu_template_id=c.cl_list_slno WHERE\n                                tu.tu_user_id=? AND c.cl_list_type=3 AND cl_deleted=0 AND tu.tu_template_id NOT IN\n                                (SELECT tu_template_id FROM template_users AS tuser WHERE tu_user_id=?)\" .\n                            $where .\n                            \"ORDER BY cl_list_id,tu_user_id,c.cl_list_item_long\";\n                        $resTemplates = sqlStatement($sql, $arval1);\n                    }\n                    while ($rowTemplates = sqlFetchArray($resTemplates)) {\n                        $cntxt = '';\n                        if (!$_REQUEST['filter_context']) {\n                            $context = sqlQuery(\"SELECT * FROM customlists WHERE cl_list_slno=?\", array($rowTemplates['cl_list_id']));\n                            $cntxt .= $context['cl_list_item_long'] . \"->\";\n                        }\n                        if (!$_REQUEST['filter_users']) {\n                            $context = sqlQuery(\"SELECT * FROM users WHERE id=?\", array($rowTemplates['tu_user_id']));\n                            $cntxt .= $context['username'] . \"->\";\n                        }\n                        echo \"<option value='\" . htmlspecialchars($rowTemplates['cl_list_slno'] . \"|\" . $rowTemplates['tu_user_id'], ENT_QUOTES) . \"'>\" . htmlspecialchars($cntxt . $rowTemplates['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                    }\n                    $sqlorphan = \"SELECT * FROM customlists WHERE cl_list_type=3 AND cl_deleted=0 AND cl_list_slno \" .\n                        \" NOT IN (SELECT DISTINCT tu_template_id FROM template_users) \" .\n                        $where .\n                        \" ORDER BY cl_list_id,cl_list_item_long\";\n                    $resorphan = sqlStatement($sqlorphan);\n                    while ($roworphan = sqlFetchArray($resorphan)) {\n                        $cntxt = '';\n                        if (!$_REQUEST['filter_context']) {\n                            $context = sqlQuery(\"SELECT * FROM customlists WHERE cl_list_slno=?\", array($roworphan['cl_list_id']));\n                            $cntxt .= $context['cl_list_item_long'] . \"->\";\n                        }\n                        echo \"<option value='\" . htmlspecialchars($roworphan['cl_list_slno'] . \"|\", ENT_QUOTES) . \"'>\" . htmlspecialchars($cntxt . $roworphan['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                    }\n                    ?>\n                </select>\n            </td>\n            <td align=\"center\">\n                <input type=\"button\" name=\"remove\" value=&raquo;\n                       onclick=\"jsub_selected(document.myform,'personalized','topersonalized')\"></br>\n                <input type=\"button\" name=\"remove\" value=&laquo;\n                       onclick=\"check_user_category(document.myform,'topersonalized','personalized')\">\n            </td>\n            <td align=left>\n                <select multiple name=\"personalized[]\" id=\"personalized\" size=\"6\" style=\"width:220px\">\n                    <?php\n                    $where = '';\n                    if ($_REQUEST['filter_context']) {\n                        $where .= \" AND cl_list_id='\" . $_REQUEST['filter_context'] . \"'\";\n                    }\n                    $sql = \"SELECT * FROM template_users AS tu LEFT OUTER JOIN customlists AS c ON tu.tu_template_id=c.cl_list_slno WHERE\n                                tu.tu_user_id=? AND c.cl_list_type=3 AND cl_deleted=0 \" .\n                        $where .\n                        \"ORDER BY c.cl_list_item_long\";\n                    $resTemplates = sqlStatement($sql, array($_SESSION['authId']));\n                    while ($rowTemplates = sqlFetchArray($resTemplates)) {\n                        $cntxt = '';\n                        if (!$_REQUEST['filter_context']) {\n                            $context = sqlQuery(\"SELECT * FROM customlists WHERE cl_list_slno=?\", array($rowTemplates['cl_list_id']));\n                            $cntxt .= $context['cl_list_item_long'] . \"->\";\n                        }\n                        echo \"<option value='\" . htmlspecialchars($rowTemplates['cl_list_slno'] . \"|\" . $rowTemplates['tu_user_id'], ENT_QUOTES) . \"'>\" . htmlspecialchars($cntxt . $rowTemplates['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                    }\n                    ?>\n                </select>\n            </td>\n        </tr>\n        <tr class=\"text\">\n            <td>&nbsp;</td>\n            <td>&nbsp;</td>\n            <td><input type=\"hidden\" name=\"submitform\" id=\"submitform\" value=\"\"></td>\n        </tr>\n        <tr class=\"text\">\n            <td colspan=\"3\">\n                <div style=\"width:100%;overflow:auto;height:150px\" id=\"itemdiv\"></div>\n            </td>\n        </tr>\n    </table>\n</form>\n</body>\n</html>\n", "<?php\n/**\n* Function to check and/or sanitize things for security such as\n* directories names, file names, etc.\n *\n * @package OpenEMR\n * @link    http://www.open-emr.org\n * @author  Brady Miller <brady.g.miller@gmail.com>\n * @author  Roberto Vasquez <robertogagliotta@gmail.com>\n * @author  Shachar Zilbershlag <shaharzi@matrix.co.il>\n * @copyright Copyright (c) 2012-2017 Brady Miller <brady.g.miller@gmail.com>\n * @license https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\n// If the label contains any illegal characters, then the script will die.\nfunction check_file_dir_name($label)\n{\n    if (empty($label) || preg_match('/[^A-Za-z0-9_.-]/', $label)) {\n        error_log(\"ERROR: The following variable contains invalid characters:\" . $label);\n        die(xlt(\"ERROR: The following variable contains invalid characters\").\": \". attr($label));\n    }\n}\n\n// Convert all illegal characters to _\nfunction convert_safe_file_dir_name($label)\n{\n    return preg_replace('/[^A-Za-z0-9_.-]/', '_', $label);\n}\n\n//Basename functionality for nonenglish languages (without this, basename function ommits nonenglish characters).\nfunction basename_international($path)\n{\n    $parts = preg_split('~[\\\\\\\\/]~', $path);\n    foreach ($parts as $key => $value) {\n        $encoded = urlencode($value);\n        $parts[$key] = $encoded;\n    }\n\n    $encoded_path = implode(\"/\", $parts);\n    $encoded_file_name = basename($encoded_path);\n    $decoded_file_name = urldecode($encoded_file_name);\n\n    return $decoded_file_name;\n}\n\n\n/**\n * This function detects a MIME type for a file and check if it in the white list of the allowed mime types.\n * @param string $file - file location.\n * @param array|null $whiteList - array of mime types that allowed to upload.\n */\n// Regarding the variable below. In the case of multiple file upload the isWhiteList function will run multiple\n// times, therefore, storing the white list in the variable below to prevent multiple requests from database.\n$white_list = null;\nfunction isWhiteFile($file)\n{\n    global $white_list;\n    if (is_null($white_list)) {\n        $white_list = array();\n        $lres = sqlStatement(\"SELECT option_id FROM list_options WHERE list_id = 'files_white_list' AND activity = 1\");\n        while ($lrow = sqlFetchArray($lres)) {\n            $white_list[] = $lrow['option_id'];\n        }\n    }\n\n    $mimetype  = mime_content_type($file);\n    if (in_array($mimetype, $white_list)) {\n        return true;\n    } else {\n        $splitMimeType = explode('/', $mimetype);\n        $categoryType = $splitMimeType[0];\n        if (in_array($categoryType. '/*', $white_list)) {\n            return true;\n        }\n    }\n\n    return false;\n}\n\n// Sanitize a value to ensure it is a number.\nfunction sanitizeNumber($number)\n{\n    $clean_number = $number +0 ;\n\n    if ($clean_number==$number) {\n        return $clean_number;\n    } else {\n        error_log('Custom validation error: Parameter contains non-numeric value (A numeric value expected)');\n        return $clean_number;\n    }\n}\n"], "fixing_code": ["<?php\n/**\n * get_claim_file.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(dirname(__FILE__) . \"/../globals.php\");\nrequire_once $GLOBALS['OE_SITE_DIR'] . \"/config.php\";\n\n$content_type = \"text/plain\";\n$claim_file_dir = $GLOBALS['OE_SITE_DIR'] . \"/edi/\";\n\n$fname = $_GET['key'];\n$fname = preg_replace(\"[/]\", \"\", $fname);\n$fname = preg_replace(\"[\\.\\.]\", \"\", $fname);\n$fname = preg_replace(\"[\\\\\\\\]\", \"\", $fname);\n\nif (strtolower(substr($fname, (strlen($fname)-4))) == \".pdf\") {\n    $content_type = \"application/pdf\";\n}\n\n$fname = $claim_file_dir . $fname;\n\nif (!file_exists($fname)) {\n    echo xl(\"The claim file: \") . text($_GET['key']) . xl(\" could not be accessed.\");\n} else {\n    $fp = fopen($fname, 'r');\n\n    header(\"Pragma: public\");\n    header(\"Expires: 0\");\n    header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n    header(\"Content-Type: $content_type\");\n    header(\"Content-Length: \" . filesize($fname));\n    header(\"Content-Disposition: attachment; filename=\" . basename($fname));\n\n    // dump the picture and stop the script\n    fpassthru($fp);\n}\n\nexit;\n", "<?php\n/**\n * This processes X12 835 remittances and produces a report.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2006-2010 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\n// Buffer all output so we can archive it to a file.\nob_start();\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/invoice_summary.inc.php\");\nrequire_once(\"$srcdir/sl_eob.inc.php\");\nrequire_once(\"$srcdir/parse_era.inc.php\");\nrequire_once(\"claim_status_codes.php\");\nrequire_once(\"adjustment_reason_codes.php\");\nrequire_once(\"remark_codes.php\");\nrequire_once(\"$srcdir/billing.inc\");\n\n$debug = $_GET['debug'] ? 1 : 0; // set to 1 for debugging mode\n$paydate = parse_date($_GET['paydate']);\n$encount = 0;\n\n$last_ptname = '';\n$last_invnumber = '';\n$last_code = '';\n$invoice_total = 0.00;\n$InsertionId;//last inserted ID of\n\n///////////////////////// Assorted Functions /////////////////////////\n\nfunction parse_date($date)\n{\n    $date = substr(trim($date), 0, 10);\n    if (preg_match('/^(\\d\\d\\d\\d)\\D*(\\d\\d)\\D*(\\d\\d)$/', $date, $matches)) {\n        return $matches[1] . '-' . $matches[2] . '-' . $matches[3];\n    }\n\n    return '';\n}\n\nfunction writeMessageLine($bgcolor, $class, $description)\n{\n    $dline =\n    \" <tr bgcolor='$bgcolor'>\\n\" .\n    \"  <td class='$class' colspan='4'>&nbsp;</td>\\n\" .\n    \"  <td class='$class'>$description</td>\\n\" .\n    \"  <td class='$class' colspan='2'>&nbsp;</td>\\n\" .\n    \" </tr>\\n\";\n    echo $dline;\n}\n\nfunction writeDetailLine(\n    $bgcolor,\n    $class,\n    $ptname,\n    $invnumber,\n    $code,\n    $date,\n    $description,\n    $amount,\n    $balance\n) {\n\n    global $last_ptname, $last_invnumber, $last_code;\n    if ($ptname == $last_ptname) {\n        $ptname = '&nbsp;';\n    } else {\n        $last_ptname = $ptname;\n    }\n\n    if ($invnumber == $last_invnumber) {\n        $invnumber = '&nbsp;';\n    } else {\n        $last_invnumber = $invnumber;\n    }\n\n    if ($code == $last_code) {\n        $code = '&nbsp;';\n    } else {\n        $last_code = $code;\n    }\n\n    if ($amount) {\n        $amount  = sprintf(\"%.2f\", $amount);\n    }\n\n    if ($balance) {\n        $balance = sprintf(\"%.2f\", $balance);\n    }\n\n    $dline =\n    \" <tr bgcolor='$bgcolor'>\\n\" .\n    \"  <td class='$class'>$ptname</td>\\n\" .\n    \"  <td class='$class'>$invnumber</td>\\n\" .\n    \"  <td class='$class'>$code</td>\\n\" .\n    \"  <td class='$class'>\" . text(oeFormatShortDate($date)) . \"</td>\\n\" .\n    \"  <td class='$class'>$description</td>\\n\" .\n    \"  <td class='$class' align='right'>\" . oeFormatMoney($amount) . \"</td>\\n\" .\n    \"  <td class='$class' align='right'>\" . oeFormatMoney($balance) . \"</td>\\n\" .\n    \" </tr>\\n\";\n    echo $dline;\n}\n\n    // This writes detail lines that were already in SQL-Ledger for a given\n    // charge item.\n    //\nfunction writeOldDetail(&$prev, $ptname, $invnumber, $dos, $code, $bgcolor)\n{\n    global $invoice_total;\n    // $prev['total'] = 0.00; // to accumulate total charges\n    ksort($prev['dtl']);\n    foreach ($prev['dtl'] as $dkey => $ddata) {\n        $ddate = substr($dkey, 0, 10);\n        $description = $ddata['src'] . $ddata['rsn'];\n        if ($ddate == '          ') { // this is the service item\n            $ddate = $dos;\n            $description = 'Service Item';\n        }\n\n        $amount = sprintf(\"%.2f\", $ddata['chg'] - $ddata['pmt']);\n        $invoice_total = sprintf(\"%.2f\", $invoice_total + $amount);\n        writeDetailLine(\n            $bgcolor,\n            'olddetail',\n            $ptname,\n            $invnumber,\n            $code,\n            $ddate,\n            $description,\n            $amount,\n            $invoice_total\n        );\n    }\n}\n\n    // This is called back by parse_era() once per claim.\n    //\nfunction era_callback_check(&$out)\n{\n    global $InsertionId;//last inserted ID of\n    global $StringToEcho,$debug;\n\n    if ($_GET['original']=='original') {\n        $StringToEcho=\"<br/><br/><br/><br/><br/><br/>\";\n        $StringToEcho.=\"<table border='1' cellpadding='0' cellspacing='0'  width='750'>\";\n        $StringToEcho.=\"<tr bgcolor='#cccccc'><td width='50'></td><td class='dehead' width='150' align='center'>\".htmlspecialchars(xl('Check Number'), ENT_QUOTES).\"</td><td class='dehead' width='400'  align='center'>\".htmlspecialchars(xl('Payee Name'), ENT_QUOTES).\"</td><td class='dehead'  width='150' align='center'>\".htmlspecialchars(xl('Check Amount'), ENT_QUOTES).\"</td></tr>\";\n        $WarningFlag=false;\n        for ($check_count=1; $check_count<=$out['check_count']; $check_count++) {\n            if ($check_count%2==1) {\n                $bgcolor='#ddddff';\n            } else {\n                $bgcolor='#ffdddd';\n            }\n\n             $rs=sqlQ(\"select reference from ar_session where reference='\".$out['check_number'.$check_count].\"'\");\n            if (sqlNumRows($rs)>0) {\n                $bgcolor='#ff0000';\n                $WarningFlag=true;\n            }\n\n            $StringToEcho.=\"<tr bgcolor='$bgcolor'>\";\n            $StringToEcho.=\"<td><input type='checkbox'  name='chk\".$out['check_number'.$check_count].\"' value='\".$out['check_number'.$check_count].\"'/></td>\";\n            $StringToEcho.=\"<td>\".htmlspecialchars($out['check_number'.$check_count]).\"</td>\";\n            $StringToEcho.=\"<td>\".htmlspecialchars($out['payee_name'.$check_count]).\"</td>\";\n            $StringToEcho.=\"<td align='right'>\".htmlspecialchars(number_format($out['check_amount'.$check_count], 2)).\"</td>\";\n            $StringToEcho.=\"</tr>\";\n        }\n\n        $StringToEcho.=\"<tr bgcolor='#cccccc'><td colspan='4' align='center'><input type='submit'  name='CheckSubmit' value='Submit'/></td></tr>\";\n        if ($WarningFlag==true) {\n            $StringToEcho.=\"<tr bgcolor='#ff0000'><td colspan='4' align='center'>\".htmlspecialchars(xl('Warning, Check Number already exist in the database'), ENT_QUOTES).\"</td></tr>\";\n        }\n\n        $StringToEcho.=\"</table>\";\n    } else {\n        for ($check_count=1; $check_count<=$out['check_count']; $check_count++) {\n            $chk_num=$out['check_number'.$check_count];\n            $chk_num=str_replace(' ', '_', $chk_num);\n            if (isset($_REQUEST['chk'.$chk_num])) {\n                $check_date=$out['check_date'.$check_count]?$out['check_date'.$check_count]:$_REQUEST['paydate'];\n                $post_to_date=$_REQUEST['post_to_date']!=''?$_REQUEST['post_to_date']:date('Y-m-d');\n                $deposit_date=$_REQUEST['deposit_date']!=''?$_REQUEST['deposit_date']:date('Y-m-d');\n                $InsertionId[$out['check_number'.$check_count]]=arPostSession($_REQUEST['InsId'], $out['check_number'.$check_count], $out['check_date'.$check_count], $out['check_amount'.$check_count], $post_to_date, $deposit_date, $debug);\n            }\n        }\n    }\n}\nfunction era_callback(&$out)\n{\n    global $encount, $debug, $claim_status_codes, $adjustment_reasons, $remark_codes;\n    global $invoice_total, $last_code, $paydate;\n    global $InsertionId;//last inserted ID of\n\n\n    // Some heading information.\n    $chk_123=$out['check_number'];\n    $chk_123=str_replace(' ', '_', $chk_123);\n    if (isset($_REQUEST['chk'.$chk_123])) {\n        if ($encount == 0) {\n            writeMessageLine(\n                '#ffffff',\n                'infdetail',\n                \"Payer: \" . htmlspecialchars($out['payer_name'], ENT_QUOTES)\n            );\n            if ($debug) {\n                writeMessageLine(\n                    '#ffffff',\n                    'infdetail',\n                    \"WITHOUT UPDATE is selected; no changes will be applied.\"\n                );\n            }\n        }\n\n        $last_code = '';\n        $invoice_total = 0.00;\n        $bgcolor = (++$encount & 1) ? \"#ddddff\" : \"#ffdddd\";\n        list($pid, $encounter, $invnumber) = slInvoiceNumber($out);\n\n        // Get details, if we have them, for the invoice.\n        $inverror = true;\n        $codes = array();\n        if ($pid && $encounter) {\n            // Get invoice data into $arrow or $ferow.\n            $ferow = sqlQuery(\"SELECT e.*, p.fname, p.mname, p.lname \" .\n            \"FROM form_encounter AS e, patient_data AS p WHERE \" .\n            \"e.pid = '$pid' AND e.encounter = '$encounter' AND \".\n            \"p.pid = e.pid\");\n            if (empty($ferow)) {\n                  $pid = $encounter = 0;\n                  $invnumber = $out['our_claim_id'];\n            } else {\n                  $inverror = false;\n                  $codes = ar_get_invoice_summary($pid, $encounter, true);\n                  // $svcdate = substr($ferow['date'], 0, 10);\n            }\n        }\n\n        // Show the claim status.\n        $csc = $out['claim_status_code'];\n        $inslabel = 'Ins1';\n        if ($csc == '1' || $csc == '19') {\n            $inslabel = 'Ins1';\n        }\n\n        if ($csc == '2' || $csc == '20') {\n            $inslabel = 'Ins2';\n        }\n\n        if ($csc == '3' || $csc == '21') {\n            $inslabel = 'Ins3';\n        }\n\n        $primary = ($inslabel == 'Ins1');\n        writeMessageLine(\n            $bgcolor,\n            'infdetail',\n            \"Claim status $csc: \" . $claim_status_codes[$csc]\n        );\n\n    // Show an error message if the claim is missing or already posted.\n        if ($inverror) {\n            writeMessageLine(\n                $bgcolor,\n                'errdetail',\n                \"The following claim is not in our database\"\n            );\n        } else {\n            // Skip this test. Claims can get multiple CLPs from the same payer!\n            //\n            // $insdone = strtolower($arrow['shipvia']);\n            // if (strpos($insdone, 'ins1') !== false) {\n            //  $inverror = true;\n            //  writeMessageLine($bgcolor, 'errdetail',\n            //   \"Primary insurance EOB was already posted for the following claim\");\n            // }\n        }\n\n        if ($csc == '4') {//Denial case, code is stored in the claims table for display in the billing manager screen with reason explained.\n            $inverror = true;\n            if (!$debug) {\n                if ($pid && $encounter) {\n                    $code_value = '';\n                    foreach ($out['svc'] as $svc) {\n                        foreach ($svc['adj'] as $adj) {//Per code and modifier the reason will be showed in the billing manager.\n                            $code_value .= $svc['code'].'_'.$svc['mod'].'_'.$adj['group_code'].'_'.$adj['reason_code'].',';\n                        }\n                    }\n\n                    $code_value = substr($code_value, 0, -1);\n                    //We store the reason code to display it with description in the billing manager screen.\n                    //process_file is used as for the denial case file name will not be there, and extra field(to store reason) can be avoided.\n                    updateClaim(true, $pid, $encounter, $_REQUEST['InsId'], substr($inslabel, 3), 7, 0, $code_value);\n                }\n            }\n\n            writeMessageLine(\n                $bgcolor,\n                'errdetail',\n                \"Not posting adjustments for denied claims, please follow up manually!\"\n            );\n        } else if ($csc == '22') {\n            $inverror = true;\n            writeMessageLine(\n                $bgcolor,\n                'errdetail',\n                \"Payment reversals are not automated, please enter manually!\"\n            );\n        }\n\n        if ($out['warnings']) {\n            writeMessageLine($bgcolor, 'infdetail', nl2br(rtrim($out['warnings'])));\n        }\n\n    // Simplify some claim attributes for cleaner code.\n        $service_date = parse_date($out['dos']);\n        $check_date      = $paydate ? $paydate : parse_date($out['check_date']);\n        $production_date = $paydate ? $paydate : parse_date($out['production_date']);\n\n        $insurance_id = arGetPayerID($pid, $service_date, substr($inslabel, 3));\n        if (empty($ferow['lname'])) {\n              $patient_name = $out['patient_fname'] . ' ' . $out['patient_lname'];\n        } else {\n            $patient_name = $ferow['fname'] . ' ' . $ferow['lname'];\n        }\n\n        $error = $inverror;\n\n    // This loops once for each service item in this claim.\n        foreach ($out['svc'] as $svc) {\n          // Treat a modifier in the remit data as part of the procedure key.\n          // This key will then make its way into SQL-Ledger.\n            $codekey = $svc['code'];\n            if ($svc['mod']) {\n                $codekey .= ':' . $svc['mod'];\n            }\n\n            $prev = $codes[$codekey];\n            $codetype = ''; //will hold code type, if exists\n\n            // This reports detail lines already on file for this service item.\n            if ($prev) {\n                $codetype = $codes[$codekey]['code_type']; //store code type\n                writeOldDetail($prev, $patient_name, $invnumber, $service_date, $codekey, $bgcolor);\n                // Check for sanity in amount charged.\n                $prevchg = sprintf(\"%.2f\", $prev['chg'] + $prev['adj']);\n                if ($prevchg != abs($svc['chg'])) {\n                    writeMessageLine(\n                        $bgcolor,\n                        'errdetail',\n                        \"EOB charge amount \" . $svc['chg'] . \" for this code does not match our invoice\"\n                    );\n                    $error = true;\n                }\n\n                // Check for already-existing primary remittance activity.\n                // Removed this check because it was not allowing for copays manually\n                // entered into the invoice under a non-copay billing code.\n                /****\n            if ((sprintf(\"%.2f\",$prev['chg']) != sprintf(\"%.2f\",$prev['bal']) ||\n                $prev['adj'] != 0) && $primary)\n            {\n                writeMessageLine($bgcolor, 'errdetail',\n                    \"This service item already has primary payments and/or adjustments!\");\n                $error = true;\n            }\n                ****/\n\n                unset($codes[$codekey]);\n            } // If the service item is not in our database...\n            else {\n                // This is not an error. If we are not in error mode and not debugging,\n                // insert the service item into SL.  Then display it (in green if it\n                // was inserted, or in red if we are in error mode).\n                $description = \"CPT4:$codekey Added by $inslabel $production_date\";\n                if (!$error && !$debug) {\n                    arPostCharge(\n                        $pid,\n                        $encounter,\n                        0,\n                        $svc['chg'],\n                        1,\n                        $service_date,\n                        $codekey,\n                        $description,\n                        $debug,\n                        '',\n                        $codetype\n                    );\n                    $invoice_total += $svc['chg'];\n                }\n\n                $class = $error ? 'errdetail' : 'newdetail';\n                writeDetailLine(\n                    $bgcolor,\n                    $class,\n                    $patient_name,\n                    $invnumber,\n                    $codekey,\n                    $production_date,\n                    $description,\n                    $svc['chg'],\n                    ($error ? '' : $invoice_total)\n                );\n            }\n\n            $class = $error ? 'errdetail' : 'newdetail';\n\n            // Report Allowed Amount.\n            if ($svc['allowed']) {\n                // A problem here is that some payers will include an adjustment\n                // reflecting the allowed amount, others not.  So here we need to\n                // check if the adjustment exists, and if not then create it.  We\n                // assume that any nonzero CO (Contractual Obligation) or PI\n            // (Payer Initiated) adjustment is good enough.\n                $contract_adj = sprintf(\"%.2f\", $svc['chg'] - $svc['allowed']);\n                foreach ($svc['adj'] as $adj) {\n                    if (($adj['group_code'] == 'CO' || $adj['group_code'] == 'PI') && $adj['amount'] != 0) {\n                        $contract_adj = 0;\n                    }\n                }\n\n                if ($contract_adj > 0) {\n                    $svc['adj'][] = array('group_code' => 'CO', 'reason_code' => 'A2',\n                    'amount' => $contract_adj);\n                }\n\n                writeMessageLine(\n                    $bgcolor,\n                    'infdetail',\n                    'Allowed amount is ' . sprintf(\"%.2f\", $svc['allowed'])\n                );\n            }\n\n            // Report miscellaneous remarks.\n            if ($svc['remark']) {\n                $rmk = $svc['remark'];\n                writeMessageLine($bgcolor, 'infdetail', \"$rmk: \" . $remark_codes[$rmk]);\n            }\n\n            // Post and report the payment for this service item from the ERA.\n            // By the way a 'Claim' level payment is probably going to be negative,\n            // i.e. a payment reversal.\n            if ($svc['paid']) {\n                if (!$error && !$debug) {\n                    arPostPayment(\n                        $pid,\n                        $encounter,\n                        $InsertionId[$out['check_number']],\n                        $svc['paid'], //$InsertionId[$out['check_number']] gives the session id\n                        $codekey,\n                        substr($inslabel, 3),\n                        $out['check_number'],\n                        $debug,\n                        '',\n                        $codetype\n                    );\n                    $invoice_total -= $svc['paid'];\n                }\n\n                $description = \"$inslabel/\" . $out['check_number'] . ' payment';\n                if ($svc['paid'] < 0) {\n                    $description .= ' reversal';\n                }\n\n                writeDetailLine(\n                    $bgcolor,\n                    $class,\n                    $patient_name,\n                    $invnumber,\n                    $codekey,\n                    $check_date,\n                    $description,\n                    0 - $svc['paid'],\n                    ($error ? '' : $invoice_total)\n                );\n            }\n\n            // Post and report adjustments from this ERA.  Posted adjustment reasons\n            // must be 25 characters or less in order to fit on patient statements.\n            foreach ($svc['adj'] as $adj) {\n                $description = $adj['reason_code'] . ': ' . $adjustment_reasons[$adj['reason_code']];\n                if ($adj['group_code'] == 'PR' || !$primary) {\n                    // Group code PR is Patient Responsibility.  Enter these as zero\n                    // adjustments to retain the note without crediting the claim.\n                    if ($primary) {\n                /****\n                    $reason = 'Pt resp: '; // Reasons should be 25 chars or less.\n                    if ($adj['reason_code'] == '1') $reason = 'To deductible: ';\n                    else if ($adj['reason_code'] == '2') $reason = 'Coinsurance: ';\n                    else if ($adj['reason_code'] == '3') $reason = 'Co-pay: ';\n                ****/\n                        $reason = \"$inslabel ptresp: \"; // Reasons should be 25 chars or less.\n                        if ($adj['reason_code'] == '1') {\n                            $reason = \"$inslabel dedbl: \";\n                        } else if ($adj['reason_code'] == '2') {\n                            $reason = \"$inslabel coins: \";\n                        } else if ($adj['reason_code'] == '3') {\n                            $reason = \"$inslabel copay: \";\n                        }\n                    } // Non-primary insurance adjustments are garbage, either repeating\n                    // the primary or are not adjustments at all.  Report them as notes\n                    // but do not post any amounts.\n                    else {\n                        $reason = \"$inslabel note \" . $adj['reason_code'] . ': ';\n                /****\n                    $reason .= sprintf(\"%.2f\", $adj['amount']);\n                ****/\n                    }\n\n                    $reason .= sprintf(\"%.2f\", $adj['amount']);\n                    // Post a zero-dollar adjustment just to save it as a comment.\n                    if (!$error && !$debug) {\n                        arPostAdjustment(\n                            $pid,\n                            $encounter,\n                            $InsertionId[$out['check_number']],\n                            0,\n                            $codekey, //$InsertionId[$out['check_number']] gives the session id\n                            substr($inslabel, 3),\n                            $reason,\n                            $debug,\n                            '',\n                            $codetype\n                        );\n                    }\n\n                    writeMessageLine($bgcolor, $class, $description . ' ' .\n                    sprintf(\"%.2f\", $adj['amount']));\n                } // Other group codes for primary insurance are real adjustments.\n                else {\n                    if (!$error && !$debug) {\n                        arPostAdjustment(\n                            $pid,\n                            $encounter,\n                            $InsertionId[$out['check_number']],\n                            $adj['amount'], //$InsertionId[$out['check_number']] gives the session id\n                            $codekey,\n                            substr($inslabel, 3),\n                            \"Adjust code \" . $adj['reason_code'],\n                            $debug,\n                            '',\n                            $codetype\n                        );\n                        $invoice_total -= $adj['amount'];\n                    }\n\n                    writeDetailLine(\n                        $bgcolor,\n                        $class,\n                        $patient_name,\n                        $invnumber,\n                        $codekey,\n                        $production_date,\n                        $description,\n                        0 - $adj['amount'],\n                        ($error ? '' : $invoice_total)\n                    );\n                }\n            }\n        } // End of service item\n\n    // Report any existing service items not mentioned in the ERA, and\n    // determine if any of them are still missing an insurance response\n    // (if so, then insurance is not yet done with the claim).\n        $insurance_done = true;\n        foreach ($codes as $code => $prev) {\n          // writeOldDetail($prev, $arrow['name'], $invnumber, $service_date, $code, $bgcolor);\n            writeOldDetail($prev, $patient_name, $invnumber, $service_date, $code, $bgcolor);\n            $got_response = false;\n            foreach ($prev['dtl'] as $ddata) {\n                if ($ddata['pmt'] || $ddata['rsn']) {\n                    $got_response = true;\n                }\n            }\n\n            if (!$got_response) {\n                $insurance_done = false;\n            }\n        }\n\n    // Cleanup: If all is well, mark Ins<x> done and check for secondary billing.\n        if (!$error && !$debug && $insurance_done) {\n            $level_done = 0 + substr($inslabel, 3);\n\n            if ($out['crossover']==1) {//Automatic forward case.So need not again bill from the billing manager screen.\n                sqlStatement(\"UPDATE form_encounter \" .\n                \"SET last_level_closed = $level_done,last_level_billed=\".$level_done.\" WHERE \" .\n                \"pid = '$pid' AND encounter = '$encounter'\");\n                writeMessageLine(\n                    $bgcolor,\n                    'infdetail',\n                    'This claim is processed by Insurance '.$level_done.' and automatically forwarded to Insurance '.($level_done+1) .' for processing. '\n                );\n            } else {\n                sqlStatement(\"UPDATE form_encounter \" .\n                \"SET last_level_closed = $level_done WHERE \" .\n                \"pid = '$pid' AND encounter = '$encounter'\");\n            }\n\n            // Check for secondary insurance.\n            if ($primary && arGetPayerID($pid, $service_date, 2)) {\n                arSetupSecondary($pid, $encounter, $debug, $out['crossover']);\n\n                if ($out['crossover']<>1) {\n                    writeMessageLine(\n                        $bgcolor,\n                        'infdetail',\n                        'This claim is now re-queued for secondary paper billing'\n                    );\n                }\n            }\n        }\n    }\n}\n\n/////////////////////////// End Functions ////////////////////////////\n\n    $info_msg = \"\";\n\n    $eraname = $_GET['eraname'];\nif (! $eraname) {\n    die(xl(\"You cannot access this page directly.\"));\n}\n\n    // Open the output file early so that in case it fails, we do not post a\n    // bunch of stuff without saving the report.  Also be sure to retain any old\n    // report files.  Do not save the report if this is a no-update situation.\n    //\nif (!$debug) {\n    $nameprefix = $GLOBALS['OE_SITE_DIR'] . \"/era/$eraname\";\n    $namesuffix = '';\n    for ($i = 1; is_file(\"$nameprefix$namesuffix.html\"); ++$i) {\n        $namesuffix = \"_$i\";\n    }\n\n    $fnreport = \"$nameprefix$namesuffix.html\";\n    $fhreport = fopen($fnreport, 'w');\n    if (!$fhreport) {\n        die(xl(\"Cannot create\") . \" '\" . text($fnreport) . \"'\");\n    }\n}\n\n?>\n<html>\n<head>\n<?php html_header_show();?>\n<link rel=stylesheet href=\"<?php echo $css_header;?>\" type=\"text/css\">\n<style type=\"text/css\">\n body       { font-family:sans-serif; font-size:8pt; font-weight:normal }\n .dehead    { color:#000000; font-family:sans-serif; font-size:9pt; font-weight:bold }\n .olddetail { color:#000000; font-family:sans-serif; font-size:9pt; font-weight:normal }\n .newdetail { color:#00dd00; font-family:sans-serif; font-size:9pt; font-weight:normal }\n .errdetail { color:#dd0000; font-family:sans-serif; font-size:9pt; font-weight:normal }\n .infdetail { color:#0000ff; font-family:sans-serif; font-size:9pt; font-weight:normal }\n</style>\n<title><?php xl('EOB Posting - Electronic Remittances', 'e')?></title>\n<script language=\"JavaScript\">\n</script>\n</head>\n<body leftmargin='0' topmargin='0' marginwidth='0' marginheight='0'>\n<form action=\"sl_eob_process.php\" method=\"get\" >\n<center>\n<?php\nif ($_GET['original']=='original') {\n    $alertmsg = parse_era_for_check($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\", 'era_callback');\n    echo $StringToEcho;\n} else {\n    ?>\n    <table border='0' cellpadding='2' cellspacing='0' width='100%'>\n\n     <tr bgcolor=\"#cccccc\">\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Patient'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Invoice'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Code'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Date'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\">\n    <?php echo htmlspecialchars(xl('Description'), ENT_QUOTES) ?>\n      </td>\n      <td class=\"dehead\" align=\"right\">\n    <?php echo htmlspecialchars(xl('Amount'), ENT_QUOTES) ?>&nbsp;\n      </td>\n      <td class=\"dehead\" align=\"right\">\n    <?php echo htmlspecialchars(xl('Balance'), ENT_QUOTES) ?>&nbsp;\n      </td>\n     </tr>\n\n    <?php\n    global $InsertionId;\n\n    $eraname=$_REQUEST['eraname'];\n    $alertmsg = parse_era_for_check($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\");\n    $alertmsg = parse_era($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\", 'era_callback');\n    if (!$debug) {\n          $StringIssue=htmlspecialchars(xl(\"Total Distribution for following check number is not full\"), ENT_QUOTES).': ';\n          $StringPrint='No';\n        foreach ($InsertionId as $key => $value) {\n            $rs= sqlQ(\"select pay_total from ar_session where session_id='$value'\");\n            $row=sqlFetchArray($rs);\n            $pay_total=$row['pay_total'];\n            $rs= sqlQ(\"select sum(pay_amount) sum_pay_amount from ar_activity where session_id='$value'\");\n            $row=sqlFetchArray($rs);\n            $pay_amount=$row['sum_pay_amount'];\n\n            if (($pay_total-$pay_amount)<>0) {\n                $StringIssue.=$key.' ';\n                $StringPrint='Yes';\n            }\n        }\n\n        if ($StringPrint=='Yes') {\n            echo \"<script>alert('$StringIssue')</script>\";\n        }\n    }\n\n\n    ?>\n    </table>\n<?php\n}\n?>\n</center>\n<script language=\"JavaScript\">\n<?php\nif ($alertmsg) {\n    echo \" alert('\" . htmlspecialchars($alertmsg, ENT_QUOTES) . \"');\\n\";\n}\n?>\n</script>\n<input type=\"hidden\" name=\"paydate\" value=\"<?php echo attr(DateToYYYYMMDD($_REQUEST['paydate'])); ?>\" />\n<input type=\"hidden\" name=\"post_to_date\" value=\"<?php echo attr(DateToYYYYMMDD($_REQUEST['post_to_date'])); ?>\" />\n<input type=\"hidden\" name=\"deposit_date\" value=\"<?php echo attr(DateToYYYYMMDD($_REQUEST['deposit_date'])); ?>\" />\n<input type=\"hidden\" name=\"debug\" value=\"<?php echo attr($_REQUEST['debug']); ?>\" />\n<input type=\"hidden\" name=\"InsId\" value=\"<?php echo attr($_REQUEST['InsId']); ?>\" />\n<input type=\"hidden\" name=\"eraname\" value=\"<?php echo attr($eraname); ?>\" />\n</form>\n</body>\n</html>\n<?php\n    // Save all of this script's output to a report file.\nif (!$debug) {\n    fwrite($fhreport, ob_get_contents());\n    fclose($fhreport);\n}\n\n    ob_end_flush();\n?>\n", "<?php\n/**\n * This the first of two pages to support posting of EOBs.\n * The second is sl_eob_invoice.php.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Bill Cernansky\n * @author    Tony McCormick\n * @author    Roberto Vasquez <robertogagliotta@gmail.com>\n * @author    Jerry Padgett <sjpadgett@gmail.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2005-2010 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/invoice_summary.inc.php\");\nrequire_once(\"$srcdir/appointments.inc.php\");\nrequire_once($GLOBALS['OE_SITE_DIR'] . \"/statement.inc.php\");\nrequire_once(\"$srcdir/parse_era.inc.php\");\nrequire_once(\"$srcdir/sl_eob.inc.php\");\nrequire_once(\"$srcdir/api.inc\");\nrequire_once(\"$srcdir/forms.inc\");\nrequire_once(\"$srcdir/../controllers/C_Document.class.php\");\nrequire_once(\"$srcdir/documents.php\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/acl.inc\");\n\n$DEBUG = 0; // set to 0 for production, 1 to test\n\n$alertmsg = '';\n$where = '';\n$eraname = '';\n$eracount = 0;\n/* Load dependencies only if we need them */\nif (! empty($GLOBALS['portal_onsite_two_enable'])) {\n    /* Addition of onsite portal patient notify of invoice and reformated invoice - sjpadgett 01/2017 */\n    require_once(\"../../portal/lib/portal_mail.inc\");\n    require_once(\"../../portal/lib/appsql.class.php\");\n\n    function is_auth_portal($pid = 0)\n    {\n        if ($pData = sqlQuery(\"SELECT * FROM `patient_data` WHERE `pid` = ?\", array(\n            $pid\n        ))) {\n            if ($pData['allow_patient_portal'] != \"YES\") {\n                return false;\n            } else {\n                $_SESSION['portalUser'] = strtolower($pData['fname']) . $pData['id'];\n                return true;\n            }\n        } else {\n            return false;\n        }\n    }\n\n    function notify_portal($thispid, array $invoices, $template, $invid)\n    {\n        $builddir = $GLOBALS['OE_SITE_DIR'] . '/documents/onsite_portal_documents/templates/' . $thispid;\n        if (! is_dir($builddir)) {\n            mkdir($builddir, 0755, true);\n        }\n\n        if (fixup_invoice($template, $builddir . '/invoice' . $invid . '.tpl') != true) {\n            return false;\n        }\n\n        if (SavePatientAudit($thispid, $invoices) != true) {\n            return false;\n        } // this is all the invoice data for portal auditing\n        $note = xl('You have an invoice due for payment in your Patient Documents. There you may pay, download or print the invoice. Thank you.');\n        if (sendMail($_SESSION['authUser'], $note, xlt('Bill/Collect'), '', '0', $_SESSION['authUser'], $_SESSION['authUser'], $_SESSION['portalUser'], $invoices[0]['patient'], \"New\", '0') == 1) { // remind admin this was sent\n            sendMail($_SESSION['portalUser'], $note, xlt('Bill/Collect'), '', '0', $_SESSION['authUser'], $_SESSION['authUser'], $_SESSION['portalUser'], $invoices[0]['patient'], \"New\", '0'); // notify patient\n        } else {\n            return false;\n        }\n\n        return true;\n    }\n\n    function fixup_invoice($template, $ifile)\n    {\n        $data = file_get_contents($template);\n        if ($data == \"\") {\n            return false;\n        }\n\n        if (! file_put_contents($ifile, $data)) {\n            return false;\n        }\n\n        return true;\n    }\n\n    function SavePatientAudit($pid, $invs)\n    {\n        $appsql = new ApplicationTable();\n        try {\n            $audit = array();\n            $audit['patient_id'] = $pid;\n            $audit['activity'] = \"invoice\";\n            $audit['require_audit'] = \"0\";\n            $audit['pending_action'] = \"payment\";\n            $audit['action_taken'] = \"\";\n            $audit['status'] = \"waiting transaction\";\n            $audit['narrative'] = \"Request patient online payment.\";\n            $audit['table_action'] = '';\n            $audit['table_args'] = json_encode($invs);\n            $audit['action_user'] = $pid;\n            $audit['action_taken_time'] = \"\";\n            $audit['checksum'] = \"\";\n            $edata = $appsql->getPortalAudit($pid, 'payment', 'invoice', \"waiting transaction\", 0);\n            if ($edata['id'] > 0) {\n                $appsql->portalAudit('update', $edata['id'], $audit);\n            } else {\n                $appsql->portalAudit('insert', '', $audit);\n            }\n        } catch (Exception $ex) {\n            return $ex;\n        }\n\n        return true;\n    }\n}\n\n// This is called back by parse_era() if we are processing X12 835's.\nfunction era_callback(&$out)\n{\n    global $where, $eracount, $eraname;\n  // print_r($out); // debugging\n    ++$eracount;\n  // $eraname = $out['isa_control_number'];\n    $eraname = $out['gs_date'] . '_' . ltrim($out['isa_control_number'], '0') .\n    '_' . ltrim($out['payer_id'], '0');\n    list($pid, $encounter, $invnumber) = slInvoiceNumber($out);\n\n    if ($pid && $encounter) {\n        if ($where) {\n            $where .= ' OR ';\n        }\n\n        $where .= \"( f.pid = '$pid' AND f.encounter = '$encounter' )\";\n    }\n}\n\nfunction bucks($amount)\n{\n    if ($amount) {\n        echo oeFormatMoney($amount);\n    }\n}\n\nfunction validEmail($email)\n{\n    if (preg_match(\"^[_a-z0-9-]+(\\.[_a-z0-9-]+)*@[a-z0-9-]+(\\.[a-z0-9-]+)*(\\.[a-z]{2,3})$^\", $email)) {\n        return true;\n    }\n\n    return false;\n}\n\nfunction emailLogin($patient_id, $message)\n{\n    $patientData = sqlQuery(\"SELECT * FROM `patient_data` WHERE `pid`=?\", array($patient_id));\n    if ($patientData['hipaa_allowemail'] != \"YES\" || empty($patientData['email']) || empty($GLOBALS['patient_reminder_sender_email'])) {\n        return false;\n    }\n\n    if (!(validEmail($patientData['email']))) {\n        return false;\n    }\n\n    if (!(validEmail($GLOBALS['patient_reminder_sender_email']))) {\n        return false;\n    }\n\n    if ($_SESSION['pc_facility']) {\n        $sql = \"select * from facility where id=?\";\n        $facility = sqlQuery($sql, array($_SESSION['pc_facility']));\n    } else {\n        $sql = \"SELECT * FROM facility ORDER BY billing_location DESC LIMIT 1\";\n        $facility = sqlQuery($sql);\n    }\n\n    $mail = new MyMailer();\n    $pt_name=$patientData['fname'].' '.$patientData['lname'];\n    $pt_email=$patientData['email'];\n    $email_subject=($facility['name'] . ' ' . xl('Patient Statement Bill'));\n    $email_sender=$GLOBALS['patient_reminder_sender_email'];\n    $mail->AddReplyTo($email_sender, $email_sender);\n    $mail->SetFrom($email_sender, $email_sender);\n    $mail->AddAddress($pt_email, $pt_name);\n    $mail->Subject = $email_subject;\n    $mail->MsgHTML(\"<html><body><div class='wrapper'>\".$message.\"</div></body></html>\");\n    $mail->IsHTML(true);\n    $mail->AltBody = $message;\n\n    if ($mail->Send()) {\n        return true;\n    } else {\n        $email_status = $mail->ErrorInfo;\n        error_log(\"EMAIL ERROR: \".$email_status, 0);\n        return false;\n    }\n}\n\n// Upload a file to the client's browser\n//\nfunction upload_file_to_client($file_to_send)\n{\n    header(\"Pragma: public\");\n    header(\"Expires: 0\");\n    header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n    header(\"Content-Type: application/force-download\");\n    header(\"Content-Length: \" . filesize($file_to_send));\n    header(\"Content-Disposition: attachment; filename=\" . basename($file_to_send));\n    header(\"Content-Description: File Transfer\");\n    readfile($file_to_send);\n  // flush the content to the browser. If you don't do this, the text from the subsequent\n  // output from this script will be in the file instead of sent to the browser.\n    flush();\n    exit(); //added to exit from process properly in order to stop bad html code -ehrlive\n  // sleep one second to ensure there's no follow-on.\n    sleep(1);\n}\n\nfunction upload_file_to_client_email($ppid, $file_to_send)\n{\n    $message = \"\";\n    global $STMT_TEMP_FILE_PDF;\n    $file = fopen($file_to_send, \"r\");//this file contains the text to be converted to pdf.\n    while (!feof($file)) {\n        $OneLine=fgets($file);//one line is read\n\n         $message = $message.$OneLine.'<br>';\n\n        $countline++;\n    }\n\n    emailLogin($ppid, $message);\n}\n\nfunction upload_file_to_client_pdf($file_to_send, $aPatFirstName = '', $aPatID = null, $flagCFN = false)\n{\n //modified for statement title name\n  //Function reads a HTML file and converts to pdf.\n\n    $aPatFName = convert_safe_file_dir_name($aPatFirstName); //modified for statement title name\n    if ($flagCFN) {\n        $STMT_TEMP_FILE_PDF = $GLOBALS['temporary_files_dir'] . \"/Stmt_{$aPatFName}_{$aPatID}.pdf\";\n    } else {\n        global $STMT_TEMP_FILE_PDF;\n    }\n\n    global $srcdir;\n\n    if ($GLOBALS['statement_appearance'] == '1') {\n        require_once(\"$srcdir/html2pdf/vendor/autoload.php\");\n        $pdf2 = new HTML2PDF(\n            $GLOBALS['pdf_layout'],\n            $GLOBALS['pdf_size'],\n            $GLOBALS['pdf_language'],\n            true, // default unicode setting is true\n            'UTF-8', // default encoding setting is UTF-8\n            array($GLOBALS['pdf_left_margin'],$GLOBALS['pdf_top_margin'],$GLOBALS['pdf_right_margin'],$GLOBALS['pdf_bottom_margin']),\n            $_SESSION['language_direction'] == 'rtl' ? true : false\n        );\n        ob_start();\n        readfile($file_to_send, \"r\");//this file contains the HTML to be converted to pdf.\n        //echo $file;\n        $content = ob_get_clean();\n\n        // Fix a nasty html2pdf bug - it ignores document root!\n        global $web_root, $webserver_root;\n        $i = 0;\n        $wrlen = strlen($web_root);\n        $wsrlen = strlen($webserver_root);\n        while (true) {\n              $i = stripos($content, \" src='/\", $i + 1);\n            if ($i === false) {\n                break;\n            }\n\n            if (substr($content, $i+6, $wrlen) === $web_root &&\n              substr($content, $i+6, $wsrlen) !== $webserver_root) {\n                $content = substr($content, 0, $i + 6) . $webserver_root . substr($content, $i + 6 + $wrlen);\n            }\n        }\n\n        $pdf2->WriteHTML($content);\n        $temp_filename = $STMT_TEMP_FILE_PDF;\n        $content_pdf = $pdf2->Output($STMT_TEMP_FILE_PDF, 'F');\n    } else {\n        $pdf = new Cezpdf('LETTER');//pdf creation starts\n        $pdf->ezSetMargins(45, 9, 36, 10);\n        $pdf->selectFont('Courier');\n        $pdf->ezSetY($pdf->ez['pageHeight'] - $pdf->ez['topMargin']);\n        $countline=1;\n        $file = fopen($file_to_send, \"r\");//this file contains the text to be converted to pdf.\n        while (!feof($file)) {\n            $OneLine=fgets($file);//one line is read\n            if (stristr($OneLine, \"\\014\") == true && !feof($file)) {//form feed means we should start a new page.\n                $pdf->ezNewPage();\n                $pdf->ezSetY($pdf->ez['pageHeight'] - $pdf->ez['topMargin']);\n                str_replace(\"\\014\", \"\", $OneLine);\n            }\n\n            if (stristr($OneLine, 'REMIT TO') == true || stristr($OneLine, 'Visit Date') == true || stristr($OneLine, 'Future Appointments') == true || stristr($OneLine, 'Current') == true) { //lines are made bold when 'REMIT TO' or 'Visit Date' is there.\n                $pdf->ezText('<b>'.$OneLine.'</b>', 12, array('justification' => 'left', 'leading' => 6));\n            } else {\n                $pdf->ezText($OneLine, 12, array('justification' => 'left', 'leading' => 6));\n            }\n\n            $countline++;\n        }\n\n        $fh = @fopen($STMT_TEMP_FILE_PDF, 'w');//stored to a pdf file\n        if ($fh) {\n            fwrite($fh, $pdf->ezOutput());\n            fclose($fh);\n        }\n    }\n\n    header(\"Pragma: public\");//this section outputs the pdf file to browser\n    header(\"Expires: 0\");\n    header(\"Cache-Control: must-revalidate, post-check=0, pre-check=0\");\n    header(\"Content-Type: application/force-download\");\n    header(\"Content-Length: \" . filesize($STMT_TEMP_FILE_PDF));\n    header(\"Content-Disposition: attachment; filename=\" . basename($STMT_TEMP_FILE_PDF));\n    header(\"Content-Description: File Transfer\");\n    readfile($STMT_TEMP_FILE_PDF);\n  // flush the content to the browser. If you don't do this, the text from the subsequent\n  // output from this script will be in the file instead of sent to the browser.\n    flush();\n    exit(); //added to exit from process properly in order to stop bad html code -ehrlive\n  // sleep one second to ensure there's no follow-on.\n    sleep(1);\n}\n\n\n$today = date(\"Y-m-d\");\n  // Print or download statements if requested.\n  //\nif (($_POST['form_print'] || $_POST['form_download'] || $_POST['form_email'] || $_POST['form_pdf']) || $_POST['form_portalnotify'] && $_POST['form_cb']) {\n    $fhprint = fopen($STMT_TEMP_FILE, 'w');\n\n    $sqlBindArray = array();\n    $where = \"\";\n    foreach ($_POST['form_cb'] as $key => $value) {\n        $where .= \" OR f.id = ?\";\n        array_push($sqlBindArray, $key);\n    }\n\n    if (!empty($where)) {\n        $where = substr($where, 4);\n        $where = '( ' . $where . ' ) AND';\n    }\n\n    $res = sqlStatement(\"SELECT \" .\n    \"f.id, f.date, f.pid, f.encounter, f.stmt_count, f.last_stmt_date, f.last_level_closed, f.last_level_billed, f.billing_note as enc_billing_note, \" .\n    \"p.fname, p.mname, p.lname, p.street, p.city, p.state, p.postal_code, p.billing_note as pat_billing_note \" .\n    \"FROM form_encounter AS f, patient_data AS p \" .\n    \"WHERE $where \" .\n    \"p.pid = f.pid \" .\n    \"ORDER BY p.lname, p.fname, f.pid, f.date, f.encounter\", $sqlBindArray);\n\n    $stmt = array();\n    $stmt_count = 0;\n\n    $flagT = true;\n    $aPatientFirstName = '';\n    $aPatientID = null;\n    $multiplePatients = false;\n    $usePatientNamePdf = false;\n\n    // get pids for delimits\n    // need to only use summary invoice for multi visits\n    $inv_pid = array();\n    $inv_count = -1;\n    if ($_POST['form_portalnotify']) {\n        foreach ($_POST['form_invpids'] as $key => $v) {\n            if ($_POST['form_cb'][$key]) {\n                array_push($inv_pid, key($v));\n            }\n        }\n    }\n    $rcnt = 0;\n    while ($row = sqlFetchArray($res)) {\n        $rows[] = $row;\n        if (!$inv_pid[$rcnt]) {\n            array_push($inv_pid, $row['pid']);\n        }\n        $rcnt++;\n    }\n   // This loops once for each invoice/encounter.\n   //\n    $rcnt = 0;\n    while ($row = $rows[$rcnt++]) {\n        $svcdate = substr($row['date'], 0, 10);\n        $duedate = $svcdate; // TBD?\n        $duncount = $row['stmt_count'];\n        $enc_note = $row['enc_billing_note'];\n\n        if ($flagT) {\n            $flagT = false;\n            $aPatientFirstName = $row['fname'];\n            $aPatientID = $row['pid'];\n            $usePatientNamePdf = true;\n        } elseif (!$multiplePatients) {\n            if ($aPatientID != $row['pid']) {\n                $multiplePatients = true;\n                $aPatientFirstName = '';\n                $aPatientID = null;\n                $usePatientNamePdf = false;\n            }\n        }\n\n       // If this is a new patient then print the pending statement\n       // and start a new one.  This is an associative array:\n       //\n       //  cid     = same as pid\n       //  pid     = OpenEMR patient ID\n       //  patient = patient name\n       //  amount  = total amount due\n       //  adjust  = adjustments (already applied to amount)\n       //  duedate = due date of the oldest included invoice\n       //  age     = number of days from duedate to today\n       //  to      = array of addressee name/address lines\n       //  lines   = array of:\n       //    dos     = date of service \"yyyy-mm-dd\"\n       //    desc    = description\n       //    amount  = charge less adjustments\n       //    paid    = amount paid\n       //    notice  = 1 for first notice, 2 for second, etc.\n       //    detail  = array of details, see invoice_summary.inc.php\n       //\n        if ($stmt['cid'] != $row['pid']) {\n            if (!empty($stmt)) {\n                ++$stmt_count;\n            }\n\n            $stmt['cid'] = $row['pid'];\n            $stmt['pid'] = $row['pid'];\n            $stmt['dun_count'] = $row['stmt_count'];\n            $stmt['bill_note'] = $row['pat_billing_note'];\n            $stmt['enc_bill_note'] = $row['enc_billing_note'];\n            $stmt['bill_level'] = $row['last_level_billed'];\n            $stmt['level_closed'] = $row['last_level_closed'];\n            $stmt['patient'] = $row['fname'] . ' ' . $row['lname'];\n            $stmt['encounter'] = $row['encounter'];\n            #If you use the field in demographics layout called\n            #guardiansname this will allow you to send statements to the parent\n            #of a child or a guardian etc\n            if (strlen($row['guardiansname']) == 0) {\n                $stmt['to'] = array($row['fname'] . ' ' . $row['lname']);\n            } else {\n                $stmt['to'] = array($row['guardiansname']);\n            }\n\n            if ($row['street']) {\n                $stmt['to'][] = $row['street'];\n            }\n\n            $stmt['to'][] = $row['city'] . \", \" . $row['state'] . \" \" . $row['postal_code'];\n            $stmt['lines'] = array();\n            $stmt['amount'] = '0.00';\n            $stmt['ins_paid'] = 0;\n            $stmt['today'] = $today;\n            $stmt['duedate'] = $duedate;\n        } else {\n            // Report the oldest due date.\n            if ($duedate < $stmt['duedate']) {\n                $stmt['duedate'] = $duedate;\n            }\n        }\n\n        // Recompute age at each invoice.\n        $stmt['age'] = round((strtotime($today) - strtotime($stmt['duedate'])) / (24 * 60 * 60));\n\n        $invlines = ar_get_invoice_summary($row['pid'], $row['encounter'], true);\n        foreach ($invlines as $key => $value) {\n            $line = array();\n            $line['dos']     = $svcdate;\n            if ($GLOBALS['use_custom_statement']) {\n                $line['desc']    = ($key == 'CO-PAY') ? \"Patient Payment\" : $value['code_text'];\n            } else {\n                $line['desc']    = ($key == 'CO-PAY') ? \"Patient Payment\" : \"Procedure $key\";\n            }\n\n             $line['amount']  = sprintf(\"%.2f\", $value['chg']);\n             $line['adjust']  = sprintf(\"%.2f\", $value['adj']);\n             $line['paid']    = sprintf(\"%.2f\", $value['chg'] - $value['bal']);\n             $line['notice']  = $duncount + 1;\n             $line['detail']  = $value['dtl'];\n             $stmt['lines'][] = $line;\n             $stmt['amount']  = sprintf(\"%.2f\", $stmt['amount'] + $value['bal']);\n             $stmt['ins_paid']  = $stmt['ins_paid'] + $value['ins'];\n        }\n\n        // Record that this statement was run.\n        if (! $DEBUG && ! $_POST['form_without']) {\n            sqlStatement(\"UPDATE form_encounter SET \" .\n            \"last_stmt_date = '$today', stmt_count = stmt_count + 1 \" .\n            \"WHERE id = \" . $row['id']);\n        }\n        $inv_count += 1;\n        if ($_POST['form_portalnotify']) {\n            if (! is_auth_portal($stmt['pid'])) {\n                $alertmsg = xlt('Notification FAILED: Not Portal Authorized');\n                break;\n            }\n            $pvoice[] = $stmt;\n            // we don't want to send the portal multiple invoices, thus this. Last invoice for pid is summary.\n            if ($inv_pid[$inv_count] != $inv_pid[$inv_count + 1]) {\n                fwrite($fhprint, make_statement($stmt));\n                if (! notify_portal($stmt['pid'], $pvoice, $STMT_TEMP_FILE, $stmt['pid'] . \"-\" . $stmt['encounter'])) {\n                    $alertmsg = xlt('Notification FAILED');\n                    break;\n                }\n\n                $pvoice = array();\n                flush();\n                ftruncate($fhprint, 0);\n            } else {\n                continue;\n            }\n        } else {\n            if ($inv_pid[$inv_count] != $inv_pid[$inv_count + 1]) {\n                $tmp = make_statement($stmt);\n                if (empty($tmp)) {\n                    $tmp = xlt(\"This EOB item does not meet minimum print requirements setup in Globals or there is an unknown error.\") . \" \" . xlt(\"EOB Id\") . \":\" . $inv_pid[$inv_count] . \" \" . xlt(\"Encounter\") . \":\" . $stmt[encounter] . \"\\n\";\n                    $tmp .= \"<br />\\n\\014<br /><br />\";\n                }\n                fwrite($fhprint, $tmp);\n            }\n        }\n    } // end while\n\n    if (!empty($stmt)) {\n        ++$stmt_count;\n    }\n\n    fclose($fhprint);\n    sleep(1);\n    // Download or print the file, as selected\n    if ($_POST['form_download']) {\n        upload_file_to_client($STMT_TEMP_FILE);\n    } elseif ($_POST['form_pdf']) {\n        upload_file_to_client_pdf($STMT_TEMP_FILE, $aPatientFirstName, $aPatientID, $usePatientNamePdf);\n    } elseif ($_POST['form_email']) {\n                upload_file_to_client_email($stmt['pid'], $STMT_TEMP_FILE);\n    } elseif ($_POST['form_portalnotify']) {\n        if ($alertmsg == \"\") {\n            $alertmsg = xl('Sending Invoice to Patient Portal Completed');\n        }\n    } else { // Must be print!\n        if ($DEBUG) {\n            $alertmsg = xl(\"Printing skipped; see test output in\") .' '. $STMT_TEMP_FILE;\n        } else {\n            exec(\"$STMT_PRINT_CMD $STMT_TEMP_FILE\");\n            if ($_POST['form_without']) {\n                $alertmsg = xl('Now printing') .' '. $stmt_count .' '. xl('statements; invoices will not be updated.');\n            } else {\n                $alertmsg = xl('Now printing') .' '. $stmt_count .' '. xl('statements and updating invoices.');\n            }\n        } // end not debug\n    } // end not form_download\n} // end statements requested\n    ?>\n  <html>\n  <head>\n    <?php html_header_show(); ?>\n    <link rel=stylesheet href=\"<?php echo $css_header;?>\" type=\"text/css\">\n    <title><?php xl('EOB Posting - Search', 'e'); ?></title>\n    <script type=\"text/javascript\" src=\"../../library/textformat.js\"></script>\n\n    <script language=\"JavaScript\">\n\n    var mypcc = '1';\n\n    function checkAll(checked) {\n     var f = document.forms[0];\n     for (var i = 0; i < f.elements.length; ++i) {\n      var ename = f.elements[i].name;\n      if (ename.indexOf('form_cb[') == 0)\n       f.elements[i].checked = checked;\n   }\n }\n\n function npopup(pid) {\n   window.open('sl_eob_patient_note.php?patient_id=' + pid, '_blank', 'width=500,height=250,resizable=1');\n   return false;\n }\n\n </script>\n\n</head>\n\n<body leftmargin='0' topmargin='0' marginwidth='0' marginheight='0'>\n  <center>\n\n    <form method='post' action='sl_eob_search.php' enctype='multipart/form-data'>\n\n      <table border='0' cellpadding='5' cellspacing='0'>\n       <tr>\n\n        <?php\n  // Identify the payer to support resumable posting sessions.\n        echo \"  <td>\\n\";\n        echo \"   \" . xl('Payer') . \":\\n\";\n        echo \"  </td>\\n\";\n        echo \"  <td>\\n\";\n        $insurancei = getInsuranceProviders();\n        echo \"   <select name='form_payer_id'>\\n\";\n        echo \"    <option value='0'>-- \" . xl('Patient') . \" --</option>\\n\";\n        foreach ($insurancei as $iid => $iname) {\n            echo \"<option value='$iid'\";\n            if ($iid == $_POST['form_payer_id']) {\n                echo \" selected\";\n            }\n\n            echo \">\" . $iname . \"</option>\\n\";\n        }\n\n        echo \"   </select>\\n\";\n        echo \"  </td>\\n\";\n        ?>\n\n        <td>\n            <?php xl('Source:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_source' size='10' value='<?php echo attr($_POST['form_source']); ?>'\n         title='<?php xl(\"A check number or claim number to identify the payment\", \"e\"); ?>'>\n       </td>\n       <td>\n            <?php xl('Pay Date:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_paydate' size='10' value='<?php echo attr($_POST['form_paydate']); ?>'\n         onkeyup='datekeyup(this,mypcc)' onblur='dateblur(this,mypcc)'\n         title='<?php xl(\"Date of payment yyyy-mm-dd\", \"e\"); ?>'>\n       </td>\n\n       <td>\n            <?php xl('Deposit Date:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_deposit_date' size='10' value='<?php echo attr($_POST['form_deposit_date']); ?>'\n         onkeyup='datekeyup(this,mypcc)' onblur='dateblur(this,mypcc)'\n         title='<?php xl(\"Date of bank deposit yyyy-mm-dd\", \"e\"); ?>'>\n       </td>\n\n       <td>\n            <?php xl('Amount:', 'e'); ?>\n       </td>\n       <td>\n         <input type='text' name='form_amount' size='10' value='<?php echo attr($_POST['form_amount']); ?>'\n         title='<?php xl(\"Paid amount that you will allocate\", \"e\"); ?>'>\n       </td>\n       <td align='right'>\n         <a href='sl_eob_help.php' target='_blank'><?php xl('Help', 'e'); ?></a>\n       </td>\n\n     </tr>\n   </table>\n\n   <table border='0' cellpadding='5' cellspacing='0'>\n\n     <tr bgcolor='#ddddff'>\n      <td>\n        <?php xl('Name:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_name' size='10' value='<?php echo attr($_POST['form_name']); ?>'\n       title='<?php xl(\"Any part of the patient name, or \\\"last,first\\\", or \\\"X-Y\\\"\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('Chart ID:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_pid' size='10' value='<?php echo attr($_POST['form_pid']); ?>'\n       title='<?php xl(\"Patient chart ID\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('Encounter:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_encounter' size='10' value='<?php echo attr($_POST['form_encounter']); ?>'\n       title='<?php xl(\"Encounter number\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('Svc Date:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_date' size='10' value='<?php echo attr($_POST['form_date']); ?>'\n       title='<?php xl(\"Date of service mm/dd/yyyy\", \"e\"); ?>'>\n     </td>\n     <td>\n        <?php xl('To:', 'e'); ?>\n     </td>\n     <td>\n       <input type='text' name='form_to_date' size='10' value='<?php echo attr($_POST['form_to_date']); ?>'\n       title='<?php xl(\"Ending DOS mm/dd/yyyy if you wish to enter a range\", \"e\"); ?>'>\n     </td>\n     <td>\n       <select name='form_category'>\n        <?php\n        foreach (array(xl('Open'), xl('All'), xl('Due Pt'), xl('Due Ins')) as $value) {\n            echo \"    <option value='$value'\";\n            if ($_POST['form_category'] == $value) {\n                echo \" selected\";\n            }\n\n            echo \">$value</option>\\n\";\n        }\n        ?>\n      </select>\n    </td>\n    <td>\n     <input type='submit' name='form_search' value='<?php xl(\"Search\", \"e\"); ?>'>\n   </td>\n </tr>\n       <!-- Filter - only show those who have debt -->\n       <tr bgcolor='#ddddff'>\n           <td colspan='12'>\n\n               <span><?php echo xlt('Patients with debt');?>\n                <input <?php echo $_POST['only_with_debt']?'checked=checked':'';?> type=\"checkbox\" name=\"only_with_debt\"  />\n               </span>\n\n           </td>\n       </tr>\n <!-- Support for X12 835 upload -->\n <tr bgcolor='#ddddff'>\n  <td colspan='12'>\n    <?php xl('Or upload ERA file:', 'e'); ?>\n   <input type=\"hidden\" name=\"MAX_FILE_SIZE\" value=\"5000000\" />\n   <input name=\"form_erafile\" type=\"file\" />\n </td>\n</tr>\n\n<tr>\n  <td height=\"1\" colspan=\"10\">\n  </td>\n</tr>\n\n</table>\n\n<?php\nif ($_POST['form_search'] || $_POST['form_print']) {\n    $form_name      = trim($_POST['form_name']);\n    $form_pid       = trim($_POST['form_pid']);\n    $form_encounter = trim($_POST['form_encounter']);\n    $form_date      = fixDate($_POST['form_date'], \"\");\n    $form_to_date   = fixDate($_POST['form_to_date'], \"\");\n\n    $where = \"\";\n\n  // Handle X12 835 file upload.\n  //\n    if ($_FILES['form_erafile']['size']) {\n        $tmp_name = $_FILES['form_erafile']['tmp_name'];\n\n        // Handle .zip extension if present.  Probably won't work on Windows.\n        if (strtolower(substr($_FILES['form_erafile']['name'], -4)) == '.zip') {\n            rename($tmp_name, \"$tmp_name.zip\");\n            exec(\"unzip -p $tmp_name.zip > $tmp_name\");\n            unlink(\"$tmp_name.zip\");\n        }\n\n        echo \"<!-- Notes from ERA upload processing:\\n\";\n        $alertmsg .= parse_era($tmp_name, 'era_callback');\n        echo \"-->\\n\";\n        $erafullname = $GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.edi\";\n\n        if (is_file($erafullname)) {\n            $alertmsg .= \"Warning: Set $eraname was already uploaded \";\n            if (is_file($GLOBALS['OE_SITE_DIR'] . \"/era/$eraname.html\")) {\n                $alertmsg .= \"and processed. \";\n            } else {\n                $alertmsg .= \"but not yet processed. \";\n            }\n        }\n\n        rename($tmp_name, $erafullname);\n    } // End 835 upload\n\n    if ($eracount) {\n        // Note that parse_era() modified $eracount and $where.\n        if (! $where) {\n            $where = '1 = 2';\n        }\n    } else {\n        if ($form_name) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            // Allow the last name to be followed by a comma and some part of a first name.\n            if (preg_match('/^(.*\\S)\\s*,\\s*(.*)/', $form_name, $matches)) {\n                $where .= \"p.lname LIKE '\" . $matches[1] . \"%' AND p.fname LIKE '\" . $matches[2] . \"%'\";\n                // Allow a filter like \"A-C\" on the first character of the last name.\n            } else if (preg_match('/^(\\S)\\s*-\\s*(\\S)$/', $form_name, $matches)) {\n                $tmp = '1 = 2';\n                while (ord($matches[1]) <= ord($matches[2])) {\n                    $tmp .= \" OR p.lname LIKE '\" . $matches[1] . \"%'\";\n                    $matches[1] = chr(ord($matches[1]) + 1);\n                }\n\n                $where .= \"( $tmp ) \";\n            } else {\n                $where .= \"p.lname LIKE '%$form_name%'\";\n            }\n        }\n\n        if ($form_pid) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            $where .= \"f.pid = '$form_pid'\";\n        }\n\n        if ($form_encounter) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            $where .= \"f.encounter = '$form_encounter'\";\n        }\n\n        if ($form_date) {\n            if ($where) {\n                $where .= \" AND \";\n            }\n\n            if ($form_to_date) {\n                $where .= \"f.date >= '$form_date' AND f.date <= '$form_to_date'\";\n            } else {\n                $where .= \"f.date = '$form_date'\";\n            }\n        }\n\n        if (! $where) {\n            if ($_POST['form_category'] == 'All') {\n                die(xl(\"At least one search parameter is required if you select All.\"));\n            } else {\n                $where = \"1 = 1\";\n            }\n        }\n    }\n\n    // Notes that as of release 4.1.1 the copays are stored\n    // in the ar_activity table marked with a PCP in the account_code column.\n    $query = \"SELECT f.id, f.pid, f.encounter, f.date, \" .\n    \"f.last_level_billed, f.last_level_closed, f.last_stmt_date, f.stmt_count, \" .\n    \"p.fname, p.mname, p.lname, p.pubpid, p.billing_note, \" .\n    \"( SELECT SUM(b.fee) FROM billing AS b WHERE \" .\n    \"b.pid = f.pid AND b.encounter = f.encounter AND \" .\n    \"b.activity = 1 AND b.code_type != 'COPAY' ) AS charges, \" .\n    \"( SELECT SUM(a.pay_amount) FROM ar_activity AS a WHERE \" .\n    \"a.pid = f.pid AND a.encounter = f.encounter AND a.payer_type = 0 AND a.account_code = 'PCP')*-1 AS copays, \" .\n    \"( SELECT SUM(a.pay_amount) FROM ar_activity AS a WHERE \" .\n    \"a.pid = f.pid AND a.encounter = f.encounter AND a.account_code != 'PCP') AS payments, \" .\n    \"( SELECT SUM(a.adj_amount) FROM ar_activity AS a WHERE \" .\n    \"a.pid = f.pid AND a.encounter = f.encounter ) AS adjustments \" .\n    \"FROM form_encounter AS f \" .\n    \"JOIN patient_data AS p ON p.pid = f.pid \" .\n    \"WHERE $where \" .\n    \"ORDER BY p.lname, p.fname, p.mname, f.pid, f.encounter\";\n\n    // Note that unlike the SQL-Ledger case, this query does not weed\n    // out encounters that are paid up.  Also the use of sub-selects\n    // will require MySQL 4.1 or greater.\n\n    // echo \"<!-- $query -->\\n\"; // debugging\n\n    $t_res = sqlStatement($query);\n\n    $num_invoices = sqlNumRows($t_res);\n    if ($eracount && $num_invoices != $eracount) {\n          $alertmsg .= \"Of $eracount remittances, there are $num_invoices \" .\n          \"matching encounters in OpenEMR. \";\n    }\n?>\n\n<table border='0' cellpadding='1' cellspacing='2' width='98%'>\n\n <tr bgcolor=\"#dddddd\">\n  <td class=\"id\">\n        <?php xl('id', 'e');?>\n  </td>\n  <td class=\"dehead\">\n   &nbsp;<?php xl('Patient', 'e'); ?>\n </td>\n <td class=\"dehead\">\n   &nbsp;<?php xl('Invoice', 'e'); ?>\n </td>\n <td class=\"dehead\">\n   &nbsp;<?php xl('Svc Date', 'e'); ?>\n </td>\n <td class=\"dehead\">\n   &nbsp;<?php xl('Last Stmt', 'e'); ?>\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Charge', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Adjust', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Paid', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"right\">\n    <?php xl('Balance', 'e'); ?>&nbsp;\n </td>\n <td class=\"dehead\" align=\"center\">\n    <?php xl('Prv', 'e'); ?>\n </td>\n    <?php if (!$eracount) { ?>\n <td class=\"dehead\" align=\"left\">\n    <?php xl('Sel', 'e'); ?>\n </td>\n  <td class=\"dehead\" align=\"center\">\n    <?php xl('Email', 'e'); ?>\n  </td>\n\n    <?php } ?>\n</tr>\n\n<?php\n$orow = -1;\n\nwhile ($row = sqlFetchArray($t_res)) {\n    $balance = sprintf(\"%.2f\", $row['charges'] + $row['copays'] - $row['payments'] - $row['adjustments']);\n  //new filter only patients with debt.\n    if ($_POST['only_with_debt'] && $balance <= 0) {\n        continue;\n    }\n\n\n    if ($_POST['form_category'] != 'All' && $eracount == 0 && $balance == 0) {\n        continue;\n    }\n\n      // $duncount was originally supposed to be the number of times that\n      // the patient was sent a statement for this invoice.\n      //\n    $duncount = $row['stmt_count'];\n\n      // But if we have not yet billed the patient, then compute $duncount as a\n      // negative count of the number of insurance plans for which we have not\n      // yet closed out insurance.\n      //\n    if (! $duncount) {\n        for ($i = 1; $i <= 3 && arGetPayerID($row['pid'], $row['date'], $i);\n        ++$i) {\n        }\n\n        $duncount = $row['last_level_closed'] + 1 - $i;\n    }\n\n    $isdueany = ($balance > 0);\n\n      // An invoice is now due from the patient if money is owed and we are\n      // not waiting for insurance to pay.\n      //\n    $isduept = ($duncount >= 0 && $isdueany) ? \" checked\" : \"\";\n\n      // Skip invoices not in the desired \"Due...\" category.\n      //\n    if (substr($_POST['form_category'], 0, 3) == 'Due' && !$isdueany) {\n        continue;\n    }\n\n    if ($_POST['form_category'] == 'Due Ins' && ($duncount >= 0 || !$isdueany)) {\n        continue;\n    }\n\n    if ($_POST['form_category'] == 'Due Pt'  && ($duncount <  0 || !$isdueany)) {\n        continue;\n    }\n\n    $bgcolor = ((++$orow & 1) ? \"#ffdddd\" : \"#ddddff\");\n\n    $svcdate = substr($row['date'], 0, 10);\n    $last_stmt_date = empty($row['last_stmt_date']) ? '' : $row['last_stmt_date'];\n\n      // Determine if customer is in collections.\n      //\n    $billnote = $row['billing_note'];\n    $in_collections = stristr($billnote, 'IN COLLECTIONS') !== false;\n    ?>\n  <tr bgcolor='<?php echo $bgcolor ?>'>\n      <td class=\"detail\">\n        <a href=\"\" onclick=\"return npopup(<?php echo $row['pid'] ?>)\"><?php echo $row['pid'];?></a>\n      </td>\n    <td class=\"detail\">\n     &nbsp;<a href=\"\" onclick=\"return npopup(<?php echo $row['pid'] ?>)\"\n     ><?php echo $row['lname'] . ', ' . $row['fname']; ?></a>\n   </td>\n   <td class=\"detail\">\n     &nbsp;<a href=\"sl_eob_invoice.php?id=<?php echo $row['id'] ?>\"\n     target=\"_blank\"><?php echo $row['pid'] . '.' . $row['encounter']; ?></a>\n   </td>\n   <td class=\"detail\">\n     &nbsp;<?php echo text(oeFormatShortDate($svcdate)); ?>\n   </td>\n   <td class=\"detail\">\n     &nbsp;<?php echo text(oeFormatShortDate($last_stmt_date)); ?>\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($row['charges']) ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($row['adjustments']) ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($row['payments'] - $row['copays']); ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"right\">\n        <?php bucks($balance); ?>&nbsp;\n   </td>\n   <td class=\"detail\" align=\"center\">\n        <?php echo $duncount ? $duncount : \"&nbsp;\" ?>\n   </td>\n    <?php if (!$eracount) { ?>\n   <td class=\"detail\" align=\"left\">\n     <input type='checkbox' name='form_cb[<?php echo($row['id']) ?>]'<?php echo $isduept ?> />\n        <?php if ($in_collections) {\n            echo \"<b><font color='red'>IC</font></b>\";\n} ?>\n        <?php if (function_exists('is_auth_portal') ? is_auth_portal($row['pid']) : false) {\n            echo(' PPt');\n            echo(\"<input type='hidden' name='form_invpids[\". $row['id'] .\"][\". $row['pid'] .\"]' />\");\n            $is_portal = true;\n}?>\n   </td>\n    <?php } ?>\n  <td class=\"detail\" align=\"left\">\n    <?php\n    $patientData = sqlQuery(\"SELECT * FROM `patient_data` WHERE `pid`=?\", array($row['pid']));\n    if ($patientData['hipaa_allowemail'] == \"YES\" && $patientData['allow_patient_portal'] == \"YES\" && $patientData['hipaa_notice'] == \"YES\" && validEmail($patientData['email'])) {\n        echo xlt(\"YES\");\n    } else {\n        echo xlt(\"NO\");\n    }\n    ?>\n  </td>\n\n </tr>\n    <?php\n} // end while\n} // end search/print logic\n\n?>\n\n</table>\n\n<p>\n    <?php if ($eracount) { ?>\n  <input type='button' value='<?php xl('Process ERA File', 'e')?>' onclick='processERA()' /> &nbsp;\n    <?php } else { ?>\n  <input type='button' value='<?php xl('Select All', 'e')?>' onclick='checkAll(true)' /> &nbsp;\n  <input type='button' value='<?php xl('Clear All', 'e')?>' onclick='checkAll(false)' /> &nbsp;\n    <?php if ($GLOBALS['statement_appearance'] != '1') { ?>\n    <input type='submit' name='form_print' value='<?php xl('Print Selected Statements', 'e'); ?>' /> &nbsp;\n    <input type='submit' name='form_download' value='<?php xl('Download Selected Statements', 'e'); ?>' /> &nbsp;\n    <?php } ?>\n  <input type='submit' name='form_pdf' value='<?php xl('PDF Download Selected Statements', 'e'); ?>' /> &nbsp;\n  <input type='submit' name='form_email' value='<?php xl('Email Selected Statements', 'e'); ?>' /> &nbsp;\n<?php if ($is_portal) {?>\n  <input type='submit' name='form_portalnotify' value='<?php xl('Notify via Patient Portal', 'e'); ?>' /> &nbsp;\n<?php }\n}?>\n  <input type='checkbox' name='form_without' value='1' /> <?php xl('Without Update', 'e'); ?>\n</p>\n\n</form>\n</center>\n<script language=\"JavaScript\">\nfunction processERA() {\n  var f = document.forms[0];\n  var debug = f.form_without.checked ? '1' : '0';\n  var paydate = f.form_paydate.value;\n  window.open('sl_eob_process.php?eraname=<?php echo $eraname ?>&debug=' + debug + '&paydate=' + paydate + '&original=original', '_blank');\n  return false;\n}\n<?php\nif ($alertmsg) {\n    echo \"alert('\" . htmlentities($alertmsg) . \"');\\n\";\n}\n\n?>\n</script>\n</body>\n</html>\n", "<?php\n/**\n * find_code_popup.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Visolve <vicareplus_engg@visolve.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) ViCarePlus, Visolve <vicareplus_engg@visolve.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"../../custom/code_types.inc.php\");\n\n$info_msg = \"\";\n$codetype = $_REQUEST['codetype'];\n$form_code_type = $_POST['form_code_type'];\n?>\n<html>\n<head>\n<?php html_header_show(); ?>\n<title><?php xl('Code Finder', 'e'); ?></title>\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n\n<style>\ntd { font-size:10pt; }\n</style>\n\n<script language=\"JavaScript\">\n//pass value selected to the parent window\n function window_submit(chk)\n {\n  var str;\n  var len=chk.length;\n  if (len==undefined && chk.checked==1)\n  {\n    if(!str)\n      str = chk.value;\n    else\n    str = \"#\"+chk.value;\n  }\n  else\n  {\n  for (pr = 0; pr < chk.length; pr++)\n   {\n    if(chk[pr].checked == 1)\n    {\n     if(!str)\n      str = chk[pr].value;\n     else\n      str = str+\"#\"+chk[pr].value;\n    }\n   }\n  }\n  if(!str)\n    alert('<?php echo xl(\"Select Diagnosis\");?>');\n  if (opener.closed || ! opener.set_related)\n   alert(\"<?php echo xl('The destination form was closed');?>\");\n  else\n   opener.set_related(str,\"diagnosis\");\n\n  window.close();\n\n }\n\nfunction window_close(chk)\n{\n window.close();\n}\n\nfunction chkbox_select_none(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=false;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=false;\n  }\n }\n}\n\nfunction chkbox_select_all(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=true;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=true;\n  }\n }\n}\n\nfunction check_search_str()\n{\n var search_str = document.getElementById('search_term').value;\n if(search_str.length < 3)\n {\n  alert('<?php echo xl(\"Search string should have at least three characters\");?>');\n  return false;\n }\n top.restoreSession();\n return true;\n}\n\n</script>\n</head>\n<body class=\"body_top\">\n<form method='post' name='theform'  action='find_code_popup.php' onsubmit=\"return check_search_str();\">\n<center>\n <input type=\"hidden\" name=\"search_status\" id=\"search_status\" value=1;>\n<table border='0' cellpadding='5' cellspacing='0'>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n <tr>\n  <td>\n   <b>\n<?php\nif ($codetype) {\n    echo \"<input type='text' name='form_code_type' value='\" . attr($codetype) . \"' size='5' readonly>\\n\";\n} else {\n    echo \"   <select name='form_code_type'\";\n    echo \">\\n\";\n    foreach ($code_types as $key => $value) {\n        echo \"    <option value='$key'\";\n        if ($codetype == $key || $form_code_type == $key) {\n            echo \" selected\";\n        }\n\n        echo \">$key</option>\\n\";\n    }\n\n    echo \"    <option value='PROD'\";\n    if ($codetype == 'PROD' || $form_code_type == 'PROD') {\n        echo \" selected\";\n    }\n\n    echo \">Product</option>\\n\";\n    echo \"   </select>&nbsp;&nbsp;\\n\";\n}\n?>\n    <?php xl('Search for', 'e'); ?>\n   <input type='text' name='search_term' id='search_term' size='12' value='<?php echo attr($_REQUEST['search_term']); ?>'\n    title='<?php xl('Any part of the desired code or its description', 'e'); ?>' />\n   &nbsp;\n   <input type='submit' name='bn_search' id='bn_search' value='<?php xl('Search', 'e'); ?>' />\n   </b>\n  </td>\n </tr>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n</table>\n</center>\n</form>\n<form method='post' name='select_diagonsis'>\n<table border='0'>\n <tr>\n <td colspan=\"4\">\n<?php if ($_REQUEST['bn_search']) {\n    $search_term = $_REQUEST['search_term'];\n    if ($form_code_type == 'PROD') {\n        $query = \"SELECT dt.drug_id, dt.selector, d.name \" .\n        \"FROM drug_templates AS dt, drugs AS d WHERE \" .\n        \"( d.name LIKE '%$search_term%' OR \" .\n        \"dt.selector LIKE '%$search_term%' ) \" .\n        \"AND d.drug_id = dt.drug_id \" .\n        \"ORDER BY d.name, dt.selector, dt.drug_id\";\n        $res = sqlStatement($query);\n        $row_count = 0;\n        while ($row = sqlFetchArray($res)) {\n            $row_count = $row_count + 1;\n            $drug_id = addslashes($row['drug_id']);\n            $selector = addslashes($row['selector']);\n            $desc = addslashes($row['name']);\n            ?>\n             <input type=\"checkbox\" name=\"diagnosis[row_count]\" value= \"<?php echo $desc; ?>\" > <?php echo $drug_id.\"    \".$selector.\"     \".$desc.\"</br>\";\n        }\n    } else {\n        $query = \"SELECT count(*) as count FROM codes \" .\n        \"WHERE (code_text LIKE '%$search_term%' OR \" .\n        \"code LIKE '%$search_term%') \" ;\n        $res = sqlStatement($query);\n        if ($row = sqlFetchArray($res)) {\n            $no_of_items = addslashes($row['count']);\n            if ($no_of_items < 1) {\n                ?>\n             <script language='JavaScript'>\n            alert(\"<?php echo xl('Search string does not match with list in database');\n            echo '\\n';\n            echo xl('Please enter new search string');?>\");\n          document.theform.search_term.value=\" \";\n             document.theform.search_term.focus();\n             </script>\n                <?php\n            }\n\n            $query = \"SELECT code_type, code, modifier, code_text FROM codes \" .\n            \"WHERE (code_text LIKE '%$search_term%' OR \" .\n            \"code LIKE '%$search_term%') \" .\n            \"ORDER BY code\";\n          // echo \"\\n<!-- $query -->\\n\"; // debugging\n            $res = sqlStatement($query);\n            $row_count = 0;\n            while ($row = sqlFetchArray($res)) {\n                $row_count = $row_count + 1;\n                $itercode = addslashes($row['code']);\n                $itertext = addslashes(ucfirst(strtolower(trim($row['code_text']))));\n                ?>\n                 <input type=\"checkbox\" id=\"chkbox\" value= \"<?php echo $form_code_type.\":\".$itercode.\"-\".$itertext; ?>\" > <?php echo $itercode.\"    \".$itertext.\"</br>\";\n            }\n        }\n    }\n    ?>\n  </td>\n </tr>\n </table>\n<center>\n</br>\n <input type='button' id='select_all' value='<?php xl('Select All', 'e'); ?>' onclick=\"chkbox_select_all(document.select_diagonsis.chkbox);\"/>\n\n <input type='button' id='unselect_all' value='<?php xl('Unselect All', 'e'); ?>' onclick=\"chkbox_select_none(document.select_diagonsis.chkbox);\"/>\n\n <input type='button' id='submit' value='<?php xl('Submit', 'e'); ?>' onclick=\"window_submit(document.select_diagonsis.chkbox);\"/>\n\n <input type='button' id='cancel' value='<?php xl('Cancel', 'e'); ?>' onclick=\"window_close();\"/>\n\n</center>\n<?php } ?>\n</form>\n</body>\n</html>\n", "<?php\n/**\n * find_immunization_popup.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Visolve <vicareplus_engg@visolve.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) ViCarePlus, Visolve <vicareplus_engg@visolve.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"../../custom/code_types.inc.php\");\n\n$info_msg = \"\";\n$codetype = $_REQUEST['codetype'];\n$form_code_type = $_POST['form_code_type'];\n?>\n<html>\n<head>\n<?php html_header_show(); ?>\n<title><?php xl('Immunization', 'e'); ?></title>\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n<style>\ntd { font-size:10pt; }\n</style>\n<script language=\"JavaScript\">\n//pass value selected to the parent window\n function window_submit(chk)\n {\n  var str;\n  var len=chk.length;\n  if (len==undefined && chk.checked==1)\n  {\n    if(!str)\n      str = chk.value;\n    else\n    str = \"#\"+chk.value;\n  }\n  else\n  {\n  for (pr = 0; pr < chk.length; pr++)\n   {\n    if(chk[pr].checked == 1)\n    {\n     if(!str)\n      str = chk[pr].value;\n     else\n      str = str+\"#\"+chk[pr].value;\n    }\n   }\n  }\n  if(!str)\n    alert('<?php echo xl(\"Select Immunizations\");?>');\n  if (opener.closed || ! opener.set_related)\n   alert(\"<?php echo xl('The destination form was closed');?>\");\n  else\n   opener.set_related(str,\"immunizations\");\n\n  window.close();\n\n }\n\nfunction window_close(chk)\n{\n window.close();\n}\n\nfunction chkbox_select_none(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=false;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=false;\n  }\n }\n}\n\nfunction chkbox_select_all(chk)\n{\n var len=chk.length;\n if (len==undefined) {chk.checked=true;}\n else\n {\n  for (pr = 0; pr < chk.length; pr++)\n  {\n   chk[pr].checked=true;\n  }\n }\n}\n\nfunction check_search_str()\n{\n var search_str = document.getElementById('search_term').value;\n if(search_str.length < 3)\n {\n  alert('<?php echo xl(\"Search string should have at least three characters\");?>');\n  return false;\n }\n top.restoreSession();\n return true;\n}\n</script>\n</head>\n<body class=\"body_top\">\n<form method='post' name='theform'  action='find_immunization_popup.php' onsubmit=\"return check_search_str();\">\n<center>\n<table border='0' cellpadding='5' cellspacing='0'>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n <tr>\n  <td>\n   <b>\n    <?php xl('Search for', 'e'); ?>\n   <input type='text' name='search_term' id='search_term' size='12' value='<?php echo attr($_REQUEST['search_term']); ?>'\n    title='<?php xl('Any part of the immunization id or immunization name', 'e'); ?>' />\n   &nbsp;\n   <input type='submit' name='bn_search' value='<?php xl('Search', 'e'); ?>' />\n   </b>\n  </td>\n </tr>\n <tr>\n  <td height=\"1\">\n  </td>\n </tr>\n</table>\n</center>\n</form>\n<form method='post' name='select_immunization'>\n<?php if ($_REQUEST['bn_search']) { ?>\n<table border='0'>\n <tr>\n  <td colspan=\"4\">\n<?php\n  $search_term = $_REQUEST['search_term'];\n  {\n    $query = \"SELECT count(*) as count FROM list_options \" .\n      \"WHERE (list_id = 'immunizations' and title LIKE '%$search_term%' AND activity = 1) \" ;\n    $res = sqlStatement($query);\nif ($row = sqlFetchArray($res)) {\n    $no_of_items = addslashes($row['count']);\n    if ($no_of_items < 1) {\n        ?>\n     <script language='JavaScript'>\n        alert(\"<?php echo xl('Search string does not match with list in database');\n        echo '\\n';\n        echo xl('Please enter new search string');?>\");\n     document.theform.search_term.value=\" \";\n     document.theform.search_term.focus();\n     </script>\n        <?php\n    }\n\n    $query = \"SELECT option_id,title FROM list_options \" .\n    \"WHERE (list_id = 'immunizations' and title LIKE '%$search_term%' AND activity = 1) \" .\n    \"ORDER BY title\";\n    $res = sqlStatement($query);\n    $row_count = 0;\n    while ($row = sqlFetchArray($res)) {\n        $row_count = $row_count + 1;\n        $itercode = addslashes($row['option_id']);\n        $itertext = addslashes(ucfirst(strtolower(trim($row['title']))));\n        ?>\n       <input type=\"checkbox\" id=\"chkbox\" value= \"<?php echo $itercode.\"-\".$itertext; ?>\" > <?php echo $itercode.\"    \".$itertext.\"</br>\";\n    }\n}\n\n  }\n?>\n</td>\n</tr>\n </table>\n<center>\n <input type='button' name='select_all' value='<?php xl('Select All', 'e'); ?>' onclick=\"chkbox_select_all(document.select_immunization.chkbox);\"/>\n\n <input type='button' name='select_none' value='<?php xl('Unselect All', 'e'); ?>' onclick=\"chkbox_select_none(document.select_immunization.chkbox);\"/>\n\n <input type='button' name='submit' value='<?php xl('Submit', 'e'); ?>' onclick=\"window_submit(document.select_immunization.chkbox);\"/>\n\n <input type='button' name='cancel' value='<?php xl('Cancel', 'e'); ?>' onclick=\"window_close();\"/>\n\n </center>\n<?php } ?>\n</form>\n</body>\n</html>\n", "<?php\n/**\n * fax dispatch\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2006-2010 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2017-2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/pnotes.inc\");\nrequire_once(\"$srcdir/forms.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/gprelations.inc.php\");\n\nif ($_GET['file']) {\n    $mode = 'fax';\n    $filename = $_GET['file'];\n\n    // ensure the file variable has no illegal characters\n    check_file_dir_name($filename);\n\n    $filepath = $GLOBALS['hylafax_basedir'] . '/recvq/' . $filename;\n} else if ($_GET['scan']) {\n    $mode = 'scan';\n    $filename = $_GET['scan'];\n\n    // ensure the file variable has no illegal characters\n    check_file_dir_name($filename);\n\n    $filepath = $GLOBALS['scanner_output_directory'] . '/' . $filename;\n} else {\n    die(\"No filename was given.\");\n}\n\n$ext = substr($filename, strrpos($filename, '.'));\n$filebase = basename(\"/$filename\", $ext);\n$faxcache = $GLOBALS['OE_SITE_DIR'] . \"/faxcache/$mode/$filebase\";\n\n$info_msg = \"\";\n\n// This function builds an array of document categories recursively.\n// Kittens are the children of cats, you know.  :-)getKittens\n//\nfunction getKittens($catid, $catstring, &$categories)\n{\n    $cres = sqlStatement(\"SELECT id, name FROM categories \" .\n    \"WHERE parent = $catid ORDER BY name\");\n    $childcount = 0;\n    while ($crow = sqlFetchArray($cres)) {\n        ++$childcount;\n        getKittens($crow['id'], ($catstring ? \"$catstring / \" : \"\") .\n        ($catid ? $crow['name'] : ''), $categories);\n    }\n\n  // If no kitties, then this is a leaf node and should be listed.\n    if (!$childcount) {\n        $categories[$catid] = $catstring;\n    }\n}\n\n// This merges the tiff files for the selected pages into one tiff file.\n//\nfunction mergeTiffs()\n{\n    global $faxcache;\n    $msg = '';\n    $inames = '';\n    $tmp1 = array();\n    $tmp2 = 0;\n  // form_images are the checkboxes to the right of the images.\n    foreach ($_POST['form_images'] as $inbase) {\n        $inames .= ' ' . escapeshellarg(\"$inbase.tif\");\n    }\n\n    if (!$inames) {\n        die(xl(\"Internal error - no pages were selected!\"));\n    }\n\n    $tmp0 = exec(\"cd '$faxcache'; tiffcp $inames temp.tif\", $tmp1, $tmp2);\n    if ($tmp2) {\n        $msg .= \"tiffcp returned $tmp2: $tmp0 \";\n    }\n\n    return $msg;\n}\n\n// If we are submitting...\n//\nif ($_POST['form_save']) {\n    $action_taken = false;\n    $tmp1 = array();\n    $tmp2 = 0;\n\n    if ($_POST['form_cb_copy']) {\n        $patient_id = (int) $_POST['form_pid'];\n        if (!$patient_id) {\n            die(xl('Internal error - patient ID was not provided!'));\n        }\n\n        // Compute the name of the target directory and make sure it exists.\n        $docdir = $GLOBALS['OE_SITE_DIR'] . \"/documents/$patient_id\";\n        exec(\"mkdir -p '$docdir'\");\n\n        // If copying to patient documents...\n        //\n        if ($_POST['form_cb_copy_type'] == 1) {\n            // Compute a target filename that does not yet exist.\n            $ffname = check_file_dir_name(trim($_POST['form_filename']));\n            $i = strrpos($ffname, '.');\n            if ($i) {\n                $ffname = trim(substr($ffname, 0, $i));\n            }\n\n            if (!$ffname) {\n                $ffname = $filebase;\n            }\n\n            $ffmod  = '';\n            $ffsuff = '.pdf';\n            // If the target filename exists, modify it until it doesn't.\n            $count = 0;\n            while (is_file(\"$docdir/$ffname$ffmod$ffsuff\")) {\n                ++$count;\n                $ffmod = \"_$count\";\n            }\n\n            $target = \"$docdir/$ffname$ffmod$ffsuff\";\n            $docdate = fixDate($_POST['form_docdate']);\n\n            // Create the target PDF.  Note that we are relying on the .tif files for\n            // the individual pages to already exist in the faxcache directory.\n            //\n            $info_msg .= mergeTiffs();\n            // The -j option here requires that libtiff is configured with libjpeg.\n            // It could be omitted, but the output PDFs would then be quite large.\n            $tmp0 = exec(\"tiff2pdf -j -p letter -o '$target' '$faxcache/temp.tif'\", $tmp1, $tmp2);\n\n            if ($tmp2) {\n                $info_msg .= \"tiff2pdf returned $tmp2: $tmp0 \";\n            } else {\n                $newid = generate_id();\n                $fsize = filesize($target);\n                $catid = (int) $_POST['form_category'];\n                // Update the database.\n                $query = \"INSERT INTO documents ( \" .\n                \"id, type, size, date, url, mimetype, foreign_id, docdate\" .\n                \" ) VALUES ( \" .\n                \"'$newid', 'file_url', '$fsize', NOW(), 'file://$target', \" .\n                \"'application/pdf', $patient_id, '$docdate' \" .\n                \")\";\n                sqlStatement($query);\n                $query = \"INSERT INTO categories_to_documents ( \" .\n                \"category_id, document_id\" .\n                \" ) VALUES ( \" .\n                \"'$catid', '$newid' \" .\n                \")\";\n                sqlStatement($query);\n            } // end not error\n\n            // If we are posting a note...\n            if ($_POST['form_cb_note'] && !$info_msg) {\n                // Build note text in a way that identifies the new document.\n                // See pnotes_full.php which uses this to auto-display the document.\n                $note = \"$ffname$ffmod$ffsuff\";\n                for ($tmp = $catid; $tmp;) {\n                    $catrow = sqlQuery(\"SELECT name, parent FROM categories WHERE id = '$tmp'\");\n                    $note = $catrow['name'] . \"/$note\";\n                    $tmp = $catrow['parent'];\n                }\n\n                $note = \"New scanned document $newid: $note\";\n                $form_note_message = trim($_POST['form_note_message']);\n                $form_note_message = strip_escape_custom($form_note_message);\n                if ($form_note_message) {\n                    $note .= \"\\n\" . $form_note_message;\n                }\n\n                // addPnote() will do its own addslashes().\n                $noteid = addPnote(\n                    $_POST['form_pid'],\n                    $note,\n                    $userauthorized,\n                    '1',\n                    $_POST['form_note_type'],\n                    $_POST['form_note_to']\n                );\n                // Link the new patient note to the document.\n                setGpRelation(1, $newid, 6, $noteid);\n            } // end post patient note\n        } // end copy to documents\n\n        // Otherwise creating a scanned encounter note...\n        //\n        else {\n            // Get desired $encounter_id.\n            $encounter_id = 0;\n            if (empty($_POST['form_copy_sn_visit'])) {\n                $info_msg .= \"This patient has no visits! \";\n            } else {\n                $encounter_id = 0 + $_POST['form_copy_sn_visit'];\n            }\n\n            if (!$info_msg) {\n                // Merge the selected pages.\n                $info_msg .= mergeTiffs();\n                $tmp_name = \"$faxcache/temp.tif\";\n            }\n\n            if (!$info_msg) {\n                // The following is cloned from contrib/forms/scanned_notes/new.php:\n                //\n                $query = \"INSERT INTO form_scanned_notes ( \" .\n                \"notes \" .\n                \") VALUES ( \" .\n                \"'\" . $_POST['form_copy_sn_comments'] . \"' \" .\n                \")\";\n                $formid = sqlInsert($query);\n                addForm(\n                    $encounter_id,\n                    \"Scanned Notes\",\n                    $formid,\n                    \"scanned_notes\",\n                    $patient_id,\n                    $userauthorized\n                );\n                //\n                $imagedir = $GLOBALS['OE_SITE_DIR'] . \"/documents/$patient_id/encounters\";\n                $imagepath = \"$imagedir/${encounter_id}_$formid.jpg\";\n                if (! is_dir($imagedir)) {\n                        $tmp0 = exec('mkdir -p \"' . $imagedir . '\"', $tmp1, $tmp2);\n                    if ($tmp2) {\n                        die(\"mkdir returned $tmp2: $tmp0\");\n                    }\n\n                        exec(\"touch '$imagedir/index.html'\");\n                }\n\n                if (is_file($imagepath)) {\n                    unlink($imagepath);\n                }\n\n                // TBD: There may be a faster way to create this file, given that\n                // we already have a jpeg for each page in faxcache.\n                $cmd = \"convert -resize 800 -density 96 '$tmp_name' -append '$imagepath'\";\n                $tmp0 = exec($cmd, $tmp1, $tmp2);\n                if ($tmp2) {\n                    die(\"\\\"$cmd\\\" returned $tmp2: $tmp0\");\n                }\n            }\n\n            // If we are posting a patient note...\n            if ($_POST['form_cb_note'] && !$info_msg) {\n                $note = \"New scanned encounter note for visit on \" . substr($erow['date'], 0, 10);\n                $form_note_message = trim($_POST['form_note_message']);\n                $form_note_message = strip_escape_custom($form_note_message);\n                if ($form_note_message) {\n                    $note .= \"\\n\" . $form_note_message;\n                }\n\n                // addPnote() will do its own addslashes().\n                addPnote(\n                    $patient_id,\n                    $note,\n                    $userauthorized,\n                    '1',\n                    $_POST['form_note_type'],\n                    $_POST['form_note_to']\n                );\n            } // end post patient note\n        }\n\n        $action_taken = true;\n    } // end copy to chart\n\n    if ($_POST['form_cb_forward']) {\n        $form_from     = trim($_POST['form_from']);\n        $form_to       = trim($_POST['form_to']);\n        $form_fax      = trim($_POST['form_fax']);\n        $form_message  = trim($_POST['form_message']);\n        $form_finemode = $_POST['form_finemode'] ? '-m' : '-l';\n\n        $form_from    = strip_escape_custom($form_from);\n        $form_to      = strip_escape_custom($form_to);\n        $form_message = strip_escape_custom($form_message);\n\n        // Generate a cover page using enscript.  This can be a cool thing\n        // to do, as enscript is very powerful.\n        //\n        $tmp1 = array();\n        $tmp2 = 0;\n        $tmpfn1 = tempnam(\"/tmp\", \"fax1\");\n        $tmpfn2 = tempnam(\"/tmp\", \"fax2\");\n        $tmph = fopen($tmpfn1, \"w\");\n        $cpstring = '';\n        $fh = fopen($GLOBALS['OE_SITE_DIR'] . \"/faxcover.txt\", 'r');\n        while (!feof($fh)) {\n            $cpstring .= fread($fh, 8192);\n        }\n\n        fclose($fh);\n        $cpstring = str_replace('{CURRENT_DATE}', date('F j, Y'), $cpstring);\n        $cpstring = str_replace('{SENDER_NAME}', $form_from, $cpstring);\n        $cpstring = str_replace('{RECIPIENT_NAME}', $form_to, $cpstring);\n        $cpstring = str_replace('{RECIPIENT_FAX}', $form_fax, $cpstring);\n        $cpstring = str_replace('{MESSAGE}', $form_message, $cpstring);\n        fwrite($tmph, $cpstring);\n        fclose($tmph);\n        $tmp0 = exec(\"cd $webserver_root/custom; \" . $GLOBALS['hylafax_enscript'] .\n        \" -o $tmpfn2 $tmpfn1\", $tmp1, $tmp2);\n        if ($tmp2) {\n              $info_msg .= \"enscript returned $tmp2: $tmp0 \";\n        }\n\n        unlink($tmpfn1);\n\n        // Send the fax as the cover page followed by the selected pages.\n        $info_msg .= mergeTiffs();\n        $tmp0 = exec(\n            \"sendfax -A -n $form_finemode -d \" .\n            escapeshellarg($form_fax) . \" $tmpfn2 '$faxcache/temp.tif'\",\n            $tmp1,\n            $tmp2\n        );\n        if ($tmp2) {\n              $info_msg .= \"sendfax returned $tmp2: $tmp0 \";\n        }\n\n        unlink($tmpfn2);\n\n        $action_taken = true;\n    } // end forward\n\n    $form_cb_delete = $_POST['form_cb_delete'];\n\n  // If deleting selected, do it and then check if any are left.\n    if ($form_cb_delete == '1' && !$info_msg) {\n        foreach ($_POST['form_images'] as $inbase) {\n            unlink(\"$faxcache/$inbase.jpg\");\n            $action_taken = true;\n        }\n\n        // Check if any .jpg files remain... if not we'll clean up.\n        if ($action_taken) {\n            $dh = opendir($faxcache);\n            if (! $dh) {\n                die(\"Cannot read $faxcache\");\n            }\n\n            $form_cb_delete = '2';\n            while (false !== ($jfname = readdir($dh))) {\n                if (preg_match('/\\.jpg$/', $jfname)) {\n                    $form_cb_delete = '1';\n                }\n            }\n\n            closedir($dh);\n        }\n    } // end delete 1\n\n    if ($form_cb_delete == '2' && !$info_msg) {\n        // Delete the tiff file, with archiving if desired.\n        if ($GLOBALS['hylafax_archdir'] && $mode == 'fax') {\n            rename($filepath, $GLOBALS['hylafax_archdir'] . '/' . $filename);\n        } else {\n            unlink($filepath);\n        }\n\n        // Erase its cache.\n        if (is_dir($faxcache)) {\n            $dh = opendir($faxcache);\n            while (($tmp = readdir($dh)) !== false) {\n                if (is_file(\"$faxcache/$tmp\")) {\n                    unlink(\"$faxcache/$tmp\");\n                }\n            }\n\n            closedir($dh);\n            rmdir($faxcache);\n        }\n\n        $action_taken = true;\n    } // end delete 2\n\n    if (!$action_taken && !$info_msg) {\n        $info_msg = xl('You did not choose any actions.');\n    }\n\n    if ($info_msg || $form_cb_delete != '1') {\n        // Close this window and refresh the fax list.\n        echo \"<html>\\n<body>\\n<script language='JavaScript'>\\n\";\n        if ($info_msg) {\n            echo \" alert('$info_msg');\\n\";\n        }\n\n        echo \" if (!opener.closed && opener.refreshme) opener.refreshme();\\n\";\n        echo \" window.close();\\n\";\n        echo \"</script>\\n</body>\\n</html>\\n\";\n        exit();\n    }\n} // end submit logic\n\n// If we get this far then we are displaying the form.\n\n// Find out if the scanned_notes form is installed and active.\n//\n$tmp = sqlQuery(\"SELECT count(*) AS count FROM registry WHERE \" .\n  \"directory LIKE 'scanned_notes' AND state = 1 AND sql_run = 1\");\n$using_scanned_notes = $tmp['count'];\n\n// If the image cache does not yet exist for this fax, build it.\n// This will contain a .tif image as well as a .jpg image for each page.\n//\nif (! is_dir($faxcache)) {\n    $tmp0 = exec('mkdir -p \"' . $faxcache . '\"', $tmp1, $tmp2);\n    if ($tmp2) {\n        die(\"mkdir returned $tmp2: $tmp0\");\n    }\n\n    if (strtolower($ext) != '.tif') {\n        // convert's default density for PDF-to-TIFF conversion is 72 dpi which is\n        // not very good, so we upgrade it to \"fine mode\" fax quality.  It's really\n        // better and faster if the scanner produces TIFFs instead of PDFs.\n        $tmp0 = exec(\"convert -density 203x196 '$filepath' '$faxcache/deleteme.tif'\", $tmp1, $tmp2);\n        if ($tmp2) {\n            die(\"convert returned $tmp2: $tmp0\");\n        }\n\n        $tmp0 = exec(\"cd '$faxcache'; tiffsplit 'deleteme.tif'; rm -f 'deleteme.tif'\", $tmp1, $tmp2);\n        if ($tmp2) {\n            die(\"tiffsplit/rm returned $tmp2: $tmp0\");\n        }\n    } else {\n        $tmp0 = exec(\"cd '$faxcache'; tiffsplit '$filepath'\", $tmp1, $tmp2);\n        if ($tmp2) {\n            die(\"tiffsplit returned $tmp2: $tmp0\");\n        }\n    }\n\n    $tmp0 = exec(\"cd '$faxcache'; mogrify -resize 750x970 -format jpg *.tif\", $tmp1, $tmp2);\n    if ($tmp2) {\n        die(\"mogrify returned $tmp2: $tmp0; ext is '$ext'; filepath is '$filepath'\");\n    }\n}\n\n// Get the categories list.\n$categories = array();\ngetKittens(0, '', $categories);\n\n// Get the users list.\n$ures = sqlStatement(\"SELECT username, fname, lname FROM users \" .\n  \"WHERE active = 1 AND ( info IS NULL OR info NOT LIKE '%Inactive%' ) \" .\n  \"ORDER BY lname, fname\");\n?>\n<html>\n<head>\n<?php if (function_exists(html_header_show)) {\n    html_header_show();\n} ?>\n<title><?php xl('Dispatch Received Document', 'e'); ?></title>\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n<link rel=\"stylesheet\" href=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-datetimepicker-2-5-4/build/jquery.datetimepicker.min.css\">\n\n<style>\n\ntd, input, select, textarea {\n font-size: 10pt;\n}\n\n.itemtitle {\n font-weight: bold;\n}\n\ndiv.section {\n border: solid;\n border-width: 1px;\n border-color: #0000ff;\n margin-left: 2em;\n padding: 1em;\n}\n\n</style>\n\n<script type=\"text/javascript\" src=\"../../library/topdialog.js?v=<?php echo $v_js_includes; ?>\"></script>\n<script type=\"text/javascript\" src=\"../../library/dialog.js?v=<?php echo $v_js_includes; ?>\"></script>\n<script type=\"text/javascript\" src=\"../../library/textformat.js?v=<?php echo $v_js_includes; ?>\"></script>\n<script type=\"text/javascript\" src=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-min-1-7-2/index.js\"></script>\n<script type=\"text/javascript\" src=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-datetimepicker-2-5-4/build/jquery.datetimepicker.full.min.js\"></script>\n\n<script language=\"JavaScript\">\n\n<?php require($GLOBALS['srcdir'] . \"/restoreSession.php\"); ?>\n\n function divclick(cb, divid) {\n  var divstyle = document.getElementById(divid).style;\n  if (cb.checked) {\n   if (divid == 'div_copy_doc') {\n    document.getElementById('div_copy_sn').style.display = 'none';\n   }\n   else if (divid == 'div_copy_sn') {\n    document.getElementById('div_copy_doc').style.display = 'none';\n   }\n   divstyle.display = 'block';\n  } else {\n   divstyle.display = 'none';\n  }\n  return true;\n }\n\n // This is for callback by the find-patient popup.\n function setpatient(pid, lname, fname, dob) {\n  var f = document.forms[0];\n  f.form_patient.value = lname + ', ' + fname;\n  f.form_pid.value = pid;\n<?php if ($using_scanned_notes) { ?>\n  // This loads the patient's list of recent encounters:\n  f.form_copy_sn_visit.options.length = 0;\n  f.form_copy_sn_visit.options[0] = new Option('Loading...', '0');\n  $.getScript(\"fax_dispatch_newpid.php?p=\" + pid);\n<?php } ?>\n }\n\n // This invokes the find-patient popup.\n function sel_patient() {\n  dlgopen('../main/calendar/find_patient_popup.php', '_blank', 500, 400);\n }\n\n // Check for errors when the form is submitted.\n function validate() {\n  var f = document.forms[0];\n\n  if (f.form_cb_copy.checked) {\n   if (! f.form_pid.value) {\n    alert('You have not selected a patient!');\n    return false;\n   }\n  }\n\n  if (f.form_cb_forward.checked) {\n   var s = f.form_fax.value;\n   if (! s) {\n    alert('A fax number is required!');\n    return false;\n   }\n   var digcount = 0;\n   for (var i = 0; i < s.length; ++i) {\n    var c = s.charAt(i);\n    if (c >= '0' && c <= '9') {\n     ++digcount;\n    }\n    else if (digcount == 0 || c != '-') {\n     alert('Invalid character(s) in fax number!');\n     return false;\n    }\n   }\n   if (digcount == 7) {\n    if (s.charAt(0) < '2') {\n     alert('Local phone number starts with an invalid digit!');\n     return false;\n    }\n   }\n   else if (digcount == 11) {\n    if (s.charAt(0) != '1') {\n     alert('11-digit number must begin with 1!');\n     return false;\n    }\n   }\n   else if (digcount == 10) {\n    if (s.charAt(0) < '2') {\n     alert('10-digit number starts with an invalid digit!');\n     return false;\n    }\n    f.form_fax.value = '1' + s;\n   }\n   else {\n    alert('Invalid number of digits in fax telephone number!');\n    return false;\n   }\n  }\n\n  if (f.form_cb_copy.checked || f.form_cb_forward.checked) {\n   var check_count = 0;\n   for (var i = 0; i < f.elements.length; ++i) {\n    if (f.elements[i].name == 'form_images[]' && f.elements[i].checked)\n     ++check_count;\n   }\n   if (check_count == 0) {\n    alert('No pages have been selected!');\n    return false;\n   }\n  }\n\n  top.restoreSession();\n  return true;\n }\n\n function allCheckboxes(issel) {\n  var f = document.forms[0];\n  for (var i = 0; i < f.elements.length; ++i) {\n   if (f.elements[i].name == 'form_images[]') f.elements[i].checked = issel;\n  }\n }\n\n    $(document).ready(function(){\n        $('.datepicker').datetimepicker({\n            <?php $datetimepicker_timepicker = false; ?>\n            <?php $datetimepicker_showseconds = false; ?>\n            <?php $datetimepicker_formatInput = false; ?>\n            <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n            <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n        });\n    });\n</script>\n\n</head>\n\n<body class=\"body_top\" onunload='imclosing()'>\n\n<center><h2><?php xl('Dispatch Received Document', 'e'); ?></h2></center>\n\n<form method='post' name='theform'\n action='fax_dispatch.php?<?php echo ($mode == 'fax') ? 'file' : 'scan'; ?>=<?php echo $filename ?>' onsubmit='return validate()'>\n\n<p><input type='checkbox' name='form_cb_copy' value='1'\n onclick='return divclick(this,\"div_copy\");' />\n<b><?php xl('Copy Pages to Patient Chart', 'e'); ?></b></p>\n\n<div id='div_copy' class='section' style='display:none;'>\n <table>\n  <tr>\n   <td class='itemtitle' width='1%' nowrap><?php xl('Patient', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_patient' style='width:100%'\n     value=' (<?php xl('Click to select'); ?>)' onclick='sel_patient()'\n     title='Click to select patient' readonly />\n    <input type='hidden' name='form_pid' value='0' />\n   </td>\n  </tr>\n  <tr>\n   <td colspan='2' style='padding-top:0.5em;'>\n    <input type='radio' name='form_cb_copy_type' value='1'\n     onclick='return divclick(this,\"div_copy_doc\");' checked />\n    <b><?php xl('Patient Document', 'e'); ?></b>&nbsp;\n<?php if ($using_scanned_notes) { ?>\n    <input type='radio' name='form_cb_copy_type' value='2'\n     onclick='return divclick(this,\"div_copy_sn\");' />\n    <b><?php xl('Scanned Encounter Note', 'e'); ?></b>\n<?php } ?>\n    <div id='div_copy_doc' class='section' style='margin-top:0.5em;'>\n     <table width='100%'>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Category', 'e'); ?></td>\n       <td>\n        <select name='form_category' style='width:100%'>\n<?php\nforeach ($categories as $catkey => $catname) {\n    echo \"         <option value='$catkey'\";\n    echo \">$catname</option>\\n\";\n}\n?>\n        </select>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Filename', 'e'); ?></td>\n       <td>\n        <input type='text' size='10' name='form_filename' style='width:100%'\n        value='<?php  echo \"$filebase.pdf\" ?>'\n        title='Name for this document in the patient chart' />\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Document Date', 'e'); ?></td>\n       <td>\n        <input type='text' class='datepicker' size='10' name='form_docdate' id='form_docdate'\n        value='<?php echo date('Y-m-d'); ?>'\n        title='<?php xl('yyyy-mm-dd date associated with this document', 'e'); ?>' />\n       </td>\n      </tr>\n     </table>\n    </div><!-- end div_copy_doc -->\n    <div id='div_copy_sn' class='section' style='display:none;margin-top:0.5em;'>\n     <table width='100%'>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap><?php xl('Visit Date', 'e'); ?></td>\n       <td>\n        <select name='form_copy_sn_visit' style='width:100%'>\n        </select>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap><?php xl('Comments', 'e'); ?></td>\n       <td>\n        <textarea name='form_copy_sn_comments' rows='3' cols='30' style='width:100%'\n         title='Comments associated with this scanned note'\n         /></textarea>\n       </td>\n      </tr>\n     </table>\n    </div><!-- end div_copy_sn -->\n   </td>\n  </tr>\n  <tr>\n   <td colspan='2' style='padding-top:0.5em;'>\n    <input type='checkbox' name='form_cb_note' value='1'\n     onclick='return divclick(this,\"div_note\");' />\n    <b><?php xl('Create Patient Note', 'e'); ?></b>\n    <div id='div_note' class='section' style='display:none;margin-top:0.5em;'>\n     <table>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap><?php xl('Type', 'e'); ?></td>\n       <td>\n        <?php\n         // Added 6/2009 by BM to incorporate the patient notes into the list_options listings\n         generate_form_field(array('data_type'=>1,'field_id'=>'note_type','list_id'=>'note_type','empty_title'=>'SKIP'), '');\n        ?>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' width='1%' nowrap>To</td>\n       <td>\n        <select name='form_note_to' style='width:100%'>\n<?php\nwhile ($urow = sqlFetchArray($ures)) {\n    echo \"         <option value='\" . $urow['username'] . \"'\";\n    echo \">\" . $urow['lname'];\n    if ($urow['fname']) {\n        echo \", \" . $urow['fname'];\n    }\n\n    echo \"</option>\\n\";\n}\n?>\n         <option value=''>** <?php  xl('Close', 'e'); ?> **</option>\n        </select>\n       </td>\n      </tr>\n      <tr>\n       <td class='itemtitle' nowrap><?php xl('Message', 'e'); ?></td>\n       <td>\n        <textarea name='form_note_message' rows='3' cols='30' style='width:100%'\n         title='Your comments' /></textarea>\n       </td>\n      </tr>\n     </table>\n    </div><!-- end div_note -->\n   </td>\n  </tr>\n </table>\n</div><!-- end div_copy -->\n\n<p><input type='checkbox' name='form_cb_forward' value='1'\n onclick='return divclick(this,\"div_forward\");' />\n<b><?php xl('Forward Pages via Fax', 'e'); ?></b></p>\n\n<div id='div_forward' class='section' style='display:none;'>\n <table>\n  <tr>\n   <td class='itemtitle' width='1%' nowrap><?php xl('From', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_from' style='width:100%'\n     title='Type your name here' />\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('To', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_to' style='width:100%'\n     title='Type the recipient name here' />\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('Fax', 'e'); ?></td>\n   <td>\n    <input type='text' size='10' name='form_fax' style='width:100%'\n     title='The fax phone number to send this to' />\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('Message', 'e'); ?></td>\n   <td>\n    <textarea name='form_message' rows='3' cols='30' style='width:100%'\n     title='Your comments to include with this message' /></textarea>\n   </td>\n  </tr>\n  <tr>\n   <td class='itemtitle' nowrap><?php xl('Quality', 'e'); ?></td>\n   <td>\n    <input type='radio' name='form_finemode' value='' /><?php xl('Normal', 'e'); ?> &nbsp;\n    <input type='radio' name='form_finemode' value='1' checked /><?php xl('Fine', 'e'); ?> &nbsp;\n   </td>\n  </tr>\n </table>\n</div><!-- end div_forward -->\n\n<p><b><?php xl('Delete Pages', 'e'); ?>:</b>&nbsp;\n<input type='radio' name='form_cb_delete' value='2' />All&nbsp;\n<input type='radio' name='form_cb_delete' value='1' checked />Selected&nbsp;\n<input type='radio' name='form_cb_delete' value='0' />None\n</p>\n\n<center>\n<p>\n<input type='submit' name='form_save' value='<?php xl('OK', 'e'); ?>' />\n&nbsp; &nbsp;\n<input type='button' value='<?php xl('Cancel', 'e'); ?>' onclick='window.close()' />\n&nbsp; &nbsp;\n<input type='button' value='<?php xl('Select All', 'e'); ?>' onclick='allCheckboxes(true)' />\n&nbsp; &nbsp;\n<input type='button' value='<?php xl('Clear All', 'e'); ?>' onclick='allCheckboxes(false)' />\n</p>\n\n<p><br /><b><?php xl('Please select the desired pages to copy or forward:', 'e'); ?></b></p>\n<table>\n\n<?php\n$dh = opendir($faxcache);\nif (! $dh) {\n    die(\"Cannot read $faxcache\");\n}\n\n$jpgarray = array();\nwhile (false !== ($jfname = readdir($dh))) {\n    if (preg_match(\"/^(.*)\\.jpg/\", $jfname, $matches)) {\n        $jpgarray[$matches[1]] = $jfname;\n    }\n}\n\nclosedir($dh);\n// readdir does not read in any particular order, we must therefore sort\n// by filename so the display order matches the original document.\nksort($jpgarray);\n$page = 0;\nforeach ($jpgarray as $jfnamebase => $jfname) {\n    ++$page;\n    echo \" <tr>\\n\";\n    echo \"  <td valign='top'>\\n\";\n    echo \"   <img src='../../sites/\" . $_SESSION['site_id'] . \"/faxcache/$mode/$filebase/$jfname' />\\n\";\n    echo \"  </td>\\n\";\n    echo \"  <td align='center' valign='top'>\\n\";\n    echo \"   <input type='checkbox' name='form_images[]' value='$jfnamebase' checked />\\n\";\n    echo \"   <br />$page\\n\";\n    echo \"  </td>\\n\";\n    echo \" </tr>\\n\";\n}\n?>\n\n</table>\n</center>\n</form>\n</body>\n</html>\n", "<?php\n/**\n * CAMOS view.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    markleeds <markleeds>\n * @author    fndtn357 <fndtn357@gmail.com>\n * @author    cornfeed <jdough823@gmail.com>\n * @author    cfapress <cfapress>\n * @author    Wakie87 <scott@npclinics.com.au>\n * @author    Robert Down <robertdown@live.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2008 cfapress <cfapress>\n * @copyright Copyright (c) 2009 markleeds <markleeds>\n * @copyright Copyright (c) 2011 cornfeed <jdough823@gmail.com>\n * @copyright Copyright (c) 2012 fndtn357 <fndtn357@gmail.com>\n * @copyright Copyright (c) 2016 Wakie87 <scott@npclinics.com.au>\n * @copyright Copyright (c) 2016-2018 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017 Robert Down <robertdown@live.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\n?>\n<!-- view.php -->\n<?php\nrequire_once(\"../../globals.php\");\nrequire_once(\"../../../library/api.inc\");\nformHeader(\"Form: CAMOS\");\n$textarea_rows = 22;\n$textarea_cols = 90;\n?>\n<html><head>\n<link rel=stylesheet href=\"<?php echo $css_header;?>\" type=\"text/css\">\n<script type=\"text/javascript\">\nfunction checkall(){\n  var f = document.my_form;\n  var x = f.elements.length;\n  var i;\n  for(i=0;i<x;i++) {\n    if (f.elements[i].type == 'checkbox') {\n      f.elements[i].checked = true;\n    }\n  }\n}\nfunction uncheckall(){\n  var f = document.my_form;\n  var x = f.elements.length;\n  var i;\n  for(i=0;i<x;i++) {\n    if (f.elements[i].type == 'checkbox') {\n      f.elements[i].checked = false;\n    }\n  }\n}\nfunction content_focus() {\n}\nfunction content_blur() {\n}\nfunction show_edit(t) {\n  var e = document.getElementById(t);\n  if (e.style.display == 'none') {\n    e.style.display = 'inline';\n    return;\n  }\n  else {\n    e.style.display = 'none';\n  }\n}\n</script>\n<?php html_header_show();?>\n<link rel=\"stylesheet\" href=\"<?php echo $css_header;?>\" type=\"text/css\">\n</head>\n<body class=\"body_top\">\n<form method=post action=\"<?php echo $rootdir?>/forms/CAMOS/save.php?mode=delete&id=<?php echo attr($_GET[\"id\"]); ?>\" name=\"my_form\">\n<h1> <?php xl('CAMOS', 'e'); ?> </h1>\n<input type=\"submit\" name=\"delete\" value=\"<?php xl('Delete Selected Items', 'e'); ?>\" />\n<input type=\"submit\" name=\"update\" value=\"<?php xl('Update Selected Items', 'e'); ?>\" />\n<?php\necho \"<a href='{$GLOBALS['form_exit_url']}'>[\" . xlt('do nothing') . \"]</a>\";\n?>\n<br/><br/>\n<input type='button' value='<?php xl('Select All', 'e'); ?>'\n  onClick='checkall()'>\n<input type='button' value='<?php xl('Unselect All', 'e'); ?>'\n  onClick='uncheckall()'>\n<br/><br/>\n<?php\n//experimental code start\n\n$pid = $GLOBALS['pid'];\n$encounter = $GLOBALS['encounter'];\n\n$query = \"select t1.id, t1.content from \".mitigateSqlTableUpperCase(\"form_CAMOS\").\" as t1 join forms as t2 \" .\n  \"on (t1.id = t2.form_id) where t2.form_name like 'CAMOS%' \" .\n  \"and t2.encounter like $encounter and t2.pid = $pid\";\n\n$statement = sqlStatement($query);\nwhile ($result = sqlFetchArray($statement)) {\n    print \"<input type=button value='\" . xl('Edit') . \"' onClick='show_edit(\\\"id_textarea_\".$result['id'].\"\\\")'>\";\n    print \"<input type=checkbox name='ch_\".$result['id'].\"'> \".$result['content'].\"<br/>\";\n    print \"<div id=id_textarea_\".$result['id'].\" style='display:none'>\";\n    print \"<textarea name=textarea_\".$result['id'].\" cols=$textarea_cols rows= $textarea_rows onFocus='content_focus()' onBlur='content_blur()' >\".$result['content'].\"</textarea><br/>\";\n    print \"</div>\";\n}\n\n\n//experimental code end\n?>\n</form>\n<?php\n\nformFooter();\n", "<?php\n/**\n * Review of Systems Checks form\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    cfapress <cfapress>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @author    Robert Down <robertdown@live.com>\n * @copyright Copyright (c) 2008 cfapress <cfapress>\n * @copyright Copyright (c) 2016-2018 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017 Robert Down <robertdown@live.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../../globals.php\");\nrequire_once(\"$srcdir/api.inc\");\n\nuse OpenEMR\\Core\\Header;\n\n$returnurl = 'encounter_top.php';\n?>\n<html>\n<head>\n    <title><?php echo xlt(\"Review of Systems Checks\"); ?></title>\n\n    <?php Header::setupHeader();?>\n</head>\n<?php\n$obj = formFetch(\"form_reviewofs\", $_GET[\"id\"]);\n?>\n<body class=\"body_top\">\n    <div class=\"container\">\n        <div class=\"row\">\n            <div class=\"\">\n                <div class=\"page-header\">\n                    <h2><?php echo xlt(\"Review of Systems Checks\");?></h2>\n                </div>\n            </div>\n        </div>\n        <div class=\"row\">\n            <form method=post action=\"<?php echo $rootdir; ?>/forms/reviewofs/save.php?mode=update&id=<?php echo attr($_GET[\"id\"]); ?>\" name=\"my_form\" onsubmit=\"return top.restoreSession()\">\n                <fieldset>\n                    <legend><?php echo xlt('General')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"fever\" <?php echo ($obj{\"fever\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Fever');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"chills\" <?php echo ($obj{\"chills\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Chills');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"night_sweats\" <?php echo ($obj{\"night_sweats\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Night Sweats');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"weight_loss\" <?php echo ($obj{\"weight_loss\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Weight Loss');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"poor_appetite\" <?php echo ($obj{\"poor_appetite\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Poor Appetite');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"insomnia\" <?php echo ($obj{\"insomnia\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Insomnia');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"fatigued\" <?php echo ($obj{\"fatigued\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Fatigued');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"depressed\" <?php echo ($obj{\"depressed\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Depressed');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hyperactive\" <?php echo ($obj{\"hyperactive\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hyperactive');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"exposure_to_foreign_countries\" <?php echo ($obj{\"exposure_to_foreign_countries\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Exposure to Foreign Countries');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Skin')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"rashes\" <?php echo ($obj{\"rashes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Rashes');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"infections\" <?php echo ($obj{\"infections\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Infections');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ulcerations\" <?php echo ($obj{\"ulcerations\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ulcerations');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"pemphigus\" <?php echo ($obj{\"pemphigus\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Pemphigus');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"herpes\" <?php echo ($obj{\"herpes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Herpes');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('HEENT')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cataracts\" <?php echo ($obj{\"cataracts\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cataracts');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cataract_surgery\" <?php echo ($obj{\"cataract_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cataract Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"glaucoma\" <?php echo ($obj{\"glaucoma\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Glaucoma');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"double_vision\" <?php echo ($obj{\"double_vision\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Double Vision');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"blurred_vision\" <?php echo ($obj{\"blurred_vision\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Blurred Vision');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"poor_hearing\" <?php echo ($obj{\"poor_hearing\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Poor Hearing');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"headaches\" <?php echo ($obj{\"headaches\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Headaches');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ringing_in_ears\" <?php echo ($obj{\"ringing_in_ears\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ringing in Ears');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"bloody_nose\" <?php echo ($obj{\"bloody_nose\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Bloody Nose');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"sinusitis\" <?php echo ($obj{\"sinusitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Sinusitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"sinus_surgery\" <?php echo ($obj{\"sinus_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Sinus Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"dry_mouth\" <?php echo ($obj{\"dry_mouth\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Dry Mouth');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"strep_throat\" <?php echo ($obj{\"strep_throat\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Strep Throat');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"tonsillectomy\" <?php echo ($obj{\"tonsillectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Tonsillectomy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"swollen_lymph_nodes\" <?php echo ($obj{\"swollen_lymph_nodes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Swollen Lymph Nodes');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"throat_cancer\" <?php echo ($obj{\"throat_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Throat Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"throat_cancer_surgery\" <?php echo ($obj{\"throat_cancer_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Throat Cancer Surgery');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Pulmonary')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"emphysema\" <?php echo ($obj{\"emphysema\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Emphysema');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"chronic_bronchitis\" <?php echo ($obj{\"chronic_bronchitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Chronic Bronchitis');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"interstitial_lung_disease\" <?php echo ($obj{\"interstitial_lung_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Interstitial Lung Disease');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"shortness_of_breath_2\" <?php echo ($obj{\"shortness_of_breath_2\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Shortness of Breath');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"lung_cancer\" <?php echo ($obj{\"lung_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Lung Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"lung_cancer_surgery\" <?php echo ($obj{\"lung_cancer_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Lung Cancer Surgery');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"pheumothorax\" <?php echo ($obj{\"pheumothorax\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Pheumothorax');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Cardiovascular')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"heart_attack\" <?php echo ($obj{\"heart_attack\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Heart Attack');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"irregular_heart_beat\" <?php echo ($obj{\"irregular_heart_beat\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Irregular Heart Beat');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"chest_pains\" <?php echo ($obj{\"chest_pains\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Chest Pains');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"shortness_of_breath\" <?php echo ($obj{\"shortness_of_breath\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Shortness of Breath');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"high_blood_pressure\" <?php echo ($obj{\"high_blood_pressure\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('High Blood Pressure');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"heart_failure\" <?php echo ($obj{\"heart_failure\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Heart Failure');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"poor_circulation\" <?php echo ($obj{\"poor_circulation\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Poor Circulation');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"vascular_surgery\" <?php echo ($obj{\"vascular_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Vascular Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cardiac_catheterization\" <?php echo ($obj{\"cardiac_catheterization\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cardiac Catheterization');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"heart_transplant\" <?php echo ($obj{\"heart_transplant\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Heart Transplant');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stress_test\" <?php echo ($obj{\"stress_test\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stress Test');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stress_test\" <?php echo ($obj{\"stress_test\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stress Test');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Gastrointestinal')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stomach_pains\" <?php echo ($obj{\"stomach_pains\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stomach Pains');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"peptic_ulcer_disease\" <?php echo ($obj{\"peptic_ulcer_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Peptic Ulcer Disease');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"gastritis\" <?php echo ($obj{\"gastritis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Gastritis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"endoscopy\" <?php echo ($obj{\"endoscopy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Endoscopy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"polyps\" <?php echo ($obj{\"polyps\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Polyps');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"colonoscopy\" <?php echo ($obj{\"colonoscopy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Colonoscopy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"colon_cancer\" <?php echo ($obj{\"colon_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Colon Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"colon_cancer_surgery\" <?php echo ($obj{\"colon_cancer_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Colon Cancer Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ulcerative_colitis\" <?php echo ($obj{\"ulcerative_colitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ulcerative Colitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"crohns_disease\" <?php echo ($obj{\"crohns_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Crohn\\'s Disease');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"appendectomy\" <?php echo ($obj{\"appendectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Appendectomy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"divirticulitis\" <?php echo ($obj{\"divirticulitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Divirticulitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"divirticulitis_surgery\" <?php echo ($obj{\"divirticulitis_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Diverticulitis Surgery');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"gall_stones\" <?php echo ($obj{\"gall_stones\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Gall Stones');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cholecystectomy\" <?php echo ($obj{\"cholecystectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cholecystectomy');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hepatitis\" <?php echo ($obj{\"hepatitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hepatitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cirrhosis_of_the_liver\" <?php echo ($obj{\"cirrhosis_of_the_liver\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cirrhosis of the Liver');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"splenectomy\" <?php echo ($obj{\"splenectomy\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Splenectomy');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Genitourinary')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_failure\" <?php echo ($obj{\"kidney_failure\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Failure');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_stones\" <?php echo ($obj{\"kidney_stones\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Stones');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_cancer\" <?php echo ($obj{\"kidney_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Cancer');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_infections\" <?php echo ($obj{\"kidney_infections\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Infections');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"bladder_infections\" <?php echo ($obj{\"bladder_infections\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Bladder Infections');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"bladder_cancer\" <?php echo ($obj{\"bladder_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Bladder Cancer');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"prostate_problems\" <?php echo ($obj{\"prostate_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Prostate Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"prostate_cancer\" <?php echo ($obj{\"prostate_cancer\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Prostate Cancer');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"kidney_transplant\" <?php echo ($obj{\"kidney_transplant\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Kidney Transplant');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"sexually_transmitted_disease\" <?php echo ($obj{\"sexually_transmitted_disease\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Sexually Transmitted Disease');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"burning_with_urination\" <?php echo ($obj{\"burning_with_urination\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Burning with Urination');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"discharge_from_urethra\" <?php echo ($obj{\"discharge_from_urethra\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Discharge From Urethra');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Musculoskeletal')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"osetoarthritis\" <?php echo ($obj{\"osetoarthritis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Osetoarthritis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"rheumotoid_arthritis\" <?php echo ($obj{\"rheumotoid_arthritis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Rheumatoid Arthritis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"lupus\" <?php echo ($obj{\"lupus\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Lupus');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ankylosing_sondlilitis\" <?php echo ($obj{\"ankylosing_sondlilitis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ankylosing Sondlilitis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"swollen_joints\" <?php echo ($obj{\"swollen_joints\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Swollen Joints');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"stiff_joints\" <?php echo ($obj{\"stiff_joints\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Stiff Joints');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"broken_bones\" <?php echo ($obj{\"broken_bones\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Broken Bones');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"neck_problems\" <?php echo ($obj{\"neck_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Neck Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"back_problems\" <?php echo ($obj{\"back_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Back Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"back_surgery\" <?php echo ($obj{\"back_surgery\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Back Surgery');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"scoliosis\" <?php echo ($obj{\"scoliosis\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Scoliosis');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"herniated_disc\" <?php echo ($obj{\"herniated_disc\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Herniated Disc');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"shoulder_problems\" <?php echo ($obj{\"shoulder_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Shoulder Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"elbow_problems\" <?php echo ($obj{\"elbow_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Elbow Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"wrist_problems\" <?php echo ($obj{\"wrist_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Wrist Problems');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hand_problems\" <?php echo ($obj{\"hand_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hand Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hip_problems\" <?php echo ($obj{\"hip_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hip Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"knee_problems\" <?php echo ($obj{\"knee_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Knee Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"ankle_problems\" <?php echo ($obj{\"ankle_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Ankle Problems');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"foot_problems\" <?php echo ($obj{\"foot_problems\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Foot Problems');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                    <legend><?php echo xlt('Endocrine')?></legend>\n                    <div class=\"row\">\n                        <div class=\"col-xs-12\">\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"insulin_dependent_diabetes\" <?php echo ($obj{\"insulin_dependent_diabetes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Insulin Dependent Diabetes');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"noninsulin_dependent_diabetes\" <?php echo ($obj{\"noninsulin_dependent_diabetes\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Non-Insulin Dependent Diabetes');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hypothyroidism\" <?php echo ($obj{\"hypothyroidism\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hypothyroidism');?>\n                                        </label>\n                                    </div>\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"hyperthyroidism\" <?php echo ($obj{\"hyperthyroidism\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Hyperthyroidism');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"cushing_syndrom\" <?php echo ($obj{\"cushing_syndrom\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Cushing Syndrome');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-sm-3\">\n                                <div class=\"form-group\">\n                                    <div class=\"checkbox\">\n                                        <label>\n                                            <input type=\"checkbox\" name=\"addison_syndrom\" <?php echo ($obj{\"addison_syndrom\"} == \"on\") ? \"checked\" : \"\"; ?>><?php echo xlt('Addison Syndrome');?>\n                                        </label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </fieldset>\n                <fieldset>\n                        <legend class=\"\"><?php echo xlt('Additional Notes');?></legend>\n                            <div class=\"form-group\">\n                                <div class=\"col-sm-10 col-sm-offset-1\">\n                                    <textarea name=\"additional_notes\" class=\"form-control\" cols=\"80\" rows=\"5\" ><?php echo text($obj{\"additional_notes\"}); ?></textarea>\n                                </div>\n                            </div>\n                </fieldset>\n                    <div class=\"form-group clearfix\">\n                        <div class=\"col-sm-12 col-sm-offset-1 position-override\">\n                            <div class=\"btn-group oe-opt-btn-group-pinch\" role=\"group\">\n                            <button type=\"submit\" onclick=\"top.restoreSession()\" class=\"btn btn-default btn-save\"><?php echo xlt('Save'); ?></button>\n                            <button type=\"button\" class=\"btn btn-link btn-cancel oe-opt-btn-separate-left\" onclick=\"top.restoreSession(); parent.closeTab(window.name, false);\"><?php echo xlt('Cancel');?></button>\n                        </div>\n                    </div>\n                </div>\n            </form>\n        </div>\n    </div>\n</body>\n</html>\n", "<?php\n/**\n * finder_navigation.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../../globals.php\");\n?>\n\n<html>\n<head>\n<?php html_header_show();?>\n<title>Navigation</title>\n\n<link rel=\"stylesheet\" href=\"<?php echo $css_header;?>\" type=\"text/css\">\n\n</head>\n<body class=\"body_nav\">\n\n<div id=\"nav_topmenu\">\n<form method='post' target=\"_top\" name=\"find_patient\" action=\"<?php echo $rootdir?>/main/finder/patient_finder.php\" onsubmit=\"return top.restoreSession()\">\n\n<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" height=\"100%\">\n<tr>\n\n<td style=\"text-align:left; width: 250px; white-space: nowrap;\">\n<input type=\"textbox\" size=\"10\" name=\"patient\" value=\"<?php echo attr($_REQUEST['patient']); ?>\" >\n<select name=\"findBy\">\n<option value=\"Last\" <?php if ($_REQUEST['findBy'] == 'Last') {\n    echo 'selected';\n} ?>><?php xl('Name', 'e');?></option>\n<option value=\"Phone\" <?php if ($_REQUEST['findBy'] == 'Phone') {\n    echo 'selected';\n} ?>><?php xl('Phone', 'e');?></option>\n<option value=\"ID\" <?php if ($_REQUEST['findBy'] == 'ID') {\n    echo 'selected';\n} ?>><?php xl('ID', 'e');?></option>\n<option value=\"SSN\" <?php if ($_REQUEST['findBy'] == 'SSN') {\n    echo 'selected';\n} ?>><?php xl('SSN', 'e');?></option>\n<option value=\"DOB\" <?php if ($_REQUEST['findBy'] == 'DOB') {\n    echo 'selected';\n} ?>><?php xl('DOB', 'e');?></option>\n</select>\n<a href=\"javascript:top.restoreSession();document.find_patient.action='<?php echo $rootdir?>/main/finder/patient_finder.php';document.find_patient.submit();\" class=\"link\">&nbsp;<?php xl('Find Patient', 'e');?></a>\n</td>\n\n<td style=\"text-align:left\">\n&nbsp;&nbsp;&nbsp;<a class=\"menu\" target=\"_top\" href=\"../../new/new_patient.php\" onclick=\"top.restoreSession()\">\n<?php xl('New Patient', 'e');?></a>&nbsp;\n</td>\n\n<td style=\"text-align:right\">\n&nbsp;<a href=\"../main_screen.php\" target=\"_top\" class=\"logout\" onclick=\"top.restoreSession()\">\n<?php xl('Back', 'e');?></a>&nbsp;&nbsp;\n</td>\n</tr>\n</table>\n\n</form>\n</div>\n\n</body>\n</html>\n", "<?php\n/**\n * types.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2010-2012 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/acl.inc\");\n\n// This script can be run either inside the OpenEMR frameset for order catalog\n// maintenance, or as a popup window for selecting an item to order.  In the\n// popup case the GET variables 'popup' (a boolean) and 'order' (an optional\n// item ID to select) will be provided, and maintenance may also be permitted.\n\n$popup = empty($_GET['popup']) ? 0 : 1;\n$order = isset($_GET['order']) ? $_GET['order'] + 0 : 0;\n$labid = isset($_GET['labid']) ? $_GET['labid'] + 0 : 0;\n\n// If Save was clicked, set the result, close the window and exit.\n//\nif ($popup && $_POST['form_save']) {\n    $form_order = isset($_GET['form_order']) ? $_GET['form_order'] + 0 : 0;\n    $ptrow = sqlQuery(\"SELECT name FROM procedure_type WHERE \" .\n    \"procedure_type_id = '$form_order'\");\n    $name = addslashes($ptrow['name']);\n?>\n<script type=\"text/javascript\" src=\"<?php echo $webroot ?>/interface/main/tabs/js/include_opener.js\"></script>\n<script language=\"JavaScript\">\nif (opener.closed || ! opener.set_proc_type) {\n alert('<?php xl('The destination form was closed; I cannot act on your selection.', 'e'); ?>');\n}\nelse {\n opener.set_proc_type(<?php echo \"$form_order, '$name'\" ?>);\n<?php\n// This is to generate the \"Questions at Order Entry\" for the Procedure Order form.\n// GET parms needed for this are: formid, formseq.\nif (isset($_GET['formid'])) {\n    require_once(\"qoe.inc.php\");\n    $qoe_init_javascript = '';\n    echo ' opener.set_proc_html(\"';\n    echo generate_qoe_html($form_order, intval($_GET['formid']), 0, intval($_GET['formseq']));\n    echo '\", \"' . $qoe_init_javascript .  '\");' . \"\\n\";\n}\n?>\n}\nwindow.close(); // comment out for debugging\n</script>\n<?php\n  exit();\n}\n\n// end Save logic\n\n?>\n<html>\n\n<head>\n\n<title><?php xl('Order and Result Types', 'e'); ?></title>\n\n<link rel=\"stylesheet\" href='<?php echo $css_header ?>' type='text/css'>\n\n<style type=\"text/css\">\nbody {\n font-family:sans-serif;\n font-size:9pt;\n font-weight:normal;\n padding: 5px 3px 5px 3px;\n}\n#con0 table {\n margin:0;\n padding:0;\n width:100%;\n}\n#con0 td {\n padding:0pt;\n font-family:sans-serif;\n font-size:9pt;\n}\n.plusminus {\n font-family:monospace;\n font-size:10pt;\n}\n.haskids {\n color:#0000dd;\n cursor:pointer;\n cursor:hand;\n}\ntr.head {\nfont-size:10pt;\nbackground-color:#cccccc;\nfont-weight:bold;\n}\ntr.evenrow {\n background-color:#ddddff;\n}\ntr.oddrow {\n background-color:#ffffff;\n}\n\n.col1 {width:35%}\n.col2 {width:8%}\n.col3 {width:12%}\n.col4 {width:35%}\n.col5 {width:10%}\n</style>\n\n<script src=\"<?php echo $GLOBALS['assets_static_relative']; ?>/jquery-min-1-2-2/index.js\" type=\"text/javascript\"></script>\n<?php if ($popup) { ?>\n<script type=\"text/javascript\" src=\"../../library/topdialog.js\"></script>\n<?php } ?>\n<script type=\"text/javascript\" src=\"../../library/dialog.js?v=<?php echo $v_js_includes; ?>\"></script>\n\n<script language=\"JavaScript\">\n\n<?php if ($popup) {\n    require($GLOBALS['srcdir'] . \"/restoreSession.php\");\n} ?>\n\n<?php\n// Create array of IDs to pre-select, leaf to top.\necho \"preopen = [\";\necho $order > 0 ? $order : 0;\nfor ($parentid = $order; $parentid > 0;) {\n    $row = sqlQuery(\"SELECT parent FROM procedure_type WHERE procedure_type_id = '$parentid'\");\n    $parentid = $row['parent'] + 0;\n    echo \", $parentid\";\n}\n\necho \"];\\n\";\n?>\n\n// initiate by loading the top-level nodes\n$(document).ready(function(){\n nextOpen();\n});\n\n// This is called repeatedly at initialization until all desired nodes\n// have been opened.\nfunction nextOpen() {\n if (preopen.length) {\n  var thisid = preopen.pop();\n  if (thisid == 0 || preopen.length > 0) {\n   if (thisid > 0)\n    toggle(thisid);\n   else\n    $.getScript('types_ajax.php?id=' + thisid + '&order=<?php echo $order; ?>' + '&labid=<?php echo $labid; ?>');\n  }\n  else {\n   recolor();\n  }\n }\n else {\n  recolor();\n }\n}\n\n// toggle expansion indicator from + to - or vice versa\nfunction swapsign(td1, from, to) {\n var s = td1.html();\n var i = s.indexOf('>' + from + '<');\n if (i >= 0) td1.html(s.substring(0,i+1) + to + s.substring(i+2));\n}\n\n// onclick handler to expand or collapse a node\nfunction toggle(id) {\n var td1 = $('#td' + id);\n if (!td1.hasClass('haskids')) return;\n if (td1.hasClass('isExpanded')) {\n  $('#con' + id).remove();\n  td1.removeClass('isExpanded');\n  swapsign(td1, '-', '+');\n  recolor();\n }\n else {\n  td1.parent().after('<tr class=\"outertr\"><td colspan=\"5\" id=\"con' + id + '\" style=\"padding:0\">Loading...</td></tr>');\n  td1.addClass('isExpanded');\n  swapsign(td1, '+', '-');\n  $.getScript('types_ajax.php?id=' + id + '&order=<?php echo $order; ?>' + '&labid=<?php echo $labid; ?>');\n }\n}\n\n// Called by the edit window to refresh a given node's children\nfunction refreshFamily(id, haskids) {\n if (id) { // id == 0 means top level\n  var td1 = $('#td' + id);\n  if (td1.hasClass('isExpanded')) {\n   $('#con' + id).remove();\n   td1.removeClass('isExpanded');\n   swapsign(td1, '-', '+');\n  }\n  if (td1.hasClass('haskids') && !haskids) {\n   td1.removeClass('haskids');\n   // swapsign(td1, '+', '.');\n   swapsign(td1, '+', '|');\n   return;\n  }\n  if (!td1.hasClass('haskids') && haskids) {\n   td1.addClass('haskids');\n   // swapsign(td1, '.', '+');\n   swapsign(td1, '|', '+');\n  }\n  if (haskids) {\n   td1.parent().after('<tr class=\"outertr\"><td colspan=\"5\" id=\"con' + id + '\" style=\"padding:0\">Loading...</td></tr>');\n   td1.addClass('isExpanded');\n   swapsign(td1, '+', '-');\n  }\n }\n if (haskids)\n  $.getScript('types_ajax.php?id=' + id + '&order=<?php echo $order; ?>' + '&labid=<?php echo $labid; ?>');\n else\n  recolor();\n}\n\n// edit a node\nfunction enode(id) {\n dlgopen('types_edit.php?parent=0&typeid=' + id, '_blank', 700, 550);\n}\n\n// add a node\nfunction anode(id) {\n dlgopen('types_edit.php?typeid=0&parent=' + id, '_blank', 700, 550);\n}\n\n// call this to alternate row colors when anything changes the number of rows\nfunction recolor() {\n var i = 0;\n $('#con0 tr').each(function(index) {\n  // skip any row that contains other rows\n  if ($(this).hasClass('outertr')) return;\n  this.className = (i++ & 1) ? \"evenrow\" : \"oddrow\";\n });\n}\n\n</script>\n\n</head>\n\n<body class=\"body_nav\">\n<center>\n\n<h3 style='margin-top:0'><?php xl('Types of Orders and Results', 'e') ?></h3>\n\n<form method='post' name='theform' action='types.php?popup=<?php echo $popup ?>&order=<?php\necho $order;\nif (isset($_GET['formid' ])) {\n    echo '&formid='  . attr($_GET['formid']);\n}\n\nif (isset($_GET['formseq'])) {\n    echo '&formseq=' . attr($_GET['formseq']);\n}\n?>'>\n\n<table width='100%' cellspacing='0' cellpadding='0' border='0'>\n <tr class='head'>\n  <th class='col1' align='left'>&nbsp;&nbsp;<?php xl('Name', 'e') ?></th>\n  <th class='col2' align='left'><?php xl('Order', 'e') ?></th>\n  <th class='col3' align='left'><?php xl('Code', 'e') ?></th>\n  <th class='col4' align='left'><?php xl('Description', 'e') ?></th>\n  <th class='col5' align='left'>&nbsp;</th>\n </tr>\n</table>\n\n<div id=\"con0\">\n</div>\n\n<p>\n<?php if ($popup) { ?>\n<input type='submit' name='form_save' value='<?php xl('Save', 'e'); ?>' />\n&nbsp;\n<input type='button' value=<?php xl('Cancel', 'e'); ?> onclick='window.close()' />\n&nbsp;\n<?php } ?>\n<input type='button' value='<?php xl('Add Top Level', 'e'); ?>' onclick='anode(0)' />\n</p>\n\n</form>\n\n</center>\n\n</body>\n</html>\n\n", "<?php\n/**\n * letter.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2007-2011 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../globals.php\");\nrequire_once($GLOBALS['srcdir'] . \"/patient.inc\");\n\nuse OpenEMR\\Core\\Header;\n\n$template_dir = $GLOBALS['OE_SITE_DIR'] . \"/letter_templates\";\n\n// array of field name tags to allow internationalization\n//  of templates\n$FIELD_TAG = array(\n    'DATE'             => xl('DATE'),\n    'FROM_TITLE'       => xl('FROM_TITLE'),\n    'FROM_FNAME'       => xl('FROM_FNAME'),\n    'FROM_LNAME'       => xl('FROM_LNAME'),\n    'FROM_MNAME'       => xl('FROM_MNAME'),\n    'FROM_STREET'      => xl('FROM_STREET'),\n    'FROM_CITY'        => xl('FROM_CITY'),\n    'FROM_STATE'       => xl('FROM_STATE'),\n    'FROM_POSTAL'      => xl('FROM_POSTAL'),\n    'FROM_VALEDICTORY' => xl('FROM_VALEDICTORY'),\n    'FROM_PHONE'       => xl('FROM_PHONE'),\n    'FROM_PHONECELL'   => xl('FROM_PHONECELL'),\n    'FROM_EMAIL'       => xl('FROM_EMAIL'),\n    'TO_TITLE'         => xl('TO_TITLE'),\n    'TO_FNAME'         => xl('TO_FNAME'),\n    'TO_LNAME'         => xl('TO_LNAME'),\n    'TO_MNAME'         => xl('TO_MNAME'),\n    'TO_STREET'        => xl('TO_STREET'),\n    'TO_CITY'          => xl('TO_CITY'),\n    'TO_STATE'         => xl('TO_STATE'),\n    'TO_POSTAL'        => xl('TO_POSTAL'),\n    'TO_VALEDICTORY'   => xl('TO_VALEDICTORY'),\n    'TO_PHONE'         => xl('TO_PHONE'),\n    'TO_PHONECELL'     => xl('TO_PHONECELL'),\n    'TO_FAX'           => xl('TO_FAX'),\n    'TO_ORGANIZATION'  => xl('TO_ORGANIZATION'),\n    'PT_FNAME'         => xl('PT_FNAME'),\n    'PT_LNAME'         => xl('PT_LNAME'),\n    'PT_MNAME'         => xl('PT_MNAME'),\n    'PT_STREET'        => xl('PT_STREET'),\n    'PT_CITY'          => xl('PT_CITY'),\n    'PT_STATE'         => xl('PT_STATE'),\n    'PT_POSTAL'        => xl('PT_POSTAL'),\n    'PT_PHONE_HOME'    => xl('PT_PHONE_HOME'),\n    'PT_PHONE_CELL'    => xl('PT_PHONE_CELL'),\n    'PT_SSN'           => xl('PT_SSN'),\n    'PT_EMAIL'         => xl('PT_EMAIL'),\n    'PT_DOB'           => xl('PT_DOB')\n\n);\n\n$patdata = sqlQuery(\"SELECT \" .\n  \"p.fname, p.mname, p.lname, p.pubpid, p.DOB, \" .\n  \"p.street, p.city, p.state, p.phone_home, p.phone_cell, p.ss, p.email, p.postal_code \" .\n  \"FROM patient_data AS p \" .\n  \"WHERE p.pid = ? LIMIT 1\", array($pid));\n\n$alertmsg = ''; // anything here pops up in an alert box\n\n// If the Generate button was clicked...\nif ($_POST['formaction']==\"generate\") {\n    $form_pid      = $_POST['form_pid'];\n    $form_from     = $_POST['form_from'];\n    $form_to       = $_POST['form_to'];\n    $form_date     = $_POST['form_date'];\n    $form_template = $_POST['form_template'];\n    $form_format   = $_POST['form_format'];\n    $form_body     = $_POST['form_body'];\n\n    $frow = sqlQuery(\"SELECT * FROM users WHERE id = ?\", array($form_from));\n    $trow = sqlQuery(\"SELECT * FROM users WHERE id = ?\", array($form_to));\n\n    $datestr = $form_date;\n    $from_title = $frow['title'] ? $frow['title'] . ' ' : '';\n    $to_title   = $trow['title'] ? $trow['title'] . ' ' : '';\n\n    $cpstring = $_POST['form_body'];\n\n    // attempt to save to the autosaved template\n    $fh = fopen(\"$template_dir/autosaved\", 'w');\n    // translate from definition to the constant\n    $temp_bodytext = $cpstring;\n    foreach ($FIELD_TAG as $key => $value) {\n        $temp_bodytext = str_replace(\"{\".$value.\"}\", \"{\".$key.\"}\", $temp_bodytext);\n    }\n\n    if (! fwrite($fh, $temp_bodytext)) {\n        echo xl('Error while saving to the file', '', '', ' ') . $template_dir.\"/autosaved\" .\n             xl('Ensure OpenEMR has write privileges to directory', '', ' . ', ' ') . $template_dir  . \"/ .\" ;\n        die;\n    }\n\n    fclose($fh);\n\n    $cpstring = str_replace('{'.$FIELD_TAG['DATE'].'}', $datestr, $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_TITLE'].'}', $from_title, $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_FNAME'].'}', $frow['fname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_LNAME'].'}', $frow['lname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_MNAME'].'}', $frow['mname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_STREET'].'}', $frow['street'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_CITY'].'}', $frow['city'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_STATE'].'}', $frow['state'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_POSTAL'].'}', $frow['zip'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_VALEDICTORY'].'}', $frow['valedictory'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_PHONECELL'].'}', $frow['phonecell'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_PHONE'].'}', $frow['phone'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['FROM_EMAIL'].'}', $frow['email'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_TITLE'].'}', $to_title, $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_FNAME'].'}', $trow['fname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_LNAME'].'}', $trow['lname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_MNAME'].'}', $trow['mname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_STREET'].'}', $trow['street'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_CITY'].'}', $trow['city'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_STATE'].'}', $trow['state'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_POSTAL'].'}', $trow['zip'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_VALEDICTORY'].'}', $trow['valedictory'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_FAX'].'}', $trow['fax'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_PHONE'].'}', $trow['phone'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_PHONECELL'].'}', $trow['phonecell'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['TO_ORGANIZATION'].'}', $trow['organization'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_FNAME'].'}', $patdata['fname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_LNAME'].'}', $patdata['lname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_MNAME'].'}', $patdata['mname'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_STREET'].'}', $patdata['street'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_CITY'].'}', $patdata['city'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_STATE'].'}', $patdata['state'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_POSTAL'].'}', $patdata['postal_code'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_PHONE_HOME'].'}', $patdata['phone_home'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_PHONE_CELL'].'}', $patdata['phone_cell'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_SSN'].'}', $patdata['ss'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_EMAIL'].'}', $patdata['email'], $cpstring);\n    $cpstring = str_replace('{'.$FIELD_TAG['PT_DOB'].'}', $patdata['DOB'], $cpstring);\n\n    if ($form_format == \"pdf\") {\n        $pdf = new Cezpdf($GLOBALS['rx_paper_size']);\n        $pdf->ezSetMargins($GLOBALS['rx_top_margin'], $GLOBALS['rx_bottom_margin'], $GLOBALS['rx_left_margin'], $GLOBALS['rx_right_margin']);\n        if (file_exists(\"$template_dir/custom_pdf.php\")) {\n            include(\"$template_dir/custom_pdf.php\");\n        } else {\n            $pdf->selectFont('Helvetica');\n            $pdf->ezText($cpstring, 12);\n        }\n\n        $pdf->ezStream();\n        exit;\n    } else { // $form_format = html\n        $cpstring = text($cpstring); //escape to prevent stored cross script attack\n        $cpstring = str_replace(\"\\n\", \"<br>\", $cpstring);\n        $cpstring = str_replace(\"\\t\", \"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\", $cpstring);\n        ?>\n        <html>\n        <head>\n        <style>\n        body {\n     font-family: sans-serif;\n     font-weight: normal;\n     font-size: 12pt;\n     background: white;\n     color: black;\n    }\n    .paddingdiv {\n     width: 524pt;\n     padding: 0pt;\n     margin-top: 50pt;\n    }\n    .navigate {\n     margin-top: 2.5em;\n    }\n    @media print {\n     .navigate {\n      display: none;\n     }\n    }\n    </style>\n    <title><?php echo xlt('Letter'); ?></title>\n    </head>\n        <body>\n    <div class='paddingdiv'>\n    <?php echo $cpstring; ?>\n        <div class=\"navigate\">\n    <a href='<?php echo $GLOBALS['rootdir'] . '/patient_file/letter.php?template=autosaved'; ?>' onclick='top.restoreSession()'>(<?php echo xlt('Back'); ?>)</a>\n    </div>\n    <script language='JavaScript'>\n    window.print();\n    </script>\n    </body>\n    </div>\n    <?php\n    exit;\n    }\n} else if (isset($_GET['template']) && $_GET['template'] != \"\") {\n    // utilized to go back to autosaved template\n    $bodytext = \"\";\n    $fh = fopen(\"$template_dir/\" . convert_safe_file_dir_name($_GET['template']), 'r');\n\n    if (!$fh) {\n        die(xlt(\"Requested template does not exist\"));\n    }\n\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n} else if ($_POST['formaction'] == \"loadtemplate\" && $_POST['form_template'] != \"\") {\n    $bodytext = \"\";\n    $fh = fopen(\"$template_dir/\" . convert_safe_file_dir_name($_POST['form_template']), 'r');\n\n    if (!$fh) {\n        die(xlt(\"Requested template does not exist\"));\n    }\n\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n} else if ($_POST['formaction'] == \"newtemplate\" && $_POST['newtemplatename'] != \"\") {\n    // attempt to save the template\n    $fh = fopen(\"$template_dir/\" . convert_safe_file_dir_name($_POST['newtemplatename']), 'w');\n    // translate from definition to the constant\n    $temp_bodytext = $_POST['form_body'];\n    foreach ($FIELD_TAG as $key => $value) {\n        $temp_bodytext = str_replace(\"{\".$value.\"}\", \"{\".$key.\"}\", $temp_bodytext);\n    }\n\n    if (! fwrite($fh, $temp_bodytext)) {\n        echo xlt('Error while writing to file') . ' ' . $template_dir.\"/\" . $_POST['newtemplatename'];\n        die;\n    }\n\n    fclose($fh);\n\n    // read the saved file back\n    $_POST['form_template'] = $_POST['newtemplatename'];\n    $fh = fopen(\"$template_dir/\" . convert_safe_file_dir_name($_POST['form_template']), 'r');\n\n    if (!$fh) {\n        die(xlt(\"Requested template does not exist\"));\n    }\n\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n} else if ($_POST['formaction'] == \"savetemplate\" && $_POST['form_template'] != \"\") {\n    // attempt to save the template\n    $fh = fopen(\"$template_dir/\" . convert_safe_file_dir_name($_POST['form_template']), 'w');\n    // translate from definition to the constant\n    $temp_bodytext = $_POST['form_body'];\n    foreach ($FIELD_TAG as $key => $value) {\n        $temp_bodytext = str_replace(\"{\".$value.\"}\", \"{\".$key.\"}\", $temp_bodytext);\n    }\n\n    if (! fwrite($fh, $temp_bodytext)) {\n        echo xlt('Error while writing to file') . ' ' . $template_dir.\"/\".$_POST['form_template'];\n        die;\n    }\n\n    fclose($fh);\n\n    // read the saved file back\n    $fh = fopen(\"$template_dir/\" . convert_safe_file_dir_name($_POST['form_template']), 'r');\n\n    if (!$fh) {\n        die(xlt(\"Requested template does not exist\"));\n    }\n\n    while (!feof($fh)) {\n        $bodytext.= fread($fh, 8192);\n    }\n\n    fclose($fh);\n    // translate from constant to the definition\n    foreach ($FIELD_TAG as $key => $value) {\n        $bodytext = str_replace(\"{\".$key.\"}\", \"{\".$value.\"}\", $bodytext);\n    }\n}\n\n// This is the case where we display the form for data entry.\n// Get the users list.\n$ures = sqlStatement(\"SELECT id, fname, lname, specialty FROM users \" .\n  \"WHERE active = 1 AND ( info IS NULL OR info NOT LIKE '%Inactive%' ) \" .\n  \"ORDER BY lname, fname\");\n$i = 0;\n$optfrom = '';\n$optto = '';\n$ulist = \"var ulist = new Array();\\n\";\nwhile ($urow = sqlFetchArray($ures)) {\n    $uname = $urow['lname'];\n    if ($urow['fname']) {\n        $uname .= \", \" . $urow['fname'];\n    }\n\n    $tmp1 = \" <option value='\" . attr($urow['id']) . \"'\";\n    $tmp2 = \">\" . text($uname) . \"</option>\\n\";\n    $optto .= $tmp1 . $tmp2;\n    if ($urow['id'] == $_SESSION['authUserID']) {\n        $tmp1 .= \" selected\";\n    }\n\n    $optfrom .= $tmp1 . $tmp2;\n    $ulist .= \"ulist[$i] = '\" . attr($uname) . \"|\" .\n    attr($urow['id']) . \"|\" . attr($urow['specialty']) . \"';\\n\";\n    ++$i;\n}\n\n// Get the unique specialties.\n$sres = sqlStatement(\"SELECT DISTINCT specialty FROM users \" .\n  \"WHERE active = 1 AND ( info IS NULL OR info NOT LIKE '%Inactive%' ) \" .\n  \"ORDER BY specialty\");\n$optspec = \"<option value='All'>\" . xlt('All') . \"</option>\\n\";\nwhile ($srow = sqlFetchArray($sres)) {\n    $optspec .= \" <option value='\" . attr($srow['specialty']) . \"'>\" .\n    text($srow['specialty']) . \"</option>\\n\";\n}\n?>\n\n<html>\n<head>\n<title><?php echo xlt('Letter Generator'); ?></title>\n<?php Header::setupHeader(['datetime-picker', 'topdialog']); ?>\n\n<script language=\"JavaScript\">\n<?php echo $ulist; ?>\n\n// React to selection of a specialty.  This rebuilds the \"to\" users list\n// with users having that specialty, or all users if \"All\" is selected.\nfunction newspecialty() {\n    var f = document.forms[0];\n    var s = f.form_specialty.value;\n    var theopts = f.form_to.options;\n    theopts.length = 0;\n    var j = 0;\n    for (var i = 0; i < ulist.length; ++i) {\n        tmp = ulist[i].split(\"|\");\n        if (s != 'All' && s != tmp[2]) continue;\n        theopts[j++] = new Option(tmp[0], tmp[1], false, false);\n    }\n}\n\n\n// insert text into a textarea where the cursor is\nfunction insertAtCaret(areaId,text) {\n    var txtarea = document.getElementById(areaId);\n    var scrollPos = txtarea.scrollTop;\n    var strPos = 0;\n    var br = ((txtarea.selectionStart || txtarea.selectionStart == '0') ?\n            \"ff\" : (document.selection ? \"ie\" : false ) );\n    if (br == \"ie\") {\n        txtarea.focus();\n        var range = document.selection.createRange();\n        range.moveStart ('character', -txtarea.value.length);\n        strPos = range.text.length;\n    }\n    else if (br == \"ff\") strPos = txtarea.selectionStart;\n\n    var front = (txtarea.value).substring(0,strPos);\n    var back = (txtarea.value).substring(strPos,txtarea.value.length);\n    txtarea.value=front+text+back;\n    strPos = strPos + text.length;\n    if (br == \"ie\") {\n        txtarea.focus();\n        var range = document.selection.createRange();\n        range.moveStart ('character', -txtarea.value.length);\n        range.moveStart ('character', strPos);\n        range.moveEnd ('character', 0);\n        range.select();\n    }\n    else if (br == \"ff\") {\n        txtarea.selectionStart = strPos;\n        txtarea.selectionEnd = strPos;\n        txtarea.focus();\n    }\n    txtarea.scrollTop = scrollPos;\n}\n\nfunction insertAtCursor(myField, myValue) {\n    //IE support\n    if (document.selection) {\n        myField.focus();\n        sel = document.selection.createRange();\n        sel.text = myValue;\n    }\n    //MOZILLA/NETSCAPE support\n    else if (myField.selectionStart || myField.selectionStart == '0') {\n        var startPos = myField.selectionStart;\n        var endPos = myField.selectionEnd;\n        myField.value = myField.value.substring(0, startPos)\n                        + myValue\n                        + myField.value.substring(endPos, myField.value.length);\n    } else {\n        myField.value += myValue;\n    }\n}\n\n\n</script>\n\n</head>\n\n<body class=\"body_top\" onunload='imclosing()'>\n\n<!-- <form method='post' action='letter.php' onsubmit='return top.restoreSession()'> -->\n<form method='post' action='letter.php' id=\"theform\" name=\"theform\" onsubmit=\"return top.restoreSession()\">\n<input type=\"hidden\" name=\"formaction\" id=\"formaction\" value=\"\">\n<input type='hidden' name='form_pid' value='<?php echo attr($pid) ?>' />\n\n<center>\n<p>\n<table width='98%'>\n\n <tr>\n  <td colspan='4' align='center'>\n   &nbsp;<br>\n   <b><?php echo xlt('Generate Letter regarding ') . text($patdata['fname']) . \" \" .\n    text($patdata['lname']) . \" (\" . text($patdata['pubpid']) . \")\" ?></b>\n    <br>&nbsp;\n  </td>\n </tr>\n\n <tr>\n\n  <td class='control-label'>\n    <?php echo xlt('From'); ?>:\n  </td>\n\n  <td>\n   <select name='form_from' class='form-control'>\n<?php echo $optfrom; ?>\n   </select>\n  </td>\n\n  <td class='control-label'>\n    <?php echo xlt('Date'); ?>:\n  </td>\n\n  <td>\n   <input type='text' size='10' name='form_date' id='form_date' class='datepicker form-control'\n    value='<?php echo attr(oeFormatShortDate(date('Y-m-d'))); ?>'\n    title='<?php echo xlt('Date of this letter'); ?>' />\n  </td>\n\n </tr>\n\n <tr>\n\n  <td class='control-label'>\n    <?php echo xlt('Specialty'); ?>:\n  </td>\n\n  <td>\n   <select name='form_specialty' onchange='newspecialty()' class='form-control'>\n<?php echo $optspec; ?>\n   </select>\n  </td>\n\n  <td class='control-label'>\n    <?php echo xlt('Template'); ?>:\n  </td>\n\n  <td>\n   <select name=\"form_template\" id=\"form_template\" class='form-control'>\n   <option value=\"\">(<?php echo xlt('none'); ?>)</option>\n<?php\n$tpldir = $GLOBALS['OE_SITE_DIR'] . \"/letter_templates\";\n$dh = opendir($tpldir);\nif (! $dh) {\n    die(xlt('Cannot read') . ' ' . $tpldir);\n}\n\nwhile (false !== ($tfname = readdir($dh))) {\n  // skip dot-files, scripts and images\n    if (preg_match(\"/^\\./\", $tfname)) {\n        continue;\n    }\n\n    if (preg_match(\"/\\.php$/\", $tfname)) {\n        continue;\n    }\n\n    if (preg_match(\"/\\.jpg$/\", $tfname)) {\n        continue;\n    }\n\n    if (preg_match(\"/\\.png$/\", $tfname)) {\n        continue;\n    }\n\n    echo \"<option value='\" . attr($tfname) . \"'\";\n    if (($tfname == $_POST['form_template']) || ($tfname == $_GET['template'])) {\n        echo \" SELECTED\";\n    }\n\n    echo \">\";\n    if ($tfname == 'autosaved') {\n        echo xlt($tfname);\n    } else {\n        echo text($tfname);\n    }\n\n    echo \"</option>\";\n}\n\nclosedir($dh);\n?>\n   </select>\n  </td>\n\n </tr>\n\n </tr>\n\n <tr>\n\n  <td class='control-label'>\n    <?php echo xlt('To'); ?>:\n  </td>\n\n  <td>\n   <select name='form_to' class='form-control'>\n<?php echo $optto; ?>\n   </select>\n  </td>\n\n  <td class='control-label'>\n    <?php echo xlt('Print Format'); ?>:\n  </td>\n\n  <td>\n   <select name='form_format' class='form-control'>\n    <option value='html'><?php echo xlt('HTML'); ?></option>\n    <option value='pdf'><?php echo xlt('PDF'); ?></option>\n   </select>\n  </td>\n\n </tr>\n\n <tr>\n  <td colspan='4'>\n    <div id=\"letter_toolbar\" class='text' style=\"width: 100%; background-color: #ddd; padding: 5px; margin: 0px;\">\n    <span class='control-label'><?php echo xlt('Insert special field'); ?>:</span>\n    <select id=\"letter_field\" class='form-control'>\n    <option value=\"\">- <?php echo xlt('Choose'); ?> -</option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['DATE'].'}'; ?>\"><?php echo xlt('Today\\'s Date'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_TITLE'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Title'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_FNAME'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('First name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_MNAME'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Middle name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_LNAME'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Last name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_STREET'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Street'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_CITY'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('City'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_STATE'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('State'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_POSTAL'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Postal Code'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_VALEDICTORY'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Valedictory'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_PHONECELL'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Cell Phone'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_PHONE'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('Phone'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['FROM_EMAIL'].'}'; ?>\"><?php echo xlt('FROM'); ?> - <?php echo xlt('email'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_TITLE'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Title'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_FNAME'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('First name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_MNAME'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Middle name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_LNAME'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Last name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_STREET'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Street'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_CITY'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('City'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_STATE'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('State'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_POSTAL'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Postal Code'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_VALEDICTORY'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Valedictory'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_ORGANIZATION'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Organization'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_FAX'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Fax number'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_PHONE'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Phone number'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['TO_PHONECELL'].'}'; ?>\"><?php echo xlt('TO'); ?> - <?php echo xlt('Cell phone number'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_FNAME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('First name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_MNAME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Middle name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_LNAME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Last name'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_STREET'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Street'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_CITY'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('City'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_STATE'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('State'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_POSTAL'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Postal Code'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_PHONE_HOME'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Phone Home'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_PHONE_CELL'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Phone Cell'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_SSN'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('SSN'); ?></option>\n    <option value=\"<?php echo '{'.$FIELD_TAG['PT_DOB'].'}'; ?>\"><?php echo xlt('PATIENT'); ?> - <?php echo xlt('Date of birth'); ?></option>\n    </select>\n    </div>\n   <textarea name='form_body' id=\"form_body\" class='form-control' rows='20' cols='30' style='width:100%'\n    title='<?php echo xla('Enter body of letter here'); ?>' /><?php echo text($bodytext); ?></textarea>\n  </td>\n </tr>\n\n</table>\n\n<div class=\"btn-group\" role=\"group\">\n    <button type='button' class='addtemplate btn btn-default btn-save'><?php echo xlt('Save as New'); ?></button>\n    <button type='button' class='btn btn-default btn-save' name='savetemplate' id=\"savetemplate\"><?php echo xlt('Save Changes'); ?></button>\n    <button type='button' class='btn btn-default btn-transmit' name='form_generate' id=\"form_generate\"><?php echo xlt('Generate Letter'); ?></button>\n</div>\n\n</center>\n\n<!-- template DIV that appears when user chooses to add a new letter template -->\n<div id=\"newtemplatedetail\" style=\"margin-top: 4em; display: none; visibility: hidden;\">\n    <span class='control-label'><?php echo xlt('Template Name'); ?>:</span> <input type=\"textbox\" size=\"20\" maxlength=\"30\" name=\"newtemplatename\" id=\"newtemplatename\" class=\"form-control\">\n    <br>\n    <div class=\"btn-group\" role=\"group\">\n        <button type=\"button\" class=\"savenewtemplate btn btn-default btn-save\"><?php echo xlt('Save new template'); ?></button>\n        <button type=\"button\" class=\"cancelnewtemplate btn btn-link btn-cancel\"><?php echo xlt('Cancel'); ?></button>\n    </div>\n</div>\n\n</form>\n</body>\n\n<script language='JavaScript'>\n\n// jQuery stuff to make the page a little easier to use\n\n$(document).ready(function(){\n    $(\"#form_generate\").click(function() { $(\"#formaction\").val(\"generate\"); $(\"#theform\").submit(); });\n    $(\"#form_template\").change(function() { $(\"#formaction\").val(\"loadtemplate\"); $(\"#theform\").submit(); });\n\n    $(\"#savetemplate\").click(function() { SaveTemplate(this); });\n\n    $(\"#letter_field\").change(function() { insertAtCursor(document.getElementById(\"form_body\"), $(this).val()); $(this).attr(\"selectedIndex\", \"0\"); });\n\n    $(\".addtemplate\").click(function() { AddTemplate(this); });\n    $(\".savenewtemplate\").click(function() { SaveNewTemplate(this); });\n    $(\".deletetemplate\").click(function() { DeleteTemplate(this); });\n    $(\".cancelnewtemplate\").click(function() { CancelNewTemplate(this); });\n\n    $('.datepicker').datetimepicker({\n        <?php $datetimepicker_timepicker = false; ?>\n        <?php $datetimepicker_showseconds = false; ?>\n        <?php $datetimepicker_formatInput = true; ?>\n        <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n        <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n    });\n\n    // display the 'new group' DIV\n    var AddTemplate = function(btnObj) {\n        // show the field details DIV\n        $('#newtemplatedetail').css('visibility', 'visible');\n        $('#newtemplatedetail').css('display', 'block');\n        $(btnObj).parent().append($(\"#newtemplatedetail\"));\n        $('#newtemplatedetail > #newtemplatename').focus();\n        $(window).scrollTop($(document).height());\n    };\n\n    // save the new template\n    var SaveNewTemplate = function(btnObj) {\n        // the template name can only have letters, numbers, spaces and underscores\n        // AND it cannot start with a number\n        if ($(\"#newtemplatename\").val().match(/^\\d+/)) {\n            alert(\"<?php echo xls('Template names cannot start with numbers.'); ?>\");\n            return false;\n        }\n        var validname = $(\"#newtemplatename\").val().replace(/[^A-za-z0-9]/g, \"_\"); // match any non-word characters and replace them\n        $(\"#newtemplatename\").val(validname);\n\n        // submit the form to add a new field to a specific group\n        $(\"#formaction\").val(\"newtemplate\");\n        $(\"#theform\").submit();\n    }\n\n    // actually delete a template file\n/*\n    var DeleteTemplate = function(btnObj) {\n        var parts = $(btnObj).attr(\"id\");\n        var groupname = parts.replace(/^\\d+/, \"\");\n        if (confirm(\"WARNING - This action cannot be undone.\\n Are you sure you wish to delete the entire group named '\"+groupname+\"'?\")) {\n            // submit the form to add a new field to a specific group\n            $(\"#formaction\").val(\"deletegroup\");\n            $(\"#deletegroupname\").val(parts);\n            $(\"#theform\").submit();\n        }\n    };\n*/\n\n    // just hide the new template DIV\n    var CancelNewTemplate = function(btnObj) {\n        // hide the field details DIV\n        $('#newtemplatedetail').css('visibility', 'hidden');\n        $('#newtemplatedetail').css('display', 'none');\n        // reset the new group values to a default\n        $('#newtemplatedetail > #newtemplatename').val(\"\");\n    };\n\n\n    // save the template, overwriting the older version\n    var SaveTemplate = function(btnObj) {\n        if (! confirm(\"<?php echo xls('You are about to permanently replace the existing template. Are you sure you wish to continue?'); ?>\")) {\n            return false;\n        }\n        $(\"#formaction\").val(\"savetemplate\");\n        $(\"#theform\").submit();\n    }\n});\n\n</script>\n\n</html>\n", "<?php\n/**\n * add_transaction is a misnomer, as this script will now also edit\n * existing transactions.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017-2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../../globals.php\");\nrequire_once(\"$srcdir/transactions.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\nrequire_once(\"$srcdir/amc.php\");\n\nuse OpenEMR\\Core\\Header;\n\n// This can come from the URL if it's an Add.\n$title   = empty($_REQUEST['title']) ? 'LBTref' : $_REQUEST['title'];\n$form_id = $title;\n\n// Plugin support.\n$fname = $GLOBALS['OE_SITE_DIR'] . \"/LBF/\" . convert_safe_file_dir_name($form_id) . \".plugin.php\";\nif (file_exists($fname)) {\n    include_once($fname);\n}\n\n$transid = empty($_REQUEST['transid']) ? 0 : $_REQUEST['transid'] + 0;\n$mode    = empty($_POST['mode' ]) ? '' : $_POST['mode' ];\n// $inmode    = $_GET['inmode'];\n$body_onload_code = \"\";\n\n// Load array of properties for this layout and its groups.\n$grparr = array();\ngetLayoutProperties($form_id, $grparr);\n\nif ($mode) {\n    $sets = \"title = ?, user = ?, groupname = ?, authorized = ?, date = NOW()\";\n    $sqlBindArray = array($form_id, $_SESSION['authUser'], $_SESSION['authProvider'], $userauthorized);\n\n    if ($transid) {\n        array_push($sqlBindArray, $transid);\n        sqlStatement(\"UPDATE transactions SET $sets WHERE id = ?\", $sqlBindArray);\n    } else {\n        array_push($sqlBindArray, $pid);\n        $sets .= \", pid = ?\";\n        $newid = sqlInsert(\"INSERT INTO transactions SET $sets\", $sqlBindArray);\n    }\n\n    $fres = sqlStatement(\"SELECT * FROM layout_options \" .\n    \"WHERE form_id = ? AND uor > 0 AND field_id != '' \" .\n    \"ORDER BY group_id, seq\", array($form_id));\n\n    while ($frow = sqlFetchArray($fres)) {\n        $data_type = $frow['data_type'];\n        $field_id  = $frow['field_id'];\n        $value = get_layout_form_value($frow);\n\n        if ($transid) { // existing form\n            if ($value === '') {\n                $query = \"DELETE FROM lbt_data WHERE \" .\n                \"form_id = ? AND field_id = ?\";\n                sqlStatement($query, array($transid, $field_id));\n            } else {\n                $query = \"REPLACE INTO lbt_data SET field_value = ?, \" .\n                \"form_id = ?, field_id = ?\";\n                sqlStatement($query, array($value, $transid, $field_id));\n            }\n        } else { // new form\n            if ($value !== '') {\n                sqlStatement(\n                    \"INSERT INTO lbt_data \" .\n                    \"( form_id, field_id, field_value ) VALUES ( ?, ?, ? )\",\n                    array($newid, $field_id, $value)\n                );\n            }\n        }\n    }\n\n    if (!$transid) {\n        $transid = $newid;\n    }\n\n  // Set the AMC sent records flag\n    if (!(empty($_POST['send_sum_flag']))) {\n        // add the sent records flag\n        processAmcCall('send_sum_amc', true, 'add', $pid, 'transactions', $transid);\n        if (!(empty($_POST['send_sum_elec_flag']))) {\n            processAmcCall('send_sum_elec_amc', true, 'add', $pid, 'transactions', $transid);\n        }\n    } else {\n        // remove the sent records flags\n        processAmcCall('send_sum_amc', true, 'remove', $pid, 'transactions', $transid);\n        processAmcCall('send_sum_elec_amc', true, 'remove', $pid, 'transactions', $transid);\n    }\n\n    $body_onload_code = \"javascript:location.href='transactions.php';\";\n}\n\n$CPR = 4; // cells per row\n\nfunction end_cell()\n{\n    global $item_count, $cell_count;\n    if ($item_count > 0) {\n        echo \"</td>\";\n        $item_count = 0;\n    }\n}\n\nfunction end_row()\n{\n    global $cell_count, $CPR;\n    end_cell();\n    if ($cell_count > 0) {\n        for (; $cell_count < $CPR;\n        ++$cell_count) {\n            echo \"<td></td>\";\n        }\n\n        echo \"</tr>\\n\";\n        $cell_count = 0;\n    }\n}\n\nfunction end_group()\n{\n    global $last_group;\n    if (strlen($last_group) > 0) {\n        end_row();\n        echo \" </table>\\n\";\n        echo \"</div>\\n\";\n    }\n}\n\n// If we are editing a transaction, get its ID and data.\n$trow = $transid ? getTransById($transid) : array();\n?>\n<html>\n<head>\n\n<title><?php echo xlt('Add/Edit Patient Transaction'); ?></title>\n\n<?php Header::setupHeader(['common','datetime-picker']); ?>\n\n<?php include_once(\"{$GLOBALS['srcdir']}/options.js.php\"); ?>\n\n<script type=\"text/javascript\">\n$(document).ready(function() {\n  if(window.tabbify){\n    tabbify();\n  }\n  if (window.checkSkipConditions) {\n    checkSkipConditions();\n  }\n});\n\nvar mypcc = '<?php echo htmlspecialchars($GLOBALS['phone_country_code'], ENT_QUOTES); ?>';\n\n$(document).ready(function(){\n  $(\"#send_sum_flag\").click(function() {\n    if ( $('#send_sum_flag').prop('checked') ) {\n      // Enable the send_sum_elec_flag checkbox\n      $(\"#send_sum_elec_flag\").removeAttr(\"disabled\");\n    }\n    else {\n      //Disable the send_sum_elec_flag checkbox (also uncheck it if applicable)\n      $(\"#send_sum_elec_flag\").attr(\"disabled\", true);\n      $(\"#send_sum_elec_flag\").prop(\"checked\", false);\n    }\n  });\n\n  $('.datepicker').datetimepicker({\n    <?php $datetimepicker_timepicker = false; ?>\n    <?php $datetimepicker_showseconds = false; ?>\n    <?php $datetimepicker_formatInput = true; ?>\n    <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n    <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n  });\n  $('.datetimepicker').datetimepicker({\n    <?php $datetimepicker_timepicker = true; ?>\n    <?php $datetimepicker_showseconds = false; ?>\n    <?php $datetimepicker_formatInput = true; ?>\n    <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n    <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n  });\n});\n\nfunction titleChanged() {\n var sel = document.forms[0].title;\n // Layouts must not interfere with each other. Reload the document in Add mode.\n top.restoreSession();\n location.href = 'add_transaction.php?title=' + sel.value;\n return true;\n}\n\nfunction divclick(cb, divid) {\n var divstyle = document.getElementById(divid).style;\n if (cb.checked) {\n  divstyle.display = 'block';\n } else {\n  divstyle.display = 'none';\n }\n return true;\n}\n\n// The ID of the input element to receive a found code.\nvar current_sel_name = '';\n\n// This is for callback by the find-code popup.\n// Appends to or erases the current list of related codes.\nfunction set_related(codetype, code, selector, codedesc) {\n var frc = document.forms[0][current_sel_name];\n var s = frc.value;\n if (code) {\n  if (s.length > 0) s += ';';\n  s += codetype + ':' + code;\n } else {\n  s = '';\n }\n frc.value = s;\n}\n\n// This invokes the find-code popup.\nfunction sel_related(e) {\n current_sel_name = e.name;\n dlgopen('../encounter/find_code_popup.php<?php if ($GLOBALS['ippf_specific']) {\n        echo '?codetype=REF';\n} ?>', '_blank', 500, 400);\n}\n\n// Process click on Delete link.\nfunction deleteme() {\n// onclick='return deleteme()'\n dlgopen('../deleter.php?transaction=<?php echo htmlspecialchars($transid, ENT_QUOTES); ?>', '_blank', 500, 450);\n return false;\n}\n\n// Called by the deleteme.php window on a successful delete.\nfunction imdeleted() {\n top.restoreSession();\n location.href = 'transaction/transactions.php';\n}\n\n// Compute the length of a string without leading and trailing spaces.\nfunction trimlen(s) {\n var i = 0;\n var j = s.length - 1;\n for (; i <= j && s.charAt(i) == ' '; ++i);\n for (; i <= j && s.charAt(j) == ' '; --j);\n if (i > j) return 0;\n return j + 1 - i;\n}\n\n// Validation logic for form submission.\nfunction validate(f) {\n var errCount = 0;\n var errMsgs = new Array();\n\n    <?php generate_layout_validation($form_id); ?>\n\n var msg = \"\";\n msg += \"<?php echo xla('The following fields are required'); ?>:\\n\\n\";\n for ( var i = 0; i < errMsgs.length; i++ ) {\n    msg += errMsgs[i] + \"\\n\";\n }\n msg += \"\\n<?php echo xla('Please fill them in before continuing.'); ?>\";\n\n if ( errMsgs.length > 0 ) {\n    alert(msg);\n }\n\n return errMsgs.length < 1;\n}\n\nfunction submitme() {\n var f = document.forms['new_transaction'];\n if (validate(f)) {\n  top.restoreSession();\n  f.submit();\n }\n}\n\n<?php if (function_exists($form_id . '_javascript')) {\n    call_user_func($form_id . '_javascript');\n} ?>\n\n</script>\n\n<style type=\"text/css\">\n.form-control {\n    width: auto;\n    display: inline;\n    height: auto;\n}\ndiv.tab {\n    height: auto;\n    width: auto;\n}\n</style>\n\n</head>\n<body class=\"body_top\" onload=\"<?php echo $body_onload_code; ?>\" >\n<form name='new_transaction' method='post' action='add_transaction.php?transid=<?php echo attr($transid); ?>' onsubmit='return validate(this)'>\n<input type='hidden' name='mode' value='add'>\n\n    <div class=\"container-fluid\">\n        <div class=\"row\">\n            <div class=\"col-xs-12\">\n                <div class=\"page-header\">\n                    <h1><?php echo xlt('Add/Edit Patient Transaction');?></h1>\n                </div>\n            </div>\n            <div class=\"col-xs-12\">\n                <div class=\"btn-group\">\n                    <a href=\"#\" class=\"btn btn-default btn-save\" onclick=\"submitme();\">\n                        <?php echo xlt('Save'); ?>\n                    </a>\n                    <a href=\"transactions.php\" class=\"btn btn-link btn-cancel\" onclick=\"top.restoreSession()\">\n                        <?php echo xlt('Cancel'); ?>\n                    </a>\n                </div>\n                <hr>\n            </div>\n        </div>\n    </div>\n\n    <table class=\"text\">\n        <tr><td>\n        <?php echo xlt('Transaction Type'); ?>:&nbsp;</td><td>\n<?php\n$ttres = sqlStatement(\"SELECT grp_form_id, grp_title \" .\n  \"FROM layout_group_properties WHERE \" .\n  \"grp_form_id LIKE 'LBT%' AND grp_group_id = '' ORDER BY grp_seq, grp_title\");\necho \"<select name='title' id='title' onchange='titleChanged()'>\\n\";\nwhile ($ttrow = sqlFetchArray($ttres)) {\n    $thisid = $ttrow['grp_form_id'];\n    echo \"<option value='\" . attr($thisid) . \"'\";\n    if ($thisid == $form_id) {\n        echo ' selected';\n    }\n    echo \">\" . text($ttrow['grp_title']) . \"</option>\\n\";\n}\necho \"</select>\\n\";\n?>\n        </td></tr>\n    </table>\n\n<div id='referdiv'>\n\n    <?php if ($GLOBALS['enable_amc_prompting'] && 'LBTref' == $form_id) { ?>\n        <div style='float:right;margin-right:25px;border-style:solid;border-width:1px;'>\n            <div style='float:left;margin:5px 5px 5px 5px;'>\n\n                <?php // Display the send records checkboxes (AMC prompting)\n                    $itemAMC = amcCollect(\"send_sum_amc\", $pid, 'transactions', $transid);\n                    $itemAMC_elec = amcCollect(\"send_sum_elec_amc\", $pid, 'transactions', $transid);\n                ?>\n\n                <?php if (!(empty($itemAMC))) { ?>\n                    <input type=\"checkbox\" id=\"send_sum_flag\" name=\"send_sum_flag\" checked>\n                <?php } else { ?>\n                    <input type=\"checkbox\" id=\"send_sum_flag\" name=\"send_sum_flag\">\n                <?php } ?>\n\n                <span class=\"text\"><?php echo xlt('Sent Summary of Care?') ?></span><br>\n\n                <?php if (!(empty($itemAMC)) && !(empty($itemAMC_elec))) { ?>\n                    &nbsp;&nbsp;<input type=\"checkbox\" id=\"send_sum_elec_flag\" name=\"send_sum_elec_flag\" checked>\n                <?php } else if (!(empty($itemAMC))) { ?>\n                    &nbsp;&nbsp;<input type=\"checkbox\" id=\"send_sum_elec_flag\" name=\"send_sum_elec_flag\">\n                <?php } else { ?>\n                    &nbsp;&nbsp;<input type=\"checkbox\" id=\"send_sum_elec_flag\" name=\"send_sum_elec_flag\" disabled>\n                <?php } ?>\n\n                <span class=\"text\"><?php echo xlt('Sent Summary of Care Electronically?') ?></span><br>\n\n            </div>\n        </div>\n    <?php } ?>\n\n                    <div id=\"DEM\">\n                        <ul class=\"tabNav\">\n<?php\n$fres = sqlStatement(\"SELECT * FROM layout_options \" .\n  \"WHERE form_id = ? AND uor > 0 \" .\n  \"ORDER BY group_id, seq\", array($form_id));\n$last_group = '';\n\nwhile ($frow = sqlFetchArray($fres)) {\n    $this_group = $frow['group_id'];\n    // Handle a data category (group) change.\n    if (strcmp($this_group, $last_group) != 0) {\n        $group_seq  = substr($this_group, 0, 1);\n        $group_name = $grparr[$this_group]['grp_title'];\n        $last_group = $this_group;\n        if ($group_seq == 1) {\n            echo \"<li class='current'>\";\n        } else {\n            echo \"<li class=''>\";\n        }\n\n        $group_seq_esc = attr($group_seq);\n        $group_name_show = text(xl_layout_label($group_name));\n        echo \"<a href='#' id='div_$group_seq_esc'>\" .\n        \"$group_name_show</a></li>\";\n    }\n}\n?>\n                        </ul>\n                        <div class=\"tabContainer\">\n<?php\n$fres = sqlStatement(\"SELECT * FROM layout_options \" .\n  \"WHERE form_id = ? AND uor > 0 \" .\n  \"ORDER BY group_id, seq\", array($form_id));\n\n$last_group = '';\n$cell_count = 0;\n$item_count = 0;\n$display_style = 'block';\n$condition_str = '';\n\nwhile ($frow = sqlFetchArray($fres)) {\n    $this_group = $frow['group_id'];\n    $titlecols  = $frow['titlecols'];\n    $datacols   = $frow['datacols'];\n    $data_type  = $frow['data_type'];\n    $field_id   = $frow['field_id'];\n    $list_id    = $frow['list_id'];\n\n    // Accumulate action conditions into a JSON expression for the browser side.\n    accumActionConditions($field_id, $condition_str, $frow['conditions']);\n\n    $currvalue  = '';\n    if (isset($trow[$field_id])) {\n        $currvalue = $trow[$field_id];\n    }\n\n    // Handle special-case default values.\n    if (!$currvalue && !$transid && $form_id == 'LBTref') {\n        if ($field_id == 'refer_date') {\n            $currvalue = date('Y-m-d');\n        } else if ($field_id == 'body' && $transid > 0) {\n             $tmp = sqlQuery(\"SELECT reason FROM form_encounter WHERE \" .\n              \"pid = ? ORDER BY date DESC LIMIT 1\", array($pid));\n            if (!empty($tmp)) {\n                $currvalue = $tmp['reason'];\n            }\n        }\n    }\n\n    // Handle a data category (group) change.\n    if (strcmp($this_group, $last_group) != 0) {\n        end_group();\n        $group_seq  = substr($this_group, 0, 1);\n        $group_name = $grparr[$this_group]['grp_title'];\n        $last_group = $this_group;\n        $group_seq_esc = attr($group_seq);\n        if ($group_seq == 1) {\n            echo \"<div class='tab current' id='div_$group_seq_esc'>\";\n        } else {\n            echo \"<div class='tab' id='div_$group_seq_esc'>\";\n        }\n\n        echo \" <table border='0' cellpadding='0'>\\n\";\n        $display_style = 'none';\n    }\n\n    // Handle starting of a new row.\n    if (($titlecols > 0 && $cell_count >= $CPR) || $cell_count == 0) {\n        end_row();\n        echo \" <tr>\";\n    }\n\n    if ($item_count == 0 && $titlecols == 0) {\n        $titlecols = 1;\n    }\n\n    // Handle starting of a new label cell.\n    if ($titlecols > 0) {\n        end_cell();\n        $titlecols_esc = attr($titlecols);\n        echo \"<td width='70' valign='top' colspan='$titlecols_esc'\";\n        echo ($frow['uor'] == 2) ? \" class='required'\" : \" class='bold'\";\n        if ($cell_count == 2) {\n            echo \" style='padding-left:10pt'\";\n        }\n\n        // This ID is used by action conditions.\n        echo \" id='label_id_\" . attr($field_id) . \"'\";\n        echo \">\";\n        $cell_count += $titlecols;\n    }\n\n    ++$item_count;\n\n    echo \"<b>\";\n\n    // Modified 6-09 by BM - Translate if applicable\n    if ($frow['title']) {\n        echo (text(xl_layout_label($frow['title'])) . \":\");\n    } else {\n        echo \"&nbsp;\";\n    }\n\n     echo \"</b>\";\n\n    // Handle starting of a new data cell.\n    if ($datacols > 0) {\n        end_cell();\n        $datacols_esc = attr($datacols);\n        echo \"<td valign='top' colspan='$datacols_esc' class='text'\";\n        // This ID is used by action conditions.\n        echo \" id='value_id_\" . attr($field_id) . \"'\";\n        if ($cell_count > 0) {\n            echo \" style='padding-left:5pt'\";\n        }\n\n        echo \">\";\n        $cell_count += $datacols;\n    }\n\n    ++$item_count;\n    generate_form_field($frow, $currvalue);\n    echo \"</div>\";\n}\n\nend_group();\n?>\n</div></div>\n</div>\n</form>\n<p />\n\n<!-- include support for the list-add selectbox feature -->\n<?php include $GLOBALS['fileroot'].\"/library/options_listadd.inc\"; ?>\n\n</body>\n\n<script language=\"JavaScript\">\n\n// Array of action conditions for the checkSkipConditions() function.\nvar skipArray = [\n<?php echo $condition_str; ?>\n];\n\n<?php echo $date_init; ?>\n// titleChanged();\n<?php\nif (function_exists($form_id . '_javascript_onload')) {\n    call_user_func($form_id . '_javascript_onload');\n}\n?>\n\n</script>\n\n</html>\n", "<?php\n/**\n * personalize.php\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Eldho Chacko <eldho@zhservices.com>\n * @author    Jacob T Paul <jacob@zhservices.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2011 Z&H Consultancy Services Private Limited <sam@zhservices.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\nrequire_once(\"../../interface/globals.php\");\n$list_id = $_REQUEST['list_id'] ? $_REQUEST['list_id'] : $_REQUEST['filter_context'];\n\nuse OpenEMR\\Core\\Header;\n\nfunction Delete_Rows($id)\n{\n    sqlStatement(\"DELETE FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($id, $_SESSION['authId']));\n}\n\nfunction Insert_Rows($id, $order = \"\")\n{\n    sqlStatement(\"REPLACE INTO template_users (tu_template_id,tu_user_id,tu_template_order) VALUES (?,?,?)\", array($id, $_SESSION['authId'], $order));\n}\n\nif (isset($_REQUEST['submitform']) && $_REQUEST['submitform'] == 'save') {\n    $topersonalized = $_REQUEST['topersonalized'];\n    $personalized = $_REQUEST['personalized'];\n    foreach ($topersonalized as $key => $value) {\n        $arr = explode(\"|\", $value);\n        $res = sqlStatement(\"SELECT * FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($arr[0], $_SESSION['authId']));\n        if (sqlNumRows($res)) {\n            Delete_Rows($arr[0]);\n            $qry = sqlStatement(\"SELECT * FROM customlists WHERE cl_list_id=? AND cl_deleted=0\", array($arr[0]));\n            while ($row = sqlFetchArray($qry)) {\n                Delete_Rows($row['cl_list_slno']);\n            }\n        }\n    }\n\n    //Add new Categories\n    foreach ($personalized as $key => $value) {\n        $arr = explode(\"|\", $value);\n        if ($arr[1]) {\n            $res = sqlStatement(\"SELECT * FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($arr[0], $_SESSION['authId']));\n            Insert_Rows($arr[0]);\n            $qry = sqlStatement(\"SELECT * FROM customlists WHERE cl_list_id=? AND cl_deleted=0\", array($arr[0]));\n            while ($row = sqlFetchArray($qry)) {\n                $qryTU = sqlStatement(\"SELECT * FROM template_users WHERE tu_template_id=? AND tu_user_id=?\", array($row['cl_list_slno'], $arr[1]));\n                while ($rowTU = sqlFetchArray($qryTU)) {\n                    Insert_Rows($rowTU['tu_template_id'], $rowTU['tu_template_order']);\n                }\n            }\n        } else {\n            Insert_Rows($arr[0]);\n            $qry = sqlStatement(\"SELECT * FROM customlists WHERE cl_list_id=? AND cl_deleted=0\", array($arr[0]));\n            while ($row = sqlFetchArray($qry)) {\n                Insert_Rows($row['cl_list_slno'], $row['cl_order']);\n            }\n        }\n    }\n}\n?>\n<html>\n<head>\n\n    <?php Header::setupHeader(['common', 'opener', 'jquery-ui',]); ?>\n\n    <script type=\"text/javascript\">\n\n        function refreshme() {\n            top.restoreSession();\n            document.location.reload();\n        }\n\n        $(document).ready(function () {\n\n            tabbify();\n\n            $(\".iframe_small\").on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                dlgopen('', '', 400, 170, '', '', {\n                    buttons: [\n                        {text: '<?php echo xla('Close'); ?>', close: true, style: 'default btn-sm'}\n                    ],\n                    onClosed: 'refreshme',\n                    type: 'iframe',\n                    url: $(this).attr('href')\n                });\n            });\n\n            $(\".iframe_medium\").on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                dlgopen('', '', 450, 250, '', '', {\n                    buttons: [\n                        {text: '<?php echo xla('Close'); ?>', close: true, style: 'default btn-sm'}\n                    ],\n                    onClosed: 'refreshme',\n                    type: 'iframe',\n                    url: $(this).attr('href')\n                });\n            });\n\n            $(\".iframe_abvmedium\").on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                dlgopen('', '', 700, 500, '', '', {\n                    buttons: [\n                        {text: '<?php echo xla('Close'); ?>', close: true, style: 'default btn-sm'}\n                    ],\n                    onClosed: 'refreshme',\n                    type: 'iframe',\n                    url: $(this).attr('href')\n                });\n            });\n\n        });\n\n        function check_user_category(form, selectFrom, selectedList) {\n            top.restoreSession();\n            var total_selected = form.elements[selectedList].length - 1;\n            var msg = '';\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    if (document.getElementById('filter_users').value) {\n                        $.ajax({\n                            type: \"POST\",\n                            url: \"ajax_code.php\",\n                            dataType: \"html\",\n                            data: {\n                                item: form.elements[selectedList].options[total_selected].value,\n                                list_id: document.getElementById('filter_users').value,\n                                source: \"check_item\"\n                            },\n                            async: false,\n                            success: function (thedata) {\n                                if (thedata == 'OK') {\n                                    total_clients = form.elements[selectFrom].length;\n                                    opt = new Option(form.elements[selectedList].options[total_selected].text, form.elements[selectedList].options[total_selected].value);\n                                    form.elements[selectFrom].options[total_clients] = opt;\n                                    form.elements[selectedList].options[total_selected] = null;\n                                }\n                                else {\n                                    msg += form.elements[selectedList].options[total_selected].text + \"\\n\";\n                                }\n                            },\n                            error: function () {\n                                alert(\"fail\");\n                            }\n                        });\n                    }\n                    else {\n                        total_clients = form.elements[selectFrom].length;\n                        opt = new Option(form.elements[selectedList].options[total_selected].text, form.elements[selectedList].options[total_selected].value);\n                        form.elements[selectFrom].options[total_clients] = opt;\n                        form.elements[selectedList].options[total_selected] = null;\n                    }\n                }\n            }\n            jsub_sortNow(form.elements[selectFrom]);\n            if (msg != '') {\n                if (confirm(\"<?php echo addslashes(xl('The following categories will be removed from your category List'));?> \\n\" + msg + \"\\n <?php echo addslashes(xl('Do you want to continue?'));?>\")) {\n                    remove_selected(form, selectedList);\n                }\n            }\n            return;\n        }\n\n        function remove_selected(form, selectedList) {\n            top.restoreSession();\n            var total_selected = form.elements[selectedList].length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    form.elements[selectedList].options[total_selected] = null;\n                }\n            }\n            jsub_sortNow(form.elements[selectFrom]);\n            return;\n        }\n\n        function all_selected(selectedList) {\n            top.restoreSession();\n            var total_selected = document.getElementById(selectedList).length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                document.getElementById(selectedList).options[total_selected].selected = true;\n            }\n        }\n\n        function all_deselected(selectedList) {\n            top.restoreSession();\n            var total_selected = document.getElementById(selectedList).length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                document.getElementById(selectedList).options[total_selected].selected = false;\n            }\n        }\n\n        function jsub_selected(form, selectFrom, selectedList) {\n            top.restoreSession();\n            var total_selected = form.elements[selectedList].length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    total_clients = form.elements[selectFrom].length;\n                    opt = new Option(form.elements[selectedList].options[total_selected].text, form.elements[selectedList].options[total_selected].value);\n                    form.elements[selectFrom].options[total_clients] = opt;\n                    form.elements[selectedList].options[total_selected] = null;\n                }\n            }\n            jsub_sortNow(form.elements[selectFrom]);\n            return;\n        }\n\n        function display_category_item(form, selectedList) {\n            top.restoreSession();\n            var len = 0;\n            var selectedval = '';\n            var total_selected = form.elements[selectedList].length - 1;\n            for (total_selected; total_selected >= 0; total_selected--) {\n                if (form.elements[selectedList].options[total_selected].selected) {\n                    selectedval = form.elements[selectedList].options[total_selected].value;\n                    len++;\n                }\n            }\n            if (len > 1) {\n                document.getElementById('itemdiv').style.display = 'none';\n            }\n            else if (len == 1) {\n                document.getElementById('itemdiv').style.display = '';\n                $.ajax({\n                    type: \"POST\",\n                    url: \"ajax_code.php\",\n                    dataType: \"html\",\n                    data: {\n                        list_id: selectedval,\n                        source: \"item_show\"\n                    },\n                    async: false,\n                    success: function (thedata) {\n                        document.getElementById('itemdiv').innerHTML = thedata;\n                    },\n                    error: function () {\n                        alert(\"fail\");\n                    }\n                });\n                return;\n            }\n        }\n\n        function jsub_sortNow(obj) {\n            top.restoreSession();\n            var len = obj.length - 1;\n            var text = new Array();\n            var values = new Array();\n            var sortarr = new Array();\n            for (var i = len; i >= 0; i--) {\n                text[i] = obj.options[i].text;\n                values[i] = obj.options[i].value;\n                sortarr[i] = obj.options[i].text;\n            }\n            sortarr.sort();\n            obj.length = 0;\n            for (i = 0; i <= len; i++) {\n                for (j = 0; j <= len; j++) {\n                    if (sortarr[i] == text[j]) {\n                        break;\n                    }\n                }\n                opt = new Option(text[j], values[j]);\n                obj.options[i] = opt;\n            }\n        }\n\n        function personalize_save() {\n            top.restoreSession();\n            document.getElementById('submitform').value = 'save';\n            all_selected('topersonalized');\n            all_selected('personalized');\n            document.myform.submit();\n        }\n    </script>\n</head>\n<body class=\"body_top\">\n<form name=\"myform\" method=\"post\" onsubmit=\"top.restoreSession();\">\n    <fieldset>\n        <legend><span class=\"text\"><?php echo htmlspecialchars(xl('Filter'), ENT_QUOTES); ?></span></legend>\n        <table>\n            <tr class=\"text\">\n                <td><?php echo htmlspecialchars(xl('Context'), ENT_QUOTES); ?></td>\n                <td>\n                    <select name='filter_context' id='filter_context' onchange='javascript:document.myform.submit();'>\n                        <option value=''><?php echo htmlspecialchars(xl('Select a Context'), ENT_QUOTES); ?></option>\n                        <?php\n                        $context_sql = \"SELECT * FROM customlists WHERE cl_list_type=2 AND cl_deleted=0\";\n                        $context_res = sqlStatement($context_sql);\n                        while ($context_row = sqlFetchArray($context_res)) {\n                            echo \"<option value='\" . htmlspecialchars($context_row['cl_list_slno'], ENT_QUOTES) . \"' \";\n                            echo ($_REQUEST['filter_context'] == $context_row['cl_list_slno']) ? 'selected' : '';\n                            echo \">\" . htmlspecialchars($context_row['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                        }\n                        ?>\n                    </select>\n                </td>\n                <td><?php echo htmlspecialchars(xl('Users'), ENT_QUOTES); ?></td>\n                <td>\n                    <select name='filter_users' id='filter_users' onchange='javascript:document.myform.submit();'>\n                        <option value=''><?php echo htmlspecialchars(xl('Select a User'), ENT_QUOTES); ?></option>\n                        <?php\n                        $user_sql = \"SELECT DISTINCT(tu.tu_user_id),u.fname,u.lname FROM template_users AS tu LEFT OUTER JOIN users AS u ON tu.tu_user_id=u.id WHERE tu.tu_user_id!=?\";\n                        $user_res = sqlStatement($user_sql, array($_SESSION['authId']));\n                        while ($user_row = sqlFetchArray($user_res)) {\n                            echo \"<option value='\" . htmlspecialchars($user_row['tu_user_id'], ENT_QUOTES) . \"' \";\n                            echo ($_REQUEST['filter_users'] == $user_row['tu_user_id']) ? 'selected' : '';\n                            echo \">\" . htmlspecialchars($user_row['fname'] . \" \" . $user_row['lname'], ENT_QUOTES) . \"</option>\";\n                        }\n                        ?>\n                    </select>\n                </td>\n            </tr>\n        </table>\n    </fieldset>\n    <table align=\"center\" width=\"100%\">\n        <tr class=\"text\">\n            <td colspan=\"3\">\n                <a href=# class=\"css_button\"\n                   onclick=\"top.restoreSession();personalize_save()\"><span><?php echo htmlspecialchars(xl('Save'), ENT_QUOTES); ?></span></a>\n                <?php\n                if (acl_check('nationnotes', 'nn_configure')) {\n                    ?>\n                    <a href=\"delete_category.php\" id=\"share_link\" class=\"iframe_medium css_button\"\n                       onclick=\"top.restoreSession();\"><span><?php echo htmlspecialchars(xl('Delete Category'), ENT_QUOTES); ?></span></a>\n                    <?php\n                }\n                ?>\n                <?php\n                if (acl_check('nationnotes', 'nn_configure')) {\n                    ?>\n                    <a href=\"add_template.php?list_id=<?php echo attr($_REQUEST['list_id']); ?>\"\n                       onclick=\"top.restoreSession();\" class=\"iframe_small css_button\"\n                       title=\"<?php echo htmlspecialchars(xl('Add Category'), ENT_QUOTES); ?>\"><span><?php echo htmlspecialchars(xl('Add Category'), ENT_QUOTES); ?></span></a>\n                    <?php\n                }\n                ?>\n                <?php\n                if (acl_check('nationnotes', 'nn_configure')) {\n                    ?>\n                    <a href=\"add_context.php\" class=\"iframe_medium css_button\" onclick=\"top.restoreSession();\"\n                       title=\"<?php echo htmlspecialchars(xl('Add Context'), ENT_QUOTES); ?>\"><span><?php echo htmlspecialchars(xl('Add Context'), ENT_QUOTES); ?></span></a>\n                    <?php\n                }\n                ?>\n        <tr class=\"text\">\n            <th><?php echo htmlspecialchars(xl('Available categories'), ENT_QUOTES); ?></th>\n            <th>&nbsp;</th>\n            <?php\n            $user = sqlQuery(\"SELECT * FROM users WHERE id=?\", array($_SESSION['authId']));\n            ?>\n            <th><?php echo htmlspecialchars(xl('Categories for') . \" \" . $user['fname'] . \" \" . $user['lname'], ENT_QUOTES); ?></th>\n        </tr>\n        <tr class=\"text\">\n            <td align=right>\n                <select multiple name=\"topersonalized[]\" id=\"topersonalized\" size=\"6\" style=\"width:220px\"\n                        onchange=\"display_category_item(document.myform,'topersonalized');\">\n                    <?php\n                    $where = '';\n                    $join = '';\n                    $arval = array($_SESSION['authId']);\n                    $arval1 = array($_REQUEST['filter_users'], $_SESSION['authId']);\n                    if ($_REQUEST['filter_context']) {\n                        $where .= \" AND cl_list_id=?\";\n                        array_push($arval, $_REQUEST['filter_context']);\n                        array_push($arval1, $_REQUEST['filter_context']);\n                    }\n                    $sql = \"SELECT * FROM template_users AS tu LEFT OUTER JOIN customlists AS c ON tu.tu_template_id=c.cl_list_slno\n                                    WHERE cl_list_type=3 AND cl_deleted=0 AND tu.tu_template_id NOT IN (SELECT tu_template_id FROM template_users AS tuser WHERE\n                                    tu_user_id=?) \" .\n                        $where .\n                        \" ORDER BY cl_list_id,tu_user_id,cl_list_item_long\";\n                    $resTemplates = sqlStatement($sql, $arval);\n                    if ($_REQUEST['filter_users']) {\n                        $sql = \" SELECT * FROM template_users AS tu LEFT OUTER JOIN customlists AS c ON tu.tu_template_id=c.cl_list_slno WHERE\n                                tu.tu_user_id=? AND c.cl_list_type=3 AND cl_deleted=0 AND tu.tu_template_id NOT IN\n                                (SELECT tu_template_id FROM template_users AS tuser WHERE tu_user_id=?)\" .\n                            $where .\n                            \"ORDER BY cl_list_id,tu_user_id,c.cl_list_item_long\";\n                        $resTemplates = sqlStatement($sql, $arval1);\n                    }\n                    while ($rowTemplates = sqlFetchArray($resTemplates)) {\n                        $cntxt = '';\n                        if (!$_REQUEST['filter_context']) {\n                            $context = sqlQuery(\"SELECT * FROM customlists WHERE cl_list_slno=?\", array($rowTemplates['cl_list_id']));\n                            $cntxt .= $context['cl_list_item_long'] . \"->\";\n                        }\n                        if (!$_REQUEST['filter_users']) {\n                            $context = sqlQuery(\"SELECT * FROM users WHERE id=?\", array($rowTemplates['tu_user_id']));\n                            $cntxt .= $context['username'] . \"->\";\n                        }\n                        echo \"<option value='\" . htmlspecialchars($rowTemplates['cl_list_slno'] . \"|\" . $rowTemplates['tu_user_id'], ENT_QUOTES) . \"'>\" . htmlspecialchars($cntxt . $rowTemplates['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                    }\n                    $sqlorphan = \"SELECT * FROM customlists WHERE cl_list_type=3 AND cl_deleted=0 AND cl_list_slno \" .\n                        \" NOT IN (SELECT DISTINCT tu_template_id FROM template_users) \" .\n                        $where .\n                        \" ORDER BY cl_list_id,cl_list_item_long\";\n                    $resorphan = sqlStatement($sqlorphan);\n                    while ($roworphan = sqlFetchArray($resorphan)) {\n                        $cntxt = '';\n                        if (!$_REQUEST['filter_context']) {\n                            $context = sqlQuery(\"SELECT * FROM customlists WHERE cl_list_slno=?\", array($roworphan['cl_list_id']));\n                            $cntxt .= $context['cl_list_item_long'] . \"->\";\n                        }\n                        echo \"<option value='\" . htmlspecialchars($roworphan['cl_list_slno'] . \"|\", ENT_QUOTES) . \"'>\" . htmlspecialchars($cntxt . $roworphan['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                    }\n                    ?>\n                </select>\n            </td>\n            <td align=\"center\">\n                <input type=\"button\" name=\"remove\" value=&raquo;\n                       onclick=\"jsub_selected(document.myform,'personalized','topersonalized')\"></br>\n                <input type=\"button\" name=\"remove\" value=&laquo;\n                       onclick=\"check_user_category(document.myform,'topersonalized','personalized')\">\n            </td>\n            <td align=left>\n                <select multiple name=\"personalized[]\" id=\"personalized\" size=\"6\" style=\"width:220px\">\n                    <?php\n                    $where = '';\n                    if ($_REQUEST['filter_context']) {\n                        $where .= \" AND cl_list_id='\" . $_REQUEST['filter_context'] . \"'\";\n                    }\n                    $sql = \"SELECT * FROM template_users AS tu LEFT OUTER JOIN customlists AS c ON tu.tu_template_id=c.cl_list_slno WHERE\n                                tu.tu_user_id=? AND c.cl_list_type=3 AND cl_deleted=0 \" .\n                        $where .\n                        \"ORDER BY c.cl_list_item_long\";\n                    $resTemplates = sqlStatement($sql, array($_SESSION['authId']));\n                    while ($rowTemplates = sqlFetchArray($resTemplates)) {\n                        $cntxt = '';\n                        if (!$_REQUEST['filter_context']) {\n                            $context = sqlQuery(\"SELECT * FROM customlists WHERE cl_list_slno=?\", array($rowTemplates['cl_list_id']));\n                            $cntxt .= $context['cl_list_item_long'] . \"->\";\n                        }\n                        echo \"<option value='\" . htmlspecialchars($rowTemplates['cl_list_slno'] . \"|\" . $rowTemplates['tu_user_id'], ENT_QUOTES) . \"'>\" . htmlspecialchars($cntxt . $rowTemplates['cl_list_item_long'], ENT_QUOTES) . \"</option>\";\n                    }\n                    ?>\n                </select>\n            </td>\n        </tr>\n        <tr class=\"text\">\n            <td>&nbsp;</td>\n            <td>&nbsp;</td>\n            <td><input type=\"hidden\" name=\"submitform\" id=\"submitform\" value=\"\"></td>\n        </tr>\n        <tr class=\"text\">\n            <td colspan=\"3\">\n                <div style=\"width:100%;overflow:auto;height:150px\" id=\"itemdiv\"></div>\n            </td>\n        </tr>\n    </table>\n</form>\n</body>\n</html>\n", "<?php\n/**\n* Function to check and/or sanitize things for security such as\n* directories names, file names, etc.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @author    Roberto Vasquez <robertogagliotta@gmail.com>\n * @author    Shachar Zilbershlag <shaharzi@matrix.co.il>\n * @copyright Copyright (c) 2012-2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n\n// If the label contains any illegal characters, then the script will die.\nfunction check_file_dir_name($label)\n{\n    if (empty($label) || preg_match('/[^A-Za-z0-9_.-]/', $label)) {\n        error_log(\"ERROR: The following variable contains invalid characters:\" . $label);\n        die(xlt(\"ERROR: The following variable contains invalid characters\").\": \". attr($label));\n    }\n}\n\n// Convert all illegal characters to _\nfunction convert_safe_file_dir_name($label)\n{\n    return preg_replace('/[^A-Za-z0-9_.-]/', '_', $label);\n}\n\n//Basename functionality for nonenglish languages (without this, basename function omits nonenglish characters).\nfunction basename_international($path)\n{\n    $parts = preg_split('~[\\\\\\\\/]~', $path);\n    foreach ($parts as $key => $value) {\n        $encoded = urlencode($value);\n        $parts[$key] = $encoded;\n    }\n\n    $encoded_path = implode(\"/\", $parts);\n    $encoded_file_name = basename($encoded_path);\n    $decoded_file_name = urldecode($encoded_file_name);\n\n    return $decoded_file_name;\n}\n\n\n/**\n * This function detects a MIME type for a file and check if it in the white list of the allowed mime types.\n * @param string $file - file location.\n * @param array|null $whiteList - array of mime types that allowed to upload.\n */\n// Regarding the variable below. In the case of multiple file upload the isWhiteList function will run multiple\n// times, therefore, storing the white list in the variable below to prevent multiple requests from database.\n$white_list = null;\nfunction isWhiteFile($file)\n{\n    global $white_list;\n    if (is_null($white_list)) {\n        $white_list = array();\n        $lres = sqlStatement(\"SELECT option_id FROM list_options WHERE list_id = 'files_white_list' AND activity = 1\");\n        while ($lrow = sqlFetchArray($lres)) {\n            $white_list[] = $lrow['option_id'];\n        }\n    }\n\n    $mimetype  = mime_content_type($file);\n    if (in_array($mimetype, $white_list)) {\n        return true;\n    } else {\n        $splitMimeType = explode('/', $mimetype);\n        $categoryType = $splitMimeType[0];\n        if (in_array($categoryType. '/*', $white_list)) {\n            return true;\n        }\n    }\n\n    return false;\n}\n\n// Sanitize a value to ensure it is a number.\nfunction sanitizeNumber($number)\n{\n    $clean_number = $number +0 ;\n\n    if ($clean_number==$number) {\n        return $clean_number;\n    } else {\n        error_log('Custom validation error: Parameter contains non-numeric value (A numeric value expected)');\n        return $clean_number;\n    }\n}\n"], "filenames": ["interface/billing/get_claim_file.php", "interface/billing/sl_eob_process.php", "interface/billing/sl_eob_search.php", "interface/de_identification_forms/find_code_popup.php", "interface/de_identification_forms/find_immunization_popup.php", "interface/fax/fax_dispatch.php", "interface/forms/CAMOS/view.php", "interface/forms/reviewofs/view.php", "interface/main/finder/finder_navigation.php", "interface/orders/types.php", "interface/patient_file/letter.php", "interface/patient_file/transaction/add_transaction.php", "library/custom_template/personalize.php", "library/sanitize.inc.php"], "buggy_code_start_loc": [2, 2, 5, 2, 2, 10, 3, 11, 2, 3, 2, 10, 2, 6], "buggy_code_end_loc": [26, 747, 716, 243, 195, 31, 75, 44, 23, 256, 270, 28, 357, 32], "fixing_code_start_loc": [2, 2, 4, 2, 2, 10, 3, 11, 2, 3, 2, 10, 2, 6], "fixing_code_end_loc": [32, 751, 709, 239, 191, 37, 77, 44, 34, 260, 296, 28, 344, 32], "type": "NVD-CWE-noinfo", "message": "interface/patient_file/letter.php in OpenEMR before 5.0.1 allows remote authenticated users to bypass intended access restrictions via the newtemplatename and form_body parameters.", "other": {"cve": {"id": "CVE-2018-10572", "sourceIdentifier": "cve@mitre.org", "published": "2018-04-30T17:29:00.300", "lastModified": "2019-10-03T00:03:26.223", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "interface/patient_file/letter.php in OpenEMR before 5.0.1 allows remote authenticated users to bypass intended access restrictions via the newtemplatename and form_body parameters."}, {"lang": "es", "value": "interface/patient_file/letter.php en OpenEMR, en versiones anteriores a la 5.0.1, permite que usuarios autenticados remotos omitan las restricciones de acceso planeadas mediante los par\u00e1metros newtemplatename y form_body."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 5.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 4.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "NVD-CWE-noinfo"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:open-emr:openemr:*:*:*:*:*:*:*:*", "versionEndExcluding": "5.0.1", "matchCriteriaId": "2B406066-3E51-4B10-A6FD-663A8F176989"}]}]}], "references": [{"url": "https://csticsfrontline.wordpress.com/2018/05/24/openemr-%E5%BC%B1%E9%BB%9E%E5%88%86%E6%9E%90/", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://github.com/openemr/openemr/commit/699e3c2ef68545357cac714505df1419b8bf2051", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/openemr/openemr/issues/1518", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Third Party Advisory"]}, {"url": "https://github.com/openemr/openemr/pull/1519", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Third Party Advisory"]}, {"url": "https://www.open-emr.org/wiki/index.php/Release_Features#Version_5.0.1", "source": "cve@mitre.org", "tags": ["Vendor Advisory"]}]}, "github_commit_url": "https://github.com/openemr/openemr/commit/699e3c2ef68545357cac714505df1419b8bf2051"}}