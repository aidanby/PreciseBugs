{"buggy_code": ["# Release Notes for Craft CMS 4\n\n## Unreleased\n\n- Date fields with \u201cShow Time Zone\u201d enabled will now remember IANA-formatted time zones set via GraphQL. ([#13893](https://github.com/craftcms/cms/issues/13893))\n- Added `craft\\gql\\types\\DateTime::$setToSystemTimeZone`.\n- `craft\\gql\\types\\DateTime` now supports JSON-encoded objects with `date`, `time`, and `timezone` keys.\n- `craft\\web\\Response::setCacheHeaders()` now includes the `public` directive in the `Cache-Control` header. ([#13922](https://github.com/craftcms/cms/pull/13922))\n- Fixed a bug where <kbd>\u2191</kbd> and <kbd>\u2193</kbd> key presses would set focus to disabled menu options. ([#13911](https://github.com/craftcms/cms/issues/13911))\n- Fixed a bug where elements\u2019 `localized` GraphQL field wasn\u2019t returning any results for drafts or revisions. ([#13924](https://github.com/craftcms/cms/issues/13924))\n- Fixed a bug where dropdown option labels within Table fields weren\u2019t getting translated. ([#13914](https://github.com/craftcms/cms/issues/13914))\n- Fixed a bug where \u201cUpdating search indexes\u201d jobs were getting queued for Matrix block revisions. ([#13917](https://github.com/craftcms/cms/issues/13917))\n- Fixed a bug where control panel resources weren\u2019t getting published on demand. ([#13935](https://github.com/craftcms/cms/issues/13935))\n- Fixed a privilege escalation vulnerability.\n\n## 4.5.10 - 2023-11-07\n\n- Added the `db/drop-table-prefix` command.\n- Top-level disabled related/nested elements are now included in \u201cExtended\u201d element exports. ([#13496](https://github.com/craftcms/cms/issues/13496))\n- Related element validation is no longer recursive. ([#13904](https://github.com/craftcms/cms/issues/13904))\n- Addresses\u2019 owner elements are now automatically set on them during initialization, if they were queried with the `owner` address query param.\n- Entry Title fields are no longer shown when \u201cShow the Title field\u201d is disabled and there\u2019s a validation error on the `title` attribute. ([#13876](https://github.com/craftcms/cms/issues/13876))\n- Improved the reliability of image dimension detection. ([#13886](https://github.com/craftcms/cms/pull/13886))\n- The default backup command for PostgreSQL no longer passes in `--column-inserts` to `pg_dump`.\n- Log contexts now include the environment name. ([#13882](https://github.com/craftcms/cms/pull/13882))\n- Added `craft\\web\\AssetManager::$cacheSourcePaths`.\n- Fixed a bug where disclosure menus could be positioned off-screen on mobile.\n- Fixed a bug where element edit pages could show a context menu when it wasn\u2019t necessary.\n- Fixed a bug where the \u201cDelete entry for this site\u201d action wasn\u2019t deleting the canonical entry for the selected site, when editing a provisional draft.\n- Fixed an error that occurred when cropping an image that was missing its dimension info. ([#13884](https://github.com/craftcms/cms/issues/13884))\n- Fixed an error that occurred if a filesystem didn\u2019t have any settings. ([#13883](https://github.com/craftcms/cms/pull/13883))\n- Fixed a bug where related element validation wansn\u2019t ensuring that related elements were loaded in the same site as the source element when possible. ([#13907](https://github.com/craftcms/cms/issues/13907))\n- Fixed a bug where sites weren\u2019t always getting queried in the same order, if multiple sites\u2019 `sortOrder` values were the same. ([#13896](https://github.com/craftcms/cms/issues/13896))\n\n## 4.5.9 - 2023-10-23\n\n- Fixed a bug where it was possible to change the status for entries that didn\u2019t show the Status field, via bulk editing. ([#13854](https://github.com/craftcms/cms/issues/13854))\n- Fixed a PHP error that could occur when editing elements via slideouts. ([#13867](https://github.com/craftcms/cms/issues/13867))\n- Fixed an error that could occur if no `storage/` folder existed.\n\n## 4.5.8 - 2023-10-20\n\n- Improved the styling and accessibility of revision pages. ([#13857](https://github.com/craftcms/cms/pull/13857), [#13850](https://github.com/craftcms/cms/issues/13850))\n- Added the `focalPoint` argument to asset save mutations. ([#13846](https://github.com/craftcms/cms/discussions/13846))\n- The `up` command now accepts a `--no-backup` option.\n- `{% cache %}` tags now store any `<meta>` tags registered with `yii\\web\\View::registerMetaTag()`. ([#13832](https://github.com/craftcms/cms/issues/13832))\n- Added `craft\\errors\\ExitException`.\n- Added `craft\\web\\View::startMetaTagBuffer()`.\n- Added `craft\\web\\View::clearMetaTagBuffer()`.\n- Added support for modifying the application config via a global `craft_modify_app_config()` function. ([#13855](https://github.com/craftcms/cms/pull/13855))\n- Fixed a bug where `{% exit %}` tags without a status code weren\u2019t outputting any HTML that had already been output in the template. ([#13848](https://github.com/craftcms/cms/discussions/13848))\n- Fixed a bug where it wasn\u2019t possible to Ctrl/Command-click on multiple elements to select them. ([#13853](https://github.com/craftcms/cms/issues/13853))\n\n## 4.5.7 - 2023-10-17\n\n- Field containers are no longer focusable unless a corresponding validation message is clicked on. ([#13782](https://github.com/craftcms/cms/issues/13782))\n- Improved element save performance.\n- Added `pgpassword` and `pwd` to the list of keywords that Craft will look for when determining whether a value is sensitive and should be redacted from logs, etc.\n- Added `craft\\events\\DefineCompatibleFieldTypesEvent`.\n- Added `craft\\services\\Fields::EVENT_DEFINE_COMPATIBLE_FIELD_TYPES`. ([#13793](https://github.com/craftcms/cms/discussions/13793))\n- Added `craft\\web\\assets\\inputmask\\InputmaskAsset`.\n- `craft\\web\\Request::accepts()` now supports wildcard (e.g. `application/*`). ([#13759](https://github.com/craftcms/cms/issues/13759))\n- `Craft.ElementEditor` instances are now configured with an `elementId` setting, which is kept up-to-date when a provisional draft is created. ([#13795](https://github.com/craftcms/cms/discussions/13795))\n- Added `Garnish.isPrimaryClick()`.\n- Fixed a bug where relational fields\u2019 element selector modals weren\u2019t always getting set to the correct site per the field\u2019s \u201cRelate entries from a specific site?\u201d setting. ([#13750](https://github.com/craftcms/cms/issues/13750))\n- Fixed a bug where Dropdown fields weren\u2019t visible when viewing revisions and other static forms. ([#13753](https://github.com/craftcms/cms/issues/13753), [craftcms/commerce#3270](https://github.com/craftcms/commerce/issues/3270))\n- Fixed a bug where the `defaultDirMode` config setting wasn\u2019t being respected when the `storage/runtime/` and `storage/logs/` folders were created. ([#13756](https://github.com/craftcms/cms/issues/13756))\n- Fixed a bug where the \u201cSave and continue editing\u201d action wasn\u2019t working on Edit User pages if they contained a Money field. ([#13760](https://github.com/craftcms/cms/issues/13760))\n- Fixed a bug where relational fields\u2019 validation messages weren\u2019t using the actual field name. ([#13807](https://github.com/craftcms/cms/issues/13807))\n- Fixed a bug where element editor slideouts were appearing behind element selector modals within Live Preview. ([#13798](https://github.com/craftcms/cms/issues/13798))\n- Fixed a bug where element URIs weren\u2019t getting updated for propagated sites automatically. ([#13812](https://github.com/craftcms/cms/issues/13812))\n- Fixed a bug where dropdown input labels could overflow out of their containers. ([#13817](https://github.com/craftcms/cms/issues/13817))\n- Fixed a bug where the `transformGifs` and `transformSvgs` config settings weren\u2019t always being respected when using `@transform` GraphQL directives. ([#13808](https://github.com/craftcms/cms/issues/13808))\n- Fixed a bug where Composer operations were sorting `require` packages differently than how Composer does it natively, when `config.sort-packages` was set to `true`. ([#13806](https://github.com/craftcms/cms/issues/13806))\n- Fixed a MySQL error that could occur when creating a Plain Text field with a high charcter limit. ([#13781](https://github.com/craftcms/cms/pull/13781))\n- Fixed a bug where entries weren\u2019t always being treated as live for View and Preview buttons, when editing a non-primary site. ([#13746](https://github.com/craftcms/cms/issues/13746))\n- Fixed a bug where Ctrl-clicks were being treated as primary clicks in some browsers. ([#13823](https://github.com/craftcms/cms/issues/13823))\n- Fixed a bug where some language options were showing \u201cfalse\u201d hints. ([#13837](https://github.com/craftcms/cms/issues/13837))\n- Fixed a bug where Craft was tracking changes to elements when they were being resaved. ([#13761](https://github.com/craftcms/cms/issues/13761))\n- Fixed a bug where sensitive keywords weren\u2019t getting redacted from log contexts.\n- Fixed RCE vulnerabilities.\n\n## 4.5.6.1 - 2023-09-27\n\n- Crossdomain JavaScript resources are now loaded via a proxy action.\n- Fixed JavaScript errors that could occur after loading new UI components over Ajax. ([#13751](https://github.com/craftcms/cms/issues/13751))\n\n## 4.5.6 - 2023-09-26\n\n- When slideouts are opened within Live Preview, they now slide up over the editor pane, rather than covering the preview pane. ([#13739](https://github.com/craftcms/cms/pull/13739))\n- Cross-site validation now only involves fields which were actually modified in the element save. ([#13675](https://github.com/craftcms/cms/discussions/13675))\n- Row headings within Table fields now get statically translated. ([#13703](https://github.com/craftcms/cms/discussions/13703))\n- Element condition settings within field layout components now display a warning if the `autosaveDrafts` config setting is disabled. ([#12348](https://github.com/craftcms/cms/issues/12348))\n- Added the `resave/addresses` command. ([#13720](https://github.com/craftcms/cms/discussions/13720))\n- The `resave/matrix-blocks` command now supports an `--owner-id` option.\n- Added `craft\\helpers\\App::phpExecutable()`.\n- `craft\\helpers\\Component::createComponent()` now filters out `as X` and `on X` keys from the component config.\n- `craft\\services\\Announcements::push()` now has an `$adminsOnly` argument. ([#13728](https://github.com/craftcms/cms/discussions/13728))\n- `Craft.appendHeadHtml()` and `appendBodyHtml()` now load external scripts asynchronously, and return promises.\n- Improved the reliability of Composer operations when PHP is running via FastCGI. ([#13681](https://github.com/craftcms/cms/issues/13681))\n- Fixed a bug where it wasn\u2019t always possible to create new entries from custom sources which were limited to one section.\n- Fixed a bug where relational fields weren\u2019t factoring in cross-site elements when enforcing their \u201cMin Relations\u201d, \u201cMax Relations\u201d, and \u201cValidate related entries\u201d settings. ([#13699](https://github.com/craftcms/cms/issues/13699))\n- Fixed a bug where pagination wasn\u2019t working for admin tables, if the `onQueryParams` callback method wasn\u2019t set. ([#13677](https://github.com/craftcms/cms/issues/13677))\n- Fixed a bug where relations within Matrix blocks weren\u2019t getting restored when restoring a revision\u2019s content. ([#13626](https://github.com/craftcms/cms/issues/13626))\n- Fixed a bug where the filesystem and volume-creation slideouts could keep reappearing if canceled. ([#13707](https://github.com/craftcms/cms/issues/13707))\n- Fixed an error that could occur when reattempting to update to Craft 4.5. ([#13714](https://github.com/craftcms/cms/issues/13714))\n- Fixed a bug where date and time inputs could be parsed incorrectly, if the user\u2019s formatting locale wasn\u2019t explicitly set, or it changed between page load and form submit. ([#13731](https://github.com/craftcms/cms/issues/13731))\n- Fixed JavaScript errors that could occur when control panel resources were being loaded from a different domain. ([#13715](https://github.com/craftcms/cms/issues/13715))\n- Fixed a PHP error that occurred if the `CRAFT_DOTENV_PATH` environment variable was set, or a console command was executed with the `--dotenvPath` option. ([#13725](https://github.com/craftcms/cms/issues/13725))\n- Fixed a bug where long element titles weren\u2019t always getting truncated in the control panel. ([#13718](https://github.com/craftcms/cms/issues/13718))\n- Fixed a bug where checkboxes could be preselected if they had an empty value. ([#13710](https://github.com/craftcms/cms/issues/13710))\n- Fixed a bug where links in validation summaries weren\u2019t working if the offending field was in a collapsed Matrix block. ([#13708](https://github.com/craftcms/cms/issues/13708))\n- Fixed a bug where cross-site validation could apply even if `craft\\services\\Elements::saveElement()` was called with `$runValidation` set to `false`.\n- Fixed some wonky scrolling behavior on pages where the details pane was shorter than the content pane. ([#13637](https://github.com/craftcms/cms/issues/13637))\n- Fixed a division by zero error. ([#13712](https://github.com/craftcms/cms/issues/13712))\n- Fixed an RCE vulnerability.\n\n## 4.5.5 - 2023-09-14\n\n- Added the `maxGraphqlBatchSize` config setting. ([#13693](https://github.com/craftcms/cms/issues/13693))\n- Fixed a bug where page sidebars and detail panes weren\u2019t scrolling properly if their height was greater than the main content pane height. ([#13637](https://github.com/craftcms/cms/issues/13637))\n- Fixed an error that could occur when changing a field\u2019s type, if a backup table needed to be created to store the old field values. ([#13669](https://github.com/craftcms/cms/issues/13669))\n- Fixed a bug where it wasn\u2019t possible to save blank Dropdown values. ([#13695](https://github.com/craftcms/cms/issues/13695))\n\n## 4.5.4 - 2023-09-12\n\n- Added the `@stripTags` and `@trim` GraphQL directives. ([#9971](https://github.com/craftcms/cms/discussions/9971))\n- Added `SK` to the list of keywords that Craft will look for when determining whether a value is sensitive and should be redacted from logs, etc. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Improved the scrolling behavior for page sidebars and detail panes. ([#13637](https://github.com/craftcms/cms/issues/13637))\n- Filesystem edit pages now have a \u201cSave and continue editing\u201d alternative submit action, and the <kbd>Command</kbd>/<kbd>Ctrl</kbd> + <kbd>S</kbd> keyboard shortcut now redirects back to the edit page. ([#13658](https://github.com/craftcms/cms/pull/13658)) \n- Attribute labels are no longer surrounded by asterisks for front-end validation messages. ([#13640](https://github.com/craftcms/cms/issues/13640))\n- The `|replace` Twig filter now has a `regex` argument, which can be set to `false` to disable regular expression parsing. ([#13642](https://github.com/craftcms/cms/discussions/13642))\n- Added `craft\\events\\DefineUserGroupsEvent`.\n- Added `craft\\services\\Users::EVENT_DEFINE_DEFAULT_USER_GROUPS`. ([#12283](https://github.com/craftcms/cms/issues/12283))\n- Added `craft\\services\\Users::getDefaultUserGroups()`.\n- `craft\\events\\UserAssignGroupEvent` now extends `DefineUserGroupsEvent`, giving it a new `$userGroups` property.\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports `DateTimeImmutable` values. ([#13656](https://github.com/craftcms/cms/issues/13656))\n- `craft\\web\\Response::setCacheHeaders()` no longer includes `public` in the `Cache-Control` header when `$overwrite` is `false`. ([#13676](https://github.com/craftcms/cms/issues/13676))\n- Deprecated `craft\\events\\UserAssignGroupEvent`. `DefineUserGroupsEvent` should be used instead.\n- Fixed a bug where the \u201cActive Trials\u201d section in the Plugin Store cart modal wasn\u2019t listing plugins in trial. ([#13661](https://github.com/craftcms/cms/issues/13661))\n- Fixed a bug where changed fields weren\u2019t being tracked properly when applying a draft for a multi-site entry.\n- `craft\\services\\Elements::duplicateElement()` now supports passing a `siteAttributes` array to the `$attributes` argument, for setting site-specific attributes.\n- Fixed an error that could occur when executing a GraphQL query with fragments. ([#13622](https://github.com/craftcms/cms/issues/13622))\n- Fixed a bug where addresses queried via GraphQL had a `photo` field.\n- Fixed a bug where boolean environment variables weren\u2019t always getting the correct value indicators within Selectize fields. ([#13613](https://github.com/craftcms/cms/issues/13613))\n- Fixed a bug where some system icons were getting black backgrounds when displayed within Vue apps. ([#13632](https://github.com/craftcms/cms/issues/13632))\n- Fixed a bug where the user and address field layouts were getting new UUIDs each time they were saved. ([#13588](https://github.com/craftcms/cms/issues/13588))\n- Fixed an error that could occur if a Money field was set to an array without a `value` key. ([#13648](https://github.com/craftcms/cms/pull/13648))\n- Fixed a bug where relations weren\u2019t getting restored when restoring a revision\u2019s content. ([#13626](https://github.com/craftcms/cms/issues/13626))\n- Fixed a bug where \u201cEntry Type\u201d fields were showing `typeId` labels for admin users with \u201cShow field handles in edit forms\u201d enabled. ([#13627](https://github.com/craftcms/cms/issues/13627))\n- Fixed a bug where Lightswitch fields with only one label weren\u2019t getting the correct padding on the unlabelled side of the container. ([#13629](https://github.com/craftcms/cms/issues/13629))\n- Fixed a bug where the `transformGifs` and `transformSvgs` config settings weren\u2019t always being respected. ([#13624](https://github.com/craftcms/cms/issues/13624), [#13635](https://github.com/craftcms/cms/issues/13635))\n- Fixed a bug where filesystems weren\u2019t requiring the \u201cBase URL\u201d setting to be set. ([#13657](https://github.com/craftcms/cms/pull/13657))\n- Fixed a bug where applying a draft could redirect to the \u201cCurrent\u201d revision on a different site, if a new site had been added on the draft. ([#13668](https://github.com/craftcms/cms/pull/13668))\n- Fixed an error that could occur when changing a field\u2019s type, if a backup table needed to be created to store the old field values. ([#13669](https://github.com/craftcms/cms/issues/13669))\n- Fixed a bug where Matrix blocks that were initially created for a newly-added site within a draft could be lost when applying the draft. ([#13670](https://github.com/craftcms/cms/pull/13670))\n- Fixed a bug where `fill` transform properties weren\u2019t being passed along by `craft\\elements\\Asset::getUrlsBySize()` and `getSrcset()`. ([#13650](https://github.com/craftcms/cms/issues/13650))\n- Fixed a bug where SVG asset icons weren\u2019t visible in Safari. ([#13685](https://github.com/craftcms/cms/issues/13685))\n- Fixed two RCE vulnerabilities.\n\n## 4.5.3 - 2023-08-29\n\n- Fixed a bug where custom fields could be marked as changed within element editor slideouts, if they modified their input values on initialization. ([craftcms/ckeditor#128](https://github.com/craftcms/ckeditor/issues/128))\n- Fixed a bug where elements were getting saved a second time after being converted to a provisional draft within a slideout. ([#13604](https://github.com/craftcms/cms/issues/13604))\n- Fixed a JavaScript error. ([#13605](https://github.com/craftcms/cms/issues/13605))\n- Fixed support for storing PHP session info in the database on PostgreSQL.\n- Fixed a bug where search inputs within element selector modals weren\u2019t getting focus rings.\n- Fixed a bug where boolean menu inputs were initially treating `null` values as `true`.\n- Fixed a bug where boolean menu inputs weren\u2019t toggling other fields. ([#13613](https://github.com/craftcms/cms/issues/13613))\n- Fixed a bug where `Craft.namespaceId()` wasn\u2019t working properly if the namespace ended in a `]` character.\n- Fixed a bug where the `|replace` Twig filter wasn\u2019t identifying regular expressions that contained escaped slashes. ([#13618](https://github.com/craftcms/cms/issues/13618))\n- Fixed a bug where entries that were cloned from a provisional draft weren\u2019t getting propagated to other sites initially. ([#13599](https://github.com/craftcms/cms/issues/13599))\n- Fixed an error that could occur when cloning a multi-site provisional draft that contained nested Matrix/Neo/Super Table blocks.\n\n## 4.5.2 - 2023-08-24\n\n- `craft\\helpers\\UrlHelper::buildQuery()` is no longer deprecated. ([#12796](https://github.com/craftcms/cms/issues/12796))\n- Fixed a bug where control panel notifications weren\u2019t always closing automatically if they contained interactive elements. ([#13591](https://github.com/craftcms/cms/issues/13591))\n- Fixed a bug where default user avatars were getting black backgrounds when displayed within Vue apps. ([#13597](https://github.com/craftcms/cms/issues/13597))\n- Fixed a bug where the Username and Email fields weren\u2019t required for public registrations forms, if \u201cDeactivate users by default\u201d was enabled. ([#13596](https://github.com/craftcms/cms/issues/13596))\n- Fixed a bug where switching sites when editing a global site wasn\u2019t working. ([#12796](https://github.com/craftcms/cms/issues/12796), [#13603](https://github.com/craftcms/cms/issues/13603))\n- Fixed a bug where page shortcuts weren\u2019t working after a related element was saved via a slideout. ([#13601](https://github.com/craftcms/cms/issues/13601))\n\n## 4.5.1 - 2023-08-23\n\n- Control panel notifications no longer block page keyboard shortcuts. ([#13591](https://github.com/craftcms/cms/issues/13591))\n- `Garnish.uiLayerManager.addLayer()` now supports a `bubble` option, which allows non-matching keyboard shortcuts to bubble up to the parent layer.\n- Fixed an error that could occur when Craft was performing a Composer operation, if no `HOME` environment variable was set for PHP. ([#13590](https://github.com/craftcms/cms/issues/13590))\n- Fixed a bug where `craft\\fields\\Matrix::serializeValue()` was setting `fields` keys to a closure. ([#13592](https://github.com/craftcms/cms/issues/13592))\n- Fixed a bug where time values weren\u2019t saving properly for Greek locales. ([#9942](https://github.com/craftcms/cms/issues/9942))\n- Fixed a bug where the \u201cStatus\u201d lightswitch would always be enabled on edit pages for single-site elements. ([#13595](https://github.com/craftcms/cms/issues/13595))\n\n## 4.5.0 - 2023-08-22\n\n### Content Management\n- Entry and category edit pages now show other authors who are currently editing the same element. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Entry and category edit pages now display a notification when the element has been saved by another author. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Entry and category edit pages now display a validation error summary at the top of the page, including a mention of errors from other sites. ([#11569](https://github.com/craftcms/cms/issues/11569), [#12125](https://github.com/craftcms/cms/pull/12125))\n- Table fields can now have a \u201cRow heading\u201d column. ([#13231](https://github.com/craftcms/cms/pull/13231))\n- Table fields now have a \u201cStatic Rows\u201d setting. ([#13231](https://github.com/craftcms/cms/pull/13231))\n- Table fields no longer show a heading row, if all heading values are blank. ([#13231](https://github.com/craftcms/cms/pull/13231))\n- Element slideouts now show their sidebar content full-screen for elements without a field layout, rather than having an empty body. ([#13056](https://github.com/craftcms/cms/pull/13056), [#13053](https://github.com/craftcms/cms/issues/13053))\n- Relational fields no longer track the previously-selected element(s) when something outside the field is clicked on. ([#13123](https://github.com/craftcms/cms/issues/13123))\n- Element indexes now use field layouts\u2019 overridden field labels, if all field layouts associated with an element source use the same label. ([#8903](https://github.com/craftcms/cms/discussions/8903))\n- Element indexes now track souces\u2019 filters in the URL, so they can be sharable and persisted when navigating back to the index page via the browser history. ([#13499](https://github.com/craftcms/cms/pull/13499))\n- Users\u2019 default thumbnails are now the user initials over a unique color gradient. ([#13511](https://github.com/craftcms/cms/pull/13511))\n- Improved the styling and max height of Selectize inputs. ([#13065](https://github.com/craftcms/cms/discussions/13065), [#13176](https://github.com/craftcms/cms/pull/13176))\n- Selectize inputs now support click-and-drag selection. ([#13273](https://github.com/craftcms/cms/discussions/13273))\n- Selectize single-select inputs now automatically select the current value on focus. ([#13273](https://github.com/craftcms/cms/discussions/13273))\n- It\u2019s now possible to create new entries from entry select modals when a custom source is selected, if the source is configured to only show entries from one section. ([#11499](https://github.com/craftcms/cms/discussions/11499))\n- The Entries index page now shows a primary \u201cNew entry\u201d button when a custom source is selected, if the source is configured to only show entries from one section. ([#13390](https://github.com/craftcms/cms/discussions/13390))\n- Invalid Dropdown fields now automatically select their default option and get marked as changed (if they have a default option). ([#13540](https://github.com/craftcms/cms/pull/13540))\n\n### Accessibility\n- Image assets\u2019 thumbnails and `<img>` tags generated via `craft\\element\\Asset::getImg()` no longer use the assets\u2019 titles as `alt` fallback values. ([#12854](https://github.com/craftcms/cms/pull/12854))\n- Element index pages now have visually-hidden \u201cSources\u201d headings for screen readers. ([#12961](https://github.com/craftcms/cms/pull/12961))\n- Element metadata fields now have visually-hidden \u201cMetadata\u201d headings for screen readers. ([#12961](https://github.com/craftcms/cms/pull/12961))\n- Structure elements within element indexes now convey their levels to screen readers. ([#13020](https://github.com/craftcms/cms/pull/13020))\n- Non-image asset thumbnails in the control panel now have `alt` attributes set to the file extension. ([#12724](https://github.com/craftcms/cms/pull/12724))\n- Improved copy-text buttons for screen readers. ([#13073](https://github.com/craftcms/cms/pull/13073))\n- Improved the contrast of asset file type icons. ([#13262](https://github.com/craftcms/cms/pull/13262))\n\n### Administration\n- Added the \u201cSlug Translation Method\u201d setting to entry types. ([#8962](https://github.com/craftcms/cms/discussions/8962), [#13291](https://github.com/craftcms/cms/pull/13291))\n- Added the \u201cShow the Status field\u201d setting to entry types. ([#12837](https://github.com/craftcms/cms/discussions/12837), [#13265](https://github.com/craftcms/cms/pull/13265))\n- Added the `setup/cloud` command, which prepares a Craft install to be deployed to Craft Cloud.\n- Added the `setup/message-tables` command, which can be run to set the project up for database-stored static translations via [DbMessageSource](https://www.yiiframework.com/doc/api/2.0/yii-i18n-dbmessagesource). ([#13542](https://github.com/craftcms/cms/pull/13542))\n- Entry types created via the `entrify/global-set` command now have \u201cShow the Status field\u201d disabled by default. ([#12837](https://github.com/craftcms/cms/discussions/12837))\n- Added the `defaultCountryCode` config setting. ([#13478](https://github.com/craftcms/cms/discussions/13478))\n- Custom element sources can now be configured to only appear for certain sites. ([#13344](https://github.com/craftcms/cms/discussions/13344))\n- The \u201cMy Account\u201d page no longer shows a \u201cRequire a password reset on next login\u201d checkbox.\n- The Asset Indexes utility no longer shows the \u201cCache remote images\u201d option on ephemeral environments. ([#13202](https://github.com/craftcms/cms/issues/13202))\n- It\u2019s now possible to configure UK addresses to show a \u201cCounty\u201d field. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- The \u201cLogin Page Logo\u201d and \u201cSite Icon\u201d general settings\u2019 image previews now have checkered backgrounds. ([#13210](https://github.com/craftcms/cms/discussions/13210), [#13229](https://github.com/craftcms/cms/pull/13229))\n- Empty field layout tabs are no longer pruned out. ([#13132](https://github.com/craftcms/cms/issues/13132))\n- `active`, `addresses`, `admin`, `email`, `friendlyName`, `locked`, `name`, `password`, `pending`, `suspended`, and `username` are now reserved user field handles. ([#13579](https://github.com/craftcms/cms/issues/13579))\n\n### Development\n- Added a new `_globals` global Twig variable for front-end templates, which can be used to store custom values in a global scope. ([#13050](https://github.com/craftcms/cms/pull/13050), [#12951](https://github.com/craftcms/cms/discussions/12951))\n- The `|replace` Twig filter now supports passing in a hash with regular expression keys. ([#12956](https://github.com/craftcms/cms/issues/12956))\n- `{% exit %}` tags now support passing a message after the status code. ([#13166](https://github.com/craftcms/cms/discussions/13166))\n- Built-in element types\u2019 GraphQL queries now support passing `null` to `relatedToAssets`, `relatedToEntries`, `relatedToUsers`, `relatedToCategories`, `relatedToTags`, and `relatedToAll` arguments. ([#7954](https://github.com/craftcms/cms/issues/7954))\n- Elements now include custom field values when being iterated over, and when being merged. ([#13009](https://github.com/craftcms/cms/issues/13009))\n- Dropdown and Radio Buttons fields now have a \u201cColumn Type\u201d setting, which will be set to `varchar` for existing fields, and defaults to \u201cAutomatic\u201d for new fields. ([#13025](https://github.com/craftcms/cms/pull/13025), [#12954](https://github.com/craftcms/cms/issues/12954))\n- Successful `users/login` JSON responses now include information about the logged-in user. ([#13374](https://github.com/craftcms/cms/discussions/13374))\n\n### Extensibility\n- Filesystem types can now register custom file uploaders. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- When applying a draft, the canonical elements\u2019 `getDirtyAttributes()` and `getDirtyFields()` methods now return the attribute names and field handles that were modified on the draft for save events. ([#12967](https://github.com/craftcms/cms/issues/12967))\n- Admin tables can be configured to pass custom query params to the data endpoint. ([#13416](https://github.com/craftcms/cms/pull/13416))\n- Admin tables can now be programatically reloaded. ([#13416](https://github.com/craftcms/cms/pull/13416))\n- Admin table properties are now reactive. ([#13558](https://github.com/craftcms/cms/pull/13558), [#13520](https://github.com/craftcms/cms/discussions/13520))\n- Native element sources can now define a `defaultFilter` key, which defines the default filter condition that should be applied when the source is selected. ([#13499](https://github.com/craftcms/cms/pull/13499))\n- Added `craft\\addresses\\SubdivisionRepository`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\base\\Element::showStatusField()`. ([#13265](https://github.com/craftcms/cms/pull/13265))\n- Added `craft\\base\\Element::thumbSvg()`. ([#13262](https://github.com/craftcms/cms/pull/13262))\n- Added `craft\\base\\ElementInterface::getIsSlugTranslatable()`.\n- Added `craft\\base\\ElementInterface::getSlugTranslationDescription()`.\n- Added `craft\\base\\ElementInterface::getSlugTranslationKey()`.\n- Added `craft\\base\\ElementInterface::getThumbHtml()`.\n- Added `craft\\base\\ElementInterface::modifyCustomSource()`.\n- Added `craft\\base\\ElementInterface::setDirtyFields()`.\n- Added `craft\\base\\ElementInterface::setFieldValueFromRequest()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\base\\FieldInterface::normalizeValueFromRequest()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\base\\FieldLayoutProviderInterface`. ([#13250](https://github.com/craftcms/cms/pull/13250))\n- Added `craft\\base\\FsInterface::getShowHasUrlSetting()`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\base\\FsInterface::getShowUrlSetting()`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\base\\FsTrait::$showHasUrlSetting`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\base\\FsTrait::$showUrlSetting`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\behaviors\\EventBehavior`. ([#13502](https://github.com/craftcms/cms/discussions/13502))\n- Added `craft\\controllers\\AssetsControllerTrait`.\n- Added `craft\\elements\\db\\ElementQuery::EVENT_BEFORE_POPULATE_ELEMENT`.\n- Added `craft\\events\\AssetBundleEvent`.\n- Added `craft\\events\\DefineAddressSubdivisionsEvent`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\events\\MoveElementEvent::$action`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\events\\MoveElementEvent::$targetElementId`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\events\\MoveElementEvent::getTargetElement()`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\gql\\GqlEntityRegistry::getOrCreate()`. ([#13354](https://github.com/craftcms/cms/pull/13354))\n- Added `craft\\helpers\\Assets::iconSvg()`.\n- Added `craft\\helpers\\StringHelper::escapeShortcodes()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\helpers\\StringHelper::unescapeShortcodes()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\models\\FieldLayout::$provider`. ([#13250](https://github.com/craftcms/cms/pull/13250))\n- Added `craft\\services\\Addresses::$formatter`, which can be used to override the default address formatter. ([#13242](https://github.com/craftcms/cms/pull/13242), [#12615](https://github.com/craftcms/cms/discussions/12615))\n- Added `craft\\services\\Addresses::EVENT_DEFINE_ADDRESS_SUBDIVISIONS`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\services\\Addresses::defineAddressSubdivisions()`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\services\\Elements::collectCacheInfoForElement()`.\n- Added `craft\\services\\Elements::getRecentActivity()`. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Added `craft\\services\\Elements::trackActivity()`. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Added `craft\\services\\ProjectConfig::$cacheDuration`. ([#13164](https://github.com/craftcms/cms/issues/13164))\n- Added `craft\\services\\Structures::ACTION_APPEND`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::ACTION_PLACE_AFTER`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::ACTION_PLACE_BEFORE`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::ACTION_PREPEND`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::EVENT_AFTER_INSERT_ELEMENT`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::EVENT_BEFORE_INSERT_ELEMENT`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\web\\Controller::EVENT_DEFINE_BEHAVIORS`. ([#13477](https://github.com/craftcms/cms/pull/13477))\n- Added `craft\\web\\Controller::defineBehaviors()`. ([#13477](https://github.com/craftcms/cms/pull/13477))\n- Added `craft\\web\\CpScreenResponseBehavior::$errorSummary`, `errorSummary()`, and `errorSummaryTemplate()`. ([#12125](https://github.com/craftcms/cms/pull/12125))\n- Added `craft\\web\\CpScreenResponseBehavior::$pageSidebar`, `pageSidebar()`, and `pageSidebarTemplate()`. ([#13019](https://github.com/craftcms/cms/pull/13019), [#12795](https://github.com/craftcms/cms/issues/12795))\n- Added `craft\\web\\CpScreenResponseBehavior::$slideoutBodyClass`.\n- Added `craft\\web\\Response::$defaultFormatters`. ([#13541](https://github.com/craftcms/cms/pull/13541))\n- Added `craft\\web\\View::EVENT_AFTER_REGISTER_ASSET_BUNDLE`.\n- `craft\\elements\\actions\\NewChild` is no longer triggerable on elements that have a `data-disallow-new-children` attribute. ([#13539](https://github.com/craftcms/cms/discussions/13539))\n- `craft\\elements\\actions\\SetStatus` is no longer triggerable on elements that have a `data-disallow-status` attribute.\n- `craft\\helpers\\Cp::selectizeFieldHtml()`, `selectizeHtml()`, and `_includes/forms/selectize.twig` now support a `multi` param. ([#13176](https://github.com/craftcms/cms/pull/13176))\n- `craft\\helpers\\Typecast::properties()` now supports backed enum values. ([#13371](https://github.com/craftcms/cms/pull/13371))\n- `craft\\services\\Assets::getRootFolderByVolumeId()` now ensures the root folder actually exists, and caches its results internally, improving performance. ([#13297](https://github.com/craftcms/cms/issues/13297))\n- `craft\\services\\Assets::getThumbUrl()` now has an `$iconFallback` argument, which can be set to `false` to prevent a file icon URL from being returned as a fallback for assets that don\u2019t have image thumbnails.\n- `craft\\services\\Assets::getAllDescendantFolders()` now has an `$asTree` argument. ([#13535](https://github.com/craftcms/cms/discussions/13535))\n- `craft\\services\\Structures::EVENT_BEFORE_MOVE_ELEMENT` is now cancellable. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- `craft\\validators\\UniqueValidator` now supports setting an additional filter via the `filter` property. ([#12941](https://github.com/craftcms/cms/pull/12941))\n- `craft\\web\\Response::setCacheHeaders()` now has `$duration` and `$overwrite` arguments.\n- `craft\\web\\Response::setNoCacheHeaders()` now has an `$overwrite` argument.\n- `craft\\web\\UrlManager` no longer triggers its `EVENT_REGISTER_CP_URL_RULES` and `EVENT_REGISTER_SITE_URL_RULES` events until the request is ready to be routed, making it safe to call `UrlManager::addRules()` from plugin/module constructors. ([#13109](https://github.com/craftcms/cms/issues/13109))\n- Deprecated `craft\\base\\Element::EVENT_AFTER_MOVE_IN_STRUCTURE`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\base\\Element::EVENT_BEFORE_MOVE_IN_STRUCTURE`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\base\\Element::afterMoveInStructure()`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\base\\Element::beforeMoveInStructure()`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\events\\ElementStructureEvent`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\helpers\\ArrayHelper::firstKey()`. `array_key_first()` should be used instead.\n- Deprecated `craft\\helpers\\Assets::iconPath()`. `craft\\helpers\\Assets::iconSvg()` or `craft\\elements\\Asset::getThumbHtml()` should be used instead.\n- Deprecated `craft\\helpers\\Assets::iconUrl()`.\n- Deprecated `craft\\helpers\\UrlHelper::buildQuery()`. `http_build_query()` should be used instead.\n- Deprecated `craft\\services\\Volumes::ensureTopFolder()`. `craft\\services\\Assets::getRootFolderByVolumeId()` should be used instead.\n- Added `Craft.BaseUploader`. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- Added `Craft.createUploader()`. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- Added `Craft.registerUploaderClass()`. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- Added `Craft.Tooltip`.\n\n### System\n- Added support for setting environmental values in a \u201csecrets\u201d PHP file, identified by a `CRAFT_SECRETS_PATH` environment variable. ([#13283](https://github.com/craftcms/cms/pull/13283))\n- Added support for the `CRAFT_LOG_ALLOW_LINE_BREAKS` environment variable. ([#13544](https://github.com/craftcms/cms/pull/13544))\n- All generated URL param characters are now properly encoded. ([#12796](https://github.com/craftcms/cms/issues/12796))\n- `migrate` commands besides `migrate/create` no longer create the migration directory if it doesn\u2019t exist yet. ([#12732](https://github.com/craftcms/cms/pull/12732))\n- When `content` table columns are resized, if any existing values are too long, all column data is now backed up into a new table, and the overflowing values are set to `null`. ([#13025](https://github.com/craftcms/cms/pull/13025))\n- When `content` table columns are renamed, if an existing column with the same name already exists, the original column data is now backed up into a new table and then deleted from the `content` table. ([#13025](https://github.com/craftcms/cms/pull/13025))\n- Plain Text and Table fields no longer convert emoji to shortcodes on PostgreSQL.\n- Reduced the size of control panel Ajax request headers.\n- Improved GraphQL performance. ([#13354](https://github.com/craftcms/cms/pull/13354))\n- Fixed an error that occurred when exporting assets, if a subfolder was selected. ([#13570](https://github.com/craftcms/cms/issues/13570))\n- Fixed a bug where icons within secondary buttons were illegible when active.\n- Fixed a bug where the `|replace` filter was treating search strings as regular expressions even if they were invalid. ([#12956](https://github.com/craftcms/cms/issues/12956))\n- Fixed a bug where user groups without \u201cEdit users\u201d permission were being granted \u201cAssign users to [group name]\u201d when upgrading to Craft 4.\n- Fixed a bug where keyboard shortcuts weren\u2019t getting reactivated when control panel notifications were dismissed. ([#13574](https://github.com/craftcms/cms/issues/13574))\n- Fixed a bug where Plain Text and Table fields were converting posted shortcode-looking strings to emoji. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Fixed a bug where `craft\\elements\\Asset::getUrl()` was returning invalid URLs for GIF and SVG assets within filesystems without base URLs, if the `transformGifs` or `transformSvgs` config settings were disabled. ([#13306](https://github.com/craftcms/cms/issues/13306))\n- Fixed a bug where the GraphQL API wasn\u2019t enforcing schema site selections for the requested site. ([#13346](https://github.com/craftcms/cms/pull/13346))\n- Fixed a bug where PM times were getting converted to AM for Greek locales. ([#9942](https://github.com/craftcms/cms/issues/9942))\n- Fixed a bug where <kbd>Command</kbd>/<kbd>Ctrl</kbd> + clicks on \u201cNew entry\u201d button menu options would open the Entries index page in a new tab, and redirect to the Edit Entry page in the current tab. ([#13550](https://github.com/craftcms/cms/issues/13550))\n- Fixed DB cache support for PostgreSQL.\n- Updated Yii to 2.0.48.1. ([#13445](https://github.com/craftcms/cms/pull/13445))\n- Loosened the Composer constraint to `^2.2.19`. ([#13396](https://github.com/craftcms/cms/discussions/13396))\n- Internal Composer operations now use a bundled `composer.phar` file, rather than Composer\u2019s PHP API. ([#13519](https://github.com/craftcms/cms/pull/13519))\n- Updated Selectize to 0.15.2. ([#13273](https://github.com/craftcms/cms/discussions/13273))\n\n## 4.4.17 - 2023-08-08\n\n- `meta.__names__` values in the project config are now updated throughout the process of applying incoming project config changes, rather than at the end of the request.\n- The `project-config/rebuild` command now rebuilds the `meta.__names__` array from scratch. ([#13456](https://github.com/craftcms/cms/issues/13456))\n- Fixed a bug where `Craft.BaseElementIndexView::this.canSelectElement()` wasn\u2019t getting applied for lazy-loaded elements.\n- Fixed a bug where setting an element query\u2019s `status` param to `archived` would always yield zero results. ([#13465](https://github.com/craftcms/cms/issues/13465))\n- Fixed a bug where `update` commands could fail on some environments.\n- Fixed a bug where element thumbnails weren\u2019t getting loaded for expanded relational field previews within element indexes.\n- Fixed an error that occurred when deleting a volume with a missing filesystem type.\n- Fixed a bug where Color field values were illegible within selected element index rows.\n- Fixed a bug where multi-site content could be overwritten when creating a draft. ([#13451](https://github.com/craftcms/cms/issues/13451))\n- Fixed a bug where some nested component names weren\u2019t getting deleted from the `meta.__names__` array in the project config. ([#13456](https://github.com/craftcms/cms/issues/13456))\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateInterval()` didn\u2019t support negative integers. ([#13463](https://github.com/craftcms/cms/pull/13463))\n- Fixed a bug where admin tables were initially displaying an empty results message rather than a loading spinner, when the initial data was loading via Ajax. ([#13459](https://github.com/craftcms/cms/issues/13459))\n- Fixed a bug where garbage collection could terminate prematurely if an exception was thrown when deleting a pending user. ([#13490](https://github.com/craftcms/cms/issues/13490))\n- Fixed an error that occurred if the `purify` Twig filter was applied to a `null` value. ([#13495](https://github.com/craftcms/cms/issues/13495))\n- Fixed an error that could occur if a console controller\u2019s `runAction()` method returned `null`.\n- Fixed a bug where image transforms weren\u2019t respecting their `format` settings. ([#13493](https://github.com/craftcms/cms/issues/13493))\n- Fixed an information disclosure vulnerability.\n\n## 4.4.16.1 - 2023-07-19\n\n- Fixed a bug where lightswitch inputs weren\u2019t always stretching to fit their labels, when there was enough space for it. ([#13452](https://github.com/craftcms/cms/issues/13452))\n\n## 4.4.16 - 2023-07-18\n\n- The \u201cAccess the control panel\u201d user permission now includes a warning that the permission grants view-only access to user data and most content.\n- Added info buttons to \u201cView entries\u201d, \u201cCreate entries\u201d, and \u201cSave entries\u201d user permissions, clarifying which actions they allow. ([#13375](https://github.com/craftcms/cms/discussions/13375))\n- Improved performance when loading users with eager-loaded `addresses`. ([#13400](https://github.com/craftcms/cms/issues/13400))\n- `createDraft` GraphQL mutations now support a `creatorId` argument. ([#13401](https://github.com/craftcms/cms/issues/13401))\n- Garbage collection now deletes entries for sites that aren\u2019t supported by their section. ([#13383](https://github.com/craftcms/cms/issues/13383))\n- Added `craft\\elements\\Address::setOwner()`.\n- `craft\\base\\ElementInterface::eagerLoadingMap()` can now include a `createElement` key in the returned array, which defines a target element factory function.\n- `craft\\base\\Element::toArray()` now clones custom field values, similar to `__get()`. ([#13392](https://github.com/craftcms/cms/issues/13392))\n- Fixed a bug where entry titles could overflow within Entries fields with \u201cMaintain hierarchy\u201d enabled. ([#13382](https://github.com/craftcms/cms/issues/13382))\n- Fixed a bug where batched jobs with a configured limit could be repeated endlessly. ([#13387](https://github.com/craftcms/cms/issues/13387))\n- Fixed an error that could occur if `null` was passed to `craft\\elements\\MatrixBlock::setOwner()`.\n- Fixed a bug where eager-loaded categories were always loaded in the structure-defined order, even if the Categories field didn\u2019t have \u201cMaintain hierarchy\u201d enabled. ([#13394](https://github.com/craftcms/cms/issues/13394))\n- Fixed a bug where time inputs weren\u2019t handling malformed values properly if ICU 72.1 was installed. ([#13381](https://github.com/craftcms/cms/issues/13381))\n- Fixed legacy Live Preview support.\n- Fixed a bug where lightswitch inputs could overflow. ([#13419](https://github.com/craftcms/cms/issues/13419))\n- Fixed a bug where Matrix field validation wasn\u2019t working properly if the field value was eager-loaded. ([#13421](https://github.com/craftcms/cms/issues/13421))\n- Fixed a bug where date and time inputs weren\u2019t always working properly on mobile. ([#13424](https://github.com/craftcms/cms/issues/13424))\n- Fixed an RCE vulnerability.\n\n## 4.4.15 - 2023-07-03 [CRITICAL]\n\n- The control panel footer now includes a message about active trials, with a link to purchase the licenses.\n- Tags fields now only show up to five suggestions. ([#13322](https://github.com/craftcms/cms/issues/13322))\n- The `up`, `migrate/up`, and `migrate/all` commands now revert any project config changes created by migrations on failure.\n- The `up`, `migrate/up`, and `migrate/all` commands now prompt to restore the backup created at the outset of the command, or recommend restoring a backup, on failure.\n- Added `craft\\console\\controllers\\BackupTrait::restore()`.\n- Added `craft\\helpers\\Component::cleanseConfig()`.\n- `craft\\log\\ContextProcessor::filterVars()` now supports filtering keys using dot notation and `!` negation. ([#13362](https://github.com/craftcms/cms/pull/13362))\n- Fixed an error that occurred when passing arguments to an element\u2019s `prev` and `next` fields via GraphQL. ([#13334](https://github.com/craftcms/cms/issues/13334))\n- Fixed a bug where Single entries weren\u2019t getting preloaded for template macros, if the template body wasn\u2018t rendered. ([#13312](https://github.com/craftcms/cms/issues/13312))\n- Fixed a bug where asset folders could get dynamically created for elements with temporary slugs. ([#13311](https://github.com/craftcms/cms/issues/13311))\n- Fixed a bug where Matrix fields with custom propagation methods were being marked as translatable if the rendered translation key was blank. ([#13329](https://github.com/craftcms/cms/issues/13329))\n- Fixed a bug where transformed images\u2019 `width` or `height` properties could be `null` if the transform didn\u2019t specify both dimensions. ([#13335](https://github.com/craftcms/cms/issues/13335))\n- Fixed a bug where heading UI elements within field layouts were getting a top border if they were preceded by conditionally-hidden fields. ([#13308](https://github.com/craftcms/cms/issues/13308))\n- Fixed a bug where new Single sections could get URIs filled in on form submit based on the section name, if the input was blank and hadn\u2019t been directly edited. ([#13350](https://github.com/craftcms/cms/issues/13350), [#13355](https://github.com/craftcms/cms/pull/13355))\n- Fixed a bug where it was possible to drag items beyond the normal page scroll limits. ([#13351](https://github.com/craftcms/cms/issues/13351))\n- Fixed two RCE vulnerabilities.\n\n## 4.4.14 - 2023-06-13\n\n- The `utils/fix-field-layout-uids` command now adds missing field layout component UUIDs.\n- The `_includes/forms/date` and `_includes/forms/time` templates now accept a `timeZone` variable.\n- Invalid utility URLs now redirect to the first permitted utility (besides \u201cUpdates\u201d). ([#13282](https://github.com/craftcms/cms/issues/13282))\n- Fixed an error that could occur when updating a plugin with the `craft update` command, if it provided a new migration but still had the same schema version.\n- Fixed an error that occurred when rendering editable tables with Date or Time columns. ([#13270](https://github.com/craftcms/cms/issues/13270))\n- Fixed a bug where CSS classes that contained a pseudo-selector weren\u2019t getting namespaced. ([#13251](https://github.com/craftcms/cms/pull/13251))\n- Fixed a JavaScript error that could occur when renaming assets without URLs. ([#13223](https://github.com/craftcms/cms/pull/13223))\n- Fixed a bug where `craft\\base\\Element::setFieldValuesFromRequest()` wasn\u2019t properly handling empty strings passed as the namespace. ([#13252](https://github.com/craftcms/cms/discussions/13252))\n- Fixed a styling issue with control panel notifications. ([#13258](https://github.com/craftcms/cms/pull/13258))\n- Fixed a bug where element thumbnails could stop getting loaded when quickly switching between element sources. ([#13253](https://github.com/craftcms/cms/issues/13253))\n- Fixed an error that occurred when uploading an asset with a filename over 232 characters long, directly to an Assets field. ([#13264](https://github.com/craftcms/cms/issues/13264))\n- Fixed an error that occurred when transforming an image with a filename over 232 characters long. ([#13266](https://github.com/craftcms/cms/pull/13266))\n- Fixed a SQL error that could occur when upgrading to 4.4 on PostgreSQL, if the database was converted from MySQL. ([#12855](https://github.com/craftcms/cms/issues/12855))\n- Fixed a bug where `craft\\db\\Query::collect()` was returning a `craft\\elements\\ElementCollection` instance.\n- Fixed a SQL error that could occur when upgrading to Craft 4 if any database tables had foreign keys to `entryversions` or other now-unused tables that are removed during the upgrade.\n- Fixed a bug where the `users/save-user` action wasn\u2019t including user details in successful responses. ([#13267](https://github.com/craftcms/cms/issues/13267))\n- Fixed a PHP error that occurred if an asset without a `dateModified` value was passed to `craft\\helpers\\Assets::revParams()`. ([#13268](https://github.com/craftcms/cms/pull/13268))\n- Fixed a bug where the Updates utility\u2019s heading wasn\u2019t reflecting updates that were blocked due to an expired plugin. ([#13274](https://github.com/craftcms/cms/issues/13274))\n- Fixed a bug where element deletion events weren\u2019t getting triggered when elements were hard-deleted from an element index. ([#13280](https://github.com/craftcms/cms/issues/13280))\n- Fixed a bug where dropdowns within editable tables had blank optgroup labels. ([#13298](https://github.com/craftcms/cms/issues/13298))\n- Fixed a bug where textual cells within editable tables would display `[object Object]` if an object was passed as their value. ([#13303](https://github.com/craftcms/cms/issues/13303))\n\n## 4.4.13 - 2023-05-24\n\n- Fixed a bug where asset sources weren\u2018t immediately showing a source path on a clear `localStorage` cache.\n- Fixed a JavaScript error that could occur when searching within an asset index, when there was no source path. ([#13241](https://github.com/craftcms/cms/issues/13241))\n- Fixed a bug where Date fields with \u201cShow Time Zone\u201d enabled were displaying their values in the system\u2019s time zone within element indexes. ([#13233](https://github.com/craftcms/cms/issues/13233))\n- Fixed a bug where the \u201cCancel\u201d buttons within Dashboard widgets\u2019 settings didn\u2019t do anything. ([#13239](https://github.com/craftcms/cms/issues/13239))\n\n## 4.4.12 - 2023-05-23\n\n- Asset indexes now remember their previously-selected source path. ([#13147](https://github.com/craftcms/cms/issues/13147))\n- Added the `enabledForSite` field for entries queried via GraphQL. ([#13214](https://github.com/craftcms/cms/pull/13214))\n- Added `craft\\base\\ElementInterface::sourcePath()`.\n- Improved `craft\\helpers\\FileHelper::getExtensionByMimeType()` for some ambiguous, web-friendly MIME types.\n- Fixed a bug where reverting an entry\u2019s content from a revision could omit some Matrix blocks.\n- Fixed an error that could occur when adding a new site to an entry which contained Matrix blocks, if the same site had been added and removed previously.\n- Fixed a bug where Matrix blocks nested within Neo or Super Table fields could be omitted when propagating an entry to a new site. ([#13207](https://github.com/craftcms/cms/issues/13207))\n- Fixed a bug where `craft\\web\\View::registerTwigExtension()` could throw an exception if Twig was already initialized. ([#13208](https://github.com/craftcms/cms/issues/13208))\n- Fixed a bug where entries mutated via GraphQL weren\u2019t becoming globally enabled if `enabled` was set to `true`. ([#13214](https://github.com/craftcms/cms/pull/13214))\n- Fixed a styling issue with \u201cPost Date\u201d and \u201cExpiry Date\u201d fields. ([#13216](https://github.com/craftcms/cms/issues/13216))\n- Removed the OAuth 2.0 Client library, as it\u2019s no longer used in core.\n- Fixed a bug where activation emails sent to newly-created users could link to the front-end site, if they were granted control panel access via a user group. ([#13204](https://github.com/craftcms/cms/issues/13204))\n- Fixed a bug where \u201cRequired\u201d lightswitch labels within field layout designers\u2019 field settings slideouts weren\u2019t getting translated. ([#13230](https://github.com/craftcms/cms/issues/13230))\n- Fixed a bug where Date fields could display the wrong date. ([#13233](https://github.com/craftcms/cms/issues/13233))\n- Deprecated the `Craft.startsWith()` JavaScript method. `String.prototype.startsWith()` should be used instead.\n- Fixed two XSS vulnerabilities.\n\n## 4.4.11 - 2023-05-15\n\n- Fixed a bug where Matrix blocks weren\u2019t getting propagated to newly-added sites for entries. ([#13181](https://github.com/craftcms/cms/issues/13181))\n- Fixed a SQL error that could occur when updating to Craft 4.4 on PostgreSQL. ([#13186](https://github.com/craftcms/cms/issues/13186))\n- Fixed a bug where `craft\\helpers\\StringHelper::isUtf8()` was unreliable.\n- Fixed a styling issue with Date fields. ([#13182](https://github.com/craftcms/cms/issues/13182))\n\n## 4.4.10.1 - 2023-05-10\n\n- Fixed a bug where it wasn\u2019t possible to add new Matrix blocks via the \u201cAdd a block\u201d menu. ([#13177](https://github.com/craftcms/cms/issues/13177))\n\n## 4.4.10 - 2023-05-09\n\n- PHP warnings and notices no longer halt execution when Dev Mode is disabled. ([#13164](https://github.com/craftcms/cms/issues/13164))\n- Fixed a \u201cDouble-instantiating a menu button on an element\u201d console warning that occurred on pages with Matrix fields. ([#6338](https://github.com/craftcms/cms/issues/6338))\n- Fixed a bug where Quick Post widget settings weren\u2019t filtering custom field options for the selected entry type.\n- Fixed a bug where Matrix blocks could get detached from entries when sections were enabled for a new site. ([#13155](https://github.com/craftcms/cms/issues/13155))\n- Fixed an error that could occur when entrifying a global set without a field layout. ([#13156](https://github.com/craftcms/cms/issues/13156))\n- Fixed a bug where Single entries\u2019 edit pages could have \u201cSave and add another\u201d actions. ([#13157](https://github.com/craftcms/cms/issues/13157))\n- Fixed styling issues with Date fields. ([#13167](https://github.com/craftcms/cms/issues/13167))\n- Fixed the vertical alignment of element labels. ([#13168](https://github.com/craftcms/cms/issues/13168))\n- Fixed a bug where the System Report utility could display MariaDB\u2019s MySQL-equivalent version, if it was listed first in the server version string.\n- Added `craft\\helpers\\ArrayHelper::containsRecursive()`.\n- `craft\\helpers\\App::normalizeVersion()` now returns the highest version found before distribution info.\n\n## 4.4.9 - 2023-05-02\n\n- Volumes no longer validate if their field layout contains a field called `extension`, `filename`, `height`, `kind`, `size`, or `width`.\n- It\u2019s now possible for plugins to register errors to entries\u2019 `typeId`, `parentId`, and `authorId` attributes. ([#13138](https://github.com/craftcms/cms/pull/13138))\n- Stack traces returned by `craft\\helpers\\App::backtrace()` now more closely resemble exception stack traces.\n- \u201cElement query executed before Craft is fully initialized\u201d warnings now include a stack trace.\n- Fixed a bug where queue-runner Ajax requests triggered on the front end weren\u2019t getting closed before running the queue, potentially causing long front-end load delays.\n- Fixed a bug where long element titles weren\u2019t wrapping. ([#13143](https://github.com/craftcms/cms/issues/13143))\n- Fixed a user enumeration timing attack vulnerability.\n- Fixed a SQL error that could occur when upgrading to Craft 4, if any `matrixblocks` table rows referenced nonexistent element IDs. ([#13121](https://github.com/craftcms/cms/issues/13121))\n- Fixed a SQL error that could occur when upgrading to Craft 4, if anything triggered an asset or volume query. ([#13130](https://github.com/craftcms/cms/issues/13130))\n- Fixed a SQL error that occurred when deleting a category group on PostgreSQL, when configured with a table prefix. ([#13127](https://github.com/craftcms/cms/issues/13127))\n- Fixed a bug where it was possible to query for elements with soft-deleted site IDs.\n- Fixed a JavaScript error that could occur on the control panel login form.\n\n## 4.4.8 - 2023-04-25\n\n- Category/tag/global set reference tags now map to entries, if no category groups/tag groups/global sets exist. ([#13082](https://github.com/craftcms/cms/issues/13082))\n- HTML Purifier now allows `data-oembed-url` attributes on `div` tags. ([craftcms/ckeditor#80](https://github.com/craftcms/ckeditor/issues/80))\n- Added `craft\\queue\\Queue::EVENT_AFTER_EXEC_AND_RELEASE`. ([#13096](https://github.com/craftcms/cms/issues/13096))\n- `craft\\services\\Elements::propagateElements()` now returns the element in the target site.\n- A globally-defined element thumb loader is now available in the control panel via `Craft.cp.elementThumbLoader`.\n- Fixed a bug where it was possible to select a disallowed volume as the Default Asset Location in Assets field settings. ([#13072](https://github.com/craftcms/cms/issues/13072))\n- Fixed a bug where it was possible to upload files to Assets fields outside of the allowed volumes, if the Default Upload Location was set to a disallowed volume. ([#13072](https://github.com/craftcms/cms/issues/13072))\n- Fixed an error that could occur if a Plain Text field had over 1,000,000 bytes. ([#13083](https://github.com/craftcms/cms/issues/13083))\n- Fixed a bug where relational field values weren\u2019t yielding any results for event handlers immediately after a draft had been merged. ([#13087](https://github.com/craftcms/cms/issues/13087))\n- Fixed a bug where element labels could bleed out of their container. ([#13099](https://github.com/craftcms/cms/issues/13099))\n- Fixed an error that occurred if `yii\\web\\UrlManager::addRules()` was called on a console request. ([#13109](https://github.com/craftcms/cms/issues/13109))\n- Fixed a bug where it was possible to select the current folder as the target when moving a volume folder, resulting in the folder and its contents being lost. ([#13118](https://github.com/craftcms/cms/issues/13118))\n- Fixed an error that could occur when running tests. ([#13076](https://github.com/craftcms/cms/issues/13076))\n- Fixed an error that occurred when sending the activation email for a new user, if there were any validation errors due to new group assignments. ([#13060](https://github.com/craftcms/cms/issues/13060))\n- Fixed a bug where the \u201cSend an activation email now\u201d user account checkbox was losing its value if there were any validation errors.\n- Fixed an error that could occur when creating a database backup on MySQL and MariaDB. ([#12996](https://github.com/craftcms/cms/issues/12996))\n- Fixed a bug where Edit Category screens were including a Parent field, even if the category group\u2019s Max Levels was set to `1`. ([#13097](https://github.com/craftcms/cms/discussions/13097))\n- Fixed a bug where the uploader\u2019s user photo wasn\u2019t always loading on Edit Asset pages.\n- Fixed a bug where the \u201cDelete for site\u201d bulk element action was deleting disabled elements and drafts across all sites. ([#13116](https://github.com/craftcms/cms/issues/13116))\n- Fixed a bug where Entries and Categories fields with \u201cMaintain hierarchy\u201d enabled could lose relations to elements that didn\u2019t exist in the primary site. ([#13057](https://github.com/craftcms/cms/issues/13057))\n\n## 4.4.7.1 - 2023-04-15\n\n- Locked the Yii 2 PSR Log Target library to 1.1.3 to avoid a PHP error that occurs on 1.1.4.\n\n## 4.4.7 - 2023-04-11\n\n- Improved the control panel styling when the Debug Toolbar is enabled.\n- The image transformer now verifies that transforms don\u2019t exist if the index record is missing, before queuing up the transform generation, for local filesystems. ([#13052](https://github.com/craftcms/cms/issues/13052))\n- Added the `--propagate-to` and `--set-enabled-for-site` options to the `resave/entries` command.\n- Craft\u2019s bootstrap script now defines a `CRAFT_ENVIRONMENT` environment variable, as a safety measure for plugins that may be checking for it rather than `Craft::$app->env`.\n- Added `craft\\helpers\\ElementHelper::siteStatusesForElement()`.\n- `craft\\elements\\Asset::EVENT_BEFORE_DEFINE_URL` now sends a `craft\\events\\DefineAssetUrlEvent` object, rather than `craft\\events\\DefineUrlEvent`. ([#13018](https://github.com/craftcms/cms/issues/13018))\n- `craft\\web\\View::renderObjectTemplate()` now trims the returned template output.\n- Fixed a bug where users were \u201cView other users\u2019 drafts\u201d section permissions weren\u2019t being enforced for unpublished drafts.\n- Fixed a bug where Matrix fields weren\u2019t counting disabled blocks when enforcing their Min Blocks settings. ([#13059](https://github.com/craftcms/cms/issues/13059))\n- Fixed a bug where volume folder modals\u2019 sidebars and content were being cut off. ([#13074](https://github.com/craftcms/cms/issues/13074))\n- Fixed a bug where element editors were showing provisional changes, even if the user didn\u2019t have permission to save them.\n- Fixed a bug where the control panel could be inaccessible if a mutex lock couldn\u2019t be acquired for the queue. ([#13052](https://github.com/craftcms/cms/issues/13052))\n- Fixed a bug where it wasn\u2019t possible to update a Matrix block on a revision without a new block ID being assigned. ([#13064](https://github.com/craftcms/cms/discussions/13064))\n- Fixed a JavaScript error that could occur on field layout designers, if any tabs didn\u2019t have any elements. ([#13062](https://github.com/craftcms/cms/issues/13062))\n- Fixed a bug where selecting an image with a transform within an asset selector modal wasn\u2019t ever resolving.\n- Fixed a PHP error that could occur if there was a problem sending a password-reset email. ([#13070](https://github.com/craftcms/cms/pull/13070))\n- Fixed a bug where users\u2019 User Groups and Permissions settings were getting cleared in the UI when sending an activation email, if the email failed to send. ([#13061](https://github.com/craftcms/cms/issues/13061))\n- Fixed XSS vulnerabilities.\n- Updated yii2-debug to 2.1.22. ([#13058](https://github.com/craftcms/cms/issues/13058))\n\n## 4.4.6.1 - 2023-04-04\n\n- Fixed a bug where Categories fields weren\u2019t retaining custom sort orders when \u201cMaintain hierarchy\u201d was disabled. ([#10560](https://github.com/craftcms/cms/discussions/10560))\n\n## 4.4.6 - 2023-04-04\n\n- Content tab menus now reveal when a tab contains validation errors, and invalid tabs\u2019 menu options get the same warning icon treatment as inline tabs do. ([#12971](https://github.com/craftcms/cms/issues/12971))\n- Selectize menus now expand upwards when there\u2019s not ample space below them. ([#12976](https://github.com/craftcms/cms/issues/12976))\n- Element index bulk action spinners are now centered on the viewport. ([#12972](https://github.com/craftcms/cms/issues/12972))\n- All control panel errors are new presented via error notifications rather than browser alerts. ([#13024](https://github.com/craftcms/cms/issues/13024))\n- The `up` command now sets its default `--isolated` option value to `true`, and no longer creates a redundant mutex lock.\n- Added `craft\\base\\Element::EVENT_BEFORE_DEFINE_URL`. ([#13018](https://github.com/craftcms/cms/issues/13018))\n- Added `craft\\utilities\\AssetIndexes::volumes()`.\n- `craft\\controllers\\AssetIndexesController::actionStartIndexing()` now cross-references the selected volumes with those allowed by `craft\\utilities\\AssetIndexes::EVENT_LIST_VOLUMES` event handlers. ([#13039](https://github.com/craftcms/cms/pull/13039), [#12819](https://github.com/craftcms/cms/pull/12819))\n- Fixed a bug where Assets fields weren\u2019t respecting their View Mode setting when viewing entry revisions. ([#12948](https://github.com/craftcms/cms/issues/12948))\n- Fixed a bug where asset pagination was broken when there was more than 100 subfolders. ([#12969](https://github.com/craftcms/cms/issues/12969))\n- Fixed a bug where entry index pages\u2019 \u201cRevision Notes\u201d and \u201cLast Edited By\u201d columns weren\u2019t getting populated for disabled entries. ([#12981](https://github.com/craftcms/cms/issues/12981))\n- Fixed a bug where assets were getting relocated to the root volume folder when renamed. ([#12995](https://github.com/craftcms/cms/issues/12995))\n- Fixed a bug where it wasn\u2019t possible to preview entries on another domain when the system was offline. ([#12979](https://github.com/craftcms/cms/issues/12979))\n- Fixed a bug where users were able to access volumes they didn\u2019t have permission to view via Assets fields. ([#13006](https://github.com/craftcms/cms/issues/13006))\n- Fixed a bug where zero-width spaces, invisible plus signs, and byte order marks weren\u2019t getting stripped from sanitized asset filenames. ([#13022](https://github.com/craftcms/cms/issues/13022))\n- Fixed a bug where the Plugin Store wasn\u2019t accurately reporting installed plugins\u2019 license statuses. ([#12986](https://github.com/craftcms/cms/issues/12986))\n- Fixed a bug where the Plugin Store wasn\u2019t handling 403 API responses for cart operations properly, once a cart had been handed off to Craft Console and assigned to an organization. ([#12916](https://github.com/craftcms/cms/issues/12916))\n- Fixed a bug where `craft\\helpers\\FileHelper::absolutePath()` wasn\u2019t treating Windows file paths beginning drive letters as absolute. ([craftcms/generator#16](https://github.com/craftcms/generator/issues/16))\n- Fixed a bug where it wasn\u2019t possible to sort Categories fields with \u201cMaintain hierarchy\u201d disabled. ([#10560](https://github.com/craftcms/cms/discussions/10560))\n- Fixed a bug where selectize inputs didn\u2019t have a minimum width. ([#12950](https://github.com/craftcms/cms/issues/12950))\n- Fixed a bug where the wrong tab would appear to be initially selected after an autosave, if the selected tab had changed during the autosave. ([#12960](https://github.com/craftcms/cms/issues/12960))\n- Fixed a bug where it wasn\u2019t possible to add a Dropdown field without a blank option to a global set. ([#12965](https://github.com/craftcms/cms/issues/12965))\n- Fixed a bug where automatically-added Matrix blocks (per the field\u2019s Min Blocks setting) were getting discarded if no changes were made to them. ([#12973](https://github.com/craftcms/cms/issues/12973))\n- Fixed an error that could occur when installing Craft with an existing project config, if any image transforms were defined that didn\u2019t specify the `upscale` property.\n- Fixed a bug where nested folders in asset search results weren\u2019t showing their relative path.\n- Fixed a bug where admin tables\u2019 default delete icon title text wasn\u2019t getting translated. ([#13030](https://github.com/craftcms/cms/issues/13030))\n- Fixed a bug where it was possible to save a Local filesystem pointed at a system directory (e.g. the `templates/` or `vendor/` folders), which mitigates a potential RCE vulnerability.\n- Fixed XSS vulnerabilities.\n\n## 4.4.5 - 2023-03-21\n\n- Fixed a bug where relation data was getting deleted when running garbage collection on PostgreSQL. ([#9905](https://github.com/craftcms/cms/issues/9905))\n- Fixed a bug where Lightswitch fields\u2019 \u201cOFF Label\u201d and \u201cON Label\u201d settings weren\u2019t getting translated. ([#12942](https://github.com/craftcms/cms/issues/12942))\n- Fixed a bug where `craft\\events\\DefineUserContentSummaryEvent::$userId` was never set for `craft\\controllers\\EVENT_DEFINE_CONTENT_SUMMARY` events. ([#12944](https://github.com/craftcms/cms/issues/12944))\n- Fixed a bug where element edit pages weren\u2019t displaying layout tabs that didn\u2019t have a unique name. ([#12928](https://github.com/craftcms/cms/issues/12928))\n- Fixed a bug where the `CRAFT_LOG_PHP_ERRORS` constant/environment variable wasn\u2019t being respected when set to `false`. ([#12862](https://github.com/craftcms/cms/issues/12862))\n- Fixed a bug where the `entrify/categories` command wasn\u2019t converting disabled categories. ([#12945](https://github.com/craftcms/cms/issues/12945))\n- Updated svg-sanitizer to 0.16. ([#12943](https://github.com/craftcms/cms/issues/12943))\n\n## 4.4.4 - 2023-03-20\n\n- Input autofocussing has been reintroduced throughout the control panel. ([#12921](https://github.com/craftcms/cms/discussions/12921))\n- The `|json_encode` Twig filter now calls `craft\\helpers\\Json::encode()` internally, improving error handling. ([#12919](https://github.com/craftcms/cms/issues/12919))\n- `craft\\helpers\\Json::encode()` no longer sets the `JSON_UNESCAPED_SLASHES` flag by default.\n- Fixed a JavaScript error that occurred when resolving an asset move conflict. ([#12920](https://github.com/craftcms/cms/issues/12920))\n- Fixed a bug where volume subfolders were being shown when viewing soft-deleted assets. ([#12927](https://github.com/craftcms/cms/issues/12927))\n- Fixed a bug where structure data was getting deleted when running garbage collection on PostgreSQL. ([#12925](https://github.com/craftcms/cms/issues/12925))\n- Fixed an error that could occur when rebuilding the project config, if there were any custom source definitions for element types that weren\u2019t Composer-installed. ([#12881](https://github.com/craftcms/cms/issues/12881))\n- Fixed an XSS vulnerability.\n\n## 4.4.3 - 2023-03-16\n\n- Customize Sources modals no longer hide when the <kbd>Esc</kbd> key is pressed on the surrounding area is clicked on. ([#12895](https://github.com/craftcms/cms/issues/12895))\n- Sections created via `entrify` commands no longer get a \u201cPrimary entry page\u201d preview target by default, unless it was sourced from a category group with URLs. ([#12897](https://github.com/craftcms/cms/issues/12897))\n- `entrify` commands and the `sections/create` command now prompt for the initial entry type name and handle. ([#12894](https://github.com/craftcms/cms/discussions/12894))\n- Added `craft\\helpers\\FileHelper::uniqueName()`.\n- Added `craft\\helpers\\StringHelper::emojiToShortcodes()`.\n- Added `craft\\helpers\\StringHelper::shortcodesToEmoji()`.\n- Fixed an error that occurred when uploading an asset with a filename over 250 characters long. ([#12889](https://github.com/craftcms/cms/issues/12889))\n- Fixed an error that could occur when preparing licensing alerts, if any licenses were invalid. ([#12899](https://github.com/craftcms/cms/issues/12899))\n- Fixed a bug where it wasn\u2019t possible to drag nested Neo blocks. ([#12896](https://github.com/craftcms/cms/issues/12896))\n- Fixed a bug where fields with reduced widths in Matrix blocks were becoming full-width while dragged. ([#12909](https://github.com/craftcms/cms/issues/12909))\n- Fixed a bug where multi-edition plugins weren\u2019t showing their edition labels within the Plugin Store cart. ([#12910](https://github.com/craftcms/cms/issues/12910))\n- Fixed a bug where private plugins\u2019 control panel templates weren\u2019t directly accessible by URL.\n- Fixed a bug where element selector modals were persisting parts of their state in the query string. ([#12900](https://github.com/craftcms/cms/issues/12900))\n- Fixed a PHP error that occurred if a field type stored enum values. ([#12297](https://github.com/craftcms/cms/issues/12297))\n- Fixed an error that could occur when generating transforms for images stored in Google Cloud Storage. ([#12878](https://github.com/craftcms/cms/issues/12878))\n- Fixed a bug where some unicode characters were getting removed by LitEmoji. ([#12905](https://github.com/craftcms/cms/issues/12905))\n\n## 4.4.2 - 2023-03-14\n\n- The `entrify/categories` and `entrify/global-set` commands now update user permissions for the new sections. ([#12849](https://github.com/craftcms/cms/discussions/12849))\n- Variable dumps now use a light theme for web requests by default. ([#12857](https://github.com/craftcms/cms/pull/12857))\n- Added the `dumper` application component and `craft\\base\\ApplicationTrait::getDumper()`. ([#12869](https://github.com/craftcms/cms/pull/12869))\n- Added `craft\\models\\ImageTransform::getConfig()`.\n- Fixed a bug where it wasn\u2019t always possible to access entry or category edit pages if the `slugWordSeparator` config setting was set to `/`. ([#12871](https://github.com/craftcms/cms/issues/12871))\n- Fixed a bug where `craft\\helpers\\Html::parseTagAttribute()` wasn\u2019t decoding attribute values, which could lead to double-encoded attributes, e.g. when using the `|attr` filter. ([#12887](https://github.com/craftcms/cms/issues/12887))\n- Fixed a bug where multi-value field inputs would be considered modified even if they weren\u2019t, if the field type\u2019s `isValueEmpty()` method returned `true`. ([#12858](https://github.com/craftcms/cms/issues/12858))\n- Fixed a bug where asset thumbnails within secondary slideout tabs weren\u2019t loading immediately. ([#12859](https://github.com/craftcms/cms/issues/12859))\n- Fixed a bug where rebuilding the project config would lose track of image transforms\u2019 `fill` and `upscale` settings. ([#12879](https://github.com/craftcms/cms/issues/12879))\n- Fixed a bug where blank Dropdown options weren\u2019t showing up in the Selectize menu. ([#12880](https://github.com/craftcms/cms/issues/12880))\n- Fixed a bug where it was possible to save a Dropdown field without a value, even if the field didn\u2019t have any blank options. ([#12880](https://github.com/craftcms/cms/issues/12880))\n- Fixed a bug where element action triggers weren\u2019t centered for element sources that don\u2019t define any exporters. ([#12885](https://github.com/craftcms/cms/issues/12885))\n- Fixed an error that could occur when generating a transform URL for an image in the temp folder.\n- Fixed XSS vulnerabilities.\n- Fixed an SSRF vulnerability.\n\n## 4.4.1 - 2023-03-09\n\n- Fixed a bug where it wasn\u2019t possible to select subfolders on the Assets index page. ([#12802](https://github.com/craftcms/cms/issues/12802))\n- Fixed a bug where element index search inputs were losing focus when the element listing was updated. ([#12846](https://github.com/craftcms/cms/issues/12846))\n- Fixed a bug where the database driver was being referenced as \u201cMySQL\u201d when using MariaDB. ([#12827](https://github.com/craftcms/cms/issues/12827))\n- Fixed a bug where users weren\u2019t able to select assets within Assets fields, if they didn\u2019t have full permissions for the volume. ([#12851](https://github.com/craftcms/cms/issues/12851))\n- Fixed a bug where the Assets index page\u2019s URL would get updated incorrectly when renaming a subfolder.\n- Fixed a bug where non-admin users weren\u2019t able to view Single section entries. ([#12838](https://github.com/craftcms/cms/issues/12838))\n- Fixed an error that could occur when saving an element with eager-loaded relations. ([#12839](https://github.com/craftcms/cms/issues/12839))\n- Fixed a bug where Customize Sources modals weren\u2019t showing source headings with no subsequent sources. ([#12840](https://github.com/craftcms/cms/issues/12840))\n- Fixed a bug where `entrify` commands could leave the database and project config data in inconsistent states, if aborted prematurely. ([#12850](https://github.com/craftcms/cms/pull/12850))\n- Fixed a bug where the `entrify/global-set` command wasn\u2019t always suggesting the command to run on other environments.\n- Fixed a bug where the Assets index page would appear to keep loading indefinitely after renaming a subfolder.\n- Fixed a bug where folders within asset indexes were getting the current site name appended to them, on multi-site installs. ([#12852](https://github.com/craftcms/cms/issues/12852))\n- Fixed a SQL error that could occur when updating to Craft 4.4 on PostgreSQL. ([#12855](https://github.com/craftcms/cms/issues/12855))\n- Added `craft\\db\\Connection::getDriverLabel()`.\n\n## 4.4.0 - 2023-03-08\n\n### Content Management\n- Volume subfolders are now displayed within the element listing pane on asset indexes, rather than as nested sources in the sidebar. ([#12558](https://github.com/craftcms/cms/pull/12558), [#9171](https://github.com/craftcms/cms/discussions/9171), [#5809](https://github.com/craftcms/cms/issues/5809))\n- Asset indexes now display the current subfolder path above the element listing. ([#12558](https://github.com/craftcms/cms/pull/12558))\n- Assets and folders can now be drag-and-dropped simultaneously. ([#12792](https://github.com/craftcms/cms/pull/12792))\n- Reduced the likelihood of accidentally triggering an asset drag operation. ([#12792](https://github.com/craftcms/cms/pull/12792))\n- Reduced the likelihood of accidentally dropping dragged assets/folders on an unintended target. ([#12792](https://github.com/craftcms/cms/pull/12792))\n- It\u2019s now possible to move volume folders and assets to a new location via a new \u201cMove\u2026\u201d bulk element action, rather than via drag-and-drop interactions. ([#12558](https://github.com/craftcms/cms/pull/12558))\n- It\u2019s now possible to sort asset indexes by image width and height. ([#12653](https://github.com/craftcms/cms/pull/12653))\n- Structured element index sources now have a dedicated view mode option for showing elements as a structured table. ([#12722](https://github.com/craftcms/cms/pull/12722), [#12718](https://github.com/craftcms/cms/discussions/12718))\n- Entry and category indexes can now have \u201cAncestors\u201d and \u201cParent\u201d columns. ([#12666](https://github.com/craftcms/cms/discussions/12666))\n- All element sources now have a \u201cDuplicate\u201d action, even if the element type\u2019s `defineActions()` method didn\u2019t include one. ([#12382](https://github.com/craftcms/cms/discussions/12382))\n- Element index pages now track the search term in a query param, so the results can be shared. ([#8942](https://github.com/craftcms/cms/discussions/8942), [#12399](https://github.com/craftcms/cms/pull/12399))\n- Entries with more than 10 revisions now include a \u201cView all revisions\u201d item within their revision menu, which links to a new revisions index page for the entry that paginates through all its revisions. ([#8609](https://github.com/craftcms/cms/discussions/8609))\n- Entries and Categories fields now have \u201cMaintain hierarchy\u201d settings, which become available when a single structured source is selected. ([#8522](https://github.com/craftcms/cms/discussions/8522), [#8748](https://github.com/craftcms/cms/discussions/8748), [#10560](https://github.com/craftcms/cms/discussions/10560), [#11749](https://github.com/craftcms/cms/pull/11749))\n- Entries fields now have a \u201cBranch Limit\u201d setting, which becomes available when \u201cMaintain hierarchy\u201d is enabled, replacing \u201cMin Relations\u201d and \u201cMax Relations\u201d.\n- Categories fields now have \u201cMin Relations\u201d and \u201cMax Relations\u201d settings, which become available when \u201cMaintain hierarchy\u201d is disabled, replacing \u201cBranch Limit\u201d.\n- Added \u201cViewable\u201d asset and entry condition rules. ([#12240](https://github.com/craftcms/cms/discussions/12240), [#12266](https://github.com/craftcms/cms/pull/12266))\n- Renamed the \u201cEditable\u201d asset and entry condition rules to \u201cSavable\u201d. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Assets, categories, and entries will now redirect to the last-selected source on their index pages when saved. ([#11996](https://github.com/craftcms/cms/discussions/11996))\n- Dropdown fields that don\u2019t have a blank option and are missing a value will now include and select a blank option at the beginning of their menu. ([#12235](https://github.com/craftcms/cms/discussions/12235))\n- Tip and Warning field layout UI elements can now be marked as dismissible, giving authors the ability to hide them. ([#12188](https://github.com/craftcms/cms/discussions/12188))\n- All assets now get thumbnails in the control panel, even if they don\u2019t have a transform filesystem with a base URL. ([#12531](https://github.com/craftcms/cms/issues/12531))\n- Dropdown and Multi-select fields now use Selectize. ([#8403](https://github.com/craftcms/cms/discussions/8403))\n- Improved the styling of bulk element action triggers. ([#12793](https://github.com/craftcms/cms/pull/12793))\n\n### Accessibility\n- Improved the announcement menu for screen readers. ([#12361](https://github.com/craftcms/cms/pull/12361))\n- Improved keyboard control of the Updates utility. ([#12189](https://github.com/craftcms/cms/pull/12189))\n- Improved the color contrast and keyboard control of the Customize Sources modal. ([#12233](https://github.com/craftcms/cms/pull/12233))\n- Improved info icons for screen readers. ([#12272](https://github.com/craftcms/cms/pull/12272))\n- Removed input autofocussing throughout the control panel. ([#12324](https://github.com/craftcms/cms/discussions/12324), [#12332](https://github.com/craftcms/cms/pull/12332), [#12406](https://github.com/craftcms/cms/pull/12406))\n- Improved the login screen for screen readers. ([#12386](https://github.com/craftcms/cms/pull/12386))\n- Improved _conditional_ and _required_ field indicators for screen readers. ([#12509](https://github.com/craftcms/cms/pull/12509))\n- Improved element index pages for screen readers. ([#12731](https://github.com/craftcms/cms/pull/12731))\n- Improved bulk element action triggers on element index pages. ([#12415](https://github.com/craftcms/cms/pull/12415))\n- Improved the color contrast of element indexes. ([#12213](https://github.com/craftcms/cms/pull/12213))\n- Asset preview modals now show videos\u2019 alt text. ([#12637](https://github.com/craftcms/cms/pull/12637))\n- Improved element indexes\u2019 \u201cExport\u201d buttons for screen readers. ([#12754](https://github.com/craftcms/cms/pull/12754))\n- Improved Quick Post widgets\u2019 \u201cFields\u201d settings for screen readers. ([#12772](https://github.com/craftcms/cms/pull/12772))\n- Improved some element selector modals for screen readers. ([#12783](https://github.com/craftcms/cms/pull/12783))\n- Fixed a bug where it wasn\u2019t possible to vertically scroll element index filter HUDs. ([#12751](https://github.com/craftcms/cms/pull/12751))\n- Fixed a bug where translated locale names within users\u2019 \u201cLanguage\u201d and \u201cFormatting Locale\u201d preference menus didn\u2019t have `lang` attributes. ([#12773](https://github.com/craftcms/cms/pull/12773))\n- Fixed a bug where search icons on element indexes weren\u2019t hidden from screen readers. ([#12785](https://github.com/craftcms/cms/pull/12785))\n\n### Administration\n- Most licensing issues are now consolidated into a single control panel alert, with a button to resolve them all with a single purchase on Craft Console. ([#12768](https://github.com/craftcms/cms/pull/12768))\n- Conditional layout components are now identified using a condition icon within field layout designers. ([#12250](https://github.com/craftcms/cms/issues/12250))\n- All CLI commands now support an `--isolated` option, which ensures the command is run in isolation. ([#12337](https://github.com/craftcms/cms/discussions/12337), [#12350](https://github.com/craftcms/cms/pull/12350))\n- Added the `entrify/categories`, `entrify/tags`, and `entrify/global-set` commands, for converting categories, tags, and global sets to entries. ([#12689](https://github.com/craftcms/cms/pull/12689), [#9781](https://github.com/craftcms/cms/discussions/9781))\n- Added the `sections/create` and `sections/delete` commands. ([#12689](https://github.com/craftcms/cms/pull/12689))\n- The `plugin/install`, `plugin/uninstall`, `plugin/enable`, and `plugin/disabled` commands now support an `--all` option, which applies the action to all applicable Composer-installed plugins. ([#11373](https://github.com/craftcms/cms/discussions/11373), [#12218](https://github.com/craftcms/cms/pull/12218))\n- The `project-config/apply` command now supports a `--quiet` option, which reduces the command output. ([#12568](https://github.com/craftcms/cms/discussions/12568))\n- Added the `users/unlock` console command. ([#12345](https://github.com/craftcms/cms/discussions/12345))\n- The Asset Indexes utility no longer skips volumes if the root folder was completely empty. ([#12585](https://github.com/craftcms/cms/issues/12585), [#12604](https://github.com/craftcms/cms/pull/12604))\n- The Asset Indexes utility now has a \u201cList empty folders\u201d setting, which determines whether empty folders should be listed for deletion from the index. ([#12604](https://github.com/craftcms/cms/pull/12604))\n- The Asset Indexes utility now lists missing/empty folders and files separately in the review screen. ([#12604](https://github.com/craftcms/cms/pull/12604))\n- Relational condition rules for conditions that are saved to the project config now accept a Twig template which outputs a related element ID dynamically. ([#12679](https://github.com/craftcms/cms/pull/12679), [#12676](https://github.com/craftcms/cms/discussions/12676))\n- Image transform settings no longer show the \u201cDefault Focal Point\u201d setting when Mode is set to \u201cFit\u201d, as the setting had no effect. ([#12774](https://github.com/craftcms/cms/pull/12774))\n- Improved the CLI output for `index-assets` commands. ([#12604](https://github.com/craftcms/cms/pull/12604))\n\n### Development\n- Added the \u201cLetterbox\u201d (`letterbox`) image transform mode. ([#8848](https://github.com/craftcms/cms/discussions/8848), [#12214](https://github.com/craftcms/cms/pull/12214))\n- Added the `preloadSingles` config setting, which causes front-end Twig templates to automatically preload Single section entries which are referenced in the template. ([#12698](https://github.com/craftcms/cms/pull/12787))\n- Control panel-defined image transforms now have an \u201cAllow Upscaling\u201d setting, which will initially be set to the `upscaleImages` config setting for existing transforms. ([#12214](https://github.com/craftcms/cms/pull/12214))\n- Template-defined image transforms can now have an `upscale` setting. The `upscaleImages` config setting will be used by default if not set. ([#12214](https://github.com/craftcms/cms/pull/12214))\n- Added the `exec` command, which executes an individual PHP statement and outputs the result. ([#12528](https://github.com/craftcms/cms/pull/12528))\n- Added the `editable` and `savable` asset query params. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added the `savable` entry query param. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- The `editable` entry query param can now be set to `false` to only show entries that _can\u2019t_ be viewed by the current user. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added the `{% dump %}` tag, which dumps variables into a new \u201cDumps\u201d Debug Toolbar panel. ([#12506](https://github.com/craftcms/cms/pull/12506))\n- Added the `base64_decode` and `base64_encode` Twig filters. ([#12696](https://github.com/craftcms/cms/discussions/12696))\n- The `dump()` Twig function now utilizes `Craft::dump()`, and no longer requires Dev Mode to be active. ([#12486](https://github.com/craftcms/cms/pull/12486), [#12479](https://github.com/craftcms/cms/discussions/12479))\n- The `{% dd %}` Twig tag can now output the entire `context` array, if no variable is passed to it. ([#12486](https://github.com/craftcms/cms/pull/12486))\n- Added the `revisionNotes` field to elements queried via GraphQL. ([#12610](https://github.com/craftcms/cms/issues/12610))\n- Added `ancestors` and `descendants` fields to categories queried via GraphQL. ([#12427](https://github.com/craftcms/cms/issues/12427))\n- Added `craft\\elements\\Asset::getFormat()` and the `format` field for assets queried via GraphQL. ([#12398](https://github.com/craftcms/cms/pull/12398), [#12521](https://github.com/craftcms/cms/pull/12521))\n- `Craft::dump()`, `Craft::dd()`, the `dump()` Twig function, and the `{% dd %}` Twig tag now use Symfony\u2019s VarDumper. ([#12479](https://github.com/craftcms/cms/discussions/12479))\n- `Craft::dump()` now has a `$return` argument, which will cause the resulting dump to be returned as a string rather than output, if `true`.\n- `craft\\elements\\Asset::getMimeType()` now has a `$transform` argument, and assets\u2019 `mimeType` GraphQL fields now support a `@transform` directive. ([#12269](https://github.com/craftcms/cms/discussions/12269), [#12397](https://github.com/craftcms/cms/pull/12397), [#12522](https://github.com/craftcms/cms/pull/12522))\n- `craft\\helpers\\App::env()` now returns `null` if the original value was `'null'`. ([#12742](https://github.com/craftcms/cms/pull/12742))\n- `craft\\helpers\\Db::escapeParam()` now escapes `:empty:` and `:notempty:` strings. ([#12691](https://github.com/craftcms/cms/discussions/12691))\n\n### Extensibility\n- Added support for private plugins. ([#12716](https://github.com/craftcms/cms/pull/12716), [#8908](https://github.com/craftcms/cms/discussions/8908))\n- Added the `elements/revisions` action. ([#12211](https://github.com/craftcms/cms/pull/12211))\n- Console controllers that directly use `craft\\console\\ControllerTrait` no longer need to call `$this->checkTty()` or `$this->checkRootUser()` themselves; they are now called from `ControllerTrait::init()` and `beforeAction()`.\n- Element source definitions can now include a `defaultSourcePath` key.\n- Element custom field validation now respects the list of attributes passed to `validate()`.\n- Improving IDE autocompletion for chained query param calls. ([#12656](https://github.com/craftcms/cms/pull/12656))\n- Added `craft\\base\\ApplicationTrait::getEditionHandle()`.\n- Added `craft\\base\\BaseFsInterface`. ([#12709](https://github.com/craftcms/cms/pull/12709))\n- Added `craft\\base\\Batchable`.\n- Added `craft\\base\\Element::cpRevisionsUrl()`.\n- Added `craft\\base\\Element::indexElements()`.\n- Added `craft\\base\\ElementInterface::findSource()`.\n- Added `craft\\base\\ElementInterface::getCpRevisionsUrl()`.\n- Added `craft\\base\\ElementInterface::getUiLabelPath()`.\n- Added `craft\\base\\ElementInterface::indexElementCount()`.\n- Added `craft\\base\\ElementInterface::setUiLabelPath()`.\n- Added `craft\\base\\Event`, which provides a `once()` static method for registering an event handler that will only be triggered up to one time.\n- Added `craft\\console\\ControllerTrait::beforeAction()`.\n- Added `craft\\console\\ControllerTrait::failure()`.\n- Added `craft\\console\\ControllerTrait::init()`.\n- Added `craft\\console\\ControllerTrait::markdownToAnsi()`.\n- Added `craft\\console\\ControllerTrait::note()`.\n- Added `craft\\console\\ControllerTrait::options()`.\n- Added `craft\\console\\ControllerTrait::runAction()`.\n- Added `craft\\console\\ControllerTrait::success()`.\n- Added `craft\\console\\ControllerTrait::tip()`.\n- Added `craft\\console\\ControllerTrait::warning()`.\n- Added `craft\\db\\QueryBatcher`.\n- Added `craft\\debug\\DumpPanel`.\n- Added `craft\\elements\\conditions\\assets\\ViewableConditionRule`. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added `craft\\elements\\conditions\\ElementCondition::$referenceElement`.\n- Added `craft\\elements\\conditions\\entries\\ViewableConditionRule`. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added `craft\\elements\\Entry::EVENT_DEFINE_PARENT_SELECTION_CRITERIA`. ([#12475](https://github.com/craftcms/cms/discussions/12475))\n- Added `craft\\events\\DefineInputOptionsEvent`. ([#12351](https://github.com/craftcms/cms/pull/12351))\n- Added `craft\\events\\ListVolumesEvent`.\n- Added `craft\\events\\UserPhotoEvent`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\fields\\BaseOptionsField::EVENT_DEFINE_OPTIONS`. ([#12351](https://github.com/craftcms/cms/pull/12351))\n- Added `craft\\fields\\BaseRelationField::$branchLimit`.\n- Added `craft\\fields\\BaseRelationField::$maintainHierarchy`.\n- Added `craft\\helpers\\Db::rawTableShortName()`.\n- Added `craft\\helpers\\ImageTransforms::generateTransform()`.\n- Added `craft\\helpers\\ImageTransforms::parseTransformString()`.\n- Added `craft\\helpers\\StringHelper::toHandle()`.\n- Added `craft\\helpers\\Template::fallback()`.\n- Added `craft\\helpers\\Template::fallbackExists()`.\n- Added `craft\\helpers\\Template::preloadSingles()`.\n- Added `craft\\image\\Raster::scaleToFitAndFill()`.\n- Added `craft\\image\\Raster::setFill()`.\n- Added `craft\\imagetransforms\\FallbackTransformer`.\n- Added `craft\\models\\CategoryGroup::$dateDeleted`.\n- Added `craft\\models\\ImageTransform::$fill`.\n- Added `craft\\models\\ImageTransform::$upscale`.\n- Added `craft\\models\\TagGroup::$dateDeleted`.\n- Added `craft\\models\\VolumeFolder::getHasChildren()`.\n- Added `craft\\models\\VolumeFolder::setHasChildren()`.\n- Added `craft\\queue\\BaseBatchedJob`. ([#12638](https://github.com/craftcms/cms/pull/12638))\n- Added `craft\\queue\\jobs\\GenerateImageTransform`. ([#12340](https://github.com/craftcms/cms/pull/12340))\n- Added `craft\\services\\Assets::createFolderQuery()`.\n- Added `craft\\services\\Assets::foldersExist()`.\n- Added `craft\\services\\Elements::deleteElementForSite()`.\n- Added `craft\\services\\Elements::deleteElementsForSite()`.\n- Added `craft\\services\\Elements::EVENT_AFTER_DELETE_FOR_SITE`. ([#12354](https://github.com/craftcms/cms/issues/12354))\n- Added `craft\\services\\Elements::EVENT_BEFORE_DELETE_FOR_SITE`. ([#12354](https://github.com/craftcms/cms/issues/12354))\n- Added `craft\\services\\Entries::getSingleEntriesByHandle()`. ([#12698](https://github.com/craftcms/cms/pull/12787))\n- Added `craft\\services\\Fields::getFieldsByType()`. ([#12381](https://github.com/craftcms/cms/discussions/12381))\n- Added `craft\\services\\Path::getImageTransformsPath()`.\n- Added `craft\\services\\Search::normalizeSearchQuery()`.\n- Added `craft\\services\\Users::EVENT_AFTER_DELETE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\services\\Users::EVENT_AFTER_SAVE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\services\\Users::EVENT_BEFORE_DELETE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\services\\Users::EVENT_BEFORE_SAVE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\utilities\\AssetIndexes::EVENT_LIST_VOLUMES`. ([#12383](https://github.com/craftcms/cms/pull/12383), [#12443](https://github.com/craftcms/cms/pull/12443))\n- Renamed `craft\\elements\\conditions\\assets\\EditableConditionRule` to `SavableConditionRule`, while preserving the original class name with an alias. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Renamed `craft\\elements\\conditions\\entries\\EditableConditionRule` to `SavableConditionRule`, while preserving the original class name with an alias. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- `craft\\services\\AssetIndexer::startIndexingSession()` and `createIndexingSession()` now have a `$listEmptyFolders` argument. ([#12604](https://github.com/craftcms/cms/pull/12604))\n- `craft\\base\\ElementQuery::joinElementTable()` now accepts table names in the format of `{{%tablename}}`.\n- `craft\\models\\Volume` now implements `craft\\base\\BaseFsInterface`. ([#12709](https://github.com/craftcms/cms/pull/12709))\n- `craft\\services\\Categories::getGroupByHandle()` now has a `$withTrashed` argument.\n- `craft\\services\\Globals::getSetByHandle()` now has a `$withTrashed` argument.\n- `craft\\services\\Tags::getTagGroupByHandle()` now has a `$withTrashed` argument.\n- `craft\\services\\Users::sendActivationEmail()`, `sendNewEmailVerifyEmail()`, `sendPasswordResetEmail()`, `getActivationUrl()`, `getEmailVerifyUrl()`, `getPasswordResetUrl()`, and `setVerificationCodeOnUser()` will now throw a `craft\\errors\\InvalidElementException` if the user has a non-unique email. ([#12431](https://github.com/craftcms/cms/issues/12431), [#12712](https://github.com/craftcms/cms/pull/12712))\n- Deprecated `craft\\elements\\Asset::getFs()`. `getVolume()` should be used instead.\n- Deprecated `craft\\helpers\\Assets::sortFolderTree()`.\n- Deprecated `craft\\imagetransforms\\ImageTransformer::ensureTransformUrlByIndexModel()`. `getTransformUrl()` should be used instead.\n- Deprecated `craft\\imagetransforms\\ImageTransformer::procureTransformedImage()`. `generateTransform()` should be used instead.\n- Deprecated `craft\\queue\\jobs\\GeneratePendingTransforms`. `GenerateImageTransform` should be used instead. ([#12340](https://github.com/craftcms/cms/pull/12340))\n- Deprecated `craft\\services\\Assets::getFolderTreeByFolderId()`.\n- Deprecated `craft\\services\\Assets::getFolderTreeByVolumeIds`.\n- Added `Craft.Accordion`. ([#12189](https://github.com/craftcms/cms/pull/12189))\n- Added `Craft.AssetMover`.\n- Added `Craft.BaseElementIndex::getSourcePathActionLabel()`.\n- Added `Craft.BaseElementIndex::getSourcePathActions()`.\n- Added `Craft.BaseElementIndex::getSourcePathLabel()`.\n- Added `Craft.BaseElementIndex::onSourcePathChange()`.\n- Added `Craft.BaseElementIndex::sourcePath`.\n- Added `Craft.BaseElementSelectorModal::getElementIndexParams()`.\n- Added `Craft.BaseElementSelectorModal::getIndexSettings()`.\n- Added `Craft.BaseElementSelectorModal::hasSelection()`.\n- Added `Craft.ElementFieldSettings`.\n- Added `Craft.VolumeFolderSelectorModal`.\n- Added `Garnish.MultiFunctionBtn`.\n- The custom `activate` jQuery event will now trigger when the <kbd>Return</kbd> key is pressed.\n- The custom `activate` jQuery event will no longer trigger for <kbd>Ctrl</kbd>/<kbd>Command</kbd>-clicks.\n- Deprecated `Craft.CategorySelectInput`. `Craft.BaseElementSelectInput` should be used instead. ([#11749](https://github.com/craftcms/cms/pull/11749))\n\n### System\n- Improved element deletion performance. ([#12223](https://github.com/craftcms/cms/pull/12223))\n- Improved queue performance. ([#12274](https://github.com/craftcms/cms/issues/12274), [#12340](https://github.com/craftcms/cms/pull/12340))\n- \u201cApplying new propagation method to elements\u201d, \u201cPropagating [element type]\u201d, and \u201cResaving [element type]\u201d queue jobs are now split up into batches of up to 100 items. ([#12638](https://github.com/craftcms/cms/pull/12638))\n- Assets\u2019 alternative text values are now included as search keywords.\n- Entry type, section, category group, and tag group deletion no longer involves looping through all affected entries/categories/tags and deleting each one individually via `craft\\services\\Elements::deleteElement()`. ([#12665](https://github.com/craftcms/cms/pull/12665))\n- Updated LitEmoji to v4. ([#12226](https://github.com/craftcms/cms/discussions/12226))\n- Fixed a database deadlock error that could occur when updating a relation or structure position for an element that was simultaneously being saved. ([#9905](https://github.com/craftcms/cms/issues/9905))\n- Fixed a bug where element query `select()` and `orderBy()` params could resolve element extension table column names to custom field columns, if a custom field had a conflicting handle. ([#12652](https://github.com/craftcms/cms/issues/12652))\n- Fixed a bug where it was possible to activate inactive users with non-unique emails. ([#12431](https://github.com/craftcms/cms/issues/12431), [#12712](https://github.com/craftcms/cms/pull/12712))\n- Fixed a bug where hint text within Selectize menus had extremely low contrast on hover. ([#12829](https://github.com/craftcms/cms/issues/12829))\n\n## 4.3.11 - 2023-03-07\n\n- Fixed a bug where `craft\\events\\RegisterElementSourcesEvent::$context` wasn\u2019t always set to `modal` when defining the available element sources for an element selection modal.\n- Fixed a styling bug where multi-line checkbox labels within the Customize Sources modal and View menu weren\u2019t wrapping properly. ([#12717](https://github.com/craftcms/cms/issues/12717))\n- Fixed a bug where asset thumbnails within collapsed Matrix blocks weren\u2019t loading when the block was expanded. ([#12720](https://github.com/craftcms/cms/issues/12720))\n- Fixed a bug where user activation/verification/reset-password URLs could be root-relative, if the `@web` alias was explicitly set to a root-relative URL.\n- Fixed a PHP error that could occur if an options field\u2019s condition rule wasn\u2019t configured with any values. ([#12713](https://github.com/craftcms/cms/pull/12713))\n- Fixed a bug where control panel notifications weren\u2019t being announced to screen readers. ([#12714](https://github.com/craftcms/cms/pull/12714))\n- Fixed a bug where localized relations could be moved to a newly-added site rather than copied, when applying project config changes. ([#12702](https://github.com/craftcms/cms/issues/12702))\n- Fixed a bug where element indexes\u2019 \u201cView\u201d buttons could be inconsistently positioned in the toolbar.\n- Fixed a bug where element selector modal footers could hide the modal contents. ([#12708](https://github.com/craftcms/cms/issues/12708))\n- Fixed a bug where asset thumbnails weren\u2019t respecting the `generateTransformsBeforePageLoad` config setting. ([#12750](https://github.com/craftcms/cms/issues/12750))\n- Fixed a bug where soft hyphens, non-breaking spaces, zero-width characters, invisible times characters, and invisible separators weren\u2019t getting stripped from sanitized asset filenames. ([#12741](https://github.com/craftcms/cms/issues/12741), [#12759](https://github.com/craftcms/cms/pull/12759))\n- Fixed a bug where custom fields\u2019 database columns would get deleted when applying project config changes, if the field type wasn\u2019t present. ([#12760](https://github.com/craftcms/cms/issues/12760))\n- Fixed an error that could occur if a non-numeric value was entered into an image transform\u2019s Width or Height settings. ([#12776](https://github.com/craftcms/cms/pull/12776))\n- Fixed a bug where Assets, Categories, and Tags fields weren\u2019t respecting their \u201cAllow self relations\u201d settings. ([#12769](https://github.com/craftcms/cms/issues/12769))\n- Fixed a bug where dynamically-generated entry titles weren\u2019t always generated with the site\u2019s formatting locale in place. ([12780](https://github.com/craftcms/cms/issues/12780))\n- Fixed a bug where element titles weren\u2019t getting a pointer cursor or underlines on hover, when selected on an element index page.\n- Fixed a bug where it wasn\u2019t possible to close modals that were opened by a custom select menu via the <kbd>Esc</kbd> key. ([#12814](https://github.com/craftcms/cms/pull/12814))\n- Fixed an error that could occur when saving an element with an eager-loaded Matrix field. ([#12815](https://github.com/craftcms/cms/issues/12815))\n- Fixed a bug where the \u201csend to Developer Support\u201d links within the Craft Support widget weren\u2019t working. ([#12822](https://github.com/craftcms/cms/issues/12822))\n\n## 4.3.10 - 2023-02-17\n\n- Fixed a bug where clicking on the scrollbar of a disclosure menu would close it. ([#12681](https://github.com/craftcms/cms/issues/12681))\n- Fixed an error that could occur when loading the Plugin Store, if there wasn\u2019t a `.env` file. ([#12687](https://github.com/craftcms/cms/issues/12687))\n- Fixed a bug where large asset thumbnails weren\u2019t centered within Assets fields. ([#12682](https://github.com/craftcms/cms/issues/12682))\n- Fixed a PHP error that could occur when versioning asset URLs. ([#12678](https://github.com/craftcms/cms/issues/12678))\n- Fixed a bug where the \u201cSite\u201d element condition rule was available for non-localizable element types\u2019 conditions. ([#12601](https://github.com/craftcms/cms/pull/12601))\n- Fixed a bug where it wasn\u2019t possible to sort assets within subfolders by anything besides the asset title. ([#12688](https://github.com/craftcms/cms/issues/12688))\n\n## 4.3.9 - 2023-02-14\n\n- Image thumbnails and previews are no longer versioned if their image URL doesn\u2019t begin with one of the asset\u2019s base filesystem URLs. ([#12663](https://github.com/craftcms/cms/issues/12663))\n- HTML Purifier now allows `oembed` tags. ([craftcms/ckeditor#59](https://github.com/craftcms/ckeditor/issues/59))\n- Added `craft\\htmlpurifier\\VideoEmbedUrlDef`.\n- `craft\\helpers\\Assets::revUrl()` now has an `$fsOnly` argument.\n- Fixed a bug where entries that aren\u2019t propagated to the primary site weren\u2019t showing revision notes. ([#12641](https://github.com/craftcms/cms/issues/12641))\n- Fixed a bug where HTML tags weren\u2019t getting stripped from auto-generated Handle and URI Format setting values.\n- Fixed a JavaScript error that could occur if an object with `null` values was passed to `Craft.compare()`.\n- Fixed a bug where `craft\\elements\\db\\ElementQuery::toArray()` was calling getter methods whose names conflicted with custom field handles. ([#12635](https://github.com/craftcms/cms/pull/12635))\n\n## 4.3.8.2 - 2023-02-08\n\n- Fixed a PHP error that could occur if relational fields were getting eager-loaded for elements that the fields didn\u2019t belong to. ([#12648](https://github.com/craftcms/cms/issues/12648))\n\n## 4.3.8.1 - 2023-02-08\n\n- Fixed a PHP error that occurred after performing a Composer action within Craft. ([#12647](https://github.com/craftcms/cms/issues/12647))\n- Fixed a bug where element attributes weren\u2019t getting eager-loaded. ([#12646](https://github.com/craftcms/cms/pull/12646), [#12645](https://github.com/craftcms/cms/issues/12645))\n- Fixed a bug where image previews weren\u2019t getting versioned, unless the `revAssetUrls` config setting was enabled. ([#12603](https://github.com/craftcms/cms/issues/12603))\n\n## 4.3.8 - 2023-02-07\n\n- Updated Composer to 2.2.19, fixing a PHP error that could occur when performing a Composer action within Craft, when the autoload classmap was generated with Composer 2.5. ([#12482](https://github.com/craftcms/cms/issues/12482))\n- Fixed a bug where Matrix blocks weren\u2019t getting eager-loaded. ([#12631](https://github.com/craftcms/cms/issues/12631))\n- Fixed a PHP error that could occur when calling `craft\\services\\Assets::getAllDescendantFolders()` for the root folder. ([craftcms/feed-me#1231](https://github.com/craftcms/feed-me/issues/1231))\n- Fixed a bug where revision notes weren\u2019t always being retained for provisional drafts. ([#12641](https://github.com/craftcms/cms/issues/12641))\n- Fixed a bug where it wasn\u2019t possible to access the Customize Sources modal on element index pages, if all sources were disabled. ([#12634](https://github.com/craftcms/cms/issues/12634))\n\n## 4.3.7.1 - 2023-02-05\n\n- The `_includes/forms/checkbox.twig`, `select.twig`, and `text.twig` templates no longer add an `aria-labelledby` attribute to the input if an `aria-label` attribute is also specified.\n- `craft\\helpers\\Cp::dateTimeFieldHtml()` now returns inputs contained within a fieldset.\n- Fixed a bug where some inputs were getting `aria-labelledby` attributes that referenced a nonexistent label ID.\n- Fixed a bug where the first changes to entries weren\u2019t saving properly. ([#12623](https://github.com/craftcms/cms/issues/12623), [#12592](https://github.com/craftcms/cms/issues/12592))\n- Fixed a bug where `craft\\behaviors\\CustomFieldBehavior::$owner` was getting nullified by `craft\\base\\Element::fieldByHandle()`. ([#12624](https://github.com/craftcms/cms/issues/12624))\n\n## 4.3.7 - 2023-02-03\n\n- Improved the performance of the \u201cGenerating pending image transforms\u201d queue job. ([#12274](https://github.com/craftcms/cms/issues/12274))\n- Removed the \u201cTimeout\u201d setting from the Gmail and SMTP mailer transporters, as they aren\u2019t supported by Symfony Mailer\u2019s transport configuration.\n- Removed the \u201cEncryption Method\u201d setting from the SMTP mailer transporter, as Symfony Mailer already uses TLS when port 465 is used (as it is by default).\n- The \u201cPort\u201d setting on the SMTP mailer transporter is no longer required. It will default to 465 or 25 depending on whether OpenSSL is installed.\n- Added more reserved field handles to avoid conflicts with `craft\\base\\Element` properties. ([#12577](https://github.com/craftcms/cms/issues/12577))\n- Assets\u2019 `alt` properties are now automatically trimmed of leading/trailing whitespace.\n- Asset element components in the control panel now include a `data-alt` attribute. ([#12600](https://github.com/craftcms/cms/discussions/12600))\n- Control panel requests no longer override the `pageTrigger` config setting value to `'p'`. ([#12598](https://github.com/craftcms/cms/issues/12598), [#12614](https://github.com/craftcms/cms/pull/12614))\n- Fixed field status badge styling in some contexts. ([#12403](https://github.com/craftcms/cms/issues/12403))\n- Fixed a bug where exporting elements with multiple field layouts as a CSV file using the \u201cExpanded\u201d export type would result in mismatched column values.\n- Fixed a bug where cancelling a conflicting volume folder move would result in the moved folder getting deleted.\n- Fixed a bug where `craft\\elements\\Category::canDuplicate()` wasn\u2019t factoring in save permissions.\n- Fixed a bug where the horizontal scroll position wasn\u2019t being retained when refreshing Live Preview. ([#12504](https://github.com/craftcms/cms/issues/12504))\n- Fixed a bug where user group condition rules for the default user group weren\u2019t getting matched properly during public registration. ([#12283](https://github.com/craftcms/cms/issues/12283))\n- Fixed a bug where HTML tags within field labels, instructions, tips, and warnings weren\u2019t always getting escaped.\n- Fixed a bug where the sidebar scroll position wasn\u2019t retained when selecting a new source on element index pages. ([#12523](https://github.com/craftcms/cms/issues/12523))\n- Fixed a bug where `resave/*` commands\u2019 output didn\u2019t take the offset into account. ([#12526](https://github.com/craftcms/cms/issues/12526))\n- Fixed a bug where warnings were getting logged for video assets that were \u201cmissing\u201d their dimensions.\n- Fixed a bug where `craft\\services\\Assets::getAllDescendantFolders()` could return unexpected results for folders that contained an underscore.\n- Fixed a bug where accessing a custom field\u2019s magic property on an element would return the field\u2019s raw database value rather than `null`, if it didn\u2019t belong to the element\u2019s field layout anymore. ([#12539](https://github.com/craftcms/cms/issues/12539), [#12578](https://github.com/craftcms/cms/pull/12578))\n- Fixed a bug where previewing an asset could wipe out all `h1` tags within Redactor fields. ([#12545](https://github.com/craftcms/cms/issues/12545))\n- Fixed a bug where `craft\\image\\Raster::getIsTransparent()` wasn\u2019t working. ([#12565](https://github.com/craftcms/cms/issues/12565))\n- Fixed a bug where textual condition rules were still showing a text input when the \u201cis empty\u201d or \u201chas a value\u201d operators were selected. ([#12587](https://github.com/craftcms/cms/pull/12587))\n- Fixed a bug where the component name comments in project config YAML files would always lag behind the current project config a little. ([#12576](https://github.com/craftcms/cms/issues/12576), [#12581](https://github.com/craftcms/cms/pull/12581))\n- Fixed a SQL error that occurred when creating a database backup using the default backup command, when running MySQL 5.7.41+ or 8.0.32+. ([#12557](https://github.com/craftcms/cms/issues/12557), [#12560](https://github.com/craftcms/cms/pull/12560))\n- Fixed a bug where database backups weren\u2019t respecting SSL database connection settings if they were specified when using MySQL. ([#10351](https://github.com/craftcms/cms/issues/10351), [#11753](https://github.com/craftcms/cms/issues/11753), [#12596](https://github.com/craftcms/cms/pull/12596))\n- Fixed a bug where element indexes could stop showing their loading spinner prematurely if the element listing needed to be reloaded multiple times in rapid succession. ([#12595](https://github.com/craftcms/cms/issues/12595))\n- Fixed a bug where element editors wouldn\u2019t show tabs that didn\u2019t contain any characters that could be converted to ASCII. ([#12602](https://github.com/craftcms/cms/issues/12602))\n- Fixed a bug where asset thumbnails weren\u2019t getting versioned in the control panel, unless the `revAssetUrls` config setting was enabled. ([#12603](https://github.com/craftcms/cms/issues/12603))\n- Fixed a bug where entry relations could be lost when switching entry types, for relational fields that didn\u2019t exist on the prior entry type. ([#12592](https://github.com/craftcms/cms/issues/12592))\n- Fixed a bug where Matrix blocks weren\u2019t getting duplicated to other sites when first editing an unpublished draft. ([#11366](https://github.com/craftcms/cms/issues/11366))\n- Fixed a bug where element indexes would show an expand/collapse toggle for structured elements that only had unsaved draft children, which aren\u2019t actually shown. ([#11253](https://github.com/craftcms/cms/issues/11253))\n- Fixed a SQL error that occurred when running the `index-assets` command on PostgreSQL. ([#12617](https://github.com/craftcms/cms/issues/12617))\n- Added `craft\\helpers\\Assets::revUrl()`.\n- Added `craft\\helpers\\Db::escapeForLike()`.\n- Added `craft\\web\\twig\\variables\\Paginate::$pageTrigger`. ([#12614](https://github.com/craftcms/cms/pull/12614))\n- `craft\\helpers\\Assets::revParams()` no longer takes the `revAssetUrls` config setting into account. That should be factored in by whatever is calling it.\n- `craft\\services\\Assets::getAllDescendantFolders()` now has a `$withParent` argument, which can be passed `false` to omit the parent folder from the results. ([#12536](https://github.com/craftcms/cms/issues/12536))\n- `craft\\services\\Matrix::duplicateBlocks()` now has a `$force` argument.\n- Deprecated `craft\\helpers\\DateTimeHelper::timeZoneAbbreviation()`.\n- Deprecated `craft\\helpers\\DateTimeHelper::timeZoneOffset()`.\n\n## 4.3.6.1 - 2023-01-09\n\n- Element edit pages now retain their previous scroll position when they\u2019re automatically refreshed to keep up with changes from another browser tab.\n- Fixed a bug where editing certain Matrix/Neo/Super Table fields could result in content loss. ([#12445](https://github.com/craftcms/cms/issues/12445))\n\n## 4.3.6 - 2023-01-04\n\n- Template caching is no longer enabled for tokenized requests. ([#12458](https://github.com/craftcms/cms/issues/12458))\n- Elisions are now stripped from search keywords. ([#12467](https://github.com/craftcms/cms/issues/12467), [#12474](https://github.com/craftcms/cms/pull/12474))\n- Added support for HEIC/HEIF images. ([#9115](https://github.com/craftcms/cms/discussions/9115))\n- The `allowedFileExtensions` config setting now includes `heic`, `heif`, and `hevc` by default. ([#12490](https://github.com/craftcms/cms/discussions/12490))\n- It\u2019s now possible to assign aliases `children` fields queried via GraphQL. ([#12494](https://github.com/craftcms/cms/pull/12494))\n- Added `craft\\helpers\\Image::isWebSafe()`.\n- Added `craft\\services\\Images::getSupportsHeic()`.\n- `Craft.MatrixInput` now fires `blockSortDragStop`, `beforeMoveBlockUp`, `moveBlockUp`, `beforeMoveBlockDown`, and `moveBlockDown` events. ([#12498](https://github.com/craftcms/cms/pull/12498))\n- Fixed a bug where deleting a field layout tab could result in duplicated tabs. ([#12459](https://github.com/craftcms/cms/issues/12459))\n- Fixed a bug where Feed widgets weren\u2019t showing feed items when they were first loaded. ([#12460](https://github.com/craftcms/cms/issues/12460))\n- Fixed an error that occurred when a Date field\u2019s condition rule was set to a relative range, \u201chas a value\u201d, or \u201cis empty\u201d. ([#12457](https://github.com/craftcms/cms/issues/12457))\n- Fixed an error that could occur when processing template caches in a console request, if a globally-scoped template cache was processed before it.\n- Fixed styling issues with large element thumbnail views. ([#12455](https://github.com/craftcms/cms/issues/12455))\n- Fixed a bug where it wasn\u2019t possible to retry all failed jobs when using a proxy queue. ([#12471](https://github.com/craftcms/cms/issues/12471))\n- Fixed a bug where the selected table columns would be forgotten if modified from a nested source. ([#12477](https://github.com/craftcms/cms/issues/12477))\n- Fixed a bug where some custom field property types in `craft\\behaviors\\CustomFieldBehavior` were incorrect.\n- Fixed an error that could occur if a Matrix sub-field\u2019s handle was too long. ([#12422](https://github.com/craftcms/cms/issues/12422))\n- Fixed a bug where element editor slideouts\u2019 submit buttons weren\u2019t always consistent with the full-page edit form. ([#12487](https://github.com/craftcms/cms/issues/12487))\n- Fixed an XSS vulnerability.\n\n## 4.3.5 - 2022-12-13\n\n- Fixed a bug where entry tab contents could remain visible when switching to other tabs, after changing the entry type.\n- Fixed a bug where it wasn\u2019t possible to enter `0` in Number fields, Money fields, and numeric column cells within editable tables, using certain keyboard layouts. ([#12412](https://github.com/craftcms/cms/issues/12412))\n- Fixed a bug where the default MySQL restore command would attempt to use credentials from `~/.my.cnf` if it existed, instead of Craft\u2019s configured database connection settings. ([#12349](https://github.com/craftcms/cms/issues/12349), [#12430](https://github.com/craftcms/cms/pull/12430))\n- Fixed a JavaScript error that could occur when autosaving an entry draft. ([#12445](https://github.com/craftcms/cms/issues/12445))\n- Added `craft\\base\\ApplicationTrait::onInit()`. ([#12439](https://github.com/craftcms/cms/pull/12439))\n- Added `craft\\console\\Controller::createDirectory()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::do()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::failure()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::note()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::success()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::tip()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::warning()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::writeJson()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::writeToFile()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\helpers\\FileHelper::absolutePath()`.\n- Added `craft\\helpers\\FileHelper::findClosestFile()`.\n- Added `craft\\helpers\\FileHelper::isWithin()`.\n- Added `craft\\helpers\\FileHelper::relativePath()`.\n- Added `craft\\helpers\\Json::decodeFromFile()`.\n- Added `Craft.filterInputVal()`.\n- Added `Craft.filterNumberInputVal()`.\n\n## 4.3.4 - 2022-11-29\n\n- The `serve` command now routes requests for nonexistent files to Craft. ([#12310](https://github.com/craftcms/cms/pull/12310))\n- `craft\\base\\Element::includeSetStatusAction()` now returns `false` by default regardless of what `hasStatuses()` returns, fixing a bug where some element indexes were unexpectedly getting \u201cSet Status\u201d actions.\n- Query conditions generated by `craft\\helpers\\Db::parseParam()` no longer account for `null` values, due to a heavy performance impact. ([#11931](https://github.com/craftcms/cms/issues/11931))\n- Fixed a bug where the default MySQL backup command would attempt to use credentials from `~/.my.cnf` if it existed, instead of Craft\u2019s configured database connection settings. ([#12349](https://github.com/craftcms/cms/issues/12349))\n- Fixed a bug where it wasn\u2019t possible to access the Customize Sources modal if all sources were disabled. ([#12369](https://github.com/craftcms/cms/issues/12369))\n- Fixed a bug where Assets fields weren\u2019t taking their \u201cShow unpermitted volumes\u201d setting into account when defining the available input sources. ([#12364](https://github.com/craftcms/cms/issues/12364))\n- Fixed a bug where user slideouts included status toggles.\n- Updated Yii to 2.0.47.\n\n## 4.3.3 - 2022-11-17\n\n- Fixed an error that occurred if an arrow function was passed to the `|sort` Twig filter. ([#12334](https://github.com/craftcms/cms/issues/12334))\n- Fixed a bug where nested fields set to numbers could be inadvertently changed when an entry draft was created.\n- `craft\\services\\Fields::getFieldsWithContent()` and `getFieldsWithoutContent()` now have `$context` arguments.\n\n## 4.3.2.1 - 2022-11-16\n\n- Fixed a PHP error that could occur when generating an image transform. ([#12333](https://github.com/craftcms/cms/issues/12333))\n\n## 4.3.2 - 2022-11-16\n\n- `firstName` and `lastName` are now reserved field handles for the user field layout. ([#12241](https://github.com/craftcms/cms/issues/12241), [#12316](https://github.com/craftcms/cms/pull/12316))\n- Asset filenames are truncated in large thumbnail views, as they were before 4.3.0. ([#12236](https://github.com/craftcms/cms/discussions/12236))\n- Fixed an information disclosure vulnerability.\n- Fixed an XSS vulnerability.\n- Fixed asset indexing for Local filesystems that were configured to use a symlinked server path.\n- Fixed an error that could occur when calling `craft\\base\\Element::getCanonicalUid()` on a draft loaded for a site that the canonical element didn\u2019t exist on yet. ([#12228](https://github.com/craftcms/cms/issues/12228))\n- Fixed a bug where long words in asset titles weren\u2019t wrapping in the large thumbnail view. ([#12237](https://github.com/craftcms/cms/issues/12237))\n- Fixed a bug where the Users index page was showing a \u201cSet Status\u201d bulk action, making it possible to disable users.\n- Disabled users now identify themselves as disabled, and Edit User pages now provide a way for them to be re-enabled.\n- Fixed a layout issue that could occur on Assets fields using the \u201cLarge Thumbnails\u201d view mode. ([#12230](https://github.com/craftcms/cms/issues/12230))\n- Fixed a bug where elements that weren\u2019t viewable by the current user could still be hyperlinked in element indexes.\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateInterval()` could return a `DateInterval` that was off by an hour around daylight savings time changes.\n- Fixed a bug where sticky element index footers were obstructed when the Debug Toolbar was enabled. ([#12242](https://github.com/craftcms/cms/issues/12242))\n- Fixed a bug where it wasn\u2019t possible to change the sort attribute on element indexes while searching. ([#12256](https://github.com/craftcms/cms/issues/12256))\n- Fixed a bug where `resave/*` commands weren\u2019t catching exceptions thrown when applying the `--set` and `--to` options. ([#12262](https://github.com/craftcms/cms/issues/12262))\n- Fixed the position of field status indicators within Matrix fields in Live Preview. ([#12287](https://github.com/craftcms/cms/issues/12287))\n- Fixed PHP errors that could occur when executing GraphQL queries. ([#12271](https://github.com/craftcms/cms/pull/12271), [#12275](https://github.com/craftcms/cms/pull/12275))\n- Fixed a bug where it was possible to add a \u201cStatus\u201d condition rule to relational fields\u2019 selectable element conditions. ([#12289](https://github.com/craftcms/cms/issues/12289))\n- Fixed a PHP error that occurred if a field type stored enum values. ([#12297](https://github.com/craftcms/cms/issues/12297))\n- Fixed a bug where PHP errors and exceptions thrown when formatting a control panel screen response weren\u2019t being handled properly. ([#12308](https://github.com/craftcms/cms/issues/12308))\n- Fixed a bug where element indexes were showing the labels of empty Dropdown options when selected. ([#12319](https://github.com/craftcms/cms/issues/12319))\n- Fixed condition builder styling issues that occurred if any rules had exceptionally long names. ([#12311](https://github.com/craftcms/cms/issues/12311))\n- Fixed an error that occurred when saving an entry via GraphQL, if a parent entry was assigned that didn\u2019t exist on the requested site. ([#12291](https://github.com/craftcms/cms/issues/12291))\n- Fixed a bug where conditional fields weren\u2019t always saving for elements that didn\u2019t support autosaved drafts. ([#12166](https://github.com/craftcms/cms/issues/12166))\n- Fixed a bug where fields set to numbers could be inadvertently changed when an entry draft was created.\n- Added `craft\\base\\Element::includeSetStatusAction()`.\n- Added `craft\\services\\Fields::getFieldsWithoutContent()`.\n\n## 4.3.1 - 2022-10-27\n\n- Numeric values are no longer automatically formatted within element indexes. ([#12205](https://github.com/craftcms/cms/issues/12205))\n- When `craft\\base\\Element::EVENT_DEFINE_URL` event handlers set `craft\\events\\DefineUrlEvent::$url` to `null`, that will no longer be respected unless `$handled` was also set to `true`. ([#12210](https://github.com/craftcms/cms/issues/12210), [nystudio107/craft-imageoptimize#359](https://github.com/nystudio107/craft-imageoptimize/issues/359))\n- Asset folder and file names are now converted to ASCII using the primary site\u2019s language for character mappings, regardless of the current user\u2019s preferred language, when the `convertFilenamesToAscii` config setting is enabled. ([#12207](https://github.com/craftcms/cms/discussions/12207))\n- Fixed a bug where locked users\u2019 remaining cooldown times could be calculated incorrectly on PHP 8.0.\n- Fixed an infinite recursion bug that occurred when editing a Matrix field with a custom propagation method. ([#12176](https://github.com/craftcms/cms/issues/12176))\n- Fixed a bug where element index source lists were showing headings that didn\u2019t have any visible nested sources. ([#12193](https://github.com/craftcms/cms/issues/12193))\n- Fixed a JavaScript 404 error that occurred when users\u2019 Language was set to Chinese. ([#12194](https://github.com/craftcms/cms/issues/12194))\n- Fixed a bug where users couldn\u2019t delete their own addresses. ([craftcms/commerce#3011](https://github.com/craftcms/commerce/issues/3011))\n- Fixed a bug where the `users/save-address` action wasn\u2019t validating addresses properly.\n- Fixed an error that could occur during garbage collection, if any nested volume folders were missing their path. ([#12195](https://github.com/craftcms/cms/issues/12195))\n\n## 4.3.0 - 2022-10-25\n\n### Content Management\n- Added a \u201cView\u201d menu to element indexes, which enable users to customize the visible table columns for themselves, without affecting other users. ([#11915](https://github.com/craftcms/cms/pull/11915))\n- Added source setting menus to element index pages, which now contain the \u201cCustomize sources\u201d option when allowed, and \u201cNew subfolder\u201d, \u201cRename folder\u201d, and \u201cDelete folder\u201d actions on the Assets index page. ([#11906](https://github.com/craftcms/cms/pull/11906))\n- Added the \u201cEditable\u201d rule to asset and entry conditions. ([#11995](https://github.com/craftcms/cms/discussions/11995))\n- Improved control panel mobile support. ([#11963](https://github.com/craftcms/cms/pull/11963), [#12005](https://github.com/craftcms/cms/pull/12005))\n- Element indexes now respect field layouts\u2019 user conditions when determining which custom field columns to show. ([#11913](https://github.com/craftcms/cms/pull/11913))\n- Element index URLs now include the selected source key in a `source` query param, so all sources are now deep-linkable, including custom sources. ([#11996](https://github.com/craftcms/cms/discussions/11996))\n- Notifications are now shown after executing folder actions on the Assets index page. ([#11906](https://github.com/craftcms/cms/pull/11906))\n- Date range condition rules now support \u201cToday\u201d, \u201cThis week\u201d, \u201cThis month\u201d, \u201cThis year\u201d, \u201cPast 7 days\u201d, \u201cPast 30 days\u201d, \u201cPast 30 days\u201d, \u201cPast year\u201d, \u201cBefore\u2026\u201d, and \u201cAfter\u2026\u201d relative range types, in addition to specifying a custom date range. ([#10749](https://github.com/craftcms/cms/discussions/10749), [#11888](https://github.com/craftcms/cms/pull/11888))\n- Number condition rules now support an \u201cis between\u2026\u201d operator. ([#11950](https://github.com/craftcms/cms/pull/11950))\n- All text, number, and date range condition rules now support \u201chas a value\u201d and \u201cis empty\u201d operators. ([#11070](https://github.com/craftcms/cms/discussions/11070))\n- \u201cSave as a new [element type]\u201d actions will now discard any unsaved changes on the original element after the new element is created. ([#10204](https://github.com/craftcms/cms/issues/10204), [#11959](https://github.com/craftcms/cms/issues/11959), [#12102](https://github.com/craftcms/cms/issues/12102), [#12165](https://github.com/craftcms/cms/issues/12165))\n- If Live Preview is triggered while a draft is saving, it will now wait until the save completes before opening. ([#11858](https://github.com/craftcms/cms/issues/11858), [#11895](https://github.com/craftcms/cms/pull/11895))\n- Addresses now support change tracking.\n- It\u2019s now possible to restore assets that were deleted programmatically with `craft\\elements\\Asset::$keepFile` set to `true`. ([#11761](https://github.com/craftcms/cms/issues/11761))\n\n### Accessibility\n- Improved the styling of selected sidebar navigation items to meet contrast requirements. ([#11589](https://github.com/craftcms/cms/pull/11589))\n- Improved the styling of slideouts for screens under 600 pixels wide. ([#11636](https://github.com/craftcms/cms/pull/11636))\n- Improved the styling of the primary button on element index pages for small screens. ([#11963](https://github.com/craftcms/cms/pull/11963))\n- Improved the contrast of modal resize handles. ([#11727](https://github.com/craftcms/cms/pull/11727))\n- Improved the contrast of fields\u2019 searchable and translatable indicator icons on the Fields index page. ([#12169](https://github.com/craftcms/cms/pull/12169))\n- Improved the contrast of the \u201cSame as language\u201d text within the \u201cFormatting Locale\u201d user preference. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Improved the contrast of the selected options within combo boxes. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved the readability of the global navigation and date pickers when text is resized to 200%. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Improved focus management for HUD components. ([#11985](https://github.com/craftcms/cms/pull/11985))\n- Improved focus management for element index pagination links.  ([#11565](https://github.com/craftcms/cms/pull/11565)).\n- Improved focus management for editable tables. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Custom slider components now support <kbd>Home</kbd> and <kbd>End</kbd> key presses. ([#11578](https://github.com/craftcms/cms/pull/11578))\n- Improved the markup and keyboard control for exclusive button groups. ([#11942](https://github.com/craftcms/cms/pull/11942))\n- Improved keyboard control for the widget manager HUD on the Dashboard. ([#11578](https://github.com/craftcms/cms/pull/11578))\n- Improved New Widget and Quick Post action menus for screen readers. ([#11611](https://github.com/craftcms/cms/pull/11611))\n- Improved the widget manager HUD for screen readers. ([#11945](https://github.com/craftcms/cms/pull/11945))\n- Improved the Craft Support widget for screen readers. ([#11703](https://github.com/craftcms/cms/pull/11703))\n- Improved element index view mode buttons for screen readers. ([#11613](https://github.com/craftcms/cms/pull/11613))\n- Improved element type selects within \u201cRelated To\u201d condition rules for screen readers. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved element action modals for screen readers. ([#11905](https://github.com/craftcms/cms/issues/7377))\n- Improved field instructions, errors, and other visually-related text for screen readers. ([#11763](https://github.com/craftcms/cms/issues/7377))\n- Improved field translation indicators for screen readers. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved the parent selection button on structured entries\u2019 and categories\u2019 edit pages for screen readers. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved the Rotate button within Live Preview for screen readers. ([#11953](https://github.com/craftcms/cms/pull/11953))\n- Improved Date fields for screen readers. ([#10546](https://github.com/craftcms/cms/pull/10546))\n- Fixed a mismatch between the visible and accessible text on the site name in the global sidebar. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Added alternative text to element status indicators. ([#11604](https://github.com/craftcms/cms/pull/11604))\n- Feed, Recent Entries, and Drafts widgets now use semantic lists instead of tables. ([#11952](https://github.com/craftcms/cms/pull/11952))\n- Added autocomplete attributes to several address fields. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Implemented fieldsets and descriptive headings on user accounts\u2019 \u201cPreferences\u201d tab. ([#11534](https://github.com/craftcms/cms/pull/11534))\n- The \u201cAll\u201d status option within element index toolbars now uses a differentiated gradient icon. ([#11911](https://github.com/craftcms/cms/pull/11911))\n- Improved status indicator shapes, when the \u201cUse shapes to represent statuses\u201d user preference is enabled. ([#11911](https://github.com/craftcms/cms/pull/11911))\n- Boolean table columns within element indexes now use check icons to indicate `true` values. ([#11911](https://github.com/craftcms/cms/pull/11911))\n- Element titles are no longer truncated on edit pages. ([#11768](https://github.com/craftcms/cms/pull/11768))\n- Asset titles are no longer truncated in asset indexes. ([#11775](https://github.com/craftcms/cms/pull/11775))\n- Element source navigation now programmatically conveys structure imparted by headings. ([#11777](https://github.com/craftcms/cms/pull/11777))\n- Added a warning icon to related elements that contain validation errors. ([#11610](https://github.com/craftcms/cms/pull/11610))\n- Element index footers now stick to the bottom of the window, and element action triggers are now inserted into the footer rather than replacing the contents of the page\u2019s toolbar. ([#11844](https://github.com/craftcms/cms/pull/11844))\n\n### Administration\n- Added the `extraLastNamePrefixes` config setting. ([#11903](https://github.com/craftcms/cms/pull/11903))\n- Added the `extraNameSalutations` config setting. ([#11903](https://github.com/craftcms/cms/pull/11903))\n- Added the `extraNameSuffixes` config setting. ([#11903](https://github.com/craftcms/cms/pull/11903))\n- Element sources now have a \u201cDefault Sort\u201d setting in the Customize Sources modal. ([#12002](https://github.com/craftcms/cms/discussions/12002))\n- Control panel-defined image transforms can now have custom quality values. ([#9622](https://github.com/craftcms/cms/discussions/9622))\n- Added support for the `CRAFT_DOTENV_PATH` PHP constant. ([#11894](https://github.com/craftcms/cms/discussions/11894))\n- Added support for `CRAFT_WEB_URL` and `CRAFT_WEB_ROOT` environment variables/PHP constants, which can be used to set the default `@web` and `@webroot` alias values. ([#11912](https://github.com/craftcms/cms/pull/11912))\n\n### Development\n- Added the `canCreateDrafts()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canDelete()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canDeleteForSite()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canDuplicate()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canSave()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canView()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `|boolean` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Added the `|float` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Added the `|integer` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Added the `|string` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Twig templates now have `today`, `tomorrow`, and `yesterday` global variables available to them.\n- Element query date params now support passing `today`, `tomorrow`, and `yesterday`. ([#10485](https://github.com/craftcms/cms/issues/10485))\n- Element queries\u2019 `relatedTo` params now only check for relations in the same site as `siteId`, if set. ([#12000](https://github.com/craftcms/cms/issues/12000), [#12072](https://github.com/craftcms/cms/pull/12072))\n- Element queries now support passing ambiguous column names (e.g. `dateCreated`) and field handles into `select()`. ([#11790](https://github.com/craftcms/cms/pull/11790), [#11800](https://github.com/craftcms/cms/pull/11800))\n- Element queries\u2019 `collect()` methods eager-loaded elements now return `craft\\elements\\ElementCollection` objects, which extends `Illuminate\\Support\\Collection` with `ids()` and `with()` methods. ([#12113](https://github.com/craftcms/cms/discussions/12113))\n- `{% cache %}` tags now store any HTML registered with `{% html %}` tags. ([#11811](https://github.com/craftcms/cms/discussions/11811))\n- `{% cache %}` tags and GraphQL query caches now get a max cache duration based on the fetched/referenced entries\u2019 expiry dates. ([#8525](https://github.com/craftcms/cms/discussions/8525), [#11901](https://github.com/craftcms/cms/pull/11901))\n- Added the `siteHandle` field to elements queried via GraphQL. ([#10829](https://github.com/craftcms/cms/discussions/10829))\n- `users/session-info` responses now include a `csrfTokenName` key. ([#11706](https://github.com/craftcms/cms/pull/11706), [#11767](https://github.com/craftcms/cms/pull/11767))\n- The `elements/save-draft` action now supports being called from the front end. ([#12131](https://github.com/craftcms/cms/issues/12131))\n- The `users/upload-user-photo` action now includes a `photoId` key in the response data. ([#12175](https://github.com/craftcms/cms/pull/12175))\n\n### Extensibility\n- Added `craft\\base\\conditions\\BaseTextConditionRule::inputOptions()`.\n- Added `craft\\base\\Element::EVENT_DEFINE_URL`. ([#12168](https://github.com/craftcms/cms/pull/12168))\n- Added `craft\\base\\ExpirableElementInterface`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\controllers\\ElementsController::$element`.\n- Added `craft\\db\\ActiveQuery::collect()`. ([#11842](https://github.com/craftcms/cms/pull/11842))\n- Added `craft\\elements\\actions\\Restore::$restorableElementsOnly`.\n- Added `craft\\elements\\conditions\\assets\\EditableConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\EditableConditionRule`.\n- Added `craft\\elements\\ElementCollection`. ([#12113](https://github.com/craftcms/cms/discussions/12113))\n- Added `craft\\events\\AuthorizationCheckEvent::$element`.\n- Added `craft\\events\\CreateTwigEvent`.\n- Added `craft\\events\\DefineAddressFieldLabelEvent`.\n- Added `craft\\events\\DefineAddressFieldsEvent`.\n- Added `craft\\events\\DefineUrlEvent`. ([#12168](https://github.com/craftcms/cms/pull/12168))\n- Added `craft\\events\\ImageTransformerOperationEvent::$tempPath`.\n- Added `craft\\events\\SearchEvent::$scores`. ([#11882](https://github.com/craftcms/cms/discussions/11882))\n- Added `craft\\events\\UserGroupPermissionsEvent`.\n- Added `craft\\events\\UserPermissionsEvent`.\n- Added `craft\\helpers\\DateRange`.\n- Added `craft\\helpers\\DateTimeHelper::firstWeekDay()`.\n- Added `craft\\helpers\\DateTimeHelper::lastMonth()`.\n- Added `craft\\helpers\\DateTimeHelper::lastWeek()`.\n- Added `craft\\helpers\\DateTimeHelper::lastWeekDay()`.\n- Added `craft\\helpers\\DateTimeHelper::lastYear()`.\n- Added `craft\\helpers\\DateTimeHelper::nextMonth()`.\n- Added `craft\\helpers\\DateTimeHelper::nextWeek()`.\n- Added `craft\\helpers\\DateTimeHelper::nextYear()`.\n- Added `craft\\helpers\\DateTimeHelper::thisMonth()`.\n- Added `craft\\helpers\\DateTimeHelper::thisWeek()`.\n- Added `craft\\helpers\\DateTimeHelper::thisYear()`.\n- Added `craft\\helpers\\DateTimeHelper::today()`.\n- Added `craft\\helpers\\DateTimeHelper::tomorrow()`.\n- Added `craft\\helpers\\DateTimeHelper::yesterday()`.\n- Added `craft\\helpers\\ElementHelper::attributeHtml()`.\n- Added `craft\\helpers\\Html::svg()`. ([#11932](https://github.com/craftcms/cms/pull/11932))\n- Added `craft\\i18n\\FormatConverter::convertDatePhpToHuman()`. ([#10546](https://github.com/craftcms/cms/pull/10546))\n- Added `craft\\i18n\\Locale::FORMAT_HUMAN`.\n- Added `craft\\nameparsing\\CustomLanguage`.\n- Added `craft\\services\\Addresses::EVENT_DEFINE_FIELD_LABEL`. ([#11788](https://github.com/craftcms/cms/discussions/11788))\n- Added `craft\\services\\Addresses::EVENT_DEFINE_USED_FIELDS`. ([#11788](https://github.com/craftcms/cms/discussions/11788))\n- Added `craft\\services\\Addresses::EVENT_DEFINE_USED_SUBDIVISION_FIELDS`. ([#11788](https://github.com/craftcms/cms/discussions/11788))\n- Added `craft\\services\\Addresses::getFieldLabel()`.\n- Added `craft\\services\\Addresses::getUsedFields()`.\n- Added `craft\\services\\Addresses::getUsedSubdivisionFields()`.\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_CREATE_DRAFTS`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE_FOR_SITE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_DUPLICATE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_SAVE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_VIEW`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::canCreateDrafts()`.\n- Added `craft\\services\\Elements::canDelete()`.\n- Added `craft\\services\\Elements::canDeleteForSite()`.\n- Added `craft\\services\\Elements::canDuplicate()`.\n- Added `craft\\services\\Elements::canSave()`.\n- Added `craft\\services\\Elements::canView()`.\n- Added `craft\\services\\Elements::getIsCollectingCacheInfo()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Elements::setCacheExpiryDate()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Elements::startCollectingCacheInfo()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Elements::stopCollectingCacheInfo()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Search::EVENT_BEFORE_SCORE_RESULTS`. ([#11882](https://github.com/craftcms/cms/discussions/11882))\n- Added `craft\\services\\UserPermissions::EVENT_AFTER_SAVE_GROUP_PERMISSIONS`. ([#12130](https://github.com/craftcms/cms/discussions/12130), [#12146](https://github.com/craftcms/cms/pull/12146))\n- Added `craft\\services\\UserPermissions::EVENT_AFTER_SAVE_USER_PERMISSIONS`. ([#12130](https://github.com/craftcms/cms/discussions/12130), [#12146](https://github.com/craftcms/cms/pull/12146))\n- Added `craft\\web\\Controller::currentUser()`. ([#11754](https://github.com/craftcms/cms/pull/11754), [#11916](https://github.com/craftcms/cms/pull/11916))\n- Added `craft\\web\\View::EVENT_AFTER_CREATE_TWIG`. ([#11774](https://github.com/craftcms/cms/pull/11774))\n- `craft\\elements\\Asset::EVENT_DEFINE_URL` now gets triggered after the default URL has been generated, and the URL will be passed to `craft\\events\\DefineAssetUrlEvent::$url`.\n- `craft\\elements\\db\\ElementQuery::collect()` and `craft\\base\\Element::getEagerLoadedElements()` now return `craft\\elements\\ElementCollection` instances. ([#12113](https://github.com/craftcms/cms/discussions/12113))\n- `craft\\events\\DraftEvent::$creatorId` is now nullable. ([#11904](https://github.com/craftcms/cms/issues/11904))\n- `craft\\fieldlayoutelements\\BaseField::statusClass()` and `statusLabel()` now return status info from the element for the attribute specified by `attribute()`.\n- `craft\\helpers\\Component::iconSvg()` now namespaces the SVG contents, and adds `aria-hidden=\"true\"`. ([#11703](https://github.com/craftcms/cms/pull/11703))\n- `craft\\services\\Drafts::createDraft()` now accepts `null` passed to its `$creatorId` argument. ([#11904](https://github.com/craftcms/cms/issues/11904))\n- `craft\\services\\Search::EVENT_AFTER_SEARCH` now includes the computed search result scores, set to `craft\\events\\SearchEvent::$scores`, and any changes made to it will be returned by `searchElements()`. ([#11882](https://github.com/craftcms/cms/discussions/11882))\n- `craft\\services\\Search::EVENT_BEFORE_INDEX_KEYWORDS` is now cancellable by setting `$event->isValid` to `false`. ([#11705](https://github.com/craftcms/cms/discussions/11705))\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_CREATE_DRAFTS`. `craft\\services\\Elements::EVENT_AUTHORIZE_CREATE_DRAFTS` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_DELETE_FOR_SITE`. `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE_FOR_SITE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_DELETE`. `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_DUPLICATE`. `craft\\services\\Elements::EVENT_AUTHORIZE_DUPLICATE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_SAVE`. `craft\\services\\Elements::EVENT_AUTHORIZE_SAVE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_VIEW`. `craft\\services\\Elements::EVENT_AUTHORIZE_VIEW` should be used instead.\n- Deprecated `craft\\elements\\Address::addressAttributeLabel()`. `craft\\services\\Addresses::getFieldLabel()` should be used instead.\n- Deprecated `craft\\events\\DefineAssetUrlEvent::$asset`. `$sender` should be used instead.\n- Deprecated `craft\\services\\Elements::getIsCollectingCacheTags()`. `getIsCollectingCacheInfo()` should be used instead. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Deprecated `craft\\services\\Elements::startCollectingCacheTags()`. `startCollectingCacheInfo()` should be used instead. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Deprecated `craft\\services\\Elements::stopCollectingCacheTags()`. `stopCollectingCacheInfo()` should be used instead. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- `checkboxSelect` inputs without `showAllOption: true` now post an empty value if no options were selected. ([#11748](https://github.com/craftcms/cms/issues/11748))\n- Added the `Craft.useMobileStyles()` JavaScript method. ([#11636](https://github.com/craftcms/cms/pull/11636))\n- Added `Craft.BaseElementIndex::getParentSource()`.\n- Added `Craft.BaseElementIndex::getRootSource()`.\n- Added `Craft.BaseElementIndex::getSourceActions()`. ([#11906](https://github.com/craftcms/cms/pull/11906))\n- Added `Craft.BaseElementIndex::getSourceLevel()`.\n- `Craft.BaseElementSelectInput` now triggers a `change` event when elements are added programmatically or removed.\n\n### System\n- Name parsing now checks for common German salutations, suffixes, and last name prefixes.\n- \u201cGenerating pending image transforms\u201d jobs no longer attempt to process transforms that had previously failed. ([#11970](https://github.com/craftcms/cms/issues/11970))\n- The default system email template now sets the `lang` attribute on the `<html>` tag. ([#12156](https://github.com/craftcms/cms/pull/12156))\n- The default system email template now includes a `Content-Type` tag. ([#12156](https://github.com/craftcms/cms/pull/12156))\n- Improved GraphQL cache reliability. ([#11994](https://github.com/craftcms/cms/issues/11994), [#12086](https://github.com/craftcms/cms/pull/12086))\n- Control panel `.twig` templates are now prioritized over `.html`. ([#11809](https://github.com/craftcms/cms/discussions/11809), [#11840](https://github.com/craftcms/cms/pull/11840))\n- Updated Yii to 2.0.46.\n- Fixed a bug where addresses weren\u2019t validating their country codes. ([#12161](https://github.com/craftcms/cms/issues/12161))\n- Fixed a bug where Entry URI Format, Template, and Default Status switches were focusable within sections\u2019 Site Settings tables, for disabled sites.\n- Fixed a bug where `craft\\helpers\\Db::parseParam()` wasn\u2019t generating conditions that would include `null` values when it should have. ([#11931](https://github.com/craftcms/cms/issues/11931))\n\n## 4.2.8 - 2022-10-18\n\n### Changed\n- The `setup/keys` command will now set the application ID if `Craft::$app->id` is empty. ([#12103](https://github.com/craftcms/cms/pull/12103))\n\n### Fixed\n- Fixed an error that could occur when running tests. ([#12088](https://github.com/craftcms/cms/issues/12088), [#12089](https://github.com/craftcms/cms/issues/12089))\n- Fixed a bug where the `db/restore` command would output a warning about a missing `info` row, even if one existed in the imported database. ([#12101](https://github.com/craftcms/cms/issues/12101))\n- Fixed a bug where the \u201cYour session has ended\u201d modal could be shown on the control panel\u2019s login page. ([#12121](https://github.com/craftcms/cms/issues/12121))\n- Fixed a permission error that could occur when uploading a file to an Assets field.\n- Fixed a bug where custom log targets were getting removed when processing queue jobs. ([#12109](https://github.com/craftcms/cms/pull/12109))\n- Fixed a bug where Money fields weren\u2019t distinguishing between `0` and empty values. ([#12122](https://github.com/craftcms/cms/issues/12122), [#12132](https://github.com/craftcms/cms/pull/12132))\n- Fixed an error that could occur in the control panel. ([#12133](https://github.com/craftcms/cms/issues/12133))\n- Fixed a bug where assets uploaded from Assets fields weren\u2019t retaining their original filename for all but the initial site. ([#12142](https://github.com/craftcms/cms/pull/12142))\n- Fixed a bug where non-admin users couldn\u2019t always see the Temporary Uploads source when selecting assets from an Assets field. ([#12128](https://github.com/craftcms/cms/issues/12128))\n- Fixed a bug where image transforms that used the `fit` mode but didn\u2019t specify a width or height weren\u2019t getting their missing dimension set on the asset. ([#12137](https://github.com/craftcms/cms/issues/12137))\n\n## 4.2.7 - 2022-10-11\n\n### Added\n- Added the `setup/keys` command, which ensure Craft is configured with an application ID and security key.\n\n### Changed\n- The `install/craft` command now runs `setup/keys` before doing anything else.\n\n## 4.2.6 - 2022-10-11\n\n### Added\n- Added the `--as-json` option to the `help` command. ([#12017](https://github.com/craftcms/cms/pull/12017), [#12074](https://github.com/craftcms/cms/pull/12074))\n- Added `craft\\helpers\\ElementHelper::isAttributeEmpty()`.\n- Added `craft\\queue\\jobs\\ResaveElements::$ifEmpty`.\n- Added `craft\\queue\\jobs\\ResaveElements::$set`.\n- Added `craft\\queue\\jobs\\ResaveElements::$to`.\n- Added `craft\\queue\\jobs\\ResaveElements::$touch`.\n\n### Changed\n- When passing a PHP callback function to the `--to` option of a `resave/*` command, the `$element` argument is now optional.\n\n### Deprecated\n- Deprecated `craft\\web\\assets\\focusvisible\\FocusVisibleAsset`. ([#12037](https://github.com/craftcms/cms/pull/12037))\n\n### Fixed\n- Fixed an error that could occur when editing a draft of an element type that didn\u2019t have change tracking enabled.\n- Fixed an error that could occur when saving an entry with Matrix blocks, if the entry had been deleted for a site.\n- Fixed a bug where `resave/*` commands weren\u2019t respecting the `--set`, `--to`, or `--touch` options when `--queue` was passed. ([#11974](https://github.com/craftcms/cms/issues/11974))\n- Fixed a bug where `relatedTo` params didn\u2019t support collections.\n- Fixed an error that could occur when passing an element query to a `relatedTo` param, if the parent element query contained any closures. ([#11981](https://github.com/craftcms/cms/issues/11981))\n- Fixed a bug where `craft\\log\\MonologTarget::$allowLineBreaks` wasn\u2019t getting a default value. ([#12004](https://github.com/craftcms/cms/pull/12004))\n- Fixed a PHP error that occurred when attempting to edit an element by an invalid ID or UUID.\n- Fixed a bug where unsaved drafts could be unintentionally deleted when saved, if a plugin or module was blocking the save via `EVENT_BEFORE_SAVE`. ([#12015](https://github.com/craftcms/cms/issues/12015))\n- Fixed a bug where \u201cPropagating tags\u201d jobs would fail if two tags had similar titles.\n- Fixed a bug where pressing \u201cDisable focal point\u201d within asset preview modals would only reset the focal point position, but not delete it. ([#12030](https://github.com/craftcms/cms/issues/12030))\n- Fixed a bug where image transforms weren\u2019t getting sized correctly in some cases when `upscaleImages` was disabled. ([#12023](https://github.com/craftcms/cms/issues/12023))\n- Fixed a bug where table cells within Redactor fields could appear to be focused when they weren\u2019t. ([#12001](https://github.com/craftcms/cms/issues/12001), [#12037](https://github.com/craftcms/cms/pull/12037))\n- Fixed a bug where alerts saying a folder can\u2019t be renamed due to a naming conflict were showing the old folder name instead of the new one. ([#12049](https://github.com/craftcms/cms/pull/12049))\n- Fixed a bug where custom fields nested within Matrix fields weren\u2019t always updating properly within slideout editors. ([#11988](https://github.com/craftcms/cms/issues/11988), [#12058](https://github.com/craftcms/cms/issues/12058))\n- Fixed an error that could occur when adding new textual condition rules to a condition. ([#12077](https://github.com/craftcms/cms/pull/12077))\n- Fixed a bug where Table fields\u2019 Default Values settings were always showing at least one row, even if the setting had been saved without any rows. ([#12071](https://github.com/craftcms/cms/issues/12071))\n- Fixed a bug where existing rows in Table fields\u2019 Default Values settings were losing the ability to be reordered or deleted when the table columns were changed.\n- Fixed a bug where sending a password reset email for an inactive user would set them to a pending state. ([#12080](https://github.com/craftcms/cms/pull/12080))\n- Fixed a bug where some GraphQL results could be missing if multiple sets of nested elements were being queried using the same alias. ([#11982](https://github.com/craftcms/cms/issues/11982))\n\n### Security\n- Fixed information disclosure vulnerabilities.\n\n## 4.2.5.2 - 2022-10-03\n\n### Security\n- Updated Twig to 3.4. ([#12022](https://github.com/craftcms/cms/issues/12022))\n\n## 4.2.5.1 - 2022-09-21\n\n### Fixed\n- Fixed a bug where the \u201cNew category\u201d button could be missing from the Categories index page. ([#11977](https://github.com/craftcms/cms/issues/11977))\n- Fixed a bug where `Craft::t()` and the `|t` Twig filter were modifying digit-dash-digit sequences. ([#11980](https://github.com/craftcms/cms/issues/11980))\n- Fixed PHP errors that occurred if `webonyx/graphql-php` 14.11.17 was installed. ([#11979](https://github.com/craftcms/cms/issues/11979), [webonyx/graphql-php#1221](https://github.com/webonyx/graphql-php/issues/1221))\n- Fixed a PHP error that could occur when working with a draft. ([#11976](https://github.com/craftcms/cms/issues/11976))\n\n## 4.2.5 - 2022-09-20\n\n### Added\n- Added `craft\\helpers\\Image::targetDimensions()`.\n\n### Changed\n- Edit Asset pages now show the \u201cView\u201d button for all file types, not just images, PDFs, and text files. ([#11936](https://github.com/craftcms/cms/issues/11936))\n\n### Removed\n- Removed the Punycode PHP library. ([#11948](https://github.com/craftcms/cms/issues/11948))\n\n### Fixed\n- Fixed a bug where image transforms weren\u2019t always getting applied properly to all animation frames. ([#11937](https://github.com/craftcms/cms/pull/11937))\n- Fixed a bug where animated WebP images would lose their animation frames when transformed. ([#11937](https://github.com/craftcms/cms/pull/11937))\n- Fixed a bug where image transform dimensions could be calculated incorrectly when `upscaleImages` was `false`. ([#11837](https://github.com/craftcms/cms/issues/11837))\n- Fixed a bug where the `users/send-password-reset-email` action wasn\u2019t passing errors back to the template. ([#11933](https://github.com/craftcms/cms/issues/11933))\n- Fixed an error that occurred when setting a non-numeric `width` or `height` on an image transform. ([#11837](https://github.com/craftcms/cms/issues/11837))\n- Fixed a bug where the database connection wasn\u2019t being configured properly when fluent config methods and environment variable overrides were being used in combination. ([#11941](https://github.com/craftcms/cms/issues/11941))\n- Fixed a bug where slideouts lost their shadows when focused.\n- Fixed a bug where `relatedTo*` arguments weren\u2019t supported by `children` fields in GraphQL. ([#11918](https://github.com/craftcms/cms/issues/11918))\n- Fixed a bug where Image Editor and slideout action buttons were obstructed when the Debug Toolbar was enabled. ([#11965](https://github.com/craftcms/cms/issues/11965))\n- Fixed an error that occurred when installing Craft when MySQL\u2019s `sql_require_primary_key` setting was enabled. ([#11374](https://github.com/craftcms/cms/discussions/11374))\n- Fixed a bug subfolders created by Assets fields could be reported as missing when updating asset indexes, even if they contained assets. ([#11949](https://github.com/craftcms/cms/issues/11949))\n- Fixed a PHP error that could occur in a potential race condition when calling  `craft\\helpers\\FileHelper::clearDirectory()`.\n- Fixed a bug where Structure section entries that were duplicated via the \u201cSave as a new entry\u201d action on a provisional draft weren\u2019t being placed within the structure properly.\n- Fixed a bug where element\u2019s `searchScore` properties would be set to `null` when their original score was below 1, rather than rounding to 0 or 1. ([#11973](https://github.com/craftcms/cms/issues/11973))\n\n## 4.2.4 - 2022-09-13\n\n### Changed\n- The \u201cNew entry\u201d and \u201cNew category\u201d buttons on the Entries and Categories index pages now support <kbd>Ctrl</kbd>/<kbd>Command</kbd>/middle-clicking to open the edit page in a new window. ([#11870](https://github.com/craftcms/cms/issues/11870))\n- Control panel menus now automatically reposition themselves when the window is resized.\n- Improved the performance of some element queries on MySQL. ([#11825](https://github.com/craftcms/cms/pull/11825))\n- `resave/*` commands now have a `--touch` option. When passed, elements\u2019 `dateUpdated` timestamps will be updated as they\u2019re resaved. ([#11849](https://github.com/craftcms/cms/discussions/11849))\n- Underscores within query param values that begin/end with `*` are now escaped, so they aren\u2019t treated as wildcard characters by the `like` condition. ([#11898](https://github.com/craftcms/cms/issues/11898))\n- `craft\\services\\Elements::resaveElements()` now has a `$touch` argument.\n- Disable the preview button while drafts are saving ([#11858](https://github.com/craftcms/cms/issues/11858))\n\n### Fixed\n- Fixed an error that could occur when upgrading to Craft 4, if any Matrix blocks contained null `sortOrder` values. ([#11843](https://github.com/craftcms/cms/issues/11843))\n- Fixed a bug where image transform dimensions could be calculated incorrectly when `upscaleImages` was `false`. ([#11837](https://github.com/craftcms/cms/issues/11837))\n- Fixed an error that occurred when parsing an image transform string that was missing an interlace type. ([#11834](https://github.com/craftcms/cms/pull/11834))\n- Fixed a bug where element caches weren\u2019t being invalidated during garbage collection, so hard-deleted elements could appear to still exist.\n- Fixed a bug where image transforms were always getting saved with `dateIndexed` set to `null`. ([#11863](https://github.com/craftcms/cms/pull/11863))\n- Fixed an error that could occur when rendering front-end templates if there was a problem connecting to the database. ([#11855](https://github.com/craftcms/cms/issues/11855))\n- Fixed a bug where Edit Asset pages were showing the \u201cView\u201d button for assets in volumes without public URLs. ([#11860](https://github.com/craftcms/cms/issues/11860))\n- Fixed a bug where the Assets index page wasn\u2019t handling failed uploads properly. ([#11866](https://github.com/craftcms/cms/issues/11866))\n- Fixed a bug where it was possible to save an asset with a focal point outside its cropped area. ([#11875](https://github.com/craftcms/cms/issues/11875))\n- Fixed a bug where element index filter HUDs were unresponsive if another one was already active for a different site/source. ([#11880](https://github.com/craftcms/cms/issues/11880))\n- Fixed a bug where newly-created subfolders on the Assets index page could appear to have the wrong indentation.\n- Fixed a UI bug where renaming a newly-created volume subfolder didn\u2019t appear to have any effect.\n- Fixed a bug where empty URL fields would be marked as changed, even when no change was made to them. ([#11908](https://github.com/craftcms/cms/issues/11908))\n- Fixed a UI bug where autosuggest menus weren\u2019t getting filtered when first opened for inputs with existing values. ([#11896](https://github.com/craftcms/cms/issues/11896))\n- Fixed a bug where Entry Type condition rules weren\u2019t working for conditions that were applied to a single element. ([#11914](https://github.com/craftcms/cms/issues/11914))\n- Fixed a bug where Related To condition rules weren\u2019t working for conditions that were applied to a single element, for cross-site relations. ([#11892](https://github.com/craftcms/cms/issues/11892))\n- Fixed a bug where form action keyboard shortcuts weren\u2019t available when a custom select menu was focused. ([#11919](https://github.com/craftcms/cms/issues/11919))\n- Fixed a bug where transforming an animated GIF into a WebP file would only include the first frame. ([#11889](https://github.com/craftcms/cms/issues/11889))\n- Fixed a bug where `craft\\models\\FieldLayout::createFromConfig()` was ignoring `id`, `uid`, `type`, and `reservedFieldHandles` keys, if set. ([#11929](https://github.com/craftcms/cms/issues/11929))\n\n### Security\n- Fixed XSS vulnerabilities.\n- Password inputs no longer temporarily reveal the password when the <kbd>Alt</kbd> key is pressed. ([#11930](https://github.com/craftcms/cms/issues/11930))\n\n## 4.2.3 - 2022-08-26\n\n### Changed\n- If a plugin\u2019s license key is set to an empty environment variable, its trial license key will now be stored in `.env` rather than the project config. ([#11830](https://github.com/craftcms/cms/issues/11830))\n\n### Fixed\n- Fixed a PHP error that occurred when garbage collection was run on web requests. ([#11829](https://github.com/craftcms/cms/issues/11829))\n\n## 4.2.2 - 2022-08-23\n\n### Added\n- Added the `utils/fix-field-layout-uids` command. ([#11746](https://github.com/craftcms/cms/issues/11746))\n\n### Changed\n- Improved the styling of Categories fields.\n- The first field group is now automatically selected by default when creating a new custom field.\n- Improved console output for the `gc` command.\n- The `gc` command now runs garbage collection for data caches.\n- Exception JSON responses now include `name` and `code` keys. ([#11799](https://github.com/craftcms/cms/discussions/11799))\n- `elements/*` actions no longer include custom field values in the failure response data, improving performance. ([#11807](https://github.com/craftcms/cms/discussions/11807))\n\n### Fixed\n- Fixed a bug where keyboard focus wasn\u2019t being maintained when changing the element type within a \u201cRelated To\u201d condition rule.\n- Fixed a bug where keyboard focus wasn\u2019t being maintained when changing the country within an address\u2019s \u201cAdministrative Area\u201d condition rule.\n- Fixed a bug where Date fields\u2019 Timezone menus could be clipped. ([#11780](https://github.com/craftcms/cms/pull/11780))\n- Fixed an error that could occur when saving an unpublished draft, if any custom validation errors were added to it after its draft status had been removed. ([#11407](https://github.com/craftcms/cms/issues/11407))\n- Fixed a bug where custom validation errors would be shown twice for unpublished drafts, if they were added to it after its draft status had been removed. ([#11407](https://github.com/craftcms/cms/issues/11407))\n- Fixed PHP warnings that would occur when passing `0` into `craft\\helpers\\DateTimeHelper::humanDuration()`. ([#11787](https://github.com/craftcms/cms/issues/11787))\n- Fixed a bug where selected assets weren\u2019t getting automatically replaced when an image was edited and \u201cSave as a new asset\u201d was chosen. ([#11805](https://github.com/craftcms/cms/issues/11805))\n- Fixed a JavaScript error that occurred when editing a user via a slideout, if the user had any addresses. ([#11810](https://github.com/craftcms/cms/issues/11810))\n- Fixed a bug where some invalid slideout submissions weren\u2019t being handled properly. ([#11812](https://github.com/craftcms/cms/issues/11812))\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateInterval()` was returning negative interval durations when integers were passed in. ([#11814](https://github.com/craftcms/cms/pull/11814))\n- Fixed a bug where `iframeResizer.contentWindow.js` was getting loaded for all preview requests, not just Live Preview, and even when `useIframeResizer` was disabled. ([#11778](https://github.com/craftcms/cms/issues/11778))\n- Fixed a bug where deleted relations and Matrix blocks could persist if the edit form was submitted before they had been fully animated away. ([#11789](https://github.com/craftcms/cms/issues/11789))\n- Fixed a PHP error that could occur if `craft\\services\\Assets::getUserTemporaryUploadFolder()` was called when there was no logged-in user account. ([#11751](https://github.com/craftcms/cms/issues/11751))\n\n## 4.2.1.1 - 2022-08-10\n\n### Fixed\n- Fixed a bug where saving an element with invalid field values could result in some field values being forgotten. ([#11756](https://github.com/craftcms/cms/issues/11756))\n- Fixed a bug where it wasn\u2019t always possible to serve asset bundles via `webpack-dev-server` over SSL. ([#11758](https://github.com/craftcms/cms/pull/11758))\n\n## 4.2.1 - 2022-08-09\n\n### Added\n- Added the `project-config/export` command. ([#11733](https://github.com/craftcms/cms/pull/11733))\n- Added `craft\\config\\GeneralConfig::getRememberedUserSessionDuration()`.\n- Added `craft\\helpers\\DateTimeHelper::toDateInterval()`.\n\n### Changed\n- \u201cRelated To\u201d condition rules are now available for conditions that are stored in the project config. ([#11740](https://github.com/craftcms/cms/issues/11740))\n- Element index filters are now managed for each site and source, rather than just for each source. ([#11719](https://github.com/craftcms/cms/issues/11719))\n- `craft\\config\\DbConfig::dsn()` now parses the DSN string and populates the other DSN-settable config properties.\n- `craft\\helpers\\DateTimeHelper::humanDuration()` no longer returns the number of weeks, unless the number of days is divisible by 7. ([#11594](https://github.com/craftcms/cms/discussions/11594))\n- `craft\\helpers\\DateTimeHelper::humanDuration()` now accepts date interval strings to be passed in.\n- `craft\\helpers\\Db::url2config()` now returns `driver`, `server`, `port`, and `database` keys, when possible. ([#11735](https://github.com/craftcms/cms/issues/11735))\n- `craft\\services\\Assets::getImagePreviewUrl()` now throws a `yii\\base\\NotSupportedException` if a preview URL could not be generated for the asset, rather than causing a PHP error.\n\n### Deprecated\n- Deprecated `craft\\helpers\\DateTimeHelper::secondsToInterval()`. `toDateInterval()` should be used instead.\n\n### Fixed\n- Fixed a bug where database connections would always use port `3306` by default if `craft\\config\\DbConfig` had been configured via fluent methods, even for PostgreSQL.\n- Fixed a bug where system messages provided by Yii weren\u2019t getting translated in some cases. ([#11712](https://github.com/craftcms/cms/issues/11712))\n- Fixed a bug where the \u201cKeep me signed in\u201d checkbox label wasn\u2019t always accurately representing the `rememberedUserSessionDuration` config setting. ([#11594](https://github.com/craftcms/cms/discussions/11594))\n- Fixed a bug where the `Craft.cp.setSiteId()` JavaScript method wasn\u2019t updating `Craft.siteId`, or the base URLs used by `Craft.getActionUrl()`, `Craft.getCpUrl()`, and `Craft.getUrl()`.\n- Fixed an error that occurred when removing a Single section from the primary site, if it contained any Matrix blocks. ([#11669](https://github.com/craftcms/cms/issues/11669))\n- Fixed a bug where Matrix sub-fields weren\u2019t showing their validation errors when `autosaveDrafts` was `false`. ([#11731](https://github.com/craftcms/cms/issues/11731))\n- Fixed a bug where saving an element with invalid field values could result in the invalid values being forgotten, rather than re-validated. ([#11731](https://github.com/craftcms/cms/issues/11731))\n- Fixed a bug where the database connection would be misconfigured if the `url` connection setting was used. ([#11735](https://github.com/craftcms/cms/issues/11735))\n- Fixed a bug where the element index filter HUDs weren\u2019t always visually aligned with the search input. ([#11739](https://github.com/craftcms/cms/issues/11739))\n- Fixed a bug where it wasn\u2019t possible to preview or edit image assets if their filesystem and transform filesystem didn\u2019t have public URLs. ([#11686](https://github.com/craftcms/cms/issues/11686), [#11687](https://github.com/craftcms/cms/issues/11687))\n- Fixed a bug where not all project config changes would be applied if a site was deleted. ([#9567](https://github.com/craftcms/cms/issues/9567))\n- Fixed a bug where `$` characters in database connection passwords weren\u2019t being escaped property when backing up/restoring the database. ([#11750](https://github.com/craftcms/cms/issues/11750))\n\n### Security\n- Fixed XSS vulnerabilities.\n\n## 4.2.0.2 - 2022-07-27\n\n### Fixed\n- Fixed a bug where `Garnish.uiShortcutManager` was getting double-instantiated, causing some keyboard shortcuts to be triggered multiple times.\n- Fixed a JavaScript error that occurred when switching sites in the control panel. ([#11709](https://github.com/craftcms/cms/issues/11709))\n- Fixed a bug where some config settings set via fluent setters weren\u2019t getting normalized.\n- Fixed a bug where the database connection DSN string wasn\u2019t getting built properly when the connection settings were set via fluent setters.\n\n## 4.2.0.1 - 2022-07-26\n\n### Fixed\n- Fixed an error that could occur when passing an object into `craft\\helpers\\ArrayHelper::removeValue()` or the `|without` filter.\n\n## 4.2.0 - 2022-07-26\n\n### Added\n- The control panel is now translated into Ukrainian.\n- Element conditions can now include condition rules for Matrix fields. ([#11620](https://github.com/craftcms/cms/issues/11620))\n- Element conditions can now include condition rules for Money fields. ([#11560](https://github.com/craftcms/cms/issues/11560))\n- Added the \u201cNotification Duration\u201d user accessibility preference. ([#11612](https://github.com/craftcms/cms/pull/11612))\n- The `accessibilityDefaults` config setting now supports a `notificationDuration` key.\n- Added `craft\\behaviors\\SessionBehavior::getSuccess()`.\n- Added `craft\\behaviors\\SessionBehavior::setSuccess()`.\n- Added `craft\\config\\BaseConfig`. ([#11591](https://github.com/craftcms/cms/pull/11591), [#11656](https://github.com/craftcms/cms/pull/11656))\n- Added `craft\\controllers\\UsersController::EVENT_AFTER_FIND_LOGIN_USER`. ([#11645](https://github.com/craftcms/cms/pull/11645))\n- Added `craft\\controllers\\UsersController::EVENT_BEFORE_FIND_LOGIN_USER`. ([#11645](https://github.com/craftcms/cms/pull/11645))\n- Added `craft\\events\\DefineFieldLayoutCustomFieldsEvent`.\n- Added `craft\\events\\FindLoginUserEvent`.\n- Added `craft\\events\\IndexKeywordsEvent`.\n- Added `craft\\fields\\conditions\\EmptyFieldConditionRule`.\n- Added `craft\\helpers\\DateTimeHelper::humanDuration()`.\n- Added `craft\\helpers\\Template::resolveTemplatePathAndLine()`.\n- Added `craft\\models\\FieldLayout::EVENT_DEFINE_CUSTOM_FIELDS`. ([#11634](https://github.com/craftcms/cms/discussions/11634))\n- Added `craft\\services\\Config::getLoadingConfigFile()`.\n- Added `craft\\services\\Elements::EVENT_INVALIDATE_CACHES`. ([#11617](https://github.com/craftcms/cms/pull/11617))\n- Added `craft\\services\\Search::EVENT_BEFORE_INDEX_KEYWORDS`. ([#11575](https://github.com/craftcms/cms/discussions/11575))\n\n### Changed\n- Redesigned user notifications. ([#11612](https://github.com/craftcms/cms/pull/11612))\n- Most element notifications now include a link to the element. ([#11612](https://github.com/craftcms/cms/pull/11612))\n- Improved overall control panel accessibility. ([#11563](https://github.com/craftcms/cms/pull/11563), [#11543](https://github.com/craftcms/cms/pull/11543), [#11688](https://github.com/craftcms/cms/pull/11688), [#11699](https://github.com/craftcms/cms/pull/11699))\n- Improved condition builder accessibility. ([#11588](https://github.com/craftcms/cms/pull/11588), [#11643](https://github.com/craftcms/cms/pull/11643))\n- Improved Image Editor accessibility. ([#11496](https://github.com/craftcms/cms/pull/11496))\n- The \u201cKeep me signed in\u201d checkbox label on the control panel\u2019s login page now includes the remembered session duration, e.g. \u201cKeep me signed in for 2 weeks\u201d. ([#11594](https://github.com/craftcms/cms/discussions/11594))\n- Dashboard widgets no longer show a confirmation dialog when deleted. Their delete notifications include an \u201cUndo\u201d button instead. ([#11573](https://github.com/craftcms/cms/discussions/11573))\n- Element edit pages no longer jump down when the \u201cShowing your unsaved changes\u201d notice is added, unless there\u2019s not enough content to require a scroll bar. ([#11586](https://github.com/craftcms/cms/discussions/11586))\n- Matrix block previews now show selected option labels rather than their raw values. ([#11659](https://github.com/craftcms/cms/issues/11659))\n- Improved the behavior of some console commands for non-interactive shells. ([#11650](https://github.com/craftcms/cms/issues/11650))\n- The `utils/prune-revisions` console command now has a `--section` option. ([#8783](https://github.com/craftcms/cms/discussions/8783))\n- Deprecation warnings\u2019 stack traces now show source templates\u2019 paths and line numbers.\n- Exception JSON responses now include the previous exception details, recursively. ([#11694](https://github.com/craftcms/cms/discussions/11694))\n- `config/general.php` and `config/db.php` can now return `craft\\config\\GeneralConfig`/`DbConfig` objects, which can be defined using new fluent setter methods. ([#11591](https://github.com/craftcms/cms/pull/11591), [#11656](https://github.com/craftcms/cms/pull/11656))\n- The `|duration` Twig filter can now be used with an integer representing a number of seconds, and its `showSeconds` argument is no longer required. Seconds will be output if the duration is less than one minute by default.\n- The `|length` Twig filter now checks if the variable is a query, and if so, returns its count. ([#11625](https://github.com/craftcms/cms/discussions/11625))\n- The `|without` Twig filter no longer uses strict value comparisons by default. It has a new `$strict` argument that can be set to `true` to enforce strict comparisons if desired. ([#11695](https://github.com/craftcms/cms/issues/11695))\n- `craft\\base\\conditions\\BaseConditionRule::inputHtml()` is no longer abstract, and returns an empty string by default.\n- `craft\\behaviors\\SessionBehavior::setError()` now has a `$settings` argument.\n- `craft\\behaviors\\SessionBehavior::setNotice()` now has a `$settings` argument.\n- `craft\\db\\Query` now implements the `ArrayAccess` and `IteratorAggregate` interfaces, so queries (including element queries) can be treated as arrays.\n- `craft\\helpers\\ArrayHelper::removeValue()` no longer uses strict value comparisons by default. It has a new `$strict` argument that can be set to `true` to enforce strict comparisons if desired.\n- `craft\\web\\Controller::asSuccess()` now has a `$notificationSettings` argument.\n- `craft\\web\\Controller::setFailFlash()` now has a `$settings` argument.\n- `craft\\web\\Controller::setSuccessFlash()` now has a `$settings` argument.\n\n### Deprecated\n- Deprecated `craft\\helpers\\DateTimeHelper::humanDurationFromInterval()`. `humanDuration()` should be used instead.\n- Deprecated `craft\\helpers\\DateTimeHelper::secondsToHumanTimeDuration()`. `humanDuration()` should be used instead.\n\n### Fixed\n- Fixed a bug where new condition rules\u2019 type selectors weren\u2019t getting auto-focused.\n- Fixed a bug where Quick Post widgets weren\u2019t submitting custom field values.\n- Fixed a bug where assets\u2019 `getImg()` methods were returning `null` for assets in volumes without URLs, even if a transform was being used. ([#11614](https://github.com/craftcms/cms/issues/11614))\n- Fixed a bug where sensitive data wasn\u2019t getting redacted in the logs when Dev Mode was enabled. ([#11618](https://github.com/craftcms/cms/issues/11618))\n- Fixed a SQL error that could occur on MySQL 5. ([#11596](https://github.com/craftcms/cms/issues/11596))\n- Fixed an error that could occur when upgrading to Craft 4. ([#11644](https://github.com/craftcms/cms/issues/11644))\n- Fixed a bug where the green color used in lightswitches was too dark. ([#11653](https://github.com/craftcms/cms/issues/11653))\n- Fixed a bug where relational and Matrix fields were assuming their values hadn\u2019t been eager-loaded on element save. ([#11667](https://github.com/craftcms/cms/issues/11667), [#11670](https://github.com/craftcms/cms/issues/11670))\n- Fixed a bug where deprecation warnings for treating an element query as an array weren\u2019t getting logged with an origin, if they involved Twig\u2019s `|batch` filter. ([#11597](https://github.com/craftcms/cms/issues/11597))\n- Fixed a bug where `{% js %}`, `{% script %}`, and `{% css %}` tags weren\u2019t registering JavaScript and CSS code properly when used within a `{% cache %}` tag that contained an ungenerated image transform. ([#11602](https://github.com/craftcms/cms/issues/11602))\n- Fixed a bug where the \u201cUser saved\u201d notification was translated for the former language, when changing the current user\u2019s language preference.\n- Fixed a JavaScript error that occurred when removing a category from a Categories field, if any of its descendants were selected as well. ([#11641](https://github.com/craftcms/cms/issues/11641))\n- Fixed a bug where links to config settings from **Settings** \u2192 **General** didn\u2019t include the correct setting anchors. ([#11665](https://github.com/craftcms/cms/pull/11665))\n- Fixed styling issues with Live Preview in Firefox.\n\n### Security\n- Fixed an information disclosure vulnerability.\n\n## 4.1.4.1 - 2022-07-13\n\n### Fixed\n- Fixed a bug where `craft\\services\\Assets::getRootFolderByVolumeId()` wasn\u2019t returning the root folder. ([#11593](https://github.com/craftcms/cms/issues/11593))\n\n## 4.1.4 - 2022-07-12\n\n### Added\n- Added `craft\\models\\FieldLayout::getVisibleCustomFieldElements()`.\n\n### Changed\n- Relation fields now focus on the next related element\u2019s \u201cRemove\u201d button when an element is removed. ([#11577](https://github.com/craftcms/cms/issues/11577))\n\n### Deprecated\n- Deprecated `craft\\base\\FieldTrait::$required`. `craft\\fieldlayoutelements\\BaseField::$required` should be used instead.\n\n### Fixed\n- Fixed a bug where assets\u2019 native Alternative Text fields were getting mislabeled as translatable. ([#11576](https://github.com/craftcms/cms/issues/11576))\n- Fixed a bug where fields nested within Neo fields could be incorrectly validated as required. ([#11574](https://github.com/craftcms/cms/issues/11574))\n- Fixed a PHP error that occurred when editing a Date field with a Min Date setting set.\n- Fixed a bug where date range inputs weren\u2019t working on mobile. ([#11571](https://github.com/craftcms/cms/issues/11571))\n- Fixed a bug where the \u201cCraft Support\u201d Dashboard widget wasn\u2019t being labeled properly in the widget settings HUD and delete confirmation dialog. ([#11573](https://github.com/craftcms/cms/discussions/11573))\n- Fixed a bug where the project config cache was getting invalidated on each public GraphQL API request.\n\n## 4.1.3 - 2022-07-07\n\n### Changed\n- Address fields now show required indicators based on the configured validation rules. ([#11566](https://github.com/craftcms/cms/pull/11566))\n\n### Fixed\n- Fixed a JavaScript error that occurred on the Updates utility. ([#11567](https://github.com/craftcms/cms/issues/11567))\n- Fixed a bug where Craft\u2019s Composer commands could produce a malformed `composer.json` file. ([#11564](https://github.com/craftcms/cms/issues/11564))\n\n## 4.1.2 - 2022-07-06\n\n### Added\n- Added `craft\\helpers\\ProjectConfig::ensureAllFilesystemsProcessed()`.\n\n### Changed\n- Relational field condition rules now have the \u201cis related to\u201d operator selected by default. ([#11550](https://github.com/craftcms/cms/discussions/11550))\n\n### Fixed\n- Fixed a bug where the Updates utility wasn\u2019t checking for updates properly. ([#11552](https://github.com/craftcms/cms/issues/11552))\n- Fixed an error that could occur when deploying a Craft 4 upgrade to another server. ([#11558](https://github.com/craftcms/cms/issues/11558))\n- Fixed a bug where Assets fields were relocating assets when saving a revision.\n- Fixed a bug where asset bundles weren\u2019t getting registered on the front end. ([#11555](https://github.com/craftcms/cms/issues/11555))\n\n## 4.1.1 - 2022-07-05\n\n### Changed\n- Improved the control panel tab design. ([#11524](https://github.com/craftcms/cms/pull/11524))\n- Changed the order of relational field condition rule operators, so \u201cis related to\u201d is listed first. ([#11550](https://github.com/craftcms/cms/discussions/11550))\n- Template caching is now supported for console requests, for `{% cache %}` tags that have the `globally` param. ([#11551](https://github.com/craftcms/cms/issues/11551))\n- Updated Composer to 2.2.15. ([#11538](https://github.com/craftcms/cms/issues/11538))\n\n### Fixed\n- Fixed an error that could occur if any custom fields were missing their field group. ([#11522](https://github.com/craftcms/cms/discussions/11522))\n- Fixed a bug where custom selects weren\u2019t scrolling to the visually-focused option.\n- Fixed errors that could occur if an element condition contained any rules for deleted custom fields. ([#11526](https://github.com/craftcms/cms/issues/11526))\n- Fixed a bug where the \u201cDeactivate users by default\u201d user setting wasn\u2019t working. ([#11519](https://github.com/craftcms/cms/issues/11519))\n- Fixed a styling issue with the Edit Route modal. ([#11528](https://github.com/craftcms/cms/issues/11528))\n- Fixed a bug where assets uploaded from Assets fields weren\u2019t retaining their original filename. ([#11530](https://github.com/craftcms/cms/issues/11530))\n- Fixed a bug where project config changes made at the end of the request lifecycle weren\u2019t getting saved.\n- Fixed a bug where toggling entries\u2019 and categories\u2019 site-specific statuses from element editor slideouts wasn\u2019t working. ([#11547](https://github.com/craftcms/cms/issues/11547))\n- Fixed a SQL error that occurred when running the `utils/prune-provisional-drafts` command. ([#11548](https://github.com/craftcms/cms/issues/11548))\n- Fixed focus styling issues with the Edit Route modal.\n\n## 4.1.0.2 - 2022-06-28\n\n### Fixed\n- Fixed a PHP error. ([#11518](https://github.com/craftcms/cms/issues/11518))\n\n## 4.1.0.1 - 2022-06-28\n\n### Fixed\n- Fixed an infinite recursion bug. ([#11514](https://github.com/craftcms/cms/issues/11514))\n\n## 4.1.0 - 2022-06-28\n\n### Added\n- Field layouts can now have \u201cLine Break\u201d UI elements. ([#11328](https://github.com/craftcms/cms/discussions/11328))\n- Added the `db/drop-all-tables` command. ([#11288](https://github.com/craftcms/cms/pull/11288))\n- Added the `elements/delete` command.\n- Added the `elements/restore` command.\n- Added the `project-config/get` command. ([#11341](https://github.com/craftcms/cms/pull/11341))\n- Added the `project-config/remove` command. ([#11341](https://github.com/craftcms/cms/pull/11341))\n- Added the `project-config/set` command. ([#11341](https://github.com/craftcms/cms/pull/11341))\n- The `AdminTable` Vue component can now be included into other Vue apps, in addition to being used as a standalone app. ([#11107](https://github.com/craftcms/cms/pull/11107))\n- Added a `one()` alias for `first()` to collections. ([#11134](https://github.com/craftcms/cms/discussions/11134))\n- Added `craft\\base\\Element::EVENT_DEFINE_CACHE_TAGS`. ([#11171](https://github.com/craftcms/cms/discussions/11171))\n- Added `craft\\base\\Element::cacheTags()`.\n- Added `craft\\base\\FieldInterface::getLabelId()`.\n- Added `craft\\console\\controllers\\UsersController::$activate`.\n- Added `craft\\elements\\conditions\\ElementCondition::$sourceKey`.\n- Added `craft\\elements\\db\\ElementQuery::EVENT_AFTER_POPULATE_ELEMENTS`. ([#11262](https://github.com/craftcms/cms/discussions/11262))\n- Added `craft\\elements\\db\\ElementQuery::EVENT_DEFINE_CACHE_TAGS`. ([#11171](https://github.com/craftcms/cms/discussions/11171))\n- Added `craft\\events\\PopulateElementsEvent`.\n- Added `craft\\fieldlayoutelements\\BaseField::labelId()`.\n- Added `craft\\fieldlayoutelements\\LineBreak`.\n- Added `craft\\helpers\\DateTimeHelper::now()`.\n- Added `craft\\helpers\\DateTimeHelper::pause()`. ([#11130](https://github.com/craftcms/cms/pull/11130))\n- Added `craft\\helpers\\DateTimeHelper::resume()`. ([#11130](https://github.com/craftcms/cms/pull/11130))\n\n### Changed\n- Improved overall control panel accessibility. ([#11297](https://github.com/craftcms/cms/pull/11297), [#11296](https://github.com/craftcms/cms/pull/11296), [#11414](https://github.com/craftcms/cms/pull/11414), [#11452](https://github.com/craftcms/cms/pull/11452))\n- Improved pagination UI accessibility. ([#11126](https://github.com/craftcms/cms/pull/11126))\n- Improved element index accessibility. ([#11169](https://github.com/craftcms/cms/pull/11169), [#11200](https://github.com/craftcms/cms/pull/11200), [#11251](https://github.com/craftcms/cms/pull/11251))\n- Improved Dashboard accessibility. ([#11217](https://github.com/craftcms/cms/pull/11217), [#11297](https://github.com/craftcms/cms/pull/11297))\n- Improved address management accessibility. ([#11397](https://github.com/craftcms/cms/pull/11397))\n- Improved Matrix field accessibility. ([#11306](https://github.com/craftcms/cms/pull/11306))\n- Improved mobile support. ([#11323](https://github.com/craftcms/cms/pull/11323), [#11430](https://github.com/craftcms/cms/pull/11430))\n- Improved keyboard support for custom selects. ([#11414](https://github.com/craftcms/cms/pull/11414))\n- It\u2019s now possible to remove all selected elements from relational fields by pressing <kbd>Backspace</kbd> or <kbd>Delete</kbd> while one of them is focused.\n- Improved the UI of condition builders. ([#11386](https://github.com/craftcms/cms/pull/11386))\n- Entry Type condition rules now allow multiple selections. ([#11124](https://github.com/craftcms/cms/pull/11124))\n- Element index filters now only show condition rules for the custom fields that are used by the field layouts in the selected source, if a native source is selected. ([#11187](https://github.com/craftcms/cms/discussions/11187))\n- Element index filters now only show condition rules for custom fields used by field layouts created for the target element type, if no native source is selected.\n- Condition builders can now include multiple rules with the same label, as long as they\u2019re in different groups.\n- Asset indexes now have a \u201cLocation\u201d table attribute option. ([#11450](https://github.com/craftcms/cms/discussions/11450))\n- It\u2019s now possible to sort entries by their section and type. ([#9192](https://github.com/craftcms/cms/discussions/9192), [#11335](https://github.com/craftcms/cms/discussions/11335))\n- It\u2019s now possible to sort assets by their file kind.\n- Element editor metadata now lists elements\u2019 IDs.\n- Live Preview now always shows a \u201cRefresh\u201d button, regardless of whether the preview target has auto-refresh enabled. ([#11160](https://github.com/craftcms/cms/discussions/11160))\n- Sites\u2019 Language settings now display the locale IDs as option hints, rather than the languages\u2019 native names. ([#11195](https://github.com/craftcms/cms/discussions/11195))\n- Selectize options can now specify searchable `keywords` that won\u2019t be visible in the UI.\n- Selectize inputs will now include their options\u2019 values as search keywords.\n- Newly-created entries now get placeholder Post Date set on them, so they get sorted appropriately when querying for entries ordered by `postDate`. ([#11272](https://github.com/craftcms/cms/issues/11272))\n- Element queries can now pass columns into the `orderBy` param in addition to `score` when searching. ([#11470](https://github.com/craftcms/cms/pull/11470), [#11457](https://github.com/craftcms/cms/discussions/11457))\n- Field layout elements within field layout designers now support double-clicking to open their settings slideout. ([#11277](https://github.com/craftcms/cms/discussions/11277))\n- The control panel\u2019s JavaScript queue is now paused when the browser tab isn\u2019t visible. ([#10632](https://github.com/craftcms/cms/issues/10632))\n- The `db/restore` command now asks whether the database should be backed up, and whether all existing database tables should be dropped, prior to restoring the backup. ([#11288](https://github.com/craftcms/cms/pull/11288))\n- The `users/create` command now asks whether the user should be activated when saved.\n- The `maxBackups` config setting now impacts `.sql.zip` files in addition to `.sql` files. ([#11241](https://github.com/craftcms/cms/issues/11241))\n- Deprecation messages are now consistently referred to as \u201cdeprecation warnings\u201d in the control panel.\n- Callback functions returned by elements\u2019 `sortOptions()`/`defineSortOptions()` methods are now passed a `craft\\db\\Connection` object as a second argument.\n- All element sources now have a \u201cSet Status\u201d action, even if the element type\u2019s `defineActions()` method didn\u2019t include one, if the element type\u2019s `hasStatuses()` method returns `true`. ([#11383](https://github.com/craftcms/cms/discussions/11383))\n- All element sources now have a \u201cView\u201d action, even if the element type\u2019s `defineActions()` method didn\u2019t include one, if the element type\u2019s `hasUris()` method returns `true`. ([#11383](https://github.com/craftcms/cms/discussions/11383))\n- All element sources now have \u201cEdit\u201d and \u201cDelete\u201d actions, even if the element type\u2019s `defineActions()` method didn\u2019t include them. ([#11383](https://github.com/craftcms/cms/discussions/11383))\n- The \u201cSet Status\u201d and \u201cEdit\u201d element actions are now only available for elements whose `canSave()` method returned `true`.\n- Assets fields now reject uploaded files which don\u2019t pass their \u201cSelectable Assets Condition\u201d setting. ([#11433](https://github.com/craftcms/cms/issues/11433))\n- It\u2019s now possible to save new assets without setting their `filename` or `kind` attributes, as long as `newLocation` or `newFilename` is set. ([#11439](https://github.com/craftcms/cms/issues/11439))\n- The `searchindex` table is now uses the InnoDB storage engine by default for MySQL installs. ([#11374](https://github.com/craftcms/cms/discussions/11374))\n- The `_layouts/elementindex` control panel template now sets the page title based on the element\u2019s `pluralDisplayName()` method by default. ([#11502](https://github.com/craftcms/cms/pull/11502))\n- `craft\\test\\ActiveFixture::$data` is now populated with the active record instances, making them accessible to tests via `$this->tester->grabFixture('my-fixture', 'data-key')`. ([#11445](https://github.com/craftcms/cms/pull/11445))\n- Address validation rules are now defined by `defineRules()`. ([#11471](https://github.com/craftcms/cms/pull/11471))\n- `Garnish.DELETE_KEY` now refers to the actual <kbd>Delete</kbd> key code, and the <kbd>Backspace</kbd> key code is now referenced by `Garnish.BACKSPACE_KEY`.\n\n### Deprecated\n- Deprecated `craft\\elements\\actions\\DeleteAssets`. `craft\\elements\\actions\\Delete` should be used instead.\n\n### Removed\n- Removed `craft\\elements\\conditions\\entries\\EntryTypeCondition::$sectionUid`.\n- Removed `craft\\elements\\conditions\\entries\\EntryTypeCondition::$entryTypeUid`.\n\n## 4.0.6 - 2022-06-28\n\n### Added\n- Added `craft\\fields\\BaseOptionsField::encodeValue()`.\n\n### Changed\n- Improved the `install` command\u2019s error output when invalid options were passed.\n- `canonical` is now a reserved field handle. ([#11503](https://github.com/craftcms/cms/issues/11503))\n- `craft\\fields\\BaseOptionsField::translatedOptions()` now has an `$encode` argument.\n\n### Fixed\n- Fixed a bug where self relations within relational fields were being forgotten. ([#11461](https://github.com/craftcms/cms/issues/11461))\n- Fixed a bug where the `install` command required `--site-name`, `--site-url`, and `--language` options to be passed when project config YAML was already present. ([#11513](https://github.com/craftcms/cms/issues/11513))\n- Fixed a bug where `Garnish.setFocusWithin()` wasn\u2019t working if the first focusable element was a checkbox. ([#11498](https://github.com/craftcms/cms/discussions/11498))\n- Fixed a bug where Matrix blocks could be saved in the wrong order.\n- Fixed a bug where Checkboxes, Dropdown, Multi-select, and Radio Buttons fields could lose their values if their option values were set to integers. ([#11461](https://github.com/craftcms/cms/issues/11461))\n\n## 4.0.5.2 - 2022-06-24\n\n### Fixed\n- Fixed a SQL error that could occur on MySQL 5. ([#11493](https://github.com/craftcms/cms/issues/11493))\n- Fixed a bug where Craft\u2019s Composer commands weren\u2019t ensuring that `config.allow-plugins.yiisoft/yii2-composer` was `true` in `composer.json`. ([#11399](https://github.com/craftcms/cms/issues/11399))\n\n## 4.0.5.1 - 2022-06-22\n\n### Fixed\n- Fixed a bug where not all changes to entries and categories created via the \u201cSave and add another\u201d action were propagating to other sites. ([#11476](https://github.com/craftcms/cms/issues/11476))\n- Fixed a bug where it wasn\u2019t possible to rename assets.\n- Fixed a bug where a provisional draft could be created for an entry if its form was interacted with before the page had fully initialized. ([#11466](https://github.com/craftcms/cms/issues/11466))\n- Fixed exact phrase searching on PostgreSQL. ([#11486](https://github.com/craftcms/cms/issues/11486))\n\n## 4.0.5 - 2022-06-21\n\n### Added\n- Added `craft\\helpers\\Number::isIntOrFloat()`.\n\n### Changed\n- Categories now support change tracking.\n- Improved performance when working with temp asset folders.\n- Temp asset folders are no longer created until they\u2019re actually needed. ([#11427](https://github.com/craftcms/cms/issues/11427))\n- Element index queries are no longer cached if they contain a search term.\n- Search inputs within field layout designers now prevent the containing form from being submitted when the <kbd>Return</kbd> key is pressed. ([#11415](https://github.com/craftcms/cms/discussions/11415))\n\n### Deprecated\n- Deprecated `craft\\services\\Categories::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Globals::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Sections::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Tags::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Users::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Volumes::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n\n### Fixed\n- Fixed an error that could occur when saving an element to a disabled site. ([#10499](https://github.com/craftcms/cms/issues/10499))\n- Fixed a bug where newly-added condition rules\u2019 types were still selectable for preexisting condition rules, when they shouldn\u2019t have been.\n- Fixed a bug where field layout designers were checking the wrong setting when determining whether to include UI elements (`customizableTabs` instead of `customizableUi`).\n- Fixed a bug where the Asset Indexes utility was analyzing image transform directories and files. ([#11362](https://github.com/craftcms/cms/issues/11362), [#11384](https://github.com/craftcms/cms/pull/11384))\n- Fixed a bug where focus was getting trapped within element editor slideouts\u2019 sidebars even for wide viewports where there was enough room to display the sidebar side-by-side with other slideout content. ([#11358](https://github.com/craftcms/cms/pull/11358))\n- Fixed a bug where users\u2019 Formatting Locale preferences weren\u2019t always being respected.\n- Fixed a bug where address card menus would linger around after an address was deleted.\n- Fixed a bug where the `index-assets` command could produce unexpected output. ([#11194](https://github.com/craftcms/cms/issues/11194)).\n- Fixed a bug where video controls within asset preview modals were inaccessible via the keyboard. ([#11371](https://github.com/craftcms/cms/pull/11371))\n- Fixed a bug where `transform` GraphQL directives weren\u2019t working for Assets fields. ([#10299](https://github.com/craftcms/cms/discussions/10299))\n- Fixed a PHP error that could occur when running the `help` command. ([#11423](https://github.com/craftcms/cms/issues/11423))\n- Fixed a bug where `craft\\helpers\\App::env()` was converting some values to integers or floats unexpectedly. ([#11422](https://github.com/craftcms/cms/issues/11422))\n- Fixed a bug where changes to existing Matrix blocks weren\u2019t saving for element types that supported drafts but not change tracking. ([#11419](https://github.com/craftcms/cms/issues/11419))\n- Fixed a bug where double-clicking on a related asset\u2019s thumbnail could open the asset\u2019s preview modal. ([#11424](https://github.com/craftcms/cms/issues/11424))\n- Fixed a bug where the control panel wasn\u2019t displaying file upload failure messages.\n- Fixed a bug where `action` query params were taking precedence over `actionTrigger` URI matches, when handling action requests. ([#11435](https://github.com/craftcms/cms/issues/11435))\n- Fixed a bug where image fields within Edit User pages and the Settings \u2192 General page weren\u2019t resetting properly after an image was deleted. ([#11436](https://github.com/craftcms/cms/issues/11436))\n- Fixed a bug where User Group condition rules set to the \u201cis not one of\u201d operator weren\u2019t being applied to individual elements correctly. ([#11444](https://github.com/craftcms/cms/discussions/11444))\n- Fixed a JavaScript error that occurred on element indexes for users that didn\u2019t have permission to edit any sites.\n- Fixed a bug where users without permission to create new entries in a section could duplicate existing entries. ([#11447](https://github.com/craftcms/cms/pull/11447))\n- Fixed a bug where element selection condition rules weren\u2019t working if an element ID was provided. ([#11451](https://github.com/craftcms/cms/pull/11451))\n- Fixed a PHP error that occurred when executing a GraphQL query using a token that wasn\u2019t set to a schema. ([#11453](https://github.com/craftcms/cms/issues/11453))\n- Fixed a PHP error that could occur when unserializing a `craft\\validator\\DateTimeValidator`, `LanguageValidator`, `StringValidator`, or `TimeValidator` object. ([#11454](https://github.com/craftcms/cms/issues/11454))\n- Fixed a bug where element types\u2019 `actions()` methods were getting called for all `element-indexes/*` action requests.\n- Fixed a bug where the `install` command would run non-interactively even if not all needed options were passed, resulting in an error after the database tables had been added. ([#11305](https://github.com/craftcms/cms/issues/11305))\n- Fixed a viewport clipping bug on the control panel\u2019s Login page. ([#11372](https://github.com/craftcms/cms/pull/11372))\n- Fixed a bug where filtering an element query by a relational field using `:empty:`/`:notempty:` wasn\u2019t factoring in the field\u2019s \u201cWhich site should entries be related from?\u201d setting properly.\n- Fixed a bug where filtering an element query by a relational field using `:empty:`/`:notempty:` wasn\u2019t factoring in the source elements\u2019 site IDs, for fields set to manage relations on a per-site basis. ([#11418](https://github.com/craftcms/cms/issues/11418))\n- Fixed a bug where the Temporary Uploads asset source wasn\u2019t including subfolders.\n- Fixed a bug where file upload progress bars weren\u2019t always going away when an upload error occurred.\n- Fixed a bug where Pashto was not being treated as an RTL language. ([#11428](https://github.com/craftcms/cms/issues/11428))\n- Fixed a bug where the `upscaleImages` config setting wasn\u2019t being respected for transforms where only a single image dimension was specified. ([#11398](https://github.com/craftcms/cms/issues/11398))\n- Fixed an error that could occur when executing a GraphQL query, if a section didn\u2019t have any entry types. ([#11273](https://github.com/craftcms/cms/issues/11273))\n- Fixed an error that could occur when changing the primary site on installs with a large number of users. ([#11459](https://github.com/craftcms/cms/issues/11459))\n- Fixed a bug where Assets fields within Vizy fields weren\u2019t getting relocated from the user\u2019s temp uploads folder. ([#11462](https://github.com/craftcms/cms/issues/11462))\n\n### Security\n- Environment-aware control panel fields no longer suggest environment variables that begin with `HTTP_`.\n- The Sendmail mailer no longer validates if the Sendmail Command setting is set to an environment variable that begins with `HTTP_`.\n\n## 4.0.4 - 2022-06-03\n\n### Added\n- Added support for querying for users with a `credentialed` status.\n- Added `craft\\elements\\db\\UserQuery::STATUS_CREDENTIALED`.\n- Added `craft\\errors\\FieldNotFoundException`.\n- Added `craft\\helpers\\Html::encodeSpaces()`.\n- Added `craft\\web\\twig\\variables\\Cp::getRequestedSite()`. ([#11082](https://github.com/craftcms/cms/discussions/11082))\n\n### Changed\n- `temp` is now a reserved volume handle.\n- Improved the performance of field layout designers. ([#11298](https://github.com/craftcms/cms/issues/11298))\n- All control panel pages now have a `site--<siteHandle>` class name on the `<body>`, based on the currently-selected site. ([#11303](https://github.com/craftcms/cms/discussions/11303))\n- Warnings are no longer logged when instantiating a field layout that references a deleted custom field. ([#11333](https://github.com/craftcms/cms/issues/11333))\n- Read/write splitting is now disabled for all console requests.\n- The `db/restore` command now prompts to clear data caches after the import is complete. ([#11327](https://github.com/craftcms/cms/issues/11327))\n- Entry queries no longer factor in seconds when looking for currently-live entries, without excluding entries that were published in the past minute. ([#5389](https://github.com/craftcms/cms/issues/5389))\n- `craft\\elements\\Asset::getUrl()` now encodes any spaces in the URL as `%20` entities.\n\n### Fixed\n- Fixed a bug where it wasn\u2019t possible to disable all table columns for an element source. ([#11291](https://github.com/craftcms/cms/issues/11291))\n- Fixed a bug where the Assets index page wasn\u2019t allowing any bulk actions for assets in the temporary volume. ([#11293](https://github.com/craftcms/cms/issues/11293))\n- Fixed a bug where PHP errors thrown while rendering a template weren\u2019t being handled properly. ([#11108](https://github.com/craftcms/cms/issues/11108))\n- Fixed a bug where site status labels were inconsistent on element edit pages. ([#11307](https://github.com/craftcms/cms/issues/11307))\n- Fixed a bug where addresses\u2019 County fields were mislabeled. ([#11314](https://github.com/craftcms/cms/pull/11314))\n- Fixed a bug where the control panel\u2019s login form wasn\u2019t handling errors properly. ([#11319](https://github.com/craftcms/cms/pull/11319))\n- Fixed a bug where it wasn\u2019t possible to use a `{% redirect %}` tag in an error template. ([#11336](https://github.com/craftcms/cms/issues/11336))\n- Fixed an error that occurred when saving an entry via a GraphQL mutation. ([#11312](https://github.com/craftcms/cms/issues/11312))\n- Fixed a bug where all web requests were getting no-cache headers. ([#11346](https://github.com/craftcms/cms/issues/11346))\n- Fixed a bug where user caches weren\u2019t getting invalidated when users were changed to a pending or inactive state.\n- Fixed a bug where querying for users with an `active` status was returning suspended users. ([#11370](https://github.com/craftcms/cms/pull/11370))\n- Fixed a bug where it wasn\u2019t possible to drag assets within Assets fields by their thumbnails. ([#11364](https://github.com/craftcms/cms/issues/11364))\n- Fixed a bug where asset thumbnails weren\u2019t loading if their filename contained a space. ([#11350](https://github.com/craftcms/cms/issues/11350))\n- Fixed a bug where `craft\\services\\AssetIndexer::indexFile()` wasn\u2019t removing the filename from the file path when setting the directory on the listing. ([#11365](https://github.com/craftcms/cms/issues/11365))\n- Fixed a bug where links within custom field instructions were getting mangled. ([#11377](https://github.com/craftcms/cms/issues/11377))\n- Fixed a bug where project config paths that contained slashes weren\u2019t getting handled properly. ([#10774](https://github.com/craftcms/cms/issues/10774))\n- Fixed a bug where the Login page had a tab-focusable \u201cSkip to content\u201d button. ([#11375](https://github.com/craftcms/cms/issues/11375))\n\n## 4.0.3 - 2022-05-20\n\n### Added\n- Added `craft\\elements\\db\\ElementQuery::prepareSubquery()`.\n\n### Changed\n- Element edit pages now disable pointer events on the content container for 300 milliseconds after the \u201cShowing your unsaved changes\u201d notice is displayed. ([#11229](https://github.com/craftcms/cms/issues/11229))\n- Users can now create drafts for entries they have permission to view, but not save. ([#11249](https://github.com/craftcms/cms/issues/11249))\n- User Group condition rules are no longer available in element conditions when no user groups exist. ([#11252](https://github.com/craftcms/cms/issues/11252))\n- Matrix blocks now have `data-type-name` attributes. ([#11286](https://github.com/craftcms/cms/pull/11286))\n- Reversed the order of Lightswitch fields\u2019 \u201cON Label\u201d and \u201cOFF Label\u201d settings. ([#11259](https://github.com/craftcms/cms/issues/11259))\n- `craft\\services\\Elements::duplicateElement()` now has a `$trackDuplication` argument.\n- `craft\\services\\Matrix::duplicateBlocks()` now has a `$trackDuplications` argument.\n\n### Fixed\n- Fixed a bug where dynamically-defined image transforms weren\u2019t respecting the `format` param, unless the `generateTransformsBeforePageLoad` config setting was enabled.\n- Fixed a bug where Table fields with Min Rows and Max Rows set to `1` were still showing a delete button. ([#11211](https://github.com/craftcms/cms/issues/11211))\n- Fixed an error that could occur when saving an Assets field that was restricted to a single location, at the root of a volume. ([#11212](https://github.com/craftcms/cms/issues/11212))\n- Fixed an error that could occur after a queue job execution had finished. ([#11213](https://github.com/craftcms/cms/issues/11213))\n- Fixed an error that could occur when saving an entry with Matrix blocks. ([#11155](https://github.com/craftcms/cms/issues/11155))\n- Fixed an error that occurred when saving a GraphQL schema without a scope. ([#11240](https://github.com/craftcms/cms/issues/11240))\n- Fixed an error that could occur when editing the public GraphQL schema, if a public token existed in the project config, but not the database. ([#11218](https://github.com/craftcms/cms/issues/11218))\n- Fixed some bugs with inconsistent asset indexing on Windows. ([#11174](https://github.com/craftcms/cms/issues/11174)), ([#11219](https://github.com/craftcms/cms/issues/11219))\n- Fixed a bug where custom fields weren\u2019t available to be included as table attributes. ([#11222](https://github.com/craftcms/cms/issues/11222))\n- Fixed a bug where Alternative Text wasn\u2019t available to be included as a table attribute. ([#11222](https://github.com/craftcms/cms/issues/11222))`immediately`\n- Fixed a JavaScript error that broke Matrix fields with Min Blocks and Max Blocks both set to `1`. ([#11233](https://github.com/craftcms/cms/issues/11233))\n- Fixed a bug where request context logs could appear when nothing else was logged. ([#11141](https://github.com/craftcms/cms/issues/11141))\n- Fixed a bug where stack traces could be erroneously filtered from logs.\n- Fixed a bug where removing an element from a relational field within an element editor could cause the editor to create a provisional draft, even if the element type didn\u2019t support drafts. ([#11242](https://github.com/craftcms/cms/issues/11242))\n- Fixed a bug where draft editor pages had two identical \u201cSave and continue editing\u201d alternate form actions.\n- Fixed a JavaScript warning that occurred when viewing an element edit page, if the user didn\u2019t have permission to edit it.\n- Fixed a bug where asset selector modals weren\u2019t fully initializing for Assets fields, if they were targeting the user\u2019s temp folder. ([#11254](https://github.com/craftcms/cms/issues/11254))\n- Fixed an error that occurred when saving an entry via a GraphQL mutation. ([#11258](https://github.com/craftcms/cms/issues/11258))\n- Fixed a bug where Matrix block types\u2019 layout elements were getting new UUIDs assigned each time the Matrix field was edited. ([#11248](https://github.com/craftcms/cms/issues/11248))\n- Fixed a bug where the web-based installation wizard was throwing an exception if a database connection couldn\u2019t be established, and there was no `config/db.php` file. ([#11245](https://github.com/craftcms/cms/issues/11245))\n- Fixed a bug where editable tables\u2019 delete buttons\u2019 `aria-label` attributes weren\u2019t getting updated when table rows were reordered or deleted.\n- Fixed a bug where editable tables\u2019 delete buttons weren\u2019t visually disabled when the minimum number of rows had been reached.\n- Fixed a bug where all eager-loaded `srcset`-style transform sizes were relative to the first eager-loaded transform, rather than the prior one. ([#11209](https://github.com/craftcms/cms/issues/11209))\n- Fixed a bug where eager-loaded `srcset`-style transform sizes didn\u2019t reference the prior eager-loaded transform\u2019s `format`, `interlace`, `mode`, `position`, or `quality` settings. ([#11264](https://github.com/craftcms/cms/issues/11264))\n- Fixed a bug where the web-based installation wizard wouldn\u2019t show the database connection screen if a connection could be established but no database was selected. ([#11245](https://github.com/craftcms/cms/issues/11245))\n- Fixed an error that could occur when applying a multi-site draft with relational fields. ([#11220](https://github.com/craftcms/cms/issues/11220))\n- Fixed a bug where Matrix blocks could be deleted from newly-created multi-site entries, if the edit page was reloaded. ([#10906](https://github.com/craftcms/cms/issues/10906))\n\n## 4.0.2 - 2022-05-11\n\n### Added\n- Added `craft\\events\\LocateUploadedFilesEvent`.\n- Added `craft\\fields\\Assets::EVENT_LOCATE_UPLOADED_FILES`. ([#11123](https://github.com/craftcms/cms/discussions/11123))\n\n### Changed\n- `elements/*` actions no longer include custom field values in the response data, improving performance.\n- Garnish menu buttons are now aware of the `disabled` attribute. ([#11128](https://github.com/craftcms/cms/issues/11128))\n- Improved save performance for multi-site elements ([#11113](https://github.com/craftcms/cms/issues/11113))\n- Built-in Composer actions now ensure that `composer.json` allows the `craftcms/plugin-installer` Composer plugin.\n\n### Fixed\n- Fixed an error that occurred when searching for elements by a custom field. ([#11120](https://github.com/craftcms/cms/pull/11120))\n- Fixed a bug where asset upload failures weren\u2019t being handled properly. ([#11156](https://github.com/craftcms/cms/issues/11156))\n- Fixed a bug where warning and error logs were being sent to both `stdout` and `stderr` when `CRAFT_STREAM_LOG` was enabled. ([#11189](https://github.com/craftcms/cms/issues/11189))\n- Fixed an error that occurred when exporting elements with relational fields using the \u201cExpanded\u201d export type. ([#11127](https://github.com/craftcms/cms/issues/11127))\n- Fixed a PHP deprecation warning that occurred if the `tablePrefix` database connection setting was `null`.\n- Fixed a bug where category groups were being identified as \u201c{name}\u201d in user permission lists. ([#11132](https://github.com/craftcms/cms/issues/11132))\n- Fixed a bug where Assets fields\u2019 \u201cUpload files\u201d buttons weren\u2019t wrapping when there wasn\u2019t enough space to show them alongside \u201cAdd an asset\u201d. ([#11133](https://github.com/craftcms/cms/issues/11133))\n- Fixed a bug where `Craft.getUrl()` was appending empty query strings to URLs when they weren\u2019t needed. ([#11159](https://github.com/craftcms/cms/issues/11159))\n- Fixed a bug where addresses could validate the wrong set of required fields, if the validation rules were invoked before the country code was set. ([#11162](https://github.com/craftcms/cms/issues/11162))\n- Fixed an error that could occur when viewing the Temporary Uploads volume, if the Temp Uploads Location asset setting was set to \u201cIn the local temp folder\u201d. ([#11192](https://github.com/craftcms/cms/issues/11192))\n- Fixed an error that could occur when deleting a volume, if its filesystem had been deleted.\n- Fixed an error that could occur when rendering the thumbnail preview for an asset, if its file was missing. ([#11196](https://github.com/craftcms/cms/issues/11196))\n- Fixed a bug where soft-deleted drafts\u2019 search keywords weren\u2019t getting re-indexed if they were restored.\n- Fixed an error that occurred when transforming an SVG image without specifying a width or height. ([#11122](https://github.com/craftcms/cms/issues/11122))\n- Fixed an error that occurred when saving a Number field with a non-numeric value. ([#11164](https://github.com/craftcms/cms/issues/11164))\n- Fixed a bug where it wasn\u2019t possible to drag an item to the top in admin tables. ([#10781](https://github.com/craftcms/cms/issues/10781))\n- Fixed a bug where entries within Structure sections weren\u2019t expandable if their only descendants were unpublished drafts.\n- Fixed a bug where expanding a collapsed Structure section entry wouldn\u2019t reveal its descendants, if the parent was a draft. ([#11186](https://github.com/craftcms/cms/issues/11186))\n- Fixed a bug where element caches weren\u2019t getting cleared for elements when they were propagated to a newly-created site.\n\n## 4.0.1 - 2022-05-06\n\n### Fixed\n- Fixed a bug where Money field labels\u2019 `for` attributes weren\u2019t referencing the correct input ID. ([#11016](https://github.com/craftcms/cms/pull/11016))\n- Fixed a bug where Money field inputs weren\u2019t getting `aria-describedby` attributes. ([#11016](https://github.com/craftcms/cms/pull/11016))\n- Fixed an error that occurred when loading an edit screen for an element type that didn\u2019t have a field layout. ([#11110](https://github.com/craftcms/cms/pull/11110))\n- Fixed a bug where condition rules that weren\u2019t selectable (per `isSelectable()`) were still visible in the rule dropdown menu. ([#11104](https://github.com/craftcms/cms/pull/11104))\n- Fixed a bug where element edit pages could reload themselves immediately after saving the element. ([#11084](https://github.com/craftcms/cms/issues/11084))\n- Fixed a bug where tabs weren\u2019t interactive after changing an entry\u2019s type, if the new entry type didn\u2019t have a tab of the same name as the previously-selected tab. ([#11093](https://github.com/craftcms/cms/issues/11093))\n- Fixed a bug where Twig syntax errors weren\u2019t being handled properly. ([#11108](https://github.com/craftcms/cms/issues/11108))\n- Fixed an error that occurred when attempting to delete a global set. ([#11100](https://github.com/craftcms/cms/issues/11100))\n- Fixed an error that could occur when applying a draft. ([#11083](https://github.com/craftcms/cms/issues/11083))\n- Fixed a bug where element queries weren\u2019t returning any results if an element attribute table wasn\u2019t joined in, and the element query was set to an abstract element class. ([#11105](https://github.com/craftcms/cms/issues/11105))\n\n## 4.0.0.1 - 2022-05-04\n\n### Changed\n- The `setup` command now writes the application ID to a `CRAFT_APP_ID` environment variable.\n- The `setup` command now writes the security key to a `CRAFT_SECURITY_KEY` environment variable.\n\n## 4.0.0 - 2022-05-04\n\n### Added\n- Entries\u2019, categories\u2019, and assets\u2019 edit pages, and all element types via slideouts, now use a unified editing experience. ([#10467](https://github.com/craftcms/cms/pull/10467))\n- Categories now support drafts. ([#10467](https://github.com/craftcms/cms/pull/10467))\n- Element slideouts now support provisional drafts and autosaving, for element types that support them. ([#10467](https://github.com/craftcms/cms/pull/10467))\n- Element indexes can now be filtered by element attributes and custom field values. ([#9192](https://github.com/craftcms/cms/discussions/9192), [#9450](https://github.com/craftcms/cms/discussions/9450), [#9462](https://github.com/craftcms/cms/discussions/9462), [#9483](https://github.com/craftcms/cms/discussions/9483))\n- Admins can now create custom element sources from the Customize Sources modal. ([#8423](https://github.com/craftcms/cms/discussions/8423))\n- It\u2019s now possible to disable native element sources from the Customize Sources modal. ([#10676](https://github.com/craftcms/cms/discussions/10676))\n- Field layout tabs, fields, and UI elements can now be conditionally shown based on properties of the current user and/or element being edited. ([#8099](https://github.com/craftcms/cms/discussions/8099), [#8154](https://github.com/craftcms/cms/discussions/8154))\n- Assets, Entries, and Users fields have new condition settings that can be used to further limit which elements should be relatable, beyond the existing field settings. ([#10393](https://github.com/craftcms/cms/pull/10393))\n- Assets, Entries, and Users fields have new \u201cMin Relations\u201d settings, and their former \u201cLimit\u201d settings have been renamed to \u201cMax Relations\u201d. ([#8621](https://github.com/craftcms/cms/discussions/8621))\n- Added a dedicated \u201cFull Name\u201d field to users. \u201cFirst Name\u201d and \u201cLast Name\u201d are now parsed out from the full name automatically when a user is saved. ([#10405](https://github.com/craftcms/cms/discussions/10405))\n- Added the \u201cInactive\u201d user status, which can be used by users which can\u2019t be signed into. ([#8963](https://github.com/craftcms/cms/discussions/8963))\n- Added \u201cCredentialed\u201d and \u201cInactive\u201d user sources.\n- Added the \u201cDeactivate\u2026\u201d user action for pending and active users.\n- Users can now have an \u201cAddresses\u201d field. ([#10507](https://github.com/craftcms/cms/pull/10507))\n- Added the concept of \u201cfilesystems\u201d, which handle file operations, either locally or on a remote service like Amazon S3.\n- It\u2019s now possible to set sites\u2019 Status settings to environment variables. ([#3005](https://github.com/craftcms/cms/issues/3005))\n- Added the Money field type.\n- Craft now provides a native \u201cAlternative Text\u201d (`alt`) field for assets. ([#10302](https://github.com/craftcms/cms/discussions/10302))\n- Asset thumbnails in the control panel now have `alt` attributes, for assets with a filled-in Alternative Text value.\n- Added the `index-assets/cleanup` command.\n- Added the \u201cDeactivate users by default\u201d user registration setting, which replaces \u201cSuspend users by default\u201d. ([#5830](https://github.com/craftcms/cms/issues/5830))\n- Element source settings are now stored in the project config. ([#8616](https://github.com/craftcms/cms/discussions/8616))\n- Improved element index accessibility. ([#10629](https://github.com/craftcms/cms/pull/10629), [#10660](https://github.com/craftcms/cms/pull/10660))\n- Improved Live Preview accessibility for screen readers. ([#10688](https://github.com/craftcms/cms/pull/10688))\n- Slideouts, Live Preview, and Matrix blocks are no longer animated for browsers that have requested reduced motion. ([#10665](https://github.com/craftcms/cms/pull/10665))\n- Added support for `JSON` columns. ([#9089](https://github.com/craftcms/cms/pull/9089))\n- It\u2019s now possible to edit images\u2019 focal points from their preview modals. ([#8489](https://github.com/craftcms/cms/discussions/8489))\n- Added support for Monolog and the PSR-3 logging interface. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- Added the `|address` Twig filter.\n- Added the `|money` Twig filter.\n- Added the `collect()` Twig function.\n- Added the `assetUploaders`, `authors`, and `fullName` user query params.\n- Added the `primaryOwner` and `primaryOwnerId` Matrix block query params.\n- Added the `hasAlt` asset query param.\n- Added the `button`, `submitButton`, `fs`, `fsField`, `volume`, and `volumeField` macros to the `_includes/forms` control panel template.\n- Added the `buildId` general config. ([#10705](https://github.com/craftcms/cms/pull/10705))\n- Added support for setting custom config settings from `config/custom.php`, which are accessible via `Craft::$app->config->custom`. ([#10012](https://github.com/craftcms/cms/issues/10012))\n- Added the `addresses`, `address`, and `addressCount` GraphQL queries.\n- Added the `hasAlt` argument to asset GraphQL queries.\n- Added the `alt` field to assets queried via GraphQL.\n- Added the `fullName`, `assetUploaders`, and `authors` arguments to user GraphQL queries.\n- Added the `addresses` field to user GraphQL queries.\n- GraphQL schemas now include settings that determine which sites elements can be queried from. ([#10610](https://github.com/craftcms/cms/issues/10610))\n- Added the `assets/icon` action.\n- Added the `assets/update-focal-point` action.\n- Added the `categories/create` action.\n- Added the `elements/apply-draft` action.\n- Added the `elements/create` action.\n- Added the `elements/delete-draft` action.\n- Added the `elements/delete-for-site` action.\n- Added the `elements/delete` action.\n- Added the `elements/duplicate` action.\n- Added the `elements/edit` action.\n- Added the `elements/redirect` action.\n- Added the `elements/revert` action.\n- Added the `elements/save-draft` action.\n- Added the `elements/save` action.\n- Added the `users/delete-address` action.\n- Added the `users/save-address` action.\n- Added the `app/render-element` control panel controller action.\n- Added the `element-indexes/element-table-html` control panel controller action.\n- Added `craft\\base\\ApplicationTrait::getConditions()`.\n- Added `craft\\base\\ApplicationTrait::getElementSources()`, which replaces `getElementIndexes()`.\n- Added `craft\\base\\ApplicationTrait::getFs()`.\n- Added `craft\\base\\ApplicationTrait::getImageTransforms()`, which replaces `getAssetTransforms()`.\n- Added `craft\\base\\conditions\\BaseCondition`.\n- Added `craft\\base\\conditions\\BaseConditionRule`.\n- Added `craft\\base\\conditions\\BaseDateRangeConditionRule`.\n- Added `craft\\base\\conditions\\BaseElementSelectConditionRule`.\n- Added `craft\\base\\conditions\\BaseLightswitchConditionRule`.\n- Added `craft\\base\\conditions\\BaseMultiSelectConditionRule`.\n- Added `craft\\base\\conditions\\BaseNumberConditionRule`.\n- Added `craft\\base\\conditions\\BaseSelectConditionRule`.\n- Added `craft\\base\\conditions\\BaseTextConditionRule`.\n- Added `craft\\base\\conditions\\ConditionInterface`.\n- Added `craft\\base\\conditions\\ConditionRuleInterface`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_CREATE_DRAFTS`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_DELETE_FOR_SITE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_DELETE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_DUPLICATE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_SAVE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_VIEW`.\n- Added `craft\\base\\Element::EVENT_DEFINE_ADDITIONAL_BUTTONS`. ([#10420](https://github.com/craftcms/cms/discussions/10420))\n- Added `craft\\base\\Element::getParentId()`.\n- Added `craft\\base\\Element::hasNewParent()`.\n- Added `craft\\base\\Element::notesFieldHtml()`.\n- Added `craft\\base\\Element::setParentId()`.\n- Added `craft\\base\\Element::statusFieldHtml()`.\n- Added `craft\\base\\ElementInterface::canCreateDrafts()`.\n- Added `craft\\base\\ElementInterface::canDelete()`.\n- Added `craft\\base\\ElementInterface::canDeleteForSite()`.\n- Added `craft\\base\\ElementInterface::canDuplicate()`.\n- Added `craft\\base\\ElementInterface::canSave()`.\n- Added `craft\\base\\ElementInterface::canView()`.\n- Added `craft\\base\\ElementInterface::createAnother()`.\n- Added `craft\\base\\ElementInterface::createCondition()`.\n- Added `craft\\base\\ElementInterface::getAdditionalButtons()`.\n- Added `craft\\base\\ElementInterface::getPostEditUrl()`.\n- Added `craft\\base\\ElementInterface::getThumbAlt()`.\n- Added `craft\\base\\ElementInterface::hasRevisions()`.\n- Added `craft\\base\\ElementInterface::prepareEditScreen()`.\n- Added `craft\\base\\FieldInterface::getElementConditionRuleType()`.\n- Added `craft\\base\\FieldInterface::isRequirable()`.\n- Added `craft\\base\\FieldLayoutComponent`.\n- Added `craft\\base\\Fs`.\n- Added `craft\\base\\FsInterface`.\n- Added `craft\\base\\FsTrait`.\n- Added `craft\\base\\Image::heartbeat()`.\n- Added `craft\\base\\Image::setHeartbeatCallback()`.\n- Added `craft\\base\\imagetransforms\\EagerImageTransformerInterface`.\n- Added `craft\\base\\imagetransforms\\ImageEditorTransformerInterface`.\n- Added `craft\\base\\imagetransforms\\ImageTransformerInterface`.\n- Added `craft\\base\\LocalFsInterface`.\n- Added `craft\\base\\Model::defineBehaviors()`. ([#10691](https://github.com/craftcms/cms/pull/10691))\n- Added `craft\\base\\ModelInterface`.\n- Added `craft\\base\\NameTrait`.\n- Added `craft\\base\\PluginInterface::config()`. ([#11039](https://github.com/craftcms/cms/pull/11039))\n- Added `craft\\behaviors\\SessionBehavior::broadcastToJs()`.\n- Added `craft\\behaviors\\SessionBehavior::getError()`.\n- Added `craft\\behaviors\\SessionBehavior::getNotice()`.\n- Added `craft\\controllers\\AddressesController`.\n- Added `craft\\controllers\\AssetIndexesController`.\n- Added `craft\\controllers\\ConditionsController`.\n- Added `craft\\controllers\\ElementIndexesController::$condition`.\n- Added `craft\\controllers\\FsController`.\n- Added `craft\\controllers\\ImageTransformsController`.\n- Added `craft\\db\\Migration::archiveTableIfExists()`. ([#10827](https://github.com/craftcms/cms/discussions/10827))\n- Added `craft\\db\\Migration::dropAllForeignKeysToTable()`.\n- Added `craft\\db\\Migration::dropForeignKeyIfExists()`.\n- Added `craft\\db\\Migration::renameTable()`.\n- Added `craft\\db\\Query::collect()`, which returns the query results as an `Illuminate\\Support\\Collection` object rather than an array. ([#8513](https://github.com/craftcms/cms/discussions/8513))\n- Added `craft\\db\\Table::ADDRESSES`.\n- Added `craft\\db\\Table::ASSETINDEXINGSESSIONS`.\n- Added `craft\\db\\Table::IMAGETRANSFORMINDEX`.\n- Added `craft\\db\\Table::IMAGETRANSFORMS`.\n- Added `craft\\db\\Table::MATRIXBLOCKS_OWNERS`.\n- Added `craft\\debug\\LogTarget`.\n- Added `craft\\debug\\MailPanel`.\n- Added `craft\\elements\\Address`.\n- Added `craft\\elements\\Asset::$alt`.\n- Added `craft\\elements\\Asset::EVENT_AFTER_GENERATE_TRANSFORM`.\n- Added `craft\\elements\\Asset::EVENT_BEFORE_GENERATE_TRANSFORM`.\n- Added `craft\\elements\\Asset::getFs()`.\n- Added `craft\\elements\\Asset::setFilename()`.\n- Added `craft\\elements\\conditions\\addresses\\AddressCondition`.\n- Added `craft\\elements\\conditions\\addresses\\CountryConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\AssetCondition`.\n- Added `craft\\elements\\conditions\\assets\\DateModifiedConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\FilenameConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\FileSizeConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\FileTypeConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\HasAltConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\HeightConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\UploaderConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\VolumeConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\WidthConditionRule`.\n- Added `craft\\elements\\conditions\\categories\\CategoryCondition`.\n- Added `craft\\elements\\conditions\\categories\\GroupConditionRule`.\n- Added `craft\\elements\\conditions\\DateCreatedConditionRule`.\n- Added `craft\\elements\\conditions\\DateUpdatedConditionRule`.\n- Added `craft\\elements\\conditions\\ElementCondition`.\n- Added `craft\\elements\\conditions\\ElementConditionInterface`.\n- Added `craft\\elements\\conditions\\ElementConditionRuleInterface`.\n- Added `craft\\elements\\conditions\\entries\\AuthorConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\AuthorGroupConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\EntryCondition`.\n- Added `craft\\elements\\conditions\\entries\\ExpiryDateConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\PostDateConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\SectionConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\TypeConditionRule`.\n- Added `craft\\elements\\conditions\\HasUrlConditionRule`.\n- Added `craft\\elements\\conditions\\IdConditionRule`.\n- Added `craft\\elements\\conditions\\LevelConditionRule`.\n- Added `craft\\elements\\conditions\\RelatedToConditionRule`.\n- Added `craft\\elements\\conditions\\SlugConditionRule`.\n- Added `craft\\elements\\conditions\\tags\\GroupConditionRule`.\n- Added `craft\\elements\\conditions\\tags\\TagCondition`.\n- Added `craft\\elements\\conditions\\TitleConditionRule`.\n- Added `craft\\elements\\conditions\\UriConditionRule`.\n- Added `craft\\elements\\conditions\\users\\AdminConditionRule`.\n- Added `craft\\elements\\conditions\\users\\CredentialedConditionRule`.\n- Added `craft\\elements\\conditions\\users\\EmailConditionRule`.\n- Added `craft\\elements\\conditions\\users\\FirstNameConditionRule`.\n- Added `craft\\elements\\conditions\\users\\GroupConditionRule`.\n- Added `craft\\elements\\conditions\\users\\LastLoginDateConditionRule`.\n- Added `craft\\elements\\conditions\\users\\LastNameConditionRule`.\n- Added `craft\\elements\\conditions\\users\\UserCondition`.\n- Added `craft\\elements\\conditions\\users\\UsernameConditionRule`.\n- Added `craft\\elements\\db\\AddressQuery`.\n- Added `craft\\elements\\MatrixBlock::$primaryOwnerId`.\n- Added `craft\\elements\\MatrixBlock::$saveOwnership`.\n- Added `craft\\elements\\User::$active`.\n- Added `craft\\elements\\User::$fullName`.\n- Added `craft\\elements\\User::canAssignUserGroups()`.\n- Added `craft\\elements\\User::getAddresses()`.\n- Added `craft\\elements\\User::getIsCredentialed()`.\n- Added `craft\\elements\\User::STATUS_INACTIVE`.\n- Added `craft\\errors\\FsException`.\n- Added `craft\\errors\\FsObjectExistsException`.\n- Added `craft\\errors\\FsObjectNotFoundException`.\n- Added `craft\\errors\\ImageTransformException`.\n- Added `craft\\errors\\InvalidFsException`.\n- Added `craft\\errors\\MissingVolumeFolderException`.\n- Added `craft\\events\\AuthorizationCheckEvent`.\n- Added `craft\\events\\CreateElementCheckEvent`.\n- Added `craft\\events\\DefineElementEditorHtmlEvent`.\n- Added `craft\\events\\DefineElementInnerHtmlEvent`. ([#11035](https://github.com/craftcms/cms/pull/11035))\n- Added `craft\\events\\DefineHtmlEvent::$static`.\n- Added `craft\\events\\FsEvent`.\n- Added `craft\\events\\GenerateTransformEvent::$asset`.\n- Added `craft\\events\\GenerateTransformEvent::$transform`.\n- Added `craft\\events\\GenerateTransformEvent::$url`.\n- Added `craft\\events\\ImageTransformerOperationEvent`.\n- Added `craft\\events\\ImageTransformEvent`.\n- Added `craft\\events\\RegisterConditionRuleTypesEvent`.\n- Added `craft\\events\\TransformImageEvent`.\n- Added `craft\\fieldlayoutelements\\addresses\\AddressField`.\n- Added `craft\\fieldlayoutelements\\addresses\\CountryCodeField`.\n- Added `craft\\fieldlayoutelements\\addresses\\LabelField`.\n- Added `craft\\fieldlayoutelements\\addresses\\LatLongField`.\n- Added `craft\\fieldlayoutelements\\addresses\\OrganizationField`.\n- Added `craft\\fieldlayoutelements\\addresses\\OrganizationTaxIdField`.\n- Added `craft\\fieldlayoutelements\\assets\\AltField`.\n- Added `craft\\fieldlayoutelements\\BaseField::selectorLabel()`.\n- Added `craft\\fieldlayoutelements\\FullNameField`.\n- Added `craft\\fieldlayoutelements\\TextareaField`.\n- Added `craft\\fieldlayoutelements\\users\\AddressesField`.\n- Added `craft\\fields\\Assets::$allowSubfolders`.\n- Added `craft\\fields\\Assets::$restrictedDefaulUploadSubpath`.\n- Added `craft\\fields\\BaseRelationField::createSelectionCondition()`.\n- Added `craft\\fields\\BaseRelationField::getSelectionCondition()`.\n- Added `craft\\fields\\BaseRelationField::setSelectionCondition()`.\n- Added `craft\\fields\\conditions\\DateFieldConditionRule`.\n- Added `craft\\fields\\conditions\\FieldConditionRuleInterface`.\n- Added `craft\\fields\\conditions\\FieldConditionRuleTrait`.\n- Added `craft\\fields\\conditions\\LightswitchFieldConditionRule`.\n- Added `craft\\fields\\conditions\\NumberFieldConditionRule`.\n- Added `craft\\fields\\conditions\\OptionsFieldConditionRule`.\n- Added `craft\\fields\\conditions\\RelationalFieldConditionRule`.\n- Added `craft\\fields\\conditions\\TextFieldConditionRule`.\n- Added `craft\\fields\\Money`.\n- Added `craft\\fs\\Local`.\n- Added `craft\\fs\\MissingFs`.\n- Added `craft\\fs\\Temp`.\n- Added `craft\\gql\\arguments\\elements\\Address`.\n- Added `craft\\gql\\base\\SingularTypeInterface`.\n- Added `craft\\gql\\interfaces\\elements\\Address`.\n- Added `craft\\gql\\queries\\Address`.\n- Added `craft\\gql\\resolvers\\elements\\Address`.\n- Added `craft\\gql\\TypeManager::registerFieldDefinitions()`.\n- Added `craft\\gql\\types\\elements\\Address`.\n- Added `craft\\gql\\types\\generators\\AddressType`.\n- Added `craft\\helpers\\App::cliOption()`.\n- Added `craft\\helpers\\App::devMode()`.\n- Added `craft\\helpers\\App::envConfig()`. ([#10869](https://github.com/craftcms/cms/pull/10869))\n- Added `craft\\helpers\\App::isStreamLog()`.\n- Added `craft\\helpers\\App::normalizeValue()`.\n- Added `craft\\helpers\\Assets::downloadFile()`.\n- Added `craft\\helpers\\Assets::iconPath()`.\n- Added `craft\\helpers\\Assets::iconUrl()`.\n- Added `craft\\helpers\\Assets::revParams()`.\n- Added `craft\\helpers\\Cp::addressCardHtml()`.\n- Added `craft\\helpers\\Cp::addressCardsHtml()`.\n- Added `craft\\helpers\\Cp::addressFieldsHtml()`.\n- Added `craft\\helpers\\Cp::dateFieldHtml()`.\n- Added `craft\\helpers\\Cp::dateHtml()`.\n- Added `craft\\helpers\\Cp::elementSelectHtml()`.\n- Added `craft\\helpers\\Cp::EVENT_DEFINE_ELEMENT_INNER_HTML`. ([#11035](https://github.com/craftcms/cms/pull/11035))\n- Added `craft\\helpers\\Cp::fieldLayoutDesignerHtml()`.\n- Added `craft\\helpers\\Cp::lightswitchHtml()`.\n- Added `craft\\helpers\\Cp::multiSelectFieldHtml()`.\n- Added `craft\\helpers\\Cp::multiSelectHtml()`.\n- Added `craft\\helpers\\Cp::requestedSite()`.\n- Added `craft\\helpers\\Cp::textareaHtml()`.\n- Added `craft\\helpers\\Cp::textHtml()`.\n- Added `craft\\helpers\\Cp::timeFieldHtml()`.\n- Added `craft\\helpers\\Cp::timeHtml()`.\n- Added `craft\\helpers\\Db::dropAllForeignKeysToTable()`.\n- Added `craft\\helpers\\Db::dropForeignKeyIfExists()`.\n- Added `craft\\helpers\\Db::dropIndexIfExists()`.\n- Added `craft\\helpers\\Db::findForeignKey()`.\n- Added `craft\\helpers\\Db::findIndex()`.\n- Added `craft\\helpers\\Db::parseMoneyParam()`.\n- Added `craft\\helpers\\Db::parseNumericParam()`.\n- Added `craft\\helpers\\Db::prepareMoneyForDb()`.\n- Added `craft\\helpers\\Db::renameTable()`.\n- Added `craft\\helpers\\FileHelper::deleteFileAfterRequest()`.\n- Added `craft\\helpers\\FileHelper::deleteQueuedFiles()`.\n- Added `craft\\helpers\\Gql::getSchemaContainedEntryTypes)()`.\n- Added `craft\\helpers\\Html::hiddenLabel()`.\n- Added `craft\\helpers\\Html::unwrapCondition()`.\n- Added `craft\\helpers\\Html::unwrapNoscript()`.\n- Added `craft\\helpers\\ImageTransforms`.\n- Added `craft\\helpers\\Money`.\n- Added `craft\\helpers\\Number::isInt()`.\n- Added `craft\\helpers\\Number::toIntOrFloat()`.\n- Added `craft\\helpers\\ProjectConfig::encodeValueAsString()`.\n- Added `craft\\helpers\\ProjectConfig::ensureAllSectionsProcessed()`.\n- Added `craft\\helpers\\ProjectConfig::traverseDataArray()`.\n- Added `craft\\helpers\\Typecast`. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- Added `craft\\i18n\\Translation`.\n- Added `craft\\imagetransforms\\ImageTransformer`.\n- Added `craft\\log\\ContextProcessor`.\n- Added `craft\\log\\Dispatcher::getTargets()`.\n- Added `craft\\log\\MessageProcessor`.\n- Added `craft\\log\\MonologTarget`.\n- Added `craft\\models\\AssetIndexingSession`.\n- Added `craft\\models\\FieldLayout::getElementsByType()`.\n- Added `craft\\models\\FieldLayout::getFirstElementByType()`.\n- Added `craft\\models\\FieldLayout::getFirstVisibleElementByType()`.\n- Added `craft\\models\\FieldLayout::getVisibleCustomFields()`.\n- Added `craft\\models\\FieldLayout::getVisibleElementsByType()`.\n- Added `craft\\models\\FieldLayoutElement::$uid`.\n- Added `craft\\models\\FieldLayoutElement::getLayout()` and `setLayout()`.\n- Added `craft\\models\\FieldLayoutForm::getVisibleElements()`.\n- Added `craft\\models\\FieldLayoutFormTab::getTabId()`.\n- Added `craft\\models\\FieldLayoutFormTab::getUid()`.\n- Added `craft\\models\\FieldLayoutTab::getElements()` and `setElements()`.\n- Added `craft\\models\\FsListing`.\n- Added `craft\\models\\ImageTransform`.\n- Added `craft\\models\\ImageTransformIndex`.\n- Added `craft\\models\\ProjectConfigData`.\n- Added `craft\\models\\ReadOnlyProjectConfigData`.\n- Added `craft\\models\\Volume`.\n- Added `craft\\queue\\jobs\\Proxy`.\n- Added `craft\\queue\\Queue::$proxyQueue`, which can be set to another queue configuration that all jobs should be sent to as proxies. ([#10999](https://github.com/craftcms/cms/pull/10999))\n- Added `craft\\records\\Address`.\n- Added `craft\\records\\AssetIndexingSession`.\n- Added `craft\\records\\ImageTransform`.\n- Added `craft\\services\\Addresses`.\n- Added `craft\\services\\AssetIndexer::createIndexingSession()`.\n- Added `craft\\services\\AssetIndexer::getExistingIndexingSessions()`.\n- Added `craft\\services\\AssetIndexer::getIndexingSessionById()`.\n- Added `craft\\services\\AssetIndexer::getMissingEntriesForSession()`.\n- Added `craft\\services\\AssetIndexer::getSkippedItemsForSession()`.\n- Added `craft\\services\\AssetIndexer::indexFileByListing()`.\n- Added `craft\\services\\AssetIndexer::indexFolderByEntry()`.\n- Added `craft\\services\\AssetIndexer::indexFolderByListing()`.\n- Added `craft\\services\\AssetIndexer::processIndexSession()`.\n- Added `craft\\services\\AssetIndexer::removeCliIndexingSessions()`.\n- Added `craft\\services\\AssetIndexer::startIndexingSession()`.\n- Added `craft\\services\\AssetIndexer::stopIndexingSession()`.\n- Added `craft\\services\\Assets::getImagePreviewUrl()`.\n- Added `craft\\services\\AssetTransforms::deleteTransformIndexDataByAssetIds()`.\n- Added `craft\\services\\Conditions`.\n- Added `craft\\services\\Config::CATEGORY_CUSTOM`.\n- Added `craft\\services\\Config::getCustom()`.\n- Added `craft\\services\\Drafts::removeDraftData()`.\n- Added `craft\\services\\ElementSources`, which replaces `craft\\services\\ElementIndexes`.\n- Added `craft\\services\\Fields::createLayout()`.\n- Added `craft\\services\\Fs`.\n- Added `craft\\services\\Gc::hardDeleteElements()`.\n- Added `craft\\services\\Gc::removeEmptyTempFolders()`.\n- Added `craft\\services\\Gql::prepareFieldDefinitions()`.\n- Added `craft\\services\\ImageTransforms`.\n- Added `craft\\services\\Matrix::createRevisionBlocks()`.\n- Added `craft\\services\\Matrix::duplicateOwnership()`.\n- Added `craft\\services\\ProjectConfig::ASSOC_KEY`.\n- Added `craft\\services\\ProjectConfig::PATH_DATE_MODIFIED`.\n- Added `craft\\services\\ProjectConfig::PATH_ELEMENT_SOURCES`.\n- Added `craft\\services\\ProjectConfig::PATH_FS`.\n- Added `craft\\services\\ProjectConfig::PATH_META_NAMES`.\n- Added `craft\\services\\ProjectConfig::PATH_SCHEMA_VERSION`.\n- Added `craft\\services\\ProjectConfig::PATH_SYSTEM`.\n- Added `craft\\services\\ProjectConfig::rememberAppliedChanges()`.\n- Added `craft\\services\\Users::deactivateUser()`.\n- Added `craft\\services\\Users::ensureUserByEmail()`, which will return a user for the given email, creating one if it didn\u2019t exist yet.\n- Added `craft\\services\\Users::EVENT_AFTER_DEACTIVATE_USER`.\n- Added `craft\\services\\Users::EVENT_BEFORE_DEACTIVATE_USER`.\n- Added `craft\\services\\Users::removeCredentials()`.\n- Added `craft\\services\\Volumes::getTemporaryVolume()`.\n- Added `craft\\services\\Volumes::getUserPhotoVolume()`.\n- Added `craft\\validators\\MoneyValidator`.\n- Added `craft\\web\\assets\\conditionbuilder\\ConditionBuilderAsset`.\n- Added `craft\\web\\assets\\htmx\\HtmxAsset`.\n- Added `craft\\web\\assets\\money\\MoneyAsset`.\n- Added `craft\\web\\Controller::asCpScreen()`.\n- Added `craft\\web\\Controller::asFailure()`.\n- Added `craft\\web\\Controller::asModelFailure()`.\n- Added `craft\\web\\Controller::asModelSuccess()`.\n- Added `craft\\web\\Controller::asSuccess()`.\n- Added `craft\\web\\Controller::CpScreenResponseBehavior()`.\n- Added `craft\\web\\Controller::CpScreenResponseFormatter()`.\n- Added `craft\\web\\Controller::getPostedRedirectUrl()`.\n- Added `craft\\web\\Controller::TemplateResponseBehavior()`.\n- Added `craft\\web\\Controller::TemplateResponseFormatter()`.\n- Added `craft\\web\\twig\\Extension::addressFilter()`.\n- Added `craft\\web\\twig\\Extension::moneyFilter()`.\n- Added `craft\\web\\twig\\variables\\Cp::fieldLayoutDesigner()`.\n- Added `craft\\web\\twig\\variables\\Cp::getFsOptions()`.\n- Added `craft\\web\\twig\\variables\\Cp::getVolumeOptions()`.\n- Added `craft\\web\\View::clearCssFileBuffer()`.\n- Added `craft\\web\\View::clearJsFileBuffer()`.\n- Added `craft\\web\\View::startCssFileBuffer()`.\n- Added `craft\\web\\View::startJsFileBuffer()`.\n- Added the `Craft.appendBodyHtml()` JavaScript method, which replaces the now-deprecated `appendFootHtml()` method.\n- Added the `Craft.CpScreenSlideout` JavaScript class, which can be used to create slideouts from actions that return `$this->asCpScreen()`.\n- Added the `Craft.ElementEditor` JavaScript class.\n- Added the `Craft.ElementEditorSlideout` JavaScript class.\n- Added the `Craft.getPageUrl()` JavaScript method.\n- Added the `Craft.getQueryParam()` JavaScript method.\n- Added the `Craft.getQueryParams()` JavaScript method.\n- Added the `Craft.namespaceId()` JavaScript method.\n- Added the `Craft.namespaceInputName()` JavaScript method.\n- Added the `Craft.Preview.refresh()` JavaScript method.\n- Added the `Craft.Queue` JavaScript class.\n- Added the `Craft.setElementAttributes()` JavaScript method.\n- Added the `Craft.setPath()` JavaScript method.\n- Added the `Craft.setQueryParam()` JavaScript method.\n- Added the `Craft.setUrl()` JavaScript method.\n- Added the `Craft.ui.createButton()` JavaScript method.\n- Added the `Craft.ui.createSubmitButton()` JavaScript method.\n- Added the `htmx.org` JavaScript library.\n- Added the commerceguys/addressing package.\n- Added the illuminate/collections package. ([#8475](https://github.com/craftcms/cms/discussions/8475))\n- Added the moneyphp/money package.\n- Added the symfony/var-dumper package.\n- Added the theiconic/name-parser package.\n- Added the yiisoft/yii2-symfonymailer package.\n\n### Changed\n- Craft now requires PHP 8.0.2 or later.\n- Craft now requires MySQL 5.7.8 / MariaDB 10.2.7 / PostgreSQL 10.0 or later.\n- Craft now requires the [Intl](https://php.net/manual/en/book.intl.php) and [BCMath](https://www.php.net/manual/en/book.bc.php) PHP extensions.\n- Improved draft creation/application performance. ([#10577](https://github.com/craftcms/cms/pull/10577))\n- Improved revision creation performance. ([#10589](https://github.com/craftcms/cms/pull/10577))\n- The \u201cWhat\u2019s New\u201d HUD now displays an icon and label above each announcement, identifying where it came from (Craft CMS or a plugin). ([#9747](https://github.com/craftcms/cms/discussions/9747))\n- The control panel now keeps track of the currently-edited site on a per-tab basis by adding a `site` query string param to all control panel URLs. ([#8920](https://github.com/craftcms/cms/discussions/8920))\n- Element index pages\u2019 status and sort menu option selections are now coded into the page URL via `status` and `sort` query string params. ([#10669](https://github.com/craftcms/cms/discussions/10669))\n- Users are no longer required to have a username or email.\n- Users can now set their Formatting Locale to any known locale; not just the available Language options. ([#10519](https://github.com/craftcms/cms/pull/10519))\n- Users\u2019 Language and Formatting Locale settings now display locale names in the current language and their native languages. ([#10519](https://github.com/craftcms/cms/pull/10519))\n- User queries now return all users by default, rather than only active users.\n- Filtering users by `active`, `pending`, and `locked` statuses no longer excludes suspended users.\n- `credentialed` and `inactive` are now reserved user group handles.\n- Elements throughout the control panel are now automatically updated whenever they\u2019re saved by another browser tab.\n- Assets fields that are restricted to a single location can now be configured to allow selection within subfolders of that location. ([#9070](https://github.com/craftcms/cms/discussions/9070))\n- When an image is saved as a new asset from the Image Editor via an Assets field, the Assets field will now automatically replace the selected asset with the new one. ([#8974](https://github.com/craftcms/cms/discussions/8974))\n- `alt` is now a reserved field handle for volume field layouts.\n- Volumes no longer have \u201ctypes\u201d, and their file operations are now delegated to a filesystem selected by an \u201cAsset Filesystem\u201d setting on the volume.\n- Volumes now have \u201cTransform Filesystem\u201d and \u201cTransform Subpath\u201d settings, which can be used to choose where image transforms should be stored. (The volume\u2019s Asset Filesystem will be used by default.)\n- Asset thumbnails are now generated as image transforms.\n- It\u2019s now possible to create volumes directly from the User Settings page.\n- Images that are not web-safe now are always converted to JPEGs when transforming, if no format was specified.\n- Entry post dates are no longer set automatically until the entry is validated with the `live` scenario. ([#10093](https://github.com/craftcms/cms/pull/10093))\n- Entry queries\u2019 `authorGroup()` param method now accepts an array of `craft\\models\\UserGroup` objects.\n- Element queries\u2019 `revision` params can now be set to `null` to include normal and revision elements.\n- Element queries can no longer be traversed or accessed like an array. Use a query execution method such as `all()`, `collect()`, or `one()` to fetch the results before working with them.\n- Element queries\u2019 `title` params no longer treat values with commas as arrays. ([#10891](https://github.com/craftcms/cms/issues/10891))\n- User queries\u2019 `firstName` and `lastName` params no longer treat values with commas as arrays. ([#10891](https://github.com/craftcms/cms/issues/10891))\n- Relational fields now load elements in the current site rather than the primary site, if the source element isn\u2019t localizable. ([#7048](https://github.com/craftcms/cms/issues/7048))\n- Lightswitch fields can no longer be marked as required within field layouts. ([#10773](https://github.com/craftcms/cms/issues/10773))\n- Built-in queue jobs are now always translated for the current user\u2019s language. ([#9745](https://github.com/craftcms/cms/pull/9745))\n- Path options passed to console commands (e.g. `--basePath`) now take precedence over their environment variable/PHP constant counterparts.\n- Database backups are now named after the Craft version in the database, rather than the Composer-installed version. ([#9733](https://github.com/craftcms/cms/discussions/9733))\n- Template autosuggestions now include their filename. ([#9744](https://github.com/craftcms/cms/pull/9744))\n- Improved the look of loading spinners in the control panel. ([#9109](https://github.com/craftcms/cms/discussions/9109))\n- The default `subLeft` and `subRight` search query term options are now only applied to terms that don\u2019t include an asterisk at the beginning/end, e.g. `hello*`. ([#10613](https://github.com/craftcms/cms/discussions/10613))\n- `{% cache %}` tags now store any external JavaScript or CSS files registered with `{% js %}` and `{% css %}` tags. ([#9987](https://github.com/craftcms/cms/discussions/9987))\n- All control panel templates end in `.twig` now. ([#9743](https://github.com/craftcms/cms/pull/9743))\n- 404 requests are no longer logged by default. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- Log entries are now single-line by default when Dev Mode is disabled. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- Log files are now rotated once every 24 hours. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- `CRAFT_STREAM_LOG` no longer logs _in addition to_ other log targets. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- The default log target no longer logs `debug` or `info` messages when Dev Mode is enabled. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- SQL query logs now use the `debug` log level, so they no longer get logged when Dev Mode is enabled. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- `yii\\db\\Connection::$enableLogging` and `$enableProfiling` are no longer enabled by default when Dev Mode is disabled. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- The `queue` log target no longer has special handling for Yii or `info` logs. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- A warning is now logged if an element query is executed before Craft is fully initialized. ([#11033](https://github.com/craftcms/cms/issues/11033))\n- A warning is now logged if Twig is instantiated before Craft is fully initialized. ([#11033](https://github.com/craftcms/cms/issues/11033))\n- Craft\u2019s bootstrap script now attempts to create its configured system paths automatically. ([#10562](https://github.com/craftcms/cms/pull/10562))\n- When using GraphQL to mutate entries, the `enabled` status is now affected on a per-site basis when specifying both the `enabled` and `siteId` parameters. ([#9771](https://github.com/craftcms/cms/issues/9771))\n- The `forms/selectize` control panel template now supports `addOptionFn` and `addOptionLabel` params, which can be set to add new options to the list.\n- Editable tables now support `allowAdd`, `allowDelete`, and `allowReorder` settings, replacing `staticRows`. ([#10163](https://github.com/craftcms/cms/pull/10163))\n- Column definitions passed to the `_includes/forms/editableTable` control panel template can now specify a `width` key. ([#11062](https://github.com/craftcms/cms/pull/11062))\n- The `limitField` macro in the `_components/fieldtypes/elementfieldsettings` control panel template has been renamed to `limitFields`.\n- Renamed the `elements/get-categories-input-html` action to `categories/input-html`.\n- Renamed the `elements/get-modal-body` action to `element-selector-modals/body`.\n- The `entries/save-entry` action now returns a 400 HTTP status for JSON responses when the entry couldn\u2019t be saved.\n- The `users/save-user` action no longer includes a `unverifiedEmail` key in failure responses.\n- The `users/set-password` action now returns a 400 HTTP status when an invalid token is passed, if there\u2019s no URL to redirect to. ([#10592](https://github.com/craftcms/cms/discussions/10592))\n- `install/*`, `setup/*`, `db/*`, and `help` actions no longer output a warning if Craft can\u2019t connect to the database. ([#10851](https://github.com/craftcms/cms/pull/10851))\n- `createFoldersInVolume:<uid>` user permissions have been renamed to `createFolders:<uid>`.\n- `deleteFilesAndFoldersInVolume:<uid>` user permissions have been renamed to `deleteAssets:<uid>`.\n- `deletePeerFilesInVolume:<uid>` user permissions have been renamed to `deletePeerAssets:<uid>`.\n- `editCategories:<uid>` user permissions have been split into `viewCategories:<uid>`, `saveCategories:<uid>`, `deleteCategories:<uid>`, `viewPeerCategoryDrafts:<uid>`, `savePeerCategoryDrafts:<uid>`, and `deletePeerCategoryDrafts:<uid>`.\n- `editEntries:<uid>` user permissions have been renamed to `viewEntries:<uid>`.\n- `editImagesInVolume:<uid>` user permissions have been renamed to `editImages:<uid>`.\n- `editPeerEntries:<uid>` user permissions have been renamed to `viewPeerEntries:<uid>`.\n- `editPeerEntryDrafts:<uid>` user permissions have been split into `viewPeerEntryDrafts:<uid>` and `savePeerEntryDrafts:<uid>`.\n- `editPeerFilesInVolume:<uid>` user permissions have been renamed to `savePeerAssets:<uid>`.\n- `editPeerImagesInVolume:<uid>` user permissions have been renamed to `editPeerImages:<uid>`.\n- `publishEntries:<uid>` user permissions have been renamed to `saveEntries:<uid>`, and no longer differentiate between enabled and disabled entries. (Users with `viewEntries:<uid>` permissions will still be able to create drafts.)\n- `publishPeerEntries:<uid>` user permissions have been renamed to `savePeerEntries:<uid>`, and no longer differentiate between enabled and disabled entries. (Users with `viewPeerEntries:<uid>` permissions will still be able to create drafts.)\n- `replaceFilesInVolume:<uid>` user permissions have been renamed to `replaceFiles:<uid>`.\n- `replacePeerFilesInVolume:<uid>` user permissions have been renamed to `replacePeerFiles:<uid>`.\n- `saveAssetInVolume:<uid>` user permissions have been renamed to `saveAssets:<uid>`.\n- `viewPeerFilesInVolume:<uid>` user permissions have been renamed to `viewPeerAssets:<uid>`.\n- `viewVolume:<uid>` user permissions have been renamed to `viewAssets:<uid>`.\n- Elements\u2019 `searchScore` GraphQL fields are now returned as integers.\n- Element types must now override `craft\\base\\Element::isDeletable()` if its elements should be deletable from the index page.\n- Element types\u2019 `cpEditUrl()` methods no longer need to add a `site` param; one will be added automatically by `craft\\base\\Element::getCpEditUrl()`.\n- Element types\u2019 `defineActions()` methods\u2019 `$source` arguments should no longer accept `null`.\n- Element types\u2019 `defineSources()` methods\u2019 `$context` arguments should no longer accept `null`.\n- Element types\u2019 `getHtmlAttributes()` and `htmlAttributes()` methods must now return attribute arrays that are compatible with `craft\\helpers\\Html::renderTagAttributes()`.\n- Element types\u2019 `sources()` methods\u2019 `$context` arguments should no longer accept `null`.\n- Element types\u2019 `tableAttributes()` and `defineTableAttributes()` methods should no longer return a generic attribute for defining the header column heading at the beginning of the returned array. The header column heading is now set to the element type\u2019s display name, per its `displayName()` method.\n- Block element types\u2019 `getOwner()` methods can now return `null`.\n- Control panel resource locations are now cached, so resource requests can be resolved when Craft isn\u2019t installed yet, or a database connection can\u2019t be established. ([#10642](https://github.com/craftcms/cms/pull/10642))\n- Control panel resources are now served with cache headers, if the `buildId` config setting is set. ([#10705](https://github.com/craftcms/cms/pull/10705))\n- Empty subfolders within the temporary upload volume are now removed during garbage collection. ([#10746](https://github.com/craftcms/cms/issues/10746))\n- Most config settings can now be overridden via environment variables. ([#10573](https://github.com/craftcms/cms/pull/10573), [#10869](https://github.com/craftcms/cms/pull/10869))\n- It\u2019s now possible to configure the Debug Toolbar to store its data files on a filesystem, rather than within `storage/runtime/debug/`. ([#10825](https://github.com/craftcms/cms/pull/10825))\n- `craft\\base\\AssetPreviewHandlerInterface::getPreviewHtml()` now accepts an optional array of variable to pass on to the template.\n- `craft\\base\\Element::__get()` now clones custom field values before returning them. ([#8781](https://github.com/craftcms/cms/discussions/8781))\n- `craft\\base\\Element::fieldLayoutFields()` now has a `visibleOnly` argument.\n- `craft\\base\\Element::getFieldValue()` now returns eager-loaded element values for the field, when they exist. ([#10047](https://github.com/craftcms/cms/issues/10047))\n- `craft\\base\\Element::metaFieldsHtml()` now has a `static` argument.\n- `craft\\base\\Element::setFieldValue()` now unsets any previously-eager-loaded elements for the field. ([#11003](https://github.com/craftcms/cms/discussions/11003))\n- `craft\\base\\Element::slugFieldHtml()` now has a `static` argument.\n- `craft\\base\\ElementInterface::getEagerLoadedElements()` now returns an `Illuminate\\Support\\Collection` object instead of an array. ([#8513](https://github.com/craftcms/cms/discussions/8513))\n- `craft\\base\\ElementInterface::getSidebarHtml()` now has a `static` argument.\n- `craft\\base\\MemoizableArray` no longer extends `ArrayObject`, and now implements `IteratorAggregate` and `Countable` directly.\n- `craft\\base\\Model::__construct()` and `setAttributes()` now automatically typecast values that map to properties with `int`, `float`, `int|float`, `string`, `bool`, `array`, or `DateTime` type declarations. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- `craft\\base\\Model::datetimeAttributes()` is now called from the constructor, instead of the `init()` method.\n- `craft\\base\\Model::setAttributes()` now normalizes date attributes into `DateTime` objects.\n- `craft\\behaviors\\FieldLayoutBehavior::getFields()` has been renamed to `getCustomFields()`.\n- `craft\\elements\\Asset::getImg()` now sets the `alt` attribute to the native Alternative Text field value, if set.\n- `craft\\elements\\Asset::getVolume()` now returns an instance of `craft\\models\\Volume`.\n- `craft\\elements\\db\\ElementQuery::ids()` no longer accepts an array of criteria params.\n- `craft\\events\\DraftEvent::$source` has been renamed to `$canonical`.\n- `craft\\events\\GetAssetThumbUrlEvent` has been renamed to `DefineAssetThumbUrlEvent`.\n- `craft\\events\\GetAssetUrlEvent` has been renamed to `DefineAssetUrlEvent`.\n- `craft\\events\\RevisionEvent::$source` has been renamed to `$canonical`.\n- `craft\\fieldlayoutelements\\AssetTitleField` has been renamed to `craft\\fieldlayoutelements\\assets\\AssetTitleField`.\n- `craft\\fieldlayoutelements\\EntryTitleField` has been renamed to `craft\\fieldlayoutelements\\entries\\EntryTitleField`.\n- `craft\\fieldlayoutelements\\StandardField` has been renamed to `craft\\fieldlayoutelements\\BaseNativeField`.\n- `craft\\fieldlayoutelements\\StandardTextField` has been renamed to `craft\\fieldlayoutelements\\TextField`.\n- `craft\\fields\\Assets::$singleUploadLocationSource` has been renamed to `$restrictedLocationSource`.\n- `craft\\fields\\Assets::$singleUploadLocationSubpath` has been renamed to `$restrictedLocationSubpath`.\n- `craft\\fields\\Assets::$useSingleFolder` has been renamed to `$restrictLocation`.\n- `craft\\fields\\BaseRelationField::$limit` has been renamed to `$maxRelations`.\n- `craft\\fields\\BaseRelationField::elementType()` is now public.\n- `craft\\fields\\BaseRelationField::inputSelectionCriteria()` has been renamed to `getInputSelectionCriteria()`, and is now public.\n- `craft\\fields\\BaseRelationField::inputSources()` has been renamed to `getInputSources()`, and is now public.\n- `craft\\gql\\directives\\FormatDateTime::defaultTimezone()` has been renamed to `defaultTimeZone()`.\n- `craft\\gql\\TypeManager::EVENT_DEFINE_GQL_TYPE_FIELDS` is now triggered when actually resolving fields for a GraphQL type, rather than when the type is first created. ([#9626](https://github.com/craftcms/cms/issues/9626))\n- `craft\\helpers\\App::env()` now checks for a PHP constant as well, if the environment variable didn\u2019t exist.\n- `craft\\helpers\\App::env()` now returns `null` if a value couldn\u2019t be found, rather than `false`.\n- `craft\\helpers\\App::env()` now returns a boolean if the original value was `'true'` or `'false'`.\n- `craft\\helpers\\App::env()` now returns an integer or float if the original value was numeric.\n- `craft\\helpers\\ArrayHelper::getValue()` now supports keys in square bracket syntax, e.g. `foo[bar][baz]`.\n- `craft\\helpers\\Assets::generateUrl()` no longer accepts a transform index for date modified comparisons. A `DateTime` object is expected instead.\n- `craft\\helpers\\Assets::urlAppendix()` no longer accepts a transform index for date modified comparisons. A `DateTime` object is expected instead.\n- `craft\\helpers\\Component::createComponent()` now automatically typecasts values that map to properties with `int`, `float`, `int|float`, `string`, `bool`, `array`, or `DateTime` type declarations. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- `craft\\helpers\\Cp::elementHtml()` now has an `$autoReload` argument.\n- `craft\\helpers\\Db::batchInsert()`, `craft\\helpers\\Db::insert()`, `craft\\db\\Command::batchInsert()`, `craft\\db\\Command::insert()`, `craft\\db\\Migration::batchInsert()`, and `craft\\db\\Migration::insert()` no longer have `$includeAuditColumns` arguments, and now check if the table has `dateCreated`, `dateUpdated`, and/or `uid` columns before setting their values.\n- `craft\\helpers\\Db::parseParam()` now validates that numeric values are passed if the `$columnType` is set to a numeric column type. ([#9142](https://github.com/craftcms/cms/issues/9142))\n- `craft\\helpers\\Db::prepareDateForDb()` no longer has a `$stripSeconds` argument.\n- `craft\\helpers\\Db::prepareValueForDb()` now has a `$columnType` argument.\n- `craft\\helpers\\Db::truncateTable()` now returns `void` rather than `int`.\n- `craft\\helpers\\Db::update()`, `craft\\helpers\\Db::upsert()`, `craft\\db\\Command::update()`, `craft\\db\\Command::upsert()`, `craft\\db\\Migration::update()`\u2019 and `craft\\db\\Migration::upsert()`\u2019 `$includeAuditColumns` arguments have been renamed to `$updateTimestamp`, and only affect the `dateCreated` column now. All upserts now check if the table has `dateCreated`, `dateUpdated`, and/or `uid` columns before setting their values.\n- `craft\\helpers\\Db::upsert()`, `craft\\db\\Command::upsert()`, and `craft\\db\\Migration()` no longer merge the `$updateColumns` array into `$insertColumns`. The full array of `INSERT` column values should be passed to `$insertColumns` now.\n- `craft\\helpers\\Gql::getUnionType()` no longer requires a resolver function to be passed, if the union contains only element GraphQL types.\n- `craft\\helpers\\Html::beginForm()` not sets `accept-charset=\"UTF-8\"` by default.\n- `craft\\helpers\\Html` now supports defining `hx-*` and `data-hx-*` attributes via a `hx` and `data-hx` keys, similar to `aria` and `data`.\n- `craft\\helpers\\i18n\\Formatter::asPercent()` now chooses a default `$decimals` value based on the value given, if `null`.\n- `craft\\helpers\\i18n\\Formatter::asPercent()` now treats all empty values as `0`.\n- `craft\\helpers\\MailerHelper::normalizeEmails()` now returns an empty array instead of `null`.\n- `craft\\helpers\\MigrationHelper::dropAllIndexesOnTable()` no longer returns an array of the dropped indexes.\n- `craft\\helpers\\Queue::push()` now has a `$queue` argument.\n- `craft\\models\\FieldLayout::EVENT_DEFINE_STANDARD_FIELDS` has been renamed to `EVENT_DEFINE_NATIVE_FIELDS`.\n- `craft\\models\\FieldLayout::getAvailableStandardFields()` has been renamed to `getAvailableNativeFields()`.\n- `craft\\models\\FieldLayout::getFields()` has been renamed to `getCustomFields()`.\n- `craft\\queue\\Queue::$channel` is now set automatically based on the queue\u2019s application component ID.\n- `craft\\services\\Announcements::push()` no longer accepts callables to be passed to the `$heading` and `$body` arguments. `craft\\i18n\\Translation::prep()` should be used to prepare the messages to be lazy-translated instead.\n- `craft\\services\\AssetIndexer::storeIndexList()` now expects the first argument to be a generator that returns `craft\\models\\FsListing` objects.\n- `craft\\services\\Assets::ensureFolderByFullPathAndVolume()` now returns a `craft\\models\\VolumeFolder` object rather than a folder ID.\n- `craft\\services\\Assets::ensureTopFolder()` now returns a `craft\\models\\VolumeFolder` object rather than a folder ID.\n- `craft\\services\\Assets::EVENT_GET_ASSET_THUMB_URL` has been renamed to `EVENT_DEFINE_THUMB_URL`.\n- `craft\\services\\Assets::EVENT_GET_ASSET_URL` has been moved to `craft\\elements\\Asset::EVENT_DEFINE_URL`.\n- `craft\\services\\AssetTransforms::CONFIG_TRANSFORM_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_IMAGE_TRANSFORMS`.\n- `craft\\services\\Categories::CONFIG_CATEGORYROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_CATEGORY_GROUPS`.\n- `craft\\services\\Fields::CONFIG_FIELDGROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_FIELD_GROUPS`.\n- `craft\\services\\Fields::CONFIG_FIELDS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_FIELDS`.\n- `craft\\services\\Globals::CONFIG_GLOBALSETS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GLOBAL_SETS`.\n- `craft\\services\\Gql::CONFIG_GQL_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GRAPHQL`.\n- `craft\\services\\Gql::CONFIG_GQL_PUBLIC_TOKEN_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GRAPHQL_PUBLIC_TOKEN`.\n- `craft\\services\\Gql::CONFIG_GQL_SCHEMAS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GRAPHQL_SCHEMAS`.\n- `craft\\services\\Matrix::CONFIG_BLOCKTYPE_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_MATRIX_BLOCK_TYPES`.\n- `craft\\services\\Matrix::duplicateBlocks()` now has a `$deleteOtherBlocks` argument.\n- `craft\\services\\Plugins::CONFIG_PLUGINS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_PLUGINS`.\n- `craft\\services\\Plugins::doesPluginRequireDatabaseUpdate()` has been renamed to `isPluginUpdatePending()`.\n- `craft\\services\\ProjectConfig::applyYamlChanges()` has been renamed to `applyExternalChanges()`.\n- `craft\\services\\ProjectConfig::getDoesYamlExist()` has been renamed to `getDoesExternalConfigExist()`.\n- `craft\\services\\ProjectConfig::getIsApplyingYamlChanges()` has been renamed to `getIsApplyingExternalChanges()`.\n- `craft\\services\\ProjectConfig::set()` now returns `true` or `false` depending on whether the project config was modified.\n- `craft\\services\\Revisions::createRevision()` now returns the ID of the revision, rather than the revision itself.\n- `craft\\services\\Routes::CONFIG_ROUTES_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_ROUTES`.\n- `craft\\services\\Sections::CONFIG_ENTRYTYPES_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_ENTRY_TYPES`.\n- `craft\\services\\Sections::CONFIG_SECTIONS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_PATH_SECTIONS`.\n- `craft\\services\\Sites::CONFIG_SITEGROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_SITE_GROUPS`.\n- `craft\\services\\Sites::CONFIG_SITES_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_SITES`.\n- `craft\\services\\Tags::CONFIG_TAGGROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_TAG_GROUPS`.\n- `craft\\services\\Updates::getIsCraftDbMigrationNeeded()` has been renamed to `getIsCraftUpdatePending()`.\n- `craft\\services\\Updates::getIsPluginDbUpdateNeeded()` has been renamed to `getIsPluginUpdatePending()`.\n- `craft\\services\\UserGroups::CONFIG_USERPGROUPS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_USER_GROUPS`.\n- `craft\\services\\UserPermissions::getAllPermissions()` and `getAssignablePermissions()` now return permission groups as arrays with `heading` and `permission` sub-keys, fixing a bug where two groups with the same heading would conflict with each other. ([#7771](https://github.com/craftcms/cms/issues/7771))\n- `craft\\services\\Users::CONFIG_USERLAYOUT_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_USER_FIELD_LAYOUTS`.\n- `craft\\services\\Users::CONFIG_USERS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_USERS`.\n- `craft\\services\\Volumes::CONFIG_VOLUME_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_VOLUMES`.\n- `craft\\test\\fixtures\\elements\\BaseElementFixture` now validates elements with the `live` scenario if they are enabled, canonical, and not a provisional draft.\n- `craft\\test\\TestSetup::getMockApp()` has been renamed to `getMockModule()`, and its `$appClass` argument has been renamed to `$moduleClass`.\n- `craft\\web\\Request::getBodyParam()` now accepts nested param names in the `foo[bar][baz]` format.\n- `craft\\web\\Request::getBodyParams()` and `getBodyParam()` now check for an `X-Craft-Namespace` header. If present, only params that begin with its value will be returned, excluding the namespace.\n- `craft\\web\\View::renderString()` now has an `$escapeHtml` argument.\n- `craft\\web\\View::setNamespace()`\u2019 `$namespace` argument no longer has a default value of `null`.\n- The `Craft.getUrl()` JavaScript method now removes duplicate query string params when passing in a param that\u2019s already included in the base URL.\n- The `Craft.getUrl()` JavaScript method now encodes any query string params passed to it.\n- `Craft.broadcastChannel` has been split up into two broadcast channels: `Craft.broadcaster` and `Craft.messageReceiver`.\n- `Craft.cp.$tabs` now returns a collection of the tabs\u2019 `<a>` elements, as they no longer have wrapping `<li>` elements.\n- Local volumes no longer use Flysystem.\n- A selected volume for user photo storage if no longer displayed if no volume has been set.\n- The user photo volume can now only be set to a volume that has a public transform filesystem configured.\n- Craft now uses Symfony Mailer to send email. ([#10062](https://github.com/craftcms/cms/discussions/10062))\n- Updated Twig to 3.3.\n- Updated vue-autosuggest to 2.2.0.\n\n### Deprecated\n- Deprecated the `autosaveDrafts` config setting.\n- Deprecated the `anyStatus` element query param. `status(null)` should be used instead.\n- Deprecated the `immediately` argument for transforms created over GraphQL. It no longer has any effect.\n- Deprecated `craft\\base\\ApplicationTrait::getInstalledSchemaVersion()`.\n- Deprecated `craft\\base\\Model::datetimeAttributes()`. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- Deprecated `craft\\elements\\User::getFullName()`. `$fullName` should be used instead.\n- Deprecated `craft\\gql\\TypeManager::flush()`. `craft\\services\\Gql::flushCaches()` should be used instead.\n- Deprecated `craft\\gql\\TypeManager::prepareFieldDefinitions()`. `craft\\services\\Gql::prepareFieldDefinitions()` should be used instead.\n- Deprecated `craft\\helpers\\ArrayHelper::append()`. `array_unshift()` should be used instead.\n- Deprecated `craft\\helpers\\ArrayHelper::prepend()`. `array_push()` should be used instead.\n- Deprecated `craft\\helpers\\MigrationHelper`.\n- Deprecated `craft\\i18n\\I18N::getIsIntlLoaded()`.\n- Deprecated `craft\\services\\Assets::getAssetUrl()`. `craft\\elements\\Asset::getUrl()` should be used instead.\n- Deprecated `craft\\services\\Assets::getIconPath()`. `craft\\helpers\\Assets::iconPath()` should be used instead.\n- Deprecated `craft\\web\\Controller::asErrorJson()`. `asFailure()` should be used instead.\n- Deprecated the `assets/save-asset` action. `elements/save` should be used instead.\n- Deprecated the `categories/save-category` action. `elements/save` should be used instead.\n- Deprecated the `Craft.appendFootHtml()` JavaScript method. `appendBodyHtml()` should be used instead.\n\n### Removed\n- Removed the \u201cHeader Column Heading\u201d element source setting.\n- Removed support for setting custom config settings from `config/general.php`. `config/custom.php` should be used instead. ([#10012](https://github.com/craftcms/cms/issues/10012))\n- Removed the `customAsciiCharMappings` config setting.\n- Removed the `siteName` config setting. Environment-specific site names can be defined via environment variables.\n- Removed the `siteUrl` config setting. Environment-specific site URLs can be defined via environment variables.\n- Removed the `suppressTemplateErrors` config setting.\n- Removed the `useCompressedJs` config setting.\n- Removed the `useProjectConfigFile` config setting. Override `craft\\services\\ProjectConfig::$writeYamlAutomatically` to opt into [manual YAML file generation](https://craftcms.com/docs/4.x/project-config.html#manual-yaml-file-generation).\n- Removed support for `config/volumes.php`. Volumes can now specify per-environment filesystems.\n- Removed support for the `CRAFT_SITE_URL` PHP constant. Environment-specific site URLs can be defined via environment variables.\n- Removed the `enabledForSite` GraphQL argument. `status` should be used instead.\n- Removed the `{% includeHiResCss %}` Twig tag.\n- Removed support for deprecated `DateTime` faux Twig methods `atom()`, `cookie()`, `iso8601()`, `rfc822()`, `rfc850()`, `rfc1036()`, `rfc1123()`, `rfc2822()`, `rfc3339()`, `rss()`, `w3c()`, `w3cDate()`, `mySqlDateTime()`, `localeDate()`, `localeTime()`, `year()`, `month()`, `day()`, `nice()`, and `uiTimestamp()`.\n- Removed the `locale` element property. `siteId` should be used instead.\n- Removed the `ownerLocale` Matrix block query param. `site` or `siteId` should be used instead.\n- Removed support for `sourceLocale` in `relatedTo` element query params. `sourceSite` should be used instead.\n- Removed the `craft.categoryGroups` Twig variable.\n- Removed the `craft.config` Twig variable.\n- Removed the `craft.deprecator` Twig variable.\n- Removed the `craft.elementIndexes` Twig variable.\n- Removed the `craft.emailMessages` Twig variable.\n- Removed the `craft.feeds` Twig variable.\n- Removed the `craft.fields` Twig variable.\n- Removed the `craft.globals` Twig variable.\n- Removed the `craft.i18n` Twig variable.\n- Removed the `craft.request` Twig variable.\n- Removed the `craft.sections` Twig variable.\n- Removed the `craft.session` Twig variable.\n- Removed the `craft.systemSettings` Twig variable.\n- Removed the `craft.userGroups` Twig variable.\n- Removed the `craft.userPermissions` Twig variable.\n- Removed the `assignUserGroups` user permission, which authorized users to assign other users to their own groups. Authorization must now be explicitly granted for each group. ([#10422](https://github.com/craftcms/cms/issues/10422))\n- Removed the `customizeSources` user permission. Only admins can customize element sources now, and only from an environment that allows admin changes.\n- Removed the `publishPeerEntryDrafts:<uid>` permissions, as they were pointless. (If a user is authorized to save an entry and view other users\u2019 drafts of it, there\u2019s nothing stopping them from making the same changes themselves.)\n- Removed the `assets/edit-asset` action.\n- Removed the `assets/thumb` action.\n- Removed the `categories/edit-category` action.\n- Removed the `categories/preview-category` action.\n- Removed the `categories/share-category` action.\n- Removed the `categories/view-shared-category` action.\n- Removed the `dashboard/get-feed-items` action.\n- Removed the `elements/get-editor-html` action.\n- Removed the `entries/switch-entry-type` action.\n- Removed `craft\\base\\ApplicationTrait::getEntryRevisions()`.\n- Removed `craft\\base\\ApplicationTrait::getFeed()`.\n- Removed `craft\\base\\Element::ATTR_STATUS_CONFLICTED`.\n- Removed `craft\\base\\Element::getHasFreshContent()`. `getIsFresh()` should be used instead.\n- Removed `craft\\base\\ElementInterface::getEditorHtml()`. Element edit forms are now exclusively driven by their field layout.\n- Removed `craft\\base\\FieldLayoutElementInterface`.\n- Removed `craft\\base\\FlysystemVolume`.\n- Removed `craft\\base\\LocalVolumeInterface`.\n- Removed `craft\\base\\Volume`.\n- Removed `craft\\base\\VolumeInterface`.\n- Removed `craft\\base\\VolumeTrait`.\n- Removed `craft\\behaviors\\FieldLayoutBehavior::setFields()`.\n- Removed `craft\\config\\DbConfig::updateDsn()`.\n- Removed `craft\\console\\Request::getIsSingleActionRequest()`.\n- Removed `craft\\controllers\\AssetTransformsController`.\n- Removed `craft\\controllers\\BaseUpdaterController::ACTION_COMPOSER_OPTIMIZE`.\n- Removed `craft\\controllers\\BaseUpdaterController::actionComposerOptimize()`.\n- Removed `craft\\controllers\\Drafts`.\n- Removed `craft\\controllers\\ElementIndexesController::$paginated`.\n- Removed `craft\\controllers\\EntriesController::EVENT_PREVIEW_ENTRY`.\n- Removed `craft\\controllers\\UtilitiesController::actionAssetIndexPerformAction()`.\n- Removed `craft\\db\\Connection::trimObjectName()`.\n- Removed `craft\\db\\Table::ASSETTRANSFORMINDEX`.\n- Removed `craft\\db\\Table::ASSETTRANSFORMS`.\n- Removed `craft\\elements\\actions\\SetStatus::$allowDisabledForSite`.\n- Removed `craft\\elements\\actions\\SetStatus::DISABLED_FOR_SITE`.\n- Removed `craft\\elements\\actions\\SetStatus::DISABLED_GLOBALLY`.\n- Removed `craft\\elements\\Asset::getSupportsPreview()`.\n- Removed `craft\\elements\\Asset::getTransformSource()`.\n- Removed `craft\\elements\\Asset::setTransformSource()`.\n- Removed `craft\\elements\\db\\ElementQuery::getIterator()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetExists()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetGet()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetSet()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetUnset()`.\n- Removed `craft\\elements\\User::mergePreferences()`.\n- Removed `craft\\errors\\AssetTransformException`.\n- Removed `craft\\errors\\FieldNotFoundException`.\n- Removed `craft\\errors\\InvalidVolumeException`.\n- Removed `craft\\errors\\MissingVolumeFolderException`.\n- Removed `craft\\errors\\VolumeException`.\n- Removed `craft\\errors\\VolumeObjectExistsException`.\n- Removed `craft\\errors\\VolumeObjectNotFoundException`.\n- Removed `craft\\events\\AssetTransformEvent`.\n- Removed `craft\\events\\AssetTransformImageEvent`.\n- Removed `craft\\events\\DefineComponentsEvent`.\n- Removed `craft\\events\\GenerateTransformEvent::$image`.\n- Removed `craft\\events\\GenerateTransformEvent::$tempPath`.\n- Removed `craft\\events\\GetAssetThumbEvent`.\n- Removed `craft\\events\\GetAssetThumbUrlEvent::$generate`.\n- Removed `craft\\events\\GetAssetThumbUrlEvent::$size`.\n- Removed `craft\\events\\GlobalSetContentEvent`.\n- Removed `craft\\events\\RegisterGqlPermissionsEvent`.\n- Removed `craft\\events\\SearchEvent::getElementIds()`.\n- Removed `craft\\events\\SearchEvent::setElementIds()`.\n- Removed `craft\\feeds\\Feeds`.\n- Removed `craft\\feeds\\GuzzleClient`.\n- Removed `craft\\fields\\BaseOptionsField::optionLabel()`.\n- Removed `craft\\fields\\Url::$placeholder`.\n- Removed `craft\\gql\\base\\Resolver::extractEagerLoadCondition()`.\n- Removed `craft\\gql\\base\\Resolver::getArrayableArguments()`.\n- Removed `craft\\gql\\base\\Resolver::prepareArguments()`.\n- Removed `craft\\helpers\\App::dbMutexConfig()`.\n- Removed `craft\\helpers\\App::getDefaultLogTargets()`.\n- Removed `craft\\helpers\\App::logConfig()`.\n- Removed `craft\\helpers\\Cp::editElementTitles()`.\n- Removed `craft\\helpers\\Localization::localeData()`.\n- Removed `craft\\helpers\\Stringy`.\n- Removed `craft\\i18n\\Locale::setDateTimeFormats()`.\n- Removed `craft\\log\\FileTarget`.\n- Removed `craft\\log\\StreamLogTarget`.\n- Removed `craft\\models\\AssetTransform`.\n- Removed `craft\\models\\AssetTransformIndex`.\n- Removed `craft\\models\\BaseEntryRevisionModel`.\n- Removed `craft\\models\\EntryDraft`.\n- Removed `craft\\models\\EntryVersion`.\n- Removed `craft\\models\\FieldLayout::setFields()`.\n- Removed `craft\\models\\FieldLayoutTab::getFields()`.\n- Removed `craft\\models\\Site::$originalBaseUrl`.\n- Removed `craft\\models\\Site::$originalName`.\n- Removed `craft\\models\\Site::overrideBaseUrl()`.\n- Removed `craft\\models\\Site::overrideName()`.\n- Removed `craft\\models\\VolumeListing`.\n- Removed `craft\\mutex\\DbMutexTrait`.\n- Removed `craft\\mutex\\FileMutex`.\n- Removed `craft\\mutex\\MysqlMutex`.\n- Removed `craft\\mutex\\PgsqlMutex`.\n- Removed `craft\\mutex\\PrefixedMutexTrait`.\n- Removed `craft\\queue\\jobs\\DeleteStaleTemplateCaches`.\n- Removed `craft\\records\\AssetTransform`.\n- Removed `craft\\records\\MatrixBlockType::$validateUniques`.\n- Removed `craft\\services\\AssetIndexer::deleteStaleIndexingData()`.\n- Removed `craft\\services\\AssetIndexer::extractFolderItemsFromIndexList()`.\n- Removed `craft\\services\\AssetIndexer::extractSkippedItemsFromIndexList()`.\n- Removed `craft\\services\\AssetIndexer::getIndexingSessionId()`.\n- Removed `craft\\services\\AssetIndexer::getMissingFiles()`.\n- Removed `craft\\services\\AssetIndexer::prepareIndexList()`.\n- Removed `craft\\services\\AssetIndexer::processIndexForVolume()`.\n- Removed `craft\\services\\Assets::$generatePendingTransformsViaQueue`.\n- Removed `craft\\services\\Assets::EVENT_GET_ASSET_THUMB_URL`.\n- Removed `craft\\services\\Assets::EVENT_GET_THUMB_PATH`.\n- Removed `craft\\services\\Assets::getThumbPath()`.\n- Removed `craft\\services\\AssetTransforms`.\n- Removed `craft\\services\\Composer::$disablePackagist`.\n- Removed `craft\\services\\Composer::optimize()`.\n- Removed `craft\\services\\Content::getContentRow()`.\n- Removed `craft\\services\\Content::populateElementContent()`.\n- Removed `craft\\services\\Drafts::EVENT_AFTER_MERGE_SOURCE_CHANGES`.\n- Removed `craft\\services\\Drafts::EVENT_AFTER_PUBLISH_DRAFT`.\n- Removed `craft\\services\\Drafts::EVENT_BEFORE_MERGE_SOURCE_CHANGES`.\n- Removed `craft\\services\\Drafts::EVENT_BEFORE_PUBLISH_DRAFT`.\n- Removed `craft\\services\\Drafts::publishDraft()`.\n- Removed `craft\\services\\EntryRevisions`.\n- Removed `craft\\services\\Fields::assembleLayout()`.\n- Removed `craft\\services\\Fields::getFieldIdsByLayoutId()`.\n- Removed `craft\\services\\Fields::getFieldsByElementType()`.\n- Removed `craft\\services\\Fields::getFieldsByLayoutId()`.\n- Removed `craft\\services\\Gql::getAllPermissions()`.\n- Removed `craft\\services\\Path::getAssetThumbsPath()`.\n- Removed `craft\\services\\ProjectConfig::CONFIG_ALL_KEY`.\n- Removed `craft\\services\\ProjectConfig::CONFIG_ALL_KEY`.\n- Removed `craft\\services\\ProjectConfig::CONFIG_KEY`.\n- Removed `craft\\services\\Sections::isSectionTemplateValid()`.\n- Removed `craft\\services\\SystemSettings`.\n- Removed `craft\\services\\TemplateCaches::deleteCacheById()`.\n- Removed `craft\\services\\TemplateCaches::deleteCachesByKey()`.\n- Removed `craft\\services\\TemplateCaches::deleteExpiredCaches()`.\n- Removed `craft\\services\\TemplateCaches::deleteExpiredCachesIfOverdue()`.\n- Removed `craft\\services\\TemplateCaches::EVENT_AFTER_DELETE_CACHES`.\n- Removed `craft\\services\\TemplateCaches::EVENT_BEFORE_DELETE_CACHES`.\n- Removed `craft\\services\\TemplateCaches::handleResponse()`.\n- Removed `craft\\services\\TemplateCaches::handleResponse()`.\n- Removed `craft\\services\\TemplateCaches::includeElementInTemplateCaches()`.\n- Removed `craft\\services\\TemplateCaches::includeElementQueryInTemplateCaches()`.\n- Removed `craft\\services\\Volumes::createVolume()`.\n- Removed `craft\\services\\Volumes::EVENT_REGISTER_VOLUME_TYPES`.\n- Removed `craft\\services\\Volumes::getAllVolumeTypes()`.\n- Removed `craft\\services\\Volumes::getVolumeOverrides()`.\n- Removed `craft\\volumes\\Local`.\n- Removed `craft\\volumes\\MissingVolume`.\n- Removed `craft\\volumes\\Temp`.\n- Removed `craft\\web\\AssetBundle::useCompressedJs()`.\n- Removed `craft\\web\\AssetManager::getPublishedPath()`.\n- Removed `craft\\web\\Request::getIsSingleActionRequest()`.\n- Removed `craft\\web\\twig\\Template`.\n- Removed `craft\\web\\twig\\variables\\CategoryGroups`.\n- Removed `craft\\web\\twig\\variables\\Config`.\n- Removed `craft\\web\\twig\\variables\\Deprecator`.\n- Removed `craft\\web\\twig\\variables\\ElementIndexes`.\n- Removed `craft\\web\\twig\\variables\\EmailMessages`.\n- Removed `craft\\web\\twig\\variables\\Feeds`.\n- Removed `craft\\web\\twig\\variables\\Fields`.\n- Removed `craft\\web\\twig\\variables\\Globals`.\n- Removed `craft\\web\\twig\\variables\\I18N`.\n- Removed `craft\\web\\twig\\variables\\Request`.\n- Removed `craft\\web\\twig\\variables\\Sections`.\n- Removed `craft\\web\\twig\\variables\\SystemSettings`.\n- Removed `craft\\web\\twig\\variables\\UserGroups`.\n- Removed `craft\\web\\twig\\variables\\UserPermissions`.\n- Removed `craft\\web\\twig\\variables\\UserSession`.\n- Removed `craft\\web\\User::destroyDebugPreferencesInSession()`.\n- Removed `craft\\web\\User::saveDebugPreferencesToSession()`.\n- Removed `craft\\web\\View::$minifyCss`.\n- Removed `craft\\web\\View::$minifyJs`.\n- Removed `craft\\web\\View::registerHiResCss()`.\n- Removed `craft\\web\\View::renderTemplateMacro()`.\n- Removed the `_layouts/element` control panel template.\n- Removed the `assets/_edit` control panel template.\n- Removed the `categories/_edit` control panel template.\n- Removed the `entries/_edit` control panel template.\n- Removed the `cp.assets.edit.content` control panel template hook.\n- Removed the `cp.assets.edit.details` control panel template hook.\n- Removed the `cp.assets.edit.meta` control panel template hook.\n- Removed the `cp.assets.edit.settings` control panel template hook.\n- Removed the `cp.assets.edit` control panel template hook.\n- Removed the `cp.categories.edit.content` control panel template hook.\n- Removed the `cp.categories.edit.details` control panel template hook.\n- Removed the `cp.categories.edit.meta` control panel template hook.\n- Removed the `cp.categories.edit.settings` control panel template hook.\n- Removed the `cp.categories.edit` control panel template hook.\n- Removed the `cp.elements.edit` control panel template hook.\n- Removed the `cp.entries.edit.content` control panel template hook.\n- Removed the `cp.entries.edit.details` control panel template hook.\n- Removed the `cp.entries.edit.meta` control panel template hook.\n- Removed the `cp.entries.edit.settings` control panel template hook.\n- Removed the `cp.entries.edit` control panel template hook.\n- Removed the `Craft.AssetEditor` JavaScript class.\n- Removed the `Craft.BaseElementEditor` JavaScript class.\n- Removed the `Craft.DraftEditor` JavaScript class.\n- Removed the `Craft.queueActionRequest()` JavaScript method. `Craft.queue.push()` can be used instead.\n- Removed the Flysystem package. The `craftcms/flysystem-adapter` package now provides a base Flysystem adapter class.\n- Removed the laminas-feed package.\n- Removed the yii2-swiftmailer package.\n\n### Fixed\n- Fixed a bug where pending project config changes in the YAML would get applied when other project config changes were made. ([#9660](https://github.com/craftcms/cms/issues/9660))\n- Fixed a bug where revisions weren\u2019t getting propagated when a section was enabled for new sites, or its Propagation Method was changed. ([#10634](https://github.com/craftcms/cms/issues/10634))\n\n### Security\n- Generated control panel URLs now begin with the `@web` alias value if the `baseCpUrl` config setting isn\u2019t defined.\n- HTML entities output within email body text are now escaped by default in HTML email bodies.\n", "<?php\n/**\n * @link https://craftcms.com/\n * @copyright Copyright (c) Pixel & Tonic, Inc.\n * @license https://craftcms.github.io/license/\n */\n\nnamespace craft\\controllers;\n\nuse Craft;\nuse craft\\base\\Element;\nuse craft\\base\\ElementInterface;\nuse craft\\base\\FieldLayoutComponent;\nuse craft\\behaviors\\DraftBehavior;\nuse craft\\behaviors\\RevisionBehavior;\nuse craft\\elements\\User;\nuse craft\\errors\\InvalidElementException;\nuse craft\\errors\\InvalidTypeException;\nuse craft\\errors\\UnsupportedSiteException;\nuse craft\\events\\DefineElementEditorHtmlEvent;\nuse craft\\helpers\\ArrayHelper;\nuse craft\\helpers\\Component;\nuse craft\\helpers\\Cp;\nuse craft\\helpers\\Db;\nuse craft\\helpers\\ElementHelper;\nuse craft\\helpers\\Html;\nuse craft\\helpers\\UrlHelper;\nuse craft\\models\\ElementActivity;\nuse craft\\models\\FieldLayoutForm;\nuse craft\\services\\Elements;\nuse craft\\web\\Controller;\nuse craft\\web\\CpScreenResponseBehavior;\nuse craft\\web\\View;\nuse Throwable;\nuse yii\\helpers\\Markdown;\nuse yii\\web\\BadRequestHttpException;\nuse yii\\web\\ForbiddenHttpException;\nuse yii\\web\\Response;\nuse yii\\web\\ServerErrorHttpException;\n\n/**\n * Elements controller.\n *\n * @author Pixel & Tonic, Inc. <support@pixelandtonic.com>\n * @since 3.0.0\n */\nclass ElementsController extends Controller\n{\n    /**\n     * @event DefineElementEditorHtmlEvent The event that is triggered when rendering an element editor\u2019s content.\n     * @see _editorContent()\n     */\n    public const EVENT_DEFINE_EDITOR_CONTENT = 'defineEditorContent';\n\n    /**\n     * @var ElementInterface|null The element currently being managed.\n     * @since 4.3.0\n     */\n    public ?ElementInterface $element = null;\n\n    private array $_attributes;\n    private ?string $_elementType = null;\n    private ?int $_elementId = null;\n    private ?string $_elementUid = null;\n    private ?int $_draftId = null;\n    private ?int $_revisionId = null;\n    private ?int $_siteId = null;\n\n    private ?bool $_enabled = null;\n    /**\n     * @var bool|bool[]|null\n     */\n    private array|bool|null $_enabledForSite = null;\n    private ?string $_slug = null;\n    private bool $_fresh;\n    private ?string $_draftName = null;\n    private ?string $_notes = null;\n    private string $_fieldsLocation;\n    private bool $_provisional;\n    private bool $_dropProvisional;\n    private bool $_addAnother;\n    private array $_visibleLayoutElements;\n    private ?string $_selectedTab = null;\n    private bool $_prevalidate;\n    private ?string $_context = null;\n    private ?string $_thumbSize = null;\n    private ?string $_viewMode = null;\n\n    /**\n     * @inheritdoc\n     */\n    public function beforeAction($action): bool\n    {\n        if (!parent::beforeAction($action)) {\n            return false;\n        }\n\n        $this->_attributes = $this->request->getBodyParams();\n\n        // No funny business\n        if (isset($this->_attributes['id']) || isset($this->_attributes['canonicalId'])) {\n            throw new BadRequestHttpException('Changing an element\u2019s ID is not allowed.');\n        }\n\n        $this->_elementType = $this->_param('elementType');\n        $this->_elementId = $this->_param('elementId');\n        $this->_elementUid = $this->_param('elementUid');\n        $this->_draftId = $this->_param('draftId');\n        $this->_revisionId = $this->_param('revisionId');\n        $this->_siteId = $this->_param('siteId');\n        $this->_enabled = $this->_param('enabled', true);\n        $this->_enabledForSite = $this->_param('enabledForSite');\n        $this->_slug = $this->_param('slug');\n        $this->_fresh = (bool)$this->_param('fresh');\n        $this->_draftName = $this->_param('draftName');\n        $this->_notes = $this->_param('notes');\n        $this->_fieldsLocation = $this->_param('fieldsLocation') ?? 'fields';\n        $this->_provisional = (bool)$this->_param('provisional');\n        $this->_dropProvisional = (bool)$this->_param('dropProvisional');\n        $this->_addAnother = (bool)$this->_param('addAnother');\n        $this->_visibleLayoutElements = $this->_param('visibleLayoutElements') ?? [];\n        $this->_selectedTab = $this->_param('selectedTab');\n        $this->_prevalidate = (bool)$this->_param('prevalidate');\n        $this->_context = $this->_param('context');\n        $this->_thumbSize = $this->_param('thumbSize');\n        $this->_viewMode = $this->_param('viewMode');\n\n        unset($this->_attributes['failMessage']);\n        unset($this->_attributes['redirect']);\n        unset($this->_attributes['successMessage']);\n        unset($this->_attributes[$this->_fieldsLocation]);\n\n        return true;\n    }\n\n    /**\n     * @param string $name\n     * @param mixed $default\n     * @return mixed\n     */\n    private function _param(string $name, mixed $default = null): mixed\n    {\n        $value = ArrayHelper::remove($this->_attributes, $name) ?? $this->request->getQueryParam($name);\n        if ($value === null && $default !== null && $this->request->getIsPost()) {\n            return $default;\n        }\n        return $value;\n    }\n\n    /**\n     * Redirects to an element\u2019s edit page.\n     *\n     * @param int|null $elementId\n     * @param string|null $elementUid\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionRedirect(?int $elementId = null, ?string $elementUid = null): Response\n    {\n        $element = $this->element = $this->_element($elementId, $elementUid);\n        $url = $element->getCpEditUrl();\n\n        if (!$url) {\n            throw new ServerErrorHttpException('The element doesn\u2019t have an edit page.');\n        }\n\n        return $this->redirect($url);\n    }\n\n    /**\n     * Creates a new element and redirects to its edit page.\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionCreate(): Response\n    {\n        if (!$this->_elementType) {\n            throw new BadRequestHttpException('Request missing required body param.');\n        }\n\n        $this->_validateElementType($this->_elementType);\n\n        /** @var ElementInterface $element */\n        $element = $this->element = Craft::createObject($this->_elementType);\n        if ($this->_siteId) {\n            $element->siteId = $this->_siteId;\n        }\n        $element->setAttributes($this->_attributes);\n\n        $user = static::currentUser();\n\n        if (!Craft::$app->getElements()->canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to create this element.');\n        }\n\n        if (!$element->slug) {\n            $element->slug = ElementHelper::tempSlug();\n        }\n\n        // Save it\n        $element->setScenario(Element::SCENARIO_ESSENTIALS);\n        if (!Craft::$app->getDrafts()->saveElementAsDraft($element, $user->id, null, null, false)) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t create {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        }\n\n        // Redirect to its edit page\n        $editUrl = $element->getCpEditUrl() ?? UrlHelper::actionUrl('elements/edit', [\n            'draftId' => $element->draftId,\n            'siteId' => $element->siteId,\n        ]);\n\n        $response = $this->_asSuccess(Craft::t('app', '{type} created.', [\n            'type' => Craft::t('app', 'Draft'),\n        ]), $element, array_filter([\n            'cpEditUrl' => $this->request->isCpRequest ? $editUrl : null,\n        ]));\n\n        if (!$this->request->getAcceptsJson()) {\n            $response->redirect(UrlHelper::urlWithParams($editUrl, [\n                'fresh' => '1',\n            ]));\n        }\n\n        return $response;\n    }\n\n    /**\n     * Returns an element edit screen.\n     *\n     * @param ElementInterface|null $element\n     * @param int|null $elementId\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionEdit(?ElementInterface $element, ?int $elementId = null): Response\n    {\n        $this->requireCpRequest();\n\n        $strictSite = $this->request->getAcceptsJson();\n\n        if ($element === null) {\n            /** @var Element|DraftBehavior|RevisionBehavior|Response|null $element */\n            $element = $this->_element($elementId, null, true, $strictSite);\n\n            if ($element instanceof Response) {\n                return $element;\n            }\n\n            if (!$element) {\n                throw new BadRequestHttpException('No element was identified by the request.');\n            }\n\n            // If this is an outdated draft, merge in the latest canonical changes\n            $mergeCanonicalChanges = (\n                $element::trackChanges() &&\n                $element->getIsDraft() &&\n                !$element->getIsUnpublishedDraft() &&\n                ElementHelper::isOutdated($element)\n            );\n            if ($mergeCanonicalChanges) {\n                Craft::$app->getElements()->mergeCanonicalChanges($element);\n            }\n\n            $this->_applyParamsToElement($element);\n\n            // Prevalidate?\n            if ($this->_prevalidate && $element->enabled && $element->getEnabledForSite()) {\n                $element->setScenario(Element::SCENARIO_LIVE);\n                $element->validate();\n            }\n        } else {\n            $mergeCanonicalChanges = false;\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        // Figure out what we're dealing with here\n        $isCanonical = $element->getIsCanonical();\n        $isDraft = $element->getIsDraft();\n        $isUnpublishedDraft = $element->getIsUnpublishedDraft();\n        $isRevision = $element->getIsRevision();\n        $isCurrent = $isCanonical || $element->isProvisionalDraft;\n        $canonical = $element->getCanonical(true);\n\n        // Site info\n        $supportedSites = ElementHelper::supportedSitesForElement($element, true);\n        $allEditableSiteIds = Craft::$app->getSites()->getEditableSiteIds();\n        $propSites = array_values(array_filter($supportedSites, fn($site) => $site['propagate']));\n        $propSiteIds = array_column($propSites, 'siteId');\n        $propEditableSiteIds = array_intersect($propSiteIds, $allEditableSiteIds);\n        $isMultiSiteElement = count($supportedSites) > 1;\n        $addlEditableSites = array_values(array_filter($supportedSites, fn($site) => !$site['propagate'] && in_array($site['siteId'], $allEditableSiteIds)));\n        $canEditMultipleSites = count($propEditableSiteIds) > 1 || $addlEditableSites;\n\n        // Is this a new site that isn\u2019t supported by the canonical element yet?\n        if ($isUnpublishedDraft) {\n            $isNewSite = true;\n        } elseif ($isDraft) {\n            $isNewSite = !$element::find()\n                ->id($element->getCanonicalId())\n                ->siteId($element->siteId)\n                ->status(null)\n                ->exists();\n        } else {\n            $isNewSite = false;\n        }\n\n        // Permissions\n        $canSave = $this->_canSave($element, $user);\n\n        if ($isUnpublishedDraft) {\n            $canSaveCanonical = $this->_canApplyUnpublishedDraft($element, $user);\n        } else {\n            $canSaveCanonical = ($isCanonical || $element->isProvisionalDraft) ? $canSave : $elementsService->canSave($canonical, $user);\n        }\n\n        $canCreateDrafts = $elementsService->canCreateDrafts($canonical, $user);\n        $canDeleteDraft = $isDraft && !$element->isProvisionalDraft && $elementsService->canDelete($element, $user);\n        $canDuplicateCanonical = $elementsService->canDuplicate($canonical, $user);\n        $canDeleteCanonical = $elementsService->canDelete($canonical, $user);\n        $canDeleteForSite = (\n            $isMultiSiteElement &&\n            count($propSiteIds) > 1 &&\n            (($isCurrent && $canDeleteCanonical) || ($canDeleteDraft && $isNewSite)) &&\n            $elementsService->canDeleteForSite($element, $user)\n        );\n\n        // Preview targets\n        $previewTargets = (\n            $element->id &&\n            (\n                ($isDraft && $canSave) ||\n                ($isCurrent && $canCreateDrafts)\n            )\n        ) ? $element->getPreviewTargets() : [];\n        $enablePreview = $previewTargets && !$this->request->isMobileBrowser(true);\n\n        if ($previewTargets) {\n            if ($isDraft && !$element->isProvisionalDraft) {\n                Craft::$app->getSession()->authorize(\"previewDraft:$element->draftId\");\n            } elseif ($isRevision) {\n                Craft::$app->getSession()->authorize(\"previewRevision:$element->revisionId\");\n            } else {\n                Craft::$app->getSession()->authorize(\"previewElement:$canonical->id\");\n            }\n        }\n\n        // Screen prep\n        [$docTitle, $title] = $this->_editElementTitles($element);\n        $type = $element::lowerDisplayName();\n        $enabledForSite = $element->getEnabledForSite();\n        $hasRoute = $element->getRoute() !== null;\n        $redirectUrl = $element->getPostEditUrl() ?? Craft::$app->getConfig()->getGeneral()->getPostCpLoginRedirect();\n\n        // Site statuses\n        if ($canEditMultipleSites) {\n            $siteStatuses = ElementHelper::siteStatusesForElement($element, true);\n        } else {\n            $siteStatuses = [\n                $element->siteId => $element->enabled,\n            ];\n        }\n\n        $security = Craft::$app->getSecurity();\n        $notice = null;\n        if ($element->isProvisionalDraft) {\n            $notice = fn() => $this->_draftNotice();\n        } elseif ($element->getIsRevision()) {\n            $notice = fn() => $this->_revisionNotice($element::lowerDisplayName());\n        }\n\n        $response = $this->asCpScreen()\n            ->editUrl($element->getCpEditUrl())\n            ->docTitle($docTitle)\n            ->title($title)\n            ->contextMenu(fn() => $this->_contextMenu(\n                $element,\n                $isMultiSiteElement,\n                $isUnpublishedDraft,\n                $canCreateDrafts,\n                $propSiteIds,\n                $elementsService,\n                $user,\n            ))\n            ->additionalButtons(fn() => $this->_additionalButtons(\n                $element,\n                $canonical,\n                $isRevision,\n                $canSave,\n                $canSaveCanonical,\n                $canCreateDrafts,\n                $previewTargets,\n                $enablePreview,\n                $isCurrent,\n                $isUnpublishedDraft,\n                $isDraft\n            ))\n            ->notice($notice)\n            ->errorSummary(fn() => $this->_errorSummary($element))\n            ->prepareScreen(\n                fn(Response $response, string $containerId) => $this->_prepareEditor(\n                    $element,\n                    $isUnpublishedDraft,\n                    $canSave,\n                    $response,\n                    $containerId,\n                    fn(?FieldLayoutForm $form) => $this->_editorContent($element, $canSave, $form),\n                    fn(?FieldLayoutForm $form) => $this->_editorSidebar($element, $mergeCanonicalChanges, $canSave),\n                    fn(?FieldLayoutForm $form) => [\n                        'additionalSites' => $addlEditableSites,\n                        'canCreateDrafts' => $canCreateDrafts,\n                        'canEditMultipleSites' => $canEditMultipleSites,\n                        'canSaveCanonical' => $canSaveCanonical,\n                        'elementId' => $element->id,\n                        'canonicalId' => $canonical->id,\n                        'draftId' => $element->draftId,\n                        'draftName' => $isDraft ? $element->draftName : null,\n                        'elementType' => get_class($element),\n                        'enablePreview' => $enablePreview,\n                        'enabledForSite' => $element->enabled && $enabledForSite,\n                        'hashedCpEditUrl' => $security->hashData('{cpEditUrl}'),\n                        'isLive' => $isCurrent && !$element->getIsDraft() && $element->enabled && $enabledForSite && $hasRoute,\n                        'isProvisionalDraft' => $element->isProvisionalDraft,\n                        'isUnpublishedDraft' => $isUnpublishedDraft,\n                        'previewTargets' => $previewTargets,\n                        'previewToken' => $previewTargets ? $security->generateRandomString() : null,\n                        'revisionId' => $element->revisionId,\n                        'siteId' => $element->siteId,\n                        'siteStatuses' => $siteStatuses,\n                        'siteToken' => (!Craft::$app->getIsLive() || !$element->getSite()->enabled) ? $security->hashData((string)$element->siteId) : null,\n                        'visibleLayoutElements' => $form ? $form->getVisibleElements() : [],\n                        'updatedTimestamp' => $element->dateUpdated->getTimestamp(),\n                        'canonicalUpdatedTimestamp' => $canonical->dateUpdated->getTimestamp(),\n                    ]\n                )\n            );\n\n        if ($canSave) {\n            if ($isUnpublishedDraft) {\n                if ($canSaveCanonical) {\n                    $response\n                        ->submitButtonLabel(Craft::t('app', 'Create {type}', [\n                            'type' => $element::lowerDisplayName(),\n                        ]))\n                        ->action('elements/apply-draft')\n                        ->redirectUrl(\"$redirectUrl#\");\n                } else {\n                    $response\n                        ->action('elements/save-draft')\n                        ->redirectUrl(\"$redirectUrl#\");\n                }\n            } elseif ($element->isProvisionalDraft) {\n                $response\n                    ->action('elements/apply-draft')\n                    ->redirectUrl(\"$redirectUrl#\");\n            } elseif ($isDraft) {\n                $response\n                    ->submitButtonLabel(Craft::t('app', 'Save {type}', [\n                        'type' => Craft::t('app', 'draft'),\n                    ]))\n                    ->action('elements/save-draft')\n                    ->redirectUrl(\"{cpEditUrl}\");\n            } else {\n                $response\n                    ->action('elements/save')\n                    ->redirectUrl(\"$redirectUrl#\");\n            }\n\n            $response\n                ->saveShortcutRedirectUrl('{cpEditUrl}')\n                ->addAltAction(\n                    $isUnpublishedDraft && $canSaveCanonical\n                        ? Craft::t('app', 'Create and continue editing')\n                        : Craft::t('app', 'Save and continue editing'),\n                    [\n                        'redirect' => '{cpEditUrl}',\n                        'shortcut' => true,\n                        'retainScroll' => true,\n                        'eventData' => ['autosave' => false],\n                    ]\n                );\n\n            if ($isCurrent) {\n                $newElement = $element->createAnother();\n                if ($newElement && $elementsService->canSave($newElement, $user)) {\n                    $response->addAltAction(\n                        $isUnpublishedDraft && $canSaveCanonical\n                            ? Craft::t('app', 'Create and add another')\n                            : Craft::t('app', 'Save and add another'),\n                        [\n                            'shortcut' => true,\n                            'shift' => true,\n                            'eventData' => ['autosave' => false],\n                            'params' => ['addAnother' => 1],\n                        ]\n                    );\n                }\n\n                if ($canSaveCanonical) {\n                    if ($isUnpublishedDraft) {\n                        $response->addAltAction(Craft::t('app', 'Save {type}', [\n                            'type' => Craft::t('app', 'draft'),\n                        ]), [\n                            'action' => 'elements/save-draft',\n                            'redirect' => \"$redirectUrl#\",\n                            'eventData' => ['autosave' => false],\n                        ]);\n                    } elseif ($canDuplicateCanonical) {\n                        $response->addAltAction(Craft::t('app', 'Save as a new {type}', compact('type')), [\n                            'action' => 'elements/duplicate', // todo\n                            'redirect' => '{cpEditUrl}',\n                        ]);\n                    }\n                }\n\n                if ($canDeleteForSite) {\n                    $response->addAltAction(Craft::t('app', 'Delete {type} for this site', [\n                        'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                    ]), [\n                        'destructive' => true,\n                        'action' => 'elements/delete-for-site',\n                        'redirect' => \"$redirectUrl#\",\n                        'confirm' => Craft::t('app', 'Are you sure you want to delete the {type} for this site?', [\n                            'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                        ]),\n                    ]);\n                }\n\n                if ($canDeleteCanonical) {\n                    $response->addAltAction(Craft::t('app', 'Delete {type}', [\n                        'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                    ]), [\n                        'destructive' => true,\n                        'action' => $isUnpublishedDraft ? 'elements/delete-draft' : 'elements/delete',\n                        'redirect' => \"$redirectUrl#\",\n                        'confirm' => Craft::t('app', 'Are you sure you want to delete this {type}?', [\n                            'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                        ]),\n                    ]);\n                }\n            } elseif ($isDraft && $canDeleteDraft) {\n                if ($canDeleteForSite) {\n                    $response->addAltAction(Craft::t('app', 'Delete {type} for this site', [\n                        'type' => Craft::t('app', 'draft'),\n                    ]), [\n                        'destructive' => true,\n                        'action' => 'elements/delete-for-site',\n                        'redirect' => \"$redirectUrl#\",\n                        'confirm' => Craft::t('app', 'Are you sure you want to delete the {type} for this site?', compact('type')),\n                    ]);\n                }\n\n                $response->addAltAction(Craft::t('app', 'Delete {type}', [\n                    'type' => Craft::t('app', 'draft'),\n                ]), [\n                    'destructive' => true,\n                    'action' => 'elements/delete-draft',\n                    'redirect' => $canonical->getCpEditUrl(),\n                    'confirm' => Craft::t('app', 'Are you sure you want to delete this {type}?', [\n                        'type' => Craft::t('app', 'draft'),\n                    ]),\n                ]);\n            }\n        }\n\n        return $response;\n    }\n\n    /**\n     * Returns an element revisions index screen.\n     *\n     * @param int $elementId\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.4.0\n     */\n    public function actionRevisions(int $elementId): Response\n    {\n        $this->requireCpRequest();\n\n        /** @var Element|DraftBehavior|RevisionBehavior|Response|null $element */\n        $element = $this->_element($elementId, null, false);\n\n        if (!$element) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        if ($element->getIsUnpublishedDraft()) {\n            throw new BadRequestHttpException('Unpublished drafts don\\'t have revisions');\n        }\n\n        if (!$element->hasRevisions()) {\n            throw new BadRequestHttpException('Element doesn\\'t have revisions');\n        }\n\n        return $this->asCpScreen()\n            ->title(Craft::t('app', 'Revisions for \u201c{title}\u201d', [\n                'title' => $element->getUiLabel(),\n            ]))\n            ->prepareScreen(function(Response $response, string $containerId) use ($element) {\n                // Give the element a chance to do things here too\n                $element->prepareEditScreen($response, $containerId);\n\n                /** @var CpScreenResponseBehavior $behavior */\n                $behavior = $response->getBehavior(CpScreenResponseBehavior::NAME);\n                if (!empty($behavior->crumbs)) {\n                    $behavior->crumbs[] = [\n                        'label' => $element->getUiLabel(),\n                        'url' => $element->getCpEditUrl(),\n                    ];\n                }\n            })\n        ->contentTemplate('_elements/revisions', [\n            'element' => $element,\n            'revisionsQuery' => $element::find()\n                ->revisionOf($element)\n                ->site('*')\n                ->preferSites([$element->siteId])\n                ->unique()\n                ->status(null)\n                ->andWhere(['!=', 'elements.dateCreated', Db::prepareDateForDb($element->dateUpdated)])\n                ->with(['revisionCreator']),\n        ]);\n    }\n\n    /**\n     * Returns the page title and document title that should be used for Edit Element pages.\n     *\n     * @param ElementInterface $element\n     * @return string[]\n     * @since 3.7.0\n     */\n    private function _editElementTitles(ElementInterface $element): array\n    {\n        $title = trim((string)$element->title);\n\n        if ($title === '') {\n            if (!$element->id || $element->getIsUnpublishedDraft()) {\n                $title = Craft::t('app', 'Create a new {type}', [\n                    'type' => $element::lowerDisplayName(),\n                ]);\n            } else {\n                $title = Craft::t('app', 'Edit {type}', [\n                    'type' => $element::displayName(),\n                ]);\n            }\n        }\n\n        $docTitle = $title;\n\n        if ($element->getIsDraft()) {\n            /** @var ElementInterface|DraftBehavior $element */\n            if ($element->isProvisionalDraft) {\n                $docTitle .= ' \u2014 ' . Craft::t('app', 'Edited');\n            } else {\n                $docTitle .= \" ($element->draftName)\";\n            }\n        } elseif ($element->getIsRevision()) {\n            /** @var ElementInterface|RevisionBehavior $element */\n            $docTitle .= ' (' . $element->getRevisionLabel() . ')';\n        }\n\n        return [$docTitle, $title];\n    }\n\n    private function _contextMenu(\n        ElementInterface $element,\n        bool $isMultiSiteElement,\n        bool $isUnpublishedDraft,\n        bool $canCreateDrafts,\n        array $propSiteIds,\n        Elements $elementsService,\n        User $user,\n    ): ?string {\n        if ($isUnpublishedDraft || !$element->id) {\n            $drafts = [];\n            $showDrafts = false;\n            $revisions = [];\n            $revisionsPageUrl = null;\n            $hasMoreRevisions = false;\n        } else {\n            $drafts = $element::find()\n                ->draftOf($element)\n                ->siteId($element->siteId)\n                ->status(null)\n                ->orderBy(['dateUpdated' => SORT_DESC])\n                ->with(['draftCreator'])\n                ->collect()\n                ->filter(fn(ElementInterface $draft) => $elementsService->canView($draft, $user))\n                ->all();\n            $showDrafts = !empty($drafts) || $canCreateDrafts;\n\n            $generalConfig = Craft::$app->getConfig()->getGeneral();\n            if ($element->hasRevisions() && (!$generalConfig->maxRevisions || $generalConfig->maxRevisions > 1)) {\n                $revisionQuery = $element::find()\n                    ->revisionOf($element)\n                    ->siteId($element->siteId)\n                    ->status(null)\n                    ->offset(1)\n                    ->limit($generalConfig->maxRevisions ? min($generalConfig->maxRevisions - 1, 10) : 10)\n                    ->orderBy(['dateCreated' => SORT_DESC])\n                    ->with(['revisionCreator']);\n                $revisions = $revisionQuery->all();\n                $revisionsPageUrl = $element->getCpRevisionsUrl();\n                if ($revisionsPageUrl) {\n                    $hasMoreRevisions = (\n                        count($revisions) === $revisionQuery->limit &&\n                        $revisionQuery->limit < ($generalConfig->maxRevisions - 1) &&\n                        ($revisionQuery->count() - 1) > $revisionQuery->limit\n                    );\n                } else {\n                    $hasMoreRevisions = false;\n                }\n            } else {\n                $revisions = [];\n                $revisionsPageUrl = null;\n                $hasMoreRevisions = false;\n            }\n        }\n\n        if (\n            $isMultiSiteElement ||\n            $showDrafts ||\n            !empty($revisions)\n        ) {\n            return Craft::$app->getView()->renderTemplate('_includes/revisionmenu.twig', [\n                'element' => $element,\n                'drafts' => $drafts,\n                'showDrafts' => $showDrafts,\n                'revisions' => $revisions,\n                'revisionsPageUrl' => $revisionsPageUrl,\n                'hasMoreRevisions' => $hasMoreRevisions,\n                'supportedSiteIds' => $propSiteIds,\n                'showSiteLabel' => $isMultiSiteElement,\n            ], View::TEMPLATE_MODE_CP);\n        }\n\n        return null;\n    }\n\n    private function _additionalButtons(\n        ElementInterface $element,\n        ElementInterface $canonical,\n        bool $isRevision,\n        bool $canSave,\n        bool $canSaveCanonical,\n        bool $canCreateDrafts,\n        ?array $previewTargets,\n        bool $enablePreview,\n        bool $isCurrent,\n        bool $isUnpublishedDraft,\n        bool $isDraft,\n    ): string {\n        $components = [\n            Html::tag('div', options: [\n                'class' => ['activity-container'],\n            ]),\n        ];\n\n        // Preview (View will be added later by JS)\n        if ($canSave && $previewTargets) {\n            $components[] =\n                Html::beginTag('div', [\n                    'class' => ['preview-btn-container', 'btngroup'],\n                ]) .\n                ($enablePreview\n                    ? Html::beginTag('button', [\n                        'type' => 'button',\n                        'class' => ['preview-btn', 'btn'],\n                        'aria' => [\n                            'label' => Craft::t('app', 'Preview'),\n                        ],\n                    ]) .\n                    Html::tag('span', Craft::t('app', 'Preview'), ['class' => 'label']) .\n                    Html::tag('span', options: ['class' => ['spinner', 'spinner-absolute']]) .\n                    Html::endTag('button')\n                    : '') .\n                Html::endTag('div');\n        }\n\n        // Create a draft\n        if ($isCurrent && !$isUnpublishedDraft && $canCreateDrafts) {\n            if ($canSave) {\n                $components[] = Html::button(Craft::t('app', 'Create a draft'), [\n                    'class' => ['btn', 'formsubmit'],\n                    'data' => [\n                        'action' => 'elements/save-draft',\n                        'redirect' => Craft::$app->getSecurity()->hashData('{cpEditUrl}'),\n                        'params' => ['dropProvisional' => 1],\n                    ],\n                ]);\n            } else {\n                $components[] = Html::beginForm() .\n                    Html::actionInput('elements/save-draft') .\n                    Html::redirectInput('{cpEditUrl}') .\n                    Html::hiddenInput('elementId', (string)$canonical->id) .\n                    Html::beginTag('div', ['class' => 'secondary-buttons']) .\n                    Html::button(Craft::t('app', 'Create a draft'), [\n                        'class' => ['btn', 'secondary', 'formsubmit'],\n                    ]) .\n                    Html::endTag('div') .\n                    Html::endForm();\n            }\n        }\n\n        // Apply draft\n        if ($isDraft && !$isCurrent && $canSave && $canSaveCanonical) {\n            $components[] = Html::button(Craft::t('app', 'Apply draft'), [\n                'class' => ['btn', 'secondary', 'formsubmit'],\n                'data' => [\n                    'action' => 'elements/apply-draft',\n                    'redirect' => Craft::$app->getSecurity()->hashData('{cpEditUrl}'),\n                ],\n            ]);\n        }\n\n        // Revert content from this revision\n        if ($isRevision && $canSaveCanonical) {\n            $components[] = Html::beginForm() .\n                Html::actionInput('elements/revert') .\n                Html::redirectInput('{cpEditUrl}') .\n                Html::hiddenInput('elementId', (string)$canonical->id) .\n                Html::hiddenInput('revisionId', (string)$element->revisionId) .\n                Html::beginTag('div', ['class' => 'secondary-buttons']) .\n                Html::button(Craft::t('app', 'Revert content from this revision'), [\n                    'class' => ['btn', 'secondary', 'formsubmit'],\n                ]) .\n                Html::endTag('div') .\n                Html::endForm();\n        }\n\n        $components[] = $element->getAdditionalButtons();\n\n        return implode(\"\\n\", array_filter($components));\n    }\n\n    private function _prepareEditor(\n        ElementInterface $element,\n        bool $isUnpublishedDraft,\n        bool $canSave,\n        Response $response,\n        string $containerId,\n        callable $contentFn,\n        callable $sidebarFn,\n        callable $jsSettingsFn,\n    ) {\n        $fieldLayout = $element->getFieldLayout();\n        $form = $fieldLayout?->createForm($element, !$canSave, [\n            'registerDeltas' => true,\n        ]);\n        $contentHtml = $contentFn($form);\n        $sidebarHtml = $sidebarFn($form);\n\n        if ($contentHtml === '' && $sidebarHtml !== '' && $this->request->getAcceptsJson()) {\n            $contentHtml = Html::tag('div', $sidebarHtml, [\n                'class' => 'details',\n            ]);\n            $sidebarHtml = '';\n            /** @var Response|CpScreenResponseBehavior $response */\n            $response->slideoutBodyClass = 'so-full-details';\n        }\n\n        if ($canSave) {\n            $components = [];\n\n            if ($element->id) {\n                $components[] = Html::hiddenInput('elementId', (string)$element->getCanonicalId());\n            }\n\n            if ($element->siteId) {\n                $components[] = Html::hiddenInput('siteId', (string)$element->siteId);\n            }\n\n            if ($element->fieldLayoutId) {\n                $components[] = Html::hiddenInput('fieldLayoutId', (string)$element->fieldLayoutId);\n            }\n\n            if ($isUnpublishedDraft && $this->_fresh) {\n                $components[] = Html::hiddenInput('fresh', '1');\n            }\n\n            $components[] = $contentHtml;\n            $contentHtml = implode(\"\\n\", $components);\n        }\n\n        /** @var Response|CpScreenResponseBehavior $response */\n        $response\n            ->tabs($form?->getTabMenu() ?? [])\n            ->content($contentHtml)\n            ->sidebar($sidebarHtml);\n\n        if ($canSave && !$element->getIsRevision()) {\n            $this->view->registerJsWithVars(fn($settingsJs) => <<<JS\nnew Craft.ElementEditor($('#$containerId'), $settingsJs);\nJS, [\n                $jsSettingsFn($form),\n            ]);\n        }\n\n        // Give the element a chance to do things here too\n        $element->prepareEditScreen($response, $containerId);\n    }\n\n    private function _editorContent(\n        ElementInterface $element,\n        bool $canSave,\n        ?FieldLayoutForm $form,\n    ): string {\n        $html = $form?->render() ?? '';\n\n        // Trigger a defineEditorContent event\n        if ($this->hasEventHandlers(self::EVENT_DEFINE_EDITOR_CONTENT)) {\n            $event = new DefineElementEditorHtmlEvent([\n                'element' => $element,\n                'html' => $html,\n                'static' => !$canSave,\n            ]);\n            $this->trigger(self::EVENT_DEFINE_EDITOR_CONTENT, $event);\n            $html = $event->html;\n        }\n\n        return trim($html);\n    }\n\n    /**\n     * Return html for errors summary box\n     *\n     * @param ElementInterface $element\n     * @return string\n     */\n    private function _errorSummary(ElementInterface $element): string\n    {\n        $html = '';\n\n        if ($element->hasErrors()) {\n            $allErrors = $element->getErrors();\n            $allKeys = array_keys($allErrors);\n\n            // only show \"top-level\" errors\n            // if you e.g. have an assets field which is set to validate related assets,\n            // you should only see the top-level \"Fix validation errors on the related asset\" error\n            // and not the details of what's wrong with the selected asset;\n            foreach ($allKeys as $key) {\n                $lastNestedKey = substr_replace($key, '', strrpos($key, '.'));\n                $lastNestedKey = substr_replace($lastNestedKey, '', strrpos($lastNestedKey, '['));\n                if (!empty($lastNestedKey)) {\n                    if (in_array($lastNestedKey, $allKeys)) {\n                        unset($allErrors[$key]);\n                    }\n                }\n            }\n            $errorsList = [];\n            foreach ($allErrors as $key => $errors) {\n                foreach ($errors as $error) {\n                    $errorItem = Html::beginTag('li');\n\n                    // this is true in case of e.g. cross site validation error\n                    if (preg_match('/^\\s?\\<a /', $error)) {\n                        $errorItem .= $error;\n                    } else {\n                        $error = Markdown::processParagraph(htmlspecialchars($error));\n                        $errorItem .= Html::a(Craft::t('app', $error), '#', [\n                            'data' => [\n                                'field-error-key' => $key,\n                            ],\n                        ]);\n                    }\n\n                    $errorItem .= Html::endTag('li');\n\n                    $errorsList[] = $errorItem;\n                }\n            }\n\n            if (!empty($errorsList)) {\n                $heading = Craft::t('app', 'Found {num, number} {num, plural, =1{error} other{errors}}', [\n                    'num' => count($errorsList),\n                ]);\n\n                $html = Html::beginTag('div', [\n                        'class' => ['error-summary'],\n                        'tabindex' => '-1',\n                    ]) .\n                    Html::beginTag('div') .\n                    Html::tag('span', '', [\n                        'class' => 'notification-icon',\n                        'data-icon' => 'alert',\n                        'aria-label' => 'error',\n                        'role' => 'img',\n                    ]) .\n                    Html::tag('h2', $heading) .\n                    Html::endTag('div') .\n                    Html::beginTag('ul', [\n                        'class' => ['errors'],\n                    ]) .\n                    implode('', $errorsList) .\n                    Html::endTag('ul') .\n                    Html::endTag('div');\n            }\n        }\n\n        return $html;\n    }\n\n    private function _editorSidebar(\n        ElementInterface $element,\n        bool $mergedCanonicalChanges,\n        bool $canSave,\n    ): string {\n        $components = [];\n\n        if ($mergedCanonicalChanges) {\n            $components[] =\n                Html::beginTag('div', [\n                    'class' => ['meta', 'warning'],\n                ]) .\n                Html::tag('p', Craft::t('app', 'Recent changes to the Current revision have been merged into this draft.')) .\n                Html::endTag('div');\n        }\n\n        /** @var ElementInterface|DraftBehavior|RevisionBehavior $element */\n        $components[] = $element->getSidebarHtml(!$canSave);\n\n        if ($this->id) {\n            $components[] = Cp::metadataHtml($element->getMetadata());\n        }\n\n        return trim(implode(\"\\n\", $components));\n    }\n\n    private function _draftNotice(): string\n    {\n        return\n            Html::beginTag('div', [\n                'class' => 'draft-notice',\n            ]) .\n            Html::tag('div', '', [\n                'class' => ['draft-icon'],\n                'aria' => ['hidden' => 'true'],\n                'data' => ['icon' => 'edit'],\n            ]) .\n            Html::tag('p', Craft::t('app', 'Showing your unsaved changes.')) .\n            Html::button(Craft::t('app', 'Discard'), [\n                'class' => ['discard-changes-btn', 'btn'],\n            ]) .\n            Html::endTag('div');\n    }\n\n    private function _revisionNotice($elementType): string\n    {\n        return\n            Html::beginTag('div', [\n                'class' => 'revision-notice',\n            ]) .\n            Html::tag('div', '', [\n                'class' => ['revision-icon'],\n                'aria' => ['hidden' => 'true'],\n                'data' => ['icon' => 'lightbulb'],\n            ]) .\n            Html::tag('p', Craft::t(\n                'app',\n                'You\u2019re viewing a revision. None of the {type}\u2019s fields are editable.',\n                [\n                    'type' => $elementType,\n                ]\n            )) .\n            Html::endTag('div');\n    }\n\n    /**\n     * Saves an element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionSave(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|null $element */\n        $element = $this->_element();\n\n        if (!$element || $element->getIsDraft() || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $this->_applyParamsToElement($element);\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if (!$elementsService->canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        if ($element->enabled && $element->getEnabledForSite()) {\n            $element->setScenario(Element::SCENARIO_LIVE);\n        }\n\n        $isNotNew = $element->id;\n        if ($isNotNew) {\n            $lockKey = \"element:$element->id\";\n            $mutex = Craft::$app->getMutex();\n            if (!$mutex->acquire($lockKey, 15)) {\n                throw new ServerErrorHttpException('Could not acquire a lock to save the element.');\n            }\n        }\n\n        try {\n            $namespace = $this->request->getHeaders()->get('X-Craft-Namespace');\n            // crossSiteValidate only if it's multisite, element supports drafts and we're not in a slideout\n            $success = $elementsService->saveElement(\n                $element,\n                crossSiteValidate: ($namespace === null && Craft::$app->getIsMultiSite() && $elementsService->canCreateDrafts($element, $user)),\n            );\n        } catch (UnsupportedSiteException $e) {\n            $element->addError('siteId', $e->getMessage());\n            $success = false;\n        } finally {\n            if ($isNotNew) {\n                $mutex->release($lockKey);\n            }\n        }\n\n        if (!$success) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t save {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        }\n\n        $elementsService->trackActivity($element, ElementActivity::TYPE_SAVE);\n\n        // See if the user happens to have a provisional element. If so delete it.\n        $provisional = $element::find()\n            ->provisionalDrafts()\n            ->draftOf($element->id)\n            ->draftCreator($user)\n            ->siteId($element->siteId)\n            ->status(null)\n            ->one();\n\n        if ($provisional) {\n            $elementsService->deleteElement($provisional, true);\n        }\n\n        if (!$this->request->getAcceptsJson()) {\n            // Tell all browser windows about the element save\n            Craft::$app->getSession()->broadcastToJs([\n                'event' => 'saveElement',\n                'id' => $element->id,\n            ]);\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} saved.', [\n            'type' => $element::displayName(),\n        ]), $element, addAnother: true);\n    }\n\n    /**\n     * Duplicates an element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionDuplicate(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (\n            !$element ||\n            ($element->getIsDraft() && !$element->isProvisionalDraft && !$element->getIsUnpublishedDraft()) ||\n            $element->getIsRevision()\n        ) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n\n        if (!$elementsService->canDuplicate($element)) {\n            throw new ForbiddenHttpException('User not authorized to duplicate this element.');\n        }\n\n        try {\n            $newElement = $elementsService->duplicateElement($element, [\n                'isProvisionalDraft' => false,\n            ]);\n        } catch (InvalidElementException $e) {\n            return $this->_asFailure($e->element, Craft::t('app', 'Couldn\u2019t duplicate {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        } catch (Throwable $e) {\n            throw new ServerErrorHttpException('An error occurred when duplicating the element.', 0, $e);\n        }\n\n        // If the original element is a provisional draft,\n        // delete the draft as the changes are likely no longer wanted.\n        if ($element->isProvisionalDraft) {\n            Craft::$app->getElements()->deleteElement($element);\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} duplicated.', [\n            'type' => $element::displayName(),\n        ]), $newElement);\n    }\n\n    /**\n     * Deletes an element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionDelete(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|null $element */\n        $element = $this->_element();\n\n        // If this is a provisional draft, delete the canonical\n        if ($element && $element->isProvisionalDraft) {\n            $element = $element->getCanonical(true);\n        }\n\n        if (!$element || $element->getIsDraft() || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if (!$elementsService->canDelete($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to delete this element.');\n        }\n\n        if (!$elementsService->deleteElement($element)) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t delete {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} deleted.', [\n            'type' => $element::displayName(),\n        ]), $element);\n    }\n\n    /**\n     * Deletes an element for a single site.\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionDeleteForSite(): Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|null $element */\n        $element = $this->_element();\n\n        if (!$element || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n\n        if (!$elementsService->canDeleteForSite($element)) {\n            throw new ForbiddenHttpException('User not authorized to delete the element for this site.');\n        }\n\n        $elementsService->deleteElementForSite($element);\n\n        if ($element->isProvisionalDraft) {\n            // see if the canonical element exists for this site\n            $canonical = $element->getCanonical();\n            if ($canonical->id !== $element->id) {\n                $element = $canonical;\n                $elementsService->deleteElementForSite($element);\n            }\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} deleted for site.', [\n            'type' => $element->getIsDraft() && !$element->isProvisionalDraft ? Craft::t('app', 'Draft') : $element::displayName(),\n        ]), $element);\n    }\n\n    /**\n     * Saves a draft.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionSaveDraft(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if (!$element->getIsDraft() && !$this->_provisional) {\n            if (!$elementsService->canCreateDrafts($element, $user)) {\n                throw new ForbiddenHttpException('User not authorized to create drafts for this element.');\n            }\n        } elseif (!$this->_canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        $this->element = $element;\n\n        if (!$element->getIsDraft() && $this->_provisional) {\n            // Make sure a provisional draft doesn't already exist for this element/user combo\n            $provisionalExists = $element::find()\n                ->provisionalDrafts()\n                ->draftOf($element->id)\n                ->draftCreator($user->id)\n                ->site('*')\n                ->status(null)\n                ->exists();\n\n            if ($provisionalExists) {\n                throw new BadRequestHttpException(\"A provisional draft already exists for element/user $element->id/$user->id.\");\n            }\n        }\n\n        return Craft::$app->getDb()->transaction(function() use ($element, $user, $elementsService): ?Response {\n            // Are we creating the draft here?\n            if (!$element->getIsDraft()) {\n                /** @var Element|DraftBehavior $element */\n                $draft = Craft::$app->getDrafts()->createDraft($element, $user->id, null, null, [], $this->_provisional);\n                $draft->setCanonical($element);\n                $element = $this->element = $draft;\n            }\n\n            $this->_applyParamsToElement($element);\n\n            // Make sure nothing just changed that would prevent the user from saving\n            if (!$this->_canSave($element, $user)) {\n                throw new ForbiddenHttpException('User not authorized to save this element.');\n            }\n\n            if ($this->_dropProvisional) {\n                $element->isProvisionalDraft = false;\n            }\n\n            $element->setScenario(Element::SCENARIO_ESSENTIALS);\n\n            if (!$elementsService->saveElement($element)) {\n                return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t save {type}.', [\n                    'type' => Craft::t('app', 'draft'),\n                ]));\n            }\n\n            $elementsService->trackActivity($element, ElementActivity::TYPE_SAVE);\n\n            $creator = $element->getCreator();\n\n            $data = [\n                'canonicalId' => $element->getCanonicalId(),\n                'elementId' => $element->id,\n                'draftId' => $element->draftId,\n                'timestamp' => Craft::$app->getFormatter()->asTimestamp($element->dateUpdated, 'short', true),\n                'creator' => $creator?->getName(),\n                'draftName' => $element->draftName,\n                'draftNotes' => $element->draftNotes,\n                'duplicatedElements' => Elements::$duplicatedElementIds,\n                'modifiedAttributes' => $element->getModifiedAttributes(),\n            ];\n\n            if ($this->request->getIsCpRequest()) {\n                [$docTitle, $title] = $this->_editElementTitles($element);\n\n                $view = Craft::$app->getView();\n\n                $namespace = $this->request->getHeaders()->get('X-Craft-Namespace');\n                $fieldLayout = $element->getFieldLayout();\n                $form = $fieldLayout->createForm($element, false, [\n                    'namespace' => $namespace,\n                    'registerDeltas' => false,\n                    'visibleElements' => $this->_visibleLayoutElements,\n                ]);\n                $missingElements = [];\n                foreach ($form->tabs as $tab) {\n                    if (!$tab->getUid()) {\n                        continue;\n                    }\n\n                    $elementInfo = [];\n\n                    foreach ($tab->elements as [$layoutElement, $isConditional, $elementHtml]) {\n                        /** @var FieldLayoutComponent $layoutElement */\n                        /** @var bool $isConditional */\n                        /** @var string|bool $elementHtml */\n                        if ($isConditional) {\n                            $elementInfo[] = [\n                                'uid' => $layoutElement->uid,\n                                'html' => $elementHtml,\n                            ];\n                        }\n                    }\n\n                    $missingElements[] = [\n                        'uid' => $tab->getUid(),\n                        'id' => $tab->getId(),\n                        'elements' => $elementInfo,\n                    ];\n                }\n\n                $tabs = $form->getTabMenu();\n                if (count($tabs) > 1) {\n                    $selectedTab = isset($tabs[$this->_selectedTab]) ? $this->_selectedTab : null;\n                    $tabHtml = $view->namespaceInputs(fn() => $view->renderTemplate('_includes/tabs.twig', [\n                        'tabs' => $tabs,\n                        'selectedTab' => $selectedTab,\n                    ], View::TEMPLATE_MODE_CP), $namespace);\n                } else {\n                    $tabHtml = null;\n                }\n\n                $data += [\n                    'docTitle' => $docTitle,\n                    'title' => $title,\n                    'tabs' => $tabHtml,\n                    'previewTargets' => $element->getPreviewTargets(),\n                    'missingElements' => $missingElements,\n                    'initialDeltaValues' => $view->getInitialDeltaValues(),\n                    'headHtml' => $view->getHeadHtml(),\n                    'bodyHtml' => $view->getBodyHtml(),\n                    'updatedTimestamp' => $element->dateUpdated->getTimestamp(),\n                    'canonicalUpdatedTimestamp' => $element->getCanonical()->dateUpdated->getTimestamp(),\n                ];\n            }\n\n            // Make sure the user is authorized to preview the draft\n            Craft::$app->getSession()->authorize(\"previewDraft:$element->draftId\");\n\n            return $this->_asSuccess(Craft::t('app', '{type} saved.', [\n                'type' => Craft::t('app', 'Draft'),\n            ]), $element, $data);\n        });\n    }\n\n    /**\n     * Applies a draft to its canonical element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionApplyDraft(): ?Response\n    {\n        $this->requirePostRequest();\n        $elementsService = Craft::$app->getElements();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || !$element->getIsDraft()) {\n            throw new BadRequestHttpException('No draft was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $this->_applyParamsToElement($element);\n        $user = static::currentUser();\n\n        if (!$elementsService->canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this draft.');\n        }\n\n        $isUnpublishedDraft = $element->getIsUnpublishedDraft();\n\n        if ($isUnpublishedDraft) {\n            if (!$this->_canApplyUnpublishedDraft($element, $user)) {\n                throw new ForbiddenHttpException('User not authorized to create this element.');\n            }\n        } elseif (!$elementsService->canSave($element->getCanonical(true), $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        // Validate and save the draft\n        if ($element->enabled && $element->getEnabledForSite()) {\n            $element->setScenario(Element::SCENARIO_LIVE);\n        }\n\n        $namespace = $this->request->getHeaders()->get('X-Craft-Namespace');\n        if (!$elementsService->saveElement($element, crossSiteValidate: ($namespace === null && Craft::$app->getIsMultiSite()))) {\n            return $this->_asAppyDraftFailure($element);\n        }\n\n        if (!$isUnpublishedDraft) {\n            $lockKey = \"element:$element->canonicalId\";\n            $mutex = Craft::$app->getMutex();\n            if (!$mutex->acquire($lockKey, 15)) {\n                throw new ServerErrorHttpException('Could not acquire a lock to save the element.');\n            }\n        }\n\n        try {\n            $canonical = Craft::$app->getDrafts()->applyDraft($element);\n        } catch (InvalidElementException) {\n            return $this->_asAppyDraftFailure($element);\n        } finally {\n            if (!$isUnpublishedDraft) {\n                $mutex->release($lockKey);\n            }\n        }\n\n        $elementsService->trackActivity($canonical, ElementActivity::TYPE_SAVE);\n\n        if (!$this->request->getAcceptsJson()) {\n            // Tell all browser windows about the element save\n            $session = Craft::$app->getSession();\n            $session->broadcastToJs([\n                'event' => 'saveElement',\n                'id' => $canonical->id,\n            ]);\n            if (!$isUnpublishedDraft) {\n                $session->broadcastToJs([\n                    'event' => 'deleteDraft',\n                    'canonicalId' => $element->getCanonicalId(),\n                    'draftId' => $element->draftId,\n                ]);\n            }\n        }\n\n        if ($isUnpublishedDraft) {\n            $message = Craft::t('app', '{type} created.', [\n                'type' => $element::displayName(),\n            ]);\n        } elseif ($element->isProvisionalDraft) {\n            $message = Craft::t('app', '{type} saved.', [\n                'type' => $element::displayName(),\n            ]);\n        } else {\n            $message = Craft::t('app', 'Draft applied.');\n        }\n\n        return $this->_asSuccess($message, $canonical, addAnother: true);\n    }\n\n    private function _asAppyDraftFailure(ElementInterface $element): ?Response\n    {\n        if ($element->getIsUnpublishedDraft()) {\n            $message = Craft::t('app', 'Couldn\u2019t create {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]);\n        } elseif ($element->isProvisionalDraft) {\n            $message = Craft::t('app', 'Couldn\u2019t save {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]);\n        } else {\n            $message = Craft::t('app', 'Couldn\u2019t apply draft.');\n        }\n\n        return $this->_asFailure($element, $message);\n    }\n\n    /**\n     * Deletes a draft.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionDeleteDraft(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || !$element->getIsDraft()) {\n            throw new BadRequestHttpException('No draft was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if (!$elementsService->canDelete($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to delete this draft.');\n        }\n\n        if (!$elementsService->deleteElement($element, true)) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t delete {type}.', [\n                'type' => Craft::t('app', 'draft'),\n            ]));\n        }\n\n        if ($element->isProvisionalDraft) {\n            $message = Craft::t('app', 'Changes discarded.');\n        } else {\n            $message = Craft::t('app', '{type} deleted.', [\n                'type' => Craft::t('app', 'Draft'),\n            ]);\n        }\n\n        if (!$this->request->getAcceptsJson()) {\n            // Tell all browser windows about the draft deletion\n            Craft::$app->getSession()->broadcastToJs([\n                'event' => 'deleteDraft',\n                'canonicalId' => $element->getCanonicalId(),\n                'draftId' => $element->draftId,\n            ]);\n        }\n\n        return $this->_asSuccess($message, $element);\n    }\n\n    /**\n     * Reverts an element\u2019s content to a revision.\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionRevert(): Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|RevisionBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || !$element->getIsRevision()) {\n            throw new BadRequestHttpException('No revision was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $user = static::currentUser();\n\n        if (!Craft::$app->getElements()->canSave($element->getCanonical(true), $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        $canonical = Craft::$app->getRevisions()->revertToRevision($element, $user->id);\n        Craft::$app->getElements()->trackActivity($canonical, ElementActivity::TYPE_SAVE);\n\n        return $this->_asSuccess(Craft::t('app', '{type} reverted to past revision.', [\n            'type' => $element::displayName(),\n        ]), $canonical);\n    }\n\n    /**\n     * Returns the HTML for a single element\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     */\n    public function actionGetElementHtml(): Response\n    {\n        $this->requireAcceptsJson();\n\n        $element = $this->_element();\n\n        if (!$element) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $context = $this->_context ?? 'field';\n        $thumbSize = $this->_thumbSize;\n\n        if (!in_array($thumbSize, [Cp::ELEMENT_SIZE_SMALL, Cp::ELEMENT_SIZE_LARGE], true)) {\n            $thumbSize = $this->_viewMode === 'thumbs' ? Cp::ELEMENT_SIZE_LARGE : Cp::ELEMENT_SIZE_SMALL;\n        }\n\n        $html = Cp::elementHtml($element, $context, $thumbSize);\n        $headHtml = $this->getView()->getHeadHtml();\n\n        return $this->asJson(compact('html', 'headHtml'));\n    }\n\n    /**\n     * Returns any recent activity for an element, and records that the user is viewing the element.\n     *\n     * @return Response\n     * @since 4.5.0\n     */\n    public function actionRecentActivity(): Response\n    {\n        $element = $this->_element();\n\n        if (!$element || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $elementsService = Craft::$app->getElements();\n        $currentUser = Craft::$app->getUser()->getIdentity();\n        $activity = $elementsService->getRecentActivity($element, $currentUser->id);\n        $elementsService->trackActivity($element, ElementActivity::TYPE_VIEW, $currentUser);\n\n        return $this->asJson([\n            'activity' => array_map(function(ElementActivity $record) use ($element) {\n                $recordIsCanonical = $record->element->getIsCanonical() || $record->element->isProvisionalDraft;\n                $recordIsCanonicalAndPublished = $recordIsCanonical && !$record->element->getIsUnpublishedDraft();\n                $isSameOrUpstream = $element->id === $record->element->id || $recordIsCanonical;\n\n                if ($isSameOrUpstream) {\n                    $messageParams = [\n                        'user' => $record->user->getName(),\n                        'type' => $recordIsCanonicalAndPublished ? $element::lowerDisplayName() : Craft::t('app', 'draft'),\n                    ];\n                    $message = match ($record->type) {\n                        ElementActivity::TYPE_VIEW => Craft::t('app', '{user} is viewing this {type}.', $messageParams),\n                        ElementActivity::TYPE_EDIT, ElementActivity::TYPE_SAVE => Craft::t('app', '{user} is editing this {type}.', $messageParams),\n                    };\n                } else {\n                    $messageParams = [\n                        'user' => $record->user->getName(),\n                        'type' => $element::lowerDisplayName(),\n                    ];\n                    $message = match ($record->type) {\n                        ElementActivity::TYPE_VIEW => Craft::t('app', '{user} is viewing a draft of this {type}.', $messageParams),\n                        ElementActivity::TYPE_EDIT, ElementActivity::TYPE_SAVE => Craft::t('app', '{user} is editing a draft of this {type}.', $messageParams),\n                    };\n                }\n\n                return [\n                    'userId' => $record->user->id,\n                    'userName' => $record->user->getName(),\n                    'userThumb' => $record->user->getThumbHtml(26),\n                    'message' => $message,\n                ];\n            }, $activity),\n            'updatedTimestamp' => $element->dateUpdated->getTimestamp(),\n            'canonicalUpdatedTimestamp' => $element->getCanonical()->dateUpdated->getTimestamp(),\n        ]);\n    }\n\n    /**\n     * Returns the requested element, populated with any posted attributes.\n     *\n     * @param int|null $elementId\n     * @param string|null $elementUid\n     * @param bool|null $provisional\n     * @param bool $strictSite\n     * @return ElementInterface|Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     */\n    private function _element(?int $elementId = null, ?string $elementUid = null, ?bool $provisional = null, bool $strictSite = true): ElementInterface|Response|null\n    {\n        $elementId = $elementId ?? $this->_elementId;\n        $elementUid = $elementUid ?? $this->_elementUid;\n\n        $sitesService = Craft::$app->getSites();\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if ($this->_siteId) {\n            $site = $sitesService->getSiteById($this->_siteId, true);\n            if (!$site) {\n                throw new BadRequestHttpException(\"Invalid side ID: $this->_siteId\");\n            }\n            if (Craft::$app->getIsMultiSite() && !$user->can(\"editSite:$site->uid\")) {\n                throw new ForbiddenHttpException('User not authorized to edit content for this site.');\n            }\n        } else {\n            $site = Cp::requestedSite();\n            if (!$site) {\n                throw new ForbiddenHttpException('User not authorized to edit content in any sites.');\n            }\n        }\n\n        if ($this->_elementType) {\n            $elementType = $this->_elementType;\n        } elseif ($elementId || $elementUid) {\n            if ($elementId) {\n                $elementType = $elementsService->getElementTypeById($elementId);\n            } else {\n                $elementType = $elementsService->getElementTypeByUid($elementUid);\n            }\n            if (!$elementType) {\n                throw new BadRequestHttpException($elementId ? \"Invalid element ID: $elementId\" : \"Invalid element UUID: $elementUid\");\n            }\n        } else {\n            throw new BadRequestHttpException('Request missing required param.');\n        }\n\n        /** @var string|ElementInterface $elementType */\n        /** @phpstan-var class-string<ElementInterface>|ElementInterface $elementType */\n        $this->_validateElementType($elementType);\n\n        if ($strictSite) {\n            $siteId = $site->id;\n            $preferSites = null;\n        } else {\n            $siteId = $sitesService->getEditableSiteIds();\n            $preferSites = [$site->id];\n        }\n\n        // Loading an existing element?\n        if ($this->_draftId || $this->_revisionId) {\n            $element = $elementType::find()\n                ->draftId($this->_draftId)\n                ->revisionId($this->_revisionId)\n                ->provisionalDrafts($this->_provisional)\n                ->siteId($siteId)\n                ->preferSites($preferSites)\n                ->unique()\n                ->status(null)\n                ->one();\n\n            if (!$element) {\n                throw new BadRequestHttpException($this->_draftId ? \"Invalid draft ID: $this->_draftId\" : \"Invalid revision ID: $this->_revisionId\");\n            }\n        } elseif ($elementId || $elementUid) {\n            if ($elementId) {\n                // First check for a provisional draft, if we're open to it\n                if ($provisional) {\n                    $element = $elementType::find()\n                        ->provisionalDrafts()\n                        ->draftOf($elementId)\n                        ->draftCreator($user)\n                        ->siteId($siteId)\n                        ->preferSites($preferSites)\n                        ->unique()\n                        ->status(null)\n                        ->one();\n                }\n\n                if (!isset($element) || !$this->_canSave($element, $user)) {\n                    $element = $elementType::find()\n                        ->id($elementId)\n                        ->siteId($siteId)\n                        ->preferSites($preferSites)\n                        ->unique()\n                        ->status(null)\n                        ->one();\n                }\n            } else {\n                $element = $elementType::find()\n                    ->uid($elementUid)\n                    ->siteId($siteId)\n                    ->preferSites($preferSites)\n                    ->unique()\n                    ->status(null)\n                    ->one();\n            }\n\n            if (!$element) {\n                throw new BadRequestHttpException($elementId ? \"Invalid element ID: $elementId\" : \"Invalid element UUID: $elementUid\");\n            }\n        } else {\n            return null;\n        }\n\n        if (!$element->canView(static::currentUser())) {\n            throw new ForbiddenHttpException('User not authorized to edit this element.');\n        }\n\n        if (!$strictSite && $element->siteId !== $site->id) {\n            return $this->redirect($element->getCpEditUrl());\n        }\n\n        return $element;\n    }\n\n    /**\n     * Ensures the given element type is valid.\n     *\n     * @param string $elementType\n     * @phpstan-param class-string<ElementInterface> $elementType\n     * @throws BadRequestHttpException\n     */\n    private function _validateElementType(string $elementType): void\n    {\n        if (!Component::validateComponentClass($elementType, ElementInterface::class)) {\n            $message = (new InvalidTypeException($elementType, ElementInterface::class))->getMessage();\n            throw new BadRequestHttpException($message);\n        }\n    }\n\n    /**\n     * Applies the request params to the given element.\n     *\n     * @param ElementInterface $element\n     * @throws ForbiddenHttpException\n     */\n    private function _applyParamsToElement(ElementInterface $element): void\n    {\n        if (isset($this->_enabledForSite)) {\n            if (is_array($this->_enabledForSite)) {\n                // Make sure they are allowed to edit all of the posted site IDs\n                $editableSiteIds = Craft::$app->getSites()->getEditableSiteIds();\n                if (array_diff(array_keys($this->_enabledForSite), $editableSiteIds)) {\n                    throw new ForbiddenHttpException('User not authorized to edit element statuses for all the submitted site IDs.');\n                }\n\n                // Set the global status to true if it's enabled for *any* sites, or if already enabled.\n                $element->enabled = in_array(true, $this->_enabledForSite) || $element->enabled;\n            }\n\n            $element->setEnabledForSite($this->_enabledForSite);\n        } elseif (isset($this->_enabled)) {\n            $element->enabled = $this->_enabled;\n        }\n\n        if ($this->_fresh) {\n            $element->setIsFresh();\n\n            if ($element->getIsUnpublishedDraft()) {\n                $element->propagateAll = true;\n            }\n        }\n\n        if ($element->getIsDraft()) {\n            /** @var ElementInterface|DraftBehavior $element */\n            if (isset($this->_draftName)) {\n                $element->draftName = $this->_draftName;\n            }\n            if (isset($this->_notes)) {\n                $element->draftNotes = $this->_notes;\n            }\n        } elseif (isset($this->_notes)) {\n            $element->setRevisionNotes($this->_notes);\n        }\n\n        $scenario = $element->getScenario();\n        $element->setScenario(Element::SCENARIO_LIVE);\n        $element->setAttributes($this->_attributes);\n\n        if ($this->_slug !== null) {\n            $element->slug = $this->_slug;\n        }\n\n        $element->setScenario($scenario);\n\n        // Now that the element is fully configured, make sure the user can actually view it\n        if (!Craft::$app->getElements()->canView($element)) {\n            throw new ForbiddenHttpException('User not authorized to edit this element.');\n        }\n\n        // Set the custom field values\n        $element->setFieldValuesFromRequest($this->_fieldsLocation);\n    }\n\n    /**\n     * Returns whether an element can be saved by the given user.\n     *\n     * If the element is a provisional draft, the canonical element will be used instead.\n     *\n     * @param ElementInterface $element\n     * @param User $user\n     * @return bool\n     */\n    private function _canSave(ElementInterface $element, User $user): bool\n    {\n        if ($element->getIsRevision()) {\n            return false;\n        }\n\n        if ($element->isProvisionalDraft) {\n            $element = $element->getCanonical(true);\n        }\n\n        return Craft::$app->getElements()->canSave($element, $user);\n    }\n\n    /**\n     * Returns whether an unpublished draft can shed its draft status by the given user.\n     *\n     * @param ElementInterface $element\n     * @param User $user\n     * @return bool\n     */\n    private function _canApplyUnpublishedDraft(ElementInterface $element, User $user): bool\n    {\n        $fakeCanonical = clone $element;\n        $fakeCanonical->draftId = null;\n        return Craft::$app->getElements()->canSave($fakeCanonical, $user);\n    }\n\n    /**\n     * @throws Throwable\n     * @throws ServerErrorHttpException\n     */\n    private function _asSuccess(string $message, ElementInterface $element, array $data = [], bool $addAnother = false): Response\n    {\n        /** @var Element $element */\n        // Don't call asModelSuccess() here so we can avoid including custom fields in the element data\n        $data += [\n            'modelName' => 'element',\n            'element' => $element->toArray($element->attributes()),\n        ];\n        $response = $this->asSuccess($message, $data, $this->getPostedRedirectUrl($element), [\n            'details' => !$element->dateDeleted ? Cp::elementHtml($element) : null,\n        ]);\n\n        if ($addAnother && $this->_addAnother) {\n            $user = static::currentUser();\n            $newElement = $element->createAnother();\n\n            if (!$newElement || !Craft::$app->getElements()->canSave($newElement, $user)) {\n                throw new ServerErrorHttpException('Unable to create a new element.');\n            }\n\n            if (!$newElement->slug) {\n                $newElement->slug = ElementHelper::tempSlug();\n            }\n\n            $newElement->setScenario(Element::SCENARIO_ESSENTIALS);\n\n            if (!Craft::$app->getDrafts()->saveElementAsDraft($newElement, $user->id, null, null, false)) {\n                throw new ServerErrorHttpException(sprintf('Unable to create a new element: %s', implode(', ', $element->getErrorSummary(true))));\n            }\n\n            $url = $newElement->getCpEditUrl();\n\n            if ($url) {\n                $url = UrlHelper::urlWithParams($url, ['fresh' => 1]);\n            } else {\n                $url = UrlHelper::actionUrl('elements/edit', [\n                    'draftId' => $newElement->draftId,\n                    'siteId' => $newElement->siteId,\n                    'fresh' => 1,\n                ]);\n            }\n\n            $response->redirect($url);\n        }\n\n        return $response;\n    }\n\n    private function _asFailure(ElementInterface $element, string $message): ?Response\n    {\n        $data = [\n            'modelName' => 'element',\n            'element' => $element->toArray($element->attributes()),\n            'errors' => $element->getErrors(),\n            'errorSummary' => $this->_errorSummary($element),\n        ];\n\n        return $this->asFailure($message, $data, ['element' => $element]);\n    }\n}\n"], "fixing_code": ["# Release Notes for Craft CMS 4\n\n## Unreleased\n\n- Date fields with \u201cShow Time Zone\u201d enabled will now remember IANA-formatted time zones set via GraphQL. ([#13893](https://github.com/craftcms/cms/issues/13893))\n- Added `craft\\gql\\types\\DateTime::$setToSystemTimeZone`.\n- `craft\\gql\\types\\DateTime` now supports JSON-encoded objects with `date`, `time`, and `timezone` keys.\n- `craft\\web\\Response::setCacheHeaders()` now includes the `public` directive in the `Cache-Control` header. ([#13922](https://github.com/craftcms/cms/pull/13922))\n- Fixed a bug where <kbd>\u2191</kbd> and <kbd>\u2193</kbd> key presses would set focus to disabled menu options. ([#13911](https://github.com/craftcms/cms/issues/13911))\n- Fixed a bug where elements\u2019 `localized` GraphQL field wasn\u2019t returning any results for drafts or revisions. ([#13924](https://github.com/craftcms/cms/issues/13924))\n- Fixed a bug where dropdown option labels within Table fields weren\u2019t getting translated. ([#13914](https://github.com/craftcms/cms/issues/13914))\n- Fixed a bug where \u201cUpdating search indexes\u201d jobs were getting queued for Matrix block revisions. ([#13917](https://github.com/craftcms/cms/issues/13917))\n- Fixed a bug where control panel resources weren\u2019t getting published on demand. ([#13935](https://github.com/craftcms/cms/issues/13935))\n- Fixed privilege escalation vulnerabilities.\n\n## 4.5.10 - 2023-11-07\n\n- Added the `db/drop-table-prefix` command.\n- Top-level disabled related/nested elements are now included in \u201cExtended\u201d element exports. ([#13496](https://github.com/craftcms/cms/issues/13496))\n- Related element validation is no longer recursive. ([#13904](https://github.com/craftcms/cms/issues/13904))\n- Addresses\u2019 owner elements are now automatically set on them during initialization, if they were queried with the `owner` address query param.\n- Entry Title fields are no longer shown when \u201cShow the Title field\u201d is disabled and there\u2019s a validation error on the `title` attribute. ([#13876](https://github.com/craftcms/cms/issues/13876))\n- Improved the reliability of image dimension detection. ([#13886](https://github.com/craftcms/cms/pull/13886))\n- The default backup command for PostgreSQL no longer passes in `--column-inserts` to `pg_dump`.\n- Log contexts now include the environment name. ([#13882](https://github.com/craftcms/cms/pull/13882))\n- Added `craft\\web\\AssetManager::$cacheSourcePaths`.\n- Fixed a bug where disclosure menus could be positioned off-screen on mobile.\n- Fixed a bug where element edit pages could show a context menu when it wasn\u2019t necessary.\n- Fixed a bug where the \u201cDelete entry for this site\u201d action wasn\u2019t deleting the canonical entry for the selected site, when editing a provisional draft.\n- Fixed an error that occurred when cropping an image that was missing its dimension info. ([#13884](https://github.com/craftcms/cms/issues/13884))\n- Fixed an error that occurred if a filesystem didn\u2019t have any settings. ([#13883](https://github.com/craftcms/cms/pull/13883))\n- Fixed a bug where related element validation wansn\u2019t ensuring that related elements were loaded in the same site as the source element when possible. ([#13907](https://github.com/craftcms/cms/issues/13907))\n- Fixed a bug where sites weren\u2019t always getting queried in the same order, if multiple sites\u2019 `sortOrder` values were the same. ([#13896](https://github.com/craftcms/cms/issues/13896))\n\n## 4.5.9 - 2023-10-23\n\n- Fixed a bug where it was possible to change the status for entries that didn\u2019t show the Status field, via bulk editing. ([#13854](https://github.com/craftcms/cms/issues/13854))\n- Fixed a PHP error that could occur when editing elements via slideouts. ([#13867](https://github.com/craftcms/cms/issues/13867))\n- Fixed an error that could occur if no `storage/` folder existed.\n\n## 4.5.8 - 2023-10-20\n\n- Improved the styling and accessibility of revision pages. ([#13857](https://github.com/craftcms/cms/pull/13857), [#13850](https://github.com/craftcms/cms/issues/13850))\n- Added the `focalPoint` argument to asset save mutations. ([#13846](https://github.com/craftcms/cms/discussions/13846))\n- The `up` command now accepts a `--no-backup` option.\n- `{% cache %}` tags now store any `<meta>` tags registered with `yii\\web\\View::registerMetaTag()`. ([#13832](https://github.com/craftcms/cms/issues/13832))\n- Added `craft\\errors\\ExitException`.\n- Added `craft\\web\\View::startMetaTagBuffer()`.\n- Added `craft\\web\\View::clearMetaTagBuffer()`.\n- Added support for modifying the application config via a global `craft_modify_app_config()` function. ([#13855](https://github.com/craftcms/cms/pull/13855))\n- Fixed a bug where `{% exit %}` tags without a status code weren\u2019t outputting any HTML that had already been output in the template. ([#13848](https://github.com/craftcms/cms/discussions/13848))\n- Fixed a bug where it wasn\u2019t possible to Ctrl/Command-click on multiple elements to select them. ([#13853](https://github.com/craftcms/cms/issues/13853))\n\n## 4.5.7 - 2023-10-17\n\n- Field containers are no longer focusable unless a corresponding validation message is clicked on. ([#13782](https://github.com/craftcms/cms/issues/13782))\n- Improved element save performance.\n- Added `pgpassword` and `pwd` to the list of keywords that Craft will look for when determining whether a value is sensitive and should be redacted from logs, etc.\n- Added `craft\\events\\DefineCompatibleFieldTypesEvent`.\n- Added `craft\\services\\Fields::EVENT_DEFINE_COMPATIBLE_FIELD_TYPES`. ([#13793](https://github.com/craftcms/cms/discussions/13793))\n- Added `craft\\web\\assets\\inputmask\\InputmaskAsset`.\n- `craft\\web\\Request::accepts()` now supports wildcard (e.g. `application/*`). ([#13759](https://github.com/craftcms/cms/issues/13759))\n- `Craft.ElementEditor` instances are now configured with an `elementId` setting, which is kept up-to-date when a provisional draft is created. ([#13795](https://github.com/craftcms/cms/discussions/13795))\n- Added `Garnish.isPrimaryClick()`.\n- Fixed a bug where relational fields\u2019 element selector modals weren\u2019t always getting set to the correct site per the field\u2019s \u201cRelate entries from a specific site?\u201d setting. ([#13750](https://github.com/craftcms/cms/issues/13750))\n- Fixed a bug where Dropdown fields weren\u2019t visible when viewing revisions and other static forms. ([#13753](https://github.com/craftcms/cms/issues/13753), [craftcms/commerce#3270](https://github.com/craftcms/commerce/issues/3270))\n- Fixed a bug where the `defaultDirMode` config setting wasn\u2019t being respected when the `storage/runtime/` and `storage/logs/` folders were created. ([#13756](https://github.com/craftcms/cms/issues/13756))\n- Fixed a bug where the \u201cSave and continue editing\u201d action wasn\u2019t working on Edit User pages if they contained a Money field. ([#13760](https://github.com/craftcms/cms/issues/13760))\n- Fixed a bug where relational fields\u2019 validation messages weren\u2019t using the actual field name. ([#13807](https://github.com/craftcms/cms/issues/13807))\n- Fixed a bug where element editor slideouts were appearing behind element selector modals within Live Preview. ([#13798](https://github.com/craftcms/cms/issues/13798))\n- Fixed a bug where element URIs weren\u2019t getting updated for propagated sites automatically. ([#13812](https://github.com/craftcms/cms/issues/13812))\n- Fixed a bug where dropdown input labels could overflow out of their containers. ([#13817](https://github.com/craftcms/cms/issues/13817))\n- Fixed a bug where the `transformGifs` and `transformSvgs` config settings weren\u2019t always being respected when using `@transform` GraphQL directives. ([#13808](https://github.com/craftcms/cms/issues/13808))\n- Fixed a bug where Composer operations were sorting `require` packages differently than how Composer does it natively, when `config.sort-packages` was set to `true`. ([#13806](https://github.com/craftcms/cms/issues/13806))\n- Fixed a MySQL error that could occur when creating a Plain Text field with a high charcter limit. ([#13781](https://github.com/craftcms/cms/pull/13781))\n- Fixed a bug where entries weren\u2019t always being treated as live for View and Preview buttons, when editing a non-primary site. ([#13746](https://github.com/craftcms/cms/issues/13746))\n- Fixed a bug where Ctrl-clicks were being treated as primary clicks in some browsers. ([#13823](https://github.com/craftcms/cms/issues/13823))\n- Fixed a bug where some language options were showing \u201cfalse\u201d hints. ([#13837](https://github.com/craftcms/cms/issues/13837))\n- Fixed a bug where Craft was tracking changes to elements when they were being resaved. ([#13761](https://github.com/craftcms/cms/issues/13761))\n- Fixed a bug where sensitive keywords weren\u2019t getting redacted from log contexts.\n- Fixed RCE vulnerabilities.\n\n## 4.5.6.1 - 2023-09-27\n\n- Crossdomain JavaScript resources are now loaded via a proxy action.\n- Fixed JavaScript errors that could occur after loading new UI components over Ajax. ([#13751](https://github.com/craftcms/cms/issues/13751))\n\n## 4.5.6 - 2023-09-26\n\n- When slideouts are opened within Live Preview, they now slide up over the editor pane, rather than covering the preview pane. ([#13739](https://github.com/craftcms/cms/pull/13739))\n- Cross-site validation now only involves fields which were actually modified in the element save. ([#13675](https://github.com/craftcms/cms/discussions/13675))\n- Row headings within Table fields now get statically translated. ([#13703](https://github.com/craftcms/cms/discussions/13703))\n- Element condition settings within field layout components now display a warning if the `autosaveDrafts` config setting is disabled. ([#12348](https://github.com/craftcms/cms/issues/12348))\n- Added the `resave/addresses` command. ([#13720](https://github.com/craftcms/cms/discussions/13720))\n- The `resave/matrix-blocks` command now supports an `--owner-id` option.\n- Added `craft\\helpers\\App::phpExecutable()`.\n- `craft\\helpers\\Component::createComponent()` now filters out `as X` and `on X` keys from the component config.\n- `craft\\services\\Announcements::push()` now has an `$adminsOnly` argument. ([#13728](https://github.com/craftcms/cms/discussions/13728))\n- `Craft.appendHeadHtml()` and `appendBodyHtml()` now load external scripts asynchronously, and return promises.\n- Improved the reliability of Composer operations when PHP is running via FastCGI. ([#13681](https://github.com/craftcms/cms/issues/13681))\n- Fixed a bug where it wasn\u2019t always possible to create new entries from custom sources which were limited to one section.\n- Fixed a bug where relational fields weren\u2019t factoring in cross-site elements when enforcing their \u201cMin Relations\u201d, \u201cMax Relations\u201d, and \u201cValidate related entries\u201d settings. ([#13699](https://github.com/craftcms/cms/issues/13699))\n- Fixed a bug where pagination wasn\u2019t working for admin tables, if the `onQueryParams` callback method wasn\u2019t set. ([#13677](https://github.com/craftcms/cms/issues/13677))\n- Fixed a bug where relations within Matrix blocks weren\u2019t getting restored when restoring a revision\u2019s content. ([#13626](https://github.com/craftcms/cms/issues/13626))\n- Fixed a bug where the filesystem and volume-creation slideouts could keep reappearing if canceled. ([#13707](https://github.com/craftcms/cms/issues/13707))\n- Fixed an error that could occur when reattempting to update to Craft 4.5. ([#13714](https://github.com/craftcms/cms/issues/13714))\n- Fixed a bug where date and time inputs could be parsed incorrectly, if the user\u2019s formatting locale wasn\u2019t explicitly set, or it changed between page load and form submit. ([#13731](https://github.com/craftcms/cms/issues/13731))\n- Fixed JavaScript errors that could occur when control panel resources were being loaded from a different domain. ([#13715](https://github.com/craftcms/cms/issues/13715))\n- Fixed a PHP error that occurred if the `CRAFT_DOTENV_PATH` environment variable was set, or a console command was executed with the `--dotenvPath` option. ([#13725](https://github.com/craftcms/cms/issues/13725))\n- Fixed a bug where long element titles weren\u2019t always getting truncated in the control panel. ([#13718](https://github.com/craftcms/cms/issues/13718))\n- Fixed a bug where checkboxes could be preselected if they had an empty value. ([#13710](https://github.com/craftcms/cms/issues/13710))\n- Fixed a bug where links in validation summaries weren\u2019t working if the offending field was in a collapsed Matrix block. ([#13708](https://github.com/craftcms/cms/issues/13708))\n- Fixed a bug where cross-site validation could apply even if `craft\\services\\Elements::saveElement()` was called with `$runValidation` set to `false`.\n- Fixed some wonky scrolling behavior on pages where the details pane was shorter than the content pane. ([#13637](https://github.com/craftcms/cms/issues/13637))\n- Fixed a division by zero error. ([#13712](https://github.com/craftcms/cms/issues/13712))\n- Fixed an RCE vulnerability.\n\n## 4.5.5 - 2023-09-14\n\n- Added the `maxGraphqlBatchSize` config setting. ([#13693](https://github.com/craftcms/cms/issues/13693))\n- Fixed a bug where page sidebars and detail panes weren\u2019t scrolling properly if their height was greater than the main content pane height. ([#13637](https://github.com/craftcms/cms/issues/13637))\n- Fixed an error that could occur when changing a field\u2019s type, if a backup table needed to be created to store the old field values. ([#13669](https://github.com/craftcms/cms/issues/13669))\n- Fixed a bug where it wasn\u2019t possible to save blank Dropdown values. ([#13695](https://github.com/craftcms/cms/issues/13695))\n\n## 4.5.4 - 2023-09-12\n\n- Added the `@stripTags` and `@trim` GraphQL directives. ([#9971](https://github.com/craftcms/cms/discussions/9971))\n- Added `SK` to the list of keywords that Craft will look for when determining whether a value is sensitive and should be redacted from logs, etc. ([#3619](https://github.com/craftcms/cms/issues/3619))\n- Improved the scrolling behavior for page sidebars and detail panes. ([#13637](https://github.com/craftcms/cms/issues/13637))\n- Filesystem edit pages now have a \u201cSave and continue editing\u201d alternative submit action, and the <kbd>Command</kbd>/<kbd>Ctrl</kbd> + <kbd>S</kbd> keyboard shortcut now redirects back to the edit page. ([#13658](https://github.com/craftcms/cms/pull/13658)) \n- Attribute labels are no longer surrounded by asterisks for front-end validation messages. ([#13640](https://github.com/craftcms/cms/issues/13640))\n- The `|replace` Twig filter now has a `regex` argument, which can be set to `false` to disable regular expression parsing. ([#13642](https://github.com/craftcms/cms/discussions/13642))\n- Added `craft\\events\\DefineUserGroupsEvent`.\n- Added `craft\\services\\Users::EVENT_DEFINE_DEFAULT_USER_GROUPS`. ([#12283](https://github.com/craftcms/cms/issues/12283))\n- Added `craft\\services\\Users::getDefaultUserGroups()`.\n- `craft\\events\\UserAssignGroupEvent` now extends `DefineUserGroupsEvent`, giving it a new `$userGroups` property.\n- `craft\\helpers\\DateTimeHelper::toDateTime()` now supports `DateTimeImmutable` values. ([#13656](https://github.com/craftcms/cms/issues/13656))\n- `craft\\web\\Response::setCacheHeaders()` no longer includes `public` in the `Cache-Control` header when `$overwrite` is `false`. ([#13676](https://github.com/craftcms/cms/issues/13676))\n- Deprecated `craft\\events\\UserAssignGroupEvent`. `DefineUserGroupsEvent` should be used instead.\n- Fixed a bug where the \u201cActive Trials\u201d section in the Plugin Store cart modal wasn\u2019t listing plugins in trial. ([#13661](https://github.com/craftcms/cms/issues/13661))\n- Fixed a bug where changed fields weren\u2019t being tracked properly when applying a draft for a multi-site entry.\n- `craft\\services\\Elements::duplicateElement()` now supports passing a `siteAttributes` array to the `$attributes` argument, for setting site-specific attributes.\n- Fixed an error that could occur when executing a GraphQL query with fragments. ([#13622](https://github.com/craftcms/cms/issues/13622))\n- Fixed a bug where addresses queried via GraphQL had a `photo` field.\n- Fixed a bug where boolean environment variables weren\u2019t always getting the correct value indicators within Selectize fields. ([#13613](https://github.com/craftcms/cms/issues/13613))\n- Fixed a bug where some system icons were getting black backgrounds when displayed within Vue apps. ([#13632](https://github.com/craftcms/cms/issues/13632))\n- Fixed a bug where the user and address field layouts were getting new UUIDs each time they were saved. ([#13588](https://github.com/craftcms/cms/issues/13588))\n- Fixed an error that could occur if a Money field was set to an array without a `value` key. ([#13648](https://github.com/craftcms/cms/pull/13648))\n- Fixed a bug where relations weren\u2019t getting restored when restoring a revision\u2019s content. ([#13626](https://github.com/craftcms/cms/issues/13626))\n- Fixed a bug where \u201cEntry Type\u201d fields were showing `typeId` labels for admin users with \u201cShow field handles in edit forms\u201d enabled. ([#13627](https://github.com/craftcms/cms/issues/13627))\n- Fixed a bug where Lightswitch fields with only one label weren\u2019t getting the correct padding on the unlabelled side of the container. ([#13629](https://github.com/craftcms/cms/issues/13629))\n- Fixed a bug where the `transformGifs` and `transformSvgs` config settings weren\u2019t always being respected. ([#13624](https://github.com/craftcms/cms/issues/13624), [#13635](https://github.com/craftcms/cms/issues/13635))\n- Fixed a bug where filesystems weren\u2019t requiring the \u201cBase URL\u201d setting to be set. ([#13657](https://github.com/craftcms/cms/pull/13657))\n- Fixed a bug where applying a draft could redirect to the \u201cCurrent\u201d revision on a different site, if a new site had been added on the draft. ([#13668](https://github.com/craftcms/cms/pull/13668))\n- Fixed an error that could occur when changing a field\u2019s type, if a backup table needed to be created to store the old field values. ([#13669](https://github.com/craftcms/cms/issues/13669))\n- Fixed a bug where Matrix blocks that were initially created for a newly-added site within a draft could be lost when applying the draft. ([#13670](https://github.com/craftcms/cms/pull/13670))\n- Fixed a bug where `fill` transform properties weren\u2019t being passed along by `craft\\elements\\Asset::getUrlsBySize()` and `getSrcset()`. ([#13650](https://github.com/craftcms/cms/issues/13650))\n- Fixed a bug where SVG asset icons weren\u2019t visible in Safari. ([#13685](https://github.com/craftcms/cms/issues/13685))\n- Fixed two RCE vulnerabilities.\n\n## 4.5.3 - 2023-08-29\n\n- Fixed a bug where custom fields could be marked as changed within element editor slideouts, if they modified their input values on initialization. ([craftcms/ckeditor#128](https://github.com/craftcms/ckeditor/issues/128))\n- Fixed a bug where elements were getting saved a second time after being converted to a provisional draft within a slideout. ([#13604](https://github.com/craftcms/cms/issues/13604))\n- Fixed a JavaScript error. ([#13605](https://github.com/craftcms/cms/issues/13605))\n- Fixed support for storing PHP session info in the database on PostgreSQL.\n- Fixed a bug where search inputs within element selector modals weren\u2019t getting focus rings.\n- Fixed a bug where boolean menu inputs were initially treating `null` values as `true`.\n- Fixed a bug where boolean menu inputs weren\u2019t toggling other fields. ([#13613](https://github.com/craftcms/cms/issues/13613))\n- Fixed a bug where `Craft.namespaceId()` wasn\u2019t working properly if the namespace ended in a `]` character.\n- Fixed a bug where the `|replace` Twig filter wasn\u2019t identifying regular expressions that contained escaped slashes. ([#13618](https://github.com/craftcms/cms/issues/13618))\n- Fixed a bug where entries that were cloned from a provisional draft weren\u2019t getting propagated to other sites initially. ([#13599](https://github.com/craftcms/cms/issues/13599))\n- Fixed an error that could occur when cloning a multi-site provisional draft that contained nested Matrix/Neo/Super Table blocks.\n\n## 4.5.2 - 2023-08-24\n\n- `craft\\helpers\\UrlHelper::buildQuery()` is no longer deprecated. ([#12796](https://github.com/craftcms/cms/issues/12796))\n- Fixed a bug where control panel notifications weren\u2019t always closing automatically if they contained interactive elements. ([#13591](https://github.com/craftcms/cms/issues/13591))\n- Fixed a bug where default user avatars were getting black backgrounds when displayed within Vue apps. ([#13597](https://github.com/craftcms/cms/issues/13597))\n- Fixed a bug where the Username and Email fields weren\u2019t required for public registrations forms, if \u201cDeactivate users by default\u201d was enabled. ([#13596](https://github.com/craftcms/cms/issues/13596))\n- Fixed a bug where switching sites when editing a global site wasn\u2019t working. ([#12796](https://github.com/craftcms/cms/issues/12796), [#13603](https://github.com/craftcms/cms/issues/13603))\n- Fixed a bug where page shortcuts weren\u2019t working after a related element was saved via a slideout. ([#13601](https://github.com/craftcms/cms/issues/13601))\n\n## 4.5.1 - 2023-08-23\n\n- Control panel notifications no longer block page keyboard shortcuts. ([#13591](https://github.com/craftcms/cms/issues/13591))\n- `Garnish.uiLayerManager.addLayer()` now supports a `bubble` option, which allows non-matching keyboard shortcuts to bubble up to the parent layer.\n- Fixed an error that could occur when Craft was performing a Composer operation, if no `HOME` environment variable was set for PHP. ([#13590](https://github.com/craftcms/cms/issues/13590))\n- Fixed a bug where `craft\\fields\\Matrix::serializeValue()` was setting `fields` keys to a closure. ([#13592](https://github.com/craftcms/cms/issues/13592))\n- Fixed a bug where time values weren\u2019t saving properly for Greek locales. ([#9942](https://github.com/craftcms/cms/issues/9942))\n- Fixed a bug where the \u201cStatus\u201d lightswitch would always be enabled on edit pages for single-site elements. ([#13595](https://github.com/craftcms/cms/issues/13595))\n\n## 4.5.0 - 2023-08-22\n\n### Content Management\n- Entry and category edit pages now show other authors who are currently editing the same element. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Entry and category edit pages now display a notification when the element has been saved by another author. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Entry and category edit pages now display a validation error summary at the top of the page, including a mention of errors from other sites. ([#11569](https://github.com/craftcms/cms/issues/11569), [#12125](https://github.com/craftcms/cms/pull/12125))\n- Table fields can now have a \u201cRow heading\u201d column. ([#13231](https://github.com/craftcms/cms/pull/13231))\n- Table fields now have a \u201cStatic Rows\u201d setting. ([#13231](https://github.com/craftcms/cms/pull/13231))\n- Table fields no longer show a heading row, if all heading values are blank. ([#13231](https://github.com/craftcms/cms/pull/13231))\n- Element slideouts now show their sidebar content full-screen for elements without a field layout, rather than having an empty body. ([#13056](https://github.com/craftcms/cms/pull/13056), [#13053](https://github.com/craftcms/cms/issues/13053))\n- Relational fields no longer track the previously-selected element(s) when something outside the field is clicked on. ([#13123](https://github.com/craftcms/cms/issues/13123))\n- Element indexes now use field layouts\u2019 overridden field labels, if all field layouts associated with an element source use the same label. ([#8903](https://github.com/craftcms/cms/discussions/8903))\n- Element indexes now track souces\u2019 filters in the URL, so they can be sharable and persisted when navigating back to the index page via the browser history. ([#13499](https://github.com/craftcms/cms/pull/13499))\n- Users\u2019 default thumbnails are now the user initials over a unique color gradient. ([#13511](https://github.com/craftcms/cms/pull/13511))\n- Improved the styling and max height of Selectize inputs. ([#13065](https://github.com/craftcms/cms/discussions/13065), [#13176](https://github.com/craftcms/cms/pull/13176))\n- Selectize inputs now support click-and-drag selection. ([#13273](https://github.com/craftcms/cms/discussions/13273))\n- Selectize single-select inputs now automatically select the current value on focus. ([#13273](https://github.com/craftcms/cms/discussions/13273))\n- It\u2019s now possible to create new entries from entry select modals when a custom source is selected, if the source is configured to only show entries from one section. ([#11499](https://github.com/craftcms/cms/discussions/11499))\n- The Entries index page now shows a primary \u201cNew entry\u201d button when a custom source is selected, if the source is configured to only show entries from one section. ([#13390](https://github.com/craftcms/cms/discussions/13390))\n- Invalid Dropdown fields now automatically select their default option and get marked as changed (if they have a default option). ([#13540](https://github.com/craftcms/cms/pull/13540))\n\n### Accessibility\n- Image assets\u2019 thumbnails and `<img>` tags generated via `craft\\element\\Asset::getImg()` no longer use the assets\u2019 titles as `alt` fallback values. ([#12854](https://github.com/craftcms/cms/pull/12854))\n- Element index pages now have visually-hidden \u201cSources\u201d headings for screen readers. ([#12961](https://github.com/craftcms/cms/pull/12961))\n- Element metadata fields now have visually-hidden \u201cMetadata\u201d headings for screen readers. ([#12961](https://github.com/craftcms/cms/pull/12961))\n- Structure elements within element indexes now convey their levels to screen readers. ([#13020](https://github.com/craftcms/cms/pull/13020))\n- Non-image asset thumbnails in the control panel now have `alt` attributes set to the file extension. ([#12724](https://github.com/craftcms/cms/pull/12724))\n- Improved copy-text buttons for screen readers. ([#13073](https://github.com/craftcms/cms/pull/13073))\n- Improved the contrast of asset file type icons. ([#13262](https://github.com/craftcms/cms/pull/13262))\n\n### Administration\n- Added the \u201cSlug Translation Method\u201d setting to entry types. ([#8962](https://github.com/craftcms/cms/discussions/8962), [#13291](https://github.com/craftcms/cms/pull/13291))\n- Added the \u201cShow the Status field\u201d setting to entry types. ([#12837](https://github.com/craftcms/cms/discussions/12837), [#13265](https://github.com/craftcms/cms/pull/13265))\n- Added the `setup/cloud` command, which prepares a Craft install to be deployed to Craft Cloud.\n- Added the `setup/message-tables` command, which can be run to set the project up for database-stored static translations via [DbMessageSource](https://www.yiiframework.com/doc/api/2.0/yii-i18n-dbmessagesource). ([#13542](https://github.com/craftcms/cms/pull/13542))\n- Entry types created via the `entrify/global-set` command now have \u201cShow the Status field\u201d disabled by default. ([#12837](https://github.com/craftcms/cms/discussions/12837))\n- Added the `defaultCountryCode` config setting. ([#13478](https://github.com/craftcms/cms/discussions/13478))\n- Custom element sources can now be configured to only appear for certain sites. ([#13344](https://github.com/craftcms/cms/discussions/13344))\n- The \u201cMy Account\u201d page no longer shows a \u201cRequire a password reset on next login\u201d checkbox.\n- The Asset Indexes utility no longer shows the \u201cCache remote images\u201d option on ephemeral environments. ([#13202](https://github.com/craftcms/cms/issues/13202))\n- It\u2019s now possible to configure UK addresses to show a \u201cCounty\u201d field. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- The \u201cLogin Page Logo\u201d and \u201cSite Icon\u201d general settings\u2019 image previews now have checkered backgrounds. ([#13210](https://github.com/craftcms/cms/discussions/13210), [#13229](https://github.com/craftcms/cms/pull/13229))\n- Empty field layout tabs are no longer pruned out. ([#13132](https://github.com/craftcms/cms/issues/13132))\n- `active`, `addresses`, `admin`, `email`, `friendlyName`, `locked`, `name`, `password`, `pending`, `suspended`, and `username` are now reserved user field handles. ([#13579](https://github.com/craftcms/cms/issues/13579))\n\n### Development\n- Added a new `_globals` global Twig variable for front-end templates, which can be used to store custom values in a global scope. ([#13050](https://github.com/craftcms/cms/pull/13050), [#12951](https://github.com/craftcms/cms/discussions/12951))\n- The `|replace` Twig filter now supports passing in a hash with regular expression keys. ([#12956](https://github.com/craftcms/cms/issues/12956))\n- `{% exit %}` tags now support passing a message after the status code. ([#13166](https://github.com/craftcms/cms/discussions/13166))\n- Built-in element types\u2019 GraphQL queries now support passing `null` to `relatedToAssets`, `relatedToEntries`, `relatedToUsers`, `relatedToCategories`, `relatedToTags`, and `relatedToAll` arguments. ([#7954](https://github.com/craftcms/cms/issues/7954))\n- Elements now include custom field values when being iterated over, and when being merged. ([#13009](https://github.com/craftcms/cms/issues/13009))\n- Dropdown and Radio Buttons fields now have a \u201cColumn Type\u201d setting, which will be set to `varchar` for existing fields, and defaults to \u201cAutomatic\u201d for new fields. ([#13025](https://github.com/craftcms/cms/pull/13025), [#12954](https://github.com/craftcms/cms/issues/12954))\n- Successful `users/login` JSON responses now include information about the logged-in user. ([#13374](https://github.com/craftcms/cms/discussions/13374))\n\n### Extensibility\n- Filesystem types can now register custom file uploaders. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- When applying a draft, the canonical elements\u2019 `getDirtyAttributes()` and `getDirtyFields()` methods now return the attribute names and field handles that were modified on the draft for save events. ([#12967](https://github.com/craftcms/cms/issues/12967))\n- Admin tables can be configured to pass custom query params to the data endpoint. ([#13416](https://github.com/craftcms/cms/pull/13416))\n- Admin tables can now be programatically reloaded. ([#13416](https://github.com/craftcms/cms/pull/13416))\n- Admin table properties are now reactive. ([#13558](https://github.com/craftcms/cms/pull/13558), [#13520](https://github.com/craftcms/cms/discussions/13520))\n- Native element sources can now define a `defaultFilter` key, which defines the default filter condition that should be applied when the source is selected. ([#13499](https://github.com/craftcms/cms/pull/13499))\n- Added `craft\\addresses\\SubdivisionRepository`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\base\\Element::showStatusField()`. ([#13265](https://github.com/craftcms/cms/pull/13265))\n- Added `craft\\base\\Element::thumbSvg()`. ([#13262](https://github.com/craftcms/cms/pull/13262))\n- Added `craft\\base\\ElementInterface::getIsSlugTranslatable()`.\n- Added `craft\\base\\ElementInterface::getSlugTranslationDescription()`.\n- Added `craft\\base\\ElementInterface::getSlugTranslationKey()`.\n- Added `craft\\base\\ElementInterface::getThumbHtml()`.\n- Added `craft\\base\\ElementInterface::modifyCustomSource()`.\n- Added `craft\\base\\ElementInterface::setDirtyFields()`.\n- Added `craft\\base\\ElementInterface::setFieldValueFromRequest()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\base\\FieldInterface::normalizeValueFromRequest()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\base\\FieldLayoutProviderInterface`. ([#13250](https://github.com/craftcms/cms/pull/13250))\n- Added `craft\\base\\FsInterface::getShowHasUrlSetting()`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\base\\FsInterface::getShowUrlSetting()`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\base\\FsTrait::$showHasUrlSetting`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\base\\FsTrait::$showUrlSetting`. ([#13224](https://github.com/craftcms/cms/pull/13224))\n- Added `craft\\behaviors\\EventBehavior`. ([#13502](https://github.com/craftcms/cms/discussions/13502))\n- Added `craft\\controllers\\AssetsControllerTrait`.\n- Added `craft\\elements\\db\\ElementQuery::EVENT_BEFORE_POPULATE_ELEMENT`.\n- Added `craft\\events\\AssetBundleEvent`.\n- Added `craft\\events\\DefineAddressSubdivisionsEvent`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\events\\MoveElementEvent::$action`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\events\\MoveElementEvent::$targetElementId`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\events\\MoveElementEvent::getTargetElement()`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\gql\\GqlEntityRegistry::getOrCreate()`. ([#13354](https://github.com/craftcms/cms/pull/13354))\n- Added `craft\\helpers\\Assets::iconSvg()`.\n- Added `craft\\helpers\\StringHelper::escapeShortcodes()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\helpers\\StringHelper::unescapeShortcodes()`. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Added `craft\\models\\FieldLayout::$provider`. ([#13250](https://github.com/craftcms/cms/pull/13250))\n- Added `craft\\services\\Addresses::$formatter`, which can be used to override the default address formatter. ([#13242](https://github.com/craftcms/cms/pull/13242), [#12615](https://github.com/craftcms/cms/discussions/12615))\n- Added `craft\\services\\Addresses::EVENT_DEFINE_ADDRESS_SUBDIVISIONS`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\services\\Addresses::defineAddressSubdivisions()`. ([#13361](https://github.com/craftcms/cms/pull/13361))\n- Added `craft\\services\\Elements::collectCacheInfoForElement()`.\n- Added `craft\\services\\Elements::getRecentActivity()`. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Added `craft\\services\\Elements::trackActivity()`. ([#13420](https://github.com/craftcms/cms/pull/13420))\n- Added `craft\\services\\ProjectConfig::$cacheDuration`. ([#13164](https://github.com/craftcms/cms/issues/13164))\n- Added `craft\\services\\Structures::ACTION_APPEND`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::ACTION_PLACE_AFTER`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::ACTION_PLACE_BEFORE`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::ACTION_PREPEND`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::EVENT_AFTER_INSERT_ELEMENT`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\services\\Structures::EVENT_BEFORE_INSERT_ELEMENT`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Added `craft\\web\\Controller::EVENT_DEFINE_BEHAVIORS`. ([#13477](https://github.com/craftcms/cms/pull/13477))\n- Added `craft\\web\\Controller::defineBehaviors()`. ([#13477](https://github.com/craftcms/cms/pull/13477))\n- Added `craft\\web\\CpScreenResponseBehavior::$errorSummary`, `errorSummary()`, and `errorSummaryTemplate()`. ([#12125](https://github.com/craftcms/cms/pull/12125))\n- Added `craft\\web\\CpScreenResponseBehavior::$pageSidebar`, `pageSidebar()`, and `pageSidebarTemplate()`. ([#13019](https://github.com/craftcms/cms/pull/13019), [#12795](https://github.com/craftcms/cms/issues/12795))\n- Added `craft\\web\\CpScreenResponseBehavior::$slideoutBodyClass`.\n- Added `craft\\web\\Response::$defaultFormatters`. ([#13541](https://github.com/craftcms/cms/pull/13541))\n- Added `craft\\web\\View::EVENT_AFTER_REGISTER_ASSET_BUNDLE`.\n- `craft\\elements\\actions\\NewChild` is no longer triggerable on elements that have a `data-disallow-new-children` attribute. ([#13539](https://github.com/craftcms/cms/discussions/13539))\n- `craft\\elements\\actions\\SetStatus` is no longer triggerable on elements that have a `data-disallow-status` attribute.\n- `craft\\helpers\\Cp::selectizeFieldHtml()`, `selectizeHtml()`, and `_includes/forms/selectize.twig` now support a `multi` param. ([#13176](https://github.com/craftcms/cms/pull/13176))\n- `craft\\helpers\\Typecast::properties()` now supports backed enum values. ([#13371](https://github.com/craftcms/cms/pull/13371))\n- `craft\\services\\Assets::getRootFolderByVolumeId()` now ensures the root folder actually exists, and caches its results internally, improving performance. ([#13297](https://github.com/craftcms/cms/issues/13297))\n- `craft\\services\\Assets::getThumbUrl()` now has an `$iconFallback` argument, which can be set to `false` to prevent a file icon URL from being returned as a fallback for assets that don\u2019t have image thumbnails.\n- `craft\\services\\Assets::getAllDescendantFolders()` now has an `$asTree` argument. ([#13535](https://github.com/craftcms/cms/discussions/13535))\n- `craft\\services\\Structures::EVENT_BEFORE_MOVE_ELEMENT` is now cancellable. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- `craft\\validators\\UniqueValidator` now supports setting an additional filter via the `filter` property. ([#12941](https://github.com/craftcms/cms/pull/12941))\n- `craft\\web\\Response::setCacheHeaders()` now has `$duration` and `$overwrite` arguments.\n- `craft\\web\\Response::setNoCacheHeaders()` now has an `$overwrite` argument.\n- `craft\\web\\UrlManager` no longer triggers its `EVENT_REGISTER_CP_URL_RULES` and `EVENT_REGISTER_SITE_URL_RULES` events until the request is ready to be routed, making it safe to call `UrlManager::addRules()` from plugin/module constructors. ([#13109](https://github.com/craftcms/cms/issues/13109))\n- Deprecated `craft\\base\\Element::EVENT_AFTER_MOVE_IN_STRUCTURE`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\base\\Element::EVENT_BEFORE_MOVE_IN_STRUCTURE`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\base\\Element::afterMoveInStructure()`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\base\\Element::beforeMoveInStructure()`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\events\\ElementStructureEvent`. ([#13429](https://github.com/craftcms/cms/pull/13429))\n- Deprecated `craft\\helpers\\ArrayHelper::firstKey()`. `array_key_first()` should be used instead.\n- Deprecated `craft\\helpers\\Assets::iconPath()`. `craft\\helpers\\Assets::iconSvg()` or `craft\\elements\\Asset::getThumbHtml()` should be used instead.\n- Deprecated `craft\\helpers\\Assets::iconUrl()`.\n- Deprecated `craft\\helpers\\UrlHelper::buildQuery()`. `http_build_query()` should be used instead.\n- Deprecated `craft\\services\\Volumes::ensureTopFolder()`. `craft\\services\\Assets::getRootFolderByVolumeId()` should be used instead.\n- Added `Craft.BaseUploader`. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- Added `Craft.createUploader()`. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- Added `Craft.registerUploaderClass()`. ([#13313](https://github.com/craftcms/cms/pull/13313))\n- Added `Craft.Tooltip`.\n\n### System\n- Added support for setting environmental values in a \u201csecrets\u201d PHP file, identified by a `CRAFT_SECRETS_PATH` environment variable. ([#13283](https://github.com/craftcms/cms/pull/13283))\n- Added support for the `CRAFT_LOG_ALLOW_LINE_BREAKS` environment variable. ([#13544](https://github.com/craftcms/cms/pull/13544))\n- All generated URL param characters are now properly encoded. ([#12796](https://github.com/craftcms/cms/issues/12796))\n- `migrate` commands besides `migrate/create` no longer create the migration directory if it doesn\u2019t exist yet. ([#12732](https://github.com/craftcms/cms/pull/12732))\n- When `content` table columns are resized, if any existing values are too long, all column data is now backed up into a new table, and the overflowing values are set to `null`. ([#13025](https://github.com/craftcms/cms/pull/13025))\n- When `content` table columns are renamed, if an existing column with the same name already exists, the original column data is now backed up into a new table and then deleted from the `content` table. ([#13025](https://github.com/craftcms/cms/pull/13025))\n- Plain Text and Table fields no longer convert emoji to shortcodes on PostgreSQL.\n- Reduced the size of control panel Ajax request headers.\n- Improved GraphQL performance. ([#13354](https://github.com/craftcms/cms/pull/13354))\n- Fixed an error that occurred when exporting assets, if a subfolder was selected. ([#13570](https://github.com/craftcms/cms/issues/13570))\n- Fixed a bug where icons within secondary buttons were illegible when active.\n- Fixed a bug where the `|replace` filter was treating search strings as regular expressions even if they were invalid. ([#12956](https://github.com/craftcms/cms/issues/12956))\n- Fixed a bug where user groups without \u201cEdit users\u201d permission were being granted \u201cAssign users to [group name]\u201d when upgrading to Craft 4.\n- Fixed a bug where keyboard shortcuts weren\u2019t getting reactivated when control panel notifications were dismissed. ([#13574](https://github.com/craftcms/cms/issues/13574))\n- Fixed a bug where Plain Text and Table fields were converting posted shortcode-looking strings to emoji. ([#12935](https://github.com/craftcms/cms/issues/12935))\n- Fixed a bug where `craft\\elements\\Asset::getUrl()` was returning invalid URLs for GIF and SVG assets within filesystems without base URLs, if the `transformGifs` or `transformSvgs` config settings were disabled. ([#13306](https://github.com/craftcms/cms/issues/13306))\n- Fixed a bug where the GraphQL API wasn\u2019t enforcing schema site selections for the requested site. ([#13346](https://github.com/craftcms/cms/pull/13346))\n- Fixed a bug where PM times were getting converted to AM for Greek locales. ([#9942](https://github.com/craftcms/cms/issues/9942))\n- Fixed a bug where <kbd>Command</kbd>/<kbd>Ctrl</kbd> + clicks on \u201cNew entry\u201d button menu options would open the Entries index page in a new tab, and redirect to the Edit Entry page in the current tab. ([#13550](https://github.com/craftcms/cms/issues/13550))\n- Fixed DB cache support for PostgreSQL.\n- Updated Yii to 2.0.48.1. ([#13445](https://github.com/craftcms/cms/pull/13445))\n- Loosened the Composer constraint to `^2.2.19`. ([#13396](https://github.com/craftcms/cms/discussions/13396))\n- Internal Composer operations now use a bundled `composer.phar` file, rather than Composer\u2019s PHP API. ([#13519](https://github.com/craftcms/cms/pull/13519))\n- Updated Selectize to 0.15.2. ([#13273](https://github.com/craftcms/cms/discussions/13273))\n\n## 4.4.17 - 2023-08-08\n\n- `meta.__names__` values in the project config are now updated throughout the process of applying incoming project config changes, rather than at the end of the request.\n- The `project-config/rebuild` command now rebuilds the `meta.__names__` array from scratch. ([#13456](https://github.com/craftcms/cms/issues/13456))\n- Fixed a bug where `Craft.BaseElementIndexView::this.canSelectElement()` wasn\u2019t getting applied for lazy-loaded elements.\n- Fixed a bug where setting an element query\u2019s `status` param to `archived` would always yield zero results. ([#13465](https://github.com/craftcms/cms/issues/13465))\n- Fixed a bug where `update` commands could fail on some environments.\n- Fixed a bug where element thumbnails weren\u2019t getting loaded for expanded relational field previews within element indexes.\n- Fixed an error that occurred when deleting a volume with a missing filesystem type.\n- Fixed a bug where Color field values were illegible within selected element index rows.\n- Fixed a bug where multi-site content could be overwritten when creating a draft. ([#13451](https://github.com/craftcms/cms/issues/13451))\n- Fixed a bug where some nested component names weren\u2019t getting deleted from the `meta.__names__` array in the project config. ([#13456](https://github.com/craftcms/cms/issues/13456))\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateInterval()` didn\u2019t support negative integers. ([#13463](https://github.com/craftcms/cms/pull/13463))\n- Fixed a bug where admin tables were initially displaying an empty results message rather than a loading spinner, when the initial data was loading via Ajax. ([#13459](https://github.com/craftcms/cms/issues/13459))\n- Fixed a bug where garbage collection could terminate prematurely if an exception was thrown when deleting a pending user. ([#13490](https://github.com/craftcms/cms/issues/13490))\n- Fixed an error that occurred if the `purify` Twig filter was applied to a `null` value. ([#13495](https://github.com/craftcms/cms/issues/13495))\n- Fixed an error that could occur if a console controller\u2019s `runAction()` method returned `null`.\n- Fixed a bug where image transforms weren\u2019t respecting their `format` settings. ([#13493](https://github.com/craftcms/cms/issues/13493))\n- Fixed an information disclosure vulnerability.\n\n## 4.4.16.1 - 2023-07-19\n\n- Fixed a bug where lightswitch inputs weren\u2019t always stretching to fit their labels, when there was enough space for it. ([#13452](https://github.com/craftcms/cms/issues/13452))\n\n## 4.4.16 - 2023-07-18\n\n- The \u201cAccess the control panel\u201d user permission now includes a warning that the permission grants view-only access to user data and most content.\n- Added info buttons to \u201cView entries\u201d, \u201cCreate entries\u201d, and \u201cSave entries\u201d user permissions, clarifying which actions they allow. ([#13375](https://github.com/craftcms/cms/discussions/13375))\n- Improved performance when loading users with eager-loaded `addresses`. ([#13400](https://github.com/craftcms/cms/issues/13400))\n- `createDraft` GraphQL mutations now support a `creatorId` argument. ([#13401](https://github.com/craftcms/cms/issues/13401))\n- Garbage collection now deletes entries for sites that aren\u2019t supported by their section. ([#13383](https://github.com/craftcms/cms/issues/13383))\n- Added `craft\\elements\\Address::setOwner()`.\n- `craft\\base\\ElementInterface::eagerLoadingMap()` can now include a `createElement` key in the returned array, which defines a target element factory function.\n- `craft\\base\\Element::toArray()` now clones custom field values, similar to `__get()`. ([#13392](https://github.com/craftcms/cms/issues/13392))\n- Fixed a bug where entry titles could overflow within Entries fields with \u201cMaintain hierarchy\u201d enabled. ([#13382](https://github.com/craftcms/cms/issues/13382))\n- Fixed a bug where batched jobs with a configured limit could be repeated endlessly. ([#13387](https://github.com/craftcms/cms/issues/13387))\n- Fixed an error that could occur if `null` was passed to `craft\\elements\\MatrixBlock::setOwner()`.\n- Fixed a bug where eager-loaded categories were always loaded in the structure-defined order, even if the Categories field didn\u2019t have \u201cMaintain hierarchy\u201d enabled. ([#13394](https://github.com/craftcms/cms/issues/13394))\n- Fixed a bug where time inputs weren\u2019t handling malformed values properly if ICU 72.1 was installed. ([#13381](https://github.com/craftcms/cms/issues/13381))\n- Fixed legacy Live Preview support.\n- Fixed a bug where lightswitch inputs could overflow. ([#13419](https://github.com/craftcms/cms/issues/13419))\n- Fixed a bug where Matrix field validation wasn\u2019t working properly if the field value was eager-loaded. ([#13421](https://github.com/craftcms/cms/issues/13421))\n- Fixed a bug where date and time inputs weren\u2019t always working properly on mobile. ([#13424](https://github.com/craftcms/cms/issues/13424))\n- Fixed an RCE vulnerability.\n\n## 4.4.15 - 2023-07-03 [CRITICAL]\n\n- The control panel footer now includes a message about active trials, with a link to purchase the licenses.\n- Tags fields now only show up to five suggestions. ([#13322](https://github.com/craftcms/cms/issues/13322))\n- The `up`, `migrate/up`, and `migrate/all` commands now revert any project config changes created by migrations on failure.\n- The `up`, `migrate/up`, and `migrate/all` commands now prompt to restore the backup created at the outset of the command, or recommend restoring a backup, on failure.\n- Added `craft\\console\\controllers\\BackupTrait::restore()`.\n- Added `craft\\helpers\\Component::cleanseConfig()`.\n- `craft\\log\\ContextProcessor::filterVars()` now supports filtering keys using dot notation and `!` negation. ([#13362](https://github.com/craftcms/cms/pull/13362))\n- Fixed an error that occurred when passing arguments to an element\u2019s `prev` and `next` fields via GraphQL. ([#13334](https://github.com/craftcms/cms/issues/13334))\n- Fixed a bug where Single entries weren\u2019t getting preloaded for template macros, if the template body wasn\u2018t rendered. ([#13312](https://github.com/craftcms/cms/issues/13312))\n- Fixed a bug where asset folders could get dynamically created for elements with temporary slugs. ([#13311](https://github.com/craftcms/cms/issues/13311))\n- Fixed a bug where Matrix fields with custom propagation methods were being marked as translatable if the rendered translation key was blank. ([#13329](https://github.com/craftcms/cms/issues/13329))\n- Fixed a bug where transformed images\u2019 `width` or `height` properties could be `null` if the transform didn\u2019t specify both dimensions. ([#13335](https://github.com/craftcms/cms/issues/13335))\n- Fixed a bug where heading UI elements within field layouts were getting a top border if they were preceded by conditionally-hidden fields. ([#13308](https://github.com/craftcms/cms/issues/13308))\n- Fixed a bug where new Single sections could get URIs filled in on form submit based on the section name, if the input was blank and hadn\u2019t been directly edited. ([#13350](https://github.com/craftcms/cms/issues/13350), [#13355](https://github.com/craftcms/cms/pull/13355))\n- Fixed a bug where it was possible to drag items beyond the normal page scroll limits. ([#13351](https://github.com/craftcms/cms/issues/13351))\n- Fixed two RCE vulnerabilities.\n\n## 4.4.14 - 2023-06-13\n\n- The `utils/fix-field-layout-uids` command now adds missing field layout component UUIDs.\n- The `_includes/forms/date` and `_includes/forms/time` templates now accept a `timeZone` variable.\n- Invalid utility URLs now redirect to the first permitted utility (besides \u201cUpdates\u201d). ([#13282](https://github.com/craftcms/cms/issues/13282))\n- Fixed an error that could occur when updating a plugin with the `craft update` command, if it provided a new migration but still had the same schema version.\n- Fixed an error that occurred when rendering editable tables with Date or Time columns. ([#13270](https://github.com/craftcms/cms/issues/13270))\n- Fixed a bug where CSS classes that contained a pseudo-selector weren\u2019t getting namespaced. ([#13251](https://github.com/craftcms/cms/pull/13251))\n- Fixed a JavaScript error that could occur when renaming assets without URLs. ([#13223](https://github.com/craftcms/cms/pull/13223))\n- Fixed a bug where `craft\\base\\Element::setFieldValuesFromRequest()` wasn\u2019t properly handling empty strings passed as the namespace. ([#13252](https://github.com/craftcms/cms/discussions/13252))\n- Fixed a styling issue with control panel notifications. ([#13258](https://github.com/craftcms/cms/pull/13258))\n- Fixed a bug where element thumbnails could stop getting loaded when quickly switching between element sources. ([#13253](https://github.com/craftcms/cms/issues/13253))\n- Fixed an error that occurred when uploading an asset with a filename over 232 characters long, directly to an Assets field. ([#13264](https://github.com/craftcms/cms/issues/13264))\n- Fixed an error that occurred when transforming an image with a filename over 232 characters long. ([#13266](https://github.com/craftcms/cms/pull/13266))\n- Fixed a SQL error that could occur when upgrading to 4.4 on PostgreSQL, if the database was converted from MySQL. ([#12855](https://github.com/craftcms/cms/issues/12855))\n- Fixed a bug where `craft\\db\\Query::collect()` was returning a `craft\\elements\\ElementCollection` instance.\n- Fixed a SQL error that could occur when upgrading to Craft 4 if any database tables had foreign keys to `entryversions` or other now-unused tables that are removed during the upgrade.\n- Fixed a bug where the `users/save-user` action wasn\u2019t including user details in successful responses. ([#13267](https://github.com/craftcms/cms/issues/13267))\n- Fixed a PHP error that occurred if an asset without a `dateModified` value was passed to `craft\\helpers\\Assets::revParams()`. ([#13268](https://github.com/craftcms/cms/pull/13268))\n- Fixed a bug where the Updates utility\u2019s heading wasn\u2019t reflecting updates that were blocked due to an expired plugin. ([#13274](https://github.com/craftcms/cms/issues/13274))\n- Fixed a bug where element deletion events weren\u2019t getting triggered when elements were hard-deleted from an element index. ([#13280](https://github.com/craftcms/cms/issues/13280))\n- Fixed a bug where dropdowns within editable tables had blank optgroup labels. ([#13298](https://github.com/craftcms/cms/issues/13298))\n- Fixed a bug where textual cells within editable tables would display `[object Object]` if an object was passed as their value. ([#13303](https://github.com/craftcms/cms/issues/13303))\n\n## 4.4.13 - 2023-05-24\n\n- Fixed a bug where asset sources weren\u2018t immediately showing a source path on a clear `localStorage` cache.\n- Fixed a JavaScript error that could occur when searching within an asset index, when there was no source path. ([#13241](https://github.com/craftcms/cms/issues/13241))\n- Fixed a bug where Date fields with \u201cShow Time Zone\u201d enabled were displaying their values in the system\u2019s time zone within element indexes. ([#13233](https://github.com/craftcms/cms/issues/13233))\n- Fixed a bug where the \u201cCancel\u201d buttons within Dashboard widgets\u2019 settings didn\u2019t do anything. ([#13239](https://github.com/craftcms/cms/issues/13239))\n\n## 4.4.12 - 2023-05-23\n\n- Asset indexes now remember their previously-selected source path. ([#13147](https://github.com/craftcms/cms/issues/13147))\n- Added the `enabledForSite` field for entries queried via GraphQL. ([#13214](https://github.com/craftcms/cms/pull/13214))\n- Added `craft\\base\\ElementInterface::sourcePath()`.\n- Improved `craft\\helpers\\FileHelper::getExtensionByMimeType()` for some ambiguous, web-friendly MIME types.\n- Fixed a bug where reverting an entry\u2019s content from a revision could omit some Matrix blocks.\n- Fixed an error that could occur when adding a new site to an entry which contained Matrix blocks, if the same site had been added and removed previously.\n- Fixed a bug where Matrix blocks nested within Neo or Super Table fields could be omitted when propagating an entry to a new site. ([#13207](https://github.com/craftcms/cms/issues/13207))\n- Fixed a bug where `craft\\web\\View::registerTwigExtension()` could throw an exception if Twig was already initialized. ([#13208](https://github.com/craftcms/cms/issues/13208))\n- Fixed a bug where entries mutated via GraphQL weren\u2019t becoming globally enabled if `enabled` was set to `true`. ([#13214](https://github.com/craftcms/cms/pull/13214))\n- Fixed a styling issue with \u201cPost Date\u201d and \u201cExpiry Date\u201d fields. ([#13216](https://github.com/craftcms/cms/issues/13216))\n- Removed the OAuth 2.0 Client library, as it\u2019s no longer used in core.\n- Fixed a bug where activation emails sent to newly-created users could link to the front-end site, if they were granted control panel access via a user group. ([#13204](https://github.com/craftcms/cms/issues/13204))\n- Fixed a bug where \u201cRequired\u201d lightswitch labels within field layout designers\u2019 field settings slideouts weren\u2019t getting translated. ([#13230](https://github.com/craftcms/cms/issues/13230))\n- Fixed a bug where Date fields could display the wrong date. ([#13233](https://github.com/craftcms/cms/issues/13233))\n- Deprecated the `Craft.startsWith()` JavaScript method. `String.prototype.startsWith()` should be used instead.\n- Fixed two XSS vulnerabilities.\n\n## 4.4.11 - 2023-05-15\n\n- Fixed a bug where Matrix blocks weren\u2019t getting propagated to newly-added sites for entries. ([#13181](https://github.com/craftcms/cms/issues/13181))\n- Fixed a SQL error that could occur when updating to Craft 4.4 on PostgreSQL. ([#13186](https://github.com/craftcms/cms/issues/13186))\n- Fixed a bug where `craft\\helpers\\StringHelper::isUtf8()` was unreliable.\n- Fixed a styling issue with Date fields. ([#13182](https://github.com/craftcms/cms/issues/13182))\n\n## 4.4.10.1 - 2023-05-10\n\n- Fixed a bug where it wasn\u2019t possible to add new Matrix blocks via the \u201cAdd a block\u201d menu. ([#13177](https://github.com/craftcms/cms/issues/13177))\n\n## 4.4.10 - 2023-05-09\n\n- PHP warnings and notices no longer halt execution when Dev Mode is disabled. ([#13164](https://github.com/craftcms/cms/issues/13164))\n- Fixed a \u201cDouble-instantiating a menu button on an element\u201d console warning that occurred on pages with Matrix fields. ([#6338](https://github.com/craftcms/cms/issues/6338))\n- Fixed a bug where Quick Post widget settings weren\u2019t filtering custom field options for the selected entry type.\n- Fixed a bug where Matrix blocks could get detached from entries when sections were enabled for a new site. ([#13155](https://github.com/craftcms/cms/issues/13155))\n- Fixed an error that could occur when entrifying a global set without a field layout. ([#13156](https://github.com/craftcms/cms/issues/13156))\n- Fixed a bug where Single entries\u2019 edit pages could have \u201cSave and add another\u201d actions. ([#13157](https://github.com/craftcms/cms/issues/13157))\n- Fixed styling issues with Date fields. ([#13167](https://github.com/craftcms/cms/issues/13167))\n- Fixed the vertical alignment of element labels. ([#13168](https://github.com/craftcms/cms/issues/13168))\n- Fixed a bug where the System Report utility could display MariaDB\u2019s MySQL-equivalent version, if it was listed first in the server version string.\n- Added `craft\\helpers\\ArrayHelper::containsRecursive()`.\n- `craft\\helpers\\App::normalizeVersion()` now returns the highest version found before distribution info.\n\n## 4.4.9 - 2023-05-02\n\n- Volumes no longer validate if their field layout contains a field called `extension`, `filename`, `height`, `kind`, `size`, or `width`.\n- It\u2019s now possible for plugins to register errors to entries\u2019 `typeId`, `parentId`, and `authorId` attributes. ([#13138](https://github.com/craftcms/cms/pull/13138))\n- Stack traces returned by `craft\\helpers\\App::backtrace()` now more closely resemble exception stack traces.\n- \u201cElement query executed before Craft is fully initialized\u201d warnings now include a stack trace.\n- Fixed a bug where queue-runner Ajax requests triggered on the front end weren\u2019t getting closed before running the queue, potentially causing long front-end load delays.\n- Fixed a bug where long element titles weren\u2019t wrapping. ([#13143](https://github.com/craftcms/cms/issues/13143))\n- Fixed a user enumeration timing attack vulnerability.\n- Fixed a SQL error that could occur when upgrading to Craft 4, if any `matrixblocks` table rows referenced nonexistent element IDs. ([#13121](https://github.com/craftcms/cms/issues/13121))\n- Fixed a SQL error that could occur when upgrading to Craft 4, if anything triggered an asset or volume query. ([#13130](https://github.com/craftcms/cms/issues/13130))\n- Fixed a SQL error that occurred when deleting a category group on PostgreSQL, when configured with a table prefix. ([#13127](https://github.com/craftcms/cms/issues/13127))\n- Fixed a bug where it was possible to query for elements with soft-deleted site IDs.\n- Fixed a JavaScript error that could occur on the control panel login form.\n\n## 4.4.8 - 2023-04-25\n\n- Category/tag/global set reference tags now map to entries, if no category groups/tag groups/global sets exist. ([#13082](https://github.com/craftcms/cms/issues/13082))\n- HTML Purifier now allows `data-oembed-url` attributes on `div` tags. ([craftcms/ckeditor#80](https://github.com/craftcms/ckeditor/issues/80))\n- Added `craft\\queue\\Queue::EVENT_AFTER_EXEC_AND_RELEASE`. ([#13096](https://github.com/craftcms/cms/issues/13096))\n- `craft\\services\\Elements::propagateElements()` now returns the element in the target site.\n- A globally-defined element thumb loader is now available in the control panel via `Craft.cp.elementThumbLoader`.\n- Fixed a bug where it was possible to select a disallowed volume as the Default Asset Location in Assets field settings. ([#13072](https://github.com/craftcms/cms/issues/13072))\n- Fixed a bug where it was possible to upload files to Assets fields outside of the allowed volumes, if the Default Upload Location was set to a disallowed volume. ([#13072](https://github.com/craftcms/cms/issues/13072))\n- Fixed an error that could occur if a Plain Text field had over 1,000,000 bytes. ([#13083](https://github.com/craftcms/cms/issues/13083))\n- Fixed a bug where relational field values weren\u2019t yielding any results for event handlers immediately after a draft had been merged. ([#13087](https://github.com/craftcms/cms/issues/13087))\n- Fixed a bug where element labels could bleed out of their container. ([#13099](https://github.com/craftcms/cms/issues/13099))\n- Fixed an error that occurred if `yii\\web\\UrlManager::addRules()` was called on a console request. ([#13109](https://github.com/craftcms/cms/issues/13109))\n- Fixed a bug where it was possible to select the current folder as the target when moving a volume folder, resulting in the folder and its contents being lost. ([#13118](https://github.com/craftcms/cms/issues/13118))\n- Fixed an error that could occur when running tests. ([#13076](https://github.com/craftcms/cms/issues/13076))\n- Fixed an error that occurred when sending the activation email for a new user, if there were any validation errors due to new group assignments. ([#13060](https://github.com/craftcms/cms/issues/13060))\n- Fixed a bug where the \u201cSend an activation email now\u201d user account checkbox was losing its value if there were any validation errors.\n- Fixed an error that could occur when creating a database backup on MySQL and MariaDB. ([#12996](https://github.com/craftcms/cms/issues/12996))\n- Fixed a bug where Edit Category screens were including a Parent field, even if the category group\u2019s Max Levels was set to `1`. ([#13097](https://github.com/craftcms/cms/discussions/13097))\n- Fixed a bug where the uploader\u2019s user photo wasn\u2019t always loading on Edit Asset pages.\n- Fixed a bug where the \u201cDelete for site\u201d bulk element action was deleting disabled elements and drafts across all sites. ([#13116](https://github.com/craftcms/cms/issues/13116))\n- Fixed a bug where Entries and Categories fields with \u201cMaintain hierarchy\u201d enabled could lose relations to elements that didn\u2019t exist in the primary site. ([#13057](https://github.com/craftcms/cms/issues/13057))\n\n## 4.4.7.1 - 2023-04-15\n\n- Locked the Yii 2 PSR Log Target library to 1.1.3 to avoid a PHP error that occurs on 1.1.4.\n\n## 4.4.7 - 2023-04-11\n\n- Improved the control panel styling when the Debug Toolbar is enabled.\n- The image transformer now verifies that transforms don\u2019t exist if the index record is missing, before queuing up the transform generation, for local filesystems. ([#13052](https://github.com/craftcms/cms/issues/13052))\n- Added the `--propagate-to` and `--set-enabled-for-site` options to the `resave/entries` command.\n- Craft\u2019s bootstrap script now defines a `CRAFT_ENVIRONMENT` environment variable, as a safety measure for plugins that may be checking for it rather than `Craft::$app->env`.\n- Added `craft\\helpers\\ElementHelper::siteStatusesForElement()`.\n- `craft\\elements\\Asset::EVENT_BEFORE_DEFINE_URL` now sends a `craft\\events\\DefineAssetUrlEvent` object, rather than `craft\\events\\DefineUrlEvent`. ([#13018](https://github.com/craftcms/cms/issues/13018))\n- `craft\\web\\View::renderObjectTemplate()` now trims the returned template output.\n- Fixed a bug where users were \u201cView other users\u2019 drafts\u201d section permissions weren\u2019t being enforced for unpublished drafts.\n- Fixed a bug where Matrix fields weren\u2019t counting disabled blocks when enforcing their Min Blocks settings. ([#13059](https://github.com/craftcms/cms/issues/13059))\n- Fixed a bug where volume folder modals\u2019 sidebars and content were being cut off. ([#13074](https://github.com/craftcms/cms/issues/13074))\n- Fixed a bug where element editors were showing provisional changes, even if the user didn\u2019t have permission to save them.\n- Fixed a bug where the control panel could be inaccessible if a mutex lock couldn\u2019t be acquired for the queue. ([#13052](https://github.com/craftcms/cms/issues/13052))\n- Fixed a bug where it wasn\u2019t possible to update a Matrix block on a revision without a new block ID being assigned. ([#13064](https://github.com/craftcms/cms/discussions/13064))\n- Fixed a JavaScript error that could occur on field layout designers, if any tabs didn\u2019t have any elements. ([#13062](https://github.com/craftcms/cms/issues/13062))\n- Fixed a bug where selecting an image with a transform within an asset selector modal wasn\u2019t ever resolving.\n- Fixed a PHP error that could occur if there was a problem sending a password-reset email. ([#13070](https://github.com/craftcms/cms/pull/13070))\n- Fixed a bug where users\u2019 User Groups and Permissions settings were getting cleared in the UI when sending an activation email, if the email failed to send. ([#13061](https://github.com/craftcms/cms/issues/13061))\n- Fixed XSS vulnerabilities.\n- Updated yii2-debug to 2.1.22. ([#13058](https://github.com/craftcms/cms/issues/13058))\n\n## 4.4.6.1 - 2023-04-04\n\n- Fixed a bug where Categories fields weren\u2019t retaining custom sort orders when \u201cMaintain hierarchy\u201d was disabled. ([#10560](https://github.com/craftcms/cms/discussions/10560))\n\n## 4.4.6 - 2023-04-04\n\n- Content tab menus now reveal when a tab contains validation errors, and invalid tabs\u2019 menu options get the same warning icon treatment as inline tabs do. ([#12971](https://github.com/craftcms/cms/issues/12971))\n- Selectize menus now expand upwards when there\u2019s not ample space below them. ([#12976](https://github.com/craftcms/cms/issues/12976))\n- Element index bulk action spinners are now centered on the viewport. ([#12972](https://github.com/craftcms/cms/issues/12972))\n- All control panel errors are new presented via error notifications rather than browser alerts. ([#13024](https://github.com/craftcms/cms/issues/13024))\n- The `up` command now sets its default `--isolated` option value to `true`, and no longer creates a redundant mutex lock.\n- Added `craft\\base\\Element::EVENT_BEFORE_DEFINE_URL`. ([#13018](https://github.com/craftcms/cms/issues/13018))\n- Added `craft\\utilities\\AssetIndexes::volumes()`.\n- `craft\\controllers\\AssetIndexesController::actionStartIndexing()` now cross-references the selected volumes with those allowed by `craft\\utilities\\AssetIndexes::EVENT_LIST_VOLUMES` event handlers. ([#13039](https://github.com/craftcms/cms/pull/13039), [#12819](https://github.com/craftcms/cms/pull/12819))\n- Fixed a bug where Assets fields weren\u2019t respecting their View Mode setting when viewing entry revisions. ([#12948](https://github.com/craftcms/cms/issues/12948))\n- Fixed a bug where asset pagination was broken when there was more than 100 subfolders. ([#12969](https://github.com/craftcms/cms/issues/12969))\n- Fixed a bug where entry index pages\u2019 \u201cRevision Notes\u201d and \u201cLast Edited By\u201d columns weren\u2019t getting populated for disabled entries. ([#12981](https://github.com/craftcms/cms/issues/12981))\n- Fixed a bug where assets were getting relocated to the root volume folder when renamed. ([#12995](https://github.com/craftcms/cms/issues/12995))\n- Fixed a bug where it wasn\u2019t possible to preview entries on another domain when the system was offline. ([#12979](https://github.com/craftcms/cms/issues/12979))\n- Fixed a bug where users were able to access volumes they didn\u2019t have permission to view via Assets fields. ([#13006](https://github.com/craftcms/cms/issues/13006))\n- Fixed a bug where zero-width spaces, invisible plus signs, and byte order marks weren\u2019t getting stripped from sanitized asset filenames. ([#13022](https://github.com/craftcms/cms/issues/13022))\n- Fixed a bug where the Plugin Store wasn\u2019t accurately reporting installed plugins\u2019 license statuses. ([#12986](https://github.com/craftcms/cms/issues/12986))\n- Fixed a bug where the Plugin Store wasn\u2019t handling 403 API responses for cart operations properly, once a cart had been handed off to Craft Console and assigned to an organization. ([#12916](https://github.com/craftcms/cms/issues/12916))\n- Fixed a bug where `craft\\helpers\\FileHelper::absolutePath()` wasn\u2019t treating Windows file paths beginning drive letters as absolute. ([craftcms/generator#16](https://github.com/craftcms/generator/issues/16))\n- Fixed a bug where it wasn\u2019t possible to sort Categories fields with \u201cMaintain hierarchy\u201d disabled. ([#10560](https://github.com/craftcms/cms/discussions/10560))\n- Fixed a bug where selectize inputs didn\u2019t have a minimum width. ([#12950](https://github.com/craftcms/cms/issues/12950))\n- Fixed a bug where the wrong tab would appear to be initially selected after an autosave, if the selected tab had changed during the autosave. ([#12960](https://github.com/craftcms/cms/issues/12960))\n- Fixed a bug where it wasn\u2019t possible to add a Dropdown field without a blank option to a global set. ([#12965](https://github.com/craftcms/cms/issues/12965))\n- Fixed a bug where automatically-added Matrix blocks (per the field\u2019s Min Blocks setting) were getting discarded if no changes were made to them. ([#12973](https://github.com/craftcms/cms/issues/12973))\n- Fixed an error that could occur when installing Craft with an existing project config, if any image transforms were defined that didn\u2019t specify the `upscale` property.\n- Fixed a bug where nested folders in asset search results weren\u2019t showing their relative path.\n- Fixed a bug where admin tables\u2019 default delete icon title text wasn\u2019t getting translated. ([#13030](https://github.com/craftcms/cms/issues/13030))\n- Fixed a bug where it was possible to save a Local filesystem pointed at a system directory (e.g. the `templates/` or `vendor/` folders), which mitigates a potential RCE vulnerability.\n- Fixed XSS vulnerabilities.\n\n## 4.4.5 - 2023-03-21\n\n- Fixed a bug where relation data was getting deleted when running garbage collection on PostgreSQL. ([#9905](https://github.com/craftcms/cms/issues/9905))\n- Fixed a bug where Lightswitch fields\u2019 \u201cOFF Label\u201d and \u201cON Label\u201d settings weren\u2019t getting translated. ([#12942](https://github.com/craftcms/cms/issues/12942))\n- Fixed a bug where `craft\\events\\DefineUserContentSummaryEvent::$userId` was never set for `craft\\controllers\\EVENT_DEFINE_CONTENT_SUMMARY` events. ([#12944](https://github.com/craftcms/cms/issues/12944))\n- Fixed a bug where element edit pages weren\u2019t displaying layout tabs that didn\u2019t have a unique name. ([#12928](https://github.com/craftcms/cms/issues/12928))\n- Fixed a bug where the `CRAFT_LOG_PHP_ERRORS` constant/environment variable wasn\u2019t being respected when set to `false`. ([#12862](https://github.com/craftcms/cms/issues/12862))\n- Fixed a bug where the `entrify/categories` command wasn\u2019t converting disabled categories. ([#12945](https://github.com/craftcms/cms/issues/12945))\n- Updated svg-sanitizer to 0.16. ([#12943](https://github.com/craftcms/cms/issues/12943))\n\n## 4.4.4 - 2023-03-20\n\n- Input autofocussing has been reintroduced throughout the control panel. ([#12921](https://github.com/craftcms/cms/discussions/12921))\n- The `|json_encode` Twig filter now calls `craft\\helpers\\Json::encode()` internally, improving error handling. ([#12919](https://github.com/craftcms/cms/issues/12919))\n- `craft\\helpers\\Json::encode()` no longer sets the `JSON_UNESCAPED_SLASHES` flag by default.\n- Fixed a JavaScript error that occurred when resolving an asset move conflict. ([#12920](https://github.com/craftcms/cms/issues/12920))\n- Fixed a bug where volume subfolders were being shown when viewing soft-deleted assets. ([#12927](https://github.com/craftcms/cms/issues/12927))\n- Fixed a bug where structure data was getting deleted when running garbage collection on PostgreSQL. ([#12925](https://github.com/craftcms/cms/issues/12925))\n- Fixed an error that could occur when rebuilding the project config, if there were any custom source definitions for element types that weren\u2019t Composer-installed. ([#12881](https://github.com/craftcms/cms/issues/12881))\n- Fixed an XSS vulnerability.\n\n## 4.4.3 - 2023-03-16\n\n- Customize Sources modals no longer hide when the <kbd>Esc</kbd> key is pressed on the surrounding area is clicked on. ([#12895](https://github.com/craftcms/cms/issues/12895))\n- Sections created via `entrify` commands no longer get a \u201cPrimary entry page\u201d preview target by default, unless it was sourced from a category group with URLs. ([#12897](https://github.com/craftcms/cms/issues/12897))\n- `entrify` commands and the `sections/create` command now prompt for the initial entry type name and handle. ([#12894](https://github.com/craftcms/cms/discussions/12894))\n- Added `craft\\helpers\\FileHelper::uniqueName()`.\n- Added `craft\\helpers\\StringHelper::emojiToShortcodes()`.\n- Added `craft\\helpers\\StringHelper::shortcodesToEmoji()`.\n- Fixed an error that occurred when uploading an asset with a filename over 250 characters long. ([#12889](https://github.com/craftcms/cms/issues/12889))\n- Fixed an error that could occur when preparing licensing alerts, if any licenses were invalid. ([#12899](https://github.com/craftcms/cms/issues/12899))\n- Fixed a bug where it wasn\u2019t possible to drag nested Neo blocks. ([#12896](https://github.com/craftcms/cms/issues/12896))\n- Fixed a bug where fields with reduced widths in Matrix blocks were becoming full-width while dragged. ([#12909](https://github.com/craftcms/cms/issues/12909))\n- Fixed a bug where multi-edition plugins weren\u2019t showing their edition labels within the Plugin Store cart. ([#12910](https://github.com/craftcms/cms/issues/12910))\n- Fixed a bug where private plugins\u2019 control panel templates weren\u2019t directly accessible by URL.\n- Fixed a bug where element selector modals were persisting parts of their state in the query string. ([#12900](https://github.com/craftcms/cms/issues/12900))\n- Fixed a PHP error that occurred if a field type stored enum values. ([#12297](https://github.com/craftcms/cms/issues/12297))\n- Fixed an error that could occur when generating transforms for images stored in Google Cloud Storage. ([#12878](https://github.com/craftcms/cms/issues/12878))\n- Fixed a bug where some unicode characters were getting removed by LitEmoji. ([#12905](https://github.com/craftcms/cms/issues/12905))\n\n## 4.4.2 - 2023-03-14\n\n- The `entrify/categories` and `entrify/global-set` commands now update user permissions for the new sections. ([#12849](https://github.com/craftcms/cms/discussions/12849))\n- Variable dumps now use a light theme for web requests by default. ([#12857](https://github.com/craftcms/cms/pull/12857))\n- Added the `dumper` application component and `craft\\base\\ApplicationTrait::getDumper()`. ([#12869](https://github.com/craftcms/cms/pull/12869))\n- Added `craft\\models\\ImageTransform::getConfig()`.\n- Fixed a bug where it wasn\u2019t always possible to access entry or category edit pages if the `slugWordSeparator` config setting was set to `/`. ([#12871](https://github.com/craftcms/cms/issues/12871))\n- Fixed a bug where `craft\\helpers\\Html::parseTagAttribute()` wasn\u2019t decoding attribute values, which could lead to double-encoded attributes, e.g. when using the `|attr` filter. ([#12887](https://github.com/craftcms/cms/issues/12887))\n- Fixed a bug where multi-value field inputs would be considered modified even if they weren\u2019t, if the field type\u2019s `isValueEmpty()` method returned `true`. ([#12858](https://github.com/craftcms/cms/issues/12858))\n- Fixed a bug where asset thumbnails within secondary slideout tabs weren\u2019t loading immediately. ([#12859](https://github.com/craftcms/cms/issues/12859))\n- Fixed a bug where rebuilding the project config would lose track of image transforms\u2019 `fill` and `upscale` settings. ([#12879](https://github.com/craftcms/cms/issues/12879))\n- Fixed a bug where blank Dropdown options weren\u2019t showing up in the Selectize menu. ([#12880](https://github.com/craftcms/cms/issues/12880))\n- Fixed a bug where it was possible to save a Dropdown field without a value, even if the field didn\u2019t have any blank options. ([#12880](https://github.com/craftcms/cms/issues/12880))\n- Fixed a bug where element action triggers weren\u2019t centered for element sources that don\u2019t define any exporters. ([#12885](https://github.com/craftcms/cms/issues/12885))\n- Fixed an error that could occur when generating a transform URL for an image in the temp folder.\n- Fixed XSS vulnerabilities.\n- Fixed an SSRF vulnerability.\n\n## 4.4.1 - 2023-03-09\n\n- Fixed a bug where it wasn\u2019t possible to select subfolders on the Assets index page. ([#12802](https://github.com/craftcms/cms/issues/12802))\n- Fixed a bug where element index search inputs were losing focus when the element listing was updated. ([#12846](https://github.com/craftcms/cms/issues/12846))\n- Fixed a bug where the database driver was being referenced as \u201cMySQL\u201d when using MariaDB. ([#12827](https://github.com/craftcms/cms/issues/12827))\n- Fixed a bug where users weren\u2019t able to select assets within Assets fields, if they didn\u2019t have full permissions for the volume. ([#12851](https://github.com/craftcms/cms/issues/12851))\n- Fixed a bug where the Assets index page\u2019s URL would get updated incorrectly when renaming a subfolder.\n- Fixed a bug where non-admin users weren\u2019t able to view Single section entries. ([#12838](https://github.com/craftcms/cms/issues/12838))\n- Fixed an error that could occur when saving an element with eager-loaded relations. ([#12839](https://github.com/craftcms/cms/issues/12839))\n- Fixed a bug where Customize Sources modals weren\u2019t showing source headings with no subsequent sources. ([#12840](https://github.com/craftcms/cms/issues/12840))\n- Fixed a bug where `entrify` commands could leave the database and project config data in inconsistent states, if aborted prematurely. ([#12850](https://github.com/craftcms/cms/pull/12850))\n- Fixed a bug where the `entrify/global-set` command wasn\u2019t always suggesting the command to run on other environments.\n- Fixed a bug where the Assets index page would appear to keep loading indefinitely after renaming a subfolder.\n- Fixed a bug where folders within asset indexes were getting the current site name appended to them, on multi-site installs. ([#12852](https://github.com/craftcms/cms/issues/12852))\n- Fixed a SQL error that could occur when updating to Craft 4.4 on PostgreSQL. ([#12855](https://github.com/craftcms/cms/issues/12855))\n- Added `craft\\db\\Connection::getDriverLabel()`.\n\n## 4.4.0 - 2023-03-08\n\n### Content Management\n- Volume subfolders are now displayed within the element listing pane on asset indexes, rather than as nested sources in the sidebar. ([#12558](https://github.com/craftcms/cms/pull/12558), [#9171](https://github.com/craftcms/cms/discussions/9171), [#5809](https://github.com/craftcms/cms/issues/5809))\n- Asset indexes now display the current subfolder path above the element listing. ([#12558](https://github.com/craftcms/cms/pull/12558))\n- Assets and folders can now be drag-and-dropped simultaneously. ([#12792](https://github.com/craftcms/cms/pull/12792))\n- Reduced the likelihood of accidentally triggering an asset drag operation. ([#12792](https://github.com/craftcms/cms/pull/12792))\n- Reduced the likelihood of accidentally dropping dragged assets/folders on an unintended target. ([#12792](https://github.com/craftcms/cms/pull/12792))\n- It\u2019s now possible to move volume folders and assets to a new location via a new \u201cMove\u2026\u201d bulk element action, rather than via drag-and-drop interactions. ([#12558](https://github.com/craftcms/cms/pull/12558))\n- It\u2019s now possible to sort asset indexes by image width and height. ([#12653](https://github.com/craftcms/cms/pull/12653))\n- Structured element index sources now have a dedicated view mode option for showing elements as a structured table. ([#12722](https://github.com/craftcms/cms/pull/12722), [#12718](https://github.com/craftcms/cms/discussions/12718))\n- Entry and category indexes can now have \u201cAncestors\u201d and \u201cParent\u201d columns. ([#12666](https://github.com/craftcms/cms/discussions/12666))\n- All element sources now have a \u201cDuplicate\u201d action, even if the element type\u2019s `defineActions()` method didn\u2019t include one. ([#12382](https://github.com/craftcms/cms/discussions/12382))\n- Element index pages now track the search term in a query param, so the results can be shared. ([#8942](https://github.com/craftcms/cms/discussions/8942), [#12399](https://github.com/craftcms/cms/pull/12399))\n- Entries with more than 10 revisions now include a \u201cView all revisions\u201d item within their revision menu, which links to a new revisions index page for the entry that paginates through all its revisions. ([#8609](https://github.com/craftcms/cms/discussions/8609))\n- Entries and Categories fields now have \u201cMaintain hierarchy\u201d settings, which become available when a single structured source is selected. ([#8522](https://github.com/craftcms/cms/discussions/8522), [#8748](https://github.com/craftcms/cms/discussions/8748), [#10560](https://github.com/craftcms/cms/discussions/10560), [#11749](https://github.com/craftcms/cms/pull/11749))\n- Entries fields now have a \u201cBranch Limit\u201d setting, which becomes available when \u201cMaintain hierarchy\u201d is enabled, replacing \u201cMin Relations\u201d and \u201cMax Relations\u201d.\n- Categories fields now have \u201cMin Relations\u201d and \u201cMax Relations\u201d settings, which become available when \u201cMaintain hierarchy\u201d is disabled, replacing \u201cBranch Limit\u201d.\n- Added \u201cViewable\u201d asset and entry condition rules. ([#12240](https://github.com/craftcms/cms/discussions/12240), [#12266](https://github.com/craftcms/cms/pull/12266))\n- Renamed the \u201cEditable\u201d asset and entry condition rules to \u201cSavable\u201d. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Assets, categories, and entries will now redirect to the last-selected source on their index pages when saved. ([#11996](https://github.com/craftcms/cms/discussions/11996))\n- Dropdown fields that don\u2019t have a blank option and are missing a value will now include and select a blank option at the beginning of their menu. ([#12235](https://github.com/craftcms/cms/discussions/12235))\n- Tip and Warning field layout UI elements can now be marked as dismissible, giving authors the ability to hide them. ([#12188](https://github.com/craftcms/cms/discussions/12188))\n- All assets now get thumbnails in the control panel, even if they don\u2019t have a transform filesystem with a base URL. ([#12531](https://github.com/craftcms/cms/issues/12531))\n- Dropdown and Multi-select fields now use Selectize. ([#8403](https://github.com/craftcms/cms/discussions/8403))\n- Improved the styling of bulk element action triggers. ([#12793](https://github.com/craftcms/cms/pull/12793))\n\n### Accessibility\n- Improved the announcement menu for screen readers. ([#12361](https://github.com/craftcms/cms/pull/12361))\n- Improved keyboard control of the Updates utility. ([#12189](https://github.com/craftcms/cms/pull/12189))\n- Improved the color contrast and keyboard control of the Customize Sources modal. ([#12233](https://github.com/craftcms/cms/pull/12233))\n- Improved info icons for screen readers. ([#12272](https://github.com/craftcms/cms/pull/12272))\n- Removed input autofocussing throughout the control panel. ([#12324](https://github.com/craftcms/cms/discussions/12324), [#12332](https://github.com/craftcms/cms/pull/12332), [#12406](https://github.com/craftcms/cms/pull/12406))\n- Improved the login screen for screen readers. ([#12386](https://github.com/craftcms/cms/pull/12386))\n- Improved _conditional_ and _required_ field indicators for screen readers. ([#12509](https://github.com/craftcms/cms/pull/12509))\n- Improved element index pages for screen readers. ([#12731](https://github.com/craftcms/cms/pull/12731))\n- Improved bulk element action triggers on element index pages. ([#12415](https://github.com/craftcms/cms/pull/12415))\n- Improved the color contrast of element indexes. ([#12213](https://github.com/craftcms/cms/pull/12213))\n- Asset preview modals now show videos\u2019 alt text. ([#12637](https://github.com/craftcms/cms/pull/12637))\n- Improved element indexes\u2019 \u201cExport\u201d buttons for screen readers. ([#12754](https://github.com/craftcms/cms/pull/12754))\n- Improved Quick Post widgets\u2019 \u201cFields\u201d settings for screen readers. ([#12772](https://github.com/craftcms/cms/pull/12772))\n- Improved some element selector modals for screen readers. ([#12783](https://github.com/craftcms/cms/pull/12783))\n- Fixed a bug where it wasn\u2019t possible to vertically scroll element index filter HUDs. ([#12751](https://github.com/craftcms/cms/pull/12751))\n- Fixed a bug where translated locale names within users\u2019 \u201cLanguage\u201d and \u201cFormatting Locale\u201d preference menus didn\u2019t have `lang` attributes. ([#12773](https://github.com/craftcms/cms/pull/12773))\n- Fixed a bug where search icons on element indexes weren\u2019t hidden from screen readers. ([#12785](https://github.com/craftcms/cms/pull/12785))\n\n### Administration\n- Most licensing issues are now consolidated into a single control panel alert, with a button to resolve them all with a single purchase on Craft Console. ([#12768](https://github.com/craftcms/cms/pull/12768))\n- Conditional layout components are now identified using a condition icon within field layout designers. ([#12250](https://github.com/craftcms/cms/issues/12250))\n- All CLI commands now support an `--isolated` option, which ensures the command is run in isolation. ([#12337](https://github.com/craftcms/cms/discussions/12337), [#12350](https://github.com/craftcms/cms/pull/12350))\n- Added the `entrify/categories`, `entrify/tags`, and `entrify/global-set` commands, for converting categories, tags, and global sets to entries. ([#12689](https://github.com/craftcms/cms/pull/12689), [#9781](https://github.com/craftcms/cms/discussions/9781))\n- Added the `sections/create` and `sections/delete` commands. ([#12689](https://github.com/craftcms/cms/pull/12689))\n- The `plugin/install`, `plugin/uninstall`, `plugin/enable`, and `plugin/disabled` commands now support an `--all` option, which applies the action to all applicable Composer-installed plugins. ([#11373](https://github.com/craftcms/cms/discussions/11373), [#12218](https://github.com/craftcms/cms/pull/12218))\n- The `project-config/apply` command now supports a `--quiet` option, which reduces the command output. ([#12568](https://github.com/craftcms/cms/discussions/12568))\n- Added the `users/unlock` console command. ([#12345](https://github.com/craftcms/cms/discussions/12345))\n- The Asset Indexes utility no longer skips volumes if the root folder was completely empty. ([#12585](https://github.com/craftcms/cms/issues/12585), [#12604](https://github.com/craftcms/cms/pull/12604))\n- The Asset Indexes utility now has a \u201cList empty folders\u201d setting, which determines whether empty folders should be listed for deletion from the index. ([#12604](https://github.com/craftcms/cms/pull/12604))\n- The Asset Indexes utility now lists missing/empty folders and files separately in the review screen. ([#12604](https://github.com/craftcms/cms/pull/12604))\n- Relational condition rules for conditions that are saved to the project config now accept a Twig template which outputs a related element ID dynamically. ([#12679](https://github.com/craftcms/cms/pull/12679), [#12676](https://github.com/craftcms/cms/discussions/12676))\n- Image transform settings no longer show the \u201cDefault Focal Point\u201d setting when Mode is set to \u201cFit\u201d, as the setting had no effect. ([#12774](https://github.com/craftcms/cms/pull/12774))\n- Improved the CLI output for `index-assets` commands. ([#12604](https://github.com/craftcms/cms/pull/12604))\n\n### Development\n- Added the \u201cLetterbox\u201d (`letterbox`) image transform mode. ([#8848](https://github.com/craftcms/cms/discussions/8848), [#12214](https://github.com/craftcms/cms/pull/12214))\n- Added the `preloadSingles` config setting, which causes front-end Twig templates to automatically preload Single section entries which are referenced in the template. ([#12698](https://github.com/craftcms/cms/pull/12787))\n- Control panel-defined image transforms now have an \u201cAllow Upscaling\u201d setting, which will initially be set to the `upscaleImages` config setting for existing transforms. ([#12214](https://github.com/craftcms/cms/pull/12214))\n- Template-defined image transforms can now have an `upscale` setting. The `upscaleImages` config setting will be used by default if not set. ([#12214](https://github.com/craftcms/cms/pull/12214))\n- Added the `exec` command, which executes an individual PHP statement and outputs the result. ([#12528](https://github.com/craftcms/cms/pull/12528))\n- Added the `editable` and `savable` asset query params. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added the `savable` entry query param. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- The `editable` entry query param can now be set to `false` to only show entries that _can\u2019t_ be viewed by the current user. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added the `{% dump %}` tag, which dumps variables into a new \u201cDumps\u201d Debug Toolbar panel. ([#12506](https://github.com/craftcms/cms/pull/12506))\n- Added the `base64_decode` and `base64_encode` Twig filters. ([#12696](https://github.com/craftcms/cms/discussions/12696))\n- The `dump()` Twig function now utilizes `Craft::dump()`, and no longer requires Dev Mode to be active. ([#12486](https://github.com/craftcms/cms/pull/12486), [#12479](https://github.com/craftcms/cms/discussions/12479))\n- The `{% dd %}` Twig tag can now output the entire `context` array, if no variable is passed to it. ([#12486](https://github.com/craftcms/cms/pull/12486))\n- Added the `revisionNotes` field to elements queried via GraphQL. ([#12610](https://github.com/craftcms/cms/issues/12610))\n- Added `ancestors` and `descendants` fields to categories queried via GraphQL. ([#12427](https://github.com/craftcms/cms/issues/12427))\n- Added `craft\\elements\\Asset::getFormat()` and the `format` field for assets queried via GraphQL. ([#12398](https://github.com/craftcms/cms/pull/12398), [#12521](https://github.com/craftcms/cms/pull/12521))\n- `Craft::dump()`, `Craft::dd()`, the `dump()` Twig function, and the `{% dd %}` Twig tag now use Symfony\u2019s VarDumper. ([#12479](https://github.com/craftcms/cms/discussions/12479))\n- `Craft::dump()` now has a `$return` argument, which will cause the resulting dump to be returned as a string rather than output, if `true`.\n- `craft\\elements\\Asset::getMimeType()` now has a `$transform` argument, and assets\u2019 `mimeType` GraphQL fields now support a `@transform` directive. ([#12269](https://github.com/craftcms/cms/discussions/12269), [#12397](https://github.com/craftcms/cms/pull/12397), [#12522](https://github.com/craftcms/cms/pull/12522))\n- `craft\\helpers\\App::env()` now returns `null` if the original value was `'null'`. ([#12742](https://github.com/craftcms/cms/pull/12742))\n- `craft\\helpers\\Db::escapeParam()` now escapes `:empty:` and `:notempty:` strings. ([#12691](https://github.com/craftcms/cms/discussions/12691))\n\n### Extensibility\n- Added support for private plugins. ([#12716](https://github.com/craftcms/cms/pull/12716), [#8908](https://github.com/craftcms/cms/discussions/8908))\n- Added the `elements/revisions` action. ([#12211](https://github.com/craftcms/cms/pull/12211))\n- Console controllers that directly use `craft\\console\\ControllerTrait` no longer need to call `$this->checkTty()` or `$this->checkRootUser()` themselves; they are now called from `ControllerTrait::init()` and `beforeAction()`.\n- Element source definitions can now include a `defaultSourcePath` key.\n- Element custom field validation now respects the list of attributes passed to `validate()`.\n- Improving IDE autocompletion for chained query param calls. ([#12656](https://github.com/craftcms/cms/pull/12656))\n- Added `craft\\base\\ApplicationTrait::getEditionHandle()`.\n- Added `craft\\base\\BaseFsInterface`. ([#12709](https://github.com/craftcms/cms/pull/12709))\n- Added `craft\\base\\Batchable`.\n- Added `craft\\base\\Element::cpRevisionsUrl()`.\n- Added `craft\\base\\Element::indexElements()`.\n- Added `craft\\base\\ElementInterface::findSource()`.\n- Added `craft\\base\\ElementInterface::getCpRevisionsUrl()`.\n- Added `craft\\base\\ElementInterface::getUiLabelPath()`.\n- Added `craft\\base\\ElementInterface::indexElementCount()`.\n- Added `craft\\base\\ElementInterface::setUiLabelPath()`.\n- Added `craft\\base\\Event`, which provides a `once()` static method for registering an event handler that will only be triggered up to one time.\n- Added `craft\\console\\ControllerTrait::beforeAction()`.\n- Added `craft\\console\\ControllerTrait::failure()`.\n- Added `craft\\console\\ControllerTrait::init()`.\n- Added `craft\\console\\ControllerTrait::markdownToAnsi()`.\n- Added `craft\\console\\ControllerTrait::note()`.\n- Added `craft\\console\\ControllerTrait::options()`.\n- Added `craft\\console\\ControllerTrait::runAction()`.\n- Added `craft\\console\\ControllerTrait::success()`.\n- Added `craft\\console\\ControllerTrait::tip()`.\n- Added `craft\\console\\ControllerTrait::warning()`.\n- Added `craft\\db\\QueryBatcher`.\n- Added `craft\\debug\\DumpPanel`.\n- Added `craft\\elements\\conditions\\assets\\ViewableConditionRule`. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added `craft\\elements\\conditions\\ElementCondition::$referenceElement`.\n- Added `craft\\elements\\conditions\\entries\\ViewableConditionRule`. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Added `craft\\elements\\Entry::EVENT_DEFINE_PARENT_SELECTION_CRITERIA`. ([#12475](https://github.com/craftcms/cms/discussions/12475))\n- Added `craft\\events\\DefineInputOptionsEvent`. ([#12351](https://github.com/craftcms/cms/pull/12351))\n- Added `craft\\events\\ListVolumesEvent`.\n- Added `craft\\events\\UserPhotoEvent`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\fields\\BaseOptionsField::EVENT_DEFINE_OPTIONS`. ([#12351](https://github.com/craftcms/cms/pull/12351))\n- Added `craft\\fields\\BaseRelationField::$branchLimit`.\n- Added `craft\\fields\\BaseRelationField::$maintainHierarchy`.\n- Added `craft\\helpers\\Db::rawTableShortName()`.\n- Added `craft\\helpers\\ImageTransforms::generateTransform()`.\n- Added `craft\\helpers\\ImageTransforms::parseTransformString()`.\n- Added `craft\\helpers\\StringHelper::toHandle()`.\n- Added `craft\\helpers\\Template::fallback()`.\n- Added `craft\\helpers\\Template::fallbackExists()`.\n- Added `craft\\helpers\\Template::preloadSingles()`.\n- Added `craft\\image\\Raster::scaleToFitAndFill()`.\n- Added `craft\\image\\Raster::setFill()`.\n- Added `craft\\imagetransforms\\FallbackTransformer`.\n- Added `craft\\models\\CategoryGroup::$dateDeleted`.\n- Added `craft\\models\\ImageTransform::$fill`.\n- Added `craft\\models\\ImageTransform::$upscale`.\n- Added `craft\\models\\TagGroup::$dateDeleted`.\n- Added `craft\\models\\VolumeFolder::getHasChildren()`.\n- Added `craft\\models\\VolumeFolder::setHasChildren()`.\n- Added `craft\\queue\\BaseBatchedJob`. ([#12638](https://github.com/craftcms/cms/pull/12638))\n- Added `craft\\queue\\jobs\\GenerateImageTransform`. ([#12340](https://github.com/craftcms/cms/pull/12340))\n- Added `craft\\services\\Assets::createFolderQuery()`.\n- Added `craft\\services\\Assets::foldersExist()`.\n- Added `craft\\services\\Elements::deleteElementForSite()`.\n- Added `craft\\services\\Elements::deleteElementsForSite()`.\n- Added `craft\\services\\Elements::EVENT_AFTER_DELETE_FOR_SITE`. ([#12354](https://github.com/craftcms/cms/issues/12354))\n- Added `craft\\services\\Elements::EVENT_BEFORE_DELETE_FOR_SITE`. ([#12354](https://github.com/craftcms/cms/issues/12354))\n- Added `craft\\services\\Entries::getSingleEntriesByHandle()`. ([#12698](https://github.com/craftcms/cms/pull/12787))\n- Added `craft\\services\\Fields::getFieldsByType()`. ([#12381](https://github.com/craftcms/cms/discussions/12381))\n- Added `craft\\services\\Path::getImageTransformsPath()`.\n- Added `craft\\services\\Search::normalizeSearchQuery()`.\n- Added `craft\\services\\Users::EVENT_AFTER_DELETE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\services\\Users::EVENT_AFTER_SAVE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\services\\Users::EVENT_BEFORE_DELETE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\services\\Users::EVENT_BEFORE_SAVE_USER_PHOTO`. ([#12360](https://github.com/craftcms/cms/pull/12360))\n- Added `craft\\utilities\\AssetIndexes::EVENT_LIST_VOLUMES`. ([#12383](https://github.com/craftcms/cms/pull/12383), [#12443](https://github.com/craftcms/cms/pull/12443))\n- Renamed `craft\\elements\\conditions\\assets\\EditableConditionRule` to `SavableConditionRule`, while preserving the original class name with an alias. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- Renamed `craft\\elements\\conditions\\entries\\EditableConditionRule` to `SavableConditionRule`, while preserving the original class name with an alias. ([#12266](https://github.com/craftcms/cms/pull/12266))\n- `craft\\services\\AssetIndexer::startIndexingSession()` and `createIndexingSession()` now have a `$listEmptyFolders` argument. ([#12604](https://github.com/craftcms/cms/pull/12604))\n- `craft\\base\\ElementQuery::joinElementTable()` now accepts table names in the format of `{{%tablename}}`.\n- `craft\\models\\Volume` now implements `craft\\base\\BaseFsInterface`. ([#12709](https://github.com/craftcms/cms/pull/12709))\n- `craft\\services\\Categories::getGroupByHandle()` now has a `$withTrashed` argument.\n- `craft\\services\\Globals::getSetByHandle()` now has a `$withTrashed` argument.\n- `craft\\services\\Tags::getTagGroupByHandle()` now has a `$withTrashed` argument.\n- `craft\\services\\Users::sendActivationEmail()`, `sendNewEmailVerifyEmail()`, `sendPasswordResetEmail()`, `getActivationUrl()`, `getEmailVerifyUrl()`, `getPasswordResetUrl()`, and `setVerificationCodeOnUser()` will now throw a `craft\\errors\\InvalidElementException` if the user has a non-unique email. ([#12431](https://github.com/craftcms/cms/issues/12431), [#12712](https://github.com/craftcms/cms/pull/12712))\n- Deprecated `craft\\elements\\Asset::getFs()`. `getVolume()` should be used instead.\n- Deprecated `craft\\helpers\\Assets::sortFolderTree()`.\n- Deprecated `craft\\imagetransforms\\ImageTransformer::ensureTransformUrlByIndexModel()`. `getTransformUrl()` should be used instead.\n- Deprecated `craft\\imagetransforms\\ImageTransformer::procureTransformedImage()`. `generateTransform()` should be used instead.\n- Deprecated `craft\\queue\\jobs\\GeneratePendingTransforms`. `GenerateImageTransform` should be used instead. ([#12340](https://github.com/craftcms/cms/pull/12340))\n- Deprecated `craft\\services\\Assets::getFolderTreeByFolderId()`.\n- Deprecated `craft\\services\\Assets::getFolderTreeByVolumeIds`.\n- Added `Craft.Accordion`. ([#12189](https://github.com/craftcms/cms/pull/12189))\n- Added `Craft.AssetMover`.\n- Added `Craft.BaseElementIndex::getSourcePathActionLabel()`.\n- Added `Craft.BaseElementIndex::getSourcePathActions()`.\n- Added `Craft.BaseElementIndex::getSourcePathLabel()`.\n- Added `Craft.BaseElementIndex::onSourcePathChange()`.\n- Added `Craft.BaseElementIndex::sourcePath`.\n- Added `Craft.BaseElementSelectorModal::getElementIndexParams()`.\n- Added `Craft.BaseElementSelectorModal::getIndexSettings()`.\n- Added `Craft.BaseElementSelectorModal::hasSelection()`.\n- Added `Craft.ElementFieldSettings`.\n- Added `Craft.VolumeFolderSelectorModal`.\n- Added `Garnish.MultiFunctionBtn`.\n- The custom `activate` jQuery event will now trigger when the <kbd>Return</kbd> key is pressed.\n- The custom `activate` jQuery event will no longer trigger for <kbd>Ctrl</kbd>/<kbd>Command</kbd>-clicks.\n- Deprecated `Craft.CategorySelectInput`. `Craft.BaseElementSelectInput` should be used instead. ([#11749](https://github.com/craftcms/cms/pull/11749))\n\n### System\n- Improved element deletion performance. ([#12223](https://github.com/craftcms/cms/pull/12223))\n- Improved queue performance. ([#12274](https://github.com/craftcms/cms/issues/12274), [#12340](https://github.com/craftcms/cms/pull/12340))\n- \u201cApplying new propagation method to elements\u201d, \u201cPropagating [element type]\u201d, and \u201cResaving [element type]\u201d queue jobs are now split up into batches of up to 100 items. ([#12638](https://github.com/craftcms/cms/pull/12638))\n- Assets\u2019 alternative text values are now included as search keywords.\n- Entry type, section, category group, and tag group deletion no longer involves looping through all affected entries/categories/tags and deleting each one individually via `craft\\services\\Elements::deleteElement()`. ([#12665](https://github.com/craftcms/cms/pull/12665))\n- Updated LitEmoji to v4. ([#12226](https://github.com/craftcms/cms/discussions/12226))\n- Fixed a database deadlock error that could occur when updating a relation or structure position for an element that was simultaneously being saved. ([#9905](https://github.com/craftcms/cms/issues/9905))\n- Fixed a bug where element query `select()` and `orderBy()` params could resolve element extension table column names to custom field columns, if a custom field had a conflicting handle. ([#12652](https://github.com/craftcms/cms/issues/12652))\n- Fixed a bug where it was possible to activate inactive users with non-unique emails. ([#12431](https://github.com/craftcms/cms/issues/12431), [#12712](https://github.com/craftcms/cms/pull/12712))\n- Fixed a bug where hint text within Selectize menus had extremely low contrast on hover. ([#12829](https://github.com/craftcms/cms/issues/12829))\n\n## 4.3.11 - 2023-03-07\n\n- Fixed a bug where `craft\\events\\RegisterElementSourcesEvent::$context` wasn\u2019t always set to `modal` when defining the available element sources for an element selection modal.\n- Fixed a styling bug where multi-line checkbox labels within the Customize Sources modal and View menu weren\u2019t wrapping properly. ([#12717](https://github.com/craftcms/cms/issues/12717))\n- Fixed a bug where asset thumbnails within collapsed Matrix blocks weren\u2019t loading when the block was expanded. ([#12720](https://github.com/craftcms/cms/issues/12720))\n- Fixed a bug where user activation/verification/reset-password URLs could be root-relative, if the `@web` alias was explicitly set to a root-relative URL.\n- Fixed a PHP error that could occur if an options field\u2019s condition rule wasn\u2019t configured with any values. ([#12713](https://github.com/craftcms/cms/pull/12713))\n- Fixed a bug where control panel notifications weren\u2019t being announced to screen readers. ([#12714](https://github.com/craftcms/cms/pull/12714))\n- Fixed a bug where localized relations could be moved to a newly-added site rather than copied, when applying project config changes. ([#12702](https://github.com/craftcms/cms/issues/12702))\n- Fixed a bug where element indexes\u2019 \u201cView\u201d buttons could be inconsistently positioned in the toolbar.\n- Fixed a bug where element selector modal footers could hide the modal contents. ([#12708](https://github.com/craftcms/cms/issues/12708))\n- Fixed a bug where asset thumbnails weren\u2019t respecting the `generateTransformsBeforePageLoad` config setting. ([#12750](https://github.com/craftcms/cms/issues/12750))\n- Fixed a bug where soft hyphens, non-breaking spaces, zero-width characters, invisible times characters, and invisible separators weren\u2019t getting stripped from sanitized asset filenames. ([#12741](https://github.com/craftcms/cms/issues/12741), [#12759](https://github.com/craftcms/cms/pull/12759))\n- Fixed a bug where custom fields\u2019 database columns would get deleted when applying project config changes, if the field type wasn\u2019t present. ([#12760](https://github.com/craftcms/cms/issues/12760))\n- Fixed an error that could occur if a non-numeric value was entered into an image transform\u2019s Width or Height settings. ([#12776](https://github.com/craftcms/cms/pull/12776))\n- Fixed a bug where Assets, Categories, and Tags fields weren\u2019t respecting their \u201cAllow self relations\u201d settings. ([#12769](https://github.com/craftcms/cms/issues/12769))\n- Fixed a bug where dynamically-generated entry titles weren\u2019t always generated with the site\u2019s formatting locale in place. ([12780](https://github.com/craftcms/cms/issues/12780))\n- Fixed a bug where element titles weren\u2019t getting a pointer cursor or underlines on hover, when selected on an element index page.\n- Fixed a bug where it wasn\u2019t possible to close modals that were opened by a custom select menu via the <kbd>Esc</kbd> key. ([#12814](https://github.com/craftcms/cms/pull/12814))\n- Fixed an error that could occur when saving an element with an eager-loaded Matrix field. ([#12815](https://github.com/craftcms/cms/issues/12815))\n- Fixed a bug where the \u201csend to Developer Support\u201d links within the Craft Support widget weren\u2019t working. ([#12822](https://github.com/craftcms/cms/issues/12822))\n\n## 4.3.10 - 2023-02-17\n\n- Fixed a bug where clicking on the scrollbar of a disclosure menu would close it. ([#12681](https://github.com/craftcms/cms/issues/12681))\n- Fixed an error that could occur when loading the Plugin Store, if there wasn\u2019t a `.env` file. ([#12687](https://github.com/craftcms/cms/issues/12687))\n- Fixed a bug where large asset thumbnails weren\u2019t centered within Assets fields. ([#12682](https://github.com/craftcms/cms/issues/12682))\n- Fixed a PHP error that could occur when versioning asset URLs. ([#12678](https://github.com/craftcms/cms/issues/12678))\n- Fixed a bug where the \u201cSite\u201d element condition rule was available for non-localizable element types\u2019 conditions. ([#12601](https://github.com/craftcms/cms/pull/12601))\n- Fixed a bug where it wasn\u2019t possible to sort assets within subfolders by anything besides the asset title. ([#12688](https://github.com/craftcms/cms/issues/12688))\n\n## 4.3.9 - 2023-02-14\n\n- Image thumbnails and previews are no longer versioned if their image URL doesn\u2019t begin with one of the asset\u2019s base filesystem URLs. ([#12663](https://github.com/craftcms/cms/issues/12663))\n- HTML Purifier now allows `oembed` tags. ([craftcms/ckeditor#59](https://github.com/craftcms/ckeditor/issues/59))\n- Added `craft\\htmlpurifier\\VideoEmbedUrlDef`.\n- `craft\\helpers\\Assets::revUrl()` now has an `$fsOnly` argument.\n- Fixed a bug where entries that aren\u2019t propagated to the primary site weren\u2019t showing revision notes. ([#12641](https://github.com/craftcms/cms/issues/12641))\n- Fixed a bug where HTML tags weren\u2019t getting stripped from auto-generated Handle and URI Format setting values.\n- Fixed a JavaScript error that could occur if an object with `null` values was passed to `Craft.compare()`.\n- Fixed a bug where `craft\\elements\\db\\ElementQuery::toArray()` was calling getter methods whose names conflicted with custom field handles. ([#12635](https://github.com/craftcms/cms/pull/12635))\n\n## 4.3.8.2 - 2023-02-08\n\n- Fixed a PHP error that could occur if relational fields were getting eager-loaded for elements that the fields didn\u2019t belong to. ([#12648](https://github.com/craftcms/cms/issues/12648))\n\n## 4.3.8.1 - 2023-02-08\n\n- Fixed a PHP error that occurred after performing a Composer action within Craft. ([#12647](https://github.com/craftcms/cms/issues/12647))\n- Fixed a bug where element attributes weren\u2019t getting eager-loaded. ([#12646](https://github.com/craftcms/cms/pull/12646), [#12645](https://github.com/craftcms/cms/issues/12645))\n- Fixed a bug where image previews weren\u2019t getting versioned, unless the `revAssetUrls` config setting was enabled. ([#12603](https://github.com/craftcms/cms/issues/12603))\n\n## 4.3.8 - 2023-02-07\n\n- Updated Composer to 2.2.19, fixing a PHP error that could occur when performing a Composer action within Craft, when the autoload classmap was generated with Composer 2.5. ([#12482](https://github.com/craftcms/cms/issues/12482))\n- Fixed a bug where Matrix blocks weren\u2019t getting eager-loaded. ([#12631](https://github.com/craftcms/cms/issues/12631))\n- Fixed a PHP error that could occur when calling `craft\\services\\Assets::getAllDescendantFolders()` for the root folder. ([craftcms/feed-me#1231](https://github.com/craftcms/feed-me/issues/1231))\n- Fixed a bug where revision notes weren\u2019t always being retained for provisional drafts. ([#12641](https://github.com/craftcms/cms/issues/12641))\n- Fixed a bug where it wasn\u2019t possible to access the Customize Sources modal on element index pages, if all sources were disabled. ([#12634](https://github.com/craftcms/cms/issues/12634))\n\n## 4.3.7.1 - 2023-02-05\n\n- The `_includes/forms/checkbox.twig`, `select.twig`, and `text.twig` templates no longer add an `aria-labelledby` attribute to the input if an `aria-label` attribute is also specified.\n- `craft\\helpers\\Cp::dateTimeFieldHtml()` now returns inputs contained within a fieldset.\n- Fixed a bug where some inputs were getting `aria-labelledby` attributes that referenced a nonexistent label ID.\n- Fixed a bug where the first changes to entries weren\u2019t saving properly. ([#12623](https://github.com/craftcms/cms/issues/12623), [#12592](https://github.com/craftcms/cms/issues/12592))\n- Fixed a bug where `craft\\behaviors\\CustomFieldBehavior::$owner` was getting nullified by `craft\\base\\Element::fieldByHandle()`. ([#12624](https://github.com/craftcms/cms/issues/12624))\n\n## 4.3.7 - 2023-02-03\n\n- Improved the performance of the \u201cGenerating pending image transforms\u201d queue job. ([#12274](https://github.com/craftcms/cms/issues/12274))\n- Removed the \u201cTimeout\u201d setting from the Gmail and SMTP mailer transporters, as they aren\u2019t supported by Symfony Mailer\u2019s transport configuration.\n- Removed the \u201cEncryption Method\u201d setting from the SMTP mailer transporter, as Symfony Mailer already uses TLS when port 465 is used (as it is by default).\n- The \u201cPort\u201d setting on the SMTP mailer transporter is no longer required. It will default to 465 or 25 depending on whether OpenSSL is installed.\n- Added more reserved field handles to avoid conflicts with `craft\\base\\Element` properties. ([#12577](https://github.com/craftcms/cms/issues/12577))\n- Assets\u2019 `alt` properties are now automatically trimmed of leading/trailing whitespace.\n- Asset element components in the control panel now include a `data-alt` attribute. ([#12600](https://github.com/craftcms/cms/discussions/12600))\n- Control panel requests no longer override the `pageTrigger` config setting value to `'p'`. ([#12598](https://github.com/craftcms/cms/issues/12598), [#12614](https://github.com/craftcms/cms/pull/12614))\n- Fixed field status badge styling in some contexts. ([#12403](https://github.com/craftcms/cms/issues/12403))\n- Fixed a bug where exporting elements with multiple field layouts as a CSV file using the \u201cExpanded\u201d export type would result in mismatched column values.\n- Fixed a bug where cancelling a conflicting volume folder move would result in the moved folder getting deleted.\n- Fixed a bug where `craft\\elements\\Category::canDuplicate()` wasn\u2019t factoring in save permissions.\n- Fixed a bug where the horizontal scroll position wasn\u2019t being retained when refreshing Live Preview. ([#12504](https://github.com/craftcms/cms/issues/12504))\n- Fixed a bug where user group condition rules for the default user group weren\u2019t getting matched properly during public registration. ([#12283](https://github.com/craftcms/cms/issues/12283))\n- Fixed a bug where HTML tags within field labels, instructions, tips, and warnings weren\u2019t always getting escaped.\n- Fixed a bug where the sidebar scroll position wasn\u2019t retained when selecting a new source on element index pages. ([#12523](https://github.com/craftcms/cms/issues/12523))\n- Fixed a bug where `resave/*` commands\u2019 output didn\u2019t take the offset into account. ([#12526](https://github.com/craftcms/cms/issues/12526))\n- Fixed a bug where warnings were getting logged for video assets that were \u201cmissing\u201d their dimensions.\n- Fixed a bug where `craft\\services\\Assets::getAllDescendantFolders()` could return unexpected results for folders that contained an underscore.\n- Fixed a bug where accessing a custom field\u2019s magic property on an element would return the field\u2019s raw database value rather than `null`, if it didn\u2019t belong to the element\u2019s field layout anymore. ([#12539](https://github.com/craftcms/cms/issues/12539), [#12578](https://github.com/craftcms/cms/pull/12578))\n- Fixed a bug where previewing an asset could wipe out all `h1` tags within Redactor fields. ([#12545](https://github.com/craftcms/cms/issues/12545))\n- Fixed a bug where `craft\\image\\Raster::getIsTransparent()` wasn\u2019t working. ([#12565](https://github.com/craftcms/cms/issues/12565))\n- Fixed a bug where textual condition rules were still showing a text input when the \u201cis empty\u201d or \u201chas a value\u201d operators were selected. ([#12587](https://github.com/craftcms/cms/pull/12587))\n- Fixed a bug where the component name comments in project config YAML files would always lag behind the current project config a little. ([#12576](https://github.com/craftcms/cms/issues/12576), [#12581](https://github.com/craftcms/cms/pull/12581))\n- Fixed a SQL error that occurred when creating a database backup using the default backup command, when running MySQL 5.7.41+ or 8.0.32+. ([#12557](https://github.com/craftcms/cms/issues/12557), [#12560](https://github.com/craftcms/cms/pull/12560))\n- Fixed a bug where database backups weren\u2019t respecting SSL database connection settings if they were specified when using MySQL. ([#10351](https://github.com/craftcms/cms/issues/10351), [#11753](https://github.com/craftcms/cms/issues/11753), [#12596](https://github.com/craftcms/cms/pull/12596))\n- Fixed a bug where element indexes could stop showing their loading spinner prematurely if the element listing needed to be reloaded multiple times in rapid succession. ([#12595](https://github.com/craftcms/cms/issues/12595))\n- Fixed a bug where element editors wouldn\u2019t show tabs that didn\u2019t contain any characters that could be converted to ASCII. ([#12602](https://github.com/craftcms/cms/issues/12602))\n- Fixed a bug where asset thumbnails weren\u2019t getting versioned in the control panel, unless the `revAssetUrls` config setting was enabled. ([#12603](https://github.com/craftcms/cms/issues/12603))\n- Fixed a bug where entry relations could be lost when switching entry types, for relational fields that didn\u2019t exist on the prior entry type. ([#12592](https://github.com/craftcms/cms/issues/12592))\n- Fixed a bug where Matrix blocks weren\u2019t getting duplicated to other sites when first editing an unpublished draft. ([#11366](https://github.com/craftcms/cms/issues/11366))\n- Fixed a bug where element indexes would show an expand/collapse toggle for structured elements that only had unsaved draft children, which aren\u2019t actually shown. ([#11253](https://github.com/craftcms/cms/issues/11253))\n- Fixed a SQL error that occurred when running the `index-assets` command on PostgreSQL. ([#12617](https://github.com/craftcms/cms/issues/12617))\n- Added `craft\\helpers\\Assets::revUrl()`.\n- Added `craft\\helpers\\Db::escapeForLike()`.\n- Added `craft\\web\\twig\\variables\\Paginate::$pageTrigger`. ([#12614](https://github.com/craftcms/cms/pull/12614))\n- `craft\\helpers\\Assets::revParams()` no longer takes the `revAssetUrls` config setting into account. That should be factored in by whatever is calling it.\n- `craft\\services\\Assets::getAllDescendantFolders()` now has a `$withParent` argument, which can be passed `false` to omit the parent folder from the results. ([#12536](https://github.com/craftcms/cms/issues/12536))\n- `craft\\services\\Matrix::duplicateBlocks()` now has a `$force` argument.\n- Deprecated `craft\\helpers\\DateTimeHelper::timeZoneAbbreviation()`.\n- Deprecated `craft\\helpers\\DateTimeHelper::timeZoneOffset()`.\n\n## 4.3.6.1 - 2023-01-09\n\n- Element edit pages now retain their previous scroll position when they\u2019re automatically refreshed to keep up with changes from another browser tab.\n- Fixed a bug where editing certain Matrix/Neo/Super Table fields could result in content loss. ([#12445](https://github.com/craftcms/cms/issues/12445))\n\n## 4.3.6 - 2023-01-04\n\n- Template caching is no longer enabled for tokenized requests. ([#12458](https://github.com/craftcms/cms/issues/12458))\n- Elisions are now stripped from search keywords. ([#12467](https://github.com/craftcms/cms/issues/12467), [#12474](https://github.com/craftcms/cms/pull/12474))\n- Added support for HEIC/HEIF images. ([#9115](https://github.com/craftcms/cms/discussions/9115))\n- The `allowedFileExtensions` config setting now includes `heic`, `heif`, and `hevc` by default. ([#12490](https://github.com/craftcms/cms/discussions/12490))\n- It\u2019s now possible to assign aliases `children` fields queried via GraphQL. ([#12494](https://github.com/craftcms/cms/pull/12494))\n- Added `craft\\helpers\\Image::isWebSafe()`.\n- Added `craft\\services\\Images::getSupportsHeic()`.\n- `Craft.MatrixInput` now fires `blockSortDragStop`, `beforeMoveBlockUp`, `moveBlockUp`, `beforeMoveBlockDown`, and `moveBlockDown` events. ([#12498](https://github.com/craftcms/cms/pull/12498))\n- Fixed a bug where deleting a field layout tab could result in duplicated tabs. ([#12459](https://github.com/craftcms/cms/issues/12459))\n- Fixed a bug where Feed widgets weren\u2019t showing feed items when they were first loaded. ([#12460](https://github.com/craftcms/cms/issues/12460))\n- Fixed an error that occurred when a Date field\u2019s condition rule was set to a relative range, \u201chas a value\u201d, or \u201cis empty\u201d. ([#12457](https://github.com/craftcms/cms/issues/12457))\n- Fixed an error that could occur when processing template caches in a console request, if a globally-scoped template cache was processed before it.\n- Fixed styling issues with large element thumbnail views. ([#12455](https://github.com/craftcms/cms/issues/12455))\n- Fixed a bug where it wasn\u2019t possible to retry all failed jobs when using a proxy queue. ([#12471](https://github.com/craftcms/cms/issues/12471))\n- Fixed a bug where the selected table columns would be forgotten if modified from a nested source. ([#12477](https://github.com/craftcms/cms/issues/12477))\n- Fixed a bug where some custom field property types in `craft\\behaviors\\CustomFieldBehavior` were incorrect.\n- Fixed an error that could occur if a Matrix sub-field\u2019s handle was too long. ([#12422](https://github.com/craftcms/cms/issues/12422))\n- Fixed a bug where element editor slideouts\u2019 submit buttons weren\u2019t always consistent with the full-page edit form. ([#12487](https://github.com/craftcms/cms/issues/12487))\n- Fixed an XSS vulnerability.\n\n## 4.3.5 - 2022-12-13\n\n- Fixed a bug where entry tab contents could remain visible when switching to other tabs, after changing the entry type.\n- Fixed a bug where it wasn\u2019t possible to enter `0` in Number fields, Money fields, and numeric column cells within editable tables, using certain keyboard layouts. ([#12412](https://github.com/craftcms/cms/issues/12412))\n- Fixed a bug where the default MySQL restore command would attempt to use credentials from `~/.my.cnf` if it existed, instead of Craft\u2019s configured database connection settings. ([#12349](https://github.com/craftcms/cms/issues/12349), [#12430](https://github.com/craftcms/cms/pull/12430))\n- Fixed a JavaScript error that could occur when autosaving an entry draft. ([#12445](https://github.com/craftcms/cms/issues/12445))\n- Added `craft\\base\\ApplicationTrait::onInit()`. ([#12439](https://github.com/craftcms/cms/pull/12439))\n- Added `craft\\console\\Controller::createDirectory()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::do()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::failure()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::note()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::success()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::tip()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::warning()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::writeJson()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\console\\Controller::writeToFile()`. ([#12438](https://github.com/craftcms/cms/pull/12438))\n- Added `craft\\helpers\\FileHelper::absolutePath()`.\n- Added `craft\\helpers\\FileHelper::findClosestFile()`.\n- Added `craft\\helpers\\FileHelper::isWithin()`.\n- Added `craft\\helpers\\FileHelper::relativePath()`.\n- Added `craft\\helpers\\Json::decodeFromFile()`.\n- Added `Craft.filterInputVal()`.\n- Added `Craft.filterNumberInputVal()`.\n\n## 4.3.4 - 2022-11-29\n\n- The `serve` command now routes requests for nonexistent files to Craft. ([#12310](https://github.com/craftcms/cms/pull/12310))\n- `craft\\base\\Element::includeSetStatusAction()` now returns `false` by default regardless of what `hasStatuses()` returns, fixing a bug where some element indexes were unexpectedly getting \u201cSet Status\u201d actions.\n- Query conditions generated by `craft\\helpers\\Db::parseParam()` no longer account for `null` values, due to a heavy performance impact. ([#11931](https://github.com/craftcms/cms/issues/11931))\n- Fixed a bug where the default MySQL backup command would attempt to use credentials from `~/.my.cnf` if it existed, instead of Craft\u2019s configured database connection settings. ([#12349](https://github.com/craftcms/cms/issues/12349))\n- Fixed a bug where it wasn\u2019t possible to access the Customize Sources modal if all sources were disabled. ([#12369](https://github.com/craftcms/cms/issues/12369))\n- Fixed a bug where Assets fields weren\u2019t taking their \u201cShow unpermitted volumes\u201d setting into account when defining the available input sources. ([#12364](https://github.com/craftcms/cms/issues/12364))\n- Fixed a bug where user slideouts included status toggles.\n- Updated Yii to 2.0.47.\n\n## 4.3.3 - 2022-11-17\n\n- Fixed an error that occurred if an arrow function was passed to the `|sort` Twig filter. ([#12334](https://github.com/craftcms/cms/issues/12334))\n- Fixed a bug where nested fields set to numbers could be inadvertently changed when an entry draft was created.\n- `craft\\services\\Fields::getFieldsWithContent()` and `getFieldsWithoutContent()` now have `$context` arguments.\n\n## 4.3.2.1 - 2022-11-16\n\n- Fixed a PHP error that could occur when generating an image transform. ([#12333](https://github.com/craftcms/cms/issues/12333))\n\n## 4.3.2 - 2022-11-16\n\n- `firstName` and `lastName` are now reserved field handles for the user field layout. ([#12241](https://github.com/craftcms/cms/issues/12241), [#12316](https://github.com/craftcms/cms/pull/12316))\n- Asset filenames are truncated in large thumbnail views, as they were before 4.3.0. ([#12236](https://github.com/craftcms/cms/discussions/12236))\n- Fixed an information disclosure vulnerability.\n- Fixed an XSS vulnerability.\n- Fixed asset indexing for Local filesystems that were configured to use a symlinked server path.\n- Fixed an error that could occur when calling `craft\\base\\Element::getCanonicalUid()` on a draft loaded for a site that the canonical element didn\u2019t exist on yet. ([#12228](https://github.com/craftcms/cms/issues/12228))\n- Fixed a bug where long words in asset titles weren\u2019t wrapping in the large thumbnail view. ([#12237](https://github.com/craftcms/cms/issues/12237))\n- Fixed a bug where the Users index page was showing a \u201cSet Status\u201d bulk action, making it possible to disable users.\n- Disabled users now identify themselves as disabled, and Edit User pages now provide a way for them to be re-enabled.\n- Fixed a layout issue that could occur on Assets fields using the \u201cLarge Thumbnails\u201d view mode. ([#12230](https://github.com/craftcms/cms/issues/12230))\n- Fixed a bug where elements that weren\u2019t viewable by the current user could still be hyperlinked in element indexes.\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateInterval()` could return a `DateInterval` that was off by an hour around daylight savings time changes.\n- Fixed a bug where sticky element index footers were obstructed when the Debug Toolbar was enabled. ([#12242](https://github.com/craftcms/cms/issues/12242))\n- Fixed a bug where it wasn\u2019t possible to change the sort attribute on element indexes while searching. ([#12256](https://github.com/craftcms/cms/issues/12256))\n- Fixed a bug where `resave/*` commands weren\u2019t catching exceptions thrown when applying the `--set` and `--to` options. ([#12262](https://github.com/craftcms/cms/issues/12262))\n- Fixed the position of field status indicators within Matrix fields in Live Preview. ([#12287](https://github.com/craftcms/cms/issues/12287))\n- Fixed PHP errors that could occur when executing GraphQL queries. ([#12271](https://github.com/craftcms/cms/pull/12271), [#12275](https://github.com/craftcms/cms/pull/12275))\n- Fixed a bug where it was possible to add a \u201cStatus\u201d condition rule to relational fields\u2019 selectable element conditions. ([#12289](https://github.com/craftcms/cms/issues/12289))\n- Fixed a PHP error that occurred if a field type stored enum values. ([#12297](https://github.com/craftcms/cms/issues/12297))\n- Fixed a bug where PHP errors and exceptions thrown when formatting a control panel screen response weren\u2019t being handled properly. ([#12308](https://github.com/craftcms/cms/issues/12308))\n- Fixed a bug where element indexes were showing the labels of empty Dropdown options when selected. ([#12319](https://github.com/craftcms/cms/issues/12319))\n- Fixed condition builder styling issues that occurred if any rules had exceptionally long names. ([#12311](https://github.com/craftcms/cms/issues/12311))\n- Fixed an error that occurred when saving an entry via GraphQL, if a parent entry was assigned that didn\u2019t exist on the requested site. ([#12291](https://github.com/craftcms/cms/issues/12291))\n- Fixed a bug where conditional fields weren\u2019t always saving for elements that didn\u2019t support autosaved drafts. ([#12166](https://github.com/craftcms/cms/issues/12166))\n- Fixed a bug where fields set to numbers could be inadvertently changed when an entry draft was created.\n- Added `craft\\base\\Element::includeSetStatusAction()`.\n- Added `craft\\services\\Fields::getFieldsWithoutContent()`.\n\n## 4.3.1 - 2022-10-27\n\n- Numeric values are no longer automatically formatted within element indexes. ([#12205](https://github.com/craftcms/cms/issues/12205))\n- When `craft\\base\\Element::EVENT_DEFINE_URL` event handlers set `craft\\events\\DefineUrlEvent::$url` to `null`, that will no longer be respected unless `$handled` was also set to `true`. ([#12210](https://github.com/craftcms/cms/issues/12210), [nystudio107/craft-imageoptimize#359](https://github.com/nystudio107/craft-imageoptimize/issues/359))\n- Asset folder and file names are now converted to ASCII using the primary site\u2019s language for character mappings, regardless of the current user\u2019s preferred language, when the `convertFilenamesToAscii` config setting is enabled. ([#12207](https://github.com/craftcms/cms/discussions/12207))\n- Fixed a bug where locked users\u2019 remaining cooldown times could be calculated incorrectly on PHP 8.0.\n- Fixed an infinite recursion bug that occurred when editing a Matrix field with a custom propagation method. ([#12176](https://github.com/craftcms/cms/issues/12176))\n- Fixed a bug where element index source lists were showing headings that didn\u2019t have any visible nested sources. ([#12193](https://github.com/craftcms/cms/issues/12193))\n- Fixed a JavaScript 404 error that occurred when users\u2019 Language was set to Chinese. ([#12194](https://github.com/craftcms/cms/issues/12194))\n- Fixed a bug where users couldn\u2019t delete their own addresses. ([craftcms/commerce#3011](https://github.com/craftcms/commerce/issues/3011))\n- Fixed a bug where the `users/save-address` action wasn\u2019t validating addresses properly.\n- Fixed an error that could occur during garbage collection, if any nested volume folders were missing their path. ([#12195](https://github.com/craftcms/cms/issues/12195))\n\n## 4.3.0 - 2022-10-25\n\n### Content Management\n- Added a \u201cView\u201d menu to element indexes, which enable users to customize the visible table columns for themselves, without affecting other users. ([#11915](https://github.com/craftcms/cms/pull/11915))\n- Added source setting menus to element index pages, which now contain the \u201cCustomize sources\u201d option when allowed, and \u201cNew subfolder\u201d, \u201cRename folder\u201d, and \u201cDelete folder\u201d actions on the Assets index page. ([#11906](https://github.com/craftcms/cms/pull/11906))\n- Added the \u201cEditable\u201d rule to asset and entry conditions. ([#11995](https://github.com/craftcms/cms/discussions/11995))\n- Improved control panel mobile support. ([#11963](https://github.com/craftcms/cms/pull/11963), [#12005](https://github.com/craftcms/cms/pull/12005))\n- Element indexes now respect field layouts\u2019 user conditions when determining which custom field columns to show. ([#11913](https://github.com/craftcms/cms/pull/11913))\n- Element index URLs now include the selected source key in a `source` query param, so all sources are now deep-linkable, including custom sources. ([#11996](https://github.com/craftcms/cms/discussions/11996))\n- Notifications are now shown after executing folder actions on the Assets index page. ([#11906](https://github.com/craftcms/cms/pull/11906))\n- Date range condition rules now support \u201cToday\u201d, \u201cThis week\u201d, \u201cThis month\u201d, \u201cThis year\u201d, \u201cPast 7 days\u201d, \u201cPast 30 days\u201d, \u201cPast 30 days\u201d, \u201cPast year\u201d, \u201cBefore\u2026\u201d, and \u201cAfter\u2026\u201d relative range types, in addition to specifying a custom date range. ([#10749](https://github.com/craftcms/cms/discussions/10749), [#11888](https://github.com/craftcms/cms/pull/11888))\n- Number condition rules now support an \u201cis between\u2026\u201d operator. ([#11950](https://github.com/craftcms/cms/pull/11950))\n- All text, number, and date range condition rules now support \u201chas a value\u201d and \u201cis empty\u201d operators. ([#11070](https://github.com/craftcms/cms/discussions/11070))\n- \u201cSave as a new [element type]\u201d actions will now discard any unsaved changes on the original element after the new element is created. ([#10204](https://github.com/craftcms/cms/issues/10204), [#11959](https://github.com/craftcms/cms/issues/11959), [#12102](https://github.com/craftcms/cms/issues/12102), [#12165](https://github.com/craftcms/cms/issues/12165))\n- If Live Preview is triggered while a draft is saving, it will now wait until the save completes before opening. ([#11858](https://github.com/craftcms/cms/issues/11858), [#11895](https://github.com/craftcms/cms/pull/11895))\n- Addresses now support change tracking.\n- It\u2019s now possible to restore assets that were deleted programmatically with `craft\\elements\\Asset::$keepFile` set to `true`. ([#11761](https://github.com/craftcms/cms/issues/11761))\n\n### Accessibility\n- Improved the styling of selected sidebar navigation items to meet contrast requirements. ([#11589](https://github.com/craftcms/cms/pull/11589))\n- Improved the styling of slideouts for screens under 600 pixels wide. ([#11636](https://github.com/craftcms/cms/pull/11636))\n- Improved the styling of the primary button on element index pages for small screens. ([#11963](https://github.com/craftcms/cms/pull/11963))\n- Improved the contrast of modal resize handles. ([#11727](https://github.com/craftcms/cms/pull/11727))\n- Improved the contrast of fields\u2019 searchable and translatable indicator icons on the Fields index page. ([#12169](https://github.com/craftcms/cms/pull/12169))\n- Improved the contrast of the \u201cSame as language\u201d text within the \u201cFormatting Locale\u201d user preference. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Improved the contrast of the selected options within combo boxes. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved the readability of the global navigation and date pickers when text is resized to 200%. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Improved focus management for HUD components. ([#11985](https://github.com/craftcms/cms/pull/11985))\n- Improved focus management for element index pagination links.  ([#11565](https://github.com/craftcms/cms/pull/11565)).\n- Improved focus management for editable tables. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Custom slider components now support <kbd>Home</kbd> and <kbd>End</kbd> key presses. ([#11578](https://github.com/craftcms/cms/pull/11578))\n- Improved the markup and keyboard control for exclusive button groups. ([#11942](https://github.com/craftcms/cms/pull/11942))\n- Improved keyboard control for the widget manager HUD on the Dashboard. ([#11578](https://github.com/craftcms/cms/pull/11578))\n- Improved New Widget and Quick Post action menus for screen readers. ([#11611](https://github.com/craftcms/cms/pull/11611))\n- Improved the widget manager HUD for screen readers. ([#11945](https://github.com/craftcms/cms/pull/11945))\n- Improved the Craft Support widget for screen readers. ([#11703](https://github.com/craftcms/cms/pull/11703))\n- Improved element index view mode buttons for screen readers. ([#11613](https://github.com/craftcms/cms/pull/11613))\n- Improved element type selects within \u201cRelated To\u201d condition rules for screen readers. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved element action modals for screen readers. ([#11905](https://github.com/craftcms/cms/issues/7377))\n- Improved field instructions, errors, and other visually-related text for screen readers. ([#11763](https://github.com/craftcms/cms/issues/7377))\n- Improved field translation indicators for screen readers. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved the parent selection button on structured entries\u2019 and categories\u2019 edit pages for screen readers. ([#11662](https://github.com/craftcms/cms/pull/11662))\n- Improved the Rotate button within Live Preview for screen readers. ([#11953](https://github.com/craftcms/cms/pull/11953))\n- Improved Date fields for screen readers. ([#10546](https://github.com/craftcms/cms/pull/10546))\n- Fixed a mismatch between the visible and accessible text on the site name in the global sidebar. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Added alternative text to element status indicators. ([#11604](https://github.com/craftcms/cms/pull/11604))\n- Feed, Recent Entries, and Drafts widgets now use semantic lists instead of tables. ([#11952](https://github.com/craftcms/cms/pull/11952))\n- Added autocomplete attributes to several address fields. ([#11767](https://github.com/craftcms/cms/pull/11767))\n- Implemented fieldsets and descriptive headings on user accounts\u2019 \u201cPreferences\u201d tab. ([#11534](https://github.com/craftcms/cms/pull/11534))\n- The \u201cAll\u201d status option within element index toolbars now uses a differentiated gradient icon. ([#11911](https://github.com/craftcms/cms/pull/11911))\n- Improved status indicator shapes, when the \u201cUse shapes to represent statuses\u201d user preference is enabled. ([#11911](https://github.com/craftcms/cms/pull/11911))\n- Boolean table columns within element indexes now use check icons to indicate `true` values. ([#11911](https://github.com/craftcms/cms/pull/11911))\n- Element titles are no longer truncated on edit pages. ([#11768](https://github.com/craftcms/cms/pull/11768))\n- Asset titles are no longer truncated in asset indexes. ([#11775](https://github.com/craftcms/cms/pull/11775))\n- Element source navigation now programmatically conveys structure imparted by headings. ([#11777](https://github.com/craftcms/cms/pull/11777))\n- Added a warning icon to related elements that contain validation errors. ([#11610](https://github.com/craftcms/cms/pull/11610))\n- Element index footers now stick to the bottom of the window, and element action triggers are now inserted into the footer rather than replacing the contents of the page\u2019s toolbar. ([#11844](https://github.com/craftcms/cms/pull/11844))\n\n### Administration\n- Added the `extraLastNamePrefixes` config setting. ([#11903](https://github.com/craftcms/cms/pull/11903))\n- Added the `extraNameSalutations` config setting. ([#11903](https://github.com/craftcms/cms/pull/11903))\n- Added the `extraNameSuffixes` config setting. ([#11903](https://github.com/craftcms/cms/pull/11903))\n- Element sources now have a \u201cDefault Sort\u201d setting in the Customize Sources modal. ([#12002](https://github.com/craftcms/cms/discussions/12002))\n- Control panel-defined image transforms can now have custom quality values. ([#9622](https://github.com/craftcms/cms/discussions/9622))\n- Added support for the `CRAFT_DOTENV_PATH` PHP constant. ([#11894](https://github.com/craftcms/cms/discussions/11894))\n- Added support for `CRAFT_WEB_URL` and `CRAFT_WEB_ROOT` environment variables/PHP constants, which can be used to set the default `@web` and `@webroot` alias values. ([#11912](https://github.com/craftcms/cms/pull/11912))\n\n### Development\n- Added the `canCreateDrafts()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canDelete()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canDeleteForSite()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canDuplicate()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canSave()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `canView()` Twig function. ([#11797](https://github.com/craftcms/cms/discussions/11797), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added the `|boolean` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Added the `|float` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Added the `|integer` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Added the `|string` Twig filter. ([#11792](https://github.com/craftcms/cms/pull/11792))\n- Twig templates now have `today`, `tomorrow`, and `yesterday` global variables available to them.\n- Element query date params now support passing `today`, `tomorrow`, and `yesterday`. ([#10485](https://github.com/craftcms/cms/issues/10485))\n- Element queries\u2019 `relatedTo` params now only check for relations in the same site as `siteId`, if set. ([#12000](https://github.com/craftcms/cms/issues/12000), [#12072](https://github.com/craftcms/cms/pull/12072))\n- Element queries now support passing ambiguous column names (e.g. `dateCreated`) and field handles into `select()`. ([#11790](https://github.com/craftcms/cms/pull/11790), [#11800](https://github.com/craftcms/cms/pull/11800))\n- Element queries\u2019 `collect()` methods eager-loaded elements now return `craft\\elements\\ElementCollection` objects, which extends `Illuminate\\Support\\Collection` with `ids()` and `with()` methods. ([#12113](https://github.com/craftcms/cms/discussions/12113))\n- `{% cache %}` tags now store any HTML registered with `{% html %}` tags. ([#11811](https://github.com/craftcms/cms/discussions/11811))\n- `{% cache %}` tags and GraphQL query caches now get a max cache duration based on the fetched/referenced entries\u2019 expiry dates. ([#8525](https://github.com/craftcms/cms/discussions/8525), [#11901](https://github.com/craftcms/cms/pull/11901))\n- Added the `siteHandle` field to elements queried via GraphQL. ([#10829](https://github.com/craftcms/cms/discussions/10829))\n- `users/session-info` responses now include a `csrfTokenName` key. ([#11706](https://github.com/craftcms/cms/pull/11706), [#11767](https://github.com/craftcms/cms/pull/11767))\n- The `elements/save-draft` action now supports being called from the front end. ([#12131](https://github.com/craftcms/cms/issues/12131))\n- The `users/upload-user-photo` action now includes a `photoId` key in the response data. ([#12175](https://github.com/craftcms/cms/pull/12175))\n\n### Extensibility\n- Added `craft\\base\\conditions\\BaseTextConditionRule::inputOptions()`.\n- Added `craft\\base\\Element::EVENT_DEFINE_URL`. ([#12168](https://github.com/craftcms/cms/pull/12168))\n- Added `craft\\base\\ExpirableElementInterface`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\controllers\\ElementsController::$element`.\n- Added `craft\\db\\ActiveQuery::collect()`. ([#11842](https://github.com/craftcms/cms/pull/11842))\n- Added `craft\\elements\\actions\\Restore::$restorableElementsOnly`.\n- Added `craft\\elements\\conditions\\assets\\EditableConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\EditableConditionRule`.\n- Added `craft\\elements\\ElementCollection`. ([#12113](https://github.com/craftcms/cms/discussions/12113))\n- Added `craft\\events\\AuthorizationCheckEvent::$element`.\n- Added `craft\\events\\CreateTwigEvent`.\n- Added `craft\\events\\DefineAddressFieldLabelEvent`.\n- Added `craft\\events\\DefineAddressFieldsEvent`.\n- Added `craft\\events\\DefineUrlEvent`. ([#12168](https://github.com/craftcms/cms/pull/12168))\n- Added `craft\\events\\ImageTransformerOperationEvent::$tempPath`.\n- Added `craft\\events\\SearchEvent::$scores`. ([#11882](https://github.com/craftcms/cms/discussions/11882))\n- Added `craft\\events\\UserGroupPermissionsEvent`.\n- Added `craft\\events\\UserPermissionsEvent`.\n- Added `craft\\helpers\\DateRange`.\n- Added `craft\\helpers\\DateTimeHelper::firstWeekDay()`.\n- Added `craft\\helpers\\DateTimeHelper::lastMonth()`.\n- Added `craft\\helpers\\DateTimeHelper::lastWeek()`.\n- Added `craft\\helpers\\DateTimeHelper::lastWeekDay()`.\n- Added `craft\\helpers\\DateTimeHelper::lastYear()`.\n- Added `craft\\helpers\\DateTimeHelper::nextMonth()`.\n- Added `craft\\helpers\\DateTimeHelper::nextWeek()`.\n- Added `craft\\helpers\\DateTimeHelper::nextYear()`.\n- Added `craft\\helpers\\DateTimeHelper::thisMonth()`.\n- Added `craft\\helpers\\DateTimeHelper::thisWeek()`.\n- Added `craft\\helpers\\DateTimeHelper::thisYear()`.\n- Added `craft\\helpers\\DateTimeHelper::today()`.\n- Added `craft\\helpers\\DateTimeHelper::tomorrow()`.\n- Added `craft\\helpers\\DateTimeHelper::yesterday()`.\n- Added `craft\\helpers\\ElementHelper::attributeHtml()`.\n- Added `craft\\helpers\\Html::svg()`. ([#11932](https://github.com/craftcms/cms/pull/11932))\n- Added `craft\\i18n\\FormatConverter::convertDatePhpToHuman()`. ([#10546](https://github.com/craftcms/cms/pull/10546))\n- Added `craft\\i18n\\Locale::FORMAT_HUMAN`.\n- Added `craft\\nameparsing\\CustomLanguage`.\n- Added `craft\\services\\Addresses::EVENT_DEFINE_FIELD_LABEL`. ([#11788](https://github.com/craftcms/cms/discussions/11788))\n- Added `craft\\services\\Addresses::EVENT_DEFINE_USED_FIELDS`. ([#11788](https://github.com/craftcms/cms/discussions/11788))\n- Added `craft\\services\\Addresses::EVENT_DEFINE_USED_SUBDIVISION_FIELDS`. ([#11788](https://github.com/craftcms/cms/discussions/11788))\n- Added `craft\\services\\Addresses::getFieldLabel()`.\n- Added `craft\\services\\Addresses::getUsedFields()`.\n- Added `craft\\services\\Addresses::getUsedSubdivisionFields()`.\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_CREATE_DRAFTS`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE_FOR_SITE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_DUPLICATE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_SAVE`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::EVENT_AUTHORIZE_VIEW`. ([#11759](https://github.com/craftcms/cms/discussions/11759), [#11808](https://github.com/craftcms/cms/pull/11808))\n- Added `craft\\services\\Elements::canCreateDrafts()`.\n- Added `craft\\services\\Elements::canDelete()`.\n- Added `craft\\services\\Elements::canDeleteForSite()`.\n- Added `craft\\services\\Elements::canDuplicate()`.\n- Added `craft\\services\\Elements::canSave()`.\n- Added `craft\\services\\Elements::canView()`.\n- Added `craft\\services\\Elements::getIsCollectingCacheInfo()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Elements::setCacheExpiryDate()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Elements::startCollectingCacheInfo()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Elements::stopCollectingCacheInfo()`. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Added `craft\\services\\Search::EVENT_BEFORE_SCORE_RESULTS`. ([#11882](https://github.com/craftcms/cms/discussions/11882))\n- Added `craft\\services\\UserPermissions::EVENT_AFTER_SAVE_GROUP_PERMISSIONS`. ([#12130](https://github.com/craftcms/cms/discussions/12130), [#12146](https://github.com/craftcms/cms/pull/12146))\n- Added `craft\\services\\UserPermissions::EVENT_AFTER_SAVE_USER_PERMISSIONS`. ([#12130](https://github.com/craftcms/cms/discussions/12130), [#12146](https://github.com/craftcms/cms/pull/12146))\n- Added `craft\\web\\Controller::currentUser()`. ([#11754](https://github.com/craftcms/cms/pull/11754), [#11916](https://github.com/craftcms/cms/pull/11916))\n- Added `craft\\web\\View::EVENT_AFTER_CREATE_TWIG`. ([#11774](https://github.com/craftcms/cms/pull/11774))\n- `craft\\elements\\Asset::EVENT_DEFINE_URL` now gets triggered after the default URL has been generated, and the URL will be passed to `craft\\events\\DefineAssetUrlEvent::$url`.\n- `craft\\elements\\db\\ElementQuery::collect()` and `craft\\base\\Element::getEagerLoadedElements()` now return `craft\\elements\\ElementCollection` instances. ([#12113](https://github.com/craftcms/cms/discussions/12113))\n- `craft\\events\\DraftEvent::$creatorId` is now nullable. ([#11904](https://github.com/craftcms/cms/issues/11904))\n- `craft\\fieldlayoutelements\\BaseField::statusClass()` and `statusLabel()` now return status info from the element for the attribute specified by `attribute()`.\n- `craft\\helpers\\Component::iconSvg()` now namespaces the SVG contents, and adds `aria-hidden=\"true\"`. ([#11703](https://github.com/craftcms/cms/pull/11703))\n- `craft\\services\\Drafts::createDraft()` now accepts `null` passed to its `$creatorId` argument. ([#11904](https://github.com/craftcms/cms/issues/11904))\n- `craft\\services\\Search::EVENT_AFTER_SEARCH` now includes the computed search result scores, set to `craft\\events\\SearchEvent::$scores`, and any changes made to it will be returned by `searchElements()`. ([#11882](https://github.com/craftcms/cms/discussions/11882))\n- `craft\\services\\Search::EVENT_BEFORE_INDEX_KEYWORDS` is now cancellable by setting `$event->isValid` to `false`. ([#11705](https://github.com/craftcms/cms/discussions/11705))\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_CREATE_DRAFTS`. `craft\\services\\Elements::EVENT_AUTHORIZE_CREATE_DRAFTS` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_DELETE_FOR_SITE`. `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE_FOR_SITE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_DELETE`. `craft\\services\\Elements::EVENT_AUTHORIZE_DELETE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_DUPLICATE`. `craft\\services\\Elements::EVENT_AUTHORIZE_DUPLICATE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_SAVE`. `craft\\services\\Elements::EVENT_AUTHORIZE_SAVE` should be used instead.\n- Deprecated `craft\\base\\Element::EVENT_AUTHORIZE_VIEW`. `craft\\services\\Elements::EVENT_AUTHORIZE_VIEW` should be used instead.\n- Deprecated `craft\\elements\\Address::addressAttributeLabel()`. `craft\\services\\Addresses::getFieldLabel()` should be used instead.\n- Deprecated `craft\\events\\DefineAssetUrlEvent::$asset`. `$sender` should be used instead.\n- Deprecated `craft\\services\\Elements::getIsCollectingCacheTags()`. `getIsCollectingCacheInfo()` should be used instead. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Deprecated `craft\\services\\Elements::startCollectingCacheTags()`. `startCollectingCacheInfo()` should be used instead. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- Deprecated `craft\\services\\Elements::stopCollectingCacheTags()`. `stopCollectingCacheInfo()` should be used instead. ([#11901](https://github.com/craftcms/cms/pull/11901))\n- `checkboxSelect` inputs without `showAllOption: true` now post an empty value if no options were selected. ([#11748](https://github.com/craftcms/cms/issues/11748))\n- Added the `Craft.useMobileStyles()` JavaScript method. ([#11636](https://github.com/craftcms/cms/pull/11636))\n- Added `Craft.BaseElementIndex::getParentSource()`.\n- Added `Craft.BaseElementIndex::getRootSource()`.\n- Added `Craft.BaseElementIndex::getSourceActions()`. ([#11906](https://github.com/craftcms/cms/pull/11906))\n- Added `Craft.BaseElementIndex::getSourceLevel()`.\n- `Craft.BaseElementSelectInput` now triggers a `change` event when elements are added programmatically or removed.\n\n### System\n- Name parsing now checks for common German salutations, suffixes, and last name prefixes.\n- \u201cGenerating pending image transforms\u201d jobs no longer attempt to process transforms that had previously failed. ([#11970](https://github.com/craftcms/cms/issues/11970))\n- The default system email template now sets the `lang` attribute on the `<html>` tag. ([#12156](https://github.com/craftcms/cms/pull/12156))\n- The default system email template now includes a `Content-Type` tag. ([#12156](https://github.com/craftcms/cms/pull/12156))\n- Improved GraphQL cache reliability. ([#11994](https://github.com/craftcms/cms/issues/11994), [#12086](https://github.com/craftcms/cms/pull/12086))\n- Control panel `.twig` templates are now prioritized over `.html`. ([#11809](https://github.com/craftcms/cms/discussions/11809), [#11840](https://github.com/craftcms/cms/pull/11840))\n- Updated Yii to 2.0.46.\n- Fixed a bug where addresses weren\u2019t validating their country codes. ([#12161](https://github.com/craftcms/cms/issues/12161))\n- Fixed a bug where Entry URI Format, Template, and Default Status switches were focusable within sections\u2019 Site Settings tables, for disabled sites.\n- Fixed a bug where `craft\\helpers\\Db::parseParam()` wasn\u2019t generating conditions that would include `null` values when it should have. ([#11931](https://github.com/craftcms/cms/issues/11931))\n\n## 4.2.8 - 2022-10-18\n\n### Changed\n- The `setup/keys` command will now set the application ID if `Craft::$app->id` is empty. ([#12103](https://github.com/craftcms/cms/pull/12103))\n\n### Fixed\n- Fixed an error that could occur when running tests. ([#12088](https://github.com/craftcms/cms/issues/12088), [#12089](https://github.com/craftcms/cms/issues/12089))\n- Fixed a bug where the `db/restore` command would output a warning about a missing `info` row, even if one existed in the imported database. ([#12101](https://github.com/craftcms/cms/issues/12101))\n- Fixed a bug where the \u201cYour session has ended\u201d modal could be shown on the control panel\u2019s login page. ([#12121](https://github.com/craftcms/cms/issues/12121))\n- Fixed a permission error that could occur when uploading a file to an Assets field.\n- Fixed a bug where custom log targets were getting removed when processing queue jobs. ([#12109](https://github.com/craftcms/cms/pull/12109))\n- Fixed a bug where Money fields weren\u2019t distinguishing between `0` and empty values. ([#12122](https://github.com/craftcms/cms/issues/12122), [#12132](https://github.com/craftcms/cms/pull/12132))\n- Fixed an error that could occur in the control panel. ([#12133](https://github.com/craftcms/cms/issues/12133))\n- Fixed a bug where assets uploaded from Assets fields weren\u2019t retaining their original filename for all but the initial site. ([#12142](https://github.com/craftcms/cms/pull/12142))\n- Fixed a bug where non-admin users couldn\u2019t always see the Temporary Uploads source when selecting assets from an Assets field. ([#12128](https://github.com/craftcms/cms/issues/12128))\n- Fixed a bug where image transforms that used the `fit` mode but didn\u2019t specify a width or height weren\u2019t getting their missing dimension set on the asset. ([#12137](https://github.com/craftcms/cms/issues/12137))\n\n## 4.2.7 - 2022-10-11\n\n### Added\n- Added the `setup/keys` command, which ensure Craft is configured with an application ID and security key.\n\n### Changed\n- The `install/craft` command now runs `setup/keys` before doing anything else.\n\n## 4.2.6 - 2022-10-11\n\n### Added\n- Added the `--as-json` option to the `help` command. ([#12017](https://github.com/craftcms/cms/pull/12017), [#12074](https://github.com/craftcms/cms/pull/12074))\n- Added `craft\\helpers\\ElementHelper::isAttributeEmpty()`.\n- Added `craft\\queue\\jobs\\ResaveElements::$ifEmpty`.\n- Added `craft\\queue\\jobs\\ResaveElements::$set`.\n- Added `craft\\queue\\jobs\\ResaveElements::$to`.\n- Added `craft\\queue\\jobs\\ResaveElements::$touch`.\n\n### Changed\n- When passing a PHP callback function to the `--to` option of a `resave/*` command, the `$element` argument is now optional.\n\n### Deprecated\n- Deprecated `craft\\web\\assets\\focusvisible\\FocusVisibleAsset`. ([#12037](https://github.com/craftcms/cms/pull/12037))\n\n### Fixed\n- Fixed an error that could occur when editing a draft of an element type that didn\u2019t have change tracking enabled.\n- Fixed an error that could occur when saving an entry with Matrix blocks, if the entry had been deleted for a site.\n- Fixed a bug where `resave/*` commands weren\u2019t respecting the `--set`, `--to`, or `--touch` options when `--queue` was passed. ([#11974](https://github.com/craftcms/cms/issues/11974))\n- Fixed a bug where `relatedTo` params didn\u2019t support collections.\n- Fixed an error that could occur when passing an element query to a `relatedTo` param, if the parent element query contained any closures. ([#11981](https://github.com/craftcms/cms/issues/11981))\n- Fixed a bug where `craft\\log\\MonologTarget::$allowLineBreaks` wasn\u2019t getting a default value. ([#12004](https://github.com/craftcms/cms/pull/12004))\n- Fixed a PHP error that occurred when attempting to edit an element by an invalid ID or UUID.\n- Fixed a bug where unsaved drafts could be unintentionally deleted when saved, if a plugin or module was blocking the save via `EVENT_BEFORE_SAVE`. ([#12015](https://github.com/craftcms/cms/issues/12015))\n- Fixed a bug where \u201cPropagating tags\u201d jobs would fail if two tags had similar titles.\n- Fixed a bug where pressing \u201cDisable focal point\u201d within asset preview modals would only reset the focal point position, but not delete it. ([#12030](https://github.com/craftcms/cms/issues/12030))\n- Fixed a bug where image transforms weren\u2019t getting sized correctly in some cases when `upscaleImages` was disabled. ([#12023](https://github.com/craftcms/cms/issues/12023))\n- Fixed a bug where table cells within Redactor fields could appear to be focused when they weren\u2019t. ([#12001](https://github.com/craftcms/cms/issues/12001), [#12037](https://github.com/craftcms/cms/pull/12037))\n- Fixed a bug where alerts saying a folder can\u2019t be renamed due to a naming conflict were showing the old folder name instead of the new one. ([#12049](https://github.com/craftcms/cms/pull/12049))\n- Fixed a bug where custom fields nested within Matrix fields weren\u2019t always updating properly within slideout editors. ([#11988](https://github.com/craftcms/cms/issues/11988), [#12058](https://github.com/craftcms/cms/issues/12058))\n- Fixed an error that could occur when adding new textual condition rules to a condition. ([#12077](https://github.com/craftcms/cms/pull/12077))\n- Fixed a bug where Table fields\u2019 Default Values settings were always showing at least one row, even if the setting had been saved without any rows. ([#12071](https://github.com/craftcms/cms/issues/12071))\n- Fixed a bug where existing rows in Table fields\u2019 Default Values settings were losing the ability to be reordered or deleted when the table columns were changed.\n- Fixed a bug where sending a password reset email for an inactive user would set them to a pending state. ([#12080](https://github.com/craftcms/cms/pull/12080))\n- Fixed a bug where some GraphQL results could be missing if multiple sets of nested elements were being queried using the same alias. ([#11982](https://github.com/craftcms/cms/issues/11982))\n\n### Security\n- Fixed information disclosure vulnerabilities.\n\n## 4.2.5.2 - 2022-10-03\n\n### Security\n- Updated Twig to 3.4. ([#12022](https://github.com/craftcms/cms/issues/12022))\n\n## 4.2.5.1 - 2022-09-21\n\n### Fixed\n- Fixed a bug where the \u201cNew category\u201d button could be missing from the Categories index page. ([#11977](https://github.com/craftcms/cms/issues/11977))\n- Fixed a bug where `Craft::t()` and the `|t` Twig filter were modifying digit-dash-digit sequences. ([#11980](https://github.com/craftcms/cms/issues/11980))\n- Fixed PHP errors that occurred if `webonyx/graphql-php` 14.11.17 was installed. ([#11979](https://github.com/craftcms/cms/issues/11979), [webonyx/graphql-php#1221](https://github.com/webonyx/graphql-php/issues/1221))\n- Fixed a PHP error that could occur when working with a draft. ([#11976](https://github.com/craftcms/cms/issues/11976))\n\n## 4.2.5 - 2022-09-20\n\n### Added\n- Added `craft\\helpers\\Image::targetDimensions()`.\n\n### Changed\n- Edit Asset pages now show the \u201cView\u201d button for all file types, not just images, PDFs, and text files. ([#11936](https://github.com/craftcms/cms/issues/11936))\n\n### Removed\n- Removed the Punycode PHP library. ([#11948](https://github.com/craftcms/cms/issues/11948))\n\n### Fixed\n- Fixed a bug where image transforms weren\u2019t always getting applied properly to all animation frames. ([#11937](https://github.com/craftcms/cms/pull/11937))\n- Fixed a bug where animated WebP images would lose their animation frames when transformed. ([#11937](https://github.com/craftcms/cms/pull/11937))\n- Fixed a bug where image transform dimensions could be calculated incorrectly when `upscaleImages` was `false`. ([#11837](https://github.com/craftcms/cms/issues/11837))\n- Fixed a bug where the `users/send-password-reset-email` action wasn\u2019t passing errors back to the template. ([#11933](https://github.com/craftcms/cms/issues/11933))\n- Fixed an error that occurred when setting a non-numeric `width` or `height` on an image transform. ([#11837](https://github.com/craftcms/cms/issues/11837))\n- Fixed a bug where the database connection wasn\u2019t being configured properly when fluent config methods and environment variable overrides were being used in combination. ([#11941](https://github.com/craftcms/cms/issues/11941))\n- Fixed a bug where slideouts lost their shadows when focused.\n- Fixed a bug where `relatedTo*` arguments weren\u2019t supported by `children` fields in GraphQL. ([#11918](https://github.com/craftcms/cms/issues/11918))\n- Fixed a bug where Image Editor and slideout action buttons were obstructed when the Debug Toolbar was enabled. ([#11965](https://github.com/craftcms/cms/issues/11965))\n- Fixed an error that occurred when installing Craft when MySQL\u2019s `sql_require_primary_key` setting was enabled. ([#11374](https://github.com/craftcms/cms/discussions/11374))\n- Fixed a bug subfolders created by Assets fields could be reported as missing when updating asset indexes, even if they contained assets. ([#11949](https://github.com/craftcms/cms/issues/11949))\n- Fixed a PHP error that could occur in a potential race condition when calling  `craft\\helpers\\FileHelper::clearDirectory()`.\n- Fixed a bug where Structure section entries that were duplicated via the \u201cSave as a new entry\u201d action on a provisional draft weren\u2019t being placed within the structure properly.\n- Fixed a bug where element\u2019s `searchScore` properties would be set to `null` when their original score was below 1, rather than rounding to 0 or 1. ([#11973](https://github.com/craftcms/cms/issues/11973))\n\n## 4.2.4 - 2022-09-13\n\n### Changed\n- The \u201cNew entry\u201d and \u201cNew category\u201d buttons on the Entries and Categories index pages now support <kbd>Ctrl</kbd>/<kbd>Command</kbd>/middle-clicking to open the edit page in a new window. ([#11870](https://github.com/craftcms/cms/issues/11870))\n- Control panel menus now automatically reposition themselves when the window is resized.\n- Improved the performance of some element queries on MySQL. ([#11825](https://github.com/craftcms/cms/pull/11825))\n- `resave/*` commands now have a `--touch` option. When passed, elements\u2019 `dateUpdated` timestamps will be updated as they\u2019re resaved. ([#11849](https://github.com/craftcms/cms/discussions/11849))\n- Underscores within query param values that begin/end with `*` are now escaped, so they aren\u2019t treated as wildcard characters by the `like` condition. ([#11898](https://github.com/craftcms/cms/issues/11898))\n- `craft\\services\\Elements::resaveElements()` now has a `$touch` argument.\n- Disable the preview button while drafts are saving ([#11858](https://github.com/craftcms/cms/issues/11858))\n\n### Fixed\n- Fixed an error that could occur when upgrading to Craft 4, if any Matrix blocks contained null `sortOrder` values. ([#11843](https://github.com/craftcms/cms/issues/11843))\n- Fixed a bug where image transform dimensions could be calculated incorrectly when `upscaleImages` was `false`. ([#11837](https://github.com/craftcms/cms/issues/11837))\n- Fixed an error that occurred when parsing an image transform string that was missing an interlace type. ([#11834](https://github.com/craftcms/cms/pull/11834))\n- Fixed a bug where element caches weren\u2019t being invalidated during garbage collection, so hard-deleted elements could appear to still exist.\n- Fixed a bug where image transforms were always getting saved with `dateIndexed` set to `null`. ([#11863](https://github.com/craftcms/cms/pull/11863))\n- Fixed an error that could occur when rendering front-end templates if there was a problem connecting to the database. ([#11855](https://github.com/craftcms/cms/issues/11855))\n- Fixed a bug where Edit Asset pages were showing the \u201cView\u201d button for assets in volumes without public URLs. ([#11860](https://github.com/craftcms/cms/issues/11860))\n- Fixed a bug where the Assets index page wasn\u2019t handling failed uploads properly. ([#11866](https://github.com/craftcms/cms/issues/11866))\n- Fixed a bug where it was possible to save an asset with a focal point outside its cropped area. ([#11875](https://github.com/craftcms/cms/issues/11875))\n- Fixed a bug where element index filter HUDs were unresponsive if another one was already active for a different site/source. ([#11880](https://github.com/craftcms/cms/issues/11880))\n- Fixed a bug where newly-created subfolders on the Assets index page could appear to have the wrong indentation.\n- Fixed a UI bug where renaming a newly-created volume subfolder didn\u2019t appear to have any effect.\n- Fixed a bug where empty URL fields would be marked as changed, even when no change was made to them. ([#11908](https://github.com/craftcms/cms/issues/11908))\n- Fixed a UI bug where autosuggest menus weren\u2019t getting filtered when first opened for inputs with existing values. ([#11896](https://github.com/craftcms/cms/issues/11896))\n- Fixed a bug where Entry Type condition rules weren\u2019t working for conditions that were applied to a single element. ([#11914](https://github.com/craftcms/cms/issues/11914))\n- Fixed a bug where Related To condition rules weren\u2019t working for conditions that were applied to a single element, for cross-site relations. ([#11892](https://github.com/craftcms/cms/issues/11892))\n- Fixed a bug where form action keyboard shortcuts weren\u2019t available when a custom select menu was focused. ([#11919](https://github.com/craftcms/cms/issues/11919))\n- Fixed a bug where transforming an animated GIF into a WebP file would only include the first frame. ([#11889](https://github.com/craftcms/cms/issues/11889))\n- Fixed a bug where `craft\\models\\FieldLayout::createFromConfig()` was ignoring `id`, `uid`, `type`, and `reservedFieldHandles` keys, if set. ([#11929](https://github.com/craftcms/cms/issues/11929))\n\n### Security\n- Fixed XSS vulnerabilities.\n- Password inputs no longer temporarily reveal the password when the <kbd>Alt</kbd> key is pressed. ([#11930](https://github.com/craftcms/cms/issues/11930))\n\n## 4.2.3 - 2022-08-26\n\n### Changed\n- If a plugin\u2019s license key is set to an empty environment variable, its trial license key will now be stored in `.env` rather than the project config. ([#11830](https://github.com/craftcms/cms/issues/11830))\n\n### Fixed\n- Fixed a PHP error that occurred when garbage collection was run on web requests. ([#11829](https://github.com/craftcms/cms/issues/11829))\n\n## 4.2.2 - 2022-08-23\n\n### Added\n- Added the `utils/fix-field-layout-uids` command. ([#11746](https://github.com/craftcms/cms/issues/11746))\n\n### Changed\n- Improved the styling of Categories fields.\n- The first field group is now automatically selected by default when creating a new custom field.\n- Improved console output for the `gc` command.\n- The `gc` command now runs garbage collection for data caches.\n- Exception JSON responses now include `name` and `code` keys. ([#11799](https://github.com/craftcms/cms/discussions/11799))\n- `elements/*` actions no longer include custom field values in the failure response data, improving performance. ([#11807](https://github.com/craftcms/cms/discussions/11807))\n\n### Fixed\n- Fixed a bug where keyboard focus wasn\u2019t being maintained when changing the element type within a \u201cRelated To\u201d condition rule.\n- Fixed a bug where keyboard focus wasn\u2019t being maintained when changing the country within an address\u2019s \u201cAdministrative Area\u201d condition rule.\n- Fixed a bug where Date fields\u2019 Timezone menus could be clipped. ([#11780](https://github.com/craftcms/cms/pull/11780))\n- Fixed an error that could occur when saving an unpublished draft, if any custom validation errors were added to it after its draft status had been removed. ([#11407](https://github.com/craftcms/cms/issues/11407))\n- Fixed a bug where custom validation errors would be shown twice for unpublished drafts, if they were added to it after its draft status had been removed. ([#11407](https://github.com/craftcms/cms/issues/11407))\n- Fixed PHP warnings that would occur when passing `0` into `craft\\helpers\\DateTimeHelper::humanDuration()`. ([#11787](https://github.com/craftcms/cms/issues/11787))\n- Fixed a bug where selected assets weren\u2019t getting automatically replaced when an image was edited and \u201cSave as a new asset\u201d was chosen. ([#11805](https://github.com/craftcms/cms/issues/11805))\n- Fixed a JavaScript error that occurred when editing a user via a slideout, if the user had any addresses. ([#11810](https://github.com/craftcms/cms/issues/11810))\n- Fixed a bug where some invalid slideout submissions weren\u2019t being handled properly. ([#11812](https://github.com/craftcms/cms/issues/11812))\n- Fixed a bug where `craft\\helpers\\DateTimeHelper::toDateInterval()` was returning negative interval durations when integers were passed in. ([#11814](https://github.com/craftcms/cms/pull/11814))\n- Fixed a bug where `iframeResizer.contentWindow.js` was getting loaded for all preview requests, not just Live Preview, and even when `useIframeResizer` was disabled. ([#11778](https://github.com/craftcms/cms/issues/11778))\n- Fixed a bug where deleted relations and Matrix blocks could persist if the edit form was submitted before they had been fully animated away. ([#11789](https://github.com/craftcms/cms/issues/11789))\n- Fixed a PHP error that could occur if `craft\\services\\Assets::getUserTemporaryUploadFolder()` was called when there was no logged-in user account. ([#11751](https://github.com/craftcms/cms/issues/11751))\n\n## 4.2.1.1 - 2022-08-10\n\n### Fixed\n- Fixed a bug where saving an element with invalid field values could result in some field values being forgotten. ([#11756](https://github.com/craftcms/cms/issues/11756))\n- Fixed a bug where it wasn\u2019t always possible to serve asset bundles via `webpack-dev-server` over SSL. ([#11758](https://github.com/craftcms/cms/pull/11758))\n\n## 4.2.1 - 2022-08-09\n\n### Added\n- Added the `project-config/export` command. ([#11733](https://github.com/craftcms/cms/pull/11733))\n- Added `craft\\config\\GeneralConfig::getRememberedUserSessionDuration()`.\n- Added `craft\\helpers\\DateTimeHelper::toDateInterval()`.\n\n### Changed\n- \u201cRelated To\u201d condition rules are now available for conditions that are stored in the project config. ([#11740](https://github.com/craftcms/cms/issues/11740))\n- Element index filters are now managed for each site and source, rather than just for each source. ([#11719](https://github.com/craftcms/cms/issues/11719))\n- `craft\\config\\DbConfig::dsn()` now parses the DSN string and populates the other DSN-settable config properties.\n- `craft\\helpers\\DateTimeHelper::humanDuration()` no longer returns the number of weeks, unless the number of days is divisible by 7. ([#11594](https://github.com/craftcms/cms/discussions/11594))\n- `craft\\helpers\\DateTimeHelper::humanDuration()` now accepts date interval strings to be passed in.\n- `craft\\helpers\\Db::url2config()` now returns `driver`, `server`, `port`, and `database` keys, when possible. ([#11735](https://github.com/craftcms/cms/issues/11735))\n- `craft\\services\\Assets::getImagePreviewUrl()` now throws a `yii\\base\\NotSupportedException` if a preview URL could not be generated for the asset, rather than causing a PHP error.\n\n### Deprecated\n- Deprecated `craft\\helpers\\DateTimeHelper::secondsToInterval()`. `toDateInterval()` should be used instead.\n\n### Fixed\n- Fixed a bug where database connections would always use port `3306` by default if `craft\\config\\DbConfig` had been configured via fluent methods, even for PostgreSQL.\n- Fixed a bug where system messages provided by Yii weren\u2019t getting translated in some cases. ([#11712](https://github.com/craftcms/cms/issues/11712))\n- Fixed a bug where the \u201cKeep me signed in\u201d checkbox label wasn\u2019t always accurately representing the `rememberedUserSessionDuration` config setting. ([#11594](https://github.com/craftcms/cms/discussions/11594))\n- Fixed a bug where the `Craft.cp.setSiteId()` JavaScript method wasn\u2019t updating `Craft.siteId`, or the base URLs used by `Craft.getActionUrl()`, `Craft.getCpUrl()`, and `Craft.getUrl()`.\n- Fixed an error that occurred when removing a Single section from the primary site, if it contained any Matrix blocks. ([#11669](https://github.com/craftcms/cms/issues/11669))\n- Fixed a bug where Matrix sub-fields weren\u2019t showing their validation errors when `autosaveDrafts` was `false`. ([#11731](https://github.com/craftcms/cms/issues/11731))\n- Fixed a bug where saving an element with invalid field values could result in the invalid values being forgotten, rather than re-validated. ([#11731](https://github.com/craftcms/cms/issues/11731))\n- Fixed a bug where the database connection would be misconfigured if the `url` connection setting was used. ([#11735](https://github.com/craftcms/cms/issues/11735))\n- Fixed a bug where the element index filter HUDs weren\u2019t always visually aligned with the search input. ([#11739](https://github.com/craftcms/cms/issues/11739))\n- Fixed a bug where it wasn\u2019t possible to preview or edit image assets if their filesystem and transform filesystem didn\u2019t have public URLs. ([#11686](https://github.com/craftcms/cms/issues/11686), [#11687](https://github.com/craftcms/cms/issues/11687))\n- Fixed a bug where not all project config changes would be applied if a site was deleted. ([#9567](https://github.com/craftcms/cms/issues/9567))\n- Fixed a bug where `$` characters in database connection passwords weren\u2019t being escaped property when backing up/restoring the database. ([#11750](https://github.com/craftcms/cms/issues/11750))\n\n### Security\n- Fixed XSS vulnerabilities.\n\n## 4.2.0.2 - 2022-07-27\n\n### Fixed\n- Fixed a bug where `Garnish.uiShortcutManager` was getting double-instantiated, causing some keyboard shortcuts to be triggered multiple times.\n- Fixed a JavaScript error that occurred when switching sites in the control panel. ([#11709](https://github.com/craftcms/cms/issues/11709))\n- Fixed a bug where some config settings set via fluent setters weren\u2019t getting normalized.\n- Fixed a bug where the database connection DSN string wasn\u2019t getting built properly when the connection settings were set via fluent setters.\n\n## 4.2.0.1 - 2022-07-26\n\n### Fixed\n- Fixed an error that could occur when passing an object into `craft\\helpers\\ArrayHelper::removeValue()` or the `|without` filter.\n\n## 4.2.0 - 2022-07-26\n\n### Added\n- The control panel is now translated into Ukrainian.\n- Element conditions can now include condition rules for Matrix fields. ([#11620](https://github.com/craftcms/cms/issues/11620))\n- Element conditions can now include condition rules for Money fields. ([#11560](https://github.com/craftcms/cms/issues/11560))\n- Added the \u201cNotification Duration\u201d user accessibility preference. ([#11612](https://github.com/craftcms/cms/pull/11612))\n- The `accessibilityDefaults` config setting now supports a `notificationDuration` key.\n- Added `craft\\behaviors\\SessionBehavior::getSuccess()`.\n- Added `craft\\behaviors\\SessionBehavior::setSuccess()`.\n- Added `craft\\config\\BaseConfig`. ([#11591](https://github.com/craftcms/cms/pull/11591), [#11656](https://github.com/craftcms/cms/pull/11656))\n- Added `craft\\controllers\\UsersController::EVENT_AFTER_FIND_LOGIN_USER`. ([#11645](https://github.com/craftcms/cms/pull/11645))\n- Added `craft\\controllers\\UsersController::EVENT_BEFORE_FIND_LOGIN_USER`. ([#11645](https://github.com/craftcms/cms/pull/11645))\n- Added `craft\\events\\DefineFieldLayoutCustomFieldsEvent`.\n- Added `craft\\events\\FindLoginUserEvent`.\n- Added `craft\\events\\IndexKeywordsEvent`.\n- Added `craft\\fields\\conditions\\EmptyFieldConditionRule`.\n- Added `craft\\helpers\\DateTimeHelper::humanDuration()`.\n- Added `craft\\helpers\\Template::resolveTemplatePathAndLine()`.\n- Added `craft\\models\\FieldLayout::EVENT_DEFINE_CUSTOM_FIELDS`. ([#11634](https://github.com/craftcms/cms/discussions/11634))\n- Added `craft\\services\\Config::getLoadingConfigFile()`.\n- Added `craft\\services\\Elements::EVENT_INVALIDATE_CACHES`. ([#11617](https://github.com/craftcms/cms/pull/11617))\n- Added `craft\\services\\Search::EVENT_BEFORE_INDEX_KEYWORDS`. ([#11575](https://github.com/craftcms/cms/discussions/11575))\n\n### Changed\n- Redesigned user notifications. ([#11612](https://github.com/craftcms/cms/pull/11612))\n- Most element notifications now include a link to the element. ([#11612](https://github.com/craftcms/cms/pull/11612))\n- Improved overall control panel accessibility. ([#11563](https://github.com/craftcms/cms/pull/11563), [#11543](https://github.com/craftcms/cms/pull/11543), [#11688](https://github.com/craftcms/cms/pull/11688), [#11699](https://github.com/craftcms/cms/pull/11699))\n- Improved condition builder accessibility. ([#11588](https://github.com/craftcms/cms/pull/11588), [#11643](https://github.com/craftcms/cms/pull/11643))\n- Improved Image Editor accessibility. ([#11496](https://github.com/craftcms/cms/pull/11496))\n- The \u201cKeep me signed in\u201d checkbox label on the control panel\u2019s login page now includes the remembered session duration, e.g. \u201cKeep me signed in for 2 weeks\u201d. ([#11594](https://github.com/craftcms/cms/discussions/11594))\n- Dashboard widgets no longer show a confirmation dialog when deleted. Their delete notifications include an \u201cUndo\u201d button instead. ([#11573](https://github.com/craftcms/cms/discussions/11573))\n- Element edit pages no longer jump down when the \u201cShowing your unsaved changes\u201d notice is added, unless there\u2019s not enough content to require a scroll bar. ([#11586](https://github.com/craftcms/cms/discussions/11586))\n- Matrix block previews now show selected option labels rather than their raw values. ([#11659](https://github.com/craftcms/cms/issues/11659))\n- Improved the behavior of some console commands for non-interactive shells. ([#11650](https://github.com/craftcms/cms/issues/11650))\n- The `utils/prune-revisions` console command now has a `--section` option. ([#8783](https://github.com/craftcms/cms/discussions/8783))\n- Deprecation warnings\u2019 stack traces now show source templates\u2019 paths and line numbers.\n- Exception JSON responses now include the previous exception details, recursively. ([#11694](https://github.com/craftcms/cms/discussions/11694))\n- `config/general.php` and `config/db.php` can now return `craft\\config\\GeneralConfig`/`DbConfig` objects, which can be defined using new fluent setter methods. ([#11591](https://github.com/craftcms/cms/pull/11591), [#11656](https://github.com/craftcms/cms/pull/11656))\n- The `|duration` Twig filter can now be used with an integer representing a number of seconds, and its `showSeconds` argument is no longer required. Seconds will be output if the duration is less than one minute by default.\n- The `|length` Twig filter now checks if the variable is a query, and if so, returns its count. ([#11625](https://github.com/craftcms/cms/discussions/11625))\n- The `|without` Twig filter no longer uses strict value comparisons by default. It has a new `$strict` argument that can be set to `true` to enforce strict comparisons if desired. ([#11695](https://github.com/craftcms/cms/issues/11695))\n- `craft\\base\\conditions\\BaseConditionRule::inputHtml()` is no longer abstract, and returns an empty string by default.\n- `craft\\behaviors\\SessionBehavior::setError()` now has a `$settings` argument.\n- `craft\\behaviors\\SessionBehavior::setNotice()` now has a `$settings` argument.\n- `craft\\db\\Query` now implements the `ArrayAccess` and `IteratorAggregate` interfaces, so queries (including element queries) can be treated as arrays.\n- `craft\\helpers\\ArrayHelper::removeValue()` no longer uses strict value comparisons by default. It has a new `$strict` argument that can be set to `true` to enforce strict comparisons if desired.\n- `craft\\web\\Controller::asSuccess()` now has a `$notificationSettings` argument.\n- `craft\\web\\Controller::setFailFlash()` now has a `$settings` argument.\n- `craft\\web\\Controller::setSuccessFlash()` now has a `$settings` argument.\n\n### Deprecated\n- Deprecated `craft\\helpers\\DateTimeHelper::humanDurationFromInterval()`. `humanDuration()` should be used instead.\n- Deprecated `craft\\helpers\\DateTimeHelper::secondsToHumanTimeDuration()`. `humanDuration()` should be used instead.\n\n### Fixed\n- Fixed a bug where new condition rules\u2019 type selectors weren\u2019t getting auto-focused.\n- Fixed a bug where Quick Post widgets weren\u2019t submitting custom field values.\n- Fixed a bug where assets\u2019 `getImg()` methods were returning `null` for assets in volumes without URLs, even if a transform was being used. ([#11614](https://github.com/craftcms/cms/issues/11614))\n- Fixed a bug where sensitive data wasn\u2019t getting redacted in the logs when Dev Mode was enabled. ([#11618](https://github.com/craftcms/cms/issues/11618))\n- Fixed a SQL error that could occur on MySQL 5. ([#11596](https://github.com/craftcms/cms/issues/11596))\n- Fixed an error that could occur when upgrading to Craft 4. ([#11644](https://github.com/craftcms/cms/issues/11644))\n- Fixed a bug where the green color used in lightswitches was too dark. ([#11653](https://github.com/craftcms/cms/issues/11653))\n- Fixed a bug where relational and Matrix fields were assuming their values hadn\u2019t been eager-loaded on element save. ([#11667](https://github.com/craftcms/cms/issues/11667), [#11670](https://github.com/craftcms/cms/issues/11670))\n- Fixed a bug where deprecation warnings for treating an element query as an array weren\u2019t getting logged with an origin, if they involved Twig\u2019s `|batch` filter. ([#11597](https://github.com/craftcms/cms/issues/11597))\n- Fixed a bug where `{% js %}`, `{% script %}`, and `{% css %}` tags weren\u2019t registering JavaScript and CSS code properly when used within a `{% cache %}` tag that contained an ungenerated image transform. ([#11602](https://github.com/craftcms/cms/issues/11602))\n- Fixed a bug where the \u201cUser saved\u201d notification was translated for the former language, when changing the current user\u2019s language preference.\n- Fixed a JavaScript error that occurred when removing a category from a Categories field, if any of its descendants were selected as well. ([#11641](https://github.com/craftcms/cms/issues/11641))\n- Fixed a bug where links to config settings from **Settings** \u2192 **General** didn\u2019t include the correct setting anchors. ([#11665](https://github.com/craftcms/cms/pull/11665))\n- Fixed styling issues with Live Preview in Firefox.\n\n### Security\n- Fixed an information disclosure vulnerability.\n\n## 4.1.4.1 - 2022-07-13\n\n### Fixed\n- Fixed a bug where `craft\\services\\Assets::getRootFolderByVolumeId()` wasn\u2019t returning the root folder. ([#11593](https://github.com/craftcms/cms/issues/11593))\n\n## 4.1.4 - 2022-07-12\n\n### Added\n- Added `craft\\models\\FieldLayout::getVisibleCustomFieldElements()`.\n\n### Changed\n- Relation fields now focus on the next related element\u2019s \u201cRemove\u201d button when an element is removed. ([#11577](https://github.com/craftcms/cms/issues/11577))\n\n### Deprecated\n- Deprecated `craft\\base\\FieldTrait::$required`. `craft\\fieldlayoutelements\\BaseField::$required` should be used instead.\n\n### Fixed\n- Fixed a bug where assets\u2019 native Alternative Text fields were getting mislabeled as translatable. ([#11576](https://github.com/craftcms/cms/issues/11576))\n- Fixed a bug where fields nested within Neo fields could be incorrectly validated as required. ([#11574](https://github.com/craftcms/cms/issues/11574))\n- Fixed a PHP error that occurred when editing a Date field with a Min Date setting set.\n- Fixed a bug where date range inputs weren\u2019t working on mobile. ([#11571](https://github.com/craftcms/cms/issues/11571))\n- Fixed a bug where the \u201cCraft Support\u201d Dashboard widget wasn\u2019t being labeled properly in the widget settings HUD and delete confirmation dialog. ([#11573](https://github.com/craftcms/cms/discussions/11573))\n- Fixed a bug where the project config cache was getting invalidated on each public GraphQL API request.\n\n## 4.1.3 - 2022-07-07\n\n### Changed\n- Address fields now show required indicators based on the configured validation rules. ([#11566](https://github.com/craftcms/cms/pull/11566))\n\n### Fixed\n- Fixed a JavaScript error that occurred on the Updates utility. ([#11567](https://github.com/craftcms/cms/issues/11567))\n- Fixed a bug where Craft\u2019s Composer commands could produce a malformed `composer.json` file. ([#11564](https://github.com/craftcms/cms/issues/11564))\n\n## 4.1.2 - 2022-07-06\n\n### Added\n- Added `craft\\helpers\\ProjectConfig::ensureAllFilesystemsProcessed()`.\n\n### Changed\n- Relational field condition rules now have the \u201cis related to\u201d operator selected by default. ([#11550](https://github.com/craftcms/cms/discussions/11550))\n\n### Fixed\n- Fixed a bug where the Updates utility wasn\u2019t checking for updates properly. ([#11552](https://github.com/craftcms/cms/issues/11552))\n- Fixed an error that could occur when deploying a Craft 4 upgrade to another server. ([#11558](https://github.com/craftcms/cms/issues/11558))\n- Fixed a bug where Assets fields were relocating assets when saving a revision.\n- Fixed a bug where asset bundles weren\u2019t getting registered on the front end. ([#11555](https://github.com/craftcms/cms/issues/11555))\n\n## 4.1.1 - 2022-07-05\n\n### Changed\n- Improved the control panel tab design. ([#11524](https://github.com/craftcms/cms/pull/11524))\n- Changed the order of relational field condition rule operators, so \u201cis related to\u201d is listed first. ([#11550](https://github.com/craftcms/cms/discussions/11550))\n- Template caching is now supported for console requests, for `{% cache %}` tags that have the `globally` param. ([#11551](https://github.com/craftcms/cms/issues/11551))\n- Updated Composer to 2.2.15. ([#11538](https://github.com/craftcms/cms/issues/11538))\n\n### Fixed\n- Fixed an error that could occur if any custom fields were missing their field group. ([#11522](https://github.com/craftcms/cms/discussions/11522))\n- Fixed a bug where custom selects weren\u2019t scrolling to the visually-focused option.\n- Fixed errors that could occur if an element condition contained any rules for deleted custom fields. ([#11526](https://github.com/craftcms/cms/issues/11526))\n- Fixed a bug where the \u201cDeactivate users by default\u201d user setting wasn\u2019t working. ([#11519](https://github.com/craftcms/cms/issues/11519))\n- Fixed a styling issue with the Edit Route modal. ([#11528](https://github.com/craftcms/cms/issues/11528))\n- Fixed a bug where assets uploaded from Assets fields weren\u2019t retaining their original filename. ([#11530](https://github.com/craftcms/cms/issues/11530))\n- Fixed a bug where project config changes made at the end of the request lifecycle weren\u2019t getting saved.\n- Fixed a bug where toggling entries\u2019 and categories\u2019 site-specific statuses from element editor slideouts wasn\u2019t working. ([#11547](https://github.com/craftcms/cms/issues/11547))\n- Fixed a SQL error that occurred when running the `utils/prune-provisional-drafts` command. ([#11548](https://github.com/craftcms/cms/issues/11548))\n- Fixed focus styling issues with the Edit Route modal.\n\n## 4.1.0.2 - 2022-06-28\n\n### Fixed\n- Fixed a PHP error. ([#11518](https://github.com/craftcms/cms/issues/11518))\n\n## 4.1.0.1 - 2022-06-28\n\n### Fixed\n- Fixed an infinite recursion bug. ([#11514](https://github.com/craftcms/cms/issues/11514))\n\n## 4.1.0 - 2022-06-28\n\n### Added\n- Field layouts can now have \u201cLine Break\u201d UI elements. ([#11328](https://github.com/craftcms/cms/discussions/11328))\n- Added the `db/drop-all-tables` command. ([#11288](https://github.com/craftcms/cms/pull/11288))\n- Added the `elements/delete` command.\n- Added the `elements/restore` command.\n- Added the `project-config/get` command. ([#11341](https://github.com/craftcms/cms/pull/11341))\n- Added the `project-config/remove` command. ([#11341](https://github.com/craftcms/cms/pull/11341))\n- Added the `project-config/set` command. ([#11341](https://github.com/craftcms/cms/pull/11341))\n- The `AdminTable` Vue component can now be included into other Vue apps, in addition to being used as a standalone app. ([#11107](https://github.com/craftcms/cms/pull/11107))\n- Added a `one()` alias for `first()` to collections. ([#11134](https://github.com/craftcms/cms/discussions/11134))\n- Added `craft\\base\\Element::EVENT_DEFINE_CACHE_TAGS`. ([#11171](https://github.com/craftcms/cms/discussions/11171))\n- Added `craft\\base\\Element::cacheTags()`.\n- Added `craft\\base\\FieldInterface::getLabelId()`.\n- Added `craft\\console\\controllers\\UsersController::$activate`.\n- Added `craft\\elements\\conditions\\ElementCondition::$sourceKey`.\n- Added `craft\\elements\\db\\ElementQuery::EVENT_AFTER_POPULATE_ELEMENTS`. ([#11262](https://github.com/craftcms/cms/discussions/11262))\n- Added `craft\\elements\\db\\ElementQuery::EVENT_DEFINE_CACHE_TAGS`. ([#11171](https://github.com/craftcms/cms/discussions/11171))\n- Added `craft\\events\\PopulateElementsEvent`.\n- Added `craft\\fieldlayoutelements\\BaseField::labelId()`.\n- Added `craft\\fieldlayoutelements\\LineBreak`.\n- Added `craft\\helpers\\DateTimeHelper::now()`.\n- Added `craft\\helpers\\DateTimeHelper::pause()`. ([#11130](https://github.com/craftcms/cms/pull/11130))\n- Added `craft\\helpers\\DateTimeHelper::resume()`. ([#11130](https://github.com/craftcms/cms/pull/11130))\n\n### Changed\n- Improved overall control panel accessibility. ([#11297](https://github.com/craftcms/cms/pull/11297), [#11296](https://github.com/craftcms/cms/pull/11296), [#11414](https://github.com/craftcms/cms/pull/11414), [#11452](https://github.com/craftcms/cms/pull/11452))\n- Improved pagination UI accessibility. ([#11126](https://github.com/craftcms/cms/pull/11126))\n- Improved element index accessibility. ([#11169](https://github.com/craftcms/cms/pull/11169), [#11200](https://github.com/craftcms/cms/pull/11200), [#11251](https://github.com/craftcms/cms/pull/11251))\n- Improved Dashboard accessibility. ([#11217](https://github.com/craftcms/cms/pull/11217), [#11297](https://github.com/craftcms/cms/pull/11297))\n- Improved address management accessibility. ([#11397](https://github.com/craftcms/cms/pull/11397))\n- Improved Matrix field accessibility. ([#11306](https://github.com/craftcms/cms/pull/11306))\n- Improved mobile support. ([#11323](https://github.com/craftcms/cms/pull/11323), [#11430](https://github.com/craftcms/cms/pull/11430))\n- Improved keyboard support for custom selects. ([#11414](https://github.com/craftcms/cms/pull/11414))\n- It\u2019s now possible to remove all selected elements from relational fields by pressing <kbd>Backspace</kbd> or <kbd>Delete</kbd> while one of them is focused.\n- Improved the UI of condition builders. ([#11386](https://github.com/craftcms/cms/pull/11386))\n- Entry Type condition rules now allow multiple selections. ([#11124](https://github.com/craftcms/cms/pull/11124))\n- Element index filters now only show condition rules for the custom fields that are used by the field layouts in the selected source, if a native source is selected. ([#11187](https://github.com/craftcms/cms/discussions/11187))\n- Element index filters now only show condition rules for custom fields used by field layouts created for the target element type, if no native source is selected.\n- Condition builders can now include multiple rules with the same label, as long as they\u2019re in different groups.\n- Asset indexes now have a \u201cLocation\u201d table attribute option. ([#11450](https://github.com/craftcms/cms/discussions/11450))\n- It\u2019s now possible to sort entries by their section and type. ([#9192](https://github.com/craftcms/cms/discussions/9192), [#11335](https://github.com/craftcms/cms/discussions/11335))\n- It\u2019s now possible to sort assets by their file kind.\n- Element editor metadata now lists elements\u2019 IDs.\n- Live Preview now always shows a \u201cRefresh\u201d button, regardless of whether the preview target has auto-refresh enabled. ([#11160](https://github.com/craftcms/cms/discussions/11160))\n- Sites\u2019 Language settings now display the locale IDs as option hints, rather than the languages\u2019 native names. ([#11195](https://github.com/craftcms/cms/discussions/11195))\n- Selectize options can now specify searchable `keywords` that won\u2019t be visible in the UI.\n- Selectize inputs will now include their options\u2019 values as search keywords.\n- Newly-created entries now get placeholder Post Date set on them, so they get sorted appropriately when querying for entries ordered by `postDate`. ([#11272](https://github.com/craftcms/cms/issues/11272))\n- Element queries can now pass columns into the `orderBy` param in addition to `score` when searching. ([#11470](https://github.com/craftcms/cms/pull/11470), [#11457](https://github.com/craftcms/cms/discussions/11457))\n- Field layout elements within field layout designers now support double-clicking to open their settings slideout. ([#11277](https://github.com/craftcms/cms/discussions/11277))\n- The control panel\u2019s JavaScript queue is now paused when the browser tab isn\u2019t visible. ([#10632](https://github.com/craftcms/cms/issues/10632))\n- The `db/restore` command now asks whether the database should be backed up, and whether all existing database tables should be dropped, prior to restoring the backup. ([#11288](https://github.com/craftcms/cms/pull/11288))\n- The `users/create` command now asks whether the user should be activated when saved.\n- The `maxBackups` config setting now impacts `.sql.zip` files in addition to `.sql` files. ([#11241](https://github.com/craftcms/cms/issues/11241))\n- Deprecation messages are now consistently referred to as \u201cdeprecation warnings\u201d in the control panel.\n- Callback functions returned by elements\u2019 `sortOptions()`/`defineSortOptions()` methods are now passed a `craft\\db\\Connection` object as a second argument.\n- All element sources now have a \u201cSet Status\u201d action, even if the element type\u2019s `defineActions()` method didn\u2019t include one, if the element type\u2019s `hasStatuses()` method returns `true`. ([#11383](https://github.com/craftcms/cms/discussions/11383))\n- All element sources now have a \u201cView\u201d action, even if the element type\u2019s `defineActions()` method didn\u2019t include one, if the element type\u2019s `hasUris()` method returns `true`. ([#11383](https://github.com/craftcms/cms/discussions/11383))\n- All element sources now have \u201cEdit\u201d and \u201cDelete\u201d actions, even if the element type\u2019s `defineActions()` method didn\u2019t include them. ([#11383](https://github.com/craftcms/cms/discussions/11383))\n- The \u201cSet Status\u201d and \u201cEdit\u201d element actions are now only available for elements whose `canSave()` method returned `true`.\n- Assets fields now reject uploaded files which don\u2019t pass their \u201cSelectable Assets Condition\u201d setting. ([#11433](https://github.com/craftcms/cms/issues/11433))\n- It\u2019s now possible to save new assets without setting their `filename` or `kind` attributes, as long as `newLocation` or `newFilename` is set. ([#11439](https://github.com/craftcms/cms/issues/11439))\n- The `searchindex` table is now uses the InnoDB storage engine by default for MySQL installs. ([#11374](https://github.com/craftcms/cms/discussions/11374))\n- The `_layouts/elementindex` control panel template now sets the page title based on the element\u2019s `pluralDisplayName()` method by default. ([#11502](https://github.com/craftcms/cms/pull/11502))\n- `craft\\test\\ActiveFixture::$data` is now populated with the active record instances, making them accessible to tests via `$this->tester->grabFixture('my-fixture', 'data-key')`. ([#11445](https://github.com/craftcms/cms/pull/11445))\n- Address validation rules are now defined by `defineRules()`. ([#11471](https://github.com/craftcms/cms/pull/11471))\n- `Garnish.DELETE_KEY` now refers to the actual <kbd>Delete</kbd> key code, and the <kbd>Backspace</kbd> key code is now referenced by `Garnish.BACKSPACE_KEY`.\n\n### Deprecated\n- Deprecated `craft\\elements\\actions\\DeleteAssets`. `craft\\elements\\actions\\Delete` should be used instead.\n\n### Removed\n- Removed `craft\\elements\\conditions\\entries\\EntryTypeCondition::$sectionUid`.\n- Removed `craft\\elements\\conditions\\entries\\EntryTypeCondition::$entryTypeUid`.\n\n## 4.0.6 - 2022-06-28\n\n### Added\n- Added `craft\\fields\\BaseOptionsField::encodeValue()`.\n\n### Changed\n- Improved the `install` command\u2019s error output when invalid options were passed.\n- `canonical` is now a reserved field handle. ([#11503](https://github.com/craftcms/cms/issues/11503))\n- `craft\\fields\\BaseOptionsField::translatedOptions()` now has an `$encode` argument.\n\n### Fixed\n- Fixed a bug where self relations within relational fields were being forgotten. ([#11461](https://github.com/craftcms/cms/issues/11461))\n- Fixed a bug where the `install` command required `--site-name`, `--site-url`, and `--language` options to be passed when project config YAML was already present. ([#11513](https://github.com/craftcms/cms/issues/11513))\n- Fixed a bug where `Garnish.setFocusWithin()` wasn\u2019t working if the first focusable element was a checkbox. ([#11498](https://github.com/craftcms/cms/discussions/11498))\n- Fixed a bug where Matrix blocks could be saved in the wrong order.\n- Fixed a bug where Checkboxes, Dropdown, Multi-select, and Radio Buttons fields could lose their values if their option values were set to integers. ([#11461](https://github.com/craftcms/cms/issues/11461))\n\n## 4.0.5.2 - 2022-06-24\n\n### Fixed\n- Fixed a SQL error that could occur on MySQL 5. ([#11493](https://github.com/craftcms/cms/issues/11493))\n- Fixed a bug where Craft\u2019s Composer commands weren\u2019t ensuring that `config.allow-plugins.yiisoft/yii2-composer` was `true` in `composer.json`. ([#11399](https://github.com/craftcms/cms/issues/11399))\n\n## 4.0.5.1 - 2022-06-22\n\n### Fixed\n- Fixed a bug where not all changes to entries and categories created via the \u201cSave and add another\u201d action were propagating to other sites. ([#11476](https://github.com/craftcms/cms/issues/11476))\n- Fixed a bug where it wasn\u2019t possible to rename assets.\n- Fixed a bug where a provisional draft could be created for an entry if its form was interacted with before the page had fully initialized. ([#11466](https://github.com/craftcms/cms/issues/11466))\n- Fixed exact phrase searching on PostgreSQL. ([#11486](https://github.com/craftcms/cms/issues/11486))\n\n## 4.0.5 - 2022-06-21\n\n### Added\n- Added `craft\\helpers\\Number::isIntOrFloat()`.\n\n### Changed\n- Categories now support change tracking.\n- Improved performance when working with temp asset folders.\n- Temp asset folders are no longer created until they\u2019re actually needed. ([#11427](https://github.com/craftcms/cms/issues/11427))\n- Element index queries are no longer cached if they contain a search term.\n- Search inputs within field layout designers now prevent the containing form from being submitted when the <kbd>Return</kbd> key is pressed. ([#11415](https://github.com/craftcms/cms/discussions/11415))\n\n### Deprecated\n- Deprecated `craft\\services\\Categories::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Globals::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Sections::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Tags::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Users::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n- Deprecated `craft\\services\\Volumes::pruneDeletedField()`. ([#11054](https://github.com/craftcms/cms/discussions/11054))\n\n### Fixed\n- Fixed an error that could occur when saving an element to a disabled site. ([#10499](https://github.com/craftcms/cms/issues/10499))\n- Fixed a bug where newly-added condition rules\u2019 types were still selectable for preexisting condition rules, when they shouldn\u2019t have been.\n- Fixed a bug where field layout designers were checking the wrong setting when determining whether to include UI elements (`customizableTabs` instead of `customizableUi`).\n- Fixed a bug where the Asset Indexes utility was analyzing image transform directories and files. ([#11362](https://github.com/craftcms/cms/issues/11362), [#11384](https://github.com/craftcms/cms/pull/11384))\n- Fixed a bug where focus was getting trapped within element editor slideouts\u2019 sidebars even for wide viewports where there was enough room to display the sidebar side-by-side with other slideout content. ([#11358](https://github.com/craftcms/cms/pull/11358))\n- Fixed a bug where users\u2019 Formatting Locale preferences weren\u2019t always being respected.\n- Fixed a bug where address card menus would linger around after an address was deleted.\n- Fixed a bug where the `index-assets` command could produce unexpected output. ([#11194](https://github.com/craftcms/cms/issues/11194)).\n- Fixed a bug where video controls within asset preview modals were inaccessible via the keyboard. ([#11371](https://github.com/craftcms/cms/pull/11371))\n- Fixed a bug where `transform` GraphQL directives weren\u2019t working for Assets fields. ([#10299](https://github.com/craftcms/cms/discussions/10299))\n- Fixed a PHP error that could occur when running the `help` command. ([#11423](https://github.com/craftcms/cms/issues/11423))\n- Fixed a bug where `craft\\helpers\\App::env()` was converting some values to integers or floats unexpectedly. ([#11422](https://github.com/craftcms/cms/issues/11422))\n- Fixed a bug where changes to existing Matrix blocks weren\u2019t saving for element types that supported drafts but not change tracking. ([#11419](https://github.com/craftcms/cms/issues/11419))\n- Fixed a bug where double-clicking on a related asset\u2019s thumbnail could open the asset\u2019s preview modal. ([#11424](https://github.com/craftcms/cms/issues/11424))\n- Fixed a bug where the control panel wasn\u2019t displaying file upload failure messages.\n- Fixed a bug where `action` query params were taking precedence over `actionTrigger` URI matches, when handling action requests. ([#11435](https://github.com/craftcms/cms/issues/11435))\n- Fixed a bug where image fields within Edit User pages and the Settings \u2192 General page weren\u2019t resetting properly after an image was deleted. ([#11436](https://github.com/craftcms/cms/issues/11436))\n- Fixed a bug where User Group condition rules set to the \u201cis not one of\u201d operator weren\u2019t being applied to individual elements correctly. ([#11444](https://github.com/craftcms/cms/discussions/11444))\n- Fixed a JavaScript error that occurred on element indexes for users that didn\u2019t have permission to edit any sites.\n- Fixed a bug where users without permission to create new entries in a section could duplicate existing entries. ([#11447](https://github.com/craftcms/cms/pull/11447))\n- Fixed a bug where element selection condition rules weren\u2019t working if an element ID was provided. ([#11451](https://github.com/craftcms/cms/pull/11451))\n- Fixed a PHP error that occurred when executing a GraphQL query using a token that wasn\u2019t set to a schema. ([#11453](https://github.com/craftcms/cms/issues/11453))\n- Fixed a PHP error that could occur when unserializing a `craft\\validator\\DateTimeValidator`, `LanguageValidator`, `StringValidator`, or `TimeValidator` object. ([#11454](https://github.com/craftcms/cms/issues/11454))\n- Fixed a bug where element types\u2019 `actions()` methods were getting called for all `element-indexes/*` action requests.\n- Fixed a bug where the `install` command would run non-interactively even if not all needed options were passed, resulting in an error after the database tables had been added. ([#11305](https://github.com/craftcms/cms/issues/11305))\n- Fixed a viewport clipping bug on the control panel\u2019s Login page. ([#11372](https://github.com/craftcms/cms/pull/11372))\n- Fixed a bug where filtering an element query by a relational field using `:empty:`/`:notempty:` wasn\u2019t factoring in the field\u2019s \u201cWhich site should entries be related from?\u201d setting properly.\n- Fixed a bug where filtering an element query by a relational field using `:empty:`/`:notempty:` wasn\u2019t factoring in the source elements\u2019 site IDs, for fields set to manage relations on a per-site basis. ([#11418](https://github.com/craftcms/cms/issues/11418))\n- Fixed a bug where the Temporary Uploads asset source wasn\u2019t including subfolders.\n- Fixed a bug where file upload progress bars weren\u2019t always going away when an upload error occurred.\n- Fixed a bug where Pashto was not being treated as an RTL language. ([#11428](https://github.com/craftcms/cms/issues/11428))\n- Fixed a bug where the `upscaleImages` config setting wasn\u2019t being respected for transforms where only a single image dimension was specified. ([#11398](https://github.com/craftcms/cms/issues/11398))\n- Fixed an error that could occur when executing a GraphQL query, if a section didn\u2019t have any entry types. ([#11273](https://github.com/craftcms/cms/issues/11273))\n- Fixed an error that could occur when changing the primary site on installs with a large number of users. ([#11459](https://github.com/craftcms/cms/issues/11459))\n- Fixed a bug where Assets fields within Vizy fields weren\u2019t getting relocated from the user\u2019s temp uploads folder. ([#11462](https://github.com/craftcms/cms/issues/11462))\n\n### Security\n- Environment-aware control panel fields no longer suggest environment variables that begin with `HTTP_`.\n- The Sendmail mailer no longer validates if the Sendmail Command setting is set to an environment variable that begins with `HTTP_`.\n\n## 4.0.4 - 2022-06-03\n\n### Added\n- Added support for querying for users with a `credentialed` status.\n- Added `craft\\elements\\db\\UserQuery::STATUS_CREDENTIALED`.\n- Added `craft\\errors\\FieldNotFoundException`.\n- Added `craft\\helpers\\Html::encodeSpaces()`.\n- Added `craft\\web\\twig\\variables\\Cp::getRequestedSite()`. ([#11082](https://github.com/craftcms/cms/discussions/11082))\n\n### Changed\n- `temp` is now a reserved volume handle.\n- Improved the performance of field layout designers. ([#11298](https://github.com/craftcms/cms/issues/11298))\n- All control panel pages now have a `site--<siteHandle>` class name on the `<body>`, based on the currently-selected site. ([#11303](https://github.com/craftcms/cms/discussions/11303))\n- Warnings are no longer logged when instantiating a field layout that references a deleted custom field. ([#11333](https://github.com/craftcms/cms/issues/11333))\n- Read/write splitting is now disabled for all console requests.\n- The `db/restore` command now prompts to clear data caches after the import is complete. ([#11327](https://github.com/craftcms/cms/issues/11327))\n- Entry queries no longer factor in seconds when looking for currently-live entries, without excluding entries that were published in the past minute. ([#5389](https://github.com/craftcms/cms/issues/5389))\n- `craft\\elements\\Asset::getUrl()` now encodes any spaces in the URL as `%20` entities.\n\n### Fixed\n- Fixed a bug where it wasn\u2019t possible to disable all table columns for an element source. ([#11291](https://github.com/craftcms/cms/issues/11291))\n- Fixed a bug where the Assets index page wasn\u2019t allowing any bulk actions for assets in the temporary volume. ([#11293](https://github.com/craftcms/cms/issues/11293))\n- Fixed a bug where PHP errors thrown while rendering a template weren\u2019t being handled properly. ([#11108](https://github.com/craftcms/cms/issues/11108))\n- Fixed a bug where site status labels were inconsistent on element edit pages. ([#11307](https://github.com/craftcms/cms/issues/11307))\n- Fixed a bug where addresses\u2019 County fields were mislabeled. ([#11314](https://github.com/craftcms/cms/pull/11314))\n- Fixed a bug where the control panel\u2019s login form wasn\u2019t handling errors properly. ([#11319](https://github.com/craftcms/cms/pull/11319))\n- Fixed a bug where it wasn\u2019t possible to use a `{% redirect %}` tag in an error template. ([#11336](https://github.com/craftcms/cms/issues/11336))\n- Fixed an error that occurred when saving an entry via a GraphQL mutation. ([#11312](https://github.com/craftcms/cms/issues/11312))\n- Fixed a bug where all web requests were getting no-cache headers. ([#11346](https://github.com/craftcms/cms/issues/11346))\n- Fixed a bug where user caches weren\u2019t getting invalidated when users were changed to a pending or inactive state.\n- Fixed a bug where querying for users with an `active` status was returning suspended users. ([#11370](https://github.com/craftcms/cms/pull/11370))\n- Fixed a bug where it wasn\u2019t possible to drag assets within Assets fields by their thumbnails. ([#11364](https://github.com/craftcms/cms/issues/11364))\n- Fixed a bug where asset thumbnails weren\u2019t loading if their filename contained a space. ([#11350](https://github.com/craftcms/cms/issues/11350))\n- Fixed a bug where `craft\\services\\AssetIndexer::indexFile()` wasn\u2019t removing the filename from the file path when setting the directory on the listing. ([#11365](https://github.com/craftcms/cms/issues/11365))\n- Fixed a bug where links within custom field instructions were getting mangled. ([#11377](https://github.com/craftcms/cms/issues/11377))\n- Fixed a bug where project config paths that contained slashes weren\u2019t getting handled properly. ([#10774](https://github.com/craftcms/cms/issues/10774))\n- Fixed a bug where the Login page had a tab-focusable \u201cSkip to content\u201d button. ([#11375](https://github.com/craftcms/cms/issues/11375))\n\n## 4.0.3 - 2022-05-20\n\n### Added\n- Added `craft\\elements\\db\\ElementQuery::prepareSubquery()`.\n\n### Changed\n- Element edit pages now disable pointer events on the content container for 300 milliseconds after the \u201cShowing your unsaved changes\u201d notice is displayed. ([#11229](https://github.com/craftcms/cms/issues/11229))\n- Users can now create drafts for entries they have permission to view, but not save. ([#11249](https://github.com/craftcms/cms/issues/11249))\n- User Group condition rules are no longer available in element conditions when no user groups exist. ([#11252](https://github.com/craftcms/cms/issues/11252))\n- Matrix blocks now have `data-type-name` attributes. ([#11286](https://github.com/craftcms/cms/pull/11286))\n- Reversed the order of Lightswitch fields\u2019 \u201cON Label\u201d and \u201cOFF Label\u201d settings. ([#11259](https://github.com/craftcms/cms/issues/11259))\n- `craft\\services\\Elements::duplicateElement()` now has a `$trackDuplication` argument.\n- `craft\\services\\Matrix::duplicateBlocks()` now has a `$trackDuplications` argument.\n\n### Fixed\n- Fixed a bug where dynamically-defined image transforms weren\u2019t respecting the `format` param, unless the `generateTransformsBeforePageLoad` config setting was enabled.\n- Fixed a bug where Table fields with Min Rows and Max Rows set to `1` were still showing a delete button. ([#11211](https://github.com/craftcms/cms/issues/11211))\n- Fixed an error that could occur when saving an Assets field that was restricted to a single location, at the root of a volume. ([#11212](https://github.com/craftcms/cms/issues/11212))\n- Fixed an error that could occur after a queue job execution had finished. ([#11213](https://github.com/craftcms/cms/issues/11213))\n- Fixed an error that could occur when saving an entry with Matrix blocks. ([#11155](https://github.com/craftcms/cms/issues/11155))\n- Fixed an error that occurred when saving a GraphQL schema without a scope. ([#11240](https://github.com/craftcms/cms/issues/11240))\n- Fixed an error that could occur when editing the public GraphQL schema, if a public token existed in the project config, but not the database. ([#11218](https://github.com/craftcms/cms/issues/11218))\n- Fixed some bugs with inconsistent asset indexing on Windows. ([#11174](https://github.com/craftcms/cms/issues/11174)), ([#11219](https://github.com/craftcms/cms/issues/11219))\n- Fixed a bug where custom fields weren\u2019t available to be included as table attributes. ([#11222](https://github.com/craftcms/cms/issues/11222))\n- Fixed a bug where Alternative Text wasn\u2019t available to be included as a table attribute. ([#11222](https://github.com/craftcms/cms/issues/11222))`immediately`\n- Fixed a JavaScript error that broke Matrix fields with Min Blocks and Max Blocks both set to `1`. ([#11233](https://github.com/craftcms/cms/issues/11233))\n- Fixed a bug where request context logs could appear when nothing else was logged. ([#11141](https://github.com/craftcms/cms/issues/11141))\n- Fixed a bug where stack traces could be erroneously filtered from logs.\n- Fixed a bug where removing an element from a relational field within an element editor could cause the editor to create a provisional draft, even if the element type didn\u2019t support drafts. ([#11242](https://github.com/craftcms/cms/issues/11242))\n- Fixed a bug where draft editor pages had two identical \u201cSave and continue editing\u201d alternate form actions.\n- Fixed a JavaScript warning that occurred when viewing an element edit page, if the user didn\u2019t have permission to edit it.\n- Fixed a bug where asset selector modals weren\u2019t fully initializing for Assets fields, if they were targeting the user\u2019s temp folder. ([#11254](https://github.com/craftcms/cms/issues/11254))\n- Fixed an error that occurred when saving an entry via a GraphQL mutation. ([#11258](https://github.com/craftcms/cms/issues/11258))\n- Fixed a bug where Matrix block types\u2019 layout elements were getting new UUIDs assigned each time the Matrix field was edited. ([#11248](https://github.com/craftcms/cms/issues/11248))\n- Fixed a bug where the web-based installation wizard was throwing an exception if a database connection couldn\u2019t be established, and there was no `config/db.php` file. ([#11245](https://github.com/craftcms/cms/issues/11245))\n- Fixed a bug where editable tables\u2019 delete buttons\u2019 `aria-label` attributes weren\u2019t getting updated when table rows were reordered or deleted.\n- Fixed a bug where editable tables\u2019 delete buttons weren\u2019t visually disabled when the minimum number of rows had been reached.\n- Fixed a bug where all eager-loaded `srcset`-style transform sizes were relative to the first eager-loaded transform, rather than the prior one. ([#11209](https://github.com/craftcms/cms/issues/11209))\n- Fixed a bug where eager-loaded `srcset`-style transform sizes didn\u2019t reference the prior eager-loaded transform\u2019s `format`, `interlace`, `mode`, `position`, or `quality` settings. ([#11264](https://github.com/craftcms/cms/issues/11264))\n- Fixed a bug where the web-based installation wizard wouldn\u2019t show the database connection screen if a connection could be established but no database was selected. ([#11245](https://github.com/craftcms/cms/issues/11245))\n- Fixed an error that could occur when applying a multi-site draft with relational fields. ([#11220](https://github.com/craftcms/cms/issues/11220))\n- Fixed a bug where Matrix blocks could be deleted from newly-created multi-site entries, if the edit page was reloaded. ([#10906](https://github.com/craftcms/cms/issues/10906))\n\n## 4.0.2 - 2022-05-11\n\n### Added\n- Added `craft\\events\\LocateUploadedFilesEvent`.\n- Added `craft\\fields\\Assets::EVENT_LOCATE_UPLOADED_FILES`. ([#11123](https://github.com/craftcms/cms/discussions/11123))\n\n### Changed\n- `elements/*` actions no longer include custom field values in the response data, improving performance.\n- Garnish menu buttons are now aware of the `disabled` attribute. ([#11128](https://github.com/craftcms/cms/issues/11128))\n- Improved save performance for multi-site elements ([#11113](https://github.com/craftcms/cms/issues/11113))\n- Built-in Composer actions now ensure that `composer.json` allows the `craftcms/plugin-installer` Composer plugin.\n\n### Fixed\n- Fixed an error that occurred when searching for elements by a custom field. ([#11120](https://github.com/craftcms/cms/pull/11120))\n- Fixed a bug where asset upload failures weren\u2019t being handled properly. ([#11156](https://github.com/craftcms/cms/issues/11156))\n- Fixed a bug where warning and error logs were being sent to both `stdout` and `stderr` when `CRAFT_STREAM_LOG` was enabled. ([#11189](https://github.com/craftcms/cms/issues/11189))\n- Fixed an error that occurred when exporting elements with relational fields using the \u201cExpanded\u201d export type. ([#11127](https://github.com/craftcms/cms/issues/11127))\n- Fixed a PHP deprecation warning that occurred if the `tablePrefix` database connection setting was `null`.\n- Fixed a bug where category groups were being identified as \u201c{name}\u201d in user permission lists. ([#11132](https://github.com/craftcms/cms/issues/11132))\n- Fixed a bug where Assets fields\u2019 \u201cUpload files\u201d buttons weren\u2019t wrapping when there wasn\u2019t enough space to show them alongside \u201cAdd an asset\u201d. ([#11133](https://github.com/craftcms/cms/issues/11133))\n- Fixed a bug where `Craft.getUrl()` was appending empty query strings to URLs when they weren\u2019t needed. ([#11159](https://github.com/craftcms/cms/issues/11159))\n- Fixed a bug where addresses could validate the wrong set of required fields, if the validation rules were invoked before the country code was set. ([#11162](https://github.com/craftcms/cms/issues/11162))\n- Fixed an error that could occur when viewing the Temporary Uploads volume, if the Temp Uploads Location asset setting was set to \u201cIn the local temp folder\u201d. ([#11192](https://github.com/craftcms/cms/issues/11192))\n- Fixed an error that could occur when deleting a volume, if its filesystem had been deleted.\n- Fixed an error that could occur when rendering the thumbnail preview for an asset, if its file was missing. ([#11196](https://github.com/craftcms/cms/issues/11196))\n- Fixed a bug where soft-deleted drafts\u2019 search keywords weren\u2019t getting re-indexed if they were restored.\n- Fixed an error that occurred when transforming an SVG image without specifying a width or height. ([#11122](https://github.com/craftcms/cms/issues/11122))\n- Fixed an error that occurred when saving a Number field with a non-numeric value. ([#11164](https://github.com/craftcms/cms/issues/11164))\n- Fixed a bug where it wasn\u2019t possible to drag an item to the top in admin tables. ([#10781](https://github.com/craftcms/cms/issues/10781))\n- Fixed a bug where entries within Structure sections weren\u2019t expandable if their only descendants were unpublished drafts.\n- Fixed a bug where expanding a collapsed Structure section entry wouldn\u2019t reveal its descendants, if the parent was a draft. ([#11186](https://github.com/craftcms/cms/issues/11186))\n- Fixed a bug where element caches weren\u2019t getting cleared for elements when they were propagated to a newly-created site.\n\n## 4.0.1 - 2022-05-06\n\n### Fixed\n- Fixed a bug where Money field labels\u2019 `for` attributes weren\u2019t referencing the correct input ID. ([#11016](https://github.com/craftcms/cms/pull/11016))\n- Fixed a bug where Money field inputs weren\u2019t getting `aria-describedby` attributes. ([#11016](https://github.com/craftcms/cms/pull/11016))\n- Fixed an error that occurred when loading an edit screen for an element type that didn\u2019t have a field layout. ([#11110](https://github.com/craftcms/cms/pull/11110))\n- Fixed a bug where condition rules that weren\u2019t selectable (per `isSelectable()`) were still visible in the rule dropdown menu. ([#11104](https://github.com/craftcms/cms/pull/11104))\n- Fixed a bug where element edit pages could reload themselves immediately after saving the element. ([#11084](https://github.com/craftcms/cms/issues/11084))\n- Fixed a bug where tabs weren\u2019t interactive after changing an entry\u2019s type, if the new entry type didn\u2019t have a tab of the same name as the previously-selected tab. ([#11093](https://github.com/craftcms/cms/issues/11093))\n- Fixed a bug where Twig syntax errors weren\u2019t being handled properly. ([#11108](https://github.com/craftcms/cms/issues/11108))\n- Fixed an error that occurred when attempting to delete a global set. ([#11100](https://github.com/craftcms/cms/issues/11100))\n- Fixed an error that could occur when applying a draft. ([#11083](https://github.com/craftcms/cms/issues/11083))\n- Fixed a bug where element queries weren\u2019t returning any results if an element attribute table wasn\u2019t joined in, and the element query was set to an abstract element class. ([#11105](https://github.com/craftcms/cms/issues/11105))\n\n## 4.0.0.1 - 2022-05-04\n\n### Changed\n- The `setup` command now writes the application ID to a `CRAFT_APP_ID` environment variable.\n- The `setup` command now writes the security key to a `CRAFT_SECURITY_KEY` environment variable.\n\n## 4.0.0 - 2022-05-04\n\n### Added\n- Entries\u2019, categories\u2019, and assets\u2019 edit pages, and all element types via slideouts, now use a unified editing experience. ([#10467](https://github.com/craftcms/cms/pull/10467))\n- Categories now support drafts. ([#10467](https://github.com/craftcms/cms/pull/10467))\n- Element slideouts now support provisional drafts and autosaving, for element types that support them. ([#10467](https://github.com/craftcms/cms/pull/10467))\n- Element indexes can now be filtered by element attributes and custom field values. ([#9192](https://github.com/craftcms/cms/discussions/9192), [#9450](https://github.com/craftcms/cms/discussions/9450), [#9462](https://github.com/craftcms/cms/discussions/9462), [#9483](https://github.com/craftcms/cms/discussions/9483))\n- Admins can now create custom element sources from the Customize Sources modal. ([#8423](https://github.com/craftcms/cms/discussions/8423))\n- It\u2019s now possible to disable native element sources from the Customize Sources modal. ([#10676](https://github.com/craftcms/cms/discussions/10676))\n- Field layout tabs, fields, and UI elements can now be conditionally shown based on properties of the current user and/or element being edited. ([#8099](https://github.com/craftcms/cms/discussions/8099), [#8154](https://github.com/craftcms/cms/discussions/8154))\n- Assets, Entries, and Users fields have new condition settings that can be used to further limit which elements should be relatable, beyond the existing field settings. ([#10393](https://github.com/craftcms/cms/pull/10393))\n- Assets, Entries, and Users fields have new \u201cMin Relations\u201d settings, and their former \u201cLimit\u201d settings have been renamed to \u201cMax Relations\u201d. ([#8621](https://github.com/craftcms/cms/discussions/8621))\n- Added a dedicated \u201cFull Name\u201d field to users. \u201cFirst Name\u201d and \u201cLast Name\u201d are now parsed out from the full name automatically when a user is saved. ([#10405](https://github.com/craftcms/cms/discussions/10405))\n- Added the \u201cInactive\u201d user status, which can be used by users which can\u2019t be signed into. ([#8963](https://github.com/craftcms/cms/discussions/8963))\n- Added \u201cCredentialed\u201d and \u201cInactive\u201d user sources.\n- Added the \u201cDeactivate\u2026\u201d user action for pending and active users.\n- Users can now have an \u201cAddresses\u201d field. ([#10507](https://github.com/craftcms/cms/pull/10507))\n- Added the concept of \u201cfilesystems\u201d, which handle file operations, either locally or on a remote service like Amazon S3.\n- It\u2019s now possible to set sites\u2019 Status settings to environment variables. ([#3005](https://github.com/craftcms/cms/issues/3005))\n- Added the Money field type.\n- Craft now provides a native \u201cAlternative Text\u201d (`alt`) field for assets. ([#10302](https://github.com/craftcms/cms/discussions/10302))\n- Asset thumbnails in the control panel now have `alt` attributes, for assets with a filled-in Alternative Text value.\n- Added the `index-assets/cleanup` command.\n- Added the \u201cDeactivate users by default\u201d user registration setting, which replaces \u201cSuspend users by default\u201d. ([#5830](https://github.com/craftcms/cms/issues/5830))\n- Element source settings are now stored in the project config. ([#8616](https://github.com/craftcms/cms/discussions/8616))\n- Improved element index accessibility. ([#10629](https://github.com/craftcms/cms/pull/10629), [#10660](https://github.com/craftcms/cms/pull/10660))\n- Improved Live Preview accessibility for screen readers. ([#10688](https://github.com/craftcms/cms/pull/10688))\n- Slideouts, Live Preview, and Matrix blocks are no longer animated for browsers that have requested reduced motion. ([#10665](https://github.com/craftcms/cms/pull/10665))\n- Added support for `JSON` columns. ([#9089](https://github.com/craftcms/cms/pull/9089))\n- It\u2019s now possible to edit images\u2019 focal points from their preview modals. ([#8489](https://github.com/craftcms/cms/discussions/8489))\n- Added support for Monolog and the PSR-3 logging interface. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- Added the `|address` Twig filter.\n- Added the `|money` Twig filter.\n- Added the `collect()` Twig function.\n- Added the `assetUploaders`, `authors`, and `fullName` user query params.\n- Added the `primaryOwner` and `primaryOwnerId` Matrix block query params.\n- Added the `hasAlt` asset query param.\n- Added the `button`, `submitButton`, `fs`, `fsField`, `volume`, and `volumeField` macros to the `_includes/forms` control panel template.\n- Added the `buildId` general config. ([#10705](https://github.com/craftcms/cms/pull/10705))\n- Added support for setting custom config settings from `config/custom.php`, which are accessible via `Craft::$app->config->custom`. ([#10012](https://github.com/craftcms/cms/issues/10012))\n- Added the `addresses`, `address`, and `addressCount` GraphQL queries.\n- Added the `hasAlt` argument to asset GraphQL queries.\n- Added the `alt` field to assets queried via GraphQL.\n- Added the `fullName`, `assetUploaders`, and `authors` arguments to user GraphQL queries.\n- Added the `addresses` field to user GraphQL queries.\n- GraphQL schemas now include settings that determine which sites elements can be queried from. ([#10610](https://github.com/craftcms/cms/issues/10610))\n- Added the `assets/icon` action.\n- Added the `assets/update-focal-point` action.\n- Added the `categories/create` action.\n- Added the `elements/apply-draft` action.\n- Added the `elements/create` action.\n- Added the `elements/delete-draft` action.\n- Added the `elements/delete-for-site` action.\n- Added the `elements/delete` action.\n- Added the `elements/duplicate` action.\n- Added the `elements/edit` action.\n- Added the `elements/redirect` action.\n- Added the `elements/revert` action.\n- Added the `elements/save-draft` action.\n- Added the `elements/save` action.\n- Added the `users/delete-address` action.\n- Added the `users/save-address` action.\n- Added the `app/render-element` control panel controller action.\n- Added the `element-indexes/element-table-html` control panel controller action.\n- Added `craft\\base\\ApplicationTrait::getConditions()`.\n- Added `craft\\base\\ApplicationTrait::getElementSources()`, which replaces `getElementIndexes()`.\n- Added `craft\\base\\ApplicationTrait::getFs()`.\n- Added `craft\\base\\ApplicationTrait::getImageTransforms()`, which replaces `getAssetTransforms()`.\n- Added `craft\\base\\conditions\\BaseCondition`.\n- Added `craft\\base\\conditions\\BaseConditionRule`.\n- Added `craft\\base\\conditions\\BaseDateRangeConditionRule`.\n- Added `craft\\base\\conditions\\BaseElementSelectConditionRule`.\n- Added `craft\\base\\conditions\\BaseLightswitchConditionRule`.\n- Added `craft\\base\\conditions\\BaseMultiSelectConditionRule`.\n- Added `craft\\base\\conditions\\BaseNumberConditionRule`.\n- Added `craft\\base\\conditions\\BaseSelectConditionRule`.\n- Added `craft\\base\\conditions\\BaseTextConditionRule`.\n- Added `craft\\base\\conditions\\ConditionInterface`.\n- Added `craft\\base\\conditions\\ConditionRuleInterface`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_CREATE_DRAFTS`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_DELETE_FOR_SITE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_DELETE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_DUPLICATE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_SAVE`.\n- Added `craft\\base\\Element::EVENT_AUTHORIZE_VIEW`.\n- Added `craft\\base\\Element::EVENT_DEFINE_ADDITIONAL_BUTTONS`. ([#10420](https://github.com/craftcms/cms/discussions/10420))\n- Added `craft\\base\\Element::getParentId()`.\n- Added `craft\\base\\Element::hasNewParent()`.\n- Added `craft\\base\\Element::notesFieldHtml()`.\n- Added `craft\\base\\Element::setParentId()`.\n- Added `craft\\base\\Element::statusFieldHtml()`.\n- Added `craft\\base\\ElementInterface::canCreateDrafts()`.\n- Added `craft\\base\\ElementInterface::canDelete()`.\n- Added `craft\\base\\ElementInterface::canDeleteForSite()`.\n- Added `craft\\base\\ElementInterface::canDuplicate()`.\n- Added `craft\\base\\ElementInterface::canSave()`.\n- Added `craft\\base\\ElementInterface::canView()`.\n- Added `craft\\base\\ElementInterface::createAnother()`.\n- Added `craft\\base\\ElementInterface::createCondition()`.\n- Added `craft\\base\\ElementInterface::getAdditionalButtons()`.\n- Added `craft\\base\\ElementInterface::getPostEditUrl()`.\n- Added `craft\\base\\ElementInterface::getThumbAlt()`.\n- Added `craft\\base\\ElementInterface::hasRevisions()`.\n- Added `craft\\base\\ElementInterface::prepareEditScreen()`.\n- Added `craft\\base\\FieldInterface::getElementConditionRuleType()`.\n- Added `craft\\base\\FieldInterface::isRequirable()`.\n- Added `craft\\base\\FieldLayoutComponent`.\n- Added `craft\\base\\Fs`.\n- Added `craft\\base\\FsInterface`.\n- Added `craft\\base\\FsTrait`.\n- Added `craft\\base\\Image::heartbeat()`.\n- Added `craft\\base\\Image::setHeartbeatCallback()`.\n- Added `craft\\base\\imagetransforms\\EagerImageTransformerInterface`.\n- Added `craft\\base\\imagetransforms\\ImageEditorTransformerInterface`.\n- Added `craft\\base\\imagetransforms\\ImageTransformerInterface`.\n- Added `craft\\base\\LocalFsInterface`.\n- Added `craft\\base\\Model::defineBehaviors()`. ([#10691](https://github.com/craftcms/cms/pull/10691))\n- Added `craft\\base\\ModelInterface`.\n- Added `craft\\base\\NameTrait`.\n- Added `craft\\base\\PluginInterface::config()`. ([#11039](https://github.com/craftcms/cms/pull/11039))\n- Added `craft\\behaviors\\SessionBehavior::broadcastToJs()`.\n- Added `craft\\behaviors\\SessionBehavior::getError()`.\n- Added `craft\\behaviors\\SessionBehavior::getNotice()`.\n- Added `craft\\controllers\\AddressesController`.\n- Added `craft\\controllers\\AssetIndexesController`.\n- Added `craft\\controllers\\ConditionsController`.\n- Added `craft\\controllers\\ElementIndexesController::$condition`.\n- Added `craft\\controllers\\FsController`.\n- Added `craft\\controllers\\ImageTransformsController`.\n- Added `craft\\db\\Migration::archiveTableIfExists()`. ([#10827](https://github.com/craftcms/cms/discussions/10827))\n- Added `craft\\db\\Migration::dropAllForeignKeysToTable()`.\n- Added `craft\\db\\Migration::dropForeignKeyIfExists()`.\n- Added `craft\\db\\Migration::renameTable()`.\n- Added `craft\\db\\Query::collect()`, which returns the query results as an `Illuminate\\Support\\Collection` object rather than an array. ([#8513](https://github.com/craftcms/cms/discussions/8513))\n- Added `craft\\db\\Table::ADDRESSES`.\n- Added `craft\\db\\Table::ASSETINDEXINGSESSIONS`.\n- Added `craft\\db\\Table::IMAGETRANSFORMINDEX`.\n- Added `craft\\db\\Table::IMAGETRANSFORMS`.\n- Added `craft\\db\\Table::MATRIXBLOCKS_OWNERS`.\n- Added `craft\\debug\\LogTarget`.\n- Added `craft\\debug\\MailPanel`.\n- Added `craft\\elements\\Address`.\n- Added `craft\\elements\\Asset::$alt`.\n- Added `craft\\elements\\Asset::EVENT_AFTER_GENERATE_TRANSFORM`.\n- Added `craft\\elements\\Asset::EVENT_BEFORE_GENERATE_TRANSFORM`.\n- Added `craft\\elements\\Asset::getFs()`.\n- Added `craft\\elements\\Asset::setFilename()`.\n- Added `craft\\elements\\conditions\\addresses\\AddressCondition`.\n- Added `craft\\elements\\conditions\\addresses\\CountryConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\AssetCondition`.\n- Added `craft\\elements\\conditions\\assets\\DateModifiedConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\FilenameConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\FileSizeConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\FileTypeConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\HasAltConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\HeightConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\UploaderConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\VolumeConditionRule`.\n- Added `craft\\elements\\conditions\\assets\\WidthConditionRule`.\n- Added `craft\\elements\\conditions\\categories\\CategoryCondition`.\n- Added `craft\\elements\\conditions\\categories\\GroupConditionRule`.\n- Added `craft\\elements\\conditions\\DateCreatedConditionRule`.\n- Added `craft\\elements\\conditions\\DateUpdatedConditionRule`.\n- Added `craft\\elements\\conditions\\ElementCondition`.\n- Added `craft\\elements\\conditions\\ElementConditionInterface`.\n- Added `craft\\elements\\conditions\\ElementConditionRuleInterface`.\n- Added `craft\\elements\\conditions\\entries\\AuthorConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\AuthorGroupConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\EntryCondition`.\n- Added `craft\\elements\\conditions\\entries\\ExpiryDateConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\PostDateConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\SectionConditionRule`.\n- Added `craft\\elements\\conditions\\entries\\TypeConditionRule`.\n- Added `craft\\elements\\conditions\\HasUrlConditionRule`.\n- Added `craft\\elements\\conditions\\IdConditionRule`.\n- Added `craft\\elements\\conditions\\LevelConditionRule`.\n- Added `craft\\elements\\conditions\\RelatedToConditionRule`.\n- Added `craft\\elements\\conditions\\SlugConditionRule`.\n- Added `craft\\elements\\conditions\\tags\\GroupConditionRule`.\n- Added `craft\\elements\\conditions\\tags\\TagCondition`.\n- Added `craft\\elements\\conditions\\TitleConditionRule`.\n- Added `craft\\elements\\conditions\\UriConditionRule`.\n- Added `craft\\elements\\conditions\\users\\AdminConditionRule`.\n- Added `craft\\elements\\conditions\\users\\CredentialedConditionRule`.\n- Added `craft\\elements\\conditions\\users\\EmailConditionRule`.\n- Added `craft\\elements\\conditions\\users\\FirstNameConditionRule`.\n- Added `craft\\elements\\conditions\\users\\GroupConditionRule`.\n- Added `craft\\elements\\conditions\\users\\LastLoginDateConditionRule`.\n- Added `craft\\elements\\conditions\\users\\LastNameConditionRule`.\n- Added `craft\\elements\\conditions\\users\\UserCondition`.\n- Added `craft\\elements\\conditions\\users\\UsernameConditionRule`.\n- Added `craft\\elements\\db\\AddressQuery`.\n- Added `craft\\elements\\MatrixBlock::$primaryOwnerId`.\n- Added `craft\\elements\\MatrixBlock::$saveOwnership`.\n- Added `craft\\elements\\User::$active`.\n- Added `craft\\elements\\User::$fullName`.\n- Added `craft\\elements\\User::canAssignUserGroups()`.\n- Added `craft\\elements\\User::getAddresses()`.\n- Added `craft\\elements\\User::getIsCredentialed()`.\n- Added `craft\\elements\\User::STATUS_INACTIVE`.\n- Added `craft\\errors\\FsException`.\n- Added `craft\\errors\\FsObjectExistsException`.\n- Added `craft\\errors\\FsObjectNotFoundException`.\n- Added `craft\\errors\\ImageTransformException`.\n- Added `craft\\errors\\InvalidFsException`.\n- Added `craft\\errors\\MissingVolumeFolderException`.\n- Added `craft\\events\\AuthorizationCheckEvent`.\n- Added `craft\\events\\CreateElementCheckEvent`.\n- Added `craft\\events\\DefineElementEditorHtmlEvent`.\n- Added `craft\\events\\DefineElementInnerHtmlEvent`. ([#11035](https://github.com/craftcms/cms/pull/11035))\n- Added `craft\\events\\DefineHtmlEvent::$static`.\n- Added `craft\\events\\FsEvent`.\n- Added `craft\\events\\GenerateTransformEvent::$asset`.\n- Added `craft\\events\\GenerateTransformEvent::$transform`.\n- Added `craft\\events\\GenerateTransformEvent::$url`.\n- Added `craft\\events\\ImageTransformerOperationEvent`.\n- Added `craft\\events\\ImageTransformEvent`.\n- Added `craft\\events\\RegisterConditionRuleTypesEvent`.\n- Added `craft\\events\\TransformImageEvent`.\n- Added `craft\\fieldlayoutelements\\addresses\\AddressField`.\n- Added `craft\\fieldlayoutelements\\addresses\\CountryCodeField`.\n- Added `craft\\fieldlayoutelements\\addresses\\LabelField`.\n- Added `craft\\fieldlayoutelements\\addresses\\LatLongField`.\n- Added `craft\\fieldlayoutelements\\addresses\\OrganizationField`.\n- Added `craft\\fieldlayoutelements\\addresses\\OrganizationTaxIdField`.\n- Added `craft\\fieldlayoutelements\\assets\\AltField`.\n- Added `craft\\fieldlayoutelements\\BaseField::selectorLabel()`.\n- Added `craft\\fieldlayoutelements\\FullNameField`.\n- Added `craft\\fieldlayoutelements\\TextareaField`.\n- Added `craft\\fieldlayoutelements\\users\\AddressesField`.\n- Added `craft\\fields\\Assets::$allowSubfolders`.\n- Added `craft\\fields\\Assets::$restrictedDefaulUploadSubpath`.\n- Added `craft\\fields\\BaseRelationField::createSelectionCondition()`.\n- Added `craft\\fields\\BaseRelationField::getSelectionCondition()`.\n- Added `craft\\fields\\BaseRelationField::setSelectionCondition()`.\n- Added `craft\\fields\\conditions\\DateFieldConditionRule`.\n- Added `craft\\fields\\conditions\\FieldConditionRuleInterface`.\n- Added `craft\\fields\\conditions\\FieldConditionRuleTrait`.\n- Added `craft\\fields\\conditions\\LightswitchFieldConditionRule`.\n- Added `craft\\fields\\conditions\\NumberFieldConditionRule`.\n- Added `craft\\fields\\conditions\\OptionsFieldConditionRule`.\n- Added `craft\\fields\\conditions\\RelationalFieldConditionRule`.\n- Added `craft\\fields\\conditions\\TextFieldConditionRule`.\n- Added `craft\\fields\\Money`.\n- Added `craft\\fs\\Local`.\n- Added `craft\\fs\\MissingFs`.\n- Added `craft\\fs\\Temp`.\n- Added `craft\\gql\\arguments\\elements\\Address`.\n- Added `craft\\gql\\base\\SingularTypeInterface`.\n- Added `craft\\gql\\interfaces\\elements\\Address`.\n- Added `craft\\gql\\queries\\Address`.\n- Added `craft\\gql\\resolvers\\elements\\Address`.\n- Added `craft\\gql\\TypeManager::registerFieldDefinitions()`.\n- Added `craft\\gql\\types\\elements\\Address`.\n- Added `craft\\gql\\types\\generators\\AddressType`.\n- Added `craft\\helpers\\App::cliOption()`.\n- Added `craft\\helpers\\App::devMode()`.\n- Added `craft\\helpers\\App::envConfig()`. ([#10869](https://github.com/craftcms/cms/pull/10869))\n- Added `craft\\helpers\\App::isStreamLog()`.\n- Added `craft\\helpers\\App::normalizeValue()`.\n- Added `craft\\helpers\\Assets::downloadFile()`.\n- Added `craft\\helpers\\Assets::iconPath()`.\n- Added `craft\\helpers\\Assets::iconUrl()`.\n- Added `craft\\helpers\\Assets::revParams()`.\n- Added `craft\\helpers\\Cp::addressCardHtml()`.\n- Added `craft\\helpers\\Cp::addressCardsHtml()`.\n- Added `craft\\helpers\\Cp::addressFieldsHtml()`.\n- Added `craft\\helpers\\Cp::dateFieldHtml()`.\n- Added `craft\\helpers\\Cp::dateHtml()`.\n- Added `craft\\helpers\\Cp::elementSelectHtml()`.\n- Added `craft\\helpers\\Cp::EVENT_DEFINE_ELEMENT_INNER_HTML`. ([#11035](https://github.com/craftcms/cms/pull/11035))\n- Added `craft\\helpers\\Cp::fieldLayoutDesignerHtml()`.\n- Added `craft\\helpers\\Cp::lightswitchHtml()`.\n- Added `craft\\helpers\\Cp::multiSelectFieldHtml()`.\n- Added `craft\\helpers\\Cp::multiSelectHtml()`.\n- Added `craft\\helpers\\Cp::requestedSite()`.\n- Added `craft\\helpers\\Cp::textareaHtml()`.\n- Added `craft\\helpers\\Cp::textHtml()`.\n- Added `craft\\helpers\\Cp::timeFieldHtml()`.\n- Added `craft\\helpers\\Cp::timeHtml()`.\n- Added `craft\\helpers\\Db::dropAllForeignKeysToTable()`.\n- Added `craft\\helpers\\Db::dropForeignKeyIfExists()`.\n- Added `craft\\helpers\\Db::dropIndexIfExists()`.\n- Added `craft\\helpers\\Db::findForeignKey()`.\n- Added `craft\\helpers\\Db::findIndex()`.\n- Added `craft\\helpers\\Db::parseMoneyParam()`.\n- Added `craft\\helpers\\Db::parseNumericParam()`.\n- Added `craft\\helpers\\Db::prepareMoneyForDb()`.\n- Added `craft\\helpers\\Db::renameTable()`.\n- Added `craft\\helpers\\FileHelper::deleteFileAfterRequest()`.\n- Added `craft\\helpers\\FileHelper::deleteQueuedFiles()`.\n- Added `craft\\helpers\\Gql::getSchemaContainedEntryTypes)()`.\n- Added `craft\\helpers\\Html::hiddenLabel()`.\n- Added `craft\\helpers\\Html::unwrapCondition()`.\n- Added `craft\\helpers\\Html::unwrapNoscript()`.\n- Added `craft\\helpers\\ImageTransforms`.\n- Added `craft\\helpers\\Money`.\n- Added `craft\\helpers\\Number::isInt()`.\n- Added `craft\\helpers\\Number::toIntOrFloat()`.\n- Added `craft\\helpers\\ProjectConfig::encodeValueAsString()`.\n- Added `craft\\helpers\\ProjectConfig::ensureAllSectionsProcessed()`.\n- Added `craft\\helpers\\ProjectConfig::traverseDataArray()`.\n- Added `craft\\helpers\\Typecast`. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- Added `craft\\i18n\\Translation`.\n- Added `craft\\imagetransforms\\ImageTransformer`.\n- Added `craft\\log\\ContextProcessor`.\n- Added `craft\\log\\Dispatcher::getTargets()`.\n- Added `craft\\log\\MessageProcessor`.\n- Added `craft\\log\\MonologTarget`.\n- Added `craft\\models\\AssetIndexingSession`.\n- Added `craft\\models\\FieldLayout::getElementsByType()`.\n- Added `craft\\models\\FieldLayout::getFirstElementByType()`.\n- Added `craft\\models\\FieldLayout::getFirstVisibleElementByType()`.\n- Added `craft\\models\\FieldLayout::getVisibleCustomFields()`.\n- Added `craft\\models\\FieldLayout::getVisibleElementsByType()`.\n- Added `craft\\models\\FieldLayoutElement::$uid`.\n- Added `craft\\models\\FieldLayoutElement::getLayout()` and `setLayout()`.\n- Added `craft\\models\\FieldLayoutForm::getVisibleElements()`.\n- Added `craft\\models\\FieldLayoutFormTab::getTabId()`.\n- Added `craft\\models\\FieldLayoutFormTab::getUid()`.\n- Added `craft\\models\\FieldLayoutTab::getElements()` and `setElements()`.\n- Added `craft\\models\\FsListing`.\n- Added `craft\\models\\ImageTransform`.\n- Added `craft\\models\\ImageTransformIndex`.\n- Added `craft\\models\\ProjectConfigData`.\n- Added `craft\\models\\ReadOnlyProjectConfigData`.\n- Added `craft\\models\\Volume`.\n- Added `craft\\queue\\jobs\\Proxy`.\n- Added `craft\\queue\\Queue::$proxyQueue`, which can be set to another queue configuration that all jobs should be sent to as proxies. ([#10999](https://github.com/craftcms/cms/pull/10999))\n- Added `craft\\records\\Address`.\n- Added `craft\\records\\AssetIndexingSession`.\n- Added `craft\\records\\ImageTransform`.\n- Added `craft\\services\\Addresses`.\n- Added `craft\\services\\AssetIndexer::createIndexingSession()`.\n- Added `craft\\services\\AssetIndexer::getExistingIndexingSessions()`.\n- Added `craft\\services\\AssetIndexer::getIndexingSessionById()`.\n- Added `craft\\services\\AssetIndexer::getMissingEntriesForSession()`.\n- Added `craft\\services\\AssetIndexer::getSkippedItemsForSession()`.\n- Added `craft\\services\\AssetIndexer::indexFileByListing()`.\n- Added `craft\\services\\AssetIndexer::indexFolderByEntry()`.\n- Added `craft\\services\\AssetIndexer::indexFolderByListing()`.\n- Added `craft\\services\\AssetIndexer::processIndexSession()`.\n- Added `craft\\services\\AssetIndexer::removeCliIndexingSessions()`.\n- Added `craft\\services\\AssetIndexer::startIndexingSession()`.\n- Added `craft\\services\\AssetIndexer::stopIndexingSession()`.\n- Added `craft\\services\\Assets::getImagePreviewUrl()`.\n- Added `craft\\services\\AssetTransforms::deleteTransformIndexDataByAssetIds()`.\n- Added `craft\\services\\Conditions`.\n- Added `craft\\services\\Config::CATEGORY_CUSTOM`.\n- Added `craft\\services\\Config::getCustom()`.\n- Added `craft\\services\\Drafts::removeDraftData()`.\n- Added `craft\\services\\ElementSources`, which replaces `craft\\services\\ElementIndexes`.\n- Added `craft\\services\\Fields::createLayout()`.\n- Added `craft\\services\\Fs`.\n- Added `craft\\services\\Gc::hardDeleteElements()`.\n- Added `craft\\services\\Gc::removeEmptyTempFolders()`.\n- Added `craft\\services\\Gql::prepareFieldDefinitions()`.\n- Added `craft\\services\\ImageTransforms`.\n- Added `craft\\services\\Matrix::createRevisionBlocks()`.\n- Added `craft\\services\\Matrix::duplicateOwnership()`.\n- Added `craft\\services\\ProjectConfig::ASSOC_KEY`.\n- Added `craft\\services\\ProjectConfig::PATH_DATE_MODIFIED`.\n- Added `craft\\services\\ProjectConfig::PATH_ELEMENT_SOURCES`.\n- Added `craft\\services\\ProjectConfig::PATH_FS`.\n- Added `craft\\services\\ProjectConfig::PATH_META_NAMES`.\n- Added `craft\\services\\ProjectConfig::PATH_SCHEMA_VERSION`.\n- Added `craft\\services\\ProjectConfig::PATH_SYSTEM`.\n- Added `craft\\services\\ProjectConfig::rememberAppliedChanges()`.\n- Added `craft\\services\\Users::deactivateUser()`.\n- Added `craft\\services\\Users::ensureUserByEmail()`, which will return a user for the given email, creating one if it didn\u2019t exist yet.\n- Added `craft\\services\\Users::EVENT_AFTER_DEACTIVATE_USER`.\n- Added `craft\\services\\Users::EVENT_BEFORE_DEACTIVATE_USER`.\n- Added `craft\\services\\Users::removeCredentials()`.\n- Added `craft\\services\\Volumes::getTemporaryVolume()`.\n- Added `craft\\services\\Volumes::getUserPhotoVolume()`.\n- Added `craft\\validators\\MoneyValidator`.\n- Added `craft\\web\\assets\\conditionbuilder\\ConditionBuilderAsset`.\n- Added `craft\\web\\assets\\htmx\\HtmxAsset`.\n- Added `craft\\web\\assets\\money\\MoneyAsset`.\n- Added `craft\\web\\Controller::asCpScreen()`.\n- Added `craft\\web\\Controller::asFailure()`.\n- Added `craft\\web\\Controller::asModelFailure()`.\n- Added `craft\\web\\Controller::asModelSuccess()`.\n- Added `craft\\web\\Controller::asSuccess()`.\n- Added `craft\\web\\Controller::CpScreenResponseBehavior()`.\n- Added `craft\\web\\Controller::CpScreenResponseFormatter()`.\n- Added `craft\\web\\Controller::getPostedRedirectUrl()`.\n- Added `craft\\web\\Controller::TemplateResponseBehavior()`.\n- Added `craft\\web\\Controller::TemplateResponseFormatter()`.\n- Added `craft\\web\\twig\\Extension::addressFilter()`.\n- Added `craft\\web\\twig\\Extension::moneyFilter()`.\n- Added `craft\\web\\twig\\variables\\Cp::fieldLayoutDesigner()`.\n- Added `craft\\web\\twig\\variables\\Cp::getFsOptions()`.\n- Added `craft\\web\\twig\\variables\\Cp::getVolumeOptions()`.\n- Added `craft\\web\\View::clearCssFileBuffer()`.\n- Added `craft\\web\\View::clearJsFileBuffer()`.\n- Added `craft\\web\\View::startCssFileBuffer()`.\n- Added `craft\\web\\View::startJsFileBuffer()`.\n- Added the `Craft.appendBodyHtml()` JavaScript method, which replaces the now-deprecated `appendFootHtml()` method.\n- Added the `Craft.CpScreenSlideout` JavaScript class, which can be used to create slideouts from actions that return `$this->asCpScreen()`.\n- Added the `Craft.ElementEditor` JavaScript class.\n- Added the `Craft.ElementEditorSlideout` JavaScript class.\n- Added the `Craft.getPageUrl()` JavaScript method.\n- Added the `Craft.getQueryParam()` JavaScript method.\n- Added the `Craft.getQueryParams()` JavaScript method.\n- Added the `Craft.namespaceId()` JavaScript method.\n- Added the `Craft.namespaceInputName()` JavaScript method.\n- Added the `Craft.Preview.refresh()` JavaScript method.\n- Added the `Craft.Queue` JavaScript class.\n- Added the `Craft.setElementAttributes()` JavaScript method.\n- Added the `Craft.setPath()` JavaScript method.\n- Added the `Craft.setQueryParam()` JavaScript method.\n- Added the `Craft.setUrl()` JavaScript method.\n- Added the `Craft.ui.createButton()` JavaScript method.\n- Added the `Craft.ui.createSubmitButton()` JavaScript method.\n- Added the `htmx.org` JavaScript library.\n- Added the commerceguys/addressing package.\n- Added the illuminate/collections package. ([#8475](https://github.com/craftcms/cms/discussions/8475))\n- Added the moneyphp/money package.\n- Added the symfony/var-dumper package.\n- Added the theiconic/name-parser package.\n- Added the yiisoft/yii2-symfonymailer package.\n\n### Changed\n- Craft now requires PHP 8.0.2 or later.\n- Craft now requires MySQL 5.7.8 / MariaDB 10.2.7 / PostgreSQL 10.0 or later.\n- Craft now requires the [Intl](https://php.net/manual/en/book.intl.php) and [BCMath](https://www.php.net/manual/en/book.bc.php) PHP extensions.\n- Improved draft creation/application performance. ([#10577](https://github.com/craftcms/cms/pull/10577))\n- Improved revision creation performance. ([#10589](https://github.com/craftcms/cms/pull/10577))\n- The \u201cWhat\u2019s New\u201d HUD now displays an icon and label above each announcement, identifying where it came from (Craft CMS or a plugin). ([#9747](https://github.com/craftcms/cms/discussions/9747))\n- The control panel now keeps track of the currently-edited site on a per-tab basis by adding a `site` query string param to all control panel URLs. ([#8920](https://github.com/craftcms/cms/discussions/8920))\n- Element index pages\u2019 status and sort menu option selections are now coded into the page URL via `status` and `sort` query string params. ([#10669](https://github.com/craftcms/cms/discussions/10669))\n- Users are no longer required to have a username or email.\n- Users can now set their Formatting Locale to any known locale; not just the available Language options. ([#10519](https://github.com/craftcms/cms/pull/10519))\n- Users\u2019 Language and Formatting Locale settings now display locale names in the current language and their native languages. ([#10519](https://github.com/craftcms/cms/pull/10519))\n- User queries now return all users by default, rather than only active users.\n- Filtering users by `active`, `pending`, and `locked` statuses no longer excludes suspended users.\n- `credentialed` and `inactive` are now reserved user group handles.\n- Elements throughout the control panel are now automatically updated whenever they\u2019re saved by another browser tab.\n- Assets fields that are restricted to a single location can now be configured to allow selection within subfolders of that location. ([#9070](https://github.com/craftcms/cms/discussions/9070))\n- When an image is saved as a new asset from the Image Editor via an Assets field, the Assets field will now automatically replace the selected asset with the new one. ([#8974](https://github.com/craftcms/cms/discussions/8974))\n- `alt` is now a reserved field handle for volume field layouts.\n- Volumes no longer have \u201ctypes\u201d, and their file operations are now delegated to a filesystem selected by an \u201cAsset Filesystem\u201d setting on the volume.\n- Volumes now have \u201cTransform Filesystem\u201d and \u201cTransform Subpath\u201d settings, which can be used to choose where image transforms should be stored. (The volume\u2019s Asset Filesystem will be used by default.)\n- Asset thumbnails are now generated as image transforms.\n- It\u2019s now possible to create volumes directly from the User Settings page.\n- Images that are not web-safe now are always converted to JPEGs when transforming, if no format was specified.\n- Entry post dates are no longer set automatically until the entry is validated with the `live` scenario. ([#10093](https://github.com/craftcms/cms/pull/10093))\n- Entry queries\u2019 `authorGroup()` param method now accepts an array of `craft\\models\\UserGroup` objects.\n- Element queries\u2019 `revision` params can now be set to `null` to include normal and revision elements.\n- Element queries can no longer be traversed or accessed like an array. Use a query execution method such as `all()`, `collect()`, or `one()` to fetch the results before working with them.\n- Element queries\u2019 `title` params no longer treat values with commas as arrays. ([#10891](https://github.com/craftcms/cms/issues/10891))\n- User queries\u2019 `firstName` and `lastName` params no longer treat values with commas as arrays. ([#10891](https://github.com/craftcms/cms/issues/10891))\n- Relational fields now load elements in the current site rather than the primary site, if the source element isn\u2019t localizable. ([#7048](https://github.com/craftcms/cms/issues/7048))\n- Lightswitch fields can no longer be marked as required within field layouts. ([#10773](https://github.com/craftcms/cms/issues/10773))\n- Built-in queue jobs are now always translated for the current user\u2019s language. ([#9745](https://github.com/craftcms/cms/pull/9745))\n- Path options passed to console commands (e.g. `--basePath`) now take precedence over their environment variable/PHP constant counterparts.\n- Database backups are now named after the Craft version in the database, rather than the Composer-installed version. ([#9733](https://github.com/craftcms/cms/discussions/9733))\n- Template autosuggestions now include their filename. ([#9744](https://github.com/craftcms/cms/pull/9744))\n- Improved the look of loading spinners in the control panel. ([#9109](https://github.com/craftcms/cms/discussions/9109))\n- The default `subLeft` and `subRight` search query term options are now only applied to terms that don\u2019t include an asterisk at the beginning/end, e.g. `hello*`. ([#10613](https://github.com/craftcms/cms/discussions/10613))\n- `{% cache %}` tags now store any external JavaScript or CSS files registered with `{% js %}` and `{% css %}` tags. ([#9987](https://github.com/craftcms/cms/discussions/9987))\n- All control panel templates end in `.twig` now. ([#9743](https://github.com/craftcms/cms/pull/9743))\n- 404 requests are no longer logged by default. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- Log entries are now single-line by default when Dev Mode is disabled. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- Log files are now rotated once every 24 hours. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- `CRAFT_STREAM_LOG` no longer logs _in addition to_ other log targets. ([#10659](https://github.com/craftcms/cms/pull/10659))\n- The default log target no longer logs `debug` or `info` messages when Dev Mode is enabled. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- SQL query logs now use the `debug` log level, so they no longer get logged when Dev Mode is enabled. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- `yii\\db\\Connection::$enableLogging` and `$enableProfiling` are no longer enabled by default when Dev Mode is disabled. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- The `queue` log target no longer has special handling for Yii or `info` logs. ([#10916](https://github.com/craftcms/cms/pull/10916))\n- A warning is now logged if an element query is executed before Craft is fully initialized. ([#11033](https://github.com/craftcms/cms/issues/11033))\n- A warning is now logged if Twig is instantiated before Craft is fully initialized. ([#11033](https://github.com/craftcms/cms/issues/11033))\n- Craft\u2019s bootstrap script now attempts to create its configured system paths automatically. ([#10562](https://github.com/craftcms/cms/pull/10562))\n- When using GraphQL to mutate entries, the `enabled` status is now affected on a per-site basis when specifying both the `enabled` and `siteId` parameters. ([#9771](https://github.com/craftcms/cms/issues/9771))\n- The `forms/selectize` control panel template now supports `addOptionFn` and `addOptionLabel` params, which can be set to add new options to the list.\n- Editable tables now support `allowAdd`, `allowDelete`, and `allowReorder` settings, replacing `staticRows`. ([#10163](https://github.com/craftcms/cms/pull/10163))\n- Column definitions passed to the `_includes/forms/editableTable` control panel template can now specify a `width` key. ([#11062](https://github.com/craftcms/cms/pull/11062))\n- The `limitField` macro in the `_components/fieldtypes/elementfieldsettings` control panel template has been renamed to `limitFields`.\n- Renamed the `elements/get-categories-input-html` action to `categories/input-html`.\n- Renamed the `elements/get-modal-body` action to `element-selector-modals/body`.\n- The `entries/save-entry` action now returns a 400 HTTP status for JSON responses when the entry couldn\u2019t be saved.\n- The `users/save-user` action no longer includes a `unverifiedEmail` key in failure responses.\n- The `users/set-password` action now returns a 400 HTTP status when an invalid token is passed, if there\u2019s no URL to redirect to. ([#10592](https://github.com/craftcms/cms/discussions/10592))\n- `install/*`, `setup/*`, `db/*`, and `help` actions no longer output a warning if Craft can\u2019t connect to the database. ([#10851](https://github.com/craftcms/cms/pull/10851))\n- `createFoldersInVolume:<uid>` user permissions have been renamed to `createFolders:<uid>`.\n- `deleteFilesAndFoldersInVolume:<uid>` user permissions have been renamed to `deleteAssets:<uid>`.\n- `deletePeerFilesInVolume:<uid>` user permissions have been renamed to `deletePeerAssets:<uid>`.\n- `editCategories:<uid>` user permissions have been split into `viewCategories:<uid>`, `saveCategories:<uid>`, `deleteCategories:<uid>`, `viewPeerCategoryDrafts:<uid>`, `savePeerCategoryDrafts:<uid>`, and `deletePeerCategoryDrafts:<uid>`.\n- `editEntries:<uid>` user permissions have been renamed to `viewEntries:<uid>`.\n- `editImagesInVolume:<uid>` user permissions have been renamed to `editImages:<uid>`.\n- `editPeerEntries:<uid>` user permissions have been renamed to `viewPeerEntries:<uid>`.\n- `editPeerEntryDrafts:<uid>` user permissions have been split into `viewPeerEntryDrafts:<uid>` and `savePeerEntryDrafts:<uid>`.\n- `editPeerFilesInVolume:<uid>` user permissions have been renamed to `savePeerAssets:<uid>`.\n- `editPeerImagesInVolume:<uid>` user permissions have been renamed to `editPeerImages:<uid>`.\n- `publishEntries:<uid>` user permissions have been renamed to `saveEntries:<uid>`, and no longer differentiate between enabled and disabled entries. (Users with `viewEntries:<uid>` permissions will still be able to create drafts.)\n- `publishPeerEntries:<uid>` user permissions have been renamed to `savePeerEntries:<uid>`, and no longer differentiate between enabled and disabled entries. (Users with `viewPeerEntries:<uid>` permissions will still be able to create drafts.)\n- `replaceFilesInVolume:<uid>` user permissions have been renamed to `replaceFiles:<uid>`.\n- `replacePeerFilesInVolume:<uid>` user permissions have been renamed to `replacePeerFiles:<uid>`.\n- `saveAssetInVolume:<uid>` user permissions have been renamed to `saveAssets:<uid>`.\n- `viewPeerFilesInVolume:<uid>` user permissions have been renamed to `viewPeerAssets:<uid>`.\n- `viewVolume:<uid>` user permissions have been renamed to `viewAssets:<uid>`.\n- Elements\u2019 `searchScore` GraphQL fields are now returned as integers.\n- Element types must now override `craft\\base\\Element::isDeletable()` if its elements should be deletable from the index page.\n- Element types\u2019 `cpEditUrl()` methods no longer need to add a `site` param; one will be added automatically by `craft\\base\\Element::getCpEditUrl()`.\n- Element types\u2019 `defineActions()` methods\u2019 `$source` arguments should no longer accept `null`.\n- Element types\u2019 `defineSources()` methods\u2019 `$context` arguments should no longer accept `null`.\n- Element types\u2019 `getHtmlAttributes()` and `htmlAttributes()` methods must now return attribute arrays that are compatible with `craft\\helpers\\Html::renderTagAttributes()`.\n- Element types\u2019 `sources()` methods\u2019 `$context` arguments should no longer accept `null`.\n- Element types\u2019 `tableAttributes()` and `defineTableAttributes()` methods should no longer return a generic attribute for defining the header column heading at the beginning of the returned array. The header column heading is now set to the element type\u2019s display name, per its `displayName()` method.\n- Block element types\u2019 `getOwner()` methods can now return `null`.\n- Control panel resource locations are now cached, so resource requests can be resolved when Craft isn\u2019t installed yet, or a database connection can\u2019t be established. ([#10642](https://github.com/craftcms/cms/pull/10642))\n- Control panel resources are now served with cache headers, if the `buildId` config setting is set. ([#10705](https://github.com/craftcms/cms/pull/10705))\n- Empty subfolders within the temporary upload volume are now removed during garbage collection. ([#10746](https://github.com/craftcms/cms/issues/10746))\n- Most config settings can now be overridden via environment variables. ([#10573](https://github.com/craftcms/cms/pull/10573), [#10869](https://github.com/craftcms/cms/pull/10869))\n- It\u2019s now possible to configure the Debug Toolbar to store its data files on a filesystem, rather than within `storage/runtime/debug/`. ([#10825](https://github.com/craftcms/cms/pull/10825))\n- `craft\\base\\AssetPreviewHandlerInterface::getPreviewHtml()` now accepts an optional array of variable to pass on to the template.\n- `craft\\base\\Element::__get()` now clones custom field values before returning them. ([#8781](https://github.com/craftcms/cms/discussions/8781))\n- `craft\\base\\Element::fieldLayoutFields()` now has a `visibleOnly` argument.\n- `craft\\base\\Element::getFieldValue()` now returns eager-loaded element values for the field, when they exist. ([#10047](https://github.com/craftcms/cms/issues/10047))\n- `craft\\base\\Element::metaFieldsHtml()` now has a `static` argument.\n- `craft\\base\\Element::setFieldValue()` now unsets any previously-eager-loaded elements for the field. ([#11003](https://github.com/craftcms/cms/discussions/11003))\n- `craft\\base\\Element::slugFieldHtml()` now has a `static` argument.\n- `craft\\base\\ElementInterface::getEagerLoadedElements()` now returns an `Illuminate\\Support\\Collection` object instead of an array. ([#8513](https://github.com/craftcms/cms/discussions/8513))\n- `craft\\base\\ElementInterface::getSidebarHtml()` now has a `static` argument.\n- `craft\\base\\MemoizableArray` no longer extends `ArrayObject`, and now implements `IteratorAggregate` and `Countable` directly.\n- `craft\\base\\Model::__construct()` and `setAttributes()` now automatically typecast values that map to properties with `int`, `float`, `int|float`, `string`, `bool`, `array`, or `DateTime` type declarations. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- `craft\\base\\Model::datetimeAttributes()` is now called from the constructor, instead of the `init()` method.\n- `craft\\base\\Model::setAttributes()` now normalizes date attributes into `DateTime` objects.\n- `craft\\behaviors\\FieldLayoutBehavior::getFields()` has been renamed to `getCustomFields()`.\n- `craft\\elements\\Asset::getImg()` now sets the `alt` attribute to the native Alternative Text field value, if set.\n- `craft\\elements\\Asset::getVolume()` now returns an instance of `craft\\models\\Volume`.\n- `craft\\elements\\db\\ElementQuery::ids()` no longer accepts an array of criteria params.\n- `craft\\events\\DraftEvent::$source` has been renamed to `$canonical`.\n- `craft\\events\\GetAssetThumbUrlEvent` has been renamed to `DefineAssetThumbUrlEvent`.\n- `craft\\events\\GetAssetUrlEvent` has been renamed to `DefineAssetUrlEvent`.\n- `craft\\events\\RevisionEvent::$source` has been renamed to `$canonical`.\n- `craft\\fieldlayoutelements\\AssetTitleField` has been renamed to `craft\\fieldlayoutelements\\assets\\AssetTitleField`.\n- `craft\\fieldlayoutelements\\EntryTitleField` has been renamed to `craft\\fieldlayoutelements\\entries\\EntryTitleField`.\n- `craft\\fieldlayoutelements\\StandardField` has been renamed to `craft\\fieldlayoutelements\\BaseNativeField`.\n- `craft\\fieldlayoutelements\\StandardTextField` has been renamed to `craft\\fieldlayoutelements\\TextField`.\n- `craft\\fields\\Assets::$singleUploadLocationSource` has been renamed to `$restrictedLocationSource`.\n- `craft\\fields\\Assets::$singleUploadLocationSubpath` has been renamed to `$restrictedLocationSubpath`.\n- `craft\\fields\\Assets::$useSingleFolder` has been renamed to `$restrictLocation`.\n- `craft\\fields\\BaseRelationField::$limit` has been renamed to `$maxRelations`.\n- `craft\\fields\\BaseRelationField::elementType()` is now public.\n- `craft\\fields\\BaseRelationField::inputSelectionCriteria()` has been renamed to `getInputSelectionCriteria()`, and is now public.\n- `craft\\fields\\BaseRelationField::inputSources()` has been renamed to `getInputSources()`, and is now public.\n- `craft\\gql\\directives\\FormatDateTime::defaultTimezone()` has been renamed to `defaultTimeZone()`.\n- `craft\\gql\\TypeManager::EVENT_DEFINE_GQL_TYPE_FIELDS` is now triggered when actually resolving fields for a GraphQL type, rather than when the type is first created. ([#9626](https://github.com/craftcms/cms/issues/9626))\n- `craft\\helpers\\App::env()` now checks for a PHP constant as well, if the environment variable didn\u2019t exist.\n- `craft\\helpers\\App::env()` now returns `null` if a value couldn\u2019t be found, rather than `false`.\n- `craft\\helpers\\App::env()` now returns a boolean if the original value was `'true'` or `'false'`.\n- `craft\\helpers\\App::env()` now returns an integer or float if the original value was numeric.\n- `craft\\helpers\\ArrayHelper::getValue()` now supports keys in square bracket syntax, e.g. `foo[bar][baz]`.\n- `craft\\helpers\\Assets::generateUrl()` no longer accepts a transform index for date modified comparisons. A `DateTime` object is expected instead.\n- `craft\\helpers\\Assets::urlAppendix()` no longer accepts a transform index for date modified comparisons. A `DateTime` object is expected instead.\n- `craft\\helpers\\Component::createComponent()` now automatically typecasts values that map to properties with `int`, `float`, `int|float`, `string`, `bool`, `array`, or `DateTime` type declarations. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- `craft\\helpers\\Cp::elementHtml()` now has an `$autoReload` argument.\n- `craft\\helpers\\Db::batchInsert()`, `craft\\helpers\\Db::insert()`, `craft\\db\\Command::batchInsert()`, `craft\\db\\Command::insert()`, `craft\\db\\Migration::batchInsert()`, and `craft\\db\\Migration::insert()` no longer have `$includeAuditColumns` arguments, and now check if the table has `dateCreated`, `dateUpdated`, and/or `uid` columns before setting their values.\n- `craft\\helpers\\Db::parseParam()` now validates that numeric values are passed if the `$columnType` is set to a numeric column type. ([#9142](https://github.com/craftcms/cms/issues/9142))\n- `craft\\helpers\\Db::prepareDateForDb()` no longer has a `$stripSeconds` argument.\n- `craft\\helpers\\Db::prepareValueForDb()` now has a `$columnType` argument.\n- `craft\\helpers\\Db::truncateTable()` now returns `void` rather than `int`.\n- `craft\\helpers\\Db::update()`, `craft\\helpers\\Db::upsert()`, `craft\\db\\Command::update()`, `craft\\db\\Command::upsert()`, `craft\\db\\Migration::update()`\u2019 and `craft\\db\\Migration::upsert()`\u2019 `$includeAuditColumns` arguments have been renamed to `$updateTimestamp`, and only affect the `dateCreated` column now. All upserts now check if the table has `dateCreated`, `dateUpdated`, and/or `uid` columns before setting their values.\n- `craft\\helpers\\Db::upsert()`, `craft\\db\\Command::upsert()`, and `craft\\db\\Migration()` no longer merge the `$updateColumns` array into `$insertColumns`. The full array of `INSERT` column values should be passed to `$insertColumns` now.\n- `craft\\helpers\\Gql::getUnionType()` no longer requires a resolver function to be passed, if the union contains only element GraphQL types.\n- `craft\\helpers\\Html::beginForm()` not sets `accept-charset=\"UTF-8\"` by default.\n- `craft\\helpers\\Html` now supports defining `hx-*` and `data-hx-*` attributes via a `hx` and `data-hx` keys, similar to `aria` and `data`.\n- `craft\\helpers\\i18n\\Formatter::asPercent()` now chooses a default `$decimals` value based on the value given, if `null`.\n- `craft\\helpers\\i18n\\Formatter::asPercent()` now treats all empty values as `0`.\n- `craft\\helpers\\MailerHelper::normalizeEmails()` now returns an empty array instead of `null`.\n- `craft\\helpers\\MigrationHelper::dropAllIndexesOnTable()` no longer returns an array of the dropped indexes.\n- `craft\\helpers\\Queue::push()` now has a `$queue` argument.\n- `craft\\models\\FieldLayout::EVENT_DEFINE_STANDARD_FIELDS` has been renamed to `EVENT_DEFINE_NATIVE_FIELDS`.\n- `craft\\models\\FieldLayout::getAvailableStandardFields()` has been renamed to `getAvailableNativeFields()`.\n- `craft\\models\\FieldLayout::getFields()` has been renamed to `getCustomFields()`.\n- `craft\\queue\\Queue::$channel` is now set automatically based on the queue\u2019s application component ID.\n- `craft\\services\\Announcements::push()` no longer accepts callables to be passed to the `$heading` and `$body` arguments. `craft\\i18n\\Translation::prep()` should be used to prepare the messages to be lazy-translated instead.\n- `craft\\services\\AssetIndexer::storeIndexList()` now expects the first argument to be a generator that returns `craft\\models\\FsListing` objects.\n- `craft\\services\\Assets::ensureFolderByFullPathAndVolume()` now returns a `craft\\models\\VolumeFolder` object rather than a folder ID.\n- `craft\\services\\Assets::ensureTopFolder()` now returns a `craft\\models\\VolumeFolder` object rather than a folder ID.\n- `craft\\services\\Assets::EVENT_GET_ASSET_THUMB_URL` has been renamed to `EVENT_DEFINE_THUMB_URL`.\n- `craft\\services\\Assets::EVENT_GET_ASSET_URL` has been moved to `craft\\elements\\Asset::EVENT_DEFINE_URL`.\n- `craft\\services\\AssetTransforms::CONFIG_TRANSFORM_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_IMAGE_TRANSFORMS`.\n- `craft\\services\\Categories::CONFIG_CATEGORYROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_CATEGORY_GROUPS`.\n- `craft\\services\\Fields::CONFIG_FIELDGROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_FIELD_GROUPS`.\n- `craft\\services\\Fields::CONFIG_FIELDS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_FIELDS`.\n- `craft\\services\\Globals::CONFIG_GLOBALSETS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GLOBAL_SETS`.\n- `craft\\services\\Gql::CONFIG_GQL_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GRAPHQL`.\n- `craft\\services\\Gql::CONFIG_GQL_PUBLIC_TOKEN_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GRAPHQL_PUBLIC_TOKEN`.\n- `craft\\services\\Gql::CONFIG_GQL_SCHEMAS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_GRAPHQL_SCHEMAS`.\n- `craft\\services\\Matrix::CONFIG_BLOCKTYPE_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_MATRIX_BLOCK_TYPES`.\n- `craft\\services\\Matrix::duplicateBlocks()` now has a `$deleteOtherBlocks` argument.\n- `craft\\services\\Plugins::CONFIG_PLUGINS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_PLUGINS`.\n- `craft\\services\\Plugins::doesPluginRequireDatabaseUpdate()` has been renamed to `isPluginUpdatePending()`.\n- `craft\\services\\ProjectConfig::applyYamlChanges()` has been renamed to `applyExternalChanges()`.\n- `craft\\services\\ProjectConfig::getDoesYamlExist()` has been renamed to `getDoesExternalConfigExist()`.\n- `craft\\services\\ProjectConfig::getIsApplyingYamlChanges()` has been renamed to `getIsApplyingExternalChanges()`.\n- `craft\\services\\ProjectConfig::set()` now returns `true` or `false` depending on whether the project config was modified.\n- `craft\\services\\Revisions::createRevision()` now returns the ID of the revision, rather than the revision itself.\n- `craft\\services\\Routes::CONFIG_ROUTES_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_ROUTES`.\n- `craft\\services\\Sections::CONFIG_ENTRYTYPES_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_ENTRY_TYPES`.\n- `craft\\services\\Sections::CONFIG_SECTIONS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_PATH_SECTIONS`.\n- `craft\\services\\Sites::CONFIG_SITEGROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_SITE_GROUPS`.\n- `craft\\services\\Sites::CONFIG_SITES_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_SITES`.\n- `craft\\services\\Tags::CONFIG_TAGGROUP_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_TAG_GROUPS`.\n- `craft\\services\\Updates::getIsCraftDbMigrationNeeded()` has been renamed to `getIsCraftUpdatePending()`.\n- `craft\\services\\Updates::getIsPluginDbUpdateNeeded()` has been renamed to `getIsPluginUpdatePending()`.\n- `craft\\services\\UserGroups::CONFIG_USERPGROUPS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_USER_GROUPS`.\n- `craft\\services\\UserPermissions::getAllPermissions()` and `getAssignablePermissions()` now return permission groups as arrays with `heading` and `permission` sub-keys, fixing a bug where two groups with the same heading would conflict with each other. ([#7771](https://github.com/craftcms/cms/issues/7771))\n- `craft\\services\\Users::CONFIG_USERLAYOUT_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_USER_FIELD_LAYOUTS`.\n- `craft\\services\\Users::CONFIG_USERS_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_USERS`.\n- `craft\\services\\Volumes::CONFIG_VOLUME_KEY` has been moved to `craft\\services\\ProjectConfig::PATH_VOLUMES`.\n- `craft\\test\\fixtures\\elements\\BaseElementFixture` now validates elements with the `live` scenario if they are enabled, canonical, and not a provisional draft.\n- `craft\\test\\TestSetup::getMockApp()` has been renamed to `getMockModule()`, and its `$appClass` argument has been renamed to `$moduleClass`.\n- `craft\\web\\Request::getBodyParam()` now accepts nested param names in the `foo[bar][baz]` format.\n- `craft\\web\\Request::getBodyParams()` and `getBodyParam()` now check for an `X-Craft-Namespace` header. If present, only params that begin with its value will be returned, excluding the namespace.\n- `craft\\web\\View::renderString()` now has an `$escapeHtml` argument.\n- `craft\\web\\View::setNamespace()`\u2019 `$namespace` argument no longer has a default value of `null`.\n- The `Craft.getUrl()` JavaScript method now removes duplicate query string params when passing in a param that\u2019s already included in the base URL.\n- The `Craft.getUrl()` JavaScript method now encodes any query string params passed to it.\n- `Craft.broadcastChannel` has been split up into two broadcast channels: `Craft.broadcaster` and `Craft.messageReceiver`.\n- `Craft.cp.$tabs` now returns a collection of the tabs\u2019 `<a>` elements, as they no longer have wrapping `<li>` elements.\n- Local volumes no longer use Flysystem.\n- A selected volume for user photo storage if no longer displayed if no volume has been set.\n- The user photo volume can now only be set to a volume that has a public transform filesystem configured.\n- Craft now uses Symfony Mailer to send email. ([#10062](https://github.com/craftcms/cms/discussions/10062))\n- Updated Twig to 3.3.\n- Updated vue-autosuggest to 2.2.0.\n\n### Deprecated\n- Deprecated the `autosaveDrafts` config setting.\n- Deprecated the `anyStatus` element query param. `status(null)` should be used instead.\n- Deprecated the `immediately` argument for transforms created over GraphQL. It no longer has any effect.\n- Deprecated `craft\\base\\ApplicationTrait::getInstalledSchemaVersion()`.\n- Deprecated `craft\\base\\Model::datetimeAttributes()`. ([#10706](https://github.com/craftcms/cms/pull/10706))\n- Deprecated `craft\\elements\\User::getFullName()`. `$fullName` should be used instead.\n- Deprecated `craft\\gql\\TypeManager::flush()`. `craft\\services\\Gql::flushCaches()` should be used instead.\n- Deprecated `craft\\gql\\TypeManager::prepareFieldDefinitions()`. `craft\\services\\Gql::prepareFieldDefinitions()` should be used instead.\n- Deprecated `craft\\helpers\\ArrayHelper::append()`. `array_unshift()` should be used instead.\n- Deprecated `craft\\helpers\\ArrayHelper::prepend()`. `array_push()` should be used instead.\n- Deprecated `craft\\helpers\\MigrationHelper`.\n- Deprecated `craft\\i18n\\I18N::getIsIntlLoaded()`.\n- Deprecated `craft\\services\\Assets::getAssetUrl()`. `craft\\elements\\Asset::getUrl()` should be used instead.\n- Deprecated `craft\\services\\Assets::getIconPath()`. `craft\\helpers\\Assets::iconPath()` should be used instead.\n- Deprecated `craft\\web\\Controller::asErrorJson()`. `asFailure()` should be used instead.\n- Deprecated the `assets/save-asset` action. `elements/save` should be used instead.\n- Deprecated the `categories/save-category` action. `elements/save` should be used instead.\n- Deprecated the `Craft.appendFootHtml()` JavaScript method. `appendBodyHtml()` should be used instead.\n\n### Removed\n- Removed the \u201cHeader Column Heading\u201d element source setting.\n- Removed support for setting custom config settings from `config/general.php`. `config/custom.php` should be used instead. ([#10012](https://github.com/craftcms/cms/issues/10012))\n- Removed the `customAsciiCharMappings` config setting.\n- Removed the `siteName` config setting. Environment-specific site names can be defined via environment variables.\n- Removed the `siteUrl` config setting. Environment-specific site URLs can be defined via environment variables.\n- Removed the `suppressTemplateErrors` config setting.\n- Removed the `useCompressedJs` config setting.\n- Removed the `useProjectConfigFile` config setting. Override `craft\\services\\ProjectConfig::$writeYamlAutomatically` to opt into [manual YAML file generation](https://craftcms.com/docs/4.x/project-config.html#manual-yaml-file-generation).\n- Removed support for `config/volumes.php`. Volumes can now specify per-environment filesystems.\n- Removed support for the `CRAFT_SITE_URL` PHP constant. Environment-specific site URLs can be defined via environment variables.\n- Removed the `enabledForSite` GraphQL argument. `status` should be used instead.\n- Removed the `{% includeHiResCss %}` Twig tag.\n- Removed support for deprecated `DateTime` faux Twig methods `atom()`, `cookie()`, `iso8601()`, `rfc822()`, `rfc850()`, `rfc1036()`, `rfc1123()`, `rfc2822()`, `rfc3339()`, `rss()`, `w3c()`, `w3cDate()`, `mySqlDateTime()`, `localeDate()`, `localeTime()`, `year()`, `month()`, `day()`, `nice()`, and `uiTimestamp()`.\n- Removed the `locale` element property. `siteId` should be used instead.\n- Removed the `ownerLocale` Matrix block query param. `site` or `siteId` should be used instead.\n- Removed support for `sourceLocale` in `relatedTo` element query params. `sourceSite` should be used instead.\n- Removed the `craft.categoryGroups` Twig variable.\n- Removed the `craft.config` Twig variable.\n- Removed the `craft.deprecator` Twig variable.\n- Removed the `craft.elementIndexes` Twig variable.\n- Removed the `craft.emailMessages` Twig variable.\n- Removed the `craft.feeds` Twig variable.\n- Removed the `craft.fields` Twig variable.\n- Removed the `craft.globals` Twig variable.\n- Removed the `craft.i18n` Twig variable.\n- Removed the `craft.request` Twig variable.\n- Removed the `craft.sections` Twig variable.\n- Removed the `craft.session` Twig variable.\n- Removed the `craft.systemSettings` Twig variable.\n- Removed the `craft.userGroups` Twig variable.\n- Removed the `craft.userPermissions` Twig variable.\n- Removed the `assignUserGroups` user permission, which authorized users to assign other users to their own groups. Authorization must now be explicitly granted for each group. ([#10422](https://github.com/craftcms/cms/issues/10422))\n- Removed the `customizeSources` user permission. Only admins can customize element sources now, and only from an environment that allows admin changes.\n- Removed the `publishPeerEntryDrafts:<uid>` permissions, as they were pointless. (If a user is authorized to save an entry and view other users\u2019 drafts of it, there\u2019s nothing stopping them from making the same changes themselves.)\n- Removed the `assets/edit-asset` action.\n- Removed the `assets/thumb` action.\n- Removed the `categories/edit-category` action.\n- Removed the `categories/preview-category` action.\n- Removed the `categories/share-category` action.\n- Removed the `categories/view-shared-category` action.\n- Removed the `dashboard/get-feed-items` action.\n- Removed the `elements/get-editor-html` action.\n- Removed the `entries/switch-entry-type` action.\n- Removed `craft\\base\\ApplicationTrait::getEntryRevisions()`.\n- Removed `craft\\base\\ApplicationTrait::getFeed()`.\n- Removed `craft\\base\\Element::ATTR_STATUS_CONFLICTED`.\n- Removed `craft\\base\\Element::getHasFreshContent()`. `getIsFresh()` should be used instead.\n- Removed `craft\\base\\ElementInterface::getEditorHtml()`. Element edit forms are now exclusively driven by their field layout.\n- Removed `craft\\base\\FieldLayoutElementInterface`.\n- Removed `craft\\base\\FlysystemVolume`.\n- Removed `craft\\base\\LocalVolumeInterface`.\n- Removed `craft\\base\\Volume`.\n- Removed `craft\\base\\VolumeInterface`.\n- Removed `craft\\base\\VolumeTrait`.\n- Removed `craft\\behaviors\\FieldLayoutBehavior::setFields()`.\n- Removed `craft\\config\\DbConfig::updateDsn()`.\n- Removed `craft\\console\\Request::getIsSingleActionRequest()`.\n- Removed `craft\\controllers\\AssetTransformsController`.\n- Removed `craft\\controllers\\BaseUpdaterController::ACTION_COMPOSER_OPTIMIZE`.\n- Removed `craft\\controllers\\BaseUpdaterController::actionComposerOptimize()`.\n- Removed `craft\\controllers\\Drafts`.\n- Removed `craft\\controllers\\ElementIndexesController::$paginated`.\n- Removed `craft\\controllers\\EntriesController::EVENT_PREVIEW_ENTRY`.\n- Removed `craft\\controllers\\UtilitiesController::actionAssetIndexPerformAction()`.\n- Removed `craft\\db\\Connection::trimObjectName()`.\n- Removed `craft\\db\\Table::ASSETTRANSFORMINDEX`.\n- Removed `craft\\db\\Table::ASSETTRANSFORMS`.\n- Removed `craft\\elements\\actions\\SetStatus::$allowDisabledForSite`.\n- Removed `craft\\elements\\actions\\SetStatus::DISABLED_FOR_SITE`.\n- Removed `craft\\elements\\actions\\SetStatus::DISABLED_GLOBALLY`.\n- Removed `craft\\elements\\Asset::getSupportsPreview()`.\n- Removed `craft\\elements\\Asset::getTransformSource()`.\n- Removed `craft\\elements\\Asset::setTransformSource()`.\n- Removed `craft\\elements\\db\\ElementQuery::getIterator()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetExists()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetGet()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetSet()`.\n- Removed `craft\\elements\\db\\ElementQuery::offsetUnset()`.\n- Removed `craft\\elements\\User::mergePreferences()`.\n- Removed `craft\\errors\\AssetTransformException`.\n- Removed `craft\\errors\\FieldNotFoundException`.\n- Removed `craft\\errors\\InvalidVolumeException`.\n- Removed `craft\\errors\\MissingVolumeFolderException`.\n- Removed `craft\\errors\\VolumeException`.\n- Removed `craft\\errors\\VolumeObjectExistsException`.\n- Removed `craft\\errors\\VolumeObjectNotFoundException`.\n- Removed `craft\\events\\AssetTransformEvent`.\n- Removed `craft\\events\\AssetTransformImageEvent`.\n- Removed `craft\\events\\DefineComponentsEvent`.\n- Removed `craft\\events\\GenerateTransformEvent::$image`.\n- Removed `craft\\events\\GenerateTransformEvent::$tempPath`.\n- Removed `craft\\events\\GetAssetThumbEvent`.\n- Removed `craft\\events\\GetAssetThumbUrlEvent::$generate`.\n- Removed `craft\\events\\GetAssetThumbUrlEvent::$size`.\n- Removed `craft\\events\\GlobalSetContentEvent`.\n- Removed `craft\\events\\RegisterGqlPermissionsEvent`.\n- Removed `craft\\events\\SearchEvent::getElementIds()`.\n- Removed `craft\\events\\SearchEvent::setElementIds()`.\n- Removed `craft\\feeds\\Feeds`.\n- Removed `craft\\feeds\\GuzzleClient`.\n- Removed `craft\\fields\\BaseOptionsField::optionLabel()`.\n- Removed `craft\\fields\\Url::$placeholder`.\n- Removed `craft\\gql\\base\\Resolver::extractEagerLoadCondition()`.\n- Removed `craft\\gql\\base\\Resolver::getArrayableArguments()`.\n- Removed `craft\\gql\\base\\Resolver::prepareArguments()`.\n- Removed `craft\\helpers\\App::dbMutexConfig()`.\n- Removed `craft\\helpers\\App::getDefaultLogTargets()`.\n- Removed `craft\\helpers\\App::logConfig()`.\n- Removed `craft\\helpers\\Cp::editElementTitles()`.\n- Removed `craft\\helpers\\Localization::localeData()`.\n- Removed `craft\\helpers\\Stringy`.\n- Removed `craft\\i18n\\Locale::setDateTimeFormats()`.\n- Removed `craft\\log\\FileTarget`.\n- Removed `craft\\log\\StreamLogTarget`.\n- Removed `craft\\models\\AssetTransform`.\n- Removed `craft\\models\\AssetTransformIndex`.\n- Removed `craft\\models\\BaseEntryRevisionModel`.\n- Removed `craft\\models\\EntryDraft`.\n- Removed `craft\\models\\EntryVersion`.\n- Removed `craft\\models\\FieldLayout::setFields()`.\n- Removed `craft\\models\\FieldLayoutTab::getFields()`.\n- Removed `craft\\models\\Site::$originalBaseUrl`.\n- Removed `craft\\models\\Site::$originalName`.\n- Removed `craft\\models\\Site::overrideBaseUrl()`.\n- Removed `craft\\models\\Site::overrideName()`.\n- Removed `craft\\models\\VolumeListing`.\n- Removed `craft\\mutex\\DbMutexTrait`.\n- Removed `craft\\mutex\\FileMutex`.\n- Removed `craft\\mutex\\MysqlMutex`.\n- Removed `craft\\mutex\\PgsqlMutex`.\n- Removed `craft\\mutex\\PrefixedMutexTrait`.\n- Removed `craft\\queue\\jobs\\DeleteStaleTemplateCaches`.\n- Removed `craft\\records\\AssetTransform`.\n- Removed `craft\\records\\MatrixBlockType::$validateUniques`.\n- Removed `craft\\services\\AssetIndexer::deleteStaleIndexingData()`.\n- Removed `craft\\services\\AssetIndexer::extractFolderItemsFromIndexList()`.\n- Removed `craft\\services\\AssetIndexer::extractSkippedItemsFromIndexList()`.\n- Removed `craft\\services\\AssetIndexer::getIndexingSessionId()`.\n- Removed `craft\\services\\AssetIndexer::getMissingFiles()`.\n- Removed `craft\\services\\AssetIndexer::prepareIndexList()`.\n- Removed `craft\\services\\AssetIndexer::processIndexForVolume()`.\n- Removed `craft\\services\\Assets::$generatePendingTransformsViaQueue`.\n- Removed `craft\\services\\Assets::EVENT_GET_ASSET_THUMB_URL`.\n- Removed `craft\\services\\Assets::EVENT_GET_THUMB_PATH`.\n- Removed `craft\\services\\Assets::getThumbPath()`.\n- Removed `craft\\services\\AssetTransforms`.\n- Removed `craft\\services\\Composer::$disablePackagist`.\n- Removed `craft\\services\\Composer::optimize()`.\n- Removed `craft\\services\\Content::getContentRow()`.\n- Removed `craft\\services\\Content::populateElementContent()`.\n- Removed `craft\\services\\Drafts::EVENT_AFTER_MERGE_SOURCE_CHANGES`.\n- Removed `craft\\services\\Drafts::EVENT_AFTER_PUBLISH_DRAFT`.\n- Removed `craft\\services\\Drafts::EVENT_BEFORE_MERGE_SOURCE_CHANGES`.\n- Removed `craft\\services\\Drafts::EVENT_BEFORE_PUBLISH_DRAFT`.\n- Removed `craft\\services\\Drafts::publishDraft()`.\n- Removed `craft\\services\\EntryRevisions`.\n- Removed `craft\\services\\Fields::assembleLayout()`.\n- Removed `craft\\services\\Fields::getFieldIdsByLayoutId()`.\n- Removed `craft\\services\\Fields::getFieldsByElementType()`.\n- Removed `craft\\services\\Fields::getFieldsByLayoutId()`.\n- Removed `craft\\services\\Gql::getAllPermissions()`.\n- Removed `craft\\services\\Path::getAssetThumbsPath()`.\n- Removed `craft\\services\\ProjectConfig::CONFIG_ALL_KEY`.\n- Removed `craft\\services\\ProjectConfig::CONFIG_ALL_KEY`.\n- Removed `craft\\services\\ProjectConfig::CONFIG_KEY`.\n- Removed `craft\\services\\Sections::isSectionTemplateValid()`.\n- Removed `craft\\services\\SystemSettings`.\n- Removed `craft\\services\\TemplateCaches::deleteCacheById()`.\n- Removed `craft\\services\\TemplateCaches::deleteCachesByKey()`.\n- Removed `craft\\services\\TemplateCaches::deleteExpiredCaches()`.\n- Removed `craft\\services\\TemplateCaches::deleteExpiredCachesIfOverdue()`.\n- Removed `craft\\services\\TemplateCaches::EVENT_AFTER_DELETE_CACHES`.\n- Removed `craft\\services\\TemplateCaches::EVENT_BEFORE_DELETE_CACHES`.\n- Removed `craft\\services\\TemplateCaches::handleResponse()`.\n- Removed `craft\\services\\TemplateCaches::handleResponse()`.\n- Removed `craft\\services\\TemplateCaches::includeElementInTemplateCaches()`.\n- Removed `craft\\services\\TemplateCaches::includeElementQueryInTemplateCaches()`.\n- Removed `craft\\services\\Volumes::createVolume()`.\n- Removed `craft\\services\\Volumes::EVENT_REGISTER_VOLUME_TYPES`.\n- Removed `craft\\services\\Volumes::getAllVolumeTypes()`.\n- Removed `craft\\services\\Volumes::getVolumeOverrides()`.\n- Removed `craft\\volumes\\Local`.\n- Removed `craft\\volumes\\MissingVolume`.\n- Removed `craft\\volumes\\Temp`.\n- Removed `craft\\web\\AssetBundle::useCompressedJs()`.\n- Removed `craft\\web\\AssetManager::getPublishedPath()`.\n- Removed `craft\\web\\Request::getIsSingleActionRequest()`.\n- Removed `craft\\web\\twig\\Template`.\n- Removed `craft\\web\\twig\\variables\\CategoryGroups`.\n- Removed `craft\\web\\twig\\variables\\Config`.\n- Removed `craft\\web\\twig\\variables\\Deprecator`.\n- Removed `craft\\web\\twig\\variables\\ElementIndexes`.\n- Removed `craft\\web\\twig\\variables\\EmailMessages`.\n- Removed `craft\\web\\twig\\variables\\Feeds`.\n- Removed `craft\\web\\twig\\variables\\Fields`.\n- Removed `craft\\web\\twig\\variables\\Globals`.\n- Removed `craft\\web\\twig\\variables\\I18N`.\n- Removed `craft\\web\\twig\\variables\\Request`.\n- Removed `craft\\web\\twig\\variables\\Sections`.\n- Removed `craft\\web\\twig\\variables\\SystemSettings`.\n- Removed `craft\\web\\twig\\variables\\UserGroups`.\n- Removed `craft\\web\\twig\\variables\\UserPermissions`.\n- Removed `craft\\web\\twig\\variables\\UserSession`.\n- Removed `craft\\web\\User::destroyDebugPreferencesInSession()`.\n- Removed `craft\\web\\User::saveDebugPreferencesToSession()`.\n- Removed `craft\\web\\View::$minifyCss`.\n- Removed `craft\\web\\View::$minifyJs`.\n- Removed `craft\\web\\View::registerHiResCss()`.\n- Removed `craft\\web\\View::renderTemplateMacro()`.\n- Removed the `_layouts/element` control panel template.\n- Removed the `assets/_edit` control panel template.\n- Removed the `categories/_edit` control panel template.\n- Removed the `entries/_edit` control panel template.\n- Removed the `cp.assets.edit.content` control panel template hook.\n- Removed the `cp.assets.edit.details` control panel template hook.\n- Removed the `cp.assets.edit.meta` control panel template hook.\n- Removed the `cp.assets.edit.settings` control panel template hook.\n- Removed the `cp.assets.edit` control panel template hook.\n- Removed the `cp.categories.edit.content` control panel template hook.\n- Removed the `cp.categories.edit.details` control panel template hook.\n- Removed the `cp.categories.edit.meta` control panel template hook.\n- Removed the `cp.categories.edit.settings` control panel template hook.\n- Removed the `cp.categories.edit` control panel template hook.\n- Removed the `cp.elements.edit` control panel template hook.\n- Removed the `cp.entries.edit.content` control panel template hook.\n- Removed the `cp.entries.edit.details` control panel template hook.\n- Removed the `cp.entries.edit.meta` control panel template hook.\n- Removed the `cp.entries.edit.settings` control panel template hook.\n- Removed the `cp.entries.edit` control panel template hook.\n- Removed the `Craft.AssetEditor` JavaScript class.\n- Removed the `Craft.BaseElementEditor` JavaScript class.\n- Removed the `Craft.DraftEditor` JavaScript class.\n- Removed the `Craft.queueActionRequest()` JavaScript method. `Craft.queue.push()` can be used instead.\n- Removed the Flysystem package. The `craftcms/flysystem-adapter` package now provides a base Flysystem adapter class.\n- Removed the laminas-feed package.\n- Removed the yii2-swiftmailer package.\n\n### Fixed\n- Fixed a bug where pending project config changes in the YAML would get applied when other project config changes were made. ([#9660](https://github.com/craftcms/cms/issues/9660))\n- Fixed a bug where revisions weren\u2019t getting propagated when a section was enabled for new sites, or its Propagation Method was changed. ([#10634](https://github.com/craftcms/cms/issues/10634))\n\n### Security\n- Generated control panel URLs now begin with the `@web` alias value if the `baseCpUrl` config setting isn\u2019t defined.\n- HTML entities output within email body text are now escaped by default in HTML email bodies.\n", "<?php\n/**\n * @link https://craftcms.com/\n * @copyright Copyright (c) Pixel & Tonic, Inc.\n * @license https://craftcms.github.io/license/\n */\n\nnamespace craft\\controllers;\n\nuse Craft;\nuse craft\\base\\Element;\nuse craft\\base\\ElementInterface;\nuse craft\\base\\FieldLayoutComponent;\nuse craft\\behaviors\\DraftBehavior;\nuse craft\\behaviors\\RevisionBehavior;\nuse craft\\elements\\User;\nuse craft\\errors\\InvalidElementException;\nuse craft\\errors\\InvalidTypeException;\nuse craft\\errors\\UnsupportedSiteException;\nuse craft\\events\\DefineElementEditorHtmlEvent;\nuse craft\\helpers\\ArrayHelper;\nuse craft\\helpers\\Component;\nuse craft\\helpers\\Cp;\nuse craft\\helpers\\Db;\nuse craft\\helpers\\ElementHelper;\nuse craft\\helpers\\Html;\nuse craft\\helpers\\UrlHelper;\nuse craft\\models\\ElementActivity;\nuse craft\\models\\FieldLayoutForm;\nuse craft\\services\\Elements;\nuse craft\\web\\Controller;\nuse craft\\web\\CpScreenResponseBehavior;\nuse craft\\web\\View;\nuse Throwable;\nuse yii\\helpers\\Markdown;\nuse yii\\web\\BadRequestHttpException;\nuse yii\\web\\ForbiddenHttpException;\nuse yii\\web\\Response;\nuse yii\\web\\ServerErrorHttpException;\n\n/**\n * Elements controller.\n *\n * @author Pixel & Tonic, Inc. <support@pixelandtonic.com>\n * @since 3.0.0\n */\nclass ElementsController extends Controller\n{\n    /**\n     * @event DefineElementEditorHtmlEvent The event that is triggered when rendering an element editor\u2019s content.\n     * @see _editorContent()\n     */\n    public const EVENT_DEFINE_EDITOR_CONTENT = 'defineEditorContent';\n\n    /**\n     * @var ElementInterface|null The element currently being managed.\n     * @since 4.3.0\n     */\n    public ?ElementInterface $element = null;\n\n    private array $_attributes;\n    private ?string $_elementType = null;\n    private ?int $_elementId = null;\n    private ?string $_elementUid = null;\n    private ?int $_draftId = null;\n    private ?int $_revisionId = null;\n    private ?int $_siteId = null;\n\n    private ?bool $_enabled = null;\n    /**\n     * @var bool|bool[]|null\n     */\n    private array|bool|null $_enabledForSite = null;\n    private ?string $_slug = null;\n    private bool $_fresh;\n    private ?string $_draftName = null;\n    private ?string $_notes = null;\n    private string $_fieldsLocation;\n    private bool $_provisional;\n    private bool $_dropProvisional;\n    private bool $_addAnother;\n    private array $_visibleLayoutElements;\n    private ?string $_selectedTab = null;\n    private bool $_prevalidate;\n    private ?string $_context = null;\n    private ?string $_thumbSize = null;\n    private ?string $_viewMode = null;\n\n    /**\n     * @inheritdoc\n     */\n    public function beforeAction($action): bool\n    {\n        if (!parent::beforeAction($action)) {\n            return false;\n        }\n\n        $this->_attributes = $this->request->getBodyParams();\n\n        // No funny business\n        if (isset($this->_attributes['id']) || isset($this->_attributes['canonicalId'])) {\n            throw new BadRequestHttpException('Changing an element\u2019s ID is not allowed.');\n        }\n\n        $this->_elementType = $this->_param('elementType');\n        $this->_elementId = $this->_param('elementId');\n        $this->_elementUid = $this->_param('elementUid');\n        $this->_draftId = $this->_param('draftId');\n        $this->_revisionId = $this->_param('revisionId');\n        $this->_siteId = $this->_param('siteId');\n        $this->_enabled = $this->_param('enabled', true);\n        $this->_enabledForSite = $this->_param('enabledForSite');\n        $this->_slug = $this->_param('slug');\n        $this->_fresh = (bool)$this->_param('fresh');\n        $this->_draftName = $this->_param('draftName');\n        $this->_notes = $this->_param('notes');\n        $this->_fieldsLocation = $this->_param('fieldsLocation') ?? 'fields';\n        $this->_provisional = (bool)$this->_param('provisional');\n        $this->_dropProvisional = (bool)$this->_param('dropProvisional');\n        $this->_addAnother = (bool)$this->_param('addAnother');\n        $this->_visibleLayoutElements = $this->_param('visibleLayoutElements') ?? [];\n        $this->_selectedTab = $this->_param('selectedTab');\n        $this->_prevalidate = (bool)$this->_param('prevalidate');\n        $this->_context = $this->_param('context');\n        $this->_thumbSize = $this->_param('thumbSize');\n        $this->_viewMode = $this->_param('viewMode');\n\n        unset($this->_attributes['failMessage']);\n        unset($this->_attributes['redirect']);\n        unset($this->_attributes['successMessage']);\n        unset($this->_attributes[$this->_fieldsLocation]);\n\n        return true;\n    }\n\n    /**\n     * @param string $name\n     * @param mixed $default\n     * @return mixed\n     */\n    private function _param(string $name, mixed $default = null): mixed\n    {\n        $value = ArrayHelper::remove($this->_attributes, $name) ?? $this->request->getQueryParam($name);\n        if ($value === null && $default !== null && $this->request->getIsPost()) {\n            return $default;\n        }\n        return $value;\n    }\n\n    /**\n     * Redirects to an element\u2019s edit page.\n     *\n     * @param int|null $elementId\n     * @param string|null $elementUid\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionRedirect(?int $elementId = null, ?string $elementUid = null): Response\n    {\n        $element = $this->element = $this->_element($elementId, $elementUid);\n        $url = $element->getCpEditUrl();\n\n        if (!$url) {\n            throw new ServerErrorHttpException('The element doesn\u2019t have an edit page.');\n        }\n\n        return $this->redirect($url);\n    }\n\n    /**\n     * Creates a new element and redirects to its edit page.\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionCreate(): Response\n    {\n        if (!$this->_elementType) {\n            throw new BadRequestHttpException('Request missing required body param.');\n        }\n\n        $this->_validateElementType($this->_elementType);\n\n        /** @var ElementInterface $element */\n        $element = $this->element = Craft::createObject($this->_elementType);\n        if ($this->_siteId) {\n            $element->siteId = $this->_siteId;\n        }\n        $element->setAttributes($this->_attributes);\n\n        $user = static::currentUser();\n\n        if (!Craft::$app->getElements()->canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to create this element.');\n        }\n\n        if (!$element->slug) {\n            $element->slug = ElementHelper::tempSlug();\n        }\n\n        // Save it\n        $element->setScenario(Element::SCENARIO_ESSENTIALS);\n        if (!Craft::$app->getDrafts()->saveElementAsDraft($element, $user->id, null, null, false)) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t create {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        }\n\n        // Redirect to its edit page\n        $editUrl = $element->getCpEditUrl() ?? UrlHelper::actionUrl('elements/edit', [\n            'draftId' => $element->draftId,\n            'siteId' => $element->siteId,\n        ]);\n\n        $response = $this->_asSuccess(Craft::t('app', '{type} created.', [\n            'type' => Craft::t('app', 'Draft'),\n        ]), $element, array_filter([\n            'cpEditUrl' => $this->request->isCpRequest ? $editUrl : null,\n        ]));\n\n        if (!$this->request->getAcceptsJson()) {\n            $response->redirect(UrlHelper::urlWithParams($editUrl, [\n                'fresh' => '1',\n            ]));\n        }\n\n        return $response;\n    }\n\n    /**\n     * Returns an element edit screen.\n     *\n     * @param ElementInterface|null $element\n     * @param int|null $elementId\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionEdit(?ElementInterface $element, ?int $elementId = null): Response\n    {\n        $this->requireCpRequest();\n\n        $strictSite = $this->request->getAcceptsJson();\n\n        if ($element === null) {\n            /** @var Element|DraftBehavior|RevisionBehavior|Response|null $element */\n            $element = $this->_element($elementId, null, true, $strictSite);\n\n            if ($element instanceof Response) {\n                return $element;\n            }\n\n            if (!$element) {\n                throw new BadRequestHttpException('No element was identified by the request.');\n            }\n\n            // If this is an outdated draft, merge in the latest canonical changes\n            $mergeCanonicalChanges = (\n                $element::trackChanges() &&\n                $element->getIsDraft() &&\n                !$element->getIsUnpublishedDraft() &&\n                ElementHelper::isOutdated($element)\n            );\n            if ($mergeCanonicalChanges) {\n                Craft::$app->getElements()->mergeCanonicalChanges($element);\n            }\n\n            $this->_applyParamsToElement($element);\n\n            // Prevalidate?\n            if ($this->_prevalidate && $element->enabled && $element->getEnabledForSite()) {\n                $element->setScenario(Element::SCENARIO_LIVE);\n                $element->validate();\n            }\n        } else {\n            $mergeCanonicalChanges = false;\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        // Figure out what we're dealing with here\n        $isCanonical = $element->getIsCanonical();\n        $isDraft = $element->getIsDraft();\n        $isUnpublishedDraft = $element->getIsUnpublishedDraft();\n        $isRevision = $element->getIsRevision();\n        $isCurrent = $isCanonical || $element->isProvisionalDraft;\n        $canonical = $element->getCanonical(true);\n\n        // Site info\n        $supportedSites = ElementHelper::supportedSitesForElement($element, true);\n        $allEditableSiteIds = Craft::$app->getSites()->getEditableSiteIds();\n        $propSites = array_values(array_filter($supportedSites, fn($site) => $site['propagate']));\n        $propSiteIds = array_column($propSites, 'siteId');\n        $propEditableSiteIds = array_intersect($propSiteIds, $allEditableSiteIds);\n        $isMultiSiteElement = count($supportedSites) > 1;\n        $addlEditableSites = array_values(array_filter($supportedSites, fn($site) => !$site['propagate'] && in_array($site['siteId'], $allEditableSiteIds)));\n        $canEditMultipleSites = count($propEditableSiteIds) > 1 || $addlEditableSites;\n\n        // Is this a new site that isn\u2019t supported by the canonical element yet?\n        if ($isUnpublishedDraft) {\n            $isNewSite = true;\n        } elseif ($isDraft) {\n            $isNewSite = !$element::find()\n                ->id($element->getCanonicalId())\n                ->siteId($element->siteId)\n                ->status(null)\n                ->exists();\n        } else {\n            $isNewSite = false;\n        }\n\n        // Permissions\n        $canSave = $this->_canSave($element, $user);\n\n        if ($isUnpublishedDraft) {\n            $canSaveCanonical = $this->_canApplyUnpublishedDraft($element, $user);\n        } else {\n            $canSaveCanonical = ($isCanonical || $element->isProvisionalDraft) ? $canSave : $elementsService->canSave($canonical, $user);\n        }\n\n        $canCreateDrafts = $elementsService->canCreateDrafts($canonical, $user);\n        $canDeleteDraft = $isDraft && !$element->isProvisionalDraft && $elementsService->canDelete($element, $user);\n        $canDuplicateCanonical = $elementsService->canDuplicate($canonical, $user);\n        $canDeleteCanonical = $elementsService->canDelete($canonical, $user);\n        $canDeleteForSite = (\n            $isMultiSiteElement &&\n            count($propSiteIds) > 1 &&\n            (($isCurrent && $canDeleteCanonical) || ($canDeleteDraft && $isNewSite)) &&\n            $elementsService->canDeleteForSite($element, $user)\n        );\n\n        // Preview targets\n        $previewTargets = (\n            $element->id &&\n            (\n                ($isDraft && $canSave) ||\n                ($isCurrent && $canCreateDrafts)\n            )\n        ) ? $element->getPreviewTargets() : [];\n        $enablePreview = $previewTargets && !$this->request->isMobileBrowser(true);\n\n        if ($previewTargets) {\n            if ($isDraft && !$element->isProvisionalDraft) {\n                Craft::$app->getSession()->authorize(\"previewDraft:$element->draftId\");\n            } elseif ($isRevision) {\n                Craft::$app->getSession()->authorize(\"previewRevision:$element->revisionId\");\n            } else {\n                Craft::$app->getSession()->authorize(\"previewElement:$canonical->id\");\n            }\n        }\n\n        // Screen prep\n        [$docTitle, $title] = $this->_editElementTitles($element);\n        $type = $element::lowerDisplayName();\n        $enabledForSite = $element->getEnabledForSite();\n        $hasRoute = $element->getRoute() !== null;\n        $redirectUrl = $element->getPostEditUrl() ?? Craft::$app->getConfig()->getGeneral()->getPostCpLoginRedirect();\n\n        // Site statuses\n        if ($canEditMultipleSites) {\n            $siteStatuses = ElementHelper::siteStatusesForElement($element, true);\n        } else {\n            $siteStatuses = [\n                $element->siteId => $element->enabled,\n            ];\n        }\n\n        $security = Craft::$app->getSecurity();\n        $notice = null;\n        if ($element->isProvisionalDraft) {\n            $notice = fn() => $this->_draftNotice();\n        } elseif ($element->getIsRevision()) {\n            $notice = fn() => $this->_revisionNotice($element::lowerDisplayName());\n        }\n\n        $response = $this->asCpScreen()\n            ->editUrl($element->getCpEditUrl())\n            ->docTitle($docTitle)\n            ->title($title)\n            ->contextMenu(fn() => $this->_contextMenu(\n                $element,\n                $isMultiSiteElement,\n                $isUnpublishedDraft,\n                $canCreateDrafts,\n                $propSiteIds,\n                $elementsService,\n                $user,\n            ))\n            ->additionalButtons(fn() => $this->_additionalButtons(\n                $element,\n                $canonical,\n                $isRevision,\n                $canSave,\n                $canSaveCanonical,\n                $canCreateDrafts,\n                $previewTargets,\n                $enablePreview,\n                $isCurrent,\n                $isUnpublishedDraft,\n                $isDraft\n            ))\n            ->notice($notice)\n            ->errorSummary(fn() => $this->_errorSummary($element))\n            ->prepareScreen(\n                fn(Response $response, string $containerId) => $this->_prepareEditor(\n                    $element,\n                    $isUnpublishedDraft,\n                    $canSave,\n                    $response,\n                    $containerId,\n                    fn(?FieldLayoutForm $form) => $this->_editorContent($element, $canSave, $form),\n                    fn(?FieldLayoutForm $form) => $this->_editorSidebar($element, $mergeCanonicalChanges, $canSave),\n                    fn(?FieldLayoutForm $form) => [\n                        'additionalSites' => $addlEditableSites,\n                        'canCreateDrafts' => $canCreateDrafts,\n                        'canEditMultipleSites' => $canEditMultipleSites,\n                        'canSaveCanonical' => $canSaveCanonical,\n                        'elementId' => $element->id,\n                        'canonicalId' => $canonical->id,\n                        'draftId' => $element->draftId,\n                        'draftName' => $isDraft ? $element->draftName : null,\n                        'elementType' => get_class($element),\n                        'enablePreview' => $enablePreview,\n                        'enabledForSite' => $element->enabled && $enabledForSite,\n                        'hashedCpEditUrl' => $security->hashData('{cpEditUrl}'),\n                        'isLive' => $isCurrent && !$element->getIsDraft() && $element->enabled && $enabledForSite && $hasRoute,\n                        'isProvisionalDraft' => $element->isProvisionalDraft,\n                        'isUnpublishedDraft' => $isUnpublishedDraft,\n                        'previewTargets' => $previewTargets,\n                        'previewToken' => $previewTargets ? $security->generateRandomString() : null,\n                        'revisionId' => $element->revisionId,\n                        'siteId' => $element->siteId,\n                        'siteStatuses' => $siteStatuses,\n                        'siteToken' => (!Craft::$app->getIsLive() || !$element->getSite()->enabled) ? $security->hashData((string)$element->siteId) : null,\n                        'visibleLayoutElements' => $form ? $form->getVisibleElements() : [],\n                        'updatedTimestamp' => $element->dateUpdated->getTimestamp(),\n                        'canonicalUpdatedTimestamp' => $canonical->dateUpdated->getTimestamp(),\n                    ]\n                )\n            );\n\n        if ($canSave) {\n            if ($isUnpublishedDraft) {\n                if ($canSaveCanonical) {\n                    $response\n                        ->submitButtonLabel(Craft::t('app', 'Create {type}', [\n                            'type' => $element::lowerDisplayName(),\n                        ]))\n                        ->action('elements/apply-draft')\n                        ->redirectUrl(\"$redirectUrl#\");\n                } else {\n                    $response\n                        ->action('elements/save-draft')\n                        ->redirectUrl(\"$redirectUrl#\");\n                }\n            } elseif ($element->isProvisionalDraft) {\n                $response\n                    ->action('elements/apply-draft')\n                    ->redirectUrl(\"$redirectUrl#\");\n            } elseif ($isDraft) {\n                $response\n                    ->submitButtonLabel(Craft::t('app', 'Save {type}', [\n                        'type' => Craft::t('app', 'draft'),\n                    ]))\n                    ->action('elements/save-draft')\n                    ->redirectUrl(\"{cpEditUrl}\");\n            } else {\n                $response\n                    ->action('elements/save')\n                    ->redirectUrl(\"$redirectUrl#\");\n            }\n\n            $response\n                ->saveShortcutRedirectUrl('{cpEditUrl}')\n                ->addAltAction(\n                    $isUnpublishedDraft && $canSaveCanonical\n                        ? Craft::t('app', 'Create and continue editing')\n                        : Craft::t('app', 'Save and continue editing'),\n                    [\n                        'redirect' => '{cpEditUrl}',\n                        'shortcut' => true,\n                        'retainScroll' => true,\n                        'eventData' => ['autosave' => false],\n                    ]\n                );\n\n            if ($isCurrent) {\n                $newElement = $element->createAnother();\n                if ($newElement && $elementsService->canSave($newElement, $user)) {\n                    $response->addAltAction(\n                        $isUnpublishedDraft && $canSaveCanonical\n                            ? Craft::t('app', 'Create and add another')\n                            : Craft::t('app', 'Save and add another'),\n                        [\n                            'shortcut' => true,\n                            'shift' => true,\n                            'eventData' => ['autosave' => false],\n                            'params' => ['addAnother' => 1],\n                        ]\n                    );\n                }\n\n                if ($canSaveCanonical) {\n                    if ($isUnpublishedDraft) {\n                        $response->addAltAction(Craft::t('app', 'Save {type}', [\n                            'type' => Craft::t('app', 'draft'),\n                        ]), [\n                            'action' => 'elements/save-draft',\n                            'redirect' => \"$redirectUrl#\",\n                            'eventData' => ['autosave' => false],\n                        ]);\n                    } elseif ($canDuplicateCanonical) {\n                        $response->addAltAction(Craft::t('app', 'Save as a new {type}', compact('type')), [\n                            'action' => 'elements/duplicate', // todo\n                            'redirect' => '{cpEditUrl}',\n                        ]);\n                    }\n                }\n\n                if ($canDeleteForSite) {\n                    $response->addAltAction(Craft::t('app', 'Delete {type} for this site', [\n                        'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                    ]), [\n                        'destructive' => true,\n                        'action' => 'elements/delete-for-site',\n                        'redirect' => \"$redirectUrl#\",\n                        'confirm' => Craft::t('app', 'Are you sure you want to delete the {type} for this site?', [\n                            'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                        ]),\n                    ]);\n                }\n\n                if ($canDeleteCanonical) {\n                    $response->addAltAction(Craft::t('app', 'Delete {type}', [\n                        'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                    ]), [\n                        'destructive' => true,\n                        'action' => $isUnpublishedDraft ? 'elements/delete-draft' : 'elements/delete',\n                        'redirect' => \"$redirectUrl#\",\n                        'confirm' => Craft::t('app', 'Are you sure you want to delete this {type}?', [\n                            'type' => $isUnpublishedDraft ? Craft::t('app', 'draft') : $type,\n                        ]),\n                    ]);\n                }\n            } elseif ($isDraft && $canDeleteDraft) {\n                if ($canDeleteForSite) {\n                    $response->addAltAction(Craft::t('app', 'Delete {type} for this site', [\n                        'type' => Craft::t('app', 'draft'),\n                    ]), [\n                        'destructive' => true,\n                        'action' => 'elements/delete-for-site',\n                        'redirect' => \"$redirectUrl#\",\n                        'confirm' => Craft::t('app', 'Are you sure you want to delete the {type} for this site?', compact('type')),\n                    ]);\n                }\n\n                $response->addAltAction(Craft::t('app', 'Delete {type}', [\n                    'type' => Craft::t('app', 'draft'),\n                ]), [\n                    'destructive' => true,\n                    'action' => 'elements/delete-draft',\n                    'redirect' => $canonical->getCpEditUrl(),\n                    'confirm' => Craft::t('app', 'Are you sure you want to delete this {type}?', [\n                        'type' => Craft::t('app', 'draft'),\n                    ]),\n                ]);\n            }\n        }\n\n        return $response;\n    }\n\n    /**\n     * Returns an element revisions index screen.\n     *\n     * @param int $elementId\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.4.0\n     */\n    public function actionRevisions(int $elementId): Response\n    {\n        $this->requireCpRequest();\n\n        /** @var Element|DraftBehavior|RevisionBehavior|Response|null $element */\n        $element = $this->_element($elementId, null, false);\n\n        if (!$element) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        if ($element->getIsUnpublishedDraft()) {\n            throw new BadRequestHttpException('Unpublished drafts don\\'t have revisions');\n        }\n\n        if (!$element->hasRevisions()) {\n            throw new BadRequestHttpException('Element doesn\\'t have revisions');\n        }\n\n        return $this->asCpScreen()\n            ->title(Craft::t('app', 'Revisions for \u201c{title}\u201d', [\n                'title' => $element->getUiLabel(),\n            ]))\n            ->prepareScreen(function(Response $response, string $containerId) use ($element) {\n                // Give the element a chance to do things here too\n                $element->prepareEditScreen($response, $containerId);\n\n                /** @var CpScreenResponseBehavior $behavior */\n                $behavior = $response->getBehavior(CpScreenResponseBehavior::NAME);\n                if (!empty($behavior->crumbs)) {\n                    $behavior->crumbs[] = [\n                        'label' => $element->getUiLabel(),\n                        'url' => $element->getCpEditUrl(),\n                    ];\n                }\n            })\n        ->contentTemplate('_elements/revisions', [\n            'element' => $element,\n            'revisionsQuery' => $element::find()\n                ->revisionOf($element)\n                ->site('*')\n                ->preferSites([$element->siteId])\n                ->unique()\n                ->status(null)\n                ->andWhere(['!=', 'elements.dateCreated', Db::prepareDateForDb($element->dateUpdated)])\n                ->with(['revisionCreator']),\n        ]);\n    }\n\n    /**\n     * Returns the page title and document title that should be used for Edit Element pages.\n     *\n     * @param ElementInterface $element\n     * @return string[]\n     * @since 3.7.0\n     */\n    private function _editElementTitles(ElementInterface $element): array\n    {\n        $title = trim((string)$element->title);\n\n        if ($title === '') {\n            if (!$element->id || $element->getIsUnpublishedDraft()) {\n                $title = Craft::t('app', 'Create a new {type}', [\n                    'type' => $element::lowerDisplayName(),\n                ]);\n            } else {\n                $title = Craft::t('app', 'Edit {type}', [\n                    'type' => $element::displayName(),\n                ]);\n            }\n        }\n\n        $docTitle = $title;\n\n        if ($element->getIsDraft()) {\n            /** @var ElementInterface|DraftBehavior $element */\n            if ($element->isProvisionalDraft) {\n                $docTitle .= ' \u2014 ' . Craft::t('app', 'Edited');\n            } else {\n                $docTitle .= \" ($element->draftName)\";\n            }\n        } elseif ($element->getIsRevision()) {\n            /** @var ElementInterface|RevisionBehavior $element */\n            $docTitle .= ' (' . $element->getRevisionLabel() . ')';\n        }\n\n        return [$docTitle, $title];\n    }\n\n    private function _contextMenu(\n        ElementInterface $element,\n        bool $isMultiSiteElement,\n        bool $isUnpublishedDraft,\n        bool $canCreateDrafts,\n        array $propSiteIds,\n        Elements $elementsService,\n        User $user,\n    ): ?string {\n        if ($isUnpublishedDraft || !$element->id) {\n            $drafts = [];\n            $showDrafts = false;\n            $revisions = [];\n            $revisionsPageUrl = null;\n            $hasMoreRevisions = false;\n        } else {\n            $drafts = $element::find()\n                ->draftOf($element)\n                ->siteId($element->siteId)\n                ->status(null)\n                ->orderBy(['dateUpdated' => SORT_DESC])\n                ->with(['draftCreator'])\n                ->collect()\n                ->filter(fn(ElementInterface $draft) => $elementsService->canView($draft, $user))\n                ->all();\n            $showDrafts = !empty($drafts) || $canCreateDrafts;\n\n            $generalConfig = Craft::$app->getConfig()->getGeneral();\n            if ($element->hasRevisions() && (!$generalConfig->maxRevisions || $generalConfig->maxRevisions > 1)) {\n                $revisionQuery = $element::find()\n                    ->revisionOf($element)\n                    ->siteId($element->siteId)\n                    ->status(null)\n                    ->offset(1)\n                    ->limit($generalConfig->maxRevisions ? min($generalConfig->maxRevisions - 1, 10) : 10)\n                    ->orderBy(['dateCreated' => SORT_DESC])\n                    ->with(['revisionCreator']);\n                $revisions = $revisionQuery->all();\n                $revisionsPageUrl = $element->getCpRevisionsUrl();\n                if ($revisionsPageUrl) {\n                    $hasMoreRevisions = (\n                        count($revisions) === $revisionQuery->limit &&\n                        $revisionQuery->limit < ($generalConfig->maxRevisions - 1) &&\n                        ($revisionQuery->count() - 1) > $revisionQuery->limit\n                    );\n                } else {\n                    $hasMoreRevisions = false;\n                }\n            } else {\n                $revisions = [];\n                $revisionsPageUrl = null;\n                $hasMoreRevisions = false;\n            }\n        }\n\n        if (\n            $isMultiSiteElement ||\n            $showDrafts ||\n            !empty($revisions)\n        ) {\n            return Craft::$app->getView()->renderTemplate('_includes/revisionmenu.twig', [\n                'element' => $element,\n                'drafts' => $drafts,\n                'showDrafts' => $showDrafts,\n                'revisions' => $revisions,\n                'revisionsPageUrl' => $revisionsPageUrl,\n                'hasMoreRevisions' => $hasMoreRevisions,\n                'supportedSiteIds' => $propSiteIds,\n                'showSiteLabel' => $isMultiSiteElement,\n            ], View::TEMPLATE_MODE_CP);\n        }\n\n        return null;\n    }\n\n    private function _additionalButtons(\n        ElementInterface $element,\n        ElementInterface $canonical,\n        bool $isRevision,\n        bool $canSave,\n        bool $canSaveCanonical,\n        bool $canCreateDrafts,\n        ?array $previewTargets,\n        bool $enablePreview,\n        bool $isCurrent,\n        bool $isUnpublishedDraft,\n        bool $isDraft,\n    ): string {\n        $components = [\n            Html::tag('div', options: [\n                'class' => ['activity-container'],\n            ]),\n        ];\n\n        // Preview (View will be added later by JS)\n        if ($canSave && $previewTargets) {\n            $components[] =\n                Html::beginTag('div', [\n                    'class' => ['preview-btn-container', 'btngroup'],\n                ]) .\n                ($enablePreview\n                    ? Html::beginTag('button', [\n                        'type' => 'button',\n                        'class' => ['preview-btn', 'btn'],\n                        'aria' => [\n                            'label' => Craft::t('app', 'Preview'),\n                        ],\n                    ]) .\n                    Html::tag('span', Craft::t('app', 'Preview'), ['class' => 'label']) .\n                    Html::tag('span', options: ['class' => ['spinner', 'spinner-absolute']]) .\n                    Html::endTag('button')\n                    : '') .\n                Html::endTag('div');\n        }\n\n        // Create a draft\n        if ($isCurrent && !$isUnpublishedDraft && $canCreateDrafts) {\n            if ($canSave) {\n                $components[] = Html::button(Craft::t('app', 'Create a draft'), [\n                    'class' => ['btn', 'formsubmit'],\n                    'data' => [\n                        'action' => 'elements/save-draft',\n                        'redirect' => Craft::$app->getSecurity()->hashData('{cpEditUrl}'),\n                        'params' => ['dropProvisional' => 1],\n                    ],\n                ]);\n            } else {\n                $components[] = Html::beginForm() .\n                    Html::actionInput('elements/save-draft') .\n                    Html::redirectInput('{cpEditUrl}') .\n                    Html::hiddenInput('elementId', (string)$canonical->id) .\n                    Html::beginTag('div', ['class' => 'secondary-buttons']) .\n                    Html::button(Craft::t('app', 'Create a draft'), [\n                        'class' => ['btn', 'secondary', 'formsubmit'],\n                    ]) .\n                    Html::endTag('div') .\n                    Html::endForm();\n            }\n        }\n\n        // Apply draft\n        if ($isDraft && !$isCurrent && $canSave && $canSaveCanonical) {\n            $components[] = Html::button(Craft::t('app', 'Apply draft'), [\n                'class' => ['btn', 'secondary', 'formsubmit'],\n                'data' => [\n                    'action' => 'elements/apply-draft',\n                    'redirect' => Craft::$app->getSecurity()->hashData('{cpEditUrl}'),\n                ],\n            ]);\n        }\n\n        // Revert content from this revision\n        if ($isRevision && $canSaveCanonical) {\n            $components[] = Html::beginForm() .\n                Html::actionInput('elements/revert') .\n                Html::redirectInput('{cpEditUrl}') .\n                Html::hiddenInput('elementId', (string)$canonical->id) .\n                Html::hiddenInput('revisionId', (string)$element->revisionId) .\n                Html::beginTag('div', ['class' => 'secondary-buttons']) .\n                Html::button(Craft::t('app', 'Revert content from this revision'), [\n                    'class' => ['btn', 'secondary', 'formsubmit'],\n                ]) .\n                Html::endTag('div') .\n                Html::endForm();\n        }\n\n        $components[] = $element->getAdditionalButtons();\n\n        return implode(\"\\n\", array_filter($components));\n    }\n\n    private function _prepareEditor(\n        ElementInterface $element,\n        bool $isUnpublishedDraft,\n        bool $canSave,\n        Response $response,\n        string $containerId,\n        callable $contentFn,\n        callable $sidebarFn,\n        callable $jsSettingsFn,\n    ) {\n        $fieldLayout = $element->getFieldLayout();\n        $form = $fieldLayout?->createForm($element, !$canSave, [\n            'registerDeltas' => true,\n        ]);\n        $contentHtml = $contentFn($form);\n        $sidebarHtml = $sidebarFn($form);\n\n        if ($contentHtml === '' && $sidebarHtml !== '' && $this->request->getAcceptsJson()) {\n            $contentHtml = Html::tag('div', $sidebarHtml, [\n                'class' => 'details',\n            ]);\n            $sidebarHtml = '';\n            /** @var Response|CpScreenResponseBehavior $response */\n            $response->slideoutBodyClass = 'so-full-details';\n        }\n\n        if ($canSave) {\n            $components = [];\n\n            if ($element->id) {\n                $components[] = Html::hiddenInput('elementId', (string)$element->getCanonicalId());\n            }\n\n            if ($element->siteId) {\n                $components[] = Html::hiddenInput('siteId', (string)$element->siteId);\n            }\n\n            if ($element->fieldLayoutId) {\n                $components[] = Html::hiddenInput('fieldLayoutId', (string)$element->fieldLayoutId);\n            }\n\n            if ($isUnpublishedDraft && $this->_fresh) {\n                $components[] = Html::hiddenInput('fresh', '1');\n            }\n\n            $components[] = $contentHtml;\n            $contentHtml = implode(\"\\n\", $components);\n        }\n\n        /** @var Response|CpScreenResponseBehavior $response */\n        $response\n            ->tabs($form?->getTabMenu() ?? [])\n            ->content($contentHtml)\n            ->sidebar($sidebarHtml);\n\n        if ($canSave && !$element->getIsRevision()) {\n            $this->view->registerJsWithVars(fn($settingsJs) => <<<JS\nnew Craft.ElementEditor($('#$containerId'), $settingsJs);\nJS, [\n                $jsSettingsFn($form),\n            ]);\n        }\n\n        // Give the element a chance to do things here too\n        $element->prepareEditScreen($response, $containerId);\n    }\n\n    private function _editorContent(\n        ElementInterface $element,\n        bool $canSave,\n        ?FieldLayoutForm $form,\n    ): string {\n        $html = $form?->render() ?? '';\n\n        // Trigger a defineEditorContent event\n        if ($this->hasEventHandlers(self::EVENT_DEFINE_EDITOR_CONTENT)) {\n            $event = new DefineElementEditorHtmlEvent([\n                'element' => $element,\n                'html' => $html,\n                'static' => !$canSave,\n            ]);\n            $this->trigger(self::EVENT_DEFINE_EDITOR_CONTENT, $event);\n            $html = $event->html;\n        }\n\n        return trim($html);\n    }\n\n    /**\n     * Return html for errors summary box\n     *\n     * @param ElementInterface $element\n     * @return string\n     */\n    private function _errorSummary(ElementInterface $element): string\n    {\n        $html = '';\n\n        if ($element->hasErrors()) {\n            $allErrors = $element->getErrors();\n            $allKeys = array_keys($allErrors);\n\n            // only show \"top-level\" errors\n            // if you e.g. have an assets field which is set to validate related assets,\n            // you should only see the top-level \"Fix validation errors on the related asset\" error\n            // and not the details of what's wrong with the selected asset;\n            foreach ($allKeys as $key) {\n                $lastNestedKey = substr_replace($key, '', strrpos($key, '.'));\n                $lastNestedKey = substr_replace($lastNestedKey, '', strrpos($lastNestedKey, '['));\n                if (!empty($lastNestedKey)) {\n                    if (in_array($lastNestedKey, $allKeys)) {\n                        unset($allErrors[$key]);\n                    }\n                }\n            }\n            $errorsList = [];\n            foreach ($allErrors as $key => $errors) {\n                foreach ($errors as $error) {\n                    $errorItem = Html::beginTag('li');\n\n                    // this is true in case of e.g. cross site validation error\n                    if (preg_match('/^\\s?\\<a /', $error)) {\n                        $errorItem .= $error;\n                    } else {\n                        $error = Markdown::processParagraph(htmlspecialchars($error));\n                        $errorItem .= Html::a(Craft::t('app', $error), '#', [\n                            'data' => [\n                                'field-error-key' => $key,\n                            ],\n                        ]);\n                    }\n\n                    $errorItem .= Html::endTag('li');\n\n                    $errorsList[] = $errorItem;\n                }\n            }\n\n            if (!empty($errorsList)) {\n                $heading = Craft::t('app', 'Found {num, number} {num, plural, =1{error} other{errors}}', [\n                    'num' => count($errorsList),\n                ]);\n\n                $html = Html::beginTag('div', [\n                        'class' => ['error-summary'],\n                        'tabindex' => '-1',\n                    ]) .\n                    Html::beginTag('div') .\n                    Html::tag('span', '', [\n                        'class' => 'notification-icon',\n                        'data-icon' => 'alert',\n                        'aria-label' => 'error',\n                        'role' => 'img',\n                    ]) .\n                    Html::tag('h2', $heading) .\n                    Html::endTag('div') .\n                    Html::beginTag('ul', [\n                        'class' => ['errors'],\n                    ]) .\n                    implode('', $errorsList) .\n                    Html::endTag('ul') .\n                    Html::endTag('div');\n            }\n        }\n\n        return $html;\n    }\n\n    private function _editorSidebar(\n        ElementInterface $element,\n        bool $mergedCanonicalChanges,\n        bool $canSave,\n    ): string {\n        $components = [];\n\n        if ($mergedCanonicalChanges) {\n            $components[] =\n                Html::beginTag('div', [\n                    'class' => ['meta', 'warning'],\n                ]) .\n                Html::tag('p', Craft::t('app', 'Recent changes to the Current revision have been merged into this draft.')) .\n                Html::endTag('div');\n        }\n\n        /** @var ElementInterface|DraftBehavior|RevisionBehavior $element */\n        $components[] = $element->getSidebarHtml(!$canSave);\n\n        if ($this->id) {\n            $components[] = Cp::metadataHtml($element->getMetadata());\n        }\n\n        return trim(implode(\"\\n\", $components));\n    }\n\n    private function _draftNotice(): string\n    {\n        return\n            Html::beginTag('div', [\n                'class' => 'draft-notice',\n            ]) .\n            Html::tag('div', '', [\n                'class' => ['draft-icon'],\n                'aria' => ['hidden' => 'true'],\n                'data' => ['icon' => 'edit'],\n            ]) .\n            Html::tag('p', Craft::t('app', 'Showing your unsaved changes.')) .\n            Html::button(Craft::t('app', 'Discard'), [\n                'class' => ['discard-changes-btn', 'btn'],\n            ]) .\n            Html::endTag('div');\n    }\n\n    private function _revisionNotice($elementType): string\n    {\n        return\n            Html::beginTag('div', [\n                'class' => 'revision-notice',\n            ]) .\n            Html::tag('div', '', [\n                'class' => ['revision-icon'],\n                'aria' => ['hidden' => 'true'],\n                'data' => ['icon' => 'lightbulb'],\n            ]) .\n            Html::tag('p', Craft::t(\n                'app',\n                'You\u2019re viewing a revision. None of the {type}\u2019s fields are editable.',\n                [\n                    'type' => $elementType,\n                ]\n            )) .\n            Html::endTag('div');\n    }\n\n    /**\n     * Saves an element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionSave(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|null $element */\n        $element = $this->_element();\n\n        if (!$element || $element->getIsDraft() || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        // Check save permissions before and after applying POST params to the element\n        // in case the request was tampered with.\n        if (!$elementsService->canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        $this->_applyParamsToElement($element);\n\n        if (!$elementsService->canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        if ($element->enabled && $element->getEnabledForSite()) {\n            $element->setScenario(Element::SCENARIO_LIVE);\n        }\n\n        $isNotNew = $element->id;\n        if ($isNotNew) {\n            $lockKey = \"element:$element->id\";\n            $mutex = Craft::$app->getMutex();\n            if (!$mutex->acquire($lockKey, 15)) {\n                throw new ServerErrorHttpException('Could not acquire a lock to save the element.');\n            }\n        }\n\n        try {\n            $namespace = $this->request->getHeaders()->get('X-Craft-Namespace');\n            // crossSiteValidate only if it's multisite, element supports drafts and we're not in a slideout\n            $success = $elementsService->saveElement(\n                $element,\n                crossSiteValidate: ($namespace === null && Craft::$app->getIsMultiSite() && $elementsService->canCreateDrafts($element, $user)),\n            );\n        } catch (UnsupportedSiteException $e) {\n            $element->addError('siteId', $e->getMessage());\n            $success = false;\n        } finally {\n            if ($isNotNew) {\n                $mutex->release($lockKey);\n            }\n        }\n\n        if (!$success) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t save {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        }\n\n        $elementsService->trackActivity($element, ElementActivity::TYPE_SAVE);\n\n        // See if the user happens to have a provisional element. If so delete it.\n        $provisional = $element::find()\n            ->provisionalDrafts()\n            ->draftOf($element->id)\n            ->draftCreator($user)\n            ->siteId($element->siteId)\n            ->status(null)\n            ->one();\n\n        if ($provisional) {\n            $elementsService->deleteElement($provisional, true);\n        }\n\n        if (!$this->request->getAcceptsJson()) {\n            // Tell all browser windows about the element save\n            Craft::$app->getSession()->broadcastToJs([\n                'event' => 'saveElement',\n                'id' => $element->id,\n            ]);\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} saved.', [\n            'type' => $element::displayName(),\n        ]), $element, addAnother: true);\n    }\n\n    /**\n     * Duplicates an element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionDuplicate(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (\n            !$element ||\n            ($element->getIsDraft() && !$element->isProvisionalDraft && !$element->getIsUnpublishedDraft()) ||\n            $element->getIsRevision()\n        ) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n\n        if (!$elementsService->canDuplicate($element)) {\n            throw new ForbiddenHttpException('User not authorized to duplicate this element.');\n        }\n\n        try {\n            $newElement = $elementsService->duplicateElement($element, [\n                'isProvisionalDraft' => false,\n            ]);\n        } catch (InvalidElementException $e) {\n            return $this->_asFailure($e->element, Craft::t('app', 'Couldn\u2019t duplicate {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        } catch (Throwable $e) {\n            throw new ServerErrorHttpException('An error occurred when duplicating the element.', 0, $e);\n        }\n\n        // If the original element is a provisional draft,\n        // delete the draft as the changes are likely no longer wanted.\n        if ($element->isProvisionalDraft) {\n            Craft::$app->getElements()->deleteElement($element);\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} duplicated.', [\n            'type' => $element::displayName(),\n        ]), $newElement);\n    }\n\n    /**\n     * Deletes an element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionDelete(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|null $element */\n        $element = $this->_element();\n\n        // If this is a provisional draft, delete the canonical\n        if ($element && $element->isProvisionalDraft) {\n            $element = $element->getCanonical(true);\n        }\n\n        if (!$element || $element->getIsDraft() || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if (!$elementsService->canDelete($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to delete this element.');\n        }\n\n        if (!$elementsService->deleteElement($element)) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t delete {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]));\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} deleted.', [\n            'type' => $element::displayName(),\n        ]), $element);\n    }\n\n    /**\n     * Deletes an element for a single site.\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionDeleteForSite(): Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|null $element */\n        $element = $this->_element();\n\n        if (!$element || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n\n        if (!$elementsService->canDeleteForSite($element)) {\n            throw new ForbiddenHttpException('User not authorized to delete the element for this site.');\n        }\n\n        $elementsService->deleteElementForSite($element);\n\n        if ($element->isProvisionalDraft) {\n            // see if the canonical element exists for this site\n            $canonical = $element->getCanonical();\n            if ($canonical->id !== $element->id) {\n                $element = $canonical;\n                $elementsService->deleteElementForSite($element);\n            }\n        }\n\n        return $this->_asSuccess(Craft::t('app', '{type} deleted for site.', [\n            'type' => $element->getIsDraft() && !$element->isProvisionalDraft ? Craft::t('app', 'Draft') : $element::displayName(),\n        ]), $element);\n    }\n\n    /**\n     * Saves a draft.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionSaveDraft(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if (!$element->getIsDraft() && !$this->_provisional) {\n            if (!$elementsService->canCreateDrafts($element, $user)) {\n                throw new ForbiddenHttpException('User not authorized to create drafts for this element.');\n            }\n        } elseif (!$this->_canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        $this->element = $element;\n\n        if (!$element->getIsDraft() && $this->_provisional) {\n            // Make sure a provisional draft doesn't already exist for this element/user combo\n            $provisionalExists = $element::find()\n                ->provisionalDrafts()\n                ->draftOf($element->id)\n                ->draftCreator($user->id)\n                ->site('*')\n                ->status(null)\n                ->exists();\n\n            if ($provisionalExists) {\n                throw new BadRequestHttpException(\"A provisional draft already exists for element/user $element->id/$user->id.\");\n            }\n        }\n\n        return Craft::$app->getDb()->transaction(function() use ($element, $user, $elementsService): ?Response {\n            // Are we creating the draft here?\n            if (!$element->getIsDraft()) {\n                /** @var Element|DraftBehavior $element */\n                $draft = Craft::$app->getDrafts()->createDraft($element, $user->id, null, null, [], $this->_provisional);\n                $draft->setCanonical($element);\n                $element = $this->element = $draft;\n            }\n\n            $this->_applyParamsToElement($element);\n\n            // Make sure nothing just changed that would prevent the user from saving\n            if (!$this->_canSave($element, $user)) {\n                throw new ForbiddenHttpException('User not authorized to save this element.');\n            }\n\n            if ($this->_dropProvisional) {\n                $element->isProvisionalDraft = false;\n            }\n\n            $element->setScenario(Element::SCENARIO_ESSENTIALS);\n\n            if (!$elementsService->saveElement($element)) {\n                return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t save {type}.', [\n                    'type' => Craft::t('app', 'draft'),\n                ]));\n            }\n\n            $elementsService->trackActivity($element, ElementActivity::TYPE_SAVE);\n\n            $creator = $element->getCreator();\n\n            $data = [\n                'canonicalId' => $element->getCanonicalId(),\n                'elementId' => $element->id,\n                'draftId' => $element->draftId,\n                'timestamp' => Craft::$app->getFormatter()->asTimestamp($element->dateUpdated, 'short', true),\n                'creator' => $creator?->getName(),\n                'draftName' => $element->draftName,\n                'draftNotes' => $element->draftNotes,\n                'duplicatedElements' => Elements::$duplicatedElementIds,\n                'modifiedAttributes' => $element->getModifiedAttributes(),\n            ];\n\n            if ($this->request->getIsCpRequest()) {\n                [$docTitle, $title] = $this->_editElementTitles($element);\n\n                $view = Craft::$app->getView();\n\n                $namespace = $this->request->getHeaders()->get('X-Craft-Namespace');\n                $fieldLayout = $element->getFieldLayout();\n                $form = $fieldLayout->createForm($element, false, [\n                    'namespace' => $namespace,\n                    'registerDeltas' => false,\n                    'visibleElements' => $this->_visibleLayoutElements,\n                ]);\n                $missingElements = [];\n                foreach ($form->tabs as $tab) {\n                    if (!$tab->getUid()) {\n                        continue;\n                    }\n\n                    $elementInfo = [];\n\n                    foreach ($tab->elements as [$layoutElement, $isConditional, $elementHtml]) {\n                        /** @var FieldLayoutComponent $layoutElement */\n                        /** @var bool $isConditional */\n                        /** @var string|bool $elementHtml */\n                        if ($isConditional) {\n                            $elementInfo[] = [\n                                'uid' => $layoutElement->uid,\n                                'html' => $elementHtml,\n                            ];\n                        }\n                    }\n\n                    $missingElements[] = [\n                        'uid' => $tab->getUid(),\n                        'id' => $tab->getId(),\n                        'elements' => $elementInfo,\n                    ];\n                }\n\n                $tabs = $form->getTabMenu();\n                if (count($tabs) > 1) {\n                    $selectedTab = isset($tabs[$this->_selectedTab]) ? $this->_selectedTab : null;\n                    $tabHtml = $view->namespaceInputs(fn() => $view->renderTemplate('_includes/tabs.twig', [\n                        'tabs' => $tabs,\n                        'selectedTab' => $selectedTab,\n                    ], View::TEMPLATE_MODE_CP), $namespace);\n                } else {\n                    $tabHtml = null;\n                }\n\n                $data += [\n                    'docTitle' => $docTitle,\n                    'title' => $title,\n                    'tabs' => $tabHtml,\n                    'previewTargets' => $element->getPreviewTargets(),\n                    'missingElements' => $missingElements,\n                    'initialDeltaValues' => $view->getInitialDeltaValues(),\n                    'headHtml' => $view->getHeadHtml(),\n                    'bodyHtml' => $view->getBodyHtml(),\n                    'updatedTimestamp' => $element->dateUpdated->getTimestamp(),\n                    'canonicalUpdatedTimestamp' => $element->getCanonical()->dateUpdated->getTimestamp(),\n                ];\n            }\n\n            // Make sure the user is authorized to preview the draft\n            Craft::$app->getSession()->authorize(\"previewDraft:$element->draftId\");\n\n            return $this->_asSuccess(Craft::t('app', '{type} saved.', [\n                'type' => Craft::t('app', 'Draft'),\n            ]), $element, $data);\n        });\n    }\n\n    /**\n     * Applies a draft to its canonical element.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @throws ServerErrorHttpException\n     * @since 4.0.0\n     */\n    public function actionApplyDraft(): ?Response\n    {\n        $this->requirePostRequest();\n        $elementsService = Craft::$app->getElements();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || !$element->getIsDraft()) {\n            throw new BadRequestHttpException('No draft was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $this->_applyParamsToElement($element);\n        $user = static::currentUser();\n\n        if (!$elementsService->canSave($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this draft.');\n        }\n\n        $isUnpublishedDraft = $element->getIsUnpublishedDraft();\n\n        if ($isUnpublishedDraft) {\n            if (!$this->_canApplyUnpublishedDraft($element, $user)) {\n                throw new ForbiddenHttpException('User not authorized to create this element.');\n            }\n        } elseif (!$elementsService->canSave($element->getCanonical(true), $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        // Validate and save the draft\n        if ($element->enabled && $element->getEnabledForSite()) {\n            $element->setScenario(Element::SCENARIO_LIVE);\n        }\n\n        $namespace = $this->request->getHeaders()->get('X-Craft-Namespace');\n        if (!$elementsService->saveElement($element, crossSiteValidate: ($namespace === null && Craft::$app->getIsMultiSite()))) {\n            return $this->_asAppyDraftFailure($element);\n        }\n\n        if (!$isUnpublishedDraft) {\n            $lockKey = \"element:$element->canonicalId\";\n            $mutex = Craft::$app->getMutex();\n            if (!$mutex->acquire($lockKey, 15)) {\n                throw new ServerErrorHttpException('Could not acquire a lock to save the element.');\n            }\n        }\n\n        try {\n            $canonical = Craft::$app->getDrafts()->applyDraft($element);\n        } catch (InvalidElementException) {\n            return $this->_asAppyDraftFailure($element);\n        } finally {\n            if (!$isUnpublishedDraft) {\n                $mutex->release($lockKey);\n            }\n        }\n\n        $elementsService->trackActivity($canonical, ElementActivity::TYPE_SAVE);\n\n        if (!$this->request->getAcceptsJson()) {\n            // Tell all browser windows about the element save\n            $session = Craft::$app->getSession();\n            $session->broadcastToJs([\n                'event' => 'saveElement',\n                'id' => $canonical->id,\n            ]);\n            if (!$isUnpublishedDraft) {\n                $session->broadcastToJs([\n                    'event' => 'deleteDraft',\n                    'canonicalId' => $element->getCanonicalId(),\n                    'draftId' => $element->draftId,\n                ]);\n            }\n        }\n\n        if ($isUnpublishedDraft) {\n            $message = Craft::t('app', '{type} created.', [\n                'type' => $element::displayName(),\n            ]);\n        } elseif ($element->isProvisionalDraft) {\n            $message = Craft::t('app', '{type} saved.', [\n                'type' => $element::displayName(),\n            ]);\n        } else {\n            $message = Craft::t('app', 'Draft applied.');\n        }\n\n        return $this->_asSuccess($message, $canonical, addAnother: true);\n    }\n\n    private function _asAppyDraftFailure(ElementInterface $element): ?Response\n    {\n        if ($element->getIsUnpublishedDraft()) {\n            $message = Craft::t('app', 'Couldn\u2019t create {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]);\n        } elseif ($element->isProvisionalDraft) {\n            $message = Craft::t('app', 'Couldn\u2019t save {type}.', [\n                'type' => $element::lowerDisplayName(),\n            ]);\n        } else {\n            $message = Craft::t('app', 'Couldn\u2019t apply draft.');\n        }\n\n        return $this->_asFailure($element, $message);\n    }\n\n    /**\n     * Deletes a draft.\n     *\n     * @return Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionDeleteDraft(): ?Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|DraftBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || !$element->getIsDraft()) {\n            throw new BadRequestHttpException('No draft was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if (!$elementsService->canDelete($element, $user)) {\n            throw new ForbiddenHttpException('User not authorized to delete this draft.');\n        }\n\n        if (!$elementsService->deleteElement($element, true)) {\n            return $this->_asFailure($element, Craft::t('app', 'Couldn\u2019t delete {type}.', [\n                'type' => Craft::t('app', 'draft'),\n            ]));\n        }\n\n        if ($element->isProvisionalDraft) {\n            $message = Craft::t('app', 'Changes discarded.');\n        } else {\n            $message = Craft::t('app', '{type} deleted.', [\n                'type' => Craft::t('app', 'Draft'),\n            ]);\n        }\n\n        if (!$this->request->getAcceptsJson()) {\n            // Tell all browser windows about the draft deletion\n            Craft::$app->getSession()->broadcastToJs([\n                'event' => 'deleteDraft',\n                'canonicalId' => $element->getCanonicalId(),\n                'draftId' => $element->draftId,\n            ]);\n        }\n\n        return $this->_asSuccess($message, $element);\n    }\n\n    /**\n     * Reverts an element\u2019s content to a revision.\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     * @since 4.0.0\n     */\n    public function actionRevert(): Response\n    {\n        $this->requirePostRequest();\n\n        /** @var Element|RevisionBehavior|null $element */\n        $element = $this->_element();\n\n        if (!$element || !$element->getIsRevision()) {\n            throw new BadRequestHttpException('No revision was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $user = static::currentUser();\n\n        if (!Craft::$app->getElements()->canSave($element->getCanonical(true), $user)) {\n            throw new ForbiddenHttpException('User not authorized to save this element.');\n        }\n\n        $canonical = Craft::$app->getRevisions()->revertToRevision($element, $user->id);\n        Craft::$app->getElements()->trackActivity($canonical, ElementActivity::TYPE_SAVE);\n\n        return $this->_asSuccess(Craft::t('app', '{type} reverted to past revision.', [\n            'type' => $element::displayName(),\n        ]), $canonical);\n    }\n\n    /**\n     * Returns the HTML for a single element\n     *\n     * @return Response\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     */\n    public function actionGetElementHtml(): Response\n    {\n        $this->requireAcceptsJson();\n\n        $element = $this->_element();\n\n        if (!$element) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $this->element = $element;\n\n        $context = $this->_context ?? 'field';\n        $thumbSize = $this->_thumbSize;\n\n        if (!in_array($thumbSize, [Cp::ELEMENT_SIZE_SMALL, Cp::ELEMENT_SIZE_LARGE], true)) {\n            $thumbSize = $this->_viewMode === 'thumbs' ? Cp::ELEMENT_SIZE_LARGE : Cp::ELEMENT_SIZE_SMALL;\n        }\n\n        $html = Cp::elementHtml($element, $context, $thumbSize);\n        $headHtml = $this->getView()->getHeadHtml();\n\n        return $this->asJson(compact('html', 'headHtml'));\n    }\n\n    /**\n     * Returns any recent activity for an element, and records that the user is viewing the element.\n     *\n     * @return Response\n     * @since 4.5.0\n     */\n    public function actionRecentActivity(): Response\n    {\n        $element = $this->_element();\n\n        if (!$element || $element->getIsRevision()) {\n            throw new BadRequestHttpException('No element was identified by the request.');\n        }\n\n        $elementsService = Craft::$app->getElements();\n        $currentUser = Craft::$app->getUser()->getIdentity();\n        $activity = $elementsService->getRecentActivity($element, $currentUser->id);\n        $elementsService->trackActivity($element, ElementActivity::TYPE_VIEW, $currentUser);\n\n        return $this->asJson([\n            'activity' => array_map(function(ElementActivity $record) use ($element) {\n                $recordIsCanonical = $record->element->getIsCanonical() || $record->element->isProvisionalDraft;\n                $recordIsCanonicalAndPublished = $recordIsCanonical && !$record->element->getIsUnpublishedDraft();\n                $isSameOrUpstream = $element->id === $record->element->id || $recordIsCanonical;\n\n                if ($isSameOrUpstream) {\n                    $messageParams = [\n                        'user' => $record->user->getName(),\n                        'type' => $recordIsCanonicalAndPublished ? $element::lowerDisplayName() : Craft::t('app', 'draft'),\n                    ];\n                    $message = match ($record->type) {\n                        ElementActivity::TYPE_VIEW => Craft::t('app', '{user} is viewing this {type}.', $messageParams),\n                        ElementActivity::TYPE_EDIT, ElementActivity::TYPE_SAVE => Craft::t('app', '{user} is editing this {type}.', $messageParams),\n                    };\n                } else {\n                    $messageParams = [\n                        'user' => $record->user->getName(),\n                        'type' => $element::lowerDisplayName(),\n                    ];\n                    $message = match ($record->type) {\n                        ElementActivity::TYPE_VIEW => Craft::t('app', '{user} is viewing a draft of this {type}.', $messageParams),\n                        ElementActivity::TYPE_EDIT, ElementActivity::TYPE_SAVE => Craft::t('app', '{user} is editing a draft of this {type}.', $messageParams),\n                    };\n                }\n\n                return [\n                    'userId' => $record->user->id,\n                    'userName' => $record->user->getName(),\n                    'userThumb' => $record->user->getThumbHtml(26),\n                    'message' => $message,\n                ];\n            }, $activity),\n            'updatedTimestamp' => $element->dateUpdated->getTimestamp(),\n            'canonicalUpdatedTimestamp' => $element->getCanonical()->dateUpdated->getTimestamp(),\n        ]);\n    }\n\n    /**\n     * Returns the requested element, populated with any posted attributes.\n     *\n     * @param int|null $elementId\n     * @param string|null $elementUid\n     * @param bool|null $provisional\n     * @param bool $strictSite\n     * @return ElementInterface|Response|null\n     * @throws BadRequestHttpException\n     * @throws ForbiddenHttpException\n     */\n    private function _element(?int $elementId = null, ?string $elementUid = null, ?bool $provisional = null, bool $strictSite = true): ElementInterface|Response|null\n    {\n        $elementId = $elementId ?? $this->_elementId;\n        $elementUid = $elementUid ?? $this->_elementUid;\n\n        $sitesService = Craft::$app->getSites();\n        $elementsService = Craft::$app->getElements();\n        $user = static::currentUser();\n\n        if ($this->_siteId) {\n            $site = $sitesService->getSiteById($this->_siteId, true);\n            if (!$site) {\n                throw new BadRequestHttpException(\"Invalid side ID: $this->_siteId\");\n            }\n            if (Craft::$app->getIsMultiSite() && !$user->can(\"editSite:$site->uid\")) {\n                throw new ForbiddenHttpException('User not authorized to edit content for this site.');\n            }\n        } else {\n            $site = Cp::requestedSite();\n            if (!$site) {\n                throw new ForbiddenHttpException('User not authorized to edit content in any sites.');\n            }\n        }\n\n        if ($this->_elementType) {\n            $elementType = $this->_elementType;\n        } elseif ($elementId || $elementUid) {\n            if ($elementId) {\n                $elementType = $elementsService->getElementTypeById($elementId);\n            } else {\n                $elementType = $elementsService->getElementTypeByUid($elementUid);\n            }\n            if (!$elementType) {\n                throw new BadRequestHttpException($elementId ? \"Invalid element ID: $elementId\" : \"Invalid element UUID: $elementUid\");\n            }\n        } else {\n            throw new BadRequestHttpException('Request missing required param.');\n        }\n\n        /** @var string|ElementInterface $elementType */\n        /** @phpstan-var class-string<ElementInterface>|ElementInterface $elementType */\n        $this->_validateElementType($elementType);\n\n        if ($strictSite) {\n            $siteId = $site->id;\n            $preferSites = null;\n        } else {\n            $siteId = $sitesService->getEditableSiteIds();\n            $preferSites = [$site->id];\n        }\n\n        // Loading an existing element?\n        if ($this->_draftId || $this->_revisionId) {\n            $element = $elementType::find()\n                ->draftId($this->_draftId)\n                ->revisionId($this->_revisionId)\n                ->provisionalDrafts($this->_provisional)\n                ->siteId($siteId)\n                ->preferSites($preferSites)\n                ->unique()\n                ->status(null)\n                ->one();\n\n            if (!$element) {\n                throw new BadRequestHttpException($this->_draftId ? \"Invalid draft ID: $this->_draftId\" : \"Invalid revision ID: $this->_revisionId\");\n            }\n        } elseif ($elementId || $elementUid) {\n            if ($elementId) {\n                // First check for a provisional draft, if we're open to it\n                if ($provisional) {\n                    $element = $elementType::find()\n                        ->provisionalDrafts()\n                        ->draftOf($elementId)\n                        ->draftCreator($user)\n                        ->siteId($siteId)\n                        ->preferSites($preferSites)\n                        ->unique()\n                        ->status(null)\n                        ->one();\n                }\n\n                if (!isset($element) || !$this->_canSave($element, $user)) {\n                    $element = $elementType::find()\n                        ->id($elementId)\n                        ->siteId($siteId)\n                        ->preferSites($preferSites)\n                        ->unique()\n                        ->status(null)\n                        ->one();\n                }\n            } else {\n                $element = $elementType::find()\n                    ->uid($elementUid)\n                    ->siteId($siteId)\n                    ->preferSites($preferSites)\n                    ->unique()\n                    ->status(null)\n                    ->one();\n            }\n\n            if (!$element) {\n                throw new BadRequestHttpException($elementId ? \"Invalid element ID: $elementId\" : \"Invalid element UUID: $elementUid\");\n            }\n        } else {\n            return null;\n        }\n\n        if (!$element->canView(static::currentUser())) {\n            throw new ForbiddenHttpException('User not authorized to edit this element.');\n        }\n\n        if (!$strictSite && $element->siteId !== $site->id) {\n            return $this->redirect($element->getCpEditUrl());\n        }\n\n        return $element;\n    }\n\n    /**\n     * Ensures the given element type is valid.\n     *\n     * @param string $elementType\n     * @phpstan-param class-string<ElementInterface> $elementType\n     * @throws BadRequestHttpException\n     */\n    private function _validateElementType(string $elementType): void\n    {\n        if (!Component::validateComponentClass($elementType, ElementInterface::class)) {\n            $message = (new InvalidTypeException($elementType, ElementInterface::class))->getMessage();\n            throw new BadRequestHttpException($message);\n        }\n    }\n\n    /**\n     * Applies the request params to the given element.\n     *\n     * @param ElementInterface $element\n     * @throws ForbiddenHttpException\n     */\n    private function _applyParamsToElement(ElementInterface $element): void\n    {\n        if (isset($this->_enabledForSite)) {\n            if (is_array($this->_enabledForSite)) {\n                // Make sure they are allowed to edit all of the posted site IDs\n                $editableSiteIds = Craft::$app->getSites()->getEditableSiteIds();\n                if (array_diff(array_keys($this->_enabledForSite), $editableSiteIds)) {\n                    throw new ForbiddenHttpException('User not authorized to edit element statuses for all the submitted site IDs.');\n                }\n\n                // Set the global status to true if it's enabled for *any* sites, or if already enabled.\n                $element->enabled = in_array(true, $this->_enabledForSite) || $element->enabled;\n            }\n\n            $element->setEnabledForSite($this->_enabledForSite);\n        } elseif (isset($this->_enabled)) {\n            $element->enabled = $this->_enabled;\n        }\n\n        if ($this->_fresh) {\n            $element->setIsFresh();\n\n            if ($element->getIsUnpublishedDraft()) {\n                $element->propagateAll = true;\n            }\n        }\n\n        if ($element->getIsDraft()) {\n            /** @var ElementInterface|DraftBehavior $element */\n            if (isset($this->_draftName)) {\n                $element->draftName = $this->_draftName;\n            }\n            if (isset($this->_notes)) {\n                $element->draftNotes = $this->_notes;\n            }\n        } elseif (isset($this->_notes)) {\n            $element->setRevisionNotes($this->_notes);\n        }\n\n        $scenario = $element->getScenario();\n        $element->setScenario(Element::SCENARIO_LIVE);\n        $element->setAttributes($this->_attributes);\n\n        if ($this->_slug !== null) {\n            $element->slug = $this->_slug;\n        }\n\n        $element->setScenario($scenario);\n\n        // Now that the element is fully configured, make sure the user can actually view it\n        if (!Craft::$app->getElements()->canView($element)) {\n            throw new ForbiddenHttpException('User not authorized to edit this element.');\n        }\n\n        // Set the custom field values\n        $element->setFieldValuesFromRequest($this->_fieldsLocation);\n    }\n\n    /**\n     * Returns whether an element can be saved by the given user.\n     *\n     * If the element is a provisional draft, the canonical element will be used instead.\n     *\n     * @param ElementInterface $element\n     * @param User $user\n     * @return bool\n     */\n    private function _canSave(ElementInterface $element, User $user): bool\n    {\n        if ($element->getIsRevision()) {\n            return false;\n        }\n\n        if ($element->isProvisionalDraft) {\n            $element = $element->getCanonical(true);\n        }\n\n        return Craft::$app->getElements()->canSave($element, $user);\n    }\n\n    /**\n     * Returns whether an unpublished draft can shed its draft status by the given user.\n     *\n     * @param ElementInterface $element\n     * @param User $user\n     * @return bool\n     */\n    private function _canApplyUnpublishedDraft(ElementInterface $element, User $user): bool\n    {\n        $fakeCanonical = clone $element;\n        $fakeCanonical->draftId = null;\n        return Craft::$app->getElements()->canSave($fakeCanonical, $user);\n    }\n\n    /**\n     * @throws Throwable\n     * @throws ServerErrorHttpException\n     */\n    private function _asSuccess(string $message, ElementInterface $element, array $data = [], bool $addAnother = false): Response\n    {\n        /** @var Element $element */\n        // Don't call asModelSuccess() here so we can avoid including custom fields in the element data\n        $data += [\n            'modelName' => 'element',\n            'element' => $element->toArray($element->attributes()),\n        ];\n        $response = $this->asSuccess($message, $data, $this->getPostedRedirectUrl($element), [\n            'details' => !$element->dateDeleted ? Cp::elementHtml($element) : null,\n        ]);\n\n        if ($addAnother && $this->_addAnother) {\n            $user = static::currentUser();\n            $newElement = $element->createAnother();\n\n            if (!$newElement || !Craft::$app->getElements()->canSave($newElement, $user)) {\n                throw new ServerErrorHttpException('Unable to create a new element.');\n            }\n\n            if (!$newElement->slug) {\n                $newElement->slug = ElementHelper::tempSlug();\n            }\n\n            $newElement->setScenario(Element::SCENARIO_ESSENTIALS);\n\n            if (!Craft::$app->getDrafts()->saveElementAsDraft($newElement, $user->id, null, null, false)) {\n                throw new ServerErrorHttpException(sprintf('Unable to create a new element: %s', implode(', ', $element->getErrorSummary(true))));\n            }\n\n            $url = $newElement->getCpEditUrl();\n\n            if ($url) {\n                $url = UrlHelper::urlWithParams($url, ['fresh' => 1]);\n            } else {\n                $url = UrlHelper::actionUrl('elements/edit', [\n                    'draftId' => $newElement->draftId,\n                    'siteId' => $newElement->siteId,\n                    'fresh' => 1,\n                ]);\n            }\n\n            $response->redirect($url);\n        }\n\n        return $response;\n    }\n\n    private function _asFailure(ElementInterface $element, string $message): ?Response\n    {\n        $data = [\n            'modelName' => 'element',\n            'element' => $element->toArray($element->attributes()),\n            'errors' => $element->getErrors(),\n            'errorSummary' => $this->_errorSummary($element),\n        ];\n\n        return $this->asFailure($message, $data, ['element' => $element]);\n    }\n}\n"], "filenames": ["CHANGELOG.md", "src/controllers/ElementsController.php"], "buggy_code_start_loc": [14, 1106], "buggy_code_end_loc": [15, 1109], "fixing_code_start_loc": [14, 1105], "fixing_code_end_loc": [15, 1116], "type": "NVD-CWE-noinfo", "message": "Craft is a content management system. This is a potential moderate impact, low complexity privilege escalation vulnerability in Craft starting in 3.x prior to 3.9.6 and 4.x prior to 4.4.16 with certain user permissions setups. This has been fixed in Craft 4.4.16 and Craft 3.9.6. Users should ensure they are running at least those versions.", "other": {"cve": {"id": "CVE-2024-21622", "sourceIdentifier": "security-advisories@github.com", "published": "2024-01-03T17:15:12.330", "lastModified": "2024-01-10T18:34:46.497", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Craft is a content management system. This is a potential moderate impact, low complexity privilege escalation vulnerability in Craft starting in 3.x prior to 3.9.6 and 4.x prior to 4.4.16 with certain user permissions setups. This has been fixed in Craft 4.4.16 and Craft 3.9.6. Users should ensure they are running at least those versions."}, {"lang": "es", "value": "Craft es un sistema de gesti\u00f3n de contenidos. Esta es una posible vulnerabilidad de escalada de privilegios de baja complejidad y impacto moderado en Craft a partir de 3.x anterior a 3.9.6 y 4.x anterior a 4.4.16 con ciertas configuraciones de permisos de usuario. Esto se ha solucionado en Craft 4.4.16 y Craft 3.9.6. Los usuarios deben asegurarse de estar ejecutando al menos esas versiones."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:A/AC:L/PR:L/UI:N/S:C/C:N/I:L/A:L", "attackVector": "ADJACENT_NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "CHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "NVD-CWE-noinfo"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-269"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:craftcms:craft_cms:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.0.0", "versionEndExcluding": "3.9.6", "matchCriteriaId": "36AC4498-6DDF-4F74-BD12-86BF5479F10A"}, {"vulnerable": true, "criteria": "cpe:2.3:a:craftcms:craft_cms:*:*:*:*:*:*:*:*", "versionStartIncluding": "4.0.0", "versionEndIncluding": "4.5.15", "matchCriteriaId": "9B004CCA-A979-42AD-ADD4-1BEFDB964C78"}]}]}], "references": [{"url": "https://github.com/craftcms/cms/blob/develop/CHANGELOG.md#4511---2023-11-16", "source": "security-advisories@github.com", "tags": ["Release Notes"]}, {"url": "https://github.com/craftcms/cms/blob/v3/CHANGELOG.md#396---2023-11-16", "source": "security-advisories@github.com", "tags": ["Release Notes"]}, {"url": "https://github.com/craftcms/cms/commit/76caf9af07d9964be0fd362772223be6a5f5b6aa", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/craftcms/cms/commit/be81eb653d633833f2ab22510794abb6bb9c0843", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/craftcms/cms/pull/13931", "source": "security-advisories@github.com", "tags": ["Issue Tracking", "Patch"]}, {"url": "https://github.com/craftcms/cms/pull/13932", "source": "security-advisories@github.com", "tags": ["Issue Tracking", "Patch"]}, {"url": "https://github.com/craftcms/cms/security/advisories/GHSA-j5g9-j7r4-6qvx", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}]}, "github_commit_url": "https://github.com/craftcms/cms/commit/76caf9af07d9964be0fd362772223be6a5f5b6aa"}}