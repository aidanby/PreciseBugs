{"buggy_code": ["<?php if (!defined('BASEPATH')) exit('No direct script access allowed');\r\n/**\r\n * MaxSite CMS\r\n * (c) https://max-3000.com/\r\n * \r\n */\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u043c \u0441\u043a\u0440\u044b\u0442\u044b\u0439 input \u0434\u043b\u044f \u0444\u043e\u0440\u043c\u044b \u0441 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0435\u0441\u0441\u0438\u0435\u0439\r\nfunction mso_form_session($name_form = 'flogin_session_id')\r\n{\r\n\treturn '<input type=\"hidden\" value=\"' . getinfo('session_id') . '\" name=\"' . $name_form . '\">';\r\n}\r\n\r\n// \u0432\u044b\u0432\u043e\u0434 \u043b\u043e\u0433\u0438\u043d-\u0444\u043e\u0440\u043c\u044b\r\n// \u0432 login_form_auth_title \u0434\u043b\u044f \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u0435\u0439 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0441\u044f \u043a\u043e\u0434 [end] - \u043d\u0443\u0436\u0435\u043d \u0434\u043b\u044f \u0442\u043e\u0433\u043e, \u0447\u0442\u043e\u0431\u044b \u043f\u0435\u0440\u0435\u0447\u0438\u0441\u043b\u044f\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u043f\u044f\u0442\u0443\u044e\r\nfunction mso_login_form($conf = [], $redirect = '', $echo = true)\r\n{\r\n\tif ($redirect == '') $redirect = urlencode(mso_current_url());\r\n\r\n\t// \u0433\u043e\u0442\u043e\u0432\u0438\u043c \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435 \u0434\u043b\u044f \u0444\u0430\u0439\u043b\u0430 \u0448\u0430\u0431\u043b\u043e\u043d\u0438\u0437\u0430\u0442\u043e\u0440\u0430 loginform-common-tmpl.php\r\n\t$login = $conf['login'] ?? '';\r\n\t$password = $conf['password'] ?? '';\r\n\t$submit = $conf['submit'] ?? '';\r\n\t$submit_value = $conf['submit_value'] ?? tf('\u0412\u043e\u0439\u0442\u0438');\r\n\t$submit_end = $conf['submit_end'] ?? '';\r\n\t$form_end = $conf['form_end'] ?? '';\r\n\t$login_add = $conf['login_add'] ?? '';\r\n\t$password_add = $conf['password_add'] ?? '';\r\n\t$tmpl_file = $conf['tmpl_file'] ?? 'type/loginform/units/loginform-common-tmpl.php';\r\n\t$action = getinfo('site_url') . 'login';\r\n\t$session_id = getinfo('session_id');\r\n\r\n\t$login_form_auth_title = $conf['login_form_auth_title'] ?? tf('\u0412\u0445\u043e\u0434 \u0447\u0435\u0440\u0435\u0437:') . ' ';\r\n\r\n\t$hook_login_form_auth = mso_hook_present('login_form_auth') ? '<span class=\"login-form-auth-title\">' . $login_form_auth_title . '</span>' . mso_hook('login_form_auth') : '';\r\n\r\n\tif ($hook_login_form_auth) {\r\n\t\t$hook_login_form_auth = trim(str_replace('[end]', '     ', $hook_login_form_auth));\r\n\t\t$hook_login_form_auth = '<div class=\"login-form-auth\">' . str_replace('     ', ', ', $hook_login_form_auth) . '</div>';\r\n\t}\r\n\r\n\tif ($echo) {\r\n\t\teval(mso_tmpl_ts($tmpl_file));\r\n\t} else {\r\n\t\tob_start();\r\n\t\teval(mso_tmpl_ts($tmpl_file));\r\n\t\t$out = ob_get_contents();\r\n\t\tob_end_clean();\r\n\t\treturn $out;\r\n\t}\r\n}\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u043c li-\u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u0434\u043b\u044f \u043c\u0435\u043d\u044e\r\n// \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u043f\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u043b\u044f\u044e\u0442 \u0441\u043e\u0431\u043e\u0439 \u0442\u0435\u043a\u0441\u0442, \u0433\u0434\u0435 \u043a\u0430\u0436\u0434\u0430\u044f \u0441\u0442\u0440\u043e\u0447\u043a\u0430 \u043e\u0434\u0438\u043d \u043f\u0443\u043d\u043a\u0442\r\n// \u043a\u0430\u0436\u0434\u044b\u0439 \u043f\u0443\u043d\u043a\u0442 \u0434\u0435\u043b\u0430\u0435\u0442\u0441\u044f \u0442\u0430\u043a:  http://\u0441\u0441\u044b\u043b\u043a\u0430 | \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 | \u043f\u043e\u0434\u0441\u043a\u0430\u0437\u043a\u0430 | class | class_\u0434\u043b\u044f_span | \u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044b \u0441\u0441\u044b\u043b\u043a\u0438\r\n// \u043d\u0430 \u0432\u044b\u0445\u043e\u0434\u0435 \u0442\u0430\u043a:\r\n// <li class=\"selected\"><a href=\"url\"><span>\u0441\u0441\u044b\u043b\u043a\u0430</span></a></li>\r\n// \u0435\u0441\u043b\u0438 \u043f\u0435\u0440\u0432\u044b\u0439 \u0441\u0438\u043c\u0432\u043e\u043b [ \u0442\u043e \u044d\u0442\u043e \u043e\u0442\u043a\u0440\u044b\u0432\u0430\u0435\u0442 \u0433\u0440\u0443\u043f\u043f\u0443 ul \r\n// \u0435\u0441\u043b\u0438 ] \u0442\u043e \u0437\u0430\u043a\u0440\u044b\u0432\u0430\u0435\u0442 - \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u043c\u043d\u043e\u0433\u043e\u0443\u0440\u043e\u0432\u043d\u0435\u0432\u044b\u0435 \u043c\u0435\u043d\u044e\r\n// \u0435\u0441\u043b\u0438 \u0430\u0434\u0440\u0435\u0441 \u0440\u0430\u0432\u0435\u043d # \u0442\u043e \u0441\u0441\u044b\u043b\u043a\u0430 \u043d\u0435 \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442\u0441\u044f, \u0442\u043e\u043b\u044c\u043a\u043e \u0442\u0435\u043a\u0441\u0442 <li class=\"\"><span>\u0441\u0441\u044b\u043b\u043a\u0430</span></li>\r\n// \u0435\u0441\u043b\u0438 \u043f\u0443\u043d\u043a\u0442 \u043c\u0435\u043d\u044e \u0440\u0430\u0432\u0435\u043d --- \u0442\u043e \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442\u0441\u044f \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c li.divider \u0418\u043c\u0435\u0435\u0442 \u0441\u043c\u044b\u0441\u043b \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u043e\u0434\u043f\u0443\u043d\u043a\u0442\u0430\u0445\r\nfunction mso_menu_build($menu = '', $select_css = 'selected', $add_link_admin = false)\r\n{\r\n\t// \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443 \u043d\u0430 admin\r\n\tif ($add_link_admin and is_login()) $menu .= NR . 'admin|Admin';\r\n\r\n\t$menu = str_replace(\"\\r\", \"\", $menu); // \u0435\u0441\u043b\u0438 \u044d\u0442\u043e windows\r\n\t$menu = str_replace(\"_NR_\", \"\\n\", $menu);\r\n\t$menu = str_replace(\" ~ \", \"\\n\", $menu);\r\n\t$menu = str_replace(\"\\n\\n\\n\", \"\\n\", $menu);\r\n\t$menu = str_replace(\"\\n\\n\", \"\\n\", $menu);\r\n\r\n\t// \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n\t$menu = explode(\"\\n\", trim($menu));\r\n\r\n\t// \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u043c \u043c\u0435\u043d\u044e \u043d\u0430 \u043f\u0440\u0435\u0434\u043c\u0435\u0442 \u043f\u0443\u0441\u0442\u044b\u0445 \u0441\u0442\u0440\u043e\u043a, \u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u043e\u0441\u0442\u0438 \u0438 \u043f\u043e\u0434\u0441\u0447\u0438\u0442\u0430\u0435\u043c \u043a\u043e\u043b-\u0432\u043e \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432\r\n\t$count_menu = 0;\r\n\tforeach ($menu as $elem) {\r\n\t\tif (strlen(trim($elem)) > 1) $count_menu++;\r\n\t}\r\n\r\n\t// \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u043c \u0442\u0435\u043a\u0443\u0449\u0438\u0439 url\r\n\t$current_url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];\r\n\r\n\t$out = '';\r\n\r\n\t$i = 1; // \u043d\u043e\u043c\u0435\u0440 \u043f\u0443\u043d\u043a\u0442\u0430\r\n\t$n = 0; // \u043d\u043e\u043c\u0435\u0440 \u0438\u0442\u0435\u0440\u0430\u0446\u0438\u0438 \u0446\u0438\u043a\u043b\u0430 \r\n\r\n\t$group_in = false;\r\n\t$group_in_first = false;\r\n\t$group_num = 0; // \u043d\u043e\u043c\u0435\u0440 \u0433\u0440\u0443\u043f\u043f\u044b\r\n\t$group_work = false; // \u043e\u0442\u043a\u0440\u044b\u0442\u0430\u044f \u0433\u0440\u0443\u043f\u043f\u0430?\r\n\t$selected_present = false; // \u0435\u0441\u0442\u044c \u043b\u0438 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u044b\u0439 \u043f\u0443\u043d\u043a\u0442?\r\n\t$group_elem = 0; // \u044d\u043b\u0435\u043c\u0435\u043d\u0442 \u0432 \u0433\u0440\u0443\u043f\u043f\u0435\r\n\r\n\tforeach ($menu as $elem) {\r\n\t\t// \u0440\u0430\u0437\u043e\u0431\u044a\u0435\u043c \u0441\u0442\u0440\u043e\u0447\u043a\u0443 \u043f\u043e \u0430\u0434\u0440\u0435\u0441 | \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435\r\n\t\t$elem = explode('|', trim($elem));\r\n\r\n\t\t// \u0434\u043e\u043b\u0436\u043d\u043e \u0431\u044b\u0442\u044c \u0434\u0432\u0430 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430\r\n\t\tif (count($elem) > 1) {\r\n\t\t\t$url = trim($elem[0]);  // \u0430\u0434\u0440\u0435\u0441\r\n\t\t\t$name = trim($elem[1]); // \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435\r\n\r\n\t\t\tif (isset($elem[2]))\r\n\t\t\t\t$title = ' title=\"' . htmlspecialchars(trim($elem[2])) . '\"';\r\n\t\t\telse\r\n\t\t\t\t$title = '';\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0430\u0434\u0440\u0435\u0441 = ## \u0442\u043e \u043d\u0435 \u0432\u044b\u0432\u043e\u0434\u0438\u043c \u0441\u0441\u044b\u043b\u043a\u0443\r\n\t\t\t$a_link = ($url != '##');\r\n\r\n\t\t\t// \u043d\u0435\u0442 \u0432 \u0430\u0434\u0440\u0435\u0441\u0435 http:// - \u0437\u043d\u0430\u0447\u0438\u0442 \u044d\u0442\u043e \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0441\u0430\u0439\u0442\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u043d\u0430\u0447\u0438\u043d\u0430\u0435\u0442\u0441\u044f \u0441 # \u0438\u043b\u0438  ? \u2014 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0434\u0435\u043b\u0430\u0435\u043c\r\n\t\t\tif (\r\n\t\t\t\t($url != '#')\r\n\t\t\t\tand strpos($url, '#') !== 0\r\n\t\t\t\tand strpos($url, '?') !== 0\r\n\t\t\t\tand strpos($url, 'http://') === false\r\n\t\t\t\tand strpos($url, 'https://') === false\r\n\t\t\t) {\r\n\t\t\t\tif ($url == '/')\r\n\t\t\t\t\t$url = getinfo('siteurl'); // \u044d\u0442\u043e \u0433\u043b\u0430\u0432\u043d\u0430\u044f\r\n\t\t\t\telse\r\n\t\t\t\t\t$url = getinfo('siteurl') . $url;\r\n\t\t\t}\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0430\u0434\u0440\u0435\u0441 \u0441\u043e\u0432\u043f\u0430\u043b, \u0437\u043d\u0430\u0447\u0438\u0442 \u043c\u044b \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435\r\n\t\t\tif ($url == $current_url) {\r\n\t\t\t\t$class = ' ' . $select_css;\r\n\t\t\t\t$selected_present = true;\r\n\t\t\t} else {\r\n\t\t\t\t$class = '';\r\n\t\t\t}\r\n\r\n\t\t\t// \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u043d css-\u043a\u043b\u0430\u0441\u0441\r\n\t\t\tif (isset($elem[3])) $class .= ' ' . trim($elem[3]);\r\n\r\n\t\t\t// \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u043d class_\u0434\u043b\u044f_span\r\n\t\t\tif (isset($elem[4]))\r\n\t\t\t\t$class_span = ' class=\"' . trim($elem[4]) . '\"';\r\n\t\t\telse\r\n\t\t\t\t$class_span = '';\r\n\r\n\t\t\t// \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u043d \u0430\u0442\u0440\u0438\u0431\u0443\u0442_\u0434\u043b\u044f_\u0441\u0441\u044b\u043b\u043a\u0438\r\n\t\t\t$link_attr = (isset($elem[5])) ? ' ' . trim($elem[5]) : '';\r\n\r\n\t\t\t// \u0434\u043b\u044f \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u043a\u043b\u0430\u0441\u0441 first\r\n\t\t\tif ($i == 1) $class .= ' first';\r\n\r\n\t\t\tif ($group_in_first) {\r\n\t\t\t\t$class .= ' group-first';\r\n\t\t\t\t$group_in_first = false;\r\n\t\t\t}\r\n\r\n\t\t\t// \u0434\u043b\u044f \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0435\u0433\u043e \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u043a\u043b\u0430\u0441\u0441 last\r\n\t\t\tif ($i == $count_menu) $class .= ' last';\r\n\r\n\t\t\tif ($class == ' ') $class = '';\r\n\r\n\t\t\tif ($group_in) {\r\n\t\t\t\t// \u043e\u0442\u043a\u0440\u044b\u0432\u0430\u0435\u043c \u0433\u0440\u0443\u043f\u043f\u0443\r\n\t\t\t\t$group_num++;\r\n\t\t\t\t$class .= ' group-num-' . $group_num;\r\n\r\n\t\t\t\tif ($a_link) {\r\n\t\t\t\t\t$out .= '<li class=\"group' . $class . '\"><a href=\"' . $url . '\"' . $title . $link_attr . '><span' . $class_span . '>' . $name . '</span></a><ul>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$out .= '<li class=\"group' . $class . '\"><span' . $class_span . '>' . $name . '</span><ul>';\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$group_in = false;\r\n\t\t\t\t$group_in_first = true;\r\n\t\t\t} else {\r\n\t\t\t\tif ($group_elem > 0 and array_key_exists($i, $menu) and isset($menu[$n + 1]) and trim($menu[$n + 1]) == ']') $class .= ' group-last';\r\n\r\n\t\t\t\tif ($a_link) {\r\n\t\t\t\t\t$out .= '<li class=\"' . trim($class) . '\"><a href=\"' . $url . '\"' . $title  . $link_attr . '><span' . $class_span . '>' . $name . '</span></a></li>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$out .= '<li class=\"' . trim($class) . '\"><span' . $class_span . '>' . $name . '</span></li>';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ($url == $current_url and $group_work) {\r\n\t\t\t\t// \u0432\u044b\u0434\u0435\u043b\u044f\u0435\u043c \u0440\u043e\u0434\u0438\u0442\u0435\u043b\u044f \u0433\u0440\u0443\u043f\u043f\u044b, \u0435\u0441\u043b\u0438 \u0432 \u043d\u0435\u0439 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u043d\u044b\u0439 \u043f\u043e\u0434\u043f\u0443\u043d\u043a\u0442\r\n\t\t\t\t$out = str_replace('group-num-' . $group_num, 'group-num-' . $group_num . ' group-selected', $out);\r\n\t\t\t\t$selected_present = true;\r\n\t\t\t}\r\n\r\n\t\t\t$i++;\r\n\t\t\t$group_elem++;\r\n\t\t} else {\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u044d\u0442\u043e [, \u0442\u043e \u044d\u0442\u043e \u043d\u0430\u0447\u0430\u043b\u043e \u0433\u0440\u0443\u043f\u043f\u044b ul \r\n\t\t\t// \u0435\u0441\u043b\u0438 ] \u0442\u043e /ul\r\n\r\n\t\t\tif ($elem[0] == '[') {\r\n\t\t\t\t$group_in = true;\r\n\t\t\t\t$group_work = true;\r\n\t\t\t\t$group_elem = 0;\r\n\t\t\t}\r\n\r\n\t\t\tif ($elem[0] == ']') {\r\n\t\t\t\t$group_elem = 0;\r\n\t\t\t\t$group_in = false;\r\n\t\t\t\t$group_work = false;\r\n\t\t\t\t$out .= '</ul></li>';\r\n\t\t\t}\r\n\r\n\t\t\tif ($elem[0] == '---') {\r\n\t\t\t\t// \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c\r\n\t\t\t\t$out .= '<li class=\"divider\"><span></span></li>';\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$n++;\r\n\t}\r\n\r\n\t$out = str_replace('<li class=\"\">', '<li>', $out);\r\n\r\n\t// \u0435\u0441\u043b\u0438 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u043e, \u0442\u043e \u0434\u043b\u044f \u043f\u0435\u0440\u0432\u043e\u0439 \u0433\u0440\u0443\u043f\u043f\u044b \u043f\u0440\u043e\u043f\u0438\u0441\u044b\u0432\u0430\u0435\u043c \u043a\u043b\u0430\u0441\u0441 group-default\r\n\tif (!$selected_present)\r\n\t\t$out = str_replace('group-num-1', 'group-num-1 group-default', $out);\r\n\r\n\t//pr($out, 1);\r\n\treturn $out;\r\n}\r\n\r\n// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u043e\u0441\u0442\u0440\u043e\u0435\u043d\u0438\u044f \u0438\u0437 \u043c\u0430\u0441\u0441\u0438\u0432\u043e\u0432 \u0441\u043f\u0438\u0441\u043a\u0430 UL\r\n// \u0432\u0445\u043e\u0434 - \u043c\u0430\u0441\u0441\u0438\u0432 \u0438\u0437 \u0441 [childs]=>array(...)\r\nfunction mso_create_list($a = [], $options = [], $child = false)\r\n{\r\n\tstatic $level = 0;\r\n\r\n\tif (!$a) return '';\r\n\r\n\tif (!isset($options['class_ul'])) $options['class_ul'] = ''; // \u043a\u043b\u0430\u0441\u0441 UL\r\n\tif (!isset($options['class_ul_style'])) $options['class_ul_style'] = ''; // \u0441\u0432\u043e\u0439 \u0441\u0442\u0438\u043b\u044c \u0434\u043b\u044f UL\r\n\tif (!isset($options['class_child'])) $options['class_child'] = 'child'; // \u043a\u043b\u0430\u0441\u0441 \u0434\u043b\u044f \u0440\u0435\u0431\u0435\u043d\u043a\u0430\r\n\tif (!isset($options['class_child_style'])) $options['class_child_style'] = ''; // \u0441\u0432\u043e\u0439 \u0441\u0442\u0438\u043b\u044c \u0434\u043b\u044f \u0440\u0435\u0431\u0435\u043d\u043a\u0430\r\n\tif (!isset($options['class_current'])) $options['class_current'] = 'current-page'; // \u043a\u043b\u0430\u0441\u0441 li \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\tif (!isset($options['class_current_style'])) $options['class_current_style'] = ''; // \u0441\u0442\u0438\u043b\u044c li \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\tif (!isset($options['class_li'])) $options['class_li'] = ''; // \u043a\u043b\u0430\u0441\u0441 LI\r\n\tif (!isset($options['class_li_style'])) $options['class_li_style'] = ''; // \u0441\u0442\u0438\u043b\u044c LI\r\n\tif (!isset($options['format'])) $options['format'] = '[LINK][TITLE][/LINK]'; // \u0444\u043e\u0440\u043c\u0430\u0442 \u0441\u0441\u044b\u043b\u043a\u0438\r\n\tif (!isset($options['format_current'])) $options['format_current'] = '<span>[TITLE]</span>'; // \u0444\u043e\u0440\u043c\u0430\u0442 \u0434\u043b\u044f \u0442\u0435\u043a\u0443\u0449\u0435\u0439\r\n\tif (!isset($options['title'])) $options['title'] = 'page_title'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u0442\u0438\u0442\u0443\u043b\u0430\r\n\tif (!isset($options['link'])) $options['link'] = 'page_slug'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u0441\u043b\u0430\u0433\u0430\r\n\tif (!isset($options['descr'])) $options['descr'] = 'category_desc'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f\r\n\tif (!isset($options['id'])) $options['id'] = 'page_id'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f id\r\n\tif (!isset($options['slug'])) $options['slug'] = 'page_slug'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f slug\r\n\tif (!isset($options['menu_order'])) $options['menu_order'] = 'page_menu_order'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f menu_order\r\n\tif (!isset($options['id_parent'])) $options['id_parent'] = 'page_id_parent'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f id_parent\r\n\tif (!isset($options['count'])) $options['count'] = 'count'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432\r\n\tif (!isset($options['prefix'])) $options['prefix'] = 'page/'; // \u043f\u0440\u0435\u0444\u0438\u043a\u0441 \u0434\u043b\u044f \u0441\u0441\u044b\u043b\u043a\u0438\r\n\tif (!isset($options['current_id'])) $options['current_id'] = true; // \u0442\u0435\u043a\u0443\u0449\u0430\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430 \u043e\u0442\u043c\u0435\u0447\u0430\u0435\u0442\u0441\u044f \u043f\u043e page_id - \u0438\u043d\u0430\u0447\u0435 \u043f\u043e \u0442\u0435\u043a\u0443\u0449\u0435\u043c\u0443 url\r\n\tif (!isset($options['childs'])) $options['childs'] = 'childs'; // \u043f\u043e\u043b\u0435 \u0434\u043b\u044f \u043c\u0430\u0441\u0441\u0438\u0432\u0430 \u0434\u0435\u0442\u0435\u0439\r\n\r\n\t// \u0435\u0441\u043b\u0438 true, \u0442\u043e \u0433\u043b\u0430\u0432\u043d\u0430\u044f \u0440\u0430\u0431\u0440\u0438\u043a\u0430 \u0432\u044b\u0432\u043e\u0434\u0438\u0442\u0441\u044f \u0431\u0435\u0437 \u0441\u0441\u044b\u043b\u043a\u0438 \u0432 <span> \r\n\tif (!isset($options['group_header_no_link'])) $options['group_header_no_link'] = false;\r\n\r\n\t// \u0444\u0443\u043d\u043a\u0446\u0438\u044f, \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u0441\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u043d\u0430 [FUNCTION]\r\n\t// \u044d\u0442\u0430 \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 \u0432 \u043a\u0430\u0447\u0435\u0441\u0442\u0432\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u0430 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u043c\u0430\u0441\u0441\u0438\u0432 $elem\r\n\tif (!isset($options['function'])) $options['function'] = false;\r\n\r\n\t// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u043f\u0440\u043e\u0441\u0442\u043e \u0441\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u044e\u0442 \u0432 \u0442\u0435\u043b\u0435 \u0446\u0438\u043a\u043b\u0430 \u2014 \r\n\t// \u043f\u0440\u0438\u043d\u0438\u043c\u0430\u0435\u0442 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u044d\u043b\u0435\u043c\u0435\u043d\u0442, \u0432\u044b\u0445\u043e\u0434\u043d\u0443\u044e \u0441\u0442\u0440\u043e\u0447\u043a\u0443 \u0438 \u043e\u043f\u0446\u0438\u044e function1_data\r\n\tif (!isset($options['function1'])) $options['function1'] = false;\r\n\tif (!isset($options['function1_data'])) $options['function1_data'] = [];\r\n\r\n\tif (!isset($options['nofollow']) or !$options['nofollow'])\r\n\t\t$options['nofollow'] = ''; // \u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u0442\u044c rel=\"nofollow\" \u0434\u043b\u044f \u0441\u0441\u044b\u043b\u043e\u043a\r\n\telse\r\n\t\t$options['nofollow'] = ' rel=\"nofollow\"';\r\n\r\n\t$class_child = $class_child_style = $class_ul = $class_ul_style = '';\r\n\t$class_current = $class_current_style = $class_li = $class_li_style = '';\r\n\r\n\t// [LEVEL] - \u0437\u0430\u043c\u0435\u043d\u044f\u0435\u0442\u0441\u044f \u043d\u0430 level-\u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u043e\u0441\u0442\u0438\r\n\tif ($options['class_child']) $class_child = ' class=\"' . $options['class_child'] . ' [LEVEL]\"';\r\n\r\n\t$class_child = str_replace('[LEVEL]', 'level' . $level, $class_child);\r\n\r\n\tif ($options['class_child_style'])\r\n\t\t$class_child_style = ' style=\"' . $options['class_child_style'] . '\"';\r\n\r\n\tif ($options['class_ul'])\r\n\t\t$class_ul = ' class=\"' . $options['class_ul'] . '\"';\r\n\r\n\tif ($options['class_ul_style'])\r\n\t\t$class_ul_style = ' style=\"' . $options['class_ul_style'] . '\"';\r\n\r\n\tif ($options['class_current'])\r\n\t\t$class_current = ' class=\"' . $options['class_current'] . '\"';\r\n\r\n\tif ($options['class_current_style'])\r\n\t\t$class_current_style = ' style=\"' . $options['class_current_style'] . '\"';\r\n\r\n\tif ($options['class_li'])\r\n\t\t$class_li = ' class=\"' . $options['class_li'] . ' group\"';\r\n\telse\r\n\t\t$class_li = ' class=\"group\"';\r\n\r\n\tif ($options['class_li_style']) $class_li_style = ' style=\"' . $options['class_li_style'] . '\"';\r\n\r\n\tif ($child)\r\n\t\t$out = NR . '\t<ul' . $class_child . $class_child_style . '>';\r\n\telse\r\n\t\t$out = NR . '<ul' . $class_ul . $class_ul_style . '>';\r\n\r\n\t$current_url = getinfo('siteurl') . mso_current_url(); // \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0443\u0440\u043b\r\n\r\n\t// \u0438\u0437 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0443 \u043d\u0443\u0436\u043d\u043e \u0443\u0431\u0440\u0430\u0442\u044c \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u044e\r\n\t$current_url = str_replace('/next/' . mso_current_paged(), '', $current_url);\r\n\r\n\tforeach ($a as $elem) {\r\n\t\t$title = $elem[$options['title']];\r\n\t\t$elem_slug = mso_strip($elem[$options['link']]); // slug \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430\r\n\r\n\t\t$url = getinfo('siteurl') . $options['prefix'] . $elem_slug;\r\n\r\n\t\t// \u0435\u0441\u043b\u0438 \u044d\u0442\u043e page, \u0442\u043e \u043d\u0443\u0436\u043d\u043e \u043f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0432\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u0435 \u044d\u0442\u043e\u0439 \u0437\u0430\u043f\u0438\u0441\u0438 \u0432 \u044d\u043b\u0435\u043c\u0435\u043d\u0442 \u0440\u0443\u0431\u0440\u0438\u043a\u0438 \r\n\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c, \u0442\u043e \u0441\u0442\u0430\u0432\u0438\u043c css-\u043a\u043b\u0430\u0441\u0441 curent-page-cat\r\n\t\t$curent_page_cat_class = is_page_cat($elem_slug, false, false) ? ' class=\"curent-page-cat\"' : '';\r\n\r\n\t\t$link = '<a' . $options['nofollow'] . ' href=\"' . $url . '\" title=\"' . htmlspecialchars($title) . '\"' . $curent_page_cat_class . '>';\r\n\r\n\t\tif (isset($elem[$options['descr']]))\r\n\t\t\t$descr = $elem[$options['descr']];\r\n\t\telse\r\n\t\t\t$descr = '';\r\n\r\n\t\tif (isset($elem[$options['count']]))\r\n\t\t\t$count = $elem[$options['count']];\r\n\t\telse\r\n\t\t\t$count = '';\r\n\r\n\t\tif (isset($elem[$options['id']]))\r\n\t\t\t$id = $elem[$options['id']];\r\n\t\telse\r\n\t\t\t$id = '';\r\n\r\n\t\tif (isset($elem[$options['slug']]))\r\n\t\t\t$slug = $elem[$options['slug']];\r\n\t\telse\r\n\t\t\t$slug = '';\r\n\r\n\t\tif (isset($elem[$options['menu_order']]))\r\n\t\t\t$menu_order = $elem[$options['menu_order']];\r\n\t\telse\r\n\t\t\t$menu_order = '';\r\n\r\n\t\tif (isset($elem[$options['id_parent']]))\r\n\t\t\t$id_parent = $elem[$options['id_parent']];\r\n\t\telse\r\n\t\t\t$id_parent = '';\r\n\r\n\t\t$cur = false;\r\n\r\n\t\tif ($options['current_id']) // \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u043c \u043f\u043e id \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\t\t{\r\n\t\t\tif (isset($elem['current'])) {\r\n\t\t\t\t$e = $options['format_current'];\r\n\t\t\t\t$cur = true;\r\n\t\t\t} else {\r\n\t\t\t\t$e = $options['format'];\r\n\t\t\t}\r\n\t\t} else // \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u043c \u043f\u043e \u0443\u0440\u043b\u0443\r\n\t\t{\r\n\t\t\tif ($url == $current_url) {\r\n\t\t\t\t$e = $options['format_current'];\r\n\t\t\t\t$cur = true;\r\n\t\t\t} else {\r\n\t\t\t\t$e = $options['format'];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$e = str_replace('[LINK]', $link, $e);\r\n\t\t$e = str_replace('[/LINK]', '</a>', $e);\r\n\t\t$e = str_replace('[TITLE]', $title, $e);\r\n\t\t$e = str_replace('[TITLE_HTML]', htmlspecialchars($title), $e);\r\n\t\t$e = str_replace('[DESCR]', $descr, $e);\r\n\t\t$e = str_replace('[DESCR_HTML]', htmlspecialchars($descr), $e);\r\n\t\t$e = str_replace('[ID]', $id, $e);\r\n\t\t$e = str_replace('[SLUG]', $slug, $e);\r\n\t\t$e = str_replace('[SLUG_HTML]', htmlspecialchars($slug), $e);\r\n\t\t$e = str_replace('[MENU_ORDER]', $menu_order, $e);\r\n\t\t$e = str_replace('[ID_PARENT]', $id_parent, $e);\r\n\t\t$e = str_replace('[COUNT]', $count, $e);\r\n\t\t$e = str_replace('[URL]', $url, $e);\r\n\r\n\t\tif ($options['function'] and function_exists($options['function'])) {\r\n\t\t\t$function = $options['function']($elem);\r\n\t\t\t$e = str_replace('[FUNCTION]', $function, $e);\r\n\t\t} else {\r\n\t\t\t$e = str_replace('[FUNCTION]', '', $e);\r\n\t\t}\r\n\r\n\t\tif ($options['function1'] and function_exists($options['function1'])) {\r\n\t\t\t$e = $options['function1']($e, $elem, $options['function1_data']);\r\n\t\t}\r\n\r\n\t\tif (isset($elem[$options['childs']])) {\r\n\r\n\t\t\tif ($cur) {\r\n\t\t\t\t$out .= NR . '<li' . $class_current . $class_current_style . '>' . $e;\r\n\t\t\t} else {\r\n\t\t\t\tif ($options['group_header_no_link'])\r\n\t\t\t\t\t$out .= NR . '<li' . $class_li . $class_li_style . '><span class=\"group_header\">' . $title . '</span>';\r\n\t\t\t\telse\r\n\t\t\t\t\t$out .= NR . '<li' . $class_li . $class_li_style . '>' . $e;\r\n\t\t\t}\r\n\r\n\t\t\t++$level;\r\n\t\t\t$out .= mso_create_list($elem[$options['childs']], $options, true);\r\n\t\t\t--$level;\r\n\r\n\t\t\t$out .= NR . '</li>';\r\n\t\t} else {\r\n\t\t\tif ($child)\r\n\t\t\t\t$out .= NR . '\t';\r\n\t\t\telse\r\n\t\t\t\t$out .= NR;\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u043d\u0435\u0442 \u0434\u0435\u0442\u0435\u0439, \u0442\u043e \u0443\u0431\u0435\u0440\u0435\u043c \u043a\u043b\u0430\u0441\u0441 group\r\n\t\t\t$class_li_1 = str_replace('group', '', $class_li);\r\n\r\n\t\t\tif ($cur)\r\n\t\t\t\t$out .= '<li' . $class_current . $class_current_style . '>' . $e . '</li>';\r\n\t\t\telse\r\n\t\t\t\t$out .= '<li' . $class_li_1 . $class_li_style . '>' . $e . '</li>';\r\n\t\t}\r\n\t}\r\n\r\n\tif ($child)\r\n\t\t$out .= NR . '\t</ul>' . NR;\r\n\telse\r\n\t\t$out .= NR . '</ul>' . NR;\r\n\r\n\t$out = str_replace('<li class=\"\">', '<li>', $out);\r\n\r\n\treturn $out;\r\n}\r\n\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 rss \u0432 <link rel...>\r\n// \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446 \u0438 \u0440\u0443\u0431\u0440\u0438\u043a \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u044e\u0442\u0441\u044f \u0441\u0432\u043e\u0438 RSS\r\nfunction mso_rss()\r\n{\r\n\tglobal $MSO;\r\n\r\n\t$out = '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t. tf('\u0412\u0441\u0435 \u043d\u043e\u0432\u044b\u0435 \u0437\u0430\u043f\u0438\u0441\u0438') . '\" href=\"'\r\n\t\t. getinfo('rss_url') . '\">' . NR;\r\n\r\n\t$out .= '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t. tf('\u0412\u0441\u0435 \u043d\u043e\u0432\u044b\u0435 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438') . '\" href=\"'\r\n\t\t. getinfo('rss_comments_url') . '\">';\r\n\r\n\tif (is_type('page') and mso_segment(2) and (isset($MSO->data['pages_is']) and $MSO->data['pages_is'])) {\r\n\t\t$out .= NR . '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t\t. tf('\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438 \u044d\u0442\u043e\u0439 \u0437\u0430\u043f\u0438\u0441\u0438') . '\" href=\"'\r\n\t\t\t. getinfo('site_url') . mso_segment(1) . '/' . mso_segment(2) . '/feed\">';\r\n\t} elseif (is_type('category') and mso_segment(2) and (isset($MSO->data['pages_is']) and $MSO->data['pages_is'])) {\r\n\t\t$out .= NR . '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t\t. tf('\u0417\u0430\u043f\u0438\u0441\u0438 \u044d\u0442\u043e\u0439 \u0440\u0443\u0431\u0440\u0438\u043a\u0438') . '\" href=\"'\r\n\t\t\t. getinfo('site_url') . mso_segment(1) . '/' . mso_segment(2) . '/feed\">';\r\n\t}\r\n\r\n\treturn $out;\r\n}\r\n\r\n// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442 <link rel=\"$REL\" $ADD>\r\n// $rel - \u0442\u0438\u043f rel. \u0415\u0441\u043b\u0438 \u043e\u043d \u0440\u0430\u0432\u0435\u043d canonical, \u0442\u043e \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442\u0441\u044f \u043a\u0430\u043d\u043e\u043d\u0438\u0437\u0430\u0446\u0438\u044f\r\n// http://www.google.com/support/webmasters/bin/answer.py?answer=139066&hl=ru\r\n// <link rel=\"canonical\" href=\"http://www.example.com/page/about\">\r\nfunction mso_link_rel($rel = 'canonical', $add = '', $url_only = false)\r\n{\r\n\tif (!$rel) return; // \u043f\u0443\u0441\u0442\u043e\u0439 \u0442\u0438\u043f\r\n\r\n\tif ($rel == 'canonical') {\r\n\t\t\r\n\t\t// \u0441\u0432\u043e\u0439 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\r\n\t\t// \u0435\u0441\u043b\u0438 \u0445\u0443\u043a \u0432\u0435\u0440\u043d\u0443\u043b false \u0438\u043b\u0438 '', \u0442\u043e \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u043f\u0440\u043e\u0434\u043e\u043b\u0436\u0430\u0435\u0442\u0441\u044f \u0434\u0430\u043b\u044c\u0448\u0435\r\n\t\t// \u0438\u043d\u0430\u0447\u0435 \u0445\u0443\u043a \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 url \u0438 \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442 \u0435\u0433\u043e \u0432\u044b\u0432\u043e\u0434\r\n\t\tif (mso_hook_present('canonicalUrl')) { \r\n\t\t\t$rh = mso_hook('canonicalUrl');\r\n\t\t\t\r\n\t\t\tif ($rh) return '<link rel=\"canonical\" href=\"' . $rh . '\">';\r\n\t\t}\r\n\t\t\r\n\t\tif ($add) {\r\n\t\t\treturn '<link rel=\"canonical\" ' . $add . '>';\r\n\t\t} else {\r\n\t\t\t// \u0434\u043b\u044f \u0440\u0430\u0437\u043d\u044b\u0445 \u0442\u0438\u043f\u043e\u0432 \u0434\u0430\u043d\u043d\u044b\u0445 \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u043c \u0440\u0430\u0437\u043d\u044b\u0439 \u043a\u0430\u043d\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u0430\u0434\u0440\u0435\u0441\r\n\t\t\t// \u043e\u043d \u043d\u0430\u043f\u0440\u044f\u043c\u0443\u044e \u0437\u0430\u0432\u0438\u0441\u0438\u0442 \u043e\u0442 \u0442\u0438\u043f\u0430\r\n\t\t\t$url = '';\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u0445\u0443\u043a canonical, \u0442\u043e \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u043c \u0435\u0433\u043e\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0445\u0443\u043a \u0432\u0435\u0440\u043d\u0443\u043b \u043a\u0430\u043a\u043e\u0435-\u0442\u043e \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435, \u0442\u043e \u044d\u0442\u043e $url\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u043d\u0435\u0442, \u0442\u043e \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u043c \u0442\u0438\u043f\u043e\u0432\u043e\u0435 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043a\u0430\u043d\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430\r\n\t\t\tif (mso_hook_present('canonical')) $url = mso_hook('canonical');\r\n\r\n\t\t\tif (!$url) {\r\n\t\t\t\tif (\r\n\t\t\t\t\tis_type('page')\r\n\t\t\t\t\tor is_type('category')\r\n\t\t\t\t\tor is_type('tag')\r\n\t\t\t\t\tor is_type('author')\r\n\t\t\t\t\tor is_type('users')\r\n\t\t\t\t\tor (mso_segment(1) == 'sitemap')\r\n\t\t\t\t\tor (mso_segment(1) == 'contact')\r\n\t\t\t\t) {\r\n\t\t\t\t\tif (mso_segment(2)) {\r\n\t\t\t\t\t\t$url = getinfo('site_url') . mso_segment(1) . '/' . urlencode(mso_segment(2));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t$url = getinfo('site_url') . mso_segment(1);\r\n\t\t\t\t\t}\r\n\t\t\t\t} elseif (is_type('home')) {\r\n\t\t\t\t\t$url = getinfo('site_url');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u044f\r\n\t\t\tif (($cur = mso_current_paged()) > 1) {\r\n\t\t\t\tif (is_type('home')) {\r\n\t\t\t\t\t$url .= 'home/next/' . $cur;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif ($url) $url .= '/next/' . $cur;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ($url) {\r\n\t\t\t\tif ($url_only)\r\n\t\t\t\t\treturn $url;\r\n\t\t\t\telse\r\n\t\t\t\t\treturn '<link rel=\"canonical\" href=\"' . $url . '\">';\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tif ($add) return '<link rel=\"' . $rel . '\" ' . $add . '>';\r\n\t}\r\n}\r\n\r\n/**\r\n * \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 TITLE, meta: description, keywords\r\n * $info: \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u0434\u0438\u043d \u0438\u0437 \u0432\u0430\u0440\u0438\u0430\u043d\u0442\u043e\u0432: title, description, keywords\r\n * $args: \u0432\u0445\u043e\u0434\u044f\u0449\u0438\u0439 \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442 \u0434\u0430\u043d\u043d\u044b\u0445, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 $pages (\u0437\u0430\u043f\u0438\u0441\u0438)\r\n * $format: \u0444\u043e\u0440\u043c\u0430\u0442 \u0432\u044b\u0432\u043e\u0434\u0430. \u0417\u0430\u043c\u0435\u043d\u044b \u0434\u043b\u044f: \r\n *          %title%, %page_title%, %category_name%, %category_desc%, %users_nik%, || (\u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c) \r\n * $sep: \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c\r\n * $only_meta == true \u2014 \u0432\u044b\u0432\u043e\u0434 \u0442\u043e\u043b\u044c\u043a\u043e meta-\u0434\u0430\u043d\u043d\u044b\u0445\r\n * $add_pag == true \u2014 \u0434\u043e\u0431\u0430\u0432\u043a\u0430 \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u0438 (\u0438\u0437 \u043e\u043f\u0446\u0438\u0438 title_pagination)\r\n * \r\n */\r\nfunction mso_head_meta($info = 'title', $args = '', $format = '%page_title%', $sep = '', $only_meta = false, $add_pag = true)\r\n{\r\n\tglobal $MSO;\r\n\r\n\t// \u0432\u044b\u044f\u0432\u043b\u044f\u0435\u043c \u043e\u0448\u0438\u0431\u043e\u0447\u043d\u044b\u0439 info\r\n\tif ($info != 'title' and $info != 'description' and $info != 'keywords') return '';\r\n\r\n\tif (mso_hook_present('head_meta')) {\r\n\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u0445\u0443\u043a\u0438, \u0442\u043e \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u0435\u0440\u0435\u0434\u0430\u0435\u043c \u0438\u043c\r\n\t\treturn mso_hook('head_meta', array('info' => $info, 'args' => $args, 'format' => $format, 'sep' => $sep, 'only_meta' => $only_meta));\r\n\t}\r\n\r\n\t// \u0434\u043e\u0431\u0430\u0432\u043a\u0430 \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u0438 \u043d\u0430 \u043e\u0441\u043d\u043e\u0432\u0435 \u043e\u043f\u0446\u0438\u0438 title_pagination \u0438 \u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f TITLE\r\n\t$pag = '';\r\n\r\n\tif ($add_pag and $info == 'title' and ($cur = mso_current_paged()) > 1 and $onum = mso_get_option('title_pagination', 'general', t(' - \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430 [NUM]'))) {\r\n\t\t$pag = htmlspecialchars(str_replace('[NUM]', $cur, $onum));\r\n\t}\r\n\r\n\t// \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u043d\u044b\u0439 \u0434\u043b\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0442\u0438\u0442\u043b\u0435 \u0445\u0440\u0430\u043d\u0438\u0442\u0441\u044f \u0432 $MSO->title description \u0438\u043b\u0438 keywords\r\n\tif (!$args) // \u043d\u0435\u0442 \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442\u0430 - \u0432\u044b\u0432\u043e\u0434\u0438\u043c \u0447\u0442\u043e \u0435\u0441\u0442\u044c\r\n\t{\r\n\t\tif (!$MSO->$info)\r\n\t\t\t$out = $MSO->$info = getinfo($info) . $pag;\r\n\t\telse\r\n\t\t\t$out = $MSO->$info;\r\n\t} else // \u0435\u0441\u0442\u044c \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442\u044b/\u0437\u0430\u043f\u0438\u0441\u0438\r\n\t{\r\n\t\tif (is_scalar($args)) {\r\n\t\t\t$out = $args . $pag; // \u043a\u0430\u043a\u0430\u044f-\u0442\u043e \u044f\u0432\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 - \u043e\u0442\u0434\u0430\u0435\u043c \u0435\u0451 \u043a\u0430\u043a \u0435\u0441\u0442\u044c\r\n\t\t} else // \u0432\u0445\u043e\u0434\u043d\u043e\u0439 \u043c\u0430\u0441\u0441\u0438\u0432 - \u0441\u043a\u043e\u0440\u0435\u0435 \u0432\u0441\u0435\u0433\u043e \u044d\u0442\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430\r\n\t\t{\r\n\t\t\t// %page_title% %title% %category_name%\r\n\t\t\t// || \u044d\u0442\u043e \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 = $sep\r\n\t\t\t// pr($args);\r\n\r\n\t\t\t$category_name = '';\r\n\t\t\t$category_desc = '';\r\n\t\t\t$page_title = '';\r\n\t\t\t$users_nik = '';\r\n\t\t\t$title = getinfo($info);\r\n\r\n\t\t\tif (isset($args[0]['page_categories_detail'])) {\r\n\t\t\t\t$slug = is_type('category') ? mso_segment(2) : '';\r\n\r\n\t\t\t\tforeach ($args[0]['page_categories_detail'] as $id => $val) {\r\n\t\t\t\t\tif ($slug == $val['category_slug']) {\r\n\t\t\t\t\t\t$category_name = $val['category_name'];\r\n\t\t\t\t\t\t$category_desc = $val['category_desc'];\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (isset($args[0]['page_title'])) $page_title = $args[0]['page_title'];\r\n\t\t\tif (isset($args[0]['users_nik']))  $users_nik = $args[0]['users_nik'];\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u043c\u0435\u0442\u0430, \u0442\u043e \u0431\u0435\u0440\u0435\u043c \u0435\u0451\r\n\t\t\tif (isset($args[0]['page_meta'][$info][0]) and $args[0]['page_meta'][$info][0]) {\r\n\t\t\t\tif ($only_meta)\r\n\t\t\t\t\t$category_name = $category_desc = $title = $sep = '';\r\n\r\n\t\t\t\t$page_title = $args[0]['page_meta'][$info][0];\r\n\r\n\t\t\t\tif ($info != 'title') $title = $page_title;\r\n\t\t\t} else {\r\n\t\t\t\t// \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b \u0435\u0441\u043b\u0438 \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u044b \u0441\u0432\u043e\u0438 keywords, \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u0443\u043a\u0430\u0437\u0430\u0442\u044c \u0438\u0437 \u043c\u0435\u0442\u043e\u043a\r\n\t\t\t\tif ($info == 'keywords' and is_type('page') and isset($args[0]['page_meta']['tags']) and $args[0]['page_meta']['tags']) {\r\n\t\t\t\t\t$page_title = implode(', ', $args[0]['page_meta']['tags']); // \u0440\u0430\u0437\u0431\u0438\u0432\u0430\u0435\u043c \u043c\u0430\u0441\u0441\u0438\u0432 \u043c\u0435\u0442\u043e\u043a \u0432 \u0441\u0442\u0440\u043e\u043a\u0443\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446, \u0435\u0441\u043b\u0438 \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d description \u0432\u044b\u0442\u044f\u0433\u0438\u0432\u0430\u0435\u043c \u0435\u0433\u043e \u0438\u0437 \u0441\u0430\u043c\u043e\u0433\u043e \u0442\u0435\u043a\u0441\u0442\u0430\r\n\t\t\t\tif ($info == 'description' and is_type('page') and $w = mso_get_option('description_of_page', 'general', 50)) {\r\n\t\t\t\t\t// \u0432\u043e\u043e\u0431\u0449\u0435 \u043d\u0435\u0442 \u043f\u043e\u043b\u044f\r\n\t\t\t\t\tif (!isset($args[0]['page_meta']['description'][0])) $d = 333;\r\n\r\n\t\t\t\t\t// \u043f\u043e\u043b\u0435 \u0435\u0441\u0442\u044c, \u043d\u043e \u043e\u043d\u043e \u043f\u0443\u0441\u0442\u043e\u0435\r\n\t\t\t\t\tif (isset($args[0]['page_meta']['description'][0]) and !$args[0]['page_meta']['description'][0]) $d = 333;\r\n\r\n\t\t\t\t\tif ($d == 333) // \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u043f\u0440\u0438\u0437\u043d\u0430\u043a\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$t = strip_tags($args[0]['page_content']);\r\n\t\t\t\t\t\t$t = trim(str_replace(\"\\r\", \"\", $t));\r\n\t\t\t\t\t\t$t = trim(str_replace(\"\\n\", ' ', $t));\r\n\t\t\t\t\t\t$t = trim(str_replace(\"\\t\", ' ', $t));\r\n\t\t\t\t\t\t$t = trim(str_replace('   ', ' ', $t));\r\n\t\t\t\t\t\t$t = trim(str_replace('  ', ' ', $t));\r\n\r\n\t\t\t\t\t\t$page_title = mso_str_word($t, $w);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t$arr_key = ['%title%', '%page_title%', '%category_name%', '%category_desc%', '%users_nik%', '||'];\r\n\r\n\t\t\t$arr_val = [htmlspecialchars($title), htmlspecialchars($page_title), htmlspecialchars($category_name), htmlspecialchars($category_desc), htmlspecialchars($users_nik), $sep];\r\n\r\n\t\t\t$out = str_replace($arr_key, $arr_val, $format) . $pag;\r\n\t\t}\r\n\t}\r\n\r\n\t// \u043e\u0442\u0434\u0430\u0435\u043c \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442, \u0441\u0440\u0430\u0437\u0443 \u0436\u0435 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u044f \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u043d\u044b\u0439 $info \u0432 $MSO\r\n\t$out = $MSO->$info = trim($out);\r\n\r\n\treturn $out;\r\n}\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442 <style> \u0438\u0437 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430 \r\n// \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0434\u0443\u0431\u043b\u0438 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0439\r\nfunction mso_load_style($url = '', $nodouble = true)\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif (!isset($MSO->data['_loaded_style'])) $MSO->data['_loaded_style'] = [];\r\n\tif ($nodouble and in_array($url, $MSO->data['_loaded_style'])) return ''; // \u0443\u0436\u0435 \u0431\u044b\u043b\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430\r\n\r\n\t$MSO->data['_loaded_style'][] = $url; // \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u0432 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d\u043d\u044b\u0445\r\n\t$MSO->data['_loaded_style'] = array_unique($MSO->data['_loaded_style']);\r\n\r\n\treturn '<link rel=\"stylesheet\" href=\"' . $url . '\">';\r\n}\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442 <script> \u0438\u0437 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430\r\n// \u0435\u0441\u043b\u0438 \u0441\u043a\u0440\u0438\u043f\u0442 \u0431\u044b\u043b \u0443\u0436\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d, \u0435\u0433\u043e \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u0435\u0442\u0441\u044f\r\nfunction mso_load_script($url = '', $nodouble = true, $attr = '')\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif (!isset($MSO->data['_loaded_script'])) $MSO->data['_loaded_script'] = [];\r\n\tif ($nodouble and in_array($url, $MSO->data['_loaded_script'])) return ''; // \u0443\u0436\u0435 \u0431\u044b\u043b\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430\r\n\r\n\t$MSO->data['_loaded_script'][] = $url; // \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u0432 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d\u043d\u044b\u0445\r\n\t$MSO->data['_loaded_script'] = array_unique($MSO->data['_loaded_script']);\r\n\r\n\t$attr = ($attr) ? ' ' . $attr : '';\r\n\r\n\treturn '<script' . $attr . ' src=\"' . $url . '\"></script>';\r\n}\r\n\r\n/**\r\n * \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 <script> \u0441 \u0432\u043d\u0435\u0448\u043d\u0438\u043c js-\u0444\u0430\u0439\u043b\u043e\u043c \u0438\u043b\u0438\r\n * \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 <link rel=\"stylesheet> \u0441 \u0432\u043d\u0435\u0448\u043d\u0438\u043c css-\u0444\u0430\u0439\u043b\u043e\u043c\r\n * \u0438\u043c\u044f \u0444\u0430\u0439\u043b\u0430 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u043a\u0430\u0442\u0430\u043b\u043e\u0433\u0430 \u0448\u0430\u0431\u043b\u043e\u043d\u0430\r\n * \u0435\u0441\u043b\u0438 \u0444\u0430\u0439\u043b\u0430 \u043d\u0435\u0442, \u0442\u043e \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442\r\n * \u0435\u0441\u043b\u0438 $lazy == true, \u0442\u043e \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430 \u0431\u0443\u0434\u0435\u0442 \u0432 \u043a\u043e\u043d\u0446\u0435 BODY \u043f\u043e \u0445\u0443\u043a\u0443 mso_hook('body_end')\r\n * \u0435\u0441\u043b\u0438 $auto_dir = __DIR__ \u0442\u043e \u043f\u0443\u0442\u044c \u0431\u0443\u0434\u0435\u0442 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u043a\u0430\u0442\u0430\u043b\u043e\u0433\u0430 \u0438\u0441\u043f\u043e\u043b\u043d\u044f\u0435\u043c\u043e\u0433\u043e php-\u0444\u0430\u0439\u043b\u0430\r\n *   \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440: component/header/header.php:\r\n *\t \u0441 $auto_dir\r\n *     mso_add_file('js/my.js', false, __DIR__); // component/header/js/my.js\r\n *\r\n *   \u0438\u043b\u0438 \u043d\u0443\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u043f\u0443\u0442\u044c \u043a \u0444\u0430\u0439\u043b\u0443:\r\n *      mso_add_file('component/header/js/my.js');\r\n *\r\n * $js_attr \u2014 \u0430\u0442\u0440\u0438\u0431\u0443\u0442 \u0434\u043b\u044f js-\u0441\u043a\u0440\u0438\u043f\u0442\u0430, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 'async'\r\n * \r\n */\r\nfunction mso_add_file($fn, $lazy = false, $auto_dir = false, $js_attr = '')\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif ($auto_dir) {\r\n\t\t$fn = str_replace(str_replace('\\\\', '/', getinfo('template_dir')), '', str_replace('\\\\', '/', $auto_dir)) . '/' . $fn;\r\n\t}\r\n\r\n\tif (file_exists(getinfo('template_dir') . $fn)) {\r\n\t\t$ext = strtolower(substr(strrchr($fn, '.'), 1)); // \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430\r\n\r\n\t\t$out = '';\r\n\r\n\t\tif ($ext == 'js')\r\n\t\t\t$out = mso_load_script(getinfo('template_url') . $fn, true, $js_attr);\r\n\t\telseif ($ext == 'css')\r\n\t\t\t$out = mso_load_style(getinfo('template_url') . $fn);\r\n\r\n\t\tif (!$lazy) {\r\n\t\t\techo $out;\r\n\t\t} elseif ($out) {\r\n\t\t\t// \u0432\u044b\u0432\u043e\u0434 \u0447\u0435\u0440\u0435\u0437 \u0445\u0443\u043a body_end \u2014 mso_add_file_body_end()\r\n\t\t\tif (!isset($MSO->data['add_file_to_body_end'])) $MSO->data['add_file_to_body_end'] = [];\r\n\t\t\t\r\n\t\t\t$MSO->data['add_file_to_body_end'][] = $out;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u043a \u0445\u0443\u043a\u0443 body_end \u043f\u043e \u043a\u043e\u0442\u043e\u0440\u043e\u0439 \u0432\u044b\u0432\u043e\u0434\u044f\u0442\u0441\u044f \u0432\u0441\u0435 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u043d\u044b\u0435 \u0444\u0430\u0439\u043b\u044b \u0447\u0435\u0440\u0435\u0437 mso_add_file(\u0444\u0430\u0439\u043b, true)\r\n * Lazy-\u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0432 \u043a\u043e\u043d\u0446\u0435 BODY\r\n */\r\nfunction mso_add_file_body_end($a)\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif (!isset($MSO->data['add_file_to_body_end']) or !$MSO->data['add_file_to_body_end'])\r\n\t\treturn $a;\r\n\r\n\techo implode($MSO->data['add_file_to_body_end']);\r\n\r\n\treturn $a;\r\n}\r\n\r\n/**\r\n *  \u0441\u0436\u0430\u0442\u0438\u0435 HTML\r\n * \r\n *  @param $text \u0432\u0445\u043e\u0434\u043d\u043e\u0439 \u0442\u0435\u043a\u0441\u0442\r\n *  @return string\r\n */\r\nfunction mso_compress_text($text)\r\n{\r\n\t// \u0437\u0430\u0449\u0438\u0449\u0435\u043d\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442\r\n\t$text = preg_replace_callback('!(<pre.*?>)(.*?)(</pre>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<code.*?>)(.*?)(</code>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<script.*?>)(.*?)(</script>)!is', '_mso_protect_script', $text);\r\n\t$text = preg_replace_callback('!(<style.*?>)(.*?)(</style>)!is', '_mso_protect_script', $text);\r\n\r\n\t// \u0441\u0436\u0430\u0442\u0438\u0435\r\n\t$text = str_replace(\"\\r\", \"\", $text);\r\n\t$text = str_replace(\"\\t\", ' ', $text);\r\n\t$text = str_replace(\"\\n   \", \"\\n\", $text);\r\n\t$text = str_replace(\"\\n  \", \"\\n\", $text);\r\n\t$text = str_replace(\"\\n \", \"\\n\", $text);\r\n\t$text = str_replace(\"\\n\", '', $text);\r\n\t$text = str_replace('   ', ' ', $text);\r\n\t$text = str_replace('  ', ' ', $text);\r\n\r\n\t// \u0441\u043f\u0435\u0446\u0438\u0444\u0438\u0447\u043d\u044b\u0435 \u0437\u0430\u043c\u0435\u043d\u044b\r\n\t$text = str_replace('<!---->', '', $text);\r\n\t$text = str_replace('>    <', '><', $text);\r\n\t$text = str_replace('>   <', '><', $text);\r\n\t$text = str_replace('>  <', '><', $text);\r\n\r\n\t$text = preg_replace_callback('!\\[html_base64\\](.*?)\\[\\/html_base64\\]!is', function ($m) {\r\n\t\treturn base64_decode($m[1]);\r\n\t}, $text);\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n *  \u0437\u0430\u043c\u0435\u043d\u044f\u0435\u0442 \u0432 \u0442\u0435\u043a\u0441\u0442\u0435 \u0432\u0441\u0435 \u0432\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u044f http:// \u0438 https:// \u043d\u0430 // \r\n *  \r\n *  @param $text \u0442\u0435\u043a\u0441\u0442\r\n *  @return string\r\n */\r\nfunction mso_remove_protocol($text)\r\n{\r\n\t// \u0437\u0430\u0449\u0438\u0449\u0435\u043d\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442\r\n\t$text = preg_replace_callback('!(<pre.*?>)(.*?)(</pre>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<code.*?>)(.*?)(</code>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<script.*?>)(.*?)(</script>)!is', '_mso_protect_script', $text);\r\n\t$text = preg_replace_callback('!(<style.*?>)(.*?)(</style>)!is', '_mso_protect_script', $text);\r\n\t$text = preg_replace_callback('!(<textarea.*?>)(.*?)(</textarea>)!is', '_mso_protect_script', $text);\r\n\r\n\t$text = str_replace('https://', '//', $text);\r\n\t$text = str_replace('http://', '//', $text);\r\n\r\n\t$text = preg_replace_callback('!\\[html_base64\\](.*?)\\[\\/html_base64\\]!is', function ($m) {\r\n\t\treturn base64_decode($m[1]);\r\n\t}, $text);\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n *  pre, \u043a\u043e\u0442\u043e\u0440\u043e\u0435 \u0437\u0430\u0433\u043e\u043d\u044f\u0435\u0442\u0441\u044f \u0432 [html_base64]\r\n *  callback\r\n * \r\n *  @param $matches matches\r\n *  @return string\r\n */\r\nfunction _mso_protect_pre($matches)\r\n{\r\n\t$text = trim($matches[2]);\r\n\r\n\t$text = str_replace('<p>', '', $text);\r\n\t$text = str_replace('</p>', '', $text);\r\n\t$text = str_replace('[', '&#91;', $text);\r\n\t$text = str_replace(']', '&#93;', $text);\r\n\t$text = str_replace(\"<br>\", \"\\n\", $text);\r\n\t$text = str_replace(\"<br />\", \"<br>\", $text);\r\n\t$text = str_replace(\"<br/>\", \"<br>\", $text);\r\n\t$text = str_replace(\"<br>\", \"\\n\", $text);\r\n\r\n\t$text = str_replace('<', '&lt;', $text);\r\n\t$text = str_replace('>', '&gt;', $text);\r\n\t$text = str_replace('&lt;pre', '<pre', $text);\r\n\t$text = str_replace('&lt;/pre', '</pre', $text);\r\n\t$text = str_replace('pre&gt;', 'pre>', $text);\r\n\r\n\t$text = $matches[1] . \"\\n\" . '[html_base64]' . base64_encode($text) . '[/html_base64]' . $matches[3];\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n *  script \u0438 style, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0437\u0430\u0433\u043e\u043d\u044f\u044e\u0442\u0441\u044f \u0432 [html_base64]\r\n *  callback\r\n * \r\n *  @param $matches matches\r\n *  @return string\r\n */\r\nfunction _mso_protect_script($matches)\r\n{\r\n\t$text = trim($matches[2]);\r\n\t$text = $matches[1] . '[html_base64]' . base64_encode($text) . '[/html_base64]' . $matches[3];\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n * \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 css \u0438\u0437 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0444\u0430\u0439\u043b\u0430\r\n * \u0432 css-\u0444\u0430\u0439\u043b\u0435 \u043c\u043e\u0436\u043d\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c php\r\n * \u043e\u0441\u0443\u0449\u0435\u0441\u0442\u0432\u043b\u044f\u0435\u0442\u0441\u044f \u0441\u0436\u0430\u0442\u0438\u0435 css\r\n * \u0430\u0432\u0442\u043e\u0437\u0430\u043c\u0435\u043d\u0430 [TEMPLATE_URL] \u043d\u0430 url-\u0448\u0430\u0431\u043b\u043e\u043d\u0430\r\n * \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u0441\u0442\u0438\u043b\u0438, \u0431\u0435\u0437 \u043e\u0431\u0440\u0430\u043c\u043b\u044f\u044e\u0449\u0435\u0433\u043e <style>\r\n * \u0415\u0441\u043b\u0438 <style> \u043d\u0443\u0436\u043d\u044b, \u0442\u043e $tag_style = true\r\n * \u0415\u0441\u043b\u0438 \u043d\u0443\u0436\u0435\u043d \u0441\u0440\u0430\u0437\u0443 \u0432\u044b\u0432\u043e\u0434 \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440, \u0442\u043e $echo = true\r\n * \r\n * @param string $fn \u0438\u043c\u044f \u0444\u0430\u0439\u043b\u0430\r\n * @param type $tag_style \u0444\u043b\u0430\u0433 \u0434\u043b\u044f \u043e\u0431\u0440\u0430\u043c\u043b\u0435\u043d\u0438\u044f \u0432 STYLE\r\n * @param type $echo \u0444\u043b\u0430\u0433 \u0432\u044b\u0432\u043e\u0434\u0430 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u0430 \u043f\u043e echo\r\n * @return string\r\n */\r\nfunction mso_out_css_file($fn, $tag_style = true, $echo = true)\r\n{\r\n\t$fn = getinfo('template_dir') . $fn;\r\n\r\n\t$out = '';\r\n\r\n\tif (file_exists($fn)) {\r\n\t\tif ($r = @file_get_contents($fn)) $out .= $r . NR; // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u0435\r\n\r\n\t\tif ($out) {\r\n\t\t\tob_start();\r\n\t\t\teval('?>' . stripslashes($out) . '<?php ');\r\n\t\t\t$out = ob_get_contents();\r\n\t\t\tob_end_clean();\r\n\r\n\t\t\t$out = str_replace('[TEMPLATE_URL]', getinfo('template_url'), $out);\r\n\t\t\t$out = str_replace(array(\"\\r\\n\", \"\\r\", \"\\n\", \"\\t\", '  ', '    ', '    '), '', $out);\r\n\t\t\t$out = str_replace(array('; ', ' {', ': ', ', '), array(';', '{', ':', ','), $out);\r\n\t\t}\r\n\r\n\t\tif ($tag_style) $out = '<style>' . $out . '</style>';\r\n\t\tif ($echo) echo $out;\r\n\t}\r\n\r\n\treturn $out;\r\n}\r\n\r\n# end of file\r\n", "<?php if (!defined('BASEPATH')) exit('No direct script access allowed');\r\n/**\r\n * MaxSite CMS\r\n * (c) https://max-3000.com/\r\n * \r\n */\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u0443 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n// http://localhost/admin/users/edit/1\r\n// mso_segment(3) -> edit\r\n// \u043d\u043e\u043c\u0435\u0440 \u0441\u0447\u0438\u0442\u0430\u0435\u0442\u0441\u044f \u043e\u0442 home-\u0441\u0430\u0439\u0442\u0430\r\n// \u0435\u0441\u043b\u0438 \u0432 \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u0435 \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u0441\u044f XSS \u0438 $die = true, \u0442\u043e \u0440\u0443\u0431\u0438\u043c \u0432\u0441\u0435\r\n// \u043c\u043e\u0436\u043d\u043e \u043f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u0432 \u0441\u0432\u043e\u0451\u043c \u043c\u0430\u0441\u0441\u0438\u0432\u0435 $my_segments\r\nfunction mso_segment($segment = 2, $die = true, $my_segments = false)\r\n{\r\n\tglobal $MSO;\r\n\r\n\t$CI = &get_instance();\r\n\r\n\tif ($my_segments === false) $my_segments = $MSO->data['uri_segment'];\r\n\r\n\tif (count($my_segments) > ($segment - 1))\r\n\t\t$seg = $my_segments[$segment];\r\n\telse\r\n\t\t$seg = '';\r\n\r\n\t$seg = urldecode($seg);\r\n\r\n\t// $url = $CI->input->xss_clean($seg); // ci < 2\r\n\t$url = $CI->security->xss_clean($seg, false);\r\n\r\n\tif ($url != $seg and $die) die('<b><font color=\"red\">Achtung! XSS attack!</font></b>');\r\n\r\n\treturn $url;\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0442\u0435\u043a\u0443\u0449\u0438\u0445 \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u043e\u0432 url \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n// \u0432 \u043e\u0442\u043b\u0438\u0447\u0438\u0435 \u043e\u0442 CodeIgniter - \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442 \u0430\u043d\u0430\u043b\u0438\u0437 get \u0438 \u043e\u0442\u0441\u0435\u043a\u0430\u043d\u0438\u0435 \u0434\u043e \u00ab?\u00bb\r\n// \u0435\u0441\u043b\u0438 \u00ab?\u00bb \u043d\u0435\u0442, \u0442\u043e \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0441\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u043e\u0435 $this->uri->segment_array();\r\nfunction mso_segment_array()\r\n{\r\n\t$CI = &get_instance();\r\n\r\n\tif (isset($_SERVER['REQUEST_URI']) and $_SERVER['REQUEST_URI']) {\r\n\t\t// http://localhost/page/privet?get=hello\r\n\t\t$url = getinfo('site_protocol');\r\n\t\t$url .= $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];\r\n\t\t$url = str_replace($CI->config->config['base_url'], '', $url); // page/privet?get=hello\r\n\r\n\t\tif (strpos($url, '?') !== FALSE) {\r\n\t\t\t// \u0435\u0441\u0442\u044c \u00ab?\u00bb\r\n\t\t\t$url = explode('?', $url); // \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u043c \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n\t\t\t$url = $url[0]; // \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u044b - \u044d\u0442\u043e \u0442\u043e\u043b\u044c\u043a\u043e \u043f\u0435\u0440\u0432\u0430\u044f \u0447\u0430\u0441\u0442\u044c\r\n\t\t\t$url = explode('/', $url); // \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u043c \u0432 \u043c\u0430\u0441\u0441\u0438\u0432 \u043f\u043e /\r\n\r\n\t\t\t// \u043d\u0443\u0436\u043d\u043e \u0438\u0437\u043c\u0435\u043d\u0438\u0442\u044c \u043d\u0443\u043c\u0435\u0440\u0430\u0446\u0438\u044e - \u043d\u0430\u0447\u0430\u043b\u043e \u0441 1\r\n\t\t\t$out = [];\r\n\t\t\t$i = 1;\r\n\t\t\t\r\n\t\t\tforeach ($url as $val) {\r\n\t\t\t\tif ($val) {\r\n\t\t\t\t\t$out[$i] = $val;\r\n\t\t\t\t\t$i++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn $out;\r\n\t\t} else {\r\n\t\t\treturn $CI->uri->segment_array();\r\n\t\t}\r\n\t} else {\r\n\t\treturn $CI->uri->segment_array();\r\n\t}\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 get-\u0441\u0442\u0440\u043e\u043a\u0438 \u0438\u0437 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430\r\nfunction mso_url_get()\r\n{\r\n\t$CI = &get_instance();\r\n\tif (isset($_SERVER['REQUEST_URI']) and $_SERVER['REQUEST_URI'] and (strpos($_SERVER['REQUEST_URI'], '?') !== FALSE)) {\r\n\t\t$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];\r\n\t\t$url = str_replace($CI->config->config['base_url'], \"\", $url);\r\n\t\t$url = explode('?', $url);\r\n\r\n\t\treturn $url[1];\r\n\t} else {\r\n\t\treturn '';\r\n\t}\r\n}\r\n\r\n// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u043e\u0432\u0430\u043d\u0438\u044f get-\u0441\u0442\u0440\u043e\u043a\u0438 \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n// \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u043c\u0430\u0441\u0441\u0438\u0432\u0430 & \u0438\u043b\u0438 &amp;\r\n// \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 \u0441\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u0443\u044e parse_str\r\nfunction mso_parse_url_get($s = '')\r\n{\r\n\tif ($s) {\r\n\t\t$s = str_replace('&amp;', '&', $s);\r\n\t\t$s = explode('&', $s);\r\n\t\t$uri_get_array = [];\r\n\r\n\t\tforeach ($s as $val) {\r\n\t\t\tparse_str($val, $arr);\r\n\r\n\t\t\tforeach ($arr as $key1 => $val1) {\r\n\t\t\t\t$uri_get_array[$key1] = $val1;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn $uri_get_array;\r\n\t} else {\r\n\t\treturn [];\r\n\t}\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0443\u0449\u0443\u044e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u0438\r\n// next - \u043f\u0440\u0438\u0437\u043d\u0430\u043a \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u043f\u043e\u0441\u043b\u0435 \u043a\u043e\u0442\u043e\u0440\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u043e\u043c\u0435\u0440 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\nfunction mso_current_paged($next = 'next')\r\n{\r\n\t// global $MSO;\r\n\r\n\t$uri = mso_current_url(false, true);\r\n\r\n\t// \u044d\u0442\u043e \u0447\u0442\u043e\u0431\u044b \u043d\u0443\u043c\u0435\u0440\u0430\u0446\u0438\u044f \u0441\u043e\u0432\u043f\u0430\u0434\u0430\u043b\u0430 \u0441 $MSO->data['uri_segment'] \u0441 1\r\n\tarray_unshift($uri, '');\r\n\tunset($uri[0]);\r\n\r\n\tif ($n = mso_array_get_key_value($uri, $next)) {\r\n\t\tif (isset($uri[$n + 1]))\r\n\t\t\t$n = (int) $uri[$n + 1];\r\n\t\telse\r\n\t\t\t$n = 1;\r\n\r\n\t\tif ($n > 0)\r\n\t\t\t$current_paged = $n;\r\n\t\telse\r\n\t\t\t$current_paged = 1;\r\n\t} else {\r\n\t\t$current_paged = 1;\r\n\t}\r\n\r\n\treturn $current_paged;\r\n}\r\n\r\n// \u0443\u0432\u0435\u043b\u0438\u0447\u0435\u043d\u0438\u0435 \u0438\u043b\u0438 \u0443\u043c\u0435\u043d\u044c\u0448\u0435\u043d\u0438\u0435 \u0441\u0441\u044b\u043b\u043a\u0438 next \u043d\u0430 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u0443\u044e \u0432\u0435\u043b\u0438\u0447\u0438\u043d\u0443 $inc\r\n// http://site.com/home/next/2 -> +1 -> http://site.com/home/next/3\r\n// $url - \u0438\u0441\u0445\u043e\u0434\u043d\u044b\u0439 \u0430\u0434\u0440\u0435\u0441 (\u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0441\u0430\u0439\u0442\u0430). \u0415\u0441\u043b\u0438 \u0430\u0434\u0440\u0435\u0441 = \u043f\u0443\u0441\u0442\u043e\u0439 \u0441\u0442\u0440\u043e\u043a\u0435, \r\n//\t\u0442\u043e \u0431\u0435\u0440\u0435\u043c mso_current_url \u0415\u0441\u043b\u0438 \u043f\u0435\u0440\u0432\u044b\u0439 \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u043f\u0443\u0441\u0442\u043e\u0439, \u0442\u043e \u044d\u0442\u043e home\r\n// $inc - \u0432\u0435\u043b\u0438\u0447\u0438\u043d\u0430 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f\r\n// $max - \u043c\u0430\u043a\u0441\u0438\u043c\u0443\u043c - \u0435\u0441\u043b\u0438 $inc + \u0442\u0435\u043a\u0443\u0449\u0438\u0439 > $max, \u0442\u043e \u0441\u0442\u0430\u0432\u0438\u0442\u0441\u044f $max. \u0415\u0441\u043b\u0438 $max = false, \u0442\u043e \u043e\u043d \u043d\u0435 \u0443\u0447\u0438\u0442\u044b\u0432\u0430\u0435\u0442\u0441\u044f\r\n// $min - \u043c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u043e\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435\r\n// $next - \u043f\u0440\u0438\u0437\u043d\u0430\u043a \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u043f\u043e\u0441\u043b\u0435 \u043a\u043e\u0442\u043e\u0440\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u043e\u043c\u0435\u0440 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n// $empty_no_range = true - \u043e\u0442\u0434\u0430\u0435\u0442 \u043f\u0443\u0441\u0442\u0443\u044e \u0441\u0442\u0440\u043e\u0447\u043a\u0443, \u0435\u0441\u043b\u0438 \u0442\u0435\u043a\u0443\u0449\u0430\u044f paged \u0431\u0443\u0434\u0435\u0442 \u0440\u0430\u0432\u043d\u0430 \u043a\u043e\u043d\u0435\u0447\u043d\u043e\u0439\r\n// \u0435\u0441\u043b\u0438 $empty_no_range = false, \u0442\u043e \u043e\u0442\u0434\u0430\u0435\u043c \u0441\u0441\u044b\u043b\u043a\u0443 \u043a\u0430\u043a \u043e\u0431\u044b\u0447\u043d\u043e\r\nfunction mso_url_paged_inc($max = false, $inc = 1, $empty_no_range = true, $url = '', $min = 1, $next = 'next')\r\n{\r\n\tif (!$url) $url = mso_current_url();\r\n\r\n\t$current_paged = mso_current_paged($next);\r\n\t$result_paged = $current_paged + $inc;\r\n\r\n\tif ($max) if ($result_paged > $max) $result_paged = $max;\r\n\tif ($result_paged < $min) $result_paged = $min;\r\n\tif ($empty_no_range and $result_paged == $current_paged) return '';\r\n\r\n\t// \u0435\u0441\u043b\u0438 \u043d\u0435\u0442 $url, \u0442\u043e \u044d\u0442\u043e \u0433\u043b\u0430\u0432\u043d\u0430\u044f\r\n\tif (!$url) $url = 'home/' . $next . '/' . $current_paged;\r\n\r\n\tif (strpos($url, $next . '/') === false) // \u043d\u0435\u0442 \u0432\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u044f next/ - \u043d\u0443\u0436\u043d\u043e \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c\r\n\t\t$url .= '/' . $next . '/' . $current_paged;\r\n\r\n\t// \u0435\u0441\u043b\u0438 $result_paged = , \u0442\u043e $min, \u0442\u043e\t$next \u043d\u0435 \u043f\u0438\u0448\u0435\u043c\r\n\tif ($result_paged == $min)\r\n\t\t$url = str_replace($next . '/' . $current_paged, '', $url);\r\n\telse\r\n\t\t$url = str_replace($next . '/' . $current_paged, $next . '/' . $result_paged, $url);\r\n\r\n\t// \u0443\u0434\u0430\u043b\u0438\u043c \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0435 \u0441\u043b\u044d\u0448\u0438\r\n\t$url = trim(str_replace('/', ' ', $url));\r\n\t$url = str_replace(' ', '/', $url);\r\n\r\n\tif ($url == 'home') $url = '';\r\n\r\n\treturn getinfo('siteurl') . $url;\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0435\u0440\u043c\u0430\u043b\u0438\u043d\u043a \u0440\u0443\u0431\u0440\u0438\u043a\u0438 \u043f\u043e \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u043c\u0443 \u0441\u043b\u0430\u0433\u0443\r\nfunction mso_get_permalink_cat_slug($slug = '', $prefix = 'category/')\r\n{\r\n\tif (!$slug) return '';\r\n\r\n\treturn  getinfo('siteurl') . $prefix . $slug;\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0435\u0440\u043c\u0430\u043b\u0438\u043d\u043a \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b \u043f\u043e \u0435\u0451 id \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u043f\u0440\u043e\u0441 \u0411\u0414\r\nfunction mso_get_permalink_page($id = 0, $prefix = 'page/')\r\n{\r\n\tglobal $MSO;\r\n\r\n\t$id = (int) $id;\r\n\tif (!$id) return '';\r\n\r\n\t$CI = &get_instance();\r\n\t$CI->db->select('page_slug, page_id');\r\n\t$CI->db->where(array('page_id' => $id));\r\n\r\n\t$query = $CI->db->get('page');\r\n\r\n\tif ($query->num_rows() > 0) {\r\n\t\tforeach ($query->result_array() as $row) {\r\n\t\t\t$slug = $row['page_slug'];\r\n\t\t}\r\n\r\n\t\treturn  $MSO->config['site_url'] . $prefix . $slug;\r\n\t} else {\r\n\t\treturn '';\r\n\t}\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e url \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0441\u0430\u0439\u0442\u0430\r\n// \u0432\u0435\u0434\u0443\u0449\u0438\u0439 \u0438 \u043a\u043e\u043d\u0435\u0447\u043d\u044b\u0435 \u0441\u043b\u044d\u0448\u0438 \u0443\u0434\u0430\u043b\u044f\u0435\u043c\r\n// \u0435\u0441\u043b\u0438 $absolute = true, \u0442\u043e \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442\u0441\u044f \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0443\u0440\u043b \u043a\u0430\u043a \u0435\u0441\u0442\u044c\r\nfunction mso_current_url($absolute = false, $explode = false, $delete_request = false)\r\n{\r\n\t$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];\r\n\r\n\tif ($delete_request) {\r\n\t\t// \u043e\u0442\u0434\u0435\u043b\u0438\u043c \u043f\u043e \u00ab?\u00bb\r\n\t\t$url = explode('?', $url);\r\n\t\t$url = $url[0];\r\n\t}\r\n\r\n\tif ($absolute) return $url;\r\n\r\n\t$url = str_replace(getinfo('site_url'), '', $url);\r\n\t$url = trim(str_replace('/', ' ', $url));\r\n\t$url = str_replace(' ', '/', $url);\r\n\t$url = urldecode($url);\r\n\r\n\tif ($explode) $url = explode('/', $url);\r\n\r\n\treturn $url;\r\n}\r\n\r\n// \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442 \u043d\u0430 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u0441\u0430\u0439\u0442\u0430. \u043f\u0443\u0442\u044c \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0441\u0430\u0439\u0442\u0430\r\n// \u0435\u0441\u043b\u0438 $absolute = true - \u043f\u0435\u0440\u0435\u0445\u043e\u0434 \u043f\u043e \u0443\u043a\u0430\u0437\u0430\u043d\u043e\u043c\u0443 \u043f\u0443\u0442\u0438\r\n// $header - 301 \u0438\u043b\u0438 302 \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442\r\nfunction mso_redirect($url = '', $absolute = false, $header = false)\r\n{\r\n\t$url = strip_tags($url);\r\n\t$url = str_replace(array('%0d', '%0a'), '', $url);\r\n\r\n\t$url = mso_xss_clean($url);\r\n\r\n\tif ($header == 301) header('HTTP/1.1 301 Moved Permanently');\r\n\telseif ($header == 302) header('HTTP/1.1 302 Found');\r\n\r\n\tif ($absolute) {\r\n\t\theader(\"Refresh: 0; url={$url}\");\r\n\t\theader(\"Location: {$url}\");\r\n\t} else {\r\n\t\t$url = getinfo('site_url') . $url;\r\n\t\theader(\"Refresh: 0; url={$url}\");\r\n\t\theader(\"Location: {$url}\");\r\n\t}\r\n\t\r\n\texit();\r\n}\r\n\r\n# end of file\r\n", "<?php if (!defined('BASEPATH')) exit('No direct script access allowed'); \r\n\r\n/**\r\n * MaxSite CMS\r\n * (c) http://max-3000.com/\r\n */\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0430\u0432\u0442\u043e\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction global_cache_autoload($args = array())\r\n{\r\n\t// \u0438\u0441\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u0438\u0437 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0430\u0434\u0440\u0435\u0441\u0430 \u043f\u043e \u043f\u0435\u0440\u0432\u043e\u043c\u0443 \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u0443\r\n\t$no_cache = array('admin', 'page_404', 'contact', 'logout', 'login', 'registration', 'password-recovery', 'loginform', 'require-maxsite', 'ajax', 'remote', 'dc', 'feed', 'search');\r\n\t\r\n\tif (in_array(mso_segment(1), $no_cache)) return $args;\r\n\t\r\n\t$options = mso_get_option('plugin_global_cache', 'plugins', array());\r\n\t\r\n\t// \u043a\u044d\u0448 \u0432\u043a\u043b\u044e\u0447\u0435\u043d?\r\n\tif (isset($options['on']) and $options['on'])\r\n\t{\r\n\t\t# \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0435\u0441\u043b\u0438 \u0431\u044b\u043b\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 POST\r\n\t\tif ( isset($_POST) and $_POST ) global_cache_all_flush();\r\n\t\t\r\n\t\t# \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u0445\u0443\u043a\u0438, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u044e\u0442 \u0441\u0431\u0440\u043e\u0441\u0438\u0442\u044c \u043a\u044d\u0448 - \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0432 \u043f\u043b\u0430\u0433\u0438\u043d\u0430\u0445 \u0438 \u0442.\u043f.\r\n\t\tmso_hook_add('global_cache_key_flush', 'global_cache_key_flush'); // \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\t\tmso_hook_add('global_cache_all_flush', 'global_cache_all_flush'); // \u0441\u0431\u0440\u043e\u0441 \u0432\u0441\u0435\u0433\u043e html-\u043a\u044d\u0448\u0430\r\n\t\t\r\n\t\t// \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0433\u043b\u0430\u0432\u043d\u0443\u044e\r\n\t\tif (isset($options['home-only']) and $options['home-only'])\r\n\t\t{\r\n\t\t\tif (!is_type('home')) return $args;\r\n\t\t}\r\n\t\t\r\n\t\t// \u0435\u0441\u043b\u0438 \u0437\u0430\u043b\u043e\u0433\u0438\u043d\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u0438 \u0435\u0441\u0442\u044c \u043e\u043f\u0446\u0438\u044f \u0432\u044b\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f, \u0442\u043e \u043e\u0442\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u043a\u044d\u0448\r\n\t\tif ( (isset($options['onlogin']) and $options['onlogin']) and (is_login() or is_login_comuser()))\r\n\t\t{\r\n\t\t\treturn $args;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// \u0441\u0442\u0430\u0432\u0438\u043c \u0445\u0443\u043a\u0438 \u043d\u0430 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\r\n\t\t\tmso_hook_add('global_cache_start', 'global_cache_start');\r\n\t\t\tmso_hook_add('global_cache_end', 'global_cache_end');\r\n\t\t}\r\n\t}\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0434\u0435\u0430\u043a\u0442\u0438\u0432\u0430\u0446\u0438\u0438 (\u0432\u044b\u043a\u043b) \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction global_cache_deactivate($args = array())\r\n{\t\r\n\t// \u043e\u0447\u0438\u0441\u0442\u0438\u0442\u044c html-\u043a\u044d\u0448\r\n\tglobal_cache_all_flush();\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0434\u0435\u0438\u043d\u0441\u0442\u044f\u043b\u044f\u0446\u0438\u0438 \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction global_cache_uninstall($args = array())\r\n{\t\r\n\t// \u043e\u0447\u0438\u0441\u0442\u0438\u0442\u044c html-\u043a\u044d\u0448\r\n\tglobal_cache_all_flush();\r\n\treturn $args;\r\n}\r\n\r\n# \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u043a\u043b\u044e\u0447\r\n# \u0435\u0441\u043b\u0438 $dir = true, \u0442\u043e \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u043a\u0430\u0442\u0430\u043b\u043e\u0433 html\r\nfunction global_cache_key($dir = true)\r\n{\r\n\t$cache_key = $_SERVER['REQUEST_URI'];\r\n\t$cache_key = str_replace('/', '-', $cache_key);\r\n\t$cache_key = mso_slug(' ' . $cache_key);\r\n\t\r\n\tif (!$cache_key) $cache_key = 'home'; // \u0433\u043b\u0430\u0432\u043d\u0430\u044f\r\n\t\r\n\tif ($dir) $cache_key = 'html/' . $cache_key . '.html';\r\n\t\telse $cache_key = $cache_key . '.html';\r\n\t\r\n\treturn $cache_key;\r\n}\r\n\r\n# \u0441\u0442\u0430\u0440\u0442 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f\r\nfunction global_cache_start($arg = array())\r\n{\r\n\tif ( $k = mso_get_cache(global_cache_key(), true) ) \r\n\t{\r\n\t\t// \u0434\u0430 \u0435\u0441\u0442\u044c \u0432 \u043a\u044d\u0448\u0435\r\n\t\t$CI = & get_instance();\t\r\n\t\t$mq = $CI->db->query_count; // \u043a\u043e\u043b\u0432\u043e sql-\u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432\r\n\t\t$k = str_replace('<!--global_cache_footer-->', ' | Cache ON (' . $mq . 'sql)', $k);\r\n\t\techo $k; \r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tob_start();\r\n\treturn false;\r\n}\r\n\r\n# \u0441\u0442\u043e\u043f \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f - \u043e\u0442\u0434\u0430\u0447\u0430 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u0430\r\nfunction global_cache_end($arg = array())\r\n{\r\n\t# \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043a\u0430\u043a POST\r\n\tif ( isset($_POST) and $_POST ) global_cache_key_flush();\r\n\telse \r\n\t{\r\n\t\t$options = mso_get_option('plugin_global_cache', 'plugins', array());\r\n\t\t\r\n\t\tif (!isset($options['time'])) $options['time'] = 15;\r\n\t\t\r\n\t\tmso_add_cache(global_cache_key(), ob_get_flush(), $options['time'] * 60, true);\r\n\t}\r\n}\r\n\r\n# \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\nfunction global_cache_key_flush($arg = array())\r\n{\r\n\tmso_flush_cache(false, 'html', global_cache_key(false));\r\n\treturn $arg;\r\n}\r\n\r\n# \u0441\u0431\u0440\u043e\u0441 \u0432\u0441\u0435\u0433\u043e \u043a\u044d\u0448\u0430 html\r\nfunction global_cache_all_flush($arg = array())\r\n{\r\n\tmso_flush_cache(false, 'html');\r\n\treturn $arg;\r\n}\r\n\r\nfunction global_cache_mso_options() \r\n{\r\n\tif ( !mso_check_allow('global_cache_edit') ) \r\n\t{\r\n\t\techo t('\u0414\u043e\u0441\u0442\u0443\u043f \u0437\u0430\u043f\u0440\u0435\u0449\u0435\u043d');\r\n\t\treturn;\r\n\t}\r\n\r\n\t// \u0441\u0431\u0440\u043e\u0441 \u0432\u0441\u0435\u0433\u043e \u043a\u044d\u0448\u0430\r\n\tif ( $post = mso_check_post(array('f_submit_clear_global_cache', 'f_session_id')) )\r\n\t{\r\n\t\tglobal_cache_all_flush();\r\n\t\techo '<div class=\"update\">'. t('\u041a\u044d\u0448 \u043e\u0447\u0438\u0449\u0435\u043d') . '</div>';\r\n\t}\r\n\r\n\t\r\n\t# \u043a\u043b\u044e\u0447, \u0442\u0438\u043f, \u043a\u043b\u044e\u0447\u0438 \u043c\u0430\u0441\u0441\u0438\u0432\u0430\r\n\tmso_admin_plugin_options('plugin_global_cache', 'plugins', \r\n\t\tarray(\r\n\t\t\r\n\t\t\t'on' => array(\r\n\t\t\t\t\t\t\t'type' => 'checkbox', \r\n\t\t\t\t\t\t\t'name' => t('\u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u043e\u0435 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435'), \r\n\t\t\t\t\t\t\t'description' => '', \r\n\t\t\t\t\t\t\t'default' => 1\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\r\n\t\t\t'home-only' => array(\r\n\t\t\t\t\t\t\t'type' => 'checkbox', \r\n\t\t\t\t\t\t\t'name' => t('\u041a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0433\u043b\u0430\u0432\u043d\u0443\u044e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443'), \r\n\t\t\t\t\t\t\t'description' => '', \r\n\t\t\t\t\t\t\t'default' => 0\r\n\t\t\t\t\t\t),\r\n\t\t\t\r\n\t\t\t'onlogin' => array(\r\n\t\t\t\t\t\t\t'type' => 'checkbox', \r\n\t\t\t\t\t\t\t'name' => t('\u0412\u044b\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u043e\u0435 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0434\u043b\u044f \u0430\u0432\u0442\u043e\u0440\u043e\u0432/\u0430\u0434\u043c\u0438\u043d\u043e\u0432'), \r\n\t\t\t\t\t\t\t'description' => '', \r\n\t\t\t\t\t\t\t'default' => 1\r\n\t\t\t\t\t\t),\r\n\t\t\t\r\n\t\t\t'time' => array(\r\n\t\t\t\t\t\t\t'type' => 'text', \r\n\t\t\t\t\t\t\t'name' => t('\u0412\u0440\u0435\u043c\u044f \u0436\u0438\u0437\u043d\u0438 \u043a\u044d\u0448\u0430 (\u043c\u0438\u043d\u0443\u0442)'), \r\n\t\t\t\t\t\t\t'description' => t('\u0423\u043a\u0430\u0436\u0438\u0442\u0435 \u0432\u0440\u0435\u043c\u044f, \u0447\u0435\u0440\u0435\u0437 \u043a\u043e\u0442\u043e\u0440\u043e\u0435 \u043a\u044d\u0448 \u0443\u0441\u0442\u0430\u0440\u0435\u0435\u0442 \u0438 \u0431\u0443\u0434\u0435\u0442 \u0441\u043e\u0437\u0434\u0430\u043d \u0437\u0430\u043d\u043e\u0432\u043e'), \r\n\t\t\t\t\t\t\t'default' => '15'\r\n\t\t\t\t\t\t),\r\n\t\t\t),\r\n\t\tt('\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u043e\u0433\u043e \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f'), // \u0442\u0438\u0442\u0443\u043b\r\n\t\tt('\u041a\u044d\u0448\u0438\u0440\u0443\u0435\u0442 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b \u0446\u0435\u043b\u0438\u043a\u043e\u043c. \u0412 \u043a\u044d\u0448 \u0431\u0443\u0434\u0435\u0442 \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c\u0441\u044f \u043f\u043e\u043b\u043d\u043e\u0441\u0442\u044c\u044e \u0441\u0433\u0435\u043d\u0435\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b, \u0447\u0442\u043e \u0443\u0441\u043a\u043e\u0440\u044f\u0435\u0442 \u0440\u0430\u0431\u043e\u0442\u0443 \u0441\u0430\u0439\u0442\u0430. \u0420\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u0435\u0442\u0441\u044f \u0434\u043b\u044f \u0441\u0430\u0439\u0442\u043e\u0432 \u0441 \u0431\u043e\u043b\u044c\u0448\u043e\u0439 \u043f\u043e\u0441\u0435\u0449\u0430\u0435\u043c\u043e\u0441\u0442\u044c\u044e. \u0414\u0430\u043d\u043d\u044b\u0439 \u043a\u044d\u0448 \u043c\u043e\u0436\u0435\u0442 \u0437\u0430\u043d\u0438\u043c\u0430\u0442\u044c \u043c\u043d\u043e\u0433\u043e \u043c\u0435\u0441\u0442\u0430 \u043d\u0430 \u0434\u0438\u0441\u043a\u0435.')   // \u0438\u043d\u0444\u043e\r\n\t);\r\n\t\r\n\techo '<form method=\"post\">' . mso_form_session('f_session_id');\r\n\techo '<p><button class=\"button i-stack-overflow\" type=\"submit\" name=\"f_submit_clear_global_cache\">'. t('\u0421\u0431\u0440\u043e\u0441\u0438\u0442\u044c \u043a\u044d\u0448') . '</button></p>';\r\n\techo '</form>';\r\n\t\r\n}\r\n\r\n# end of file", "<?php if (!defined('BASEPATH')) exit('No direct script access allowed'); \r\n\r\n/**\r\n * MaxSite CMS\r\n * (c) http://max-3000.com/\r\n */\r\n\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0430\u0432\u0442\u043e\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction sape_autoload($args = array())\r\n{\r\n\tmso_hook_add( 'init', 'sape_init'); # \u0445\u0443\u043a \u043d\u0430 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044e\r\n\tmso_hook_add( 'admin_init', 'sape_admin_init'); # \u0445\u0443\u043a \u043d\u0430 \u0430\u0434\u043c\u0438\u043d\u043a\u0443\r\n\tmso_register_widget('sape_widget', 'Sape.ru'); # \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0435\u043c \u0432\u0438\u0434\u0436\u0435\u0442\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0430\u043a\u0442\u0438\u0432\u0430\u0446\u0438\u0438 (\u0432\u043a\u043b) \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction sape_activate($args = array())\r\n{\t\r\n\tmso_create_allow('sape_edit', t('\u0410\u0434\u043c\u0438\u043d-\u0434\u043e\u0441\u0442\u0443\u043f \u043a \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044e sape'));\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0434\u0435\u0438\u043d\u0441\u0442\u0430\u043b\u044f\u0446\u0438\u0438 \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction sape_uninstall($args = array())\r\n{\t\r\n\tmso_delete_option_mask('sape_widget_', 'plugins' ); // \u0443\u0434\u0430\u043b\u0438\u043c \u0441\u043e\u0437\u0434\u0430\u043d\u043d\u044b\u0435 \u043e\u043f\u0446\u0438\u0438\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0443\u043a\u0430\u0437\u0430\u043d\u043e\u043c \u0445\u0443\u043a\u0435 admin_init\r\nfunction sape_admin_init($args = array()) \r\n{\r\n\tif ( mso_check_allow('plugin_sape') ) \r\n\t{\r\n\t\t$this_plugin_url = 'plugin_sape'; // url \u0438 hook\r\n\t\tmso_admin_menu_add('plugins', $this_plugin_url, 'Sape.ru');\r\n\t\tmso_admin_url_hook ($this_plugin_url, 'sape_admin_page');\r\n\t}\r\n\t\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u043c\u0430\u044f \u043f\u0440\u0438 \u0445\u0443\u043a\u0435, \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u043c \u0432 mso_admin_url_hook\r\nfunction sape_admin_page($args = array()) \r\n{\r\n\r\n\t# \u0432\u044b\u043d\u043e\u0441\u0438\u043c \u0430\u0434\u043c\u0438\u043d\u0441\u043a\u0438\u0435 \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u043e \u0432 \u0444\u0430\u0439\u043b\r\n\tif ( !mso_check_allow('plugin_sape') ) \r\n\t{\r\n\t\techo '\u0414\u043e\u0441\u0442\u0443\u043f \u0437\u0430\u043f\u0440\u0435\u0449\u0435\u043d';\r\n\t\treturn $args;\r\n\t}\r\n\t# \u0432\u044b\u043d\u043e\u0441\u0438\u043c \u0430\u0434\u043c\u0438\u043d\u0441\u043a\u0438\u0435 \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u043e \u0432 \u0444\u0430\u0439\u043b\r\n\tmso_hook_add_dinamic( 'mso_admin_header', ' return $args . \"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 Sape.ru\"; ' );\r\n\tmso_hook_add_dinamic( 'admin_title', ' return \"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 Sape.ru - \" . $args; ' );\r\n\trequire(getinfo('plugins_dir') . 'sape/admin.php');\r\n}\r\n\r\n\r\n# \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u0441\u0430\u043f\u044b\r\nfunction sape_init($args = array()) \r\n{\r\n\tglobal $SAPE, $SAPE_CONTENT, $SAPE_ARTICLE;\r\n\t\r\n\t$options = mso_get_option('sape', 'plugins', array() ); // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438\r\n\t\r\n\tif (isset($options['kod']) \r\n\t\tand isset($options['go']) and $options['go'] \r\n\t\tand isset($options['start']) and $options['start']) // \u043c\u043e\u0436\u043d\u043e \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0442\u044c\r\n\t{\r\n\t\r\n\t\t// \u0435\u0441\u043b\u0438 \u0432\u043a\u044e\u0447\u0435\u043d \u0430\u043d\u0442\u0438\u0447\u0435\u043a\r\n\t\tif (isset($options['anticheck']) and $options['anticheck'])\r\n\t\t{\r\n\t\t// \u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u043c \u0432\u0445\u043e\u0434\u044f\u0449\u0438\u0439 url \u043d\u0430 \u043f\u0440\u0435\u0434\u043c\u0435\u0442 ?\r\n\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c, \u0442\u043e \u0434\u0435\u043b\u0430\u0435\u043c \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442 \u043d\u0430 \u0442\u043e, \u0447\u0442\u043e \u0434\u043e ?\r\n\t\t\t// \u0442\u0430\u043a\u0438\u043c \u043e\u0431\u0440\u0430\u0437\u043e\u043c \u043e\u0431\u043d\u0430\u0440\u0443\u0436\u0438\u0442\u044c \u043f\u0440\u043e\u0434\u0430\u0436\u043d\u0443\u044e \u0441\u0441\u044b\u043b\u043a\u0443 \u0431\u0443\u0434\u0435\u0442 \u043d\u0435\u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\r\n\t\t\tif (isset($_SERVER['argv']) and $_SERVER['argv']) // \u0435\u0441\u0442\u044c \u043a\u0430\u043a\u0438\u0435-\u0442\u043e \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b - \u0434\u0435\u043b\u0430\u0435\u043c \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442\r\n\t\t\t{\r\n\t\t\t\t$url = $_SERVER['REQUEST_URI']; // /?nono  /about/?momo\r\n\t\t\t\t\r\n\t\t\t\t$url = explode('?', $url);\r\n\t\t\t\tif (isset($url[0])) $url = $url[0];\r\n\t\t\t\telse $url = '';\r\n\t\t\t\t\r\n\t\t\t\t$url = '/' . trim(str_replace('/', ' ', $url));\r\n\t\t\t\t$url = str_replace(' ', '/', $url);\r\n\t\t\t\t$url = 'http://' . $_SERVER['HTTP_HOST'] . $url;\r\n\t\t\t\t\r\n\t\t\t\theader('HTTP/1.1 301 Moved Permanently');\r\n\t\t\t\theader('Location: ' . $url);\r\n\t\t\t\texit;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif ( !defined('_SAPE_USER') ) define('_SAPE_USER', $options['kod']);\r\n\t\t\r\n\t\t// \u0435\u0441\u043b\u0438 \u0444\u0430\u0439\u043b\u0430 \u0441\u0430\u043f\u044b \u043d\u0435\u0442, \u0442\u043e \u0432\u044b\u0445\u043e\u0434\u0438\u043c\r\n\t\tif (!file_exists($_SERVER['DOCUMENT_ROOT'] . '/' . _SAPE_USER . '/sape.php')) return $args;\r\n\t\t\r\n\t\trequire_once($_SERVER['DOCUMENT_ROOT'] . '/' . _SAPE_USER . '/sape.php');\r\n\t\t\r\n\t\t$sa['charset'] = 'UTF-8';\r\n\t\t\r\n\t\t//$sa['fetch_remote_type'] = 'file_get_contents'; // file_get_contents|curl|socket\r\n\t\t\r\n\t\tif (isset($options['test']) and $options['test']) $sa['force_show_code'] = true;\r\n\t\t\r\n\t\tif (isset($options['multi_site']) and $options['multi_site']) $sa['multi_site'] = true;\r\n\r\n\t\t$SAPE = new SAPE_client($sa);\r\n\t\t\r\n\t\tif (isset($options['context']) and $options['context'])\r\n\t\t{\r\n\t\t\tif ( !isset($SAPE_CONTENT) ) $SAPE_CONTENT = new SAPE_context(array('charset' => 'UTF-8'));\r\n\t\t\tmso_hook_add( 'content_content', 'sape_content'); # \u0445\u0443\u043a \u043d\u0430 \u043a\u043e\u043d\u0435\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442 \u0434\u043b\u044f \u0432\u044b\u0432\u043e\u0434\u0430\r\n\t\t\t\r\n\t\t\tif (isset($options['context_comment']) and $options['context_comment'])\r\n\t\t\t\tmso_hook_add( 'comments_content_out', 'sape_content'); \r\n\t\t\t\t# \u0445\u0443\u043a \u043d\u0430 \u043a\u043e\u043d\u0435\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442 \u0434\u043b\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0432 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u044f\u0445\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$SAPE_CONTENT = false;\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\tif (isset($options['articles']) and $options['articles'] )\r\n\t\t{\r\n\t\t\r\n\t\t\tif ( !isset($SAPE_ARTICLE) ) $SAPE_ARTICLE = new SAPE_articles();\r\n\t\t\t\r\n\t\t\t// \u044d\u0442\u043e \u0432\u044b\u0432\u043e\u0434 \u0440\u0435\u043a\u043b\u0430\u043c\u043d\u043e\u0439 \u0441\u0442\u0430\u0442\u044c\u0438\r\n\t\t\tif (isset($options['articles_url']) and mso_segment(1) == $options['articles_url'] )\r\n\t\t\t{\r\n\t\t\t\t# \u0445\u0443\u043a \u0434\u043b\u044f \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043a \u0448\u0430\u0431\u043b\u043e\u043d\u0443\r\n\t\t\t\tmso_hook_add('custom_page_404', 'sape_articles_custom_page_404');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u0438\u043b\u0438 \u0437\u0430\u043f\u0440\u043e\u0441 \u0448\u0430\u0431\u043b\u043e\u043d\u0430 \u043e\u0442 \u0440\u043e\u0431\u043e\u0442\u0430 \u0441\u0430\u043f\u044b\r\n\t\t\tif ( isset($options['articles_template']) and mso_segment(1) == $options['articles_template'] )\r\n\t\t\t{\r\n\t\t\t\t# \u0445\u0443\u043a \u0434\u043b\u044f \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043a \u0448\u0430\u0431\u043b\u043e\u043d\u0443\r\n\t\t\t\tmso_hook_add('custom_page_404', 'sape_articles_template_custom_page_404');\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$SAPE_ARTICLE = false;\r\n\t\t}\r\n\t\t\r\n\t}\r\n\t\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f, \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u0431\u0435\u0440\u0435\u0442 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0438\u0437 \u043e\u043f\u0446\u0438\u0439 \u0432\u0438\u0434\u0436\u0435\u0442\u043e\u0432\r\nfunction sape_widget($num = 1) \r\n{\r\n\t$widget = 'sape_widget_' . $num; // \u0438\u043c\u044f \u0434\u043b\u044f \u043e\u043f\u0446\u0438\u0439 = \u0432\u0438\u0434\u0436\u0435\u0442 + \u043d\u043e\u043c\u0435\u0440\r\n\t$options = mso_get_option($widget, 'plugins', array() ); // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438\r\n\t\r\n\t// \u0437\u0430\u043c\u0435\u043d\u0438\u043c \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a, \u0447\u0442\u043e\u0431\u044b \u0431\u044b\u043b \u0432  h2 class=\"box\"\r\n\tif ( isset($options['header']) and $options['header'] ) $options['header'] = mso_get_val('widget_header_start', '<h2 class=\"box\"><span>') . $options['header'] . mso_get_val('widget_header_end', '</span></h2>');\r\n\t\telse $options['header'] = '';\r\n\t\r\n\treturn sape_widget_custom($options, $num);\r\n}\r\n\r\n\r\n# \u0444\u043e\u0440\u043c\u0430 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0432\u0438\u0434\u0436\u0435\u0442\u0430 \r\n# \u0438\u043c\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u0438 = \u0432\u0438\u0434\u0436\u0435\u0442_form\r\nfunction sape_widget_form($num = 1) \r\n{\r\n\t$widget = 'sape_widget_' . $num; // \u0438\u043c\u044f \u0434\u043b\u044f \u0444\u043e\u0440\u043c\u044b \u0438 \u043e\u043f\u0446\u0438\u0439 = \u0432\u0438\u0434\u0436\u0435\u0442 + \u043d\u043e\u043c\u0435\u0440\r\n\t\r\n\t// \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438 \r\n\t$options = mso_get_option($widget, 'plugins', array());\r\n\t\r\n\tif ( !isset($options['header']) ) $options['header'] = '';\r\n\tif ( !isset($options['count']) ) $options['count'] = '';\r\n\tif ( !isset($options['htmldo']) ) $options['htmldo'] = '';\r\n\tif ( !isset($options['htmlposle']) ) $options['htmlposle'] = '';\r\n\tif ( !isset($options['links_or_articles']) ) $options['links_or_articles'] = 'links';\r\n\t\r\n\t// \u0432\u044b\u0432\u043e\u0434 \u0441\u0430\u043c\u043e\u0439 \u0444\u043e\u0440\u043c\u044b\r\n\t$CI = & get_instance();\r\n\t$CI->load->helper('form');\r\n\t\r\n\t$form = mso_widget_create_form(t('\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a'), form_input( array( 'name'=>$widget . 'header', 'value'=>$options['header'])));\r\n\t\r\n\t$form .= mso_widget_create_form(t('\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0441\u0441\u044b\u043b\u043e\u043a'), form_input( array( 'name'=>$widget . 'count', 'value'=>$options['count'])), t('\u0415\u0441\u043b\u0438 \u044d\u0442\u043e\u0442 \u0432\u0438\u0434\u0436\u0435\u0442 \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u0438\u043b\u0438 \u0435\u0434\u0438\u043d\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0439, \u0442\u043e \u043e\u0441\u0442\u0430\u0432\u044c\u0442\u0435 \u044d\u0442\u043e \u043f\u043e\u043b\u0435 \u043f\u0443\u0441\u0442\u044b\u043c \u0438\u043b\u0438 0'));\r\n\t\r\n\t$form .= mso_widget_create_form(t('HTML \u0434\u043e'), form_input( array( 'name'=>$widget . 'htmldo', 'value'=>$options['htmldo'])), '');\r\n\t\r\n\t$form .= mso_widget_create_form(t('HTML \u043f\u043e\u0441\u043b\u0435'), form_input( array( 'name'=>$widget . 'htmlposle', 'value'=>$options['htmlposle'])), '');\r\n\t\r\n\t$form .= mso_widget_create_form(t('\u0412\u044b\u0432\u043e\u0434\u0438\u0442\u044c'), form_dropdown( $widget . 'links_or_articles', array('links'=>t('\u0421\u0441\u044b\u043b\u043a\u0438'), 'articles'=>t('\u0421\u0442\u0430\u0442\u044c\u0438')), $options['links_or_articles']), '');\r\n\t\r\n\t\r\n\treturn $form;\r\n}\r\n\r\n\r\n# \u0441\u044e\u0434\u0430 \u043f\u0440\u0438\u0445\u043e\u0434\u044f\u0442 POST \u0438\u0437 \u0444\u043e\u0440\u043c\u044b \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0432\u0438\u0434\u0436\u0435\u0442\u0430\r\n# \u0438\u043c\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u0438 = \u0432\u0438\u0434\u0436\u0435\u0442_update\r\nfunction sape_widget_update($num = 1) \r\n{\r\n\t$widget = 'sape_widget_' . $num; // \u0438\u043c\u044f \u0434\u043b\u044f \u043e\u043f\u0446\u0438\u0439 = \u0432\u0438\u0434\u0436\u0435\u0442 + \u043d\u043e\u043c\u0435\u0440\r\n\t\r\n\t// \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438\r\n\t$options = $newoptions = mso_get_option($widget, 'plugins', array());\r\n\t\r\n\t# \u043e\u0431\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u0435\u043c POST\r\n\t$newoptions['header'] = mso_widget_get_post($widget . 'header');\r\n\t$newoptions['count'] = (int) mso_widget_get_post($widget . 'count');\r\n\t$newoptions['htmldo'] = mso_widget_get_post($widget . 'htmldo');\r\n\t$newoptions['htmlposle'] = mso_widget_get_post($widget . 'htmlposle');\r\n\t$newoptions['links_or_articles'] = mso_widget_get_post($widget . 'links_or_articles');\r\n\t\r\n\tif ( $options != $newoptions ) \r\n\t\tmso_add_option($widget, $newoptions, 'plugins' );\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0432\u0438\u0434\u0436\u0435\u0442\u0430\r\nfunction sape_widget_custom($options = array(), $num = 1)\r\n{\r\n\tif ( !isset($options['header']) ) $options['header'] = '';\r\n\tif ( !isset($options['count']) ) $options['count'] = 0;\r\n\tif ( !isset($options['htmldo']) ) $options['htmldo'] = '';\r\n\tif ( !isset($options['htmlposle']) ) $options['htmlposle'] = '';\r\n\tif ( !isset($options['links_or_articles']) ) $options['links_or_articles'] = 'links';\r\n\t\r\n\tif ($options['links_or_articles'] == 'links')\r\n\t{\r\n\t\t$out = sape_out($options['count'] , false); // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u0441\u0441\u044b\u043b\u043a\u0438\r\n\t\t\r\n\t\tif ($out == '<!--check code-->') // \u0432\u0435\u0440\u043d\u0443\u043b\u0441\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043e\u0447\u043d\u044b\u0439 \u043a\u043e\u0434\r\n\t\t{\r\n\t\t\t$out = '<!--check code-->\u041a\u043e\u0434 <a href=\"http://www.sape.ru/r.aa92aef9c6.php\" target=\"_blank\">sape.ru</a> \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d \u0432\u0435\u0440\u043d\u043e!';\r\n\t\t\treturn $out;\r\n\t\t}\r\n\t\telseif ($out and $options['header']) $out = $options['header'] . $options['htmldo'] . $out . $options['htmlposle'];\r\n\t\treturn $out;\r\n\t}\r\n\telseif ($options['links_or_articles'] == 'articles')\r\n\t{\r\n\t\tglobal $SAPE_ARTICLE;\r\n\t\t\r\n\t\t//pr($SAPE_ARTICLE);\r\n\t\t\r\n\t\t$out = $SAPE_ARTICLE->return_announcements();\r\n\t\t\r\n\t\t// \u044d\u0442\u043e \u0447\u0435\u043a\u043a\u043e\u0434\r\n\t\tif ($out == $SAPE_ARTICLE->_data['index']['checkCode'])\r\n\t\t{\r\n\t\t\treturn $out;\r\n\t\t}\r\n\t\t\r\n\t\t$out_check = strip_tags($out); // \u0435\u0441\u0442\u044c \u0442\u0435\u043a\u0441\u0442\u044b\r\n\t\t\r\n\t\tif ($out_check and $options['header']) \r\n\t\t\t$out = $options['header'] . $options['htmldo'] . $out . $options['htmlposle'];\r\n\t\t\r\n\t\treturn $out;\r\n\t}\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0431\u043b\u043e\u043a\u0430 \u0441\u0441\u044b\u043b\u043e\u043a\r\nfunction sape_out($count = 0, $echo = true)\r\n{\r\n\tglobal $SAPE;\r\n\t\r\n\t$out = '';\r\n\t\r\n\tif (isset($SAPE) and $SAPE)\r\n\t{\r\n\t\tif ($count)\r\n\t\t{\r\n\t\t\t$out = $SAPE->return_links($count);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$out = $SAPE->return_links();\r\n\t\t}\r\n\t}\r\n\t\r\n\tif ($echo) echo $out;\r\n\t\telse return $out;\t\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u043a\u043e\u043d\u0442\u0435\u043d\u0442\u0430\r\nfunction sape_content($text = '')\r\n{\r\n\tglobal $SAPE_CONTENT;\r\n\t\r\n\tif ($SAPE_CONTENT)\r\n\t{\r\n\t\t// $text = 'TEXT-DO ' . $SAPE_CONTENT->replace_in_text_segment($text) . ' TEXT-POSLE'; // \u043a\u043e\u043d\u0442\u0440\u043e\u043b\u044c\r\n\t\t$text = $SAPE_CONTENT->replace_in_text_segment($text);\r\n\t}\r\n\t\r\n\treturn $text;\r\n}\r\n\r\n\r\n# \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u0441\u0432\u043e\u0439 \u0444\u0430\u0439\u043b \u043a \u0448\u0430\u0431\u043b\u043e\u043d\u0443\r\nfunction sape_articles_template_custom_page_404($args = false)\r\n{\r\n\trequire( getinfo('plugins_dir') . 'sape/articles_template.php' ); // \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0438\u043b\u0438 \u0441\u0432\u043e\u0439 \u0444\u0430\u0439\u043b \u0432\u044b\u0432\u043e\u0434\u0430\r\n\treturn true; // \u0432\u044b\u0445\u043e\u0434\u0438\u043c \u0441 true\r\n}\r\n\r\nfunction sape_articles_custom_page_404($args = false)\r\n{\r\n\tglobal $SAPE_ARTICLE;\r\n\t\r\n\t// \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u043c http-\u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a\r\n\theader(\"HTTP/1.x 200 OK\", TRUE);\r\n\t\r\n\t// \u0434\u043e\u0431\u0430\u0432\u0438\u043b echo\r\n\techo $SAPE_ARTICLE->process_request();\r\n\r\n\treturn true; // \u0432\u044b\u0445\u043e\u0434\u0438\u043c \u0441 true\r\n}\r\n\r\n\r\n# end of file"], "fixing_code": ["<?php if (!defined('BASEPATH')) exit('No direct script access allowed');\r\n/**\r\n * MaxSite CMS\r\n * (c) https://max-3000.com/\r\n * \r\n */\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u043c \u0441\u043a\u0440\u044b\u0442\u044b\u0439 input \u0434\u043b\u044f \u0444\u043e\u0440\u043c\u044b \u0441 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0435\u0441\u0441\u0438\u0435\u0439\r\nfunction mso_form_session($name_form = 'flogin_session_id')\r\n{\r\n\treturn '<input type=\"hidden\" value=\"' . getinfo('session_id') . '\" name=\"' . $name_form . '\">';\r\n}\r\n\r\n// \u0432\u044b\u0432\u043e\u0434 \u043b\u043e\u0433\u0438\u043d-\u0444\u043e\u0440\u043c\u044b\r\n// \u0432 login_form_auth_title \u0434\u043b\u044f \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u0435\u0439 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442\u0441\u044f \u043a\u043e\u0434 [end] - \u043d\u0443\u0436\u0435\u043d \u0434\u043b\u044f \u0442\u043e\u0433\u043e, \u0447\u0442\u043e\u0431\u044b \u043f\u0435\u0440\u0435\u0447\u0438\u0441\u043b\u044f\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u043f\u044f\u0442\u0443\u044e\r\nfunction mso_login_form($conf = [], $redirect = '', $echo = true)\r\n{\r\n\tif ($redirect == '') $redirect = urlencode(mso_current_url());\r\n\r\n\t// \u0433\u043e\u0442\u043e\u0432\u0438\u043c \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435 \u0434\u043b\u044f \u0444\u0430\u0439\u043b\u0430 \u0448\u0430\u0431\u043b\u043e\u043d\u0438\u0437\u0430\u0442\u043e\u0440\u0430 loginform-common-tmpl.php\r\n\t$login = $conf['login'] ?? '';\r\n\t$password = $conf['password'] ?? '';\r\n\t$submit = $conf['submit'] ?? '';\r\n\t$submit_value = $conf['submit_value'] ?? tf('\u0412\u043e\u0439\u0442\u0438');\r\n\t$submit_end = $conf['submit_end'] ?? '';\r\n\t$form_end = $conf['form_end'] ?? '';\r\n\t$login_add = $conf['login_add'] ?? '';\r\n\t$password_add = $conf['password_add'] ?? '';\r\n\t$tmpl_file = $conf['tmpl_file'] ?? 'type/loginform/units/loginform-common-tmpl.php';\r\n\t$action = getinfo('site_url') . 'login';\r\n\t$session_id = getinfo('session_id');\r\n\r\n\t$login_form_auth_title = $conf['login_form_auth_title'] ?? tf('\u0412\u0445\u043e\u0434 \u0447\u0435\u0440\u0435\u0437:') . ' ';\r\n\r\n\t$hook_login_form_auth = mso_hook_present('login_form_auth') ? '<span class=\"login-form-auth-title\">' . $login_form_auth_title . '</span>' . mso_hook('login_form_auth') : '';\r\n\r\n\tif ($hook_login_form_auth) {\r\n\t\t$hook_login_form_auth = trim(str_replace('[end]', '     ', $hook_login_form_auth));\r\n\t\t$hook_login_form_auth = '<div class=\"login-form-auth\">' . str_replace('     ', ', ', $hook_login_form_auth) . '</div>';\r\n\t}\r\n\r\n\tif ($echo) {\r\n\t\teval(mso_tmpl_ts($tmpl_file));\r\n\t} else {\r\n\t\tob_start();\r\n\t\teval(mso_tmpl_ts($tmpl_file));\r\n\t\t$out = ob_get_contents();\r\n\t\tob_end_clean();\r\n\t\treturn $out;\r\n\t}\r\n}\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u043c li-\u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u0434\u043b\u044f \u043c\u0435\u043d\u044e\r\n// \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u043f\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u043b\u044f\u044e\u0442 \u0441\u043e\u0431\u043e\u0439 \u0442\u0435\u043a\u0441\u0442, \u0433\u0434\u0435 \u043a\u0430\u0436\u0434\u0430\u044f \u0441\u0442\u0440\u043e\u0447\u043a\u0430 \u043e\u0434\u0438\u043d \u043f\u0443\u043d\u043a\u0442\r\n// \u043a\u0430\u0436\u0434\u044b\u0439 \u043f\u0443\u043d\u043a\u0442 \u0434\u0435\u043b\u0430\u0435\u0442\u0441\u044f \u0442\u0430\u043a:  http://\u0441\u0441\u044b\u043b\u043a\u0430 | \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 | \u043f\u043e\u0434\u0441\u043a\u0430\u0437\u043a\u0430 | class | class_\u0434\u043b\u044f_span | \u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044b \u0441\u0441\u044b\u043b\u043a\u0438\r\n// \u043d\u0430 \u0432\u044b\u0445\u043e\u0434\u0435 \u0442\u0430\u043a:\r\n// <li class=\"selected\"><a href=\"url\"><span>\u0441\u0441\u044b\u043b\u043a\u0430</span></a></li>\r\n// \u0435\u0441\u043b\u0438 \u043f\u0435\u0440\u0432\u044b\u0439 \u0441\u0438\u043c\u0432\u043e\u043b [ \u0442\u043e \u044d\u0442\u043e \u043e\u0442\u043a\u0440\u044b\u0432\u0430\u0435\u0442 \u0433\u0440\u0443\u043f\u043f\u0443 ul \r\n// \u0435\u0441\u043b\u0438 ] \u0442\u043e \u0437\u0430\u043a\u0440\u044b\u0432\u0430\u0435\u0442 - \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u043c\u043d\u043e\u0433\u043e\u0443\u0440\u043e\u0432\u043d\u0435\u0432\u044b\u0435 \u043c\u0435\u043d\u044e\r\n// \u0435\u0441\u043b\u0438 \u0430\u0434\u0440\u0435\u0441 \u0440\u0430\u0432\u0435\u043d # \u0442\u043e \u0441\u0441\u044b\u043b\u043a\u0430 \u043d\u0435 \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442\u0441\u044f, \u0442\u043e\u043b\u044c\u043a\u043e \u0442\u0435\u043a\u0441\u0442 <li class=\"\"><span>\u0441\u0441\u044b\u043b\u043a\u0430</span></li>\r\n// \u0435\u0441\u043b\u0438 \u043f\u0443\u043d\u043a\u0442 \u043c\u0435\u043d\u044e \u0440\u0430\u0432\u0435\u043d --- \u0442\u043e \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442\u0441\u044f \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c li.divider \u0418\u043c\u0435\u0435\u0442 \u0441\u043c\u044b\u0441\u043b \u0442\u043e\u043b\u044c\u043a\u043e \u0432 \u043f\u043e\u0434\u043f\u0443\u043d\u043a\u0442\u0430\u0445\r\nfunction mso_menu_build($menu = '', $select_css = 'selected', $add_link_admin = false)\r\n{\r\n\t// \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u0441\u044b\u043b\u043a\u0443 \u043d\u0430 admin\r\n\tif ($add_link_admin and is_login()) $menu .= NR . 'admin|Admin';\r\n\r\n\t$menu = str_replace(\"\\r\", \"\", $menu); // \u0435\u0441\u043b\u0438 \u044d\u0442\u043e windows\r\n\t$menu = str_replace(\"_NR_\", \"\\n\", $menu);\r\n\t$menu = str_replace(\" ~ \", \"\\n\", $menu);\r\n\t$menu = str_replace(\"\\n\\n\\n\", \"\\n\", $menu);\r\n\t$menu = str_replace(\"\\n\\n\", \"\\n\", $menu);\r\n\r\n\t// \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n\t$menu = explode(\"\\n\", trim($menu));\r\n\r\n\t// \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u043c \u043c\u0435\u043d\u044e \u043d\u0430 \u043f\u0440\u0435\u0434\u043c\u0435\u0442 \u043f\u0443\u0441\u0442\u044b\u0445 \u0441\u0442\u0440\u043e\u043a, \u043a\u043e\u0440\u0440\u0435\u043a\u0442\u043d\u043e\u0441\u0442\u0438 \u0438 \u043f\u043e\u0434\u0441\u0447\u0438\u0442\u0430\u0435\u043c \u043a\u043e\u043b-\u0432\u043e \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432\r\n\t$count_menu = 0;\r\n\tforeach ($menu as $elem) {\r\n\t\tif (strlen(trim($elem)) > 1) $count_menu++;\r\n\t}\r\n\r\n\t// \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0438\u043c \u0442\u0435\u043a\u0443\u0449\u0438\u0439 url\r\n\t$current_url = mso_current_url(true);\r\n\t// $current_url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];\r\n\r\n\t$out = '';\r\n\r\n\t$i = 1; // \u043d\u043e\u043c\u0435\u0440 \u043f\u0443\u043d\u043a\u0442\u0430\r\n\t$n = 0; // \u043d\u043e\u043c\u0435\u0440 \u0438\u0442\u0435\u0440\u0430\u0446\u0438\u0438 \u0446\u0438\u043a\u043b\u0430 \r\n\r\n\t$group_in = false;\r\n\t$group_in_first = false;\r\n\t$group_num = 0; // \u043d\u043e\u043c\u0435\u0440 \u0433\u0440\u0443\u043f\u043f\u044b\r\n\t$group_work = false; // \u043e\u0442\u043a\u0440\u044b\u0442\u0430\u044f \u0433\u0440\u0443\u043f\u043f\u0430?\r\n\t$selected_present = false; // \u0435\u0441\u0442\u044c \u043b\u0438 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u044b\u0439 \u043f\u0443\u043d\u043a\u0442?\r\n\t$group_elem = 0; // \u044d\u043b\u0435\u043c\u0435\u043d\u0442 \u0432 \u0433\u0440\u0443\u043f\u043f\u0435\r\n\r\n\tforeach ($menu as $elem) {\r\n\t\t// \u0440\u0430\u0437\u043e\u0431\u044a\u0435\u043c \u0441\u0442\u0440\u043e\u0447\u043a\u0443 \u043f\u043e \u0430\u0434\u0440\u0435\u0441 | \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435\r\n\t\t$elem = explode('|', trim($elem));\r\n\r\n\t\t// \u0434\u043e\u043b\u0436\u043d\u043e \u0431\u044b\u0442\u044c \u0434\u0432\u0430 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430\r\n\t\tif (count($elem) > 1) {\r\n\t\t\t$url = trim($elem[0]);  // \u0430\u0434\u0440\u0435\u0441\r\n\t\t\t$name = trim($elem[1]); // \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435\r\n\r\n\t\t\tif (isset($elem[2]))\r\n\t\t\t\t$title = ' title=\"' . htmlspecialchars(trim($elem[2])) . '\"';\r\n\t\t\telse\r\n\t\t\t\t$title = '';\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0430\u0434\u0440\u0435\u0441 = ## \u0442\u043e \u043d\u0435 \u0432\u044b\u0432\u043e\u0434\u0438\u043c \u0441\u0441\u044b\u043b\u043a\u0443\r\n\t\t\t$a_link = ($url != '##');\r\n\r\n\t\t\t// \u043d\u0435\u0442 \u0432 \u0430\u0434\u0440\u0435\u0441\u0435 http:// - \u0437\u043d\u0430\u0447\u0438\u0442 \u044d\u0442\u043e \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0441\u0430\u0439\u0442\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u043d\u0430\u0447\u0438\u043d\u0430\u0435\u0442\u0441\u044f \u0441 # \u0438\u043b\u0438  ? \u2014 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0434\u0435\u043b\u0430\u0435\u043c\r\n\t\t\tif (\r\n\t\t\t\t($url != '#')\r\n\t\t\t\tand strpos($url, '#') !== 0\r\n\t\t\t\tand strpos($url, '?') !== 0\r\n\t\t\t\tand strpos($url, 'http://') === false\r\n\t\t\t\tand strpos($url, 'https://') === false\r\n\t\t\t) {\r\n\t\t\t\tif ($url == '/')\r\n\t\t\t\t\t$url = getinfo('siteurl'); // \u044d\u0442\u043e \u0433\u043b\u0430\u0432\u043d\u0430\u044f\r\n\t\t\t\telse\r\n\t\t\t\t\t$url = getinfo('siteurl') . $url;\r\n\t\t\t}\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0430\u0434\u0440\u0435\u0441 \u0441\u043e\u0432\u043f\u0430\u043b, \u0437\u043d\u0430\u0447\u0438\u0442 \u043c\u044b \u043d\u0430 \u044d\u0442\u043e\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0435\r\n\t\t\tif ($url == $current_url) {\r\n\t\t\t\t$class = ' ' . $select_css;\r\n\t\t\t\t$selected_present = true;\r\n\t\t\t} else {\r\n\t\t\t\t$class = '';\r\n\t\t\t}\r\n\r\n\t\t\t// \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u043d css-\u043a\u043b\u0430\u0441\u0441\r\n\t\t\tif (isset($elem[3])) $class .= ' ' . trim($elem[3]);\r\n\r\n\t\t\t// \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u043d class_\u0434\u043b\u044f_span\r\n\t\t\tif (isset($elem[4]))\r\n\t\t\t\t$class_span = ' class=\"' . trim($elem[4]) . '\"';\r\n\t\t\telse\r\n\t\t\t\t$class_span = '';\r\n\r\n\t\t\t// \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u043d \u0430\u0442\u0440\u0438\u0431\u0443\u0442_\u0434\u043b\u044f_\u0441\u0441\u044b\u043b\u043a\u0438\r\n\t\t\t$link_attr = (isset($elem[5])) ? ' ' . trim($elem[5]) : '';\r\n\r\n\t\t\t// \u0434\u043b\u044f \u043f\u0435\u0440\u0432\u043e\u0433\u043e \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u043a\u043b\u0430\u0441\u0441 first\r\n\t\t\tif ($i == 1) $class .= ' first';\r\n\r\n\t\t\tif ($group_in_first) {\r\n\t\t\t\t$class .= ' group-first';\r\n\t\t\t\t$group_in_first = false;\r\n\t\t\t}\r\n\r\n\t\t\t// \u0434\u043b\u044f \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0435\u0433\u043e \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430 \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u043a\u043b\u0430\u0441\u0441 last\r\n\t\t\tif ($i == $count_menu) $class .= ' last';\r\n\r\n\t\t\tif ($class == ' ') $class = '';\r\n\r\n\t\t\tif ($group_in) {\r\n\t\t\t\t// \u043e\u0442\u043a\u0440\u044b\u0432\u0430\u0435\u043c \u0433\u0440\u0443\u043f\u043f\u0443\r\n\t\t\t\t$group_num++;\r\n\t\t\t\t$class .= ' group-num-' . $group_num;\r\n\r\n\t\t\t\tif ($a_link) {\r\n\t\t\t\t\t$out .= '<li class=\"group' . $class . '\"><a href=\"' . $url . '\"' . $title . $link_attr . '><span' . $class_span . '>' . $name . '</span></a><ul>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$out .= '<li class=\"group' . $class . '\"><span' . $class_span . '>' . $name . '</span><ul>';\r\n\t\t\t\t}\r\n\r\n\t\t\t\t$group_in = false;\r\n\t\t\t\t$group_in_first = true;\r\n\t\t\t} else {\r\n\t\t\t\tif ($group_elem > 0 and array_key_exists($i, $menu) and isset($menu[$n + 1]) and trim($menu[$n + 1]) == ']') $class .= ' group-last';\r\n\r\n\t\t\t\tif ($a_link) {\r\n\t\t\t\t\t$out .= '<li class=\"' . trim($class) . '\"><a href=\"' . $url . '\"' . $title  . $link_attr . '><span' . $class_span . '>' . $name . '</span></a></li>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$out .= '<li class=\"' . trim($class) . '\"><span' . $class_span . '>' . $name . '</span></li>';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ($url == $current_url and $group_work) {\r\n\t\t\t\t// \u0432\u044b\u0434\u0435\u043b\u044f\u0435\u043c \u0440\u043e\u0434\u0438\u0442\u0435\u043b\u044f \u0433\u0440\u0443\u043f\u043f\u044b, \u0435\u0441\u043b\u0438 \u0432 \u043d\u0435\u0439 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u043d\u044b\u0439 \u043f\u043e\u0434\u043f\u0443\u043d\u043a\u0442\r\n\t\t\t\t$out = str_replace('group-num-' . $group_num, 'group-num-' . $group_num . ' group-selected', $out);\r\n\t\t\t\t$selected_present = true;\r\n\t\t\t}\r\n\r\n\t\t\t$i++;\r\n\t\t\t$group_elem++;\r\n\t\t} else {\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u044d\u0442\u043e [, \u0442\u043e \u044d\u0442\u043e \u043d\u0430\u0447\u0430\u043b\u043e \u0433\u0440\u0443\u043f\u043f\u044b ul \r\n\t\t\t// \u0435\u0441\u043b\u0438 ] \u0442\u043e /ul\r\n\r\n\t\t\tif ($elem[0] == '[') {\r\n\t\t\t\t$group_in = true;\r\n\t\t\t\t$group_work = true;\r\n\t\t\t\t$group_elem = 0;\r\n\t\t\t}\r\n\r\n\t\t\tif ($elem[0] == ']') {\r\n\t\t\t\t$group_elem = 0;\r\n\t\t\t\t$group_in = false;\r\n\t\t\t\t$group_work = false;\r\n\t\t\t\t$out .= '</ul></li>';\r\n\t\t\t}\r\n\r\n\t\t\tif ($elem[0] == '---') {\r\n\t\t\t\t// \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c\r\n\t\t\t\t$out .= '<li class=\"divider\"><span></span></li>';\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$n++;\r\n\t}\r\n\r\n\t$out = str_replace('<li class=\"\">', '<li>', $out);\r\n\r\n\t// \u0435\u0441\u043b\u0438 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0432\u044b\u0434\u0435\u043b\u0435\u043d\u043e, \u0442\u043e \u0434\u043b\u044f \u043f\u0435\u0440\u0432\u043e\u0439 \u0433\u0440\u0443\u043f\u043f\u044b \u043f\u0440\u043e\u043f\u0438\u0441\u044b\u0432\u0430\u0435\u043c \u043a\u043b\u0430\u0441\u0441 group-default\r\n\tif (!$selected_present)\r\n\t\t$out = str_replace('group-num-1', 'group-num-1 group-default', $out);\r\n\r\n\t//pr($out, 1);\r\n\treturn $out;\r\n}\r\n\r\n// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u043e\u0441\u0442\u0440\u043e\u0435\u043d\u0438\u044f \u0438\u0437 \u043c\u0430\u0441\u0441\u0438\u0432\u043e\u0432 \u0441\u043f\u0438\u0441\u043a\u0430 UL\r\n// \u0432\u0445\u043e\u0434 - \u043c\u0430\u0441\u0441\u0438\u0432 \u0438\u0437 \u0441 [childs]=>array(...)\r\nfunction mso_create_list($a = [], $options = [], $child = false)\r\n{\r\n\tstatic $level = 0;\r\n\r\n\tif (!$a) return '';\r\n\r\n\tif (!isset($options['class_ul'])) $options['class_ul'] = ''; // \u043a\u043b\u0430\u0441\u0441 UL\r\n\tif (!isset($options['class_ul_style'])) $options['class_ul_style'] = ''; // \u0441\u0432\u043e\u0439 \u0441\u0442\u0438\u043b\u044c \u0434\u043b\u044f UL\r\n\tif (!isset($options['class_child'])) $options['class_child'] = 'child'; // \u043a\u043b\u0430\u0441\u0441 \u0434\u043b\u044f \u0440\u0435\u0431\u0435\u043d\u043a\u0430\r\n\tif (!isset($options['class_child_style'])) $options['class_child_style'] = ''; // \u0441\u0432\u043e\u0439 \u0441\u0442\u0438\u043b\u044c \u0434\u043b\u044f \u0440\u0435\u0431\u0435\u043d\u043a\u0430\r\n\tif (!isset($options['class_current'])) $options['class_current'] = 'current-page'; // \u043a\u043b\u0430\u0441\u0441 li \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\tif (!isset($options['class_current_style'])) $options['class_current_style'] = ''; // \u0441\u0442\u0438\u043b\u044c li \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\tif (!isset($options['class_li'])) $options['class_li'] = ''; // \u043a\u043b\u0430\u0441\u0441 LI\r\n\tif (!isset($options['class_li_style'])) $options['class_li_style'] = ''; // \u0441\u0442\u0438\u043b\u044c LI\r\n\tif (!isset($options['format'])) $options['format'] = '[LINK][TITLE][/LINK]'; // \u0444\u043e\u0440\u043c\u0430\u0442 \u0441\u0441\u044b\u043b\u043a\u0438\r\n\tif (!isset($options['format_current'])) $options['format_current'] = '<span>[TITLE]</span>'; // \u0444\u043e\u0440\u043c\u0430\u0442 \u0434\u043b\u044f \u0442\u0435\u043a\u0443\u0449\u0435\u0439\r\n\tif (!isset($options['title'])) $options['title'] = 'page_title'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u0442\u0438\u0442\u0443\u043b\u0430\r\n\tif (!isset($options['link'])) $options['link'] = 'page_slug'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u0441\u043b\u0430\u0433\u0430\r\n\tif (!isset($options['descr'])) $options['descr'] = 'category_desc'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u044f\r\n\tif (!isset($options['id'])) $options['id'] = 'page_id'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f id\r\n\tif (!isset($options['slug'])) $options['slug'] = 'page_slug'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f slug\r\n\tif (!isset($options['menu_order'])) $options['menu_order'] = 'page_menu_order'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f menu_order\r\n\tif (!isset($options['id_parent'])) $options['id_parent'] = 'page_id_parent'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f id_parent\r\n\tif (!isset($options['count'])) $options['count'] = 'count'; // \u0438\u043c\u044f \u043a\u043b\u044e\u0447\u0430 \u0434\u043b\u044f \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432\r\n\tif (!isset($options['prefix'])) $options['prefix'] = 'page/'; // \u043f\u0440\u0435\u0444\u0438\u043a\u0441 \u0434\u043b\u044f \u0441\u0441\u044b\u043b\u043a\u0438\r\n\tif (!isset($options['current_id'])) $options['current_id'] = true; // \u0442\u0435\u043a\u0443\u0449\u0430\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430 \u043e\u0442\u043c\u0435\u0447\u0430\u0435\u0442\u0441\u044f \u043f\u043e page_id - \u0438\u043d\u0430\u0447\u0435 \u043f\u043e \u0442\u0435\u043a\u0443\u0449\u0435\u043c\u0443 url\r\n\tif (!isset($options['childs'])) $options['childs'] = 'childs'; // \u043f\u043e\u043b\u0435 \u0434\u043b\u044f \u043c\u0430\u0441\u0441\u0438\u0432\u0430 \u0434\u0435\u0442\u0435\u0439\r\n\r\n\t// \u0435\u0441\u043b\u0438 true, \u0442\u043e \u0433\u043b\u0430\u0432\u043d\u0430\u044f \u0440\u0430\u0431\u0440\u0438\u043a\u0430 \u0432\u044b\u0432\u043e\u0434\u0438\u0442\u0441\u044f \u0431\u0435\u0437 \u0441\u0441\u044b\u043b\u043a\u0438 \u0432 <span> \r\n\tif (!isset($options['group_header_no_link'])) $options['group_header_no_link'] = false;\r\n\r\n\t// \u0444\u0443\u043d\u043a\u0446\u0438\u044f, \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u0441\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u043d\u0430 [FUNCTION]\r\n\t// \u044d\u0442\u0430 \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 \u0432 \u043a\u0430\u0447\u0435\u0441\u0442\u0432\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u0430 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u043c\u0430\u0441\u0441\u0438\u0432 $elem\r\n\tif (!isset($options['function'])) $options['function'] = false;\r\n\r\n\t// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u043f\u0440\u043e\u0441\u0442\u043e \u0441\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u044e\u0442 \u0432 \u0442\u0435\u043b\u0435 \u0446\u0438\u043a\u043b\u0430 \u2014 \r\n\t// \u043f\u0440\u0438\u043d\u0438\u043c\u0430\u0435\u0442 \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u044d\u043b\u0435\u043c\u0435\u043d\u0442, \u0432\u044b\u0445\u043e\u0434\u043d\u0443\u044e \u0441\u0442\u0440\u043e\u0447\u043a\u0443 \u0438 \u043e\u043f\u0446\u0438\u044e function1_data\r\n\tif (!isset($options['function1'])) $options['function1'] = false;\r\n\tif (!isset($options['function1_data'])) $options['function1_data'] = [];\r\n\r\n\tif (!isset($options['nofollow']) or !$options['nofollow'])\r\n\t\t$options['nofollow'] = ''; // \u043c\u043e\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u0430\u0442\u044c rel=\"nofollow\" \u0434\u043b\u044f \u0441\u0441\u044b\u043b\u043e\u043a\r\n\telse\r\n\t\t$options['nofollow'] = ' rel=\"nofollow\"';\r\n\r\n\t$class_child = $class_child_style = $class_ul = $class_ul_style = '';\r\n\t$class_current = $class_current_style = $class_li = $class_li_style = '';\r\n\r\n\t// [LEVEL] - \u0437\u0430\u043c\u0435\u043d\u044f\u0435\u0442\u0441\u044f \u043d\u0430 level-\u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u043e\u0441\u0442\u0438\r\n\tif ($options['class_child']) $class_child = ' class=\"' . $options['class_child'] . ' [LEVEL]\"';\r\n\r\n\t$class_child = str_replace('[LEVEL]', 'level' . $level, $class_child);\r\n\r\n\tif ($options['class_child_style'])\r\n\t\t$class_child_style = ' style=\"' . $options['class_child_style'] . '\"';\r\n\r\n\tif ($options['class_ul'])\r\n\t\t$class_ul = ' class=\"' . $options['class_ul'] . '\"';\r\n\r\n\tif ($options['class_ul_style'])\r\n\t\t$class_ul_style = ' style=\"' . $options['class_ul_style'] . '\"';\r\n\r\n\tif ($options['class_current'])\r\n\t\t$class_current = ' class=\"' . $options['class_current'] . '\"';\r\n\r\n\tif ($options['class_current_style'])\r\n\t\t$class_current_style = ' style=\"' . $options['class_current_style'] . '\"';\r\n\r\n\tif ($options['class_li'])\r\n\t\t$class_li = ' class=\"' . $options['class_li'] . ' group\"';\r\n\telse\r\n\t\t$class_li = ' class=\"group\"';\r\n\r\n\tif ($options['class_li_style']) $class_li_style = ' style=\"' . $options['class_li_style'] . '\"';\r\n\r\n\tif ($child)\r\n\t\t$out = NR . '\t<ul' . $class_child . $class_child_style . '>';\r\n\telse\r\n\t\t$out = NR . '<ul' . $class_ul . $class_ul_style . '>';\r\n\r\n\t$current_url = getinfo('siteurl') . mso_current_url(); // \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0443\u0440\u043b\r\n\r\n\t// \u0438\u0437 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0443 \u043d\u0443\u0436\u043d\u043e \u0443\u0431\u0440\u0430\u0442\u044c \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u044e\r\n\t$current_url = str_replace('/next/' . mso_current_paged(), '', $current_url);\r\n\r\n\tforeach ($a as $elem) {\r\n\t\t$title = $elem[$options['title']];\r\n\t\t$elem_slug = mso_strip($elem[$options['link']]); // slug \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430\r\n\r\n\t\t$url = getinfo('siteurl') . $options['prefix'] . $elem_slug;\r\n\r\n\t\t// \u0435\u0441\u043b\u0438 \u044d\u0442\u043e page, \u0442\u043e \u043d\u0443\u0436\u043d\u043e \u043f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0432\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u0435 \u044d\u0442\u043e\u0439 \u0437\u0430\u043f\u0438\u0441\u0438 \u0432 \u044d\u043b\u0435\u043c\u0435\u043d\u0442 \u0440\u0443\u0431\u0440\u0438\u043a\u0438 \r\n\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c, \u0442\u043e \u0441\u0442\u0430\u0432\u0438\u043c css-\u043a\u043b\u0430\u0441\u0441 curent-page-cat\r\n\t\t$curent_page_cat_class = is_page_cat($elem_slug, false, false) ? ' class=\"curent-page-cat\"' : '';\r\n\r\n\t\t$link = '<a' . $options['nofollow'] . ' href=\"' . $url . '\" title=\"' . htmlspecialchars($title) . '\"' . $curent_page_cat_class . '>';\r\n\r\n\t\tif (isset($elem[$options['descr']]))\r\n\t\t\t$descr = $elem[$options['descr']];\r\n\t\telse\r\n\t\t\t$descr = '';\r\n\r\n\t\tif (isset($elem[$options['count']]))\r\n\t\t\t$count = $elem[$options['count']];\r\n\t\telse\r\n\t\t\t$count = '';\r\n\r\n\t\tif (isset($elem[$options['id']]))\r\n\t\t\t$id = $elem[$options['id']];\r\n\t\telse\r\n\t\t\t$id = '';\r\n\r\n\t\tif (isset($elem[$options['slug']]))\r\n\t\t\t$slug = $elem[$options['slug']];\r\n\t\telse\r\n\t\t\t$slug = '';\r\n\r\n\t\tif (isset($elem[$options['menu_order']]))\r\n\t\t\t$menu_order = $elem[$options['menu_order']];\r\n\t\telse\r\n\t\t\t$menu_order = '';\r\n\r\n\t\tif (isset($elem[$options['id_parent']]))\r\n\t\t\t$id_parent = $elem[$options['id_parent']];\r\n\t\telse\r\n\t\t\t$id_parent = '';\r\n\r\n\t\t$cur = false;\r\n\r\n\t\tif ($options['current_id']) // \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u043c \u043f\u043e id \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\t\t{\r\n\t\t\tif (isset($elem['current'])) {\r\n\t\t\t\t$e = $options['format_current'];\r\n\t\t\t\t$cur = true;\r\n\t\t\t} else {\r\n\t\t\t\t$e = $options['format'];\r\n\t\t\t}\r\n\t\t} else // \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u044f\u0435\u043c \u043f\u043e \u0443\u0440\u043b\u0443\r\n\t\t{\r\n\t\t\tif ($url == $current_url) {\r\n\t\t\t\t$e = $options['format_current'];\r\n\t\t\t\t$cur = true;\r\n\t\t\t} else {\r\n\t\t\t\t$e = $options['format'];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$e = str_replace('[LINK]', $link, $e);\r\n\t\t$e = str_replace('[/LINK]', '</a>', $e);\r\n\t\t$e = str_replace('[TITLE]', $title, $e);\r\n\t\t$e = str_replace('[TITLE_HTML]', htmlspecialchars($title), $e);\r\n\t\t$e = str_replace('[DESCR]', $descr, $e);\r\n\t\t$e = str_replace('[DESCR_HTML]', htmlspecialchars($descr), $e);\r\n\t\t$e = str_replace('[ID]', $id, $e);\r\n\t\t$e = str_replace('[SLUG]', $slug, $e);\r\n\t\t$e = str_replace('[SLUG_HTML]', htmlspecialchars($slug), $e);\r\n\t\t$e = str_replace('[MENU_ORDER]', $menu_order, $e);\r\n\t\t$e = str_replace('[ID_PARENT]', $id_parent, $e);\r\n\t\t$e = str_replace('[COUNT]', $count, $e);\r\n\t\t$e = str_replace('[URL]', $url, $e);\r\n\r\n\t\tif ($options['function'] and function_exists($options['function'])) {\r\n\t\t\t$function = $options['function']($elem);\r\n\t\t\t$e = str_replace('[FUNCTION]', $function, $e);\r\n\t\t} else {\r\n\t\t\t$e = str_replace('[FUNCTION]', '', $e);\r\n\t\t}\r\n\r\n\t\tif ($options['function1'] and function_exists($options['function1'])) {\r\n\t\t\t$e = $options['function1']($e, $elem, $options['function1_data']);\r\n\t\t}\r\n\r\n\t\tif (isset($elem[$options['childs']])) {\r\n\r\n\t\t\tif ($cur) {\r\n\t\t\t\t$out .= NR . '<li' . $class_current . $class_current_style . '>' . $e;\r\n\t\t\t} else {\r\n\t\t\t\tif ($options['group_header_no_link'])\r\n\t\t\t\t\t$out .= NR . '<li' . $class_li . $class_li_style . '><span class=\"group_header\">' . $title . '</span>';\r\n\t\t\t\telse\r\n\t\t\t\t\t$out .= NR . '<li' . $class_li . $class_li_style . '>' . $e;\r\n\t\t\t}\r\n\r\n\t\t\t++$level;\r\n\t\t\t$out .= mso_create_list($elem[$options['childs']], $options, true);\r\n\t\t\t--$level;\r\n\r\n\t\t\t$out .= NR . '</li>';\r\n\t\t} else {\r\n\t\t\tif ($child)\r\n\t\t\t\t$out .= NR . '\t';\r\n\t\t\telse\r\n\t\t\t\t$out .= NR;\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u043d\u0435\u0442 \u0434\u0435\u0442\u0435\u0439, \u0442\u043e \u0443\u0431\u0435\u0440\u0435\u043c \u043a\u043b\u0430\u0441\u0441 group\r\n\t\t\t$class_li_1 = str_replace('group', '', $class_li);\r\n\r\n\t\t\tif ($cur)\r\n\t\t\t\t$out .= '<li' . $class_current . $class_current_style . '>' . $e . '</li>';\r\n\t\t\telse\r\n\t\t\t\t$out .= '<li' . $class_li_1 . $class_li_style . '>' . $e . '</li>';\r\n\t\t}\r\n\t}\r\n\r\n\tif ($child)\r\n\t\t$out .= NR . '\t</ul>' . NR;\r\n\telse\r\n\t\t$out .= NR . '</ul>' . NR;\r\n\r\n\t$out = str_replace('<li class=\"\">', '<li>', $out);\r\n\r\n\treturn $out;\r\n}\r\n\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 rss \u0432 <link rel...>\r\n// \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446 \u0438 \u0440\u0443\u0431\u0440\u0438\u043a \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u044e\u0442\u0441\u044f \u0441\u0432\u043e\u0438 RSS\r\nfunction mso_rss()\r\n{\r\n\tglobal $MSO;\r\n\r\n\t$out = '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t. tf('\u0412\u0441\u0435 \u043d\u043e\u0432\u044b\u0435 \u0437\u0430\u043f\u0438\u0441\u0438') . '\" href=\"'\r\n\t\t. getinfo('rss_url') . '\">' . NR;\r\n\r\n\t$out .= '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t. tf('\u0412\u0441\u0435 \u043d\u043e\u0432\u044b\u0435 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438') . '\" href=\"'\r\n\t\t. getinfo('rss_comments_url') . '\">';\r\n\r\n\tif (is_type('page') and mso_segment(2) and (isset($MSO->data['pages_is']) and $MSO->data['pages_is'])) {\r\n\t\t$out .= NR . '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t\t. tf('\u041a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0438 \u044d\u0442\u043e\u0439 \u0437\u0430\u043f\u0438\u0441\u0438') . '\" href=\"'\r\n\t\t\t. getinfo('site_url') . mso_segment(1) . '/' . mso_segment(2) . '/feed\">';\r\n\t} elseif (is_type('category') and mso_segment(2) and (isset($MSO->data['pages_is']) and $MSO->data['pages_is'])) {\r\n\t\t$out .= NR . '<link rel=\"alternate\" type=\"application/rss+xml\" title=\"'\r\n\t\t\t. tf('\u0417\u0430\u043f\u0438\u0441\u0438 \u044d\u0442\u043e\u0439 \u0440\u0443\u0431\u0440\u0438\u043a\u0438') . '\" href=\"'\r\n\t\t\t. getinfo('site_url') . mso_segment(1) . '/' . mso_segment(2) . '/feed\">';\r\n\t}\r\n\r\n\treturn $out;\r\n}\r\n\r\n// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442 <link rel=\"$REL\" $ADD>\r\n// $rel - \u0442\u0438\u043f rel. \u0415\u0441\u043b\u0438 \u043e\u043d \u0440\u0430\u0432\u0435\u043d canonical, \u0442\u043e \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442\u0441\u044f \u043a\u0430\u043d\u043e\u043d\u0438\u0437\u0430\u0446\u0438\u044f\r\n// http://www.google.com/support/webmasters/bin/answer.py?answer=139066&hl=ru\r\n// <link rel=\"canonical\" href=\"http://www.example.com/page/about\">\r\nfunction mso_link_rel($rel = 'canonical', $add = '', $url_only = false)\r\n{\r\n\tif (!$rel) return; // \u043f\u0443\u0441\u0442\u043e\u0439 \u0442\u0438\u043f\r\n\r\n\tif ($rel == 'canonical') {\r\n\t\t\r\n\t\t// \u0441\u0432\u043e\u0439 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\r\n\t\t// \u0435\u0441\u043b\u0438 \u0445\u0443\u043a \u0432\u0435\u0440\u043d\u0443\u043b false \u0438\u043b\u0438 '', \u0442\u043e \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u043f\u0440\u043e\u0434\u043e\u043b\u0436\u0430\u0435\u0442\u0441\u044f \u0434\u0430\u043b\u044c\u0448\u0435\r\n\t\t// \u0438\u043d\u0430\u0447\u0435 \u0445\u0443\u043a \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 url \u0438 \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442 \u0435\u0433\u043e \u0432\u044b\u0432\u043e\u0434\r\n\t\tif (mso_hook_present('canonicalUrl')) { \r\n\t\t\t$rh = mso_hook('canonicalUrl');\r\n\t\t\t\r\n\t\t\tif ($rh) return '<link rel=\"canonical\" href=\"' . $rh . '\">';\r\n\t\t}\r\n\t\t\r\n\t\tif ($add) {\r\n\t\t\treturn '<link rel=\"canonical\" ' . $add . '>';\r\n\t\t} else {\r\n\t\t\t// \u0434\u043b\u044f \u0440\u0430\u0437\u043d\u044b\u0445 \u0442\u0438\u043f\u043e\u0432 \u0434\u0430\u043d\u043d\u044b\u0445 \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u043c \u0440\u0430\u0437\u043d\u044b\u0439 \u043a\u0430\u043d\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u0430\u0434\u0440\u0435\u0441\r\n\t\t\t// \u043e\u043d \u043d\u0430\u043f\u0440\u044f\u043c\u0443\u044e \u0437\u0430\u0432\u0438\u0441\u0438\u0442 \u043e\u0442 \u0442\u0438\u043f\u0430\r\n\t\t\t$url = '';\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u0445\u0443\u043a canonical, \u0442\u043e \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u043c \u0435\u0433\u043e\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0445\u0443\u043a \u0432\u0435\u0440\u043d\u0443\u043b \u043a\u0430\u043a\u043e\u0435-\u0442\u043e \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435, \u0442\u043e \u044d\u0442\u043e $url\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u043d\u0435\u0442, \u0442\u043e \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u043c \u0442\u0438\u043f\u043e\u0432\u043e\u0435 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043a\u0430\u043d\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430\r\n\t\t\tif (mso_hook_present('canonical')) $url = mso_hook('canonical');\r\n\r\n\t\t\tif (!$url) {\r\n\t\t\t\tif (\r\n\t\t\t\t\tis_type('page')\r\n\t\t\t\t\tor is_type('category')\r\n\t\t\t\t\tor is_type('tag')\r\n\t\t\t\t\tor is_type('author')\r\n\t\t\t\t\tor is_type('users')\r\n\t\t\t\t\tor (mso_segment(1) == 'sitemap')\r\n\t\t\t\t\tor (mso_segment(1) == 'contact')\r\n\t\t\t\t) {\r\n\t\t\t\t\tif (mso_segment(2)) {\r\n\t\t\t\t\t\t$url = getinfo('site_url') . mso_segment(1) . '/' . urlencode(mso_segment(2));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t$url = getinfo('site_url') . mso_segment(1);\r\n\t\t\t\t\t}\r\n\t\t\t\t} elseif (is_type('home')) {\r\n\t\t\t\t\t$url = getinfo('site_url');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u044f\r\n\t\t\tif (($cur = mso_current_paged()) > 1) {\r\n\t\t\t\tif (is_type('home')) {\r\n\t\t\t\t\t$url .= 'home/next/' . $cur;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif ($url) $url .= '/next/' . $cur;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ($url) {\r\n\t\t\t\tif ($url_only)\r\n\t\t\t\t\treturn $url;\r\n\t\t\t\telse\r\n\t\t\t\t\treturn '<link rel=\"canonical\" href=\"' . $url . '\">';\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tif ($add) return '<link rel=\"' . $rel . '\" ' . $add . '>';\r\n\t}\r\n}\r\n\r\n/**\r\n * \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 TITLE, meta: description, keywords\r\n * $info: \u0442\u043e\u043b\u044c\u043a\u043e \u043e\u0434\u0438\u043d \u0438\u0437 \u0432\u0430\u0440\u0438\u0430\u043d\u0442\u043e\u0432: title, description, keywords\r\n * $args: \u0432\u0445\u043e\u0434\u044f\u0449\u0438\u0439 \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442 \u0434\u0430\u043d\u043d\u044b\u0445, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 $pages (\u0437\u0430\u043f\u0438\u0441\u0438)\r\n * $format: \u0444\u043e\u0440\u043c\u0430\u0442 \u0432\u044b\u0432\u043e\u0434\u0430. \u0417\u0430\u043c\u0435\u043d\u044b \u0434\u043b\u044f: \r\n *          %title%, %page_title%, %category_name%, %category_desc%, %users_nik%, || (\u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c) \r\n * $sep: \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c\r\n * $only_meta == true \u2014 \u0432\u044b\u0432\u043e\u0434 \u0442\u043e\u043b\u044c\u043a\u043e meta-\u0434\u0430\u043d\u043d\u044b\u0445\r\n * $add_pag == true \u2014 \u0434\u043e\u0431\u0430\u0432\u043a\u0430 \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u0438 (\u0438\u0437 \u043e\u043f\u0446\u0438\u0438 title_pagination)\r\n * \r\n */\r\nfunction mso_head_meta($info = 'title', $args = '', $format = '%page_title%', $sep = '', $only_meta = false, $add_pag = true)\r\n{\r\n\tglobal $MSO;\r\n\r\n\t// \u0432\u044b\u044f\u0432\u043b\u044f\u0435\u043c \u043e\u0448\u0438\u0431\u043e\u0447\u043d\u044b\u0439 info\r\n\tif ($info != 'title' and $info != 'description' and $info != 'keywords') return '';\r\n\r\n\tif (mso_hook_present('head_meta')) {\r\n\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u0445\u0443\u043a\u0438, \u0442\u043e \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u0435\u0440\u0435\u0434\u0430\u0435\u043c \u0438\u043c\r\n\t\treturn mso_hook('head_meta', array('info' => $info, 'args' => $args, 'format' => $format, 'sep' => $sep, 'only_meta' => $only_meta));\r\n\t}\r\n\r\n\t// \u0434\u043e\u0431\u0430\u0432\u043a\u0430 \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u0438 \u043d\u0430 \u043e\u0441\u043d\u043e\u0432\u0435 \u043e\u043f\u0446\u0438\u0438 title_pagination \u0438 \u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f TITLE\r\n\t$pag = '';\r\n\r\n\tif ($add_pag and $info == 'title' and ($cur = mso_current_paged()) > 1 and $onum = mso_get_option('title_pagination', 'general', t(' - \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430 [NUM]'))) {\r\n\t\t$pag = htmlspecialchars(str_replace('[NUM]', $cur, $onum));\r\n\t}\r\n\r\n\t// \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u043d\u044b\u0439 \u0434\u043b\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0442\u0438\u0442\u043b\u0435 \u0445\u0440\u0430\u043d\u0438\u0442\u0441\u044f \u0432 $MSO->title description \u0438\u043b\u0438 keywords\r\n\tif (!$args) // \u043d\u0435\u0442 \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442\u0430 - \u0432\u044b\u0432\u043e\u0434\u0438\u043c \u0447\u0442\u043e \u0435\u0441\u0442\u044c\r\n\t{\r\n\t\tif (!$MSO->$info)\r\n\t\t\t$out = $MSO->$info = getinfo($info) . $pag;\r\n\t\telse\r\n\t\t\t$out = $MSO->$info;\r\n\t} else // \u0435\u0441\u0442\u044c \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442\u044b/\u0437\u0430\u043f\u0438\u0441\u0438\r\n\t{\r\n\t\tif (is_scalar($args)) {\r\n\t\t\t$out = $args . $pag; // \u043a\u0430\u043a\u0430\u044f-\u0442\u043e \u044f\u0432\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 - \u043e\u0442\u0434\u0430\u0435\u043c \u0435\u0451 \u043a\u0430\u043a \u0435\u0441\u0442\u044c\r\n\t\t} else // \u0432\u0445\u043e\u0434\u043d\u043e\u0439 \u043c\u0430\u0441\u0441\u0438\u0432 - \u0441\u043a\u043e\u0440\u0435\u0435 \u0432\u0441\u0435\u0433\u043e \u044d\u0442\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0430\r\n\t\t{\r\n\t\t\t// %page_title% %title% %category_name%\r\n\t\t\t// || \u044d\u0442\u043e \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 = $sep\r\n\t\t\t// pr($args);\r\n\r\n\t\t\t$category_name = '';\r\n\t\t\t$category_desc = '';\r\n\t\t\t$page_title = '';\r\n\t\t\t$users_nik = '';\r\n\t\t\t$title = getinfo($info);\r\n\r\n\t\t\tif (isset($args[0]['page_categories_detail'])) {\r\n\t\t\t\t$slug = is_type('category') ? mso_segment(2) : '';\r\n\r\n\t\t\t\tforeach ($args[0]['page_categories_detail'] as $id => $val) {\r\n\t\t\t\t\tif ($slug == $val['category_slug']) {\r\n\t\t\t\t\t\t$category_name = $val['category_name'];\r\n\t\t\t\t\t\t$category_desc = $val['category_desc'];\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (isset($args[0]['page_title'])) $page_title = $args[0]['page_title'];\r\n\t\t\tif (isset($args[0]['users_nik']))  $users_nik = $args[0]['users_nik'];\r\n\r\n\t\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u043c\u0435\u0442\u0430, \u0442\u043e \u0431\u0435\u0440\u0435\u043c \u0435\u0451\r\n\t\t\tif (isset($args[0]['page_meta'][$info][0]) and $args[0]['page_meta'][$info][0]) {\r\n\t\t\t\tif ($only_meta)\r\n\t\t\t\t\t$category_name = $category_desc = $title = $sep = '';\r\n\r\n\t\t\t\t$page_title = $args[0]['page_meta'][$info][0];\r\n\r\n\t\t\t\tif ($info != 'title') $title = $page_title;\r\n\t\t\t} else {\r\n\t\t\t\t// \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b \u0435\u0441\u043b\u0438 \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u044b \u0441\u0432\u043e\u0438 keywords, \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u0443\u043a\u0430\u0437\u0430\u0442\u044c \u0438\u0437 \u043c\u0435\u0442\u043e\u043a\r\n\t\t\t\tif ($info == 'keywords' and is_type('page') and isset($args[0]['page_meta']['tags']) and $args[0]['page_meta']['tags']) {\r\n\t\t\t\t\t$page_title = implode(', ', $args[0]['page_meta']['tags']); // \u0440\u0430\u0437\u0431\u0438\u0432\u0430\u0435\u043c \u043c\u0430\u0441\u0441\u0438\u0432 \u043c\u0435\u0442\u043e\u043a \u0432 \u0441\u0442\u0440\u043e\u043a\u0443\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446, \u0435\u0441\u043b\u0438 \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d description \u0432\u044b\u0442\u044f\u0433\u0438\u0432\u0430\u0435\u043c \u0435\u0433\u043e \u0438\u0437 \u0441\u0430\u043c\u043e\u0433\u043e \u0442\u0435\u043a\u0441\u0442\u0430\r\n\t\t\t\tif ($info == 'description' and is_type('page') and $w = mso_get_option('description_of_page', 'general', 50)) {\r\n\t\t\t\t\t// \u0432\u043e\u043e\u0431\u0449\u0435 \u043d\u0435\u0442 \u043f\u043e\u043b\u044f\r\n\t\t\t\t\tif (!isset($args[0]['page_meta']['description'][0])) $d = 333;\r\n\r\n\t\t\t\t\t// \u043f\u043e\u043b\u0435 \u0435\u0441\u0442\u044c, \u043d\u043e \u043e\u043d\u043e \u043f\u0443\u0441\u0442\u043e\u0435\r\n\t\t\t\t\tif (isset($args[0]['page_meta']['description'][0]) and !$args[0]['page_meta']['description'][0]) $d = 333;\r\n\r\n\t\t\t\t\tif ($d == 333) // \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c \u043f\u0440\u0438\u0437\u043d\u0430\u043a\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t$t = strip_tags($args[0]['page_content']);\r\n\t\t\t\t\t\t$t = trim(str_replace(\"\\r\", \"\", $t));\r\n\t\t\t\t\t\t$t = trim(str_replace(\"\\n\", ' ', $t));\r\n\t\t\t\t\t\t$t = trim(str_replace(\"\\t\", ' ', $t));\r\n\t\t\t\t\t\t$t = trim(str_replace('   ', ' ', $t));\r\n\t\t\t\t\t\t$t = trim(str_replace('  ', ' ', $t));\r\n\r\n\t\t\t\t\t\t$page_title = mso_str_word($t, $w);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t$arr_key = ['%title%', '%page_title%', '%category_name%', '%category_desc%', '%users_nik%', '||'];\r\n\r\n\t\t\t$arr_val = [htmlspecialchars($title), htmlspecialchars($page_title), htmlspecialchars($category_name), htmlspecialchars($category_desc), htmlspecialchars($users_nik), $sep];\r\n\r\n\t\t\t$out = str_replace($arr_key, $arr_val, $format) . $pag;\r\n\t\t}\r\n\t}\r\n\r\n\t// \u043e\u0442\u0434\u0430\u0435\u043c \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442, \u0441\u0440\u0430\u0437\u0443 \u0436\u0435 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u044f \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u043d\u044b\u0439 $info \u0432 $MSO\r\n\t$out = $MSO->$info = trim($out);\r\n\r\n\treturn $out;\r\n}\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442 <style> \u0438\u0437 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430 \r\n// \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0434\u0443\u0431\u043b\u0438 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0439\r\nfunction mso_load_style($url = '', $nodouble = true)\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif (!isset($MSO->data['_loaded_style'])) $MSO->data['_loaded_style'] = [];\r\n\tif ($nodouble and in_array($url, $MSO->data['_loaded_style'])) return ''; // \u0443\u0436\u0435 \u0431\u044b\u043b\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430\r\n\r\n\t$MSO->data['_loaded_style'][] = $url; // \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u0432 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d\u043d\u044b\u0445\r\n\t$MSO->data['_loaded_style'] = array_unique($MSO->data['_loaded_style']);\r\n\r\n\treturn '<link rel=\"stylesheet\" href=\"' . $url . '\">';\r\n}\r\n\r\n// \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442 <script> \u0438\u0437 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430\r\n// \u0435\u0441\u043b\u0438 \u0441\u043a\u0440\u0438\u043f\u0442 \u0431\u044b\u043b \u0443\u0436\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d, \u0435\u0433\u043e \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u0435\u0442\u0441\u044f\r\nfunction mso_load_script($url = '', $nodouble = true, $attr = '')\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif (!isset($MSO->data['_loaded_script'])) $MSO->data['_loaded_script'] = [];\r\n\tif ($nodouble and in_array($url, $MSO->data['_loaded_script'])) return ''; // \u0443\u0436\u0435 \u0431\u044b\u043b\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430\r\n\r\n\t$MSO->data['_loaded_script'][] = $url; // \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u0432 \u0441\u043f\u0438\u0441\u043e\u043a \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d\u043d\u044b\u0445\r\n\t$MSO->data['_loaded_script'] = array_unique($MSO->data['_loaded_script']);\r\n\r\n\t$attr = ($attr) ? ' ' . $attr : '';\r\n\r\n\treturn '<script' . $attr . ' src=\"' . $url . '\"></script>';\r\n}\r\n\r\n/**\r\n * \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 <script> \u0441 \u0432\u043d\u0435\u0448\u043d\u0438\u043c js-\u0444\u0430\u0439\u043b\u043e\u043c \u0438\u043b\u0438\r\n * \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 <link rel=\"stylesheet> \u0441 \u0432\u043d\u0435\u0448\u043d\u0438\u043c css-\u0444\u0430\u0439\u043b\u043e\u043c\r\n * \u0438\u043c\u044f \u0444\u0430\u0439\u043b\u0430 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u043a\u0430\u0442\u0430\u043b\u043e\u0433\u0430 \u0448\u0430\u0431\u043b\u043e\u043d\u0430\r\n * \u0435\u0441\u043b\u0438 \u0444\u0430\u0439\u043b\u0430 \u043d\u0435\u0442, \u0442\u043e \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442\r\n * \u0435\u0441\u043b\u0438 $lazy == true, \u0442\u043e \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430 \u0431\u0443\u0434\u0435\u0442 \u0432 \u043a\u043e\u043d\u0446\u0435 BODY \u043f\u043e \u0445\u0443\u043a\u0443 mso_hook('body_end')\r\n * \u0435\u0441\u043b\u0438 $auto_dir = __DIR__ \u0442\u043e \u043f\u0443\u0442\u044c \u0431\u0443\u0434\u0435\u0442 \u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u043a\u0430\u0442\u0430\u043b\u043e\u0433\u0430 \u0438\u0441\u043f\u043e\u043b\u043d\u044f\u0435\u043c\u043e\u0433\u043e php-\u0444\u0430\u0439\u043b\u0430\r\n *   \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440: component/header/header.php:\r\n *\t \u0441 $auto_dir\r\n *     mso_add_file('js/my.js', false, __DIR__); // component/header/js/my.js\r\n *\r\n *   \u0438\u043b\u0438 \u043d\u0443\u0436\u043d\u043e \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u043f\u0443\u0442\u044c \u043a \u0444\u0430\u0439\u043b\u0443:\r\n *      mso_add_file('component/header/js/my.js');\r\n *\r\n * $js_attr \u2014 \u0430\u0442\u0440\u0438\u0431\u0443\u0442 \u0434\u043b\u044f js-\u0441\u043a\u0440\u0438\u043f\u0442\u0430, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 'async'\r\n * \r\n */\r\nfunction mso_add_file($fn, $lazy = false, $auto_dir = false, $js_attr = '')\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif ($auto_dir) {\r\n\t\t$fn = str_replace(str_replace('\\\\', '/', getinfo('template_dir')), '', str_replace('\\\\', '/', $auto_dir)) . '/' . $fn;\r\n\t}\r\n\r\n\tif (file_exists(getinfo('template_dir') . $fn)) {\r\n\t\t$ext = strtolower(substr(strrchr($fn, '.'), 1)); // \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430\r\n\r\n\t\t$out = '';\r\n\r\n\t\tif ($ext == 'js')\r\n\t\t\t$out = mso_load_script(getinfo('template_url') . $fn, true, $js_attr);\r\n\t\telseif ($ext == 'css')\r\n\t\t\t$out = mso_load_style(getinfo('template_url') . $fn);\r\n\r\n\t\tif (!$lazy) {\r\n\t\t\techo $out;\r\n\t\t} elseif ($out) {\r\n\t\t\t// \u0432\u044b\u0432\u043e\u0434 \u0447\u0435\u0440\u0435\u0437 \u0445\u0443\u043a body_end \u2014 mso_add_file_body_end()\r\n\t\t\tif (!isset($MSO->data['add_file_to_body_end'])) $MSO->data['add_file_to_body_end'] = [];\r\n\t\t\t\r\n\t\t\t$MSO->data['add_file_to_body_end'][] = $out;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * \u0424\u0443\u043d\u043a\u0446\u0438\u044f \u043a \u0445\u0443\u043a\u0443 body_end \u043f\u043e \u043a\u043e\u0442\u043e\u0440\u043e\u0439 \u0432\u044b\u0432\u043e\u0434\u044f\u0442\u0441\u044f \u0432\u0441\u0435 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u043d\u044b\u0435 \u0444\u0430\u0439\u043b\u044b \u0447\u0435\u0440\u0435\u0437 mso_add_file(\u0444\u0430\u0439\u043b, true)\r\n * Lazy-\u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0432 \u043a\u043e\u043d\u0446\u0435 BODY\r\n */\r\nfunction mso_add_file_body_end($a)\r\n{\r\n\tglobal $MSO;\r\n\r\n\tif (!isset($MSO->data['add_file_to_body_end']) or !$MSO->data['add_file_to_body_end'])\r\n\t\treturn $a;\r\n\r\n\techo implode($MSO->data['add_file_to_body_end']);\r\n\r\n\treturn $a;\r\n}\r\n\r\n/**\r\n *  \u0441\u0436\u0430\u0442\u0438\u0435 HTML\r\n * \r\n *  @param $text \u0432\u0445\u043e\u0434\u043d\u043e\u0439 \u0442\u0435\u043a\u0441\u0442\r\n *  @return string\r\n */\r\nfunction mso_compress_text($text)\r\n{\r\n\t// \u0437\u0430\u0449\u0438\u0449\u0435\u043d\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442\r\n\t$text = preg_replace_callback('!(<pre.*?>)(.*?)(</pre>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<code.*?>)(.*?)(</code>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<script.*?>)(.*?)(</script>)!is', '_mso_protect_script', $text);\r\n\t$text = preg_replace_callback('!(<style.*?>)(.*?)(</style>)!is', '_mso_protect_script', $text);\r\n\r\n\t// \u0441\u0436\u0430\u0442\u0438\u0435\r\n\t$text = str_replace(\"\\r\", \"\", $text);\r\n\t$text = str_replace(\"\\t\", ' ', $text);\r\n\t$text = str_replace(\"\\n   \", \"\\n\", $text);\r\n\t$text = str_replace(\"\\n  \", \"\\n\", $text);\r\n\t$text = str_replace(\"\\n \", \"\\n\", $text);\r\n\t$text = str_replace(\"\\n\", '', $text);\r\n\t$text = str_replace('   ', ' ', $text);\r\n\t$text = str_replace('  ', ' ', $text);\r\n\r\n\t// \u0441\u043f\u0435\u0446\u0438\u0444\u0438\u0447\u043d\u044b\u0435 \u0437\u0430\u043c\u0435\u043d\u044b\r\n\t$text = str_replace('<!---->', '', $text);\r\n\t$text = str_replace('>    <', '><', $text);\r\n\t$text = str_replace('>   <', '><', $text);\r\n\t$text = str_replace('>  <', '><', $text);\r\n\r\n\t$text = preg_replace_callback('!\\[html_base64\\](.*?)\\[\\/html_base64\\]!is', function ($m) {\r\n\t\treturn base64_decode($m[1]);\r\n\t}, $text);\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n *  \u0437\u0430\u043c\u0435\u043d\u044f\u0435\u0442 \u0432 \u0442\u0435\u043a\u0441\u0442\u0435 \u0432\u0441\u0435 \u0432\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u044f http:// \u0438 https:// \u043d\u0430 // \r\n *  \r\n *  @param $text \u0442\u0435\u043a\u0441\u0442\r\n *  @return string\r\n */\r\nfunction mso_remove_protocol($text)\r\n{\r\n\t// \u0437\u0430\u0449\u0438\u0449\u0435\u043d\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442\r\n\t$text = preg_replace_callback('!(<pre.*?>)(.*?)(</pre>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<code.*?>)(.*?)(</code>)!is', '_mso_protect_pre', $text);\r\n\t$text = preg_replace_callback('!(<script.*?>)(.*?)(</script>)!is', '_mso_protect_script', $text);\r\n\t$text = preg_replace_callback('!(<style.*?>)(.*?)(</style>)!is', '_mso_protect_script', $text);\r\n\t$text = preg_replace_callback('!(<textarea.*?>)(.*?)(</textarea>)!is', '_mso_protect_script', $text);\r\n\r\n\t$text = str_replace('https://', '//', $text);\r\n\t$text = str_replace('http://', '//', $text);\r\n\r\n\t$text = preg_replace_callback('!\\[html_base64\\](.*?)\\[\\/html_base64\\]!is', function ($m) {\r\n\t\treturn base64_decode($m[1]);\r\n\t}, $text);\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n *  pre, \u043a\u043e\u0442\u043e\u0440\u043e\u0435 \u0437\u0430\u0433\u043e\u043d\u044f\u0435\u0442\u0441\u044f \u0432 [html_base64]\r\n *  callback\r\n * \r\n *  @param $matches matches\r\n *  @return string\r\n */\r\nfunction _mso_protect_pre($matches)\r\n{\r\n\t$text = trim($matches[2]);\r\n\r\n\t$text = str_replace('<p>', '', $text);\r\n\t$text = str_replace('</p>', '', $text);\r\n\t$text = str_replace('[', '&#91;', $text);\r\n\t$text = str_replace(']', '&#93;', $text);\r\n\t$text = str_replace(\"<br>\", \"\\n\", $text);\r\n\t$text = str_replace(\"<br />\", \"<br>\", $text);\r\n\t$text = str_replace(\"<br/>\", \"<br>\", $text);\r\n\t$text = str_replace(\"<br>\", \"\\n\", $text);\r\n\r\n\t$text = str_replace('<', '&lt;', $text);\r\n\t$text = str_replace('>', '&gt;', $text);\r\n\t$text = str_replace('&lt;pre', '<pre', $text);\r\n\t$text = str_replace('&lt;/pre', '</pre', $text);\r\n\t$text = str_replace('pre&gt;', 'pre>', $text);\r\n\r\n\t$text = $matches[1] . \"\\n\" . '[html_base64]' . base64_encode($text) . '[/html_base64]' . $matches[3];\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n *  script \u0438 style, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0437\u0430\u0433\u043e\u043d\u044f\u044e\u0442\u0441\u044f \u0432 [html_base64]\r\n *  callback\r\n * \r\n *  @param $matches matches\r\n *  @return string\r\n */\r\nfunction _mso_protect_script($matches)\r\n{\r\n\t$text = trim($matches[2]);\r\n\t$text = $matches[1] . '[html_base64]' . base64_encode($text) . '[/html_base64]' . $matches[3];\r\n\r\n\treturn $text;\r\n}\r\n\r\n/**\r\n * \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442 css \u0438\u0437 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0444\u0430\u0439\u043b\u0430\r\n * \u0432 css-\u0444\u0430\u0439\u043b\u0435 \u043c\u043e\u0436\u043d\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c php\r\n * \u043e\u0441\u0443\u0449\u0435\u0441\u0442\u0432\u043b\u044f\u0435\u0442\u0441\u044f \u0441\u0436\u0430\u0442\u0438\u0435 css\r\n * \u0430\u0432\u0442\u043e\u0437\u0430\u043c\u0435\u043d\u0430 [TEMPLATE_URL] \u043d\u0430 url-\u0448\u0430\u0431\u043b\u043e\u043d\u0430\r\n * \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u0441\u0442\u0438\u043b\u0438, \u0431\u0435\u0437 \u043e\u0431\u0440\u0430\u043c\u043b\u044f\u044e\u0449\u0435\u0433\u043e <style>\r\n * \u0415\u0441\u043b\u0438 <style> \u043d\u0443\u0436\u043d\u044b, \u0442\u043e $tag_style = true\r\n * \u0415\u0441\u043b\u0438 \u043d\u0443\u0436\u0435\u043d \u0441\u0440\u0430\u0437\u0443 \u0432\u044b\u0432\u043e\u0434 \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440, \u0442\u043e $echo = true\r\n * \r\n * @param string $fn \u0438\u043c\u044f \u0444\u0430\u0439\u043b\u0430\r\n * @param type $tag_style \u0444\u043b\u0430\u0433 \u0434\u043b\u044f \u043e\u0431\u0440\u0430\u043c\u043b\u0435\u043d\u0438\u044f \u0432 STYLE\r\n * @param type $echo \u0444\u043b\u0430\u0433 \u0432\u044b\u0432\u043e\u0434\u0430 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u0430 \u043f\u043e echo\r\n * @return string\r\n */\r\nfunction mso_out_css_file($fn, $tag_style = true, $echo = true)\r\n{\r\n\t$fn = getinfo('template_dir') . $fn;\r\n\r\n\t$out = '';\r\n\r\n\tif (file_exists($fn)) {\r\n\t\tif ($r = @file_get_contents($fn)) $out .= $r . NR; // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u0435\r\n\r\n\t\tif ($out) {\r\n\t\t\tob_start();\r\n\t\t\teval('?>' . stripslashes($out) . '<?php ');\r\n\t\t\t$out = ob_get_contents();\r\n\t\t\tob_end_clean();\r\n\r\n\t\t\t$out = str_replace('[TEMPLATE_URL]', getinfo('template_url'), $out);\r\n\t\t\t$out = str_replace(array(\"\\r\\n\", \"\\r\", \"\\n\", \"\\t\", '  ', '    ', '    '), '', $out);\r\n\t\t\t$out = str_replace(array('; ', ' {', ': ', ', '), array(';', '{', ':', ','), $out);\r\n\t\t}\r\n\r\n\t\tif ($tag_style) $out = '<style>' . $out . '</style>';\r\n\t\tif ($echo) echo $out;\r\n\t}\r\n\r\n\treturn $out;\r\n}\r\n\r\n# end of file\r\n", "<?php if (!defined('BASEPATH')) exit('No direct script access allowed');\r\n/**\r\n * MaxSite CMS\r\n * (c) https://max-3000.com/\r\n * \r\n */\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u0433\u043e \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u0443 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n// http://localhost/admin/users/edit/1\r\n// mso_segment(3) -> edit\r\n// \u043d\u043e\u043c\u0435\u0440 \u0441\u0447\u0438\u0442\u0430\u0435\u0442\u0441\u044f \u043e\u0442 home-\u0441\u0430\u0439\u0442\u0430\r\n// \u0435\u0441\u043b\u0438 \u0432 \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u0435 \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u0441\u044f XSS \u0438 $die = true, \u0442\u043e \u0440\u0443\u0431\u0438\u043c \u0432\u0441\u0435\r\n// \u043c\u043e\u0436\u043d\u043e \u043f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u0432 \u0441\u0432\u043e\u0451\u043c \u043c\u0430\u0441\u0441\u0438\u0432\u0435 $my_segments\r\nfunction mso_segment($segment = 2, $die = true, $my_segments = false)\r\n{\r\n\tglobal $MSO;\r\n\r\n\t$CI = &get_instance();\r\n\r\n\tif ($my_segments === false) $my_segments = $MSO->data['uri_segment'];\r\n\r\n\tif (count($my_segments) > ($segment - 1))\r\n\t\t$seg = $my_segments[$segment];\r\n\telse\r\n\t\t$seg = '';\r\n\r\n\t$seg = urldecode($seg);\r\n\r\n\t// $url = $CI->input->xss_clean($seg); // ci < 2\r\n\t$url = $CI->security->xss_clean($seg, false);\r\n\r\n\tif ($url != $seg and $die) die('<b><font color=\"red\">Achtung! XSS attack!</font></b>');\r\n\r\n\treturn $url;\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0442\u0435\u043a\u0443\u0449\u0438\u0445 \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u043e\u0432 url \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n// \u0432 \u043e\u0442\u043b\u0438\u0447\u0438\u0435 \u043e\u0442 CodeIgniter - \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442 \u0430\u043d\u0430\u043b\u0438\u0437 get \u0438 \u043e\u0442\u0441\u0435\u043a\u0430\u043d\u0438\u0435 \u0434\u043e \u00ab?\u00bb\r\n// \u0435\u0441\u043b\u0438 \u00ab?\u00bb \u043d\u0435\u0442, \u0442\u043e \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u0441\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u043e\u0435 $this->uri->segment_array();\r\nfunction mso_segment_array()\r\n{\r\n\t$CI = &get_instance();\r\n\r\n\tif (isset($_SERVER['REQUEST_URI']) and $_SERVER['REQUEST_URI']) {\r\n\t\t// http://localhost/page/privet?get=hello\r\n\t\t$url = getinfo('site_protocol');\r\n\t\t$url .= $_SERVER['HTTP_HOST'] . mso_clean_str($_SERVER['REQUEST_URI']);\r\n\t\t$url = str_replace($CI->config->config['base_url'], '', $url); // page/privet?get=hello\r\n\r\n\t\tif (strpos($url, '?') !== FALSE) {\r\n\t\t\t// \u0435\u0441\u0442\u044c \u00ab?\u00bb\r\n\t\t\t$url = explode('?', $url); // \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u043c \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n\t\t\t$url = $url[0]; // \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u044b - \u044d\u0442\u043e \u0442\u043e\u043b\u044c\u043a\u043e \u043f\u0435\u0440\u0432\u0430\u044f \u0447\u0430\u0441\u0442\u044c\r\n\t\t\t$url = explode('/', $url); // \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u043c \u0432 \u043c\u0430\u0441\u0441\u0438\u0432 \u043f\u043e /\r\n\r\n\t\t\t// \u043d\u0443\u0436\u043d\u043e \u0438\u0437\u043c\u0435\u043d\u0438\u0442\u044c \u043d\u0443\u043c\u0435\u0440\u0430\u0446\u0438\u044e - \u043d\u0430\u0447\u0430\u043b\u043e \u0441 1\r\n\t\t\t$out = [];\r\n\t\t\t$i = 1;\r\n\t\t\t\r\n\t\t\tforeach ($url as $val) {\r\n\t\t\t\tif ($val) {\r\n\t\t\t\t\t$out[$i] = $val;\r\n\t\t\t\t\t$i++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn $out;\r\n\t\t} else {\r\n\t\t\treturn $CI->uri->segment_array();\r\n\t\t}\r\n\t} else {\r\n\t\treturn $CI->uri->segment_array();\r\n\t}\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 get-\u0441\u0442\u0440\u043e\u043a\u0438 \u0438\u0437 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e \u0430\u0434\u0440\u0435\u0441\u0430\r\nfunction mso_url_get()\r\n{\r\n\t$CI = &get_instance();\r\n\tif (isset($_SERVER['REQUEST_URI']) and $_SERVER['REQUEST_URI'] and (strpos($_SERVER['REQUEST_URI'], '?') !== FALSE)) {\r\n\t\t$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . mso_clean_str($_SERVER['REQUEST_URI']);\r\n\t\t$url = str_replace($CI->config->config['base_url'], \"\", $url);\r\n\t\t$url = explode('?', $url);\r\n\r\n\t\treturn $url[1];\r\n\t} else {\r\n\t\treturn '';\r\n\t}\r\n}\r\n\r\n// \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u043f\u0440\u0435\u043e\u0431\u0440\u0430\u0437\u043e\u0432\u0430\u043d\u0438\u044f get-\u0441\u0442\u0440\u043e\u043a\u0438 \u0432 \u043c\u0430\u0441\u0441\u0438\u0432\r\n// \u0440\u0430\u0437\u0434\u0435\u043b\u0438\u0442\u0435\u043b\u044c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u043c\u0430\u0441\u0441\u0438\u0432\u0430 & \u0438\u043b\u0438 &amp;\r\n// \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 \u0441\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u0443\u044e parse_str\r\nfunction mso_parse_url_get($s = '')\r\n{\r\n\tif ($s) {\r\n\t\t$s = str_replace('&amp;', '&', $s);\r\n\t\t$s = explode('&', $s);\r\n\t\t$uri_get_array = [];\r\n\r\n\t\tforeach ($s as $val) {\r\n\t\t\tparse_str($val, $arr);\r\n\r\n\t\t\tforeach ($arr as $key1 => $val1) {\r\n\t\t\t\t$uri_get_array[$key1] = $val1;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn $uri_get_array;\r\n\t} else {\r\n\t\treturn [];\r\n\t}\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u0435\u043a\u0443\u0449\u0443\u044e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u043f\u0430\u0433\u0438\u043d\u0430\u0446\u0438\u0438\r\n// next - \u043f\u0440\u0438\u0437\u043d\u0430\u043a \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u043f\u043e\u0441\u043b\u0435 \u043a\u043e\u0442\u043e\u0440\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u043e\u043c\u0435\u0440 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\nfunction mso_current_paged($next = 'next')\r\n{\r\n\t// global $MSO;\r\n\r\n\t$uri = mso_current_url(false, true);\r\n\r\n\t// \u044d\u0442\u043e \u0447\u0442\u043e\u0431\u044b \u043d\u0443\u043c\u0435\u0440\u0430\u0446\u0438\u044f \u0441\u043e\u0432\u043f\u0430\u0434\u0430\u043b\u0430 \u0441 $MSO->data['uri_segment'] \u0441 1\r\n\tarray_unshift($uri, '');\r\n\tunset($uri[0]);\r\n\r\n\tif ($n = mso_array_get_key_value($uri, $next)) {\r\n\t\tif (isset($uri[$n + 1]))\r\n\t\t\t$n = (int) $uri[$n + 1];\r\n\t\telse\r\n\t\t\t$n = 1;\r\n\r\n\t\tif ($n > 0)\r\n\t\t\t$current_paged = $n;\r\n\t\telse\r\n\t\t\t$current_paged = 1;\r\n\t} else {\r\n\t\t$current_paged = 1;\r\n\t}\r\n\r\n\treturn $current_paged;\r\n}\r\n\r\n// \u0443\u0432\u0435\u043b\u0438\u0447\u0435\u043d\u0438\u0435 \u0438\u043b\u0438 \u0443\u043c\u0435\u043d\u044c\u0448\u0435\u043d\u0438\u0435 \u0441\u0441\u044b\u043b\u043a\u0438 next \u043d\u0430 \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u0443\u044e \u0432\u0435\u043b\u0438\u0447\u0438\u043d\u0443 $inc\r\n// http://site.com/home/next/2 -> +1 -> http://site.com/home/next/3\r\n// $url - \u0438\u0441\u0445\u043e\u0434\u043d\u044b\u0439 \u0430\u0434\u0440\u0435\u0441 (\u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0441\u0430\u0439\u0442\u0430). \u0415\u0441\u043b\u0438 \u0430\u0434\u0440\u0435\u0441 = \u043f\u0443\u0441\u0442\u043e\u0439 \u0441\u0442\u0440\u043e\u043a\u0435, \r\n//\t\u0442\u043e \u0431\u0435\u0440\u0435\u043c mso_current_url \u0415\u0441\u043b\u0438 \u043f\u0435\u0440\u0432\u044b\u0439 \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u043f\u0443\u0441\u0442\u043e\u0439, \u0442\u043e \u044d\u0442\u043e home\r\n// $inc - \u0432\u0435\u043b\u0438\u0447\u0438\u043d\u0430 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f\r\n// $max - \u043c\u0430\u043a\u0441\u0438\u043c\u0443\u043c - \u0435\u0441\u043b\u0438 $inc + \u0442\u0435\u043a\u0443\u0449\u0438\u0439 > $max, \u0442\u043e \u0441\u0442\u0430\u0432\u0438\u0442\u0441\u044f $max. \u0415\u0441\u043b\u0438 $max = false, \u0442\u043e \u043e\u043d \u043d\u0435 \u0443\u0447\u0438\u0442\u044b\u0432\u0430\u0435\u0442\u0441\u044f\r\n// $min - \u043c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u043e\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435\r\n// $next - \u043f\u0440\u0438\u0437\u043d\u0430\u043a \u0441\u0435\u0433\u043c\u0435\u043d\u0442 \u043f\u043e\u0441\u043b\u0435 \u043a\u043e\u0442\u043e\u0440\u043e\u0433\u043e \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u043e\u043c\u0435\u0440 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n// $empty_no_range = true - \u043e\u0442\u0434\u0430\u0435\u0442 \u043f\u0443\u0441\u0442\u0443\u044e \u0441\u0442\u0440\u043e\u0447\u043a\u0443, \u0435\u0441\u043b\u0438 \u0442\u0435\u043a\u0443\u0449\u0430\u044f paged \u0431\u0443\u0434\u0435\u0442 \u0440\u0430\u0432\u043d\u0430 \u043a\u043e\u043d\u0435\u0447\u043d\u043e\u0439\r\n// \u0435\u0441\u043b\u0438 $empty_no_range = false, \u0442\u043e \u043e\u0442\u0434\u0430\u0435\u043c \u0441\u0441\u044b\u043b\u043a\u0443 \u043a\u0430\u043a \u043e\u0431\u044b\u0447\u043d\u043e\r\nfunction mso_url_paged_inc($max = false, $inc = 1, $empty_no_range = true, $url = '', $min = 1, $next = 'next')\r\n{\r\n\tif (!$url) $url = mso_current_url();\r\n\r\n\t$current_paged = mso_current_paged($next);\r\n\t$result_paged = $current_paged + $inc;\r\n\r\n\tif ($max) if ($result_paged > $max) $result_paged = $max;\r\n\tif ($result_paged < $min) $result_paged = $min;\r\n\tif ($empty_no_range and $result_paged == $current_paged) return '';\r\n\r\n\t// \u0435\u0441\u043b\u0438 \u043d\u0435\u0442 $url, \u0442\u043e \u044d\u0442\u043e \u0433\u043b\u0430\u0432\u043d\u0430\u044f\r\n\tif (!$url) $url = 'home/' . $next . '/' . $current_paged;\r\n\r\n\tif (strpos($url, $next . '/') === false) // \u043d\u0435\u0442 \u0432\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u044f next/ - \u043d\u0443\u0436\u043d\u043e \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c\r\n\t\t$url .= '/' . $next . '/' . $current_paged;\r\n\r\n\t// \u0435\u0441\u043b\u0438 $result_paged = , \u0442\u043e $min, \u0442\u043e\t$next \u043d\u0435 \u043f\u0438\u0448\u0435\u043c\r\n\tif ($result_paged == $min)\r\n\t\t$url = str_replace($next . '/' . $current_paged, '', $url);\r\n\telse\r\n\t\t$url = str_replace($next . '/' . $current_paged, $next . '/' . $result_paged, $url);\r\n\r\n\t// \u0443\u0434\u0430\u043b\u0438\u043c \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0435 \u0441\u043b\u044d\u0448\u0438\r\n\t$url = trim(str_replace('/', ' ', $url));\r\n\t$url = str_replace(' ', '/', $url);\r\n\r\n\tif ($url == 'home') $url = '';\r\n\r\n\treturn getinfo('siteurl') . $url;\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0435\u0440\u043c\u0430\u043b\u0438\u043d\u043a \u0440\u0443\u0431\u0440\u0438\u043a\u0438 \u043f\u043e \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u043c\u0443 \u0441\u043b\u0430\u0433\u0443\r\nfunction mso_get_permalink_cat_slug($slug = '', $prefix = 'category/')\r\n{\r\n\tif (!$slug) return '';\r\n\r\n\treturn  getinfo('siteurl') . $prefix . $slug;\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043f\u0435\u0440\u043c\u0430\u043b\u0438\u043d\u043a \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b \u043f\u043e \u0435\u0451 id \u0447\u0435\u0440\u0435\u0437 \u0437\u0430\u043f\u0440\u043e\u0441 \u0411\u0414\r\nfunction mso_get_permalink_page($id = 0, $prefix = 'page/')\r\n{\r\n\tglobal $MSO;\r\n\r\n\t$id = (int) $id;\r\n\tif (!$id) return '';\r\n\r\n\t$CI = &get_instance();\r\n\t$CI->db->select('page_slug, page_id');\r\n\t$CI->db->where(array('page_id' => $id));\r\n\r\n\t$query = $CI->db->get('page');\r\n\r\n\tif ($query->num_rows() > 0) {\r\n\t\tforeach ($query->result_array() as $row) {\r\n\t\t\t$slug = $row['page_slug'];\r\n\t\t}\r\n\r\n\t\treturn  $MSO->config['site_url'] . $prefix . $slug;\r\n\t} else {\r\n\t\treturn '';\r\n\t}\r\n}\r\n\r\n// \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e url \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0441\u0430\u0439\u0442\u0430\r\n// \u0432\u0435\u0434\u0443\u0449\u0438\u0439 \u0438 \u043a\u043e\u043d\u0435\u0447\u043d\u044b\u0435 \u0441\u043b\u044d\u0448\u0438 \u0443\u0434\u0430\u043b\u044f\u0435\u043c\r\n// \u0435\u0441\u043b\u0438 $absolute = true, \u0442\u043e \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442\u0441\u044f \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u0443\u0440\u043b \u043a\u0430\u043a \u0435\u0441\u0442\u044c\r\nfunction mso_current_url($absolute = false, $explode = false, $delete_request = false)\r\n{\r\n\t$url = getinfo('site_protocol') . $_SERVER['HTTP_HOST'] . mso_clean_str($_SERVER['REQUEST_URI']);\r\n\t\r\n\t//pr($url);\r\n\r\n\tif ($delete_request) {\r\n\t\t// \u043e\u0442\u0434\u0435\u043b\u0438\u043c \u043f\u043e \u00ab?\u00bb\r\n\t\t$url = explode('?', $url);\r\n\t\t$url = $url[0];\r\n\t}\r\n\r\n\tif ($absolute) return $url;\r\n\r\n\t$url = str_replace(getinfo('site_url'), '', $url);\r\n\t$url = trim(str_replace('/', ' ', $url));\r\n\t$url = str_replace(' ', '/', $url);\r\n\t$url = urldecode($url);\r\n\r\n\tif ($explode) $url = explode('/', $url);\r\n\r\n\treturn $url;\r\n}\r\n\r\n// \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442 \u043d\u0430 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u0441\u0430\u0439\u0442\u0430. \u043f\u0443\u0442\u044c \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0441\u0430\u0439\u0442\u0430\r\n// \u0435\u0441\u043b\u0438 $absolute = true - \u043f\u0435\u0440\u0435\u0445\u043e\u0434 \u043f\u043e \u0443\u043a\u0430\u0437\u0430\u043d\u043e\u043c\u0443 \u043f\u0443\u0442\u0438\r\n// $header - 301 \u0438\u043b\u0438 302 \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442\r\nfunction mso_redirect($url = '', $absolute = false, $header = false)\r\n{\r\n\t$url = strip_tags($url);\r\n\t$url = str_replace(array('%0d', '%0a'), '', $url);\r\n\r\n\t$url = mso_xss_clean($url);\r\n\r\n\tif ($header == 301) header('HTTP/1.1 301 Moved Permanently');\r\n\telseif ($header == 302) header('HTTP/1.1 302 Found');\r\n\r\n\tif ($absolute) {\r\n\t\theader(\"Refresh: 0; url={$url}\");\r\n\t\theader(\"Location: {$url}\");\r\n\t} else {\r\n\t\t$url = getinfo('site_url') . $url;\r\n\t\theader(\"Refresh: 0; url={$url}\");\r\n\t\theader(\"Location: {$url}\");\r\n\t}\r\n\t\r\n\texit();\r\n}\r\n\r\n# end of file\r\n", "<?php if (!defined('BASEPATH')) exit('No direct script access allowed'); \r\n\r\n/**\r\n * MaxSite CMS\r\n * (c) http://max-3000.com/\r\n */\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0430\u0432\u0442\u043e\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction global_cache_autoload($args = array())\r\n{\r\n\t// \u0438\u0441\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u0438\u0437 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0430\u0434\u0440\u0435\u0441\u0430 \u043f\u043e \u043f\u0435\u0440\u0432\u043e\u043c\u0443 \u0441\u0435\u0433\u043c\u0435\u043d\u0442\u0443\r\n\t$no_cache = array('admin', 'page_404', 'contact', 'logout', 'login', 'registration', 'password-recovery', 'loginform', 'require-maxsite', 'ajax', 'remote', 'dc', 'feed', 'search');\r\n\t\r\n\tif (in_array(mso_segment(1), $no_cache)) return $args;\r\n\t\r\n\t$options = mso_get_option('plugin_global_cache', 'plugins', array());\r\n\t\r\n\t// \u043a\u044d\u0448 \u0432\u043a\u043b\u044e\u0447\u0435\u043d?\r\n\tif (isset($options['on']) and $options['on'])\r\n\t{\r\n\t\t# \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0435\u0441\u043b\u0438 \u0431\u044b\u043b\u0430 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 POST\r\n\t\tif ( isset($_POST) and $_POST ) global_cache_all_flush();\r\n\t\t\r\n\t\t# \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u0445\u0443\u043a\u0438, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u044e\u0442 \u0441\u0431\u0440\u043e\u0441\u0438\u0442\u044c \u043a\u044d\u0448 - \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0432 \u043f\u043b\u0430\u0433\u0438\u043d\u0430\u0445 \u0438 \u0442.\u043f.\r\n\t\tmso_hook_add('global_cache_key_flush', 'global_cache_key_flush'); // \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\n\t\tmso_hook_add('global_cache_all_flush', 'global_cache_all_flush'); // \u0441\u0431\u0440\u043e\u0441 \u0432\u0441\u0435\u0433\u043e html-\u043a\u044d\u0448\u0430\r\n\t\t\r\n\t\t// \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0433\u043b\u0430\u0432\u043d\u0443\u044e\r\n\t\tif (isset($options['home-only']) and $options['home-only'])\r\n\t\t{\r\n\t\t\tif (!is_type('home')) return $args;\r\n\t\t}\r\n\t\t\r\n\t\t// \u0435\u0441\u043b\u0438 \u0437\u0430\u043b\u043e\u0433\u0438\u043d\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u0438 \u0435\u0441\u0442\u044c \u043e\u043f\u0446\u0438\u044f \u0432\u044b\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f, \u0442\u043e \u043e\u0442\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u043a\u044d\u0448\r\n\t\tif ( (isset($options['onlogin']) and $options['onlogin']) and (is_login() or is_login_comuser()))\r\n\t\t{\r\n\t\t\treturn $args;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// \u0441\u0442\u0430\u0432\u0438\u043c \u0445\u0443\u043a\u0438 \u043d\u0430 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\r\n\t\t\tmso_hook_add('global_cache_start', 'global_cache_start');\r\n\t\t\tmso_hook_add('global_cache_end', 'global_cache_end');\r\n\t\t}\r\n\t}\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0434\u0435\u0430\u043a\u0442\u0438\u0432\u0430\u0446\u0438\u0438 (\u0432\u044b\u043a\u043b) \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction global_cache_deactivate($args = array())\r\n{\t\r\n\t// \u043e\u0447\u0438\u0441\u0442\u0438\u0442\u044c html-\u043a\u044d\u0448\r\n\tglobal_cache_all_flush();\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0434\u0435\u0438\u043d\u0441\u0442\u044f\u043b\u044f\u0446\u0438\u0438 \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction global_cache_uninstall($args = array())\r\n{\t\r\n\t// \u043e\u0447\u0438\u0441\u0442\u0438\u0442\u044c html-\u043a\u044d\u0448\r\n\tglobal_cache_all_flush();\r\n\treturn $args;\r\n}\r\n\r\n# \u0442\u0435\u043a\u0443\u0449\u0438\u0439 \u043a\u043b\u044e\u0447\r\n# \u0435\u0441\u043b\u0438 $dir = true, \u0442\u043e \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0435\u043c \u043a\u0430\u0442\u0430\u043b\u043e\u0433 html\r\nfunction global_cache_key($dir = true)\r\n{\r\n\t$cache_key =  mso_clean_str($_SERVER['REQUEST_URI']); //$_SERVER['REQUEST_URI'];\r\n\t$cache_key = str_replace('/', '-', $cache_key);\r\n\t$cache_key = mso_slug(' ' . $cache_key);\r\n\t\r\n\tif (!$cache_key) $cache_key = 'home'; // \u0433\u043b\u0430\u0432\u043d\u0430\u044f\r\n\t\r\n\tif ($dir) $cache_key = 'html/' . $cache_key . '.html';\r\n\t\telse $cache_key = $cache_key . '.html';\r\n\t\r\n\treturn $cache_key;\r\n}\r\n\r\n# \u0441\u0442\u0430\u0440\u0442 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f\r\nfunction global_cache_start($arg = array())\r\n{\r\n\tif ( $k = mso_get_cache(global_cache_key(), true) ) \r\n\t{\r\n\t\t// \u0434\u0430 \u0435\u0441\u0442\u044c \u0432 \u043a\u044d\u0448\u0435\r\n\t\t$CI = & get_instance();\t\r\n\t\t$mq = $CI->db->query_count; // \u043a\u043e\u043b\u0432\u043e sql-\u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432\r\n\t\t$k = str_replace('<!--global_cache_footer-->', ' | Cache ON (' . $mq . 'sql)', $k);\r\n\t\techo $k; \r\n\t\treturn true;\r\n\t}\r\n\t\r\n\tob_start();\r\n\treturn false;\r\n}\r\n\r\n# \u0441\u0442\u043e\u043f \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f - \u043e\u0442\u0434\u0430\u0447\u0430 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u0430\r\nfunction global_cache_end($arg = array())\r\n{\r\n\t# \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0434\u043b\u044f \u0441\u0442\u0440\u0430\u043d\u0438\u0446, \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b \u043a\u0430\u043a POST\r\n\tif ( isset($_POST) and $_POST ) global_cache_key_flush();\r\n\telse \r\n\t{\r\n\t\t$options = mso_get_option('plugin_global_cache', 'plugins', array());\r\n\t\t\r\n\t\tif (!isset($options['time'])) $options['time'] = 15;\r\n\t\t\r\n\t\tmso_add_cache(global_cache_key(), ob_get_flush(), $options['time'] * 60, true);\r\n\t}\r\n}\r\n\r\n# \u0441\u0431\u0440\u043e\u0441 \u043a\u044d\u0448\u0430 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b\r\nfunction global_cache_key_flush($arg = array())\r\n{\r\n\tmso_flush_cache(false, 'html', global_cache_key(false));\r\n\treturn $arg;\r\n}\r\n\r\n# \u0441\u0431\u0440\u043e\u0441 \u0432\u0441\u0435\u0433\u043e \u043a\u044d\u0448\u0430 html\r\nfunction global_cache_all_flush($arg = array())\r\n{\r\n\tmso_flush_cache(false, 'html');\r\n\treturn $arg;\r\n}\r\n\r\nfunction global_cache_mso_options() \r\n{\r\n\tif ( !mso_check_allow('global_cache_edit') ) \r\n\t{\r\n\t\techo t('\u0414\u043e\u0441\u0442\u0443\u043f \u0437\u0430\u043f\u0440\u0435\u0449\u0435\u043d');\r\n\t\treturn;\r\n\t}\r\n\r\n\t// \u0441\u0431\u0440\u043e\u0441 \u0432\u0441\u0435\u0433\u043e \u043a\u044d\u0448\u0430\r\n\tif ( $post = mso_check_post(array('f_submit_clear_global_cache', 'f_session_id')) )\r\n\t{\r\n\t\tglobal_cache_all_flush();\r\n\t\techo '<div class=\"update\">'. t('\u041a\u044d\u0448 \u043e\u0447\u0438\u0449\u0435\u043d') . '</div>';\r\n\t}\r\n\r\n\t\r\n\t# \u043a\u043b\u044e\u0447, \u0442\u0438\u043f, \u043a\u043b\u044e\u0447\u0438 \u043c\u0430\u0441\u0441\u0438\u0432\u0430\r\n\tmso_admin_plugin_options('plugin_global_cache', 'plugins', \r\n\t\tarray(\r\n\t\t\r\n\t\t\t'on' => array(\r\n\t\t\t\t\t\t\t'type' => 'checkbox', \r\n\t\t\t\t\t\t\t'name' => t('\u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u043e\u0435 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435'), \r\n\t\t\t\t\t\t\t'description' => '', \r\n\t\t\t\t\t\t\t'default' => 1\r\n\t\t\t\t\t\t),\r\n\t\t\t\t\t\t\r\n\t\t\t'home-only' => array(\r\n\t\t\t\t\t\t\t'type' => 'checkbox', \r\n\t\t\t\t\t\t\t'name' => t('\u041a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0433\u043b\u0430\u0432\u043d\u0443\u044e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443'), \r\n\t\t\t\t\t\t\t'description' => '', \r\n\t\t\t\t\t\t\t'default' => 0\r\n\t\t\t\t\t\t),\r\n\t\t\t\r\n\t\t\t'onlogin' => array(\r\n\t\t\t\t\t\t\t'type' => 'checkbox', \r\n\t\t\t\t\t\t\t'name' => t('\u0412\u044b\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u043e\u0435 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0434\u043b\u044f \u0430\u0432\u0442\u043e\u0440\u043e\u0432/\u0430\u0434\u043c\u0438\u043d\u043e\u0432'), \r\n\t\t\t\t\t\t\t'description' => '', \r\n\t\t\t\t\t\t\t'default' => 1\r\n\t\t\t\t\t\t),\r\n\t\t\t\r\n\t\t\t'time' => array(\r\n\t\t\t\t\t\t\t'type' => 'text', \r\n\t\t\t\t\t\t\t'name' => t('\u0412\u0440\u0435\u043c\u044f \u0436\u0438\u0437\u043d\u0438 \u043a\u044d\u0448\u0430 (\u043c\u0438\u043d\u0443\u0442)'), \r\n\t\t\t\t\t\t\t'description' => t('\u0423\u043a\u0430\u0436\u0438\u0442\u0435 \u0432\u0440\u0435\u043c\u044f, \u0447\u0435\u0440\u0435\u0437 \u043a\u043e\u0442\u043e\u0440\u043e\u0435 \u043a\u044d\u0448 \u0443\u0441\u0442\u0430\u0440\u0435\u0435\u0442 \u0438 \u0431\u0443\u0434\u0435\u0442 \u0441\u043e\u0437\u0434\u0430\u043d \u0437\u0430\u043d\u043e\u0432\u043e'), \r\n\t\t\t\t\t\t\t'default' => '15'\r\n\t\t\t\t\t\t),\r\n\t\t\t),\r\n\t\tt('\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u043e\u0433\u043e \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f'), // \u0442\u0438\u0442\u0443\u043b\r\n\t\tt('\u041a\u044d\u0448\u0438\u0440\u0443\u0435\u0442 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b \u0446\u0435\u043b\u0438\u043a\u043e\u043c. \u0412 \u043a\u044d\u0448 \u0431\u0443\u0434\u0435\u0442 \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c\u0441\u044f \u043f\u043e\u043b\u043d\u043e\u0441\u0442\u044c\u044e \u0441\u0433\u0435\u043d\u0435\u0440\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b, \u0447\u0442\u043e \u0443\u0441\u043a\u043e\u0440\u044f\u0435\u0442 \u0440\u0430\u0431\u043e\u0442\u0443 \u0441\u0430\u0439\u0442\u0430. \u0420\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u0435\u0442\u0441\u044f \u0434\u043b\u044f \u0441\u0430\u0439\u0442\u043e\u0432 \u0441 \u0431\u043e\u043b\u044c\u0448\u043e\u0439 \u043f\u043e\u0441\u0435\u0449\u0430\u0435\u043c\u043e\u0441\u0442\u044c\u044e. \u0414\u0430\u043d\u043d\u044b\u0439 \u043a\u044d\u0448 \u043c\u043e\u0436\u0435\u0442 \u0437\u0430\u043d\u0438\u043c\u0430\u0442\u044c \u043c\u043d\u043e\u0433\u043e \u043c\u0435\u0441\u0442\u0430 \u043d\u0430 \u0434\u0438\u0441\u043a\u0435.')   // \u0438\u043d\u0444\u043e\r\n\t);\r\n\t\r\n\techo '<form method=\"post\">' . mso_form_session('f_session_id');\r\n\techo '<p><button class=\"button i-stack-overflow\" type=\"submit\" name=\"f_submit_clear_global_cache\">'. t('\u0421\u0431\u0440\u043e\u0441\u0438\u0442\u044c \u043a\u044d\u0448') . '</button></p>';\r\n\techo '</form>';\r\n\t\r\n}\r\n\r\n# end of file", "<?php if (!defined('BASEPATH')) exit('No direct script access allowed'); \r\n\r\n/**\r\n * MaxSite CMS\r\n * (c) http://max-3000.com/\r\n */\r\n\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0430\u0432\u0442\u043e\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction sape_autoload($args = array())\r\n{\r\n\tmso_hook_add( 'init', 'sape_init'); # \u0445\u0443\u043a \u043d\u0430 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044e\r\n\tmso_hook_add( 'admin_init', 'sape_admin_init'); # \u0445\u0443\u043a \u043d\u0430 \u0430\u0434\u043c\u0438\u043d\u043a\u0443\r\n\tmso_register_widget('sape_widget', 'Sape.ru'); # \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0435\u043c \u0432\u0438\u0434\u0436\u0435\u0442\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0430\u043a\u0442\u0438\u0432\u0430\u0446\u0438\u0438 (\u0432\u043a\u043b) \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction sape_activate($args = array())\r\n{\t\r\n\tmso_create_allow('sape_edit', t('\u0410\u0434\u043c\u0438\u043d-\u0434\u043e\u0441\u0442\u0443\u043f \u043a \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044e sape'));\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0434\u0435\u0438\u043d\u0441\u0442\u0430\u043b\u044f\u0446\u0438\u0438 \u043f\u043b\u0430\u0433\u0438\u043d\u0430\r\nfunction sape_uninstall($args = array())\r\n{\t\r\n\tmso_delete_option_mask('sape_widget_', 'plugins' ); // \u0443\u0434\u0430\u043b\u0438\u043c \u0441\u043e\u0437\u0434\u0430\u043d\u043d\u044b\u0435 \u043e\u043f\u0446\u0438\u0438\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u044f\u0435\u0442\u0441\u044f \u043f\u0440\u0438 \u0443\u043a\u0430\u0437\u0430\u043d\u043e\u043c \u0445\u0443\u043a\u0435 admin_init\r\nfunction sape_admin_init($args = array()) \r\n{\r\n\tif ( mso_check_allow('plugin_sape') ) \r\n\t{\r\n\t\t$this_plugin_url = 'plugin_sape'; // url \u0438 hook\r\n\t\tmso_admin_menu_add('plugins', $this_plugin_url, 'Sape.ru');\r\n\t\tmso_admin_url_hook ($this_plugin_url, 'sape_admin_page');\r\n\t}\r\n\t\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u043c\u0430\u044f \u043f\u0440\u0438 \u0445\u0443\u043a\u0435, \u0443\u043a\u0430\u0437\u0430\u043d\u043d\u043e\u043c \u0432 mso_admin_url_hook\r\nfunction sape_admin_page($args = array()) \r\n{\r\n\r\n\t# \u0432\u044b\u043d\u043e\u0441\u0438\u043c \u0430\u0434\u043c\u0438\u043d\u0441\u043a\u0438\u0435 \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u043e \u0432 \u0444\u0430\u0439\u043b\r\n\tif ( !mso_check_allow('plugin_sape') ) \r\n\t{\r\n\t\techo '\u0414\u043e\u0441\u0442\u0443\u043f \u0437\u0430\u043f\u0440\u0435\u0449\u0435\u043d';\r\n\t\treturn $args;\r\n\t}\r\n\t# \u0432\u044b\u043d\u043e\u0441\u0438\u043c \u0430\u0434\u043c\u0438\u043d\u0441\u043a\u0438\u0435 \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u043e \u0432 \u0444\u0430\u0439\u043b\r\n\tmso_hook_add_dinamic( 'mso_admin_header', ' return $args . \"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 Sape.ru\"; ' );\r\n\tmso_hook_add_dinamic( 'admin_title', ' return \"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 Sape.ru - \" . $args; ' );\r\n\trequire(getinfo('plugins_dir') . 'sape/admin.php');\r\n}\r\n\r\n\r\n# \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u0441\u0430\u043f\u044b\r\nfunction sape_init($args = array()) \r\n{\r\n\tglobal $SAPE, $SAPE_CONTENT, $SAPE_ARTICLE;\r\n\t\r\n\t$options = mso_get_option('sape', 'plugins', array() ); // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438\r\n\t\r\n\tif (isset($options['kod']) \r\n\t\tand isset($options['go']) and $options['go'] \r\n\t\tand isset($options['start']) and $options['start']) // \u043c\u043e\u0436\u043d\u043e \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0442\u044c\r\n\t{\r\n\t\r\n\t\t// \u0435\u0441\u043b\u0438 \u0432\u043a\u044e\u0447\u0435\u043d \u0430\u043d\u0442\u0438\u0447\u0435\u043a\r\n\t\tif (isset($options['anticheck']) and $options['anticheck'])\r\n\t\t{\r\n\t\t// \u0430\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u043c \u0432\u0445\u043e\u0434\u044f\u0449\u0438\u0439 url \u043d\u0430 \u043f\u0440\u0435\u0434\u043c\u0435\u0442 ?\r\n\t\t// \u0435\u0441\u043b\u0438 \u0435\u0441\u0442\u044c, \u0442\u043e \u0434\u0435\u043b\u0430\u0435\u043c \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442 \u043d\u0430 \u0442\u043e, \u0447\u0442\u043e \u0434\u043e ?\r\n\t\t\t// \u0442\u0430\u043a\u0438\u043c \u043e\u0431\u0440\u0430\u0437\u043e\u043c \u043e\u0431\u043d\u0430\u0440\u0443\u0436\u0438\u0442\u044c \u043f\u0440\u043e\u0434\u0430\u0436\u043d\u0443\u044e \u0441\u0441\u044b\u043b\u043a\u0443 \u0431\u0443\u0434\u0435\u0442 \u043d\u0435\u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\r\n\t\t\tif (isset($_SERVER['argv']) and $_SERVER['argv']) // \u0435\u0441\u0442\u044c \u043a\u0430\u043a\u0438\u0435-\u0442\u043e \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b - \u0434\u0435\u043b\u0430\u0435\u043c \u0440\u0435\u0434\u0438\u0440\u0435\u043a\u0442\r\n\t\t\t{\r\n\t\t\t\t$url =  mso_clean_str($_SERVER['REQUEST_URI']); // $_SERVER['REQUEST_URI']; // /?nono  /about/?momo\r\n\t\t\t\t\r\n\t\t\t\t$url = explode('?', $url);\r\n\t\t\t\tif (isset($url[0])) $url = $url[0];\r\n\t\t\t\telse $url = '';\r\n\t\t\t\t\r\n\t\t\t\t$url = '/' . trim(str_replace('/', ' ', $url));\r\n\t\t\t\t$url = str_replace(' ', '/', $url);\r\n\t\t\t\t$url = 'http://' . $_SERVER['HTTP_HOST'] . $url;\r\n\t\t\t\t\r\n\t\t\t\theader('HTTP/1.1 301 Moved Permanently');\r\n\t\t\t\theader('Location: ' . $url);\r\n\t\t\t\texit;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif ( !defined('_SAPE_USER') ) define('_SAPE_USER', $options['kod']);\r\n\t\t\r\n\t\t// \u0435\u0441\u043b\u0438 \u0444\u0430\u0439\u043b\u0430 \u0441\u0430\u043f\u044b \u043d\u0435\u0442, \u0442\u043e \u0432\u044b\u0445\u043e\u0434\u0438\u043c\r\n\t\tif (!file_exists($_SERVER['DOCUMENT_ROOT'] . '/' . _SAPE_USER . '/sape.php')) return $args;\r\n\t\t\r\n\t\trequire_once($_SERVER['DOCUMENT_ROOT'] . '/' . _SAPE_USER . '/sape.php');\r\n\t\t\r\n\t\t$sa['charset'] = 'UTF-8';\r\n\t\t\r\n\t\t//$sa['fetch_remote_type'] = 'file_get_contents'; // file_get_contents|curl|socket\r\n\t\t\r\n\t\tif (isset($options['test']) and $options['test']) $sa['force_show_code'] = true;\r\n\t\t\r\n\t\tif (isset($options['multi_site']) and $options['multi_site']) $sa['multi_site'] = true;\r\n\r\n\t\t$SAPE = new SAPE_client($sa);\r\n\t\t\r\n\t\tif (isset($options['context']) and $options['context'])\r\n\t\t{\r\n\t\t\tif ( !isset($SAPE_CONTENT) ) $SAPE_CONTENT = new SAPE_context(array('charset' => 'UTF-8'));\r\n\t\t\tmso_hook_add( 'content_content', 'sape_content'); # \u0445\u0443\u043a \u043d\u0430 \u043a\u043e\u043d\u0435\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442 \u0434\u043b\u044f \u0432\u044b\u0432\u043e\u0434\u0430\r\n\t\t\t\r\n\t\t\tif (isset($options['context_comment']) and $options['context_comment'])\r\n\t\t\t\tmso_hook_add( 'comments_content_out', 'sape_content'); \r\n\t\t\t\t# \u0445\u0443\u043a \u043d\u0430 \u043a\u043e\u043d\u0435\u0447\u043d\u044b\u0439 \u0442\u0435\u043a\u0441\u0442 \u0434\u043b\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0432 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u044f\u0445\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$SAPE_CONTENT = false;\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\tif (isset($options['articles']) and $options['articles'] )\r\n\t\t{\r\n\t\t\r\n\t\t\tif ( !isset($SAPE_ARTICLE) ) $SAPE_ARTICLE = new SAPE_articles();\r\n\t\t\t\r\n\t\t\t// \u044d\u0442\u043e \u0432\u044b\u0432\u043e\u0434 \u0440\u0435\u043a\u043b\u0430\u043c\u043d\u043e\u0439 \u0441\u0442\u0430\u0442\u044c\u0438\r\n\t\t\tif (isset($options['articles_url']) and mso_segment(1) == $options['articles_url'] )\r\n\t\t\t{\r\n\t\t\t\t# \u0445\u0443\u043a \u0434\u043b\u044f \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043a \u0448\u0430\u0431\u043b\u043e\u043d\u0443\r\n\t\t\t\tmso_hook_add('custom_page_404', 'sape_articles_custom_page_404');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// \u0438\u043b\u0438 \u0437\u0430\u043f\u0440\u043e\u0441 \u0448\u0430\u0431\u043b\u043e\u043d\u0430 \u043e\u0442 \u0440\u043e\u0431\u043e\u0442\u0430 \u0441\u0430\u043f\u044b\r\n\t\t\tif ( isset($options['articles_template']) and mso_segment(1) == $options['articles_template'] )\r\n\t\t\t{\r\n\t\t\t\t# \u0445\u0443\u043a \u0434\u043b\u044f \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043a \u0448\u0430\u0431\u043b\u043e\u043d\u0443\r\n\t\t\t\tmso_hook_add('custom_page_404', 'sape_articles_template_custom_page_404');\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$SAPE_ARTICLE = false;\r\n\t\t}\r\n\t\t\r\n\t}\r\n\t\r\n\treturn $args;\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f, \u043a\u043e\u0442\u043e\u0440\u0430\u044f \u0431\u0435\u0440\u0435\u0442 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0438\u0437 \u043e\u043f\u0446\u0438\u0439 \u0432\u0438\u0434\u0436\u0435\u0442\u043e\u0432\r\nfunction sape_widget($num = 1) \r\n{\r\n\t$widget = 'sape_widget_' . $num; // \u0438\u043c\u044f \u0434\u043b\u044f \u043e\u043f\u0446\u0438\u0439 = \u0432\u0438\u0434\u0436\u0435\u0442 + \u043d\u043e\u043c\u0435\u0440\r\n\t$options = mso_get_option($widget, 'plugins', array() ); // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438\r\n\t\r\n\t// \u0437\u0430\u043c\u0435\u043d\u0438\u043c \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a, \u0447\u0442\u043e\u0431\u044b \u0431\u044b\u043b \u0432  h2 class=\"box\"\r\n\tif ( isset($options['header']) and $options['header'] ) $options['header'] = mso_get_val('widget_header_start', '<h2 class=\"box\"><span>') . $options['header'] . mso_get_val('widget_header_end', '</span></h2>');\r\n\t\telse $options['header'] = '';\r\n\t\r\n\treturn sape_widget_custom($options, $num);\r\n}\r\n\r\n\r\n# \u0444\u043e\u0440\u043c\u0430 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0432\u0438\u0434\u0436\u0435\u0442\u0430 \r\n# \u0438\u043c\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u0438 = \u0432\u0438\u0434\u0436\u0435\u0442_form\r\nfunction sape_widget_form($num = 1) \r\n{\r\n\t$widget = 'sape_widget_' . $num; // \u0438\u043c\u044f \u0434\u043b\u044f \u0444\u043e\u0440\u043c\u044b \u0438 \u043e\u043f\u0446\u0438\u0439 = \u0432\u0438\u0434\u0436\u0435\u0442 + \u043d\u043e\u043c\u0435\u0440\r\n\t\r\n\t// \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438 \r\n\t$options = mso_get_option($widget, 'plugins', array());\r\n\t\r\n\tif ( !isset($options['header']) ) $options['header'] = '';\r\n\tif ( !isset($options['count']) ) $options['count'] = '';\r\n\tif ( !isset($options['htmldo']) ) $options['htmldo'] = '';\r\n\tif ( !isset($options['htmlposle']) ) $options['htmlposle'] = '';\r\n\tif ( !isset($options['links_or_articles']) ) $options['links_or_articles'] = 'links';\r\n\t\r\n\t// \u0432\u044b\u0432\u043e\u0434 \u0441\u0430\u043c\u043e\u0439 \u0444\u043e\u0440\u043c\u044b\r\n\t$CI = & get_instance();\r\n\t$CI->load->helper('form');\r\n\t\r\n\t$form = mso_widget_create_form(t('\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a'), form_input( array( 'name'=>$widget . 'header', 'value'=>$options['header'])));\r\n\t\r\n\t$form .= mso_widget_create_form(t('\u041a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0441\u0441\u044b\u043b\u043e\u043a'), form_input( array( 'name'=>$widget . 'count', 'value'=>$options['count'])), t('\u0415\u0441\u043b\u0438 \u044d\u0442\u043e\u0442 \u0432\u0438\u0434\u0436\u0435\u0442 \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u0438\u043b\u0438 \u0435\u0434\u0438\u043d\u0441\u0442\u0432\u0435\u043d\u043d\u044b\u0439, \u0442\u043e \u043e\u0441\u0442\u0430\u0432\u044c\u0442\u0435 \u044d\u0442\u043e \u043f\u043e\u043b\u0435 \u043f\u0443\u0441\u0442\u044b\u043c \u0438\u043b\u0438 0'));\r\n\t\r\n\t$form .= mso_widget_create_form(t('HTML \u0434\u043e'), form_input( array( 'name'=>$widget . 'htmldo', 'value'=>$options['htmldo'])), '');\r\n\t\r\n\t$form .= mso_widget_create_form(t('HTML \u043f\u043e\u0441\u043b\u0435'), form_input( array( 'name'=>$widget . 'htmlposle', 'value'=>$options['htmlposle'])), '');\r\n\t\r\n\t$form .= mso_widget_create_form(t('\u0412\u044b\u0432\u043e\u0434\u0438\u0442\u044c'), form_dropdown( $widget . 'links_or_articles', array('links'=>t('\u0421\u0441\u044b\u043b\u043a\u0438'), 'articles'=>t('\u0421\u0442\u0430\u0442\u044c\u0438')), $options['links_or_articles']), '');\r\n\t\r\n\t\r\n\treturn $form;\r\n}\r\n\r\n\r\n# \u0441\u044e\u0434\u0430 \u043f\u0440\u0438\u0445\u043e\u0434\u044f\u0442 POST \u0438\u0437 \u0444\u043e\u0440\u043c\u044b \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0432\u0438\u0434\u0436\u0435\u0442\u0430\r\n# \u0438\u043c\u044f \u0444\u0443\u043d\u043a\u0446\u0438\u0438 = \u0432\u0438\u0434\u0436\u0435\u0442_update\r\nfunction sape_widget_update($num = 1) \r\n{\r\n\t$widget = 'sape_widget_' . $num; // \u0438\u043c\u044f \u0434\u043b\u044f \u043e\u043f\u0446\u0438\u0439 = \u0432\u0438\u0434\u0436\u0435\u0442 + \u043d\u043e\u043c\u0435\u0440\r\n\t\r\n\t// \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u043e\u043f\u0446\u0438\u0438\r\n\t$options = $newoptions = mso_get_option($widget, 'plugins', array());\r\n\t\r\n\t# \u043e\u0431\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u0435\u043c POST\r\n\t$newoptions['header'] = mso_widget_get_post($widget . 'header');\r\n\t$newoptions['count'] = (int) mso_widget_get_post($widget . 'count');\r\n\t$newoptions['htmldo'] = mso_widget_get_post($widget . 'htmldo');\r\n\t$newoptions['htmlposle'] = mso_widget_get_post($widget . 'htmlposle');\r\n\t$newoptions['links_or_articles'] = mso_widget_get_post($widget . 'links_or_articles');\r\n\t\r\n\tif ( $options != $newoptions ) \r\n\t\tmso_add_option($widget, $newoptions, 'plugins' );\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0432\u0438\u0434\u0436\u0435\u0442\u0430\r\nfunction sape_widget_custom($options = array(), $num = 1)\r\n{\r\n\tif ( !isset($options['header']) ) $options['header'] = '';\r\n\tif ( !isset($options['count']) ) $options['count'] = 0;\r\n\tif ( !isset($options['htmldo']) ) $options['htmldo'] = '';\r\n\tif ( !isset($options['htmlposle']) ) $options['htmlposle'] = '';\r\n\tif ( !isset($options['links_or_articles']) ) $options['links_or_articles'] = 'links';\r\n\t\r\n\tif ($options['links_or_articles'] == 'links')\r\n\t{\r\n\t\t$out = sape_out($options['count'] , false); // \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u043c \u0441\u0441\u044b\u043b\u043a\u0438\r\n\t\t\r\n\t\tif ($out == '<!--check code-->') // \u0432\u0435\u0440\u043d\u0443\u043b\u0441\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043e\u0447\u043d\u044b\u0439 \u043a\u043e\u0434\r\n\t\t{\r\n\t\t\t$out = '<!--check code-->\u041a\u043e\u0434 <a href=\"http://www.sape.ru/r.aa92aef9c6.php\" target=\"_blank\">sape.ru</a> \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d \u0432\u0435\u0440\u043d\u043e!';\r\n\t\t\treturn $out;\r\n\t\t}\r\n\t\telseif ($out and $options['header']) $out = $options['header'] . $options['htmldo'] . $out . $options['htmlposle'];\r\n\t\treturn $out;\r\n\t}\r\n\telseif ($options['links_or_articles'] == 'articles')\r\n\t{\r\n\t\tglobal $SAPE_ARTICLE;\r\n\t\t\r\n\t\t//pr($SAPE_ARTICLE);\r\n\t\t\r\n\t\t$out = $SAPE_ARTICLE->return_announcements();\r\n\t\t\r\n\t\t// \u044d\u0442\u043e \u0447\u0435\u043a\u043a\u043e\u0434\r\n\t\tif ($out == $SAPE_ARTICLE->_data['index']['checkCode'])\r\n\t\t{\r\n\t\t\treturn $out;\r\n\t\t}\r\n\t\t\r\n\t\t$out_check = strip_tags($out); // \u0435\u0441\u0442\u044c \u0442\u0435\u043a\u0441\u0442\u044b\r\n\t\t\r\n\t\tif ($out_check and $options['header']) \r\n\t\t\t$out = $options['header'] . $options['htmldo'] . $out . $options['htmlposle'];\r\n\t\t\r\n\t\treturn $out;\r\n\t}\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u0431\u043b\u043e\u043a\u0430 \u0441\u0441\u044b\u043b\u043e\u043a\r\nfunction sape_out($count = 0, $echo = true)\r\n{\r\n\tglobal $SAPE;\r\n\t\r\n\t$out = '';\r\n\t\r\n\tif (isset($SAPE) and $SAPE)\r\n\t{\r\n\t\tif ($count)\r\n\t\t{\r\n\t\t\t$out = $SAPE->return_links($count);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t$out = $SAPE->return_links();\r\n\t\t}\r\n\t}\r\n\t\r\n\tif ($echo) echo $out;\r\n\t\telse return $out;\t\r\n}\r\n\r\n# \u0444\u0443\u043d\u043a\u0446\u0438\u044f \u0432\u044b\u0432\u043e\u0434\u0430 \u043a\u043e\u043d\u0442\u0435\u043d\u0442\u0430\r\nfunction sape_content($text = '')\r\n{\r\n\tglobal $SAPE_CONTENT;\r\n\t\r\n\tif ($SAPE_CONTENT)\r\n\t{\r\n\t\t// $text = 'TEXT-DO ' . $SAPE_CONTENT->replace_in_text_segment($text) . ' TEXT-POSLE'; // \u043a\u043e\u043d\u0442\u0440\u043e\u043b\u044c\r\n\t\t$text = $SAPE_CONTENT->replace_in_text_segment($text);\r\n\t}\r\n\t\r\n\treturn $text;\r\n}\r\n\r\n\r\n# \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0435\u043c \u0441\u0432\u043e\u0439 \u0444\u0430\u0439\u043b \u043a \u0448\u0430\u0431\u043b\u043e\u043d\u0443\r\nfunction sape_articles_template_custom_page_404($args = false)\r\n{\r\n\trequire( getinfo('plugins_dir') . 'sape/articles_template.php' ); // \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0438\u043b\u0438 \u0441\u0432\u043e\u0439 \u0444\u0430\u0439\u043b \u0432\u044b\u0432\u043e\u0434\u0430\r\n\treturn true; // \u0432\u044b\u0445\u043e\u0434\u0438\u043c \u0441 true\r\n}\r\n\r\nfunction sape_articles_custom_page_404($args = false)\r\n{\r\n\tglobal $SAPE_ARTICLE;\r\n\t\r\n\t// \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u043c http-\u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a\r\n\theader(\"HTTP/1.x 200 OK\", TRUE);\r\n\t\r\n\t// \u0434\u043e\u0431\u0430\u0432\u0438\u043b echo\r\n\techo $SAPE_ARTICLE->process_request();\r\n\r\n\treturn true; // \u0432\u044b\u0445\u043e\u0434\u0438\u043c \u0441 true\r\n}\r\n\r\n\r\n# end of file"], "filenames": ["application/maxsite/common/core/format.php", "application/maxsite/common/core/url.php", "application/maxsite/plugins/global_cache/index.php", "application/maxsite/plugins/sape/index.php"], "buggy_code_start_loc": [83, 47, 68, 81], "buggy_code_end_loc": [84, 225, 69, 82], "fixing_code_start_loc": [83, 47, 68, 81], "fixing_code_end_loc": [85, 227, 69, 82], "type": "CWE-79", "message": "A reflected cross-site scripting (XSS) vulnerability in MaxSite CMS before V106 via product/page/* allows remote attackers to inject arbitrary web script to a page.", "other": {"cve": {"id": "CVE-2021-35265", "sourceIdentifier": "cve@mitre.org", "published": "2021-08-03T12:15:07.880", "lastModified": "2021-08-06T14:07:36.013", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A reflected cross-site scripting (XSS) vulnerability in MaxSite CMS before V106 via product/page/* allows remote attackers to inject arbitrary web script to a page."}, {"lang": "es", "value": "Una vulnerabilidad de tipo cross-site scripting (XSS) reflejado en MaxSite CMS versiones anteriores a V106, por medio de product/page/* permite a atacantes remotos inyectar un script web arbitrario en una p\u00e1gina"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:maxsite:maxsite_cms:*:*:*:*:*:*:*:*", "versionEndExcluding": "106", "matchCriteriaId": "7DF4DB5E-8339-4985-9ABC-811FC2C28960"}]}]}], "references": [{"url": "https://github.com/maxsite/cms/commit/6b0ab1de9f3d471485d1347e800a9ce43fedbf1a", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/maxsite/cms/issues/414#issue-726249183", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/maxsite/cms/commit/6b0ab1de9f3d471485d1347e800a9ce43fedbf1a"}}