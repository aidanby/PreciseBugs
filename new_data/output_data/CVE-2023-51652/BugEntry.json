{"buggy_code": ["/*\n * Copyright (c) 2009-2022, Arshan Dabirsiaghi, Sebasti\u00e1n Passaro\n * \n * All rights reserved.\n * \n * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n * \n * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n * Neither the name of OWASP nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF\n * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING\n * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Text;\nusing System.Text.RegularExpressions;\nusing FluentAssertions;\nusing NUnit.Framework;\nusing OWASP.AntiSamy.Html;\nusing OWASP.AntiSamy.Html.Model;\nusing OWASP.AntiSamy.Html.Util;\nusing Attribute = OWASP.AntiSamy.Html.Model.Attribute;\nusing Constants = OWASP.AntiSamy.Html.Scan.Constants;\n\nnamespace AntiSamyTests\n{\n    [TestFixture]\n    public class AntiSamyTest\n    {\n        private AntiSamy antisamy;\n        private TestPolicy policy;\n\n        [SetUp]\n        public void SetUp()\n        {\n            antisamy = new AntiSamy();\n            policy = TestPolicy.GetInstance(TestConstants.DEFAULT_POLICY_PATH);\n        }\n\n        [Test(Description = \"Test basic XSS cases.\")]\n        public void TestScriptAttacks()\n        {\n            antisamy.Scan(\"test<script>alert(document.cookie)</script>\", policy).GetCleanHtml().Should().NotContain(\"script\");\n            antisamy.Scan(\"<<<><<script src=http://fake-evil.ru/test.js>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<script<script src=http://fake-evil.ru/test.js>>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT/XSS SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<BODY onload!#$%&()*~+-_.,:;?@[/|\\\\]^`=alert(\\\"XSS\\\")>\", policy).GetCleanHtml().Should().NotContain(\"onload\");\n            antisamy.Scan(\"<BODY ONLOAD=alert('XSS')>\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<iframe src=http://ha.ckers.org/scriptlet.html <\", policy).GetCleanHtml().Should().NotContain(\"<iframe\");\n            antisamy.Scan(\"<INPUT TYPE=\\\"IMAGE\\\" SRC=\\\"javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"src\");\n        }\n\n        [Test]\n        public void TestImgAttacks()\n        {\n            antisamy.Scan(\"<img src='http://www.myspace.com/img.gif'>\", policy).GetCleanHtml().Should().Contain(\"<img\");\n            antisamy.Scan(\"<img src=javascript:alert(document.cookie)>\", policy).GetCleanHtml().Should().NotContain(\"<img\");\n            antisamy.Scan(\"<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>\", policy).GetCleanHtml()\n                .Should().NotContain(\"<img\");\n            antisamy.Scan(\"<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040\" +\n                \"&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>\", policy).GetCleanHtml().Should().Contain(\"&amp;\");\n            antisamy.Scan(\"<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>\", policy).GetCleanHtml()\n                .Should().Contain(\"&amp;\");\n            antisamy.Scan(\"<IMG SRC=\\\"jav&#x0D;ascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<IMG SRC=\\\"javascript:alert('XSS')\\\"\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<IMG LOWSRC=\\\"javascript:alert('XSS')\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<BGSOUND SRC=\\\"javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n        }\n\n        [Test]\n        public void TestHrefAttacks()\n        {\n            antisamy.Scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"href\");\n            antisamy.Scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"http://ha.ckers.org/xss.css\\\">\", policy).GetCleanHtml().Should().NotContain(\"href\");\n            antisamy.Scan(\"<STYLE>@import'http://ha.ckers.org/xss.css';</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"ha.ckers.org\");\n            antisamy.Scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"ha.ckers.org\");\n            antisamy.Scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"xss.htc\");\n            antisamy.Scan(\"<STYLE>li {list-style-image: url(\\\"javascript:alert('XSS')\\\");}</STYLE><UL><LI>XSS\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<IMG SRC='vbscript:msgbox(\\\"XSS\\\")'>\", policy).GetCleanHtml().Should().NotContain(\"vbscript\");\n            antisamy.Scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0; URL=http://;URL=javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"<meta\");\n            antisamy.Scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"<meta\");\n            antisamy.Scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\\\">\", policy).GetCleanHtml().Should().NotContain(\"<meta\");\n            antisamy.Scan(\"<IFRAME SRC=\\\"javascript:alert('XSS');\\\"></IFRAME>\", policy).GetCleanHtml().Should().NotContain(\"iframe\");\n            antisamy.Scan(\"<FRAMESET><FRAME SRC=\\\"javascript:alert('XSS');\\\"></FRAMESET>\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<TABLE BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy).GetCleanHtml().Should().NotContain(\"background\");\n            antisamy.Scan(\"<TABLE><TD BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy).GetCleanHtml().Should().NotContain(\"background\");\n            antisamy.Scan(\"<DIV STYLE=\\\"background-image: url(javascript:alert('XSS'))\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<DIV STYLE=\\\"width: expression(alert('XSS'));\\\">\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<IMG STYLE=\\\"xss:expr/*XSS*/ession(alert('XSS'))\\\">\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<STYLE>@im\\\\port'\\\\ja\\\\vasc\\\\ript:alert(\\\"XSS\\\")';</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"ript:alert\");\n            antisamy.Scan(\"<BASE HREF=\\\"javascript:alert('XSS');//\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<BaSe hReF=\\\"http://arbitrary.com/\\\">\", policy).GetCleanHtml().Should().NotContain(\"<base\");\n            antisamy.Scan(\"<OBJECT TYPE=\\\"text/x-scriptlet\\\" DATA=\\\"http://ha.ckers.org/scriptlet.html\\\"></OBJECT>\", policy).GetCleanHtml().Should().NotContain(\"<object\");\n            antisamy.Scan(\"<OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389><param name=url value=javascript:alert('XSS')></OBJECT>\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<EMBED SRC=\\\"http://ha.ckers.org/xss.swf\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy).GetCleanHtml().Should().NotContain(\"<embed\");\n            antisamy.Scan(\"<EMBED SRC=\\\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJod\" +\n                \"HRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUy\" +\n                \"IpOzwvc2NyaXB0Pjwvc3ZnPg==\\\" type=\\\"image/svg+xml\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy).GetCleanHtml().Should().NotContain(\"<embed\");\n            antisamy.Scan(\"<SCRIPT a=\\\">\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT a=\\\">\\\" '' SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT a=`>` SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT a=\\\">'>\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT>document.write(\\\"<SCRI\\\");</SCRIPT>PT SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"script\");\n            antisamy.Scan(\"<SCRIPT SRC=http://ha.ckers.org/xss.js\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<div/style=&#92&#45&#92&#109&#111&#92&#122&#92&#45&#98&#92&#105&#92&#110&#100&#92&#105&#110&#92&#103:&#92&#117&#114&#108&#40&#47&#47&#98&#117&#115&#105&#110&#101&#115\" +\n                \"&#115&#92&#105&#92&#110&#102&#111&#46&#99&#111&#46&#117&#107&#92&#47&#108&#97&#98&#115&#92&#47&#120&#98&#108&#92&#47&#120&#98&#108&#92&#46&#120&#109&#108&#92&#35&#120&#115&#115\" +\n                \"&#41&>\", policy).GetCleanHtml().Should().NotContain(\"&amp;\");\n            antisamy.Scan(\"<a href='aim: &c:\\\\windows\\\\system32\\\\calc.exe' ini='C:\\\\Documents and Settings\\\\All Users\\\\Start Menu\\\\Programs\\\\Startup\\\\pwnd.bat'>\", policy).GetCleanHtml()\n                .Should().NotContain(\"aim.exe\");\n            antisamy.Scan(\"<!--\\n<A href=\\n- --><a href=javascript:alert:document.domain>test-->\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<a></a style=\\\"\\\"xx:expr/**/ession(document.appendChild(document.createElement('script')).src='http://h4k.in/i.js')\\\">\", policy).GetCleanHtml()\n                .Should().NotContain(\"document\");\n            antisamy.Scan(\"<dIv/sTyLe='background-image: url(sheep.png), url(\\\"javascript:alert(1)\\\");'></dIv>\", policy).GetCleanHtml().Should().Contain(\"style=''\");\n            antisamy.Scan(\"<dIv/sTyLe='background-image: url(sheep.png), url(\\\"https://safe.com/kitten.jpg\\\");'></dIv>\", policy).GetCleanHtml()\n                .Should().ContainAll(\"sheep.png\", \"kitten.jpg\");\n            antisamy.Scan(\"<a href=\\\"http://example.com\\\"&amp;/onclick=alert(9)>foo</a>\", policy).GetCleanHtml().Should().Be(\"<a href=\\\"http://example.com\\\" rel=\\\"nofollow\\\">foo</a>\");\n        }\n\n        [Test(Description = \"Test CSS protections.\")]\n        public void TestCssAttacks()\n        {\n            antisamy.Scan(\"<div style=\\\"position:absolute\\\">\", policy).GetCleanHtml().Should().NotContain(\"position\");\n            antisamy.Scan(\"<style>b { position:absolute }</style>\", policy).GetCleanHtml().Should().NotContain(\"position\");\n            antisamy.Scan(\"<div style=\\\"z-index:25\\\">\", policy).GetCleanHtml().Should().NotContain(\"z-index\");\n            antisamy.Scan(\"<style>z-index:25</style>\", policy).GetCleanHtml().Should().NotContain(\"z-index\");\n        }\n\n        [Test(Description = \"Tests issues #12 and #36 from owaspantisamy Google Code Archive.\")]\n        public void TestEmptyTags()\n        {\n            string html = antisamy.Scan(\"<br ><strong></strong><a>hello world</a><b /><i/><hr>\", policy).GetCleanHtml();\n\n            var regex = new Regex(\".*<strong(\\\\s*)/>.*\");\n            regex.IsMatch(html).Should().BeFalse();\n\n            regex = new Regex(\".*<b(\\\\s*)/>.*\");\n            regex.IsMatch(html).Should().BeFalse();\n\n            regex = new Regex(\".*<i(\\\\s*)/>.*\");\n            regex.IsMatch(html).Should().BeFalse();\n\n            (html.Contains(\"<hr />\") || html.Contains(\"<hr/>\")).Should().BeTrue();\n        }\n\n        [Test(Description = \"Tests issue #20 from owaspantisamy Google Code Archive.\")]\n        public void TestMisplacedTag()\n        {\n            antisamy.Scan(\"<b><i>Some Text</b></i>\", policy).GetCleanHtml().Should().NotContain(\"<i />\");\n        }\n\n        [Test(Description = \"Tests issue #25 from owaspantisamy Google Code Archive.\")]\n        public void TestMarginRemovalFromInlineStyle()\n        {\n            antisamy.Scan(\"<div style=\\\"margin: -5em\\\">Test</div>\", policy).GetCleanHtml().Should().Be(\"<div style=\\\"\\\">Test</div>\");\n        }\n\n        [Test(Description = \"Tests issue #28 from owaspantisamy Google Code Archive.\")]\n        public void TestPreserveFontFamily()\n        {\n            antisamy.Scan(\"<div style=\\\"font-family: Geneva, Arial, courier new, sans-serif\\\">Test</div>\", policy).GetCleanHtml().Should().Contain(\"font-family\");\n        }\n\n        [Test(Description = \"Tests issue #30 from owaspantisamy Google Code Archive>: 'missing quotes around properties with spaces'\")]\n        [Ignore(\"CDATA is not handled by HtmlAgilityPack the same way than the Java version. The code works but the format is just different.\")]\n        public void TestCssPropertiesWithMultilineAndCData()\n        {\n            // The current result in Windows and with HtmlAgilityPack is: \n            // \"<style type=\\\"text/css\\\">\\r\\n//<![CDATA[\\r\\nP { font-family: &quot;Arial Unicode MS&quot; }\\r\\n//]]>//\\r\\n</style>\"\n            const string html = \"<style type=\\\"text/css\\\"><![CDATA[P {\\n\tfont-family: \\\"Arial Unicode MS\\\";\\n}\\n]]></style>\";\n            antisamy.Scan(html, policy).GetCleanHtml().Should().Be(html);\n\n            antisamy.Scan(\"<style type=\\\"text/css\\\"><![CDATA[\\r\\nP {\\r\\n margin-bottom: 0.08in;\\r\\n}\\r\\n]]></style>\", policy).GetCleanHtml()\n                .Should().Be(\"<style type=\\\"text/css\\\"><![CDATA[P {\\n\\tmargin-bottom: 0.08in;\\n}\\n]]></style>\");\n        }\n\n        [Test(Description = \"Tests issue #31 from owaspantisamy Google Code Archive.\")]\n        public void TestUnknownTagEncoding()\n        {\n            const string html = \"<b><u><g>foo</g></u></b>\";\n\n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_ENCODE);\n            antisamy.Scan(html, revised).GetCleanHtml().Should().ContainAll(\"&lt;g&gt;\", \"&lt;/g&gt;\");\n\n            Tag tag = policy.GetTagByName(\"b\").MutateAction(\"encode\");\n            Policy revised2 = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER).MutateTag(tag);\n            antisamy.Scan(html, revised2).GetCleanHtml().Should().ContainAll(\"&lt;b&gt;\", \"&lt;/b&gt;\");\n        }\n\n        [Test(Description = \"Tests issue #38 from owaspantisamy Google Code Archive.\")]\n        public void TestColorProcessing()\n        {\n            antisamy.Scan(\"<font color=\\\"#fff\\\">Test</font>\", policy).GetCleanHtml().Should().Be(\"<font color=\\\"#fff\\\">Test</font>\");\n            // AngleSharp replaces the CSS color hex value into rgba instead of rgb, expected results are expanded in case the library changes.\n            antisamy.Scan(\"<div style=\\\"color: #fff\\\">Test 3 letter code</div>\").GetCleanHtml().Should().ContainAny(\n                \"color: rgba(255, 255, 255, 1)\",\n                \"color: rgba(255,255,255,1)\",\n                \"color: rgb(255, 255, 255)\",\n                \"color: rgb(255,255,255)\");\n            antisamy.Scan(\"<font color=\\\"red\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font color=\\\"red\\\">Test</font>\");\n            antisamy.Scan(\"<font color=\\\"neonpink\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font>Test</font>\");\n            antisamy.Scan(\"<font color=\\\"#0000\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font>Test</font>\");\n            // This gets interpreted by AngleSharp as #0 = #00, so it's valid RGBA (0,0,0,0)\n            antisamy.Scan(\"<div style=\\\"color: #0000\\\">Test</div>\").GetCleanHtml().Should().ContainAny(\n                \"color: rgba(0, 0, 0, 0)\",\n                \"color: rgba(0,0,0,0)\",\n                \"color: rgb(0, 0, 0)\",\n                \"color: rgb(0,0,0)\");\n            // This assertion is added to make the previous case invalid as in the original Java test\n            antisamy.Scan(\"<div style=\\\"color: #00000\\\">Test</div>\").GetCleanHtml().Should().Be(\"<div style=\\\"\\\">Test</div>\");\n            antisamy.Scan(\"<font color=\\\"#000000\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font color=\\\"#000000\\\">Test</font>\");\n            // Also AngleSharp asumes 1 in alpha value if the last hex are not present\n            antisamy.Scan(\"<div style=\\\"color: #000000\\\">Test</div>\").GetCleanHtml().Should().ContainAny(\n                \"color: rgba(0, 0, 0, 1)\",\n                \"color: rgba(0,0,0,1)\",\n                \"color: rgb(0, 0, 0)\",\n                \"color: rgb(0,0,0)\");\n\n            // Testing an error that came up on a dependency from the Java version\n            string result = null;\n            try\n            {\n                result = antisamy.Scan(\"<b><u>foo<style><script>alert(1)</script></style>@import 'x';</u>bar\").GetCleanHtml();\n            }\n            catch (Exception)\n            {\n                // To comply with try/catch\n            }\n\n            result.Should().NotBeNull();\n        }\n\n        [Test(Description = \"Tests issue #40 from owaspantisamy Google Code Archive.\")]\n        public void TestMediaAttributeHandling()\n        {\n            antisamy.Scan(\"<style media=\\\"print, projection, screen\\\"> P { margin: 1em; }</style>\", policy).GetCleanHtml()\n                .Should().Contain(\"print, projection, screen\");\n        }\n\n        [Test(Description = \"Tests issue #41 from owaspantisamy Google Code Archive.\")]\n        public void TestCommentProcessing()\n        {\n            Policy revised = policy.CloneWithDirective(Constants.PRESERVE_SPACE, \"true\");\n\n            antisamy.Scan(\"text <!-- comment -->\", revised).GetCleanHtml().Should().Be(\"text \");\n\n            Policy revised2 = policy\n                .CloneWithDirective(Constants.PRESERVE_COMMENTS, \"true\")\n                .CloneWithDirective(Constants.PRESERVE_SPACE, \"true\")\n                .CloneWithDirective(Constants.FORMAT_OUTPUT, \"false\");\n\n            // These make sure the regular comments are kept alive and that conditional comments are ripped out.\n            antisamy.Scan(\"<div>text <!-- comment --></div>\", revised2).GetCleanHtml().Should().Be(\"<div>text <!-- comment --></div>\");\n            antisamy.Scan(\"<div>text <!--[if IE]> comment <[endif]--></div>\", revised2).GetCleanHtml().Should().Be(\"<div>text <!-- comment --></div>\");\n\n            /*\n            * Check to see how nested conditional comments are handled. This is not very clean but \n            * the main goal is to avoid any tags. Not sure on encodings allowed in comments.\n            */\n            antisamy.Scan(\"<div>text <!--[if IE]> <!--[if gte 6]> comment <[endif]--><[endif]--></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text <!-- <!-- comment -->&lt;[endif]--&gt;</div>\");\n\n            // Regular comment nested inside conditional comment. Test makes sure.\n            antisamy.Scan(\"<div>text <!--[if IE]> <!-- IE specific --> comment <[endif]--></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text <!-- <!-- IE specific --> comment &lt;[endif]--&gt;</div>\");\n\n            // These play with whitespace and have invalid comment syntax.\n            antisamy.Scan(\"<div>text <!-- [ if lte 6 ]>\\ncomment <[ endif\\n]--></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text <!-- \\ncomment --></div>\");\n            antisamy.Scan(\"<div>text <![if !IE]> comment <![endif]></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text  comment </div>\");\n            antisamy.Scan(\"<div>text <![ if !IE]> comment <![endif]></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text  comment </div>\");\n\n            const string attack = \"[if lte 8]<script>\";\n            const string spacer = \"<![if IE]>\";\n\n            var stringBuilder = new StringBuilder();\n\n            stringBuilder.Append(\"<div>text<!\");\n            for (int i = 0; i < attack.Length; i++)\n            {\n                stringBuilder.Append(attack[i]);\n                stringBuilder.Append(spacer);\n            }\n            stringBuilder.Append(\"<![endif]>\");\n\n            string builtAttack = stringBuilder.ToString();\n            antisamy.Scan(builtAttack, revised2).GetCleanHtml().Should().NotContain(\"<script\"); // This one leaves <script> but HTML-encoded\n\n            // This one was added due to issue #61 from nahsra/antisamy\n            const string htmlWithCommentInTheMiddle = \"<p>this is a test content before start testing</p>\" +\n                \"<!-- TESTING COMMENT --><p>another line</p>\" +\n                \"<p>end of the content</p>\";\n            antisamy.Scan(htmlWithCommentInTheMiddle, policy.CloneWithDirective(Constants.PRESERVE_COMMENTS, \"true\"))\n                .GetCleanHtml().Should().Be(htmlWithCommentInTheMiddle);\n        }\n\n        [Test(Description = \"Tests issue #44 from owaspantisamy Google Code Archive.\")]\n        public void TestErrorsOnChildlessNodesOfNonAllowedElements()\n        {\n            const int expectedErrorNumber = 3;\n            antisamy.Scan(\"<iframe src='http://foo.com/'></iframe><script src=''></script><link href='/foo.css'>\", policy).GetNumberOfErrors()\n                .Should().Be(expectedErrorNumber);\n        }\n\n        [Test(Description = \"Tests issue #51 from owaspantisamy Google Code Archive.\")]\n        public void TestParenthesesInUrl()\n        {\n            const int expectedErrorNumber = 0;\n            const string html = \"<a href='http://subdomain.domain/(S(ke0lpq54bw0fvp53a10e1a45))/MyPage.aspx'>test</a>\";\n            CleanResults result = antisamy.Scan(html, policy);\n            result.GetNumberOfErrors().Should().Be(expectedErrorNumber);\n            result.GetCleanHtml().Should().Contain(\"href='http://subdomain.domain/(S(ke0lpq54bw0fvp53a10e1a45))/MyPage.aspx'\");\n        }\n\n        [Test(Description = \"Tests issue #56 from owaspantisamy Google Code Archive.\")]\n        public void TestNoSpacesAreAdded()\n        {\n            // HtmlAgilityPack preverves single quotes and removes last semicolon occurrence\n            antisamy.Scan(\"<SPAN style='font-weight: bold;'>Hello World!</SPAN>\", policy).GetCleanHtml()\n                .Should().Contain(\"<span style='font-weight: bold'>Hello World!</span>\");\n        }\n\n        [Test(Description = \"Tests issue #58 from owaspantisamy Google Code Archive.\")]\n        public void TestNotAllowedInputTag()\n        {\n            antisamy.Scan(\"tgdan <input/> g  h\", policy).GetNumberOfErrors()\n                .Should().Be(0);\n        }\n\n        [Test(Description = \"Tests issue #61 from owaspantisamy Google Code Archive.\")]\n        public void TestPreventNewLineAtEndOfLastValidTag()\n        {\n            const string dirtyInput = \"blah <b>blah</b>.\";\n            antisamy.Scan(dirtyInput, policy).GetCleanHtml().Should().Be(dirtyInput);\n        }\n\n        [Test(Description = \"Tests issue #69 from owaspantisamy Google Code Archive.\")]\n        public void TestCharAttribute()\n        {\n            antisamy.Scan(\"<table><tr><td char='.'>test</td></tr></table>\", policy).GetCleanHtml().Should().Contain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='..'>test</td></tr></table>\", policy).GetCleanHtml().Should().NotContain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='&quot;'>test</td></tr></table>\", policy).GetCleanHtml().Should().Contain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='&quot;a'>test</td></tr></table>\", policy).GetCleanHtml().Should().NotContain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='&quot;&amp;'>test</td></tr></table>\", policy).GetCleanHtml().Should().NotContain(\"char\");\n        }\n\n        [Test]\n        public void TestLiteralLists()\n        {\n            CleanResults result = antisamy.Scan(\"hello<p align='invalid'>world</p>\", policy);\n            result.GetCleanHtml().Should().NotContain(\"invalid\");\n            result.GetNumberOfErrors().Should().Be(1);\n\n            antisamy.Scan(\"hello<p align='left'>world</p>\", policy).GetCleanHtml().Should().Contain(\"left\");\n        }\n\n        [Test]\n        public void TestStackExhaustion()\n        {\n            // This test was to measure how much it can be pushed with nesting\n            var sb = new StringBuilder();\n            for (int i = 0; i < Constants.MAX_NESTED_TAGS; i++)\n            {\n                sb.Append(\"<div>\");\n            }\n            antisamy.Scan(sb.ToString(), policy).GetCleanHtml().Should().NotBeNullOrEmpty();\n\n            // Add one more tag to push the limit\n            sb.Append(\"<div>\");\n            string result = null;\n            try\n            {\n                result = antisamy.Scan(sb.ToString()).GetCleanHtml();\n            }\n            catch (OWASP.AntiSamy.Exceptions.ScanException)\n            {\n                // To comply with try/catch\n            }\n\n            result.Should().BeNull();\n        }\n\n        [Test(Description = \"Tests issue #107 from owaspantisamy Google Code Archive.\")]\n        public void TestErroneousNewLinesAppearing()\n        {\n            var sb = new StringBuilder();\n            const string nl = \"\\n\";\n            const string header = \"<h1>Header</h1>\";\n            const string para = \"<p>Paragraph</p>\";\n            sb.Append(header);\n            sb.Append(nl);\n            sb.Append(para);\n\n            string html = sb.ToString();\n            string result = antisamy.Scan(html, policy).GetCleanHtml();\n            result.IndexOf(nl).Should().Be(result.LastIndexOf(nl));\n\n            int expectedLocation = header.Length;\n            int actualLocation = result.IndexOf(nl);\n            actualLocation.Should().BeInRange(expectedLocation - 1, expectedLocation,\n                because: \"According to Java project: 'account for line separator length difference across OSes'\");\n        }\n\n        [Test(Description = \"Tests issue #112 from owaspantisamy Google Code Archive.\")]\n        public void TestEmptyTagSelfClosing()\n        {\n            Policy revised = policy\n                .CloneWithDirective(Constants.PRESERVE_COMMENTS, \"true\")\n                .CloneWithDirective(Constants.PRESERVE_SPACE, \"true\")\n                .CloneWithDirective(Constants.FORMAT_OUTPUT, \"false\");\n\n            antisamy.Scan(\"text <strong></strong> text <strong><em></em></strong> text\", revised).GetCleanHtml()\n                .Should().NotContainAll(\"<strong />\", \"<strong/>\");\n\n            // Due to CDATA handling on title tag, test result is not equality checking.\n            antisamy.Scan(\"<html><head><title>foobar</title></head><body><img src=\\\"http://foobar.com/pic.gif\\\" /></body></html>\", policy).GetCleanHtml().Should()\n                .ContainAll(\"<title>\", \"foobar\", \"</title>\", \"<body><img src=\\\"http://foobar.com/pic.gif\\\" /></body>\");\n        }\n\n        [Test]\n        [Ignore(\"HtmlAgilityPack does not parse CDATA tags very well. This in particular, is wrong.\")]\n        public void TestCDataBypass()\n        {\n            CleanResults result = antisamy.Scan(\"<![CDATA[]><script>alert(1)</script>]]>\", policy);\n            result.GetNumberOfErrors().Should().BeGreaterThan(0);\n            result.GetCleanHtml().Should().Contain(\"&lt;script\").And.NotContain(\"<script\");\n        }\n\n        [Test]\n        [Ignore(\"HtmlAgilityPack does not parse CDATA tags very well. This in particular, is wrong.\")]\n        public void TestNestedCDataAttack()\n        {\n            antisamy.Scan(\"<![CDATA[]><script>alert(1)</script><![CDATA[]>]]><script>alert(2)</script>>]]>\", policy).GetCleanHtml().\n                Should().NotContain(\"<script>\");\n        }\n\n        [Test(Description = \"Tests issue #101 from owaspantisamy Google Code Archive.\")]\n        public void TestInternationalCharacterSupport()\n        {\n            const string html = \"<b>letter 'a' with umlaut: \\u00e4\";\n\n            Policy revised = policy.CloneWithDirective(Constants.ENTITY_ENCODE_INERNATIONAL_CHARS, \"false\");\n            antisamy.Scan(html, revised).GetCleanHtml().Should().Contain(\"\\u00e4\");\n\n            Policy revised2 = policy.CloneWithDirective(Constants.ENTITY_ENCODE_INERNATIONAL_CHARS, \"true\");\n            antisamy.Scan(html, revised2).GetCleanHtml().Should().Contain(\"&auml;\").And.NotContain(\"\\u00e4\");\n\n            antisamy.Scan(\"<span id=\\\"my-span\\\" class='my-class'>More special characters: \u0262\u2660\u2664\u00e1</span>\", revised2).GetCleanHtml().Should()\n                .Be(\"<span id=\\\"my-span\\\" class='my-class'>More special characters: &#610;&spades;&#9828;&aacute;</span>\");\n        }\n\n        [Test]\n        [Ignore(\"Current result is <iframe />, more inspection is needed.\")]\n        public void TestIframeValidation()\n        {\n            var tag = new Tag(\"iframe\", Constants.ACTION_VALIDATE, new Dictionary<string, Attribute>());\n            Policy revised = policy.MutateTag(tag);\n\n            antisamy.Scan(\"<iframe></iframe>\", revised).GetCleanHtml().Should().Be(\"<iframe></iframe>\");\n        }\n\n        /*\n\t     * Tests cases dealing with nofollowAnchors directive. Assumes anchor tags\n\t     * have an action set to \"validate\" (may be implicit) in the policy file.\n\t     */\n        [Test]\n        public void TestNoFollowAnchors()\n        {\n            // If we have activated nofollowAnchors\n            Policy revised = policy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"true\");\n\n            // Adds when not present\n            antisamy.Scan(\"<a href=\\\"blah\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // Adds properly even with bad attr\n            antisamy.Scan(\"<a href=\\\"blah\\\" bad=\\\"true\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // rel with bad value gets corrected\n            antisamy.Scan(\"<a href=\\\"blah\\\" rel=\\\"blh\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // Correct attribute doesn't get messed with\n            antisamy.Scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // If two correct attributes, only one remaining after scan\n            antisamy.Scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\" rel=\\\"nofollow\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // Test if value is off - does it add?\n            antisamy.Scan(\"a href=\\\"blah\\\">link</a>\", revised).GetCleanHtml().Should().NotContain(\"nofollow\");\n        }\n\n        [Test]\n        public void TestValidateParamAsEmbed()\n        {\n            Policy revised = policy.CloneWithDirective(Constants.VALIDATE_PARAM_AS_EMBED, \"true\");\n\n            // Let's start with a YouTube embed\n            string input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n            string expectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n            antisamy.Scan(input, revised).GetCleanHtml().Should().Be(expectedOutput);\n\n            // Now what if someone sticks malicious URL in the value of the value attribute in the param tag? Remove that param tag\n            input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://supermaliciouscode.com/badstuff.swf\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n            expectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n            antisamy.Scan(input, revised).GetCleanHtml().Should().Contain(expectedOutput);\n\n            // Now what if someone sticks malicious URL in the value of the src attribute in the embed tag? remove that embed tag\n            input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://hereswhereikeepbadcode.com/ohnoscary.swf\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n            expectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /></object>\";\n            antisamy.Scan(input, revised).GetCleanHtml().Should().Contain(expectedOutput);\n        }\n\n        [Test]\n        public void TestOnsiteRegex()\n        {\n            antisamy.Scan(\"<a href=\\\"foo\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n            antisamy.Scan(\"<a href=\\\"/foo/bar\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n            antisamy.Scan(\"<a href=\\\"../../di.cgi?foo&amp;3D~\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n            antisamy.Scan(\"<a href=\\\"/foo/bar/1/sdf;jsessiond=1f1f12312_123123\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n        }\n\n        [Test(Description = \"Tests issue #10 from nahsra/antisamy on GitHub.\")]\n        public void TestHtml5Colon()\n        {\n            antisamy.Scan(\"<a href=\\\"javascript&colon;alert&lpar;1&rpar;\\\">X</a>\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n        }\n\n        [Test(Description = \"Tests issue #144 from owaspantisamy Google Code Archive.\")]\n        public void TestPinataString()\n        {\n            antisamy.Scan(\"pi\\u00f1ata\", policy).GetCleanHtml().Should().Be(\"pi\\u00f1ata\");\n        }\n\n        [Test]\n        public void TestHtml5DynamicDataAttribute()\n        {\n            // Test good attribute \"data-\"\n            antisamy.Scan(\"<p data-tag=\\\"abc123\\\">Hello World!</p>\", policy).GetCleanHtml().Should().Be(\"<p data-tag=\\\"abc123\\\">Hello World!</p>\");\n            // Test bad attribute \"dat-\"\n            antisamy.Scan(\"<p dat-tag=\\\"abc123\\\">Hello World!</p>\", policy).GetCleanHtml().Should().Be(\"<p>Hello World!</p>\");\n        }\n\n        [Test]\n        public void TestXssOnMouseOver()\n        {\n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER);\n            antisamy.Scan(\"<bogus>whatever</bogus><img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" onmouseover=\\\"alert('xss')\\\">\", revised).GetCleanHtml()\n                .Should().Be(\"whatever<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" />\");\n        }\n\n        [Test]\n        public void TestObfuscationOnclickXssBypass()\n        {\n            antisamy.Scan(\"<a href=\\\"http://example.com\\\"&amp;/onclick=alert(9)>foo</a>\", policy).GetCleanHtml()\n                .Should().Be(\"<a href=\\\"http://example.com\\\" rel=\\\"nofollow\\\">foo</a>\");\n        }\n\n        [Test(Description = \"Tests issue #10 from nahsra/antisamy on GitHub.\")]\n        public void TestOnloadXssOnStyleTag()\n        {\n            antisamy.Scan(\"<style onload=alert(1)>h1 {color:red;}</style>\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n        }\n\n        [Test]\n        public void TestUnknownTags()\n        {\n            // Original comment: Mailing list user sent this in. Didn't work, but good test to leave in.\n            antisamy.Scan(\"<%/onmouseover=prompt(1)>\", policy).GetCleanHtml().Should().NotContain(\"<%/\");\n        }\n\n        [Test]\n        public void TestStreamScan()\n        {\n            const string testImgSrcUrl = \"<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" \";\n            using var reader = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes($\"<bogus>whatever</bogus>{testImgSrcUrl}onmouseover=\\\"alert('xss')\\\">\")));\n            using var writer = new StreamWriter(new MemoryStream());\n\n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER);\n            antisamy.Scan(reader, writer, revised).GetCleanHtml().Should().BeNull();\n\n            using var resultReader = new StreamReader(writer.BaseStream);\n            resultReader.ReadToEnd().Should().Be($\"whatever{testImgSrcUrl}/>\");\n        }\n\n        [Test(Description = \"Tests issue #23 from nahsra/antisamy on GitHub.\")]\n        public void TestStrippingNestedLists()\n        {\n            const string html = \"<ul><li>one</li><li>two</li><li>three<ul><li>a</li><li>b</li></ul></li></ul>\";\n            /* Issue claims you end up with this:\n             *      <ul><li>one</li><li>two</li><li>three<ul></ul></li><li>a</li><li>b</li></ul>\n             *      \n             * Meaning the <li>a</li><li>b</li> elements were moved outside of the nested <ul> list they were in\n             */\n\n            // The replace is used to strip out all the whitespace in the clean HTML so we can successfully find what we expect to find\n            antisamy.Scan(html, policy).GetCleanHtml().Replace(\"\\\\s\", \"\").Should().Contain(\"<ul><li>a</li>\");\n        }\n\n        [Test(Description = \"Tests issue #24 from nahsra/antisamy on GitHub.\")]\n        [Ignore(\"This issue is a valid enhancement request planned to implement in the future. Now it is ignored to pass CI.\")]\n        public void TestOnUnknownTagEncodingBehaviorWithAtSymbol()\n        {\n            // If we have onUnknownTag set to \"encode\", it still strips out the @ and everything else after it.\n            // DOM Parser actually rips out the entire <name@mail.com> value even with onUnknownTag set.\n            Policy revised = policy.CloneWithDirective(\"onUnknownTag\", Constants.ACTION_ENCODE);\n            antisamy.Scan(\"firstname,lastname<name@mail.com>\", revised).GetCleanHtml().Should().Contain(\"name@mail.com\");\n        }\n\n        [Test(Description = \"Tests issue #26 from nahsra/antisamy on GitHub.\")]\n        public void TestPotentialXssFalsePositive()\n        {\n            const string html = \"&#x22;&#x3E;&#x3C;&#x69;&#x6D;&#x67;&#x20;&#x73;&#x72;&#x63;&#x3D;&#x61;&#x20;&#x6F;\" +\n                \"&#x6E;&#x65;&#x72;&#x72;&#x6F;&#x72;&#x3D;&#x61;&#x6C;&#x65;&#x72;&#x74;&#x28;&#x31;&#x29;&#x3E;\";\n            // Issue claims you end up with this: ><img src=a onerror=alert(1)>\n            antisamy.Scan(html, policy).GetCleanHtml().Should().NotContain(\"<img src=a onerror=alert(1)>\");\n            // But you actually end up with this: &quot;&gt;&lt;img src=a onerror=alert(1)&gt; -- Which is as expected\n        }\n\n        [Test(Description = \"Tests issue #27 from nahsra/antisamy on GitHub.\")]\n        public void TestOutOfBoundsExceptionOnSimpleText()\n        {\n            // This test doesn't cause an OutOfBoundsException, as reported in this issue even though it replicates the test as described.\n            antisamy.Scan(\"my &test\", policy).GetCleanHtml().Should().Contain(\"test\");\n        }\n\n        [Test(Description = \"Tests issue #33 from nahsra/antisamy on GitHub.\")]\n        public void TestTrickyEncodingXssBypassTrial()\n        {\n            /* Issue claims you end up with this:\n             *   javascript:x=alert and other similar problems (javascript&#00058x=alert,x%281%29) but you don't.\n             *   So issue is a false positive and has been closed.\n             */\n            const string html = \"<html>\\n\"\n                + \"<head>\\n\"\n                + \"  <title>Test</title>\\n\"\n                + \"</head>\\n\"\n                + \"<body>\\n\"\n                + \"  <h1>Tricky Encoding</h1>\\n\"\n                + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n                + \"  <ol>\\n\"\n                + \"    <li><a href=\\\"javascript&#00058x=alert,x%281%29\\\">X&#00058;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#00058y=alert,y%281%29\\\">X&#00058;y</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#58x=alert,x%281%29\\\">X&#58;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#58y=alert,y%281%29\\\">X&#58;y</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x0003Ax=alert,x%281%29\\\">X&#x0003A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x0003Ay=alert,y%281%29\\\">X&#x0003A;y</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">X&#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x3Ay=alert,y%281%29\\\">X&#x3A;y</a></li>\\n\"\n                + \"  </ol>\\n\"\n                + \"  <h1>Tricky Encoding with Ampersand Encoding</h1>\\n\"\n                + \"  <p>AntiSamy turns harmless payload into XSS by just decoding the encoded ampersands in the href attribute</a>\\n\"\n                + \"  <ol>\\n\"\n                + \"    <li><a href=\\\"javascript&amp;#x3Ax=alert,x%281%29\\\">X&amp;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&AMP;#x3Ax=alert,x%281%29\\\">X&AMP;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#38;#x3Ax=alert,x%281%29\\\">X&#38;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#00038;#x3Ax=alert,x%281%29\\\">X&#00038;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x26;#x3Ax=alert,x%281%29\\\">X&#x26;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x00026;#x3Ax=alert,x%281%29\\\">X&#x00026;#x3A;x</a></li>\\n\"\n                + \"  </ol>\\n\"\n                + \"  <p><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">Original without ampersand encoding</a></p>\\n\"\n                + \"</body>\\n\"\n                + \"</html>\";\n            antisamy.Scan(html, policy).GetCleanHtml().Should().NotContain(\"javascript&#00058x=alert,x%281%29\");\n        }\n\n        [Test(Description = \"Tests issue #34 from nahsra/antisamy on GitHub.\")]\n        public void TestStripNonValidXmlCharacters()\n        {\n            // Issue indicates: \"<div>Hello\\\\uD83D\\\\uDC95</div>\" should be sanitized to: \"<div>Hello</div>\"\n            antisamy.Scan(\"<div>Hello\\uD83D\\uDC95</div>\", policy).GetCleanHtml().Should().Be(\"<div>Hello</div>\");\n            antisamy.Scan(\"\\uD888\", policy).GetCleanHtml().Should().BeEmpty();\n        }\n\n        [Test(Description = \"Tests issue #40 from nahsra/antisamy on GitHub.\")]\n        public void TestCleaningSvgFalsePositive()\n        {\n            // Concern is that: <svg onload=alert(1)//  does not get cleansed.\n            // Based on these test results, it does get cleaned so this issue is a false positive, so we closed it.\n            const string html = \"<html>\\n\"\n                + \"<head>\\n\"\n                + \"  <title>Test</title>\\n\"\n                + \"</head>\\n\"\n                + \"<body>\\n\"\n                + \"  <h1>Tricky Encoding</h1>\\n\"\n                + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n                + \"  <ol>\\n\"\n                + \"    <li><h3>svg onload=alert follows:</h3><svg onload=alert(1)//</li>\\n\"\n                + \"  </ol>\\n\"\n                + \"</body>\\n\"\n                + \"</html>\";\n\n            antisamy.Scan(html, policy).GetCleanHtml().Should().NotContain(\"<svg onload=alert(1)//\");\n        }\n\n        [Test(Description = \"Tests issue #48 from nahsra/antisamy on GitHub.\")]\n        public void TestOnsiteUrlAttacks()\n        {\n            // Concern is that onsiteURL regex is not safe for URLs that start with //.\n            // For example:  //evilactor.com?param=foo\n            const string phishingAttempt = \"<a href=\\\"//evilactor.com/stealinfo?a=xxx&b=xxx\\\"><span style=\\\"color:red;font-size:100px\\\">\"\n                + \"You must click me</span></a>\";\n            // Output: <a rel=\"nofollow\"><span style=\"color: red;font-size: 100.0px;\">You must click me</span></a>\n            antisamy.Scan(phishingAttempt, policy).GetCleanHtml().Should().NotContain(\"//evilactor.com/\");\n\n            // This ones never failed, they're just to prove a dangling markup attack on the following resulting HTML won't work.\n            // Less probable case (steal more tags):\n            const string danglingMarkup = \"<div>User input: \" +\n                \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\"><a href='//evilactor.com?\" +\n                \"\\\"> all this info wants to be stolen with <i>danlging markup attack</i>\" +\n                \" until a single quote to close is found'</div>\";\n            antisamy.Scan(danglingMarkup, policy).GetCleanHtml().Should().NotContain(\"//evilactor.com/\");\n\n            // More probable case (steal just an attribute):\n            //      HTML before attack: <input type=\"text\" name=\"input\" value=\"\" data-attribute-to-steal=\"some value\">\n            const string danglingMarkup2 = \"<div>User input: \" +\n                    \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\" data-attribute-to-steal=\\\"some value\\\">\";\n            antisamy.Scan(danglingMarkup2, policy).GetCleanHtml().Should().NotContain(\"//evilactor.com/\");\n        }\n\n        [Test(Description = \"Tests issue #62 from nahsra/antisamy on GitHub.\")]\n        public void TestProcessingInstructionRemoval()\n        {\n            antisamy.Scan(\"<div><?foo note=\\\"I am XML processing instruction. I wish to be excluded\\\" ?></div>\", policy).GetCleanHtml().Should().Be(\"<div></div>\");\n            antisamy.Scan(\"<?xml-stylesheet type=\\\"text/css\\\" href=\\\"style.css\\\"?>\", policy).GetCleanHtml().Should().BeEmpty();\n            antisamy.Scan(\"|<?ai aaa\", policy).GetCleanHtml().Should().Be(\"|\");\n            antisamy.Scan(\"<div>|<?ai aaa\", policy).GetCleanHtml().Should().Be(\"<div>|</div>\");\n        }\n\n        [Test]\n        public void TestTagTruncation()\n        {\n            Policy revised = policy\n                .MutateTag(new Tag(\"section\", \"validate\", null))\n                .MutateTag(new Tag(\"div\", \"truncate\", null));\n\n            antisamy.Scan(\"<section><div class='.divToTruncate'>Div only contains this text<span>Confirmed</span></div></section>\", revised)\n                .GetCleanHtml().Should().Be(\"<section><div>Div only contains this text</div></section>\");\n        }\n\n        [Test(Description = \"Tests issue #81 from nahsra/antisamy on GitHub.\")]\n        public void TestPreserveImportantOnCssProperty()\n        {\n            antisamy.Scan(\"<p style=\\\"color: red !important\\\">Some Text</p>\", policy).GetCleanHtml().Should().Contain(\"!important\");\n        }\n\n        [Test]\n        public void TestEntityReferenceEncodedInHtmlAttribute()\n        {\n            antisamy.Scan(\"<p><a href=\\\"javascript&#00058x=1,%61%6c%65%72%74%28%22%62%6f%6f%6d%22%29\\\">xss</a></p>\", policy).GetCleanHtml().Should().Contain(\"javascript&amp;#00058\");\n        }\n\n        [Test(Description = \"Tests issue #101 from nahsra/antisamy on GitHub.\")]\n        public void TestManySingificantFiguresAndExponentialValuesOnCss()\n        {\n            // Test that margin attribute is not removed when value has too much significant figures.\n            // Current behavior is that decimals like 0.00001 are internally translated to 1E-05, this\n            // is reflected on regex validation and actual output. The inconsistency is due to Batik CSS.\n            antisamy.Scan(\"<p style=\\\"margin: 0.0001pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 0.0001pt\");\n            antisamy.Scan(\"<p style=\\\"margin: 10000000pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 10000000pt\");\n            \n            // When using exponential directly with \"e\" or \"E\" the output gets transformed to decimal.\n            // Ideally in a new version of AngleSharp.Css it should keep the exponential format.\n            antisamy.Scan(\"<p style=\\\"margin: 1.0E-04pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 0.0001\");\n            antisamy.Scan(\"<p style=\\\"margin: 1.0e+04pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 10000\");\n        }\n\n        [Test]\n        public void TestCssUnits()\n        {\n            const string input = \"<div style=\\\"width:50vw;height:50vh;padding:1rpc;\\\">\\n\" +\n                \"\\t<p style=\\\"font-size:1.5ex;padding-left:1rem;padding-top:16px;\\\">Some text.</p>\\n\" +\n                \"</div>\";\n            antisamy.Scan(input, policy).GetCleanHtml().Should().ContainAll(\"ex\", \"px\", \"rem\", \"vw\", \"vh\").And.NotContain(\"rpc\");\n        }\n\n        [Test(Description = \"Tests for CVE-2021-42575.\")]\n        public void TestXSSInsideSelectOptionStyle()\n        {\n            antisamy.Scan(\"<select><option><style>h1{color:black;}</style></option></select>\", policy).GetCleanHtml().Should().Contain(\"color\");\n            antisamy.Scan(\"<select><option><style><script>alert(1)</script></style></option></select>\", policy).GetCleanHtml().Should().NotContain(\"<script>\");\n        }\n\n        [Test]\n        public void TestStyleImport()\n        {\n            // Check order is correct:\n            //  First import: noprint class\n            //  Second import: table.browserref selector\n            //  Original styles: very-specific-antisamy class\n            const string input = \"<style type='text/css'>\\n\" +\n                \"\\t@import url(https://www.w3.org/2008/site/css/realprint.css);\\n\" +\n                \"\\t@import \\\"https://www.w3schools.com/browserref.css\\\";\\n\" +\n                \"\\t.very-specific-antisamy {font: 15pt \\\"Arial\\\"; color: blue;}\\n\" +\n                \"</style>\";\n            var resultRegex = new Regex(@\".*?\\.noprint.*?table\\.browserref.*?\\.very-specific-antisamy.*?\", RegexOptions.Singleline);\n            \n            Policy revised = policy.CloneWithDirective(Constants.EMBED_STYLESHEETS, \"true\");\n            resultRegex.IsMatch(antisamy.Scan(input, revised).GetCleanHtml()).Should().Be(true);\n\n            Policy revised2 = policy.CloneWithDirective(Constants.EMBED_STYLESHEETS, \"true\").CloneWithDirective(Constants.MAX_STYLESHEET_IMPORTS, \"1\");\n            antisamy.Scan(input, revised2).GetErrorMessages()\n                .Should().Contain(string.Format(OWASP.AntiSamy.Properties.Resources.ResourceManager.GetString(Constants.ERROR_CSS_IMPORT_EXCEEDED), \n                HtmlEntityEncoder.HtmlEntityEncode(\"https://www.w3schools.com/browserref.css\"), 1));\n\n            Policy revised3 = revised.CloneWithDirective(Constants.MAX_INPUT_SIZE, \"500\");\n            antisamy.Scan(input, revised3).GetErrorMessages()\n                .Should().Contain(string.Format(OWASP.AntiSamy.Properties.Resources.ResourceManager.GetString(Constants.ERROR_CSS_IMPORT_TOOLARGE), \n                HtmlEntityEncoder.HtmlEntityEncode(\"https://www.w3schools.com/browserref.css\"), 500));\n        }\n\n        [Test]\n        public void TestOnUnknownTagActions()\n        {\n            const string unknownTag = \"<bogus a=\\\"1\\\">whatever</bogus><span>Text</span>\";\n            // Default is to remove.\n            antisamy.Scan(unknownTag, policy).GetCleanHtml().Should().Be(\"<span>Text</span>\");\n            // Only actions different than \"remove\" are considered, any other text reuslts in removing. \n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, \"other text\");\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"<span>Text</span>\");\n            // Cannot validate undefined tag, remove it.\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_VALIDATE);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"<span>Text</span>\");\n            // Encode tag\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_ENCODE);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"&lt;bogus a=&quot;1&quot;&gt;whatever&lt;/bogus&gt;<span>Text</span>\");\n            // Filter tag\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"whatever<span>Text</span>\");\n            // Truncate tag\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_TRUNCATE);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"<bogus>whatever</bogus><span>Text</span>\");\n        }\n\n        [Test]\n        public void TestNoopenerAndNoreferrer()\n        {\n            Policy basePolicy = policy.MutateTag(new Tag(\"a\", Constants.ACTION_VALIDATE, new Dictionary<string, Attribute>\n            {\n                { \"target\", new Attribute(\"target\", string.Empty, string.Empty, new List<string>(), new List<string>{ \"_blank\", \"_self\" }) },\n                { \"rel\", new Attribute(\"rel\", string.Empty, string.Empty, new List<string>(), new List<string>{ \"nofollow\", \"noopener\", \"noreferrer\" }) }\n            }));\n\n            Policy revised = basePolicy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"true\").CloneWithDirective(Constants.ANCHORS_NOOPENER_NOREFERRER, \"true\");\n            // No target=\"_blank\", so only nofollow can be added.\n            antisamy.Scan(\"<a>Link text</a>\", revised).GetCleanHtml().Should().Contain(\"nofollow\").And.NotContain(\"noopener noreferrer\");\n            // target=\"_blank\", can have both.\n            antisamy.Scan(\"<a target=\\\"_blank\\\">Link text</a>\", revised).GetCleanHtml().Should().Contain(\"nofollow noopener noreferrer\");\n            \n            Policy revised2 = basePolicy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"false\").CloneWithDirective(Constants.ANCHORS_NOOPENER_NOREFERRER, \"true\");\n            // No target=\"_blank\", no rel added.\n            antisamy.Scan(\"<a>Link text</a>\", revised2).GetCleanHtml().Should().NotContain(\"rel=\");\n            // target=\"_blank\", everything present.\n            antisamy.Scan(\"<a target='_blank' rel='nofollow'>Link text</a>\", revised2).GetCleanHtml().Should().Contain(\"nofollow noopener noreferrer\");\n            // target=\"_self\", no rel added.\n            antisamy.Scan(\"<a target='_self'>Link text</a>\", revised2).GetCleanHtml().Should().NotContain(\"rel=\");\n            // target=\"_self\", only nofollow present.\n            antisamy.Scan(\"<a target='_self' rel='nofollow'>Link text</a>\", revised2).GetCleanHtml().Should().Contain(\"nofollow\").And.NotContain(\"noopener noreferrer\");\n            // noopener is not repeated\n            antisamy.Scan(\"<a target='_blank' rel='noopener'>Link text</a>\", revised2).GetCleanHtml()\n                .Split(new string[] { \"noopener\" }, StringSplitOptions.None).Length.Should().Be(2);\n\n            Policy revised3 = basePolicy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"false\").CloneWithDirective(Constants.ANCHORS_NOOPENER_NOREFERRER, \"false\");\n            // No rel added\n            antisamy.Scan(\"<a>Link text</a>\", revised3).GetCleanHtml().Should().NotContain(\"rel=\");\n            // noopener is not repeated\n            antisamy.Scan(\"<a target='_blank' rel='noopener'>Link text</a>\", revised3).GetCleanHtml()\n                .Split(new string[] { \"noopener\" }, StringSplitOptions.None).Length.Should().Be(2);\n        }\n\n        [Test]\n        public void TestLeadingDashOnPropertyName()\n        {\n            // Test that property names with leading dash are supported\n            string input = \"<style type='text/css'>\\n\" +\n                \"\\t.very-specific-antisamy { -moz-border-radius: inherit ; -webkit-border-radius: 25px 10px 5px 10px;}\\n\" +\n                \"</style>\";\n            \n            // Define new properties for the policy\n            var leadingDashProperty1 = new Property(\"-webkit-border-radius\");\n            leadingDashProperty1.AddAllowedRegExp(\"\\\\d+(\\\\.\\\\d+)?px( \\\\d+(\\\\.\\\\d+)?px){0,3}\");\n            var leadingDashProperty2 = new Property(\"-moz-border-radius\");\n            leadingDashProperty2.AddAllowedValue(\"inherit\");\n            Policy revised = policy.AddCssProperty(leadingDashProperty1).AddCssProperty(leadingDashProperty2);\n            \n            // Test properties\n            antisamy.Scan(input, revised).GetCleanHtml().Should().ContainAll(\"-webkit-border-radius\", \"-moz-border-radius\");\n        }\n\n        [Test]\n        public void TestSmuggledTagsInStyleContent()\n        {\n            antisamy.Scan(\"<style/>b<![CDATA[</style><a href=javascript:alert(1)>test\", policy).GetCleanHtml()\n                .Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<select<style/>W<xmp<script>alert(1)</script>\", policy).GetCleanHtml()\n                .Should().NotContain(\"script\");\n            antisamy.Scan(\"<select<style/>k<input<</>input/onfocus=alert(1)>\", policy).GetCleanHtml()\n                .Should().NotContain(\"input\");\n        }\n\n        [Test]\n        public void TestMalformedPIScan()\n        {\n            string result = null;\n            try\n            {\n                result = antisamy.Scan(\"<!--><?a/\", policy).GetCleanHtml();\n            }\n            catch\n            {\n                // To comply with try/catch\n            }\n            result.Should().NotBeNull();\n\n            result = null;\n            try\n            {\n                result = antisamy.Scan(\"<!--?><?a/\", policy).GetCleanHtml();\n            }\n            catch\n            {\n                // To comply with try/catch\n            }\n            result.Should().NotBeNull();\n        }\n    }\n}\n"], "fixing_code": ["/*\n * Copyright (c) 2009-2022, Arshan Dabirsiaghi, Sebasti\u00e1n Passaro\n * \n * All rights reserved.\n * \n * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n * \n * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n * Neither the name of OWASP nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF\n * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING\n * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Text;\nusing System.Text.RegularExpressions;\nusing FluentAssertions;\nusing NUnit.Framework;\nusing OWASP.AntiSamy.Html;\nusing OWASP.AntiSamy.Html.Model;\nusing OWASP.AntiSamy.Html.Util;\nusing Attribute = OWASP.AntiSamy.Html.Model.Attribute;\nusing Constants = OWASP.AntiSamy.Html.Scan.Constants;\n\nnamespace AntiSamyTests\n{\n    [TestFixture]\n    public class AntiSamyTest\n    {\n        private AntiSamy antisamy;\n        private TestPolicy policy;\n\n        [SetUp]\n        public void SetUp()\n        {\n            antisamy = new AntiSamy();\n            policy = TestPolicy.GetInstance(TestConstants.DEFAULT_POLICY_PATH);\n        }\n\n        [Test(Description = \"Test basic XSS cases.\")]\n        public void TestScriptAttacks()\n        {\n            antisamy.Scan(\"test<script>alert(document.cookie)</script>\", policy).GetCleanHtml().Should().NotContain(\"script\");\n            antisamy.Scan(\"<<<><<script src=http://fake-evil.ru/test.js>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<script<script src=http://fake-evil.ru/test.js>>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT/XSS SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<BODY onload!#$%&()*~+-_.,:;?@[/|\\\\]^`=alert(\\\"XSS\\\")>\", policy).GetCleanHtml().Should().NotContain(\"onload\");\n            antisamy.Scan(\"<BODY ONLOAD=alert('XSS')>\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<iframe src=http://ha.ckers.org/scriptlet.html <\", policy).GetCleanHtml().Should().NotContain(\"<iframe\");\n            antisamy.Scan(\"<INPUT TYPE=\\\"IMAGE\\\" SRC=\\\"javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"src\");\n        }\n\n        [Test]\n        public void TestImgAttacks()\n        {\n            antisamy.Scan(\"<img src='http://www.myspace.com/img.gif'>\", policy).GetCleanHtml().Should().Contain(\"<img\");\n            antisamy.Scan(\"<img src=javascript:alert(document.cookie)>\", policy).GetCleanHtml().Should().NotContain(\"<img\");\n            antisamy.Scan(\"<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>\", policy).GetCleanHtml()\n                .Should().NotContain(\"<img\");\n            antisamy.Scan(\"<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040\" +\n                \"&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>\", policy).GetCleanHtml().Should().Contain(\"&amp;\");\n            antisamy.Scan(\"<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>\", policy).GetCleanHtml()\n                .Should().Contain(\"&amp;\");\n            antisamy.Scan(\"<IMG SRC=\\\"jav&#x0D;ascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<IMG SRC=\\\"javascript:alert('XSS')\\\"\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<IMG LOWSRC=\\\"javascript:alert('XSS')\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<BGSOUND SRC=\\\"javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n        }\n\n        [Test]\n        public void TestHrefAttacks()\n        {\n            antisamy.Scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"href\");\n            antisamy.Scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"http://ha.ckers.org/xss.css\\\">\", policy).GetCleanHtml().Should().NotContain(\"href\");\n            antisamy.Scan(\"<STYLE>@import'http://ha.ckers.org/xss.css';</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"ha.ckers.org\");\n            antisamy.Scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"ha.ckers.org\");\n            antisamy.Scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"xss.htc\");\n            antisamy.Scan(\"<STYLE>li {list-style-image: url(\\\"javascript:alert('XSS')\\\");}</STYLE><UL><LI>XSS\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<IMG SRC='vbscript:msgbox(\\\"XSS\\\")'>\", policy).GetCleanHtml().Should().NotContain(\"vbscript\");\n            antisamy.Scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0; URL=http://;URL=javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"<meta\");\n            antisamy.Scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=javascript:alert('XSS');\\\">\", policy).GetCleanHtml().Should().NotContain(\"<meta\");\n            antisamy.Scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\\\">\", policy).GetCleanHtml().Should().NotContain(\"<meta\");\n            antisamy.Scan(\"<IFRAME SRC=\\\"javascript:alert('XSS');\\\"></IFRAME>\", policy).GetCleanHtml().Should().NotContain(\"iframe\");\n            antisamy.Scan(\"<FRAMESET><FRAME SRC=\\\"javascript:alert('XSS');\\\"></FRAMESET>\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<TABLE BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy).GetCleanHtml().Should().NotContain(\"background\");\n            antisamy.Scan(\"<TABLE><TD BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy).GetCleanHtml().Should().NotContain(\"background\");\n            antisamy.Scan(\"<DIV STYLE=\\\"background-image: url(javascript:alert('XSS'))\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<DIV STYLE=\\\"width: expression(alert('XSS'));\\\">\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<IMG STYLE=\\\"xss:expr/*XSS*/ession(alert('XSS'))\\\">\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n            antisamy.Scan(\"<STYLE>@im\\\\port'\\\\ja\\\\vasc\\\\ript:alert(\\\"XSS\\\")';</STYLE>\", policy).GetCleanHtml().Should().NotContain(\"ript:alert\");\n            antisamy.Scan(\"<BASE HREF=\\\"javascript:alert('XSS');//\\\">\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<BaSe hReF=\\\"http://arbitrary.com/\\\">\", policy).GetCleanHtml().Should().NotContain(\"<base\");\n            antisamy.Scan(\"<OBJECT TYPE=\\\"text/x-scriptlet\\\" DATA=\\\"http://ha.ckers.org/scriptlet.html\\\"></OBJECT>\", policy).GetCleanHtml().Should().NotContain(\"<object\");\n            antisamy.Scan(\"<OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389><param name=url value=javascript:alert('XSS')></OBJECT>\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<EMBED SRC=\\\"http://ha.ckers.org/xss.swf\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy).GetCleanHtml().Should().NotContain(\"<embed\");\n            antisamy.Scan(\"<EMBED SRC=\\\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJod\" +\n                \"HRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUy\" +\n                \"IpOzwvc2NyaXB0Pjwvc3ZnPg==\\\" type=\\\"image/svg+xml\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy).GetCleanHtml().Should().NotContain(\"<embed\");\n            antisamy.Scan(\"<SCRIPT a=\\\">\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT a=\\\">\\\" '' SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT a=`>` SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT a=\\\">'>\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<SCRIPT>document.write(\\\"<SCRI\\\");</SCRIPT>PT SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy).GetCleanHtml().Should().NotContain(\"script\");\n            antisamy.Scan(\"<SCRIPT SRC=http://ha.ckers.org/xss.js\", policy).GetCleanHtml().Should().NotContain(\"<script\");\n            antisamy.Scan(\"<div/style=&#92&#45&#92&#109&#111&#92&#122&#92&#45&#98&#92&#105&#92&#110&#100&#92&#105&#110&#92&#103:&#92&#117&#114&#108&#40&#47&#47&#98&#117&#115&#105&#110&#101&#115\" +\n                \"&#115&#92&#105&#92&#110&#102&#111&#46&#99&#111&#46&#117&#107&#92&#47&#108&#97&#98&#115&#92&#47&#120&#98&#108&#92&#47&#120&#98&#108&#92&#46&#120&#109&#108&#92&#35&#120&#115&#115\" +\n                \"&#41&>\", policy).GetCleanHtml().Should().NotContain(\"&amp;\");\n            antisamy.Scan(\"<a href='aim: &c:\\\\windows\\\\system32\\\\calc.exe' ini='C:\\\\Documents and Settings\\\\All Users\\\\Start Menu\\\\Programs\\\\Startup\\\\pwnd.bat'>\", policy).GetCleanHtml()\n                .Should().NotContain(\"aim.exe\");\n            antisamy.Scan(\"<!--\\n<A href=\\n- --><a href=javascript:alert:document.domain>test-->\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<a></a style=\\\"\\\"xx:expr/**/ession(document.appendChild(document.createElement('script')).src='http://h4k.in/i.js')\\\">\", policy).GetCleanHtml()\n                .Should().NotContain(\"document\");\n            antisamy.Scan(\"<dIv/sTyLe='background-image: url(sheep.png), url(\\\"javascript:alert(1)\\\");'></dIv>\", policy).GetCleanHtml().Should().Contain(\"style=''\");\n            antisamy.Scan(\"<dIv/sTyLe='background-image: url(sheep.png), url(\\\"https://safe.com/kitten.jpg\\\");'></dIv>\", policy).GetCleanHtml()\n                .Should().ContainAll(\"sheep.png\", \"kitten.jpg\");\n            antisamy.Scan(\"<a href=\\\"http://example.com\\\"&amp;/onclick=alert(9)>foo</a>\", policy).GetCleanHtml().Should().Be(\"<a href=\\\"http://example.com\\\" rel=\\\"nofollow\\\">foo</a>\");\n        }\n\n        [Test(Description = \"Test CSS protections.\")]\n        public void TestCssAttacks()\n        {\n            antisamy.Scan(\"<div style=\\\"position:absolute\\\">\", policy).GetCleanHtml().Should().NotContain(\"position\");\n            antisamy.Scan(\"<style>b { position:absolute }</style>\", policy).GetCleanHtml().Should().NotContain(\"position\");\n            antisamy.Scan(\"<div style=\\\"z-index:25\\\">\", policy).GetCleanHtml().Should().NotContain(\"z-index\");\n            antisamy.Scan(\"<style>z-index:25</style>\", policy).GetCleanHtml().Should().NotContain(\"z-index\");\n        }\n\n        [Test(Description = \"Tests issues #12 and #36 from owaspantisamy Google Code Archive.\")]\n        public void TestEmptyTags()\n        {\n            string html = antisamy.Scan(\"<br ><strong></strong><a>hello world</a><b /><i/><hr>\", policy).GetCleanHtml();\n\n            var regex = new Regex(\".*<strong(\\\\s*)/>.*\");\n            regex.IsMatch(html).Should().BeFalse();\n\n            regex = new Regex(\".*<b(\\\\s*)/>.*\");\n            regex.IsMatch(html).Should().BeFalse();\n\n            regex = new Regex(\".*<i(\\\\s*)/>.*\");\n            regex.IsMatch(html).Should().BeFalse();\n\n            (html.Contains(\"<hr />\") || html.Contains(\"<hr/>\")).Should().BeTrue();\n        }\n\n        [Test(Description = \"Tests issue #20 from owaspantisamy Google Code Archive.\")]\n        public void TestMisplacedTag()\n        {\n            antisamy.Scan(\"<b><i>Some Text</b></i>\", policy).GetCleanHtml().Should().NotContain(\"<i />\");\n        }\n\n        [Test(Description = \"Tests issue #25 from owaspantisamy Google Code Archive.\")]\n        public void TestMarginRemovalFromInlineStyle()\n        {\n            antisamy.Scan(\"<div style=\\\"margin: -5em\\\">Test</div>\", policy).GetCleanHtml().Should().Be(\"<div style=\\\"\\\">Test</div>\");\n        }\n\n        [Test(Description = \"Tests issue #28 from owaspantisamy Google Code Archive.\")]\n        public void TestPreserveFontFamily()\n        {\n            antisamy.Scan(\"<div style=\\\"font-family: Geneva, Arial, courier new, sans-serif\\\">Test</div>\", policy).GetCleanHtml().Should().Contain(\"font-family\");\n        }\n\n        [Test(Description = \"Tests issue #30 from owaspantisamy Google Code Archive>: 'missing quotes around properties with spaces'\")]\n        [Ignore(\"CDATA is not handled by HtmlAgilityPack the same way than the Java version. The code works but the format is just different.\")]\n        public void TestCssPropertiesWithMultilineAndCData()\n        {\n            // The current result in Windows and with HtmlAgilityPack is: \n            // \"<style type=\\\"text/css\\\">\\r\\n//<![CDATA[\\r\\nP { font-family: &quot;Arial Unicode MS&quot; }\\r\\n//]]>//\\r\\n</style>\"\n            const string html = \"<style type=\\\"text/css\\\"><![CDATA[P {\\n\tfont-family: \\\"Arial Unicode MS\\\";\\n}\\n]]></style>\";\n            antisamy.Scan(html, policy).GetCleanHtml().Should().Be(html);\n\n            antisamy.Scan(\"<style type=\\\"text/css\\\"><![CDATA[\\r\\nP {\\r\\n margin-bottom: 0.08in;\\r\\n}\\r\\n]]></style>\", policy).GetCleanHtml()\n                .Should().Be(\"<style type=\\\"text/css\\\"><![CDATA[P {\\n\\tmargin-bottom: 0.08in;\\n}\\n]]></style>\");\n        }\n\n        [Test(Description = \"Tests issue #31 from owaspantisamy Google Code Archive.\")]\n        public void TestUnknownTagEncoding()\n        {\n            const string html = \"<b><u><g>foo</g></u></b>\";\n\n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_ENCODE);\n            antisamy.Scan(html, revised).GetCleanHtml().Should().ContainAll(\"&lt;g&gt;\", \"&lt;/g&gt;\");\n\n            Tag tag = policy.GetTagByName(\"b\").MutateAction(\"encode\");\n            Policy revised2 = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER).MutateTag(tag);\n            antisamy.Scan(html, revised2).GetCleanHtml().Should().ContainAll(\"&lt;b&gt;\", \"&lt;/b&gt;\");\n        }\n\n        [Test(Description = \"Tests issue #38 from owaspantisamy Google Code Archive.\")]\n        public void TestColorProcessing()\n        {\n            antisamy.Scan(\"<font color=\\\"#fff\\\">Test</font>\", policy).GetCleanHtml().Should().Be(\"<font color=\\\"#fff\\\">Test</font>\");\n            // AngleSharp replaces the CSS color hex value into rgba instead of rgb, expected results are expanded in case the library changes.\n            antisamy.Scan(\"<div style=\\\"color: #fff\\\">Test 3 letter code</div>\").GetCleanHtml().Should().ContainAny(\n                \"color: rgba(255, 255, 255, 1)\",\n                \"color: rgba(255,255,255,1)\",\n                \"color: rgb(255, 255, 255)\",\n                \"color: rgb(255,255,255)\");\n            antisamy.Scan(\"<font color=\\\"red\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font color=\\\"red\\\">Test</font>\");\n            antisamy.Scan(\"<font color=\\\"neonpink\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font>Test</font>\");\n            antisamy.Scan(\"<font color=\\\"#0000\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font>Test</font>\");\n            // This gets interpreted by AngleSharp as #0 = #00, so it's valid RGBA (0,0,0,0)\n            antisamy.Scan(\"<div style=\\\"color: #0000\\\">Test</div>\").GetCleanHtml().Should().ContainAny(\n                \"color: rgba(0, 0, 0, 0)\",\n                \"color: rgba(0,0,0,0)\",\n                \"color: rgb(0, 0, 0)\",\n                \"color: rgb(0,0,0)\");\n            // This assertion is added to make the previous case invalid as in the original Java test\n            antisamy.Scan(\"<div style=\\\"color: #00000\\\">Test</div>\").GetCleanHtml().Should().Be(\"<div style=\\\"\\\">Test</div>\");\n            antisamy.Scan(\"<font color=\\\"#000000\\\">Test</font>\").GetCleanHtml().Should().Be(\"<font color=\\\"#000000\\\">Test</font>\");\n            // Also AngleSharp asumes 1 in alpha value if the last hex are not present\n            antisamy.Scan(\"<div style=\\\"color: #000000\\\">Test</div>\").GetCleanHtml().Should().ContainAny(\n                \"color: rgba(0, 0, 0, 1)\",\n                \"color: rgba(0,0,0,1)\",\n                \"color: rgb(0, 0, 0)\",\n                \"color: rgb(0,0,0)\");\n\n            // Testing an error that came up on a dependency from the Java version\n            string result = null;\n            try\n            {\n                result = antisamy.Scan(\"<b><u>foo<style><script>alert(1)</script></style>@import 'x';</u>bar\").GetCleanHtml();\n            }\n            catch (Exception)\n            {\n                // To comply with try/catch\n            }\n\n            result.Should().NotBeNull();\n        }\n\n        [Test(Description = \"Tests issue #40 from owaspantisamy Google Code Archive.\")]\n        public void TestMediaAttributeHandling()\n        {\n            antisamy.Scan(\"<style media=\\\"print, projection, screen\\\"> P { margin: 1em; }</style>\", policy).GetCleanHtml()\n                .Should().Contain(\"print, projection, screen\");\n        }\n\n        [Test(Description = \"Tests issue #41 from owaspantisamy Google Code Archive.\")]\n        public void TestCommentProcessing()\n        {\n            Policy revised = policy.CloneWithDirective(Constants.PRESERVE_SPACE, \"true\");\n\n            antisamy.Scan(\"text <!-- comment -->\", revised).GetCleanHtml().Should().Be(\"text \");\n\n            Policy revised2 = policy\n                .CloneWithDirective(Constants.PRESERVE_COMMENTS, \"true\")\n                .CloneWithDirective(Constants.PRESERVE_SPACE, \"true\")\n                .CloneWithDirective(Constants.FORMAT_OUTPUT, \"false\");\n\n            // These make sure the regular comments are kept alive and that conditional comments are ripped out.\n            antisamy.Scan(\"<div>text <!-- comment --></div>\", revised2).GetCleanHtml().Should().Be(\"<div>text <!-- comment --></div>\");\n            antisamy.Scan(\"<div>text <!--[if IE]> comment <[endif]--></div>\", revised2).GetCleanHtml().Should().Be(\"<div>text <!-- comment --></div>\");\n\n            /*\n            * Check to see how nested conditional comments are handled. This is not very clean but \n            * the main goal is to avoid any tags. Not sure on encodings allowed in comments.\n            */\n            antisamy.Scan(\"<div>text <!--[if IE]> <!--[if gte 6]> comment <[endif]--><[endif]--></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text <!-- <!-- comment -->&lt;[endif]--&gt;</div>\");\n\n            // Regular comment nested inside conditional comment. Test makes sure.\n            antisamy.Scan(\"<div>text <!--[if IE]> <!-- IE specific --> comment <[endif]--></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text <!-- <!-- IE specific --> comment &lt;[endif]--&gt;</div>\");\n\n            // These play with whitespace and have invalid comment syntax.\n            antisamy.Scan(\"<div>text <!-- [ if lte 6 ]>\\ncomment <[ endif\\n]--></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text <!-- \\ncomment --></div>\");\n            antisamy.Scan(\"<div>text <![if !IE]> comment <![endif]></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text  comment </div>\");\n            antisamy.Scan(\"<div>text <![ if !IE]> comment <![endif]></div>\", revised2).GetCleanHtml()\n                .Should().Be(\"<div>text  comment </div>\");\n\n            const string attack = \"[if lte 8]<script>\";\n            const string spacer = \"<![if IE]>\";\n\n            var stringBuilder = new StringBuilder();\n\n            stringBuilder.Append(\"<div>text<!\");\n            for (int i = 0; i < attack.Length; i++)\n            {\n                stringBuilder.Append(attack[i]);\n                stringBuilder.Append(spacer);\n            }\n            stringBuilder.Append(\"<![endif]>\");\n\n            string builtAttack = stringBuilder.ToString();\n            antisamy.Scan(builtAttack, revised2).GetCleanHtml().Should().NotContain(\"<script\"); // This one leaves <script> but HTML-encoded\n\n            // This one was added due to issue #61 from nahsra/antisamy\n            const string htmlWithCommentInTheMiddle = \"<p>this is a test content before start testing</p>\" +\n                \"<!-- TESTING COMMENT --><p>another line</p>\" +\n                \"<p>end of the content</p>\";\n            antisamy.Scan(htmlWithCommentInTheMiddle, policy.CloneWithDirective(Constants.PRESERVE_COMMENTS, \"true\"))\n                .GetCleanHtml().Should().Be(htmlWithCommentInTheMiddle);\n        }\n\n        [Test(Description = \"Tests issue #44 from owaspantisamy Google Code Archive.\")]\n        public void TestErrorsOnChildlessNodesOfNonAllowedElements()\n        {\n            const int expectedErrorNumber = 3;\n            antisamy.Scan(\"<iframe src='http://foo.com/'></iframe><script src=''></script><link href='/foo.css'>\", policy).GetNumberOfErrors()\n                .Should().Be(expectedErrorNumber);\n        }\n\n        [Test(Description = \"Tests issue #51 from owaspantisamy Google Code Archive.\")]\n        public void TestParenthesesInUrl()\n        {\n            const int expectedErrorNumber = 0;\n            const string html = \"<a href='http://subdomain.domain/(S(ke0lpq54bw0fvp53a10e1a45))/MyPage.aspx'>test</a>\";\n            CleanResults result = antisamy.Scan(html, policy);\n            result.GetNumberOfErrors().Should().Be(expectedErrorNumber);\n            result.GetCleanHtml().Should().Contain(\"href='http://subdomain.domain/(S(ke0lpq54bw0fvp53a10e1a45))/MyPage.aspx'\");\n        }\n\n        [Test(Description = \"Tests issue #56 from owaspantisamy Google Code Archive.\")]\n        public void TestNoSpacesAreAdded()\n        {\n            // HtmlAgilityPack preverves single quotes and removes last semicolon occurrence\n            antisamy.Scan(\"<SPAN style='font-weight: bold;'>Hello World!</SPAN>\", policy).GetCleanHtml()\n                .Should().Contain(\"<span style='font-weight: bold'>Hello World!</span>\");\n        }\n\n        [Test(Description = \"Tests issue #58 from owaspantisamy Google Code Archive.\")]\n        public void TestNotAllowedInputTag()\n        {\n            antisamy.Scan(\"tgdan <input/> g  h\", policy).GetNumberOfErrors()\n                .Should().Be(0);\n        }\n\n        [Test(Description = \"Tests issue #61 from owaspantisamy Google Code Archive.\")]\n        public void TestPreventNewLineAtEndOfLastValidTag()\n        {\n            const string dirtyInput = \"blah <b>blah</b>.\";\n            antisamy.Scan(dirtyInput, policy).GetCleanHtml().Should().Be(dirtyInput);\n        }\n\n        [Test(Description = \"Tests issue #69 from owaspantisamy Google Code Archive.\")]\n        public void TestCharAttribute()\n        {\n            antisamy.Scan(\"<table><tr><td char='.'>test</td></tr></table>\", policy).GetCleanHtml().Should().Contain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='..'>test</td></tr></table>\", policy).GetCleanHtml().Should().NotContain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='&quot;'>test</td></tr></table>\", policy).GetCleanHtml().Should().Contain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='&quot;a'>test</td></tr></table>\", policy).GetCleanHtml().Should().NotContain(\"char\");\n            antisamy.Scan(\"<table><tr><td char='&quot;&amp;'>test</td></tr></table>\", policy).GetCleanHtml().Should().NotContain(\"char\");\n        }\n\n        [Test]\n        public void TestLiteralLists()\n        {\n            CleanResults result = antisamy.Scan(\"hello<p align='invalid'>world</p>\", policy);\n            result.GetCleanHtml().Should().NotContain(\"invalid\");\n            result.GetNumberOfErrors().Should().Be(1);\n\n            antisamy.Scan(\"hello<p align='left'>world</p>\", policy).GetCleanHtml().Should().Contain(\"left\");\n        }\n\n        [Test]\n        public void TestStackExhaustion()\n        {\n            // This test was to measure how much it can be pushed with nesting\n            var sb = new StringBuilder();\n            for (int i = 0; i < Constants.MAX_NESTED_TAGS; i++)\n            {\n                sb.Append(\"<div>\");\n            }\n            antisamy.Scan(sb.ToString(), policy).GetCleanHtml().Should().NotBeNullOrEmpty();\n\n            // Add one more tag to push the limit\n            sb.Append(\"<div>\");\n            string result = null;\n            try\n            {\n                result = antisamy.Scan(sb.ToString()).GetCleanHtml();\n            }\n            catch (OWASP.AntiSamy.Exceptions.ScanException)\n            {\n                // To comply with try/catch\n            }\n\n            result.Should().BeNull();\n        }\n\n        [Test(Description = \"Tests issue #107 from owaspantisamy Google Code Archive.\")]\n        public void TestErroneousNewLinesAppearing()\n        {\n            var sb = new StringBuilder();\n            const string nl = \"\\n\";\n            const string header = \"<h1>Header</h1>\";\n            const string para = \"<p>Paragraph</p>\";\n            sb.Append(header);\n            sb.Append(nl);\n            sb.Append(para);\n\n            string html = sb.ToString();\n            string result = antisamy.Scan(html, policy).GetCleanHtml();\n            result.IndexOf(nl).Should().Be(result.LastIndexOf(nl));\n\n            int expectedLocation = header.Length;\n            int actualLocation = result.IndexOf(nl);\n            actualLocation.Should().BeInRange(expectedLocation - 1, expectedLocation,\n                because: \"According to Java project: 'account for line separator length difference across OSes'\");\n        }\n\n        [Test(Description = \"Tests issue #112 from owaspantisamy Google Code Archive.\")]\n        public void TestEmptyTagSelfClosing()\n        {\n            Policy revised = policy\n                .CloneWithDirective(Constants.PRESERVE_COMMENTS, \"true\")\n                .CloneWithDirective(Constants.PRESERVE_SPACE, \"true\")\n                .CloneWithDirective(Constants.FORMAT_OUTPUT, \"false\");\n\n            antisamy.Scan(\"text <strong></strong> text <strong><em></em></strong> text\", revised).GetCleanHtml()\n                .Should().NotContainAll(\"<strong />\", \"<strong/>\");\n\n            // Due to CDATA handling on title tag, test result is not equality checking.\n            antisamy.Scan(\"<html><head><title>foobar</title></head><body><img src=\\\"http://foobar.com/pic.gif\\\" /></body></html>\", policy).GetCleanHtml().Should()\n                .ContainAll(\"<title>\", \"foobar\", \"</title>\", \"<body><img src=\\\"http://foobar.com/pic.gif\\\" /></body>\");\n        }\n\n        [Test]\n        [Ignore(\"HtmlAgilityPack does not parse CDATA tags very well. This in particular, is wrong.\")]\n        public void TestCDataBypass()\n        {\n            CleanResults result = antisamy.Scan(\"<![CDATA[]><script>alert(1)</script>]]>\", policy);\n            result.GetNumberOfErrors().Should().BeGreaterThan(0);\n            result.GetCleanHtml().Should().Contain(\"&lt;script\").And.NotContain(\"<script\");\n        }\n\n        [Test]\n        [Ignore(\"HtmlAgilityPack does not parse CDATA tags very well. This in particular, is wrong.\")]\n        public void TestNestedCDataAttack()\n        {\n            antisamy.Scan(\"<![CDATA[]><script>alert(1)</script><![CDATA[]>]]><script>alert(2)</script>>]]>\", policy).GetCleanHtml().\n                Should().NotContain(\"<script>\");\n        }\n\n        [Test(Description = \"Tests issue #101 from owaspantisamy Google Code Archive.\")]\n        public void TestInternationalCharacterSupport()\n        {\n            const string html = \"<b>letter 'a' with umlaut: \\u00e4\";\n\n            Policy revised = policy.CloneWithDirective(Constants.ENTITY_ENCODE_INERNATIONAL_CHARS, \"false\");\n            antisamy.Scan(html, revised).GetCleanHtml().Should().Contain(\"\\u00e4\");\n\n            Policy revised2 = policy.CloneWithDirective(Constants.ENTITY_ENCODE_INERNATIONAL_CHARS, \"true\");\n            antisamy.Scan(html, revised2).GetCleanHtml().Should().Contain(\"&auml;\").And.NotContain(\"\\u00e4\");\n\n            antisamy.Scan(\"<span id=\\\"my-span\\\" class='my-class'>More special characters: \u0262\u2660\u2664\u00e1</span>\", revised2).GetCleanHtml().Should()\n                .Be(\"<span id=\\\"my-span\\\" class='my-class'>More special characters: &#610;&spades;&#9828;&aacute;</span>\");\n        }\n\n        [Test]\n        [Ignore(\"Current result is <iframe />, more inspection is needed.\")]\n        public void TestIframeValidation()\n        {\n            var tag = new Tag(\"iframe\", Constants.ACTION_VALIDATE, new Dictionary<string, Attribute>());\n            Policy revised = policy.MutateTag(tag);\n\n            antisamy.Scan(\"<iframe></iframe>\", revised).GetCleanHtml().Should().Be(\"<iframe></iframe>\");\n        }\n\n        /*\n\t     * Tests cases dealing with nofollowAnchors directive. Assumes anchor tags\n\t     * have an action set to \"validate\" (may be implicit) in the policy file.\n\t     */\n        [Test]\n        public void TestNoFollowAnchors()\n        {\n            // If we have activated nofollowAnchors\n            Policy revised = policy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"true\");\n\n            // Adds when not present\n            antisamy.Scan(\"<a href=\\\"blah\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // Adds properly even with bad attr\n            antisamy.Scan(\"<a href=\\\"blah\\\" bad=\\\"true\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // rel with bad value gets corrected\n            antisamy.Scan(\"<a href=\\\"blah\\\" rel=\\\"blh\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // Correct attribute doesn't get messed with\n            antisamy.Scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // If two correct attributes, only one remaining after scan\n            antisamy.Scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\" rel=\\\"nofollow\\\">link</a>\", revised).GetCleanHtml().Should().Be(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\");\n            // Test if value is off - does it add?\n            antisamy.Scan(\"a href=\\\"blah\\\">link</a>\", revised).GetCleanHtml().Should().NotContain(\"nofollow\");\n        }\n\n        [Test]\n        public void TestValidateParamAsEmbed()\n        {\n            Policy revised = policy.CloneWithDirective(Constants.VALIDATE_PARAM_AS_EMBED, \"true\");\n\n            // Let's start with a YouTube embed\n            string input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n            string expectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n            antisamy.Scan(input, revised).GetCleanHtml().Should().Be(expectedOutput);\n\n            // Now what if someone sticks malicious URL in the value of the value attribute in the param tag? Remove that param tag\n            input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://supermaliciouscode.com/badstuff.swf\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n            expectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n            antisamy.Scan(input, revised).GetCleanHtml().Should().Contain(expectedOutput);\n\n            // Now what if someone sticks malicious URL in the value of the src attribute in the embed tag? remove that embed tag\n            input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://hereswhereikeepbadcode.com/ohnoscary.swf\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n            expectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /></object>\";\n            antisamy.Scan(input, revised).GetCleanHtml().Should().Contain(expectedOutput);\n        }\n\n        [Test]\n        public void TestOnsiteRegex()\n        {\n            antisamy.Scan(\"<a href=\\\"foo\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n            antisamy.Scan(\"<a href=\\\"/foo/bar\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n            antisamy.Scan(\"<a href=\\\"../../di.cgi?foo&amp;3D~\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n            antisamy.Scan(\"<a href=\\\"/foo/bar/1/sdf;jsessiond=1f1f12312_123123\\\">X</a>\", policy).GetCleanHtml().Should().Contain(\"href=\\\"\");\n        }\n\n        [Test(Description = \"Tests issue #10 from nahsra/antisamy on GitHub.\")]\n        public void TestHtml5Colon()\n        {\n            antisamy.Scan(\"<a href=\\\"javascript&colon;alert&lpar;1&rpar;\\\">X</a>\", policy).GetCleanHtml().Should().NotContain(\"javascript\");\n        }\n\n        [Test(Description = \"Tests issue #144 from owaspantisamy Google Code Archive.\")]\n        public void TestPinataString()\n        {\n            antisamy.Scan(\"pi\\u00f1ata\", policy).GetCleanHtml().Should().Be(\"pi\\u00f1ata\");\n        }\n\n        [Test]\n        public void TestHtml5DynamicDataAttribute()\n        {\n            // Test good attribute \"data-\"\n            antisamy.Scan(\"<p data-tag=\\\"abc123\\\">Hello World!</p>\", policy).GetCleanHtml().Should().Be(\"<p data-tag=\\\"abc123\\\">Hello World!</p>\");\n            // Test bad attribute \"dat-\"\n            antisamy.Scan(\"<p dat-tag=\\\"abc123\\\">Hello World!</p>\", policy).GetCleanHtml().Should().Be(\"<p>Hello World!</p>\");\n        }\n\n        [Test]\n        public void TestXssOnMouseOver()\n        {\n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER);\n            antisamy.Scan(\"<bogus>whatever</bogus><img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" onmouseover=\\\"alert('xss')\\\">\", revised).GetCleanHtml()\n                .Should().Be(\"whatever<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" />\");\n        }\n\n        [Test]\n        public void TestObfuscationOnclickXssBypass()\n        {\n            antisamy.Scan(\"<a href=\\\"http://example.com\\\"&amp;/onclick=alert(9)>foo</a>\", policy).GetCleanHtml()\n                .Should().Be(\"<a href=\\\"http://example.com\\\" rel=\\\"nofollow\\\">foo</a>\");\n        }\n\n        [Test(Description = \"Tests issue #10 from nahsra/antisamy on GitHub.\")]\n        public void TestOnloadXssOnStyleTag()\n        {\n            antisamy.Scan(\"<style onload=alert(1)>h1 {color:red;}</style>\", policy).GetCleanHtml().Should().NotContain(\"alert\");\n        }\n\n        [Test]\n        public void TestUnknownTags()\n        {\n            // Original comment: Mailing list user sent this in. Didn't work, but good test to leave in.\n            antisamy.Scan(\"<%/onmouseover=prompt(1)>\", policy).GetCleanHtml().Should().NotContain(\"<%/\");\n        }\n\n        [Test]\n        public void TestStreamScan()\n        {\n            const string testImgSrcUrl = \"<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" \";\n            using var reader = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes($\"<bogus>whatever</bogus>{testImgSrcUrl}onmouseover=\\\"alert('xss')\\\">\")));\n            using var writer = new StreamWriter(new MemoryStream());\n\n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER);\n            antisamy.Scan(reader, writer, revised).GetCleanHtml().Should().BeNull();\n\n            using var resultReader = new StreamReader(writer.BaseStream);\n            resultReader.ReadToEnd().Should().Be($\"whatever{testImgSrcUrl}/>\");\n        }\n\n        [Test(Description = \"Tests issue #23 from nahsra/antisamy on GitHub.\")]\n        public void TestStrippingNestedLists()\n        {\n            const string html = \"<ul><li>one</li><li>two</li><li>three<ul><li>a</li><li>b</li></ul></li></ul>\";\n            /* Issue claims you end up with this:\n             *      <ul><li>one</li><li>two</li><li>three<ul></ul></li><li>a</li><li>b</li></ul>\n             *      \n             * Meaning the <li>a</li><li>b</li> elements were moved outside of the nested <ul> list they were in\n             */\n\n            // The replace is used to strip out all the whitespace in the clean HTML so we can successfully find what we expect to find\n            antisamy.Scan(html, policy).GetCleanHtml().Replace(\"\\\\s\", \"\").Should().Contain(\"<ul><li>a</li>\");\n        }\n\n        [Test(Description = \"Tests issue #24 from nahsra/antisamy on GitHub.\")]\n        [Ignore(\"This issue is a valid enhancement request planned to implement in the future. Now it is ignored to pass CI.\")]\n        public void TestOnUnknownTagEncodingBehaviorWithAtSymbol()\n        {\n            // If we have onUnknownTag set to \"encode\", it still strips out the @ and everything else after it.\n            // DOM Parser actually rips out the entire <name@mail.com> value even with onUnknownTag set.\n            Policy revised = policy.CloneWithDirective(\"onUnknownTag\", Constants.ACTION_ENCODE);\n            antisamy.Scan(\"firstname,lastname<name@mail.com>\", revised).GetCleanHtml().Should().Contain(\"name@mail.com\");\n        }\n\n        [Test(Description = \"Tests issue #26 from nahsra/antisamy on GitHub.\")]\n        public void TestPotentialXssFalsePositive()\n        {\n            const string html = \"&#x22;&#x3E;&#x3C;&#x69;&#x6D;&#x67;&#x20;&#x73;&#x72;&#x63;&#x3D;&#x61;&#x20;&#x6F;\" +\n                \"&#x6E;&#x65;&#x72;&#x72;&#x6F;&#x72;&#x3D;&#x61;&#x6C;&#x65;&#x72;&#x74;&#x28;&#x31;&#x29;&#x3E;\";\n            // Issue claims you end up with this: ><img src=a onerror=alert(1)>\n            antisamy.Scan(html, policy).GetCleanHtml().Should().NotContain(\"<img src=a onerror=alert(1)>\");\n            // But you actually end up with this: &quot;&gt;&lt;img src=a onerror=alert(1)&gt; -- Which is as expected\n        }\n\n        [Test(Description = \"Tests issue #27 from nahsra/antisamy on GitHub.\")]\n        public void TestOutOfBoundsExceptionOnSimpleText()\n        {\n            // This test doesn't cause an OutOfBoundsException, as reported in this issue even though it replicates the test as described.\n            antisamy.Scan(\"my &test\", policy).GetCleanHtml().Should().Contain(\"test\");\n        }\n\n        [Test(Description = \"Tests issue #33 from nahsra/antisamy on GitHub.\")]\n        public void TestTrickyEncodingXssBypassTrial()\n        {\n            /* Issue claims you end up with this:\n             *   javascript:x=alert and other similar problems (javascript&#00058x=alert,x%281%29) but you don't.\n             *   So issue is a false positive and has been closed.\n             */\n            const string html = \"<html>\\n\"\n                + \"<head>\\n\"\n                + \"  <title>Test</title>\\n\"\n                + \"</head>\\n\"\n                + \"<body>\\n\"\n                + \"  <h1>Tricky Encoding</h1>\\n\"\n                + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n                + \"  <ol>\\n\"\n                + \"    <li><a href=\\\"javascript&#00058x=alert,x%281%29\\\">X&#00058;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#00058y=alert,y%281%29\\\">X&#00058;y</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#58x=alert,x%281%29\\\">X&#58;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#58y=alert,y%281%29\\\">X&#58;y</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x0003Ax=alert,x%281%29\\\">X&#x0003A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x0003Ay=alert,y%281%29\\\">X&#x0003A;y</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">X&#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x3Ay=alert,y%281%29\\\">X&#x3A;y</a></li>\\n\"\n                + \"  </ol>\\n\"\n                + \"  <h1>Tricky Encoding with Ampersand Encoding</h1>\\n\"\n                + \"  <p>AntiSamy turns harmless payload into XSS by just decoding the encoded ampersands in the href attribute</a>\\n\"\n                + \"  <ol>\\n\"\n                + \"    <li><a href=\\\"javascript&amp;#x3Ax=alert,x%281%29\\\">X&amp;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&AMP;#x3Ax=alert,x%281%29\\\">X&AMP;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#38;#x3Ax=alert,x%281%29\\\">X&#38;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#00038;#x3Ax=alert,x%281%29\\\">X&#00038;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x26;#x3Ax=alert,x%281%29\\\">X&#x26;#x3A;x</a></li>\\n\"\n                + \"    <li><a href=\\\"javascript&#x00026;#x3Ax=alert,x%281%29\\\">X&#x00026;#x3A;x</a></li>\\n\"\n                + \"  </ol>\\n\"\n                + \"  <p><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">Original without ampersand encoding</a></p>\\n\"\n                + \"</body>\\n\"\n                + \"</html>\";\n            antisamy.Scan(html, policy).GetCleanHtml().Should().NotContain(\"javascript&#00058x=alert,x%281%29\");\n        }\n\n        [Test(Description = \"Tests issue #34 from nahsra/antisamy on GitHub.\")]\n        public void TestStripNonValidXmlCharacters()\n        {\n            // Issue indicates: \"<div>Hello\\\\uD83D\\\\uDC95</div>\" should be sanitized to: \"<div>Hello</div>\"\n            antisamy.Scan(\"<div>Hello\\uD83D\\uDC95</div>\", policy).GetCleanHtml().Should().Be(\"<div>Hello</div>\");\n            antisamy.Scan(\"\\uD888\", policy).GetCleanHtml().Should().BeEmpty();\n        }\n\n        [Test(Description = \"Tests issue #40 from nahsra/antisamy on GitHub.\")]\n        public void TestCleaningSvgFalsePositive()\n        {\n            // Concern is that: <svg onload=alert(1)//  does not get cleansed.\n            // Based on these test results, it does get cleaned so this issue is a false positive, so we closed it.\n            const string html = \"<html>\\n\"\n                + \"<head>\\n\"\n                + \"  <title>Test</title>\\n\"\n                + \"</head>\\n\"\n                + \"<body>\\n\"\n                + \"  <h1>Tricky Encoding</h1>\\n\"\n                + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n                + \"  <ol>\\n\"\n                + \"    <li><h3>svg onload=alert follows:</h3><svg onload=alert(1)//</li>\\n\"\n                + \"  </ol>\\n\"\n                + \"</body>\\n\"\n                + \"</html>\";\n\n            antisamy.Scan(html, policy).GetCleanHtml().Should().NotContain(\"<svg onload=alert(1)//\");\n        }\n\n        [Test(Description = \"Tests issue #48 from nahsra/antisamy on GitHub.\")]\n        public void TestOnsiteUrlAttacks()\n        {\n            // Concern is that onsiteURL regex is not safe for URLs that start with //.\n            // For example:  //evilactor.com?param=foo\n            const string phishingAttempt = \"<a href=\\\"//evilactor.com/stealinfo?a=xxx&b=xxx\\\"><span style=\\\"color:red;font-size:100px\\\">\"\n                + \"You must click me</span></a>\";\n            // Output: <a rel=\"nofollow\"><span style=\"color: red;font-size: 100.0px;\">You must click me</span></a>\n            antisamy.Scan(phishingAttempt, policy).GetCleanHtml().Should().NotContain(\"//evilactor.com/\");\n\n            // This ones never failed, they're just to prove a dangling markup attack on the following resulting HTML won't work.\n            // Less probable case (steal more tags):\n            const string danglingMarkup = \"<div>User input: \" +\n                \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\"><a href='//evilactor.com?\" +\n                \"\\\"> all this info wants to be stolen with <i>danlging markup attack</i>\" +\n                \" until a single quote to close is found'</div>\";\n            antisamy.Scan(danglingMarkup, policy).GetCleanHtml().Should().NotContain(\"//evilactor.com/\");\n\n            // More probable case (steal just an attribute):\n            //      HTML before attack: <input type=\"text\" name=\"input\" value=\"\" data-attribute-to-steal=\"some value\">\n            const string danglingMarkup2 = \"<div>User input: \" +\n                    \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\" data-attribute-to-steal=\\\"some value\\\">\";\n            antisamy.Scan(danglingMarkup2, policy).GetCleanHtml().Should().NotContain(\"//evilactor.com/\");\n        }\n\n        [Test(Description = \"Tests issue #62 from nahsra/antisamy on GitHub.\")]\n        public void TestProcessingInstructionRemoval()\n        {\n            antisamy.Scan(\"<div><?foo note=\\\"I am XML processing instruction. I wish to be excluded\\\" ?></div>\", policy).GetCleanHtml().Should().Be(\"<div></div>\");\n            antisamy.Scan(\"<?xml-stylesheet type=\\\"text/css\\\" href=\\\"style.css\\\"?>\", policy).GetCleanHtml().Should().BeEmpty();\n            antisamy.Scan(\"|<?ai aaa\", policy).GetCleanHtml().Should().Be(\"|\");\n            antisamy.Scan(\"<div>|<?ai aaa\", policy).GetCleanHtml().Should().Be(\"<div>|</div>\");\n        }\n\n        [Test]\n        public void TestTagTruncation()\n        {\n            Policy revised = policy\n                .MutateTag(new Tag(\"section\", \"validate\", null))\n                .MutateTag(new Tag(\"div\", \"truncate\", null));\n\n            antisamy.Scan(\"<section><div class='.divToTruncate'>Div only contains this text<span>Confirmed</span></div></section>\", revised)\n                .GetCleanHtml().Should().Be(\"<section><div>Div only contains this text</div></section>\");\n        }\n\n        [Test(Description = \"Tests issue #81 from nahsra/antisamy on GitHub.\")]\n        public void TestPreserveImportantOnCssProperty()\n        {\n            antisamy.Scan(\"<p style=\\\"color: red !important\\\">Some Text</p>\", policy).GetCleanHtml().Should().Contain(\"!important\");\n        }\n\n        [Test]\n        public void TestEntityReferenceEncodedInHtmlAttribute()\n        {\n            antisamy.Scan(\"<p><a href=\\\"javascript&#00058x=1,%61%6c%65%72%74%28%22%62%6f%6f%6d%22%29\\\">xss</a></p>\", policy).GetCleanHtml().Should().Contain(\"javascript&amp;#00058\");\n        }\n\n        [Test(Description = \"Tests issue #101 from nahsra/antisamy on GitHub.\")]\n        public void TestManySingificantFiguresAndExponentialValuesOnCss()\n        {\n            // Test that margin attribute is not removed when value has too much significant figures.\n            // Current behavior is that decimals like 0.00001 are internally translated to 1E-05, this\n            // is reflected on regex validation and actual output. The inconsistency is due to Batik CSS.\n            antisamy.Scan(\"<p style=\\\"margin: 0.0001pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 0.0001pt\");\n            antisamy.Scan(\"<p style=\\\"margin: 10000000pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 10000000pt\");\n            \n            // When using exponential directly with \"e\" or \"E\" the output gets transformed to decimal.\n            // Ideally in a new version of AngleSharp.Css it should keep the exponential format.\n            antisamy.Scan(\"<p style=\\\"margin: 1.0E-04pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 0.0001\");\n            antisamy.Scan(\"<p style=\\\"margin: 1.0e+04pt;\\\">Some text.</p>\", policy).GetCleanHtml().Should().Contain(\"margin: 10000\");\n        }\n\n        [Test]\n        public void TestCssUnits()\n        {\n            const string input = \"<div style=\\\"width:50vw;height:50vh;padding:1rpc;\\\">\\n\" +\n                \"\\t<p style=\\\"font-size:1.5ex;padding-left:1rem;padding-top:16px;\\\">Some text.</p>\\n\" +\n                \"</div>\";\n            antisamy.Scan(input, policy).GetCleanHtml().Should().ContainAll(\"ex\", \"px\", \"rem\", \"vw\", \"vh\").And.NotContain(\"rpc\");\n        }\n\n        [Test(Description = \"Tests for CVE-2021-42575.\")]\n        public void TestXSSInsideSelectOptionStyle()\n        {\n            antisamy.Scan(\"<select><option><style>h1{color:black;}</style></option></select>\", policy).GetCleanHtml().Should().Contain(\"color\");\n            antisamy.Scan(\"<select><option><style><script>alert(1)</script></style></option></select>\", policy).GetCleanHtml().Should().NotContain(\"<script>\");\n        }\n\n        [Test]\n        public void TestStyleImport()\n        {\n            // Check order is correct:\n            //  First import: noprint class\n            //  Second import: table.browserref selector\n            //  Original styles: very-specific-antisamy class\n            const string input = \"<style type='text/css'>\\n\" +\n                \"\\t@import url(https://www.w3.org/2008/site/css/realprint.css);\\n\" +\n                \"\\t@import \\\"https://www.w3schools.com/browserref.css\\\";\\n\" +\n                \"\\t.very-specific-antisamy {font: 15pt \\\"Arial\\\"; color: blue;}\\n\" +\n                \"</style>\";\n            var resultRegex = new Regex(@\".*?\\.noprint.*?table\\.browserref.*?\\.very-specific-antisamy.*?\", RegexOptions.Singleline);\n            \n            Policy revised = policy.CloneWithDirective(Constants.EMBED_STYLESHEETS, \"true\");\n            resultRegex.IsMatch(antisamy.Scan(input, revised).GetCleanHtml()).Should().Be(true);\n\n            Policy revised2 = policy.CloneWithDirective(Constants.EMBED_STYLESHEETS, \"true\").CloneWithDirective(Constants.MAX_STYLESHEET_IMPORTS, \"1\");\n            antisamy.Scan(input, revised2).GetErrorMessages()\n                .Should().Contain(string.Format(OWASP.AntiSamy.Properties.Resources.ResourceManager.GetString(Constants.ERROR_CSS_IMPORT_EXCEEDED), \n                HtmlEntityEncoder.HtmlEntityEncode(\"https://www.w3schools.com/browserref.css\"), 1));\n\n            Policy revised3 = revised.CloneWithDirective(Constants.MAX_INPUT_SIZE, \"500\");\n            antisamy.Scan(input, revised3).GetErrorMessages()\n                .Should().Contain(string.Format(OWASP.AntiSamy.Properties.Resources.ResourceManager.GetString(Constants.ERROR_CSS_IMPORT_TOOLARGE), \n                HtmlEntityEncoder.HtmlEntityEncode(\"https://www.w3schools.com/browserref.css\"), 500));\n        }\n\n        [Test]\n        public void TestOnUnknownTagActions()\n        {\n            const string unknownTag = \"<bogus a=\\\"1\\\">whatever</bogus><span>Text</span>\";\n            // Default is to remove.\n            antisamy.Scan(unknownTag, policy).GetCleanHtml().Should().Be(\"<span>Text</span>\");\n            // Only actions different than \"remove\" are considered, any other text reuslts in removing. \n            Policy revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, \"other text\");\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"<span>Text</span>\");\n            // Cannot validate undefined tag, remove it.\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_VALIDATE);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"<span>Text</span>\");\n            // Encode tag\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_ENCODE);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"&lt;bogus a=&quot;1&quot;&gt;whatever&lt;/bogus&gt;<span>Text</span>\");\n            // Filter tag\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_FILTER);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"whatever<span>Text</span>\");\n            // Truncate tag\n            revised = policy.CloneWithDirective(Constants.ON_UNKNOWN_TAG_ACTION, Constants.ACTION_TRUNCATE);\n            antisamy.Scan(unknownTag, revised).GetCleanHtml().Should().Be(\"<bogus>whatever</bogus><span>Text</span>\");\n        }\n\n        [Test]\n        public void TestNoopenerAndNoreferrer()\n        {\n            Policy basePolicy = policy.MutateTag(new Tag(\"a\", Constants.ACTION_VALIDATE, new Dictionary<string, Attribute>\n            {\n                { \"target\", new Attribute(\"target\", string.Empty, string.Empty, new List<string>(), new List<string>{ \"_blank\", \"_self\" }) },\n                { \"rel\", new Attribute(\"rel\", string.Empty, string.Empty, new List<string>(), new List<string>{ \"nofollow\", \"noopener\", \"noreferrer\" }) }\n            }));\n\n            Policy revised = basePolicy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"true\").CloneWithDirective(Constants.ANCHORS_NOOPENER_NOREFERRER, \"true\");\n            // No target=\"_blank\", so only nofollow can be added.\n            antisamy.Scan(\"<a>Link text</a>\", revised).GetCleanHtml().Should().Contain(\"nofollow\").And.NotContain(\"noopener noreferrer\");\n            // target=\"_blank\", can have both.\n            antisamy.Scan(\"<a target=\\\"_blank\\\">Link text</a>\", revised).GetCleanHtml().Should().Contain(\"nofollow noopener noreferrer\");\n            \n            Policy revised2 = basePolicy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"false\").CloneWithDirective(Constants.ANCHORS_NOOPENER_NOREFERRER, \"true\");\n            // No target=\"_blank\", no rel added.\n            antisamy.Scan(\"<a>Link text</a>\", revised2).GetCleanHtml().Should().NotContain(\"rel=\");\n            // target=\"_blank\", everything present.\n            antisamy.Scan(\"<a target='_blank' rel='nofollow'>Link text</a>\", revised2).GetCleanHtml().Should().Contain(\"nofollow noopener noreferrer\");\n            // target=\"_self\", no rel added.\n            antisamy.Scan(\"<a target='_self'>Link text</a>\", revised2).GetCleanHtml().Should().NotContain(\"rel=\");\n            // target=\"_self\", only nofollow present.\n            antisamy.Scan(\"<a target='_self' rel='nofollow'>Link text</a>\", revised2).GetCleanHtml().Should().Contain(\"nofollow\").And.NotContain(\"noopener noreferrer\");\n            // noopener is not repeated\n            antisamy.Scan(\"<a target='_blank' rel='noopener'>Link text</a>\", revised2).GetCleanHtml()\n                .Split(new string[] { \"noopener\" }, StringSplitOptions.None).Length.Should().Be(2);\n\n            Policy revised3 = basePolicy.CloneWithDirective(Constants.ANCHORS_NOFOLLOW, \"false\").CloneWithDirective(Constants.ANCHORS_NOOPENER_NOREFERRER, \"false\");\n            // No rel added\n            antisamy.Scan(\"<a>Link text</a>\", revised3).GetCleanHtml().Should().NotContain(\"rel=\");\n            // noopener is not repeated\n            antisamy.Scan(\"<a target='_blank' rel='noopener'>Link text</a>\", revised3).GetCleanHtml()\n                .Split(new string[] { \"noopener\" }, StringSplitOptions.None).Length.Should().Be(2);\n        }\n\n        [Test]\n        public void TestLeadingDashOnPropertyName()\n        {\n            // Test that property names with leading dash are supported\n            string input = \"<style type='text/css'>\\n\" +\n                \"\\t.very-specific-antisamy { -moz-border-radius: inherit ; -webkit-border-radius: 25px 10px 5px 10px;}\\n\" +\n                \"</style>\";\n            \n            // Define new properties for the policy\n            var leadingDashProperty1 = new Property(\"-webkit-border-radius\");\n            leadingDashProperty1.AddAllowedRegExp(\"\\\\d+(\\\\.\\\\d+)?px( \\\\d+(\\\\.\\\\d+)?px){0,3}\");\n            var leadingDashProperty2 = new Property(\"-moz-border-radius\");\n            leadingDashProperty2.AddAllowedValue(\"inherit\");\n            Policy revised = policy.AddCssProperty(leadingDashProperty1).AddCssProperty(leadingDashProperty2);\n            \n            // Test properties\n            antisamy.Scan(input, revised).GetCleanHtml().Should().ContainAll(\"-webkit-border-radius\", \"-moz-border-radius\");\n        }\n\n        [Test]\n        public void TestSmuggledTagsInStyleContent()\n        {\n            antisamy.Scan(\"<style/>b<![CDATA[</style><a href=javascript:alert(1)>test\", policy).GetCleanHtml()\n                .Should().NotContain(\"javascript\");\n            antisamy.Scan(\"<select<style/>W<xmp<script>alert(1)</script>\", policy).GetCleanHtml()\n                .Should().NotContain(\"script\");\n            antisamy.Scan(\"<select<style/>k<input<</>input/onfocus=alert(1)>\", policy).GetCleanHtml()\n                .Should().NotContain(\"input\");\n            antisamy.Scan(\"<style/><listing/>]]><noembed></style><img src=x onerror=mxss(1)></noembed>\", policy).GetCleanHtml()\n               .Should().NotContain(\"mxss\");\n            antisamy.Scan(\"<style/><math>'<noframes ></style><img src=x onerror=mxss(1)></noframes>'\", policy).GetCleanHtml()\n               .Should().NotContain(\"mxss\");\n        }\n\n        [Test]\n        public void TestMalformedPIScan()\n        {\n            string result = null;\n            try\n            {\n                result = antisamy.Scan(\"<!--><?a/\", policy).GetCleanHtml();\n            }\n            catch\n            {\n                // To comply with try/catch\n            }\n            result.Should().NotBeNull();\n\n            result = null;\n            try\n            {\n                result = antisamy.Scan(\"<!--?><?a/\", policy).GetCleanHtml();\n            }\n            catch\n            {\n                // To comply with try/catch\n            }\n            result.Should().NotBeNull();\n        }\n    }\n}\n"], "filenames": ["OWASP.AntiSamyTests/Html/AntiSamyTest.cs"], "buggy_code_start_loc": [905], "buggy_code_end_loc": [905], "fixing_code_start_loc": [906], "fixing_code_end_loc": [910], "type": "CWE-79", "message": "OWASP AntiSamy .NET is a library for performing cleansing of HTML coming from untrusted sources. Prior to version 1.2.0, there is a potential for a mutation cross-site scripting (mXSS) vulnerability in AntiSamy caused by flawed parsing of the HTML being sanitized. To be subject to this vulnerability the `preserveComments` directive must be enabled in your policy file and also allow for certain tags at the same time. As a result, certain crafty inputs can result in elements in comment tags being interpreted as executable when using AntiSamy's sanitized output. This is patched in OWASP AntiSamy .NET 1.2.0 and later. See important remediation details in the reference given below. As a workaround, manually edit the AntiSamy policy file (e.g., antisamy.xml) by deleting the `preserveComments` directive or setting its value to `false`,  if present. Also it would be useful to make AntiSamy remove the `noscript` tag by adding a line described in the GitHub Security Advisory to the tag definitions under the `<tagrules>` node, or deleting it entirely if present. As the previously mentioned policy settings are preconditions for the mXSS attack to work, changing them as recommended should be sufficient to protect you against this vulnerability when using a vulnerable version of this library. However, the existing bug would still be present in AntiSamy or its parser dependency (HtmlAgilityPack). The safety of this workaround relies on configurations that may change in the future and don't address the root cause of the vulnerability. As such, it is strongly recommended to upgrade to a fixed version of AntiSamy.", "other": {"cve": {"id": "CVE-2023-51652", "sourceIdentifier": "security-advisories@github.com", "published": "2024-01-02T20:15:10.453", "lastModified": "2024-01-08T19:35:18.890", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "OWASP AntiSamy .NET is a library for performing cleansing of HTML coming from untrusted sources. Prior to version 1.2.0, there is a potential for a mutation cross-site scripting (mXSS) vulnerability in AntiSamy caused by flawed parsing of the HTML being sanitized. To be subject to this vulnerability the `preserveComments` directive must be enabled in your policy file and also allow for certain tags at the same time. As a result, certain crafty inputs can result in elements in comment tags being interpreted as executable when using AntiSamy's sanitized output. This is patched in OWASP AntiSamy .NET 1.2.0 and later. See important remediation details in the reference given below. As a workaround, manually edit the AntiSamy policy file (e.g., antisamy.xml) by deleting the `preserveComments` directive or setting its value to `false`,  if present. Also it would be useful to make AntiSamy remove the `noscript` tag by adding a line described in the GitHub Security Advisory to the tag definitions under the `<tagrules>` node, or deleting it entirely if present. As the previously mentioned policy settings are preconditions for the mXSS attack to work, changing them as recommended should be sufficient to protect you against this vulnerability when using a vulnerable version of this library. However, the existing bug would still be present in AntiSamy or its parser dependency (HtmlAgilityPack). The safety of this workaround relies on configurations that may change in the future and don't address the root cause of the vulnerability. As such, it is strongly recommended to upgrade to a fixed version of AntiSamy."}, {"lang": "es", "value": "OWASP AntiSamy .NET es una librer\u00eda para realizar la limpieza de HTML proveniente de fuentes no confiables. Antes de la versi\u00f3n 1.2.0, exist\u00eda la posibilidad de que se produjera una vulnerabilidad de mutaci\u00f3n de cross site scripting (mXSS) en AntiSamy causada por un an\u00e1lisis defectuoso del HTML que se estaba sanitizando. Para estar sujeto a esta vulnerabilidad, la directiva `preserveComments` debe estar habilitada en su archivo de pol\u00edtica y tambi\u00e9n permitir ciertas etiquetas al mismo tiempo. Como resultado, ciertas entradas astutas pueden dar lugar a que los elementos de las etiquetas de comentarios se interpreten como ejecutables cuando se utiliza la salida sanitizada de AntiSamy. Esto est\u00e1 parcheado en OWASP AntiSamy .NET 1.2.0 y posteriores. Consulte detalles importantes de remediaci\u00f3n en la referencia que se proporciona a continuaci\u00f3n. Como workaround, edite manualmente el archivo de pol\u00edtica AntiSamy (por ejemplo, antisamy.xml) eliminando la directiva `preserveComments` o estableciendo su valor en `false`, si est\u00e1 presente. Tambi\u00e9n ser\u00eda \u00fatil hacer que AntiSamy elimine la etiqueta `noscript` agregando una l\u00ednea descrita en GitHub Security Advisory a las definiciones de etiquetas en el nodo ``, o elimin\u00e1ndola por completo si est\u00e1 presente. Como las configuraciones de pol\u00edticas mencionadas anteriormente son condiciones previas para que funcione el ataque mXSS, cambiarlas seg\u00fan lo recomendado deber\u00eda ser suficiente para protegerlo contra esta vulnerabilidad cuando utilice una versi\u00f3n vulnerable de esta librer\u00eda. Sin embargo, el error existente a\u00fan estar\u00eda presente en AntiSamy o su dependencia del analizador (HtmlAgilityPack). La seguridad de esta soluci\u00f3n depende de configuraciones que pueden cambiar en el futuro y no abordan la causa ra\u00edz de la vulnerabilidad. Como tal, se recomienda encarecidamente actualizar a una versi\u00f3n fija de AntiSamy."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:spassarop:owasp_antisamy_.net:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.2.0", "matchCriteriaId": "13BDB025-E8FE-41BA-8BEC-53FC1A8994D3"}]}]}], "references": [{"url": "https://github.com/spassarop/antisamy-dotnet/commit/7e500daef6ad9c10e97c68feab78f4cb6e3083c6", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/spassarop/antisamy-dotnet/commit/8117911933e75a25cd0054ef017577486338444a", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/spassarop/antisamy-dotnet/security/advisories/GHSA-8x6f-956f-q43w", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}]}, "github_commit_url": "https://github.com/spassarop/antisamy-dotnet/commit/7e500daef6ad9c10e97c68feab78f4cb6e3083c6"}}