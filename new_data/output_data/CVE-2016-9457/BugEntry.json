{"buggy_code": ["<?php\n\n/*\n+---------------------------------------------------------------------------+\n| Revive Adserver                                                           |\n| http://www.revive-adserver.com                                            |\n|                                                                           |\n| Copyright: See the COPYRIGHT.txt file.                                    |\n| License: GPLv2 or later, see the LICENSE.txt file.                        |\n+---------------------------------------------------------------------------+\n*/\n\nrequire_once MAX_PATH . '/lib/max/Admin_DA.php';\nrequire_once MAX_PATH . '/www/admin/lib-statistics.inc.php';\nrequire_once LIB_PATH . '/Plugin/Component.php';\nrequire_once MAX_PATH . '/lib/OX/Util/Utils.php';\nrequire_once MAX_PATH . '/lib/OA/Admin/UI/model/InventoryPageHeaderModelBuilder.php';\n\n\nfunction MAX_getDisplayName($name, $length = 60, $append = '...')\n{\n    $displayName = strlen($name) > $length ? rtrim(substr($name, 0, $length-strlen($append))) . $append : $name;\n    if (empty($displayName)) {\n        $displayName = $GLOBALS['strUntitled'];\n    }\n    return $displayName;\n}\n\nfunction MAX_buildName($id, $name)\n{\n    return htmlspecialchars($name);\n}\n\nfunction MAX_getEntityIcon($entity, $active=true, $type='', $marketAdvertiserid = '')\n{\n    include_once MAX_PATH . '/www/admin/lib-zones.inc.php';\n\n    $icon = '';\n    switch ($entity) {\n        case 'advertiser' :\n            $do = OA_Dal::factoryDO('Clients');\n            switch($type) {\n                case DataObjects_Clients::ADVERTISER_TYPE_MARKET:\n                    $icon = 'images/icon-advertiser-openx.png';\n                break;\n                default:\n                    if($active) {\n                        $icon = 'images/icon-advertiser.gif';\n                    } else {\n                        $icon = 'images/icon-advertiser-d.gif';\n                    }\n                break;\n            }\n            break;\n\n        case 'placement'  :\n            $do = OA_Dal::factoryDO('Campaigns');\n            switch($type) {\n                case DataObjects_Campaigns::CAMPAIGN_TYPE_MARKET_CAMPAIGN_OPTIN:\n                case DataObjects_Campaigns::CAMPAIGN_TYPE_MARKET_CONTRACT:\n                case DataObjects_Campaigns::CAMPAIGN_TYPE_MARKET_ZONE_OPTIN:\n                    $icon = 'images/icon-campaigns-openx.png';\n                break;\n\n                default:\n                    if($active) {\n                        $icon = 'images/icon-campaign.gif';\n                    } else {\n                        $icon = 'images/icon-campaign-d.gif';\n                    }\n                break;\n                }\n            break;\n        case 'publisher'  : $icon = 'images/icon-affiliate.gif'; break;\n        case 'ad' :\n            switch ($type) {\n                case 'html' : $icon = $active ? 'images/icon-banner-html.gif' : 'images/icon-banner-html-d.gif'; break;\n                case 'txt'  : $icon = $active ? 'images/icon-banner-text.gif' : 'images/icon-banner-text-d.gif'; break;\n                case 'url'  : $icon = $active ? 'images/icon-banner-url.gif' : 'images/icon-banner-url-d.gif'; break;\n                case 'web'  : $icon = $active ? 'images/icon-banner-stored.gif' : 'images/icon-banner-stored-d.gif'; break;\n                default     : $icon = $active ? 'images/icon-banner-stored.gif' : 'images/icon-banner-stored-d.gif'; break;\n            }\n            break;\n        case 'zone'       :\n            switch ($type) {\n                case MAX_ZoneMarketMigrated  : $icon = 'images/icon-advertiser-openx.png'; break;\n                case phpAds_ZoneBanner       : $icon = 'images/icon-zone.gif'; break;\n                case phpAds_ZoneInterstitial : $icon = 'images/icon-interstitial.gif'; break;\n                case phpAds_ZonePopup        : $icon = 'images/icon-popup.gif'; break;\n                case phpAds_ZoneText         : $icon = 'images/icon-textzone.gif'; break;\n                case MAX_ZoneEmail           : $icon = 'images/icon-zone-email.gif'; break;\n                case MAX_ZoneClick           : $icon = 'images/icon-zone-click.gif'; break;\n                default                      : $icon = 'images/icon-zone.gif'; break;\n            }\n            break;\n    }\n    return substr($icon,0,4) == 'http' ? $icon : (OX::assetPath() . \"/\" . $icon);\n}\n\nfunction MAX_displayZoneHeader($pageName, $listorder, $orderdirection, $entityIds=null, $anonymous=false)\n{\n    global $phpAds_TextAlignRight;\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strName'], 'name', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strID'], 'id', $pageName, $entityIds, $listorder, $orderdirection, ($anonymous == false));\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strDescription'], 'description', $pageName, $entityIds, $listorder, $orderdirection);\n    echo \"\n    <tr height='1'>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='300' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td width='100%'><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n    </tr>\n    <tr height='25'>\n        <td>$column1</td>\n        <td>$column2</td>\n        <td>$column3</td>\n    </tr>\n    <tr height='1'><td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n}\n\nfunction MAX_displayStatsHeader($pageName, $listorder, $orderdirection, $entityIds=null, $anonymous=false)\n{\n    global $phpAds_TextAlignRight;\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strName'], 'name', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strID'], 'id', $pageName, $entityIds, $listorder, $orderdirection, ($anonymous == false));\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strRequests'], 'sum_requests', $pageName, $entityIds, $listorder, $orderdirection);\n    $column4 = _getHtmlHeaderColumn($GLOBALS['strImpressions'], 'sum_views', $pageName, $entityIds, $listorder, $orderdirection);\n    $column5 = _getHtmlHeaderColumn($GLOBALS['strClicks'], 'sum_clicks', $pageName, $entityIds, $listorder, $orderdirection);\n    $column6 = _getHtmlHeaderColumn($GLOBALS['strCTRShort'], 'ctr', $pageName, $entityIds, $listorder, $orderdirection);\n    $column7 = _getHtmlHeaderColumn($GLOBALS['strConversions'], 'sum_conversions', $pageName, $entityIds, $listorder, $orderdirection);\n    $column8 = _getHtmlHeaderColumn($GLOBALS['strCNVRShort'], 'cnvr', $pageName, $entityIds, $listorder, $orderdirection);\n    echo \"\n    <tr height='1'>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='200' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n    </tr>\n    <tr height='25'>\n        <td width='30%'>$column1</td>\n        <td align='$phpAds_TextAlignRight'>$column2</td>\n        <td align='$phpAds_TextAlignRight'>$column3</td>\n        <td align='$phpAds_TextAlignRight'>$column4</td>\n        <td align='$phpAds_TextAlignRight'>$column5</td>\n        <td align='$phpAds_TextAlignRight'>$column6</td>\n        <td align='$phpAds_TextAlignRight'>$column7</td>\n        <td align='$phpAds_TextAlignRight'>$column8</td>\n    </tr>\n    <tr height='1'><td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n}\n\nfunction MAX_displayStatsHistoryHeader($pageName, $listorder, $orderdirection, $entityIds=null)\n{\n    global $phpAds_TextAlignRight;\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strDays'], 'name', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strImpressions'], 'sum_views', $pageName, $entityIds, $listorder, $orderdirection);\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strClicks'], 'sum_clicks', $pageName, $entityIds, $listorder, $orderdirection);\n    $column4 = _getHtmlHeaderColumn($GLOBALS['strCTRShort'], 'ctr', $pageName, $entityIds, $listorder, $orderdirection);\n    $column5 = _getHtmlHeaderColumn($GLOBALS['strConversions'], 'sum_conversions', $pageName, $entityIds, $listorder, $orderdirection);\n    $column6 = _getHtmlHeaderColumn($GLOBALS['strCNVRShort'], 'cnvr', $pageName, $entityIds, $listorder, $orderdirection);\n    echo \"\n        <table border='0' cellpadding='0' cellspacing='0' width='100%'>\n        <tr height='1'>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='200' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        </tr>\n        <tr height='25'>\n            <td width='30%'>$column1</td>\n            <td align='$phpAds_TextAlignRight'>$column2</td>\n            <td align='$phpAds_TextAlignRight'>$column3</td>\n            <td align='$phpAds_TextAlignRight'>$column4</td>\n            <td align='$phpAds_TextAlignRight'>$column5</td>\n            <td align='$phpAds_TextAlignRight'>$column6</td>\n        </tr>\n        <tr height='1'><td colspan='7' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\n    \";\n}\n\nfunction MAX_displayNoStatsMessage()\n{\n    echo \"\n    <br /><br /><div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/info.gif' width='16' height='16' border='0' align='absmiddle'>{$GLOBALS['strNoStats']}</div>\";\n}\n\nfunction _getHtmlHeaderColumn($title, $name, $pageName, $entityIds, $listorder, $orderdirection, $showColumn = true)\n{\n    $str = '';\n    $entity = _getEntityString($entityIds);\n    if ($listorder == $name) {\n        if (($orderdirection == '') || ($orderdirection == 'down')) {\n            $str = \"<a href='$pageName?{$entity}orderdirection=up'><img src='\" . OX::assetPath() . \"/images/caret-ds.gif' border='0' alt='' title=''></a>\";\n        } else {\n            $str = \"<a href='$pageName?{$entity}orderdirection=down'><img src='\" . OX::assetPath() . \"/images/caret-u.gif' border='0' alt='' title=''></a>\";\n        }\n    }\n    return $showColumn ? \"<b><a href='$pageName?{$entity}listorder=$name'>$title</a>$str</b>\" : '';\n}\n\nfunction _getEntityString($entityIds)\n{\n    $entity = '';\n    if (!empty($entityIds)) {\n        $entityArr = array();\n        foreach ($entityIds as $entityId => $entityValue) {\n            $entityArr[] = \"$entityId=$entityValue\";\n        }\n        $entity = implode('&',$entityArr) . '&';\n    }\n\n    return $entity;\n}\n\nfunction MAX_displayDateSelectionForm($period, $period_start, $period_end, $pageName, &$tabindex, $hiddenValues = null)\n{\n    global $tabindex;\n    require_once MAX_PATH . '/lib/max/Admin/UI/FieldFactory.php';\n\n    $oDaySpan =& FieldFactory::newField('day-span');\n    $oDaySpan->_name = 'period';\n    $oDaySpan->_autoSubmit = true;\n    $oDaySpan->setValueFromArray(array('period_preset' => $period, 'period_start' => $period_start, 'period_end' => $period_end));\n    $oDaySpan->_tabIndex = $tabindex;\n    echo \"\n    <form id='period_form' name='period_form' action='$pageName'>\";\n    $oDaySpan->display();\n    $tabindex = $oDaySpan->_tabIndex;\n    echo \"\n    <input type='button' value='Go' onclick='return periodFormSubmit()' style='margin-left: 1em' tabindex='\".$tabindex++.\"' />\";\n    _displayHiddenValues($hiddenValues);\n    echo \"\n    </form>\";\n}\n\nfunction _displayHiddenValues($hiddenValues)\n{\n    if (!empty($hiddenValues) && is_array($hiddenValues)) {\n        foreach ($hiddenValues as $name => $value) {\n            echo \"\n    <input type='hidden' name='$name' value='$value'>\";\n        }\n    }\n}\n\nfunction MAX_displayPeriodSelectionForm($period, $pageName, &$tabindex, $hiddenValues = null)\n{\n    global $phpAds_TextDirection;\n\n    echo \"\n    <form action='$pageName'>\n    <select name='period' onChange='this.form.submit();' tabindex='\". $tabindex++ .\"'>\n        <option value='daily'\".($period == 'daily' ? ' selected' : '').\">{$GLOBALS['strDailyHistory']}</option>\n        <option value='w'\".($period == 'weekly' ? ' selected' : '').\">{$GLOBALS['strWeeklyHistory']}</option>\n        <option value='m'\".($period == 'monthly' ? ' selected' : '').\">{$GLOBALS['strMonthlyHistory']}</option>\n    </select>\n    &nbsp;&nbsp;\n    <input type='image' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif' border='0' name='submit'>\n    &nbsp;\";\n    _displayHiddenValues($hiddenValues);\n    echo \"\n    </form>\n    \";\n}\n\nfunction MAX_displayHistoryStatsDaily($aHistoryStats, $aTotalHistoryStats, $pageName, $hiddenValues = null)\n{\n    $i = 0;\n    $entity = _getEntityString($hiddenValues);\n    foreach ($aHistoryStats as $day => $stats) {\n        $bgColor = ($i++ % 2 == 0) ? '#F6F6F6' : '#FFFFFF';\n        $views = phpAds_formatNumber($stats['sum_views']);\n        $clicks = phpAds_formatNumber($stats['sum_clicks']);\n        $conversions = phpAds_formatNumber($stats['sum_conversions']);\n        $ctr = phpAds_buildRatioPercentage($stats['sum_clicks'], $stats['sum_views']);\n        $cnvr = phpAds_buildRatioPercentage($stats['sum_conversions'], $stats['sum_clicks']);\n        echo \"\n        <tr height='25' bgcolor='$bgColor'>\n            <td>&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-date.gif' align='absmiddle' alt=''>&nbsp;<a href='$pageName?{$entity}'>$day</a></td>\n            <td align='right'>$views</td>\n            <td align='right'>$clicks</td>\n            <td align='right'>$ctr</td>\n            <td align='right'>$conversions</td>\n            <td align='right'>$cnvr</td>\n        </tr>\n        <tr><td height='1' colspan='6' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%' alt=''></td></tr>\n        \";\n    }\n    echo \"\n    </table>\";\n}\n\nfunction MAX_displayPublisherZoneStats($aParams, $pageName, $anonymous, $aNodes, $expand, $listorder, $orderdirection, $hideinactive, $showPublisher, $entityIds)\n{\n    global $phpAds_TextAlignLeft, $phpAds_TextAlignRight, $phpAds_TextDirection;\n\n    // Get the icons for all levels (publisher/zone)\n    $entity = _getEntityString($entityIds);\n    $publishersHidden = 0;\n\n    $aPublishers = Admin_DA::fromCache('getPublishersStats', $aParams);\n    if (!empty($aPublishers)) {\n        echo \"\n        <br /><br />\n        <table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n        MAX_displayStatsHeader($pageName, $listorder, $orderdirection, $entityIds);\n\n        // Variable to determine if the row should be grey or white...\n        $i=0;\n\n        // Loop through publishers\n        $totalRequests = 0;\n        $totalViews = 0;\n        $totalClicks = 0;\n        $totalConversions = 0;\n        MAX_sortArray($aPublishers, ($listorder == 'id' ? 'publisher_id' : $listorder), $orderdirection == 'up');\n        foreach($aPublishers as $publisherId => $publisher) {\n            $publisherRequests = phpAds_formatNumber($publisher['sum_requests']);\n            $publisherViews = phpAds_formatNumber($publisher['sum_views']);\n            $publisherClicks = phpAds_formatNumber($publisher['sum_clicks']);\n            $publisherConversions = phpAds_formatNumber($publisher['sum_conversions']);\n            $publisherCtr = phpAds_buildRatioPercentage($publisher['sum_clicks'], $publisher['sum_views']);\n            $publisherSr = phpAds_buildRatioPercentage($publisher['sum_conversions'], $publisher['sum_clicks']);\n            $publisherExpanded = MAX_isExpanded($publisherId, $expand, $aNodes, 'p');\n            $publisherActive = true;\n            $publisherIcon = MAX_getEntityIcon('publisher', $publisherActive);\n\n            if (!$hideinactive || $publisherActive) {\n                $bgcolor = ($i++ % 2 == 0) ? \" bgcolor='#F6F6F6'\" : '';\n                echo \"\n            <tr height='25'$bgcolor>\n                <td>\";\n                if (!empty($publisher['num_children'])) {\n                    if ($publisherExpanded)\n                        echo \"&nbsp;<a href='$pageName?{$entity}collapse=p$publisherId'><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'></a>&nbsp;\";\n                    else\n                        echo \"&nbsp;<a href='$pageName?{$entity}expand=p$publisherId'><img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'></a>&nbsp;\";\n                }\n                else\n                    echo \"&nbsp;<img src='\" . OX::assetPath() . \"/images/spacer.gif' height='16' width='16'>&nbsp;\";\n\n                echo \"\n                    <img src='$publisherIcon' align='absmiddle'>&nbsp;\n                    <a href='stats.php?entity=affiliate&breakdown=history&affiliateid=$publisherId'>{$publisher['name']}</a>\n                </td>\";\n                if ($anonymous) {\n                    echo \"\n                <td align='$phpAds_TextAlignRight'>&nbsp;</td>\";\n                } else {\n                    echo \"\n                <td align='$phpAds_TextAlignRight'>$publisherId</td>\";\n                    }\n                    echo \"\n                <td align='$phpAds_TextAlignRight'>$publisherRequests</td>\n                <td align='$phpAds_TextAlignRight'>$publisherViews</td>\n                <td align='$phpAds_TextAlignRight'>$publisherClicks</td>\n                <td align='$phpAds_TextAlignRight'>$publisherCtr</td>\n                <td align='$phpAds_TextAlignRight'>$publisherConversions</td>\n                <td align='$phpAds_TextAlignRight'>$publisherSr</td>\n            </tr>\";\n\n                if (!empty($publisher['num_children']) && $publisherExpanded) {\n                    echo \"\n            <tr height='1'>\n                <td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n                <td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n            </tr>\";\n\n\n                    // Loop through zones\n                    $aZones = Admin_DA::fromCache('getZonesStats', $aParams);\n                    MAX_sortArray($aZones, ($listorder == 'id' ? 'zone_id' : $listorder), $orderdirection == 'up');\n                    foreach ($aZones as $zoneId => $zone) {\n                        $zoneRequests = phpAds_formatNumber($zone['sum_requests']);\n                        $zoneViews = phpAds_formatNumber($zone['sum_views']);\n                        $zoneClicks = phpAds_formatNumber($zone['sum_clicks']);\n                        $zoneConversions = phpAds_formatNumber($zone['sum_conversions']);\n                        $zoneCtr = phpAds_buildRatioPercentage($zone['sum_clicks'], $zone['sum_views']);\n                        $zoneSr = phpAds_buildRatioPercentage($zone['sum_conversions'], $zone['sum_clicks']);\n                        $zoneActive = true;\n                        $zoneIcon = MAX_getEntityIcon('zone', $zoneActive, $zone['type']);\n\n                        echo \"\n            <tr height='25'$bgcolor>\n                <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n                    <img src='\" . OX::assetPath() . \"/images/spacer.gif' height='16' width='16' align='absmiddle'>&nbsp;\n                    <img src='$zoneIcon' align='absmiddle'>&nbsp;\n                    <a href='stats.php?entity=zone&breakdown=history&affiliateid=$publisherId&zoneid=$zoneId'>{$zone['name']}</a>\n                </td>\n                <td align='$phpAds_TextAlignRight'>$zoneId</td>\n                <td align='$phpAds_TextAlignRight'>$zoneRequests</td>\n                <td align='$phpAds_TextAlignRight'>$zoneViews</td>\n                <td align='$phpAds_TextAlignRight'>$zoneClicks</td>\n                <td align='$phpAds_TextAlignRight'>$zoneCtr</td>\n                <td align='$phpAds_TextAlignRight'>$zoneConversions</td>\n                <td align='$phpAds_TextAlignRight'>$zoneSr</td>\n            </tr>\";\n                    }\n                }\n                echo \"\n                <tr height='1'><td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n            } else {\n                $publishersHidden++;\n            }\n            $totalRequests += $publisher['sum_requests'];\n            $totalViews += $publisher['sum_views'];\n            $totalClicks += $publisher['sum_clicks'];\n            $totalConversions += $publisher['sum_conversions'];\n        }\n\n        // Total\n        echo \"\n        <tr height='25'$bgcolor>\n            <td>&nbsp;&nbsp;<b>{$GLOBALS['strTotal']}</b></td>\n            <td>&nbsp;</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalRequests).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalViews).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalViews, $totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalConversions).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalClicks, $totalConversions).\"</td>\n        </tr>\n        <tr height='1'>\n            <td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n        </tr>\";\n        if (!$anonymous) {\n            $publisherIcon = MAX_getEntityIcon('publisher');\n            echo \"\n        <tr>\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap>\";\n\n            if ($hideinactive == true) {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-activate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=0'>{$GLOBALS['strShowAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;$publishersHidden {$GLOBALS['strInactivePublishersHidden']}\";\n            } else {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-hideinactivate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=1'>{$GLOBALS['strHideInactivePublishers']}</a>\";\n            }\n\n            echo \"\n            </td>\n            <td colspan='4' align='$phpAds_TextAlignRight' nowrap><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=all' accesskey='$keyExpandAll'>{$GLOBALS['strExpandAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=none' accesskey='$keyCollapseAll'>{$GLOBALS['strCollapseAll']}</a>&nbsp;&nbsp;</td>\n        </tr>\n        <tr height='25'>\";\n            if ($showPublisher == 't') {\n                echo \"\n            <td colspan='8' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='$publisherIcon' align='absmiddle'><a href='$pageName?{$entity}showpublisher=f'> Hide parent publisher</a></td>\";\n            } else {\n                echo \"\n            <td colspan='8' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='$publisherIcon' align='absmiddle'><a href='$pageName?{$entity}showpublisher=t'> Show parent publisher</a></td>\";\n            }\n            echo \"\n        </tr>\";\n        }\n        echo \"\n        </table>\n        <br /><br />\";\n    } else {\n        MAX_displayNoStatsMessage();\n    }\n}\n\nfunction MAX_displayZoneStats($aParams, $pageName, $anonymous, $aNodes, $expand, $listorder, $orderdirection, $hideinactive, $showPublisher, $entityIds)\n{\n    global $phpAds_TextAlignLeft, $phpAds_TextAlignRight, $phpAds_TextDirection;\n\n    // Get the icons for all levels (publisher/zone)\n    $entity = _getEntityString($entityIds);\n    $publishersHidden = 0;\n\n    $aZones = Admin_DA::fromCache('getZonesStats', $aParams);\n    if (!empty($aZones)) {\n        echo \"\n        <br /><br />\n        <table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n        MAX_displayStatsHeader($pageName, $listorder, $orderdirection, $entityIds, $anonymous);\n\n        // Variable to determine if the row should be grey or white...\n        $i=0;\n        $totalRequests = 0;\n        $totalViews = 0;\n        $totalClicks = 0;\n        $totalConversions = 0;\n\n        // Loop through publishers\n        MAX_sortArray($aZones, ($listorder == 'id' ? 'zone_id' : $listorder), $orderdirection == 'up');\n        foreach($aZones as $zoneId => $zone) {\n            $zoneRequests = phpAds_formatNumber($zone['sum_requests']);\n            $zoneViews = phpAds_formatNumber($zone['sum_views']);\n            $zoneClicks = phpAds_formatNumber($zone['sum_clicks']);\n            $zoneConversions = phpAds_formatNumber($zone['sum_conversions']);\n            $zoneCtr = phpAds_buildRatioPercentage($zone['sum_clicks'], $zone['sum_views']);\n            $zoneSr = phpAds_buildRatioPercentage($zone['sum_conversions'], $zone['sum_clicks']);\n            $zoneActive = true;\n            $zoneIcon = MAX_getEntityIcon('zone', $zoneActive, $zone['type']);\n\n            if (!$hideinactive || $zoneActive) {\n                $bgcolor = ($i++ % 2 == 0) ? \" bgcolor='#F6F6F6'\" : '';\n                echo \"\n        <tr height='25'$bgcolor>\n            <td>&nbsp;<img src='\" . OX::assetPath() . \"/images/spacer.gif' height='16' width='16'>&nbsp;\n                <img src='$zoneIcon' align='absmiddle'>&nbsp;\";\n                if ($anonymous) {\n                    echo \"\n                Hidden zone {$zone['id']}\";\n                } else {\n                    echo \"\n                <a href='stats.php?entity=zone&breakdown=history&affiliateid={$zone['publisher_id']}'>{$zone['name']}</a>\";\n                }\n                echo \"\n            </td>\";\n                if ($anonymous) {\n                    echo \"\n            <td align='$phpAds_TextAlignRight'>&nbsp;</td>\";\n                } else {\n                    echo \"\n            <td align='$phpAds_TextAlignRight'>$zoneId</td>\";\n                }\n                echo \"\n            <td align='$phpAds_TextAlignRight'>$zoneRequests</td>\n            <td align='$phpAds_TextAlignRight'>$zoneViews</td>\n            <td align='$phpAds_TextAlignRight'>$zoneClicks</td>\n            <td align='$phpAds_TextAlignRight'>$zoneCtr</td>\n            <td align='$phpAds_TextAlignRight'>$zoneConversions</td>\n            <td align='$phpAds_TextAlignRight'>$zoneSr</td>\n        </tr>\n        <tr height='1'><td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n            } else {\n                $publishersHidden++;\n            }\n            $totalRequests += $zone['sum_requests'];\n            $totalViews += $zone['sum_views'];\n            $totalClicks += $zone['sum_clicks'];\n            $totalConversions += $zone['sum_conversions'];\n        }\n\n        // Total\n        echo \"\n        <tr height='25'$bgcolor>\n            <td>&nbsp;&nbsp;<b>{$GLOBALS['strTotal']}</b></td>\n            <td>&nbsp;</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalRequests).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalViews).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalViews, $totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalConversions).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalClicks, $totalConversions).\"</td>\n        </tr>\n        <tr height='1'>\n            <td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n        </tr>\";\n        if (!$anonymous) {\n            echo \"\n        <tr>\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap>\";\n\n            if ($hideinactive == true) {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-activate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=0'>{$GLOBALS['strShowAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;$publishersHidden {$GLOBALS['strInactivePublishersHidden']}\";\n            } else {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-hideinactivate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=1'>{$GLOBALS['strHideInactivePublishers']}</a>\";\n            }\n\n            echo \"\n            </td>\n            <td colspan='4' align='$phpAds_TextAlignRight' nowrap><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=all'>{$GLOBALS['strExpandAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=none'>{$GLOBALS['strCollapseAll']}</a>&nbsp;&nbsp;</td>\n        </tr>\n        <tr height='25'>\";\n            if ($showPublisher == 't') {\n                echo \"\n            <td colspan='7' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-affiliate.gif' align='absmiddle'><a href='$pageName?{$entity}showpublisher=f'> Hide parent publisher</a></td>\";\n            } else {\n                echo \"\n            <td colspan='7' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-affiliate.gif' align='absmiddle'><a href='$pageName?{$entity}showpublisher=t'> Show parent publisher</a></td>\";\n            }\n            echo \"\n        </tr>\";\n        }\n        echo \"\n        </table>\n        <br /><br />\";\n    } else {\n        MAX_displayNoStatsMessage();\n    }\n}\n\nfunction MAX_displayInventoryBreadcrumbs($aEntityNamesUrls, $entityClass, $newEntity = false)\n{\n    MAX_displayInventoryBreadcrumbsInternal($aEntityNamesUrls, MAX_buildBreadcrumbPath($entityClass), $newEntity);\n}\n\nfunction MAX_displayInventoryBreadcrumbsInternal($aEntityNamesUrls, $breadcrumbPath, $newEntity = false)\n{\n    global $phpAds_breadcrumbs;\n\n    $path = array();\n\n    // Breadcrumbs above the main title\n    for ($i = 0; $i < count($aEntityNamesUrls); $i++) {\n    \t$breadcrumbInfo = MAX_buildBreadcrumbInfo($breadcrumbPath[$i]);\n\n        $path[] = array(\n            'name' => $aEntityNamesUrls[$i][\"name\"],\n            'url' => $aEntityNamesUrls[$i][\"url\"],\n            'label' => ($newEntity && $i == count($aEntityNamesUrls) -1 ? $breadcrumbInfo['newLabel'] : $breadcrumbInfo['label']),\n            'newTarget' => $breadcrumbInfo['newTarget'],\n            'cssClass' => $breadcrumbInfo['class']\n        );\n    }\n\n    $phpAds_breadcrumbs = array(\n        'path' => $path,\n        'newEntity' => $newEntity\n    );\n}\n\nfunction MAX_buildBreadcrumbInfo($entityClass)\n{\n\tswitch ($entityClass)\n\t{\n\t\tcase 'advertiser':\n\t       return array(\"label\" => $GLOBALS['strClient'], \"newLabel\" => $GLOBALS['strAddClient'], \"class\" => \"adv\");\n\n\t\tcase 'campaign':\n\t       return array(\"label\" => $GLOBALS['strCampaign'], \"newLabel\" => $GLOBALS['strAddCampaign'], \"newTarget\" => $GLOBALS['strCampaignForAdvertiser'], \"class\" => \"camp\");\n\n\t\tcase 'tracker':\n\t       return array(\"label\" => $GLOBALS['strTracker'], \"newLabel\" => $GLOBALS['strAddTracker'], \"newTarget\" => $GLOBALS['strTrackerForAdvertiser'], \"class\" => \"track\");\n\n\t\tcase 'banner':\n\t       return array(\"label\" => $GLOBALS['strBanner'], \"newLabel\" => $GLOBALS['strAddBanner'], \"newTarget\" => $GLOBALS['strBannerToCampaign'], \"class\" => \"ban\");\n\n\t\tcase 'website':\n\t       return array(\"label\" => $GLOBALS['strAffiliate'], \"newLabel\" => $GLOBALS['strAddNewAffiliate'], \"class\" => \"webs\");\n\n\t\tcase 'zone':\n            return array(\"label\" => $GLOBALS['strZone'], \"newLabel\" => $GLOBALS['strAddNewZone'], \"newTarget\" => $GLOBALS['strZoneToWebsite'], \"class\" => \"zone\");\n\n\t\tcase 'channel':\n\t       return array(\"label\" => $GLOBALS['strChannel'], \"newLabel\" => $GLOBALS['strAddNewChannel'], \"newTarget\" => $GLOBALS['strChannelToWebsite'], \"class\" => \"chan\");\n\n\t\tcase 'agency':\n\t       return array(\"label\" => $GLOBALS['strAgency'], \"newLabel\" => $GLOBALS['strAddAgency'], \"class\" => \"agen\");\n\n\t\tcase 'day':\n\t       return array(\"label\" => $GLOBALS['strDay'], \"newLabel\" => '', \"class\" => \"day\");\n\t}\n\n\treturn null;\n}\n\nfunction MAX_buildBreadcrumbPath($entityClass)\n{\n\tswitch ($entityClass)\n\t{\n\t\tcase 'banner':\n\t\tcase 'campaign':\n\t\tcase 'advertiser':\n\t\t\treturn array('advertiser', 'campaign', 'banner');\n\n\t\tcase 'tracker':\n\t\t\treturn array('advertiser', 'tracker');\n\n\t\tcase 'website':\n\t\tcase 'zone':\n\t\t\treturn array('website', 'zone');\n\n\t\tcase 'trafficker-zone':\n\t\t\treturn array('zone');\n\n\t\tcase 'channel':\n\t\t\treturn array('website', 'channel');\n\n\t\tcase 'global-channel':\n\t\t\treturn array('channel');\n\n\t\tcase 'agency':\n\t\t\treturn array('agency');\n\t}\n\n\treturn null;\n}\n\n/**\n * Builds header model for advertiser edit page tabs\n *\n * @param mixed $idOrAdvertiser - either advertiser id or advertiser array\n * @return OA_Admin_UI_Model_PageHeaderModel\n */\nfunction buildAdvertiserHeaderModel($idOrAdvertiser)\n{\n    if (is_array($idOrAdvertiser)) {\n        $aAdvertiser = $idOrAdvertiser;\n    }\n    else if (!empty($idOrAdvertiser)) {\n        $aAdvertiser = phpAds_getClientDetails($idOrAdvertiser);\n    }\n    else {\n        $aAdvertiser = array();\n    }\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $pageType = empty($aAdvertiser['clientid']) ? 'edit-new' : 'edit';\n\n    $oHeaderModel = $builder->buildEntityHeader(array(\n        array(\"name\" => $aAdvertiser['clientname'])),\n        \"advertiser\", $pageType);\n    return $oHeaderModel;\n}\n\nfunction MAX_displayTrackerBreadcrumbs($clientid, $trackerid = null)\n{\n\tif ($trackerid) {\n        $parentClientId = phpAds_getTrackerParentClientID($trackerid);\n        $tracker = phpAds_getTrackerDetails($trackerid);\n        $trackerName = $tracker['trackername'];\n        $pageType = 'edit';\n\t}\n\telse {\n\t\t$parentClientId = $clientid;\n\t\t$trackerName = \"\";\n\t\t$pageType = 'edit-new';\n\t}\n    $advertiserEditUrl = \"advertiser-edit.php?clientid=$parentClientId\";\n    $advertiser = phpAds_getClientDetails($parentClientId);\n    $advertiserName = $advertiser['clientname'];\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                        array(\"name\" => $advertiserName, \"url\" => $advertiserEditUrl),\n                                        array(\"name\" => $trackerName)),\n                                        'tracker', $pageType);\n\n    return $oHeaderModel;\n}\n\nfunction MAX_displayWebsiteBreadcrumbs($affiliateid)\n{\n\tif ($affiliateid) {\n\t\t$publisher = Admin_DA::getPublisher($affiliateid);\n        $websiteName = $publisher['name'];\n        $pageType = \"edit\";\n\t}\n\telse {\n\t\t$websiteName = \"\";\n\t\t$pageType = \"edit-new\";\n\t}\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n\t    array(\"name\" => $websiteName)), \"website\", $pageType);\n\n\treturn $oHeaderModel;\n}\n\n\n\n\nfunction MAX_displayNavigationPublisher($pageName, $aOtherPublishers, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $publisherId = $aEntities['affiliateid'];\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['affiliateid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n\n    // Determine which tab is highlighted\n    switch ($pageName) {\n        case 'affiliate-channels.php' : $tabValue = '4.2.4'; break;\n    }\n\n    // Sort the publishers by name...\n    require_once(MAX_PATH . '/lib/max/other/stats.php');\n    MAX_displayInventoryBreadcrumbs(array(array(\"name\" => $publisherName)), \"website\");\n    phpAds_PageHeader($tabValue, $extra = '');\n}\n\n\nfunction MAX_displayZoneEntitySelection($entity, $aOtherAdvertisers, $aOtherPlacements, $aOtherAds, $advertiserId, $placementId, $adId, $publisherId, $zoneId, $title, $pageName, &$tabIndex)\n{\n    echo \"\n<br />$title<br /><br />\n<table cellpadding='0' cellspacing='0' border='0'>\n<tr>\";\n    $aSavedEntities = array('affiliateid' => $publisherId, 'zoneid' => $zoneId);\n    _displayZoneEntitySelectionCell('advertiser', $advertiserId, $aOtherAdvertisers, 'clientid', $aSavedEntities, ($entity != 'advertiser'), $pageName, $tabIndex);\n\n    if (!empty($advertiserId) && $entity != 'advertiser') {\n        $aSavedEntities['clientid'] = $advertiserId;\n        _displayZoneEntitySelectionCell('placement', $placementId, $aOtherPlacements, 'campaignid', $aSavedEntities, ($entity != 'placement'), $pageName, $tabIndex);\n\n        if (!empty($placementId) && $entity != 'placement') {\n            $aSavedEntities['campaignid'] = $placementId;\n            _displayZoneEntitySelectionCell('ad', $adId, $aOtherAds, 'bannerid', $aSavedEntities, ($entity != 'ad'), $pageName, $tabIndex);\n        }\n    }\n    echo \"\n</tr>\n</table>\n<br /><br />\";\n}\n\nfunction _displayZoneEntitySelectionCell($entity, $entityId, $aOtherEntities, $entityIdName, $aSavedEntities, $autoSubmit, $pageName, &$tabIndex)\n{\n    global $phpAds_TextDirection;\n\n    $onChange = $autoSubmit ? \" onChange='this.form.submit();'\" : '';\n    $submitIcon = $autoSubmit ? '' : \"&nbsp;<input type='hidden' name='action' value='set'><input id='link_submit' name='submitimage' id='submitimage' type='image' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif' border='0' tabindex='\".($tabIndex++).\"'>\";\n    $tabInfo = \" tabindex='\" . ($tabIndex++) . \"'\";\n    $entityIcon = MAX_getEntityIcon($entity);\n    echo \"\n<td>\n<form name='zonetypeselection' method='get' action='$pageName'>\";\n    foreach($aSavedEntities as $savedEntityName => $savedEntityId) {\n        echo \"\n<input type='hidden' name='$savedEntityName' value='$savedEntityId'>\";\n    }\n    echo \"\n    &nbsp;&nbsp;<img src='$entityIcon' align='absmiddle'>&nbsp;\n    <select name='$entityIdName'{$onChange}{$tabInfo}>\";\n    // Show an empty value in the dropdown if none is selected\n    if (empty($entityId)) {\n        switch ($entity) {\n            case 'advertiser' : $description = \"-- {$GLOBALS['strSelectAdvertiser']} --\"; break;\n            case 'placement'  : $description = \"-- {$GLOBALS['strSelectPlacement']} --\"; break;\n            case 'ad' : $description = \"-- {$GLOBALS['strSelectAd']} --\"; break;\n            default : $description = '';\n        }\n        echo \"\n        <option value='' selected>$description</option>\";\n    }\n\n    $aOtherEntities = _multiSort($aOtherEntities, 'name', 'advertiser_id');\n    foreach ($aOtherEntities as $aOtherEntity) {\n        switch ($entity) {\n            case 'advertiser':\n                $otherEntityId = $aOtherEntity['advertiser_id'];\n                break;\n            case 'placement':\n                $otherEntityId = $aOtherEntity['placement_id'];\n                break;\n            case 'ad':\n                $otherEntityId = $aOtherEntity['ad_id'];\n                break;\n        }\n        $selected = $otherEntityId == $entityId ? ' selected' : '';\n\n        $adsCount = '';\n        if ($entity == 'placement') {\n            $aParams = array('placement_id' => $otherEntityId);\n            $aParams += MAX_getLinkedAdParams($GLOBALS['zoneId']);\n\n            $doCampaign = OA_Dal::factoryDO('campaigns');\n            $doCampaign->campaignid = $otherEntityId;\n            $doCampaign->find();\n            $doCampaign->fetch();\n\n            if($doCampaign->type == DataObjects_Campaigns::CAMPAIGN_TYPE_DEFAULT) {\n                $translation = new OX_Translation();\n                $aStringParams[\"bannerCount\"] = count(Admin_DA::getAds($aParams));\n                $translated = $translation->translate($GLOBALS['strWithXBanners'], $aStringParams);\n                $adsCount = \"(\" .$translated.\")\";\n            }\n        }\n\n        $name = MAX_buildName($otherEntityId, $aOtherEntity['name']);\n        echo \"\n        <option value='$otherEntityId'{$selected}>\".$name.\" $adsCount</option>\";\n    }\n    echo \"\n    </select>\n    $submitIcon\n</form>\n</td>\";\n}\n\nfunction MAX_displayLinkedAdsPlacements($aParams, $publisherId, $zoneId, $hideInactive, $showParentPlacements, $pageName, &$tabIndex)\n{\n    global $phpAds_TextDirection, $phpAds_TextAlignRight;\n\n    echo \"\n<table id='linked-banners' width='100%' border='0' align='center' cellspacing='0' cellpadding='0'>\n<tr height='25'>\n<td width='40%'><b>&nbsp;&nbsp;{$GLOBALS['strName']}</b></td>\n<td><b>{$GLOBALS['strID']}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></td>\n<td>&nbsp;</td>\n</tr>\n<tr height='1'>\n<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n</tr>\";\n    $i = 0;\n    $inactive = 0;\n    $aPlacements = !empty($aParams) ? Admin_DA::getPlacements($aParams) : array();\n    foreach ($aPlacements as $placementId => $aPlacement) {\n        $aAds = Admin_DA::getAds($aParams + array('placement_id' => $placementId), true);\n        $placementActive = $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING;\n        if (!$hideInactive || $placementActive) {\n            $bgcolor = $i % 2 == 0 ? \" bgcolor='#F6F6F6'\" : '';\n            if ($showParentPlacements) {\n                $placementIcon = MAX_getEntityIcon('placement', $placementActive);\n                $placementName = MAX_getDisplayName($aPlacement['name']);\n                $placementLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='campaign-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId'>$placementName</a>\" : $placementName;\n                if ($i > 0) {\n                    echo \"\n<tr height='1'>\n<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n</tr>\";\n            }\n            echo \"\n<tr height='25'$bgcolor>\n<td>\n    &nbsp;&nbsp;<img src='$placementIcon' align='absmiddle'>\n    &nbsp;$placementLink\n</td>\n<td>$placementId</td>\n<td>&nbsp;</td>\n</tr>\";\n            }\n            foreach ($aAds as $adId => $aAd) {\n                $adActive = ($aAd['status'] == OA_ENTITY_STATUS_RUNNING && $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING);\n                if (!$hideInactive || $adActive) {\n                    $adIcon = MAX_getEntityIcon('ad', $adActive, $aAd['type']);\n                    $adName = htmlspecialchars(MAX_getDisplayName($aAd['name']));\n                    $adLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='banner-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId&bannerid=$adId'>$adName</a>\" : $adName;\n                    $adWidth = $aAd['contenttype'] == 'txt' ? 300 : $aAd['width'] + 64;\n                    $adHeight = $aAd['contenttype'] == 'txt' ? 200 : $aAd['height'] + (!empty($aAd['bannertext']) ? 90 : 64);\n                    echo \"\n<tr height='1'>\n<td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n<td colspan='2' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-el.gif' height='1' width='100%'></td>\n</tr>\n<tr height='25'$bgcolor>\n<td>\n    &nbsp;&nbsp;<a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&bannerid=$adId&action=remove'><img src='\" . OX::assetPath() . \"/images/caret-l.gif' border='0' align='absmiddle'></a>\n    &nbsp;&nbsp;&nbsp;&nbsp;<img src='$adIcon' align='absmiddle'>&nbsp;$adLink</td>\n<td>$adId</td>\n<td align='$phpAds_TextAlignRight'>\n    <img src='\" . OX::assetPath() . \"/images/icon-zoom.gif' align='absmiddle' border='0'>&nbsp;<a href='banner-htmlpreview.php?bannerid=$adId' target='_new' onClick=\\\"return openWindow('banner-htmlpreview.php?bannerid=$adId', '', 'status=no,scrollbars=no,resizable=no,width=$adWidth,height=$adHeight');\\\">{$GLOBALS['strShowBanner']}</a>&nbsp;&nbsp;\n</td>\n</tr>\";\n                } else {\n                    $inactive++;\n                }\n            }\n            $i++;\n        } else {\n            $inactive += count($aAds);\n        }\n    }\n    $showParentText = $showParentPlacements ? $GLOBALS['strHideParentCampaigns'] : $GLOBALS['strShowParentCampaigns'];\n    $showParentValue = $showParentPlacements ? '0': '1';\n    $hideInactiveText = $hideInactive ? $GLOBALS['strShowAll'] : $GLOBALS['strHideInactiveBanners'];\n    $hideInactiveStats = $hideInactive ? \"&nbsp;&nbsp;|&nbsp;&nbsp;$inactive {$GLOBALS['strInactiveBannersHidden']}\" : '';\n    $hideInactiveValue = $hideInactive ? '0' : '1';\n    $hideInactiveIcon = OX::assetPath($hideInactive ? 'images/icon-activate.gif' : 'images/icon-hideinactivate.gif');\n    echo \"\n<tr height='1'>\n<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n</tr>\n<tr height='25'>\n<td colspan='2'>\n    <img src='$hideInactiveIcon' align='absmiddle' border='0'>\n    <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&hideinactive=$hideInactiveValue'>$hideInactiveText</a>$hideInactiveStats\n</td>\n<td align='right'>\n    <img src='\" . OX::assetPath() . \"/images/icon-campaign-d.gif' align='absmiddle' border='0'>\n    <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&showcampaigns=$showParentValue'>$showParentText</a>\n</table>\";\n}\n\nfunction MAX_displayLinkedPlacementsAds($aParams, $publisherId, $zoneId, $hideInactive, $showMatchingAds, $pageName, &$tabIndex, $directLinkedAds=false)\n    {\n        echo \"\n    <br /><strong>{$GLOBALS['strCampaignLinkedAds']}:</strong><br />\n    <table id='linked-campaigns' width='100%' border='0' align='center' cellspacing='0' cellpadding='0'>\n    <tr height='25'>\n        <td width='40%'><b>&nbsp;&nbsp;{$GLOBALS['strName']}</b></td>\n        <td width='20%'><b>&nbsp;&nbsp;{$GLOBALS['strType']}</b></td>\n        <td><b>{$GLOBALS['strID']}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></td>\n        <td>&nbsp;</td>\n    </tr>\n    <tr height='1'>\n        <td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n    </tr>\";\n\n        $i = 0;\n        $inactive = 0;\n        $aPlacements = (!empty($aParams)) ? Admin_DA::getPlacements($aParams) : array();\n        foreach ($aPlacements as $placementId => $aPlacement) {\n            $placementActive = $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING;\n            if (!$hideInactive || $placementActive) {\n                $pParams = $aParams;\n                $pParams['placement_id'] = $placementId;\n                $aAds = Admin_DA::getAds($pParams, true);\n                $bgcolor = $i % 2 == 0 ? \" bgcolor='#F6F6F6'\" : '';\n                // Remove these ad(s) from the direct linked ads\n                foreach ($aAds as $dAdId) {\n                    unset($directLinkedAds[$dAdId['ad_id']]);\n                }\n\n                // Remove from array any ads not linked to the zone.\n                // These might exist if campaign has been linked to zone\n                // and indivual ads have then been unlinked\n                $pParams = array('zone_id' => $zoneId);\n                $aAdZones = Admin_DA::getAdZones($pParams, true);\n                $aAdZoneLinks = array();\n                foreach($aAdZones as $aAdZone) {\n                    $aAdZoneLinks[] = $aAdZone['ad_id'];\n                }\n                foreach($aAds as $adId => $aAd) {\n                    if (!in_array($adId, $aAdZoneLinks)) {\n                        unset($aAds[$adId]);\n                    }\n                }\n\n                $placementIcon = MAX_getEntityIcon('placement', $placementActive);\n                $placementName = htmlspecialchars(MAX_getDisplayName($aPlacement['name']));\n                $placementLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='campaign-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId'>$placementName</a>\" : $placementName;\n                $placementTypeName = OX_Util_Utils::getCampaignTypeName($aPlacement['priority']);\n                $adCount = empty($aAds) ? 0 : count($aAds);\n                $placementDescription = $showMatchingAds ? '&nbsp;' : str_replace('{count}', $adCount, $GLOBALS['strMatchingBanners']);\n                if ($i > 0) {\n                    echo \"\n    <tr height='1'>\n        <td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n    </tr>\";\n                }\n                echo \"\n    <tr height='25'$bgcolor>\n        <td>\n            &nbsp;&nbsp;<a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&campaignid=$placementId&action=remove'><img src='\" . OX::assetPath() . \"/images/caret-l.gif' border='0' align='absmiddle'></a>\n            &nbsp;&nbsp;<img src='$placementIcon' align='absmiddle'>\n            &nbsp;$placementLink\n        </td>\n        <td><span class='campaign-type'>$placementTypeName</span></td>\n        <td>$placementId</td>\n        <td>$placementDescription</td>\n    </tr>\";\n                if ($showMatchingAds && !empty($aAds)) {\n                    foreach ($aAds as $adId => $aAd) {\n                        $adActive = ($aAd['status'] == OA_ENTITY_STATUS_RUNNING && $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING);\n                        if (!$hideInactive || $adActive) {\n                            $adIcon = MAX_getEntityIcon('ad', $adActive, $aAd['type']);\n                            $adName = htmlspecialchars(MAX_getDisplayName($aAd['name']));\n                            $adLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='banner-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId&bannerid=$adId'>$adName</a>\" : $adName;\n                            $adWidth = $aAd['contenttype'] == 'txt' ? 300 : $aAd['width'] + 64;\n                            $adHeight = $aAd['contenttype'] == 'txt' ? 200 : $aAd['height'] + (!empty($aAd['bannertext']) ? 90 : 64);\n                            echo \"\n    <tr height='1'>\n        <td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n        <td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-el.gif' height='1' width='100%'></td>\n    </tr>\n    <tr height='25'$bgcolor>\n        <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src='$adIcon' align='absmiddle'>&nbsp;$adLink</td>\n        <td></td>\n        <td>$adId</td>\n        <td align=\".$GLOBALS['phpAds_TextAlignRight'].\">\n            <img src='\" . OX::assetPath() . \"/images/icon-zoom.gif' align='absmiddle' border='0'>&nbsp;<a href='banner-htmlpreview.php?bannerid=$adId' target='_new' onClick=\\\"return openWindow('banner-htmlpreview.php?bannerid=$adId', '', 'status=no,scrollbars=no,resizable=no,width=$adWidth,height=$adHeight');\\\">{$GLOBALS['strShowBanner']}</a>&nbsp;&nbsp;\n        </td>\n    </tr>\";\n                        } else {\n                            $inactive++;\n                        }\n                    }\n                }\n                $i++;\n            } else {\n                $inactive++;\n            }\n        }\n        $showMatchingText = $showMatchingAds ? $GLOBALS['strHideMatchingBanners'] : $GLOBALS['strShowMatchingBanners'];\n        $showMatchingValue = $showMatchingAds ? '0' : '1';\n        $hideInactiveText = $hideInactive ? $GLOBALS['strShowAll'] : $GLOBALS['strHideInactiveCampaigns'];\n        $hideInactiveStats = $hideInactive ? \"&nbsp;&nbsp;|&nbsp;&nbsp;$inactive {$GLOBALS['strInactiveCampaignsHidden']}\" : '';\n        $hideInactiveValue = $hideInactive ? '0' : '1';\n        $hideInactiveIcon = OX::assetPath($hideInactive ? 'images/icon-activate.gif' : 'images/icon-hideinactivate.gif');\n        echo \"\n    <tr height='1'>\n        <td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n    </tr>\n    <tr height='25'>\n        <td colspan='3'>\n            <img src='$hideInactiveIcon' align='absmiddle' border='0'>\n            <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&hideinactive=$hideInactiveValue'>$hideInactiveText</a>$hideInactiveStats\n        </td>\n        <td align='right'>\n            <img src='\" . OX::assetPath() . \"/images/icon-banner-stored-d.gif' align='absmiddle' border='0'>\n            <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&showbanners=$showMatchingValue'>$showMatchingText</a>\n    </table>\";\n        if (!empty($directLinkedAds)) {\n            echo \"<br /><strong>{$GLOBALS['strBannerLinkedAds']}:</strong><br />\";\n            $aParams = array('ad_id' => implode(',', array_keys($directLinkedAds)));\n            MAX_displayLinkedAdsPlacements($aParams, $publisherId, $zoneId, $hideInactive, $showParentPlacements, $pageName, $tabIndex);\n        }\n    }\n\nfunction MAX_displayPlacementAdSelectionViewForm($publisherId, $zoneId, $view, $pageName, &$tabIndex, $aOtherZones = array())\n{\n    global $phpAds_TextDirection;\n\n    $disabled = null;\n    $disabledHidden = null;\n    if (!empty($aOtherZones[$zoneId]['type'])) {\n        if ($aOtherZones[$zoneId]['type'] == MAX_ZoneEmail) {\n            $view = 'ad';\n            $disabled = ' disabled';\n            $disabledHidden = \"<input type='hidden' name='view' value='ad' />\";\n        }\n    }\n    $placementSelected = $view == 'placement' ? ' selected' : '';\n    $categorySelected = $view == 'category' ? ' selected' : '';\n    $adSelected = $view == 'ad' ? ' selected' : '';\n\n    echo \"\n<form name='zoneview' method='post' action='$pageName'>\n<input type='hidden' name='zoneid' value='$zoneId'>\n<input type='hidden' name='affiliateid' value='$publisherId'>\n<table border='0' width='100%' cellpadding='0' cellspacing='0'>\n<tr height='25'>\n<td colspan='3'><b>{$GLOBALS['strSelectZoneType']}</b></td>\n</tr>\n<tr height='25'>\n<td>\n    <select name='view' onchange='this.form.submit();' $disabled>\n        <option value='placement'$placementSelected>{$GLOBALS['strCampaignDefaults']}</option>\n        <!--option value='category'$categorySelected>{$GLOBALS['strLinkedCategories']}</option-->\n        <option value='ad'$adSelected>{$GLOBALS['strLinkedBanners']}</option>\n    </select>\n    &nbsp;<input type='image' id='link_type_submit' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif' border='0'>\n    $disabledHidden\n</td>\n</tr>\n</table>\n</form>\";\n    phpAds_ShowBreak();\n    echo \"\n<br />\";\n}\n\nfunction MAX_displayAcls($acls, $aParams)\n{\n    $tabindex =& $GLOBALS['tabindex'];\n    $page = basename($_SERVER['SCRIPT_NAME']);\n    $conf = $GLOBALS['_MAX']['CONF'];\n\n    echo \"<form action='{$page}' method='post'>\";\n    echo \"<input type='hidden' name='token' value='\".urlencode(phpAds_SessionGetToken()).\"' />\";\n\n    echo \"<label><img src='\" . OX::assetPath() . \"/images/icon-acl-add.gif' align='absmiddle'>&nbsp;\". $GLOBALS['strACLAdd'] .\": &nbsp;\";\n    echo \"<select name='type' accesskey='{$GLOBALS['keyAddNew']}' tabindex='\".($tabindex++).\"'>\";\n\n    $deliveryLimitations = OX_Component::getComponents('deliveryLimitations', null, false);\n    foreach ($deliveryLimitations as $pluginName => $plugin) {\n        if ($plugin->isAllowed($page)) {\n            echo \"<option value='{$pluginName}'>\" . $plugin->getName() . \"</option>\";\n        }\n    }\n\n    echo \"</select></label>\";\n    echo \"&nbsp;\";\n    echo \"<input type='submit' class='flat' name='action[new]' value='\" . $GLOBALS['strAdd'] . \"'\";\n\n    phpAds_ShowBreak();\n    echo \"<br />\";\n    $aErrors = OX_AclCheckInputsFields($acls, $page);\n    if (!empty($GLOBALS['action'])) {\n        // We are part way through making changes, show a message\n        //echo \"<br>\";\n        echo \"<div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/warning.gif' align='absmiddle'>\";\n        echo \"<span class='tab-s'>{$GLOBALS['strUnsavedChanges']}</span><br>\";\n        echo \"</div>\";\n    }\n    elseif (!MAX_AclValidate($page, $aParams)) {\n        echo \"<div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/warning.gif' align='absmiddle'>\";\n        echo \"<span class='tab-r'>{$GLOBALS['strDeliveryLimitationsDisagree']}</span><br>\";\n        echo \"</div>\";\n    }\n\n    if ($aErrors  !== true) {\n        echo \"<div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/warning.gif' align='absmiddle'>\";\n        echo \"<span class='tab-s'>{$GLOBALS['strDeliveryLimitationsInputErrors']}</span><br><ul>\";\n        foreach ($aErrors as $error) {\n            echo \"<li><span class='tab-s'>{$error}</span><br></li>\";\n        }\n        echo \"</ul></div>\";\n    }\n\n    foreach ($aParams as $name => $value) {\n        echo \"<input type='hidden' name='{$name}' value='{$value}' />\";\n    }\n    echo \"<table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n    echo \"<tr><td height='25' colspan='4' bgcolor='#FFFFFF'><b>{$GLOBALS['strDeliveryLimitations']}</b></td></tr>\";\n    echo \"<tr><td height='1' colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n\n    if (empty($acls)) {\n        echo \"<tr><td height='24' colspan='4' bgcolor='#F6F6F6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$GLOBALS['strNoLimitations']}</td></tr>\";\n        echo \"<tr><td height='1' colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n    } else {\n        echo \"<tr><td height='25' colspan='4' bgcolor='#F6F6F6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$GLOBALS['strOnlyDisplayWhen']}</td></tr>\";\n        echo \"<tr><td colspan='4'><img src='\" . OX::assetPath() . \"/images/break-el.gif' width='100%' height='1'></td></tr>\";\n\n        foreach ($acls as $aclId => $acl) {\n            if ($deliveryLimitationPlugin = OA_aclGetComponentFromRow($acl)) {\n                $deliveryLimitationPlugin->init($acl);\n                $deliveryLimitationPlugin->count = count($acls);\n                if ($deliveryLimitationPlugin->isAllowed($page)) {\n                    $deliveryLimitationPlugin->display();\n                }\n            }\n        }\n    }\n\n    echo \"<tr><td height='30' colspan='2'>\";\n\n    if (!empty($acls)) {\n        $url = $page . '?';\n        foreach ($aParams as $name => $value) {\n            $url .= \"{$name}={$value}&\";\n        }\n        $url .= \"action[clear]=true\";\n        echo \"<img src='\" . OX::assetPath() . \"/images/icon-recycle.gif' border='0' align='absmiddle'>&nbsp;\n                <a href='{$url}'>{$GLOBALS['strRemoveAllLimitations']}</a>&nbsp;&nbsp;&nbsp;&nbsp;\n        \";\n    }\n\n    echo \"</td><td height='30' colspan='2' align='{$GLOBALS['phpAds_TextAlignRight']}'>\";\n    echo \"</td></tr>\";\n\n    echo \"</table>\";\n}\n\nfunction MAX_displayChannels($channels, $aParams) {\n    $entityString = _getEntityString($aParams);\n    echo \"<table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n\n    echo \"<tr height='25'><td height='25'><b>&nbsp;&nbsp;{$GLOBALS['strName']}</a></b></td>\";\n\n    echo \"<td height='25'><b>{$GLOBALS['strID']}</a></td>\";\n    echo \"<td height='25'>&nbsp;</td>\";\n    echo \"</tr>\";\n\n    echo \"<tr height='1'><td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n\n    if (empty($channels)) {\n        echo \"<tr height='25' bgcolor='#F6F6F6'><td height='25' colspan='3'>\";\n        echo \"&nbsp;&nbsp;{$GLOBALS['strNoChannels']}</td></tr>\";\n\n        echo \"<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n    } else {\n        $i = 0;\n        foreach ($channels as $channelId => $channel) {\n            if ($i > 0) echo \"<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\";\n            echo \"<tr height='25' \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\">\";\n            echo \"<td height='25'>&nbsp;&nbsp;\";\n            echo \"<img src='\" . OX::assetPath() . \"/images/icon-channel.gif' align='absmiddle'>&nbsp;\";\n\n            // set channel ownership info for display\n            if ($GLOBALS['pageName'] != 'affiliate-channels.php') {\n                if (!empty($channel['publisher_id'])) {\n                    $ownerTypeStr = 'Publisher: ';\n                    $publisher = Admin_DA::getPublisher($channel['publisher_id']);\n                    $ownerNameStr = '[id'.$channel['publisher_id'].'] '.$publisher['name'];\n                } else if (!empty($channel['agency_id']) && empty($channel['publisher_id'])\n                       && !OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n                    $ownerTypeStr = 'Agency: ';\n                    $agency = Admin_DA::getAgency($channel['agency_id']);\n                    $ownerNameStr = '[id'.$channel['agency_id'].'] '.$agency['name'];\n                } else {\n                    $ownerTypeStr = '';\n                    $ownerNameStr = '';\n                }\n            }\n            $ownerStr = !empty($ownerTypeStr) ? '&nbsp&nbsp<i>'.$ownerTypeStr.'</i>'.htmlspecialchars($ownerNameStr) : '';\n\n            echo \"<a href='channel-edit.php?{$entityString}channelid={$channel['channel_id']}'>\".htmlspecialchars($channel['name'].$ownerStr).\"</a>\";\n            echo \"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\";\n            echo \"</td>\";\n            echo \"<td height='25'>{$channel['channel_id']}</td>\";\n            echo \"<td>&nbsp;</td></tr>\";\n\n            // Description\n            echo \"<tr height='25' \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\">\";\n            echo \"<td>&nbsp;</td>\";\n            echo \"<td height='25' colspan='3'>\".htmlspecialchars(stripslashes($channel['description'])).\"</td>\";\n            echo \"</tr>\";\n\n            echo \"<tr height='1'>\";\n            echo \"<td \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\"><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\";\n            echo \"<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\";\n            echo \"</tr>\";\n            echo \"<tr height='25' \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\">\";\n\n            // Empty\n            echo \"<td>&nbsp;</td>\";\n\n            // Buttons\n            echo \"<td height='25' colspan='3'>\";\n\n            echo \"<img src='\" . OX::assetPath() . \"/images/icon-acl.gif' border='0' align='absmiddle' alt='{$GLOBALS['strIncludedBanners']}'>&nbsp;<a href='channel-acl.php?{$entityString}channelid={$channel['channel_id']}'>{$GLOBALS['strEditChannelLimitations']}</a>&nbsp;&nbsp;&nbsp;&nbsp;\";\n            echo \"<img src='\" . OX::assetPath() . \"/images/icon-recycle.gif' border='0' align='absmiddle' alt='{$GLOBALS['strDelete']}'>&nbsp;<a href='channel-delete.php?token=\" . urlencode(phpAds_SessionGetToken()) . \"&{$entityString}channelid={$channel['channel_id']}&returnurl=\".(empty($aParams['affiliateid']) ? 'channel-index.php' : 'affiliate-channels.php').\"'\".phpAds_DelConfirm($GLOBALS['strConfirmDeleteChannel']).\">{$GLOBALS['strDelete']}</a>&nbsp;&nbsp;&nbsp;&nbsp;\";\n\n            echo \"</td></tr>\";\n            $i++;\n        }\n        if (!empty($channels)) {\n            echo \"<tr height='1'><td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n        }\n    }\n    echo \"</table>\";\n}\n\n/**\n * Show a confirm message for zone delete\n *\n * @param int $zoneId Zone ID\n * @return string\n */\nfunction MAX_zoneDelConfirm($zoneId)\n{\n    $dalZones = OA_Dal::factoryDAL('zones');\n    return phpAds_DelConfirm(\n                ($dalZones->checkZoneLinkedToActiveCampaign($zoneId)) ?\n                    $GLOBALS['strConfirmDeleteZoneLinkActive'] . '\\n' . $GLOBALS['strConfirmDeleteZone']\n                    : $GLOBALS['strConfirmDeleteZone']\n           );\n}\n\nfunction OX_Display_ConversionWindowHTML($varName, $windowSeconds, &$tabindex, $enabled = true)\n{\n    $window = _secondsToWindowArray($windowSeconds);\n    echo \"\n        \" . (($enabled) ? \"<input id='{$varName}daytrk' class='flat' type='text' size='3' name='{$varName}day' value='{$window['days']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['days']) . \" {$GLOBALS['strDays']} &nbsp;&nbsp;\n        \" . (($enabled) ? \"<input id='{$varName}hourtrk' class='flat' type='text' size='3' name='{$varName}hour' value='{$window['hours']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['hours']) . \" {$GLOBALS['strHours']} &nbsp;&nbsp;\n        \" . (($enabled) ? \"<input id='{$varName}minutetrk' class='flat' type='text' size='3' name='{$varName}minute' value='{$window['minutes']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['minutes']) . \" {$GLOBALS['strMinutes']} &nbsp;&nbsp;\n        \" . (($enabled) ? \"<input id='{$varName}secondtrk' class='flat' type='text' size='3' name='{$varName}second' value='{$window['seconds']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['seconds']) . \" {$GLOBALS['strSeconds']} &nbsp;&nbsp;\n    \";\n}\n\n// Determine whether an advertiser has an active placement/ad running under it...\nfunction _isAdvertiserActive($aAdvertiserPlacementAd)\n{\n    $active = false;\n    if (isset($aAdvertiserPlacementAd['children'])) {\n        foreach($aAdvertiserPlacementAd['children'] as $aPlacementAd) {\n            if (_isPlacementActive($aPlacementAd)) {\n                $active = true;\n                break;\n            }\n        }\n    }\n    return $active;\n}\n\n// Determine whether a placement has an active ad running under it...\nfunction _isPlacementActive($aPlacementAd)\n{\n    $active = false;\n    if ($aPlacementAd['status'] == OA_ENTITY_STATUS_RUNNING) {\n        if (isset($aPlacementAd['children'])) {\n            foreach($aPlacementAd['children'] as $aAd) {\n                if ($aAd['status'] == OA_ENTITY_STATUS_RUNNING) {\n                    $active = true;\n                    break;\n                }\n            }\n        }\n    }\n    return $active;\n}\n\n// Determine whether a publisher is active...\nfunction _isPublisherActive($aPublisherZone)\n{\n    return true;  // for now, all publishers are active.\n}\n\n// Determine whether a zone is active...\nfunction _isZoneActive($aZone)\n{\n    return true;  // for now, all zones are active.\n}\n\nfunction _secondsToWindowArray($seconds)\n{\n    $return['days'] = floor($seconds / (60*60*24));\n    $seconds = $seconds % (60*60*24);\n    $return['hours'] = floor($seconds / (60*60));\n    $seconds = $seconds % (60*60);\n    $return['minutes'] = floor($seconds / (60));\n    $seconds = $seconds % (60);\n    $return['seconds'] = $seconds;\n    return $return;\n}\n\nfunction _windowValuesToseconds($days, $hours, $minutes, $seconds)\n{\n    $days =    ($days > 0)    ? $days    : 0;\n    $hours =   ($hours > 0)   ? $hours   : 0;\n    $minutes = ($minutes > 0) ? $minutes : 0;\n    $seconds = ($seconds > 0) ? $seconds : 0;\n    return $days * (24*60*60) + $hours * (60*60) + $minutes * (60) + $seconds;\n}\n\nfunction _multiSort($array, $arg1, $arg2){\n        $arr1 = array();\n        $arr2 = array();\n\n        foreach ($array as $key => $value){\n            $arr1[$key] = strtolower( $value[$arg1] );\n            $arr2[$key] = $value[$arg2];\n        }\n\n        array_multisort($arr1, $arr2, $array);\n        return $array;\n}\n\n/** Tools and Breadcrumbs **/\nfunction MAX_displayNavigationTracker($advertiserId, $trackerId, $aOtherAdvertisers)\n{\n    addTrackerPageTools($advertiserId, $trackerId, $aOtherAdvertisers);\n    $oHeaderModel = MAX_displayTrackerBreadcrumbs($advertiserId, $trackerId);\n    phpAds_PageHeader(null, $oHeaderModel);\n}\n\n\nfunction MAX_displayNavigationCampaign($campaignId, $aOtherAdvertisers, $aOtherCampaigns, $aEntities)\n{\n    $advertiserId = $aEntities['clientid'];\n\n\n    $doCampaign = OA_Dal::factoryDO('campaigns');\n    $doCampaign->campaignid = $campaignId;\n    $doCampaign->find();\n    $doCampaign->fetch();\n    $campaignName = $doCampaign->campaignname;\n\n    $advertiserName = MAX_buildName($advertiserId, $aOtherAdvertisers[$advertiserId]['name']);\n    $advertiserEditUrl = '';\n    if (OA_Permission::hasAccessToObject('clients', $advertiserId, OA_Permission::OPERATION_EDIT)) {\n        $advertiserEditUrl = \"advertiser-edit.php?clientid=$advertiserId\";\n    }\n\n    addCampaignPageTools($advertiserId, $campaignId, $aOtherAdvertisers, $aEntities);\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                          array(\"name\" => $advertiserName, \"url\" => $advertiserEditUrl),\n                                          array(\"name\" => $campaignName)),\n                                        \"campaign\", \"edit\");\n    phpAds_PageHeader(null, $oHeaderModel);\n}\n\n\nfunction MAX_displayNavigationBanner($pageName, $aOtherCampaigns, $aOtherBanners, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $advertiserId = $aEntities['clientid'];\n    $campaignId = $aEntities['campaignid'];\n    $bannerId = $aEntities['bannerid'];\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['bannerid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n    if ($pageName == 'banner-edit.php' && empty($bannerId)) {\n                $tabValue = 'banner-edit_new';\n                $pageType = 'edit-new';\n    }\n    else {\n    \t$pageType = 'edit';\n    }\n\n    $advertiserEditUrl = '';\n    $campaignEditUrl = '';\n\n    if (OA_Permission::hasAccessToObject('clients', $advertiserId)) {\n        $advertiserEditUrl = \"advertiser-edit.php?clientid=$advertiserId\";\n    }\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        $campaignEditUrl = \"campaign-edit.php?clientid=$advertiserId&campaignid=$campaignId\";\n    }\n\n    // Build banner preview\n    if ($bannerId && !empty($GLOBALS['_MAX']['PREF']['ui_show_banner_preview']) && empty($_GET['nopreview'])) {\n        $bannerCode = MAX_bannerPreview($bannerId);\n    } else {\n        $bannerCode = '';\n    }\n\n    $advertiserDetails = phpAds_getClientDetails($advertiserId);\n    $advertiserName = $advertiserDetails['clientname'];\n    $campaignDetails = Admin_DA::getPlacement($campaignId);\n    $campaignName = $campaignDetails['name'];\n    $bannerName = $aOtherBanners[$bannerId]['name'];\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                      array(\"name\" => $advertiserName, \"url\" => $advertiserEditUrl),\n                                      array(\"name\" => $campaignName, \"url\" => $campaignEditUrl),\n                                      array(\"name\" => $bannerName)),\n                                    \"banner\", $pageType);\n\n    global $phpAds_breadcrumbs_extra;\n    $phpAds_breadcrumbs_extra .= \"<div class='bannercode'>$bannerCode</div>\";\n    if ($bannerCode != '') {\n        $phpAds_breadcrumbs_extra .= \"<br />\";\n    }\n\n    addBannerPageTools($advertiserId, $campaignId, $bannerId, $aOtherCampaigns, $aOtherBanners, $aEntities);\n    phpAds_PageHeader($tabValue, $oHeaderModel);\n}\n\nfunction MAX_bannerPreview($bannerId)\n{\n    require_once (MAX_PATH . '/lib/max/Delivery/adRender.php');\n    $aBanner = Admin_DA::getAd($bannerId);\n    $aBanner['storagetype'] = $aBanner['type'];\n    $aBanner['bannerid'] = $aBanner['ad_id'];\n    if ($aBanner['contenttype'] == 'swf') {\n        return\n            MAX_adRender($aBanner, 0, '', '', '', true, '', false, false) .\n            \"<br /><br />\" .\n            _adRenderImage($aBanner, 0, '', '', true, false, false, true);\n    } else {\n        return\n            MAX_adRender($aBanner, 0, '', '', '', true, '', false, false);\n    }\n}\n\nfunction MAX_displayNavigationZone($pageName, $aOtherPublishers, $aOtherZones, $aEntities)\n{\n\n    global $phpAds_TextDirection;\n\n    $websiteId = $aEntities['affiliateid'];\n    $zoneId = $aEntities['zoneid'];\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['zoneid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n    $aPublisher = $aOtherPublishers[$websiteId];\n    $publisherName = MAX_buildName($websiteId, $aPublisher['name']);\n    $zoneName = (empty($zoneId)) ? $GLOBALS['strUntitled'] : MAX_buildName($zoneId, $aOtherZones[$zoneId]['name']);\n\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n        $tabSections = array('4.2.3.2', '4.2.3.6', '4.2.3.3', '4.2.3.4', '4.2.3.5');\n        // Determine which tab is highlighted\n        switch ($pageName) {\n            case 'zone-edit.php'       :\n                if (empty($zoneId)) {\n                    $tabValue = 'zone-edit_new';\n                } else {\n                    $tabValue = 'zone-edit';\n                }\n                break;\n            default: $tabSections = basename($pageName); break;\n        }\n    }\n    elseif (OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER)) {\n        $tabSections = array();\n        if (OA_Permission::hasPermission(OA_PERM_ZONE_EDIT)) { $tabSections[] = '2.1.1'; }\n        if (OA_Permission::hasPermission(OA_PERM_ZONE_LINK)) { $tabSections[] = '2.1.2'; }\n        $tabSections[] = '2.1.3';\n        if (OA_Permission::hasPermission(OA_PERM_ZONE_INVOCATION)) { $tabSections[] = '2.1.4'; }\n        switch($pageName) {\n            case 'zone-edit.php': {\n                $tabValue = 'zone-edit';\n                if (empty($zoneId)) {\n                     $tabValue = 'zone-edit_new';\n                }\n                break;\n            }\n            case 'zone-include.php': $tabValue = '2.1.2'; break;\n            case 'zone-probability.php': $tabValue = '2.1.3'; break;\n            case 'zone-invocation.php': $tabValue = '2.1.4'; break;\n        }\n    }\n    // Sort the zones by name...\n    require_once(MAX_PATH . '/lib/max/other/stats.php');\n\n    $publisherEditUrl = \"affiliate-edit.php?affiliateid=$websiteId\";\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADMIN, OA_ACCOUNT_MANAGER)) {\n        $publisherEditUrl = \"affiliate-zones.php?affiliateid=$websiteId\";\n    }\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                       array(\"name\" => $publisherName, \"url\" => $publisherEditUrl),\n                                       array(\"name\" => empty($zoneId) ? '' : $zoneName)\n                                   ), \"zone\", empty($zoneId));\n\n    if (!empty($zoneId)) {\n        addZonePageTools($websiteId, $zoneId, $aOtherPublishers, $aEntities);\n    }\n    phpAds_PageHeader($tabValue, $oHeaderModel);\n    phpAds_ShowSections($tabSections);\n}\n\nfunction MAX_displayNavigationChannel($pageName, $aOtherChannels, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $agencyId = isset($aEntities['agencyid']) ? $aEntities['agencyid'] : null;\n    $websiteId = isset($aEntities['affiliateid']) ? $aEntities['affiliateid'] : null;\n    $channelId = $aEntities['channelid'];\n    $channelName = $aOtherChannels[$channelId]['name'];\n\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['channelid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n\n    if (!empty($websiteId)) {\n        $channelType = 'publisher';\n    }\n    else {\n        $channelType = 'agency';\n    }\n\n    // Determine which set of tabs to show...\n    if ($channelType == 'publisher') {\n        // Determine which tab is highlighted\n        switch ($pageName) {\n            case 'channel-edit.php' : $tabValue = (!empty($channelId)) ? 'channel-edit-affiliate' : 'channel-edit-affiliate_new'; break;\n            case 'channel-acl.php' : $tabValue = 'channel-affiliate-acl'; break;\n        }\n    } else {\n        // Determine which tab is highlighted\n        switch ($pageName) {\n            case 'channel-edit.php' : $tabValue = (!empty($channelId)) ? 'channel-edit' : 'channel-edit_new'; break;\n            case 'channel-acl.php' : $tabValue = 'channel-acl'; break;\n        }\n    }\n\n    // Sort the channels by name...\n    require_once(MAX_PATH . '/lib/max/other/stats.php');\n\n    $publisherEditUrl = \"affiliate-edit.php?affiliateid=$websiteId\";\n    if (!empty($channelId)) {\n        addChannelPageTools($agencyId, $websiteId, $channelId, $channelType);\n\n        // Determine which tab is highlighted\n        $publisher = Admin_DA::getPublisher($websiteId);\n        $publisherName = $publisher['name'];\n        if (!empty($channelId)) {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                array(\"name\" => $publisherName, url => $publisherEditUrl),\n                array(\"name\" => $channelName)), \"channel\", \"edit\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n        else {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                array(\"name\" => $publisherName, url => $publisherEditUrl),\n                array(\"name\" => $channelName)), \"channel\", \"edit-new\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n    }\n    else {\n        if (!empty($channelId)) {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                array(\"name\" => $channelName)), \"global-channel\", \"edit\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n        else {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                        array(\"name\" => \"\")), \"global-channel\", \"edit-new\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n    }\n}\n\n\nfunction addAdvertiserPageToolsAndShortcuts($advertiserId)\n{\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        addPageLinkTool($GLOBALS[\"strAddCampaign_Key\"], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-edit.php?clientid=\".$advertiserId), \"iconCampaignAdd\", $GLOBALS[\"keyAddNew\"] );\n    }\n    addPageShortcut($GLOBALS['strAdvertiserCampaigns'], MAX::constructUrl(MAX_URL_ADMIN, \"advertiser-campaigns.php?clientid=$advertiserId\"), \"iconCampaigns\");\n    addPageShortcut($GLOBALS['strClientHistory'], MAX::constructUrl(MAX_URL_ADMIN, 'stats.php?entity=advertiser&breakdown=history&clientid='.$advertiserId), 'iconStatistics');\n}\n\n\nfunction addTrackerPageTools($advertiserId, $trackerId, $aOtherAdvertisers)\n{\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n        $token = phpAds_SessionGetToken();\n\n        //duplicate\n        addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"tracker-modify.php?token=\".urlencode($token).\"&clientid=\".$advertiserId.\"&trackerid=\".$trackerId.\"&duplicate=true&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconTrackerDuplicate\");\n\n        //move to\n        $form  = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'tracker-modify.php') . \"'>\n            <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n            <input type='hidden' name='trackerid' value='$trackerId'\n            <input type='hidden' name='clientid' value='$advertiserId'\n            <input type='hidden' name='returnurl' value='tracker-edit.php'>\n            <select name='moveto'>\";\n        foreach ($aOtherAdvertisers as $advertiser) {\n            $form .= \"<option value='\".$advertiser['clientid'].\"'>\".htmlspecialchars(MAX_buildName($advertiser['clientid'], $advertiser['clientname'])).\"</option>\";\n        }\n        $form .= \"</select><input type='image' class='submit' src='\" . OX::assetPath() . \"/images/\".$GLOBALS['phpAds_TextDirection'].\"/go_blue.gif'></form>\";\n        addPageFormTool($GLOBALS['strMoveTo'], 'iconTrackerMove', $form);\n\n        //delete\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteTracker']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"tracker-delete.php?token=\".urlencode($token).\"&clientid=\".$advertiserId.\"&trackerid=\".$trackerId.\"&returnurl=advertiser-trackers.php\"), \"iconDelete\", null, $deleteConfirm);\n        addPageShortcut($GLOBALS['strBackToTrackers'], MAX::constructUrl(MAX_URL_ADMIN, \"advertiser-trackers.php?clientid=$advertiserId\"), \"iconBack\");\n    }\n}\n\n\nfunction addCampaignPageTools($clientid, $campaignid, $aOtherAdvertisers, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n\n        $token = phpAds_SessionGetToken();\n\n        addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-modify.php?token=\".urlencode($token).\"&duplicate=1&clientid=$clientid&campaignid=$campaignid&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconCampaignDuplicate\");\n\n        if (OA_Permission::hasAccessToObject('campaigns', $campaignid, OA_Permission::OPERATION_MOVE)) {\n            $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'campaign-modify.php') . \"'>\n            <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n            <input type='hidden' name='clientid' value='$clientid'>\n            <input type='hidden' name='campaignid' value='$campaignid'>\n            <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'], ENT_QUOTES)).\"'>\n            <select name='newclientid'>\";\n                $aOtherAdvertisers = _multiSort($aOtherAdvertisers,'name','advertiser_id');\n                foreach ($aOtherAdvertisers as $aOtherAdvertiser) {\n                    $otherAdvertiserId = $aOtherAdvertiser['advertiser_id'];\n                    $otherAdvertiserName = MAX_buildName($otherAdvertiserId, $aOtherAdvertiser['name']);\n\n                    if ($otherAdvertiserId != $advertiserId) {\n                        $form .= \"<option value='$otherAdvertiserId'>\" . htmlspecialchars($otherAdvertiserName) . \"</option>\";\n                    }\n                }\n            $form .= \"</select><input type='image' class='submit' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif'></form>\";\n\n            addPageFormTool($GLOBALS['strMoveTo'], 'iconCampaignMove', $form);\n        }\n\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteCampaign']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-delete.php?token=\".urlencode($token).\"&clientid=$clientid&campaignid=$campaignid&returnurl=advertiser-campaigns.php\"), \"iconDelete\", null, $deleteConfirm);\n    }\n\n    //shortcuts\n    if (!empty($campaignid) && !OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        if (OA_Permission::hasAccessToObject('campaigns', $campaignid, OA_Permission::OPERATION_ADD_CHILD)) {\n            addPageLinkTool($GLOBALS[\"strAddBanner_Key\"], MAX::constructUrl(MAX_URL_ADMIN, \"banner-edit.php?clientid=$clientid&campaignid=$campaignid\"), \"iconBannerAdd\", $GLOBALS[\"strAddNew\"] );\n        }\n        addPageShortcut($GLOBALS['strBackToCampaigns'], MAX::constructUrl(MAX_URL_ADMIN, \"advertiser-campaigns.php?clientid=$clientid\"), \"iconBack\");\n    }\n    if (!empty($campaignid)) {\n        if (OA_Permission::hasAccessToObject('campaigns', $campaignid, OA_Permission::OPERATION_VIEW_CHILDREN)) {\n            addPageShortcut($GLOBALS['strCampaignBanners'], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-banners.php?clientid=$clientid&campaignid=$campaignid\"), \"iconBanners\");\n        }\n        $entityString = _getEntityString($aEntities);\n        addPageShortcut($GLOBALS['strCampaignHistory'], MAX::constructUrl(MAX_URL_ADMIN, \"stats.php?entity=campaign&breakdown=history&$entityString\"), 'iconStatistics');\n    }\n}\n\nfunction addBannerPageTools($advertiserId, $campaignId, $bannerId, $aOtherCampaigns, $aOtherBanners, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    if (empty($bannerId)) {\n        return;\n    }\n\n    $token = phpAds_SessionGetToken();\n\n    //duplicate\n    addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"banner-modify.php?token=\".urlencode($token).\"&duplicate=true&clientid=$advertiserId&campaignid=$campaignId&bannerid=$bannerId&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconBannerDuplicate\");\n\n    //move to\n    $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'banner-modify.php') . \"'>\n    <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n    <input type='hidden' name='clientid' value='$advertiserId'>\n    <input type='hidden' name='campaignid' value='$campaignId'>\n    <input type='hidden' name='bannerid' value='$bannerId'>\n    <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'])).\"'>\n    <select name='moveto'>\";\n    $aOtherCampaigns = _multiSort($aOtherCampaigns,'name','placement_id');\n    foreach ($aOtherCampaigns as $otherCampaignId => $aOtherCampaign) {\n        // mask campaign name if anonymous campaign\n        $aOtherCampaign['name'] = MAX_getPlacementName($aOtherCampaign);\n        $otherCampaignName = MAX_buildName($aOtherCampaign['placement_id'], $aOtherCampaign['name']);\n\n        if ($aOtherCampaign['placement_id'] != $campaignId) {\n            $form .= \"<option value='\" . $aOtherCampaign['placement_id'] . \"'>\" . htmlspecialchars($otherCampaignName) . \"</option>\";\n        }\n        else {\n            $campaignName = $otherCampaignName;\n        }\n    }\n    $form .= \"</select><input name='moveto' class='submit' type='image' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif'></form>\";\n    addPageFormTool($GLOBALS['strMoveTo'], 'iconBannerMove', $form);\n\n    //apply to\n    if (basename($_SERVER['SCRIPT_NAME']) == 'banner-acl.php') {\n        $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'banner-modify.php') . \"'>\n        <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n        <input type='hidden' name='clientid' value='$advertiserId'>\n        <input type='hidden' name='campaignid' value='$campaignId'>\n        <input type='hidden' name='bannerid' value='$bannerId'>\n        <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'])).\"'>\n        <select name='applyto'>\";\n\n        $aOtherBanners = _multiSort($aOtherBanners,'name','ad_id');\n        foreach ($aOtherBanners as $idx => $aOtherBanner) {\n            if ($aOtherBanner['ad_id'] != $bannerId) {\n                $form .= \"<option value='{$aOtherBanner['ad_id']}'>\" . MAX_buildName($aOtherBanner['ad_id'], $aOtherBanner['name']) . \"</option>\";\n            }\n        }\n        $form .= \"</select><input type='image' class='submit' name='applyto' src='\" . OX::assetPath() . \"/images/\".$phpAds_TextDirection.\"/go_blue.gif'></form>\";\n\n        addPageFormTool($GLOBALS['strApplyLimitationsTo'], 'iconBannerApplyLimitations', $form);\n    }\n\n    //delete\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteBanner']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"banner-delete.php?token=\".urlencode($token).\"&clientid=$advertiserId&campaignid=$campaignId&bannerid=$bannerId&returnurl=campaign-banners.php\"), \"iconDelete\", null, $deleteConfirm);\n    }\n\n    /* Shortcuts */\n    addPageShortcut($GLOBALS['strBackToBanners'], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-banners.php?clientid=$advertiserId&campaignid=$campaignId\"), \"iconBack\");\n    $entityString = _getEntityString($aEntities);\n    addPageShortcut($GLOBALS['strBannerHistory'], MAX::constructUrl(MAX_URL_ADMIN, \"stats.php?entity=banner&breakdown=history&$entityString\"), 'iconStatistics');\n}\n\n\nfunction addWebsitePageTools($websiteId)\n{\n    if (!empty($websiteId) && (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n        || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)\n        || OA_Permission::hasPermission(OA_PERM_ZONE_ADD))) {\n        addPageLinkTool($GLOBALS[\"strAddNewZone_Key\"], MAX::constructUrl(MAX_URL_ADMIN, \"zone-edit.php?affiliateid=$websiteId\"), \"iconZoneAdd\", $GLOBALS[\"keyAddNew\"] );\n        addPageShortcut($GLOBALS['strWebsiteZones'], MAX::constructUrl(MAX_URL_ADMIN, \"affiliate-zones.php?affiliateid=$websiteId\"), \"iconZones\");\n    }\n    addPageShortcut($GLOBALS['strAffiliateHistory'], MAX::constructUrl(MAX_URL_ADMIN, 'stats.php?entity=affiliate&breakdown=history&affiliateid='.$websiteId), 'iconStatistics');\n}\n\n\nfunction addZonePageTools($affiliateid, $zoneid, $aOtherPublishers, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $token = phpAds_SessionGetToken();\n\n    //duplicate\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n        || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)\n        || OA_Permission::hasPermission(OA_PERM_ZONE_ADD)) {\n        addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"zone-modify.php?duplicate=true&affiliateid=$affiliateid&zoneid=$zoneid&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconZoneDuplicate\");\n    }\n\n    //move to\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n        || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n        $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'zone-modify.php') . \"'>\n        <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n        <input type='hidden' name='affiliateid' value='$affiliateid'>\n        <input type='hidden' name='zoneid' value='$zoneid'>\n        <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'])).\"'>\n        <select name='newaffiliateid'>\";\n        $aOtherPublishers = _multiSort($aOtherPublishers,'name','publisher_id');\n        foreach ($aOtherPublishers as $otherPublisherId => $aOtherPublisher) {\n            $otherPublisherName = MAX_buildName($aOtherPublisher['publisher_id'], $aOtherPublisher['name']);\n            if ($aOtherPublisher['publisher_id'] != $affiliateid) {\n                $form .= \"<option value='\" . $aOtherPublisher['publisher_id'] . \"'>\" . htmlspecialchars($otherPublisherName) . \"</option>\";\n            }\n        }\n        $form .= \"</select><input type='image' class='submit' src='\" . OX::assetPath() . \"/images/\".$phpAds_TextDirection.\"/go_blue.gif'></form>\";\n\n        addPageFormTool($GLOBALS['strMoveTo'], 'iconZoneMove', $form);\n    }\n\n    //delete\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n       || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)\n       || OA_Permission::hasPermission(OA_PERM_ZONE_DELETE)) {\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteZone']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"zone-delete.php?token=\".urlencode($token).\"&affiliateid=$affiliateid&zoneid=$zoneid&returnurl=affiliate-zones.php\"), \"iconDelete\", null, $deleteConfirm);\n    }\n\n    //shortcut\n    addPageShortcut($GLOBALS['strBackToZones'], MAX::constructUrl(MAX_URL_ADMIN, \"affiliate-zones.php?affiliateid=$affiliateid\"), \"iconBack\");\n    $entityString = _getEntityString($aEntities);\n    addPageShortcut($GLOBALS['strZoneHistory'], MAX::constructUrl(MAX_URL_ADMIN, \"stats.php?entity=zone&breakdown=history&$entityString\"), 'iconStatistics');\n}\n\nfunction addChannelPageTools($agencyid, $websiteId, $channelid, $channelType)\n{\n    if ($channelType == 'publisher') {\n        $deleteReturlUrl = MAX::constructUrl(MAX_URL_ADMIN, 'affiliate-channels.php');\n    }\n    else {\n        $deleteReturlUrl = MAX::constructUrl(MAX_URL_ADMIN, 'channel-index.php');\n    }\n\n    $token = phpAds_SessionGetToken();\n\n    //duplicate\n    addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"channel-modify.php?token=\".urlencode($token).\"&duplicate=true&agencyid=$agencyid&affiliateid=$websiteId&channelid=$channelid&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconTargetingChannelDuplicate\");\n\n    //delete\n    $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteChannel']);\n    addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"channel-delete.php?token=\".urlencode($token).\"&agencyid=$agencyid&affiliateid=$websiteId&channelid=$channelid&returnurl=$deleteReturlUrl\"), \"iconDelete\", null, $deleteConfirm);\n}\n\n\n/**\n * Builds Pear pager object, preconfigured with items per page. Pager links are\n * processed to make them more readable. Also items name in summary can be added.\n *\n * @param unknown_type $items\n * @param unknown_type $itemsPerPage\n * @param unknown_type $withNumbers\n * @param unknown_type $itemsName\n * @return unknown\n */\nfunction OX_buildPager($items, $itemsPerPage, $withNumbers = true, $itemsName = '', $delta = 4,\n    $currentPage = null, $fileName = null, $params = null)\n{\n    require_once MAX_PATH . '/lib/pear/Pager/Pager.php';\n\n    $oTrans = new OX_Translation();\n\n    /** prepare paging **/\n    $count = count($items);\n        $delta = $withNumbers ? $delta : 0;\n\n\n    $pagerOptions = array(\n        'mode'       => 'Sliding',\n        'perPage'    => $itemsPerPage,\n        'delta'      => $delta,\n        'totalItems' => $count,\n        'prevImg'       => '&lt; ' . $oTrans->translate('Back'),\n        'nextImg'       => $oTrans->translate('Next') . ' &gt;',\n        'urlVar' => 'p',\n        'linkClass' => 'page',\n        'curPageLinkClassName' => 'current',\n        'spacesBeforeSeparator' => 0,\n        'httpMethod' => 'GET',\n        'spacesAfterSeparator' => 0\n    );\n    if (!empty($fileName)) {\n        $pagerOptions['fileName'] = $fileName;\n        $pagerOptions['fixFileName'] = false;\n    }\n    if (!empty($params)) {\n        $pagerOptions['extraVars'] = $params;\n    }\n    if (!empty($currentPage)) {\n        $pagerOptions['currentPage'] = $currentPage;\n    }\n\n    $pager = Pager::factory($pagerOptions);\n    list($from, $to) = $pager->getOffsetByPageId();\n    $summary = \"<em>$from</em>-<em>$to</em> of <em>\".$pager->numItems().\" $itemsName</em>\";\n    $pager->summary = $summary;\n\n    //override links with shorter pager controls\n    if (!$withNumbers) {\n        $links = $pager->links;\n        $shortLinks = preg_replace(\"/<span class=\\\"current\\\">\\d+<\\/span>/i\", \"<span class='summary'>$summary</span>\" , $links);\n        $shortLinks = preg_replace(\"/\\[\\d+\\]/\", \"\" , $shortLinks);\n        $pager->links = $shortLinks;\n    }\n\n    return $pager;\n}\n\n\n\n?>\n", "{*<!--\n\n+---------------------------------------------------------------------------+\n| Revive Adserver                                                           |\n| http://www.revive-adserver.com                                            |\n|                                                                           |\n| Copyright: See the COPYRIGHT.txt file.                                    |\n| License: GPLv2 or later, see the LICENSE.txt file.                        |\n+---------------------------------------------------------------------------+\n\n-->*}\n\n<div class='dropDown {$cssClass}'>\n    <span><span>{$title}</span></span>\n\n    <div class='panel'>\n        <div>\n            <ul>\n    \t\t{section name=linkLoop loop=$aLinks}\n        \t\t<li>\n        \t\t\t{if $aLinks[linkLoop].type == 'link'}\n            \t\t\t{if $aLinks[linkLoop].icon}<img src='{$assetPath}/images/{$aLinks[linkLoop].icon}' align='absmiddle' alt=''>{/if}\n            \t\t\t<a href='{$aLinks[linkLoop].url}' {if $aLinks[linkLoop].iconClass}class='inlineIcon {$aLinks[linkLoop].iconClass}'{/if} {if $aLinks[linkLoop].accesskey}accesskey='{$aLinks[linkLoop].accesskey}'{/if} {$aLinks[linkLoop].extraAttr}>{$aLinks[linkLoop].title}</a>\n        \t\t\t{elseif $aLinks[linkLoop].type == 'form'}\n            \t\t\t{if $aLinks[linkLoop].icon}<img src='{$assetPath}/images/{$aLinks[linkLoop].icon}' align='absmiddle' alt=''>{/if}\n            \t\t\t<label {if $aLinks[linkLoop].iconClass}class='inlineIcon {$aLinks[linkLoop].iconClass}'{/if}>{$aLinks[linkLoop].title}</label>\n               \t\t\t{$aLinks[linkLoop].form}\n        \t\t\t{/if}\n        \t\t</li>\n    \t\t{/section}\n            </ul>\n        </div>\n    </div>\n\n    <div class='mask'></div>\n</div>\n", "<?php\n\n/*\n+---------------------------------------------------------------------------+\n| Revive Adserver                                                           |\n| http://www.revive-adserver.com                                            |\n|                                                                           |\n| Copyright: See the COPYRIGHT.txt file.                                    |\n| License: GPLv2 or later, see the LICENSE.txt file.                        |\n+---------------------------------------------------------------------------+\n*/\n\n// Require the initialisation file\nrequire_once '../../init.php';\n\n// Required files\nrequire_once MAX_PATH . '/www/admin/config.php';\nrequire_once MAX_PATH . '/www/admin/lib-statistics.inc.php';\nrequire_once MAX_PATH . '/lib/max/other/common.php';\nrequire_once MAX_PATH . '/lib/max/Admin_DA.php';\nrequire_once MAX_PATH . '/lib/max/other/html.php';\nrequire_once MAX_PATH . '/lib/max/other/stats.php';\nrequire_once 'Pager/Pager.php';\nrequire_once MAX_PATH . '/lib/pear/Date.php';\n\n// Security check\nOA_Permission::enforceAccount(OA_ACCOUNT_MANAGER, OA_ACCOUNT_ADVERTISER, OA_ACCOUNT_TRAFFICKER);\n\n// Get input variables\n$pref = $GLOBALS['_MAX']['PREF'];\n$hideinactive   = MAX_getStoredValue('hideinactive', ($pref['ui_hide_inactive'] == true), null, true);\n$listorder      = MAX_getStoredValue('listorder', 'date_time');\n$orderdirection = MAX_getStoredValue('orderdirection', 'up');\n$aNodes         = MAX_getStoredArray('nodes', array());\n$editStatuses   = MAX_getStoredValue('editStatuses', false, null, true);\n$day            = MAX_getStoredValue('day', null, 'stats-conversions.php');\n$howLong        = MAX_getStoredValue('howLong', 'd');\n$hour           = MAX_getStoredValue('hour', null, 'stats-conversions.php', true);\n$setPerPage     = MAX_getStoredValue('setPerPage', 15);\n$pageID         = MAX_getStoredValue('pageID', 1);\n\nif (!empty($day)) {\n    // Reset period\n    $period_preset = '';\n    // Always refresh howLong and hour\n    $howLong = MAX_getValue('howLong', 'd');\n    $hour    = MAX_getValue('hour');\n} else {\n    $period_preset  = MAX_getStoredValue('period_preset', 'today');\n    $period_start   = MAX_getStoredValue('period_start', date('Y-m-d'));\n    $period_end     = MAX_getStoredValue('period_end', date('Y-m-d'));\n}\n\nif (is_numeric($hour) && $hour < 10 && strlen($hour) != 2) {\n    $hour = '0' . $hour;\n}\n\n$expand         = MAX_getValue('expand', '');\n$collapse       = MAX_getValue('collapse');\n\n$clientId       = MAX_getValue('clientid');\n$campaignId     = MAX_getValue('campaignid');\n$bannerId       = MAX_getValue('bannerid');\n\n$affiliateId    = MAX_getValue('affiliateid');\n$zoneId         = MAX_getValue('zoneid');\n\nif (OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n    $clientId = $clientid = OA_Permission::getEntityId();\n} elseif (OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER)) {\n    $affiliateId = $affiliateid = OA_Permission::getEntityId();\n}\n\n// Build $addUrl variable which will be added to any required link on this page, eg: expand, collapse, editStatuses\n$entityIds = array(\n    'entity'      => 'conversions',\n    'clientid'    => $clientid,\n    'campaignid'  => $campaignId,\n    'bannerid'    => $bannerId,\n    'affiliateid' => $affiliateId,\n    'zoneid'      => $zoneId,\n    'setPerPage'  => $setPerPage,\n    'pageID'      => $pageID\n);\n$addUrl = \"entity=conversions&clientid=$clientId&campaignid=$campaignId&bannerid=$bannerId&affiliateid=$affiliateId&zoneid=$zoneId&setPerPage=$setPerPage&pageID=$pageID\";\n\nif (!empty($day)) {\n    $entityIds += array(\n        'day' => $day,\n        'hour' => $hour,\n        'howLong' => $howLong\n    );\n    $addUrl .= \"&day={$day}&hour={$hour}&howLong={$howLong}\";\n} else {\n    $entityIds += array(\n        'period_preset' => $period_preset,\n        'period_start' => $period_start,\n        'period_end' => $period_end,\n    );\n    $addUrl .= \"&period_preset={$period_preset}&period_start={$period_start}&period_end={$period_end}\";\n}\n// Adjust which nodes are opened closed...\nMAX_adjustNodes($aNodes, $expand, $collapse);\n\nif (!OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n    // editing statuses is allowed only for admin and agency\n    $editStatuses = false;\n}\nelse {\n    if($editStatuses) {\n        addPageShortcut($strShortcutShowStatuses, 'stats.php?entity=conversions&editStatuses=0&'.$addUrl, 'iconZoom');\n    }\n    else {\n        addPageShortcut($strShortcutEditStatuses, 'stats.php?entity=conversions&editStatuses=1&'.$addUrl, 'iconEdit');\n    }\n}\n\n// @todo: hack - get edit status working when expading/collapsing\nif ($editStatuses) {\n    $entityIds['editStatuses'] = 1;\n    $addUrl .= '&editStatuses=1';\n}\n\n// Display navigation\nif(OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER)) {\n    // Navigation for publisher\n    $conf = &$GLOBALS['_MAX']['CONF'];\n    $conf['logging']['adRequests'] = false;\n    $affiliateid = OA_Permission::getEntityId();\n\n    phpAds_PageHeader(\"1.1\");\n    echo '<br><br>';\n} elseif(OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n    // Navigation for advertiser\n    $clientid = OA_Permission::getEntityId();\n\n    phpAds_PageHeader(\"1.1\");\n    echo '<br><br>';\n} else {\n    // Navigation for admin and agency\n\n    phpAds_PageHeader(\"2.1\");\n    echo '<br><br>';\n}\n// Initialise some parameters\n$pageName = basename($_SERVER['SCRIPT_NAME']);\n$tabindex = 1;\n$advertisersHidden = 0;\n\n// Display date filter form\nif(empty($day)) {\n    $aDates = MAX_getDatesByPeriod($period_preset, $period_start, $period_end);\n} else {\n    $aDates = array();\n    $oDayDate = new Date();\n    $oDayDate->setDate($day, DATE_FORMAT_TIMESTAMP);\n    if(!empty($hour)) {\n        // If hour is set build day date including hour\n        $aDates['day_hour'] = $oDayDate->format('%Y-%m-%d').' '.$hour;\n    } else {\n        // Build month, day, day_begin and day_end dependends on $howLong\n        switch($howLong) {\n            case 'm':\n                $aDates['month'] = $oDayDate->format('%Y-%m');\n                break;\n            case 'w':\n                $aDates['day_begin'] = $oDayDate->format('%Y-%m-%d');\n                $oDayDate->addSeconds(60*60*24*7); // Add 7 days\n                $aDates['day_end'] = $oDayDate->format('%Y-%m-%d');\n                break;\n            case 'd':\n            default:\n                $aDates['day'] = $oDayDate->format('%Y-%m-%d');\n                break;\n        }\n    }\n}\n\n$hiddenValues = array(\n    'entity'   => 'conversions',\n    'clientid' => $clientId,\n    'campaignid' => $campaignId,\n    'bannerid' => $bannerId,\n    'affiliateid' => $affiliateId,\n    'zoneid' => $zoneId,\n);\nif(!empty($period_preset)) {\n    MAX_displayDateSelectionForm($period_preset, $period_start, $period_end, $pageName, $tabindex, $hiddenValues);\n} else {\n    $comma = '';\n    foreach($aDates as $dateValue) {\n        echo $comma.$dateValue;\n        $comma = ' - ';\n    }\n}\n\nphpAds_ShowBreak();\n\n$aParams = array();\n$aParams['agency_id'] = OA_Permission::getAgencyId();\n\n$aParams['clientid']    = $clientId;\n$aParams['campaignid']  = $campaignId;\n$aParams['bannerid']    = $bannerId;\n$aZonesIds = null; // Admin_DA class expects null if no zones to be used\nif (empty($zoneId) && !empty($affiliateId)) {\n    $aZonesIds = Admin_DA::fromCache('getZonesIdsByAffiliateId', $affiliateId);\n}\nif(!empty($zoneId)) {\n    $aZonesIds = array($zoneId);\n}\n$aParams['zonesIds'] = $aZonesIds;\n\n\n\n// Get conversions...\n\n\n\n$aParams['perPage'] = '999999';\n$aConversions = Admin_DA::fromCache('getConversions', $aParams + $aDates);\n\n\n$aParams['totalItems'] = count($aConversions);\n$aParams['perPage'] = MAX_getStoredValue('setPerPage', 15);\n\nif (!isset($pageID) || $pageID == 1) {\n    $aParams['startRecord'] = 0;\n} else {\n    $aParams['startRecord'] = (MAX_getStoredValue('pageID', 1) * $aParams['perPage']) - $aParams['perPage'];\n}\n\n\n\n$aConversions = Admin_DA::fromCache('getConversions', $aParams + $aDates);\n\n\n$aParams['perPage'] = MAX_getStoredValue('setPerPage', 15);\n//$aParams['startRecord'] = $_REQUEST['page'];\n\n$pager = & Pager::factory($aParams);\n$per_page = $pager->_perPage;\n$pager->history = $pager->getPageData();\n$pager->pagerLinks = $pager->getLinks();\n\n$pager->pagerLinks = $pager->pagerLinks['all'];\n$pager->pagerSelect = preg_replace('/(<select.*?)(>)/i', '$1 id=\"setPerPageSelect\"$2', $pager->getPerPageSelectBox(15, 120, 15));\n\n// Build the conversions array\nif (!empty($aConversions)) {\n\n    if($editStatuses) {\n        echo \"<form id='connections-modify' action='connections-modify.php' name='connectionsmodify' id='connectionsmodify' method='POST'>\".\"\\n\";\n        echo \"<input type='hidden' name='clientid' value='$clientId'>\".\"\\n\";\n        echo \"<input type='hidden' name='campaignid' value='$campaignId'>\".\"\\n\";\n        echo \"<input type='hidden' name='bannerid' value='$bannerId'>\".\"\\n\";\n        echo \"<input type='hidden' name='affiliateid' value='$affiliateId'>\".\"\\n\";\n        echo \"<input type='hidden' name='zoneid' value='$zoneId'>\".\"\\n\";\n        echo \"<input type='hidden' name='day' value='$day'>\".\"\\n\";\n        echo \"<input type='hidden' name='hour' value='$hour'>\".\"\\n\";\n        echo \"<input type='hidden' name='howLong' value='$howLong'>\".\"\\n\";\n        echo \"<input type='hidden' name='period_preset' value='$period_preset'>\".\"\\n\";\n        if ($period_preset == 'specific') {\n            echo \"<input type='hidden' name='period_start' value='$period_start'>\".\"\\n\";\n            echo \"<input type='hidden' name='period_end' value='$period_end'>\".\"\\n\";\n        }\n        echo \"<input type='hidden' name='returnurl' value='stats.php'>\".\"\\n\";\n        echo \"<input type='hidden' name='entity' value='conversions'>\".\"\\n\";\n        echo \"<input type='hidden' name='setPerPage' value='$setPerPage'>\".\"\\n\";\n        echo \"<input type='hidden' name='pageID' value='$pageID'>\".\"\\n\";\n    }\n\n    echo \"\n        <br /><br />\n        <table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strDateTime'], 'date_time', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strStatus'], 'connection_status', $pageName, $entityIds, $listorder, $orderdirection);\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strTrackerID'], 'tracker_id', $pageName, $entityIds, $listorder, $orderdirection);\n    $column4 = _getHtmlHeaderColumn($GLOBALS['strTrackerName'], 'trackername', $pageName, $entityIds, $listorder, $orderdirection);\n    $column5 = _getHtmlHeaderColumn($GLOBALS['strCampaignID'], 'campaignid', $pageName, $entityIds, $listorder, $orderdirection);\n    $column6 = _getHtmlHeaderColumn($GLOBALS['strCampaignName'], 'campaignname', $pageName, $entityIds, $listorder, $orderdirection);\n\n    echo \"\n        <tr height='1'>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='150' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='60' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='60' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        </tr>\n        <tr height='25'>\n            <td width='150' style='padding-left: 16px'>&nbsp;&nbsp;$column1</td>\n            <td align='center' style='padding: 0 4px'>$column2</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column3</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column4</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column5</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column6</td>\n        </tr>\n        <tr height='1'><td colspan='6' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n\n    // Variable to determine if the row should be grey or white...\n    $i=0;\n\n    $statusesColors = array(\n        MAX_CONNECTION_STATUS_IGNORE      => 'grey',\n        MAX_CONNECTION_STATUS_PENDING     => 'darkblue',\n        MAX_CONNECTION_STATUS_ONHOLD      => 'blue',\n        MAX_CONNECTION_STATUS_APPROVED    => 'green',\n        MAX_CONNECTION_STATUS_DISAPPROVED => 'red',\n        MAX_CONNECTION_STATUS_DUPLICATE   => 'grey',\n    );\n\n    $totalRequests = 0;\n    $totalViews = 0;\n    $totalClicks = 0;\n    $totalConversions = 0;\n\n    // Loop through advertisers\n    MAX_sortArray($aConversions, ($listorder == 'id' ? 'date_time' : $listorder), $orderdirection == 'up');\n    foreach($aConversions as $conversionId => $conversion) {\n        $conversionExpanded = MAX_isExpanded($conversionId, $expand, $aNodes, 'a');\n\n            $bgcolor = ($i++ % 2 == 0) ? \" bgcolor='#F6F6F6'\" : '';\n\n            $connectionStatus = $GLOBALS['_MAX']['STATUSES'][$conversion['connection_status']];\n            $translatedStatus = $GLOBALS[$connectionStatus];\n\n            echo \"\n        <tr height='25'$bgcolor>\n            <td>\";\n            if ($conversionExpanded) {\n                echo \"&nbsp;<a href='$pageName?collapse=a$conversionId&$addUrl'><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'></a>&nbsp;\";\n            } else {\n                echo \"&nbsp;<a href='$pageName?expand=a$conversionId&$addUrl'><img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'></a>&nbsp;\";\n            }\n\n            $aConversionStatuses = array(\n                MAX_CONNECTION_STATUS_IGNORE,\n                MAX_CONNECTION_STATUS_PENDING,\n                MAX_CONNECTION_STATUS_ONHOLD,\n                MAX_CONNECTION_STATUS_APPROVED,\n                MAX_CONNECTION_STATUS_DISAPPROVED,\n                MAX_CONNECTION_STATUS_DUPLICATE,\n            );\n\n            echo \"{$conversion['date_time']}</td>\";\n            if ($editStatuses) {\n                // Only managers can edit statuses. No constraint to the type of changes since OX-4138.\n                echo \"<td align='center' style='padding: 0 4px'><nobr>\";\n                foreach($GLOBALS['_MAX']['STATUSES'] as $statusId => $statusStr) {\n                    echo \"&nbsp;<label><input type='radio' name='statusIds[$conversionId]' value='$statusId' \".($conversion['connection_status']==$statusId?' checked':'').\" tabindex='\".($tabindex++).\"'>{$GLOBALS[$statusStr]}</label>\";\n                }\n                echo \"</nobr></td>\";\n            } else {\n                echo \"<td align='center' style='padding: 0 4px'><span style='color: {$statusesColors[$conversion['connection_status']]}'>{$translatedStatus}</span></td>\";\n            }\n            echo \"<td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['tracker_id']}</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['trackername']}</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['campaignid']}</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['campaignname']}</td>\n        </tr>\";\n\n        if ($conversionExpanded) {\n            $aConVariables = Admin_DA::fromCache('getConnectionVariables', $conversionId);\n\n            echo \"\n            <tr height='1'>\n                <td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n                <td colspan='5' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n            </tr>\";\n\n            switch ($conversion['connection_action']) {\n                case MAX_CONNECTION_AD_CLICK:   $action = 'Click'; break;\n                case MAX_CONNECTION_AD_ARRIVAL: $action = 'Arrival'; break;\n                case MAX_CONNECTION_MANUAL:     $action = 'Manual'; break;\n                default:                        $action = 'View'; break;\n            }\n\n            $connectionType = $GLOBALS[$GLOBALS['_MAX']['CONN_TYPES'][$conversion['connection_type']]];\n\n            $eventDateStamp = strtotime($conversion['date_time']);\n\n            $secondsLeft = $eventDateStamp - strtotime($conversion['connection_date_time']);\n\n            $days = intval($secondsLeft / 86400);  // 86400 seconds in a day\n            $partDay = $secondsLeft - ($days * 86400);\n            $hours = intval($partDay / 3600);  // 3600 seconds in an hour\n            $partHour = $partDay - ($hours * 3600);\n            $minutes = intval($partHour / 60);  // 60 seconds in a minute\n            $seconds = $partHour - ($minutes * 60);\n\n            $windowDelay = $days.\"d \".$hours.\"h \".$minutes.\"m \".$seconds.\"s\";\n\n            echo \"\n            <tr height='25'$bgcolor>\n                <td></td>\n                <td colspan='5'>\n                    <table width='100%' border='0' cellspacing='' cellpadding='4'>\n                        <tr valign='top'>\n                            <td width='40%'>\n                                <table border='0' cellspacing='0' cellpadding='0'>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strIPAddress']}:</th><td style='padding-left: 8px'>{$conversion['tracker_ip_address']}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strCountry']}:</th><td style='padding-left: 8px'>{$conversion['tracker_country']}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strStatsAction']}:</th><td style='padding-left: 8px'>{$action}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strConnectionType']}:</th><td style='padding-left: 8px'>{$connectionType}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strWindowDelay']}:</th><td style='padding-left: 8px'>{$windowDelay}</td></tr>\";\n            if (!is_null($conversion['comments'])) {\n                echo \"\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strComments']}:</th><td style='padding-left: 8px'>{$conversion['comments']}</td></tr>\";\n            }\n            echo \"\n                                </table>\n                            </td>\n                            <td width='60%'>\n                                <table border='0' cellspacing='0' cellpadding='0'>\n                                    <tr><th scope='col' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strStatsVariables']}:</th><td></td></tr>\";\n            foreach($aConVariables as $conVariable) {\n                // Do not show hidden variables to publishers\n                if (OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER) && $conVariable['hidden'] == 't') {\n                    continue;\n                }\n                echo \"<tr><th scope='row' style='text-align: $phpAds_TextAlignLeft; color: darkgrey'>\".\n                        htmlspecialchars(empty($conVariable['description']) ? $conVariable['name'] : $conVariable['description']).\n                        \"</th><td style='padding-left: 8px'>\".htmlspecialchars($conVariable['value']).\"</td></tr>\";\n            }\n            echo \"\n                                </table>\n                            </td>\n                        </tr>\n                    </table>\n                \";\n                echo \"\n                </td>\n            </tr>\";\n        }\n        echo \"\n        <tr height='1'><td colspan='6' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n    }\n\n    echo \"\n        <tr>\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap>\";\n    echo \"\n            </td>\n            <td colspan='2' align='$phpAds_TextAlignRight' nowrap><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?$addUrl&amp;expand=all' accesskey='$keyExpandAll'>$strExpandAll</a>&nbsp;&nbsp;|&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?$addUrl&amp;expand=none' accesskey='$keyCollapseAll'>$strCollapseAll</a>&nbsp;&nbsp;</td>\n\n        </tr>\";\n    echo \"<tr>\n\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap> \";\n    if($editStatuses) {\n             echo \"<input type='submit' name='submit' value='$strSaveChanges' tabindex='\".($tabindex++).\"' onClick='document.connectionsmodify.submit()'>\".\"\\n\";\n    }\n\n    echo \"\n            </td>\n\n            <td colspan='2' align='$phpAds_TextAlignRight' nowrap> $strItemsPerPage $pager->pagerSelect &nbsp; $pager->pagerLinks &nbsp;&nbsp;</td>\n\n        </tr>\n\n        </table>\n        <br /><br />\n        \";\n\n    if($editStatuses) {\n        echo \"</form>\".\"\\n\";\n    }\n\n    echo \"<form id='setPager' method='get' action='stats.php?\".htmlentities($_SERVER['QUERY_STRING']).\"'>\";\n\n    $getValues = preg_split('/&/D', $_SERVER['QUERY_STRING']);\n    foreach ($getValues as $record) {\n        $filed = explode('=', $record);\n        if ($filed[0] != 'setPerPage' && $filed[0] != 'pageID') {\n            echo \"<input type='hidden' name='\". $filed[0].\"' value='\". $filed[1].\"'>\";\n        }\n    }\n\n    echo \"<input type='hidden' name='pageID'  value='1'>\";\n    echo \"<input type='hidden' name='setPerPage' id='setPerPage'>\";\n\n    echo \"</form>\";\n\necho '\n<script type=\\'text/javascript\\'>\n<!--\n\n$(document).ready(function() {\n    $(\"#setPerPageSelect\").change(updatePerPage);\n});\n\nfunction updatePerPage()\n{\n    perPage = $(\"#setPerPageSelect\").val();\n    $form = $(\"#setPager\");\n\n    $(\"#setPerPage\", $form).attr(\\'value\\', perPage);\n\n    $form.get(0).submit();\n}\n\n-->\n</script>';\n\n} else {\n    echo \"\n        <br /><br /><div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/info.gif' width='16' height='16' border='0' align='absmiddle'>$strNoStats</div>\";\n}\n\n// Store preferences\n$session['prefs'][$pageName]['hideinactive'] = $hideinactive;\n$session['prefs'][$pageName]['listorder'] = $listorder;\n$session['prefs'][$pageName]['nodes'] = implode (\",\", $aNodes);\n$session['prefs'][$pageName]['orderdirection'] = $orderdirection;\n$session['prefs'][$pageName]['day'] = $day;\n$session['prefs'][$pageName]['howLong'] = $howLong;\n$session['prefs'][$pageName]['hour'] = $hour;\n$session['prefs'][$pageName]['editStatuses'] = $editStatuses;\n$session['prefs']['GLOBALS']['period_preset'] = $period_preset;\n$session['prefs']['GLOBALS']['period_start'] = $period_start;\n$session['prefs']['GLOBALS']['period_end'] = $period_end;\nphpAds_SessionDataStore();\n\n// Display page footer\nphpAds_PageFooter();\n\n?>\n"], "fixing_code": ["<?php\n\n/*\n+---------------------------------------------------------------------------+\n| Revive Adserver                                                           |\n| http://www.revive-adserver.com                                            |\n|                                                                           |\n| Copyright: See the COPYRIGHT.txt file.                                    |\n| License: GPLv2 or later, see the LICENSE.txt file.                        |\n+---------------------------------------------------------------------------+\n*/\n\nrequire_once MAX_PATH . '/lib/max/Admin_DA.php';\nrequire_once MAX_PATH . '/www/admin/lib-statistics.inc.php';\nrequire_once LIB_PATH . '/Plugin/Component.php';\nrequire_once MAX_PATH . '/lib/OX/Util/Utils.php';\nrequire_once MAX_PATH . '/lib/OA/Admin/UI/model/InventoryPageHeaderModelBuilder.php';\n\n\nfunction MAX_getDisplayName($name, $length = 60, $append = '...')\n{\n    $displayName = strlen($name) > $length ? rtrim(substr($name, 0, $length-strlen($append))) . $append : $name;\n    if (empty($displayName)) {\n        $displayName = $GLOBALS['strUntitled'];\n    }\n    return $displayName;\n}\n\nfunction MAX_buildName($id, $name)\n{\n    return htmlspecialchars($name);\n}\n\nfunction MAX_getEntityIcon($entity, $active=true, $type='', $marketAdvertiserid = '')\n{\n    include_once MAX_PATH . '/www/admin/lib-zones.inc.php';\n\n    $icon = '';\n    switch ($entity) {\n        case 'advertiser' :\n            $do = OA_Dal::factoryDO('Clients');\n            switch($type) {\n                case DataObjects_Clients::ADVERTISER_TYPE_MARKET:\n                    $icon = 'images/icon-advertiser-openx.png';\n                break;\n                default:\n                    if($active) {\n                        $icon = 'images/icon-advertiser.gif';\n                    } else {\n                        $icon = 'images/icon-advertiser-d.gif';\n                    }\n                break;\n            }\n            break;\n\n        case 'placement'  :\n            $do = OA_Dal::factoryDO('Campaigns');\n            switch($type) {\n                case DataObjects_Campaigns::CAMPAIGN_TYPE_MARKET_CAMPAIGN_OPTIN:\n                case DataObjects_Campaigns::CAMPAIGN_TYPE_MARKET_CONTRACT:\n                case DataObjects_Campaigns::CAMPAIGN_TYPE_MARKET_ZONE_OPTIN:\n                    $icon = 'images/icon-campaigns-openx.png';\n                break;\n\n                default:\n                    if($active) {\n                        $icon = 'images/icon-campaign.gif';\n                    } else {\n                        $icon = 'images/icon-campaign-d.gif';\n                    }\n                break;\n                }\n            break;\n        case 'publisher'  : $icon = 'images/icon-affiliate.gif'; break;\n        case 'ad' :\n            switch ($type) {\n                case 'html' : $icon = $active ? 'images/icon-banner-html.gif' : 'images/icon-banner-html-d.gif'; break;\n                case 'txt'  : $icon = $active ? 'images/icon-banner-text.gif' : 'images/icon-banner-text-d.gif'; break;\n                case 'url'  : $icon = $active ? 'images/icon-banner-url.gif' : 'images/icon-banner-url-d.gif'; break;\n                case 'web'  : $icon = $active ? 'images/icon-banner-stored.gif' : 'images/icon-banner-stored-d.gif'; break;\n                default     : $icon = $active ? 'images/icon-banner-stored.gif' : 'images/icon-banner-stored-d.gif'; break;\n            }\n            break;\n        case 'zone'       :\n            switch ($type) {\n                case MAX_ZoneMarketMigrated  : $icon = 'images/icon-advertiser-openx.png'; break;\n                case phpAds_ZoneBanner       : $icon = 'images/icon-zone.gif'; break;\n                case phpAds_ZoneInterstitial : $icon = 'images/icon-interstitial.gif'; break;\n                case phpAds_ZonePopup        : $icon = 'images/icon-popup.gif'; break;\n                case phpAds_ZoneText         : $icon = 'images/icon-textzone.gif'; break;\n                case MAX_ZoneEmail           : $icon = 'images/icon-zone-email.gif'; break;\n                case MAX_ZoneClick           : $icon = 'images/icon-zone-click.gif'; break;\n                default                      : $icon = 'images/icon-zone.gif'; break;\n            }\n            break;\n    }\n    return substr($icon,0,4) == 'http' ? $icon : (OX::assetPath() . \"/\" . $icon);\n}\n\nfunction MAX_displayZoneHeader($pageName, $listorder, $orderdirection, $entityIds=null, $anonymous=false)\n{\n    global $phpAds_TextAlignRight;\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strName'], 'name', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strID'], 'id', $pageName, $entityIds, $listorder, $orderdirection, ($anonymous == false));\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strDescription'], 'description', $pageName, $entityIds, $listorder, $orderdirection);\n    echo \"\n    <tr height='1'>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='300' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td width='100%'><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n    </tr>\n    <tr height='25'>\n        <td>$column1</td>\n        <td>$column2</td>\n        <td>$column3</td>\n    </tr>\n    <tr height='1'><td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n}\n\nfunction MAX_displayStatsHeader($pageName, $listorder, $orderdirection, $entityIds=null, $anonymous=false)\n{\n    global $phpAds_TextAlignRight;\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strName'], 'name', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strID'], 'id', $pageName, $entityIds, $listorder, $orderdirection, ($anonymous == false));\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strRequests'], 'sum_requests', $pageName, $entityIds, $listorder, $orderdirection);\n    $column4 = _getHtmlHeaderColumn($GLOBALS['strImpressions'], 'sum_views', $pageName, $entityIds, $listorder, $orderdirection);\n    $column5 = _getHtmlHeaderColumn($GLOBALS['strClicks'], 'sum_clicks', $pageName, $entityIds, $listorder, $orderdirection);\n    $column6 = _getHtmlHeaderColumn($GLOBALS['strCTRShort'], 'ctr', $pageName, $entityIds, $listorder, $orderdirection);\n    $column7 = _getHtmlHeaderColumn($GLOBALS['strConversions'], 'sum_conversions', $pageName, $entityIds, $listorder, $orderdirection);\n    $column8 = _getHtmlHeaderColumn($GLOBALS['strCNVRShort'], 'cnvr', $pageName, $entityIds, $listorder, $orderdirection);\n    echo \"\n    <tr height='1'>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='200' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n    </tr>\n    <tr height='25'>\n        <td width='30%'>$column1</td>\n        <td align='$phpAds_TextAlignRight'>$column2</td>\n        <td align='$phpAds_TextAlignRight'>$column3</td>\n        <td align='$phpAds_TextAlignRight'>$column4</td>\n        <td align='$phpAds_TextAlignRight'>$column5</td>\n        <td align='$phpAds_TextAlignRight'>$column6</td>\n        <td align='$phpAds_TextAlignRight'>$column7</td>\n        <td align='$phpAds_TextAlignRight'>$column8</td>\n    </tr>\n    <tr height='1'><td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n}\n\nfunction MAX_displayStatsHistoryHeader($pageName, $listorder, $orderdirection, $entityIds=null)\n{\n    global $phpAds_TextAlignRight;\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strDays'], 'name', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strImpressions'], 'sum_views', $pageName, $entityIds, $listorder, $orderdirection);\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strClicks'], 'sum_clicks', $pageName, $entityIds, $listorder, $orderdirection);\n    $column4 = _getHtmlHeaderColumn($GLOBALS['strCTRShort'], 'ctr', $pageName, $entityIds, $listorder, $orderdirection);\n    $column5 = _getHtmlHeaderColumn($GLOBALS['strConversions'], 'sum_conversions', $pageName, $entityIds, $listorder, $orderdirection);\n    $column6 = _getHtmlHeaderColumn($GLOBALS['strCNVRShort'], 'cnvr', $pageName, $entityIds, $listorder, $orderdirection);\n    echo \"\n        <table border='0' cellpadding='0' cellspacing='0' width='100%'>\n        <tr height='1'>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='200' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        </tr>\n        <tr height='25'>\n            <td width='30%'>$column1</td>\n            <td align='$phpAds_TextAlignRight'>$column2</td>\n            <td align='$phpAds_TextAlignRight'>$column3</td>\n            <td align='$phpAds_TextAlignRight'>$column4</td>\n            <td align='$phpAds_TextAlignRight'>$column5</td>\n            <td align='$phpAds_TextAlignRight'>$column6</td>\n        </tr>\n        <tr height='1'><td colspan='7' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\n    \";\n}\n\nfunction MAX_displayNoStatsMessage()\n{\n    echo \"\n    <br /><br /><div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/info.gif' width='16' height='16' border='0' align='absmiddle'>{$GLOBALS['strNoStats']}</div>\";\n}\n\nfunction _getHtmlHeaderColumn($title, $name, $pageName, $entityIds, $listorder, $orderdirection, $showColumn = true)\n{\n    $str = '';\n    $entity = htmlspecialchars(_getEntityString($entityIds), ENT_QUOTES);\n    $pageName = htmlspecialchars($pageName, ENT_QUOTES);\n    if ($listorder == $name) {\n        if (($orderdirection == '') || ($orderdirection == 'down')) {\n            $str = \"<a href='$pageName?{$entity}orderdirection=up'><img src='\" . OX::assetPath() . \"/images/caret-ds.gif' border='0' alt='' title=''></a>\";\n        } else {\n            $str = \"<a href='$pageName?{$entity}orderdirection=down'><img src='\" . OX::assetPath() . \"/images/caret-u.gif' border='0' alt='' title=''></a>\";\n        }\n    }\n    return $showColumn ? \"<b><a href='$pageName?{$entity}listorder=\".urlencode($name).\"'>$title</a>$str</b>\" : '';\n}\n\nfunction _getEntityString($entityIds)\n{\n    $entity = '';\n    if (!empty($entityIds)) {\n        $entityArr = array();\n        foreach ($entityIds as $entityId => $entityValue) {\n            $entityArr[] = \"$entityId=\".urlencode($entityValue);\n        }\n        $entity = implode('&', $entityArr) . '&';\n    }\n\n    return $entity;\n}\n\nfunction MAX_displayDateSelectionForm($period, $period_start, $period_end, $pageName, &$tabindex, $hiddenValues = null)\n{\n    global $tabindex;\n    require_once MAX_PATH . '/lib/max/Admin/UI/FieldFactory.php';\n\n    $oDaySpan =& FieldFactory::newField('day-span');\n    $oDaySpan->_name = 'period';\n    $oDaySpan->_autoSubmit = true;\n    $oDaySpan->setValueFromArray(array('period_preset' => $period, 'period_start' => $period_start, 'period_end' => $period_end));\n    $oDaySpan->_tabIndex = $tabindex;\n    echo \"\n    <form id='period_form' name='period_form' action='$pageName'>\";\n    $oDaySpan->display();\n    $tabindex = $oDaySpan->_tabIndex;\n    echo \"\n    <input type='button' value='Go' onclick='return periodFormSubmit()' style='margin-left: 1em' tabindex='\".$tabindex++.\"' />\";\n    _displayHiddenValues($hiddenValues);\n    echo \"\n    </form>\";\n}\n\nfunction _displayHiddenValues($hiddenValues)\n{\n    if (!empty($hiddenValues) && is_array($hiddenValues)) {\n        foreach ($hiddenValues as $name => $value) {\n            echo \"\n    <input type='hidden' name='$name' value='$value'>\";\n        }\n    }\n}\n\nfunction MAX_displayPeriodSelectionForm($period, $pageName, &$tabindex, $hiddenValues = null)\n{\n    global $phpAds_TextDirection;\n\n    echo \"\n    <form action='$pageName'>\n    <select name='period' onChange='this.form.submit();' tabindex='\". $tabindex++ .\"'>\n        <option value='daily'\".($period == 'daily' ? ' selected' : '').\">{$GLOBALS['strDailyHistory']}</option>\n        <option value='w'\".($period == 'weekly' ? ' selected' : '').\">{$GLOBALS['strWeeklyHistory']}</option>\n        <option value='m'\".($period == 'monthly' ? ' selected' : '').\">{$GLOBALS['strMonthlyHistory']}</option>\n    </select>\n    &nbsp;&nbsp;\n    <input type='image' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif' border='0' name='submit'>\n    &nbsp;\";\n    _displayHiddenValues($hiddenValues);\n    echo \"\n    </form>\n    \";\n}\n\nfunction MAX_displayHistoryStatsDaily($aHistoryStats, $aTotalHistoryStats, $pageName, $hiddenValues = null)\n{\n    $i = 0;\n    $entity = _getEntityString($hiddenValues);\n    foreach ($aHistoryStats as $day => $stats) {\n        $bgColor = ($i++ % 2 == 0) ? '#F6F6F6' : '#FFFFFF';\n        $views = phpAds_formatNumber($stats['sum_views']);\n        $clicks = phpAds_formatNumber($stats['sum_clicks']);\n        $conversions = phpAds_formatNumber($stats['sum_conversions']);\n        $ctr = phpAds_buildRatioPercentage($stats['sum_clicks'], $stats['sum_views']);\n        $cnvr = phpAds_buildRatioPercentage($stats['sum_conversions'], $stats['sum_clicks']);\n        echo \"\n        <tr height='25' bgcolor='$bgColor'>\n            <td>&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-date.gif' align='absmiddle' alt=''>&nbsp;<a href='$pageName?{$entity}'>$day</a></td>\n            <td align='right'>$views</td>\n            <td align='right'>$clicks</td>\n            <td align='right'>$ctr</td>\n            <td align='right'>$conversions</td>\n            <td align='right'>$cnvr</td>\n        </tr>\n        <tr><td height='1' colspan='6' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%' alt=''></td></tr>\n        \";\n    }\n    echo \"\n    </table>\";\n}\n\nfunction MAX_displayPublisherZoneStats($aParams, $pageName, $anonymous, $aNodes, $expand, $listorder, $orderdirection, $hideinactive, $showPublisher, $entityIds)\n{\n    global $phpAds_TextAlignLeft, $phpAds_TextAlignRight, $phpAds_TextDirection;\n\n    // Get the icons for all levels (publisher/zone)\n    $entity = _getEntityString($entityIds);\n    $publishersHidden = 0;\n\n    $aPublishers = Admin_DA::fromCache('getPublishersStats', $aParams);\n    if (!empty($aPublishers)) {\n        echo \"\n        <br /><br />\n        <table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n        MAX_displayStatsHeader($pageName, $listorder, $orderdirection, $entityIds);\n\n        // Variable to determine if the row should be grey or white...\n        $i=0;\n\n        // Loop through publishers\n        $totalRequests = 0;\n        $totalViews = 0;\n        $totalClicks = 0;\n        $totalConversions = 0;\n        MAX_sortArray($aPublishers, ($listorder == 'id' ? 'publisher_id' : $listorder), $orderdirection == 'up');\n        foreach($aPublishers as $publisherId => $publisher) {\n            $publisherRequests = phpAds_formatNumber($publisher['sum_requests']);\n            $publisherViews = phpAds_formatNumber($publisher['sum_views']);\n            $publisherClicks = phpAds_formatNumber($publisher['sum_clicks']);\n            $publisherConversions = phpAds_formatNumber($publisher['sum_conversions']);\n            $publisherCtr = phpAds_buildRatioPercentage($publisher['sum_clicks'], $publisher['sum_views']);\n            $publisherSr = phpAds_buildRatioPercentage($publisher['sum_conversions'], $publisher['sum_clicks']);\n            $publisherExpanded = MAX_isExpanded($publisherId, $expand, $aNodes, 'p');\n            $publisherActive = true;\n            $publisherIcon = MAX_getEntityIcon('publisher', $publisherActive);\n\n            if (!$hideinactive || $publisherActive) {\n                $bgcolor = ($i++ % 2 == 0) ? \" bgcolor='#F6F6F6'\" : '';\n                echo \"\n            <tr height='25'$bgcolor>\n                <td>\";\n                if (!empty($publisher['num_children'])) {\n                    if ($publisherExpanded)\n                        echo \"&nbsp;<a href='$pageName?{$entity}collapse=p$publisherId'><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'></a>&nbsp;\";\n                    else\n                        echo \"&nbsp;<a href='$pageName?{$entity}expand=p$publisherId'><img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'></a>&nbsp;\";\n                }\n                else\n                    echo \"&nbsp;<img src='\" . OX::assetPath() . \"/images/spacer.gif' height='16' width='16'>&nbsp;\";\n\n                echo \"\n                    <img src='$publisherIcon' align='absmiddle'>&nbsp;\n                    <a href='stats.php?entity=affiliate&breakdown=history&affiliateid=$publisherId'>{$publisher['name']}</a>\n                </td>\";\n                if ($anonymous) {\n                    echo \"\n                <td align='$phpAds_TextAlignRight'>&nbsp;</td>\";\n                } else {\n                    echo \"\n                <td align='$phpAds_TextAlignRight'>$publisherId</td>\";\n                    }\n                    echo \"\n                <td align='$phpAds_TextAlignRight'>$publisherRequests</td>\n                <td align='$phpAds_TextAlignRight'>$publisherViews</td>\n                <td align='$phpAds_TextAlignRight'>$publisherClicks</td>\n                <td align='$phpAds_TextAlignRight'>$publisherCtr</td>\n                <td align='$phpAds_TextAlignRight'>$publisherConversions</td>\n                <td align='$phpAds_TextAlignRight'>$publisherSr</td>\n            </tr>\";\n\n                if (!empty($publisher['num_children']) && $publisherExpanded) {\n                    echo \"\n            <tr height='1'>\n                <td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n                <td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n            </tr>\";\n\n\n                    // Loop through zones\n                    $aZones = Admin_DA::fromCache('getZonesStats', $aParams);\n                    MAX_sortArray($aZones, ($listorder == 'id' ? 'zone_id' : $listorder), $orderdirection == 'up');\n                    foreach ($aZones as $zoneId => $zone) {\n                        $zoneRequests = phpAds_formatNumber($zone['sum_requests']);\n                        $zoneViews = phpAds_formatNumber($zone['sum_views']);\n                        $zoneClicks = phpAds_formatNumber($zone['sum_clicks']);\n                        $zoneConversions = phpAds_formatNumber($zone['sum_conversions']);\n                        $zoneCtr = phpAds_buildRatioPercentage($zone['sum_clicks'], $zone['sum_views']);\n                        $zoneSr = phpAds_buildRatioPercentage($zone['sum_conversions'], $zone['sum_clicks']);\n                        $zoneActive = true;\n                        $zoneIcon = MAX_getEntityIcon('zone', $zoneActive, $zone['type']);\n\n                        echo \"\n            <tr height='25'$bgcolor>\n                <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n                    <img src='\" . OX::assetPath() . \"/images/spacer.gif' height='16' width='16' align='absmiddle'>&nbsp;\n                    <img src='$zoneIcon' align='absmiddle'>&nbsp;\n                    <a href='stats.php?entity=zone&breakdown=history&affiliateid=$publisherId&zoneid=$zoneId'>{$zone['name']}</a>\n                </td>\n                <td align='$phpAds_TextAlignRight'>$zoneId</td>\n                <td align='$phpAds_TextAlignRight'>$zoneRequests</td>\n                <td align='$phpAds_TextAlignRight'>$zoneViews</td>\n                <td align='$phpAds_TextAlignRight'>$zoneClicks</td>\n                <td align='$phpAds_TextAlignRight'>$zoneCtr</td>\n                <td align='$phpAds_TextAlignRight'>$zoneConversions</td>\n                <td align='$phpAds_TextAlignRight'>$zoneSr</td>\n            </tr>\";\n                    }\n                }\n                echo \"\n                <tr height='1'><td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n            } else {\n                $publishersHidden++;\n            }\n            $totalRequests += $publisher['sum_requests'];\n            $totalViews += $publisher['sum_views'];\n            $totalClicks += $publisher['sum_clicks'];\n            $totalConversions += $publisher['sum_conversions'];\n        }\n\n        // Total\n        echo \"\n        <tr height='25'$bgcolor>\n            <td>&nbsp;&nbsp;<b>{$GLOBALS['strTotal']}</b></td>\n            <td>&nbsp;</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalRequests).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalViews).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalViews, $totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalConversions).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalClicks, $totalConversions).\"</td>\n        </tr>\n        <tr height='1'>\n            <td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n        </tr>\";\n        if (!$anonymous) {\n            $publisherIcon = MAX_getEntityIcon('publisher');\n            echo \"\n        <tr>\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap>\";\n\n            if ($hideinactive == true) {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-activate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=0'>{$GLOBALS['strShowAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;$publishersHidden {$GLOBALS['strInactivePublishersHidden']}\";\n            } else {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-hideinactivate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=1'>{$GLOBALS['strHideInactivePublishers']}</a>\";\n            }\n\n            echo \"\n            </td>\n            <td colspan='4' align='$phpAds_TextAlignRight' nowrap><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=all' accesskey='$keyExpandAll'>{$GLOBALS['strExpandAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=none' accesskey='$keyCollapseAll'>{$GLOBALS['strCollapseAll']}</a>&nbsp;&nbsp;</td>\n        </tr>\n        <tr height='25'>\";\n            if ($showPublisher == 't') {\n                echo \"\n            <td colspan='8' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='$publisherIcon' align='absmiddle'><a href='$pageName?{$entity}showpublisher=f'> Hide parent publisher</a></td>\";\n            } else {\n                echo \"\n            <td colspan='8' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='$publisherIcon' align='absmiddle'><a href='$pageName?{$entity}showpublisher=t'> Show parent publisher</a></td>\";\n            }\n            echo \"\n        </tr>\";\n        }\n        echo \"\n        </table>\n        <br /><br />\";\n    } else {\n        MAX_displayNoStatsMessage();\n    }\n}\n\nfunction MAX_displayZoneStats($aParams, $pageName, $anonymous, $aNodes, $expand, $listorder, $orderdirection, $hideinactive, $showPublisher, $entityIds)\n{\n    global $phpAds_TextAlignLeft, $phpAds_TextAlignRight, $phpAds_TextDirection;\n\n    // Get the icons for all levels (publisher/zone)\n    $entity = _getEntityString($entityIds);\n    $publishersHidden = 0;\n\n    $aZones = Admin_DA::fromCache('getZonesStats', $aParams);\n    if (!empty($aZones)) {\n        echo \"\n        <br /><br />\n        <table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n        MAX_displayStatsHeader($pageName, $listorder, $orderdirection, $entityIds, $anonymous);\n\n        // Variable to determine if the row should be grey or white...\n        $i=0;\n        $totalRequests = 0;\n        $totalViews = 0;\n        $totalClicks = 0;\n        $totalConversions = 0;\n\n        // Loop through publishers\n        MAX_sortArray($aZones, ($listorder == 'id' ? 'zone_id' : $listorder), $orderdirection == 'up');\n        foreach($aZones as $zoneId => $zone) {\n            $zoneRequests = phpAds_formatNumber($zone['sum_requests']);\n            $zoneViews = phpAds_formatNumber($zone['sum_views']);\n            $zoneClicks = phpAds_formatNumber($zone['sum_clicks']);\n            $zoneConversions = phpAds_formatNumber($zone['sum_conversions']);\n            $zoneCtr = phpAds_buildRatioPercentage($zone['sum_clicks'], $zone['sum_views']);\n            $zoneSr = phpAds_buildRatioPercentage($zone['sum_conversions'], $zone['sum_clicks']);\n            $zoneActive = true;\n            $zoneIcon = MAX_getEntityIcon('zone', $zoneActive, $zone['type']);\n\n            if (!$hideinactive || $zoneActive) {\n                $bgcolor = ($i++ % 2 == 0) ? \" bgcolor='#F6F6F6'\" : '';\n                echo \"\n        <tr height='25'$bgcolor>\n            <td>&nbsp;<img src='\" . OX::assetPath() . \"/images/spacer.gif' height='16' width='16'>&nbsp;\n                <img src='$zoneIcon' align='absmiddle'>&nbsp;\";\n                if ($anonymous) {\n                    echo \"\n                Hidden zone {$zone['id']}\";\n                } else {\n                    echo \"\n                <a href='stats.php?entity=zone&breakdown=history&affiliateid={$zone['publisher_id']}'>{$zone['name']}</a>\";\n                }\n                echo \"\n            </td>\";\n                if ($anonymous) {\n                    echo \"\n            <td align='$phpAds_TextAlignRight'>&nbsp;</td>\";\n                } else {\n                    echo \"\n            <td align='$phpAds_TextAlignRight'>$zoneId</td>\";\n                }\n                echo \"\n            <td align='$phpAds_TextAlignRight'>$zoneRequests</td>\n            <td align='$phpAds_TextAlignRight'>$zoneViews</td>\n            <td align='$phpAds_TextAlignRight'>$zoneClicks</td>\n            <td align='$phpAds_TextAlignRight'>$zoneCtr</td>\n            <td align='$phpAds_TextAlignRight'>$zoneConversions</td>\n            <td align='$phpAds_TextAlignRight'>$zoneSr</td>\n        </tr>\n        <tr height='1'><td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n            } else {\n                $publishersHidden++;\n            }\n            $totalRequests += $zone['sum_requests'];\n            $totalViews += $zone['sum_views'];\n            $totalClicks += $zone['sum_clicks'];\n            $totalConversions += $zone['sum_conversions'];\n        }\n\n        // Total\n        echo \"\n        <tr height='25'$bgcolor>\n            <td>&nbsp;&nbsp;<b>{$GLOBALS['strTotal']}</b></td>\n            <td>&nbsp;</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalRequests).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalViews).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalViews, $totalClicks).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_formatNumber($totalConversions).\"</td>\n            <td align='$phpAds_TextAlignRight'>\".phpAds_buildCTR($totalClicks, $totalConversions).\"</td>\n        </tr>\n        <tr height='1'>\n            <td colspan='8' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n        </tr>\";\n        if (!$anonymous) {\n            echo \"\n        <tr>\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap>\";\n\n            if ($hideinactive == true) {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-activate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=0'>{$GLOBALS['strShowAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;$publishersHidden {$GLOBALS['strInactivePublishersHidden']}\";\n            } else {\n                echo \"&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-hideinactivate.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}hideinactive=1'>{$GLOBALS['strHideInactivePublishers']}</a>\";\n            }\n\n            echo \"\n            </td>\n            <td colspan='4' align='$phpAds_TextAlignRight' nowrap><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=all'>{$GLOBALS['strExpandAll']}</a>&nbsp;&nbsp;|&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?{$entity}expand=none'>{$GLOBALS['strCollapseAll']}</a>&nbsp;&nbsp;</td>\n        </tr>\n        <tr height='25'>\";\n            if ($showPublisher == 't') {\n                echo \"\n            <td colspan='7' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-affiliate.gif' align='absmiddle'><a href='$pageName?{$entity}showpublisher=f'> Hide parent publisher</a></td>\";\n            } else {\n                echo \"\n            <td colspan='7' align='$phpAds_TextAlignLeft' nowrap>&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/icon-affiliate.gif' align='absmiddle'><a href='$pageName?{$entity}showpublisher=t'> Show parent publisher</a></td>\";\n            }\n            echo \"\n        </tr>\";\n        }\n        echo \"\n        </table>\n        <br /><br />\";\n    } else {\n        MAX_displayNoStatsMessage();\n    }\n}\n\nfunction MAX_displayInventoryBreadcrumbs($aEntityNamesUrls, $entityClass, $newEntity = false)\n{\n    MAX_displayInventoryBreadcrumbsInternal($aEntityNamesUrls, MAX_buildBreadcrumbPath($entityClass), $newEntity);\n}\n\nfunction MAX_displayInventoryBreadcrumbsInternal($aEntityNamesUrls, $breadcrumbPath, $newEntity = false)\n{\n    global $phpAds_breadcrumbs;\n\n    $path = array();\n\n    // Breadcrumbs above the main title\n    for ($i = 0; $i < count($aEntityNamesUrls); $i++) {\n    \t$breadcrumbInfo = MAX_buildBreadcrumbInfo($breadcrumbPath[$i]);\n\n        $path[] = array(\n            'name' => $aEntityNamesUrls[$i][\"name\"],\n            'url' => $aEntityNamesUrls[$i][\"url\"],\n            'label' => ($newEntity && $i == count($aEntityNamesUrls) -1 ? $breadcrumbInfo['newLabel'] : $breadcrumbInfo['label']),\n            'newTarget' => $breadcrumbInfo['newTarget'],\n            'cssClass' => $breadcrumbInfo['class']\n        );\n    }\n\n    $phpAds_breadcrumbs = array(\n        'path' => $path,\n        'newEntity' => $newEntity\n    );\n}\n\nfunction MAX_buildBreadcrumbInfo($entityClass)\n{\n\tswitch ($entityClass)\n\t{\n\t\tcase 'advertiser':\n\t       return array(\"label\" => $GLOBALS['strClient'], \"newLabel\" => $GLOBALS['strAddClient'], \"class\" => \"adv\");\n\n\t\tcase 'campaign':\n\t       return array(\"label\" => $GLOBALS['strCampaign'], \"newLabel\" => $GLOBALS['strAddCampaign'], \"newTarget\" => $GLOBALS['strCampaignForAdvertiser'], \"class\" => \"camp\");\n\n\t\tcase 'tracker':\n\t       return array(\"label\" => $GLOBALS['strTracker'], \"newLabel\" => $GLOBALS['strAddTracker'], \"newTarget\" => $GLOBALS['strTrackerForAdvertiser'], \"class\" => \"track\");\n\n\t\tcase 'banner':\n\t       return array(\"label\" => $GLOBALS['strBanner'], \"newLabel\" => $GLOBALS['strAddBanner'], \"newTarget\" => $GLOBALS['strBannerToCampaign'], \"class\" => \"ban\");\n\n\t\tcase 'website':\n\t       return array(\"label\" => $GLOBALS['strAffiliate'], \"newLabel\" => $GLOBALS['strAddNewAffiliate'], \"class\" => \"webs\");\n\n\t\tcase 'zone':\n            return array(\"label\" => $GLOBALS['strZone'], \"newLabel\" => $GLOBALS['strAddNewZone'], \"newTarget\" => $GLOBALS['strZoneToWebsite'], \"class\" => \"zone\");\n\n\t\tcase 'channel':\n\t       return array(\"label\" => $GLOBALS['strChannel'], \"newLabel\" => $GLOBALS['strAddNewChannel'], \"newTarget\" => $GLOBALS['strChannelToWebsite'], \"class\" => \"chan\");\n\n\t\tcase 'agency':\n\t       return array(\"label\" => $GLOBALS['strAgency'], \"newLabel\" => $GLOBALS['strAddAgency'], \"class\" => \"agen\");\n\n\t\tcase 'day':\n\t       return array(\"label\" => $GLOBALS['strDay'], \"newLabel\" => '', \"class\" => \"day\");\n\t}\n\n\treturn null;\n}\n\nfunction MAX_buildBreadcrumbPath($entityClass)\n{\n\tswitch ($entityClass)\n\t{\n\t\tcase 'banner':\n\t\tcase 'campaign':\n\t\tcase 'advertiser':\n\t\t\treturn array('advertiser', 'campaign', 'banner');\n\n\t\tcase 'tracker':\n\t\t\treturn array('advertiser', 'tracker');\n\n\t\tcase 'website':\n\t\tcase 'zone':\n\t\t\treturn array('website', 'zone');\n\n\t\tcase 'trafficker-zone':\n\t\t\treturn array('zone');\n\n\t\tcase 'channel':\n\t\t\treturn array('website', 'channel');\n\n\t\tcase 'global-channel':\n\t\t\treturn array('channel');\n\n\t\tcase 'agency':\n\t\t\treturn array('agency');\n\t}\n\n\treturn null;\n}\n\n/**\n * Builds header model for advertiser edit page tabs\n *\n * @param mixed $idOrAdvertiser - either advertiser id or advertiser array\n * @return OA_Admin_UI_Model_PageHeaderModel\n */\nfunction buildAdvertiserHeaderModel($idOrAdvertiser)\n{\n    if (is_array($idOrAdvertiser)) {\n        $aAdvertiser = $idOrAdvertiser;\n    }\n    else if (!empty($idOrAdvertiser)) {\n        $aAdvertiser = phpAds_getClientDetails($idOrAdvertiser);\n    }\n    else {\n        $aAdvertiser = array();\n    }\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $pageType = empty($aAdvertiser['clientid']) ? 'edit-new' : 'edit';\n\n    $oHeaderModel = $builder->buildEntityHeader(array(\n        array(\"name\" => $aAdvertiser['clientname'])),\n        \"advertiser\", $pageType);\n    return $oHeaderModel;\n}\n\nfunction MAX_displayTrackerBreadcrumbs($clientid, $trackerid = null)\n{\n\tif ($trackerid) {\n        $parentClientId = phpAds_getTrackerParentClientID($trackerid);\n        $tracker = phpAds_getTrackerDetails($trackerid);\n        $trackerName = $tracker['trackername'];\n        $pageType = 'edit';\n\t}\n\telse {\n\t\t$parentClientId = $clientid;\n\t\t$trackerName = \"\";\n\t\t$pageType = 'edit-new';\n\t}\n    $advertiserEditUrl = \"advertiser-edit.php?clientid=$parentClientId\";\n    $advertiser = phpAds_getClientDetails($parentClientId);\n    $advertiserName = $advertiser['clientname'];\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                        array(\"name\" => $advertiserName, \"url\" => $advertiserEditUrl),\n                                        array(\"name\" => $trackerName)),\n                                        'tracker', $pageType);\n\n    return $oHeaderModel;\n}\n\nfunction MAX_displayWebsiteBreadcrumbs($affiliateid)\n{\n\tif ($affiliateid) {\n\t\t$publisher = Admin_DA::getPublisher($affiliateid);\n        $websiteName = $publisher['name'];\n        $pageType = \"edit\";\n\t}\n\telse {\n\t\t$websiteName = \"\";\n\t\t$pageType = \"edit-new\";\n\t}\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n\t    array(\"name\" => $websiteName)), \"website\", $pageType);\n\n\treturn $oHeaderModel;\n}\n\n\n\n\nfunction MAX_displayNavigationPublisher($pageName, $aOtherPublishers, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $publisherId = $aEntities['affiliateid'];\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['affiliateid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n\n    // Determine which tab is highlighted\n    switch ($pageName) {\n        case 'affiliate-channels.php' : $tabValue = '4.2.4'; break;\n    }\n\n    // Sort the publishers by name...\n    require_once(MAX_PATH . '/lib/max/other/stats.php');\n    MAX_displayInventoryBreadcrumbs(array(array(\"name\" => $publisherName)), \"website\");\n    phpAds_PageHeader($tabValue, $extra = '');\n}\n\n\nfunction MAX_displayZoneEntitySelection($entity, $aOtherAdvertisers, $aOtherPlacements, $aOtherAds, $advertiserId, $placementId, $adId, $publisherId, $zoneId, $title, $pageName, &$tabIndex)\n{\n    echo \"\n<br />$title<br /><br />\n<table cellpadding='0' cellspacing='0' border='0'>\n<tr>\";\n    $aSavedEntities = array('affiliateid' => $publisherId, 'zoneid' => $zoneId);\n    _displayZoneEntitySelectionCell('advertiser', $advertiserId, $aOtherAdvertisers, 'clientid', $aSavedEntities, ($entity != 'advertiser'), $pageName, $tabIndex);\n\n    if (!empty($advertiserId) && $entity != 'advertiser') {\n        $aSavedEntities['clientid'] = $advertiserId;\n        _displayZoneEntitySelectionCell('placement', $placementId, $aOtherPlacements, 'campaignid', $aSavedEntities, ($entity != 'placement'), $pageName, $tabIndex);\n\n        if (!empty($placementId) && $entity != 'placement') {\n            $aSavedEntities['campaignid'] = $placementId;\n            _displayZoneEntitySelectionCell('ad', $adId, $aOtherAds, 'bannerid', $aSavedEntities, ($entity != 'ad'), $pageName, $tabIndex);\n        }\n    }\n    echo \"\n</tr>\n</table>\n<br /><br />\";\n}\n\nfunction _displayZoneEntitySelectionCell($entity, $entityId, $aOtherEntities, $entityIdName, $aSavedEntities, $autoSubmit, $pageName, &$tabIndex)\n{\n    global $phpAds_TextDirection;\n\n    $onChange = $autoSubmit ? \" onChange='this.form.submit();'\" : '';\n    $submitIcon = $autoSubmit ? '' : \"&nbsp;<input type='hidden' name='action' value='set'><input id='link_submit' name='submitimage' id='submitimage' type='image' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif' border='0' tabindex='\".($tabIndex++).\"'>\";\n    $tabInfo = \" tabindex='\" . ($tabIndex++) . \"'\";\n    $entityIcon = MAX_getEntityIcon($entity);\n    echo \"\n<td>\n<form name='zonetypeselection' method='get' action='$pageName'>\";\n    foreach($aSavedEntities as $savedEntityName => $savedEntityId) {\n        echo \"\n<input type='hidden' name='$savedEntityName' value='$savedEntityId'>\";\n    }\n    echo \"\n    &nbsp;&nbsp;<img src='$entityIcon' align='absmiddle'>&nbsp;\n    <select name='$entityIdName'{$onChange}{$tabInfo}>\";\n    // Show an empty value in the dropdown if none is selected\n    if (empty($entityId)) {\n        switch ($entity) {\n            case 'advertiser' : $description = \"-- {$GLOBALS['strSelectAdvertiser']} --\"; break;\n            case 'placement'  : $description = \"-- {$GLOBALS['strSelectPlacement']} --\"; break;\n            case 'ad' : $description = \"-- {$GLOBALS['strSelectAd']} --\"; break;\n            default : $description = '';\n        }\n        echo \"\n        <option value='' selected>$description</option>\";\n    }\n\n    $aOtherEntities = _multiSort($aOtherEntities, 'name', 'advertiser_id');\n    foreach ($aOtherEntities as $aOtherEntity) {\n        switch ($entity) {\n            case 'advertiser':\n                $otherEntityId = $aOtherEntity['advertiser_id'];\n                break;\n            case 'placement':\n                $otherEntityId = $aOtherEntity['placement_id'];\n                break;\n            case 'ad':\n                $otherEntityId = $aOtherEntity['ad_id'];\n                break;\n        }\n        $selected = $otherEntityId == $entityId ? ' selected' : '';\n\n        $adsCount = '';\n        if ($entity == 'placement') {\n            $aParams = array('placement_id' => $otherEntityId);\n            $aParams += MAX_getLinkedAdParams($GLOBALS['zoneId']);\n\n            $doCampaign = OA_Dal::factoryDO('campaigns');\n            $doCampaign->campaignid = $otherEntityId;\n            $doCampaign->find();\n            $doCampaign->fetch();\n\n            if($doCampaign->type == DataObjects_Campaigns::CAMPAIGN_TYPE_DEFAULT) {\n                $translation = new OX_Translation();\n                $aStringParams[\"bannerCount\"] = count(Admin_DA::getAds($aParams));\n                $translated = $translation->translate($GLOBALS['strWithXBanners'], $aStringParams);\n                $adsCount = \"(\" .$translated.\")\";\n            }\n        }\n\n        $name = MAX_buildName($otherEntityId, $aOtherEntity['name']);\n        echo \"\n        <option value='$otherEntityId'{$selected}>\".$name.\" $adsCount</option>\";\n    }\n    echo \"\n    </select>\n    $submitIcon\n</form>\n</td>\";\n}\n\nfunction MAX_displayLinkedAdsPlacements($aParams, $publisherId, $zoneId, $hideInactive, $showParentPlacements, $pageName, &$tabIndex)\n{\n    global $phpAds_TextDirection, $phpAds_TextAlignRight;\n\n    echo \"\n<table id='linked-banners' width='100%' border='0' align='center' cellspacing='0' cellpadding='0'>\n<tr height='25'>\n<td width='40%'><b>&nbsp;&nbsp;{$GLOBALS['strName']}</b></td>\n<td><b>{$GLOBALS['strID']}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></td>\n<td>&nbsp;</td>\n</tr>\n<tr height='1'>\n<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n</tr>\";\n    $i = 0;\n    $inactive = 0;\n    $aPlacements = !empty($aParams) ? Admin_DA::getPlacements($aParams) : array();\n    foreach ($aPlacements as $placementId => $aPlacement) {\n        $aAds = Admin_DA::getAds($aParams + array('placement_id' => $placementId), true);\n        $placementActive = $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING;\n        if (!$hideInactive || $placementActive) {\n            $bgcolor = $i % 2 == 0 ? \" bgcolor='#F6F6F6'\" : '';\n            if ($showParentPlacements) {\n                $placementIcon = MAX_getEntityIcon('placement', $placementActive);\n                $placementName = MAX_getDisplayName($aPlacement['name']);\n                $placementLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='campaign-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId'>$placementName</a>\" : $placementName;\n                if ($i > 0) {\n                    echo \"\n<tr height='1'>\n<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n</tr>\";\n            }\n            echo \"\n<tr height='25'$bgcolor>\n<td>\n    &nbsp;&nbsp;<img src='$placementIcon' align='absmiddle'>\n    &nbsp;$placementLink\n</td>\n<td>$placementId</td>\n<td>&nbsp;</td>\n</tr>\";\n            }\n            foreach ($aAds as $adId => $aAd) {\n                $adActive = ($aAd['status'] == OA_ENTITY_STATUS_RUNNING && $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING);\n                if (!$hideInactive || $adActive) {\n                    $adIcon = MAX_getEntityIcon('ad', $adActive, $aAd['type']);\n                    $adName = htmlspecialchars(MAX_getDisplayName($aAd['name']));\n                    $adLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='banner-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId&bannerid=$adId'>$adName</a>\" : $adName;\n                    $adWidth = $aAd['contenttype'] == 'txt' ? 300 : $aAd['width'] + 64;\n                    $adHeight = $aAd['contenttype'] == 'txt' ? 200 : $aAd['height'] + (!empty($aAd['bannertext']) ? 90 : 64);\n                    echo \"\n<tr height='1'>\n<td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n<td colspan='2' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-el.gif' height='1' width='100%'></td>\n</tr>\n<tr height='25'$bgcolor>\n<td>\n    &nbsp;&nbsp;<a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&bannerid=$adId&action=remove'><img src='\" . OX::assetPath() . \"/images/caret-l.gif' border='0' align='absmiddle'></a>\n    &nbsp;&nbsp;&nbsp;&nbsp;<img src='$adIcon' align='absmiddle'>&nbsp;$adLink</td>\n<td>$adId</td>\n<td align='$phpAds_TextAlignRight'>\n    <img src='\" . OX::assetPath() . \"/images/icon-zoom.gif' align='absmiddle' border='0'>&nbsp;<a href='banner-htmlpreview.php?bannerid=$adId' target='_new' onClick=\\\"return openWindow('banner-htmlpreview.php?bannerid=$adId', '', 'status=no,scrollbars=no,resizable=no,width=$adWidth,height=$adHeight');\\\">{$GLOBALS['strShowBanner']}</a>&nbsp;&nbsp;\n</td>\n</tr>\";\n                } else {\n                    $inactive++;\n                }\n            }\n            $i++;\n        } else {\n            $inactive += count($aAds);\n        }\n    }\n    $showParentText = $showParentPlacements ? $GLOBALS['strHideParentCampaigns'] : $GLOBALS['strShowParentCampaigns'];\n    $showParentValue = $showParentPlacements ? '0': '1';\n    $hideInactiveText = $hideInactive ? $GLOBALS['strShowAll'] : $GLOBALS['strHideInactiveBanners'];\n    $hideInactiveStats = $hideInactive ? \"&nbsp;&nbsp;|&nbsp;&nbsp;$inactive {$GLOBALS['strInactiveBannersHidden']}\" : '';\n    $hideInactiveValue = $hideInactive ? '0' : '1';\n    $hideInactiveIcon = OX::assetPath($hideInactive ? 'images/icon-activate.gif' : 'images/icon-hideinactivate.gif');\n    echo \"\n<tr height='1'>\n<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n</tr>\n<tr height='25'>\n<td colspan='2'>\n    <img src='$hideInactiveIcon' align='absmiddle' border='0'>\n    <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&hideinactive=$hideInactiveValue'>$hideInactiveText</a>$hideInactiveStats\n</td>\n<td align='right'>\n    <img src='\" . OX::assetPath() . \"/images/icon-campaign-d.gif' align='absmiddle' border='0'>\n    <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&showcampaigns=$showParentValue'>$showParentText</a>\n</table>\";\n}\n\nfunction MAX_displayLinkedPlacementsAds($aParams, $publisherId, $zoneId, $hideInactive, $showMatchingAds, $pageName, &$tabIndex, $directLinkedAds=false)\n    {\n        echo \"\n    <br /><strong>{$GLOBALS['strCampaignLinkedAds']}:</strong><br />\n    <table id='linked-campaigns' width='100%' border='0' align='center' cellspacing='0' cellpadding='0'>\n    <tr height='25'>\n        <td width='40%'><b>&nbsp;&nbsp;{$GLOBALS['strName']}</b></td>\n        <td width='20%'><b>&nbsp;&nbsp;{$GLOBALS['strType']}</b></td>\n        <td><b>{$GLOBALS['strID']}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></td>\n        <td>&nbsp;</td>\n    </tr>\n    <tr height='1'>\n        <td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n    </tr>\";\n\n        $i = 0;\n        $inactive = 0;\n        $aPlacements = (!empty($aParams)) ? Admin_DA::getPlacements($aParams) : array();\n        foreach ($aPlacements as $placementId => $aPlacement) {\n            $placementActive = $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING;\n            if (!$hideInactive || $placementActive) {\n                $pParams = $aParams;\n                $pParams['placement_id'] = $placementId;\n                $aAds = Admin_DA::getAds($pParams, true);\n                $bgcolor = $i % 2 == 0 ? \" bgcolor='#F6F6F6'\" : '';\n                // Remove these ad(s) from the direct linked ads\n                foreach ($aAds as $dAdId) {\n                    unset($directLinkedAds[$dAdId['ad_id']]);\n                }\n\n                // Remove from array any ads not linked to the zone.\n                // These might exist if campaign has been linked to zone\n                // and indivual ads have then been unlinked\n                $pParams = array('zone_id' => $zoneId);\n                $aAdZones = Admin_DA::getAdZones($pParams, true);\n                $aAdZoneLinks = array();\n                foreach($aAdZones as $aAdZone) {\n                    $aAdZoneLinks[] = $aAdZone['ad_id'];\n                }\n                foreach($aAds as $adId => $aAd) {\n                    if (!in_array($adId, $aAdZoneLinks)) {\n                        unset($aAds[$adId]);\n                    }\n                }\n\n                $placementIcon = MAX_getEntityIcon('placement', $placementActive);\n                $placementName = htmlspecialchars(MAX_getDisplayName($aPlacement['name']));\n                $placementLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='campaign-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId'>$placementName</a>\" : $placementName;\n                $placementTypeName = OX_Util_Utils::getCampaignTypeName($aPlacement['priority']);\n                $adCount = empty($aAds) ? 0 : count($aAds);\n                $placementDescription = $showMatchingAds ? '&nbsp;' : str_replace('{count}', $adCount, $GLOBALS['strMatchingBanners']);\n                if ($i > 0) {\n                    echo \"\n    <tr height='1'>\n        <td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n    </tr>\";\n                }\n                echo \"\n    <tr height='25'$bgcolor>\n        <td>\n            &nbsp;&nbsp;<a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&campaignid=$placementId&action=remove'><img src='\" . OX::assetPath() . \"/images/caret-l.gif' border='0' align='absmiddle'></a>\n            &nbsp;&nbsp;<img src='$placementIcon' align='absmiddle'>\n            &nbsp;$placementLink\n        </td>\n        <td><span class='campaign-type'>$placementTypeName</span></td>\n        <td>$placementId</td>\n        <td>$placementDescription</td>\n    </tr>\";\n                if ($showMatchingAds && !empty($aAds)) {\n                    foreach ($aAds as $adId => $aAd) {\n                        $adActive = ($aAd['status'] == OA_ENTITY_STATUS_RUNNING && $aPlacement['status'] == OA_ENTITY_STATUS_RUNNING);\n                        if (!$hideInactive || $adActive) {\n                            $adIcon = MAX_getEntityIcon('ad', $adActive, $aAd['type']);\n                            $adName = htmlspecialchars(MAX_getDisplayName($aAd['name']));\n                            $adLink = (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) ? \"<a href='banner-edit.php?clientid={$aPlacement['advertiser_id']}&campaignid=$placementId&bannerid=$adId'>$adName</a>\" : $adName;\n                            $adWidth = $aAd['contenttype'] == 'txt' ? 300 : $aAd['width'] + 64;\n                            $adHeight = $aAd['contenttype'] == 'txt' ? 200 : $aAd['height'] + (!empty($aAd['bannertext']) ? 90 : 64);\n                            echo \"\n    <tr height='1'>\n        <td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n        <td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-el.gif' height='1' width='100%'></td>\n    </tr>\n    <tr height='25'$bgcolor>\n        <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src='$adIcon' align='absmiddle'>&nbsp;$adLink</td>\n        <td></td>\n        <td>$adId</td>\n        <td align=\".$GLOBALS['phpAds_TextAlignRight'].\">\n            <img src='\" . OX::assetPath() . \"/images/icon-zoom.gif' align='absmiddle' border='0'>&nbsp;<a href='banner-htmlpreview.php?bannerid=$adId' target='_new' onClick=\\\"return openWindow('banner-htmlpreview.php?bannerid=$adId', '', 'status=no,scrollbars=no,resizable=no,width=$adWidth,height=$adHeight');\\\">{$GLOBALS['strShowBanner']}</a>&nbsp;&nbsp;\n        </td>\n    </tr>\";\n                        } else {\n                            $inactive++;\n                        }\n                    }\n                }\n                $i++;\n            } else {\n                $inactive++;\n            }\n        }\n        $showMatchingText = $showMatchingAds ? $GLOBALS['strHideMatchingBanners'] : $GLOBALS['strShowMatchingBanners'];\n        $showMatchingValue = $showMatchingAds ? '0' : '1';\n        $hideInactiveText = $hideInactive ? $GLOBALS['strShowAll'] : $GLOBALS['strHideInactiveCampaigns'];\n        $hideInactiveStats = $hideInactive ? \"&nbsp;&nbsp;|&nbsp;&nbsp;$inactive {$GLOBALS['strInactiveCampaignsHidden']}\" : '';\n        $hideInactiveValue = $hideInactive ? '0' : '1';\n        $hideInactiveIcon = OX::assetPath($hideInactive ? 'images/icon-activate.gif' : 'images/icon-hideinactivate.gif');\n        echo \"\n    <tr height='1'>\n        <td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\n    </tr>\n    <tr height='25'>\n        <td colspan='3'>\n            <img src='$hideInactiveIcon' align='absmiddle' border='0'>\n            <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&hideinactive=$hideInactiveValue'>$hideInactiveText</a>$hideInactiveStats\n        </td>\n        <td align='right'>\n            <img src='\" . OX::assetPath() . \"/images/icon-banner-stored-d.gif' align='absmiddle' border='0'>\n            <a href='$pageName?affiliateid=$publisherId&zoneid=$zoneId&showbanners=$showMatchingValue'>$showMatchingText</a>\n    </table>\";\n        if (!empty($directLinkedAds)) {\n            echo \"<br /><strong>{$GLOBALS['strBannerLinkedAds']}:</strong><br />\";\n            $aParams = array('ad_id' => implode(',', array_keys($directLinkedAds)));\n            MAX_displayLinkedAdsPlacements($aParams, $publisherId, $zoneId, $hideInactive, $showParentPlacements, $pageName, $tabIndex);\n        }\n    }\n\nfunction MAX_displayPlacementAdSelectionViewForm($publisherId, $zoneId, $view, $pageName, &$tabIndex, $aOtherZones = array())\n{\n    global $phpAds_TextDirection;\n\n    $disabled = null;\n    $disabledHidden = null;\n    if (!empty($aOtherZones[$zoneId]['type'])) {\n        if ($aOtherZones[$zoneId]['type'] == MAX_ZoneEmail) {\n            $view = 'ad';\n            $disabled = ' disabled';\n            $disabledHidden = \"<input type='hidden' name='view' value='ad' />\";\n        }\n    }\n    $placementSelected = $view == 'placement' ? ' selected' : '';\n    $categorySelected = $view == 'category' ? ' selected' : '';\n    $adSelected = $view == 'ad' ? ' selected' : '';\n\n    echo \"\n<form name='zoneview' method='post' action='$pageName'>\n<input type='hidden' name='zoneid' value='$zoneId'>\n<input type='hidden' name='affiliateid' value='$publisherId'>\n<table border='0' width='100%' cellpadding='0' cellspacing='0'>\n<tr height='25'>\n<td colspan='3'><b>{$GLOBALS['strSelectZoneType']}</b></td>\n</tr>\n<tr height='25'>\n<td>\n    <select name='view' onchange='this.form.submit();' $disabled>\n        <option value='placement'$placementSelected>{$GLOBALS['strCampaignDefaults']}</option>\n        <!--option value='category'$categorySelected>{$GLOBALS['strLinkedCategories']}</option-->\n        <option value='ad'$adSelected>{$GLOBALS['strLinkedBanners']}</option>\n    </select>\n    &nbsp;<input type='image' id='link_type_submit' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif' border='0'>\n    $disabledHidden\n</td>\n</tr>\n</table>\n</form>\";\n    phpAds_ShowBreak();\n    echo \"\n<br />\";\n}\n\nfunction MAX_displayAcls($acls, $aParams)\n{\n    $tabindex =& $GLOBALS['tabindex'];\n    $page = basename($_SERVER['SCRIPT_NAME']);\n    $conf = $GLOBALS['_MAX']['CONF'];\n\n    echo \"<form action='{$page}' method='post'>\";\n    echo \"<input type='hidden' name='token' value='\".urlencode(phpAds_SessionGetToken()).\"' />\";\n\n    echo \"<label><img src='\" . OX::assetPath() . \"/images/icon-acl-add.gif' align='absmiddle'>&nbsp;\". $GLOBALS['strACLAdd'] .\": &nbsp;\";\n    echo \"<select name='type' accesskey='{$GLOBALS['keyAddNew']}' tabindex='\".($tabindex++).\"'>\";\n\n    $deliveryLimitations = OX_Component::getComponents('deliveryLimitations', null, false);\n    foreach ($deliveryLimitations as $pluginName => $plugin) {\n        if ($plugin->isAllowed($page)) {\n            echo \"<option value='{$pluginName}'>\" . $plugin->getName() . \"</option>\";\n        }\n    }\n\n    echo \"</select></label>\";\n    echo \"&nbsp;\";\n    echo \"<input type='submit' class='flat' name='action[new]' value='\" . $GLOBALS['strAdd'] . \"'\";\n\n    phpAds_ShowBreak();\n    echo \"<br />\";\n    $aErrors = OX_AclCheckInputsFields($acls, $page);\n    if (!empty($GLOBALS['action'])) {\n        // We are part way through making changes, show a message\n        //echo \"<br>\";\n        echo \"<div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/warning.gif' align='absmiddle'>\";\n        echo \"<span class='tab-s'>{$GLOBALS['strUnsavedChanges']}</span><br>\";\n        echo \"</div>\";\n    }\n    elseif (!MAX_AclValidate($page, $aParams)) {\n        echo \"<div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/warning.gif' align='absmiddle'>\";\n        echo \"<span class='tab-r'>{$GLOBALS['strDeliveryLimitationsDisagree']}</span><br>\";\n        echo \"</div>\";\n    }\n\n    if ($aErrors  !== true) {\n        echo \"<div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/warning.gif' align='absmiddle'>\";\n        echo \"<span class='tab-s'>{$GLOBALS['strDeliveryLimitationsInputErrors']}</span><br><ul>\";\n        foreach ($aErrors as $error) {\n            echo \"<li><span class='tab-s'>{$error}</span><br></li>\";\n        }\n        echo \"</ul></div>\";\n    }\n\n    foreach ($aParams as $name => $value) {\n        echo \"<input type='hidden' name='{$name}' value='{$value}' />\";\n    }\n    echo \"<table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n    echo \"<tr><td height='25' colspan='4' bgcolor='#FFFFFF'><b>{$GLOBALS['strDeliveryLimitations']}</b></td></tr>\";\n    echo \"<tr><td height='1' colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n\n    if (empty($acls)) {\n        echo \"<tr><td height='24' colspan='4' bgcolor='#F6F6F6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$GLOBALS['strNoLimitations']}</td></tr>\";\n        echo \"<tr><td height='1' colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n    } else {\n        echo \"<tr><td height='25' colspan='4' bgcolor='#F6F6F6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$GLOBALS['strOnlyDisplayWhen']}</td></tr>\";\n        echo \"<tr><td colspan='4'><img src='\" . OX::assetPath() . \"/images/break-el.gif' width='100%' height='1'></td></tr>\";\n\n        foreach ($acls as $aclId => $acl) {\n            if ($deliveryLimitationPlugin = OA_aclGetComponentFromRow($acl)) {\n                $deliveryLimitationPlugin->init($acl);\n                $deliveryLimitationPlugin->count = count($acls);\n                if ($deliveryLimitationPlugin->isAllowed($page)) {\n                    $deliveryLimitationPlugin->display();\n                }\n            }\n        }\n    }\n\n    echo \"<tr><td height='30' colspan='2'>\";\n\n    if (!empty($acls)) {\n        $url = $page . '?';\n        foreach ($aParams as $name => $value) {\n            $url .= \"{$name}={$value}&\";\n        }\n        $url .= \"action[clear]=true\";\n        echo \"<img src='\" . OX::assetPath() . \"/images/icon-recycle.gif' border='0' align='absmiddle'>&nbsp;\n                <a href='{$url}'>{$GLOBALS['strRemoveAllLimitations']}</a>&nbsp;&nbsp;&nbsp;&nbsp;\n        \";\n    }\n\n    echo \"</td><td height='30' colspan='2' align='{$GLOBALS['phpAds_TextAlignRight']}'>\";\n    echo \"</td></tr>\";\n\n    echo \"</table>\";\n}\n\nfunction MAX_displayChannels($channels, $aParams) {\n    $entityString = _getEntityString($aParams);\n    echo \"<table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n\n    echo \"<tr height='25'><td height='25'><b>&nbsp;&nbsp;{$GLOBALS['strName']}</a></b></td>\";\n\n    echo \"<td height='25'><b>{$GLOBALS['strID']}</a></td>\";\n    echo \"<td height='25'>&nbsp;</td>\";\n    echo \"</tr>\";\n\n    echo \"<tr height='1'><td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n\n    if (empty($channels)) {\n        echo \"<tr height='25' bgcolor='#F6F6F6'><td height='25' colspan='3'>\";\n        echo \"&nbsp;&nbsp;{$GLOBALS['strNoChannels']}</td></tr>\";\n\n        echo \"<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n    } else {\n        $i = 0;\n        foreach ($channels as $channelId => $channel) {\n            if ($i > 0) echo \"<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td>\";\n            echo \"<tr height='25' \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\">\";\n            echo \"<td height='25'>&nbsp;&nbsp;\";\n            echo \"<img src='\" . OX::assetPath() . \"/images/icon-channel.gif' align='absmiddle'>&nbsp;\";\n\n            // set channel ownership info for display\n            if ($GLOBALS['pageName'] != 'affiliate-channels.php') {\n                if (!empty($channel['publisher_id'])) {\n                    $ownerTypeStr = 'Publisher: ';\n                    $publisher = Admin_DA::getPublisher($channel['publisher_id']);\n                    $ownerNameStr = '[id'.$channel['publisher_id'].'] '.$publisher['name'];\n                } else if (!empty($channel['agency_id']) && empty($channel['publisher_id'])\n                       && !OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n                    $ownerTypeStr = 'Agency: ';\n                    $agency = Admin_DA::getAgency($channel['agency_id']);\n                    $ownerNameStr = '[id'.$channel['agency_id'].'] '.$agency['name'];\n                } else {\n                    $ownerTypeStr = '';\n                    $ownerNameStr = '';\n                }\n            }\n            $ownerStr = !empty($ownerTypeStr) ? '&nbsp&nbsp<i>'.$ownerTypeStr.'</i>'.htmlspecialchars($ownerNameStr) : '';\n\n            echo \"<a href='channel-edit.php?{$entityString}channelid={$channel['channel_id']}'>\".htmlspecialchars($channel['name'].$ownerStr).\"</a>\";\n            echo \"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\";\n            echo \"</td>\";\n            echo \"<td height='25'>{$channel['channel_id']}</td>\";\n            echo \"<td>&nbsp;</td></tr>\";\n\n            // Description\n            echo \"<tr height='25' \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\">\";\n            echo \"<td>&nbsp;</td>\";\n            echo \"<td height='25' colspan='3'>\".htmlspecialchars(stripslashes($channel['description'])).\"</td>\";\n            echo \"</tr>\";\n\n            echo \"<tr height='1'>\";\n            echo \"<td \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\"><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\";\n            echo \"<td colspan='3' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\";\n            echo \"</tr>\";\n            echo \"<tr height='25' \".($i%2==0?\"bgcolor='#F6F6F6'\":\"\").\">\";\n\n            // Empty\n            echo \"<td>&nbsp;</td>\";\n\n            // Buttons\n            echo \"<td height='25' colspan='3'>\";\n\n            echo \"<img src='\" . OX::assetPath() . \"/images/icon-acl.gif' border='0' align='absmiddle' alt='{$GLOBALS['strIncludedBanners']}'>&nbsp;<a href='channel-acl.php?{$entityString}channelid={$channel['channel_id']}'>{$GLOBALS['strEditChannelLimitations']}</a>&nbsp;&nbsp;&nbsp;&nbsp;\";\n            echo \"<img src='\" . OX::assetPath() . \"/images/icon-recycle.gif' border='0' align='absmiddle' alt='{$GLOBALS['strDelete']}'>&nbsp;<a href='channel-delete.php?token=\" . urlencode(phpAds_SessionGetToken()) . \"&{$entityString}channelid={$channel['channel_id']}&returnurl=\".(empty($aParams['affiliateid']) ? 'channel-index.php' : 'affiliate-channels.php').\"'\".phpAds_DelConfirm($GLOBALS['strConfirmDeleteChannel']).\">{$GLOBALS['strDelete']}</a>&nbsp;&nbsp;&nbsp;&nbsp;\";\n\n            echo \"</td></tr>\";\n            $i++;\n        }\n        if (!empty($channels)) {\n            echo \"<tr height='1'><td colspan='4' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n        }\n    }\n    echo \"</table>\";\n}\n\n/**\n * Show a confirm message for zone delete\n *\n * @param int $zoneId Zone ID\n * @return string\n */\nfunction MAX_zoneDelConfirm($zoneId)\n{\n    $dalZones = OA_Dal::factoryDAL('zones');\n    return phpAds_DelConfirm(\n                ($dalZones->checkZoneLinkedToActiveCampaign($zoneId)) ?\n                    $GLOBALS['strConfirmDeleteZoneLinkActive'] . '\\n' . $GLOBALS['strConfirmDeleteZone']\n                    : $GLOBALS['strConfirmDeleteZone']\n           );\n}\n\nfunction OX_Display_ConversionWindowHTML($varName, $windowSeconds, &$tabindex, $enabled = true)\n{\n    $window = _secondsToWindowArray($windowSeconds);\n    echo \"\n        \" . (($enabled) ? \"<input id='{$varName}daytrk' class='flat' type='text' size='3' name='{$varName}day' value='{$window['days']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['days']) . \" {$GLOBALS['strDays']} &nbsp;&nbsp;\n        \" . (($enabled) ? \"<input id='{$varName}hourtrk' class='flat' type='text' size='3' name='{$varName}hour' value='{$window['hours']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['hours']) . \" {$GLOBALS['strHours']} &nbsp;&nbsp;\n        \" . (($enabled) ? \"<input id='{$varName}minutetrk' class='flat' type='text' size='3' name='{$varName}minute' value='{$window['minutes']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['minutes']) . \" {$GLOBALS['strMinutes']} &nbsp;&nbsp;\n        \" . (($enabled) ? \"<input id='{$varName}secondtrk' class='flat' type='text' size='3' name='{$varName}second' value='{$window['seconds']}' onKeyUp=\\\"phpAds_formLimitUpdate();\\\" tabindex='\".($tabindex++).\"' />\" : $window['seconds']) . \" {$GLOBALS['strSeconds']} &nbsp;&nbsp;\n    \";\n}\n\n// Determine whether an advertiser has an active placement/ad running under it...\nfunction _isAdvertiserActive($aAdvertiserPlacementAd)\n{\n    $active = false;\n    if (isset($aAdvertiserPlacementAd['children'])) {\n        foreach($aAdvertiserPlacementAd['children'] as $aPlacementAd) {\n            if (_isPlacementActive($aPlacementAd)) {\n                $active = true;\n                break;\n            }\n        }\n    }\n    return $active;\n}\n\n// Determine whether a placement has an active ad running under it...\nfunction _isPlacementActive($aPlacementAd)\n{\n    $active = false;\n    if ($aPlacementAd['status'] == OA_ENTITY_STATUS_RUNNING) {\n        if (isset($aPlacementAd['children'])) {\n            foreach($aPlacementAd['children'] as $aAd) {\n                if ($aAd['status'] == OA_ENTITY_STATUS_RUNNING) {\n                    $active = true;\n                    break;\n                }\n            }\n        }\n    }\n    return $active;\n}\n\n// Determine whether a publisher is active...\nfunction _isPublisherActive($aPublisherZone)\n{\n    return true;  // for now, all publishers are active.\n}\n\n// Determine whether a zone is active...\nfunction _isZoneActive($aZone)\n{\n    return true;  // for now, all zones are active.\n}\n\nfunction _secondsToWindowArray($seconds)\n{\n    $return['days'] = floor($seconds / (60*60*24));\n    $seconds = $seconds % (60*60*24);\n    $return['hours'] = floor($seconds / (60*60));\n    $seconds = $seconds % (60*60);\n    $return['minutes'] = floor($seconds / (60));\n    $seconds = $seconds % (60);\n    $return['seconds'] = $seconds;\n    return $return;\n}\n\nfunction _windowValuesToseconds($days, $hours, $minutes, $seconds)\n{\n    $days =    ($days > 0)    ? $days    : 0;\n    $hours =   ($hours > 0)   ? $hours   : 0;\n    $minutes = ($minutes > 0) ? $minutes : 0;\n    $seconds = ($seconds > 0) ? $seconds : 0;\n    return $days * (24*60*60) + $hours * (60*60) + $minutes * (60) + $seconds;\n}\n\nfunction _multiSort($array, $arg1, $arg2){\n        $arr1 = array();\n        $arr2 = array();\n\n        foreach ($array as $key => $value){\n            $arr1[$key] = strtolower( $value[$arg1] );\n            $arr2[$key] = $value[$arg2];\n        }\n\n        array_multisort($arr1, $arr2, $array);\n        return $array;\n}\n\n/** Tools and Breadcrumbs **/\nfunction MAX_displayNavigationTracker($advertiserId, $trackerId, $aOtherAdvertisers)\n{\n    addTrackerPageTools($advertiserId, $trackerId, $aOtherAdvertisers);\n    $oHeaderModel = MAX_displayTrackerBreadcrumbs($advertiserId, $trackerId);\n    phpAds_PageHeader(null, $oHeaderModel);\n}\n\n\nfunction MAX_displayNavigationCampaign($campaignId, $aOtherAdvertisers, $aOtherCampaigns, $aEntities)\n{\n    $advertiserId = $aEntities['clientid'];\n\n\n    $doCampaign = OA_Dal::factoryDO('campaigns');\n    $doCampaign->campaignid = $campaignId;\n    $doCampaign->find();\n    $doCampaign->fetch();\n    $campaignName = $doCampaign->campaignname;\n\n    $advertiserName = MAX_buildName($advertiserId, $aOtherAdvertisers[$advertiserId]['name']);\n    $advertiserEditUrl = '';\n    if (OA_Permission::hasAccessToObject('clients', $advertiserId, OA_Permission::OPERATION_EDIT)) {\n        $advertiserEditUrl = \"advertiser-edit.php?clientid=$advertiserId\";\n    }\n\n    addCampaignPageTools($advertiserId, $campaignId, $aOtherAdvertisers, $aEntities);\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                          array(\"name\" => $advertiserName, \"url\" => $advertiserEditUrl),\n                                          array(\"name\" => $campaignName)),\n                                        \"campaign\", \"edit\");\n    phpAds_PageHeader(null, $oHeaderModel);\n}\n\n\nfunction MAX_displayNavigationBanner($pageName, $aOtherCampaigns, $aOtherBanners, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $advertiserId = $aEntities['clientid'];\n    $campaignId = $aEntities['campaignid'];\n    $bannerId = $aEntities['bannerid'];\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['bannerid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n    if ($pageName == 'banner-edit.php' && empty($bannerId)) {\n                $tabValue = 'banner-edit_new';\n                $pageType = 'edit-new';\n    }\n    else {\n    \t$pageType = 'edit';\n    }\n\n    $advertiserEditUrl = '';\n    $campaignEditUrl = '';\n\n    if (OA_Permission::hasAccessToObject('clients', $advertiserId)) {\n        $advertiserEditUrl = \"advertiser-edit.php?clientid=$advertiserId\";\n    }\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        $campaignEditUrl = \"campaign-edit.php?clientid=$advertiserId&campaignid=$campaignId\";\n    }\n\n    // Build banner preview\n    if ($bannerId && !empty($GLOBALS['_MAX']['PREF']['ui_show_banner_preview']) && empty($_GET['nopreview'])) {\n        $bannerCode = MAX_bannerPreview($bannerId);\n    } else {\n        $bannerCode = '';\n    }\n\n    $advertiserDetails = phpAds_getClientDetails($advertiserId);\n    $advertiserName = $advertiserDetails['clientname'];\n    $campaignDetails = Admin_DA::getPlacement($campaignId);\n    $campaignName = $campaignDetails['name'];\n    $bannerName = $aOtherBanners[$bannerId]['name'];\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                      array(\"name\" => $advertiserName, \"url\" => $advertiserEditUrl),\n                                      array(\"name\" => $campaignName, \"url\" => $campaignEditUrl),\n                                      array(\"name\" => $bannerName)),\n                                    \"banner\", $pageType);\n\n    global $phpAds_breadcrumbs_extra;\n    $phpAds_breadcrumbs_extra .= \"<div class='bannercode'>$bannerCode</div>\";\n    if ($bannerCode != '') {\n        $phpAds_breadcrumbs_extra .= \"<br />\";\n    }\n\n    addBannerPageTools($advertiserId, $campaignId, $bannerId, $aOtherCampaigns, $aOtherBanners, $aEntities);\n    phpAds_PageHeader($tabValue, $oHeaderModel);\n}\n\nfunction MAX_bannerPreview($bannerId)\n{\n    require_once (MAX_PATH . '/lib/max/Delivery/adRender.php');\n    $aBanner = Admin_DA::getAd($bannerId);\n    $aBanner['storagetype'] = $aBanner['type'];\n    $aBanner['bannerid'] = $aBanner['ad_id'];\n    if ($aBanner['contenttype'] == 'swf') {\n        return\n            MAX_adRender($aBanner, 0, '', '', '', true, '', false, false) .\n            \"<br /><br />\" .\n            _adRenderImage($aBanner, 0, '', '', true, false, false, true);\n    } else {\n        return\n            MAX_adRender($aBanner, 0, '', '', '', true, '', false, false);\n    }\n}\n\nfunction MAX_displayNavigationZone($pageName, $aOtherPublishers, $aOtherZones, $aEntities)\n{\n\n    global $phpAds_TextDirection;\n\n    $websiteId = $aEntities['affiliateid'];\n    $zoneId = $aEntities['zoneid'];\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['zoneid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n    $aPublisher = $aOtherPublishers[$websiteId];\n    $publisherName = MAX_buildName($websiteId, $aPublisher['name']);\n    $zoneName = (empty($zoneId)) ? $GLOBALS['strUntitled'] : MAX_buildName($zoneId, $aOtherZones[$zoneId]['name']);\n\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n        $tabSections = array('4.2.3.2', '4.2.3.6', '4.2.3.3', '4.2.3.4', '4.2.3.5');\n        // Determine which tab is highlighted\n        switch ($pageName) {\n            case 'zone-edit.php'       :\n                if (empty($zoneId)) {\n                    $tabValue = 'zone-edit_new';\n                } else {\n                    $tabValue = 'zone-edit';\n                }\n                break;\n            default: $tabSections = basename($pageName); break;\n        }\n    }\n    elseif (OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER)) {\n        $tabSections = array();\n        if (OA_Permission::hasPermission(OA_PERM_ZONE_EDIT)) { $tabSections[] = '2.1.1'; }\n        if (OA_Permission::hasPermission(OA_PERM_ZONE_LINK)) { $tabSections[] = '2.1.2'; }\n        $tabSections[] = '2.1.3';\n        if (OA_Permission::hasPermission(OA_PERM_ZONE_INVOCATION)) { $tabSections[] = '2.1.4'; }\n        switch($pageName) {\n            case 'zone-edit.php': {\n                $tabValue = 'zone-edit';\n                if (empty($zoneId)) {\n                     $tabValue = 'zone-edit_new';\n                }\n                break;\n            }\n            case 'zone-include.php': $tabValue = '2.1.2'; break;\n            case 'zone-probability.php': $tabValue = '2.1.3'; break;\n            case 'zone-invocation.php': $tabValue = '2.1.4'; break;\n        }\n    }\n    // Sort the zones by name...\n    require_once(MAX_PATH . '/lib/max/other/stats.php');\n\n    $publisherEditUrl = \"affiliate-edit.php?affiliateid=$websiteId\";\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADMIN, OA_ACCOUNT_MANAGER)) {\n        $publisherEditUrl = \"affiliate-zones.php?affiliateid=$websiteId\";\n    }\n\n    $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n    $oHeaderModel = $builder->buildEntityHeader(array(\n                                       array(\"name\" => $publisherName, \"url\" => $publisherEditUrl),\n                                       array(\"name\" => empty($zoneId) ? '' : $zoneName)\n                                   ), \"zone\", empty($zoneId));\n\n    if (!empty($zoneId)) {\n        addZonePageTools($websiteId, $zoneId, $aOtherPublishers, $aEntities);\n    }\n    phpAds_PageHeader($tabValue, $oHeaderModel);\n    phpAds_ShowSections($tabSections);\n}\n\nfunction MAX_displayNavigationChannel($pageName, $aOtherChannels, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $agencyId = isset($aEntities['agencyid']) ? $aEntities['agencyid'] : null;\n    $websiteId = isset($aEntities['affiliateid']) ? $aEntities['affiliateid'] : null;\n    $channelId = $aEntities['channelid'];\n    $channelName = $aOtherChannels[$channelId]['name'];\n\n    $entityString = _getEntityString($aEntities);\n    $aOtherEntities = $aEntities;\n    unset($aOtherEntities['channelid']);\n    $otherEntityString = _getEntityString($aOtherEntities);\n\n    if (!empty($websiteId)) {\n        $channelType = 'publisher';\n    }\n    else {\n        $channelType = 'agency';\n    }\n\n    // Determine which set of tabs to show...\n    if ($channelType == 'publisher') {\n        // Determine which tab is highlighted\n        switch ($pageName) {\n            case 'channel-edit.php' : $tabValue = (!empty($channelId)) ? 'channel-edit-affiliate' : 'channel-edit-affiliate_new'; break;\n            case 'channel-acl.php' : $tabValue = 'channel-affiliate-acl'; break;\n        }\n    } else {\n        // Determine which tab is highlighted\n        switch ($pageName) {\n            case 'channel-edit.php' : $tabValue = (!empty($channelId)) ? 'channel-edit' : 'channel-edit_new'; break;\n            case 'channel-acl.php' : $tabValue = 'channel-acl'; break;\n        }\n    }\n\n    // Sort the channels by name...\n    require_once(MAX_PATH . '/lib/max/other/stats.php');\n\n    $publisherEditUrl = \"affiliate-edit.php?affiliateid=$websiteId\";\n    if (!empty($channelId)) {\n        addChannelPageTools($agencyId, $websiteId, $channelId, $channelType);\n\n        // Determine which tab is highlighted\n        $publisher = Admin_DA::getPublisher($websiteId);\n        $publisherName = $publisher['name'];\n        if (!empty($channelId)) {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                array(\"name\" => $publisherName, url => $publisherEditUrl),\n                array(\"name\" => $channelName)), \"channel\", \"edit\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n        else {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                array(\"name\" => $publisherName, url => $publisherEditUrl),\n                array(\"name\" => $channelName)), \"channel\", \"edit-new\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n    }\n    else {\n        if (!empty($channelId)) {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                array(\"name\" => $channelName)), \"global-channel\", \"edit\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n        else {\n            $builder = new OA_Admin_UI_Model_InventoryPageHeaderModelBuilder();\n            $oHeaderModel = $builder->buildEntityHeader(array(\n                        array(\"name\" => \"\")), \"global-channel\", \"edit-new\");\n            phpAds_PageHeader($tabValue, $oHeaderModel);\n        }\n    }\n}\n\n\nfunction addAdvertiserPageToolsAndShortcuts($advertiserId)\n{\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        addPageLinkTool($GLOBALS[\"strAddCampaign_Key\"], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-edit.php?clientid=\".$advertiserId), \"iconCampaignAdd\", $GLOBALS[\"keyAddNew\"] );\n    }\n    addPageShortcut($GLOBALS['strAdvertiserCampaigns'], MAX::constructUrl(MAX_URL_ADMIN, \"advertiser-campaigns.php?clientid=$advertiserId\"), \"iconCampaigns\");\n    addPageShortcut($GLOBALS['strClientHistory'], MAX::constructUrl(MAX_URL_ADMIN, 'stats.php?entity=advertiser&breakdown=history&clientid='.$advertiserId), 'iconStatistics');\n}\n\n\nfunction addTrackerPageTools($advertiserId, $trackerId, $aOtherAdvertisers)\n{\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN) || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n        $token = phpAds_SessionGetToken();\n\n        //duplicate\n        addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"tracker-modify.php?token=\".urlencode($token).\"&clientid=\".$advertiserId.\"&trackerid=\".$trackerId.\"&duplicate=true&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconTrackerDuplicate\");\n\n        //move to\n        $form  = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'tracker-modify.php') . \"'>\n            <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n            <input type='hidden' name='trackerid' value='$trackerId'\n            <input type='hidden' name='clientid' value='$advertiserId'\n            <input type='hidden' name='returnurl' value='tracker-edit.php'>\n            <select name='moveto'>\";\n        foreach ($aOtherAdvertisers as $advertiser) {\n            $form .= \"<option value='\".$advertiser['clientid'].\"'>\".htmlspecialchars(MAX_buildName($advertiser['clientid'], $advertiser['clientname'])).\"</option>\";\n        }\n        $form .= \"</select><input type='image' class='submit' src='\" . OX::assetPath() . \"/images/\".$GLOBALS['phpAds_TextDirection'].\"/go_blue.gif'></form>\";\n        addPageFormTool($GLOBALS['strMoveTo'], 'iconTrackerMove', $form);\n\n        //delete\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteTracker']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"tracker-delete.php?token=\".urlencode($token).\"&clientid=\".$advertiserId.\"&trackerid=\".$trackerId.\"&returnurl=advertiser-trackers.php\"), \"iconDelete\", null, $deleteConfirm);\n        addPageShortcut($GLOBALS['strBackToTrackers'], MAX::constructUrl(MAX_URL_ADMIN, \"advertiser-trackers.php?clientid=$advertiserId\"), \"iconBack\");\n    }\n}\n\n\nfunction addCampaignPageTools($clientid, $campaignid, $aOtherAdvertisers, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n\n        $token = phpAds_SessionGetToken();\n\n        addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-modify.php?token=\".urlencode($token).\"&duplicate=1&clientid=$clientid&campaignid=$campaignid&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconCampaignDuplicate\");\n\n        if (OA_Permission::hasAccessToObject('campaigns', $campaignid, OA_Permission::OPERATION_MOVE)) {\n            $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'campaign-modify.php') . \"'>\n            <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n            <input type='hidden' name='clientid' value='$clientid'>\n            <input type='hidden' name='campaignid' value='$campaignid'>\n            <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'], ENT_QUOTES)).\"'>\n            <select name='newclientid'>\";\n                $aOtherAdvertisers = _multiSort($aOtherAdvertisers,'name','advertiser_id');\n                foreach ($aOtherAdvertisers as $aOtherAdvertiser) {\n                    $otherAdvertiserId = $aOtherAdvertiser['advertiser_id'];\n                    $otherAdvertiserName = MAX_buildName($otherAdvertiserId, $aOtherAdvertiser['name']);\n\n                    if ($otherAdvertiserId != $advertiserId) {\n                        $form .= \"<option value='$otherAdvertiserId'>\" . htmlspecialchars($otherAdvertiserName) . \"</option>\";\n                    }\n                }\n            $form .= \"</select><input type='image' class='submit' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif'></form>\";\n\n            addPageFormTool($GLOBALS['strMoveTo'], 'iconCampaignMove', $form);\n        }\n\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteCampaign']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-delete.php?token=\".urlencode($token).\"&clientid=$clientid&campaignid=$campaignid&returnurl=advertiser-campaigns.php\"), \"iconDelete\", null, $deleteConfirm);\n    }\n\n    //shortcuts\n    if (!empty($campaignid) && !OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        if (OA_Permission::hasAccessToObject('campaigns', $campaignid, OA_Permission::OPERATION_ADD_CHILD)) {\n            addPageLinkTool($GLOBALS[\"strAddBanner_Key\"], MAX::constructUrl(MAX_URL_ADMIN, \"banner-edit.php?clientid=$clientid&campaignid=$campaignid\"), \"iconBannerAdd\", $GLOBALS[\"strAddNew\"] );\n        }\n        addPageShortcut($GLOBALS['strBackToCampaigns'], MAX::constructUrl(MAX_URL_ADMIN, \"advertiser-campaigns.php?clientid=$clientid\"), \"iconBack\");\n    }\n    if (!empty($campaignid)) {\n        if (OA_Permission::hasAccessToObject('campaigns', $campaignid, OA_Permission::OPERATION_VIEW_CHILDREN)) {\n            addPageShortcut($GLOBALS['strCampaignBanners'], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-banners.php?clientid=$clientid&campaignid=$campaignid\"), \"iconBanners\");\n        }\n        $entityString = _getEntityString($aEntities);\n        addPageShortcut($GLOBALS['strCampaignHistory'], MAX::constructUrl(MAX_URL_ADMIN, \"stats.php?entity=campaign&breakdown=history&$entityString\"), 'iconStatistics');\n    }\n}\n\nfunction addBannerPageTools($advertiserId, $campaignId, $bannerId, $aOtherCampaigns, $aOtherBanners, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    if (empty($bannerId)) {\n        return;\n    }\n\n    $token = phpAds_SessionGetToken();\n\n    //duplicate\n    addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"banner-modify.php?token=\".urlencode($token).\"&duplicate=true&clientid=$advertiserId&campaignid=$campaignId&bannerid=$bannerId&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconBannerDuplicate\");\n\n    //move to\n    $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'banner-modify.php') . \"'>\n    <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n    <input type='hidden' name='clientid' value='$advertiserId'>\n    <input type='hidden' name='campaignid' value='$campaignId'>\n    <input type='hidden' name='bannerid' value='$bannerId'>\n    <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'])).\"'>\n    <select name='moveto'>\";\n    $aOtherCampaigns = _multiSort($aOtherCampaigns,'name','placement_id');\n    foreach ($aOtherCampaigns as $otherCampaignId => $aOtherCampaign) {\n        // mask campaign name if anonymous campaign\n        $aOtherCampaign['name'] = MAX_getPlacementName($aOtherCampaign);\n        $otherCampaignName = MAX_buildName($aOtherCampaign['placement_id'], $aOtherCampaign['name']);\n\n        if ($aOtherCampaign['placement_id'] != $campaignId) {\n            $form .= \"<option value='\" . $aOtherCampaign['placement_id'] . \"'>\" . htmlspecialchars($otherCampaignName) . \"</option>\";\n        }\n        else {\n            $campaignName = $otherCampaignName;\n        }\n    }\n    $form .= \"</select><input name='moveto' class='submit' type='image' src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/go_blue.gif'></form>\";\n    addPageFormTool($GLOBALS['strMoveTo'], 'iconBannerMove', $form);\n\n    //apply to\n    if (basename($_SERVER['SCRIPT_NAME']) == 'banner-acl.php') {\n        $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'banner-modify.php') . \"'>\n        <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n        <input type='hidden' name='clientid' value='$advertiserId'>\n        <input type='hidden' name='campaignid' value='$campaignId'>\n        <input type='hidden' name='bannerid' value='$bannerId'>\n        <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'])).\"'>\n        <select name='applyto'>\";\n\n        $aOtherBanners = _multiSort($aOtherBanners,'name','ad_id');\n        foreach ($aOtherBanners as $idx => $aOtherBanner) {\n            if ($aOtherBanner['ad_id'] != $bannerId) {\n                $form .= \"<option value='{$aOtherBanner['ad_id']}'>\" . MAX_buildName($aOtherBanner['ad_id'], $aOtherBanner['name']) . \"</option>\";\n            }\n        }\n        $form .= \"</select><input type='image' class='submit' name='applyto' src='\" . OX::assetPath() . \"/images/\".$phpAds_TextDirection.\"/go_blue.gif'></form>\";\n\n        addPageFormTool($GLOBALS['strApplyLimitationsTo'], 'iconBannerApplyLimitations', $form);\n    }\n\n    //delete\n    if (!OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteBanner']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"banner-delete.php?token=\".urlencode($token).\"&clientid=$advertiserId&campaignid=$campaignId&bannerid=$bannerId&returnurl=campaign-banners.php\"), \"iconDelete\", null, $deleteConfirm);\n    }\n\n    /* Shortcuts */\n    addPageShortcut($GLOBALS['strBackToBanners'], MAX::constructUrl(MAX_URL_ADMIN, \"campaign-banners.php?clientid=$advertiserId&campaignid=$campaignId\"), \"iconBack\");\n    $entityString = _getEntityString($aEntities);\n    addPageShortcut($GLOBALS['strBannerHistory'], MAX::constructUrl(MAX_URL_ADMIN, \"stats.php?entity=banner&breakdown=history&$entityString\"), 'iconStatistics');\n}\n\n\nfunction addWebsitePageTools($websiteId)\n{\n    if (!empty($websiteId) && (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n        || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)\n        || OA_Permission::hasPermission(OA_PERM_ZONE_ADD))) {\n        addPageLinkTool($GLOBALS[\"strAddNewZone_Key\"], MAX::constructUrl(MAX_URL_ADMIN, \"zone-edit.php?affiliateid=$websiteId\"), \"iconZoneAdd\", $GLOBALS[\"keyAddNew\"] );\n        addPageShortcut($GLOBALS['strWebsiteZones'], MAX::constructUrl(MAX_URL_ADMIN, \"affiliate-zones.php?affiliateid=$websiteId\"), \"iconZones\");\n    }\n    addPageShortcut($GLOBALS['strAffiliateHistory'], MAX::constructUrl(MAX_URL_ADMIN, 'stats.php?entity=affiliate&breakdown=history&affiliateid='.$websiteId), 'iconStatistics');\n}\n\n\nfunction addZonePageTools($affiliateid, $zoneid, $aOtherPublishers, $aEntities)\n{\n    global $phpAds_TextDirection;\n\n    $token = phpAds_SessionGetToken();\n\n    //duplicate\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n        || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)\n        || OA_Permission::hasPermission(OA_PERM_ZONE_ADD)) {\n        addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"zone-modify.php?duplicate=true&affiliateid=$affiliateid&zoneid=$zoneid&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconZoneDuplicate\");\n    }\n\n    //move to\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n        || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n        $form = \"<form action='\" . MAX::constructUrl(MAX_URL_ADMIN, 'zone-modify.php') . \"'>\n        <input type='hidden' name='token' value='\".htmlspecialchars($token, ENT_QUOTES).\"'>\n        <input type='hidden' name='affiliateid' value='$affiliateid'>\n        <input type='hidden' name='zoneid' value='$zoneid'>\n        <input type='hidden' name='returnurl' value='\".htmlspecialchars(basename($_SERVER['SCRIPT_NAME'])).\"'>\n        <select name='newaffiliateid'>\";\n        $aOtherPublishers = _multiSort($aOtherPublishers,'name','publisher_id');\n        foreach ($aOtherPublishers as $otherPublisherId => $aOtherPublisher) {\n            $otherPublisherName = MAX_buildName($aOtherPublisher['publisher_id'], $aOtherPublisher['name']);\n            if ($aOtherPublisher['publisher_id'] != $affiliateid) {\n                $form .= \"<option value='\" . $aOtherPublisher['publisher_id'] . \"'>\" . htmlspecialchars($otherPublisherName) . \"</option>\";\n            }\n        }\n        $form .= \"</select><input type='image' class='submit' src='\" . OX::assetPath() . \"/images/\".$phpAds_TextDirection.\"/go_blue.gif'></form>\";\n\n        addPageFormTool($GLOBALS['strMoveTo'], 'iconZoneMove', $form);\n    }\n\n    //delete\n    if (OA_Permission::isAccount(OA_ACCOUNT_ADMIN)\n       || OA_Permission::isAccount(OA_ACCOUNT_MANAGER)\n       || OA_Permission::hasPermission(OA_PERM_ZONE_DELETE)) {\n        $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteZone']);\n        addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"zone-delete.php?token=\".urlencode($token).\"&affiliateid=$affiliateid&zoneid=$zoneid&returnurl=affiliate-zones.php\"), \"iconDelete\", null, $deleteConfirm);\n    }\n\n    //shortcut\n    addPageShortcut($GLOBALS['strBackToZones'], MAX::constructUrl(MAX_URL_ADMIN, \"affiliate-zones.php?affiliateid=$affiliateid\"), \"iconBack\");\n    $entityString = _getEntityString($aEntities);\n    addPageShortcut($GLOBALS['strZoneHistory'], MAX::constructUrl(MAX_URL_ADMIN, \"stats.php?entity=zone&breakdown=history&$entityString\"), 'iconStatistics');\n}\n\nfunction addChannelPageTools($agencyid, $websiteId, $channelid, $channelType)\n{\n    if ($channelType == 'publisher') {\n        $deleteReturlUrl = MAX::constructUrl(MAX_URL_ADMIN, 'affiliate-channels.php');\n    }\n    else {\n        $deleteReturlUrl = MAX::constructUrl(MAX_URL_ADMIN, 'channel-index.php');\n    }\n\n    $token = phpAds_SessionGetToken();\n\n    //duplicate\n    addPageLinkTool($GLOBALS[\"strDuplicate\"], MAX::constructUrl(MAX_URL_ADMIN, \"channel-modify.php?token=\".urlencode($token).\"&duplicate=true&agencyid=$agencyid&affiliateid=$websiteId&channelid=$channelid&returnurl=\".urlencode(basename($_SERVER['SCRIPT_NAME']))), \"iconTargetingChannelDuplicate\");\n\n    //delete\n    $deleteConfirm = phpAds_DelConfirm($GLOBALS['strConfirmDeleteChannel']);\n    addPageLinkTool($GLOBALS[\"strDelete\"], MAX::constructUrl(MAX_URL_ADMIN, \"channel-delete.php?token=\".urlencode($token).\"&agencyid=$agencyid&affiliateid=$websiteId&channelid=$channelid&returnurl=$deleteReturlUrl\"), \"iconDelete\", null, $deleteConfirm);\n}\n\n\n/**\n * Builds Pear pager object, preconfigured with items per page. Pager links are\n * processed to make them more readable. Also items name in summary can be added.\n *\n * @param unknown_type $items\n * @param unknown_type $itemsPerPage\n * @param unknown_type $withNumbers\n * @param unknown_type $itemsName\n * @return unknown\n */\nfunction OX_buildPager($items, $itemsPerPage, $withNumbers = true, $itemsName = '', $delta = 4,\n    $currentPage = null, $fileName = null, $params = null)\n{\n    require_once MAX_PATH . '/lib/pear/Pager/Pager.php';\n\n    $oTrans = new OX_Translation();\n\n    /** prepare paging **/\n    $count = count($items);\n        $delta = $withNumbers ? $delta : 0;\n\n\n    $pagerOptions = array(\n        'mode'       => 'Sliding',\n        'perPage'    => $itemsPerPage,\n        'delta'      => $delta,\n        'totalItems' => $count,\n        'prevImg'       => '&lt; ' . $oTrans->translate('Back'),\n        'nextImg'       => $oTrans->translate('Next') . ' &gt;',\n        'urlVar' => 'p',\n        'linkClass' => 'page',\n        'curPageLinkClassName' => 'current',\n        'spacesBeforeSeparator' => 0,\n        'httpMethod' => 'GET',\n        'spacesAfterSeparator' => 0\n    );\n    if (!empty($fileName)) {\n        $pagerOptions['fileName'] = $fileName;\n        $pagerOptions['fixFileName'] = false;\n    }\n    if (!empty($params)) {\n        $pagerOptions['extraVars'] = $params;\n    }\n    if (!empty($currentPage)) {\n        $pagerOptions['currentPage'] = $currentPage;\n    }\n\n    $pager = Pager::factory($pagerOptions);\n    list($from, $to) = $pager->getOffsetByPageId();\n    $summary = \"<em>$from</em>-<em>$to</em> of <em>\".$pager->numItems().\" $itemsName</em>\";\n    $pager->summary = $summary;\n\n    //override links with shorter pager controls\n    if (!$withNumbers) {\n        $links = $pager->links;\n        $shortLinks = preg_replace(\"/<span class=\\\"current\\\">\\d+<\\/span>/i\", \"<span class='summary'>$summary</span>\" , $links);\n        $shortLinks = preg_replace(\"/\\[\\d+\\]/\", \"\" , $shortLinks);\n        $pager->links = $shortLinks;\n    }\n\n    return $pager;\n}\n\n\n\n?>\n", "{*<!--\n\n+---------------------------------------------------------------------------+\n| Revive Adserver                                                           |\n| http://www.revive-adserver.com                                            |\n|                                                                           |\n| Copyright: See the COPYRIGHT.txt file.                                    |\n| License: GPLv2 or later, see the LICENSE.txt file.                        |\n+---------------------------------------------------------------------------+\n\n-->*}\n\n<div class='dropDown {$cssClass}'>\n    <span><span>{$title}</span></span>\n\n    <div class='panel'>\n        <div>\n            <ul>\n    \t\t{section name=linkLoop loop=$aLinks}\n        \t\t<li>\n        \t\t\t{if $aLinks[linkLoop].type == 'link'}\n            \t\t\t{if $aLinks[linkLoop].icon}<img src='{$assetPath}/images/{$aLinks[linkLoop].icon}' align='absmiddle' alt=''>{/if}\n                        <a href='{$aLinks[linkLoop].url|escape}' {if $aLinks[linkLoop].iconClass}class='inlineIcon {$aLinks[linkLoop].iconClass}'{/if} {if $aLinks[linkLoop].accesskey}accesskey='{$aLinks[linkLoop].accesskey}'{/if} {$aLinks[linkLoop].extraAttr}>{$aLinks[linkLoop].title}</a>\n        \t\t\t{elseif $aLinks[linkLoop].type == 'form'}\n            \t\t\t{if $aLinks[linkLoop].icon}<img src='{$assetPath}/images/{$aLinks[linkLoop].icon}' align='absmiddle' alt=''>{/if}\n            \t\t\t<label {if $aLinks[linkLoop].iconClass}class='inlineIcon {$aLinks[linkLoop].iconClass}'{/if}>{$aLinks[linkLoop].title}</label>\n               \t\t\t{$aLinks[linkLoop].form}\n        \t\t\t{/if}\n        \t\t</li>\n    \t\t{/section}\n            </ul>\n        </div>\n    </div>\n\n    <div class='mask'></div>\n</div>\n", "<?php\n\n/*\n+---------------------------------------------------------------------------+\n| Revive Adserver                                                           |\n| http://www.revive-adserver.com                                            |\n|                                                                           |\n| Copyright: See the COPYRIGHT.txt file.                                    |\n| License: GPLv2 or later, see the LICENSE.txt file.                        |\n+---------------------------------------------------------------------------+\n*/\n\n// Require the initialisation file\nrequire_once '../../init.php';\n\n// Required files\nrequire_once MAX_PATH . '/www/admin/config.php';\nrequire_once MAX_PATH . '/www/admin/lib-statistics.inc.php';\nrequire_once MAX_PATH . '/lib/max/other/common.php';\nrequire_once MAX_PATH . '/lib/max/Admin_DA.php';\nrequire_once MAX_PATH . '/lib/max/other/html.php';\nrequire_once MAX_PATH . '/lib/max/other/stats.php';\nrequire_once 'Pager/Pager.php';\nrequire_once MAX_PATH . '/lib/pear/Date.php';\n\n// Security check\nOA_Permission::enforceAccount(OA_ACCOUNT_MANAGER, OA_ACCOUNT_ADVERTISER, OA_ACCOUNT_TRAFFICKER);\n\n// Get input variables\n$pref = $GLOBALS['_MAX']['PREF'];\n$hideinactive   = MAX_getStoredValue('hideinactive', ($pref['ui_hide_inactive'] == true), null, true);\n$listorder      = MAX_getStoredValue('listorder', 'date_time');\n$orderdirection = MAX_getStoredValue('orderdirection', 'up');\n$aNodes         = MAX_getStoredArray('nodes', array());\n$editStatuses   = MAX_getStoredValue('editStatuses', false, null, true);\n$day            = MAX_getStoredValue('day', null, 'stats-conversions.php');\n$howLong        = MAX_getStoredValue('howLong', 'd');\n$hour           = MAX_getStoredValue('hour', null, 'stats-conversions.php', true);\n$setPerPage     = MAX_getStoredValue('setPerPage', 15);\n$pageID         = MAX_getStoredValue('pageID', 1);\n\nif (!empty($day)) {\n    // Reset period\n    $period_preset = '';\n    // Always refresh howLong and hour\n    $howLong = MAX_getValue('howLong', 'd');\n    $hour    = MAX_getValue('hour');\n} else {\n    $period_preset  = MAX_getStoredValue('period_preset', 'today');\n    $period_start   = MAX_getStoredValue('period_start', date('Y-m-d'));\n    $period_end     = MAX_getStoredValue('period_end', date('Y-m-d'));\n}\n\nif (is_numeric($hour) && $hour < 10 && strlen($hour) != 2) {\n    $hour = '0' . $hour;\n}\n\n$expand         = MAX_getValue('expand', '');\n$collapse       = MAX_getValue('collapse');\n\nif ($clientid) {\n    OA_Permission::enforceAccessToObject('clients', $clientid);\n}\nif ($campaignid) {\n    OA_Permission::enforceAccessToObject('campaigns', $campaignid);\n}\nif ($bannerid) {\n    OA_Permission::enforceAccessToObject('banners', $bannerid);\n}\nif ($affiliateid) {\n    OA_Permission::enforceAccessToObject('affiliates', $clientid);\n}\nif ($zoneid) {\n    OA_Permission::enforceAccessToObject('zones', $zoneid);\n}\n\n// Build $addUrl variable which will be added to any required link on this page, eg: expand, collapse, editStatuses\n$entityIds = array(\n    'entity'      => 'conversions',\n    'clientid'    => $clientid,\n    'campaignid'  => $campaignid,\n    'bannerid'    => $bannerid,\n    'affiliateid' => $affiliateid,\n    'zoneid'      => $zoneid,\n    'setPerPage'  => $setPerPage,\n    'pageID'      => $pageID\n);\n$addUrl = \"entity=conversions&clientid=$clientid&campaignid=$campaignid&bannerid=$bannerid&affiliateid=$affiliateid&zoneid=$zoneid&setPerPage=$setPerPage&pageID=$pageID\";\n\nif (!empty($day)) {\n    $entityIds += array(\n        'day' => $day,\n        'hour' => $hour,\n        'howLong' => $howLong\n    );\n    $addUrl .= \"&day=\".urlencode($day).\"&hour=\".urlencode($hour).\"&howLong=\".urlencode($howLong);\n} else {\n    $entityIds += array(\n        'period_preset' => $period_preset,\n        'period_start' => $period_start,\n        'period_end' => $period_end,\n    );\n    $addUrl .= \"&period_preset=\".urlencode($period_preset).\"&period_start=\".urlencode($period_start).\"&period_end=\".urlencode($period_end);\n}\n// Adjust which nodes are opened closed...\nMAX_adjustNodes($aNodes, $expand, $collapse);\n\nif (!OA_Permission::isAccount(OA_ACCOUNT_MANAGER)) {\n    // editing statuses is allowed only for admin and agency\n    $editStatuses = false;\n}\nelse {\n    if($editStatuses) {\n        addPageShortcut($strShortcutShowStatuses, 'stats.php?entity=conversions&editStatuses=0&'.$addUrl, 'iconZoom');\n    }\n    else {\n        addPageShortcut($strShortcutEditStatuses, 'stats.php?entity=conversions&editStatuses=1&'.$addUrl, 'iconEdit');\n    }\n}\n\n// @todo: hack - get edit status working when expading/collapsing\nif ($editStatuses) {\n    $entityIds['editStatuses'] = 1;\n    $addUrl .= '&editStatuses=1';\n}\n\n// Display navigation\nif(OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER)) {\n    // Navigation for publisher\n    $conf = &$GLOBALS['_MAX']['CONF'];\n    $conf['logging']['adRequests'] = false;\n    $affiliateid = OA_Permission::getEntityId();\n\n    phpAds_PageHeader(\"1.1\");\n    echo '<br><br>';\n} elseif(OA_Permission::isAccount(OA_ACCOUNT_ADVERTISER)) {\n    // Navigation for advertiser\n    $clientid = OA_Permission::getEntityId();\n\n    phpAds_PageHeader(\"1.1\");\n    echo '<br><br>';\n} else {\n    // Navigation for admin and agency\n\n    phpAds_PageHeader(\"2.1\");\n    echo '<br><br>';\n}\n// Initialise some parameters\n$pageName = basename($_SERVER['SCRIPT_NAME']);\n$tabindex = 1;\n$advertisersHidden = 0;\n\n// Display date filter form\nif(empty($day)) {\n    $aDates = MAX_getDatesByPeriod($period_preset, $period_start, $period_end);\n} else {\n    $aDates = array();\n    $oDayDate = new Date();\n    $oDayDate->setDate($day, DATE_FORMAT_TIMESTAMP);\n    if(!empty($hour)) {\n        // If hour is set build day date including hour\n        $aDates['day_hour'] = $oDayDate->format('%Y-%m-%d').' '.$hour;\n    } else {\n        // Build month, day, day_begin and day_end dependends on $howLong\n        switch($howLong) {\n            case 'm':\n                $aDates['month'] = $oDayDate->format('%Y-%m');\n                break;\n            case 'w':\n                $aDates['day_begin'] = $oDayDate->format('%Y-%m-%d');\n                $oDayDate->addSeconds(60*60*24*7); // Add 7 days\n                $aDates['day_end'] = $oDayDate->format('%Y-%m-%d');\n                break;\n            case 'd':\n            default:\n                $aDates['day'] = $oDayDate->format('%Y-%m-%d');\n                break;\n        }\n    }\n}\n\n$hiddenValues = array(\n    'entity'   => 'conversions',\n    'clientid' => $clientid,\n    'campaignid' => $campaignid,\n    'bannerid' => $bannerid,\n    'affiliateid' => $affiliateid,\n    'zoneid' => $zoneid,\n);\nif(!empty($period_preset)) {\n    MAX_displayDateSelectionForm($period_preset, $period_start, $period_end, $pageName, $tabindex, $hiddenValues);\n} else {\n    $comma = '';\n    foreach($aDates as $dateValue) {\n        echo $comma.$dateValue;\n        $comma = ' - ';\n    }\n}\n\nphpAds_ShowBreak();\n\n$aParams = array();\n$aParams['agency_id'] = OA_Permission::getAgencyId();\n\n$aParams['clientid']    = $clientid;\n$aParams['campaignid']  = $campaignid;\n$aParams['bannerid']    = $bannerid;\n$aZonesIds = null; // Admin_DA class expects null if no zones to be used\nif (empty($zoneid) && !empty($affiliateid)) {\n    $aZonesIds = Admin_DA::fromCache('getZonesIdsByAffiliateId', $affiliateid);\n}\nif(!empty($zoneid)) {\n    $aZonesIds = array($zoneid);\n}\n$aParams['zonesIds'] = $aZonesIds;\n\n\n\n// Get conversions...\n\n\n\n$aParams['perPage'] = '999999';\n$aConversions = Admin_DA::fromCache('getConversions', $aParams + $aDates);\n\n\n$aParams['totalItems'] = count($aConversions);\n$aParams['perPage'] = MAX_getStoredValue('setPerPage', 15);\n\nif (!isset($pageID) || $pageID == 1) {\n    $aParams['startRecord'] = 0;\n} else {\n    $aParams['startRecord'] = (MAX_getStoredValue('pageID', 1) * $aParams['perPage']) - $aParams['perPage'];\n}\n\n\n\n$aConversions = Admin_DA::fromCache('getConversions', $aParams + $aDates);\n\n\n$aParams['perPage'] = MAX_getStoredValue('setPerPage', 15);\n//$aParams['startRecord'] = $_REQUEST['page'];\n\n$pager = & Pager::factory($aParams);\n$per_page = $pager->_perPage;\n$pager->history = $pager->getPageData();\n$pager->pagerLinks = $pager->getLinks();\n\n$pager->pagerLinks = $pager->pagerLinks['all'];\n$pager->pagerSelect = preg_replace('/(<select.*?)(>)/i', '$1 id=\"setPerPageSelect\"$2', $pager->getPerPageSelectBox(15, 120, 15));\n\n// Build the conversions array\nif (!empty($aConversions)) {\n\n    if($editStatuses) {\n        echo \"<form id='connections-modify' action='connections-modify.php' name='connectionsmodify' id='connectionsmodify' method='POST'>\".\"\\n\";\n        echo \"<input type='hidden' name='clientid' value='$clientid'>\".\"\\n\";\n        echo \"<input type='hidden' name='campaignid' value='$campaignid'>\".\"\\n\";\n        echo \"<input type='hidden' name='bannerid' value='$bannerid'>\".\"\\n\";\n        echo \"<input type='hidden' name='affiliateid' value='$affiliateid'>\".\"\\n\";\n        echo \"<input type='hidden' name='zoneid' value='$zoneid'>\".\"\\n\";\n        echo \"<input type='hidden' name='day' value='\".htmlspecialchars($day, ENT_QUOTES).\"'>\".\"\\n\";\n        echo \"<input type='hidden' name='hour' value='\".htmlspecialchars($hour, ENT_QUOTES).\"'>\".\"\\n\";\n        echo \"<input type='hidden' name='howLong' value='\".htmlspecialchars($howLong, ENT_QUOTES).\"'>\".\"\\n\";\n        echo \"<input type='hidden' name='period_preset' value='\".htmlspecialchars($period_preset, ENT_QUOTES).\"'>\".\"\\n\";\n        if ($period_preset == 'specific') {\n            echo \"<input type='hidden' name='period_start' value='\".htmlspecialchars($period_start, ENT_QUOTES).\"'>\".\"\\n\";\n            echo \"<input type='hidden' name='period_end' value='\".htmlspecialchars($period_end, ENT_QUOTES).\"'>\".\"\\n\";\n        }\n        echo \"<input type='hidden' name='returnurl' value='stats.php'>\".\"\\n\";\n        echo \"<input type='hidden' name='entity' value='conversions'>\".\"\\n\";\n        echo \"<input type='hidden' name='setPerPage' value='\".htmlspecialchars($setPerPage, ENT_QUOTES).\"'>\".\"\\n\";\n        echo \"<input type='hidden' name='pageID' value='\".htmlspecialchars($pageID, ENT_QUOTES).\"'>\".\"\\n\";\n    }\n\n    echo \"\n        <br /><br />\n        <table border='0' width='100%' cellpadding='0' cellspacing='0'>\";\n\n    $column1 = _getHtmlHeaderColumn($GLOBALS['strDateTime'], 'date_time', $pageName, $entityIds, $listorder, $orderdirection);\n    $column2 = _getHtmlHeaderColumn($GLOBALS['strStatus'], 'connection_status', $pageName, $entityIds, $listorder, $orderdirection);\n    $column3 = _getHtmlHeaderColumn($GLOBALS['strTrackerID'], 'tracker_id', $pageName, $entityIds, $listorder, $orderdirection);\n    $column4 = _getHtmlHeaderColumn($GLOBALS['strTrackerName'], 'trackername', $pageName, $entityIds, $listorder, $orderdirection);\n    $column5 = _getHtmlHeaderColumn($GLOBALS['strCampaignID'], 'campaignid', $pageName, $entityIds, $listorder, $orderdirection);\n    $column6 = _getHtmlHeaderColumn($GLOBALS['strCampaignName'], 'campaignname', $pageName, $entityIds, $listorder, $orderdirection);\n\n    echo \"\n        <tr height='1'>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='150' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='60' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='60' height='1' border='0' alt='' title=''></td>\n            <td><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='80' height='1' border='0' alt='' title=''></td>\n        </tr>\n        <tr height='25'>\n            <td width='150' style='padding-left: 16px'>&nbsp;&nbsp;$column1</td>\n            <td align='center' style='padding: 0 4px'>$column2</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column3</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column4</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column5</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>$column6</td>\n        </tr>\n        <tr height='1'><td colspan='6' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n\n    // Variable to determine if the row should be grey or white...\n    $i=0;\n\n    $statusesColors = array(\n        MAX_CONNECTION_STATUS_IGNORE      => 'grey',\n        MAX_CONNECTION_STATUS_PENDING     => 'darkblue',\n        MAX_CONNECTION_STATUS_ONHOLD      => 'blue',\n        MAX_CONNECTION_STATUS_APPROVED    => 'green',\n        MAX_CONNECTION_STATUS_DISAPPROVED => 'red',\n        MAX_CONNECTION_STATUS_DUPLICATE   => 'grey',\n    );\n\n    $totalRequests = 0;\n    $totalViews = 0;\n    $totalClicks = 0;\n    $totalConversions = 0;\n\n    // Loop through advertisers\n    MAX_sortArray($aConversions, ($listorder == 'id' ? 'date_time' : $listorder), $orderdirection == 'up');\n    foreach($aConversions as $conversionId => $conversion) {\n        $conversionExpanded = MAX_isExpanded($conversionId, $expand, $aNodes, 'a');\n\n            $bgcolor = ($i++ % 2 == 0) ? \" bgcolor='#F6F6F6'\" : '';\n\n            $connectionStatus = $GLOBALS['_MAX']['STATUSES'][$conversion['connection_status']];\n            $translatedStatus = $GLOBALS[$connectionStatus];\n\n            echo \"\n        <tr height='25'$bgcolor>\n            <td>\";\n            if ($conversionExpanded) {\n                echo \"&nbsp;<a href='\".htmlspecialchars(\"$pageName?collapse=a$conversionId&$addUrl\", ENT_QUOTES).\"'><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'></a>&nbsp;\";\n            } else {\n                echo \"&nbsp;<a href='\".htmlspecialchars(\"$pageName?expand=a$conversionId&$addUrl\", ENT_QUOTES).\"'><img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'></a>&nbsp;\";\n            }\n\n            $aConversionStatuses = array(\n                MAX_CONNECTION_STATUS_IGNORE,\n                MAX_CONNECTION_STATUS_PENDING,\n                MAX_CONNECTION_STATUS_ONHOLD,\n                MAX_CONNECTION_STATUS_APPROVED,\n                MAX_CONNECTION_STATUS_DISAPPROVED,\n                MAX_CONNECTION_STATUS_DUPLICATE,\n            );\n\n            echo \"{$conversion['date_time']}</td>\";\n            if ($editStatuses) {\n                // Only managers can edit statuses. No constraint to the type of changes since OX-4138.\n                echo \"<td align='center' style='padding: 0 4px'><nobr>\";\n                foreach($GLOBALS['_MAX']['STATUSES'] as $statusId => $statusStr) {\n                    echo \"&nbsp;<label><input type='radio' name='statusIds[$conversionId]' value='$statusId' \".($conversion['connection_status']==$statusId?' checked':'').\" tabindex='\".($tabindex++).\"'>{$GLOBALS[$statusStr]}</label>\";\n                }\n                echo \"</nobr></td>\";\n            } else {\n                echo \"<td align='center' style='padding: 0 4px'><span style='color: {$statusesColors[$conversion['connection_status']]}'>{$translatedStatus}</span></td>\";\n            }\n            echo \"<td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['tracker_id']}</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['trackername']}</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['campaignid']}</td>\n            <td align='$phpAds_TextAlignLeft' style='padding: 0 4px'>{$conversion['campaignname']}</td>\n        </tr>\";\n\n        if ($conversionExpanded) {\n            $aConVariables = Admin_DA::fromCache('getConnectionVariables', $conversionId);\n\n            echo \"\n            <tr height='1'>\n                <td$bgcolor><img src='\" . OX::assetPath() . \"/images/spacer.gif' width='1' height='1'></td>\n                <td colspan='5' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break-l.gif' height='1' width='100%'></td>\n            </tr>\";\n\n            switch ($conversion['connection_action']) {\n                case MAX_CONNECTION_AD_CLICK:   $action = 'Click'; break;\n                case MAX_CONNECTION_AD_ARRIVAL: $action = 'Arrival'; break;\n                case MAX_CONNECTION_MANUAL:     $action = 'Manual'; break;\n                default:                        $action = 'View'; break;\n            }\n\n            $connectionType = $GLOBALS[$GLOBALS['_MAX']['CONN_TYPES'][$conversion['connection_type']]];\n\n            $eventDateStamp = strtotime($conversion['date_time']);\n\n            $secondsLeft = $eventDateStamp - strtotime($conversion['connection_date_time']);\n\n            $days = intval($secondsLeft / 86400);  // 86400 seconds in a day\n            $partDay = $secondsLeft - ($days * 86400);\n            $hours = intval($partDay / 3600);  // 3600 seconds in an hour\n            $partHour = $partDay - ($hours * 3600);\n            $minutes = intval($partHour / 60);  // 60 seconds in a minute\n            $seconds = $partHour - ($minutes * 60);\n\n            $windowDelay = $days.\"d \".$hours.\"h \".$minutes.\"m \".$seconds.\"s\";\n\n            echo \"\n            <tr height='25'$bgcolor>\n                <td></td>\n                <td colspan='5'>\n                    <table width='100%' border='0' cellspacing='' cellpadding='4'>\n                        <tr valign='top'>\n                            <td width='40%'>\n                                <table border='0' cellspacing='0' cellpadding='0'>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strIPAddress']}:</th><td style='padding-left: 8px'>{$conversion['tracker_ip_address']}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strCountry']}:</th><td style='padding-left: 8px'>{$conversion['tracker_country']}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strStatsAction']}:</th><td style='padding-left: 8px'>{$action}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strConnectionType']}:</th><td style='padding-left: 8px'>{$connectionType}</td></tr>\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strWindowDelay']}:</th><td style='padding-left: 8px'>{$windowDelay}</td></tr>\";\n            if (!is_null($conversion['comments'])) {\n                echo \"\n                                    <tr><th scope='row' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strComments']}:</th><td style='padding-left: 8px'>{$conversion['comments']}</td></tr>\";\n            }\n            echo \"\n                                </table>\n                            </td>\n                            <td width='60%'>\n                                <table border='0' cellspacing='0' cellpadding='0'>\n                                    <tr><th scope='col' style='text-align: $phpAds_TextAlignLeft'>{$GLOBALS['strStatsVariables']}:</th><td></td></tr>\";\n            foreach($aConVariables as $conVariable) {\n                // Do not show hidden variables to publishers\n                if (OA_Permission::isAccount(OA_ACCOUNT_TRAFFICKER) && $conVariable['hidden'] == 't') {\n                    continue;\n                }\n                echo \"<tr><th scope='row' style='text-align: $phpAds_TextAlignLeft; color: darkgrey'>\".\n                        htmlspecialchars(empty($conVariable['description']) ? $conVariable['name'] : $conVariable['description']).\n                        \"</th><td style='padding-left: 8px'>\".htmlspecialchars($conVariable['value']).\"</td></tr>\";\n            }\n            echo \"\n                                </table>\n                            </td>\n                        </tr>\n                    </table>\n                \";\n                echo \"\n                </td>\n            </tr>\";\n        }\n        echo \"\n        <tr height='1'><td colspan='6' bgcolor='#888888'><img src='\" . OX::assetPath() . \"/images/break.gif' height='1' width='100%'></td></tr>\";\n    }\n\n    echo \"\n        <tr>\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap>\";\n    echo \"\n            </td>\n            <td colspan='2' align='$phpAds_TextAlignRight' nowrap><img src='\" . OX::assetPath() . \"/images/triangle-d.gif' align='absmiddle' border='0'>&nbsp;<a href='\".htmlspecialchars(\"$pageName?$addUrl&expand=all\", ENT_QUOTES).\"' accesskey='$keyExpandAll'>$strExpandAll</a>&nbsp;&nbsp;|&nbsp;&nbsp;<img src='\" . OX::assetPath() . \"/images/$phpAds_TextDirection/triangle-l.gif' align='absmiddle' border='0'>&nbsp;<a href='$pageName?$addUrl&amp;expand=none' accesskey='$keyCollapseAll'>$strCollapseAll</a>&nbsp;&nbsp;</td>\n\n        </tr>\";\n    echo \"<tr>\n\n            <td colspan='4' align='$phpAds_TextAlignLeft' nowrap> \";\n    if($editStatuses) {\n             echo \"<input type='submit' name='submit' value='$strSaveChanges' tabindex='\".($tabindex++).\"' onClick='document.connectionsmodify.submit()'>\".\"\\n\";\n    }\n\n    echo \"\n            </td>\n\n            <td colspan='2' align='$phpAds_TextAlignRight' nowrap> $strItemsPerPage $pager->pagerSelect &nbsp; $pager->pagerLinks &nbsp;&nbsp;</td>\n\n        </tr>\n\n        </table>\n        <br /><br />\n        \";\n\n    if($editStatuses) {\n        echo \"</form>\".\"\\n\";\n    }\n\n    echo \"<form id='setPager' method='get' action='stats.php?\".htmlspecialchars($_SERVER['QUERY_STRING'], ENT_QUOTES).\"'>\";\n\n    $getValues = preg_split('/&/D', $_SERVER['QUERY_STRING']);\n    foreach ($getValues as $record) {\n        $filed = explode('=', $record);\n        if ($filed[0] != 'setPerPage' && $filed[0] != 'pageID') {\n            echo \"<input type='hidden' name='\". $filed[0].\"' value='\". $filed[1].\"'>\";\n        }\n    }\n\n    echo \"<input type='hidden' name='pageID'  value='1'>\";\n    echo \"<input type='hidden' name='setPerPage' id='setPerPage'>\";\n\n    echo \"</form>\";\n\necho '\n<script type=\\'text/javascript\\'>\n<!--\n\n$(document).ready(function() {\n    $(\"#setPerPageSelect\").change(updatePerPage);\n});\n\nfunction updatePerPage()\n{\n    perPage = $(\"#setPerPageSelect\").val();\n    $form = $(\"#setPager\");\n\n    $(\"#setPerPage\", $form).attr(\\'value\\', perPage);\n\n    $form.get(0).submit();\n}\n\n-->\n</script>';\n\n} else {\n    echo \"\n        <br /><br /><div class='errormessage'><img class='errormessage' src='\" . OX::assetPath() . \"/images/info.gif' width='16' height='16' border='0' align='absmiddle'>$strNoStats</div>\";\n}\n\n// Store preferences\n$session['prefs'][$pageName]['hideinactive'] = $hideinactive;\n$session['prefs'][$pageName]['listorder'] = $listorder;\n$session['prefs'][$pageName]['nodes'] = implode (\",\", $aNodes);\n$session['prefs'][$pageName]['orderdirection'] = $orderdirection;\n$session['prefs'][$pageName]['day'] = $day;\n$session['prefs'][$pageName]['howLong'] = $howLong;\n$session['prefs'][$pageName]['hour'] = $hour;\n$session['prefs'][$pageName]['editStatuses'] = $editStatuses;\n$session['prefs']['GLOBALS']['period_preset'] = $period_preset;\n$session['prefs']['GLOBALS']['period_start'] = $period_start;\n$session['prefs']['GLOBALS']['period_end'] = $period_end;\nphpAds_SessionDataStore();\n\n// Display page footer\nphpAds_PageFooter();\n\n?>\n"], "filenames": ["lib/max/other/html.php", "lib/templates/admin/layout/links-container.html", "www/admin/stats-conversions.php"], "buggy_code_start_loc": [195, 23, 61], "buggy_code_end_loc": [215, 24, 473], "fixing_code_start_loc": [195, 23, 61], "fixing_code_end_loc": [216, 24, 476], "type": "CWE-79", "message": "Revive Adserver before 3.2.3 suffers from Reflected XSS. `www/admin/stats.php` is vulnerable to reflected XSS attacks via multiple parameters that are not properly sanitised or escaped when displayed, such as setPerPage, pageId, bannerid, period_start, period_end, and possibly others.", "other": {"cve": {"id": "CVE-2016-9457", "sourceIdentifier": "support@hackerone.com", "published": "2017-03-28T02:59:00.700", "lastModified": "2017-03-30T01:59:01.567", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Revive Adserver before 3.2.3 suffers from Reflected XSS. `www/admin/stats.php` is vulnerable to reflected XSS attacks via multiple parameters that are not properly sanitised or escaped when displayed, such as setPerPage, pageId, bannerid, period_start, period_end, and possibly others."}, {"lang": "es", "value": "Revive Adserver en versiones anteriores a 3.2.3 sufre de XSS reflejado. `www/admin/stats.php` es vulnerable a los ataques XSS reflejados a trav\u00e9s de m\u00faltiples par\u00e1metros que no se desinfectan correctamente o se escapan cuando se muestran, como setPerPage, pageId, bannerid, period_start, period_end y posiblemente otros."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "support@hackerone.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:revive-adserver:revive_adserver:*:*:*:*:*:*:*:*", "versionEndIncluding": "3.2.2", "matchCriteriaId": "94F64F5A-ACD3-4AED-82BE-832D7B4801DA"}]}]}], "references": [{"url": "http://www.securityfocus.com/bid/83964", "source": "support@hackerone.com"}, {"url": "https://github.com/revive-adserver/revive-adserver/commit/ecbe822b48ef4ff61c2c6357c0c94199a81946f4", "source": "support@hackerone.com", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}, {"url": "https://hackerone.com/reports/107879", "source": "support@hackerone.com", "tags": ["Permissions Required"]}, {"url": "https://www.revive-adserver.com/security/revive-sa-2016-001/", "source": "support@hackerone.com", "tags": ["Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/revive-adserver/revive-adserver/commit/ecbe822b48ef4ff61c2c6357c0c94199a81946f4"}}