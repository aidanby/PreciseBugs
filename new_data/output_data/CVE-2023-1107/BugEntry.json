{"buggy_code": ["<?php\n\nclass admin_uploader_mediamanager extends AdminPanelAction {\n\n\tvar $finfo;\n\n\tvar $conf;\n\n\tvar $langres = 'plugin:mediamanager';\n\n\tfunction cmpfiles($a, $b) {\n\t\t$c = strcmp($a ['type'], $b ['type']);\n\t\tif ($c == 0) {\n\t\t\treturn strcmp($a ['name'], $b ['name']);\n\t\t}\n\t\treturn $c;\n\t}\n\n\tfunction formatBytes($bytes, $precision = 2) {\n\t\t$units = array(\n\t\t\t'B',\n\t\t\t'KB',\n\t\t\t'MB',\n\t\t\t'GB',\n\t\t\t'TB'\n\t\t);\n\n\t\t$bytes = max($bytes, 0);\n\t\t$pow = floor(($bytes ? log($bytes) : 0) / log(1024));\n\t\t$pow = min($pow, count($units) - 1);\n\n\t\t$bytes /= pow(1024, $pow);\n\n\t\treturn round($bytes, $precision) . ' ' . $units [$pow];\n\t}\n\n\tfunction getFileInfo($filepath) {\n\t\tglobal $fp_config;\n\n\t\t$info = array(\n\t\t\t\"name\" => basename($filepath),\n\t\t\t\"size\" => $this->formatBytes(filesize($filepath)),\n\t\t\t\"mtime\" => date_strformat($fp_config ['locale'] ['dateformatshort'], filemtime($filepath))\n\t\t);\n\n\t\tif (isset($this->conf ['usecount'] [basename($filepath)])) {\n\t\t\t$info ['usecount'] = $this->conf ['usecount'] [basename($filepath)];\n\t\t} else {\n\t\t\t$info ['usecount'] = null;\n\t\t}\n\n\t\treturn $info;\n\t}\n\n\tfunction setup() {\n\t\t$this->smarty->assign('admin_resource', \"plugin:mediamanager/admin.plugin.mediamanager.files\");\n\t}\n\n\tfunction deleteFolder($folder, $mmbaseurl) {\n\t\tif (!file_exists($folder))\n\t\t\treturn false;\n\t\t$dir = opendir($folder);\n\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\tif (!fs_is_directorycomponent($file)) {\n\t\t\t\tif (is_dir($folder . \"/\" . $file)) {\n\t\t\t\t\t$this->deleteFolder($folder . \"/\" . $file, $mmbaseurl);\n\t\t\t\t} else {\n\t\t\t\t\tif (!unlink($folder . \"/\" . $file))\n\t\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn rmdir($folder);\n\t}\n\n\tfunction doItemActions($folder, $mmbaseurl) {\n\t\t/* delete file */\n\t\tif (isset($_GET ['deletefile'])) {\n\t\t\tlist ($type, $name) = explode(\"-\", $_GET ['deletefile'], 2);\n\t\t\tswitch ($type) {\n\t\t\t\tcase 'attachs':\n\t\t\t\t\t$type = ABS_PATH . ATTACHS_DIR;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'images':\n\t\t\t\t\t$type = ABS_PATH . IMAGES_DIR . $folder;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'gallery':\n\t\t\t\t\tif (!$this->deleteFolder(ABS_PATH . IMAGES_DIR . $name, $mmbaseurl))\n\t\t\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\t\t@utils_redirect($mmbaseurl . '&status=1');\n\t\t\t\t\treturn true;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\t{\n\t\t\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t}\n\t\t\tif (!file_exists($type . $name)) {\n\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (!unlink($type . $name)) {\n\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\t@utils_redirect($mmbaseurl . '&status=1');\n\t\t\treturn true;\n\t\t}\n\t\tif (isset($_GET ['status'])) {\n\t\t\t$this->smarty->assign('success', $_GET ['status']);\n\t\t}\n\t\treturn false;\n\t}\n\n\tfunction main() {\n\t\t$mmbaseurl = \"admin.php?p=uploader&action=mediamanager\";\n\t\t$folder = \"\";\n\t\t$gallery = \"\";\n\t\tif (isset($_GET ['gallery']) && !fs_is_directorycomponent($_GET ['gallery'])) {\n\t\t\t$mmbaseurl .= \"&gallery=\" . $_GET ['gallery'];\n\t\t\t$gallery = str_replace(\"/\", \"\", $_GET ['gallery']);\n\t\t\t$folder = $gallery . \"/\";\n\t\t}\n\n\t\t$weburl = plugin_geturl('mediamanager');\n\t\t$this->conf = plugin_getoptions('mediamanager');\n\t\tif ($this->doItemActions($folder, $mmbaseurl))\n\t\t\treturn;\n\n\t\t$files = array();\n\t\t$galleries = array();\n\n\t\t$files_needupdate = array();\n\t\t$galleries_needupdate = array();\n\n\t\t# galleries (alwais from IMAGES_DIR)\n\t\tif (file_exists(ABS_PATH . IMAGES_DIR)) {\n\t\t\t$dir = opendir(ABS_PATH . IMAGES_DIR);\n\t\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\t\t$fullpath = ABS_PATH . IMAGES_DIR . $file;\n\t\t\t\tif (!fs_is_directorycomponent($file) && !fs_is_hidden_file($file) && is_dir($fullpath)) {\n\t\t\t\t\t$info = $this->getFileInfo($fullpath);\n\t\t\t\t\t$info ['type'] = \"gallery\";\n\t\t\t\t\t$galleries [$fullpath] = $info;\n\t\t\t\t\tif (is_null($info ['usecount'])) {\n\t\t\t\t\t\t$galleries_needupdate [] = $fullpath;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t# attachs (NO attachs in galleries)\n\t\tif ($folder == \"\" && file_exists(ABS_PATH . ATTACHS_DIR)) {\n\t\t\t$dir = opendir(ABS_PATH . ATTACHS_DIR);\n\t\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\t\tif (!fs_is_directorycomponent($file) && !fs_is_hidden_file($file)) {\n\t\t\t\t\t$fullpath = ABS_PATH . ATTACHS_DIR . $file;\n\t\t\t\t\t$info = $this->getFileInfo($fullpath);\n\t\t\t\t\t$info ['type'] = \"attachs\";\n\t\t\t\t\t$info ['url'] = BLOG_ROOT . ATTACHS_DIR . $file;\n\t\t\t\t\t$files [$fullpath] = $info;\n\t\t\t\t\tif (is_null($info ['usecount'])) {\n\t\t\t\t\t\t$files_needupdate [] = $fullpath;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t# images\n\t\tif (file_exists(ABS_PATH . IMAGES_DIR . $folder)) {\n\t\t\t$dir = opendir(ABS_PATH . IMAGES_DIR . $folder);\n\t\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\t\t$fullpath = ABS_PATH . IMAGES_DIR . $folder . $file;\n\t\t\t\tif (!fs_is_directorycomponent($file) && !fs_is_hidden_file($file) && !is_dir($fullpath)) {\n\t\t\t\t\t$info = $this->getFileInfo($fullpath);\n\t\t\t\t\t$info ['type'] = \"images\";\n\t\t\t\t\t$info ['url'] = BLOG_ROOT . IMAGES_DIR . $folder . $file;\n\t\t\t\t\t$files [$fullpath] = $info;\n\t\t\t\t\t# NO count for images in galleries\n\t\t\t\t\tif ($folder == \"\" && is_null($info ['usecount'])) {\n\t\t\t\t\t\t$files_needupdate [] = $fullpath;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tmediamanager_updateUseCountArr($files, $files_needupdate);\n\t\tmediamanager_updateUseCountArr($galleries, $galleries_needupdate);\n\n\t\tusort($files, Array(\n\t\t\t\"admin_uploader_mediamanager\",\n\t\t\t\"cmpfiles\"\n\t\t));\n\t\t$totalfilescount = (string) count($files);\n\t\t# paginator\n\t\t$pages = ceil((count($files) + count($galleries)) / ITEMSPERPAGE);\n\t\tif ($pages == 0)\n\t\t\t$pages = 1;\n\t\tif (isset($_GET ['page'])) {\n\t\t\t$page = (int) $_GET ['page'];\n\t\t} else {\n\t\t\t$page = 1;\n\t\t}\n\t\tif ($page < 1)\n\t\t\t$page = 1;\n\t\tif ($page > $pages)\n\t\t\t$page = $pages;\n\t\t$pagelist = array();\n\t\tfor($k = 1; $k <= $pages; $k++)\n\t\t\t$pagelist [] = $k;\n\t\t$paginator = array(\n\t\t\t\"total\" => $pages,\n\t\t\t\"current\" => $page,\n\t\t\t\"limit\" => ITEMSPERPAGE,\n\t\t\t\"pages\" => $pagelist\n\t\t);\n\n\t\t$startfrom = ($page - 1) * ITEMSPERPAGE;\n\t\t$galleriesout = count(array_slice($galleries, 0, $startfrom));\n\t\t$dropdowngalleries = $galleries;\n\t\t$galleries = array_slice($galleries, $startfrom, ITEMSPERPAGE);\n\n\t\t$files = array_slice($files, $startfrom - $galleriesout, ITEMSPERPAGE - count($galleries));\n\n\t\t$this->smarty->assign('paginator', $paginator);\n\t\t$this->smarty->assign('files', $files);\n\t\t$this->smarty->assign('galleries', $galleries);\n\t\t$this->smarty->assign('dwgalleries', $dropdowngalleries);\n\t\t$this->smarty->assign('mmurl', $weburl);\n\t\t$this->smarty->assign('mmbaseurl', $mmbaseurl);\n\t\t$this->smarty->assign('currentgallery', $gallery);\n\t\t$this->smarty->assign('totalfilescount', $totalfilescount);\n\t}\n\n\tfunction onsubmit($data = NULL) {\n\t\tif (isset($_POST ['mm-newgallery'])) {\n\t\t\t$newgallery = $_POST ['mm-newgallery-name'];\n\t\t\tif ($newgallery == \"\") {\n\t\t\t\t$this->smarty->assign('success', -3);\n\t\t\t\treturn 2;\n\t\t\t}\n\t\t\t$newgallery = str_replace(\"/\", \"\", $newgallery);\n\t\t\t$newgallery = str_replace(\".\", \"\", $newgallery);\n\t\t\t// create images folder if not existant\n\t\t\tif (!file_exists(ABS_PATH . IMAGES_DIR)) {\n\t\t\t\tmkdir(ABS_PATH . IMAGES_DIR);\n\t\t\t}\n\t\t\t// now create gallery folder\n\t\t\tif (mkdir(ABS_PATH . IMAGES_DIR . $newgallery)) {\n\t\t\t\t$this->smarty->assign('success', 3);\n\t\t\t} else {\n\t\t\t\t$this->smarty->assign('success', -2);\n\t\t\t}\n\t\t\treturn 2;\n\t\t}\n\n\t\t$folder = \"\";\n\t\tif (isset($_GET ['gallery'])) {\n\t\t\t$mmbaseurl .= \"&gallery=\" . $_GET ['gallery'];\n\t\t\t$folder = str_replace(\"/\", \"\", $_GET ['gallery']) . \"/\";\n\t\t}\n\n\t\tlist ($action, $arg) = explode(\"-\", $_POST ['action'], 2);\n\t\tif (!isset($_POST ['file']))\n\t\t\treturn 2;\n\t\tforeach ($_POST ['file'] as $file => $v) {\n\t\t\tlist ($type, $name) = explode(\"-\", $file, 2);\n\t\t\tif ($action == 'atg' && $type == 'images') {\n\t\t\t\tcopy(ABS_PATH . IMAGES_DIR . $folder . $name, ABS_PATH . IMAGES_DIR . $arg . '/' . $name);\n\t\t\t\t$this->smarty->assign('success', 2);\n\t\t\t}\n\t\t}\n\t\treturn 2;\n\t}\n\n}\n\nadmin_addpanelaction('uploader', 'mediamanager', true);"], "fixing_code": ["<?php\n\nclass admin_uploader_mediamanager extends AdminPanelAction {\n\n\tvar $finfo;\n\n\tvar $conf;\n\n\tvar $langres = 'plugin:mediamanager';\n\n\tfunction cmpfiles($a, $b) {\n\t\t$c = strcmp($a ['type'], $b ['type']);\n\t\tif ($c == 0) {\n\t\t\treturn strcmp($a ['name'], $b ['name']);\n\t\t}\n\t\treturn $c;\n\t}\n\n\tfunction formatBytes($bytes, $precision = 2) {\n\t\t$units = array(\n\t\t\t'B',\n\t\t\t'KB',\n\t\t\t'MB',\n\t\t\t'GB',\n\t\t\t'TB'\n\t\t);\n\n\t\t$bytes = max($bytes, 0);\n\t\t$pow = floor(($bytes ? log($bytes) : 0) / log(1024));\n\t\t$pow = min($pow, count($units) - 1);\n\n\t\t$bytes /= pow(1024, $pow);\n\n\t\treturn round($bytes, $precision) . ' ' . $units [$pow];\n\t}\n\n\tfunction getFileInfo($filepath) {\n\t\tglobal $fp_config;\n\n\t\t$info = array(\n\t\t\t\"name\" => basename($filepath),\n\t\t\t\"size\" => $this->formatBytes(filesize($filepath)),\n\t\t\t\"mtime\" => date_strformat($fp_config ['locale'] ['dateformatshort'], filemtime($filepath))\n\t\t);\n\n\t\tif (isset($this->conf ['usecount'] [basename($filepath)])) {\n\t\t\t$info ['usecount'] = $this->conf ['usecount'] [basename($filepath)];\n\t\t} else {\n\t\t\t$info ['usecount'] = null;\n\t\t}\n\n\t\treturn $info;\n\t}\n\n\tfunction setup() {\n\t\t$this->smarty->assign('admin_resource', \"plugin:mediamanager/admin.plugin.mediamanager.files\");\n\t}\n\n\tfunction deleteFolder($folder, $mmbaseurl) {\n\t\tif (!file_exists($folder))\n\t\t\treturn false;\n\t\t$dir = opendir($folder);\n\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\tif (!fs_is_directorycomponent($file)) {\n\t\t\t\tif (is_dir($folder . \"/\" . $file)) {\n\t\t\t\t\t$this->deleteFolder($folder . \"/\" . $file, $mmbaseurl);\n\t\t\t\t} else {\n\t\t\t\t\tif (!unlink($folder . \"/\" . $file))\n\t\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn rmdir($folder);\n\t}\n\n\tfunction doItemActions($folder, $mmbaseurl) {\n\t\t/* delete file */\n\t\tif (isset($_GET ['deletefile'])) {\n\t\t\tlist ($type, $name) = explode(\"-\", $_GET ['deletefile'], 2);\n\t\t\tswitch ($type) {\n\t\t\t\tcase 'attachs':\n\t\t\t\t\t$type = ABS_PATH . ATTACHS_DIR;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'images':\n\t\t\t\t\t$type = ABS_PATH . IMAGES_DIR . $folder;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'gallery':\n\t\t\t\t\tif (!$this->deleteFolder(ABS_PATH . IMAGES_DIR . $name, $mmbaseurl))\n\t\t\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\t\t@utils_redirect($mmbaseurl . '&status=1');\n\t\t\t\t\treturn true;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\t{\n\t\t\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t}\n\t\t\tif (!file_exists($type . $name)) {\n\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (!unlink($type . $name)) {\n\t\t\t\t@utils_redirect($mmbaseurl . '&status=-1');\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\t@utils_redirect($mmbaseurl . '&status=1');\n\t\t\treturn true;\n\t\t}\n\t\tif (isset($_GET ['status'])) {\n\t\t\t$this->smarty->assign('success', $_GET ['status']);\n\t\t}\n\t\treturn false;\n\t}\n\n\tfunction main() {\n\t\t$mmbaseurl = \"admin.php?p=uploader&action=mediamanager\";\n\t\t$folder = \"\";\n\t\t$gallery = \"\";\n\t\tif (isset($_GET ['gallery']) && !fs_is_directorycomponent($_GET ['gallery'])) {\n\t\t\t$mmbaseurl .= \"&gallery=\" . $_GET ['gallery'];\n\t\t\t$gallery = str_replace(\"/\", \"\", $_GET ['gallery']);\n\t\t\t$folder = $gallery . \"/\";\n\t\t}\n\n\t\t$weburl = plugin_geturl('mediamanager');\n\t\t$this->conf = plugin_getoptions('mediamanager');\n\t\tif ($this->doItemActions($folder, $mmbaseurl))\n\t\t\treturn;\n\n\t\t$files = array();\n\t\t$galleries = array();\n\n\t\t$files_needupdate = array();\n\t\t$galleries_needupdate = array();\n\n\t\t# galleries (alwais from IMAGES_DIR)\n\t\tif (file_exists(ABS_PATH . IMAGES_DIR)) {\n\t\t\t$dir = opendir(ABS_PATH . IMAGES_DIR);\n\t\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\t\t$fullpath = ABS_PATH . IMAGES_DIR . $file;\n\t\t\t\tif (!fs_is_directorycomponent($file) && !fs_is_hidden_file($file) && is_dir($fullpath)) {\n\t\t\t\t\t$info = $this->getFileInfo($fullpath);\n\t\t\t\t\t$info ['type'] = \"gallery\";\n\t\t\t\t\t$galleries [$fullpath] = $info;\n\t\t\t\t\tif (is_null($info ['usecount'])) {\n\t\t\t\t\t\t$galleries_needupdate [] = $fullpath;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t# attachs (NO attachs in galleries)\n\t\tif ($folder == \"\" && file_exists(ABS_PATH . ATTACHS_DIR)) {\n\t\t\t$dir = opendir(ABS_PATH . ATTACHS_DIR);\n\t\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\t\tif (!fs_is_directorycomponent($file) && !fs_is_hidden_file($file)) {\n\t\t\t\t\t$fullpath = ABS_PATH . ATTACHS_DIR . $file;\n\t\t\t\t\t$info = $this->getFileInfo($fullpath);\n\t\t\t\t\t$info ['type'] = \"attachs\";\n\t\t\t\t\t$info ['url'] = BLOG_ROOT . ATTACHS_DIR . $file;\n\t\t\t\t\t$files [$fullpath] = $info;\n\t\t\t\t\tif (is_null($info ['usecount'])) {\n\t\t\t\t\t\t$files_needupdate [] = $fullpath;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t# images\n\t\tif (file_exists(ABS_PATH . IMAGES_DIR . $folder)) {\n\t\t\t$dir = opendir(ABS_PATH . IMAGES_DIR . $folder);\n\t\t\twhile (false !== ($file = readdir($dir))) {\n\t\t\t\t$fullpath = ABS_PATH . IMAGES_DIR . $folder . $file;\n\t\t\t\tif (!fs_is_directorycomponent($file) && !fs_is_hidden_file($file) && !is_dir($fullpath)) {\n\t\t\t\t\t$info = $this->getFileInfo($fullpath);\n\t\t\t\t\t$info ['type'] = \"images\";\n\t\t\t\t\t$info ['url'] = BLOG_ROOT . IMAGES_DIR . $folder . $file;\n\t\t\t\t\t$files [$fullpath] = $info;\n\t\t\t\t\t# NO count for images in galleries\n\t\t\t\t\tif ($folder == \"\" && is_null($info ['usecount'])) {\n\t\t\t\t\t\t$files_needupdate [] = $fullpath;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tmediamanager_updateUseCountArr($files, $files_needupdate);\n\t\tmediamanager_updateUseCountArr($galleries, $galleries_needupdate);\n\n\t\tusort($files, Array(\n\t\t\t\"admin_uploader_mediamanager\",\n\t\t\t\"cmpfiles\"\n\t\t));\n\t\t$totalfilescount = (string) count($files);\n\t\t# paginator\n\t\t$pages = ceil((count($files) + count($galleries)) / ITEMSPERPAGE);\n\t\tif ($pages == 0)\n\t\t\t$pages = 1;\n\t\tif (isset($_GET ['page'])) {\n\t\t\t$page = (int) $_GET ['page'];\n\t\t} else {\n\t\t\t$page = 1;\n\t\t}\n\t\tif ($page < 1)\n\t\t\t$page = 1;\n\t\tif ($page > $pages)\n\t\t\t$page = $pages;\n\t\t$pagelist = array();\n\t\tfor($k = 1; $k <= $pages; $k++)\n\t\t\t$pagelist [] = $k;\n\t\t$paginator = array(\n\t\t\t\"total\" => $pages,\n\t\t\t\"current\" => $page,\n\t\t\t\"limit\" => ITEMSPERPAGE,\n\t\t\t\"pages\" => $pagelist\n\t\t);\n\n\t\t$startfrom = ($page - 1) * ITEMSPERPAGE;\n\t\t$galleriesout = count(array_slice($galleries, 0, $startfrom));\n\t\t$dropdowngalleries = $galleries;\n\t\t$galleries = array_slice($galleries, $startfrom, ITEMSPERPAGE);\n\n\t\t$files = array_slice($files, $startfrom - $galleriesout, ITEMSPERPAGE - count($galleries));\n\n\t\t$this->smarty->assign('paginator', $paginator);\n\t\t$this->smarty->assign('files', $files);\n\t\t$this->smarty->assign('galleries', $galleries);\n\t\t$this->smarty->assign('dwgalleries', $dropdowngalleries);\n\t\t$this->smarty->assign('mmurl', $weburl);\n\t\t$this->smarty->assign('mmbaseurl', $mmbaseurl);\n\t\t$this->smarty->assign('currentgallery', $gallery);\n\t\t$this->smarty->assign('totalfilescount', $totalfilescount);\n\t}\n\n\tfunction onsubmit($data = NULL) {\n\t\tif (isset($_POST ['mm-newgallery'])) {\n\t\t\t$newgallery = strip_tags($_POST ['mm-newgallery-name']);\n\t\t\tif ($newgallery == \"\") {\n\t\t\t\t$this->smarty->assign('success', -3);\n\t\t\t\treturn 2;\n\t\t\t}\n\t\t\t$newgallery = str_replace(\"/\", \"\", $newgallery);\n\t\t\t$newgallery = str_replace(\".\", \"\", $newgallery);\n\t\t\t// create images folder if not existant\n\t\t\tif (!file_exists(ABS_PATH . IMAGES_DIR)) {\n\t\t\t\tmkdir(ABS_PATH . IMAGES_DIR);\n\t\t\t}\n\t\t\t// now create gallery folder\n\t\t\tif (mkdir(ABS_PATH . IMAGES_DIR . $newgallery)) {\n\t\t\t\t$this->smarty->assign('success', 3);\n\t\t\t} else {\n\t\t\t\t$this->smarty->assign('success', -2);\n\t\t\t}\n\t\t\treturn 2;\n\t\t}\n\n\t\t$folder = \"\";\n\t\tif (isset($_GET ['gallery'])) {\n\t\t\t$mmbaseurl .= \"&gallery=\" . $_GET ['gallery'];\n\t\t\t$folder = str_replace(\"/\", \"\", $_GET ['gallery']) . \"/\";\n\t\t}\n\n\t\tlist ($action, $arg) = explode(\"-\", $_POST ['action'], 2);\n\t\tif (!isset($_POST ['file']))\n\t\t\treturn 2;\n\t\tforeach ($_POST ['file'] as $file => $v) {\n\t\t\tlist ($type, $name) = explode(\"-\", $file, 2);\n\t\t\tif ($action == 'atg' && $type == 'images') {\n\t\t\t\tcopy(ABS_PATH . IMAGES_DIR . $folder . $name, ABS_PATH . IMAGES_DIR . $arg . '/' . $name);\n\t\t\t\t$this->smarty->assign('success', 2);\n\t\t\t}\n\t\t}\n\t\treturn 2;\n\t}\n\n}\n\nadmin_addpanelaction('uploader', 'mediamanager', true);"], "filenames": ["fp-plugins/mediamanager/panels/panel.mediamanager.file.php"], "buggy_code_start_loc": [236], "buggy_code_end_loc": [237], "fixing_code_start_loc": [236], "fixing_code_end_loc": [237], "type": "CWE-79", "message": "Cross-site Scripting (XSS) - Stored in GitHub repository flatpressblog/flatpress prior to 1.3.", "other": {"cve": {"id": "CVE-2023-1107", "sourceIdentifier": "security@huntr.dev", "published": "2023-03-02T02:15:42.057", "lastModified": "2023-03-03T18:57:23.693", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross-site Scripting (XSS) - Stored in GitHub repository flatpressblog/flatpress prior to 1.3."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:flatpress:flatpress:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.3", "matchCriteriaId": "2C1FD291-99DD-40F3-96DB-D79CA8279692"}]}]}], "references": [{"url": "https://github.com/flatpressblog/flatpress/commit/d3f329496536dc99f9707f2f295d571d65a496f5", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/4b880868-bd28-4fd0-af56-7686e55d3762", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/flatpressblog/flatpress/commit/d3f329496536dc99f9707f2f295d571d65a496f5"}}