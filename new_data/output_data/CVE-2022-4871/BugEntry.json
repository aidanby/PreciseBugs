{"buggy_code": ["<?php\n\nclass JSON_LoadUsers extends JSONAdmin\n{\n\tpublic function execute()\n\t{\n\t\t$sort\t\t= Functions::Post( 'sort' );\n\t\t$direction\t= Functions::Post( 'direction' );\n\t\t\n\t\tif ( !$this->_Load_Users( $sort, $direction, $users ) )\n\t\t{\n\t\t\treturn $this->setDBError();\n\t\t}\n\t\t\n\t\tforeach( $users as &$loaded_user )\n\t\t{\n\t\t\t$loaded_user[ 'last_on' ] \t\t\t= Functions::FormatDate( $loaded_user[ 'last_on' ] );\n\t\t\t$loaded_user[ 'current_place' ] \t= Functions::Place( $loaded_user[ 'current_place' ] ); \n\t\t}\n\n\t\treturn $this->setData( $users );\t\t\n\t}\n\n\t// Helper functions\n\n\tprivate function _Load_Users( $sort, $direction, &$users )\n\t{\n\t\t$db_weeks\t= new Weeks( $this->_db );\n\t\t$current\t= $db_weeks->Current();\n\t\t$direction \t= ( $direction === 'asc' ) ? 'ASC' : 'DESC';\n\t\t$sql \t\t= \"SELECT\n\t\t\t\t\t\t\tu.*,\n\t\t\t\t\t\t\tCONCAT( u.fname, ' ', u.lname ) AS name,\n\t\t\t\t\t\t\t( SELECT COUNT( * ) FROM failed_logins WHERE email = u.email ) AS failed_logins,\n\t\t\t\t\t\t\t( SELECT COUNT( * ) FROM sessions WHERE userid = u.id ) AS active_sessions,\n\t\t\t\t\t\t\tCOUNT( g.id ) AS remaining\n\t\t\t\t\t\tFROM\n\t\t\t\t\t\t\tusers u\n\t\t\t\t\t\t\tLEFT OUTER JOIN games g ON 1 = 1\n\t\t\t\t\t\t\tLEFT OUTER JOIN picks p ON p.game_id = g.id AND p.user_id = u.id\n\t\t\t\t\t\tWHERE\n\t\t\t\t\t\t\tg.week = ? AND\n\t\t\t\t\t\t\tp.id IS NULL\n\t\t\t\t\t\tGROUP BY\n\t\t\t\t\t\t\tu.id\n\t\t\t\t\t\tORDER BY\n\t\t\t\t\t\t\t{$sort} {$direction}\";\n\t\treturn $this->_db->select( $sql, $users, $current );\n\t}\n}\n"], "fixing_code": ["<?php\n\nclass JSON_LoadUsers extends JSONAdmin\n{\n\tpublic function execute()\n\t{\n\t\t$sort\t\t= Functions::Post( 'sort' );\n\t\t$direction\t= Functions::Post( 'direction' );\n\n\t\tif ( !$this->_Load_Users( $sort, $direction, $users ) )\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tforeach( $users as &$loaded_user )\n\t\t{\n\t\t\t$loaded_user[ 'last_on' ] \t\t\t= Functions::FormatDate( $loaded_user[ 'last_on' ] );\n\t\t\t$loaded_user[ 'current_place' ] \t= Functions::Place( $loaded_user[ 'current_place' ] );\n\t\t}\n\n\t\treturn $this->setData( $users );\n\t}\n\n\t// Helper functions\n\n\tprivate function _Load_Users( $sort, $direction, &$users )\n\t{\n\t\t$db_weeks\t= new Weeks( $this->_db );\n\t\t$current\t= $db_weeks->Current();\n\t\t$direction \t= ( $direction === 'asc' ) ? 'ASC' : 'DESC';\n\n\t\tswitch ( $sort )\n\t\t{\n\t\t\tcase 'name'\t\t\t\t:\n\t\t\tcase 'current_place'\t:\n\t\t\tcase 'last_on'\t\t\t:\n\t\t\tcase 'paid'\t\t\t\t:\n\t\t\tcase 'failed_logins'\t:\n\t\t\tcase 'active_sessions'\t:\n\t\t\tcase 'remaining'\t\t:\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault\t\t\t\t\t:\n\t\t\t{\n\t\t\t\treturn $this->setError( array( '#Error#', 'Invalid sort' ) );\n\t\t\t}\n\t\t}\n\n\t\t$sql \t\t= \"SELECT\n\t\t\t\t\t\t\tu.*,\n\t\t\t\t\t\t\tCONCAT( u.fname, ' ', u.lname ) AS name,\n\t\t\t\t\t\t\t( SELECT COUNT( * ) FROM failed_logins WHERE email = u.email ) AS failed_logins,\n\t\t\t\t\t\t\t( SELECT COUNT( * ) FROM sessions WHERE userid = u.id ) AS active_sessions,\n\t\t\t\t\t\t\tCOUNT( g.id ) AS remaining\n\t\t\t\t\t\tFROM\n\t\t\t\t\t\t\tusers u\n\t\t\t\t\t\t\tLEFT OUTER JOIN games g ON 1 = 1\n\t\t\t\t\t\t\tLEFT OUTER JOIN picks p ON p.game_id = g.id AND p.user_id = u.id\n\t\t\t\t\t\tWHERE\n\t\t\t\t\t\t\tg.week = ? AND\n\t\t\t\t\t\t\tp.id IS NULL\n\t\t\t\t\t\tGROUP BY\n\t\t\t\t\t\t\tu.id\n\t\t\t\t\t\tORDER BY\n\t\t\t\t\t\t\t{$sort} {$direction}\";\n\n\t\tif ( !$this->_db->select( $sql, $users, $current ) )\n\t\t{\n\t\t\treturn $this->setDBError();\n\t\t}\n\n\t\treturn true;\n\t}\n}\n"], "filenames": ["html/includes/runtime/admin/JSON/LoadUsers.php"], "buggy_code_start_loc": [9], "buggy_code_end_loc": [49], "fixing_code_start_loc": [9], "fixing_code_end_loc": [74], "type": "CWE-89", "message": "A vulnerability classified as problematic was found in ummmmm nflpick-em.com up to 2.2.x. This vulnerability affects the function _Load_Users of the file html/includes/runtime/admin/JSON/LoadUsers.php. The manipulation of the argument sort leads to sql injection. The attack can be initiated remotely. The name of the patch is dd77a35942f527ea0beef5e0ec62b92e8b93211e. It is recommended to apply a patch to fix this issue. VDB-217270 is the identifier assigned to this vulnerability. NOTE: JSON entrypoint is only accessible via an admin account", "other": {"cve": {"id": "CVE-2022-4871", "sourceIdentifier": "cna@vuldb.com", "published": "2023-01-03T12:15:10.660", "lastModified": "2023-01-09T21:09:17.993", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability classified as problematic was found in ummmmm nflpick-em.com up to 2.2.x. This vulnerability affects the function _Load_Users of the file html/includes/runtime/admin/JSON/LoadUsers.php. The manipulation of the argument sort leads to sql injection. The attack can be initiated remotely. The name of the patch is dd77a35942f527ea0beef5e0ec62b92e8b93211e. It is recommended to apply a patch to fix this issue. VDB-217270 is the identifier assigned to this vulnerability. NOTE: JSON entrypoint is only accessible via an admin account"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:U/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 4.7, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.2, "impactScore": 3.4}], "cvssMetricV2": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:M/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "MULTIPLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 5.8}, "baseSeverity": "MEDIUM", "exploitabilityScore": 6.4, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}, {"source": "cna@vuldb.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:nflpick-em:nflpick-em:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.3.0", "matchCriteriaId": "B7789A33-BFA5-48C2-932B-8EB9AFF6D19C"}]}]}], "references": [{"url": "https://github.com/ummmmm/nflpick-em.com/commit/dd77a35942f527ea0beef5e0ec62b92e8b93211e", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?ctiid.217270", "source": "cna@vuldb.com", "tags": ["Third Party Advisory", "VDB Entry"]}, {"url": "https://vuldb.com/?id.217270", "source": "cna@vuldb.com", "tags": ["Third Party Advisory", "VDB Entry"]}]}, "github_commit_url": "https://github.com/ummmmm/nflpick-em.com/commit/dd77a35942f527ea0beef5e0ec62b92e8b93211e"}}