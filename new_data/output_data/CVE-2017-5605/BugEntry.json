{"buggy_code": ["<?php\n/*\n * @file Carbons.php\n *\n * @brief Handle incoming carbons messages\n *\n * Copyright 2014 edhelas <edhelas@edhelas-laptop>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program; if not, write to the Free Software\n * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,\n * MA 02110-1301, USA.\n *\n *\n */\n\nnamespace Moxl\\Xec\\Payload;\n\nclass Carbons extends Payload\n{\n    public function handle($stanza, $parent = false)\n    {\n        $message = $stanza->forwarded->message;\n\n        $jid = explode('/',(string)$message->attributes()->from);\n        $to = current(explode('/',(string)$message->attributes()->to));\n\n        if($message->composing)\n            $this->event('composing', array($jid[0], $to));\n        if($message->paused)\n            $this->event('paused', array($jid[0], $to));\n        if($message->gone)\n            $this->event('gone', array($jid[0], $to));\n\n        if($message->body || $message->subject) {\n            $m = new \\Modl\\Message;\n            $m->set($message, $stanza->forwarded);\n\n            if(!preg_match('#^\\?OTR#', $m->body)) {\n                $md = new \\Modl\\MessageDAO;\n                $md->set($m);\n\n                $this->pack($m);\n                $this->deliver();\n            }\n        }\n    }\n}\n"], "fixing_code": ["<?php\n\nnamespace Moxl\\Xec\\Payload;\n\nclass Carbons extends Payload\n{\n    public function handle($stanza, $parent = false)\n    {\n        $parentfrom = current(explode('/', (string)$parent->attributes()->from));\n\n        $message = $stanza->forwarded->message;\n\n        $from = current(explode('/',(string)$message->attributes()->from));\n        $to = current(explode('/',(string)$message->attributes()->to));\n\n        $user = new \\User;\n        if($parentfrom == $user->getLogin()) {\n            if($message->composing)\n                $this->event('composing', [$from, $to]);\n            if($message->paused)\n                $this->event('paused', [$from, $to]);\n            if($message->gone)\n                $this->event('gone', [$from, $to]);\n\n            if($message->body || $message->subject) {\n                $m = new \\Modl\\Message;\n                $m->set($message, $stanza->forwarded);\n\n                if(!preg_match('#^\\?OTR#', $m->body)) {\n                    $md = new \\Modl\\MessageDAO;\n                    $md->set($m);\n\n                    $this->pack($m);\n                    $this->deliver();\n                }\n            }\n        }\n    }\n}\n"], "filenames": ["src/Moxl/Xec/Payload/Carbons.php"], "buggy_code_start_loc": [2], "buggy_code_end_loc": [55], "fixing_code_start_loc": [1], "fixing_code_end_loc": [36], "type": "CWE-20", "message": "An incorrect implementation of \"XEP-0280: Message Carbons\" in multiple XMPP clients allows a remote attacker to impersonate any user, including contacts, in the vulnerable application's display. This allows for various kinds of social engineering attacks. This CVE is for Movim 0.8 - 0.10.", "other": {"cve": {"id": "CVE-2017-5605", "sourceIdentifier": "cve@mitre.org", "published": "2017-02-09T20:59:00.497", "lastModified": "2017-03-01T02:59:05.903", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "An incorrect implementation of \"XEP-0280: Message Carbons\" in multiple XMPP clients allows a remote attacker to impersonate any user, including contacts, in the vulnerable application's display. This allows for various kinds of social engineering attacks. This CVE is for Movim 0.8 - 0.10."}, {"lang": "es", "value": "Una implementaci\u00f3n incorrecta de \"XEP-0280: Message Carbons\" en m\u00faltiples clientes XMPP permite a un atacante remoto personificar cualquier usuario, incluidos los contactos, en la pantalla de la aplicaci\u00f3n vulnerable. Esto permite varios tipos de ataques de ingenier\u00eda social. Esta CVE es para Movim 0.8 - 0.10."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 5.9, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.2, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-20"}, {"lang": "en", "value": "CWE-346"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:movim:movim:0.8:*:*:*:*:*:*:*", "matchCriteriaId": "3A6AF2A7-99C5-418C-A134-F19FE53C6F82"}, {"vulnerable": true, "criteria": "cpe:2.3:a:movim:movim:0.8.1:*:*:*:*:*:*:*", "matchCriteriaId": "19E9E794-3396-4297-AE9E-691E50BC8DAF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:movim:movim:0.9:*:*:*:*:*:*:*", "matchCriteriaId": "ACEAD0C3-ABD3-420E-9C9E-1EAC3F1CCA76"}, {"vulnerable": true, "criteria": "cpe:2.3:a:movim:movim:0.10:*:*:*:*:*:*:*", "matchCriteriaId": "60CB8427-9799-431E-9BD0-2E7DE7B3CD90"}]}]}], "references": [{"url": "http://openwall.com/lists/oss-security/2017/02/09/29", "source": "cve@mitre.org", "tags": ["Exploit", "Mailing List", "Third Party Advisory"]}, {"url": "http://www.securityfocus.com/bid/96177", "source": "cve@mitre.org"}, {"url": "https://github.com/movim/moxl/commit/838b0a42efc3b67cc17d63e25ae1d0ea849cd89b", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://rt-solutions.de/en/2017/02/CVE-2017-5589_xmpp_carbons/", "source": "cve@mitre.org", "tags": ["Exploit", "Technical Description", "Third Party Advisory"]}, {"url": "https://rt-solutions.de/wp-content/uploads/2017/02/CVE-2017-5589_xmpp_carbons.pdf", "source": "cve@mitre.org", "tags": ["Exploit", "Technical Description", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/movim/moxl/commit/838b0a42efc3b67cc17d63e25ae1d0ea849cd89b"}}