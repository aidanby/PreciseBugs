{"buggy_code": ["{\n  \"name\": \"DiscoTOC\",\n  \"component\": true,\n  \"about_url\": \"https://meta.discourse.org/t/discotoc-automatic-table-of-contents/111143\",\n  \"license_url\": \"https://github.com/discourse/DiscoTOC/blob/main/LICENSE\",\n  \"assets\": {\n    \"icons-sprite\": \"/assets/sprite.svg\"\n  }\n}\n", "import domUtils from \"discourse-common/utils/dom-utils\";\nimport { headerOffset } from \"discourse/lib/offset-calculator\";\nimport { iconHTML } from \"discourse-common/lib/icon-library\";\nimport { later } from \"@ember/runloop\";\nimport { slugify } from \"discourse/lib/utilities\";\nimport { withPluginApi } from \"discourse/lib/plugin-api\";\nimport I18n from \"I18n\";\n\nexport default {\n  name: \"disco-toc-main\",\n\n  initialize() {\n    withPluginApi(\"1.0.0\", (api) => {\n      const autoTocCategoryIds = settings.auto_TOC_categories\n        .split(\"|\")\n        .map((id) => parseInt(id, 10));\n\n      const autoTocTags = settings.auto_TOC_tags.split(\"|\");\n\n      api.decorateCookedElement(\n        (el, helper) => {\n          if (helper) {\n            const post = helper.getModel();\n            if (post?.post_number !== 1) {\n              return;\n            }\n\n            const topicCategory = helper.getModel().topic.category_id;\n            const topicTags = helper.getModel().topic.tags;\n\n            const hasTOCmarkup = el?.querySelector(`[data-theme-toc=\"true\"]`);\n            const tocCategory = autoTocCategoryIds?.includes(topicCategory);\n            const tocTag = topicTags?.some((tag) => autoTocTags?.includes(tag));\n\n            if (!hasTOCmarkup && !tocCategory && !tocTag) {\n              document.body.classList.remove(\"d-toc-timeline-visible\");\n              return;\n            }\n\n            let dTocHeadingSelectors =\n              \":scope > h1, :scope > h2, :scope > h3, :scope > h4, :scope > h5\";\n            const headings = el.querySelectorAll(dTocHeadingSelectors);\n\n            if (headings.length < 1) {\n              return;\n            }\n\n            headings.forEach((h, index) => {\n              // suffix uses index for non-Latin languages\n              const suffix = slugify(h.textContent) || index;\n              const id =\n                h.getAttribute(\"id\") || slugify(`toc-${h.nodeName}-${suffix}`);\n\n              h.setAttribute(\"id\", id);\n              h.setAttribute(\"data-d-toc\", id);\n              h.classList.add(\"d-toc-post-heading\");\n            });\n\n            el.classList.add(\"d-toc-cooked\");\n\n            if (document.querySelector(\".d-toc-wrapper\")) {\n              this.insertTOC(headings);\n            } else {\n              // try again if decoration happens while outlet is not rendered\n              // this is due to core resetting `canRender` for topic-navigation\n              // when transitioning between topics\n              later(() => {\n                if (document.querySelector(\".d-toc-wrapper\")) {\n                  this.insertTOC(headings);\n                }\n              }, 300);\n            }\n          }\n        },\n        {\n          id: \"disco-toc\",\n          onlyStream: true,\n          afterAdopt: true,\n        }\n      );\n\n      api.onAppEvent(\"topic:current-post-changed\", (args) => {\n        if (!document.querySelector(\".d-toc-cooked\")) {\n          return;\n        }\n        if (args.post.post_number === 1) {\n          document.body.classList.add(\"d-toc-timeline-visible\");\n        } else {\n          document.body.classList.remove(\"d-toc-timeline-visible\");\n        }\n      });\n\n      api.onAppEvent(\"docs-topic:current-post-scrolled\", () => {\n        this.updateTOCSidebar();\n      });\n\n      api.onAppEvent(\"topic:current-post-scrolled\", (args) => {\n        if (args.postIndex !== 1) {\n          return;\n        }\n\n        this.updateTOCSidebar();\n      });\n\n      api.cleanupStream(() => {\n        document.body.classList.remove(\"d-toc-timeline-visible\");\n        document.removeEventListener(\"click\", this.clickTOC, false);\n      });\n    });\n  },\n\n  updateTOCSidebar() {\n    if (!document.querySelector(\".d-toc-cooked\")) {\n      return;\n    }\n\n    const headings = document.querySelectorAll(\".d-toc-post-heading\");\n    let closestHeadingDistance = null;\n    let closestHeading = null;\n\n    headings.forEach((heading) => {\n      const distance = Math.abs(\n        domUtils.offset(heading).top - headerOffset() - window.scrollY\n      );\n      if (closestHeadingDistance == null || distance < closestHeadingDistance) {\n        closestHeadingDistance = distance;\n        closestHeading = heading;\n      } else {\n        return false;\n      }\n    });\n\n    if (closestHeading) {\n      document.querySelectorAll(\"#d-toc li\").forEach((listItem) => {\n        listItem.classList.remove(\"active\");\n        listItem.classList.remove(\"direct-active\");\n      });\n\n      const anchor = document.querySelector(\n        `#d-toc a[data-d-toc=\"${closestHeading.getAttribute(\"id\")}\"]`\n      );\n\n      if (!anchor) {\n        return;\n      }\n      anchor.parentElement.classList.add(\"direct-active\");\n      parentsUntil(anchor, \"#d-toc\", \".d-toc-item\").forEach((liParent) => {\n        liParent.classList.add(\"active\");\n      });\n    }\n  },\n\n  insertTOC(headings) {\n    const dToc = document.createElement(\"div\");\n    dToc.classList.add(\"d-toc-main\");\n    dToc.innerHTML = `<div class=\"d-toc-icons\">\n              <a href=\"#\" class=\"scroll-to-bottom\" title=\"${I18n.t(\n                themePrefix(\"post_bottom_tooltip\")\n              )}\">${iconHTML(\"downward\")}</a>\n              <a href=\"#\" class=\"d-toc-close\">${iconHTML(\"times\")}</a></div>`;\n\n    const existing = document.querySelector(\".d-toc-wrapper .d-toc-main\");\n    if (existing) {\n      document.querySelector(\".d-toc-wrapper\").replaceChild(dToc, existing);\n    } else {\n      document.querySelector(\".d-toc-wrapper\").appendChild(dToc);\n    }\n\n    const result = this.buildTOC(Array.from(headings));\n    document.querySelector(\".d-toc-main\").appendChild(result);\n    document.addEventListener(\"click\", this.clickTOC, false);\n  },\n\n  clickTOC(e) {\n    const classNames = [\"d-toc-timeline-visible\", \"archetype-docs-topic\"];\n\n    if (\n      !classNames.some((className) =>\n        document.body.classList.contains(className)\n      )\n    ) {\n      return;\n    }\n\n    // link to each heading\n    if (\n      e.target.closest(\".d-toc-item\") &&\n      e.target.hasAttribute(\"data-d-toc\")\n    ) {\n      const target = `#${e.target.getAttribute(\"data-d-toc\")}`;\n      const scrollTo = domUtils.offset(\n        document.querySelector(`.d-toc-cooked ${target}`)\n      ).top;\n      window.scrollTo({\n        top: scrollTo - headerOffset() - 10,\n        behavior: \"smooth\",\n      });\n      document.querySelector(\".d-toc-wrapper\").classList.remove(\"overlay\");\n      e.preventDefault();\n      return false;\n    }\n\n    if (e.target.closest(\"a\")) {\n      // link to first post bottom\n      if (e.target.closest(\"a\").classList.contains(\"scroll-to-bottom\")) {\n        const rect = document\n          .querySelector(\".d-toc-cooked\")\n          .getBoundingClientRect();\n\n        if (rect) {\n          window.scrollTo({\n            top: rect.bottom + window.scrollY - headerOffset() - 10,\n            behavior: \"smooth\",\n          });\n\n          e.preventDefault();\n          return false;\n        }\n      }\n\n      // close overlay\n      if (e.target.closest(\"a\").classList.contains(\"d-toc-close\")) {\n        document.querySelector(\".d-toc-wrapper\").classList.remove(\"overlay\");\n        e.preventDefault();\n        return false;\n      }\n    }\n\n    if (!document.querySelector(\".d-toc-wrapper.overlay\")) {\n      return;\n    }\n\n    // clicking outside overlay\n    if (!e.target.closest(\".d-toc-wrapper.overlay\")) {\n      document.querySelector(\".d-toc-wrapper\").classList.remove(\"overlay\");\n    }\n  },\n\n  buildTOC(headings) {\n    const result = document.createElement(\"div\");\n    result.setAttribute(\"id\", \"d-toc\");\n\n    const primaryH = headings[0].tagName;\n    const primaryHeadings = headings.filter((n) => n.tagName === primaryH);\n    let nextIndex = headings.length;\n\n    primaryHeadings.forEach((primaryHeading, index) => {\n      const ul = document.createElement(\"ul\");\n      ul.classList.add(\"d-toc-heading\");\n\n      let li = this.buildItem(primaryHeading);\n      ul.appendChild(li);\n\n      const currentIndex = headings.indexOf(primaryHeading);\n      if (primaryHeadings[index + 1]) {\n        nextIndex = headings.indexOf(primaryHeadings[index + 1]);\n      } else {\n        nextIndex = headings.length;\n      }\n\n      headings.forEach((heading, subIndex) => {\n        if (subIndex > currentIndex && subIndex < nextIndex) {\n          let subUl = li.lastChild;\n          if (subUl.tagName !== \"UL\") {\n            subUl = subUl.appendChild(document.createElement(\"ul\"));\n            subUl.classList.add(\"d-toc-sublevel\");\n            li.appendChild(subUl);\n          }\n\n          let subLi = this.buildItem(heading);\n          subUl.appendChild(subLi);\n        }\n      });\n\n      result.appendChild(ul);\n    });\n\n    return result;\n  },\n\n  buildItem(node) {\n    let clonedNode = node.cloneNode(true);\n\n    clonedNode.querySelector(\"span.clicks\")?.remove();\n    const li = document.createElement(\"li\");\n    li.classList.add(\"d-toc-item\");\n    li.classList.add(`d-toc-${clonedNode.tagName.toLowerCase()}`);\n\n    li.innerHTML = `<a href=\"#\" data-d-toc=\"${clonedNode.getAttribute(\"id\")}\">${\n      clonedNode.textContent\n    }</a>`;\n\n    clonedNode.remove();\n    return li;\n  },\n};\n\nfunction parentsUntil(el, selector, filter) {\n  const result = [];\n  const matchesSelector =\n    el.matches ||\n    el.webkitMatchesSelector ||\n    el.mozMatchesSelector ||\n    el.msMatchesSelector;\n\n  // match start from parent\n  el = el.parentElement;\n  while (el && !matchesSelector.call(el, selector)) {\n    if (!filter) {\n      result.push(el);\n    } else {\n      if (matchesSelector.call(el, filter)) {\n        result.push(el);\n      }\n    }\n    el = el.parentElement;\n  }\n  return result;\n}\n", "{\n  \"name\": \"DiscoTOC\",\n  \"version\": \"2.0.0\",\n  \"repository\": \"https://github.com/discourse/DiscoTOC\",\n  \"author\": \"Discourse\",\n  \"license\": \"MIT\",\n  \"devDependencies\": {\n    \"eslint-config-discourse\": \"^3.2.0\"\n  }\n}\n", "import {\n  acceptance,\n  exists,\n  query,\n} from \"discourse/tests/helpers/qunit-helpers\";\nimport { visit } from \"@ember/test-helpers\";\nimport { test } from \"qunit\";\nimport topicFixtures from \"discourse/tests/fixtures/topic\";\nimport { cloneJSON } from \"discourse-common/lib/object\";\n\nconst COOKED_WITH_HEADINGS =\n  '<h1>\\n<a name=\"h1-first-test-edited-1\" class=\"anchor\" href=\"#h1-first-test-edited-1\"></a>\u5e16\u5b50\u63a7\u5236</h1>\\n<h2>\\n<a name=\"measure-h2-2\" class=\"anchor\" href=\"#measure-h2-2\"></a>Measure h2</h2>\\n<p>Jaracaca Swamp we gazed round the very evening light in some. HTML version of science far too late. Wait a snake and nearly half-past two terrible carnivorous dinosaur and distribute. Employers Liability Act you! Each of me see that the crudest pleasantry. Sonny my own special brain. Advancing in front of them and there?</p>\\n<div class=\"md-table\">\\n<table>\\n<thead>\\n<tr>\\n<th>questions</th>\\n<th>vanish</th>\\n<th>contention</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>nearer</td>\\n<td>depressed</td>\\n<td>francisca</td>\\n</tr>\\n<tr>\\n<td>rooms</td>\\n<td>kennel</td>\\n<td>genesis</td>\\n</tr>\\n</tbody>\\n</table>\\n</div><h2>\\n<a name=\"undeveloped-h2-3\" class=\"anchor\" href=\"#undeveloped-h2-3\"></a>Undeveloped h2</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.<br>\\nCried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.<br>\\nCried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h1>\\n<a name=\"h1-second-section-4\" class=\"anchor\" href=\"#h1-second-section-4\"></a>H1 second section</h1>\\n<h2>\\n<a name=\"undeveloped-2-h2-5\" class=\"anchor\" href=\"#undeveloped-2-h2-5\"></a>Undeveloped 2 h2</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through.<br>\\nYou\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h3>\\n<a name=\"subheading-3-h3-6\" class=\"anchor\" href=\"#subheading-3-h3-6\"></a>Subheading 3 h3</h3>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h3>\\n<a name=\"subheading-3-long-ass-wire-h3-7\" class=\"anchor\" href=\"#subheading-3-long-ass-wire-h3-7\"></a>Subheading 3 long ass wire h3</h3>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h2>\\n<a name=\"another-section-h2-8\" class=\"anchor\" href=\"#another-section-h2-8\"></a>Another section h2</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h3>\\n<a name=\"subheading-again-then-h3-9\" class=\"anchor\" href=\"#subheading-again-then-h3-9\"></a>Subheading again then h3</h3>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subbheading-h4-10\" class=\"anchor\" href=\"#su-subbheading-h4-10\"></a>Su-subbheading h4</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subalicions-heading-h4-11\" class=\"anchor\" href=\"#su-subalicions-heading-h4-11\"></a>Su-subalicions heading h4</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subalicions-heading-h4-quite-long-to-test-a-real-life-kind-of-scenario-here-then-12\" class=\"anchor\" href=\"#su-subalicions-heading-h4-quite-long-to-test-a-real-life-kind-of-scenario-here-then-12\"></a>Su-subalicions heading h4 quite long to test a real-life kind of scenario here then</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subalicions-heading-h4-also-quite-long-to-test-a-real-life-kind-of-scenario-here-then-13\" class=\"anchor\" href=\"#su-subalicions-heading-h4-also-quite-long-to-test-a-real-life-kind-of-scenario-here-then-13\"></a>Su-subalicions heading h4 also quite long to test a real-life kind of scenario here then</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<aside class=\"quote no-group\" data-username=\"kathey.zemlak\" data-post=\"2\" data-topic=\"71\">\\n<div class=\"title\">\\n<div class=\"quote-controls\"></div>\\n<img alt=\"\" width=\"20\" height=\"20\" src=\"//127.0.0.1:4200/user_avatar/127.0.0.1/kathey.zemlak/40/14_2.png\" class=\"avatar\"><a href=\"//127.0.0.1:4200/t/modernizing-the-antiquated-boxing-scoring-system/71/2\">Modernizing the antiquated boxing scoring system</a>\\n</div>\\n<blockquote>\\n<h2>Undeveloped</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n</blockquote>\\n</aside>';\n\nconst TOC_MARKUP = '\\n<div data-theme-toc=\"true\"></div>';\nconst TOC_AUTO_CATEGORIES = \"17|19|13\";\nconst TOC_AUTO_TAGS = \"docs|knowledge\";\n\nconst TOC_TOPIC_TAGS = [\"design\", \"docs\"];\nconst TOC_TOPIC_CATEGORY = 19;\n\nacceptance(\"DiscoTOC - main\", function (needs) {\n  needs.pretender((server, helper) => {\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked =\n      COOKED_WITH_HEADINGS + TOC_MARKUP;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"shows TOC, hides timeline on desktop\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n\n    assert.ok(exists(\".d-toc-wrapper #d-toc\"), \"TOC element exists\");\n\n    const firstH2 = query(\".topic-body h2\"),\n      dTocID = firstH2.getAttribute(\"data-d-toc\"),\n      matchingTocItem = `#d-toc [data-d-toc=\"${dTocID}\"]`;\n    assert.equal(\n      firstH2.textContent.trim(),\n      query(matchingTocItem).textContent.trim(),\n      \"TOC above timeline has matching items\"\n    );\n\n    const bquoteH2 = query(\".topic-body blockquote h2\");\n    assert.ok(exists(bquoteH2), \"blockquote H2 exists\");\n    assert.equal(\n      bquoteH2.hasAttribute(\"data-d-toc\"),\n      false,\n      \"does not apply TOC to headings in blockquote\"\n    );\n\n    assert.equal(\n      firstH2.hasAttribute(\"data-d-toc\"),\n      true,\n      \"does apply TOC to regular headings\"\n    );\n\n    const firstH1 = query(\".topic-body h1\");\n\n    assert.equal(\n      firstH1.getAttribute(\"id\"),\n      \"toc-h1-0\",\n      \"heading gets an ID even when it has no Latin characters\"\n    );\n  });\n});\n\nacceptance(\"DiscoTOC - off\", function (needs) {\n  needs.pretender((server, helper) => {\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked = COOKED_WITH_HEADINGS;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"no TOC markup on a regular topic\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n    assert.ok(!exists(\".d-toc-wrapper #d-toc\"));\n  });\n});\n\nacceptance(\"DiscoTOC - with tags\", function (needs) {\n  needs.pretender((server, helper) => {\n    settings.auto_TOC_tags = TOC_AUTO_TAGS;\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked = COOKED_WITH_HEADINGS;\n    topicResponse.tags = TOC_TOPIC_TAGS;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"automaticly adds TOC based on tags\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n    assert.ok(exists(\".d-toc-wrapper #d-toc\"));\n  });\n});\n\nacceptance(\"DiscoTOC - with categories\", function (needs) {\n  needs.pretender((server, helper) => {\n    settings.auto_TOC_categories = TOC_AUTO_CATEGORIES;\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked = COOKED_WITH_HEADINGS;\n    topicResponse.category_id = TOC_TOPIC_CATEGORY;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"automaticly adds TOC based on category\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n    assert.ok(exists(\".d-toc-wrapper #d-toc\"));\n  });\n});\n"], "fixing_code": ["{\n  \"name\": \"DiscoTOC\",\n  \"component\": true,\n  \"about_url\": \"https://meta.discourse.org/t/discotoc-automatic-table-of-contents/111143\",\n  \"license_url\": \"https://github.com/discourse/DiscoTOC/blob/main/LICENSE\",\n  \"theme_version\": \"2.1.0\",\n  \"assets\": {\n    \"icons-sprite\": \"/assets/sprite.svg\"\n  }\n}\n", "import domUtils from \"discourse-common/utils/dom-utils\";\nimport { headerOffset } from \"discourse/lib/offset-calculator\";\nimport { iconHTML } from \"discourse-common/lib/icon-library\";\nimport { later } from \"@ember/runloop\";\nimport { slugify } from \"discourse/lib/utilities\";\nimport { withPluginApi } from \"discourse/lib/plugin-api\";\nimport I18n from \"I18n\";\n\nexport default {\n  name: \"disco-toc-main\",\n\n  initialize() {\n    withPluginApi(\"1.0.0\", (api) => {\n      const autoTocCategoryIds = settings.auto_TOC_categories\n        .split(\"|\")\n        .map((id) => parseInt(id, 10));\n\n      const autoTocTags = settings.auto_TOC_tags.split(\"|\");\n\n      api.decorateCookedElement(\n        (el, helper) => {\n          if (helper) {\n            const post = helper.getModel();\n            if (post?.post_number !== 1) {\n              return;\n            }\n\n            const topicCategory = helper.getModel().topic.category_id;\n            const topicTags = helper.getModel().topic.tags;\n\n            const hasTOCmarkup = el?.querySelector(`[data-theme-toc=\"true\"]`);\n            const tocCategory = autoTocCategoryIds?.includes(topicCategory);\n            const tocTag = topicTags?.some((tag) => autoTocTags?.includes(tag));\n\n            if (!hasTOCmarkup && !tocCategory && !tocTag) {\n              document.body.classList.remove(\"d-toc-timeline-visible\");\n              return;\n            }\n\n            let dTocHeadingSelectors =\n              \":scope > h1, :scope > h2, :scope > h3, :scope > h4, :scope > h5\";\n            const headings = el.querySelectorAll(dTocHeadingSelectors);\n\n            if (headings.length < 1) {\n              return;\n            }\n\n            headings.forEach((h, index) => {\n              // suffix uses index for non-Latin languages\n              const suffix = slugify(h.textContent) || index;\n              const id =\n                h.getAttribute(\"id\") || slugify(`toc-${h.nodeName}-${suffix}`);\n\n              h.setAttribute(\"id\", id);\n              h.setAttribute(\"data-d-toc\", id);\n              h.classList.add(\"d-toc-post-heading\");\n            });\n\n            el.classList.add(\"d-toc-cooked\");\n\n            if (document.querySelector(\".d-toc-wrapper\")) {\n              this.insertTOC(headings);\n            } else {\n              // try again if decoration happens while outlet is not rendered\n              // this is due to core resetting `canRender` for topic-navigation\n              // when transitioning between topics\n              later(() => {\n                if (document.querySelector(\".d-toc-wrapper\")) {\n                  this.insertTOC(headings);\n                }\n              }, 300);\n            }\n          }\n        },\n        {\n          id: \"disco-toc\",\n          onlyStream: true,\n          afterAdopt: true,\n        }\n      );\n\n      api.onAppEvent(\"topic:current-post-changed\", (args) => {\n        if (!document.querySelector(\".d-toc-cooked\")) {\n          return;\n        }\n        if (args.post.post_number === 1) {\n          document.body.classList.add(\"d-toc-timeline-visible\");\n        } else {\n          document.body.classList.remove(\"d-toc-timeline-visible\");\n        }\n      });\n\n      api.onAppEvent(\"docs-topic:current-post-scrolled\", () => {\n        this.updateTOCSidebar();\n      });\n\n      api.onAppEvent(\"topic:current-post-scrolled\", (args) => {\n        if (args.postIndex !== 1) {\n          return;\n        }\n\n        this.updateTOCSidebar();\n      });\n\n      api.cleanupStream(() => {\n        document.body.classList.remove(\"d-toc-timeline-visible\");\n        document.removeEventListener(\"click\", this.clickTOC, false);\n      });\n    });\n  },\n\n  updateTOCSidebar() {\n    if (!document.querySelector(\".d-toc-cooked\")) {\n      return;\n    }\n\n    const headings = document.querySelectorAll(\".d-toc-post-heading\");\n    let closestHeadingDistance = null;\n    let closestHeading = null;\n\n    headings.forEach((heading) => {\n      const distance = Math.abs(\n        domUtils.offset(heading).top - headerOffset() - window.scrollY\n      );\n      if (closestHeadingDistance == null || distance < closestHeadingDistance) {\n        closestHeadingDistance = distance;\n        closestHeading = heading;\n      } else {\n        return false;\n      }\n    });\n\n    if (closestHeading) {\n      document.querySelectorAll(\"#d-toc li\").forEach((listItem) => {\n        listItem.classList.remove(\"active\");\n        listItem.classList.remove(\"direct-active\");\n      });\n\n      const anchor = document.querySelector(\n        `#d-toc a[data-d-toc=\"${closestHeading.getAttribute(\"id\")}\"]`\n      );\n\n      if (!anchor) {\n        return;\n      }\n      anchor.parentElement.classList.add(\"direct-active\");\n      parentsUntil(anchor, \"#d-toc\", \".d-toc-item\").forEach((liParent) => {\n        liParent.classList.add(\"active\");\n      });\n    }\n  },\n\n  insertTOC(headings) {\n    const dToc = document.createElement(\"div\");\n    dToc.classList.add(\"d-toc-main\");\n    dToc.innerHTML = `<div class=\"d-toc-icons\">\n              <a href=\"#\" class=\"scroll-to-bottom\" title=\"${I18n.t(\n                themePrefix(\"post_bottom_tooltip\")\n              )}\">${iconHTML(\"downward\")}</a>\n              <a href=\"#\" class=\"d-toc-close\">${iconHTML(\"times\")}</a></div>`;\n\n    const existing = document.querySelector(\".d-toc-wrapper .d-toc-main\");\n    if (existing) {\n      document.querySelector(\".d-toc-wrapper\").replaceChild(dToc, existing);\n    } else {\n      document.querySelector(\".d-toc-wrapper\").appendChild(dToc);\n    }\n\n    const result = this.buildTOC(Array.from(headings));\n    document.querySelector(\".d-toc-main\").appendChild(result);\n    document.addEventListener(\"click\", this.clickTOC, false);\n  },\n\n  clickTOC(e) {\n    const classNames = [\"d-toc-timeline-visible\", \"archetype-docs-topic\"];\n\n    if (\n      !classNames.some((className) =>\n        document.body.classList.contains(className)\n      )\n    ) {\n      return;\n    }\n\n    // link to each heading\n    if (\n      e.target.closest(\".d-toc-item\") &&\n      e.target.hasAttribute(\"data-d-toc\")\n    ) {\n      const target = `#${e.target.getAttribute(\"data-d-toc\")}`;\n      const scrollTo = domUtils.offset(\n        document.querySelector(`.d-toc-cooked ${target}`)\n      ).top;\n      window.scrollTo({\n        top: scrollTo - headerOffset() - 10,\n        behavior: \"smooth\",\n      });\n      document.querySelector(\".d-toc-wrapper\").classList.remove(\"overlay\");\n      e.preventDefault();\n      return false;\n    }\n\n    if (e.target.closest(\"a\")) {\n      // link to first post bottom\n      if (e.target.closest(\"a\").classList.contains(\"scroll-to-bottom\")) {\n        const rect = document\n          .querySelector(\".d-toc-cooked\")\n          .getBoundingClientRect();\n\n        if (rect) {\n          window.scrollTo({\n            top: rect.bottom + window.scrollY - headerOffset() - 10,\n            behavior: \"smooth\",\n          });\n\n          e.preventDefault();\n          return false;\n        }\n      }\n\n      // close overlay\n      if (e.target.closest(\"a\").classList.contains(\"d-toc-close\")) {\n        document.querySelector(\".d-toc-wrapper\").classList.remove(\"overlay\");\n        e.preventDefault();\n        return false;\n      }\n    }\n\n    if (!document.querySelector(\".d-toc-wrapper.overlay\")) {\n      return;\n    }\n\n    // clicking outside overlay\n    if (!e.target.closest(\".d-toc-wrapper.overlay\")) {\n      document.querySelector(\".d-toc-wrapper\").classList.remove(\"overlay\");\n    }\n  },\n\n  buildTOC(headings) {\n    const result = document.createElement(\"div\");\n    result.setAttribute(\"id\", \"d-toc\");\n\n    const primaryH = headings[0].tagName;\n    const primaryHeadings = headings.filter((n) => n.tagName === primaryH);\n    let nextIndex = headings.length;\n\n    primaryHeadings.forEach((primaryHeading, index) => {\n      const ul = document.createElement(\"ul\");\n      ul.classList.add(\"d-toc-heading\");\n\n      let li = this.buildItem(primaryHeading);\n      ul.appendChild(li);\n\n      const currentIndex = headings.indexOf(primaryHeading);\n      if (primaryHeadings[index + 1]) {\n        nextIndex = headings.indexOf(primaryHeadings[index + 1]);\n      } else {\n        nextIndex = headings.length;\n      }\n\n      headings.forEach((heading, subIndex) => {\n        if (subIndex > currentIndex && subIndex < nextIndex) {\n          let subUl = li.lastChild;\n          if (subUl.tagName !== \"UL\") {\n            subUl = subUl.appendChild(document.createElement(\"ul\"));\n            subUl.classList.add(\"d-toc-sublevel\");\n            li.appendChild(subUl);\n          }\n\n          let subLi = this.buildItem(heading);\n          subUl.appendChild(subLi);\n        }\n      });\n\n      result.appendChild(ul);\n    });\n\n    return result;\n  },\n\n  buildItem(node) {\n    let clonedNode = node.cloneNode(true);\n\n    clonedNode.querySelector(\"span.clicks\")?.remove();\n    const li = document.createElement(\"li\");\n    li.classList.add(\"d-toc-item\");\n    li.classList.add(`d-toc-${clonedNode.tagName.toLowerCase()}`);\n\n    const id = clonedNode.getAttribute(\"id\");\n    li.innerHTML = `<a href=\"#\" data-d-toc=\"${id}\"></a>`;\n    li.querySelector(\"a\").innerText = clonedNode.textContent.trim();\n\n    clonedNode.remove();\n    return li;\n  },\n};\n\nfunction parentsUntil(el, selector, filter) {\n  const result = [];\n  const matchesSelector =\n    el.matches ||\n    el.webkitMatchesSelector ||\n    el.mozMatchesSelector ||\n    el.msMatchesSelector;\n\n  // match start from parent\n  el = el.parentElement;\n  while (el && !matchesSelector.call(el, selector)) {\n    if (!filter) {\n      result.push(el);\n    } else {\n      if (matchesSelector.call(el, filter)) {\n        result.push(el);\n      }\n    }\n    el = el.parentElement;\n  }\n  return result;\n}\n", "{\n  \"name\": \"DiscoTOC\",\n  \"version\": \"2.1.0\",\n  \"repository\": \"https://github.com/discourse/DiscoTOC\",\n  \"author\": \"Discourse\",\n  \"license\": \"MIT\",\n  \"devDependencies\": {\n    \"eslint-config-discourse\": \"^3.2.0\"\n  }\n}\n", "import {\n  acceptance,\n  exists,\n  query,\n} from \"discourse/tests/helpers/qunit-helpers\";\nimport { visit } from \"@ember/test-helpers\";\nimport { test } from \"qunit\";\nimport topicFixtures from \"discourse/tests/fixtures/topic\";\nimport { cloneJSON } from \"discourse-common/lib/object\";\n\nconst COOKED_WITH_HEADINGS =\n  '<h1>\\n<a name=\"h1-first-test-edited-1\" class=\"anchor\" href=\"#h1-first-test-edited-1\"></a>\u5e16\u5b50\u63a7\u5236</h1>\\n<h2>\\n<a name=\"measure-h2-2\" class=\"anchor\" href=\"#measure-h2-2\"></a>Measure h2</h2>\\n<p>Jaracaca Swamp we gazed round the very evening light in some. HTML version of science far too late. Wait a snake and nearly half-past two terrible carnivorous dinosaur and distribute. Employers Liability Act you! Each of me see that the crudest pleasantry. Sonny my own special brain. Advancing in front of them and there?</p>\\n<div class=\"md-table\">\\n<table>\\n<thead>\\n<tr>\\n<th>questions</th>\\n<th>vanish</th>\\n<th>contention</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>nearer</td>\\n<td>depressed</td>\\n<td>francisca</td>\\n</tr>\\n<tr>\\n<td>rooms</td>\\n<td>kennel</td>\\n<td>genesis</td>\\n</tr>\\n</tbody>\\n</table>\\n</div><h2>\\n<a name=\"undeveloped-h2-3\" class=\"anchor\" href=\"#undeveloped-h2-3\"></a>Undeveloped h2</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.<br>\\nCried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.<br>\\nCried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h1>\\n<a name=\"h1-second-section-4\" class=\"anchor\" href=\"#h1-second-section-4\"></a>H1 second section</h1>\\n<h2>\\n<a name=\"undeveloped-2-h2-5\" class=\"anchor\" href=\"#undeveloped-2-h2-5\"></a>Undeveloped 2 h2</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through.<br>\\nYou\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h3>\\n<a name=\"subheading-3-h3-6\" class=\"anchor\" href=\"#subheading-3-h3-6\"></a>Subheading 3 h3</h3>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h3>\\n<a name=\"subheading-3-long-ass-wire-h3-7\" class=\"anchor\" href=\"#subheading-3-long-ass-wire-h3-7\"></a>Subheading 3 long ass wire h3</h3>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h2>\\n<a name=\"another-section-h2-8\" class=\"anchor\" href=\"#another-section-h2-8\"></a>Another section h2</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h3>\\n<a name=\"subheading-again-then-h3-9\" class=\"anchor\" href=\"#subheading-again-then-h3-9\"></a>Subheading again then h3</h3>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subbheading-h4-10\" class=\"anchor\" href=\"#su-subbheading-h4-10\"></a>Su-subbheading h4</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subalicions-heading-h4-11\" class=\"anchor\" href=\"#su-subalicions-heading-h4-11\"></a>Su-subalicions heading h4</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subalicions-heading-h4-quite-long-to-test-a-real-life-kind-of-scenario-here-then-12\" class=\"anchor\" href=\"#su-subalicions-heading-h4-quite-long-to-test-a-real-life-kind-of-scenario-here-then-12\"></a>Su-subalicions heading h4 quite long to test a real-life kind of scenario here then</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<h4>\\n<a name=\"su-subalicions-heading-h4-also-quite-long-to-test-a-real-life-kind-of-scenario-here-then-13\" class=\"anchor\" href=\"#su-subalicions-heading-h4-also-quite-long-to-test-a-real-life-kind-of-scenario-here-then-13\"></a>Su-subalicions heading h4 also quite long to test a real-life kind of scenario here then</h4>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n<aside class=\"quote no-group\" data-username=\"kathey.zemlak\" data-post=\"2\" data-topic=\"71\">\\n<div class=\"title\">\\n<div class=\"quote-controls\"></div>\\n<img alt=\"\" width=\"20\" height=\"20\" src=\"//127.0.0.1:4200/user_avatar/127.0.0.1/kathey.zemlak/40/14_2.png\" class=\"avatar\"><a href=\"//127.0.0.1:4200/t/modernizing-the-antiquated-boxing-scoring-system/71/2\">Modernizing the antiquated boxing scoring system</a>\\n</div>\\n<blockquote>\\n<h2>Undeveloped</h2>\\n<p>Cried leaning upon the tangle of the full of the same. Behind us upon the luxurious. Tarp Henry of the moment that similar upon his lecture. Devil got there came well with him fifteen dollars a whisper We slunk through. You\u2019ll find its palm. Other ones and east of Shakespeare could his seat there by. McArdle looked round and I have thrown open and his people have seen the tangled.</p>\\n</blockquote>\\n</aside>';\n\nconst TOC_MARKUP = '\\n<div data-theme-toc=\"true\"></div>';\nconst TOC_AUTO_CATEGORIES = \"17|19|13\";\nconst TOC_AUTO_TAGS = \"docs|knowledge\";\n\nconst TOC_TOPIC_TAGS = [\"design\", \"docs\"];\nconst TOC_TOPIC_CATEGORY = 19;\n\nacceptance(\"DiscoTOC - main\", function (needs) {\n  needs.pretender((server, helper) => {\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked =\n      COOKED_WITH_HEADINGS + TOC_MARKUP;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"shows TOC, hides timeline on desktop\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n\n    assert.ok(exists(\".d-toc-wrapper #d-toc\"), \"TOC element exists\");\n\n    const firstH2 = query(\".topic-body h2\"),\n      dTocID = firstH2.getAttribute(\"data-d-toc\"),\n      matchingTocItem = `#d-toc [data-d-toc=\"${dTocID}\"]`;\n    assert.equal(\n      firstH2.textContent.trim(),\n      query(matchingTocItem).textContent.trim(),\n      \"TOC above timeline has matching items\"\n    );\n\n    const bquoteH2 = query(\".topic-body blockquote h2\");\n    assert.ok(exists(bquoteH2), \"blockquote H2 exists\");\n    assert.equal(\n      bquoteH2.hasAttribute(\"data-d-toc\"),\n      false,\n      \"does not apply TOC to headings in blockquote\"\n    );\n\n    assert.equal(\n      firstH2.hasAttribute(\"data-d-toc\"),\n      true,\n      \"does apply TOC to regular headings\"\n    );\n\n    const firstH1 = query(\".topic-body h1\");\n\n    assert.equal(\n      firstH1.getAttribute(\"id\"),\n      \"toc-h1-0\",\n      \"heading gets an ID even when it has no Latin characters\"\n    );\n  });\n});\n\nacceptance(\"DiscoTOC - off\", function (needs) {\n  needs.pretender((server, helper) => {\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked = COOKED_WITH_HEADINGS;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"no TOC markup on a regular topic\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n    assert.ok(!exists(\".d-toc-wrapper #d-toc\"));\n  });\n});\n\nacceptance(\"DiscoTOC - with tags\", function (needs) {\n  needs.pretender((server, helper) => {\n    settings.auto_TOC_tags = TOC_AUTO_TAGS;\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked = COOKED_WITH_HEADINGS;\n    topicResponse.tags = TOC_TOPIC_TAGS;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"automaticly adds TOC based on tags\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n    assert.ok(exists(\".d-toc-wrapper #d-toc\"));\n  });\n});\n\nacceptance(\"DiscoTOC - with categories\", function (needs) {\n  needs.pretender((server, helper) => {\n    settings.auto_TOC_categories = TOC_AUTO_CATEGORIES;\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked = COOKED_WITH_HEADINGS;\n    topicResponse.category_id = TOC_TOPIC_CATEGORY;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"automaticly adds TOC based on category\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n    assert.ok(exists(\".d-toc-wrapper #d-toc\"));\n  });\n});\n\nacceptance(\"DiscoTOC - non-text headings\", function (needs) {\n  needs.pretender((server, helper) => {\n    const topicResponse = cloneJSON(topicFixtures[\"/t/280/1.json\"]);\n    topicResponse.post_stream.posts[0].cooked = `\n      <h3 id=\"toc-h3-span\" data-d-toc=\"toc-h3-span\" class=\"d-toc-post-heading\">\n        <a name=\"span-4\" class=\"anchor\" href=\"#span-4\"></a>&lt;span style=\"color: red\"&gt;what about this&lt;/span&gt;</h3>\n      </h3>\n      <p>test</p>\n      ${TOC_MARKUP}\n    `;\n\n    server.get(\"/t/280.json\", () => helper.response(topicResponse));\n    server.get(\"/t/280/:post_number.json\", () =>\n      helper.response(topicResponse)\n    );\n  });\n\n  test(\"renders the TOC items as plain text\", async function (assert) {\n    await visit(\"/t/internationalization-localization/280\");\n\n    const item = query(`#d-toc [data-d-toc=\"toc-h3-span\"]`);\n    assert.strictEqual(\n      item.innerHTML.trim(),\n      `&lt;span style=\"color: red\"&gt;what about this&lt;/span&gt;`\n    );\n  });\n});\n"], "filenames": ["about.json", "javascripts/discourse/initializers/disco-toc-main.js", "package.json", "test/acceptance/toc-test.js"], "buggy_code_start_loc": [5, 289, 3, 124], "buggy_code_end_loc": [5, 292, 4, 124], "fixing_code_start_loc": [6, 289, 3, 125], "fixing_code_end_loc": [7, 292, 4, 153], "type": "CWE-79", "message": "DiscoTOC is a Discourse theme component that generates a table of contents for topics. Users that can create topics in TOC-enabled categories (and have sufficient trust level - configured in component's settings) are able to inject arbitrary HTML on that topic's page. The issue has been fixed on the `main` branch. Admins can update the theme component through the admin UI (Customize -> Themes -> Components -> DiscoTOC -> Check for Updates). Alternatively, admins can temporarily disable the DiscoTOC theme component.", "other": {"cve": {"id": "CVE-2022-39270", "sourceIdentifier": "security-advisories@github.com", "published": "2022-10-06T18:16:14.227", "lastModified": "2022-11-10T04:15:48.747", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "DiscoTOC is a Discourse theme component that generates a table of contents for topics. Users that can create topics in TOC-enabled categories (and have sufficient trust level - configured in component's settings) are able to inject arbitrary HTML on that topic's page. The issue has been fixed on the `main` branch. Admins can update the theme component through the admin UI (Customize -> Themes -> Components -> DiscoTOC -> Check for Updates). Alternatively, admins can temporarily disable the DiscoTOC theme component."}, {"lang": "es", "value": "DiscoTOC es un componente tem\u00e1tico de Discourse que genera una tabla de contenidos para los temas. Los usuarios que pueden crear temas en categor\u00edas habilitadas para TOC (y presentan un nivel confiable suficiente - configurado en los ajustes del componente) son capaces de inyectar HTML arbitrario en la p\u00e1gina de ese tema. El problema ha sido corregido en la rama \"main\". Los administradores pueden actualizar el componente del tema mediante de la Interfaz de Usuario de administraci\u00f3n (Customize -&gt; Themes -&gt; Components -&gt; DiscoTOC -&gt; Check for Updates). Como alternativa, los administradores pueden deshabilitar temporalmente el componente tem\u00e1tico DiscoTOC"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "nvd@nist.gov", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:discourse:discotoc:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.1.0", "matchCriteriaId": "4C3159DE-74E9-466A-902D-CF31AB3F0B54"}]}]}], "references": [{"url": "https://github.com/discourse/DiscoTOC/commit/f80c215a283cd045d2a371403e6eba88b2911192", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/discourse/DiscoTOC/security/advisories/GHSA-m44p-w923-w32h", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/discourse/DiscoTOC/commit/f80c215a283cd045d2a371403e6eba88b2911192"}}