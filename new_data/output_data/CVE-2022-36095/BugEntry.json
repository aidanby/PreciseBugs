{"buggy_code": ["## ---------------------------------------------------------------------------\n## See the NOTICE file distributed with this work for additional\n## information regarding copyright ownership.\n##\n## This is free software; you can redistribute it and/or modify it\n## under the terms of the GNU Lesser General Public License as\n## published by the Free Software Foundation; either version 2.1 of\n## the License, or (at your option) any later version.\n##\n## This software is distributed in the hope that it will be useful,\n## but WITHOUT ANY WARRANTY; without even the implied warranty of\n## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n## Lesser General Public License for more details.\n##\n## You should have received a copy of the GNU Lesser General Public\n## License along with this software; if not, write to the Free\n## Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n## 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n## ---------------------------------------------------------------------------\n#template(\"xwikivars.vm\")\n#set($tagsId = 'xdocTags')\n#set($tagErrorMessage = '')\n#set($xredirect = $escapetool.url($doc.getURL('view', \"#${tagsId}\")))\n##\n##\n##\n#macro(displayTag $tag)\n<span class=\"tag-wrapper\"><span class=\"tag\"><a href=\"$xwiki.getURL('Main.Tags', 'view', \"do=viewTag&amp;tag=$!{escapetool.url($tag)}\")\">$!{escapetool.xml($tag)}</a></span>#if($hasedit)<span class=\"separator\">[</span><a href=\"$doc.getURL('view', \"xpage=documentTags&amp;xaction=delete&amp;tag=$!{escapetool.url($tag)}&amp;xredirect=${xredirect}\")\" class=\"tag-tool tag-delete\" title=\"$services.localization.render('core.tags.remove.tooltip')\">X</a><span class=\"separator\">]</span>#end</span>\n#end\n##\n#macro(removeTag $tag)\n    #if($xwiki.tag)\n        #set($result = $xwiki.tag.removeTagFromDocument($tag, $doc.fullName))\n        #if($result == 'OK' && \"$!{request.ajax}\" != '')\n            $response.setStatus(200)\n            #set($responseMessage = 'OK')\n        #elseif($result == 'NO_EFFECT')\n            $response.setStatus(409)\n            #set($responseMessage = $services.localization.render('core.tags.remove.error.notFound', [$tag]))\n        #elseif($result == 'NOT_ALLOWED')\n            $response.setStatus(403)\n            #set($responseMessage = $services.localization.render('core.tags.remove.error.notAllowed', [$tag]))\n        #elseif($result == 'FAILED')\n            $response.setStatus(500)\n            #set($responseMessage = $services.localization.render('core.tags.remove.error.failed', [$tag]))\n        #end\n        #if(\"$!{request.ajax}\" != '')\n            $!responseMessage\n        #elseif(\"$!{request.xredirect}\" != '')\n            $response.sendRedirect($request.xredirect)\n        #end\n    #else\n        ## TODO\n    #end\n#end\n##\n#macro(addTag $tag)\n    #if($xwiki.tag)\n        #set($oldTags = $xwiki.tag.getTagsFromDocument($doc.fullName))\n        #set($result = $xwiki.tag.addTagsToDocument($tag, $doc.fullName))\n        #if($result == 'OK' && \"$!{request.ajax}\" != '')\n            #set($newTags = $xwiki.tag.getTagsFromDocument($doc.fullName))\n            #set($discard = $newTags.removeAll($oldTags))\n            #foreach($t in $newTags)\n                #if($t != '' && !$oldTags.contains($t))\n                    #displayTag($t)\n                #end\n            #end\n        #elseif($result == 'NO_EFFECT')\n            $response.setStatus(409)\n            #set($tagErrorMessage = $services.localization.render('core.tags.add.error.alreadySet', [$tag]))\n        #elseif($result == 'NOT_ALLOWED')\n            $response.setStatus(403)\n            #set($tagErrorMessage = $services.localization.render('core.tags.add.error.notAllowed', [$tag]))\n        #elseif($result == 'FAILED')\n            $response.setStatus(500)\n            #set($tagErrorMessage = $services.localization.render('core.tags.add.error.failed', [$tag]))\n        #end\n        #if(\"$!{request.ajax}\" != '')\n            $tagErrorMessage\n        #elseif(\"$!{request.xredirect}\" != '')\n            $response.sendRedirect($request.xredirect)\n        #end\n    #else\n        ## TODO\n    #end\n#end\n##\n#macro(displayAddForm)\n<form action=\"$doc.getURL('view', \"xpage=documentTags&amp;xaction=add&amp;xredirect=${xredirect}\")\" method=\"post\" class=\"tag-add-form\">\n  <div>\n      ## CSRF prevention\n    <div class=\"hidden\"><input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /></div>\n    <label for=\"tag\">$services.localization.render('core.tags.add.label')<br/>\n      <input class=\"input-tag\" type=\"text\" id=\"tag\" name=\"tag\" autocomplete=\"off\"/></label><br/>\n    <span class=\"buttonwrapper\"><input class=\"button button-add-tag\" type=\"submit\" value=\"$services.localization.render('core.tags.add.submit')\"/></span>\n    <span class=\"buttonwrapper\"><a class=\"button button-add-tag-cancel\" href=\"$doc.getURL('view', \"#${tagsId}\")\">$services.localization.render('core.tags.add.cancel')</a></span>\n  </div>\n</form>\n#end\n##\n#set($xaction = \"$!{request.xaction}\")\n#if(\"$!{request.showTagAddForm}\" == 'true' && \"$!{request.ajax}\" == '1')\n    #displayAddForm()\n#elseif($xaction == 'delete')\n    #removeTag($request.tag)\n#elseif($xaction == 'add')\n    #addTag($request.tag)\n#else ## display\n    $xwiki.ssfx.use('uicomponents/viewers/tags.css', {'forceSkinAction': true, 'colorTheme': \"$!{themeDocFullName}\"})##\n    $xwiki.jsfx.use('uicomponents/viewers/tags.js', true)##\n<div class=\"doc-tags\" id=\"${tagsId}\">\n    #if($xwiki.tag)\n        #set($hasTagsPlugin = true)\n        #set($tags = $xwiki.tag.getTagsFromDocument($doc.fullName))\n    #else\n        #set($hasTagsPlugin = false)\n        #set($tags = $doc.getTagList())\n    #end\n    ##   #if($!tags.size() == 0)\n    ##     No tags\n    ##   #else\n    $services.localization.render('core.tags.list.label')\n    #foreach($tag in $tags)\n        #displayTag($tag)\n    #end\n    ##   #end\n    #if($hasedit)\n        #if($xwiki.tag)\n          <div class=\"tag-tool tag-add\">#if(\"$!{request.showTagAddForm}\" == '')<a href=\"$doc.getURL('view', \"showTagAddForm=true&amp;$!{escapetool.url(${request.queryString})}#${tagsId}\")\" title=\"$services.localization.render('core.tags.add.tooltip')\" rel=\"nofollow\">[+]</a>#else #displayAddForm()#end</div>\n        #else\n            ## TODO\n        #end\n    #end\n</div>\n    #if($tagErrorMessage != '')\n        #error($tagErrorMessage)\n    #end\n#end"], "fixing_code": ["## ---------------------------------------------------------------------------\n## See the NOTICE file distributed with this work for additional\n## information regarding copyright ownership.\n##\n## This is free software; you can redistribute it and/or modify it\n## under the terms of the GNU Lesser General Public License as\n## published by the Free Software Foundation; either version 2.1 of\n## the License, or (at your option) any later version.\n##\n## This software is distributed in the hope that it will be useful,\n## but WITHOUT ANY WARRANTY; without even the implied warranty of\n## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n## Lesser General Public License for more details.\n##\n## You should have received a copy of the GNU Lesser General Public\n## License along with this software; if not, write to the Free\n## Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n## 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n## ---------------------------------------------------------------------------\n#template(\"xwikivars.vm\")\n#set($tagsId = 'xdocTags')\n#set($tagErrorMessage = '')\n#set($xredirect = $escapetool.url($doc.getURL('view', \"#${tagsId}\")))\n##\n##\n##\n#macro(displayTag $tag)\n  #set ($viewTagUrl = $xwiki.getURL('Main.Tags', 'view', \"do=viewTag&amp;tag=$!{escapetool.url($tag)}\"))\n  ## Note that the form_token parameter needs to be kept before the xredirect parameter since the JS code might replace the latter\n  ## All that would need a cleaner fix in the javascript of tags.\n  #set ($deleteTagUrl = $doc.getURL('view', \"xpage=documentTags&amp;xaction=delete&amp;tag=$!{escapetool.url($tag)}&amp;form_token=$!{escapetool.url($services.csrf.token)}&amp;xredirect=${xredirect}\"))\n<span class=\"tag-wrapper\">\n  <span class=\"tag\"><a href=\"$viewTagUrl\">$!{escapetool.xml($tag)}</a></span>\n  #if($hasedit)<span class=\"separator\">[</span><a href=\"$deleteTagUrl\" class=\"tag-tool tag-delete\" title=\"$services.localization.render('core.tags.remove.tooltip')\">X</a><span class=\"separator\">]</span>#end\n</span>\n#end\n##\n#macro(removeTag $tag)\n    #if ($services.csrf.isTokenValid($request.get('form_token')))\n        #if($xwiki.tag)\n            #set($result = $xwiki.tag.removeTagFromDocument($tag, $doc.fullName))\n            #if($result == 'OK' && \"$!{request.ajax}\" != '')\n                #set ($discard= $response.setStatus(200))\n                #set($responseMessage = 'OK')\n            #elseif($result == 'NO_EFFECT')\n                #set ($discard= $response.setStatus(409))\n                #set($responseMessage = $services.localization.render('core.tags.remove.error.notFound', [$tag]))\n            #elseif($result == 'NOT_ALLOWED')\n                #set ($discard= $response.setStatus(403))\n                #set($responseMessage = $services.localization.render('core.tags.remove.error.notAllowed', [$tag]))\n            #elseif($result == 'FAILED')\n                #set ($discard= $response.setStatus(500))\n                #set($responseMessage = $services.localization.render('core.tags.remove.error.failed', [$tag]))\n            #end\n        #else\n            #set ($discard= $response.setStatus(501))\n            #set ($responseMessage = \"Tag plugin is missing\")\n        #end\n    #else\n        #set ($discard= $response.setStatus(401))\n        #set($responseMessage = $services.localization.render('core.tags.remove.error.notAllowed', [$tag]))\n    #end\n    #if(\"$!{request.ajax}\" != '')\n        $!responseMessage\n    #elseif(\"$!{request.xredirect}\" != '')\n        $response.sendRedirect($request.xredirect)\n    #end\n#end\n##\n#macro(addTag $tag)\n    #if ($services.csrf.isTokenValid($request.get('form_token')))\n        #if($xwiki.tag)\n            #set($oldTags = $xwiki.tag.getTagsFromDocument($doc.fullName))\n            #set($result = $xwiki.tag.addTagsToDocument($tag, $doc.fullName))\n            #if($result == 'OK' && \"$!{request.ajax}\" != '')\n                #set($newTags = $xwiki.tag.getTagsFromDocument($doc.fullName))\n                #set($discard = $newTags.removeAll($oldTags))\n                #foreach($t in $newTags)\n                    #if($t != '' && !$oldTags.contains($t))\n                        #displayTag($t)\n                    #end\n                #end\n            #elseif($result == 'NO_EFFECT')\n                $response.setStatus(409)\n                #set($tagErrorMessage = $services.localization.render('core.tags.add.error.alreadySet', [$tag]))\n            #elseif($result == 'NOT_ALLOWED')\n                $response.setStatus(403)\n                #set($tagErrorMessage = $services.localization.render('core.tags.add.error.notAllowed', [$tag]))\n            #elseif($result == 'FAILED')\n                $response.setStatus(500)\n                #set($tagErrorMessage = $services.localization.render('core.tags.add.error.failed', [$tag]))\n            #end\n            #if(\"$!{request.ajax}\" != '')\n                $tagErrorMessage\n            #elseif(\"$!{request.xredirect}\" != '')\n                $response.sendRedirect($request.xredirect)\n            #end\n        #else\n            #set ($discard= $response.setStatus(501))\n            #set ($responseMessage = \"Tag plugin is missing\")\n        #end\n    #else\n        #set ($discard= $response.setStatus(401))\n        #set($responseMessage = $services.localization.render('core.tags.add.error.notAllowed', [$tag]))\n    #end\n#end\n##\n#macro(displayAddForm)\n## Note that the form_token parameter needs to be kept before the xredirect parameter since the JS code might replace the latter\n## All that would need a cleaner fix in the javascript of tags.\n<form action=\"$doc.getURL('view', \"xpage=documentTags&amp;xaction=add&amp;form_token=$!{escapetool.url($services.csrf.token)}&amp;xredirect=${xredirect}\")\" method=\"post\" class=\"tag-add-form\">\n  <div>\n    <label for=\"tag\">$services.localization.render('core.tags.add.label')<br/>\n      <input class=\"input-tag\" type=\"text\" id=\"tag\" name=\"tag\" autocomplete=\"off\"/></label><br/>\n    <span class=\"buttonwrapper\"><input class=\"button button-add-tag\" type=\"submit\" value=\"$services.localization.render('core.tags.add.submit')\"/></span>\n    <span class=\"buttonwrapper\"><a class=\"button button-add-tag-cancel\" href=\"$doc.getURL('view', \"#${tagsId}\")\">$services.localization.render('core.tags.add.cancel')</a></span>\n  </div>\n</form>\n#end\n##\n#set($xaction = \"$!{request.xaction}\")\n#if(\"$!{request.showTagAddForm}\" == 'true' && \"$!{request.ajax}\" == '1')\n    #displayAddForm()\n#elseif($xaction == 'delete')\n    #removeTag($request.tag)\n#elseif($xaction == 'add')\n    #addTag($request.tag)\n#else ## display\n    $xwiki.ssfx.use('uicomponents/viewers/tags.css', {'forceSkinAction': true, 'colorTheme': \"$!{themeDocFullName}\"})##\n    $xwiki.jsfx.use('uicomponents/viewers/tags.js', true)##\n<div class=\"doc-tags\" id=\"${tagsId}\">\n    #if($xwiki.tag)\n        #set($hasTagsPlugin = true)\n        #set($tags = $xwiki.tag.getTagsFromDocument($doc.fullName))\n    #else\n        #set($hasTagsPlugin = false)\n        #set($tags = $doc.getTagList())\n    #end\n    ##   #if($!tags.size() == 0)\n    ##     No tags\n    ##   #else\n    $services.localization.render('core.tags.list.label')\n    #foreach($tag in $tags)\n        #displayTag($tag)\n    #end\n    ##   #end\n    #if($hasedit)\n        #if($xwiki.tag)\n          <div class=\"tag-tool tag-add\">#if(\"$!{request.showTagAddForm}\" == '')<a href=\"$doc.getURL('view', \"showTagAddForm=true&amp;$!{escapetool.url(${request.queryString})}#${tagsId}\")\" title=\"$services.localization.render('core.tags.add.tooltip')\" rel=\"nofollow\">[+]</a>#else #displayAddForm()#end</div>\n        #else\n            ## TODO\n        #end\n    #end\n</div>\n    #if($tagErrorMessage != '')\n        #error($tagErrorMessage)\n    #end\n#end"], "filenames": ["xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/documentTags.vm"], "buggy_code_start_loc": [28], "buggy_code_end_loc": [94], "fixing_code_start_loc": [28], "fixing_code_end_loc": [112], "type": "CWE-352", "message": "XWiki Platform is a generic wiki platform. Prior to versions 13.10.5 and 14.3, it is possible to perform a Cross-Site Request Forgery (CSRF) attack for adding or removing tags on XWiki pages. The problem has been patched in XWiki 13.10.5 and 14.3. As a workaround, one may locally modify the `documentTags.vm` template in one's filesystem, to apply the changes exposed there.", "other": {"cve": {"id": "CVE-2022-36095", "sourceIdentifier": "security-advisories@github.com", "published": "2022-09-08T21:15:07.870", "lastModified": "2022-09-15T14:02:50.120", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "XWiki Platform is a generic wiki platform. Prior to versions 13.10.5 and 14.3, it is possible to perform a Cross-Site Request Forgery (CSRF) attack for adding or removing tags on XWiki pages. The problem has been patched in XWiki 13.10.5 and 14.3. As a workaround, one may locally modify the `documentTags.vm` template in one's filesystem, to apply the changes exposed there."}, {"lang": "es", "value": "XWiki Platform es una plataforma wiki gen\u00e9rica.&#xa0;En versiones anteriores a 13.10.5 y 14.3, era posible llevar a cabo un ataque de tipo Cross-Site Request Forgery (CSRF) para agregar o eliminar etiquetas en las p\u00e1ginas de XWiki.&#xa0;El problema ha sido parcheado en XWiki versiones 13.10.5 y 14.3.&#xa0;Como mitigaci\u00f3n, uno puede modificar localmente la plantilla \"documentTags.vm\" en el sistema de archivos de uno, para aplicar los cambios expuestos all\u00ed"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:*:*:*:*:*:*:*:*", "versionStartIncluding": "2.3", "versionEndExcluding": "13.10.6", "matchCriteriaId": "CA38BFD3-071C-41C6-8BD7-41D9237A24DE"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:*:*:*:*:*:*:*:*", "versionStartIncluding": "14.0", "versionEndExcluding": "14.3", "matchCriteriaId": "9B57E523-06A8-4964-84FE-361C9AA26990"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:2.0:milestone2:*:*:*:*:*:*", "matchCriteriaId": "67F5BE97-09EF-4019-A503-2EA2CA1E3790"}]}]}], "references": [{"url": "https://github.com/xwiki/xwiki-platform/commit/7ca56e40cf79a468cea54d3480b6b403f259f9ae", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-fxwr-4vq9-9vhj", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://jira.xwiki.org/browse/XWIKI-19550", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}]}, "github_commit_url": "https://github.com/xwiki/xwiki-platform/commit/7ca56e40cf79a468cea54d3480b6b403f259f9ae"}}