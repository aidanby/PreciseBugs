{"buggy_code": ["<?php\nnamespace Api\\Controller;\nuse Think\\Controller;\nclass AdminUpdateController extends BaseController {\n\n    //\u68c0\u6d4bshowdoc\u7248\u672c\u66f4\u65b0\n    public function checkUpdate(){\n        //\u83b7\u53d6\u5f53\u524d\u7248\u672c\n        $text = file_get_contents(\"../composer.json\");\n        $composer = json_decode($text, true);\n        $version = $composer['version'] ;\n        $url = \"https://www.showdoc.cc/server/api/open/checkUpdate\";\n        $ch = curl_init();\n        $timeout = 2;\n        curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);\n        curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, $timeout);\n        curl_setopt ( $ch, CURLOPT_POST, true );\n        curl_setopt ( $ch, CURLOPT_POSTFIELDS, \"version={$version}\" );\n        curl_setopt($ch,CURLOPT_URL,$url);\n        $sContent = curl_exec($ch);\n        curl_close($ch);\n        echo $sContent  ;\n    }\n\n    // \u4e0b\u8f7d\u66f4\u65b0\u4ee3\u7801\u5305\n    public function download(){\n        $this->checkLogin();\n        $this->checkAdmin();\n        set_time_limit(1000);\n        ini_set('memory_limit','500M');\n        $new_version = I(\"new_version\") ;\n        $file_url = I(\"file_url\") ;\n        $version_num = str_replace(\"v\",\"\",$new_version) ;\n\n        $showdoc_path = \"../\" ;\n\n        // \u8fdb\u884c\u6587\u4ef6\u8bfb\u5199\u6743\u9650\u68c0\u67e5\n        if(!$this->new_is_writeable($showdoc_path)\n            || !$this->new_is_writeable($showdoc_path.\"Sqlite/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/index.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/vendor/autoload.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/Application/Api\" )\n        ){\n            $this->sendError(10101,'\u8bf7\u624b\u52a8\u7ed9showdoc\u5b89\u88c5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u53ef\u5199\u6743\u9650\uff0c\u5426\u5219\u7a0b\u5e8f\u65e0\u6cd5\u8986\u76d6\u65e7\u6587\u4ef6');\n            return ;\n        }\n\n        $temp_dir = sys_get_temp_dir().\"/showdoc_update/\";\n        $zip_file = $temp_dir.'showdoc-'.$version_num.'.zip' ;\n        mkdir($temp_dir) ;\n        unlink($zip_file);\n        $file = file_get_contents($file_url);\n        file_put_contents($zip_file,$file);\n        \n        $zip = new \\ZipArchive();\n        $flag = $zip->open($zip_file);\n        if($flag!==true){\n            $this->sendError(10101,'\u4e0b\u8f7d\u66f4\u65b0\u538b\u7f29\u5305\u5931\u8d25');\n            return ;\n        }\n        $zip->extractTo($temp_dir);\n        $flag = $zip->close();\n        \n        $zip_file_subpath = $temp_dir.'showdoc-'.$version_num.\"/\" ;\n        \n        if(file_exists($zip_file_subpath.'composer.json') && file_exists($zip_file_subpath.'web/index.php') && file_exists($zip_file_subpath.'server/vendor/autoload.php') ){\n            //echo $zip_file_subpath.'\u5b58\u5728';\n            // \u79fb\u52a8\u76ee\u5f55\u5230upload/update\n            $this->copydir($zip_file_subpath ,$showdoc_path.'Public/Uploads/update/' );\n            $this->deldir($temp_dir);\n            $this->sendResult(array());\n        \n        }else{\n            $this->sendError(10101,'\u4e0b\u8f7d\u66f4\u65b0\u538b\u7f29\u5305\u540e\uff0c\u89e3\u538b\u7684\u6587\u4ef6\u7f3a\u5931');\n            return ;\n        }\n    }\n\n    // \u6267\u884c\u5347\u7ea7\u64cd\u4f5c\uff0c\u5347\u7ea7\u8986\u76d6\u6587\u4ef6\n    public function updateFiles(){\n        $this->checkLogin();\n        $this->checkAdmin();\n        set_time_limit(1000);\n        ini_set('memory_limit','500M');\n        \n        $showdoc_path = \"../\" ;\n        \n        // \u8fdb\u884c\u6587\u4ef6\u8bfb\u5199\u6743\u9650\u68c0\u67e5\n        if(!$this->new_is_writeable($showdoc_path)\n            || !$this->new_is_writeable($showdoc_path.\"Sqlite/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/index.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/vendor/autoload.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/Application/Api\" )\n        ){\n            $this->sendError(10101,'\u8bf7\u624b\u52a8\u7ed9showdoc\u5b89\u88c5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u53ef\u5199\u6743\u9650\uff0c\u5426\u5219\u7a0b\u5e8f\u65e0\u6cd5\u8986\u76d6\u65e7\u6587\u4ef6');\n            return ;\n        }\n\n        if(file_exists($showdoc_path.'Public/Uploads/update/composer.json') && file_exists($showdoc_path.'Public/Uploads/update/server/vendor/autoload.php') ){\n        \n                $text = file_get_contents($showdoc_path.\"composer.json\");\n                $composer = json_decode($text, true);\n                $cur_version = $composer['version'] ;\n                $cur_version = str_replace(\"v\",\"\",$cur_version) ;\n        \n                $text = file_get_contents($showdoc_path.\"Public/Uploads/update/composer.json\");\n                $composer = json_decode($text, true);\n                $update_version = $composer['version'] ;\n                $update_version = str_replace(\"v\",\"\",$update_version) ;\n        \n                if(version_compare($update_version,$cur_version) > 0 ){\n                    //\u590d\u5236\u6570\u636e\u5e93\u6587\u4ef6\u5907\u4efd\n                    $bak_name = $showdoc_path.'Sqlite/showdoc.db.bak.'.date(\"Y-m-d-H-i-s\").'.php';\n                    copy($showdoc_path.'Sqlite/showdoc.db.php', $bak_name);\n        \n                    // \u76ee\u5f55\u8986\u76d6\n                    $this->copydir($showdoc_path.'Public/Uploads/update/',$showdoc_path);\n                    // \u7528\u5907\u4efd\u7684\u6570\u636e\u5e93\u8fd8\u539f\n                    copy($bak_name, $showdoc_path.'Sqlite/showdoc.db.php' );\n        \n                    $this->deldir($showdoc_path.'Public/Uploads/update/') ;\n        \n                    // echo '\u5347\u7ea7\u6210\u529f\uff01' ;\n                    $this->sendResult(array());\n        \n                }else{\n                    // echo '\u4e0d\u9700\u8981\u5347\u7ea7';\n                    $this->sendError(10101,'\u7248\u672c\u53f7\u663e\u793a\u4e0d\u9700\u8981\u5347\u7ea7');\n                }\n        }else{\n            $this->sendError(10101,'\u5347\u7ea7\u6587\u4ef6\u4e0d\u5b58\u5728');\n        }\n    }\n\n    /**\n     * \u590d\u5236\u5230\u76ee\u5f55\n    * $dirsrc  \u539f\u76ee\u5f55\n    * $dirto  \u76ee\u6807\u76ee\u5f55\n    *\n    */\n    private function copydir($dirsrc, $dirto) {\n        //\u5982\u679c\u539f\u6765\u7684\u6587\u4ef6\u5b58\u5728\uff0c \u662f\u4e0d\u662f\u4e00\u4e2a\u76ee\u5f55\n\n        if(file_exists($dirto)) {\n            if(!is_dir($dirto)) {\n                echo \"\u76ee\u6807\u4e0d\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c \u4e0d\u80fdcopy\u8fdb\u53bb<br>\";\n                exit;   \n            }\n        }else{\n            mkdir($dirto);\n        }\n\n\n        $dir = opendir($dirsrc);\n\n        while($filename = readdir($dir)) {\n            if($filename != \".\" && $filename !=\"..\") {\n                $srcfile = $dirsrc.\"/\".$filename;  //\u539f\u6587\u4ef6\n                $tofile = $dirto.\"/\".$filename;    //\u76ee\u6807\u6587\u4ef6\n\n                if(is_dir($srcfile)) {\n                    $this->copydir($srcfile, $tofile);  //\u9012\u5f52\u5904\u7406\u6240\u6709\u5b50\u76ee\u5f55\n                }else{\n                    copy($srcfile, $tofile);\n                }\n\n            }\n        }\n    }\n\n    // \u5220\u9664\u6587\u4ef6\u5939\u53ca\u6587\u4ef6\u5939\u4e0b\u6240\u6709\u7684\u6587\u4ef6\n    private function deldir($dir) {\n        //\u5148\u5220\u9664\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff1a\n        $dh = opendir($dir);\n        while ($file = readdir($dh)) {\n            if($file != \".\" && $file!=\"..\") {\n            $fullpath = $dir.\"/\".$file;\n            if(!is_dir($fullpath)) {\n                unlink($fullpath);\n            } else {\n                $this->deldir($fullpath);\n            }\n            }\n        }\n        closedir($dh);\n\n        //\u5220\u9664\u5f53\u524d\u6587\u4ef6\u5939\uff1a\n        if(rmdir($dir)) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n\n    /**\n     * \u5224\u65ad \u6587\u4ef6/\u76ee\u5f55 \u662f\u5426\u53ef\u5199\uff08\u53d6\u4ee3\u7cfb\u7edf\u81ea\u5e26\u7684 is_writeable \u51fd\u6570\uff09\n     *\n     * @param string $file \u6587\u4ef6/\u76ee\u5f55\n     * @return boolean\n     */\n    private function new_is_writeable($file) {\n        if (is_dir($file)){\n        $dir = $file;\n        if ($fp = @fopen(\"$dir/test.txt\", 'w')) {\n            @fclose($fp);\n            @unlink(\"$dir/test.txt\");\n            $writeable = 1;\n        } else {\n            $writeable = 0;\n        }\n        } else {\n        if ($fp = @fopen($file, 'a+')) {\n            @fclose($fp);\n            $writeable = 1;\n        } else {\n            $writeable = 0;\n        }\n        }\n    \n        return $writeable;\n    }\n\n}\n", "<template>\n  <div class=\"\">\n    <div>\n      <br />\n      <p>\n        \u672c\u7ad9\u57fa\u4e8e\u5f00\u6e90\u7248<b>showdoc {{ cur_version }}</b\n        >\u642d\u5efa\n      </p>\n      <p>\n        \u5982\u6709\u95ee\u9898\u6216\u8005\u5efa\u8bae\uff0c\u8bf7\u5230github\u63d0issue\uff1a<a\n          href=\"https://github.com/star7th/showdoc/issues\"\n          target=\"_blank\"\n          >https://github.com/star7th/showdoc/issues</a\n        >\n        <br />\u5982\u679c\u4f60\u89c9\u5f97showdoc\u597d\u7528\uff0c\u4e0d\u59a8\u53bb<a\n          href=\"https://github.com/star7th/showdoc\"\n          target=\"_blank\"\n          >github</a\n        >\u7ed9\u5f00\u6e90\u9879\u76ee\u70b9\u4e00\u4e2astar\u3002\u826f\u597d\u7684\u5173\u6ce8\u5ea6\u548c\u53c2\u4e0e\u5ea6\u6709\u52a9\u4e8e\u5f00\u6e90\u9879\u76ee\u7684\u957f\u8fdc\u53d1\u5c55\u3002\n      </p>\n      <p>\n        <a href=\"https://www.showdoc.com.cn/\" target=\"_blank\">showdoc\u5b98\u65b9</a>\n        \u62e5\u6709\u7a0b\u5e8f\u7684\u7248\u6743\u548c\u76f8\u5e94\u6743\u5229\uff0c\u5728\u4fdd\u7559\u7248\u6743\u4fe1\u606f\u548c\u94fe\u63a5\u7684\u524d\u63d0\u4e0b\u53ef\u514d\u8d39\u4f7f\u7528\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\n      </p>\n    </div>\n\n    <div v-if=\"isUpdate\">\n      <hr />\n      <p>\n        \u68c0\u6d4b\u5230showdoc\u6709\u65b0\u7248\u66f4\u65b0({{\n          new_version\n        }})\uff0c\u70b9\u51fb\u4e0b\u65b9\u6309\u94ae\u5c06\u81ea\u52a8\u5347\u7ea7\u5230\u6700\u65b0\u7a33\u5b9a\u7248\u3002<a\n          href=\"https://www.showdoc.com.cn/help/13733\"\n          target=\"_blank\"\n          >\u66f4\u65b0\u65e5\u5fd7</a\n        >\n      </p>\n      <p>\n        \u5347\u7ea7\u5230\u6700\u65b0\u7248\u6709\u52a9\u4e8e\u53ca\u65f6\u5f97\u5230\u5b98\u65b9\u7684\u5b89\u5168\u4fee\u590d\u548c\u529f\u80fd\u66f4\u65b0\uff0c\u4ee5\u83b7\u5f97\u66f4\u5b89\u5168\u66f4\u7a33\u5b9a\u7684\u4f7f\u7528\u4f53\u9a8c\u3002\n      </p>\n      <el-badge value=\"new\"\n        ><el-button type=\"primary\" @click=\"clickToUpdate\"\n          >\u70b9\u6b64\u66f4\u65b0</el-button\n        ></el-badge\n      >\n      <br />\n      <br />\n      <div>\n        \u5982\u70b9\u51fb\u4e0a\u9762\u6309\u94ae\u66f4\u65b0\u5931\u8d25\uff0c<a\n          href=\"https://www.showdoc.com.cn/help?page_id=13732\"\n          target=\"_blank\"\n          >\u70b9\u51fb\u8fd9\u91cc</a\n        >\u53c2\u8003\u6587\u6863\u8fdb\u884c\u624b\u52a8\u5347\u7ea7\n      </div>\n    </div>\n  </div>\n</template>\n\n<style scoped></style>\n\n<script>\nexport default {\n  data() {\n    return {\n      isUpdate: false,\n      cur_version: '',\n      new_version: '',\n      url: '',\n      file_url: ''\n    }\n  },\n  methods: {\n    getCurVersion() {\n      this.request('/api/common/version', {}).then(data => {\n        if (data && data.data && data.data.version) {\n          this.cur_version = data.data.version\n        }\n      })\n    },\n    checkUpadte() {\n      this.request('/api/adminUpdate/checkUpdate', {}).then(data => {\n        if (data && data.data && data.data.url) {\n          this.url = data.data.url\n          this.file_url = data.data.file_url\n          this.new_version = data.data.new_version\n          this.cur_version = data.data.version\n          this.isUpdate = true\n        }\n      })\n    },\n    clickToUpdate() {\n      let loading = this.$loading({\n        text: '\u6b63\u5728\u4e0b\u8f7d\u66f4\u65b0\u5305...'\n      })\n      this.request('/api/adminUpdate/download', {\n        new_version: this.new_version,\n        file_url: this.file_url\n      }).then(\n        data => {\n          loading.close()\n          loading = this.$loading({\n            text: '\u6b63\u5728\u66f4\u65b0\u6587\u4ef6...'\n          })\n          this.request('/api/adminUpdate/updateFiles', {}).then(\n            () => {\n              loading.close()\n              loading = this.$loading({\n                text:\n                  '\u5347\u7ea7\u6587\u4ef6\u6210\u529f\uff0c\u51c6\u5907\u5237\u65b0\u9875\u9762...\u5982\u679c\u9875\u9762\u7f13\u5b58\u8fdf\u8fdf\u4e0d\u80fd\u81ea\u52a8\u66f4\u65b0\uff0c\u8bf7\u624b\u52a8\u5237\u65b0\u9875\u9762\u4ee5\u66f4\u65b0\u6d4f\u89c8\u5668\u7f13\u5b58'\n              })\n              this.request('/api/update/checkDb')\n              // this.axios.get('./')\n              setTimeout(() => {\n                window.location.reload()\n              }, 7000)\n            },\n            () => {\n              loading.close()\n            }\n          )\n        },\n        () => {\n          loading.close()\n        }\n      )\n    }\n  },\n  mounted() {\n    this.checkUpadte()\n    this.getCurVersion()\n  },\n  beforeDestroy() {}\n}\n</script>\n"], "fixing_code": ["<?php\nnamespace Api\\Controller;\nuse Think\\Controller;\nclass AdminUpdateController extends BaseController {\n\n    //\u68c0\u6d4bshowdoc\u7248\u672c\u66f4\u65b0\n    public function checkUpdate(){\n        //\u83b7\u53d6\u5f53\u524d\u7248\u672c\n        $text = file_get_contents(\"../composer.json\");\n        $composer = json_decode($text, true);\n        $version = $composer['version'] ;\n        $url = \"https://www.showdoc.cc/server/api/open/checkUpdate\";\n        $ch = curl_init();\n        $timeout = 2;\n        curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);\n        curl_setopt ($ch, CURLOPT_CONNECTTIMEOUT, $timeout);\n        curl_setopt ( $ch, CURLOPT_POST, true );\n        curl_setopt ( $ch, CURLOPT_POSTFIELDS, \"version={$version}\" );\n        curl_setopt($ch,CURLOPT_URL,$url);\n        $sContent = curl_exec($ch);\n        curl_close($ch);\n        echo $sContent  ;\n    }\n\n    // \u4e0b\u8f7d\u66f4\u65b0\u4ee3\u7801\u5305\n    public function download(){\n        $this->checkLogin();\n        $this->checkAdmin();\n        set_time_limit(1000);\n        ini_set('memory_limit','500M');\n        //\u83b7\u53d6\u5f53\u524d\u7248\u672c\n        $text = file_get_contents(\"../composer.json\");\n        $composer = json_decode($text, true);\n        $version = $composer['version'] ;\n        $url = \"https://www.showdoc.cc/server/api/open/checkUpdate\";\n        $res = http_post($url , array(\"version\"=>$version));\n        $res_array = json_decode($res,true);\n        $new_version =$res_array['data']['new_version'] ;\n        $file_url =$res_array['data']['file_url'] ;\n\n        if(!$file_url){\n            $this->sendError(10101,'\u68c0\u6d4b\u66f4\u65b0\u65f6\u5f02\u5e38');\n            return ;\n        }\n\n        $version_num = str_replace(\"v\",\"\",$new_version) ;\n\n        $showdoc_path = \"../\" ;\n\n        // \u8fdb\u884c\u6587\u4ef6\u8bfb\u5199\u6743\u9650\u68c0\u67e5\n        if(!$this->new_is_writeable($showdoc_path)\n            || !$this->new_is_writeable($showdoc_path.\"Sqlite/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/index.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/vendor/autoload.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/Application/Api\" )\n        ){\n            $this->sendError(10101,'\u8bf7\u624b\u52a8\u7ed9showdoc\u5b89\u88c5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u53ef\u5199\u6743\u9650\uff0c\u5426\u5219\u7a0b\u5e8f\u65e0\u6cd5\u8986\u76d6\u65e7\u6587\u4ef6');\n            return ;\n        }\n\n        $temp_dir = sys_get_temp_dir().\"/showdoc_update/\";\n        $zip_file = $temp_dir.'showdoc-'.$version_num.'.zip' ;\n        mkdir($temp_dir) ;\n        unlink($zip_file);\n        $file = file_get_contents($file_url);\n        file_put_contents($zip_file,$file);\n        \n        $zip = new \\ZipArchive();\n        $flag = $zip->open($zip_file);\n        if($flag!==true){\n            $this->sendError(10101,'\u4e0b\u8f7d\u66f4\u65b0\u538b\u7f29\u5305\u5931\u8d25');\n            return ;\n        }\n        $zip->extractTo($temp_dir);\n        $flag = $zip->close();\n        \n        $zip_file_subpath = $temp_dir.'showdoc-'.$version_num.\"/\" ;\n        \n        if(file_exists($zip_file_subpath.'composer.json') && file_exists($zip_file_subpath.'web/index.php') && file_exists($zip_file_subpath.'server/vendor/autoload.php') ){\n            //echo $zip_file_subpath.'\u5b58\u5728';\n            // \u79fb\u52a8\u76ee\u5f55\u5230upload/update\n            $this->copydir($zip_file_subpath ,$showdoc_path.'Public/Uploads/update/' );\n            $this->deldir($temp_dir);\n            $this->sendResult(array());\n        \n        }else{\n            $this->sendError(10101,'\u4e0b\u8f7d\u66f4\u65b0\u538b\u7f29\u5305\u540e\uff0c\u89e3\u538b\u7684\u6587\u4ef6\u7f3a\u5931');\n            return ;\n        }\n    }\n\n    // \u6267\u884c\u5347\u7ea7\u64cd\u4f5c\uff0c\u5347\u7ea7\u8986\u76d6\u6587\u4ef6\n    public function updateFiles(){\n        $this->checkLogin();\n        $this->checkAdmin();\n        set_time_limit(1000);\n        ini_set('memory_limit','500M');\n        \n        $showdoc_path = \"../\" ;\n        \n        // \u8fdb\u884c\u6587\u4ef6\u8bfb\u5199\u6743\u9650\u68c0\u67e5\n        if(!$this->new_is_writeable($showdoc_path)\n            || !$this->new_is_writeable($showdoc_path.\"Sqlite/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/\" )\n            || !$this->new_is_writeable($showdoc_path.\"web/index.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/vendor/autoload.php\" )\n            || !$this->new_is_writeable($showdoc_path.\"server/Application/Api\" )\n        ){\n            $this->sendError(10101,'\u8bf7\u624b\u52a8\u7ed9showdoc\u5b89\u88c5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u53ef\u5199\u6743\u9650\uff0c\u5426\u5219\u7a0b\u5e8f\u65e0\u6cd5\u8986\u76d6\u65e7\u6587\u4ef6');\n            return ;\n        }\n\n        if(file_exists($showdoc_path.'Public/Uploads/update/composer.json') && file_exists($showdoc_path.'Public/Uploads/update/server/vendor/autoload.php') ){\n        \n                $text = file_get_contents($showdoc_path.\"composer.json\");\n                $composer = json_decode($text, true);\n                $cur_version = $composer['version'] ;\n                $cur_version = str_replace(\"v\",\"\",$cur_version) ;\n        \n                $text = file_get_contents($showdoc_path.\"Public/Uploads/update/composer.json\");\n                $composer = json_decode($text, true);\n                $update_version = $composer['version'] ;\n                $update_version = str_replace(\"v\",\"\",$update_version) ;\n        \n                if(version_compare($update_version,$cur_version) > 0 ){\n                    //\u590d\u5236\u6570\u636e\u5e93\u6587\u4ef6\u5907\u4efd\n                    $bak_name = $showdoc_path.'Sqlite/showdoc.db.bak.'.date(\"Y-m-d-H-i-s\").'.php';\n                    copy($showdoc_path.'Sqlite/showdoc.db.php', $bak_name);\n        \n                    // \u76ee\u5f55\u8986\u76d6\n                    $this->copydir($showdoc_path.'Public/Uploads/update/',$showdoc_path);\n                    // \u7528\u5907\u4efd\u7684\u6570\u636e\u5e93\u8fd8\u539f\n                    copy($bak_name, $showdoc_path.'Sqlite/showdoc.db.php' );\n        \n                    $this->deldir($showdoc_path.'Public/Uploads/update/') ;\n        \n                    // echo '\u5347\u7ea7\u6210\u529f\uff01' ;\n                    $this->sendResult(array());\n        \n                }else{\n                    // echo '\u4e0d\u9700\u8981\u5347\u7ea7';\n                    $this->sendError(10101,'\u7248\u672c\u53f7\u663e\u793a\u4e0d\u9700\u8981\u5347\u7ea7');\n                }\n        }else{\n            $this->sendError(10101,'\u5347\u7ea7\u6587\u4ef6\u4e0d\u5b58\u5728');\n        }\n    }\n\n    /**\n     * \u590d\u5236\u5230\u76ee\u5f55\n    * $dirsrc  \u539f\u76ee\u5f55\n    * $dirto  \u76ee\u6807\u76ee\u5f55\n    *\n    */\n    private function copydir($dirsrc, $dirto) {\n        //\u5982\u679c\u539f\u6765\u7684\u6587\u4ef6\u5b58\u5728\uff0c \u662f\u4e0d\u662f\u4e00\u4e2a\u76ee\u5f55\n\n        if(file_exists($dirto)) {\n            if(!is_dir($dirto)) {\n                echo \"\u76ee\u6807\u4e0d\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c \u4e0d\u80fdcopy\u8fdb\u53bb<br>\";\n                exit;   \n            }\n        }else{\n            mkdir($dirto);\n        }\n\n\n        $dir = opendir($dirsrc);\n\n        while($filename = readdir($dir)) {\n            if($filename != \".\" && $filename !=\"..\") {\n                $srcfile = $dirsrc.\"/\".$filename;  //\u539f\u6587\u4ef6\n                $tofile = $dirto.\"/\".$filename;    //\u76ee\u6807\u6587\u4ef6\n\n                if(is_dir($srcfile)) {\n                    $this->copydir($srcfile, $tofile);  //\u9012\u5f52\u5904\u7406\u6240\u6709\u5b50\u76ee\u5f55\n                }else{\n                    copy($srcfile, $tofile);\n                }\n\n            }\n        }\n    }\n\n    // \u5220\u9664\u6587\u4ef6\u5939\u53ca\u6587\u4ef6\u5939\u4e0b\u6240\u6709\u7684\u6587\u4ef6\n    private function deldir($dir) {\n        //\u5148\u5220\u9664\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff1a\n        $dh = opendir($dir);\n        while ($file = readdir($dh)) {\n            if($file != \".\" && $file!=\"..\") {\n            $fullpath = $dir.\"/\".$file;\n            if(!is_dir($fullpath)) {\n                unlink($fullpath);\n            } else {\n                $this->deldir($fullpath);\n            }\n            }\n        }\n        closedir($dh);\n\n        //\u5220\u9664\u5f53\u524d\u6587\u4ef6\u5939\uff1a\n        if(rmdir($dir)) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n\n    /**\n     * \u5224\u65ad \u6587\u4ef6/\u76ee\u5f55 \u662f\u5426\u53ef\u5199\uff08\u53d6\u4ee3\u7cfb\u7edf\u81ea\u5e26\u7684 is_writeable \u51fd\u6570\uff09\n     *\n     * @param string $file \u6587\u4ef6/\u76ee\u5f55\n     * @return boolean\n     */\n    private function new_is_writeable($file) {\n        if (is_dir($file)){\n        $dir = $file;\n        if ($fp = @fopen(\"$dir/test.txt\", 'w')) {\n            @fclose($fp);\n            @unlink(\"$dir/test.txt\");\n            $writeable = 1;\n        } else {\n            $writeable = 0;\n        }\n        } else {\n        if ($fp = @fopen($file, 'a+')) {\n            @fclose($fp);\n            $writeable = 1;\n        } else {\n            $writeable = 0;\n        }\n        }\n    \n        return $writeable;\n    }\n\n}\n", "<template>\n  <div class=\"\">\n    <div>\n      <br />\n      <p>\n        \u672c\u7ad9\u57fa\u4e8e\u5f00\u6e90\u7248<b>showdoc {{ cur_version }}</b\n        >\u642d\u5efa\n      </p>\n      <p>\n        \u5982\u6709\u95ee\u9898\u6216\u8005\u5efa\u8bae\uff0c\u8bf7\u5230github\u63d0issue\uff1a<a\n          href=\"https://github.com/star7th/showdoc/issues\"\n          target=\"_blank\"\n          >https://github.com/star7th/showdoc/issues</a\n        >\n        <br />\u5982\u679c\u4f60\u89c9\u5f97showdoc\u597d\u7528\uff0c\u4e0d\u59a8\u53bb<a\n          href=\"https://github.com/star7th/showdoc\"\n          target=\"_blank\"\n          >github</a\n        >\u7ed9\u5f00\u6e90\u9879\u76ee\u70b9\u4e00\u4e2astar\u3002\u826f\u597d\u7684\u5173\u6ce8\u5ea6\u548c\u53c2\u4e0e\u5ea6\u6709\u52a9\u4e8e\u5f00\u6e90\u9879\u76ee\u7684\u957f\u8fdc\u53d1\u5c55\u3002\n      </p>\n      <p>\n        <a href=\"https://www.showdoc.com.cn/\" target=\"_blank\">showdoc\u5b98\u65b9</a>\n        \u62e5\u6709\u7a0b\u5e8f\u7684\u7248\u6743\u548c\u76f8\u5e94\u6743\u5229\uff0c\u5728\u4fdd\u7559\u7248\u6743\u4fe1\u606f\u548c\u94fe\u63a5\u7684\u524d\u63d0\u4e0b\u53ef\u514d\u8d39\u4f7f\u7528\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\n      </p>\n    </div>\n\n    <div v-if=\"isUpdate\">\n      <hr />\n      <p>\n        \u68c0\u6d4b\u5230showdoc\u6709\u65b0\u7248\u66f4\u65b0({{\n          new_version\n        }})\uff0c\u70b9\u51fb\u4e0b\u65b9\u6309\u94ae\u5c06\u81ea\u52a8\u5347\u7ea7\u5230\u6700\u65b0\u7a33\u5b9a\u7248\u3002<a\n          href=\"https://www.showdoc.com.cn/help/13733\"\n          target=\"_blank\"\n          >\u66f4\u65b0\u65e5\u5fd7</a\n        >\n      </p>\n      <p>\n        \u5347\u7ea7\u5230\u6700\u65b0\u7248\u6709\u52a9\u4e8e\u53ca\u65f6\u5f97\u5230\u5b98\u65b9\u7684\u5b89\u5168\u4fee\u590d\u548c\u529f\u80fd\u66f4\u65b0\uff0c\u4ee5\u83b7\u5f97\u66f4\u5b89\u5168\u66f4\u7a33\u5b9a\u7684\u4f7f\u7528\u4f53\u9a8c\u3002\n      </p>\n      <el-badge value=\"new\"\n        ><el-button type=\"primary\" @click=\"clickToUpdate\"\n          >\u70b9\u6b64\u66f4\u65b0</el-button\n        ></el-badge\n      >\n      <br />\n      <br />\n      <div>\n        \u5982\u70b9\u51fb\u4e0a\u9762\u6309\u94ae\u66f4\u65b0\u5931\u8d25\uff0c<a\n          href=\"https://www.showdoc.com.cn/help?page_id=13732\"\n          target=\"_blank\"\n          >\u70b9\u51fb\u8fd9\u91cc</a\n        >\u53c2\u8003\u6587\u6863\u8fdb\u884c\u624b\u52a8\u5347\u7ea7\n      </div>\n    </div>\n  </div>\n</template>\n\n<style scoped></style>\n\n<script>\nexport default {\n  data() {\n    return {\n      isUpdate: false,\n      cur_version: '',\n      new_version: '',\n      url: ''\n    }\n  },\n  methods: {\n    getCurVersion() {\n      this.request('/api/common/version', {}).then(data => {\n        if (data && data.data && data.data.version) {\n          this.cur_version = data.data.version\n        }\n      })\n    },\n    checkUpadte() {\n      this.request('/api/adminUpdate/checkUpdate', {}).then(data => {\n        if (data && data.data && data.data.url) {\n          this.url = data.data.url\n          this.new_version = data.data.new_version\n          this.cur_version = data.data.version\n          this.isUpdate = true\n        }\n      })\n    },\n    clickToUpdate() {\n      let loading = this.$loading({\n        text: '\u6b63\u5728\u4e0b\u8f7d\u66f4\u65b0\u5305...'\n      })\n      this.request('/api/adminUpdate/download', {}).then(\n        data => {\n          loading.close()\n          loading = this.$loading({\n            text: '\u6b63\u5728\u66f4\u65b0\u6587\u4ef6...'\n          })\n          this.request('/api/adminUpdate/updateFiles', {}).then(\n            () => {\n              loading.close()\n              loading = this.$loading({\n                text:\n                  '\u5347\u7ea7\u6587\u4ef6\u6210\u529f\uff0c\u51c6\u5907\u5237\u65b0\u9875\u9762...\u5982\u679c\u9875\u9762\u7f13\u5b58\u8fdf\u8fdf\u4e0d\u80fd\u81ea\u52a8\u66f4\u65b0\uff0c\u8bf7\u624b\u52a8\u5237\u65b0\u9875\u9762\u4ee5\u66f4\u65b0\u6d4f\u89c8\u5668\u7f13\u5b58'\n              })\n              this.request('/api/update/checkDb')\n              // this.axios.get('./')\n              setTimeout(() => {\n                window.location.reload()\n              }, 7000)\n            },\n            () => {\n              loading.close()\n            }\n          )\n        },\n        () => {\n          loading.close()\n        }\n      )\n    }\n  },\n  mounted() {\n    this.checkUpadte()\n    this.getCurVersion()\n  },\n  beforeDestroy() {}\n}\n</script>\n"], "filenames": ["server/Application/Api/Controller/AdminUpdateController.class.php", "web_src/src/components/admin/about/Index.vue"], "buggy_code_start_loc": [31, 68], "buggy_code_end_loc": [33, 99], "fixing_code_start_loc": [31, 68], "fixing_code_end_loc": [46, 94], "type": "CWE-434", "message": "There is a Unrestricted Upload of File vulnerability in ShowDoc v2.10.3 in GitHub repository star7th/showdoc prior to 2.10.4.", "other": {"cve": {"id": "CVE-2022-1034", "sourceIdentifier": "security@huntr.dev", "published": "2022-03-22T08:15:07.003", "lastModified": "2022-03-28T21:03:01.067", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "There is a Unrestricted Upload of File vulnerability in ShowDoc v2.10.3 in GitHub repository star7th/showdoc prior to 2.10.4."}, {"lang": "es", "value": "Se presenta una vulnerabilidad de Carga no Restringida de Archivos en ShowDoc versi\u00f3n v2.10.3, en el repositorio GitHub star7th/showdoc versiones anteriores a 2.10.4"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.1, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 2.3, "impactScore": 6.0}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-434"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-434"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:showdoc:showdoc:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.10.4", "matchCriteriaId": "4AA94847-8E4A-4668-B8DE-2727B947AC1C"}]}]}], "references": [{"url": "https://github.com/star7th/showdoc/commit/bd792a89c0325836fbd64784f4c4117c0171416b", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/d205c489-3266-4ac4-acb7-c8ee570887f7", "source": "security@huntr.dev", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/star7th/showdoc/commit/bd792a89c0325836fbd64784f4c4117c0171416b"}}