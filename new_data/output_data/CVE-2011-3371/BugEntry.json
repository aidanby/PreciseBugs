{"buggy_code": ["<?php\n/**\n * Loads common functions used throughout the site.\n *\n * @copyright (C) 2008-2009 PunBB, partially based on code (C) 2008-2009 FluxBB.org\n * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher\n * @package PunBB\n */\n\n//\n// Common helpers and forum's wrappers for PHP functions\n//\n\n// Encodes the contents of $str so that they are safe to output on an (X)HTML page\nfunction forum_htmlencode($str)\n{\n\t$return = ($hook = get_hook('fn_forum_htmlencode_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn htmlspecialchars($str, ENT_QUOTES, 'UTF-8');\n}\n\n\n// Trim whitespace including non-breaking space\nfunction forum_trim($str, $charlist = \" \\t\\n\\r\\x0b\\xc2\\xa0\")\n{\n\treturn utf8_trim($str, $charlist);\n}\n\n\n// Convert \\r\\n and \\r to \\n\nfunction forum_linebreaks($str)\n{\n\treturn str_replace(array(\"\\r\\n\", \"\\r\"), \"\\n\", $str);\n}\n\n\n// Converts the CDATA end sequence ]]> into ]]&gt;\nfunction escape_cdata($str)\n{\n\treturn str_replace(']]>', ']]&gt;', $str);\n}\n\n\n// Inserts $element into $input at $offset\n// $offset can be either a numerical offset to insert at (eg: 0 inserts at the beginning of the array)\n// or a string, which is the key that the new element should be inserted before\n// $key is optional: it's used when inserting a new key/value pair into an associative array\nfunction array_insert(&$input, $offset, $element, $key = null)\n{\n\tif ($key == null)\n\t\t$key = $offset;\n\n\t// Determine the proper offset if we're using a string\n\tif (!is_int($offset))\n\t\t$offset = array_search($offset, array_keys($input), true);\n\n\t// Out of bounds checks\n\tif ($offset > count($input))\n\t\t$offset = count($input);\n\telse if ($offset < 0)\n\t\t$offset = 0;\n\n\t$input = array_merge(array_slice($input, 0, $offset), array($key => $element), array_slice($input, $offset));\n}\n\n\n// Unset any variables instantiated as a result of register_globals being enabled\nfunction forum_unregister_globals()\n{\n\t$register_globals = @ini_get('register_globals');\n\tif ($register_globals === \"\" || $register_globals === \"0\" || strtolower($register_globals) === \"off\")\n\t\treturn;\n\n\t// Prevent script.php?GLOBALS[foo]=bar\n\tif (isset($_REQUEST['GLOBALS']) || isset($_FILES['GLOBALS']))\n\t\texit('I\\'ll have a steak sandwich and... a steak sandwich.');\n\n\t// Variables that shouldn't be unset\n\t$no_unset = array('GLOBALS', '_GET', '_POST', '_COOKIE', '_REQUEST', '_SERVER', '_ENV', '_FILES');\n\n\t// Remove elements in $GLOBALS that are present in any of the superglobals\n\t$input = array_merge($_GET, $_POST, $_COOKIE, $_SERVER, $_ENV, $_FILES, isset($_SESSION) && is_array($_SESSION) ? $_SESSION : array());\n\tforeach ($input as $k => $v)\n\t\tif (!in_array($k, $no_unset) && isset($GLOBALS[$k]))\n\t\t{\n\t\t\tunset($GLOBALS[$k]);\n\t\t\tunset($GLOBALS[$k]);\t// Double unset to circumvent the zend_hash_del_key_or_index hole in PHP <4.4.3 and <5.1.4\n\t\t}\n}\n// Removes any \"bad\" characters (characters which mess with the display of a page, are invisible, etc) from user input\nfunction forum_remove_bad_characters()\n{\n\tglobal $bad_utf8_chars;\n\n\t$bad_utf8_chars = array(\"\\0\", \"\\xc2\\xad\", \"\\xcc\\xb7\", \"\\xcc\\xb8\", \"\\xe1\\x85\\x9F\", \"\\xe1\\x85\\xA0\", \"\\xe2\\x80\\x80\", \"\\xe2\\x80\\x81\", \"\\xe2\\x80\\x82\", \"\\xe2\\x80\\x83\", \"\\xe2\\x80\\x84\", \"\\xe2\\x80\\x85\", \"\\xe2\\x80\\x86\", \"\\xe2\\x80\\x87\", \"\\xe2\\x80\\x88\", \"\\xe2\\x80\\x89\", \"\\xe2\\x80\\x8a\", \"\\xe2\\x80\\x8b\", \"\\xe2\\x80\\x8e\", \"\\xe2\\x80\\x8f\", \"\\xe2\\x80\\xaa\", \"\\xe2\\x80\\xab\", \"\\xe2\\x80\\xac\", \"\\xe2\\x80\\xad\", \"\\xe2\\x80\\xae\", \"\\xe2\\x80\\xaf\", \"\\xe2\\x81\\x9f\", \"\\xe3\\x80\\x80\", \"\\xe3\\x85\\xa4\", \"\\xef\\xbb\\xbf\", \"\\xef\\xbe\\xa0\", \"\\xef\\xbf\\xb9\", \"\\xef\\xbf\\xba\", \"\\xef\\xbf\\xbb\", \"\\xE2\\x80\\x8D\");\n\n\t($hook = get_hook('fn_remove_bad_characters_start')) ? eval($hook) : null;\n\n\tfunction _forum_remove_bad_characters($array)\n\t{\n\t\tglobal $bad_utf8_chars;\n\t\treturn is_array($array) ? array_map('_forum_remove_bad_characters', $array) : str_replace($bad_utf8_chars, '', $array);\n\t}\n\n\t$_GET = _forum_remove_bad_characters($_GET);\n\t$_POST = _forum_remove_bad_characters($_POST);\n\t$_COOKIE = _forum_remove_bad_characters($_COOKIE);\n\t$_REQUEST = _forum_remove_bad_characters($_REQUEST);\n}\n\n\n// Fix the REQUEST_URI if we can, since both IIS6 and IIS7 break it\nfunction forum_fix_request_uri()\n{\n\tif (defined('FORUM_IGNORE_REQUEST_URI'))\n\t\treturn;\n\n\tglobal $forum_config;\n\n\tif (!isset($_SERVER['REQUEST_URI']) || (isset($_SERVER['QUERY_STRING']) && !empty($_SERVER['QUERY_STRING']) && strpos($_SERVER['REQUEST_URI'], '?') === false))\n\t{\n\t\t// Workaround for a bug in IIS7\n\t\tif (isset($_SERVER['HTTP_X_ORIGINAL_URL']))\n\t\t\t$_SERVER['REQUEST_URI'] = $_SERVER['HTTP_X_ORIGINAL_URL'];\n\n\t\t// IIS6 also doesn't set REQUEST_URI, If we are using the default SEF URL scheme then we can work around it\n\t\telse if (!isset($forum_config) || $forum_config['o_sef'] == 'Default')\n\t\t{\n\t\t\t$requested_page = str_replace(array('%26', '%3D', '%2F', '%3F'), array('&', '=', '/', '?'), rawurlencode($_SERVER['PHP_SELF']));\n\t\t\t$_SERVER['REQUEST_URI'] = $requested_page.(isset($_SERVER['QUERY_STRING']) && !empty($_SERVER['QUERY_STRING']) ? '?'.$_SERVER['QUERY_STRING'] : '');\n\t\t}\n\n\t\t// Otherwise I am not aware of a work around...\n\t\telse\n\t\t\terror('The web server you are using is not correctly setting the REQUEST_URI variable. This usually means you are using IIS6, or an unpatched IIS7. Please either disable SEF URLs, upgrade to IIS7 and install any available patches or try a different web server.');\n\t}\n}\n// Set a cookie, PunBB style!\n// Like other headers, cookies must be sent before any output from your script.\n// Use headers_sent() to ckeck wether HTTP headers has been sent already.\nfunction forum_setcookie($name, $value, $expire)\n{\n\tglobal $cookie_path, $cookie_domain, $cookie_secure;\n\n\t$return = ($hook = get_hook('fn_forum_setcookie_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Enable sending of a P3P header\n\theader('P3P: CP=\"CUR ADM\"');\n\n\tif (version_compare(PHP_VERSION, '5.2.0', '>='))\n\t\tsetcookie($name, $value, $expire, $cookie_path, $cookie_domain, $cookie_secure, true);\n\telse\n\t\tsetcookie($name, $value, $expire, $cookie_path.'; HttpOnly', $cookie_domain, $cookie_secure);\n}\n\n\n// Attempts to fetch the provided URL using any available means\nfunction get_remote_file($url, $timeout, $head_only = false, $max_redirects = 10)\n{\n\t$result = null;\n\t$parsed_url = parse_url($url);\n\t$allow_url_fopen = strtolower(@ini_get('allow_url_fopen'));\n\n\t// Quite unlikely that this will be allowed on a shared host, but it can't hurt\n\tif (function_exists('ini_set'))\n\t\t@ini_set('default_socket_timeout', $timeout);\n\n\t// If we have cURL, we might as well use it\n\tif (function_exists('curl_init'))\n\t{\n\t\t// Setup the transfer\n\t\t$ch = curl_init();\n\t\tcurl_setopt($ch, CURLOPT_URL, $url);\n\t\tcurl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_0);\n\t\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n\t\tcurl_setopt($ch, CURLOPT_HEADER, true);\n\t\tcurl_setopt($ch, CURLOPT_NOBODY, $head_only);\n\t\tcurl_setopt($ch, CURLOPT_TIMEOUT, $timeout);\n\t\tcurl_setopt($ch, CURLOPT_USERAGENT, 'PunBB');\n\n\t\t// Grab the page\n\t\t$content = @curl_exec($ch);\n\t\t$responce_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);\n\t\tcurl_close($ch);\n\n\t\t// Process 301/302 redirect\n\t\tif ($content !== false && ($responce_code == '301' || $responce_code == '302') && $max_redirects > 0)\n\t\t{\n\t\t\t$headers = explode(\"\\r\\n\", trim($content));\n\t\t\tforeach ($headers as $header)\n\t\t\t\tif (substr($header, 0, 10) == 'Location: ')\n\t\t\t\t{\n\t\t\t\t\t$responce = get_remote_file(substr($header, 10), $timeout, $head_only, $max_redirects - 1);\n\t\t\t\t\tif ($responce !== null)\n\t\t\t\t\t\t$responce['headers'] = array_merge($headers, $responce['headers']);\n\t\t\t\t\treturn $responce;\n\t\t\t\t}\n\t\t}\n\n\t\t// Ignore everything except a 200 response code\n\t\tif ($content !== false && $responce_code == '200')\n\t\t{\n\t\t\tif ($head_only)\n\t\t\t\t$result['headers'] = explode(\"\\r\\n\", str_replace(\"\\r\\n\\r\\n\", \"\\r\\n\", trim($content)));\n\t\t\telse\n\t\t\t{\n\t\t\t\tpreg_match('#HTTP/1.[01] 200 OK#', $content, $match, PREG_OFFSET_CAPTURE);\n\t\t\t\t$last_content = substr($content, $match[0][1]);\n\t\t\t\t$content_start = strpos($last_content, \"\\r\\n\\r\\n\");\n\t\t\t\tif ($content_start !== false)\n\t\t\t\t{\n\t\t\t\t\t$result['headers'] = explode(\"\\r\\n\", str_replace(\"\\r\\n\\r\\n\", \"\\r\\n\", substr($content, 0, $match[0][1] + $content_start)));\n\t\t\t\t\t$result['content'] = substr($last_content, $content_start + 4);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// fsockopen() is the second best thing\n\telse if (function_exists('fsockopen'))\n\t{\n\t\t$remote = @fsockopen($parsed_url['host'], !empty($parsed_url['port']) ? intval($parsed_url['port']) : 80, $errno, $errstr, $timeout);\n\t\tif ($remote)\n\t\t{\n\t\t\t// Send a standard HTTP 1.0 request for the page\n\t\t\tfwrite($remote, ($head_only ? 'HEAD' : 'GET').' '.(!empty($parsed_url['path']) ? $parsed_url['path'] : '/').(!empty($parsed_url['query']) ? '?'.$parsed_url['query'] : '').' HTTP/1.0'.\"\\r\\n\");\n\t\t\tfwrite($remote, 'Host: '.$parsed_url['host'].\"\\r\\n\");\n\t\t\tfwrite($remote, 'User-Agent: PunBB'.\"\\r\\n\");\n\t\t\tfwrite($remote, 'Connection: Close'.\"\\r\\n\\r\\n\");\n\n\t\t\tstream_set_timeout($remote, $timeout);\n\t\t\t$stream_meta = stream_get_meta_data($remote);\n\n\t\t\t// Fetch the response 1024 bytes at a time and watch out for a timeout\n\t\t\t$content = false;\n\t\t\twhile (!feof($remote) && !$stream_meta['timed_out'])\n\t\t\t{\n\t\t\t\t$content .= fgets($remote, 1024);\n\t\t\t\t$stream_meta = stream_get_meta_data($remote);\n\t\t\t}\n\n\t\t\tfclose($remote);\n\n\t\t\t// Process 301/302 redirect\n\t\t\tif ($content !== false && $max_redirects > 0 && preg_match('#^HTTP/1.[01] 30[12]#', $content))\n\t\t\t{\n\t\t\t\t$headers = explode(\"\\r\\n\", trim($content));\n\t\t\t\tforeach ($headers as $header)\n\t\t\t\t\tif (substr($header, 0, 10) == 'Location: ')\n\t\t\t\t\t{\n\t\t\t\t\t\t$responce = get_remote_file(substr($header, 10), $timeout, $head_only, $max_redirects - 1);\n\t\t\t\t\t\tif ($responce !== null)\n\t\t\t\t\t\t\t$responce['headers'] = array_merge($headers, $responce['headers']);\n\t\t\t\t\t\treturn $responce;\n\t\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Ignore everything except a 200 response code\n\t\t\tif ($content !== false && preg_match('#^HTTP/1.[01] 200 OK#', $content))\n\t\t\t{\n\t\t\t\tif ($head_only)\n\t\t\t\t\t$result['headers'] = explode(\"\\r\\n\", trim($content));\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$content_start = strpos($content, \"\\r\\n\\r\\n\");\n\t\t\t\t\tif ($content_start !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$result['headers'] = explode(\"\\r\\n\", substr($content, 0, $content_start));\n\t\t\t\t\t\t$result['content'] = substr($content, $content_start + 4);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// Last case scenario, we use file_get_contents provided allow_url_fopen is enabled (any non 200 response results in a failure)\n\telse if (in_array($allow_url_fopen, array('on', 'true', '1')))\n\t{\n\t\t// PHP5's version of file_get_contents() supports stream options\n\t\tif (version_compare(PHP_VERSION, '5.0.0', '>='))\n\t\t{\n\t\t\t// Setup a stream context\n\t\t\t$stream_context = stream_context_create(\n\t\t\t\tarray(\n\t\t\t\t\t'http' => array(\n\t\t\t\t\t\t'method'\t\t=> $head_only ? 'HEAD' : 'GET',\n\t\t\t\t\t\t'user_agent'\t=> 'PunBB',\n\t\t\t\t\t\t'max_redirects'\t=> $max_redirects + 1,\t// PHP >=5.1.0 only\n\t\t\t\t\t\t'timeout'\t\t=> $timeout\t// PHP >=5.2.1 only\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\n\t\t\t$content = @file_get_contents($url, false, $stream_context);\n\t\t}\n\t\telse\n\t\t\t$content = @file_get_contents($url);\n\n\t\t// Did we get anything?\n\t\tif ($content !== false)\n\t\t{\n\t\t\t// Gotta love the fact that $http_response_header just appears in the global scope (*cough* hack! *cough*)\n\t\t\t$result['headers'] = $http_response_header;\n\t\t\tif (!$head_only)\n\t\t\t\t$result['content'] = $content;\n\t\t}\n\t}\n\n\treturn $result;\n}\n\n\n// Clean version string from trailing '.0's\nfunction clean_version($version)\n{\n\treturn preg_replace('/(\\.0)+(?!\\.)|(\\.0+$)/', '$2', $version);\n}\n\n\n// Dump contents of variable(s) for debug\nfunction forum_dump()\n{\n\techo '<pre>';\n\n\t$num_args = func_num_args();\n\n\tfor ($i = 0; $i < $num_args; ++$i)\n\t{\n\t\tprint_r(func_get_arg($i));\n\t\techo \"\\n\\n\";\n\t}\n\n\techo '</pre>';\n\texit;\n}\n\n\n//\n// Markup helpers\n//\n\n// A wrapper for PHP's number_format function\nfunction forum_number_format($number, $decimals = 0)\n{\n\tglobal $lang_common;\n\n\t$return = ($hook = get_hook('fn_forum_number_format_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn number_format($number, $decimals, $lang_common['lang_decimal_point'], $lang_common['lang_thousands_sep']);\n}\n\n\n// Format a time string according to $date_format, $time_format, and timezones\ndefine('FORUM_FT_DATETIME', 0);\ndefine('FORUM_FT_DATE', 1);\ndefine('FORUM_FT_TIME', 2);\nfunction format_time($timestamp, $type = FORUM_FT_DATETIME, $date_format = null, $time_format = null, $no_text = false)\n{\n\tglobal $forum_config, $lang_common, $forum_user, $forum_time_formats, $forum_date_formats;\n\n\t$return = ($hook = get_hook('fn_format_time_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($timestamp == '')\n\t\treturn ($no_text ? '' : $lang_common['Never']);\n\n\tif ($date_format == null)\n\t\t$date_format = $forum_date_formats[$forum_user['date_format']];\n\n\tif ($time_format == null)\n\t\t$time_format = $forum_time_formats[$forum_user['time_format']];\n\n\t$diff = ($forum_user['timezone'] + $forum_user['dst']) * 3600;\n\t$timestamp += $diff;\n\t$now = time();\n\n\t$formatted_time = '';\n\n\tif ($type == FORUM_FT_DATETIME || $type == FORUM_FT_DATE)\n\t{\n\t\t$formatted_time = gmdate($date_format, $timestamp);\n\n\t\tif (!$no_text)\n\t\t{\n\t\t\t$base = gmdate('Y-m-d', $timestamp);\n\t\t\t$today = gmdate('Y-m-d', $now + $diff);\n\t\t\t$yesterday = gmdate('Y-m-d', $now + $diff - 86400);\n\n\t\t\tif ($base == $today)\n\t\t\t\t$formatted_time = $lang_common['Today'];\n\t\t\telse if ($base == $yesterday)\n\t\t\t\t$formatted_time = $lang_common['Yesterday'];\n\t\t}\n\t}\n\n\tif ($type == FORUM_FT_DATETIME)\n\t\t$formatted_time .= ' ';\n\n\tif ($type == FORUM_FT_DATETIME || $type == FORUM_FT_TIME)\n\t\t$formatted_time .= gmdate($time_format, $timestamp);\n\n\t($hook = get_hook('fn_format_time_end')) ? eval($hook) : null;\n\n\treturn $formatted_time;\n}\n\n\n\n// Generate the \"navigator\" that appears at the top of every page\nfunction generate_navlinks()\n{\n\tglobal $forum_config, $lang_common, $forum_url, $forum_user;\n\n\t$return = ($hook = get_hook('fn_generate_navlinks_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// Index should always be displayed\n\t$links['index'] = '<li id=\"navindex\"'.((FORUM_PAGE == 'index') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['index']).'\">'.$lang_common['Index'].'</a></li>';\n\n\tif ($forum_user['g_read_board'] == '1' && $forum_user['g_view_users'] == '1')\n\t\t$links['userlist'] = '<li id=\"navuserlist\"'.((FORUM_PAGE == 'userlist') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['users']).'\">'.$lang_common['User list'].'</a></li>';\n\n\tif ($forum_config['o_rules'] == '1' && (!$forum_user['is_guest'] || $forum_user['g_read_board'] == '1' || $forum_config['o_regs_allow'] == '1'))\n\t\t$links['rules'] = '<li id=\"navrules\"'.((FORUM_PAGE == 'rules') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['rules']).'\">'.$lang_common['Rules'].'</a></li>';\n\n\tif ($forum_user['is_guest'])\n\t{\n\t\tif ($forum_user['g_read_board'] == '1' && $forum_user['g_search'] == '1')\n\t\t\t$links['search'] = '<li id=\"navsearch\"'.((FORUM_PAGE == 'search') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['search']).'\">'.$lang_common['Search'].'</a></li>';\n\n\t\t$links['register'] = '<li id=\"navregister\"'.((FORUM_PAGE == 'register') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['register']).'\">'.$lang_common['Register'].'</a></li>';\n\t\t$links['login'] = '<li id=\"navlogin\"'.((FORUM_PAGE == 'login') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['login']).'\">'.$lang_common['Login'].'</a></li>';\n\t}\n\telse\n\t{\n\t\tif (!$forum_user['is_admmod'])\n\t\t{\n\t\t\tif ($forum_user['g_read_board'] == '1' && $forum_user['g_search'] == '1')\n\t\t\t\t$links['search'] = '<li id=\"navsearch\"'.((FORUM_PAGE == 'search') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['search']).'\">'.$lang_common['Search'].'</a></li>';\n\n\t\t\t$links['profile'] = '<li id=\"navprofile\"'.((substr(FORUM_PAGE, 0, 7) == 'profile') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['user'], $forum_user['id']).'\">'.$lang_common['Profile'].'</a></li>';\n\t\t\t$links['logout'] = '<li id=\"navlogout\"><a href=\"'.forum_link($forum_url['logout'], array($forum_user['id'], generate_form_token('logout'.$forum_user['id']))).'\">'.$lang_common['Logout'].'</a></li>';\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$links['search'] = '<li id=\"navsearch\"'.((FORUM_PAGE == 'search') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['search']).'\">'.$lang_common['Search'].'</a></li>';\n\t\t\t$links['profile'] = '<li id=\"navprofile\"'.((substr(FORUM_PAGE, 0, 7) == 'profile') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['user'], $forum_user['id']).'\">'.$lang_common['Profile'].'</a></li>';\n\t\t\t$links['logout'] = '<li id=\"navlogout\"><a href=\"'.forum_link($forum_url['logout'], array($forum_user['id'], generate_form_token('logout'.$forum_user['id']))).'\">'.$lang_common['Logout'].'</a></li>';\n\t\t\t$links['admin'] = '<li id=\"navadmin\"'.((substr(FORUM_PAGE, 0, 5) == 'admin') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['admin_index']).'\">'.$lang_common['Admin'].'</a></li>';\n\t\t}\n\t}\n\n\t// Are there any additional navlinks we should insert into the array before imploding it?\n\tif ($forum_config['o_additional_navlinks'] != '' && preg_match_all('#([0-9]+)\\s*=\\s*(.*?)\\n#s', $forum_config['o_additional_navlinks'].\"\\n\", $extra_links))\n\t{\n\t\t// Insert any additional links into the $links array (at the correct index)\n\t\t$num_links = count($extra_links[1]);\n\t\tfor ($i = 0; $i < $num_links; ++$i)\n\t\t\tarray_insert($links, (int)$extra_links[1][$i], '<li id=\"navextra'.($i + 1).'\">'.$extra_links[2][$i].'</li>');\n\t}\n\n\t($hook = get_hook('fn_generate_navlinks_end')) ? eval($hook) : null;\n\n\treturn implode(\"\\n\\t\\t\", $links);\n}\n\n\n// Outputs markup to display a user's avatar\nfunction generate_avatar_markup($user_id)\n{\n\tglobal $forum_config, $base_url;\n\n\t$filetypes = array('jpg', 'gif', 'png');\n\t$avatar_markup = '';\n\n\t$return = ($hook = get_hook('fn_generate_avatar_markup_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tforeach ($filetypes as $cur_type)\n\t{\n\t\t$path = $forum_config['o_avatars_dir'].'/'.$user_id.'.'.$cur_type;\n\n\t\tif (file_exists(FORUM_ROOT.$path) && $img_size = @getimagesize(FORUM_ROOT.$path))\n\t\t{\n\t\t\t$avatar_markup = '<img src=\"'.$base_url.'/'.$path.'\" '.$img_size[3].' alt=\"\" />';\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_generate_avatar_markup_end')) ? eval($hook) : null;\n\n\treturn $avatar_markup;\n}\n\n\n// Generate breadcrumb navigation\nfunction generate_crumbs($reverse)\n{\n\tglobal $lang_common, $forum_url, $forum_config, $forum_page;\n\n\t$return = ($hook = get_hook('fn_generate_crumbs_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif (empty($forum_page['crumbs']))\n\t\t$forum_page['crumbs'][0] = $forum_config['o_board_title'];\n\n\t$crumbs = '';\n\t$num_crumbs = count($forum_page['crumbs']);\n\n\tif ($reverse)\n\t{\n\t\tfor ($i = ($num_crumbs - 1); $i >= 0; --$i)\n\t\t\t$crumbs .= (is_array($forum_page['crumbs'][$i]) ? forum_htmlencode($forum_page['crumbs'][$i][0]) : forum_htmlencode($forum_page['crumbs'][$i])).((isset($forum_page['page']) && $i == ($num_crumbs - 1)) ? ' ('.$lang_common['Page'].' '.forum_number_format($forum_page['page']).')' : '').($i > 0 ? $lang_common['Title separator'] : '');\n\t}\n\telse\n\t\tfor ($i = 0; $i < $num_crumbs; ++$i)\n\t\t{\n\t\t\tif ($i < ($num_crumbs - 1))\n\t\t\t\t$crumbs .= '<span class=\"crumb'.(($i == 0) ? ' crumbfirst' : '').'\">'.(($i >= 1) ? '<span>'.$lang_common['Crumb separator'].'</span>' : '').(is_array($forum_page['crumbs'][$i]) ? '<a href=\"'.$forum_page['crumbs'][$i][1].'\">'.forum_htmlencode($forum_page['crumbs'][$i][0]).'</a>' : forum_htmlencode($forum_page['crumbs'][$i])).'</span> ';\n\t\t\telse\n\t\t\t\t$crumbs .= '<span class=\"crumb crumblast'.(($i == 0) ? ' crumbfirst' : '').'\">'.(($i >= 1) ? '<span>'.$lang_common['Crumb separator'].'</span>' : '').(is_array($forum_page['crumbs'][$i]) ? '<a href=\"'.$forum_page['crumbs'][$i][1].'\">'.forum_htmlencode($forum_page['crumbs'][$i][0]).'</a>' : forum_htmlencode($forum_page['crumbs'][$i])).'</span> ';\n\t\t}\n\n\t($hook = get_hook('fn_generate_crumbs_end')) ? eval($hook) : null;\n\n\treturn $crumbs;\n}\n\n\n\n// Generate a string with page and item information for multipage headings\nfunction generate_items_info($label, $first, $total)\n{\n\tglobal $forum_page, $lang_common;\n\n\t$return = ($hook = get_hook('fn_generate_page_info_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($forum_page['num_pages'] == 1)\n\t\t$item_info =  '<span class=\"item-info\">'.sprintf($lang_common['Item info single'], $label, forum_number_format($total)).'</span>';\n\telse\n\t\t$item_info = '<span class=\"item-info\">'.sprintf($lang_common['Item info plural'], $label, forum_number_format($first), forum_number_format($forum_page['finish_at']), forum_number_format($total)).'</span>';\n\n\t($hook = get_hook('fn_generate_page_info_end')) ? eval($hook) : null;\n\n\treturn $item_info;\n}\n\n\n// Generate a string with numbered links (for multipage scripts)\nfunction paginate($num_pages, $cur_page, $link, $separator, $args = null, $is_default_scheme = null)\n{\n\tglobal $forum_url, $lang_common;\n\n\tif ($is_default_scheme == null)\n\t\t$forum_url_page = $forum_url['page'];\n\telse\n\t{\n\t\t$forum_url_page = '&amp;p=$1';\n\t\tunset($forum_url['insertion_find']);\n\t}\n\n\t$pages = array();\n\t$link_to_all = false;\n\n\t$return = ($hook = get_hook('fn_paginate_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// If $cur_page == -1, we link to all pages (used in viewforum.php)\n\tif ($cur_page == -1)\n\t{\n\t\t$cur_page = 1;\n\t\t$link_to_all = true;\n\t}\n\n\tif ($num_pages <= 1)\n\t\t$pages = array('<strong class=\"first-item\">'.forum_number_format(1).'</strong>');\n\telse\n\t{\n\t\t// Add a previous page link\n\t\tif ($num_pages > 1 && $cur_page > 1)\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\"' : '').' href=\"'.forum_sublink($link, $forum_url_page, ($cur_page - 1), $args).'\">'.$lang_common['Previous'].'</a>';\n\n\t\tif ($cur_page > 3)\n\t\t{\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\"' : '').' href=\"'.forum_sublink($link, $forum_url_page, 1, $args).'\">'.forum_number_format(1).'</a>';\n\n\t\t\tif ($cur_page > 5)\n\t\t\t\t$pages[] = '<span>'.$lang_common['Spacer'].'</span>';\n\t\t}\n\n\t\t// Don't ask me how the following works. It just does, OK? :-)\n\t\tfor ($current = ($cur_page == 5) ? $cur_page - 3 : $cur_page - 2, $stop = ($cur_page + 4 == $num_pages) ? $cur_page + 4 : $cur_page + 3; $current < $stop; ++$current)\n\t\t\tif ($current < 1 || $current > $num_pages)\n\t\t\t\tcontinue;\n\t\t\telse if ($current != $cur_page || $link_to_all)\n\t\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\" ' : '').' href=\"'.forum_sublink($link, $forum_url_page, $current, $args).'\">'.forum_number_format($current).'</a>';\n\t\t\telse\n\t\t\t\t$pages[] = '<strong'.(empty($pages) ? ' class=\"first-item\"' : '').'>'.forum_number_format($current).'</strong>';\n\n\t\tif ($cur_page <= ($num_pages-3))\n\t\t{\n\t\t\tif ($cur_page != ($num_pages-3) && $cur_page != ($num_pages-4))\n\t\t\t\t$pages[] = '<span>'.$lang_common['Spacer'].'</span>';\n\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\" ' : '').' href=\"'.forum_sublink($link, $forum_url_page, $num_pages, $args).'\">'.forum_number_format($num_pages).'</a>';\n\t\t}\n\n\t\t// Add a next page link\n\t\tif ($num_pages > 1 && !$link_to_all && $cur_page < $num_pages)\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\" ' : '').' href=\"'.forum_sublink($link, $forum_url_page, ($cur_page + 1), $args).'\">'.$lang_common['Next'].'</a>';\n\t}\n\n\t($hook = get_hook('fn_paginate_end')) ? eval($hook) : null;\n\n\treturn implode($separator, $pages);\n}\n\n\n// Display executed queries (if enabled) for debug\nfunction get_saved_queries()\n{\n\tglobal $forum_db, $lang_common;\n\n\t// Get the queries so that we can print them out\n\t$saved_queries = $forum_db->get_saved_queries();\n\n\tob_start();\n\n?>\n<div id=\"brd-debug\" class=\"main\">\n\n\t<div class=\"main-head\">\n\t\t<h2 class=\"hn\"><span><?php echo $lang_common['Debug table'] ?></span></h2>\n\t</div>\n\n\t<div class=\"main-content debug\">\n\t\t<table cellspacing=\"0\" summary=\"<?php echo $lang_common['Debug summary'] ?>\">\n\t\t\t<thead>\n\t\t\t\t<tr>\n\t\t\t\t\t<th class=\"tcl\" scope=\"col\"><?php echo $lang_common['Query times'] ?></th>\n\t\t\t\t\t<th class=\"tcr\" scope=\"col\"><?php echo $lang_common['Query'] ?></th>\n\t\t\t\t</tr>\n\t\t\t</thead>\n\t\t\t<tbody>\n<?php\n\n\t$query_time_total = 0.0;\n\tforeach ($saved_queries as $cur_query)\n\t{\n\t\t$query_time_total += $cur_query[1];\n\n?>\n\t\t\t\t<tr>\n\t\t\t\t\t<td class=\"tcl\"><?php echo (($cur_query[1] != 0) ? forum_number_format($cur_query[1], 5) : '&#160;') ?></td>\n\t\t\t\t\t<td class=\"tcr\"><?php echo forum_htmlencode($cur_query[0]) ?></td>\n\t\t\t\t</tr>\n<?php\n\n\t}\n\n?>\n\t\t\t\t<tr class=\"totals\">\n\t\t\t\t\t<td class=\"tcl\"><em><?php echo forum_number_format($query_time_total, 5) ?></em></td>\n\t\t\t\t\t<td class=\"tcr\"><em><?php echo $lang_common['Total query time'] ?></em></td>\n\t\t\t\t</tr>\n\t\t\t</tbody>\n\t\t</table>\n\t</div>\n</div>\n<?php\n\n\treturn ob_get_clean();\n}\n\n\n//\n// Other special helpers\n//\n\n// Return all code blocks that hook into $hook_id\nfunction get_hook($hook_id)\n{\n\tglobal $forum_hooks;\n\n\treturn !defined('FORUM_DISABLE_HOOKS') && isset($forum_hooks[$hook_id]) ? implode(\"\\n\", $forum_hooks[$hook_id]) : false;\n}\n\n// Generate a hyperlink with parameters and anchor\nfunction forum_link($link, $args = null)\n{\n\tglobal $forum_config, $base_url;\n\n\t$return = ($hook = get_hook('fn_forum_link_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$gen_link = $link;\n\tif ($args == null)\n\t\t$gen_link = $base_url.'/'.$link;\n\telse if (!is_array($args))\n\t\t$gen_link = $base_url.'/'.str_replace('$1', $args, $link);\n\telse\n\t{\n\t\tfor ($i = 0; isset($args[$i]); ++$i)\n\t\t\t$gen_link = str_replace('$'.($i + 1), $args[$i], $gen_link);\n\t\t$gen_link = $base_url.'/'.$gen_link;\n\t}\n\n\t($hook = get_hook('fn_forum_link_end')) ? eval($hook) : null;\n\n\treturn $gen_link;\n}\n\n\n// Generate a hyperlink with parameters and anchor and a subsection such as a subpage\nfunction forum_sublink($link, $sublink, $subarg, $args = null)\n{\n\tglobal $forum_config, $forum_url, $base_url;\n\n\t$return = ($hook = get_hook('fn_forum_sublink_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($sublink == $forum_url['page'] && $subarg == 1)\n\t\treturn forum_link($link, $args);\n\n\t$gen_link = $link;\n\tif (!is_array($args) && $args != null)\n\t\t$gen_link = str_replace('$1', $args, $link);\n\telse\n\t{\n\t\tfor ($i = 0; isset($args[$i]); ++$i)\n\t\t\t$gen_link = str_replace('$'.($i + 1), $args[$i], $gen_link);\n\t}\n\n\tif (isset($forum_url['insertion_find']))\n\t\t$gen_link = $base_url.'/'.str_replace($forum_url['insertion_find'], str_replace('$1', str_replace('$1', $subarg, $sublink), $forum_url['insertion_replace']), $gen_link);\n\telse\n\t\t$gen_link = $base_url.'/'.$gen_link.str_replace('$1', $subarg, $sublink);\n\n\t($hook = get_hook('fn_forum_sublink_end')) ? eval($hook) : null;\n\n\treturn $gen_link;\n}\n// Make a string safe to use in a URL\nfunction sef_friendly($str)\n{\n\tglobal $forum_config, $forum_user;\n\tstatic $lang_url_replace, $forum_reserved_strings;\n\n\tif (!isset($lang_url_replace))\n\t\trequire FORUM_ROOT.'lang/'.$forum_user['language'].'/url_replace.php';\n\n\tif (!isset($forum_reserved_strings))\n\t{\n\t\t// Bring in any reserved strings\n\t\tif (file_exists(FORUM_ROOT.'include/url/'.$forum_config['o_sef'].'/reserved_strings.php'))\n\t\t\trequire FORUM_ROOT.'include/url/'.$forum_config['o_sef'].'/reserved_strings.php';\n\t\telse\n\t\t\trequire FORUM_ROOT.'include/url/Default/reserved_strings.php';\n\t}\n\n\t$return = ($hook = get_hook('fn_sef_friendly_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$str = strtr($str, $lang_url_replace);\n\t$str = strtolower(utf8_decode($str));\n\t$str = forum_trim(preg_replace(array('/[^a-z0-9\\s]/', '/[\\s]+/'), array('', '-'), $str), '-');\n\n\tforeach ($forum_reserved_strings as $match => $replace)\n\t\tif ($str == $match)\n\t\t\treturn $replace;\n\t\telse if ($match != '')\n\t\t\t$str = str_replace($match, $replace, $str);\n\n\treturn $str;\n}\n\n\n// Replace censored words in $text\nfunction censor_words($text)\n{\n\tglobal $forum_db;\n\tstatic $search_for, $replace_with;\n\n\t$return = ($hook = get_hook('fn_censor_words_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// If not already loaded in a previous call, load the cached censors\n\tif (!defined('FORUM_CENSORS_LOADED'))\n\t{\n\t\tif (file_exists(FORUM_CACHE_DIR.'cache_censors.php'))\n\t\t\tinclude FORUM_CACHE_DIR.'cache_censors.php';\n\n\t\tif (!defined('FORUM_CENSORS_LOADED'))\n\t\t{\n\t\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\t\tgenerate_censors_cache();\n\t\t\trequire FORUM_CACHE_DIR.'cache_censors.php';\n\t\t}\n\n\t\t$search_for = array();\n\t\t$replace_with = array();\n\n\t\tforeach ($forum_censors as $censor_key => $cur_word)\n\t\t{\n\t\t\t$search_for[$censor_key] = '/(?<=\\W)('.str_replace('\\*', '\\w*?', preg_quote($cur_word['search_for'], '/')).')(?=\\W)/iu';\n\t\t\t$replace_with[$censor_key] = $cur_word['replace_with'];\n\n\t\t\t($hook = get_hook('fn_censor_words_setup_regex')) ? eval($hook) : null;\n\t\t}\n\t}\n\n\tif (!empty($search_for))\n\t\t$text = utf8_substr(preg_replace($search_for, $replace_with, ' '.$text.' '), 1, -1);\n\n\treturn $text;\n}\n\n\n// Verifies that the provided username is OK for insertion into the database\nfunction validate_username($username, $exclude_id = null)\n{\n\tglobal $lang_common, $lang_register, $lang_profile, $forum_config;\n\n\t$errors = array();\n\n\t$return = ($hook = get_hook('fn_validate_username_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// Convert multiple whitespace characters into one (to prevent people from registering with indistinguishable usernames)\n\t$username = preg_replace('#\\s+#s', ' ', $username);\n\n\t// Validate username\n\tif (utf8_strlen($username) < 2)\n\t\t$errors[] = $lang_profile['Username too short'];\n\telse if (utf8_strlen($username) > 25)\n\t\t$errors[] = $lang_profile['Username too long'];\n\telse if (strtolower($username) == 'guest' || utf8_strtolower($username) == utf8_strtolower($lang_common['Guest']))\n\t\t$errors[] = $lang_profile['Username guest'];\n\telse if (preg_match('/[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}/', $username) || preg_match('/((([0-9A-Fa-f]{1,4}:){7}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}:[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){5}:([0-9A-Fa-f]{1,4}:)?[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){4}:([0-9A-Fa-f]{1,4}:){0,2}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){3}:([0-9A-Fa-f]{1,4}:){0,3}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){2}:([0-9A-Fa-f]{1,4}:){0,4}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}((\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b)\\.){3}(\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b))|(([0-9A-Fa-f]{1,4}:){0,5}:((\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b)\\.){3}(\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b))|(::([0-9A-Fa-f]{1,4}:){0,5}((\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b)\\.){3}(\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b))|([0-9A-Fa-f]{1,4}::([0-9A-Fa-f]{1,4}:){0,5}[0-9A-Fa-f]{1,4})|(::([0-9A-Fa-f]{1,4}:){0,6}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){1,7}:))/', $username))\n\t\t$errors[] = $lang_profile['Username IP'];\n\telse if ((strpos($username, '[') !== false || strpos($username, ']') !== false) && strpos($username, '\\'') !== false && strpos($username, '\"') !== false)\n\t\t$errors[] = $lang_profile['Username reserved chars'];\n\telse if (preg_match('/(?:\\[\\/?(?:b|u|i|h|colou?r|quote|code|img|url|email|list)\\]|\\[(?:code|quote|list)=)/i', $username))\n\t\t$errors[] = $lang_profile['Username BBCode'];\n\n\t// Check username for any censored words\n\tif ($forum_config['o_censoring'] == '1' && censor_words($username) != $username)\n\t\t$errors[] = $lang_profile['Username censor'];\n\n\t// Check for username dupe\n\t$dupe = check_username_dupe($username, $exclude_id);\n\tif ($dupe !== false)\n\t\t$errors[] = sprintf($lang_profile['Username dupe'], forum_htmlencode($dupe));\n\n\t($hook = get_hook('fn_validate_username_end')) ? eval($hook) : null;\n\n\treturn $errors;\n}\n\n\n\n\n// Determines the correct title for $user\n// $user must contain the elements 'username', 'title', 'posts', 'g_id' and 'g_user_title'\nfunction get_title($user)\n{\n\tglobal $forum_db, $forum_config, $forum_bans, $lang_common;\n\tstatic $ban_list, $forum_ranks;\n\n\t$return = ($hook = get_hook('fn_get_title_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// If not already built in a previous call, build an array of lowercase banned usernames\n\tif (empty($ban_list))\n\t{\n\t\t$ban_list = array();\n\n\t\tforeach ($forum_bans as $cur_ban)\n\t\t\t$ban_list[] = utf8_strtolower($cur_ban['username']);\n\t}\n\n\t// If not already loaded in a previous call, load the cached ranks\n\tif ($forum_config['o_ranks'] == '1' && !defined('FORUM_RANKS_LOADED'))\n\t{\n\t\tif (file_exists(FORUM_CACHE_DIR.'cache_ranks.php'))\n\t\t\tinclude FORUM_CACHE_DIR.'cache_ranks.php';\n\n\t\tif (!defined('FORUM_RANKS_LOADED'))\n\t\t{\n\t\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\t\tgenerate_ranks_cache();\n\t\t\trequire FORUM_CACHE_DIR.'cache_ranks.php';\n\t\t}\n\t}\n\n\t// If the user has a custom title\n\tif ($user['title'] != '')\n\t\t$user_title = forum_htmlencode($forum_config['o_censoring'] == '1' ? censor_words($user['title']) : $user['title']);\n\t// If the user is banned\n\telse if (in_array(utf8_strtolower($user['username']), $ban_list))\n\t\t$user_title = $lang_common['Banned'];\n\t// If the user group has a default user title\n\telse if ($user['g_user_title'] != '')\n\t\t$user_title = forum_htmlencode($user['g_user_title']);\n\t// If the user is a guest\n\telse if ($user['g_id'] == FORUM_GUEST)\n\t\t$user_title = $lang_common['Guest'];\n\telse\n\t{\n\t\t// Are there any ranks?\n\t\tif ($forum_config['o_ranks'] == '1' && !empty($forum_ranks))\n\t\t\tforeach ($forum_ranks as $cur_rank)\n\t\t\t\tif (intval($user['num_posts']) >= $cur_rank['min_posts'])\n\t\t\t\t\t$user_title = forum_htmlencode($cur_rank['rank']);\n\n\t\t// If the user didn't \"reach\" any rank (or if ranks are disabled), we assign the default\n\t\tif (!isset($user_title))\n\t\t\t$user_title = $lang_common['Member'];\n\t}\n\n\t($hook = get_hook('fn_get_title_end')) ? eval($hook) : null;\n\n\treturn $user_title;\n}\n\n\n// Return a list of all URL schemes installed\nfunction get_scheme_packs()\n{\n  \t$schemes = array();\n\n\tif($handle = opendir(FORUM_ROOT.'include/url'))\n\t{\n\t\twhile (false !== ($dirname = readdir($handle)))\n\t\t{\n\t\t\t$dirname =  FORUM_ROOT.'include/url/'.$dirname;\n\t\t\tif (is_dir($dirname) && file_exists($dirname.'/forum_urls.php'))\n\t\t\t\t$schemes[] = basename($dirname);\n\t\t}\n\t\tclosedir($handle);\n\t}\n\n\t($hook = get_hook('fn_get_scheme_packs_end')) ? eval($hook) : null;\n\n\treturn $schemes;\n}\n\n\n// Return a list of all styles installed\nfunction get_style_packs()\n{\n\t$styles = array();\n\n\tif($handle = opendir(FORUM_ROOT.'style'))\n\t{\n\t\twhile (false !== ($dirname = readdir($handle)))\n\t\t{\n\t\t\t$dirname =  FORUM_ROOT.'style/'.$dirname;\n\t\t\t$tempname = basename($dirname);\n\t\t\tif (is_dir($dirname) && file_exists($dirname.'/'.$tempname.'.php'))\n\t\t\t\t$styles[] = $tempname;\n\t\t}\n\t\tclosedir($handle);\n\t}\n\n\t($hook = get_hook('fn_get_style_packs_end')) ? eval($hook) : null;\n\n\treturn $styles;\n}\n\n\n// Return a list of all language packs installed\nfunction get_language_packs()\n{\n\t$languages = array();\n\n\tif($handle = opendir(FORUM_ROOT.'lang'))\n\t{\n\t\twhile (false !== ($dirname = readdir($handle)))\n\t\t{\n\t\t\t$dirname =  FORUM_ROOT.'lang/'.$dirname;\n\t\t\tif (is_dir($dirname) && file_exists($dirname.'/common.php'))\n\t\t\t\t$languages[] = basename($dirname);\n\t\t}\n\t\tclosedir($handle);\n\t}\n\n\t($hook = get_hook('fn_get_language_packs_end')) ? eval($hook) : null;\n\n\treturn $languages;\n}\n\n\n// Try to determine the correct remote IP-address\nfunction get_remote_address()\n{\n\t$return = ($hook = get_hook('fn_get_remote_address_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn $_SERVER['REMOTE_ADDR'];\n}\n\n\n// Try to determine the current URL\nfunction get_current_url($max_length = 0)\n{\n\t$return = ($hook = get_hook('fn_get_current_url_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$protocol = (!isset($_SERVER['HTTPS']) || strtolower($_SERVER['HTTPS']) == 'off') ? 'http://' : 'https://';\n\t$port = (isset($_SERVER['SERVER_PORT']) && (($_SERVER['SERVER_PORT'] != '80' && $protocol == 'http://') || ($_SERVER['SERVER_PORT'] != '443' && $protocol == 'https://')) && strpos($_SERVER['HTTP_HOST'], ':') === false) ? ':'.$_SERVER['SERVER_PORT'] : '';\n\n\t$url = $protocol.$_SERVER['HTTP_HOST'].$port.$_SERVER['REQUEST_URI'];\n\n\tif (strlen($url) <= $max_length || $max_length == 0)\n\t\treturn $url;\n\n\t// We can't find a short enough url\n\treturn null;\n}\n// Checks if a word is a valid searchable word\nfunction validate_search_word($word)\n{\n\tglobal $forum_user;\n\tstatic $stopwords;\n\n\t$return = ($hook = get_hook('fn_validate_search_word_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif (!isset($stopwords))\n\t{\n\t\tif (file_exists(FORUM_ROOT.'lang/'.$forum_user['language'].'/stopwords.txt'))\n\t\t{\n\t\t\t$stopwords = file(FORUM_ROOT.'lang/'.$forum_user['language'].'/stopwords.txt');\n\t\t\t$stopwords = array_map('forum_trim', $stopwords);\n\t\t\t$stopwords = array_filter($stopwords);\n\t\t}\n\t\telse\n\t\t\t$stopwords = array();\n\n\t\t($hook = get_hook('fn_validate_search_word_modify_stopwords')) ? eval($hook) : null;\n\t}\n\n\t$num_chars = utf8_strlen($word);\n\n\t$return = ($hook = get_hook('fn_validate_search_word_end')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn $num_chars >= FORUM_SEARCH_MIN_WORD && $num_chars <= FORUM_SEARCH_MAX_WORD && !in_array($word, $stopwords);\n}\n\n\n// Generate a random key of length $len\nfunction random_key($len, $readable = false, $hash = false)\n{\n\t$key = '';\n\n\t$return = ($hook = get_hook('fn_random_key_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($hash)\n\t\t$key = substr(sha1(uniqid(rand(), true)), 0, $len);\n\telse if ($readable)\n\t{\n\t\t$chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n\n\t\tfor ($i = 0; $i < $len; ++$i)\n\t\t\t$key .= substr($chars, (mt_rand() % strlen($chars)), 1);\n\t}\n\telse\n\t\tfor ($i = 0; $i < $len; ++$i)\n\t\t\t$key .= chr(mt_rand(33, 126));\n\n\t($hook = get_hook('fn_random_key_end')) ? eval($hook) : null;\n\n\treturn $key;\n}\n\n\n// Generates a valid CSRF token for use when submitting a form to $target_url\n// $target_url should be an absolute URL and it should be exactly the URL that the user is going to\n// Alternately, if the form token is going to be used in GET (which would mean the token is going to be\n// a part of the URL itself), $target_url may be a plain string containing information related to the URL.\nfunction generate_form_token($target_url)\n{\n\tglobal $forum_user;\n\n\t$return = ($hook = get_hook('fn_generate_form_token_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn sha1(str_replace('&amp;', '&', $target_url).$forum_user['csrf_token']);\n}\n\n\n// Generates a salted, SHA-1 hash of $str\nfunction forum_hash($str, $salt)\n{\n\t$return = ($hook = get_hook('fn_forum_hash_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn sha1($salt.sha1($str));\n}\n// Delete every .php file in the forum's cache directory\nfunction forum_clear_cache()\n{\n\t$return = ($hook = get_hook('fn_forum_clear_cache_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t$d = dir(FORUM_CACHE_DIR);\n\twhile (($entry = $d->read()) !== false)\n\t{\n\t\tif (substr($entry, strlen($entry)-4) == '.php')\n\t\t\t@unlink(FORUM_CACHE_DIR.$entry);\n\t}\n\t$d->close();\n}\n\n\n//\n// General forum specific functions\n//\n\n// Authenticates the provided username and password against the user database\n// $user can be either a user ID (integer) or a username (string)\n// $password can be either a plaintext password or a password hash including salt ($password_is_hash must be set accordingly)\nfunction authenticate_user($user, $password, $password_is_hash = false)\n{\n\tglobal $forum_db, $forum_user;\n\n\t$return = ($hook = get_hook('fn_authenticate_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Check if there's a user matching $user and $password\n\t$query = array(\n\t\t'SELECT'\t=> 'u.*, g.*, o.logged, o.idle, o.csrf_token, o.prev_url',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'online AS o',\n\t\t\t\t'ON'\t\t\t=> 'o.user_id=u.id'\n\t\t\t)\n\t\t)\n\t);\n\n\t// Are we looking for a user ID or a username?\n\t$query['WHERE'] = is_int($user) ? 'u.id='.intval($user) : 'u.username=\\''.$forum_db->escape($user).'\\'';\n\n\t($hook = get_hook('fn_authenticate_user_qr_get_user')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$forum_user = $forum_db->fetch_assoc($result);\n\n\tif (!isset($forum_user['id']) ||\n\t\t($password_is_hash && $password != $forum_user['password']) ||\n\t\t(!$password_is_hash && forum_hash($password, $forum_user['salt']) != $forum_user['password']))\n\t\tset_default_user();\n\n\t($hook = get_hook('fn_authenticate_user_end')) ? eval($hook) : null;\n}\n\n\n// Attempt to login with the user ID and password hash from the cookie\nfunction cookie_login(&$forum_user)\n{\n\tglobal $forum_db, $db_type, $forum_config, $cookie_name, $cookie_path, $cookie_domain, $cookie_secure, $forum_time_formats, $forum_date_formats;\n\n\t$now = time();\n\t$expire = $now + 1209600;\t// The cookie expires after 14 days\n\n\t// We assume it's a guest\n\t$cookie = array('user_id' => 1, 'password_hash' => 'Guest', 'expiration_time' => 0, 'expire_hash' => 'Guest');\n\n\t$return = ($hook = get_hook('fn_cookie_login_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// If a cookie is set, we get the user_id and password hash from it\n\tif (!empty($_COOKIE[$cookie_name]))\n\t{\n\t\t$cookie_data = explode('|', base64_decode($_COOKIE[$cookie_name]));\n\n\t\tif (!empty($cookie_data) && count($cookie_data) == 4)\n\t\t\tlist($cookie['user_id'], $cookie['password_hash'], $cookie['expiration_time'], $cookie['expire_hash']) = $cookie_data;\n\t}\n\n\t($hook = get_hook('fn_cookie_login_fetch_cookie')) ? eval($hook) : null;\n\n\t// If this a cookie for a logged in user and it shouldn't have already expired\n\tif (intval($cookie['user_id']) > 1 && intval($cookie['expiration_time']) > $now)\n\t{\n\t\tauthenticate_user(intval($cookie['user_id']), $cookie['password_hash'], true);\n\n\t\t// We now validate the cookie hash\n\t\tif ($cookie['expire_hash'] !== sha1($forum_user['salt'].$forum_user['password'].forum_hash(intval($cookie['expiration_time']), $forum_user['salt'])))\n\t\t\tset_default_user();\n\n\t\t// If we got back the default user, the login failed\n\t\tif ($forum_user['id'] == '1')\n\t\t{\n\t\t\tforum_setcookie($cookie_name, base64_encode('1|'.random_key(8, false, true).'|'.$expire.'|'.random_key(8, false, true)), $expire);\n\t\t\treturn;\n\t\t}\n\n\t\t// Send a new, updated cookie with a new expiration timestamp\n\t\t$expire = (intval($cookie['expiration_time']) > $now + $forum_config['o_timeout_visit']) ? $now + 1209600 : $now + $forum_config['o_timeout_visit'];\n\t\tforum_setcookie($cookie_name, base64_encode($forum_user['id'].'|'.$forum_user['password'].'|'.$expire.'|'.sha1($forum_user['salt'].$forum_user['password'].forum_hash($expire, $forum_user['salt']))), $expire);\n\n\t\t// Set a default language if the user selected language no longer exists\n\t\tif (!file_exists(FORUM_ROOT.'lang/'.$forum_user['language'].'/common.php'))\n\t\t\t$forum_user['language'] = $forum_config['o_default_lang'];\n\n\t\t// Set a default style if the user selected style no longer exists\n\t\tif (!file_exists(FORUM_ROOT.'style/'.$forum_user['style'].'/'.$forum_user['style'].'.php'))\n\t\t\t$forum_user['style'] = $forum_config['o_default_style'];\n\n\t\tif (!$forum_user['disp_topics'])\n\t\t\t$forum_user['disp_topics'] = $forum_config['o_disp_topics_default'];\n\t\tif (!$forum_user['disp_posts'])\n\t\t\t$forum_user['disp_posts'] = $forum_config['o_disp_posts_default'];\n\n\t\t// Check user has a valid date and time format\n\t\tif (!isset($forum_time_formats[$forum_user['time_format']]))\n\t\t\t$forum_user['time_format'] = 0;\n\t\tif (!isset($forum_date_formats[$forum_user['date_format']]))\n\t\t\t$forum_user['date_format'] = 0;\n\n\t\t// Define this if you want this visit to affect the online list and the users last visit data\n\t\tif (!defined('FORUM_QUIET_VISIT'))\n\t\t{\n\t\t\t// Update the online list\n\t\t\tif (!$forum_user['logged'])\n\t\t\t{\n\t\t\t\t$forum_user['logged'] = $now;\n\t\t\t\t$forum_user['csrf_token'] = random_key(40, false, true);\n\t\t\t\t$forum_user['prev_url'] = get_current_url(255);\n\n\t\t\t\t// REPLACE INTO avoids a user having two rows in the online table\n\t\t\t\t$query = array(\n\t\t\t\t\t'REPLACE'\t=> 'user_id, ident, logged, csrf_token',\n\t\t\t\t\t'INTO'\t\t=> 'online',\n\t\t\t\t\t'VALUES'\t=> $forum_user['id'].', \\''.$forum_db->escape($forum_user['username']).'\\', '.$forum_user['logged'].', \\''.$forum_user['csrf_token'].'\\'',\n\t\t\t\t\t'UNIQUE'\t=> 'user_id='.$forum_user['id']\n\t\t\t\t);\n\n\t\t\t\tif ($forum_user['prev_url'] != null)\n\t\t\t\t{\n\t\t\t\t\t$query['REPLACE'] .= ', prev_url';\n\t\t\t\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($forum_user['prev_url']).'\\'';\n\t\t\t\t}\n\n\t\t\t\t($hook = get_hook('fn_cookie_login_qr_add_online_user')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t// Reset tracked topics\n\t\t\t\tset_tracked_topics(null);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// Special case: We've timed out, but no other user has browsed the forums since we timed out\n\t\t\t\tif ($forum_user['logged'] < ($now-$forum_config['o_timeout_visit']))\n\t\t\t\t{\n\t\t\t\t\t$query = array(\n\t\t\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t\t\t'SET'\t\t=> 'last_visit='.$forum_user['logged'],\n\t\t\t\t\t\t'WHERE'\t\t=> 'id='.$forum_user['id']\n\t\t\t\t\t);\n\n\t\t\t\t\t($hook = get_hook('fn_cookie_login_qr_update_user_visit')) ? eval($hook) : null;\n\t\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t\t$forum_user['last_visit'] = $forum_user['logged'];\n\t\t\t\t}\n\n\t\t\t\t// Now update the logged time and save the current URL in the online list\n\t\t\t\t$query = array(\n\t\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t\t'SET'\t\t=> 'logged='.$now,\n\t\t\t\t\t'WHERE'\t\t=> 'user_id='.$forum_user['id']\n\t\t\t\t);\n\n\t\t\t\t$current_url = get_current_url(255);\n\t\t\t\tif ($current_url != null)\n\t\t\t\t\t$query['SET'] .= ', prev_url=\\''.$forum_db->escape($current_url).'\\'';\n\n\t\t\t\tif ($forum_user['idle'] == '1')\n\t\t\t\t\t$query['SET'] .= ', idle=0';\n\n\t\t\t\t($hook = get_hook('fn_cookie_login_qr_update_online_user')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t// Update tracked topics with the current expire time\n\t\t\t\tif (isset($_COOKIE[$cookie_name.'_track']))\n\t\t\t\t\tforum_setcookie($cookie_name.'_track', $_COOKIE[$cookie_name.'_track'], $now + $forum_config['o_timeout_visit']);\n\t\t\t}\n\t\t}\n\n\t\t$forum_user['is_guest'] = false;\n\t\t$forum_user['is_admmod'] = $forum_user['g_id'] == FORUM_ADMIN || $forum_user['g_moderator'] == '1';\n\t}\n\telse\n\t\tset_default_user();\n\n\t($hook = get_hook('fn_cookie_login_end')) ? eval($hook) : null;\n}\n\n\n// Fill $forum_user with default values (for guests)\nfunction set_default_user()\n{\n\tglobal $forum_db, $db_type, $forum_user, $forum_config;\n\n\t$remote_addr = get_remote_address();\n\n\t$return = ($hook = get_hook('fn_set_default_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Fetch guest user\n\t$query = array(\n\t\t'SELECT'\t=> 'u.*, g.*, o.logged, o.csrf_token, o.prev_url, o.last_post, o.last_search',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'online AS o',\n\t\t\t\t'ON'\t\t\t=> 'o.ident=\\''.$forum_db->escape($remote_addr).'\\''\n\t\t\t)\n\t\t),\n\t\t'WHERE'\t\t=> 'u.id=1'\n\t);\n\n\t($hook = get_hook('fn_set_default_user_qr_get_default_user')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tif (!$forum_db->num_rows($result))\n\t\texit('Unable to fetch guest information. The table \\''.$forum_db->prefix.'users\\' must contain an entry with id = 1 that represents anonymous users.');\n\n\t$forum_user = $forum_db->fetch_assoc($result);\n\n\tif (!defined('FORUM_QUIET_VISIT'))\n\t{\n\t\t// Update online list\n\t\tif (!$forum_user['logged'])\n\t\t{\n\t\t\t$forum_user['logged'] = time();\n\t\t\t$forum_user['csrf_token'] = random_key(40, false, true);\n\t\t\t$forum_user['prev_url'] = get_current_url(255);\n\n\t\t\t// REPLACE INTO avoids a user having two rows in the online table\n\t\t\t$query = array(\n\t\t\t\t'REPLACE'\t=> 'user_id, ident, logged, csrf_token',\n\t\t\t\t'INTO'\t\t=> 'online',\n\t\t\t\t'VALUES'\t=> '1, \\''.$forum_db->escape($remote_addr).'\\', '.$forum_user['logged'].', \\''.$forum_user['csrf_token'].'\\'',\n\t\t\t\t'UNIQUE'\t=> 'user_id=1 AND ident=\\''.$forum_db->escape($remote_addr).'\\''\n\t\t\t);\n\n\t\t\tif ($forum_user['prev_url'] != null)\n\t\t\t{\n\t\t\t\t$query['REPLACE'] .= ', prev_url';\n\t\t\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($forum_user['prev_url']).'\\'';\n\t\t\t}\n\n\t\t\t($hook = get_hook('fn_set_default_user_qr_add_online_guest_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t'SET'\t\t=> 'logged='.time(),\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape($remote_addr).'\\''\n\t\t\t);\n\n\t\t\t$current_url = get_current_url(255);\n\t\t\tif ($current_url != null)\n\t\t\t\t$query['SET'] .= ', prev_url=\\''.$forum_db->escape($current_url).'\\'';\n\n\t\t\t($hook = get_hook('fn_set_default_user_qr_update_online_guest_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t}\n\n\t$forum_user['disp_topics'] = $forum_config['o_disp_topics_default'];\n\t$forum_user['disp_posts'] = $forum_config['o_disp_posts_default'];\n\t$forum_user['timezone'] = $forum_config['o_default_timezone'];\n\t$forum_user['dst'] = $forum_config['o_default_dst'];\n\t$forum_user['language'] = $forum_config['o_default_lang'];\n\t$forum_user['style'] = $forum_config['o_default_style'];\n\t$forum_user['is_guest'] = true;\n\t$forum_user['is_admmod'] = false;\n\n\t($hook = get_hook('fn_set_default_user_end')) ? eval($hook) : null;\n}\n\n\n// Check whether the connecting user is banned (and delete any expired bans while we're at it)\nfunction check_bans()\n{\n\tglobal $forum_db, $forum_config, $lang_common, $forum_user, $forum_bans;\n\n\t$return = ($hook = get_hook('fn_check_bans_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Admins aren't affected\n\tif (defined('FORUM_ADMIN') && $forum_user['g_id'] == FORUM_ADMIN || !$forum_bans)\n\t\treturn;\n\n\t// Add a dot or a colon (depending on IPv4/IPv6) at the end of the IP address to prevent banned address\n\t// 192.168.0.5 from matching e.g. 192.168.0.50\n\t$user_ip = get_remote_address();\n\t$user_ip .= (strpos($user_ip, '.') !== false) ? '.' : ':';\n\n\t$bans_altered = false;\n\t$is_banned = false;\n\n\tforeach ($forum_bans as $cur_ban)\n\t{\n\t\t// Has this ban expired?\n\t\tif ($cur_ban['expire'] != '' && $cur_ban['expire'] <= time())\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'bans',\n\t\t\t\t'WHERE'\t\t=> 'id='.$cur_ban['id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_check_bans_qr_delete_expired_ban')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t$bans_altered = true;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif ($cur_ban['username'] != '' && utf8_strtolower($forum_user['username']) == utf8_strtolower($cur_ban['username']))\n\t\t\t$is_banned = true;\n\n\t\tif ($cur_ban['email'] != '' && $forum_user['email'] == $cur_ban['email'])\n\t\t\t$is_banned = true;\n\n\t\tif ($cur_ban['ip'] != '')\n\t\t{\n\t\t\t$cur_ban_ips = explode(' ', $cur_ban['ip']);\n\n\t\t\t$num_ips = count($cur_ban_ips);\n\t\t\tfor ($i = 0; $i < $num_ips; ++$i)\n\t\t\t{\n\t\t\t\t// Add the proper ending to the ban\n\t\t\t\tif (strpos($user_ip, '.') !== false)\n\t\t\t\t\t$cur_ban_ips[$i] = $cur_ban_ips[$i].'.';\n\t\t\t\telse\n\t\t\t\t\t$cur_ban_ips[$i] = $cur_ban_ips[$i].':';\n\n\t\t\t\tif (substr($user_ip, 0, strlen($cur_ban_ips[$i])) == $cur_ban_ips[$i])\n\t\t\t\t{\n\t\t\t\t\t$is_banned = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ($is_banned)\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'online',\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape($forum_user['username']).'\\''\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_check_bans_qr_delete_online_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\tmessage($lang_common['Ban message'].(($cur_ban['expire'] != '') ? ' '.sprintf($lang_common['Ban message 2'], format_time($cur_ban['expire'], 1, null, null, true)) : '').(($cur_ban['message'] != '') ? ' '.$lang_common['Ban message 3'].'</p><p><strong>'.forum_htmlencode($cur_ban['message']).'</strong></p>' : '</p>').'<p>'.sprintf($lang_common['Ban message 4'], '<a href=\"mailto:'.forum_htmlencode($forum_config['o_admin_email']).'\">'.forum_htmlencode($forum_config['o_admin_email']).'</a>'));\n\t\t}\n\t}\n\n\t// If we removed any expired bans during our run-through, we need to regenerate the bans cache\n\tif ($bans_altered)\n\t{\n\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\tgenerate_bans_cache();\n\t}\n}\n\n\n// Update \"Users online\"\nfunction update_users_online()\n{\n\tglobal $forum_db, $forum_config, $forum_user;\n\n\t$now = time();\n\n\t$return = ($hook = get_hook('fn_update_users_online_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Fetch all online list entries that are older than \"o_timeout_online\"\n\t$query = array(\n\t\t'SELECT'\t=> 'o.*',\n\t\t'FROM'\t\t=> 'online AS o',\n\t\t'WHERE'\t\t=> 'o.logged<'.($now-$forum_config['o_timeout_online'])\n\t);\n\n\t($hook = get_hook('fn_update_users_online_qr_get_old_online_users')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\twhile ($cur_user = $forum_db->fetch_assoc($result))\n\t{\n\t\t// If the entry is a guest, delete it\n\t\tif ($cur_user['user_id'] == '1')\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'online',\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape($cur_user['ident']).'\\''\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_update_users_online_qr_delete_online_guest_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// If the entry is older than \"o_timeout_visit\", update last_visit for the user in question, then delete him/her from the online list\n\t\t\tif ($cur_user['logged'] < ($now - $forum_config['o_timeout_visit']))\n\t\t\t{\n\t\t\t\t$query = array(\n\t\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t\t'SET'\t\t=> 'last_visit='.$cur_user['logged'],\n\t\t\t\t\t'WHERE'\t\t=> 'id='.$cur_user['user_id']\n\t\t\t\t);\n\n\t\t\t\t($hook = get_hook('fn_update_users_online_qr_update_user_visit')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t$query = array(\n\t\t\t\t\t'DELETE'\t=> 'online',\n\t\t\t\t\t'WHERE'\t\t=> 'user_id='.$cur_user['user_id']\n\t\t\t\t);\n\n\t\t\t\t($hook = get_hook('fn_update_users_online_qr_delete_online_user')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$query = array(\n\t\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t\t'SET'\t\t=> 'idle=1',\n\t\t\t\t\t'WHERE'\t\t=> 'user_id='.$cur_user['user_id']\n\t\t\t\t);\n\n\t\t\t\t($hook = get_hook('fn_update_users_online_qr_update_user_idle')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t\t}\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_update_users_online_end')) ? eval($hook) : null;\n}\n\n\n// Save array of tracked topics in cookie\nfunction set_tracked_topics($tracked_topics)\n{\n\tglobal $cookie_name, $cookie_path, $cookie_domain, $cookie_secure, $forum_config;\n\n\t$return = ($hook = get_hook('fn_set_tracked_topics_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t$cookie_data = '';\n\tif (!empty($tracked_topics))\n\t{\n\t\t// Sort the arrays (latest read first)\n\t\tarsort($tracked_topics['topics'], SORT_NUMERIC);\n\t\tarsort($tracked_topics['forums'], SORT_NUMERIC);\n\n\t\t// Homebrew serialization (to avoid having to run unserialize() on cookie data)\n\t\tforeach ($tracked_topics['topics'] as $id => $timestamp)\n\t\t\t$cookie_data .= 't'.$id.'='.$timestamp.';';\n\t\tforeach ($tracked_topics['forums'] as $id => $timestamp)\n\t\t\t$cookie_data .= 'f'.$id.'='.$timestamp.';';\n\n\t\t// Enforce a 4048 byte size limit (4096 minus some space for the cookie name)\n\t\tif (strlen($cookie_data) > 4048)\n\t\t{\n\t\t\t$cookie_data = substr($cookie_data, 0, 4048);\n\t\t\t$cookie_data = substr($cookie_data, 0, strrpos($cookie_data, ';')).';';\n\t\t}\n\t}\n\n\tforum_setcookie($cookie_name.'_track', $cookie_data, time() + $forum_config['o_timeout_visit']);\n\t$_COOKIE[$cookie_name.'_track'] = $cookie_data;\t// Set it directly in $_COOKIE as well\n}\n\n\n// Extract array of tracked topics from cookie\nfunction get_tracked_topics()\n{\n\tglobal $cookie_name;\n\n\t$return = ($hook = get_hook('fn_get_tracked_topics_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$cookie_data = isset($_COOKIE[$cookie_name.'_track']) ? $_COOKIE[$cookie_name.'_track'] : false;\n\tif (!$cookie_data)\n\t\treturn array('topics' => array(), 'forums' => array());\n\n\tif (strlen($cookie_data) > 4048)\n\t\treturn array('topics' => array(), 'forums' => array());\n\n\t// Unserialize data from cookie\n\t$tracked_topics = array('topics' => array(), 'forums' => array());\n\tforeach (explode(';', $cookie_data) as $id_data)\n\t{\n\t\tswitch (substr($id_data, 0, 1))\n\t\t{\n\t\t\tcase 'f': $type = 'forums'; break;\n\t\t\tcase 't': $type = 'topics'; break;\n\t\t\tdefault: continue;\n\t\t}\n\n\t\t$id = intval(substr($id_data, 1));\n\n\t\tif (($pos = strpos($id_data, '=')) === false)\n\t\t\tcontinue;\n\t\t$timestamp = intval(substr($id_data, $pos + 1));\n\n\t\tif ($id > 0 && $timestamp > 0)\n\t\t\t$tracked_topics[$type][$id] = $timestamp;\n\t}\n\n\t($hook = get_hook('fn_get_tracked_topics_end')) ? eval($hook) : null;\n\n\treturn $tracked_topics;\n}\n\n\n// Adds a new user. The username must be passed through validate_username() first.\nfunction add_user($user_info, &$new_uid)\n{\n\tglobal $forum_db, $base_url, $lang_common, $forum_config, $forum_user, $forum_url;\n\n\t$return = ($hook = get_hook('fn_add_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Add the user\n\t$query = array(\n\t\t'INSERT'\t=> 'username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit, salt, activate_key',\n\t\t'INTO'\t\t=> 'users',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($user_info['username']).'\\', '.$user_info['group_id'].', \\''.$forum_db->escape($user_info['password_hash']).'\\', \\''.$forum_db->escape($user_info['email']).'\\', '.$user_info['email_setting'].', '.floatval($user_info['timezone']).', '.$user_info['dst'].', \\''.$forum_db->escape($user_info['language']).'\\', \\''.$forum_db->escape($user_info['style']).'\\', '.$user_info['registered'].', \\''.$forum_db->escape($user_info['registration_ip']).'\\', '.$user_info['registered'].', \\''.$forum_db->escape($user_info['salt']).'\\', '.$user_info['activate_key'].''\n\t);\n\n\t($hook = get_hook('fn_add_user_qr_insert_user')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_uid = $forum_db->insert_id();\n\n\t// Must the user verify the registration?\n\tif ($user_info['require_verification'])\n\t{\n\t\t// Load the \"welcome\" template\n\t\t$mail_tpl = forum_trim(file_get_contents(FORUM_ROOT.'lang/'.$forum_user['language'].'/mail_templates/welcome.tpl'));\n\n\t\t// The first row contains the subject\n\t\t$first_crlf = strpos($mail_tpl, \"\\n\");\n\t\t$mail_subject = forum_trim(substr($mail_tpl, 8, $first_crlf-8));\n\t\t$mail_message = forum_trim(substr($mail_tpl, $first_crlf));\n\n\t\t$mail_subject = str_replace('<board_title>', $forum_config['o_board_title'], $mail_subject);\n\t\t$mail_message = str_replace('<base_url>', $base_url.'/', $mail_message);\n\t\t$mail_message = str_replace('<username>', $user_info['username'], $mail_message);\n\t\t$mail_message = str_replace('<activation_url>', str_replace('&amp;', '&', forum_link($forum_url['change_password_key'], array($new_uid, substr($user_info['activate_key'], 1, -1)))), $mail_message);\n\t\t$mail_message = str_replace('<board_mailer>', sprintf($lang_common['Forum mailer'], $forum_config['o_board_title']), $mail_message);\n\n\t\t($hook = get_hook('fn_add_user_send_verification')) ? eval($hook) : null;\n\n\t\tforum_mail($user_info['email'], $mail_subject, $mail_message);\n\t}\n\n\t// Should we alert people on the admin mailing list that a new user has registered?\n\tif ($user_info['notify_admins'] && $forum_config['o_mailing_list'] != '')\n\t{\n\t\t$mail_subject = 'Alert - New registration';\n\t\t$mail_message = 'User \\''.$user_info['username'].'\\' registered in the forums at '.$base_url.'/'.\"\\n\\n\".'User profile: '.forum_link($forum_url['user'], $new_uid).\"\\n\\n\".'-- '.\"\\n\".'Forum Mailer'.\"\\n\".'(Do not reply to this message)';\n\n\t\tforum_mail($forum_config['o_mailing_list'], $mail_subject, $mail_message);\n\t}\n\n\t($hook = get_hook('fn_add_user_end')) ? eval($hook) : null;\n}\n\n\n// Delete a user and all information associated with it\nfunction delete_user($user_id, $delete_posts = false)\n{\n\tglobal $forum_db, $db_type, $forum_config;\n\n\t$return = ($hook = get_hook('fn_delete_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// First we need to get some data on the user\n\t$query = array(\n\t\t'SELECT'\t=> 'u.username, u.group_id, g.g_moderator',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t)\n\t\t),\n\t\t'WHERE'\t\t=> 'u.id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_get_user_data')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$user = $forum_db->fetch_assoc($result);\n\n\t// Delete any subscriptions\n\t$query = array(\n\t\t'DELETE'\t=> 'subscriptions',\n\t\t'WHERE'\t\t=> 'user_id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_delete_subscriptions')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Remove him/her from the online list (if they happen to be logged in)\n\t$query = array(\n\t\t'DELETE'\t=> 'online',\n\t\t'WHERE'\t\t=> 'user_id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_delete_online')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Should we delete all posts made by this user?\n\tif ($delete_posts)\n\t{\n\t\t@set_time_limit(0);\n\n\t\t// Find all posts made by this user\n\t\t$query = array(\n\t\t\t'SELECT'\t=> 'p.id, p.topic_id, t.forum_id, t.first_post_id',\n\t\t\t'FROM'\t\t=> 'posts AS p',\n\t\t\t'JOINS'\t\t=> array(\n\t\t\t\tarray(\n\t\t\t\t\t'INNER JOIN'\t=> 'topics AS t',\n\t\t\t\t\t'ON'\t\t\t=> 't.id=p.topic_id'\n\t\t\t\t)\n\t\t\t),\n\t\t\t'WHERE'\t\t=> 'p.poster_id='.$user_id\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_user_qr_get_user_posts')) ? eval($hook) : null;\n\t\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\twhile ($cur_post = $forum_db->fetch_assoc($result))\n\t\t{\n\t\t\tif ($cur_post['first_post_id'] == $cur_post['id'])\n\t\t\t\tdelete_topic($cur_post['topic_id'], $cur_post['forum_id']);\n\t\t\telse\n\t\t\t\tdelete_post($cur_post['id'], $cur_post['topic_id'], $cur_post['forum_id']);\n\t\t}\n\t}\n\telse\n\t{\n\t\t// Set all his/her posts to guest\n\t\t$query = array(\n\t\t\t'UPDATE'\t=> 'posts',\n\t\t\t'SET'\t\t=> 'poster_id=1',\n\t\t\t'WHERE'\t\t=> 'poster_id='.$user_id\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_user_qr_reset_user_posts')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// Delete the user\n\t$query = array(\n\t\t'DELETE'\t=> 'users',\n\t\t'WHERE'\t\t=> 'id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_delete_user')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Delete user avatar\n\tdelete_avatar($user_id);\n\n\t// If the user is a moderator or an administrator, we remove him/her from the moderator list in all forums\n\t// and regenerate the bans cache (in case he/she created any bans)\n\tif ($user['group_id'] == FORUM_ADMIN || $user['g_moderator'] == '1')\n\t{\n\t\tclean_forum_moderators();\n\n\t\t// Regenerate the bans cache\n\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\tgenerate_bans_cache();\n\t}\n\n\t($hook = get_hook('fn_delete_user_end')) ? eval($hook) : null;\n}\n\n\n// Check if a username is occupied\nfunction check_username_dupe($username, $exclude_id = null)\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_check_username_dupe_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$query = array(\n\t\t'SELECT'\t=> 'u.username',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'WHERE'\t\t=> '(UPPER(username)=UPPER(\\''.$forum_db->escape($username).'\\') OR UPPER(username)=UPPER(\\''.$forum_db->escape(preg_replace('/[^\\w]/u', '', $username)).'\\')) AND id>1'\n\t);\n\n\tif ($exclude_id)\n\t\t$query['WHERE'] .= ' AND id!='.$exclude_id;\n\n\t($hook = get_hook('fn_check_username_dupe_qr_check_username_dupe')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\treturn $forum_db->num_rows($result) ? $forum_db->result($result) : false;\n}\n\n\n// Deletes any avatars owned by the specified user ID\nfunction delete_avatar($user_id)\n{\n\tglobal $forum_config;\n\n\t$filetypes = array('jpg', 'gif', 'png');\n\n\t$return = ($hook = get_hook('fn_delete_avatar_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Delete user avatar\n\tforeach ($filetypes as $cur_type)\n\t\t@unlink(FORUM_ROOT.$forum_config['o_avatars_dir'].'/'.$user_id.'.'.$cur_type);\n\n}\n\n\n// Creates a new topic with its first post\nfunction add_topic($post_info, &$new_tid, &$new_pid)\n{\n\tglobal $forum_db, $db_type, $forum_config, $lang_common;\n\n\t$return = ($hook = get_hook('fn_add_topic_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Add the topic\n\t$query = array(\n\t\t'INSERT'\t=> 'poster, subject, posted, last_post, last_poster, forum_id',\n\t\t'INTO'\t\t=> 'topics',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($post_info['poster']).'\\', \\''.$forum_db->escape($post_info['subject']).'\\', '.$post_info['posted'].', '.$post_info['posted'].', \\''.$forum_db->escape($post_info['poster']).'\\', '.$post_info['forum_id']\n\t);\n\n\t($hook = get_hook('fn_add_topic_qr_add_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_tid = $forum_db->insert_id();\n\n\t// To subscribe or not to subscribe, that ...\n\tif (!$post_info['is_guest'] && $post_info['subscribe'])\n\t{\n\t\t$query = array(\n\t\t\t'INSERT'\t=> 'user_id, topic_id',\n\t\t\t'INTO'\t\t=> 'subscriptions',\n\t\t\t'VALUES'\t=> $post_info['poster_id'].' ,'.$new_tid\n\t\t);\n\n\t\t($hook = get_hook('fn_add_topic_qr_add_subscription')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// Create the post (\"topic post\")\n\t$query = array(\n\t\t'INSERT'\t=> 'poster, poster_id, poster_ip, message, hide_smilies, posted, topic_id',\n\t\t'INTO'\t\t=> 'posts',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($post_info['poster']).'\\', '.$post_info['poster_id'].', \\''.$forum_db->escape(get_remote_address()).'\\', \\''.$forum_db->escape($post_info['message']).'\\', '.$post_info['hide_smilies'].', '.$post_info['posted'].', '.$new_tid\n\t);\n\n\t// If it's a guest post, there might be an e-mail address we need to include\n\tif ($post_info['is_guest'] && $post_info['poster_email'] != null)\n\t{\n\t\t$query['INSERT'] .= ', poster_email';\n\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($post_info['poster_email']).'\\'';\n\t}\n\n\t($hook = get_hook('fn_add_topic_qr_add_topic_post')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_pid = $forum_db->insert_id();\n\n\t// Update the topic with last_post_id and first_post_id\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'last_post_id='.$new_pid.', first_post_id='.$new_pid,\n\t\t'WHERE'\t\t=> 'id='.$new_tid\n\t);\n\n\t($hook = get_hook('fn_add_topic_qr_update_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\trequire FORUM_ROOT.'include/search_idx.php';\n\n\tupdate_search_index('post', $new_pid, $post_info['message'], $post_info['subject']);\n\n\tsync_forum($post_info['forum_id']);\n\n\t// Increment user's post count & last post time\n\tif (isset($post_info['update_user']) && $post_info['update_user'])\n\t{\n\t\tif ($post_info['is_guest'])\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t'SET'\t\t=> 'last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape(get_remote_address()).'\\''\n\t\t\t);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t'SET'\t\t=> 'num_posts=num_posts+1, last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'id='.$post_info['poster_id']\n\t\t\t);\n\t\t}\n\n\t\t($hook = get_hook('fn_add_topic_qr_update_last_post')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// If the posting user is logged in update his/her unread indicator\n\tif (!$post_info['is_guest'] && isset($post_info['update_unread']) && $post_info['update_unread'])\n\t{\n\t\t$tracked_topics = get_tracked_topics();\n\t\t$tracked_topics['topics'][$new_tid] = time();\n\t\tset_tracked_topics($tracked_topics);\n\t}\n\n\t($hook = get_hook('fn_add_topic_end')) ? eval($hook) : null;\n}\n\n\n// Delete a topic and all of it's posts\nfunction delete_topic($topic_id, $forum_id)\n{\n\tglobal $forum_db, $db_type;\n\n\t$return = ($hook = get_hook('fn_delete_topic_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Create an array of forum IDs that need to be synced\n\t$forum_ids = array($forum_id);\n\t$query = array(\n\t\t'SELECT'\t=> 't.forum_id',\n\t\t'FROM'\t\t=> 'topics AS t',\n\t\t'WHERE'\t\t=> 't.moved_to='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_get_forums_to_sync')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\twhile ($row = $forum_db->fetch_row($result))\n\t\t$forum_ids[] = $row[0];\n\n\t// Delete the topic and any redirect topics\n\t$query = array(\n\t\t'DELETE'\t=> 'topics',\n\t\t'WHERE'\t\t=> 'id='.$topic_id.' OR moved_to='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_delete_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Create a list of the post ID's in this topic\n\t$query = array(\n\t\t'SELECT'\t=> 'p.id',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_get_posts_to_delete')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t$post_ids = array();\n\twhile ($row = $forum_db->fetch_row($result))\n\t\t$post_ids[] = $row[0];\n\n\t// Make sure we have a list of post ID's\n\tif (!empty($post_ids))\n\t{\n\t\t// Delete posts in topic\n\t\t$query = array(\n\t\t\t'DELETE'\t=> 'posts',\n\t\t\t'WHERE'\t\t=> 'topic_id='.$topic_id\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_topic_qr_delete_topic_posts')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\t\trequire_once FORUM_ROOT.'include/search_idx.php';\n\n\t\tstrip_search_index($post_ids);\n\t}\n\n\t// Delete any subscriptions for this topic\n\t$query = array(\n\t\t'DELETE'\t=> 'subscriptions',\n\t\t'WHERE'\t\t=> 'topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_delete_topic_subscriptions')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tforeach ($forum_ids as $cur_forum_id)\n\t\tsync_forum($cur_forum_id);\n\n\t($hook = get_hook('fn_delete_topic_end')) ? eval($hook) : null;\n}\n\n\n// Locate and delete any orphaned redirect topics\nfunction delete_orphans()\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_delete_orphans_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Locate any orphaned redirect topics\n\t$query = array(\n\t\t'SELECT'\t=> 't1.id',\n\t\t'FROM'\t\t=> 'topics AS t1',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'topics AS t2',\n\t\t\t\t'ON'\t\t\t=> 't1.moved_to=t2.id'\n\t\t\t)\n\t\t),\n\t\t'WHERE'\t\t=> 't2.id IS NULL AND t1.moved_to IS NOT NULL'\n\t);\n\n\t($hook = get_hook('fn_delete_orphans_qr_get_orphans')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_orphans = $forum_db->num_rows($result);\n\n\tif ($num_orphans)\n\t{\n\t\tfor ($i = 0; $i < $num_orphans; ++$i)\n\t\t\t$orphans[] = $forum_db->result($result, $i);\n\n\t\t// Delete the orphan\n\t\t$query = array(\n\t\t\t'DELETE'\t=> 'topics',\n\t\t\t'WHERE'\t\t=> 'id IN('.implode(',', $orphans).')'\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_orphans_qr_delete_orphan')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t($hook = get_hook('fn_delete_orphans_end')) ? eval($hook) : null;\n}\n\n\n// Creates a new post\nfunction add_post($post_info, &$new_pid)\n{\n\tglobal $forum_db, $db_type, $forum_config, $lang_common;\n\n\t$return = ($hook = get_hook('fn_add_post_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Add the post\n\t$query = array(\n\t\t'INSERT'\t=> 'poster, poster_id, poster_ip, message, hide_smilies, posted, topic_id',\n\t\t'INTO'\t\t=> 'posts',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($post_info['poster']).'\\', '.$post_info['poster_id'].', \\''.$forum_db->escape(get_remote_address()).'\\', \\''.$forum_db->escape($post_info['message']).'\\', '.$post_info['hide_smilies'].', '.$post_info['posted'].', '.$post_info['topic_id']\n\t);\n\n\t// If it's a guest post, there might be an e-mail address we need to include\n\tif ($post_info['is_guest'] && $post_info['poster_email'] != null)\n\t{\n\t\t$query['INSERT'] .= ', poster_email';\n\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($post_info['poster_email']).'\\'';\n\t}\n\n\t($hook = get_hook('fn_add_post_qr_add_post')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_pid = $forum_db->insert_id();\n\n\tif (!$post_info['is_guest'])\n\t{\n\t\t// Subscribe or unsubscribe?\n\t\tif ($post_info['subscr_action'] == 1)\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'INSERT'\t=> 'user_id, topic_id',\n\t\t\t\t'INTO'\t\t=> 'subscriptions',\n\t\t\t\t'VALUES'\t=> $post_info['poster_id'].' ,'.$post_info['topic_id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_add_post_qr_add_subscription')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t\telse if ($post_info['subscr_action'] == 2)\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'subscriptions',\n\t\t\t\t'WHERE'\t\t=> 'topic_id='.$post_info['topic_id'].' AND user_id='.$post_info['poster_id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_add_post_qr_delete_subscription')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t}\n\n\t// Count number of replies in the topic\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(p.id)',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$post_info['topic_id']\n\t);\n\n\t($hook = get_hook('fn_add_post_qr_get_topic_reply_count')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_replies = $forum_db->result($result, 0) - 1;\n\n\t// Update topic\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'num_replies='.$num_replies.', last_post='.$post_info['posted'].', last_post_id='.$new_pid.', last_poster=\\''.$forum_db->escape($post_info['poster']).'\\'',\n\t\t'WHERE'\t\t=> 'id='.$post_info['topic_id']\n\t);\n\n\t($hook = get_hook('fn_add_post_qr_update_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tsync_forum($post_info['forum_id']);\n\n\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\trequire FORUM_ROOT.'include/search_idx.php';\n\n\tupdate_search_index('post', $new_pid, $post_info['message']);\n\n\tsend_subscriptions($post_info, $new_pid);\n\n\t// Increment user's post count & last post time\n\tif (isset($post_info['update_user']))\n\t{\n\t\tif ($post_info['is_guest'])\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t'SET'\t\t=> 'last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape(get_remote_address()).'\\''\n\t\t\t);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t'SET'\t\t=> 'num_posts=num_posts+1, last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'id='.$post_info['poster_id']\n\t\t\t);\n\t\t}\n\n\t\t($hook = get_hook('fn_add_post_qr_update_last_post')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// If the posting user is logged in update his/her unread indicator\n\tif (!$post_info['is_guest'] && isset($post_info['update_unread']) && $post_info['update_unread'])\n\t{\n\t\t$tracked_topics = get_tracked_topics();\n\t\t$tracked_topics['topics'][$post_info['topic_id']] = time();\n\t\tset_tracked_topics($tracked_topics);\n\t}\n\n\t($hook = get_hook('fn_add_post_end')) ? eval($hook) : null;\n}\n\n\n// Delete a single post\nfunction delete_post($post_id, $topic_id, $forum_id)\n{\n\tglobal $forum_db, $db_type;\n\n\t$return = ($hook = get_hook('fn_delete_post_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t$query = array(\n\t\t'SELECT'\t=> 'p.id, p.poster, p.posted',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id,\n\t\t'ORDER BY'\t=> 'p.id DESC',\n\t\t'LIMIT'\t\t=> '2'\n\t);\n\n\t($hook = get_hook('fn_qr_get_topic_lastposts_info')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tlist($last_id, ,) = $forum_db->fetch_row($result);\n\tlist($second_last_id, $second_poster, $second_posted) = $forum_db->fetch_row($result);\n\n\t// Delete the post\n\t$query = array(\n\t\t'DELETE'\t=> 'posts',\n\t\t'WHERE'\t\t=> 'id='.$post_id\n\t);\n\n\t($hook = get_hook('fn_delete_post_qr_delete_post')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\trequire FORUM_ROOT.'include/search_idx.php';\n\n\tstrip_search_index($post_id);\n\n\t// Count number of replies in the topic\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(p.id)',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_qr_get_topic_reply_count2')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_replies = $forum_db->result($result, 0) - 1;\n\n\t// Update the topic now that a post has been deleted\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'num_replies='.$num_replies,\n\t\t'WHERE'\t\t=> 'id='.$topic_id\n\t);\n\n\t// If we deleted the most recent post, we need to sync up last post data as wel\n\tif ($last_id == $post_id)\n\t\t$query['SET'] .= ', last_post='.$second_posted.', last_post_id='.$second_last_id.', last_poster=\\''.$forum_db->escape($second_poster).'\\'';\n\n\t($hook = get_hook('fn_qr_update_topic2')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tsync_forum($forum_id);\n\n\t($hook = get_hook('fn_delete_post_end')) ? eval($hook) : null;\n}\n\n\n// Update posts, topics, last_post, last_post_id and last_poster for a forum\nfunction sync_forum($forum_id)\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_sync_forum_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Get topic and post count for forum\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(t.id), SUM(t.num_replies)',\n\t\t'FROM'\t\t=> 'topics AS t',\n\t\t'WHERE'\t\t=> 't.forum_id='.$forum_id\n\t);\n\n\t($hook = get_hook('fn_sync_forum_qr_get_forum_stats')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tlist($num_topics, $num_posts) = $forum_db->fetch_row($result);\n\n\t$num_posts = $num_posts + $num_topics;\t\t// $num_posts is only the sum of all replies (we have to add the topic posts)\n\n\t// Get last_post, last_post_id and last_poster for forum (if any)\n\t$query = array(\n\t\t'SELECT'\t=> 't.last_post, t.last_post_id, t.last_poster',\n\t\t'FROM'\t\t=> 'topics AS t',\n\t\t'WHERE'\t\t=> 't.forum_id='.$forum_id.' AND t.moved_to is NULL',\n\t\t'ORDER BY'\t=> 't.last_post DESC',\n\t\t'LIMIT'\t\t=> '1'\n\t);\n\n\t($hook = get_hook('fn_sync_forum_qr_get_forum_last_post_data')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tif ($forum_db->num_rows($result))\n\t{\n\t\tlist($last_post, $last_post_id, $last_poster) = $forum_db->fetch_row($result);\n\t\t$last_poster = '\\''.$forum_db->escape($last_poster).'\\'';\n\t}\n\telse\n\t\t$last_post = $last_post_id = $last_poster = 'NULL';\n\n\t// Now update the forum\n\t$query = array(\n\t\t'UPDATE'\t=> 'forums',\n\t\t'SET'\t\t=> 'num_topics='.$num_topics.', num_posts='.$num_posts.', last_post='.$last_post.', last_post_id='.$last_post_id.', last_poster='.$last_poster,\n\t\t'WHERE'\t\t=> 'id='.$forum_id\n\t);\n\n\t($hook = get_hook('fn_sync_forum_qr_update_forum')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t($hook = get_hook('fn_sync_forum_end')) ? eval($hook) : null;\n}\n\n\n// Update replies, last_post, last_post_id and last_poster for a topic\nfunction sync_topic($topic_id)\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_sync_topic_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Count number of replies in the topic\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(p.id)',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_sync_topic_qr_get_topic_reply_count')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_replies = $forum_db->result($result, 0) - 1;\n\n\t// Get last_post, last_post_id and last_poster\n\t$query = array(\n\t\t'SELECT'\t=> 'p.posted, p.id, p.poster',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id,\n\t\t'ORDER BY'\t=> 'p.id DESC',\n\t\t'LIMIT'\t\t=> '1'\n\t);\n\n\t($hook = get_hook('fn_sync_topic_qr_get_topic_last_post_data')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tlist($last_post, $last_post_id, $last_poster) = $forum_db->fetch_row($result);\n\n\t// Now update the topic\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'num_replies='.$num_replies.', last_post='.$last_post.', last_post_id='.$last_post_id.', last_poster=\\''.$forum_db->escape($last_poster).'\\'',\n\t\t'WHERE'\t\t=> 'id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_sync_topic_qr_update_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t($hook = get_hook('fn_sync_topic_end')) ? eval($hook) : null;\n}\n\n\n// Iterates through all forum moderator lists and removes any erroneous entries\nfunction clean_forum_moderators()\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_clean_forum_moderators_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Get a list of forums and their respective lists of moderators\n\t$query = array(\n\t\t'SELECT'\t=> 'f.id, f.moderators',\n\t\t'FROM'\t\t=> 'forums AS f',\n\t\t'WHERE'\t\t=> 'f.moderators IS NOT NULL'\n\t);\n\n\t($hook = get_hook('fn_clean_forum_moderators_qr_get_forum_moderators')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t$removed_moderators = array();\n\twhile ($cur_forum = $forum_db->fetch_assoc($result))\n\t{\n\t\t$cur_moderators = unserialize($cur_forum['moderators']);\n\t\t$new_moderators = $cur_moderators;\n\n\t\t// Iterate through each user in the list and check if he/she is in a moderator or admin group\n\t\tforeach ($cur_moderators as $username => $user_id)\n\t\t{\n\t\t\tif (in_array($user_id, $removed_moderators))\n\t\t\t{\n\t\t\t\tunset($new_moderators[$username]);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t$query = array(\n\t\t\t\t'SELECT'\t=> '1',\n\t\t\t\t'FROM'\t\t=> 'users AS u',\n\t\t\t\t'JOINS'\t\t=> array(\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t\t\t)\n\t\t\t\t),\n\t\t\t\t'WHERE'\t\t=> '(g.g_moderator=1 OR u.group_id=1) AND u.id='.$user_id\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_clean_forum_moderators_qr_check_user_in_moderator_group')) ? eval($hook) : null;\n\t\t\t$result2 = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\tif (!$forum_db->num_rows($result2))\t// If the user isn't in a moderator or admin group, remove him/her from the list\n\t\t\t{\n\t\t\t\tunset($new_moderators[$username]);\n\t\t\t\t$removed_moderators[] = $user_id;\n\t\t\t}\n\t\t}\n\n\t\t// If we changed anything, update the forum\n\t\tif ($cur_moderators != $new_moderators)\n\t\t{\n\t\t\t$new_moderators = (!empty($new_moderators)) ? '\\''.$forum_db->escape(serialize($new_moderators)).'\\'' : 'NULL';\n\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'forums',\n\t\t\t\t'SET'\t\t=> 'moderators='.$new_moderators,\n\t\t\t\t'WHERE'\t\t=> 'id='.$cur_forum['id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_qr_clean_forum_moderators_set_forum_moderators')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_clean_forum_moderators_end')) ? eval($hook) : null;\n}\n\n\n// Send out subscription emails\nfunction send_subscriptions($post_info, $new_pid)\n{\n\tglobal $forum_config, $forum_db, $forum_url, $lang_common;\n\n\t$return = ($hook = get_hook('fn_send_subscriptions_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\tif ($forum_config['o_subscriptions'] != '1')\n\t\treturn;\n\n\t// Get the post time for the previous post in this topic\n\t$query = array(\n\t\t'SELECT'\t=> 'p.posted',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$post_info['topic_id'],\n\t\t'ORDER BY'\t=> 'p.id DESC',\n\t\t'LIMIT'\t\t=> '1, 1'\n\t);\n\n\t($hook = get_hook('fn_send_subscriptions_qr_get_previous_post_time')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$previous_post_time = $forum_db->result($result);\n\n\t// Get any subscribed users that should be notified (banned users are excluded)\n\t$query = array(\n\t\t'SELECT'\t=> 'u.id, u.email, u.notify_with_post, u.language',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'subscriptions AS s',\n\t\t\t\t'ON'\t\t\t=> 'u.id=s.user_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'forum_perms AS fp',\n\t\t\t\t'ON'\t\t\t=> '(fp.forum_id='.$post_info['forum_id'].' AND fp.group_id=u.group_id)'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'online AS o',\n\t\t\t\t'ON'\t\t\t=> 'u.id=o.user_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'bans AS b',\n\t\t\t\t'ON'\t\t\t=> 'u.username=b.username'\n\t\t\t),\n\t\t),\n\t\t'WHERE'\t\t=> 'b.username IS NULL AND COALESCE(o.logged, u.last_visit)>'.$previous_post_time.' AND (fp.read_forum IS NULL OR fp.read_forum=1) AND s.topic_id='.$post_info['topic_id'].' AND u.id!='.$post_info['poster_id']\n\t);\n\n\t($hook = get_hook('fn_send_subscriptions_qr_get_users_to_notify')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tif ($forum_db->num_rows($result))\n\t{\n\t\tif (!defined('FORUM_EMAIL_FUNCTIONS_LOADED'))\n\t\t\trequire FORUM_ROOT.'include/email.php';\n\n\t\t$notification_emails = array();\n\n\t\t// Loop through subscribed users and send e-mails\n\t\twhile ($cur_subscriber = $forum_db->fetch_assoc($result))\n\t\t{\n\t\t\t// Is the subscription e-mail for $cur_subscriber['language'] cached or not?\n\t\t\tif (!isset($notification_emails[$cur_subscriber['language']]) && file_exists(FORUM_ROOT.'lang/'.$cur_subscriber['language'].'/mail_templates/new_reply.tpl'))\n\t\t\t{\n\t\t\t\t// Load the \"new reply\" template\n\t\t\t\t$mail_tpl = forum_trim(file_get_contents(FORUM_ROOT.'lang/'.$cur_subscriber['language'].'/mail_templates/new_reply.tpl'));\n\n\t\t\t\t// Load the \"new reply full\" template (with post included)\n\t\t\t\t$mail_tpl_full = forum_trim(file_get_contents(FORUM_ROOT.'lang/'.$cur_subscriber['language'].'/mail_templates/new_reply_full.tpl'));\n\n\t\t\t\t// The first row contains the subject (it also starts with \"Subject:\")\n\t\t\t\t$first_crlf = strpos($mail_tpl, \"\\n\");\n\t\t\t\t$mail_subject = forum_trim(substr($mail_tpl, 8, $first_crlf-8));\n\t\t\t\t$mail_message = forum_trim(substr($mail_tpl, $first_crlf));\n\n\t\t\t\t$first_crlf = strpos($mail_tpl_full, \"\\n\");\n\t\t\t\t$mail_subject_full = forum_trim(substr($mail_tpl_full, 8, $first_crlf-8));\n\t\t\t\t$mail_message_full = forum_trim(substr($mail_tpl_full, $first_crlf));\n\n\t\t\t\t$mail_subject = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_subject);\n\t\t\t\t$mail_message = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_message);\n\t\t\t\t$mail_message = str_replace('<replier>', $post_info['poster'], $mail_message);\n\t\t\t\t$mail_message = str_replace('<post_url>', forum_link($forum_url['post'], $new_pid), $mail_message);\n\t\t\t\t$mail_message = str_replace('<unsubscribe_url>', forum_link($forum_url['unsubscribe'], array($post_info['topic_id'], generate_form_token('unsubscribe'.$post_info['topic_id'].$cur_subscriber['id']))), $mail_message);\n\t\t\t\t$mail_message = str_replace('<board_mailer>', sprintf($lang_common['Forum mailer'], $forum_config['o_board_title']), $mail_message);\n\n\t\t\t\t$mail_subject_full = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_subject_full);\n\t\t\t\t$mail_message_full = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<replier>', $post_info['poster'], $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<message>', $post_info['message'], $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<post_url>', forum_link($forum_url['post'], $new_pid), $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<unsubscribe_url>', forum_link($forum_url['unsubscribe'], array($post_info['topic_id'], generate_form_token('unsubscribe'.$post_info['topic_id'].$cur_subscriber['id']))), $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<board_mailer>', sprintf($lang_common['Forum mailer'], $forum_config['o_board_title']), $mail_message_full);\n\n\t\t\t\t$notification_emails[$cur_subscriber['language']][0] = $mail_subject;\n\t\t\t\t$notification_emails[$cur_subscriber['language']][1] = $mail_message;\n\t\t\t\t$notification_emails[$cur_subscriber['language']][2] = $mail_subject_full;\n\t\t\t\t$notification_emails[$cur_subscriber['language']][3] = $mail_message_full;\n\n\t\t\t\t$mail_subject = $mail_message = $mail_subject_full = $mail_message_full = null;\n\t\t\t}\n\n\t\t\t// We have to double check here because the templates could be missing\n\t\t\t// Make sure the e-mail address format is valid before sending\n\t\t\tif (isset($notification_emails[$cur_subscriber['language']]) && is_valid_email($cur_subscriber['email']))\n\t\t\t{\n\t\t\t\tif ($cur_subscriber['notify_with_post'] == '0')\n\t\t\t\t\tforum_mail($cur_subscriber['email'], $notification_emails[$cur_subscriber['language']][0], $notification_emails[$cur_subscriber['language']][1]);\n\t\t\t\telse\n\t\t\t\t\tforum_mail($cur_subscriber['email'], $notification_emails[$cur_subscriber['language']][2], $notification_emails[$cur_subscriber['language']][3]);\n\t\t\t}\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_send_subscriptions_end')) ? eval($hook) : null;\n}\n\n\n//\n// Special pages\n//\n\n// Display a form that the user can use to confirm that they want to undertake an action.\n// Used when the CSRF token from the request does not match the token stored in the database.\nfunction csrf_confirm_form()\n{\n\tglobal $forum_db, $forum_url, $lang_common, $forum_config, $base_url, $forum_start, $tpl_main, $forum_user, $forum_page, $forum_updates;\n\n\t// If we've disabled the CSRF check for this page, we have nothing to do here.\n\tif (defined('FORUM_DISABLE_CSRF_CONFIRM'))\n\t\treturn;\n\n\t// User pressed the cancel button\n\tif (isset($_POST['confirm_cancel']))\n\t\tredirect(forum_htmlencode($_POST['prev_url']), $lang_common['Cancel redirect']);\n\n\t// A helper function for csrf_confirm_form. It takes a multi-dimensional array and returns it as a\n\t// single-dimensional array suitable for use in hidden fields.\n\tfunction _csrf_confirm_form($key, $values)\n\t{\n\t\t$fields = array();\n\n\t\tif (is_array($values))\n\t\t{\n\t\t\tforeach ($values as $cur_key => $cur_values)\n\t\t\t\t$fields = array_merge($fields, _csrf_confirm_form($key.'['.$cur_key.']', $cur_values));\n\n\t\t\treturn $fields;\n\t\t}\n\t\telse\n\t\t\t$fields[$key] = $values;\n\n\t\treturn $fields;\n\t}\n\n\t$return = ($hook = get_hook('fn_csrf_confirm_form_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Setup breadcrumbs\n\t$forum_page['crumbs'] = array(\n\t\tarray($forum_config['o_board_title'], forum_link($forum_url['index'])),\n\t\t$lang_common['Confirm action']\n\t);\n\n\t$forum_page['form_action'] = get_current_url();\n\n\t$forum_page['hidden_fields'] = array(\n\t\t'csrf_token'\t=> '<input type=\"hidden\" name=\"csrf_token\" value=\"'.generate_form_token($forum_page['form_action']).'\" />',\n\t\t'prev_url'\t\t=> '<input type=\"hidden\" name=\"prev_url\" value=\"'.forum_htmlencode($forum_user['prev_url']).'\" />'\n\t);\n\n\tforeach ($_POST as $submitted_key => $submitted_val)\n\t\tif ($submitted_key != 'csrf_token' && $submitted_key != 'prev_url')\n\t\t{\n\t\t\t$hidden_fields = _csrf_confirm_form($submitted_key, $submitted_val);\n\t\t\tforeach ($hidden_fields as $field_key => $field_val)\n\t\t\t\t$forum_page['hidden_fields'][$field_key] = '<input type=\"hidden\" name=\"'.forum_htmlencode($field_key).'\" value=\"'.forum_htmlencode($field_val).'\" />';\n\t\t}\n\n\tdefine('FORUM_PAGE', 'dialogue');\n\trequire FORUM_ROOT.'header.php';\n\n\t// START SUBST - <!-- forum_main -->\n\tob_start();\n\n\t($hook = get_hook('fn_csrf_confirm_form_pre_header_load')) ? eval($hook) : null;\n\n?>\n<div id=\"brd-main\" class=\"main\">\n\t<div class=\"main-head\">\n\t\t<h2 class=\"hn\"><span><?php echo $lang_common['Confirm action head'] ?></span></h2>\n\t</div>\n\t<div class=\"main-content main-frm\">\n\t\t<div class=\"ct-box info-box\">\n\t\t\t<p><?php echo $lang_common['CSRF token mismatch'] ?></p>\n\t\t</div>\n\t\t<form class=\"frm-form\" method=\"post\" accept-charset=\"utf-8\" action=\"<?php echo $forum_page['form_action'] ?>\">\n\t\t\t<div class=\"hidden\">\n\t\t\t\t<?php echo implode(\"\\n\\t\\t\\t\\t\", $forum_page['hidden_fields']).\"\\n\" ?>\n\t\t\t</div>\n\t\t\t<div class=\"frm-buttons\">\n\t\t\t\t<span class=\"submit\"><input type=\"submit\" value=\"<?php echo $lang_common['Confirm'] ?>\" /></span>\n\t\t\t\t<span class=\"cancel\"><input type=\"submit\" name=\"confirm_cancel\" value=\"<?php echo $lang_common['Cancel'] ?>\" /></span>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n</div>\n<?php\n\n\t($hook = get_hook('fn_csrf_confirm_form_end')) ? eval($hook) : null;\n\n\t$tpl_temp = forum_trim(ob_get_contents());\n\t$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_main -->\n\n\trequire FORUM_ROOT.'footer.php';\n}\n\n\n// Display a message\nfunction message($message, $link = '', $heading = '')\n{\n\tglobal $forum_db, $forum_url, $lang_common, $forum_config, $base_url, $forum_start, $tpl_main, $forum_user, $forum_page, $forum_updates;\n\n\t($hook = get_hook('fn_message_start')) ? eval($hook) : null;\n\n\tif (!defined('FORUM_HEADER'))\n\t{\n\t\tif ($heading == '')\n\t\t\t$heading = $lang_common['Forum message'];\n\n\t\t// Setup breadcrumbs\n\t\t$forum_page['crumbs'] = array(\n\t\t\tarray($forum_config['o_board_title'], forum_link($forum_url['index'])),\n\t\t\t$lang_common['Forum message']\n\t\t);\n\n\t\t($hook = get_hook('fn_message_pre_header_load')) ? eval($hook) : null;\n\n\t\tdefine('FORUM_PAGE', 'message');\n\t\trequire FORUM_ROOT.'header.php';\n\n\t\t// START SUBST - <!-- forum_main -->\n\t\tob_start();\n\n\t\t($hook = get_hook('fn_message_output_start')) ? eval($hook) : null;\n\t}\n\n?>\n\t<div class=\"main-head\">\n<?php\n\n\tif (!empty($forum_page['main_head_options']))\n\t\techo \"\\n\\t\\t\".'<p class=\"options\">'.implode(' ', $forum_page['main_head_options']).'</p>';\n\n?>\n\t\t<h2 class=\"hn\"><span><?php echo $heading ?></span></h2>\n\t</div>\n\n\t<div class=\"main-content main-message\">\n\t\t<p><?php echo $message ?><?php if ($link != '') echo ' <span>'.$link.'</span>' ?></p>\n\t</div>\n<?php\n\n\t($hook = get_hook('fn_message_output_end')) ? eval($hook) : null;\n\n\t$tpl_temp = forum_trim(ob_get_contents());\n\t$tpl_main = str_replace('<!-- forum_main -->', \"\\t\".$tpl_temp, $tpl_main);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_main -->\n\n\trequire FORUM_ROOT.'footer.php';\n}\n\n\n\n\n// Display a message when board is in maintenance mode\nfunction maintenance_message()\n{\n\tglobal $forum_db, $forum_config, $lang_common, $forum_user, $base_url;\n\n\t$return = ($hook = get_hook('fn_maintenance_message_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// Deal with newlines, tabs and multiple spaces\n\t$pattern = array(\"\\t\\t\", '  ', '  ');\n\t$replace = array('&#160; &#160; ', '&#160; ', ' &#160;');\n\t$message = str_replace($pattern, $replace, $forum_config['o_maintenance_message']);\n\n\t// Send the Content-type header in case the web server is setup to send something else\n\theader('Content-type: text/html; charset=utf-8');\n\n\t// Send a 503 HTTP response code to prevent search bots from indexing the maintenace message\n\theader('HTTP/1.1 503 Service Temporarily Unavailable');\n\n\t// Load the maintenance template\n\tif (file_exists(FORUM_ROOT.'style/'.$forum_user['style'].'/maintenance.tpl'))\n\t\t$tpl_path = FORUM_ROOT.'style/'.$forum_user['style'].'/maintenance.tpl';\n\telse\n\t\t$tpl_path = FORUM_ROOT.'include/template/maintenance.tpl';\n\n\t($hook = get_hook('fn_maintenance_message_pre_template_loaded')) ? eval($hook) : null;\n\n\t$tpl_maint = forum_trim(file_get_contents($tpl_path));\n\n\t($hook = get_hook('fn_maintenance_message_template_loaded')) ? eval($hook) : null;\n\n\t// START SUBST - <!-- forum_local -->\n\t$tpl_maint = str_replace('<!-- forum_local -->', 'xml:lang=\"'.$lang_common['lang_identifier'].'\" lang=\"'.$lang_common['lang_identifier'].'\" dir=\"'.$lang_common['lang_direction'].'\"', $tpl_maint);\n\t// END SUBST - <!-- forum_local -->\n\n\n\t// START SUBST - <!-- forum_head -->\n\n\tob_start();\n\n\trequire FORUM_ROOT.'style/'.$forum_user['style'].'/'.$forum_user['style'].'.php';\n\n\t$tpl_temp = forum_trim(ob_get_contents());\n\t$tpl_maint = str_replace('<!-- forum_head -->', $tpl_temp, $tpl_maint);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_head -->\n\n\n\t// START SUBST - <!-- forum_maint_main -->\n\tob_start();\n\n?>\n\t<div class=\"main-head\">\n\t\t<h1 class=\"hn\"><span><?php echo $lang_common['Maintenance mode'] ?></span></h1>\n\t</div>\n\t<div class=\"main-content main-message\">\n\t\t<div class=\"ct-box user-box\">\n\t\t\t<?php echo $message.\"\\n\" ?>\n\t\t</div>\n\t</div>\n<?php\n\n\t$tpl_temp = \"\\t\".forum_trim(ob_get_contents());\n\t$tpl_maint = str_replace('<!-- forum_maint_main -->', $tpl_temp, $tpl_maint);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_maint_main -->\n\n\n\t// End the transaction\n\t$forum_db->end_transaction();\n\n\n\t// START SUBST - <!-- forum_include \"*\" -->\n\twhile (preg_match('#<!-- ?forum_include \"([^/\\\\\\\\]*?)\" ?-->#', $tpl_maint, $cur_include))\n\t{\n\t\tif (!file_exists(FORUM_ROOT.'include/user/'.$cur_include[1]))\n\t\t\terror('Unable to process user include &lt;!-- forum_include \"'.forum_htmlencode($cur_include[1]).'\" --&gt; from template maintenance.tpl. There is no such file in folder /include/user/.');\n\n\t\tob_start();\n\t\tinclude FORUM_ROOT.'include/user/'.$cur_include[1];\n\t\t$tpl_temp = ob_get_contents();\n\t\t$tpl_maint = str_replace($cur_include[0], $tpl_temp, $tpl_maint);\n\t\tob_end_clean();\n\t}\n\t// END SUBST - <!-- forum_include \"*\" -->\n\n\n\t// Close the db connection (and free up any result data)\n\t$forum_db->close();\n\n\texit($tpl_maint);\n}\n\n\n// Display $message and redirect user to $destination_url\nfunction redirect($destination_url, $message)\n{\n\tglobal $forum_db, $forum_config, $lang_common, $forum_user, $base_url;\n\n\tdefine('FORUM_PAGE', 'redirect');\n\n\t($hook = get_hook('fn_redirect_start')) ? eval($hook) : null;\n\n\t// Prefix with base_url (unless it's there already)\n\tif (strpos($destination_url, 'http://') !== 0 && strpos($destination_url, 'https://') !== 0 && strpos($destination_url, '/') !== 0)\n\t\t$destination_url = $base_url.'/'.$destination_url;\n\n\t// Do a little spring cleaning\n\t$destination_url = preg_replace('/([\\r\\n])|(%0[ad])|(;[\\s]*data[\\s]*:)/i', '', $destination_url);\n\n\t// If the delay is 0 seconds, we might as well skip the redirect all together\n\tif ($forum_config['o_redirect_delay'] == '0')\n\t\theader('Location: '.str_replace('&amp;', '&', $destination_url));\n\n\t// Send no-cache headers\n\theader('Expires: Thu, 21 Jul 1977 07:30:00 GMT');\t// When yours truly first set eyes on this world! :)\n\theader('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT');\n\theader('Cache-Control: post-check=0, pre-check=0', false);\n\theader('Pragma: no-cache');\t\t// For HTTP/1.0 compability\n\n\t// Send the Content-type header in case the web server is setup to send something else\n\theader('Content-type: text/html; charset=utf-8');\n\n\t// Load the redirect template\n\tif (file_exists(FORUM_ROOT.'style/'.$forum_user['style'].'/redirect.tpl'))\n\t\t$tpl_path = FORUM_ROOT.'style/'.$forum_user['style'].'/redirect.tpl';\n\telse\n\t\t$tpl_path = FORUM_ROOT.'include/template/redirect.tpl';\n\n\t($hook = get_hook('fn_redirect_pre_template_loaded')) ? eval($hook) : null;\n\n\t$tpl_redir = forum_trim(file_get_contents($tpl_path));\n\n\t($hook = get_hook('fn_redirect_template_loaded')) ? eval($hook) : null;\n\n\t// START SUBST - <!-- forum_local -->\n\t$tpl_redir = str_replace('<!-- forum_local -->', 'xml:lang=\"'.$lang_common['lang_identifier'].'\" lang=\"'.$lang_common['lang_identifier'].'\" dir=\"'.$lang_common['lang_direction'].'\"', $tpl_redir);\n\t// END SUBST - <!-- forum_local -->\n\n\n\t// START SUBST - <!-- forum_head -->\n\n\t$forum_head['refresh'] = '<meta http-equiv=\"refresh\" content=\"'.$forum_config['o_redirect_delay'].';URL='.str_replace(array('<', '>', '\"'), array('&lt;', '&gt;', '&quot;'), $destination_url).'\" />';\n\t$forum_head['title'] = '<title>'.$lang_common['Redirecting'].$lang_common['Title separator'].forum_htmlencode($forum_config['o_board_title']).'</title>';\n\n\tob_start();\n\n\t// Include stylesheets\n\trequire FORUM_ROOT.'style/'.$forum_user['style'].'/'.$forum_user['style'].'.php';\n\n\t$head_temp = forum_trim(ob_get_contents());\n\t$num_temp = 0;\n\tforeach (explode(\"\\n\", $head_temp) as $style_temp)\n\t\t$forum_head['style'.$num_temp++] = $style_temp;\n\n\tob_end_clean();\n\n\t($hook = get_hook('fn_redirect_head')) ? eval($hook) : null;\n\n\t$tpl_redir = str_replace('<!-- forum_head -->', implode(\"\\n\",$forum_head), $tpl_redir);\n\tunset($forum_head);\n\n\t// END SUBST - <!-- forum_head -->\n\n\n\t// START SUBST - <!-- forum_redir_main -->\n\tob_start();\n\n?>\n<div id=\"brd-main\" class=\"main basic\">\n\n\t<div class=\"main-head\">\n\t\t<h1 class=\"hn\"><span><?php echo $message ?></span></h1>\n\t</div>\n\n\t<div class=\"main-content main-message\">\n\t\t<p><?php printf($lang_common['Forwarding info'], $forum_config['o_redirect_delay'], intval($forum_config['o_redirect_delay']) == 1 ? $lang_common['second'] : $lang_common['seconds']) ?><span> <a href=\"<?php echo $destination_url ?>\"><?php echo $lang_common['Click redirect'] ?></a></span></p>\n\t</div>\n\n</div>\n<?php\n\n\t$tpl_temp = \"\\t\".forum_trim(ob_get_contents());\n\t$tpl_redir = str_replace('<!-- forum_redir_main -->', $tpl_temp, $tpl_redir);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_redir_main -->\n\n\n\t// START SUBST - <!-- forum_debug -->\n\tif (defined('FORUM_SHOW_QUERIES'))\n\t\t$tpl_redir = str_replace('<!-- forum_debug -->', get_saved_queries(), $tpl_redir);\n\n\t// End the transaction\n\t$forum_db->end_transaction();\n\t// END SUBST - <!-- forum_debug -->\n\n\n\t// START SUBST - <!-- forum_include \"*\" -->\n\twhile (preg_match('#<!-- ?forum_include \"([^/\\\\\\\\]*?)\" ?-->#', $tpl_redir, $cur_include))\n\t{\n\t\tif (!file_exists(FORUM_ROOT.'include/user/'.$cur_include[1]))\n\t\t\terror('Unable to process user include &lt;!-- forum_include \"'.forum_htmlencode($cur_include[1]).'\" --&gt; from template redirect.tpl. There is no such file in folder /include/user/.');\n\n\t\tob_start();\n\t\tinclude FORUM_ROOT.'include/user/'.$cur_include[1];\n\t\t$tpl_temp = ob_get_contents();\n\t\t$tpl_redir = str_replace($cur_include[0], $tpl_temp, $tpl_redir);\n\t\tob_end_clean();\n\t}\n\t// END SUBST - <!-- forum_include \"*\" -->\n\n\n\t// Close the db connection (and free up any result data)\n\t$forum_db->close();\n\n\texit($tpl_redir);\n}\n\n\n// Display a simple error message\nfunction error()\n{\n\tglobal $forum_config;\n\n\tif (!headers_sent())\n\t{\n\t\t// if no HTTP responce code is set we send 503\n\t\tif (!defined('FORUM_HTTP_RESPONSE_CODE_SET'))\n\t\t\theader('HTTP/1.1 503 Service Temporarily Unavailable');\n\t\theader('Content-type: text/html; charset=utf-8');\n\t}\n\n\t/*\n\t\tParse input parameters. Possible function signatures:\n\t\terror('Error message.');\n\t\terror(__FILE__, __LINE__);\n\t\terror('Error message.', __FILE__, __LINE__);\n\t*/\n\t$num_args = func_num_args();\n\tif ($num_args == 3)\n\t{\n\t\t$message = func_get_arg(0);\n\t\t$file = func_get_arg(1);\n\t\t$line = func_get_arg(2);\n\t}\n\telse if ($num_args == 2)\n\t{\n\t\t$file = func_get_arg(0);\n\t\t$line = func_get_arg(1);\n\t}\n\telse if ($num_args == 1)\n\t\t$message = func_get_arg(0);\n\n\t// Set a default title and gzip setting if the script failed before $forum_config could be populated\n\tif (empty($forum_config))\n\t{\n\t\t$forum_config['o_board_title'] = 'PunBB';\n\t\t$forum_config['o_gzip'] = '0';\n\t}\n\n\t// Empty all output buffers and stop buffering\n\twhile (@ob_end_clean());\n\n\t// \"Restart\" output buffering if we are using ob_gzhandler (since the gzip header is already sent)\n\tif (!empty($forum_config['o_gzip']) && extension_loaded('zlib') && !empty($_SERVER['HTTP_ACCEPT_ENCODING']) && (strpos($_SERVER['HTTP_ACCEPT_ENCODING'], 'gzip') !== false || strpos($_SERVER['HTTP_ACCEPT_ENCODING'], 'deflate') !== false))\n\t\tob_start('ob_gzhandler');\n\n?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\" dir=\"ltr\">\n<head>\n<title>Error - <?php echo forum_htmlencode($forum_config['o_board_title']) ?></title>\n</head>\n<body style=\"margin: 40px; font: 85%/130% verdana, arial, sans-serif; color: #333;\">\n\n<h1>An error was encountered</h1>\n<hr />\n<?php\n\n\tif (isset($message))\n\t\techo '<p>'.$message.'</p>'.\"\\n\";\n\n\tif ($num_args > 1)\n\t{\n\t\tif (defined('FORUM_DEBUG'))\n\t\t{\n\t\t\tif (isset($file) && isset($line))\n\t\t\t\techo '<p><em>The error occurred on line '.$line.' in '.$file.'</em></p>'.\"\\n\";\n\n\t\t\t$db_error = isset($GLOBALS['forum_db']) ? $GLOBALS['forum_db']->error() : array();\n\t\t\tif (!empty($db_error['error_msg']))\n\t\t\t{\n\t\t\t\techo '<p><strong>Database reported:</strong> '.forum_htmlencode($db_error['error_msg']).(($db_error['error_no']) ? ' (Errno: '.$db_error['error_no'].')' : '').'.</p>'.\"\\n\";\n\n\t\t\t\tif ($db_error['error_sql'] != '')\n\t\t\t\t\techo '<p><strong>Failed query:</strong> <code>'.forum_htmlencode($db_error['error_sql']).'</code></p>'.\"\\n\";\n\t\t\t}\n\t\t}\n\t\telse\n\t\t\techo '<p><strong>Note:</strong> For detailed error information (necessary for troubleshooting), enable \"DEBUG mode\". To enable \"DEBUG mode\", open up the file config.php in a text editor, add a line that looks like \"define(\\'FORUM_DEBUG\\', 1);\" (without the quotation marks), and re-upload the file. Once you\\'ve solved the problem, it is recommended that \"DEBUG mode\" be turned off again (just remove the line from the file and re-upload it).</p>'.\"\\n\";\n\t}\n\n?>\n\n</body>\n</html>\n<?php\n\n\t// If a database connection was established (before this error) we close it\n\tif (isset($GLOBALS['forum_db']))\n\t\t$GLOBALS['forum_db']->close();\n\n\texit;\n}\n\n// Check the text is CAPSED\nfunction check_is_all_caps($text)\n{\n\treturn (bool)/**/(utf8_strtoupper($text) == $text && utf8_strtolower($text) != $text);\n}"], "fixing_code": ["<?php\n/**\n * Loads common functions used throughout the site.\n *\n * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org\n * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher\n * @package PunBB\n */\n\n//\n// Common helpers and forum's wrappers for PHP functions\n//\n\n// Encodes the contents of $str so that they are safe to output on an (X)HTML page\nfunction forum_htmlencode($str)\n{\n\t$return = ($hook = get_hook('fn_forum_htmlencode_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn htmlspecialchars($str, ENT_QUOTES, 'UTF-8');\n}\n\n\n// Trim whitespace including non-breaking space\nfunction forum_trim($str, $charlist = \" \\t\\n\\r\\x0b\\xc2\\xa0\")\n{\n\treturn utf8_trim($str, $charlist);\n}\n\n\n// Convert \\r\\n and \\r to \\n\nfunction forum_linebreaks($str)\n{\n\treturn str_replace(array(\"\\r\\n\", \"\\r\"), \"\\n\", $str);\n}\n\n\n// Converts the CDATA end sequence ]]> into ]]&gt;\nfunction escape_cdata($str)\n{\n\treturn str_replace(']]>', ']]&gt;', $str);\n}\n\n\n// Inserts $element into $input at $offset\n// $offset can be either a numerical offset to insert at (eg: 0 inserts at the beginning of the array)\n// or a string, which is the key that the new element should be inserted before\n// $key is optional: it's used when inserting a new key/value pair into an associative array\nfunction array_insert(&$input, $offset, $element, $key = null)\n{\n\tif ($key == null)\n\t\t$key = $offset;\n\n\t// Determine the proper offset if we're using a string\n\tif (!is_int($offset))\n\t\t$offset = array_search($offset, array_keys($input), true);\n\n\t// Out of bounds checks\n\tif ($offset > count($input))\n\t\t$offset = count($input);\n\telse if ($offset < 0)\n\t\t$offset = 0;\n\n\t$input = array_merge(array_slice($input, 0, $offset), array($key => $element), array_slice($input, $offset));\n}\n\n\n// Unset any variables instantiated as a result of register_globals being enabled\nfunction forum_unregister_globals()\n{\n\t$register_globals = @ini_get('register_globals');\n\tif ($register_globals === \"\" || $register_globals === \"0\" || strtolower($register_globals) === \"off\")\n\t\treturn;\n\n\t// Prevent script.php?GLOBALS[foo]=bar\n\tif (isset($_REQUEST['GLOBALS']) || isset($_FILES['GLOBALS']))\n\t\texit('I\\'ll have a steak sandwich and... a steak sandwich.');\n\n\t// Variables that shouldn't be unset\n\t$no_unset = array('GLOBALS', '_GET', '_POST', '_COOKIE', '_REQUEST', '_SERVER', '_ENV', '_FILES');\n\n\t// Remove elements in $GLOBALS that are present in any of the superglobals\n\t$input = array_merge($_GET, $_POST, $_COOKIE, $_SERVER, $_ENV, $_FILES, isset($_SESSION) && is_array($_SESSION) ? $_SESSION : array());\n\tforeach ($input as $k => $v)\n\t\tif (!in_array($k, $no_unset) && isset($GLOBALS[$k]))\n\t\t{\n\t\t\tunset($GLOBALS[$k]);\n\t\t\tunset($GLOBALS[$k]);\t// Double unset to circumvent the zend_hash_del_key_or_index hole in PHP <4.4.3 and <5.1.4\n\t\t}\n}\n// Removes any \"bad\" characters (characters which mess with the display of a page, are invisible, etc) from user input\nfunction forum_remove_bad_characters()\n{\n\tglobal $bad_utf8_chars;\n\n\t$bad_utf8_chars = array(\"\\0\", \"\\xc2\\xad\", \"\\xcc\\xb7\", \"\\xcc\\xb8\", \"\\xe1\\x85\\x9F\", \"\\xe1\\x85\\xA0\", \"\\xe2\\x80\\x80\", \"\\xe2\\x80\\x81\", \"\\xe2\\x80\\x82\", \"\\xe2\\x80\\x83\", \"\\xe2\\x80\\x84\", \"\\xe2\\x80\\x85\", \"\\xe2\\x80\\x86\", \"\\xe2\\x80\\x87\", \"\\xe2\\x80\\x88\", \"\\xe2\\x80\\x89\", \"\\xe2\\x80\\x8a\", \"\\xe2\\x80\\x8b\", \"\\xe2\\x80\\x8e\", \"\\xe2\\x80\\x8f\", \"\\xe2\\x80\\xaa\", \"\\xe2\\x80\\xab\", \"\\xe2\\x80\\xac\", \"\\xe2\\x80\\xad\", \"\\xe2\\x80\\xae\", \"\\xe2\\x80\\xaf\", \"\\xe2\\x81\\x9f\", \"\\xe3\\x80\\x80\", \"\\xe3\\x85\\xa4\", \"\\xef\\xbb\\xbf\", \"\\xef\\xbe\\xa0\", \"\\xef\\xbf\\xb9\", \"\\xef\\xbf\\xba\", \"\\xef\\xbf\\xbb\", \"\\xE2\\x80\\x8D\");\n\n\t($hook = get_hook('fn_remove_bad_characters_start')) ? eval($hook) : null;\n\n\tfunction _forum_remove_bad_characters($array)\n\t{\n\t\tglobal $bad_utf8_chars;\n\t\treturn is_array($array) ? array_map('_forum_remove_bad_characters', $array) : str_replace($bad_utf8_chars, '', $array);\n\t}\n\n\t$_GET = _forum_remove_bad_characters($_GET);\n\t$_POST = _forum_remove_bad_characters($_POST);\n\t$_COOKIE = _forum_remove_bad_characters($_COOKIE);\n\t$_REQUEST = _forum_remove_bad_characters($_REQUEST);\n}\n\n\n// Fix the REQUEST_URI if we can, since both IIS6 and IIS7 break it\nfunction forum_fix_request_uri()\n{\n\tif (defined('FORUM_IGNORE_REQUEST_URI'))\n\t\treturn;\n\n\tglobal $forum_config;\n\n\tif (!isset($_SERVER['REQUEST_URI']) || (isset($_SERVER['QUERY_STRING']) && !empty($_SERVER['QUERY_STRING']) && strpos($_SERVER['REQUEST_URI'], '?') === false))\n\t{\n\t\t// Workaround for a bug in IIS7\n\t\tif (isset($_SERVER['HTTP_X_ORIGINAL_URL']))\n\t\t\t$_SERVER['REQUEST_URI'] = $_SERVER['HTTP_X_ORIGINAL_URL'];\n\n\t\t// IIS6 also doesn't set REQUEST_URI, If we are using the default SEF URL scheme then we can work around it\n\t\telse if (!isset($forum_config) || $forum_config['o_sef'] == 'Default')\n\t\t{\n\t\t\t$requested_page = str_replace(array('%26', '%3D', '%2F', '%3F'), array('&', '=', '/', '?'), rawurlencode($_SERVER['PHP_SELF']));\n\t\t\t$_SERVER['REQUEST_URI'] = $requested_page.(isset($_SERVER['QUERY_STRING']) && !empty($_SERVER['QUERY_STRING']) ? '?'.$_SERVER['QUERY_STRING'] : '');\n\t\t}\n\n\t\t// Otherwise I am not aware of a work around...\n\t\telse\n\t\t\terror('The web server you are using is not correctly setting the REQUEST_URI variable. This usually means you are using IIS6, or an unpatched IIS7. Please either disable SEF URLs, upgrade to IIS7 and install any available patches or try a different web server.');\n\t}\n}\n// Set a cookie, PunBB style!\n// Like other headers, cookies must be sent before any output from your script.\n// Use headers_sent() to ckeck wether HTTP headers has been sent already.\nfunction forum_setcookie($name, $value, $expire)\n{\n\tglobal $cookie_path, $cookie_domain, $cookie_secure;\n\n\t$return = ($hook = get_hook('fn_forum_setcookie_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Enable sending of a P3P header\n\theader('P3P: CP=\"CUR ADM\"');\n\n\tif (version_compare(PHP_VERSION, '5.2.0', '>='))\n\t\tsetcookie($name, $value, $expire, $cookie_path, $cookie_domain, $cookie_secure, true);\n\telse\n\t\tsetcookie($name, $value, $expire, $cookie_path.'; HttpOnly', $cookie_domain, $cookie_secure);\n}\n\n\n// Attempts to fetch the provided URL using any available means\nfunction get_remote_file($url, $timeout, $head_only = false, $max_redirects = 10)\n{\n\t$result = null;\n\t$parsed_url = parse_url($url);\n\t$allow_url_fopen = strtolower(@ini_get('allow_url_fopen'));\n\n\t// Quite unlikely that this will be allowed on a shared host, but it can't hurt\n\tif (function_exists('ini_set'))\n\t\t@ini_set('default_socket_timeout', $timeout);\n\n\t// If we have cURL, we might as well use it\n\tif (function_exists('curl_init'))\n\t{\n\t\t// Setup the transfer\n\t\t$ch = curl_init();\n\t\tcurl_setopt($ch, CURLOPT_URL, $url);\n\t\tcurl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_0);\n\t\tcurl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\n\t\tcurl_setopt($ch, CURLOPT_HEADER, true);\n\t\tcurl_setopt($ch, CURLOPT_NOBODY, $head_only);\n\t\tcurl_setopt($ch, CURLOPT_TIMEOUT, $timeout);\n\t\tcurl_setopt($ch, CURLOPT_USERAGENT, 'PunBB');\n\n\t\t// Grab the page\n\t\t$content = @curl_exec($ch);\n\t\t$responce_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);\n\t\tcurl_close($ch);\n\n\t\t// Process 301/302 redirect\n\t\tif ($content !== false && ($responce_code == '301' || $responce_code == '302') && $max_redirects > 0)\n\t\t{\n\t\t\t$headers = explode(\"\\r\\n\", trim($content));\n\t\t\tforeach ($headers as $header)\n\t\t\t\tif (substr($header, 0, 10) == 'Location: ')\n\t\t\t\t{\n\t\t\t\t\t$responce = get_remote_file(substr($header, 10), $timeout, $head_only, $max_redirects - 1);\n\t\t\t\t\tif ($responce !== null)\n\t\t\t\t\t\t$responce['headers'] = array_merge($headers, $responce['headers']);\n\t\t\t\t\treturn $responce;\n\t\t\t\t}\n\t\t}\n\n\t\t// Ignore everything except a 200 response code\n\t\tif ($content !== false && $responce_code == '200')\n\t\t{\n\t\t\tif ($head_only)\n\t\t\t\t$result['headers'] = explode(\"\\r\\n\", str_replace(\"\\r\\n\\r\\n\", \"\\r\\n\", trim($content)));\n\t\t\telse\n\t\t\t{\n\t\t\t\tpreg_match('#HTTP/1.[01] 200 OK#', $content, $match, PREG_OFFSET_CAPTURE);\n\t\t\t\t$last_content = substr($content, $match[0][1]);\n\t\t\t\t$content_start = strpos($last_content, \"\\r\\n\\r\\n\");\n\t\t\t\tif ($content_start !== false)\n\t\t\t\t{\n\t\t\t\t\t$result['headers'] = explode(\"\\r\\n\", str_replace(\"\\r\\n\\r\\n\", \"\\r\\n\", substr($content, 0, $match[0][1] + $content_start)));\n\t\t\t\t\t$result['content'] = substr($last_content, $content_start + 4);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// fsockopen() is the second best thing\n\telse if (function_exists('fsockopen'))\n\t{\n\t\t$remote = @fsockopen($parsed_url['host'], !empty($parsed_url['port']) ? intval($parsed_url['port']) : 80, $errno, $errstr, $timeout);\n\t\tif ($remote)\n\t\t{\n\t\t\t// Send a standard HTTP 1.0 request for the page\n\t\t\tfwrite($remote, ($head_only ? 'HEAD' : 'GET').' '.(!empty($parsed_url['path']) ? $parsed_url['path'] : '/').(!empty($parsed_url['query']) ? '?'.$parsed_url['query'] : '').' HTTP/1.0'.\"\\r\\n\");\n\t\t\tfwrite($remote, 'Host: '.$parsed_url['host'].\"\\r\\n\");\n\t\t\tfwrite($remote, 'User-Agent: PunBB'.\"\\r\\n\");\n\t\t\tfwrite($remote, 'Connection: Close'.\"\\r\\n\\r\\n\");\n\n\t\t\tstream_set_timeout($remote, $timeout);\n\t\t\t$stream_meta = stream_get_meta_data($remote);\n\n\t\t\t// Fetch the response 1024 bytes at a time and watch out for a timeout\n\t\t\t$content = false;\n\t\t\twhile (!feof($remote) && !$stream_meta['timed_out'])\n\t\t\t{\n\t\t\t\t$content .= fgets($remote, 1024);\n\t\t\t\t$stream_meta = stream_get_meta_data($remote);\n\t\t\t}\n\n\t\t\tfclose($remote);\n\n\t\t\t// Process 301/302 redirect\n\t\t\tif ($content !== false && $max_redirects > 0 && preg_match('#^HTTP/1.[01] 30[12]#', $content))\n\t\t\t{\n\t\t\t\t$headers = explode(\"\\r\\n\", trim($content));\n\t\t\t\tforeach ($headers as $header)\n\t\t\t\t\tif (substr($header, 0, 10) == 'Location: ')\n\t\t\t\t\t{\n\t\t\t\t\t\t$responce = get_remote_file(substr($header, 10), $timeout, $head_only, $max_redirects - 1);\n\t\t\t\t\t\tif ($responce !== null)\n\t\t\t\t\t\t\t$responce['headers'] = array_merge($headers, $responce['headers']);\n\t\t\t\t\t\treturn $responce;\n\t\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Ignore everything except a 200 response code\n\t\t\tif ($content !== false && preg_match('#^HTTP/1.[01] 200 OK#', $content))\n\t\t\t{\n\t\t\t\tif ($head_only)\n\t\t\t\t\t$result['headers'] = explode(\"\\r\\n\", trim($content));\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$content_start = strpos($content, \"\\r\\n\\r\\n\");\n\t\t\t\t\tif ($content_start !== false)\n\t\t\t\t\t{\n\t\t\t\t\t\t$result['headers'] = explode(\"\\r\\n\", substr($content, 0, $content_start));\n\t\t\t\t\t\t$result['content'] = substr($content, $content_start + 4);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// Last case scenario, we use file_get_contents provided allow_url_fopen is enabled (any non 200 response results in a failure)\n\telse if (in_array($allow_url_fopen, array('on', 'true', '1')))\n\t{\n\t\t// PHP5's version of file_get_contents() supports stream options\n\t\tif (version_compare(PHP_VERSION, '5.0.0', '>='))\n\t\t{\n\t\t\t// Setup a stream context\n\t\t\t$stream_context = stream_context_create(\n\t\t\t\tarray(\n\t\t\t\t\t'http' => array(\n\t\t\t\t\t\t'method'\t\t=> $head_only ? 'HEAD' : 'GET',\n\t\t\t\t\t\t'user_agent'\t=> 'PunBB',\n\t\t\t\t\t\t'max_redirects'\t=> $max_redirects + 1,\t// PHP >=5.1.0 only\n\t\t\t\t\t\t'timeout'\t\t=> $timeout\t// PHP >=5.2.1 only\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\n\t\t\t$content = @file_get_contents($url, false, $stream_context);\n\t\t}\n\t\telse\n\t\t\t$content = @file_get_contents($url);\n\n\t\t// Did we get anything?\n\t\tif ($content !== false)\n\t\t{\n\t\t\t// Gotta love the fact that $http_response_header just appears in the global scope (*cough* hack! *cough*)\n\t\t\t$result['headers'] = $http_response_header;\n\t\t\tif (!$head_only)\n\t\t\t\t$result['content'] = $content;\n\t\t}\n\t}\n\n\treturn $result;\n}\n\n\n// Clean version string from trailing '.0's\nfunction clean_version($version)\n{\n\treturn preg_replace('/(\\.0)+(?!\\.)|(\\.0+$)/', '$2', $version);\n}\n\n\n// Dump contents of variable(s) for debug\nfunction forum_dump()\n{\n\techo '<pre>';\n\n\t$num_args = func_num_args();\n\n\tfor ($i = 0; $i < $num_args; ++$i)\n\t{\n\t\tprint_r(func_get_arg($i));\n\t\techo \"\\n\\n\";\n\t}\n\n\techo '</pre>';\n\texit;\n}\n\n\n//\n// Markup helpers\n//\n\n// A wrapper for PHP's number_format function\nfunction forum_number_format($number, $decimals = 0)\n{\n\tglobal $lang_common;\n\n\t$return = ($hook = get_hook('fn_forum_number_format_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn number_format($number, $decimals, $lang_common['lang_decimal_point'], $lang_common['lang_thousands_sep']);\n}\n\n\n// Format a time string according to $date_format, $time_format, and timezones\ndefine('FORUM_FT_DATETIME', 0);\ndefine('FORUM_FT_DATE', 1);\ndefine('FORUM_FT_TIME', 2);\nfunction format_time($timestamp, $type = FORUM_FT_DATETIME, $date_format = null, $time_format = null, $no_text = false)\n{\n\tglobal $forum_config, $lang_common, $forum_user, $forum_time_formats, $forum_date_formats;\n\n\t$return = ($hook = get_hook('fn_format_time_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($timestamp == '')\n\t\treturn ($no_text ? '' : $lang_common['Never']);\n\n\tif ($date_format == null)\n\t\t$date_format = $forum_date_formats[$forum_user['date_format']];\n\n\tif ($time_format == null)\n\t\t$time_format = $forum_time_formats[$forum_user['time_format']];\n\n\t$diff = ($forum_user['timezone'] + $forum_user['dst']) * 3600;\n\t$timestamp += $diff;\n\t$now = time();\n\n\t$formatted_time = '';\n\n\tif ($type == FORUM_FT_DATETIME || $type == FORUM_FT_DATE)\n\t{\n\t\t$formatted_time = gmdate($date_format, $timestamp);\n\n\t\tif (!$no_text)\n\t\t{\n\t\t\t$base = gmdate('Y-m-d', $timestamp);\n\t\t\t$today = gmdate('Y-m-d', $now + $diff);\n\t\t\t$yesterday = gmdate('Y-m-d', $now + $diff - 86400);\n\n\t\t\tif ($base == $today)\n\t\t\t\t$formatted_time = $lang_common['Today'];\n\t\t\telse if ($base == $yesterday)\n\t\t\t\t$formatted_time = $lang_common['Yesterday'];\n\t\t}\n\t}\n\n\tif ($type == FORUM_FT_DATETIME)\n\t\t$formatted_time .= ' ';\n\n\tif ($type == FORUM_FT_DATETIME || $type == FORUM_FT_TIME)\n\t\t$formatted_time .= gmdate($time_format, $timestamp);\n\n\t($hook = get_hook('fn_format_time_end')) ? eval($hook) : null;\n\n\treturn $formatted_time;\n}\n\n\n\n// Generate the \"navigator\" that appears at the top of every page\nfunction generate_navlinks()\n{\n\tglobal $forum_config, $lang_common, $forum_url, $forum_user;\n\n\t$return = ($hook = get_hook('fn_generate_navlinks_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// Index should always be displayed\n\t$links['index'] = '<li id=\"navindex\"'.((FORUM_PAGE == 'index') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['index']).'\">'.$lang_common['Index'].'</a></li>';\n\n\tif ($forum_user['g_read_board'] == '1' && $forum_user['g_view_users'] == '1')\n\t\t$links['userlist'] = '<li id=\"navuserlist\"'.((FORUM_PAGE == 'userlist') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['users']).'\">'.$lang_common['User list'].'</a></li>';\n\n\tif ($forum_config['o_rules'] == '1' && (!$forum_user['is_guest'] || $forum_user['g_read_board'] == '1' || $forum_config['o_regs_allow'] == '1'))\n\t\t$links['rules'] = '<li id=\"navrules\"'.((FORUM_PAGE == 'rules') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['rules']).'\">'.$lang_common['Rules'].'</a></li>';\n\n\tif ($forum_user['is_guest'])\n\t{\n\t\tif ($forum_user['g_read_board'] == '1' && $forum_user['g_search'] == '1')\n\t\t\t$links['search'] = '<li id=\"navsearch\"'.((FORUM_PAGE == 'search') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['search']).'\">'.$lang_common['Search'].'</a></li>';\n\n\t\t$links['register'] = '<li id=\"navregister\"'.((FORUM_PAGE == 'register') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['register']).'\">'.$lang_common['Register'].'</a></li>';\n\t\t$links['login'] = '<li id=\"navlogin\"'.((FORUM_PAGE == 'login') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['login']).'\">'.$lang_common['Login'].'</a></li>';\n\t}\n\telse\n\t{\n\t\tif (!$forum_user['is_admmod'])\n\t\t{\n\t\t\tif ($forum_user['g_read_board'] == '1' && $forum_user['g_search'] == '1')\n\t\t\t\t$links['search'] = '<li id=\"navsearch\"'.((FORUM_PAGE == 'search') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['search']).'\">'.$lang_common['Search'].'</a></li>';\n\n\t\t\t$links['profile'] = '<li id=\"navprofile\"'.((substr(FORUM_PAGE, 0, 7) == 'profile') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['user'], $forum_user['id']).'\">'.$lang_common['Profile'].'</a></li>';\n\t\t\t$links['logout'] = '<li id=\"navlogout\"><a href=\"'.forum_link($forum_url['logout'], array($forum_user['id'], generate_form_token('logout'.$forum_user['id']))).'\">'.$lang_common['Logout'].'</a></li>';\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$links['search'] = '<li id=\"navsearch\"'.((FORUM_PAGE == 'search') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['search']).'\">'.$lang_common['Search'].'</a></li>';\n\t\t\t$links['profile'] = '<li id=\"navprofile\"'.((substr(FORUM_PAGE, 0, 7) == 'profile') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['user'], $forum_user['id']).'\">'.$lang_common['Profile'].'</a></li>';\n\t\t\t$links['logout'] = '<li id=\"navlogout\"><a href=\"'.forum_link($forum_url['logout'], array($forum_user['id'], generate_form_token('logout'.$forum_user['id']))).'\">'.$lang_common['Logout'].'</a></li>';\n\t\t\t$links['admin'] = '<li id=\"navadmin\"'.((substr(FORUM_PAGE, 0, 5) == 'admin') ? ' class=\"isactive\"' : '').'><a href=\"'.forum_link($forum_url['admin_index']).'\">'.$lang_common['Admin'].'</a></li>';\n\t\t}\n\t}\n\n\t// Are there any additional navlinks we should insert into the array before imploding it?\n\tif ($forum_config['o_additional_navlinks'] != '' && preg_match_all('#([0-9]+)\\s*=\\s*(.*?)\\n#s', $forum_config['o_additional_navlinks'].\"\\n\", $extra_links))\n\t{\n\t\t// Insert any additional links into the $links array (at the correct index)\n\t\t$num_links = count($extra_links[1]);\n\t\tfor ($i = 0; $i < $num_links; ++$i)\n\t\t\tarray_insert($links, (int)$extra_links[1][$i], '<li id=\"navextra'.($i + 1).'\">'.$extra_links[2][$i].'</li>');\n\t}\n\n\t($hook = get_hook('fn_generate_navlinks_end')) ? eval($hook) : null;\n\n\treturn implode(\"\\n\\t\\t\", $links);\n}\n\n\n// Outputs markup to display a user's avatar\nfunction generate_avatar_markup($user_id)\n{\n\tglobal $forum_config, $base_url;\n\n\t$filetypes = array('jpg', 'gif', 'png');\n\t$avatar_markup = '';\n\n\t$return = ($hook = get_hook('fn_generate_avatar_markup_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tforeach ($filetypes as $cur_type)\n\t{\n\t\t$path = $forum_config['o_avatars_dir'].'/'.$user_id.'.'.$cur_type;\n\n\t\tif (file_exists(FORUM_ROOT.$path) && $img_size = @getimagesize(FORUM_ROOT.$path))\n\t\t{\n\t\t\t$avatar_markup = '<img src=\"'.$base_url.'/'.$path.'\" '.$img_size[3].' alt=\"\" />';\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_generate_avatar_markup_end')) ? eval($hook) : null;\n\n\treturn $avatar_markup;\n}\n\n\n// Generate breadcrumb navigation\nfunction generate_crumbs($reverse)\n{\n\tglobal $lang_common, $forum_url, $forum_config, $forum_page;\n\n\t$return = ($hook = get_hook('fn_generate_crumbs_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif (empty($forum_page['crumbs']))\n\t\t$forum_page['crumbs'][0] = $forum_config['o_board_title'];\n\n\t$crumbs = '';\n\t$num_crumbs = count($forum_page['crumbs']);\n\n\tif ($reverse)\n\t{\n\t\tfor ($i = ($num_crumbs - 1); $i >= 0; --$i)\n\t\t\t$crumbs .= (is_array($forum_page['crumbs'][$i]) ? forum_htmlencode($forum_page['crumbs'][$i][0]) : forum_htmlencode($forum_page['crumbs'][$i])).((isset($forum_page['page']) && $i == ($num_crumbs - 1)) ? ' ('.$lang_common['Page'].' '.forum_number_format($forum_page['page']).')' : '').($i > 0 ? $lang_common['Title separator'] : '');\n\t}\n\telse\n\t\tfor ($i = 0; $i < $num_crumbs; ++$i)\n\t\t{\n\t\t\tif ($i < ($num_crumbs - 1))\n\t\t\t\t$crumbs .= '<span class=\"crumb'.(($i == 0) ? ' crumbfirst' : '').'\">'.(($i >= 1) ? '<span>'.$lang_common['Crumb separator'].'</span>' : '').(is_array($forum_page['crumbs'][$i]) ? '<a href=\"'.$forum_page['crumbs'][$i][1].'\">'.forum_htmlencode($forum_page['crumbs'][$i][0]).'</a>' : forum_htmlencode($forum_page['crumbs'][$i])).'</span> ';\n\t\t\telse\n\t\t\t\t$crumbs .= '<span class=\"crumb crumblast'.(($i == 0) ? ' crumbfirst' : '').'\">'.(($i >= 1) ? '<span>'.$lang_common['Crumb separator'].'</span>' : '').(is_array($forum_page['crumbs'][$i]) ? '<a href=\"'.$forum_page['crumbs'][$i][1].'\">'.forum_htmlencode($forum_page['crumbs'][$i][0]).'</a>' : forum_htmlencode($forum_page['crumbs'][$i])).'</span> ';\n\t\t}\n\n\t($hook = get_hook('fn_generate_crumbs_end')) ? eval($hook) : null;\n\n\treturn $crumbs;\n}\n\n\n\n// Generate a string with page and item information for multipage headings\nfunction generate_items_info($label, $first, $total)\n{\n\tglobal $forum_page, $lang_common;\n\n\t$return = ($hook = get_hook('fn_generate_page_info_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($forum_page['num_pages'] == 1)\n\t\t$item_info =  '<span class=\"item-info\">'.sprintf($lang_common['Item info single'], $label, forum_number_format($total)).'</span>';\n\telse\n\t\t$item_info = '<span class=\"item-info\">'.sprintf($lang_common['Item info plural'], $label, forum_number_format($first), forum_number_format($forum_page['finish_at']), forum_number_format($total)).'</span>';\n\n\t($hook = get_hook('fn_generate_page_info_end')) ? eval($hook) : null;\n\n\treturn $item_info;\n}\n\n\n// Generate a string with numbered links (for multipage scripts)\nfunction paginate($num_pages, $cur_page, $link, $separator, $args = null, $is_default_scheme = null)\n{\n\tglobal $forum_url, $lang_common;\n\n\tif ($is_default_scheme == null)\n\t\t$forum_url_page = $forum_url['page'];\n\telse\n\t{\n\t\t$forum_url_page = '&amp;p=$1';\n\t\tunset($forum_url['insertion_find']);\n\t}\n\n\t$pages = array();\n\t$link_to_all = false;\n\n\t$return = ($hook = get_hook('fn_paginate_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// If $cur_page == -1, we link to all pages (used in viewforum.php)\n\tif ($cur_page == -1)\n\t{\n\t\t$cur_page = 1;\n\t\t$link_to_all = true;\n\t}\n\n\tif ($num_pages <= 1)\n\t\t$pages = array('<strong class=\"first-item\">'.forum_number_format(1).'</strong>');\n\telse\n\t{\n\t\t// Add a previous page link\n\t\tif ($num_pages > 1 && $cur_page > 1)\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\"' : '').' href=\"'.forum_sublink($link, $forum_url_page, ($cur_page - 1), $args).'\">'.$lang_common['Previous'].'</a>';\n\n\t\tif ($cur_page > 3)\n\t\t{\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\"' : '').' href=\"'.forum_sublink($link, $forum_url_page, 1, $args).'\">'.forum_number_format(1).'</a>';\n\n\t\t\tif ($cur_page > 5)\n\t\t\t\t$pages[] = '<span>'.$lang_common['Spacer'].'</span>';\n\t\t}\n\n\t\t// Don't ask me how the following works. It just does, OK? :-)\n\t\tfor ($current = ($cur_page == 5) ? $cur_page - 3 : $cur_page - 2, $stop = ($cur_page + 4 == $num_pages) ? $cur_page + 4 : $cur_page + 3; $current < $stop; ++$current)\n\t\t\tif ($current < 1 || $current > $num_pages)\n\t\t\t\tcontinue;\n\t\t\telse if ($current != $cur_page || $link_to_all)\n\t\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\" ' : '').' href=\"'.forum_sublink($link, $forum_url_page, $current, $args).'\">'.forum_number_format($current).'</a>';\n\t\t\telse\n\t\t\t\t$pages[] = '<strong'.(empty($pages) ? ' class=\"first-item\"' : '').'>'.forum_number_format($current).'</strong>';\n\n\t\tif ($cur_page <= ($num_pages-3))\n\t\t{\n\t\t\tif ($cur_page != ($num_pages-3) && $cur_page != ($num_pages-4))\n\t\t\t\t$pages[] = '<span>'.$lang_common['Spacer'].'</span>';\n\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\" ' : '').' href=\"'.forum_sublink($link, $forum_url_page, $num_pages, $args).'\">'.forum_number_format($num_pages).'</a>';\n\t\t}\n\n\t\t// Add a next page link\n\t\tif ($num_pages > 1 && !$link_to_all && $cur_page < $num_pages)\n\t\t\t$pages[] = '<a'.(empty($pages) ? ' class=\"first-item\" ' : '').' href=\"'.forum_sublink($link, $forum_url_page, ($cur_page + 1), $args).'\">'.$lang_common['Next'].'</a>';\n\t}\n\n\t($hook = get_hook('fn_paginate_end')) ? eval($hook) : null;\n\n\treturn implode($separator, $pages);\n}\n\n\n// Display executed queries (if enabled) for debug\nfunction get_saved_queries()\n{\n\tglobal $forum_db, $lang_common;\n\n\t// Get the queries so that we can print them out\n\t$saved_queries = $forum_db->get_saved_queries();\n\n\tob_start();\n\n?>\n<div id=\"brd-debug\" class=\"main\">\n\n\t<div class=\"main-head\">\n\t\t<h2 class=\"hn\"><span><?php echo $lang_common['Debug table'] ?></span></h2>\n\t</div>\n\n\t<div class=\"main-content debug\">\n\t\t<table cellspacing=\"0\" summary=\"<?php echo $lang_common['Debug summary'] ?>\">\n\t\t\t<thead>\n\t\t\t\t<tr>\n\t\t\t\t\t<th class=\"tcl\" scope=\"col\"><?php echo $lang_common['Query times'] ?></th>\n\t\t\t\t\t<th class=\"tcr\" scope=\"col\"><?php echo $lang_common['Query'] ?></th>\n\t\t\t\t</tr>\n\t\t\t</thead>\n\t\t\t<tbody>\n<?php\n\n\t$query_time_total = 0.0;\n\tforeach ($saved_queries as $cur_query)\n\t{\n\t\t$query_time_total += $cur_query[1];\n\n?>\n\t\t\t\t<tr>\n\t\t\t\t\t<td class=\"tcl\"><?php echo (($cur_query[1] != 0) ? forum_number_format($cur_query[1], 5) : '&#160;') ?></td>\n\t\t\t\t\t<td class=\"tcr\"><?php echo forum_htmlencode($cur_query[0]) ?></td>\n\t\t\t\t</tr>\n<?php\n\n\t}\n\n?>\n\t\t\t\t<tr class=\"totals\">\n\t\t\t\t\t<td class=\"tcl\"><em><?php echo forum_number_format($query_time_total, 5) ?></em></td>\n\t\t\t\t\t<td class=\"tcr\"><em><?php echo $lang_common['Total query time'] ?></em></td>\n\t\t\t\t</tr>\n\t\t\t</tbody>\n\t\t</table>\n\t</div>\n</div>\n<?php\n\n\treturn ob_get_clean();\n}\n\n\n//\n// Other special helpers\n//\n\n// Return all code blocks that hook into $hook_id\nfunction get_hook($hook_id)\n{\n\tglobal $forum_hooks;\n\n\treturn !defined('FORUM_DISABLE_HOOKS') && isset($forum_hooks[$hook_id]) ? implode(\"\\n\", $forum_hooks[$hook_id]) : false;\n}\n\n// Generate a hyperlink with parameters and anchor\nfunction forum_link($link, $args = null)\n{\n\tglobal $forum_config, $base_url;\n\n\t$return = ($hook = get_hook('fn_forum_link_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$gen_link = $link;\n\tif ($args == null)\n\t\t$gen_link = $base_url.'/'.$link;\n\telse if (!is_array($args))\n\t\t$gen_link = $base_url.'/'.str_replace('$1', $args, $link);\n\telse\n\t{\n\t\tfor ($i = 0; isset($args[$i]); ++$i)\n\t\t\t$gen_link = str_replace('$'.($i + 1), $args[$i], $gen_link);\n\t\t$gen_link = $base_url.'/'.$gen_link;\n\t}\n\n\t($hook = get_hook('fn_forum_link_end')) ? eval($hook) : null;\n\n\treturn $gen_link;\n}\n\n\n// Generate a hyperlink with parameters and anchor and a subsection such as a subpage\nfunction forum_sublink($link, $sublink, $subarg, $args = null)\n{\n\tglobal $forum_config, $forum_url, $base_url;\n\n\t$return = ($hook = get_hook('fn_forum_sublink_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($sublink == $forum_url['page'] && $subarg == 1)\n\t\treturn forum_link($link, $args);\n\n\t$gen_link = $link;\n\tif (!is_array($args) && $args != null)\n\t\t$gen_link = str_replace('$1', $args, $link);\n\telse\n\t{\n\t\tfor ($i = 0; isset($args[$i]); ++$i)\n\t\t\t$gen_link = str_replace('$'.($i + 1), $args[$i], $gen_link);\n\t}\n\n\tif (isset($forum_url['insertion_find']))\n\t\t$gen_link = $base_url.'/'.str_replace($forum_url['insertion_find'], str_replace('$1', str_replace('$1', $subarg, $sublink), $forum_url['insertion_replace']), $gen_link);\n\telse\n\t\t$gen_link = $base_url.'/'.$gen_link.str_replace('$1', $subarg, $sublink);\n\n\t($hook = get_hook('fn_forum_sublink_end')) ? eval($hook) : null;\n\n\treturn $gen_link;\n}\n// Make a string safe to use in a URL\nfunction sef_friendly($str)\n{\n\tglobal $forum_config, $forum_user;\n\tstatic $lang_url_replace, $forum_reserved_strings;\n\n\tif (!isset($lang_url_replace))\n\t\trequire FORUM_ROOT.'lang/'.$forum_user['language'].'/url_replace.php';\n\n\tif (!isset($forum_reserved_strings))\n\t{\n\t\t// Bring in any reserved strings\n\t\tif (file_exists(FORUM_ROOT.'include/url/'.$forum_config['o_sef'].'/reserved_strings.php'))\n\t\t\trequire FORUM_ROOT.'include/url/'.$forum_config['o_sef'].'/reserved_strings.php';\n\t\telse\n\t\t\trequire FORUM_ROOT.'include/url/Default/reserved_strings.php';\n\t}\n\n\t$return = ($hook = get_hook('fn_sef_friendly_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$str = strtr($str, $lang_url_replace);\n\t$str = strtolower(utf8_decode($str));\n\t$str = forum_trim(preg_replace(array('/[^a-z0-9\\s]/', '/[\\s]+/'), array('', '-'), $str), '-');\n\n\tforeach ($forum_reserved_strings as $match => $replace)\n\t\tif ($str == $match)\n\t\t\treturn $replace;\n\t\telse if ($match != '')\n\t\t\t$str = str_replace($match, $replace, $str);\n\n\treturn $str;\n}\n\n\n// Replace censored words in $text\nfunction censor_words($text)\n{\n\tglobal $forum_db;\n\tstatic $search_for, $replace_with;\n\n\t$return = ($hook = get_hook('fn_censor_words_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// If not already loaded in a previous call, load the cached censors\n\tif (!defined('FORUM_CENSORS_LOADED'))\n\t{\n\t\tif (file_exists(FORUM_CACHE_DIR.'cache_censors.php'))\n\t\t\tinclude FORUM_CACHE_DIR.'cache_censors.php';\n\n\t\tif (!defined('FORUM_CENSORS_LOADED'))\n\t\t{\n\t\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\t\tgenerate_censors_cache();\n\t\t\trequire FORUM_CACHE_DIR.'cache_censors.php';\n\t\t}\n\n\t\t$search_for = array();\n\t\t$replace_with = array();\n\n\t\tforeach ($forum_censors as $censor_key => $cur_word)\n\t\t{\n\t\t\t$search_for[$censor_key] = '/(?<=\\W)('.str_replace('\\*', '\\w*?', preg_quote($cur_word['search_for'], '/')).')(?=\\W)/iu';\n\t\t\t$replace_with[$censor_key] = $cur_word['replace_with'];\n\n\t\t\t($hook = get_hook('fn_censor_words_setup_regex')) ? eval($hook) : null;\n\t\t}\n\t}\n\n\tif (!empty($search_for))\n\t\t$text = utf8_substr(preg_replace($search_for, $replace_with, ' '.$text.' '), 1, -1);\n\n\treturn $text;\n}\n\n\n// Verifies that the provided username is OK for insertion into the database\nfunction validate_username($username, $exclude_id = null)\n{\n\tglobal $lang_common, $lang_register, $lang_profile, $forum_config;\n\n\t$errors = array();\n\n\t$return = ($hook = get_hook('fn_validate_username_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// Convert multiple whitespace characters into one (to prevent people from registering with indistinguishable usernames)\n\t$username = preg_replace('#\\s+#s', ' ', $username);\n\n\t// Validate username\n\tif (utf8_strlen($username) < 2)\n\t\t$errors[] = $lang_profile['Username too short'];\n\telse if (utf8_strlen($username) > 25)\n\t\t$errors[] = $lang_profile['Username too long'];\n\telse if (strtolower($username) == 'guest' || utf8_strtolower($username) == utf8_strtolower($lang_common['Guest']))\n\t\t$errors[] = $lang_profile['Username guest'];\n\telse if (preg_match('/[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}/', $username) || preg_match('/((([0-9A-Fa-f]{1,4}:){7}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}:[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){5}:([0-9A-Fa-f]{1,4}:)?[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){4}:([0-9A-Fa-f]{1,4}:){0,2}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){3}:([0-9A-Fa-f]{1,4}:){0,3}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){2}:([0-9A-Fa-f]{1,4}:){0,4}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}((\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b)\\.){3}(\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b))|(([0-9A-Fa-f]{1,4}:){0,5}:((\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b)\\.){3}(\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b))|(::([0-9A-Fa-f]{1,4}:){0,5}((\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b)\\.){3}(\\b((25[0-5])|(1\\d{2})|(2[0-4]\\d)|(\\d{1,2}))\\b))|([0-9A-Fa-f]{1,4}::([0-9A-Fa-f]{1,4}:){0,5}[0-9A-Fa-f]{1,4})|(::([0-9A-Fa-f]{1,4}:){0,6}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){1,7}:))/', $username))\n\t\t$errors[] = $lang_profile['Username IP'];\n\telse if ((strpos($username, '[') !== false || strpos($username, ']') !== false) && strpos($username, '\\'') !== false && strpos($username, '\"') !== false)\n\t\t$errors[] = $lang_profile['Username reserved chars'];\n\telse if (preg_match('/(?:\\[\\/?(?:b|u|i|h|colou?r|quote|code|img|url|email|list)\\]|\\[(?:code|quote|list)=)/i', $username))\n\t\t$errors[] = $lang_profile['Username BBCode'];\n\n\t// Check username for any censored words\n\tif ($forum_config['o_censoring'] == '1' && censor_words($username) != $username)\n\t\t$errors[] = $lang_profile['Username censor'];\n\n\t// Check for username dupe\n\t$dupe = check_username_dupe($username, $exclude_id);\n\tif ($dupe !== false)\n\t\t$errors[] = sprintf($lang_profile['Username dupe'], forum_htmlencode($dupe));\n\n\t($hook = get_hook('fn_validate_username_end')) ? eval($hook) : null;\n\n\treturn $errors;\n}\n\n\n\n\n// Determines the correct title for $user\n// $user must contain the elements 'username', 'title', 'posts', 'g_id' and 'g_user_title'\nfunction get_title($user)\n{\n\tglobal $forum_db, $forum_config, $forum_bans, $lang_common;\n\tstatic $ban_list, $forum_ranks;\n\n\t$return = ($hook = get_hook('fn_get_title_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// If not already built in a previous call, build an array of lowercase banned usernames\n\tif (empty($ban_list))\n\t{\n\t\t$ban_list = array();\n\n\t\tforeach ($forum_bans as $cur_ban)\n\t\t\t$ban_list[] = utf8_strtolower($cur_ban['username']);\n\t}\n\n\t// If not already loaded in a previous call, load the cached ranks\n\tif ($forum_config['o_ranks'] == '1' && !defined('FORUM_RANKS_LOADED'))\n\t{\n\t\tif (file_exists(FORUM_CACHE_DIR.'cache_ranks.php'))\n\t\t\tinclude FORUM_CACHE_DIR.'cache_ranks.php';\n\n\t\tif (!defined('FORUM_RANKS_LOADED'))\n\t\t{\n\t\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\t\tgenerate_ranks_cache();\n\t\t\trequire FORUM_CACHE_DIR.'cache_ranks.php';\n\t\t}\n\t}\n\n\t// If the user has a custom title\n\tif ($user['title'] != '')\n\t\t$user_title = forum_htmlencode($forum_config['o_censoring'] == '1' ? censor_words($user['title']) : $user['title']);\n\t// If the user is banned\n\telse if (in_array(utf8_strtolower($user['username']), $ban_list))\n\t\t$user_title = $lang_common['Banned'];\n\t// If the user group has a default user title\n\telse if ($user['g_user_title'] != '')\n\t\t$user_title = forum_htmlencode($user['g_user_title']);\n\t// If the user is a guest\n\telse if ($user['g_id'] == FORUM_GUEST)\n\t\t$user_title = $lang_common['Guest'];\n\telse\n\t{\n\t\t// Are there any ranks?\n\t\tif ($forum_config['o_ranks'] == '1' && !empty($forum_ranks))\n\t\t\tforeach ($forum_ranks as $cur_rank)\n\t\t\t\tif (intval($user['num_posts']) >= $cur_rank['min_posts'])\n\t\t\t\t\t$user_title = forum_htmlencode($cur_rank['rank']);\n\n\t\t// If the user didn't \"reach\" any rank (or if ranks are disabled), we assign the default\n\t\tif (!isset($user_title))\n\t\t\t$user_title = $lang_common['Member'];\n\t}\n\n\t($hook = get_hook('fn_get_title_end')) ? eval($hook) : null;\n\n\treturn $user_title;\n}\n\n\n// Return a list of all URL schemes installed\nfunction get_scheme_packs()\n{\n  \t$schemes = array();\n\n\tif($handle = opendir(FORUM_ROOT.'include/url'))\n\t{\n\t\twhile (false !== ($dirname = readdir($handle)))\n\t\t{\n\t\t\t$dirname =  FORUM_ROOT.'include/url/'.$dirname;\n\t\t\tif (is_dir($dirname) && file_exists($dirname.'/forum_urls.php'))\n\t\t\t\t$schemes[] = basename($dirname);\n\t\t}\n\t\tclosedir($handle);\n\t}\n\n\t($hook = get_hook('fn_get_scheme_packs_end')) ? eval($hook) : null;\n\n\treturn $schemes;\n}\n\n\n// Return a list of all styles installed\nfunction get_style_packs()\n{\n\t$styles = array();\n\n\tif($handle = opendir(FORUM_ROOT.'style'))\n\t{\n\t\twhile (false !== ($dirname = readdir($handle)))\n\t\t{\n\t\t\t$dirname =  FORUM_ROOT.'style/'.$dirname;\n\t\t\t$tempname = basename($dirname);\n\t\t\tif (is_dir($dirname) && file_exists($dirname.'/'.$tempname.'.php'))\n\t\t\t\t$styles[] = $tempname;\n\t\t}\n\t\tclosedir($handle);\n\t}\n\n\t($hook = get_hook('fn_get_style_packs_end')) ? eval($hook) : null;\n\n\treturn $styles;\n}\n\n\n// Return a list of all language packs installed\nfunction get_language_packs()\n{\n\t$languages = array();\n\n\tif($handle = opendir(FORUM_ROOT.'lang'))\n\t{\n\t\twhile (false !== ($dirname = readdir($handle)))\n\t\t{\n\t\t\t$dirname =  FORUM_ROOT.'lang/'.$dirname;\n\t\t\tif (is_dir($dirname) && file_exists($dirname.'/common.php'))\n\t\t\t\t$languages[] = basename($dirname);\n\t\t}\n\t\tclosedir($handle);\n\t}\n\n\t($hook = get_hook('fn_get_language_packs_end')) ? eval($hook) : null;\n\n\treturn $languages;\n}\n\n\n// Try to determine the correct remote IP-address\nfunction get_remote_address()\n{\n\t$return = ($hook = get_hook('fn_get_remote_address_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn $_SERVER['REMOTE_ADDR'];\n}\n\n\n// Try to determine the current URL\nfunction get_current_url($max_length = 0)\n{\n\t$return = ($hook = get_hook('fn_get_current_url_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$protocol = (!isset($_SERVER['HTTPS']) || strtolower($_SERVER['HTTPS']) == 'off') ? 'http://' : 'https://';\n\t$port = (isset($_SERVER['SERVER_PORT']) && (($_SERVER['SERVER_PORT'] != '80' && $protocol == 'http://') || ($_SERVER['SERVER_PORT'] != '443' && $protocol == 'https://')) && strpos($_SERVER['HTTP_HOST'], ':') === false) ? ':'.$_SERVER['SERVER_PORT'] : '';\n\n\t$url = $protocol.$_SERVER['HTTP_HOST'].$port.$_SERVER['REQUEST_URI'];\n\n\tif (strlen($url) <= $max_length || $max_length == 0)\n\t\treturn $url;\n\n\t// We can't find a short enough url\n\treturn null;\n}\n// Checks if a word is a valid searchable word\nfunction validate_search_word($word)\n{\n\tglobal $forum_user;\n\tstatic $stopwords;\n\n\t$return = ($hook = get_hook('fn_validate_search_word_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif (!isset($stopwords))\n\t{\n\t\tif (file_exists(FORUM_ROOT.'lang/'.$forum_user['language'].'/stopwords.txt'))\n\t\t{\n\t\t\t$stopwords = file(FORUM_ROOT.'lang/'.$forum_user['language'].'/stopwords.txt');\n\t\t\t$stopwords = array_map('forum_trim', $stopwords);\n\t\t\t$stopwords = array_filter($stopwords);\n\t\t}\n\t\telse\n\t\t\t$stopwords = array();\n\n\t\t($hook = get_hook('fn_validate_search_word_modify_stopwords')) ? eval($hook) : null;\n\t}\n\n\t$num_chars = utf8_strlen($word);\n\n\t$return = ($hook = get_hook('fn_validate_search_word_end')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn $num_chars >= FORUM_SEARCH_MIN_WORD && $num_chars <= FORUM_SEARCH_MAX_WORD && !in_array($word, $stopwords);\n}\n\n\n// Generate a random key of length $len\nfunction random_key($len, $readable = false, $hash = false)\n{\n\t$key = '';\n\n\t$return = ($hook = get_hook('fn_random_key_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\tif ($hash)\n\t\t$key = substr(sha1(uniqid(rand(), true)), 0, $len);\n\telse if ($readable)\n\t{\n\t\t$chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n\n\t\tfor ($i = 0; $i < $len; ++$i)\n\t\t\t$key .= substr($chars, (mt_rand() % strlen($chars)), 1);\n\t}\n\telse\n\t\tfor ($i = 0; $i < $len; ++$i)\n\t\t\t$key .= chr(mt_rand(33, 126));\n\n\t($hook = get_hook('fn_random_key_end')) ? eval($hook) : null;\n\n\treturn $key;\n}\n\n\n// Generates a valid CSRF token for use when submitting a form to $target_url\n// $target_url should be an absolute URL and it should be exactly the URL that the user is going to\n// Alternately, if the form token is going to be used in GET (which would mean the token is going to be\n// a part of the URL itself), $target_url may be a plain string containing information related to the URL.\nfunction generate_form_token($target_url)\n{\n\tglobal $forum_user;\n\n\t$return = ($hook = get_hook('fn_generate_form_token_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn sha1(str_replace('&amp;', '&', $target_url).$forum_user['csrf_token']);\n}\n\n\n// Generates a salted, SHA-1 hash of $str\nfunction forum_hash($str, $salt)\n{\n\t$return = ($hook = get_hook('fn_forum_hash_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\treturn sha1($salt.sha1($str));\n}\n// Delete every .php file in the forum's cache directory\nfunction forum_clear_cache()\n{\n\t$return = ($hook = get_hook('fn_forum_clear_cache_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t$d = dir(FORUM_CACHE_DIR);\n\twhile (($entry = $d->read()) !== false)\n\t{\n\t\tif (substr($entry, strlen($entry)-4) == '.php')\n\t\t\t@unlink(FORUM_CACHE_DIR.$entry);\n\t}\n\t$d->close();\n}\n\n\n//\n// General forum specific functions\n//\n\n// Authenticates the provided username and password against the user database\n// $user can be either a user ID (integer) or a username (string)\n// $password can be either a plaintext password or a password hash including salt ($password_is_hash must be set accordingly)\nfunction authenticate_user($user, $password, $password_is_hash = false)\n{\n\tglobal $forum_db, $forum_user;\n\n\t$return = ($hook = get_hook('fn_authenticate_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Check if there's a user matching $user and $password\n\t$query = array(\n\t\t'SELECT'\t=> 'u.*, g.*, o.logged, o.idle, o.csrf_token, o.prev_url',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'online AS o',\n\t\t\t\t'ON'\t\t\t=> 'o.user_id=u.id'\n\t\t\t)\n\t\t)\n\t);\n\n\t// Are we looking for a user ID or a username?\n\t$query['WHERE'] = is_int($user) ? 'u.id='.intval($user) : 'u.username=\\''.$forum_db->escape($user).'\\'';\n\n\t($hook = get_hook('fn_authenticate_user_qr_get_user')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$forum_user = $forum_db->fetch_assoc($result);\n\n\tif (!isset($forum_user['id']) ||\n\t\t($password_is_hash && $password != $forum_user['password']) ||\n\t\t(!$password_is_hash && forum_hash($password, $forum_user['salt']) != $forum_user['password']))\n\t\tset_default_user();\n\n\t($hook = get_hook('fn_authenticate_user_end')) ? eval($hook) : null;\n}\n\n\n// Attempt to login with the user ID and password hash from the cookie\nfunction cookie_login(&$forum_user)\n{\n\tglobal $forum_db, $db_type, $forum_config, $cookie_name, $cookie_path, $cookie_domain, $cookie_secure, $forum_time_formats, $forum_date_formats;\n\n\t$now = time();\n\t$expire = $now + 1209600;\t// The cookie expires after 14 days\n\n\t// We assume it's a guest\n\t$cookie = array('user_id' => 1, 'password_hash' => 'Guest', 'expiration_time' => 0, 'expire_hash' => 'Guest');\n\n\t$return = ($hook = get_hook('fn_cookie_login_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// If a cookie is set, we get the user_id and password hash from it\n\tif (!empty($_COOKIE[$cookie_name]))\n\t{\n\t\t$cookie_data = explode('|', base64_decode($_COOKIE[$cookie_name]));\n\n\t\tif (!empty($cookie_data) && count($cookie_data) == 4)\n\t\t\tlist($cookie['user_id'], $cookie['password_hash'], $cookie['expiration_time'], $cookie['expire_hash']) = $cookie_data;\n\t}\n\n\t($hook = get_hook('fn_cookie_login_fetch_cookie')) ? eval($hook) : null;\n\n\t// If this a cookie for a logged in user and it shouldn't have already expired\n\tif (intval($cookie['user_id']) > 1 && intval($cookie['expiration_time']) > $now)\n\t{\n\t\tauthenticate_user(intval($cookie['user_id']), $cookie['password_hash'], true);\n\n\t\t// We now validate the cookie hash\n\t\tif ($cookie['expire_hash'] !== sha1($forum_user['salt'].$forum_user['password'].forum_hash(intval($cookie['expiration_time']), $forum_user['salt'])))\n\t\t\tset_default_user();\n\n\t\t// If we got back the default user, the login failed\n\t\tif ($forum_user['id'] == '1')\n\t\t{\n\t\t\tforum_setcookie($cookie_name, base64_encode('1|'.random_key(8, false, true).'|'.$expire.'|'.random_key(8, false, true)), $expire);\n\t\t\treturn;\n\t\t}\n\n\t\t// Send a new, updated cookie with a new expiration timestamp\n\t\t$expire = (intval($cookie['expiration_time']) > $now + $forum_config['o_timeout_visit']) ? $now + 1209600 : $now + $forum_config['o_timeout_visit'];\n\t\tforum_setcookie($cookie_name, base64_encode($forum_user['id'].'|'.$forum_user['password'].'|'.$expire.'|'.sha1($forum_user['salt'].$forum_user['password'].forum_hash($expire, $forum_user['salt']))), $expire);\n\n\t\t// Set a default language if the user selected language no longer exists\n\t\tif (!file_exists(FORUM_ROOT.'lang/'.$forum_user['language'].'/common.php'))\n\t\t\t$forum_user['language'] = $forum_config['o_default_lang'];\n\n\t\t// Set a default style if the user selected style no longer exists\n\t\tif (!file_exists(FORUM_ROOT.'style/'.$forum_user['style'].'/'.$forum_user['style'].'.php'))\n\t\t\t$forum_user['style'] = $forum_config['o_default_style'];\n\n\t\tif (!$forum_user['disp_topics'])\n\t\t\t$forum_user['disp_topics'] = $forum_config['o_disp_topics_default'];\n\t\tif (!$forum_user['disp_posts'])\n\t\t\t$forum_user['disp_posts'] = $forum_config['o_disp_posts_default'];\n\n\t\t// Check user has a valid date and time format\n\t\tif (!isset($forum_time_formats[$forum_user['time_format']]))\n\t\t\t$forum_user['time_format'] = 0;\n\t\tif (!isset($forum_date_formats[$forum_user['date_format']]))\n\t\t\t$forum_user['date_format'] = 0;\n\n\t\t// Define this if you want this visit to affect the online list and the users last visit data\n\t\tif (!defined('FORUM_QUIET_VISIT'))\n\t\t{\n\t\t\t// Update the online list\n\t\t\tif (!$forum_user['logged'])\n\t\t\t{\n\t\t\t\t$forum_user['logged'] = $now;\n\t\t\t\t$forum_user['csrf_token'] = random_key(40, false, true);\n\t\t\t\t$forum_user['prev_url'] = get_current_url(255);\n\n\t\t\t\t// REPLACE INTO avoids a user having two rows in the online table\n\t\t\t\t$query = array(\n\t\t\t\t\t'REPLACE'\t=> 'user_id, ident, logged, csrf_token',\n\t\t\t\t\t'INTO'\t\t=> 'online',\n\t\t\t\t\t'VALUES'\t=> $forum_user['id'].', \\''.$forum_db->escape($forum_user['username']).'\\', '.$forum_user['logged'].', \\''.$forum_user['csrf_token'].'\\'',\n\t\t\t\t\t'UNIQUE'\t=> 'user_id='.$forum_user['id']\n\t\t\t\t);\n\n\t\t\t\tif ($forum_user['prev_url'] != null)\n\t\t\t\t{\n\t\t\t\t\t$query['REPLACE'] .= ', prev_url';\n\t\t\t\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($forum_user['prev_url']).'\\'';\n\t\t\t\t}\n\n\t\t\t\t($hook = get_hook('fn_cookie_login_qr_add_online_user')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t// Reset tracked topics\n\t\t\t\tset_tracked_topics(null);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// Special case: We've timed out, but no other user has browsed the forums since we timed out\n\t\t\t\tif ($forum_user['logged'] < ($now-$forum_config['o_timeout_visit']))\n\t\t\t\t{\n\t\t\t\t\t$query = array(\n\t\t\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t\t\t'SET'\t\t=> 'last_visit='.$forum_user['logged'],\n\t\t\t\t\t\t'WHERE'\t\t=> 'id='.$forum_user['id']\n\t\t\t\t\t);\n\n\t\t\t\t\t($hook = get_hook('fn_cookie_login_qr_update_user_visit')) ? eval($hook) : null;\n\t\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t\t$forum_user['last_visit'] = $forum_user['logged'];\n\t\t\t\t}\n\n\t\t\t\t// Now update the logged time and save the current URL in the online list\n\t\t\t\t$query = array(\n\t\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t\t'SET'\t\t=> 'logged='.$now,\n\t\t\t\t\t'WHERE'\t\t=> 'user_id='.$forum_user['id']\n\t\t\t\t);\n\n\t\t\t\t$current_url = get_current_url(255);\n\t\t\t\tif ($current_url != null)\n\t\t\t\t\t$query['SET'] .= ', prev_url=\\''.$forum_db->escape($current_url).'\\'';\n\n\t\t\t\tif ($forum_user['idle'] == '1')\n\t\t\t\t\t$query['SET'] .= ', idle=0';\n\n\t\t\t\t($hook = get_hook('fn_cookie_login_qr_update_online_user')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t// Update tracked topics with the current expire time\n\t\t\t\tif (isset($_COOKIE[$cookie_name.'_track']))\n\t\t\t\t\tforum_setcookie($cookie_name.'_track', $_COOKIE[$cookie_name.'_track'], $now + $forum_config['o_timeout_visit']);\n\t\t\t}\n\t\t}\n\n\t\t$forum_user['is_guest'] = false;\n\t\t$forum_user['is_admmod'] = $forum_user['g_id'] == FORUM_ADMIN || $forum_user['g_moderator'] == '1';\n\t}\n\telse\n\t\tset_default_user();\n\n\t($hook = get_hook('fn_cookie_login_end')) ? eval($hook) : null;\n}\n\n\n// Fill $forum_user with default values (for guests)\nfunction set_default_user()\n{\n\tglobal $forum_db, $db_type, $forum_user, $forum_config;\n\n\t$remote_addr = get_remote_address();\n\n\t$return = ($hook = get_hook('fn_set_default_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Fetch guest user\n\t$query = array(\n\t\t'SELECT'\t=> 'u.*, g.*, o.logged, o.csrf_token, o.prev_url, o.last_post, o.last_search',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'online AS o',\n\t\t\t\t'ON'\t\t\t=> 'o.ident=\\''.$forum_db->escape($remote_addr).'\\''\n\t\t\t)\n\t\t),\n\t\t'WHERE'\t\t=> 'u.id=1'\n\t);\n\n\t($hook = get_hook('fn_set_default_user_qr_get_default_user')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tif (!$forum_db->num_rows($result))\n\t\texit('Unable to fetch guest information. The table \\''.$forum_db->prefix.'users\\' must contain an entry with id = 1 that represents anonymous users.');\n\n\t$forum_user = $forum_db->fetch_assoc($result);\n\n\tif (!defined('FORUM_QUIET_VISIT'))\n\t{\n\t\t// Update online list\n\t\tif (!$forum_user['logged'])\n\t\t{\n\t\t\t$forum_user['logged'] = time();\n\t\t\t$forum_user['csrf_token'] = random_key(40, false, true);\n\t\t\t$forum_user['prev_url'] = get_current_url(255);\n\n\t\t\t// REPLACE INTO avoids a user having two rows in the online table\n\t\t\t$query = array(\n\t\t\t\t'REPLACE'\t=> 'user_id, ident, logged, csrf_token',\n\t\t\t\t'INTO'\t\t=> 'online',\n\t\t\t\t'VALUES'\t=> '1, \\''.$forum_db->escape($remote_addr).'\\', '.$forum_user['logged'].', \\''.$forum_user['csrf_token'].'\\'',\n\t\t\t\t'UNIQUE'\t=> 'user_id=1 AND ident=\\''.$forum_db->escape($remote_addr).'\\''\n\t\t\t);\n\n\t\t\tif ($forum_user['prev_url'] != null)\n\t\t\t{\n\t\t\t\t$query['REPLACE'] .= ', prev_url';\n\t\t\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($forum_user['prev_url']).'\\'';\n\t\t\t}\n\n\t\t\t($hook = get_hook('fn_set_default_user_qr_add_online_guest_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t'SET'\t\t=> 'logged='.time(),\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape($remote_addr).'\\''\n\t\t\t);\n\n\t\t\t$current_url = get_current_url(255);\n\t\t\tif ($current_url != null)\n\t\t\t\t$query['SET'] .= ', prev_url=\\''.$forum_db->escape($current_url).'\\'';\n\n\t\t\t($hook = get_hook('fn_set_default_user_qr_update_online_guest_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t}\n\n\t$forum_user['disp_topics'] = $forum_config['o_disp_topics_default'];\n\t$forum_user['disp_posts'] = $forum_config['o_disp_posts_default'];\n\t$forum_user['timezone'] = $forum_config['o_default_timezone'];\n\t$forum_user['dst'] = $forum_config['o_default_dst'];\n\t$forum_user['language'] = $forum_config['o_default_lang'];\n\t$forum_user['style'] = $forum_config['o_default_style'];\n\t$forum_user['is_guest'] = true;\n\t$forum_user['is_admmod'] = false;\n\n\t($hook = get_hook('fn_set_default_user_end')) ? eval($hook) : null;\n}\n\n\n// Check whether the connecting user is banned (and delete any expired bans while we're at it)\nfunction check_bans()\n{\n\tglobal $forum_db, $forum_config, $lang_common, $forum_user, $forum_bans;\n\n\t$return = ($hook = get_hook('fn_check_bans_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Admins aren't affected\n\tif (defined('FORUM_ADMIN') && $forum_user['g_id'] == FORUM_ADMIN || !$forum_bans)\n\t\treturn;\n\n\t// Add a dot or a colon (depending on IPv4/IPv6) at the end of the IP address to prevent banned address\n\t// 192.168.0.5 from matching e.g. 192.168.0.50\n\t$user_ip = get_remote_address();\n\t$user_ip .= (strpos($user_ip, '.') !== false) ? '.' : ':';\n\n\t$bans_altered = false;\n\t$is_banned = false;\n\n\tforeach ($forum_bans as $cur_ban)\n\t{\n\t\t// Has this ban expired?\n\t\tif ($cur_ban['expire'] != '' && $cur_ban['expire'] <= time())\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'bans',\n\t\t\t\t'WHERE'\t\t=> 'id='.$cur_ban['id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_check_bans_qr_delete_expired_ban')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t$bans_altered = true;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif ($cur_ban['username'] != '' && utf8_strtolower($forum_user['username']) == utf8_strtolower($cur_ban['username']))\n\t\t\t$is_banned = true;\n\n\t\tif ($cur_ban['email'] != '' && $forum_user['email'] == $cur_ban['email'])\n\t\t\t$is_banned = true;\n\n\t\tif ($cur_ban['ip'] != '')\n\t\t{\n\t\t\t$cur_ban_ips = explode(' ', $cur_ban['ip']);\n\n\t\t\t$num_ips = count($cur_ban_ips);\n\t\t\tfor ($i = 0; $i < $num_ips; ++$i)\n\t\t\t{\n\t\t\t\t// Add the proper ending to the ban\n\t\t\t\tif (strpos($user_ip, '.') !== false)\n\t\t\t\t\t$cur_ban_ips[$i] = $cur_ban_ips[$i].'.';\n\t\t\t\telse\n\t\t\t\t\t$cur_ban_ips[$i] = $cur_ban_ips[$i].':';\n\n\t\t\t\tif (substr($user_ip, 0, strlen($cur_ban_ips[$i])) == $cur_ban_ips[$i])\n\t\t\t\t{\n\t\t\t\t\t$is_banned = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ($is_banned)\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'online',\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape($forum_user['username']).'\\''\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_check_bans_qr_delete_online_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\tmessage($lang_common['Ban message'].(($cur_ban['expire'] != '') ? ' '.sprintf($lang_common['Ban message 2'], format_time($cur_ban['expire'], 1, null, null, true)) : '').(($cur_ban['message'] != '') ? ' '.$lang_common['Ban message 3'].'</p><p><strong>'.forum_htmlencode($cur_ban['message']).'</strong></p>' : '</p>').'<p>'.sprintf($lang_common['Ban message 4'], '<a href=\"mailto:'.forum_htmlencode($forum_config['o_admin_email']).'\">'.forum_htmlencode($forum_config['o_admin_email']).'</a>'));\n\t\t}\n\t}\n\n\t// If we removed any expired bans during our run-through, we need to regenerate the bans cache\n\tif ($bans_altered)\n\t{\n\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\tgenerate_bans_cache();\n\t}\n}\n\n\n// Update \"Users online\"\nfunction update_users_online()\n{\n\tglobal $forum_db, $forum_config, $forum_user;\n\n\t$now = time();\n\n\t$return = ($hook = get_hook('fn_update_users_online_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Fetch all online list entries that are older than \"o_timeout_online\"\n\t$query = array(\n\t\t'SELECT'\t=> 'o.*',\n\t\t'FROM'\t\t=> 'online AS o',\n\t\t'WHERE'\t\t=> 'o.logged<'.($now-$forum_config['o_timeout_online'])\n\t);\n\n\t($hook = get_hook('fn_update_users_online_qr_get_old_online_users')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\twhile ($cur_user = $forum_db->fetch_assoc($result))\n\t{\n\t\t// If the entry is a guest, delete it\n\t\tif ($cur_user['user_id'] == '1')\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'online',\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape($cur_user['ident']).'\\''\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_update_users_online_qr_delete_online_guest_user')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// If the entry is older than \"o_timeout_visit\", update last_visit for the user in question, then delete him/her from the online list\n\t\t\tif ($cur_user['logged'] < ($now - $forum_config['o_timeout_visit']))\n\t\t\t{\n\t\t\t\t$query = array(\n\t\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t\t'SET'\t\t=> 'last_visit='.$cur_user['logged'],\n\t\t\t\t\t'WHERE'\t\t=> 'id='.$cur_user['user_id']\n\t\t\t\t);\n\n\t\t\t\t($hook = get_hook('fn_update_users_online_qr_update_user_visit')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\t\t$query = array(\n\t\t\t\t\t'DELETE'\t=> 'online',\n\t\t\t\t\t'WHERE'\t\t=> 'user_id='.$cur_user['user_id']\n\t\t\t\t);\n\n\t\t\t\t($hook = get_hook('fn_update_users_online_qr_delete_online_user')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$query = array(\n\t\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t\t'SET'\t\t=> 'idle=1',\n\t\t\t\t\t'WHERE'\t\t=> 'user_id='.$cur_user['user_id']\n\t\t\t\t);\n\n\t\t\t\t($hook = get_hook('fn_update_users_online_qr_update_user_idle')) ? eval($hook) : null;\n\t\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t\t}\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_update_users_online_end')) ? eval($hook) : null;\n}\n\n\n// Save array of tracked topics in cookie\nfunction set_tracked_topics($tracked_topics)\n{\n\tglobal $cookie_name, $cookie_path, $cookie_domain, $cookie_secure, $forum_config;\n\n\t$return = ($hook = get_hook('fn_set_tracked_topics_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t$cookie_data = '';\n\tif (!empty($tracked_topics))\n\t{\n\t\t// Sort the arrays (latest read first)\n\t\tarsort($tracked_topics['topics'], SORT_NUMERIC);\n\t\tarsort($tracked_topics['forums'], SORT_NUMERIC);\n\n\t\t// Homebrew serialization (to avoid having to run unserialize() on cookie data)\n\t\tforeach ($tracked_topics['topics'] as $id => $timestamp)\n\t\t\t$cookie_data .= 't'.$id.'='.$timestamp.';';\n\t\tforeach ($tracked_topics['forums'] as $id => $timestamp)\n\t\t\t$cookie_data .= 'f'.$id.'='.$timestamp.';';\n\n\t\t// Enforce a 4048 byte size limit (4096 minus some space for the cookie name)\n\t\tif (strlen($cookie_data) > 4048)\n\t\t{\n\t\t\t$cookie_data = substr($cookie_data, 0, 4048);\n\t\t\t$cookie_data = substr($cookie_data, 0, strrpos($cookie_data, ';')).';';\n\t\t}\n\t}\n\n\tforum_setcookie($cookie_name.'_track', $cookie_data, time() + $forum_config['o_timeout_visit']);\n\t$_COOKIE[$cookie_name.'_track'] = $cookie_data;\t// Set it directly in $_COOKIE as well\n}\n\n\n// Extract array of tracked topics from cookie\nfunction get_tracked_topics()\n{\n\tglobal $cookie_name;\n\n\t$return = ($hook = get_hook('fn_get_tracked_topics_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$cookie_data = isset($_COOKIE[$cookie_name.'_track']) ? $_COOKIE[$cookie_name.'_track'] : false;\n\tif (!$cookie_data)\n\t\treturn array('topics' => array(), 'forums' => array());\n\n\tif (strlen($cookie_data) > 4048)\n\t\treturn array('topics' => array(), 'forums' => array());\n\n\t// Unserialize data from cookie\n\t$tracked_topics = array('topics' => array(), 'forums' => array());\n\tforeach (explode(';', $cookie_data) as $id_data)\n\t{\n\t\tswitch (substr($id_data, 0, 1))\n\t\t{\n\t\t\tcase 'f': $type = 'forums'; break;\n\t\t\tcase 't': $type = 'topics'; break;\n\t\t\tdefault: continue;\n\t\t}\n\n\t\t$id = intval(substr($id_data, 1));\n\n\t\tif (($pos = strpos($id_data, '=')) === false)\n\t\t\tcontinue;\n\t\t$timestamp = intval(substr($id_data, $pos + 1));\n\n\t\tif ($id > 0 && $timestamp > 0)\n\t\t\t$tracked_topics[$type][$id] = $timestamp;\n\t}\n\n\t($hook = get_hook('fn_get_tracked_topics_end')) ? eval($hook) : null;\n\n\treturn $tracked_topics;\n}\n\n\n// Adds a new user. The username must be passed through validate_username() first.\nfunction add_user($user_info, &$new_uid)\n{\n\tglobal $forum_db, $base_url, $lang_common, $forum_config, $forum_user, $forum_url;\n\n\t$return = ($hook = get_hook('fn_add_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Add the user\n\t$query = array(\n\t\t'INSERT'\t=> 'username, group_id, password, email, email_setting, timezone, dst, language, style, registered, registration_ip, last_visit, salt, activate_key',\n\t\t'INTO'\t\t=> 'users',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($user_info['username']).'\\', '.$user_info['group_id'].', \\''.$forum_db->escape($user_info['password_hash']).'\\', \\''.$forum_db->escape($user_info['email']).'\\', '.$user_info['email_setting'].', '.floatval($user_info['timezone']).', '.$user_info['dst'].', \\''.$forum_db->escape($user_info['language']).'\\', \\''.$forum_db->escape($user_info['style']).'\\', '.$user_info['registered'].', \\''.$forum_db->escape($user_info['registration_ip']).'\\', '.$user_info['registered'].', \\''.$forum_db->escape($user_info['salt']).'\\', '.$user_info['activate_key'].''\n\t);\n\n\t($hook = get_hook('fn_add_user_qr_insert_user')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_uid = $forum_db->insert_id();\n\n\t// Must the user verify the registration?\n\tif ($user_info['require_verification'])\n\t{\n\t\t// Load the \"welcome\" template\n\t\t$mail_tpl = forum_trim(file_get_contents(FORUM_ROOT.'lang/'.$forum_user['language'].'/mail_templates/welcome.tpl'));\n\n\t\t// The first row contains the subject\n\t\t$first_crlf = strpos($mail_tpl, \"\\n\");\n\t\t$mail_subject = forum_trim(substr($mail_tpl, 8, $first_crlf-8));\n\t\t$mail_message = forum_trim(substr($mail_tpl, $first_crlf));\n\n\t\t$mail_subject = str_replace('<board_title>', $forum_config['o_board_title'], $mail_subject);\n\t\t$mail_message = str_replace('<base_url>', $base_url.'/', $mail_message);\n\t\t$mail_message = str_replace('<username>', $user_info['username'], $mail_message);\n\t\t$mail_message = str_replace('<activation_url>', str_replace('&amp;', '&', forum_link($forum_url['change_password_key'], array($new_uid, substr($user_info['activate_key'], 1, -1)))), $mail_message);\n\t\t$mail_message = str_replace('<board_mailer>', sprintf($lang_common['Forum mailer'], $forum_config['o_board_title']), $mail_message);\n\n\t\t($hook = get_hook('fn_add_user_send_verification')) ? eval($hook) : null;\n\n\t\tforum_mail($user_info['email'], $mail_subject, $mail_message);\n\t}\n\n\t// Should we alert people on the admin mailing list that a new user has registered?\n\tif ($user_info['notify_admins'] && $forum_config['o_mailing_list'] != '')\n\t{\n\t\t$mail_subject = 'Alert - New registration';\n\t\t$mail_message = 'User \\''.$user_info['username'].'\\' registered in the forums at '.$base_url.'/'.\"\\n\\n\".'User profile: '.forum_link($forum_url['user'], $new_uid).\"\\n\\n\".'-- '.\"\\n\".'Forum Mailer'.\"\\n\".'(Do not reply to this message)';\n\n\t\tforum_mail($forum_config['o_mailing_list'], $mail_subject, $mail_message);\n\t}\n\n\t($hook = get_hook('fn_add_user_end')) ? eval($hook) : null;\n}\n\n\n// Delete a user and all information associated with it\nfunction delete_user($user_id, $delete_posts = false)\n{\n\tglobal $forum_db, $db_type, $forum_config;\n\n\t$return = ($hook = get_hook('fn_delete_user_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// First we need to get some data on the user\n\t$query = array(\n\t\t'SELECT'\t=> 'u.username, u.group_id, g.g_moderator',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t)\n\t\t),\n\t\t'WHERE'\t\t=> 'u.id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_get_user_data')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$user = $forum_db->fetch_assoc($result);\n\n\t// Delete any subscriptions\n\t$query = array(\n\t\t'DELETE'\t=> 'subscriptions',\n\t\t'WHERE'\t\t=> 'user_id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_delete_subscriptions')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Remove him/her from the online list (if they happen to be logged in)\n\t$query = array(\n\t\t'DELETE'\t=> 'online',\n\t\t'WHERE'\t\t=> 'user_id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_delete_online')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Should we delete all posts made by this user?\n\tif ($delete_posts)\n\t{\n\t\t@set_time_limit(0);\n\n\t\t// Find all posts made by this user\n\t\t$query = array(\n\t\t\t'SELECT'\t=> 'p.id, p.topic_id, t.forum_id, t.first_post_id',\n\t\t\t'FROM'\t\t=> 'posts AS p',\n\t\t\t'JOINS'\t\t=> array(\n\t\t\t\tarray(\n\t\t\t\t\t'INNER JOIN'\t=> 'topics AS t',\n\t\t\t\t\t'ON'\t\t\t=> 't.id=p.topic_id'\n\t\t\t\t)\n\t\t\t),\n\t\t\t'WHERE'\t\t=> 'p.poster_id='.$user_id\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_user_qr_get_user_posts')) ? eval($hook) : null;\n\t\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\twhile ($cur_post = $forum_db->fetch_assoc($result))\n\t\t{\n\t\t\tif ($cur_post['first_post_id'] == $cur_post['id'])\n\t\t\t\tdelete_topic($cur_post['topic_id'], $cur_post['forum_id']);\n\t\t\telse\n\t\t\t\tdelete_post($cur_post['id'], $cur_post['topic_id'], $cur_post['forum_id']);\n\t\t}\n\t}\n\telse\n\t{\n\t\t// Set all his/her posts to guest\n\t\t$query = array(\n\t\t\t'UPDATE'\t=> 'posts',\n\t\t\t'SET'\t\t=> 'poster_id=1',\n\t\t\t'WHERE'\t\t=> 'poster_id='.$user_id\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_user_qr_reset_user_posts')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// Delete the user\n\t$query = array(\n\t\t'DELETE'\t=> 'users',\n\t\t'WHERE'\t\t=> 'id='.$user_id\n\t);\n\n\t($hook = get_hook('fn_delete_user_qr_delete_user')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Delete user avatar\n\tdelete_avatar($user_id);\n\n\t// If the user is a moderator or an administrator, we remove him/her from the moderator list in all forums\n\t// and regenerate the bans cache (in case he/she created any bans)\n\tif ($user['group_id'] == FORUM_ADMIN || $user['g_moderator'] == '1')\n\t{\n\t\tclean_forum_moderators();\n\n\t\t// Regenerate the bans cache\n\t\tif (!defined('FORUM_CACHE_FUNCTIONS_LOADED'))\n\t\t\trequire FORUM_ROOT.'include/cache.php';\n\n\t\tgenerate_bans_cache();\n\t}\n\n\t($hook = get_hook('fn_delete_user_end')) ? eval($hook) : null;\n}\n\n\n// Check if a username is occupied\nfunction check_username_dupe($username, $exclude_id = null)\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_check_username_dupe_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t$query = array(\n\t\t'SELECT'\t=> 'u.username',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'WHERE'\t\t=> '(UPPER(username)=UPPER(\\''.$forum_db->escape($username).'\\') OR UPPER(username)=UPPER(\\''.$forum_db->escape(preg_replace('/[^\\w]/u', '', $username)).'\\')) AND id>1'\n\t);\n\n\tif ($exclude_id)\n\t\t$query['WHERE'] .= ' AND id!='.$exclude_id;\n\n\t($hook = get_hook('fn_check_username_dupe_qr_check_username_dupe')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\treturn $forum_db->num_rows($result) ? $forum_db->result($result) : false;\n}\n\n\n// Deletes any avatars owned by the specified user ID\nfunction delete_avatar($user_id)\n{\n\tglobal $forum_config;\n\n\t$filetypes = array('jpg', 'gif', 'png');\n\n\t$return = ($hook = get_hook('fn_delete_avatar_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Delete user avatar\n\tforeach ($filetypes as $cur_type)\n\t\t@unlink(FORUM_ROOT.$forum_config['o_avatars_dir'].'/'.$user_id.'.'.$cur_type);\n\n}\n\n\n// Creates a new topic with its first post\nfunction add_topic($post_info, &$new_tid, &$new_pid)\n{\n\tglobal $forum_db, $db_type, $forum_config, $lang_common;\n\n\t$return = ($hook = get_hook('fn_add_topic_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Add the topic\n\t$query = array(\n\t\t'INSERT'\t=> 'poster, subject, posted, last_post, last_poster, forum_id',\n\t\t'INTO'\t\t=> 'topics',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($post_info['poster']).'\\', \\''.$forum_db->escape($post_info['subject']).'\\', '.$post_info['posted'].', '.$post_info['posted'].', \\''.$forum_db->escape($post_info['poster']).'\\', '.$post_info['forum_id']\n\t);\n\n\t($hook = get_hook('fn_add_topic_qr_add_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_tid = $forum_db->insert_id();\n\n\t// To subscribe or not to subscribe, that ...\n\tif (!$post_info['is_guest'] && $post_info['subscribe'])\n\t{\n\t\t$query = array(\n\t\t\t'INSERT'\t=> 'user_id, topic_id',\n\t\t\t'INTO'\t\t=> 'subscriptions',\n\t\t\t'VALUES'\t=> $post_info['poster_id'].' ,'.$new_tid\n\t\t);\n\n\t\t($hook = get_hook('fn_add_topic_qr_add_subscription')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// Create the post (\"topic post\")\n\t$query = array(\n\t\t'INSERT'\t=> 'poster, poster_id, poster_ip, message, hide_smilies, posted, topic_id',\n\t\t'INTO'\t\t=> 'posts',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($post_info['poster']).'\\', '.$post_info['poster_id'].', \\''.$forum_db->escape(get_remote_address()).'\\', \\''.$forum_db->escape($post_info['message']).'\\', '.$post_info['hide_smilies'].', '.$post_info['posted'].', '.$new_tid\n\t);\n\n\t// If it's a guest post, there might be an e-mail address we need to include\n\tif ($post_info['is_guest'] && $post_info['poster_email'] != null)\n\t{\n\t\t$query['INSERT'] .= ', poster_email';\n\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($post_info['poster_email']).'\\'';\n\t}\n\n\t($hook = get_hook('fn_add_topic_qr_add_topic_post')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_pid = $forum_db->insert_id();\n\n\t// Update the topic with last_post_id and first_post_id\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'last_post_id='.$new_pid.', first_post_id='.$new_pid,\n\t\t'WHERE'\t\t=> 'id='.$new_tid\n\t);\n\n\t($hook = get_hook('fn_add_topic_qr_update_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\trequire FORUM_ROOT.'include/search_idx.php';\n\n\tupdate_search_index('post', $new_pid, $post_info['message'], $post_info['subject']);\n\n\tsync_forum($post_info['forum_id']);\n\n\t// Increment user's post count & last post time\n\tif (isset($post_info['update_user']) && $post_info['update_user'])\n\t{\n\t\tif ($post_info['is_guest'])\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t'SET'\t\t=> 'last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape(get_remote_address()).'\\''\n\t\t\t);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t'SET'\t\t=> 'num_posts=num_posts+1, last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'id='.$post_info['poster_id']\n\t\t\t);\n\t\t}\n\n\t\t($hook = get_hook('fn_add_topic_qr_update_last_post')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// If the posting user is logged in update his/her unread indicator\n\tif (!$post_info['is_guest'] && isset($post_info['update_unread']) && $post_info['update_unread'])\n\t{\n\t\t$tracked_topics = get_tracked_topics();\n\t\t$tracked_topics['topics'][$new_tid] = time();\n\t\tset_tracked_topics($tracked_topics);\n\t}\n\n\t($hook = get_hook('fn_add_topic_end')) ? eval($hook) : null;\n}\n\n\n// Delete a topic and all of it's posts\nfunction delete_topic($topic_id, $forum_id)\n{\n\tglobal $forum_db, $db_type;\n\n\t$return = ($hook = get_hook('fn_delete_topic_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Create an array of forum IDs that need to be synced\n\t$forum_ids = array($forum_id);\n\t$query = array(\n\t\t'SELECT'\t=> 't.forum_id',\n\t\t'FROM'\t\t=> 'topics AS t',\n\t\t'WHERE'\t\t=> 't.moved_to='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_get_forums_to_sync')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\twhile ($row = $forum_db->fetch_row($result))\n\t\t$forum_ids[] = $row[0];\n\n\t// Delete the topic and any redirect topics\n\t$query = array(\n\t\t'DELETE'\t=> 'topics',\n\t\t'WHERE'\t\t=> 'id='.$topic_id.' OR moved_to='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_delete_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t// Create a list of the post ID's in this topic\n\t$query = array(\n\t\t'SELECT'\t=> 'p.id',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_get_posts_to_delete')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t$post_ids = array();\n\twhile ($row = $forum_db->fetch_row($result))\n\t\t$post_ids[] = $row[0];\n\n\t// Make sure we have a list of post ID's\n\tif (!empty($post_ids))\n\t{\n\t\t// Delete posts in topic\n\t\t$query = array(\n\t\t\t'DELETE'\t=> 'posts',\n\t\t\t'WHERE'\t\t=> 'topic_id='.$topic_id\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_topic_qr_delete_topic_posts')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\t\trequire_once FORUM_ROOT.'include/search_idx.php';\n\n\t\tstrip_search_index($post_ids);\n\t}\n\n\t// Delete any subscriptions for this topic\n\t$query = array(\n\t\t'DELETE'\t=> 'subscriptions',\n\t\t'WHERE'\t\t=> 'topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_delete_topic_qr_delete_topic_subscriptions')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tforeach ($forum_ids as $cur_forum_id)\n\t\tsync_forum($cur_forum_id);\n\n\t($hook = get_hook('fn_delete_topic_end')) ? eval($hook) : null;\n}\n\n\n// Locate and delete any orphaned redirect topics\nfunction delete_orphans()\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_delete_orphans_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Locate any orphaned redirect topics\n\t$query = array(\n\t\t'SELECT'\t=> 't1.id',\n\t\t'FROM'\t\t=> 'topics AS t1',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'topics AS t2',\n\t\t\t\t'ON'\t\t\t=> 't1.moved_to=t2.id'\n\t\t\t)\n\t\t),\n\t\t'WHERE'\t\t=> 't2.id IS NULL AND t1.moved_to IS NOT NULL'\n\t);\n\n\t($hook = get_hook('fn_delete_orphans_qr_get_orphans')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_orphans = $forum_db->num_rows($result);\n\n\tif ($num_orphans)\n\t{\n\t\tfor ($i = 0; $i < $num_orphans; ++$i)\n\t\t\t$orphans[] = $forum_db->result($result, $i);\n\n\t\t// Delete the orphan\n\t\t$query = array(\n\t\t\t'DELETE'\t=> 'topics',\n\t\t\t'WHERE'\t\t=> 'id IN('.implode(',', $orphans).')'\n\t\t);\n\n\t\t($hook = get_hook('fn_delete_orphans_qr_delete_orphan')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t($hook = get_hook('fn_delete_orphans_end')) ? eval($hook) : null;\n}\n\n\n// Creates a new post\nfunction add_post($post_info, &$new_pid)\n{\n\tglobal $forum_db, $db_type, $forum_config, $lang_common;\n\n\t$return = ($hook = get_hook('fn_add_post_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Add the post\n\t$query = array(\n\t\t'INSERT'\t=> 'poster, poster_id, poster_ip, message, hide_smilies, posted, topic_id',\n\t\t'INTO'\t\t=> 'posts',\n\t\t'VALUES'\t=> '\\''.$forum_db->escape($post_info['poster']).'\\', '.$post_info['poster_id'].', \\''.$forum_db->escape(get_remote_address()).'\\', \\''.$forum_db->escape($post_info['message']).'\\', '.$post_info['hide_smilies'].', '.$post_info['posted'].', '.$post_info['topic_id']\n\t);\n\n\t// If it's a guest post, there might be an e-mail address we need to include\n\tif ($post_info['is_guest'] && $post_info['poster_email'] != null)\n\t{\n\t\t$query['INSERT'] .= ', poster_email';\n\t\t$query['VALUES'] .= ', \\''.$forum_db->escape($post_info['poster_email']).'\\'';\n\t}\n\n\t($hook = get_hook('fn_add_post_qr_add_post')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$new_pid = $forum_db->insert_id();\n\n\tif (!$post_info['is_guest'])\n\t{\n\t\t// Subscribe or unsubscribe?\n\t\tif ($post_info['subscr_action'] == 1)\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'INSERT'\t=> 'user_id, topic_id',\n\t\t\t\t'INTO'\t\t=> 'subscriptions',\n\t\t\t\t'VALUES'\t=> $post_info['poster_id'].' ,'.$post_info['topic_id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_add_post_qr_add_subscription')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t\telse if ($post_info['subscr_action'] == 2)\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'DELETE'\t=> 'subscriptions',\n\t\t\t\t'WHERE'\t\t=> 'topic_id='.$post_info['topic_id'].' AND user_id='.$post_info['poster_id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_add_post_qr_delete_subscription')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t}\n\n\t// Count number of replies in the topic\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(p.id)',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$post_info['topic_id']\n\t);\n\n\t($hook = get_hook('fn_add_post_qr_get_topic_reply_count')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_replies = $forum_db->result($result, 0) - 1;\n\n\t// Update topic\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'num_replies='.$num_replies.', last_post='.$post_info['posted'].', last_post_id='.$new_pid.', last_poster=\\''.$forum_db->escape($post_info['poster']).'\\'',\n\t\t'WHERE'\t\t=> 'id='.$post_info['topic_id']\n\t);\n\n\t($hook = get_hook('fn_add_post_qr_update_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tsync_forum($post_info['forum_id']);\n\n\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\trequire FORUM_ROOT.'include/search_idx.php';\n\n\tupdate_search_index('post', $new_pid, $post_info['message']);\n\n\tsend_subscriptions($post_info, $new_pid);\n\n\t// Increment user's post count & last post time\n\tif (isset($post_info['update_user']))\n\t{\n\t\tif ($post_info['is_guest'])\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'online',\n\t\t\t\t'SET'\t\t=> 'last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'ident=\\''.$forum_db->escape(get_remote_address()).'\\''\n\t\t\t);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'users',\n\t\t\t\t'SET'\t\t=> 'num_posts=num_posts+1, last_post='.$post_info['posted'],\n\t\t\t\t'WHERE'\t\t=> 'id='.$post_info['poster_id']\n\t\t\t);\n\t\t}\n\n\t\t($hook = get_hook('fn_add_post_qr_update_last_post')) ? eval($hook) : null;\n\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t}\n\n\t// If the posting user is logged in update his/her unread indicator\n\tif (!$post_info['is_guest'] && isset($post_info['update_unread']) && $post_info['update_unread'])\n\t{\n\t\t$tracked_topics = get_tracked_topics();\n\t\t$tracked_topics['topics'][$post_info['topic_id']] = time();\n\t\tset_tracked_topics($tracked_topics);\n\t}\n\n\t($hook = get_hook('fn_add_post_end')) ? eval($hook) : null;\n}\n\n\n// Delete a single post\nfunction delete_post($post_id, $topic_id, $forum_id)\n{\n\tglobal $forum_db, $db_type;\n\n\t$return = ($hook = get_hook('fn_delete_post_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t$query = array(\n\t\t'SELECT'\t=> 'p.id, p.poster, p.posted',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id,\n\t\t'ORDER BY'\t=> 'p.id DESC',\n\t\t'LIMIT'\t\t=> '2'\n\t);\n\n\t($hook = get_hook('fn_qr_get_topic_lastposts_info')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tlist($last_id, ,) = $forum_db->fetch_row($result);\n\tlist($second_last_id, $second_poster, $second_posted) = $forum_db->fetch_row($result);\n\n\t// Delete the post\n\t$query = array(\n\t\t'DELETE'\t=> 'posts',\n\t\t'WHERE'\t\t=> 'id='.$post_id\n\t);\n\n\t($hook = get_hook('fn_delete_post_qr_delete_post')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tif (!defined('FORUM_SEARCH_IDX_FUNCTIONS_LOADED'))\n\t\trequire FORUM_ROOT.'include/search_idx.php';\n\n\tstrip_search_index($post_id);\n\n\t// Count number of replies in the topic\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(p.id)',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_qr_get_topic_reply_count2')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_replies = $forum_db->result($result, 0) - 1;\n\n\t// Update the topic now that a post has been deleted\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'num_replies='.$num_replies,\n\t\t'WHERE'\t\t=> 'id='.$topic_id\n\t);\n\n\t// If we deleted the most recent post, we need to sync up last post data as wel\n\tif ($last_id == $post_id)\n\t\t$query['SET'] .= ', last_post='.$second_posted.', last_post_id='.$second_last_id.', last_poster=\\''.$forum_db->escape($second_poster).'\\'';\n\n\t($hook = get_hook('fn_qr_update_topic2')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tsync_forum($forum_id);\n\n\t($hook = get_hook('fn_delete_post_end')) ? eval($hook) : null;\n}\n\n\n// Update posts, topics, last_post, last_post_id and last_poster for a forum\nfunction sync_forum($forum_id)\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_sync_forum_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Get topic and post count for forum\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(t.id), SUM(t.num_replies)',\n\t\t'FROM'\t\t=> 'topics AS t',\n\t\t'WHERE'\t\t=> 't.forum_id='.$forum_id\n\t);\n\n\t($hook = get_hook('fn_sync_forum_qr_get_forum_stats')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tlist($num_topics, $num_posts) = $forum_db->fetch_row($result);\n\n\t$num_posts = $num_posts + $num_topics;\t\t// $num_posts is only the sum of all replies (we have to add the topic posts)\n\n\t// Get last_post, last_post_id and last_poster for forum (if any)\n\t$query = array(\n\t\t'SELECT'\t=> 't.last_post, t.last_post_id, t.last_poster',\n\t\t'FROM'\t\t=> 'topics AS t',\n\t\t'WHERE'\t\t=> 't.forum_id='.$forum_id.' AND t.moved_to is NULL',\n\t\t'ORDER BY'\t=> 't.last_post DESC',\n\t\t'LIMIT'\t\t=> '1'\n\t);\n\n\t($hook = get_hook('fn_sync_forum_qr_get_forum_last_post_data')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tif ($forum_db->num_rows($result))\n\t{\n\t\tlist($last_post, $last_post_id, $last_poster) = $forum_db->fetch_row($result);\n\t\t$last_poster = '\\''.$forum_db->escape($last_poster).'\\'';\n\t}\n\telse\n\t\t$last_post = $last_post_id = $last_poster = 'NULL';\n\n\t// Now update the forum\n\t$query = array(\n\t\t'UPDATE'\t=> 'forums',\n\t\t'SET'\t\t=> 'num_topics='.$num_topics.', num_posts='.$num_posts.', last_post='.$last_post.', last_post_id='.$last_post_id.', last_poster='.$last_poster,\n\t\t'WHERE'\t\t=> 'id='.$forum_id\n\t);\n\n\t($hook = get_hook('fn_sync_forum_qr_update_forum')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t($hook = get_hook('fn_sync_forum_end')) ? eval($hook) : null;\n}\n\n\n// Update replies, last_post, last_post_id and last_poster for a topic\nfunction sync_topic($topic_id)\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_sync_topic_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Count number of replies in the topic\n\t$query = array(\n\t\t'SELECT'\t=> 'COUNT(p.id)',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_sync_topic_qr_get_topic_reply_count')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$num_replies = $forum_db->result($result, 0) - 1;\n\n\t// Get last_post, last_post_id and last_poster\n\t$query = array(\n\t\t'SELECT'\t=> 'p.posted, p.id, p.poster',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$topic_id,\n\t\t'ORDER BY'\t=> 'p.id DESC',\n\t\t'LIMIT'\t\t=> '1'\n\t);\n\n\t($hook = get_hook('fn_sync_topic_qr_get_topic_last_post_data')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\tlist($last_post, $last_post_id, $last_poster) = $forum_db->fetch_row($result);\n\n\t// Now update the topic\n\t$query = array(\n\t\t'UPDATE'\t=> 'topics',\n\t\t'SET'\t\t=> 'num_replies='.$num_replies.', last_post='.$last_post.', last_post_id='.$last_post_id.', last_poster=\\''.$forum_db->escape($last_poster).'\\'',\n\t\t'WHERE'\t\t=> 'id='.$topic_id\n\t);\n\n\t($hook = get_hook('fn_sync_topic_qr_update_topic')) ? eval($hook) : null;\n\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t($hook = get_hook('fn_sync_topic_end')) ? eval($hook) : null;\n}\n\n\n// Iterates through all forum moderator lists and removes any erroneous entries\nfunction clean_forum_moderators()\n{\n\tglobal $forum_db;\n\n\t$return = ($hook = get_hook('fn_clean_forum_moderators_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Get a list of forums and their respective lists of moderators\n\t$query = array(\n\t\t'SELECT'\t=> 'f.id, f.moderators',\n\t\t'FROM'\t\t=> 'forums AS f',\n\t\t'WHERE'\t\t=> 'f.moderators IS NOT NULL'\n\t);\n\n\t($hook = get_hook('fn_clean_forum_moderators_qr_get_forum_moderators')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t$removed_moderators = array();\n\twhile ($cur_forum = $forum_db->fetch_assoc($result))\n\t{\n\t\t$cur_moderators = unserialize($cur_forum['moderators']);\n\t\t$new_moderators = $cur_moderators;\n\n\t\t// Iterate through each user in the list and check if he/she is in a moderator or admin group\n\t\tforeach ($cur_moderators as $username => $user_id)\n\t\t{\n\t\t\tif (in_array($user_id, $removed_moderators))\n\t\t\t{\n\t\t\t\tunset($new_moderators[$username]);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t$query = array(\n\t\t\t\t'SELECT'\t=> '1',\n\t\t\t\t'FROM'\t\t=> 'users AS u',\n\t\t\t\t'JOINS'\t\t=> array(\n\t\t\t\t\tarray(\n\t\t\t\t\t\t'INNER JOIN'\t=> 'groups AS g',\n\t\t\t\t\t\t'ON'\t\t\t=> 'g.g_id=u.group_id'\n\t\t\t\t\t)\n\t\t\t\t),\n\t\t\t\t'WHERE'\t\t=> '(g.g_moderator=1 OR u.group_id=1) AND u.id='.$user_id\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_clean_forum_moderators_qr_check_user_in_moderator_group')) ? eval($hook) : null;\n\t\t\t$result2 = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\t\t\tif (!$forum_db->num_rows($result2))\t// If the user isn't in a moderator or admin group, remove him/her from the list\n\t\t\t{\n\t\t\t\tunset($new_moderators[$username]);\n\t\t\t\t$removed_moderators[] = $user_id;\n\t\t\t}\n\t\t}\n\n\t\t// If we changed anything, update the forum\n\t\tif ($cur_moderators != $new_moderators)\n\t\t{\n\t\t\t$new_moderators = (!empty($new_moderators)) ? '\\''.$forum_db->escape(serialize($new_moderators)).'\\'' : 'NULL';\n\n\t\t\t$query = array(\n\t\t\t\t'UPDATE'\t=> 'forums',\n\t\t\t\t'SET'\t\t=> 'moderators='.$new_moderators,\n\t\t\t\t'WHERE'\t\t=> 'id='.$cur_forum['id']\n\t\t\t);\n\n\t\t\t($hook = get_hook('fn_qr_clean_forum_moderators_set_forum_moderators')) ? eval($hook) : null;\n\t\t\t$forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_clean_forum_moderators_end')) ? eval($hook) : null;\n}\n\n\n// Send out subscription emails\nfunction send_subscriptions($post_info, $new_pid)\n{\n\tglobal $forum_config, $forum_db, $forum_url, $lang_common;\n\n\t$return = ($hook = get_hook('fn_send_subscriptions_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\tif ($forum_config['o_subscriptions'] != '1')\n\t\treturn;\n\n\t// Get the post time for the previous post in this topic\n\t$query = array(\n\t\t'SELECT'\t=> 'p.posted',\n\t\t'FROM'\t\t=> 'posts AS p',\n\t\t'WHERE'\t\t=> 'p.topic_id='.$post_info['topic_id'],\n\t\t'ORDER BY'\t=> 'p.id DESC',\n\t\t'LIMIT'\t\t=> '1, 1'\n\t);\n\n\t($hook = get_hook('fn_send_subscriptions_qr_get_previous_post_time')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\t$previous_post_time = $forum_db->result($result);\n\n\t// Get any subscribed users that should be notified (banned users are excluded)\n\t$query = array(\n\t\t'SELECT'\t=> 'u.id, u.email, u.notify_with_post, u.language',\n\t\t'FROM'\t\t=> 'users AS u',\n\t\t'JOINS'\t\t=> array(\n\t\t\tarray(\n\t\t\t\t'INNER JOIN'\t=> 'subscriptions AS s',\n\t\t\t\t'ON'\t\t\t=> 'u.id=s.user_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'forum_perms AS fp',\n\t\t\t\t'ON'\t\t\t=> '(fp.forum_id='.$post_info['forum_id'].' AND fp.group_id=u.group_id)'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'online AS o',\n\t\t\t\t'ON'\t\t\t=> 'u.id=o.user_id'\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'LEFT JOIN'\t\t=> 'bans AS b',\n\t\t\t\t'ON'\t\t\t=> 'u.username=b.username'\n\t\t\t),\n\t\t),\n\t\t'WHERE'\t\t=> 'b.username IS NULL AND COALESCE(o.logged, u.last_visit)>'.$previous_post_time.' AND (fp.read_forum IS NULL OR fp.read_forum=1) AND s.topic_id='.$post_info['topic_id'].' AND u.id!='.$post_info['poster_id']\n\t);\n\n\t($hook = get_hook('fn_send_subscriptions_qr_get_users_to_notify')) ? eval($hook) : null;\n\t$result = $forum_db->query_build($query) or error(__FILE__, __LINE__);\n\n\tif ($forum_db->num_rows($result))\n\t{\n\t\tif (!defined('FORUM_EMAIL_FUNCTIONS_LOADED'))\n\t\t\trequire FORUM_ROOT.'include/email.php';\n\n\t\t$notification_emails = array();\n\n\t\t// Loop through subscribed users and send e-mails\n\t\twhile ($cur_subscriber = $forum_db->fetch_assoc($result))\n\t\t{\n\t\t\t// Is the subscription e-mail for $cur_subscriber['language'] cached or not?\n\t\t\tif (!isset($notification_emails[$cur_subscriber['language']]) && file_exists(FORUM_ROOT.'lang/'.$cur_subscriber['language'].'/mail_templates/new_reply.tpl'))\n\t\t\t{\n\t\t\t\t// Load the \"new reply\" template\n\t\t\t\t$mail_tpl = forum_trim(file_get_contents(FORUM_ROOT.'lang/'.$cur_subscriber['language'].'/mail_templates/new_reply.tpl'));\n\n\t\t\t\t// Load the \"new reply full\" template (with post included)\n\t\t\t\t$mail_tpl_full = forum_trim(file_get_contents(FORUM_ROOT.'lang/'.$cur_subscriber['language'].'/mail_templates/new_reply_full.tpl'));\n\n\t\t\t\t// The first row contains the subject (it also starts with \"Subject:\")\n\t\t\t\t$first_crlf = strpos($mail_tpl, \"\\n\");\n\t\t\t\t$mail_subject = forum_trim(substr($mail_tpl, 8, $first_crlf-8));\n\t\t\t\t$mail_message = forum_trim(substr($mail_tpl, $first_crlf));\n\n\t\t\t\t$first_crlf = strpos($mail_tpl_full, \"\\n\");\n\t\t\t\t$mail_subject_full = forum_trim(substr($mail_tpl_full, 8, $first_crlf-8));\n\t\t\t\t$mail_message_full = forum_trim(substr($mail_tpl_full, $first_crlf));\n\n\t\t\t\t$mail_subject = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_subject);\n\t\t\t\t$mail_message = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_message);\n\t\t\t\t$mail_message = str_replace('<replier>', $post_info['poster'], $mail_message);\n\t\t\t\t$mail_message = str_replace('<post_url>', forum_link($forum_url['post'], $new_pid), $mail_message);\n\t\t\t\t$mail_message = str_replace('<unsubscribe_url>', forum_link($forum_url['unsubscribe'], array($post_info['topic_id'], generate_form_token('unsubscribe'.$post_info['topic_id'].$cur_subscriber['id']))), $mail_message);\n\t\t\t\t$mail_message = str_replace('<board_mailer>', sprintf($lang_common['Forum mailer'], $forum_config['o_board_title']), $mail_message);\n\n\t\t\t\t$mail_subject_full = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_subject_full);\n\t\t\t\t$mail_message_full = str_replace('<topic_subject>', '\\''.$post_info['subject'].'\\'', $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<replier>', $post_info['poster'], $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<message>', $post_info['message'], $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<post_url>', forum_link($forum_url['post'], $new_pid), $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<unsubscribe_url>', forum_link($forum_url['unsubscribe'], array($post_info['topic_id'], generate_form_token('unsubscribe'.$post_info['topic_id'].$cur_subscriber['id']))), $mail_message_full);\n\t\t\t\t$mail_message_full = str_replace('<board_mailer>', sprintf($lang_common['Forum mailer'], $forum_config['o_board_title']), $mail_message_full);\n\n\t\t\t\t$notification_emails[$cur_subscriber['language']][0] = $mail_subject;\n\t\t\t\t$notification_emails[$cur_subscriber['language']][1] = $mail_message;\n\t\t\t\t$notification_emails[$cur_subscriber['language']][2] = $mail_subject_full;\n\t\t\t\t$notification_emails[$cur_subscriber['language']][3] = $mail_message_full;\n\n\t\t\t\t$mail_subject = $mail_message = $mail_subject_full = $mail_message_full = null;\n\t\t\t}\n\n\t\t\t// We have to double check here because the templates could be missing\n\t\t\t// Make sure the e-mail address format is valid before sending\n\t\t\tif (isset($notification_emails[$cur_subscriber['language']]) && is_valid_email($cur_subscriber['email']))\n\t\t\t{\n\t\t\t\tif ($cur_subscriber['notify_with_post'] == '0')\n\t\t\t\t\tforum_mail($cur_subscriber['email'], $notification_emails[$cur_subscriber['language']][0], $notification_emails[$cur_subscriber['language']][1]);\n\t\t\t\telse\n\t\t\t\t\tforum_mail($cur_subscriber['email'], $notification_emails[$cur_subscriber['language']][2], $notification_emails[$cur_subscriber['language']][3]);\n\t\t\t}\n\t\t}\n\t}\n\n\t($hook = get_hook('fn_send_subscriptions_end')) ? eval($hook) : null;\n}\n\n\n//\n// Special pages\n//\n\n// Display a form that the user can use to confirm that they want to undertake an action.\n// Used when the CSRF token from the request does not match the token stored in the database.\nfunction csrf_confirm_form()\n{\n\tglobal $forum_db, $forum_url, $lang_common, $forum_config, $base_url, $forum_start, $tpl_main, $forum_user, $forum_page, $forum_updates;\n\n\t// If we've disabled the CSRF check for this page, we have nothing to do here.\n\tif (defined('FORUM_DISABLE_CSRF_CONFIRM'))\n\t\treturn;\n\n\t// User pressed the cancel button\n\tif (isset($_POST['confirm_cancel']))\n\t\tredirect(forum_htmlencode($_POST['prev_url']), $lang_common['Cancel redirect']);\n\n\t// A helper function for csrf_confirm_form. It takes a multi-dimensional array and returns it as a\n\t// single-dimensional array suitable for use in hidden fields.\n\tfunction _csrf_confirm_form($key, $values)\n\t{\n\t\t$fields = array();\n\n\t\tif (is_array($values))\n\t\t{\n\t\t\tforeach ($values as $cur_key => $cur_values)\n\t\t\t\t$fields = array_merge($fields, _csrf_confirm_form($key.'['.$cur_key.']', $cur_values));\n\n\t\t\treturn $fields;\n\t\t}\n\t\telse\n\t\t\t$fields[$key] = $values;\n\n\t\treturn $fields;\n\t}\n\n\t$return = ($hook = get_hook('fn_csrf_confirm_form_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn;\n\n\t// Setup breadcrumbs\n\t$forum_page['crumbs'] = array(\n\t\tarray($forum_config['o_board_title'], forum_link($forum_url['index'])),\n\t\t$lang_common['Confirm action']\n\t);\n\n\t$forum_page['form_action'] = get_current_url();\n\n\t$forum_page['hidden_fields'] = array(\n\t\t'csrf_token'\t=> '<input type=\"hidden\" name=\"csrf_token\" value=\"'.generate_form_token($forum_page['form_action']).'\" />',\n\t\t'prev_url'\t\t=> '<input type=\"hidden\" name=\"prev_url\" value=\"'.forum_htmlencode($forum_user['prev_url']).'\" />'\n\t);\n\n\tforeach ($_POST as $submitted_key => $submitted_val)\n\t\tif ($submitted_key != 'csrf_token' && $submitted_key != 'prev_url')\n\t\t{\n\t\t\t$hidden_fields = _csrf_confirm_form($submitted_key, $submitted_val);\n\t\t\tforeach ($hidden_fields as $field_key => $field_val)\n\t\t\t\t$forum_page['hidden_fields'][$field_key] = '<input type=\"hidden\" name=\"'.forum_htmlencode($field_key).'\" value=\"'.forum_htmlencode($field_val).'\" />';\n\t\t}\n\n\tdefine('FORUM_PAGE', 'dialogue');\n\trequire FORUM_ROOT.'header.php';\n\n\t// START SUBST - <!-- forum_main -->\n\tob_start();\n\n\t($hook = get_hook('fn_csrf_confirm_form_pre_header_load')) ? eval($hook) : null;\n\n?>\n<div id=\"brd-main\" class=\"main\">\n\t<div class=\"main-head\">\n\t\t<h2 class=\"hn\"><span><?php echo $lang_common['Confirm action head'] ?></span></h2>\n\t</div>\n\t<div class=\"main-content main-frm\">\n\t\t<div class=\"ct-box info-box\">\n\t\t\t<p><?php echo $lang_common['CSRF token mismatch'] ?></p>\n\t\t</div>\n\t\t<form class=\"frm-form\" method=\"post\" accept-charset=\"utf-8\" action=\"<?php echo forum_htmlencode($forum_page['form_action']) ?>\">\n\t\t\t<div class=\"hidden\">\n\t\t\t\t<?php echo implode(\"\\n\\t\\t\\t\\t\", $forum_page['hidden_fields']).\"\\n\" ?>\n\t\t\t</div>\n\t\t\t<div class=\"frm-buttons\">\n\t\t\t\t<span class=\"submit\"><input type=\"submit\" value=\"<?php echo $lang_common['Confirm'] ?>\" /></span>\n\t\t\t\t<span class=\"cancel\"><input type=\"submit\" name=\"confirm_cancel\" value=\"<?php echo $lang_common['Cancel'] ?>\" /></span>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n</div>\n<?php\n\n\t($hook = get_hook('fn_csrf_confirm_form_end')) ? eval($hook) : null;\n\n\t$tpl_temp = forum_trim(ob_get_contents());\n\t$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_main -->\n\n\trequire FORUM_ROOT.'footer.php';\n}\n\n\n// Display a message\nfunction message($message, $link = '', $heading = '')\n{\n\tglobal $forum_db, $forum_url, $lang_common, $forum_config, $base_url, $forum_start, $tpl_main, $forum_user, $forum_page, $forum_updates;\n\n\t($hook = get_hook('fn_message_start')) ? eval($hook) : null;\n\n\tif (!defined('FORUM_HEADER'))\n\t{\n\t\tif ($heading == '')\n\t\t\t$heading = $lang_common['Forum message'];\n\n\t\t// Setup breadcrumbs\n\t\t$forum_page['crumbs'] = array(\n\t\t\tarray($forum_config['o_board_title'], forum_link($forum_url['index'])),\n\t\t\t$lang_common['Forum message']\n\t\t);\n\n\t\t($hook = get_hook('fn_message_pre_header_load')) ? eval($hook) : null;\n\n\t\tdefine('FORUM_PAGE', 'message');\n\t\trequire FORUM_ROOT.'header.php';\n\n\t\t// START SUBST - <!-- forum_main -->\n\t\tob_start();\n\n\t\t($hook = get_hook('fn_message_output_start')) ? eval($hook) : null;\n\t}\n\n?>\n\t<div class=\"main-head\">\n<?php\n\n\tif (!empty($forum_page['main_head_options']))\n\t\techo \"\\n\\t\\t\".'<p class=\"options\">'.implode(' ', $forum_page['main_head_options']).'</p>';\n\n?>\n\t\t<h2 class=\"hn\"><span><?php echo $heading ?></span></h2>\n\t</div>\n\n\t<div class=\"main-content main-message\">\n\t\t<p><?php echo $message ?><?php if ($link != '') echo ' <span>'.$link.'</span>' ?></p>\n\t</div>\n<?php\n\n\t($hook = get_hook('fn_message_output_end')) ? eval($hook) : null;\n\n\t$tpl_temp = forum_trim(ob_get_contents());\n\t$tpl_main = str_replace('<!-- forum_main -->', \"\\t\".$tpl_temp, $tpl_main);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_main -->\n\n\trequire FORUM_ROOT.'footer.php';\n}\n\n\n\n\n// Display a message when board is in maintenance mode\nfunction maintenance_message()\n{\n\tglobal $forum_db, $forum_config, $lang_common, $forum_user, $base_url;\n\n\t$return = ($hook = get_hook('fn_maintenance_message_start')) ? eval($hook) : null;\n\tif ($return != null)\n\t\treturn $return;\n\n\t// Deal with newlines, tabs and multiple spaces\n\t$pattern = array(\"\\t\\t\", '  ', '  ');\n\t$replace = array('&#160; &#160; ', '&#160; ', ' &#160;');\n\t$message = str_replace($pattern, $replace, $forum_config['o_maintenance_message']);\n\n\t// Send the Content-type header in case the web server is setup to send something else\n\theader('Content-type: text/html; charset=utf-8');\n\n\t// Send a 503 HTTP response code to prevent search bots from indexing the maintenace message\n\theader('HTTP/1.1 503 Service Temporarily Unavailable');\n\n\t// Load the maintenance template\n\tif (file_exists(FORUM_ROOT.'style/'.$forum_user['style'].'/maintenance.tpl'))\n\t\t$tpl_path = FORUM_ROOT.'style/'.$forum_user['style'].'/maintenance.tpl';\n\telse\n\t\t$tpl_path = FORUM_ROOT.'include/template/maintenance.tpl';\n\n\t($hook = get_hook('fn_maintenance_message_pre_template_loaded')) ? eval($hook) : null;\n\n\t$tpl_maint = forum_trim(file_get_contents($tpl_path));\n\n\t($hook = get_hook('fn_maintenance_message_template_loaded')) ? eval($hook) : null;\n\n\t// START SUBST - <!-- forum_local -->\n\t$tpl_maint = str_replace('<!-- forum_local -->', 'xml:lang=\"'.$lang_common['lang_identifier'].'\" lang=\"'.$lang_common['lang_identifier'].'\" dir=\"'.$lang_common['lang_direction'].'\"', $tpl_maint);\n\t// END SUBST - <!-- forum_local -->\n\n\n\t// START SUBST - <!-- forum_head -->\n\n\tob_start();\n\n\trequire FORUM_ROOT.'style/'.$forum_user['style'].'/'.$forum_user['style'].'.php';\n\n\t$tpl_temp = forum_trim(ob_get_contents());\n\t$tpl_maint = str_replace('<!-- forum_head -->', $tpl_temp, $tpl_maint);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_head -->\n\n\n\t// START SUBST - <!-- forum_maint_main -->\n\tob_start();\n\n?>\n\t<div class=\"main-head\">\n\t\t<h1 class=\"hn\"><span><?php echo $lang_common['Maintenance mode'] ?></span></h1>\n\t</div>\n\t<div class=\"main-content main-message\">\n\t\t<div class=\"ct-box user-box\">\n\t\t\t<?php echo $message.\"\\n\" ?>\n\t\t</div>\n\t</div>\n<?php\n\n\t$tpl_temp = \"\\t\".forum_trim(ob_get_contents());\n\t$tpl_maint = str_replace('<!-- forum_maint_main -->', $tpl_temp, $tpl_maint);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_maint_main -->\n\n\n\t// End the transaction\n\t$forum_db->end_transaction();\n\n\n\t// START SUBST - <!-- forum_include \"*\" -->\n\twhile (preg_match('#<!-- ?forum_include \"([^/\\\\\\\\]*?)\" ?-->#', $tpl_maint, $cur_include))\n\t{\n\t\tif (!file_exists(FORUM_ROOT.'include/user/'.$cur_include[1]))\n\t\t\terror('Unable to process user include &lt;!-- forum_include \"'.forum_htmlencode($cur_include[1]).'\" --&gt; from template maintenance.tpl. There is no such file in folder /include/user/.');\n\n\t\tob_start();\n\t\tinclude FORUM_ROOT.'include/user/'.$cur_include[1];\n\t\t$tpl_temp = ob_get_contents();\n\t\t$tpl_maint = str_replace($cur_include[0], $tpl_temp, $tpl_maint);\n\t\tob_end_clean();\n\t}\n\t// END SUBST - <!-- forum_include \"*\" -->\n\n\n\t// Close the db connection (and free up any result data)\n\t$forum_db->close();\n\n\texit($tpl_maint);\n}\n\n\n// Display $message and redirect user to $destination_url\nfunction redirect($destination_url, $message)\n{\n\tglobal $forum_db, $forum_config, $lang_common, $forum_user, $base_url;\n\n\tdefine('FORUM_PAGE', 'redirect');\n\n\t($hook = get_hook('fn_redirect_start')) ? eval($hook) : null;\n\n\t// Prefix with base_url (unless it's there already)\n\tif (strpos($destination_url, 'http://') !== 0 && strpos($destination_url, 'https://') !== 0 && strpos($destination_url, '/') !== 0)\n\t\t$destination_url = $base_url.'/'.$destination_url;\n\n\t// Do a little spring cleaning\n\t$destination_url = preg_replace('/([\\r\\n])|(%0[ad])|(;[\\s]*data[\\s]*:)/i', '', $destination_url);\n\n\t// If the delay is 0 seconds, we might as well skip the redirect all together\n\tif ($forum_config['o_redirect_delay'] == '0')\n\t\theader('Location: '.str_replace('&amp;', '&', $destination_url));\n\n\t// Send no-cache headers\n\theader('Expires: Thu, 21 Jul 1977 07:30:00 GMT');\t// When yours truly first set eyes on this world! :)\n\theader('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT');\n\theader('Cache-Control: post-check=0, pre-check=0', false);\n\theader('Pragma: no-cache');\t\t// For HTTP/1.0 compability\n\n\t// Send the Content-type header in case the web server is setup to send something else\n\theader('Content-type: text/html; charset=utf-8');\n\n\t// Load the redirect template\n\tif (file_exists(FORUM_ROOT.'style/'.$forum_user['style'].'/redirect.tpl'))\n\t\t$tpl_path = FORUM_ROOT.'style/'.$forum_user['style'].'/redirect.tpl';\n\telse\n\t\t$tpl_path = FORUM_ROOT.'include/template/redirect.tpl';\n\n\t($hook = get_hook('fn_redirect_pre_template_loaded')) ? eval($hook) : null;\n\n\t$tpl_redir = forum_trim(file_get_contents($tpl_path));\n\n\t($hook = get_hook('fn_redirect_template_loaded')) ? eval($hook) : null;\n\n\t// START SUBST - <!-- forum_local -->\n\t$tpl_redir = str_replace('<!-- forum_local -->', 'xml:lang=\"'.$lang_common['lang_identifier'].'\" lang=\"'.$lang_common['lang_identifier'].'\" dir=\"'.$lang_common['lang_direction'].'\"', $tpl_redir);\n\t// END SUBST - <!-- forum_local -->\n\n\n\t// START SUBST - <!-- forum_head -->\n\n\t$forum_head['refresh'] = '<meta http-equiv=\"refresh\" content=\"'.$forum_config['o_redirect_delay'].';URL='.str_replace(array('<', '>', '\"'), array('&lt;', '&gt;', '&quot;'), $destination_url).'\" />';\n\t$forum_head['title'] = '<title>'.$lang_common['Redirecting'].$lang_common['Title separator'].forum_htmlencode($forum_config['o_board_title']).'</title>';\n\n\tob_start();\n\n\t// Include stylesheets\n\trequire FORUM_ROOT.'style/'.$forum_user['style'].'/'.$forum_user['style'].'.php';\n\n\t$head_temp = forum_trim(ob_get_contents());\n\t$num_temp = 0;\n\tforeach (explode(\"\\n\", $head_temp) as $style_temp)\n\t\t$forum_head['style'.$num_temp++] = $style_temp;\n\n\tob_end_clean();\n\n\t($hook = get_hook('fn_redirect_head')) ? eval($hook) : null;\n\n\t$tpl_redir = str_replace('<!-- forum_head -->', implode(\"\\n\",$forum_head), $tpl_redir);\n\tunset($forum_head);\n\n\t// END SUBST - <!-- forum_head -->\n\n\n\t// START SUBST - <!-- forum_redir_main -->\n\tob_start();\n\n?>\n<div id=\"brd-main\" class=\"main basic\">\n\n\t<div class=\"main-head\">\n\t\t<h1 class=\"hn\"><span><?php echo $message ?></span></h1>\n\t</div>\n\n\t<div class=\"main-content main-message\">\n\t\t<p><?php printf($lang_common['Forwarding info'], $forum_config['o_redirect_delay'], intval($forum_config['o_redirect_delay']) == 1 ? $lang_common['second'] : $lang_common['seconds']) ?><span> <a href=\"<?php echo $destination_url ?>\"><?php echo $lang_common['Click redirect'] ?></a></span></p>\n\t</div>\n\n</div>\n<?php\n\n\t$tpl_temp = \"\\t\".forum_trim(ob_get_contents());\n\t$tpl_redir = str_replace('<!-- forum_redir_main -->', $tpl_temp, $tpl_redir);\n\tob_end_clean();\n\t// END SUBST - <!-- forum_redir_main -->\n\n\n\t// START SUBST - <!-- forum_debug -->\n\tif (defined('FORUM_SHOW_QUERIES'))\n\t\t$tpl_redir = str_replace('<!-- forum_debug -->', get_saved_queries(), $tpl_redir);\n\n\t// End the transaction\n\t$forum_db->end_transaction();\n\t// END SUBST - <!-- forum_debug -->\n\n\n\t// START SUBST - <!-- forum_include \"*\" -->\n\twhile (preg_match('#<!-- ?forum_include \"([^/\\\\\\\\]*?)\" ?-->#', $tpl_redir, $cur_include))\n\t{\n\t\tif (!file_exists(FORUM_ROOT.'include/user/'.$cur_include[1]))\n\t\t\terror('Unable to process user include &lt;!-- forum_include \"'.forum_htmlencode($cur_include[1]).'\" --&gt; from template redirect.tpl. There is no such file in folder /include/user/.');\n\n\t\tob_start();\n\t\tinclude FORUM_ROOT.'include/user/'.$cur_include[1];\n\t\t$tpl_temp = ob_get_contents();\n\t\t$tpl_redir = str_replace($cur_include[0], $tpl_temp, $tpl_redir);\n\t\tob_end_clean();\n\t}\n\t// END SUBST - <!-- forum_include \"*\" -->\n\n\n\t// Close the db connection (and free up any result data)\n\t$forum_db->close();\n\n\texit($tpl_redir);\n}\n\n\n// Display a simple error message\nfunction error()\n{\n\tglobal $forum_config;\n\n\tif (!headers_sent())\n\t{\n\t\t// if no HTTP responce code is set we send 503\n\t\tif (!defined('FORUM_HTTP_RESPONSE_CODE_SET'))\n\t\t\theader('HTTP/1.1 503 Service Temporarily Unavailable');\n\t\theader('Content-type: text/html; charset=utf-8');\n\t}\n\n\t/*\n\t\tParse input parameters. Possible function signatures:\n\t\terror('Error message.');\n\t\terror(__FILE__, __LINE__);\n\t\terror('Error message.', __FILE__, __LINE__);\n\t*/\n\t$num_args = func_num_args();\n\tif ($num_args == 3)\n\t{\n\t\t$message = func_get_arg(0);\n\t\t$file = func_get_arg(1);\n\t\t$line = func_get_arg(2);\n\t}\n\telse if ($num_args == 2)\n\t{\n\t\t$file = func_get_arg(0);\n\t\t$line = func_get_arg(1);\n\t}\n\telse if ($num_args == 1)\n\t\t$message = func_get_arg(0);\n\n\t// Set a default title and gzip setting if the script failed before $forum_config could be populated\n\tif (empty($forum_config))\n\t{\n\t\t$forum_config['o_board_title'] = 'PunBB';\n\t\t$forum_config['o_gzip'] = '0';\n\t}\n\n\t// Empty all output buffers and stop buffering\n\twhile (@ob_end_clean());\n\n\t// \"Restart\" output buffering if we are using ob_gzhandler (since the gzip header is already sent)\n\tif (!empty($forum_config['o_gzip']) && extension_loaded('zlib') && !empty($_SERVER['HTTP_ACCEPT_ENCODING']) && (strpos($_SERVER['HTTP_ACCEPT_ENCODING'], 'gzip') !== false || strpos($_SERVER['HTTP_ACCEPT_ENCODING'], 'deflate') !== false))\n\t\tob_start('ob_gzhandler');\n\n?>\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\" dir=\"ltr\">\n<head>\n<title>Error - <?php echo forum_htmlencode($forum_config['o_board_title']) ?></title>\n</head>\n<body style=\"margin: 40px; font: 85%/130% verdana, arial, sans-serif; color: #333;\">\n\n<h1>An error was encountered</h1>\n<hr />\n<?php\n\n\tif (isset($message))\n\t\techo '<p>'.$message.'</p>'.\"\\n\";\n\n\tif ($num_args > 1)\n\t{\n\t\tif (defined('FORUM_DEBUG'))\n\t\t{\n\t\t\tif (isset($file) && isset($line))\n\t\t\t\techo '<p><em>The error occurred on line '.$line.' in '.$file.'</em></p>'.\"\\n\";\n\n\t\t\t$db_error = isset($GLOBALS['forum_db']) ? $GLOBALS['forum_db']->error() : array();\n\t\t\tif (!empty($db_error['error_msg']))\n\t\t\t{\n\t\t\t\techo '<p><strong>Database reported:</strong> '.forum_htmlencode($db_error['error_msg']).(($db_error['error_no']) ? ' (Errno: '.$db_error['error_no'].')' : '').'.</p>'.\"\\n\";\n\n\t\t\t\tif ($db_error['error_sql'] != '')\n\t\t\t\t\techo '<p><strong>Failed query:</strong> <code>'.forum_htmlencode($db_error['error_sql']).'</code></p>'.\"\\n\";\n\t\t\t}\n\t\t}\n\t\telse\n\t\t\techo '<p><strong>Note:</strong> For detailed error information (necessary for troubleshooting), enable \"DEBUG mode\". To enable \"DEBUG mode\", open up the file config.php in a text editor, add a line that looks like \"define(\\'FORUM_DEBUG\\', 1);\" (without the quotation marks), and re-upload the file. Once you\\'ve solved the problem, it is recommended that \"DEBUG mode\" be turned off again (just remove the line from the file and re-upload it).</p>'.\"\\n\";\n\t}\n\n?>\n\n</body>\n</html>\n<?php\n\n\t// If a database connection was established (before this error) we close it\n\tif (isset($GLOBALS['forum_db']))\n\t\t$GLOBALS['forum_db']->close();\n\n\texit;\n}\n\n// Check the text is CAPSED\nfunction check_is_all_caps($text)\n{\n\treturn (bool)/**/(utf8_strtoupper($text) == $text && utf8_strtolower($text) != $text);\n}"], "filenames": ["include/functions.php"], "buggy_code_start_loc": [5], "buggy_code_end_loc": [2676], "fixing_code_start_loc": [5], "fixing_code_end_loc": [2676], "type": "CWE-79", "message": "Multiple cross-site scripting (XSS) vulnerabilities in include/functions.php in PunBB before 1.3.6 allow remote attackers to inject arbitrary web script or HTML via the (1) id, (2) form_sent, (3) csrf_token, (4) req_confirm, or (5) delete parameter to delete.php, the (6) id, (7) form_sent, (8) csrf_token, (9) req_message, or (10) submit parameter to edit.php, the (11) action, (12) form_sent, (13) csrf_token, (14) req_email, or (15) request_pass parameter to login.php, the (16) email, (17) form_sent, (18) redirect_url, (19) csrf_token, (20) req_subject, (21) req_message, or (22) submit parameter to misc.php, the (23) action, (24) id, (25) form_sent, (26) csrf_token, (27) req_old_password, (28) req_new_password1, (29) req_new_password2, or (30) update parameter to profile.php, or the (31) action, (32) form_sent, (33) csrf_token, (34) req_username, (35) req_password1, (36) req_password2, (37) req_email1, (38) timezone, or (39) register parameter to register.php.", "other": {"cve": {"id": "CVE-2011-3371", "sourceIdentifier": "secalert@redhat.com", "published": "2011-10-02T20:55:01.507", "lastModified": "2012-05-18T04:00:00.000", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Multiple cross-site scripting (XSS) vulnerabilities in include/functions.php in PunBB before 1.3.6 allow remote attackers to inject arbitrary web script or HTML via the (1) id, (2) form_sent, (3) csrf_token, (4) req_confirm, or (5) delete parameter to delete.php, the (6) id, (7) form_sent, (8) csrf_token, (9) req_message, or (10) submit parameter to edit.php, the (11) action, (12) form_sent, (13) csrf_token, (14) req_email, or (15) request_pass parameter to login.php, the (16) email, (17) form_sent, (18) redirect_url, (19) csrf_token, (20) req_subject, (21) req_message, or (22) submit parameter to misc.php, the (23) action, (24) id, (25) form_sent, (26) csrf_token, (27) req_old_password, (28) req_new_password1, (29) req_new_password2, or (30) update parameter to profile.php, or the (31) action, (32) form_sent, (33) csrf_token, (34) req_username, (35) req_password1, (36) req_password2, (37) req_email1, (38) timezone, or (39) register parameter to register.php."}, {"lang": "es", "value": "Varias vulnerabilidades de cross-site scripting (XSS) en include / functions.php en PunBB antes de v1.3.6 permite a atacantes remotos inyectar secuencias de comandos web o HTML a trav\u00e9s de (1) id, (2) form_sent, (3) csrf_token, (4) req_confirm, or (5) delete parameter to delete.php, the (6) id, (7) form_sent, (8) csrf_token, (9) req_message, o (10) enviar par\u00e1metro a edit.php, la (11) acci\u00f3n, (12) form_sent, (13) csrf_token, (14) req_email, o (15)  par\u00e1metro request_pass a login.php, el (16) correo electr\u00f3nico, (17) form_sent, (18) REDIRECT_URL, (19) csrf_token, (20) req_subject, (21) req_message, o (22) enviar par\u00e1metro a misc.php, la acci\u00f3n (23), (24) id, (25) form_sent, (26) csrf_token, (27) req_old_password, (28) req_new_password1 , (29) de actualizaci\u00f3n req_new_password2, o (30) par\u00e1metro para profile.php, o la acci\u00f3n (31), (32) form_sent, (33) csrf_token, (34) req_username, (35) req_password1, (36) req_password2, (37) req_email1, (38) zona horaria, o (39) registro de par\u00e1metros para register.php."}], "metrics": {"cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:*:*:*:*:*:*:*:*", "versionEndIncluding": "1.3.5", "matchCriteriaId": "85BCDB92-3C21-4245-AD69-F672175A7E43"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:*:*:*:*:*:*:*", "matchCriteriaId": "92F62C7C-EA7A-40B2-A8A0-5FEA69DF321B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:alpha:*:*:*:*:*:*", "matchCriteriaId": "4C9B6A22-A7BD-4C31-B4BB-A3BA43F4B9FD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:beta1:*:*:*:*:*:*", "matchCriteriaId": "C80A6D72-289A-4F53-AF80-6F2697AFF2D8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:beta1a:*:*:*:*:*:*", "matchCriteriaId": "9CADED1D-A90F-485E-B9EB-8CCAA22C9FB4"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:beta2:*:*:*:*:*:*", "matchCriteriaId": "037398E0-C125-48DC-B0D8-FEE9DBEF6374"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:beta3:*:*:*:*:*:*", "matchCriteriaId": "D1E6BBD6-5EE2-4412-92E1-48401F3622C8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:rc1:*:*:*:*:*:*", "matchCriteriaId": "3BEBC325-DD6F-4DB1-84B8-86C26AC4165C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0:rc2:*:*:*:*:*:*", "matchCriteriaId": "78C47271-AED6-444B-B2E6-EF2A48B15600"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.0.1:*:*:*:*:*:*:*", "matchCriteriaId": "8827471A-6FCC-48A6-BBAA-6DC82EA42EB4"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.1:*:*:*:*:*:*:*", "matchCriteriaId": "E04494D1-FE7F-431C-8242-A0591A5D0A6A"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.1.1:*:*:*:*:*:*:*", "matchCriteriaId": "A97DA335-4815-4608-84D5-67F4E539D8F0"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.1.2:*:*:*:*:*:*:*", "matchCriteriaId": "9481F02E-2523-4599-A39D-3ACE518CEC35"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.1.3:*:*:*:*:*:*:*", "matchCriteriaId": "01C976DD-47E4-48CA-AF99-93D0653D31F0"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.1.4:*:*:*:*:*:*:*", "matchCriteriaId": "A1AAB3BF-EBFA-4F55-A3D4-0B26F749D91E"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.1.5:*:*:*:*:*:*:*", "matchCriteriaId": "7277A122-5963-4E7F-BA1A-62B19AF804EB"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2:*:*:*:*:*:*:*", "matchCriteriaId": "CEF85286-A1F8-4797-99F0-4F42B6D859CF"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.1:*:*:*:*:*:*:*", "matchCriteriaId": "05BCF8A0-5530-4B36-8CEA-5330307C74CC"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.2:*:*:*:*:*:*:*", "matchCriteriaId": "C8EDF1AE-B415-4B5B-80CD-0B96AFA21D81"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.3:*:*:*:*:*:*:*", "matchCriteriaId": "DDBA41AF-C817-476A-8ED1-57808D0B678C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.4:*:*:*:*:*:*:*", "matchCriteriaId": "C353C194-328F-4C4C-9773-F06A0FA3978C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.5:*:*:*:*:*:*:*", "matchCriteriaId": "BFE58D68-FC34-4F70-849A-2E6CC919230D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.6:*:*:*:*:*:*:*", "matchCriteriaId": "5713E747-5529-4A64-95B4-D9678D8E88B3"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.7:*:*:*:*:*:*:*", "matchCriteriaId": "9C920E92-B2AE-416D-9669-9A4FBFE0AE8D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.8:*:*:*:*:*:*:*", "matchCriteriaId": "1DFD4225-32F9-4D62-87C5-9632A1C03326"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.9:*:*:*:*:*:*:*", "matchCriteriaId": "4A75787B-6156-4710-9B24-48C5763E7771"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.10:*:*:*:*:*:*:*", "matchCriteriaId": "20A9473E-DE15-4BE2-839D-90B55F8713EB"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.11:*:*:*:*:*:*:*", "matchCriteriaId": "F4A94FF3-C732-4552-A32B-53C4739F7E52"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.12:*:*:*:*:*:*:*", "matchCriteriaId": "01063CD1-BCE0-4C0A-AE34-AC4CCFD5802B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.13:*:*:*:*:*:*:*", "matchCriteriaId": "C427E4AB-79A3-4B9E-BD73-35F8BE03B93C"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.14:*:*:*:*:*:*:*", "matchCriteriaId": "4CDCB2E5-91A9-48D8-8B98-19E770CEB1E4"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.15:*:*:*:*:*:*:*", "matchCriteriaId": "CDD30AB1-3E59-4981-9DFD-E7270D9C009E"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.16:*:*:*:*:*:*:*", "matchCriteriaId": "4546E547-54E1-4FB9-9F20-7C70B9F86BC6"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.17:*:*:*:*:*:*:*", "matchCriteriaId": "3295A0E9-854B-4AC3-B2C0-349303C54C16"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.18:*:*:*:*:*:*:*", "matchCriteriaId": "0C42BE39-C741-4A28-86C7-7EE93E3C835F"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.19:*:*:*:*:*:*:*", "matchCriteriaId": "45B97265-ACC7-4EA7-BAC3-1284445A819B"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.20:*:*:*:*:*:*:*", "matchCriteriaId": "89427CA6-7788-4FEB-801B-4B4C7311533F"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.21:*:*:*:*:*:*:*", "matchCriteriaId": "66F790FB-D4F7-4043-A593-F88580790881"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.22:*:*:*:*:*:*:*", "matchCriteriaId": "AE9DE41D-FF5A-409D-A0D0-02FC3C25716F"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.2.23:*:*:*:*:*:*:*", "matchCriteriaId": "C29596A6-AD28-4D49-9F7C-0D038EF3D426"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3:*:*:*:*:*:*:*", "matchCriteriaId": "8BFEEEAA-E8FE-436A-93B8-FC6A8461870D"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3:beta:*:*:*:*:*:*", "matchCriteriaId": "74C5F4B1-5062-4B65-8476-5EC149671CAD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3:rc1:*:*:*:*:*:*", "matchCriteriaId": "7AC9A07E-8ECA-48E7-8210-9FD32CADA6F5"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3:rc2:*:*:*:*:*:*", "matchCriteriaId": "C7AF33DD-56CA-4E76-BC61-B0F59A300494"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3:rc7:*:*:*:*:*:*", "matchCriteriaId": "FDA784AD-3D96-4E99-8F00-2FEF34691E72"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3.1:*:*:*:*:*:*:*", "matchCriteriaId": "6B9C856B-8DF6-414D-9EF7-99FD10456F81"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3.2:*:*:*:*:*:*:*", "matchCriteriaId": "39E64E53-5AE9-4C0A-B327-056FE21848B5"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3.3:*:*:*:*:*:*:*", "matchCriteriaId": "1B572BF2-96CE-4742-BEFA-0E7FB4EF6CFD"}, {"vulnerable": true, "criteria": "cpe:2.3:a:punbb:punbb:1.3.4:*:*:*:*:*:*:*", "matchCriteriaId": "771AF72C-ADE9-487D-96FE-CF2A317CB7F2"}]}]}], "references": [{"url": "http://archives.neohapsis.com/archives/fulldisclosure/2011-09/0193.html", "source": "secalert@redhat.com", "tags": ["Exploit"]}, {"url": "http://archives.neohapsis.com/archives/fulldisclosure/2011-09/0210.html", "source": "secalert@redhat.com", "tags": ["Exploit"]}, {"url": "http://archives.neohapsis.com/archives/fulldisclosure/2011-09/0272.html", "source": "secalert@redhat.com", "tags": ["Exploit"]}, {"url": "http://punbb.informer.com/forums/topic/24427/multiple-xss-vulnerabilities/", "source": "secalert@redhat.com", "tags": ["Patch"]}, {"url": "http://punbb.informer.com/forums/topic/24430/punbb-136/", "source": "secalert@redhat.com", "tags": ["Patch"]}, {"url": "http://securitytracker.com/id?1026073", "source": "secalert@redhat.com"}, {"url": "http://www.openwall.com/lists/oss-security/2011/09/18/1", "source": "secalert@redhat.com", "tags": ["Patch"]}, {"url": "http://www.openwall.com/lists/oss-security/2011/09/22/3", "source": "secalert@redhat.com", "tags": ["Patch"]}, {"url": "https://github.com/downloads/punbb/punbb/punbb-1.3.6.zip", "source": "secalert@redhat.com", "tags": ["Patch"]}, {"url": "https://github.com/punbb/punbb/commit/dd50a50a2760f10bd2d09814e30af4b36052ca6d", "source": "secalert@redhat.com", "tags": ["Patch"]}]}, "github_commit_url": "https://github.com/punbb/punbb/commit/dd50a50a2760f10bd2d09814e30af4b36052ca6d"}}