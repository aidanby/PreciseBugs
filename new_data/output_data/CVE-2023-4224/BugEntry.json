{"buggy_code": ["# Check that your Apache virtualhost have this settings:\n\n#<Directory \"/var/www/chamilo-classic\">\n#  AllowOverride All\n#  Order allow,deny\n#  Allow from all\n#</Directory>\n\nRewriteEngine on\n\n# Disables access to myfile.php/something\nAcceptPathInfo Off\n\n# Prevent execution of PHP from directories used for different types of uploads\nRedirectMatch 403 ^/app/(?!courses/proxy)(cache|courses|home|logs|upload|Resources/public/css)/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/default_course_document/images/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/lang/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/web/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/app/config/.*\\.yml(\\.dist)?$\n\n# http://my.chamilo.net/certificates/?id=123 to http://my.chamilo.net/certificates/index.php?id=123\nRewriteCond %{QUERY_STRING} ^id=(.*)$\nRewriteRule ^certificates/$ certificates/index.php?id=%1 [L]\n\n# Course redirection\nRewriteRule ^courses/([^/]+)/?$ main/course_home/course_home.php?cDir=$1 [QSA,L]\nRewriteRule ^courses/([^/]+)/index.php$ main/course_home/course_home.php?cDir=$1 [QSA,L]\n\n# Rewrite everything in the scorm folder of a course to the download script\n# except JS, CSS and some image files, which can be served directly\nRewriteRule ^courses/([^/]+)/scorm/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/scorm/$2 [QSA,L]\nRewriteRule ^courses/([^/]+)/scorm/(.*)$ main/document/download_scorm.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Rewrite everything in the document folder of a course to the download script\n# Except certificate resources, which might need to be accessible publicly to all\nRewriteRule ^courses/([^/]+)/document/certificates/(.*)$ app/courses/$1/document/certificates/$2 [QSA,L]\n# Note : since version 2.4.38-3 of Apache a security fix had a side effect that made redirection with space not to work.\n# To fix this issue we did not have a common syntaxis but it work with one of those 2 options :\n# changing at the end of the following line [QSA,L] for [QSA,L,B=\\x20?] or for \"[QSA,L,B= ?,BNP]\"\nRewriteRule ^courses/([^/]+)/document/(.*)$ main/document/download.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Optimize load of custom per-course icons in courses (avoid download_uploaded_files.php)\nRewriteRule ^courses/([^/]+)/upload/course_home_icons/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/upload/course_home_icons/$2 [QSA,L]\n# Course upload files\n# Note : since version 2.4.38-3 of Apache a security fix had a side effect that made redirection with space not to work.\n# To fix this issue we did not have a common syntaxis but it work with one of those 2 options :\n# changing at the end of the following line [QSA,L] for [QSA,L,B=\\x20?] or for \"[QSA,L,B= ?,BNP]\"\nRewriteRule ^courses/([^/]+)/upload/([^/]+)/(.*)$ main/document/download_uploaded_files.php?code=$1&type=$2&file=$3 [QSA,L]\n\n# Rewrite everything in the work folder\n# Note : since version 2.4.38-3 of Apache a security fix had a side effect that made redirection with space not to work.\n# To fix this issue we did not have a common syntaxis but it work with one of those 2 options :\n# changing at the end of the following line [QSA,L] for [QSA,L,B=\\x20?] or for \"[QSA,L,B= ?,BNP]\"\nRewriteRule ^courses/([^/]+)/work/(.*)$ main/work/download.php?file=work/$2&cDir=$1 [QSA,L]\n\nRewriteRule ^courses/([^/]+)/course-pic85x85.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-pic.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_large_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-email-pic-cropped.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_email_image_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-email-pic.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_email_image_large_source [QSA,L]\n\n# Redirect all courses/ to app/courses/\nRewriteRule ^courses/([^/]+)/(.*)$ app/courses/$1/$2 [QSA,L]\n\n# About session\nRewriteRule ^session/(\\d{1,})/about/?$ main/session/about.php?session_id=$1 [QSA,L]\n\n# About course\nRewriteRule ^course/(\\d{1,})/about/?$ main/course_info/about.php?course_id=$1 [QSA,L]\n\n# Issued individual badge friendly URL\nRewriteRule ^badge/(\\d{1,})/?$ main/badge/issued.php?issue=$1 [QSA,L]\n\n# Issued badges friendly URL\nRewriteRule ^skill/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n# Support deprecated URL (avoid 404)\nRewriteRule ^badge/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n\n# Support old URLs using the exercice (with a c) folder rather than exercise\nRewriteRule ^main/exercice/(.*)$ main/exercise/$1 [QSA,L]\n# Support old URLs using the newscorm folder rather than lp\nRewriteRule ^main/newscorm/(.*)$ main/lp/$1 [QSA,L]\n\n# service Information\nRewriteRule ^service/(\\d{1,})$ plugin/buycourses/src/service_information.php?service_id=$1 [L]\n\n# LTI outcome service\nRewriteRule ^lti/os$ plugin/ims_lti/outcome_service.php [L]\n\n# Deny direct access to user my files\nRewriteRule ^app/upload/users/([^/]+)/([^/]+)/my_files/(.*)$ main/social/download_my_files.php?user_id=$2&file=$3 [QSA,L]\n\n# Deny access\nRewriteRule ^(tests|.git) - [F,L,NC]\n\n# Add caching of woff font files to avoid loading 2*15KB each time with Chamilo\n# default OpenSans font\nAddType application/font-woff .woff .woff2\n<IfModule mod_expires.c>\n  ExpiresActive On\n  ExpiresByType application/font-woff \"access plus 1 month\"\n</IfModule>\n\n# Force SSL/HTTPS\n# We recommend you place this block in your VirtualHost config rather\n# than uncommenting it below. However, if you have no other way,\n# feel free to uncomment it, but please remember that this file will \n# be overwritten during your next Chamilo update.\n# Also note this will only work if you have an SSL certificate\n# configured elsewhere in your Apache configuration.\n\n#RewriteCond %{HTTPS} !=on\n#RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]\n#<IfModule mod_headers.c>\n#  Header always set Content-Security-Policy \"upgrade-insecure-requests;\"\n#</IfModule>\n"], "fixing_code": ["# Check that your Apache virtualhost have this settings:\n\n#<Directory \"/var/www/chamilo-classic\">\n#  AllowOverride All\n#  Order allow,deny\n#  Allow from all\n#</Directory>\n\nRewriteEngine on\n\n# Disables access to myfile.php/something\nAcceptPathInfo Off\n\n# Prevent execution of PHP from directories used for different types of uploads\nRedirectMatch 403 ^/app/(?!courses/proxy)(cache|courses|home|logs|upload|Resources/public/css)/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/default_course_document/images/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/main/lang/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/web/.*\\.ph(p[3457]?|t|tml|ar)$\nRedirectMatch 403 ^/app/config/.*\\.yml(\\.dist)?$\n\n# http://my.chamilo.net/certificates/?id=123 to http://my.chamilo.net/certificates/index.php?id=123\nRewriteCond %{QUERY_STRING} ^id=(.*)$\nRewriteRule ^certificates/$ certificates/index.php?id=%1 [L]\n\n# Course redirection\nRewriteRule ^courses/([^/]+)/?$ main/course_home/course_home.php?cDir=$1 [QSA,L]\nRewriteRule ^courses/([^/]+)/index.php$ main/course_home/course_home.php?cDir=$1 [QSA,L]\n\n# Rewrite everything in the scorm folder of a course to the download script\n# except JS, CSS and some image files, which can be served directly\nRewriteRule ^courses/([^/]+)/scorm/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/scorm/$2 [QSA,L]\nRewriteRule ^courses/([^/]+)/scorm/(.*)$ main/document/download_scorm.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Rewrite everything in the document folder of a course to the download script\n# Except certificate resources, which might need to be accessible publicly to all\nRewriteRule ^courses/([^/]+)/document/certificates/(.*)$ app/courses/$1/document/certificates/$2 [QSA,L]\n# Note : since version 2.4.38-3 of Apache a security fix had a side effect that made redirection with space not to work.\n# To fix this issue we did not have a common syntaxis but it work with one of those 2 options :\n# changing at the end of the following line [QSA,L] for [QSA,L,B=\\x20?] or for \"[QSA,L,B= ?,BNP]\"\nRewriteRule ^courses/([^/]+)/document/(.*)$ main/document/download.php?doc_url=/$2&cDir=$1 [QSA,L]\n\n# Optimize load of custom per-course icons in courses (avoid download_uploaded_files.php)\nRewriteRule ^courses/([^/]+)/upload/course_home_icons/(.*([\\.js|\\.css|\\.png|\\.jpg|\\.jpeg|\\.gif]))$ app/courses/$1/upload/course_home_icons/$2 [QSA,L]\n# Course upload files\n# Note : since version 2.4.38-3 of Apache a security fix had a side effect that made redirection with space not to work.\n# To fix this issue we did not have a common syntaxis but it work with one of those 2 options :\n# changing at the end of the following line [QSA,L] for [QSA,L,B=\\x20?] or for \"[QSA,L,B= ?,BNP]\"\nRewriteRule ^courses/([^/]+)/upload/([^/]+)/(.*)$ main/document/download_uploaded_files.php?code=$1&type=$2&file=$3 [QSA,L]\n\n# Rewrite everything in the work folder\n# Note : since version 2.4.38-3 of Apache a security fix had a side effect that made redirection with space not to work.\n# To fix this issue we did not have a common syntaxis but it work with one of those 2 options :\n# changing at the end of the following line [QSA,L] for [QSA,L,B=\\x20?] or for \"[QSA,L,B= ?,BNP]\"\nRewriteRule ^courses/([^/]+)/work/(.*)$ main/work/download.php?file=work/$2&cDir=$1 [QSA,L]\n\nRewriteRule ^courses/([^/]+)/course-pic85x85.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-pic.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_image_large_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-email-pic-cropped.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_email_image_source [QSA,L]\nRewriteRule ^courses/([^/]+)/course-email-pic.png$ main/inc/ajax/course.ajax.php?a=get_course_image&code=$1&image=course_email_image_large_source [QSA,L]\n\n# Redirect all courses/ to app/courses/\nRewriteRule ^courses/([^/]+)/(.*)$ app/courses/$1/$2 [QSA,L]\n\n# About session\nRewriteRule ^session/(\\d{1,})/about/?$ main/session/about.php?session_id=$1 [QSA,L]\n\n# About course\nRewriteRule ^course/(\\d{1,})/about/?$ main/course_info/about.php?course_id=$1 [QSA,L]\n\n# Issued individual badge friendly URL\nRewriteRule ^badge/(\\d{1,})/?$ main/badge/issued.php?issue=$1 [QSA,L]\n\n# Issued badges friendly URL\nRewriteRule ^skill/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n# Support deprecated URL (avoid 404)\nRewriteRule ^badge/(\\d{1,})/user/(\\d{1,})/?$ main/badge/issued_all.php?skill=$1&user=$2 [L]\n\n# Support old URLs using the exercice (with a c) folder rather than exercise\nRewriteRule ^main/exercice/(.*)$ main/exercise/$1 [QSA,L]\n# Support old URLs using the newscorm folder rather than lp\nRewriteRule ^main/newscorm/(.*)$ main/lp/$1 [QSA,L]\n\n# service Information\nRewriteRule ^service/(\\d{1,})$ plugin/buycourses/src/service_information.php?service_id=$1 [L]\n\n# LTI outcome service\nRewriteRule ^lti/os$ plugin/ims_lti/outcome_service.php [L]\n\n# Deny direct access to user my files\nRewriteRule ^app/upload/users/([^/]+)/([^/]+)/my_files/(.*)$ main/social/download_my_files.php?user_id=$2&file=$3 [QSA,L]\n\n# Deny access\nRewriteRule ^(tests|.git) - [F,L,NC]\n\n# Add caching of woff font files to avoid loading 2*15KB each time with Chamilo\n# default OpenSans font\nAddType application/font-woff .woff .woff2\n<IfModule mod_expires.c>\n  ExpiresActive On\n  ExpiresByType application/font-woff \"access plus 1 month\"\n</IfModule>\n\n# Force SSL/HTTPS\n# We recommend you place this block in your VirtualHost config rather\n# than uncommenting it below. However, if you have no other way,\n# feel free to uncomment it, but please remember that this file will \n# be overwritten during your next Chamilo update.\n# Also note this will only work if you have an SSL certificate\n# configured elsewhere in your Apache configuration.\n\n#RewriteCond %{HTTPS} !=on\n#RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]\n#<IfModule mod_headers.c>\n#  Header always set Content-Security-Policy \"upgrade-insecure-requests;\"\n#</IfModule>\n\n<IfModule mod_headers.c>\n  Header always set X-Content-Type-Options nosniff\n</IfModule>\n"], "filenames": [".htaccess"], "buggy_code_start_loc": [115], "buggy_code_end_loc": [115], "fixing_code_start_loc": [116], "fixing_code_end_loc": [120], "type": "CWE-434", "message": "Unrestricted file upload in `/main/inc/ajax/dropbox.ajax.php` in Chamilo LMS <= v1.11.24 allows authenticated attackers with learner role to obtain remote code execution via uploading of PHP files.", "other": {"cve": {"id": "CVE-2023-4224", "sourceIdentifier": "info@starlabs.sg", "published": "2023-11-28T08:15:09.213", "lastModified": "2023-11-30T05:34:56.030", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Unrestricted file upload in `/main/inc/ajax/dropbox.ajax.php` in Chamilo LMS <= v1.11.24 allows authenticated attackers with learner role to obtain remote code execution via uploading of PHP files."}, {"lang": "es", "value": "La carga de archivos sin restricciones en `/main/inc/ajax/dropbox.ajax.php` en Chamilo LMS en versiones &lt;= 1.11.24 permite a atacantes autenticados con rol de aprendizaje obtener la ejecuci\u00f3n remota de c\u00f3digo mediante la carga de archivos PHP."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}, {"source": "info@starlabs.sg", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-434"}]}, {"source": "info@starlabs.sg", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-434"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:chamilo:chamilo_lms:*:*:*:*:*:*:*:*", "versionEndIncluding": "1.11.24", "matchCriteriaId": "3CA5310C-E5B0-4369-BC5A-F56EBED72EBA"}]}]}], "references": [{"url": "https://github.com/chamilo/chamilo-lms/commit/6f32625a012d5de2dfe8edbccb4ed14a85e310d4", "source": "info@starlabs.sg", "tags": ["Patch"]}, {"url": "https://github.com/chamilo/chamilo-lms/commit/e864127a440c2cab0eb62c113a04e2e904543a1f", "source": "info@starlabs.sg", "tags": ["Patch"]}, {"url": "https://github.com/chamilo/chamilo-lms/commit/f3d62b65ad60d68096c2674d5695339f04de0b8a", "source": "info@starlabs.sg", "tags": ["Patch"]}, {"url": "https://starlabs.sg/advisories/23/23-4224", "source": "info@starlabs.sg", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://support.chamilo.org/projects/chamilo-18/wiki/security_issues#Issue-129-2023-09-04-Critical-impact-Moderate-risk-Authenticated-users-may-gain-unauthenticated-RCE-CVE-2023-4223CVE-2023-4224CVE-2023-4225CVE-2023-4226", "source": "info@starlabs.sg", "tags": ["Issue Tracking", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/chamilo/chamilo-lms/commit/6f32625a012d5de2dfe8edbccb4ed14a85e310d4"}}