{"buggy_code": ["<?php\n\n/**\n * Patient matching and selection dialog.\n *\n * @package   OpenEMR\n * @link      https://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2013-2015 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\n\n$form_key = $_REQUEST['key'];\n$args = unserialize($form_key, ['allowed_classes' => false]);\n$form_ss = preg_replace('/[^0-9]/', '', $args['ss']);\n$form_fname = $args['fname'];\n$form_lname = $args['lname'];\n$form_DOB = $args['DOB'];\n?>\n<!DOCTYPE html>\n<html>\n<head>\n<?php Header::setupHeader(['opener']); ?>\n<style>\n    .oneResult {\n    }\n</style>\n<script>\n\n    $(function () {\n        $(\".oneresult\").mouseover(function () {\n            $(this).addClass(\"highlight\");\n        });\n        $(\".oneresult\").mouseout(function () {\n            $(this).removeClass(\"highlight\");\n        });\n    });\n\n    function myRestoreSession() {\n        if (top.restoreSession) top.restoreSession(); else opener.top.restoreSession();\n        return true;\n    }\n\n    function openPatient(ptid) {\n        var f = opener.document.forms[0];\n        var ename = '<?php echo addslashes(\"select[$form_key]\"); ?>';\n        if (f[ename]) {\n            f[ename].value = ptid;\n            window.close();\n        }\n        else {\n            alert(<?php echo xlj('Form element not found'); ?> + ': ' + ename);\n        }\n    }\n\n</script>\n</head>\n\n<body class=\"body_top\">\n<form method='post' action='patient_select.php' onsubmit='return myRestoreSession()'>\n<input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n<?php\nif ($form_key) {\n    $clarr = array();\n    $clsql = \"0\";\n// First name.\n    if ($form_fname !== '') {\n        $clsql .= \" + ((fname IS NOT NULL AND fname = ?) * 5)\";\n        $clarr[] = $form_fname;\n    }\n\n// Last name.\n    if ($form_lname !== '') {\n        $clsql .= \" + ((lname IS NOT NULL AND lname = ?) * 5)\";\n        $clarr[] = $form_lname;\n    }\n\n// Birth date.\n    if ($form_DOB !== '') {\n        $clsql .= \" + ((DOB IS NOT NULL AND DOB = ?) * 5)\";\n        $clarr[] = $form_DOB;\n    }\n\n// SSN match is worth a lot and we allow for matching on last 4 digits.\n    if (strlen($form_ss) > 3) {\n        $clsql .= \" + ((ss IS NOT NULL AND ss LIKE ?) * 10)\";\n        $clarr[] = \"%$form_ss\";\n    }\n\n    $sql = \"SELECT $clsql AS closeness, \" .\n        \"pid, pubpid, fname, lname, mname, DOB, ss, postal_code, street, \" .\n        \"phone_biz, phone_home, phone_cell, phone_contact \" .\n        \"FROM patient_data \" .\n        \"ORDER BY closeness DESC, lname, fname LIMIT 10\";\n    $res = sqlStatement($sql, $clarr);\n    ?>\n\n    <div id=\"searchResults\">\n\n        <table class=\"table table-striped table-sm\">\n            <h5>\n                <?php\n                echo xlt('Matching for Patient') . \": \" .\n                    text(\"$form_lname, $form_fname\") . text(\" Dob = $form_DOB\") .\n                    \" SS = \" . text(($form_ss ? $form_ss : \"unk\"))\n                ?>\n            </h5>\n            <tr>\n                <th><?php echo xlt('Name'); ?></th>\n                <th><?php echo xlt('Phone'); ?></th>\n                <th><?php echo xlt('SS'); ?></th>\n                <th><?php echo xlt('DOB'); ?></th>\n                <th><?php echo xlt('Address'); ?></th>\n            </tr>\n\n            <?php\n            while ($row = sqlFetchArray($res)) {\n                if ($row['closeness'] == 0) {\n                    continue;\n                }\n\n                $phone = $row['phone_biz'];\n                if (empty($phone)) {\n                    $phone = $row['phone_home'];\n                }\n\n                if (empty($phone)) {\n                    $phone = $row['phone_cell'];\n                }\n\n                if (empty($phone)) {\n                    $phone = $row['phone_contact'];\n                }\n\n                echo \"  <tr class='oneresult'\";\n                echo \" onclick=\\\"openPatient(\" . attr_js($row['pid']) . \")\\\">\\n\";\n                echo \"   <td>\" . text($row['lname'] . \", \" . $row['fname']) . \"</td>\\n\";\n                echo \"   <td>\" . text($phone) . \"</td>\\n\";\n                echo \"   <td>\" . text($row['ss']) . \"</td>\\n\";\n                echo \"   <td>\" . text($row['DOB']) . \"</td>\\n\";\n                echo \"   <td>\" . text($row['street'] . ' ' . $row['postal_code']) . \"</td>\\n\";\n                echo \"  </tr>\\n\";\n            }\n            ?>\n        </table>\n    </div>\n    <?php\n}\n?>\n\n<p>\n    <input type='button' value='<?php echo xla('Add New Patient'); ?>' onclick=\"openPatient(0)\"/>\n    <input type='button' value='<?php echo xla('Cancel'); ?>' onclick=\"window.close()\"/>\n</p>\n\n</form>\n</center>\n</body>\n</html>\n", "<?php\n\n/**\n * Patient report\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017-2018 Brady Miller <brady.g.miller@gmail.com>\n * @author    Stephen Nielson <stephen@nielson.org>\n * @copyright Copyright (c) 2019 Stephen Nielson <stephen@nielson.org>\n * @author    Jerry Padgett <sjpadgett@gmail.com>\n * @copyright Copyright (c) 2019 Jerry Padgett <sjpadgett@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nrequire_once(\"../../globals.php\");\nrequire_once(\"$srcdir/lists.inc\");\nrequire_once(\"$srcdir/forms.inc\");\nrequire_once(\"$srcdir/patient.inc\");\n\nuse OpenEMR\\Common\\Acl\\AclMain;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\Events\\PatientReport\\PatientReportEvent;\nuse OpenEMR\\Menu\\PatientMenuRole;\nuse OpenEMR\\OeUI\\OemrUI;\nuse Symfony\\Component\\EventDispatcher\\EventDispatcherInterface;\nuse Symfony\\Component\\EventDispatcher\\GenericEvent;\n\nif (!AclMain::aclCheckCore('patients', 'pat_rep')) {\n    die(xlt('Not authorized'));\n}\n// get various authorization levels\n$auth_notes_a  = AclMain::aclCheckCore('encounters', 'notes_a');\n$auth_notes    = AclMain::aclCheckCore('encounters', 'notes');\n$auth_coding_a = AclMain::aclCheckCore('encounters', 'coding_a');\n$auth_coding   = AclMain::aclCheckCore('encounters', 'coding');\n$auth_relaxed  = AclMain::aclCheckCore('encounters', 'relaxed');\n$auth_med      = AclMain::aclCheckCore('patients', 'med');\n$auth_demo     = AclMain::aclCheckCore('patients', 'demo');\n\n$oefax = !empty($GLOBALS['oefax_enable']) ? $GLOBALS['oefax_enable'] : 0;\n/**\n * @var EventDispatcherInterface $eventDispatcher  The event dispatcher / listener object\n */\n$eventDispatcher = $GLOBALS['kernel']->getEventDispatcher();\n?>\n<html>\n<head>\n<title><?php echo xlt(\"Patient Reports\"); ?></title>\n\n<?php Header::setupHeader(['datetime-picker', 'common']); ?>\n<script>\n\nfunction checkAll(check) {\n var f = document.forms['report_form'];\n for (var i = 0; i < f.elements.length; ++i) {\n  if (f.elements[i].type == 'checkbox') f.elements[i].checked = check;\n }\n return false;\n}\n\nfunction show_date_fun(){\n  if(document.getElementById('show_date').checked == true){\n    document.getElementById('date_div').style.display = '';\n  }else{\n    document.getElementById('date_div').style.display = 'none';\n  }\n  return;\n}\n<?php require_once(\"$include_root/patient_file/erx_patient_portal_js.php\"); // jQuery for popups for eRx and patient portal ?>\n</script>\n<?php\n$arrOeUiSettings = array(\n    'heading_title' => xl('Patient Reports'),\n    'include_patient_name' => true,\n    'expandable' => false,\n    'expandable_files' => array(),//all file names need suffix _xpd\n    'action' => \"\",//conceal, reveal, search, reset, link or back\n    'action_title' => \"\",\n    'action_href' => \"\",//only for actions - reset, link or back\n    'show_help_icon' => true,\n    'help_file_name' => \"report_dashboard_help.php\"\n);\n$oemr_ui = new OemrUI($arrOeUiSettings);\n?>\n</head>\n\n<body>\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?> mt-3\">\n        <div id=\"patient_reports\"> <!-- large outer DIV -->\n            <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <?php require_once(\"$include_root/patient_file/summary/dashboard_header.php\");?>\n                </div>\n            </div>\n            <?php\n            $list_id = \"report\"; // to indicate nav item is active, count and give correct id\n            // Collect the patient menu then build it\n            $menuPatient = new PatientMenuRole();\n            $menuPatient->displayHorizNavBarMenu();\n            ?>\n\n            <?php\n            if ($GLOBALS['activate_ccr_ccd_report']) { // show CCR/CCD reporting options ?>\n                <div class=\"mt-3\" id=\"ccr_report\">\n                    <form name='ccr_form' id='ccr_form' method='post' action='../../../ccr/createCCR.php'>\n                        <fieldset>\n                            <div class=\"col-sm-12\">\n                                <span class='title oe-report-section-header'><?php echo xlt('Continuity of Care Record (CCR)'); ?></span>\n                                <span class='text'>(<?php echo xlt('Pop ups need to be enabled to see these reports'); ?>)</span>\n                                <br/>\n                                <br/>\n                                <input type='hidden' name='ccrAction' />\n                                <input type='hidden' name='raw' />\n                                <input type=\"checkbox\" name=\"show_date\" id=\"show_date\" onchange=\"show_date_fun();\" ><span class='text'><?php echo xlt('Use Date Range'); ?>\n                                <br />\n                                <br />\n                                <div id=\"date_div\" style=\"display: none\">\n                                    <div class=\"form-row\">\n                                        <div class=\"col-12 col-sm-2\">\n                                        <label for=\"Start\" class='font-weight-bold'><?php echo xlt('Start Date');?>: </label>\n                                        </div>\n                                        <div class=\"col-12 col-sm-4\">\n                                            <input type='text' class='datepicker form-control' size='10' name='Start' id='Start' title='<?php echo xla('yyyy-mm-dd'); ?>' />\n                                        </div>\n                                        <div class=\"col-12 col-sm-2\">\n                                            <label for=\"End\" class='font-weight-bold'><?php echo xlt('End Date');?>: </label>\n                                        </div>\n                                        <div class=\"col-12 col-sm-4\">\n                                            <input type='text' class='datepicker form-control' size='10' name='End' id='End' title='<?php echo xla('yyyy-mm-dd'); ?>' />\n                                        </div>\n                                    </div>\n                                </div>\n                                <br />\n                                <button type=\"button\" class=\"generateCCR btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                                <!--<input type=\"button\" class=\"generateCCR_raw\" value=\"<?php echo xlt('Raw Report'); ?>\" /> -->\n                                <button type=\"button\" class=\"generateCCR_download_p btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download'); ?>\" ><?php echo xlt('Download'); ?></button>\n\n                                <?php\n                                if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccr_enable'] == true) { ?>\n                                    <button type=\"button\" class=\"viewCCR_send_dialog btn btn-primary btn-transmit btn-sm\" value=\"<?php echo xla('Transmit'); ?>\"><?php echo xlt('Transmit'); ?></button>\n                                    <br />\n                                    <div id=\"ccr_send_dialog\" style=\"display: none\">\n                                        <br />\n                                        <div class=\"table-responsive\">\n                                            <table class=\"table border-0\">\n                                                <tr>\n                                                    <td>\n                                                        <span class='font-weight-bold'><?php echo xlt('Enter Recipient\\'s Direct Address');?>: </span>\n                                                        <input type=\"text\" size=\"64\" name=\"ccr_send_to\" id=\"ccr_send_to\" value=\"\" />\n                                                        <input type=\"hidden\" name=\"ccr_sent_by\" id=\"ccr_sent_by\" value=\"user\" />\n                                                        <button type=\"button\" class=\"viewCCR_transmit btn btn-primary btn-send-msg btn-sm\" value=\"<?php echo xla('Send CCR'); ?>\"><?php echo xlt('Send CCR'); ?></button>\n                                                        <div id=\"ccr_send_result\" style=\"display: none\">\n                                                            <span class=\"text\" id=\"ccr_send_message\"></span>\n                                                        </div>\n                                                    </td>\n                                                </tr>\n                                            </table>\n                                        </div>\n                                    </div>\n                                    <?php } ?>\n                            </div>\n                        </fieldset>\n                        <hr/>\n                        <fieldset>\n                            <div class=\"col-sm-12\">\n                                <span class='title oe-report-section-header'><?php echo xlt('Continuity of Care Document (CCD)'); ?></span>&nbsp;&nbsp;\n                                <span class='text'>(<?php echo xlt('Pop ups need to be enabled to see these reports'); ?>)</span>\n                                <br/>\n                                <br/>\n                                <button type=\"button\" class=\"viewCCD btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                                <button type=\"button\" class=\"viewCCD_download btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download'); ?>\" ><?php echo xlt('Download'); ?></button>\n                                <?php\n                                if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccd_enable'] == true) { ?>\n                                    <button type=\"button\" class=\"viewCCD_send_dialog btn btn-primary btn-transmit btn-sm\" value=\"<?php echo xla('Transmit'); ?>\" ><?php echo xlt('Transmit'); ?></button>\n                                    <br />\n                                    <div id=\"ccd_send_dialog\" style=\"display: none\">\n                                        <div class=\"form-row mt-3\">\n                                            <div class=\"col-12\">\n                                                <label for=\"\" class=\"font-weight-bold\">\n                                                    <?php echo xlt('Enter Recipient\\'s Direct Address');?>:\n                                                </label>\n                                            </div>\n                                            <div class=\"col-md\">\n                                                <input type=\"text\" class=\"form-control\" size=\"64\" name=\"ccd_send_to\" id=\"ccd_send_to\" value=\"\" />\n                                                <input type=\"hidden\" name=\"ccd_sent_by\" id=\"ccd_sent_by\" value=\"user\" />\n                                            </div>\n                                            <div class=\"col-md\">\n                                                <button type=\"button\" class=\"viewCCD_transmit btn btn-primary btn-send-msg btn-sm\" value=\"<?php echo xla('Send CCD'); ?>\"><?php echo xlt('Send CCD'); ?></button>\n                                            </div>\n                                        </div>\n                                        <div id=\"ccd_send_result\" style=\"display: none\">\n                                            <span class=\"text\" id=\"ccd_send_message\"></span>\n                                        </div>\n                                    </div>\n                                <?php } ?>\n                            </div>\n                        </fieldset>\n                    </form>\n                    <hr/>\n                </div>\n                <?php\n            } // end CCR/CCD reporting options ?>\n\n            <form name='report_form' id=\"report_form\" method='post' action='custom_report.php'>\n                <fieldset>\n                    <div class=\"col-sm-12\">\n                        <span class='title oe-report-section-header'><?php echo xlt('Patient Report'); ?></span>&nbsp;&nbsp;\n                        <!--\n                        <a class=\"link_submit\" href=\"full_report.php\" onclick=\"top.restoreSession()\">\n                        [<?php echo xlt('View Comprehensive Patient Report'); ?>]</a>\n                        -->\n                        <a class=\"link_submit btn btn-secondary btn-sm btn-save\" href=\"#\" onclick=\"return checkAll(true)\">\n                            <?php echo xla('Check All'); ?>\n                        </a>\n                        <a class=\"link_submit btn btn-secondary btn-sm btn-undo\" href=\"#\" onclick=\"return checkAll(false)\">\n                            <?php echo xla('Clear All'); ?>\n                        </a>\n\n                        <table class=\"includes mt-3\">\n                            <tr>\n                                <td class='text'>\n                                    <input type='checkbox' name='include_demographics' id='include_demographics' value=\"demographics\" checked /><?php echo xlt('Demographics'); ?>\n                                    <br />\n                                    <?php if (AclMain::aclCheckCore('patients', 'med')) : ?>\n                                    <input type='checkbox' name='include_history' id='include_history' value=\"history\" /><?php echo xlt('History'); ?>\n                                    <br />\n                                    <?php endif; ?>\n                                    <!--\n                                    <input type='checkbox' name='include_employer' id='include_employer' value=\"employer\"><?php echo xlt('Employer'); ?><br />\n                                    -->\n                                    <input type='checkbox' name='include_insurance' id='include_insurance' value=\"insurance\" /><?php echo xlt('Insurance'); ?>\n                                    <br />\n                                    <input type='checkbox' name='include_billing' id='include_billing' value=\"billing\"\n                                    <?php\n                                    if (!$GLOBALS['simplified_demographics']) {\n                                        echo 'checked';\n                                    } ?> /><?php echo xlt('Billing'); ?>\n                                    <br />\n                                </td>\n                                <td class='text'>\n                                    <!--\n                                    <input type='checkbox' name='include_allergies' id='include_allergies' value=\"allergies\">Allergies<br />\n                                    <input type='checkbox' name='include_medications' id='include_medications' value=\"medications\">Medications<br />\n                                    -->\n                                    <input type='checkbox' name='include_immunizations' id='include_immunizations' value=\"immunizations\" /><?php echo xlt('Immunizations'); ?>\n                                    <br />\n                                    <!--\n                                    <input type='checkbox' name='include_medical_problems' id='include_medical_problems' value=\"medical_problems\">Medical Problems<br />\n                                    -->\n                                    <input type='checkbox' name='include_notes' id='include_notes' value=\"notes\" /><?php echo xlt('Patient Notes'); ?>\n                                    <br />\n                                    <input type='checkbox' name='include_transactions' id='include_transactions' value=\"transactions\" /><?php echo xlt('Transactions'); ?>\n                                    <br />\n                                    <input type='checkbox' name='include_batchcom' id='include_batchcom' value=\"batchcom\" /><?php echo xlt('Communications'); ?>\n                                    <br />\n                                </td>\n                                <td class=\"text\">\n                                    <input type='checkbox' name='include_recurring_days' id='include_recurring_days' value=\"recurring_days\" /><?php echo  xlt('Recurrent Appointments'); ?>\n                                    <br />\n                                </td>\n                            </tr>\n                        </table>\n                        <br />\n                        <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                        <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n\n                        <?php\n                        if ($oefax) {\n                            $eventDispatcher->dispatch(PatientReportEvent::ACTIONS_RENDER_POST, new GenericEvent());\n                        }\n                        ?>\n                        <input type='hidden' name='pdf' value='0' />\n                        <br />\n\n                        <!-- old ccr button position -->\n                        <hr/>\n\n                        <div class=\"row issues_encounters_forms\">\n                            <!-- Issues -->\n                            <div class=\"col-md-6\">\n                                <div class=\"issues table-responsive\">\n                                    <span class='font-weight-bold oe-report-section-header'><?php echo xlt('Issues'); ?>:</span>\n                                    <br />\n                                    <br />\n\n                                    <?php if (! AclMain::aclCheckCore('patients', 'med')) { ?>\n                                    <br />(Issues not authorized)\n                                    <?php } else { ?>\n                                    <table class=\"table table-borderless\">\n                                        <?php\n                                        // get issues\n                                        $pres = sqlStatement(\"SELECT * FROM lists WHERE pid = ? \" .\n                                        \"ORDER BY type, begdate\", array($pid));\n                                        $lasttype = \"\";\n                                        while ($prow = sqlFetchArray($pres)) {\n                                            if ($lasttype != $prow['type']) {\n                                                $lasttype = $prow['type'];\n\n                                                /****\n                                                $disptype = $lasttype;\n                                                switch ($lasttype) {\n                                                case \"allergy\"        : $disptype = \"Allergies\"       ; break;\n                                                case \"problem\"        :\n                                                case \"medical_problem\": $disptype = \"Medical Problems\"; break;\n                                                case \"medication\"     : $disptype = \"Medications\"     ; break;\n                                                case \"surgery\"        : $disptype = \"Surgeries\"       ; break;\n                                                }\n                                                ****/\n                                                $disptype = $ISSUE_TYPES[$lasttype][0];\n\n                                                echo \" <tr>\\n\";\n                                                echo \"  <td colspan='4' class='font-weight-bold'><span class='oe-report-section-header'>\" . xlt($disptype) . \":</span></td>\\n\";\n                                                echo \" </tr>\\n\";\n                                            }\n\n                                            $rowid = $prow['id'];\n                                            $disptitle = trim($prow['title']) ? $prow['title'] : \"[Missing Title]\";\n\n                                            $ieres = sqlStatement(\"SELECT encounter FROM issue_encounter WHERE \" .\n                                            \"pid = ? AND list_id = ?\", array($pid, $rowid));\n\n                                            echo \"    <tr class='text'>\\n\";\n                                            echo \"     <td>&nbsp;</td>\\n\";\n                                            echo \"     <td>\";\n                                            echo \"<input type='checkbox' name='issue_\" . attr($rowid) . \"' id='issue_\" . attr($rowid) . \"' class='issuecheckbox' value='/\";\n                                            while ($ierow = sqlFetchArray($ieres)) {\n                                                echo attr($ierow['encounter']) . \"/\";\n                                            }\n\n                                            echo \"' />$disptitle</td>\\n\";\n                                            echo \"     <td>\" . text($prow['begdate']);\n\n                                            if ($prow['enddate']) {\n                                                echo \" - \" . text($prow['enddate']);\n                                            } else {\n                                                echo \" Active\";\n                                            }\n\n                                            echo \"</td>\\n\";\n                                            echo \"</tr>\\n\";\n                                        }\n                                        ?>\n                                    </table>\n                                    <?php } // end of Issues output ?>\n                                </div> <!-- end issues DIV -->\n                                <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                                <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n                            </div>\n                            <!-- Encounters and Forms -->\n                            <div class=\"col-md-6\">\n                                <div class='encounters table-responsive'>\n                                    <span class='font-weight-bold oe-report-section-header'><?php echo xlt('Encounters & Forms'); ?>:</span>\n                                    <br />\n                                    <br />\n\n                                    <?php\n                                    if (!($auth_notes_a || $auth_notes || $auth_coding_a || $auth_coding || $auth_med || $auth_relaxed)) { ?>\n                                        (Encounters not authorized)\n                                        <?php\n                                    } else { ?>\n                                        <?php\n                                        $isfirst = 1;\n                                        $res = sqlStatement(\"SELECT forms.encounter, forms.form_id, forms.form_name, \" .\n                                        \"forms.formdir, forms.date AS fdate, form_encounter.date \" .\n                                        \",form_encounter.reason \" .\n                                        \"FROM forms, form_encounter WHERE \" .\n                                        \"forms.pid = ? AND form_encounter.pid = ? AND \" .\n                                        \"form_encounter.encounter = forms.encounter \" .\n                                        \" AND forms.deleted=0 \" . // --JRM--\n                                        \"ORDER BY form_encounter.encounter DESC, form_encounter.date DESC, fdate ASC\", array($pid, $pid));\n                                        $res2 = sqlStatement(\"SELECT name FROM registry ORDER BY priority\");\n                                        $html_strings = array();\n                                        $registry_form_name = array();\n                                        while ($result2 = sqlFetchArray($res2)) {\n                                            array_push($registry_form_name, trim($result2['name']));\n                                        }\n\n                                        while ($result = sqlFetchArray($res)) {\n                                            if ($result[\"form_name\"] == \"New Patient Encounter\") {\n                                                if ($isfirst == 0) {\n                                                    foreach ($registry_form_name as $var) {\n                                                        if ($toprint = $html_strings[$var]) {\n                                                            foreach ($toprint as $var) {\n                                                                print $var;\n                                                            }\n                                                        }\n                                                    }\n                                                    $html_strings = array();\n                                                    echo \"</div>\\n\"; // end DIV encounter_forms\n                                                    echo \"</div>\\n\\n\";  //end DIV encounter_data\n                                                    echo \"<br />\";\n                                                }\n                                                $isfirst = 0;\n                                                echo \"<div class='encounter_data'>\\n\";\n                                                echo \"<input type=checkbox \" .\n                                                \" name='\" . attr($result[\"formdir\"]) . \"_\" .  attr($result[\"form_id\"]) . \"'\" .\n                                                \" id='\" . attr($result[\"formdir\"]) . \"_\" .  attr($result[\"form_id\"]) . \"'\" .\n                                                \" value='\" . attr($result[\"encounter\"]) . \"'\" .\n                                                \" class='encounter'\" .\n                                                \" >\";\n                                                // show encounter reason, not just 'New Encounter'\n                                                // trim to a reasonable length for display purposes --cfapress\n                                                $maxReasonLength = 20;\n                                                if (strlen($result[\"reason\"]) > $maxReasonLength) {\n                                                    // The default encoding for this mb_substr() call is set near top of globals.php\n                                                    $result['reason'] = mb_substr($result['reason'], 0, $maxReasonLength) . \" ... \";\n                                                }\n                                                echo text($result[\"reason\"]) .\n                                                \" (\" . text(date(\"Y-m-d\", strtotime($result[\"date\"]))) .\n                                                \")\\n\";\n                                                echo \"<div class='encounter_forms'>\\n\";\n                                            } else {\n                                                $form_name = trim($result[\"form_name\"]);\n                                                //if form name is not in registry, look for the closest match by\n                                                // finding a registry name which is  at the start of the form name.\n                                                //this is to allow for forms to put additional helpful information\n                                                //in the database in the same string as their form name after the name\n                                                $form_name_found_flag = 0;\n                                                foreach ($registry_form_name as $var) {\n                                                    if ($var == $form_name) {\n                                                        $form_name_found_flag = 1;\n                                                    }\n                                                }\n                                                // if the form does not match precisely with any names in the registry, now see if any front partial matches\n                                                // and change $form_name appropriately so it will print above in $toprint = $html_strings[$var]\n                                                if (!$form_name_found_flag) {\n                                                    foreach ($registry_form_name as $var) {\n                                                        if (strpos($form_name, $var) == 0) {\n                                                            $form_name = $var;\n                                                        }\n                                                    }\n                                                }\n                                                if (empty($html_strings[$form_name]) || !is_array($html_strings[$form_name])) {\n                                                    $html_strings[$form_name] = array();\n                                                }\n                                                array_push($html_strings[$form_name], \"<input type='checkbox' \" .\n                                                    \" name='\" . attr($result[\"formdir\"]) . \"_\" . attr($result[\"form_id\"]) . \"'\" .\n                                                    \" id='\" . attr($result[\"formdir\"]) . \"_\" . attr($result[\"form_id\"]) . \"'\" .\n                                                    \" value='\" . attr($result[\"encounter\"]) . \"'\" .\n                                                    \" class='encounter_form' \" .\n                                                    \">\" . text(xl_form_title($result[\"form_name\"])) . \"<br />\\n\");\n                                            }\n                                        }\n\n                                        foreach ($registry_form_name as $var) {\n                                            if (!empty($html_strings[$var])) {\n                                                if ($toprint = $html_strings[$var]) {\n                                                    foreach ($toprint as $var) {\n                                                        print $var;\n                                                    }\n                                                }\n                                            }\n                                        }\n                                        ?>\n\n                                        <?php\n                                    } ?>\n                                </div> <!-- end encounters DIV -->\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-sm-12\">\n                        <!-- Procedure Orders -->\n                        <hr/>\n                        <div class=\"table-responsive\">\n                            <table class=\"table table-borderless\">\n                                <tr>\n                                    <td class='font-weight-bold'><span class='oe-report-section-header'><?php echo xlt('Procedures'); ?>:</span></td>\n                                    <td class='text'>&nbsp;<?php echo xlt('Order Date'); ?>&nbsp;&nbsp;</td>\n                                    <td class='text'><?php echo xlt('Encounter Date'); ?>&nbsp;&nbsp;</td>\n                                    <td class='text'><?php echo xlt('Order Descriptions'); ?></td>\n                                </tr>\n                                <?php\n                                $res = sqlStatement(\n                                    \"SELECT po.procedure_order_id, po.date_ordered, fe.date \" .\n                                    \"FROM procedure_order AS po \" .\n                                    \"LEFT JOIN forms AS f ON f.pid = po.patient_id AND f.formdir = 'procedure_order' AND \" .\n                                    \"f.form_id = po.procedure_order_id AND f.deleted = 0 \" .\n                                    \"LEFT JOIN form_encounter AS fe ON fe.pid = f.pid AND fe.encounter = f.encounter \" .\n                                    \"WHERE po.patient_id = ? \" .\n                                    \"ORDER BY po.date_ordered DESC, po.procedure_order_id DESC\",\n                                    array($pid)\n                                );\n                                while ($row = sqlFetchArray($res)) {\n                                    $poid = $row['procedure_order_id'];\n                                    echo \" <tr>\\n\";\n                                    echo \"  <td class='text text-center'>\" .\n                                    \"<input type='checkbox' name='procedures[]' value='\" . attr($poid) . \"' />&nbsp;&nbsp;</td>\\n\";\n                                    echo \"  <td class='text'>\" . text(oeFormatShortDate($row['date_ordered'])) . \"&nbsp;&nbsp;</td>\\n\";\n                                    echo \"  <td class='text'>\" . text(oeFormatShortDate($row['date'])) . \"&nbsp;&nbsp;</td>\\n\";\n                                    echo \"  <td class='text'>\";\n                                    $opres = sqlStatement(\n                                        \"SELECT procedure_code, procedure_name FROM procedure_order_code \" .\n                                        \"WHERE procedure_order_id = ? ORDER BY procedure_order_seq\",\n                                        array($poid)\n                                    );\n                                    while ($oprow = sqlFetchArray($opres)) {\n                                        $tmp = $oprow['procedure_name'];\n                                        if (empty($tmp)) {\n                                            $tmp = $oprow['procedure_code'];\n                                        }\n                                        echo text($tmp) . \"<br />\";\n                                    }\n                                    echo \"</td>\\n\";\n                                    echo \" </tr>\\n\";\n                                }\n                                ?>\n                            </table>\n                        </div>\n\n                        <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                        <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n                        <hr/>\n                    <div>\n\n                    <span class=\"font-weight-bold oe-report-section-header\"><?php echo xlt('Documents'); ?>:</span><br />\n                    <ul>\n                        <?php\n                        // show available documents\n                        $db = $GLOBALS['adodb']['db'];\n                        $sql = \"SELECT d.id, d.url, d.name as document_name, c.name, c.aco_spec FROM documents AS d \" .\n                                \"LEFT JOIN categories_to_documents AS ctd ON d.id=ctd.document_id \" .\n                                \"LEFT JOIN categories AS c ON c.id = ctd.category_id WHERE \" .\n                                \"d.foreign_id = ? AND d.deleted = 0\";\n                        $result = $db->Execute($sql, array($pid));\n                        if ($db->ErrorMsg()) {\n                            echo $db->ErrorMsg();\n                        }\n                        while ($result && !$result->EOF) {\n                            if (empty($result->fields['aco_spec']) || AclMain::aclCheckAcoSpec($result->fields['aco_spec'])) {\n                                echo \"<li class='font-weight-bold'>\";\n                                echo '<input type=\"checkbox\" name=\"documents[]\" value=\"' .\n                                attr($result->fields['id']) . '\">';\n                                echo '&nbsp;&nbsp;<i>' .  text(xl_document_category($result->fields['name'])) . \"</i>\";\n                                echo '&nbsp;&nbsp;' . xlt('Name') . ': <i>' . text($result->fields['document_name']) . '-' . text($result->fields['id']) . \"</i>\";\n                                echo '</li>';\n                            }\n                            $result->MoveNext();\n                        }\n                        ?>\n                    </ul>\n                    <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                    <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n                </fieldset>\n            </form>\n        </div>  <!-- close patient_reports DIV -->\n    </div><!--end of container div-->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n\n<script>\n\n// jQuery stuff to make the page a little easier to use\n$(function () {\n    $('.datepicker').datetimepicker({\n        <?php $datetimepicker_timepicker = false; ?>\n        <?php $datetimepicker_showseconds = false; ?>\n        <?php $datetimepicker_formatInput = false; ?>\n        <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n        <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n    });\n\n    $(\".genreport\").click(function() { top.restoreSession(); document.report_form.pdf.value = 0; $(\"#report_form\").submit(); });\n    $(\".genpdfrep\").click(function() { top.restoreSession(); document.report_form.pdf.value = 1; $(\"#report_form\").submit(); });\n    $(\".genportal\").click(function() { top.restoreSession(); document.report_form.pdf.value = 2; $(\"#report_form\").submit(); });\n    $(\"#genfullreport\").click(function() { location.href='<?php echo \"$rootdir/patient_file/encounter/\" . ($returnurl ?? ''); ?>'; });\n    //$(\"#printform\").click(function() { PrintForm(); });\n    $(\".issuecheckbox\").click(function() { issueClick(this); });\n\n    // check/uncheck all Forms of an encounter\n    $(\".encounter\").click(function() { SelectForms($(this)); });\n\n    $(\".generateCCR\").click(function() {\n        if(document.getElementById('show_date').checked == true){\n            if(document.getElementById('Start').value == '' || document.getElementById('End').value == ''){\n                alert(<?php echo xlj('Please select a start date and end date') ?>);\n                return false;\n            }\n        }\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'no';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".generateCCR_raw\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'yes';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".generateCCR_download_h\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'hybrid';\n        top.restoreSession();\n        $(\"#ccr_form\").submit();\n    });\n    $(\".generateCCR_download_p\").click(function() {\n        if(document.getElementById('show_date').checked == true){\n            if(document.getElementById('Start').value == '' || document.getElementById('End').value == ''){\n                alert(<?php echo xlj('Please select a start date and end date'); ?>);\n                return false;\n            }\n        }\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'pure';\n        top.restoreSession();\n        $(\"#ccr_form\").submit();\n    });\n    $(\".viewCCD\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'viewccd';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'no';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".viewCCD_raw\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'viewccd';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'yes';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".viewCCD_download\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'viewccd';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'pure';\n        $(\"#ccr_form\").submit();\n    });\n\n    <?php if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccr_enable'] == true) { ?>\n        $(\".viewCCR_send_dialog\").click(function() {\n            $(\"#ccr_send_dialog\").toggle();\n        });\n        $(\".viewCCR_transmit\").click(function() {\n            $(\".viewCCR_transmit\").attr('disabled','disabled');\n            var ccrAction = document.getElementsByName('ccrAction');\n            ccrAction[0].value = 'generate';\n            var ccrRecipient = $(\"#ccr_send_to\").val();\n            var raw = document.getElementsByName('raw');\n            raw[0].value = 'send '+ccrRecipient;\n            if(ccrRecipient==\"\") {\n                    $(\"#ccr_send_message\").html(<?php\n                        echo xlj('Please enter a valid Direct Address above.'); ?>);\n                    $(\"#ccr_send_result\").show();\n            } else {\n                    $(\".viewCCR_transmit\").attr('disabled','disabled');\n                    $(\"#ccr_send_message\").html(<?php\n                        echo xlj('Working... this may take a minute.'); ?>);\n                    $(\"#ccr_send_result\").show();\n                    var action=$(\"#ccr_form\").attr('action');\n                    $.post(action,\n                        {\n                            ccrAction:'generate',\n                            raw:'send '+ccrRecipient,\n                            requested_by:'user'\n                        },\n                        function(data) {\n                            if(data==\"SUCCESS\") {\n                                $(\"#ccr_send_message\").html(<?php\n                                    echo xlj('Your message was submitted for delivery to');\n                                ?>+ \" \" + ccrRecipient);\n                                $(\"#ccr_send_to\").val(\"\");\n                            } else {\n                                $(\"#ccr_send_message\").html(data);\n                            }\n                            $(\".viewCCR_transmit\").removeAttr('disabled');\n                    });\n                    }\n        });\n    <?php }\n\n    if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccd_enable'] == true) { ?>\n        $(\".viewCCD_send_dialog\").click(function() {\n            $(\"#ccd_send_dialog\").toggle();\n        });\n        $(\".viewCCD_transmit\").click(function() {\n            $(\".viewCCD_transmit\").attr('disabled','disabled');\n            var ccrAction = document.getElementsByName('ccrAction');\n            ccrAction[0].value = 'viewccd';\n            var ccdRecipient = $(\"#ccd_send_to\").val();\n            var raw = document.getElementsByName('raw');\n            raw[0].value = 'send '+ccdRecipient;\n                if(ccdRecipient==\"\") {\n                        $(\"#ccd_send_message\").html(<?php\n                            echo xlj('Please enter a valid Direct Address above.'); ?>);\n                        $(\"#ccd_send_result\").show();\n                } else {\n                        $(\".viewCCD_transmit\").attr('disabled','disabled');\n                        $(\"#ccd_send_message\").html(<?php\n                            echo xlj('Working... this may take a minute.'); ?>);\n                        $(\"#ccd_send_result\").show();\n                        var action=$(\"#ccr_form\").attr('action');\n                        $.post(action,\n                            {\n                            ccrAction:'viewccd',\n                            raw:'send '+ccdRecipient,\n                            requested_by:'user'\n                            },\n                            function(data) {\n                            if(data==\"SUCCESS\") {\n                                $(\"#ccd_send_message\").html(<?php\n                                    echo xlj('Your message was submitted for delivery to');\n                                ?> + \" \" + ccdRecipient);\n                                $(\"#ccd_send_to\").val(\"\");\n                            } else {\n                                $(\"#ccd_send_message\").html(data);\n                            }\n                            $(\".viewCCD_transmit\").removeAttr('disabled');\n                        });\n                }\n        });\n    <?php } ?>\n\n    <?php\n    if ($oefax) {\n        $eventDispatcher->dispatch(PatientReportEvent::JAVASCRIPT_READY_POST, new GenericEvent());\n    }\n    ?>\n\n});\n\n// select/deselect the Forms related to the selected Encounter\n// (it ain't pretty code folks)\nvar SelectForms = function (selectedEncounter) {\n    if ($(selectedEncounter).prop(\"checked\")) {\n        $(selectedEncounter).parent().children().each(function(i, obj) {\n            $(this).children().each(function(i, obj) {\n                $(this).prop(\"checked\", true);\n            });\n        });\n    }\n    else {\n        $(selectedEncounter).parent().children().each(function(i, obj) {\n            $(this).children().each(function(i, obj) {\n                $(this).prop(\"checked\", false);\n            });\n        });\n    }\n}\n\n// When an issue is checked, auto-check all the related encounters and forms\nfunction issueClick(issue) {\n    // do nothing when unchecked\n    if (! $(issue).attr(\"checked\")) return;\n\n    $(\"#report_form :checkbox\").each(function(i, obj) {\n        if ($(issue).val().indexOf('/' + $(this).val() + '/') >= 0) {\n            $(this).attr(\"checked\", \"checked\");\n        }\n    });\n}\n\nvar listId = '#' + <?php echo js_escape($list_id); ?>;\n$(function () {\n    $(listId).addClass(\"active\");\n});\n\n</script>\n</body>\n</html>\n", "<?php\n\n/**\n * Multi-Factor Authentication Management\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2018 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018-2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE CNU General Public License 3\n */\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\OeUI\\OemrUI;\n\nfunction writeRow($method, $name, $allowEdit = false)\n{\n    echo \"        <tr><td>&nbsp;\";\n    if ($name == '') {\n        echo '<i class=\"fa fa-exclamation-circle oe-text-orange\" aria-hidden=\"true\"></i>' . ' ' . text($method);\n    } else {\n        echo text($method);\n    }\n    echo \"&nbsp;</td><td>&nbsp;\";\n    echo text($name);\n    echo \"&nbsp;</td><td>\";\n    if ($allowEdit) {\n        echo \"<button type='button' class='btn btn-secondary btn-search' onclick='editclick(\" . attr_js($method) . \")'>\" . xlt('View') . \"</button> &nbsp\";\n    }\n    if ($name) {\n        echo \"<button type='button' class='btn btn-secondary btn-delete' onclick='delclick(\" . attr_js($method) . \", \" .\n        attr_js($name) . \")'>\" . xlt('Delete') . \"</button>\";\n    }\n    echo \"</td></tr>\\n\";\n}\n\n$userid = $_SESSION['authUserID'];\n$user_name = getUserIDInfo($userid);\n$user_full_name = $user_name['fname'] . \" \" . $user_name['lname'];\n$message = '';\nif (!empty($_POST['form_delete_method'])) {\n    if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n    // Delete the indicated MFA instance.\n    sqlStatement(\n        \"DELETE FROM login_mfa_registrations WHERE user_id = ? AND method = ? AND name = ?\",\n        array($userid, $_POST['form_delete_method'], $_POST['form_delete_name'])\n    );\n    $message = xl('Delete successful.');\n}\n?>\n<!DOCTYPE html>\n<html>\n<head>\n    <?php Header::setupHeader(); ?>\n\n<title><?php echo xlt('Manage Multi Factor Authentication'); ?></title>\n<script>\n\nfunction delclick(mfamethod, mfaname) {\n    var f = document.forms[0];\n    f.form_delete_method.value = mfamethod;\n    f.form_delete_name.value = mfaname;\n    top.restoreSession();\n    f.submit();\n}\n\nfunction editclick(method) {\n    top.restoreSession();\n    if (method == 'TOTP') {\n        window.location.href = 'mfa_totp.php?action=reg1';\n    }\n    else {\n        alert(<?php echo xlj('Not yet implemented.'); ?>);\n    }\n}\n\nfunction addclick(sel) {\n    top.restoreSession();\n    if (sel.value) {\n        if (sel.value == 'U2F') {\n            window.location.href = 'mfa_u2f.php?action=reg1';\n        } else if (sel.value == 'TOTP') {\n            window.location.href = 'mfa_totp.php?action=reg1';\n        }\n        else {\n            alert(<?php echo xlj('Not yet implemented.'); ?>);\n        }\n    }\n    sel.selectedIndex = 0;\n}\n\n</script>\n<?php\n$arrOeUiSettings = array(\n    'heading_title' => xl('Manage Multi Factor Authentication'),\n    'include_patient_name' => false,\n    'expandable' => false,\n    'expandable_files' => array(),//all file names need suffix _xpd\n    'action' => \"\",//conceal, reveal, search, reset, link or back\n    'action_title' => \"\",\n    'action_href' => \"\",//only for actions - reset, link or back\n    'show_help_icon' => true,\n    'help_file_name' => \"mfa_help.php\"\n);\n$oemr_ui = new OemrUI($arrOeUiSettings);\n?>\n</head>\n<body class=\"body_top\">\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <?php echo $oemr_ui->pageHeading() . \"\\r\\n\"; ?>\n            </div>\n        </div>\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n            <?php\n            if ($message) {?>\n              <div id=\"display_msg\" class=\"alert alert-danger\" style=\"font-size:100%; font-weight:700\"><?php echo text($message); ?></div>\n                <?php\n            }\n            ?>\n            </div>\n        </div>\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <form method='post' action='mfa_registrations.php' onsubmit='return top.restoreSession()'>\n                    <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n                    <div>\n                        <fieldset>\n                            <legend><?php echo xlt('Current Authentication Method for') . \" \" . $user_full_name; ?></legend>\n                            <table class='table'>\n                                <tr>\n                                  <th align='left'>&nbsp;<?php echo xlt('Method'); ?>&nbsp;</th>\n                                  <th align='left'>&nbsp;<?php echo xlt('Key Name'); ?>&nbsp;</th>\n                                  <th align='left'>&nbsp;<?php echo xlt('Action'); ?>&nbsp;</th>\n                                </tr>\n                                <?php\n                                $res = sqlStatement(\"SELECT name, method FROM login_mfa_registrations WHERE \" .\n                                \"user_id = ? ORDER BY method, name\", array($userid));\n                                $disableNewTotp = false;\n                                if (sqlNumRows($res)) {\n                                    while ($row = sqlFetchArray($res)) {\n                                        if ($row['method'] == \"TOTP\") {\n                                            $disableNewTotp = true;\n                                            writeRow($row['method'], $row['name'], true);\n                                        } else {\n                                            writeRow($row['method'], $row['name']);\n                                        }\n                                    }\n                                } else {\n                                    writeRow(xl(\"No method enabled\"), '');\n                                }\n                                ?>\n                            </table>\n                        </fieldset>\n                    </div>\n                    <div>\n                        <fieldset>\n                            <legend><?php echo xlt('Select/Add New Authentication Method for') . \" \" . $user_full_name; ?></legend>\n                            <div class='col-sm-4 offset-sm-4'>\n                                <select name='form_add' onchange='addclick(this)'class='col-sm-12'>\n                                    <option value=''><?php echo xlt('Add New...'); ?></option>\n                                    <option value='U2F'><?php echo xlt('U2F USB Device'); ?></option>\n                                    <option value='TOTP'\n                                        <?php echo ($disableNewTotp) ? 'title=\"' . xla('Only one TOTP Key can be set up per user') . '\"' : ''; ?>\n                                        <?php echo ($disableNewTotp) ? 'disabled' : ''; ?>>\n                                        <?php echo xlt('TOTP Key'); ?>\n                                    </option>\n                                </select>\n                            </div>\n                            <input type='hidden' name='form_delete_method' value='' />\n                            <input type='hidden' name='form_delete_name' value='' />\n                        </fieldset>\n                    </div>\n                </form>\n            </div>\n        </div>\n\n    </div><!--end of container div -->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n</body>\n</html>\n", "<?php\n\n/**\n * App Based TOTP Support\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Anthony Zullo <anthonykzullo@gmail.com>\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2019 Anthony Zullo <anthonykzullo@gmail.com>\n * @copyright Copyright (c) 2018 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018-2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE CNU General Public License 3\n */\n\n// Set $sessionAllowWrite to true to prevent session concurrency issues during authorization related code\n$sessionAllowWrite = true;\nrequire_once('../globals.php');\nrequire_once(\"$srcdir/classes/Totp.class.php\");\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Auth\\AuthUtils;\nuse OpenEMR\\Common\\Crypto\\CryptoGen;\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\OeUI\\OemrUI;\n\n$userid = $_SESSION['authUserID'];\n$action = $_REQUEST['action'];\n$user_name = getUserIDInfo($userid);\n$user_full_name = $user_name['fname'] . \" \" . $user_name['lname'];\n\n?>\n<html>\n<head>\n    <?php Header::setupHeader(); ?>\n    <title><?php echo xlt('TOTP Registration'); ?></title>\n    <script>\n\n        function doregister(step, error) {\n            var f = document.forms[0];\n            f.action.value = step;\n            if (error) {\n                f.error.value = error;\n            }\n            f.action.value = step;\n            top.restoreSession();\n            f.submit();\n        }\n\n        function docancel() {\n            var redirectUrl = 'mfa_registrations.php';\n            window.location.href = 'mfa_registrations.php';\n        }\n\n        $(function () {\n            $('#clearPass').focus();\n        });\n    </script>\n    <style>\n        p {\n            text-align: center\n        }\n            .alert-msg {\n            font-size:100%;\n            font-weight:700;\n        }\n    </style>\n    <?php\n    $arrOeUiSettings = array(\n        'heading_title' => xl('Register Time Based One Time Password Key') . \" - \" . xl('TOTP'),\n        'include_patient_name' => false,\n        'expandable' => false,\n        'expandable_files' => array(),//all file names need suffix _xpd\n        'action' => \"\",//conceal, reveal, search, reset, link or back\n        'action_title' => \"\",\n        'action_href' => \"\",//only for actions - reset, link or back\n        'show_help_icon' => false,\n        'help_file_name' => \"\"\n    );\n    $oemr_ui = new OemrUI($arrOeUiSettings);\n    ?>\n</head>\n<body class=\"body_top\">\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n    <?php\n    // If current step is reg1 or reg2, display the header\n    if ($action == 'reg1' || $action == 'reg2') { ?>\n        <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n            <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <?php echo $oemr_ui->pageHeading() . \"\\r\\n\"; ?>\n                </div>\n            </div>\n        <?php\n    } ?>    <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <form method='post' class=\"form-horizontal\" action='mfa_totp.php' onsubmit='return top.restoreSession()'>\n                        <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n\n\n\n\n                        <?php\n                        // step 1 is to verify the password\n                        if ($action == 'reg1') {\n                            $error = (isset($_GET[\"error\"])) ? $_GET[\"error\"] : false;\n                            ?>\n                            <div>\n                                <fieldset>\n                                    <legend><?php echo xlt('Provide Password for') . \" \" . $user_full_name; ?></legend>\n                                    <div class=\"row\">\n                                        <div class=\"col-sm-12\">\n                                            <?php if ($error == \"auth\") { ?>\n                                                <div class=\"alert alert-danger alert-msg login-failure m-1\">\n                                                    <?php echo xlt('Invalid password'); ?>\n                                                </div>\n                                            <?php } ?>\n                                            <p><?php echo xlt('In order to register your device, please provide your OpenEMR login password'); ?></p>\n                                            <div class=\"col-sm-4 offset-sm-4\">\n                                                <input type=\"password\" class=\"form-control\" id=\"clearPass\" name=\"clearPass\" placeholder=\"<?php echo xla('Password'); ?>:\" >\n                                            </div>\n                                        </div>\n                                    </div>\n                                </fieldset>\n                                <div class=\"form-group clearfix\">\n                                <div class=\"col-sm-12 text-left position-override\">\n                                        <button type=\"button\" class=\"btn btn-secondary btn-save\" value=\"<?php echo xla('Submit'); ?>\" onclick=\"doregister('reg2')\"><?php echo xlt('Submit'); ?></button>\n                                        <button type=\"button\" class=\"btn btn-link btn-cancel\" value=\"<?php echo xla('Cancel'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Cancel'); ?></button>\n                                    </div>\n                                </div>\n                            </div>\n                            <?php\n                        // step 2 is to validate password and display qr code\n                        } elseif ($action == 'reg2') {\n                            if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n                                CsrfUtils::csrfNotVerified();\n                            }\n\n                            // Redirect back to step 1 if user password is incorrect\n                            if (!(new AuthUtils())->confirmPassword($_SESSION['authUser'], $_POST['clearPass'])) {\n                                header(\"Location: mfa_totp.php?action=reg1&error=auth\");\n                                exit();\n                            }\n\n                            // Determines whether existing TOTP method exists already\n                            $existingSecret = privQuery(\n                                \"SELECT var1 FROM login_mfa_registrations WHERE \" .\n                                \"`user_id` = ? AND `method` = 'TOTP'\",\n                                array($userid)\n                            );\n                            if (empty($existingSecret['var1'])) {\n                                $secret = false;\n                                $doesExist = false;\n                            } else {\n                                $cryptoGen = new CryptoGen();\n                                $secret = $cryptoGen->decryptStandard($existingSecret['var1']);\n                                $doesExist = true;\n                            }\n\n                            // Generate a new QR code or existing QR code\n                            $googleAuth = new Totp($secret, $_SESSION['authUser']);\n                            $qr = $googleAuth->generateQrCode();\n\n\n                            // if secret did not exist previously, stores secret in session variable for saving\n                            if (!$doesExist) {\n                                $_SESSION['totpSecret'] = $googleAuth->getSecret();\n                            }\n                            ?>\n                            <fieldset>\n                                <legend><?php echo xlt('Register TOTP Key for') . \" \" . $user_full_name; ?></legend>\n                                <div class=\"row\">\n                                    <div class=\"col-sm-12\">\n                                        <?php if (!$doesExist) { ?>\n                                            <p>\n                                                <?php echo xlt('Scan the following QR code with your preferred authenticator app to register a new TOTP key.'); ?>\n                                            </p>\n                                        <?php } else { // $doesExist ?>\n                                            <p>\n                                                <?php echo xlt('Your current TOTP key QR code is displayed below.'); ?>\n                                            </p>\n                                        <?php } ?>\n                                            <br />\n                                            <img src=\"<?php echo attr($qr); ?>\" class=\"img-responsive center-block\" style=\"height:200px !Important\"/>\n                                            <br />\n                                            <p><?php echo xlt('Example authenticator apps include'); ?></p>:\n                                            <div class=\"col-sm-4 offset-sm-4\">\n                                                <ul>\n                                                    <li><?php echo xlt('Google Auth'); ?>\n                                                        (<a href=\"https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8\" target=\"_blank\" rel=\"noopener\">\n                                                            <?php echo xlt('ios'); ?>\n                                                        </a>,\n                                                        <a href=\"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en\" target=\"_blank\" rel=\"noopener\">\n                                                            <?php echo xlt('android'); ?>\n                                                        </a>)</li>\n                                                    <li><?php echo xlt('Authy'); ?>\n                                                        (<a href=\"https://itunes.apple.com/us/app/authy/id494168017?mt=8\" target=\"_blank\" rel=\"noopener\"><?php echo xlt('ios'); ?></a>, <a href=\"https://play.google.com/store/apps/details?id=com.authy.authy&hl=en\" target=\"_blank\" rel=\"noopener\"><?php echo xlt('android'); ?></a>)</li>\n                                                </ul>\n                                            </div>\n                                    </div>\n                                </div>\n                            </fieldset>\n                            <div class=\"form-group clearfix\">\n                                <div class=\"col-sm-12 text-left position-override\">\n                                    <?php if (!$doesExist) { ?>\n                                        <button type=\"button\" class=\"btn btn-secondary btn-save\" value=\"<?php echo xla('Register'); ?>\" onclick=\"doregister('reg3')\"><?php echo xlt('Register'); ?></button>\n                                        <button type=\"button\" class=\"btn btn-link btn-cancel\" value=\"<?php echo xla('Cancel'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Cancel'); ?></button>\n                                    <?php } else { // $doesExist ?>\n                                        <button type=\"button\" class=\"btn btn-link btn-back\" value=\"<?php echo xla('Back'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Back'); ?></button>\n                                    <?php } ?>\n                                    </div>\n                                </div>\n                            </div>\n                            <?php\n                        // step 3 is to save the qr code\n                        } elseif ($action == 'reg3') {\n                            if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n                                CsrfUtils::csrfNotVerified();\n                            }\n\n                            echo \"<script>\\n\";\n\n                            // Verify that no TOTP method exists already\n                            $row = privQuery(\n                                \"SELECT COUNT(*) AS count FROM login_mfa_registrations WHERE \" .\n                                \"`user_id` = ? AND `method` = 'TOTP'\",\n                                array($userid)\n                            );\n\n\n                            if (empty($row['count']) && isset($_SESSION['totpSecret'])) {\n                                $cryptoGen = new CryptoGen();\n                                privStatement(\n                                    \"INSERT INTO login_mfa_registrations \" .\n                                    \"(`user_id`, `method`, `name`, `var1`, `var2`) VALUES \" .\n                                    \"(?, 'TOTP', 'App Based 2FA', ?, '')\",\n                                    array($userid, $cryptoGen->encryptStandard($_SESSION['totpSecret']))\n                                );\n                                unset($_SESSION['totpSecret']);\n                            } else {\n                                echo \" alert(\" . xlj('TOTP Method already exists and is enabled. Try again.') . \");\\n\";\n                            }\n\n                            echo \"window.location.href = 'mfa_registrations.php';\\n\";\n                            echo \"</script>\\n\";\n                        }\n                        ?>\n\n                        <input type='hidden' name='action' value='' />\n                        <input type='hidden' name='error' value='' />\n                    </form>\n                </div>\n            </div>\n    </div><!--end of container div -->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n</body>\n</html>\n", "<?php\n\n/**\n * FIDO U2F Support Module\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2018 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE CNU General Public License 3\n */\n\nrequire_once('../globals.php');\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\OeUI\\OemrUI;\n\n// https is required, and with a proxy the server might not see it.\n$scheme = \"https://\"; // isset($_SERVER['HTTPS']) ? \"https://\" : \"http://\";\n$appId = $scheme . $_SERVER['HTTP_HOST'];\n$u2f = new u2flib_server\\U2F($appId);\n\n$userid = $_SESSION['authUserID'];\n$action = $_REQUEST['action'];\n$user_name = getUserIDInfo($userid);\n$user_full_name = $user_name['fname'] . \" \" . $user_name['lname'];\n?>\n<html>\n<head>\n<?php Header::setupHeader(); ?>\n<title><?php echo xlt('U2F Registration'); ?></title>\n<script src=\"<?php echo $GLOBALS['webroot'] ?>/library/js/u2f-api.js\"></script>\n<script>\n\nfunction doregister() {\n  var f = document.forms[0];\n  if (f.form_name.value.trim() == '') {\n    alert(<?php echo xlj(\"Please enter a name for this key.\"); ?>);\n    return;\n  }\n  var request = JSON.parse(f.form_request.value);\n  u2f.register(\n    <?php echo js_escape($appId); ?>,\n    [request],\n    [],\n    function(data) {\n      if(data.errorCode && data.errorCode != 0) {\n        alert(<?php echo xlj(\"Registration failed with error\"); ?> + ' ' + data.errorCode);\n        return;\n      }\n      f.form_registration.value = JSON.stringify(data);\n      f.action.value = 'reg2';\n      top.restoreSession();\n      f.submit();\n    },\n    60\n  );\n}\n\nfunction docancel() {\n  window.location.href = 'mfa_registrations.php';\n}\n\n</script>\n<?php\n    $arrOeUiSettings = array(\n        'heading_title' => xl('Register Universal 2nd Factor Key') . \" - \" . xl('U2F'),\n        'include_patient_name' => false,\n        'expandable' => false,\n        'expandable_files' => array(),//all file names need suffix _xpd\n        'action' => \"\",//conceal, reveal, search, reset, link or back\n        'action_title' => \"\",\n        'action_href' => \"\",//only for actions - reset, link or back\n        'show_help_icon' => false,\n        'help_file_name' => \"\"\n    );\n    $oemr_ui = new OemrUI($arrOeUiSettings);\n    ?>\n</head>\n<body class=\"body_top\">\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <?php echo $oemr_ui->pageHeading() . \"\\r\\n\"; ?>\n            </div>\n        </div>\n        <form method='post' action='mfa_u2f.php' onsubmit='return top.restoreSession()'>\n        <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n\n        <?php\n\n        ///////////////////////////////////////////////////////////////////////\n\n        if ($action == 'reg1') {\n            list ($request, $signs) = $u2f->getRegisterData();\n            ?>\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <fieldset>\n                    <legend><?php echo xlt('Register U2F Key for') . \" \" . $user_full_name; ?></legend>\n                    <div class='col-sm-12'>\n                        <p><?php echo xlt(\"Instructions\");?>:\n                            <ul>\n                                <li><?php echo xlt('This will register a new U2F USB key'); ?></li>\n                                <li><?php echo xlt('Type a name for your key, insert it into a USB port and click the Register button below'); ?></li>\n                                <li><?php echo xlt('Then press the flashing button on your key within 1 minute to complete registration'); ?></li>\n                            </ul>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"form_name\" class=\"col-sm-2 col-form-label\"><?php echo xlt('Please give this key a name'); ?></label>\n                        <div class=\"col-sm-4\">\n                            <input type='text' class='form-control' name='form_name' id='form_name'>\n                            <input type='hidden' name='form_request' value='<?php echo attr(json_encode($request)); ?>'>\n                            <input type='hidden' name='form_signs'   value='<?php echo attr(json_encode($signs)); ?>'>\n                            <input type='hidden' name='form_registration' value=''>\n                        </div>\n                    </div>\n\n                    <div class='col-sm-12'>\n                        <ul>\n                            <li><?php echo xlt('A secure (HTTPS) web connection is required for U2F'); ?></li>\n                            <li><?php echo xlt('Chrome browser version 41 and above, Mozilla Firefox browser version 64 and above, Microsoft Edge browser version 19 and above, Safari browser version 13 and above, Opera browser version 40 and Opera browser version 42 and above support FIDO U2F API'); ?></li>\n                            <li><?php echo xlt('Internet Explorer browser version 6 to Internet Explorer browser version 11 does not support FIDO U2F API'); ?></li>\n\n                            <li><?php echo xlt('For U2F support on Linux click'); ?>: <a href='https://www.key-id.com/enable-fido-u2f-linux/' rel=\"noopener\" target='_blank'><?php echo text('Enable FIDO U2F Linux'); ?></a></li>\n                            <li><?php echo xlt('For Firefox click'); ?>: <a href='https://www.trishtech.com/2018/07/enable-fido-u2f-security-key-yubikey-in-mozilla-firefox/' rel=\"noopener\" target='_blank'><?php echo text('Enable FIDO U2F Key in Firefox'); ?></a></li>\n                        </ul>\n                    </div>\n                </fieldset>\n                <div class=\"form-group clearfix\">\n                <div class=\"col-sm-12 text-left position-override\">\n                        <button type=\"button\" class=\"btn btn-secondary btn-save\" value='<?php echo xla('Register'); ?>' onclick='doregister()'><?php echo xlt('Register'); ?></button>\n                        <button type=\"button\" class=\"btn btn-link btn-cancel\" value=\"<?php echo xla('Cancel'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Cancel'); ?></button>\n                    </div>\n                </div>\n            </div>\n        </div>\n            <?php\n        } elseif ($action == 'reg2') {\n            if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n                CsrfUtils::csrfNotVerified();\n            }\n            try {\n                $data = $u2f->doRegister(json_decode($_POST['form_request']), json_decode($_POST['form_registration']));\n            } catch (u2flib_server\\Error $e) {\n                die(xlt('Registration error') . ': ' . text($e->getMessage()));\n            }\n            echo \"<script>\\n\";\n            $row = sqlQuery(\n                \"SELECT COUNT(*) AS count FROM login_mfa_registrations WHERE \" .\n                \"`user_id` = ? AND `name` = ?\",\n                array($userid, $_POST['form_name'])\n            );\n            if (empty($row['count'])) {\n                sqlStatement(\n                    \"INSERT INTO login_mfa_registrations \" .\n                    \"(`user_id`, `method`, `name`, `var1`, `var2`) VALUES \" .\n                    \"(?, 'U2F', ?, ?, ?)\",\n                    array($userid, $_POST['form_name'], json_encode($data), '')\n                );\n            } else {\n                echo \" alert(\" . xlj('This key name is already in use by you. Try again.') . \");\\n\";\n            }\n            echo \" window.location.href = 'mfa_registrations.php';\\n\";\n            echo \"</script>\\n\";\n        }\n\n        ///////////////////////////////////////////////////////////////////////\n\n        ?>\n\n        <input type='hidden' name='action' value='' />\n        </form>\n    </div><!--end of container div -->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n</body>\n</html>\n", "<?php\n\n/**\n * This script Assign acl 'Emergency login'.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Roberto Vasquez <robertogagliotta@gmail.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @author    Daniel Pflieger <daniel@mi-squared.com> <daniel@growlingflea.com>\n * @author    Ken Chapple <ken@mi-squared.com>\n * @copyright Copyright (c) 2015 Roberto Vasquez <robertogagliotta@gmail.com>\n * @copyright Copyright (c) 2017-2019 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2021 Daniel Pflieger <daniel@mi-squared.com> <daniel@growlingflea.com>\n * @copyright Copyright (c) 2021 Ken Chapple <ken@mi-squared.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n$sessionAllowWrite = true;\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/auth.inc\");\n\nuse OpenEMR\\Common\\Acl\\AclExtended;\nuse OpenEMR\\Common\\Acl\\AclMain;\nuse OpenEMR\\Common\\Auth\\AuthUtils;\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\Services\\UserService;\nuse OpenEMR\\Events\\User\\UserUpdatedEvent;\nuse OpenEMR\\Events\\User\\UserCreatedEvent;\n\nif (!empty($_POST)) {\n    if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n}\n\nif (!empty($_GET)) {\n    if (!CsrfUtils::verifyCsrfToken($_GET[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n}\n\nif (!AclMain::aclCheckCore('admin', 'users')) {\n    die(xlt('Access denied'));\n}\n\nif (!AclMain::aclCheckCore('admin', 'super')) {\n    //block non-administrator user from create administrator\n    foreach ($_POST['access_group'] as $aro_group) {\n        if (AclExtended::isGroupIncludeSuperuser($aro_group)) {\n            die(xlt('Saving denied'));\n        };\n    }\n    if ($_POST['mode'] === 'update') {\n        //block non-administrator user from update administrator\n        $user_service = new UserService();\n        $user = $user_service->getUser($_POST['id']);\n        $aro_groups = AclExtended::aclGetGroupTitles($user['username']);\n        foreach ($aro_groups as $aro_group) {\n            if (AclExtended::isGroupIncludeSuperuser($aro_group)) {\n                die(xlt('Saving denied'));\n            };\n        }\n    }\n}\n\n$alertmsg = '';\n$bg_msg = '';\n$set_active_msg = 0;\n$show_message = 0;\n\n/* Sending a mail to the admin when the breakglass user is activated only if $GLOBALS['Emergency_Login_email'] is set to 1 */\nif (!empty($_POST['access_group']) && is_array($_POST['access_group'])) {\n    $bg_count = count($_POST['access_group']);\n    $mail_id = explode(\".\", $SMTP_HOST);\n    for ($i = 0; $i < $bg_count; $i++) {\n        if (($_POST['access_group'][$i] == \"Emergency Login\") && ($_POST['active'] == 'on') && ($_POST['pre_active'] == 0)) {\n            if (($_POST['get_admin_id'] == 1) && ($_POST['admin_id'] != \"\")) {\n                $res = sqlStatement(\"select username from users where id= ? \", array($_POST[\"id\"]));\n                $row = sqlFetchArray($res);\n                $uname = $row['username'];\n                $mail = new MyMailer();\n                $mail->From = $GLOBALS[\"practice_return_email_path\"];\n                $mail->FromName = \"Administrator OpenEMR\";\n                $text_body = \"Hello Security Admin,\\n\\n The Emergency Login user \" . $uname .\n                    \" was activated at \" . date('l jS \\of F Y h:i:s A') . \" \\n\\nThanks,\\nAdmin OpenEMR.\";\n                $mail->Body = $text_body;\n                $mail->Subject = \"Emergency Login User Activated\";\n                $mail->AddAddress($_POST['admin_id']);\n                $mail->Send();\n            }\n        }\n    }\n}\n\n/* To refresh and save variables in mail frame */\nif (isset($_POST[\"privatemode\"]) && $_POST[\"privatemode\"] == \"user_admin\") {\n    if ($_POST[\"mode\"] == \"update\") {\n        $user_data = sqlFetchArray(sqlStatement(\"select * from users where id= ? \", array($_POST[\"id\"])));\n\n        if (isset($_POST[\"username\"])) {\n            sqlStatement(\"update users set username=? where id= ? \", array(trim($_POST[\"username\"]), $_POST[\"id\"]));\n            sqlStatement(\"update `groups` set user=? where user= ?\", array(trim($_POST[\"username\"]), $user_data[\"username\"]));\n        }\n\n        if ($_POST[\"taxid\"]) {\n            sqlStatement(\"update users set federaltaxid=? where id= ? \", array($_POST[\"taxid\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"state_license_number\"]) {\n            sqlStatement(\"update users set state_license_number=? where id= ? \", array($_POST[\"state_license_number\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"drugid\"]) {\n            sqlStatement(\"update users set federaldrugid=? where id= ? \", array($_POST[\"drugid\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"upin\"]) {\n            sqlStatement(\"update users set upin=? where id= ? \", array($_POST[\"upin\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"npi\"]) {\n            sqlStatement(\"update users set npi=? where id= ? \", array($_POST[\"npi\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"taxonomy\"]) {\n            sqlStatement(\"update users set taxonomy = ? where id= ? \", array($_POST[\"taxonomy\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"lname\"]) {\n            sqlStatement(\"update users set lname=? where id= ? \", array($_POST[\"lname\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"job\"]) {\n            sqlStatement(\"update users set specialty=? where id= ? \", array($_POST[\"job\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"mname\"]) {\n            sqlStatement(\"update users set mname=? where id= ? \", array($_POST[\"mname\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"facility_id\"]) {\n            sqlStatement(\"update users set facility_id = ? where id = ? \", array($_POST[\"facility_id\"], $_POST[\"id\"]));\n            //(CHEMED) Update facility name when changing the id\n            sqlStatement(\"UPDATE users, facility SET users.facility = facility.name WHERE facility.id = ? AND users.id = ?\", array($_POST[\"facility_id\"], $_POST[\"id\"]));\n            //END (CHEMED)\n        }\n\n        if ($GLOBALS['restrict_user_facility'] && $_POST[\"schedule_facility\"]) {\n            $sqlBindArray = [];\n            $scheduledFacilityString = \"\";\n            foreach ($_POST[\"schedule_facility\"] as $scheduledFacility) {\n                $scheduledFacilityString .= \"?,\";\n                array_push($sqlBindArray, $scheduledFacility);\n            }\n            if (!empty($scheduledFacilityString)) {\n                $scheduledFacilityString = substr($scheduledFacilityString, 0, -1);\n            }\n            array_unshift($sqlBindArray, $_POST[\"id\"]);\n            sqlStatement(\"delete from users_facility\n            where tablename='users'\n            and table_id= ?\n            and facility_id not in (\" . $scheduledFacilityString . \")\", $sqlBindArray);\n\n            foreach ($_POST[\"schedule_facility\"] as $tqvar) {\n                sqlStatement(\"replace into users_facility set\n                facility_id = ?,\n                tablename='users',\n                table_id = ?\", array($tqvar, $_POST[\"id\"]));\n            }\n        }\n\n        if ($_POST[\"fname\"]) {\n            sqlStatement(\"update users set fname=? where id= ? \", array($_POST[\"fname\"], $_POST[\"id\"]));\n        }\n\n        if (isset($_POST['default_warehouse'])) {\n            sqlStatement(\"UPDATE users SET default_warehouse = ? WHERE id = ?\", array($_POST['default_warehouse'], $_POST[\"id\"]));\n        }\n\n        if (isset($_POST['irnpool'])) {\n            sqlStatement(\"UPDATE users SET irnpool = ? WHERE id = ?\", array($_POST['irnpool'], $_POST[\"id\"]));\n        }\n\n        if (!empty($_POST['clear_2fa'])) {\n            sqlStatement(\"DELETE FROM login_mfa_registrations WHERE user_id = ?\", array($_POST['id']));\n        }\n\n        if ($_POST[\"adminPass\"] && $_POST[\"clearPass\"]) {\n            $authUtilsUpdatePassword = new AuthUtils();\n            $success = $authUtilsUpdatePassword->updatePassword($_SESSION['authUserID'], $_POST['id'], $_POST['adminPass'], $_POST['clearPass']);\n            if (!$success) {\n                error_log(errorLogEscape($authUtilsUpdatePassword->getErrorMessage()));\n                $alertmsg .= $authUtilsUpdatePassword->getErrorMessage();\n            }\n        }\n\n        $tqvar  = (!empty($_POST[\"authorized\"])) ? 1 : 0;\n        $actvar = (!empty($_POST[\"active\"]))     ? 1 : 0;\n        $calvar = (!empty($_POST[\"calendar\"]))   ? 1 : 0;\n        $portalvar = (!empty($_POST[\"portal_user\"])) ? 1 : 0;\n\n        sqlStatement(\"UPDATE users SET authorized = ?, active = ?, \" .\n        \"calendar = ?, portal_user = ?, see_auth = ? WHERE \" .\n        \"id = ? \", array($tqvar, $actvar, $calvar, $portalvar, $_POST['see_auth'], $_POST[\"id\"]));\n      //Display message when Emergency Login user was activated\n        $bg_count = count($_POST['access_group']);\n        for ($i = 0; $i < $bg_count; $i++) {\n            if (($_POST['access_group'][$i] == \"Emergency Login\") && ($_POST['pre_active'] == 0) && ($actvar == 1)) {\n                $show_message = 1;\n            }\n        }\n\n        if (($_POST['access_group'])) {\n            for ($i = 0; $i < $bg_count; $i++) {\n                if (($_POST['access_group'][$i] == \"Emergency Login\") && ($_POST['user_type']) == \"\" && ($_POST['check_acl'] == 1) && ($_POST['active']) != \"\") {\n                    $set_active_msg = 1;\n                }\n            }\n        }\n\n        if ($_POST[\"comments\"]) {\n            sqlStatement(\"update users set info = ? where id = ? \", array($_POST[\"comments\"], $_POST[\"id\"]));\n        }\n\n        $erxrole = isset($_POST['erxrole']) ? $_POST['erxrole'] : '';\n        sqlStatement(\"update users set newcrop_user_role = ? where id = ? \", array($erxrole, $_POST[\"id\"]));\n\n        if ($_POST[\"physician_type\"]) {\n            sqlStatement(\"update users set physician_type = ? where id = ? \", array($_POST[\"physician_type\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"main_menu_role\"]) {\n              $mainMenuRole = filter_input(INPUT_POST, 'main_menu_role');\n              sqlStatement(\"update `users` set `main_menu_role` = ? where `id` = ? \", array($mainMenuRole, $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"patient_menu_role\"]) {\n            $patientMenuRole = filter_input(INPUT_POST, 'patient_menu_role');\n            sqlStatement(\"update `users` set `patient_menu_role` = ? where `id` = ? \", array($patientMenuRole, $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"erxprid\"]) {\n            sqlStatement(\"update users set weno_prov_id = ? where id = ? \", array($_POST[\"erxprid\"], $_POST[\"id\"]));\n        }\n\n        if (isset($_POST[\"supervisor_id\"])) {\n            sqlStatement(\"update users set supervisor_id = ? where id = ? \", array((int)$_POST[\"supervisor_id\"], $_POST[\"id\"]));\n        }\n        if (isset($_POST[\"google_signin_email\"])) {\n            sqlStatement(\"update users set google_signin_email = ? where id = ? \", array($_POST[\"google_signin_email\"], $_POST[\"id\"]));\n        }\n\n        // Set the access control group of user\n        $user_data = sqlFetchArray(sqlStatement(\"select username from users where id= ?\", array($_POST[\"id\"])));\n        AclExtended::setUserAro(\n            $_POST['access_group'],\n            $user_data[\"username\"],\n            (isset($_POST['fname']) ? $_POST['fname'] : ''),\n            (isset($_POST['mname']) ? $_POST['mname'] : ''),\n            (isset($_POST['lname']) ? $_POST['lname'] : '')\n        );\n\n        $userUpdatedEvent = new UserUpdatedEvent($user_data, $_POST);\n        $GLOBALS[\"kernel\"]->getEventDispatcher()->dispatch(UserUpdatedEvent::EVENT_HANDLE, $userUpdatedEvent, 10);\n    }\n}\n\n/* To refresh and save variables in mail frame  - Arb*/\nif (isset($_POST[\"mode\"])) {\n    if ($_POST[\"mode\"] == \"new_user\") {\n        if (empty($_POST[\"authorized\"]) || $_POST[\"authorized\"] != \"1\") {\n            $_POST[\"authorized\"] = 0;\n        }\n\n        $calvar = (!empty($_POST[\"calendar\"])) ? 1 : 0;\n        $portalvar = (!empty($_POST[\"portal_user\"])) ? 1 : 0;\n\n        $res = sqlStatement(\"select distinct username from users where username != ''\");\n        $doit = true;\n        while ($row = sqlFetchArray($res)) {\n            if ($doit == true && $row['username'] == trim($_POST['rumple'])) {\n                $doit = false;\n            }\n        }\n\n        if ($doit == true) {\n            $insertUserSQL =\n            \"insert into users set \" .\n            \"username = '\"         . add_escape_custom(trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))) .\n            \"', password = '\"      . 'NoLongerUsed'                  .\n            \"', fname = '\"         . add_escape_custom(trim((isset($_POST['fname']) ? $_POST['fname'] : ''))) .\n            \"', mname = '\"         . add_escape_custom(trim((isset($_POST['mname']) ? $_POST['mname'] : ''))) .\n            \"', lname = '\"         . add_escape_custom(trim((isset($_POST['lname']) ? $_POST['lname'] : ''))) .\n            \"', federaltaxid = '\"  . add_escape_custom(trim((isset($_POST['federaltaxid']) ? $_POST['federaltaxid'] : ''))) .\n            \"', state_license_number = '\"  . add_escape_custom(trim((isset($_POST['state_license_number']) ? $_POST['state_license_number'] : ''))) .\n            \"', newcrop_user_role = '\"  . add_escape_custom(trim((isset($_POST['erxrole']) ? $_POST['erxrole'] : ''))) .\n            \"', physician_type = '\"  . add_escape_custom(trim((isset($_POST['physician_type']) ? $_POST['physician_type'] : ''))) .\n            \"', main_menu_role = '\"  . add_escape_custom(trim((isset($_POST['main_menu_role']) ? $_POST['main_menu_role'] : ''))) .\n            \"', patient_menu_role = '\"  . add_escape_custom(trim((isset($_POST['patient_menu_role']) ? $_POST['patient_menu_role'] : ''))) .\n            \"', weno_prov_id = '\"  . add_escape_custom(trim((isset($_POST['erxprid']) ? $_POST['erxprid'] : ''))) .\n            \"', authorized = '\"    . add_escape_custom(trim((isset($_POST['authorized']) ? $_POST['authorized'] : ''))) .\n            \"', info = '\"          . add_escape_custom(trim((isset($_POST['info']) ? $_POST['info'] : ''))) .\n            \"', federaldrugid = '\" . add_escape_custom(trim((isset($_POST['federaldrugid']) ? $_POST['federaldrugid'] : ''))) .\n            \"', upin = '\"          . add_escape_custom(trim((isset($_POST['upin']) ? $_POST['upin'] : ''))) .\n            \"', npi  = '\"          . add_escape_custom(trim((isset($_POST['npi']) ? $_POST['npi'] : ''))) .\n            \"', taxonomy = '\"      . add_escape_custom(trim((isset($_POST['taxonomy']) ? $_POST['taxonomy'] : ''))) .\n            \"', facility_id = '\"   . add_escape_custom(trim((isset($_POST['facility_id']) ? $_POST['facility_id'] : ''))) .\n            \"', specialty = '\"     . add_escape_custom(trim((isset($_POST['specialty']) ? $_POST['specialty'] : ''))) .\n            \"', see_auth = '\"      . add_escape_custom(trim((isset($_POST['see_auth']) ? $_POST['see_auth'] : ''))) .\n            \"', default_warehouse = '\" . add_escape_custom(trim((isset($_POST['default_warehouse']) ? $_POST['default_warehouse'] : ''))) .\n            \"', irnpool = '\"       . add_escape_custom(trim((isset($_POST['irnpool']) ? $_POST['irnpool'] : ''))) .\n            \"', calendar = '\"      . add_escape_custom($calvar) .\n            \"', portal_user = '\"   . add_escape_custom($portalvar) .\n            \"', supervisor_id = '\" . add_escape_custom((isset($_POST['supervisor_id']) ? (int)$_POST['supervisor_id'] : 0)) .\n            \"'\";\n\n            $authUtilsNewPassword = new AuthUtils();\n            $success = $authUtilsNewPassword->updatePassword(\n                $_SESSION['authUserID'],\n                0,\n                $_POST['adminPass'],\n                $_POST['stiltskin'],\n                true,\n                $insertUserSQL,\n                trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n            );\n            if (!empty($authUtilsNewPassword->getErrorMessage())) {\n                $alertmsg .= $authUtilsNewPassword->getErrorMessage();\n            }\n            if ($success) {\n                //set the facility name from the selected facility_id\n                sqlStatement(\n                    \"UPDATE users, facility SET users.facility = facility.name WHERE facility.id = ? AND users.username = ?\",\n                    array(\n                        trim((isset($_POST['facility_id']) ? $_POST['facility_id'] : '')),\n                        trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n                    )\n                );\n\n                sqlStatement(\n                    \"insert into `groups` set name = ?, user = ?\",\n                    array(\n                        trim((isset($_POST['groupname']) ? $_POST['groupname'] : '')),\n                        trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n                    )\n                );\n\n                if (trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))) {\n                              // Set the access control group of user\n                              AclExtended::setUserAro(\n                                  $_POST['access_group'],\n                                  trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')),\n                                  trim((isset($_POST['fname']) ? $_POST['fname'] : '')),\n                                  trim((isset($_POST['mname']) ? $_POST['mname'] : '')),\n                                  trim((isset($_POST['lname']) ? $_POST['lname'] : ''))\n                              );\n                }\n            }\n        } else {\n            $alertmsg .= xl('User') . ' ' . trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')) . ' ' . xl('already exists.');\n        }\n\n        if ($_POST['access_group']) {\n            $bg_count = count($_POST['access_group']);\n            for ($i = 0; $i < $bg_count; $i++) {\n                if ($_POST['access_group'][$i] == \"Emergency Login\") {\n                      $set_active_msg = 1;\n                }\n            }\n        }\n\n        $userCreatedEvent = new UserCreatedEvent($_POST);\n        $GLOBALS[\"kernel\"]->getEventDispatcher()->dispatch(UserCreatedEvent::EVENT_HANDLE, $userCreatedEvent, 10);\n    } elseif ($_POST[\"mode\"] == \"new_group\") {\n        $res = sqlStatement(\"select distinct name, user from `groups`\");\n        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n            $result[$iter] = $row;\n        }\n\n        $doit = 1;\n        foreach ($result as $iter) {\n            if ($doit == 1 && $iter[\"name\"] == (trim((isset($_POST['groupname']) ? $_POST['groupname'] : ''))) && $iter[\"user\"] == (trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')))) {\n                $doit--;\n            }\n        }\n\n        if ($doit == 1) {\n            sqlStatement(\n                \"insert into `groups` set name = ?, user = ?\",\n                array(\n                    trim((isset($_POST['groupname']) ? $_POST['groupname'] : '')),\n                    trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n                )\n            );\n        } else {\n            $alertmsg .= \"User \" . trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')) .\n            \" is already a member of group \" . trim((isset($_POST['groupname']) ? $_POST['groupname'] : '')) . \". \";\n        }\n    }\n}\n\nif (isset($_GET[\"mode\"])) {\n  /*******************************************************************\n  // This is the code to delete a user.  Note that the link which invokes\n  // this is commented out.  Somebody must have figured it was too dangerous.\n  //\n  if ($_GET[\"mode\"] == \"delete\") {\n    $res = sqlStatement(\"select distinct username, id from users where id = '\" .\n      $_GET[\"id\"] . \"'\");\n    for ($iter = 0; $row = sqlFetchArray($res); $iter++)\n      $result[$iter] = $row;\n\n    // TBD: Before deleting the user, we should check all tables that\n    // reference users to make sure this user is not referenced!\n\n    foreach($result as $iter) {\n      sqlStatement(\"delete from `groups` where user = '\" . $iter[\"username\"] . \"'\");\n    }\n    sqlStatement(\"delete from users where id = '\" . $_GET[\"id\"] . \"'\");\n  }\n  *******************************************************************/\n\n    if ($_GET[\"mode\"] == \"delete_group\") {\n        $res = sqlStatement(\"select distinct user from `groups` where id = ?\", array($_GET[\"id\"]));\n        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n            $result[$iter] = $row;\n        }\n\n        foreach ($result as $iter) {\n            $un = $iter[\"user\"];\n        }\n\n        $res = sqlStatement(\"select name, user from `groups` where user = ? \" .\n        \"and id != ?\", array($un, $_GET[\"id\"]));\n\n        // Remove the user only if they are also in some other group.  I.e. every\n        // user must be a member of at least one group.\n        if (sqlFetchArray($res) != false) {\n              sqlStatement(\"delete from `groups` where id = ?\", array($_GET[\"id\"]));\n        } else {\n              $alertmsg .= \"You must add this user to some other group before \" .\n                \"removing them from this group. \";\n        }\n    }\n}\n// added for form submit's from usergroup_admin_add and user_admin.php\n// sjp 12/29/17\nif (isset($_REQUEST[\"mode\"])) {\n    exit(text(trim($alertmsg)));\n}\n\n$form_inactive = empty($_POST['form_inactive']) ? false : true;\n\n?>\n<html>\n<head>\n<title><?php echo xlt('User / Groups');?></title>\n\n<?php Header::setupHeader(['common']); ?>\n\n<script>\n\n$(function () {\n\n    tabbify();\n\n    $(\".medium_modal\").on('click', function(e) {\n        e.preventDefault();e.stopPropagation();\n        dlgopen('', '', 'modal-mlg', 450, '', '', {\n            type: 'iframe',\n            url: $(this).attr('href')\n        });\n    });\n\n});\n\nfunction authorized_clicked() {\n var f = document.forms[0];\n f.calendar.disabled = !f.authorized.checked;\n f.calendar.checked  =  f.authorized.checked;\n}\n\n</script>\n\n</head>\n<body class=\"body_top\">\n\n<div class=\"container\">\n    <div class=\"row\">\n        <div class=\"col-12\">\n            <div class=\"page-title\">\n                <h2><?php echo xlt('User / Groups');?></h2>\n            </div>\n        </div>\n    </div>\n    <div class=\"row\">\n        <div class=\"col-12\">\n            <div class=\"btn-group\">\n                <a href=\"usergroup_admin_add.php\" class=\"medium_modal btn btn-secondary btn-add\"><?php echo xlt('Add User'); ?></a>\n                <a href=\"facility_user.php\" class=\"btn btn-secondary btn-show\"><?php echo xlt('View Facility Specific User Information'); ?></a>\n            </div>\n            <form name='userlist' method='post' style=\"display: inline;\" class=\"form-inline\" class=\"float-right\" action='usergroup_admin.php' onsubmit='return top.restoreSession()'>\n                <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n                <div class=\"checkbox\">\n                    <label for=\"form_inactive\">\n                        <input type='checkbox' class=\"form-control\" id=\"form_inactive\" name='form_inactive' value='1' onclick='submit()' <?php echo ($form_inactive) ? 'checked ' : ''; ?>>\n                        <?php echo xlt('Include inactive users'); ?>\n                    </label>\n                </div>\n            </form>\n        </div>\n    </div>\n    <div class=\"row\">\n        <div class=\"col-12\">\n            <?php\n            if ($set_active_msg == 1) {\n                echo \"<div class='alert alert-danger'>\" . xlt('Emergency Login ACL is chosen. The user is still in active state, please de-activate the user and activate the same when required during emergency situations. Visit Administration->Users for activation or de-activation.') . \"</div><br />\";\n            }\n\n            if ($show_message == 1) {\n                echo \"<div class='alert alert-danger'>\" . xlt('The following Emergency Login User is activated:') . \" \" . \"<b>\" . text($_GET['fname']) . \"</b>\" . \"</div><br />\";\n                echo \"<div class='alert alert-danger'>\" . xlt('Emergency Login activation email will be circulated only if following settings in the interface/globals.php file are configured:') . \" \\$GLOBALS['Emergency_Login_email'], \\$GLOBALS['Emergency_Login_email_id']</div>\";\n            }\n\n            ?>\n            <div class=\"table-responsive\">\n                <table class=\"table table-striped\">\n                    <thead>\n                    <tr>\n                        <th><?php echo xlt('Username'); ?></th>\n                        <th><?php echo xlt('Real Name'); ?></th>\n                        <th><?php echo xlt('Additional Info'); ?></th>\n                        <th><?php echo xlt('Authorized'); ?></th>\n                        <th><?php echo xlt('MFA'); ?></th>\n                        <?php\n                        $checkPassExp = false;\n                        if (($GLOBALS['password_expiration_days'] != 0) && (check_integer($GLOBALS['password_expiration_days'])) && (check_integer($GLOBALS['password_grace_time']))) {\n                            $checkPassExp = true;\n                            echo '<th>' . xlt('Password Expiration') . '</th>';\n                        }\n                        ?>\n                    </tr>\n                    <tbody>\n                        <?php\n                        $query = \"SELECT * FROM users WHERE username != '' \";\n                        if (!$form_inactive) {\n                            $query .= \"AND active = '1' \";\n                        }\n\n                        $query .= \"ORDER BY username\";\n                        $res = sqlStatement($query);\n                        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n                            $result4[$iter] = $row;\n                        }\n\n                        foreach ($result4 as $iter) {\n                            if ($iter[\"authorized\"]) {\n                                $iter[\"authorized\"] = xl('yes');\n                            } else {\n                                $iter[\"authorized\"] = xl('no');\n                            }\n\n                            $mfa = sqlQuery(\n                                \"SELECT `method` FROM `login_mfa_registrations` \" .\n                                \"WHERE `user_id` = ? AND (`method` = 'TOTP' OR `method` = 'U2F')\",\n                                [$iter['id']]\n                            );\n                            if (!empty($mfa['method'])) {\n                                $isMfa = xl('yes');\n                            } else {\n                                $isMfa = xl('no');\n                            }\n\n                            if ($checkPassExp && !empty($iter[\"active\"])) {\n                                $current_date = date(\"Y-m-d\");\n                                $userSecure = privQuery(\"SELECT `last_update_password` FROM `users_secure` WHERE `id` = ?\", [$iter['id']]);\n                                $pwd_expires = date(\"Y-m-d\", strtotime($userSecure['last_update_password'] . \"+\" . $GLOBALS['password_expiration_days'] . \" days\"));\n                                $grace_time = date(\"Y-m-d\", strtotime($pwd_expires . \"+\" . $GLOBALS['password_grace_time'] . \" days\"));\n                            }\n\n                            print \"<tr>\n                                <td><b><a href='user_admin.php?id=\" . attr_url($iter[\"id\"]) . \"&csrf_token_form=\" . attr_url(CsrfUtils::collectCsrfToken()) .\n                                \"' class='medium_modal' onclick='top.restoreSession()'>\" . text($iter[\"username\"]) . \"</a></b>\" . \"&nbsp;</td>\n                                <td>\" . text($iter[\"fname\"]) . ' ' . text($iter[\"lname\"]) . \"&nbsp;</td>\n                                <td>\" . text($iter[\"info\"]) . \"&nbsp;</td>\n                                <td align='left'><span>\" . text($iter[\"authorized\"]) . \"</td>\n                                <td align='left'><span>\" . text($isMfa) . \"</td>\";\n                            if ($checkPassExp) {\n                                echo '<td>';\n                                if (AuthUtils::useActiveDirectory($iter[\"username\"]) || empty($iter[\"active\"])) {\n                                    // LDAP bypasses expired password mechanism\n                                    echo '<div class=\"alert alert-success\" role=\"alert\">' . xlt('Not Applicable') . '</div>';\n                                } elseif (strtotime($current_date) > strtotime($grace_time)) {\n                                    echo '<div class=\"alert alert-danger\" role=\"alert\">' . xlt('Expired') . '</div>';\n                                } elseif (strtotime($current_date) > strtotime($pwd_expires)) {\n                                    echo '<div class=\"alert alert-warning\" role=\"alert\">' . xlt('Grace Period') . '</div>';\n                                } else {\n                                    echo '<div class=\"alert alert-success\" role=\"alert\">' . text(oeFormatShortDate($pwd_expires)) . '</div>';\n                                }\n                                echo '</td>';\n                            }\n                            print \"</tr>\\n\";\n                        }\n                        ?>\n                    </tbody>\n                </table>\n            </div>\n            <?php\n            if (empty($GLOBALS['disable_non_default_groups'])) {\n                $res = sqlStatement(\"select * from `groups` order by name\");\n                for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n                    $result5[$iter] = $row;\n                }\n\n                foreach ($result5 as $iter) {\n                    $grouplist[$iter[\"name\"]] .= text($iter[\"user\"]) .\n                        \"(<a class='link_submit' href='usergroup_admin.php?mode=delete_group&id=\" .\n                        attr_url($iter[\"id\"]) . \"&csrf_token_form=\" . attr_url(CsrfUtils::collectCsrfToken()) . \"' onclick='top.restoreSession()'>\" . xlt('Remove') . \"</a>), \";\n                }\n\n                foreach ($grouplist as $groupname => $list) {\n                    print \"<span class='bold'>\" . text($groupname) . \"</span><br />\\n<span>\" .\n                        substr($list, 0, strlen($list) - 2) . \"</span><br />\\n\";\n                }\n            }\n            ?>\n        </div>\n    </div>\n</div>\n<script>\n<?php\nif ($alertmsg = trim($alertmsg)) {\n    echo \"alert(\" . js_escape($alertmsg) . \");\\n\";\n}\n?>\n</script>\n</body>\n</html>\n"], "fixing_code": ["<?php\n\n/**\n * Patient matching and selection dialog.\n *\n * @package   OpenEMR\n * @link      https://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2013-2015 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/patient.inc\");\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\n\n$form_key = $_REQUEST['key'];\n$args = unserialize($form_key, ['allowed_classes' => false]);\n$form_ss = preg_replace('/[^0-9]/', '', $args['ss']);\n$form_fname = $args['fname'];\n$form_lname = $args['lname'];\n$form_DOB = $args['DOB'];\n?>\n<!DOCTYPE html>\n<html>\n<head>\n<?php Header::setupHeader(['opener']); ?>\n<style>\n    .oneResult {\n    }\n</style>\n<script>\n\n    $(function () {\n        $(\".oneresult\").mouseover(function () {\n            $(this).addClass(\"highlight\");\n        });\n        $(\".oneresult\").mouseout(function () {\n            $(this).removeClass(\"highlight\");\n        });\n    });\n\n    function myRestoreSession() {\n        if (top.restoreSession) top.restoreSession(); else opener.top.restoreSession();\n        return true;\n    }\n\n    function openPatient(ptid) {\n        var f = opener.document.forms[0];\n        var ename = <?php echo js_escape(\"select[$form_key]\"); ?>;\n        if (f[ename]) {\n            f[ename].value = ptid;\n            window.close();\n        }\n        else {\n            alert(<?php echo xlj('Form element not found'); ?> + ': ' + ename);\n        }\n    }\n\n</script>\n</head>\n\n<body class=\"body_top\">\n<form method='post' action='patient_select.php' onsubmit='return myRestoreSession()'>\n<input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n<?php\nif ($form_key) {\n    $clarr = array();\n    $clsql = \"0\";\n// First name.\n    if ($form_fname !== '') {\n        $clsql .= \" + ((fname IS NOT NULL AND fname = ?) * 5)\";\n        $clarr[] = $form_fname;\n    }\n\n// Last name.\n    if ($form_lname !== '') {\n        $clsql .= \" + ((lname IS NOT NULL AND lname = ?) * 5)\";\n        $clarr[] = $form_lname;\n    }\n\n// Birth date.\n    if ($form_DOB !== '') {\n        $clsql .= \" + ((DOB IS NOT NULL AND DOB = ?) * 5)\";\n        $clarr[] = $form_DOB;\n    }\n\n// SSN match is worth a lot and we allow for matching on last 4 digits.\n    if (strlen($form_ss) > 3) {\n        $clsql .= \" + ((ss IS NOT NULL AND ss LIKE ?) * 10)\";\n        $clarr[] = \"%$form_ss\";\n    }\n\n    $sql = \"SELECT $clsql AS closeness, \" .\n        \"pid, pubpid, fname, lname, mname, DOB, ss, postal_code, street, \" .\n        \"phone_biz, phone_home, phone_cell, phone_contact \" .\n        \"FROM patient_data \" .\n        \"ORDER BY closeness DESC, lname, fname LIMIT 10\";\n    $res = sqlStatement($sql, $clarr);\n    ?>\n\n    <div id=\"searchResults\">\n\n        <table class=\"table table-striped table-sm\">\n            <h5>\n                <?php\n                echo xlt('Matching for Patient') . \": \" .\n                    text(\"$form_lname, $form_fname\") . text(\" Dob = $form_DOB\") .\n                    \" SS = \" . text(($form_ss ? $form_ss : \"unk\"))\n                ?>\n            </h5>\n            <tr>\n                <th><?php echo xlt('Name'); ?></th>\n                <th><?php echo xlt('Phone'); ?></th>\n                <th><?php echo xlt('SS'); ?></th>\n                <th><?php echo xlt('DOB'); ?></th>\n                <th><?php echo xlt('Address'); ?></th>\n            </tr>\n\n            <?php\n            while ($row = sqlFetchArray($res)) {\n                if ($row['closeness'] == 0) {\n                    continue;\n                }\n\n                $phone = $row['phone_biz'];\n                if (empty($phone)) {\n                    $phone = $row['phone_home'];\n                }\n\n                if (empty($phone)) {\n                    $phone = $row['phone_cell'];\n                }\n\n                if (empty($phone)) {\n                    $phone = $row['phone_contact'];\n                }\n\n                echo \"  <tr class='oneresult'\";\n                echo \" onclick=\\\"openPatient(\" . attr_js($row['pid']) . \")\\\">\\n\";\n                echo \"   <td>\" . text($row['lname'] . \", \" . $row['fname']) . \"</td>\\n\";\n                echo \"   <td>\" . text($phone) . \"</td>\\n\";\n                echo \"   <td>\" . text($row['ss']) . \"</td>\\n\";\n                echo \"   <td>\" . text($row['DOB']) . \"</td>\\n\";\n                echo \"   <td>\" . text($row['street'] . ' ' . $row['postal_code']) . \"</td>\\n\";\n                echo \"  </tr>\\n\";\n            }\n            ?>\n        </table>\n    </div>\n    <?php\n}\n?>\n\n<p>\n    <input type='button' value='<?php echo xla('Add New Patient'); ?>' onclick=\"openPatient(0)\"/>\n    <input type='button' value='<?php echo xla('Cancel'); ?>' onclick=\"window.close()\"/>\n</p>\n\n</form>\n</center>\n</body>\n</html>\n", "<?php\n\n/**\n * Patient report\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2017-2018 Brady Miller <brady.g.miller@gmail.com>\n * @author    Stephen Nielson <stephen@nielson.org>\n * @copyright Copyright (c) 2019 Stephen Nielson <stephen@nielson.org>\n * @author    Jerry Padgett <sjpadgett@gmail.com>\n * @copyright Copyright (c) 2019 Jerry Padgett <sjpadgett@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\nrequire_once(\"../../globals.php\");\nrequire_once(\"$srcdir/lists.inc\");\nrequire_once(\"$srcdir/forms.inc\");\nrequire_once(\"$srcdir/patient.inc\");\n\nuse OpenEMR\\Common\\Acl\\AclMain;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\Events\\PatientReport\\PatientReportEvent;\nuse OpenEMR\\Menu\\PatientMenuRole;\nuse OpenEMR\\OeUI\\OemrUI;\nuse Symfony\\Component\\EventDispatcher\\EventDispatcherInterface;\nuse Symfony\\Component\\EventDispatcher\\GenericEvent;\n\nif (!AclMain::aclCheckCore('patients', 'pat_rep')) {\n    die(xlt('Not authorized'));\n}\n// get various authorization levels\n$auth_notes_a  = AclMain::aclCheckCore('encounters', 'notes_a');\n$auth_notes    = AclMain::aclCheckCore('encounters', 'notes');\n$auth_coding_a = AclMain::aclCheckCore('encounters', 'coding_a');\n$auth_coding   = AclMain::aclCheckCore('encounters', 'coding');\n$auth_relaxed  = AclMain::aclCheckCore('encounters', 'relaxed');\n$auth_med      = AclMain::aclCheckCore('patients', 'med');\n$auth_demo     = AclMain::aclCheckCore('patients', 'demo');\n\n$oefax = !empty($GLOBALS['oefax_enable']) ? $GLOBALS['oefax_enable'] : 0;\n/**\n * @var EventDispatcherInterface $eventDispatcher  The event dispatcher / listener object\n */\n$eventDispatcher = $GLOBALS['kernel']->getEventDispatcher();\n?>\n<html>\n<head>\n<title><?php echo xlt(\"Patient Reports\"); ?></title>\n\n<?php Header::setupHeader(['datetime-picker', 'common']); ?>\n<script>\n\nfunction checkAll(check) {\n var f = document.forms['report_form'];\n for (var i = 0; i < f.elements.length; ++i) {\n  if (f.elements[i].type == 'checkbox') f.elements[i].checked = check;\n }\n return false;\n}\n\nfunction show_date_fun(){\n  if(document.getElementById('show_date').checked == true){\n    document.getElementById('date_div').style.display = '';\n  }else{\n    document.getElementById('date_div').style.display = 'none';\n  }\n  return;\n}\n<?php require_once(\"$include_root/patient_file/erx_patient_portal_js.php\"); // jQuery for popups for eRx and patient portal ?>\n</script>\n<?php\n$arrOeUiSettings = array(\n    'heading_title' => xl('Patient Reports'),\n    'include_patient_name' => true,\n    'expandable' => false,\n    'expandable_files' => array(),//all file names need suffix _xpd\n    'action' => \"\",//conceal, reveal, search, reset, link or back\n    'action_title' => \"\",\n    'action_href' => \"\",//only for actions - reset, link or back\n    'show_help_icon' => true,\n    'help_file_name' => \"report_dashboard_help.php\"\n);\n$oemr_ui = new OemrUI($arrOeUiSettings);\n?>\n</head>\n\n<body>\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?> mt-3\">\n        <div id=\"patient_reports\"> <!-- large outer DIV -->\n            <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <?php require_once(\"$include_root/patient_file/summary/dashboard_header.php\");?>\n                </div>\n            </div>\n            <?php\n            $list_id = \"report\"; // to indicate nav item is active, count and give correct id\n            // Collect the patient menu then build it\n            $menuPatient = new PatientMenuRole();\n            $menuPatient->displayHorizNavBarMenu();\n            ?>\n\n            <?php\n            if ($GLOBALS['activate_ccr_ccd_report']) { // show CCR/CCD reporting options ?>\n                <div class=\"mt-3\" id=\"ccr_report\">\n                    <form name='ccr_form' id='ccr_form' method='post' action='../../../ccr/createCCR.php'>\n                        <fieldset>\n                            <div class=\"col-sm-12\">\n                                <span class='title oe-report-section-header'><?php echo xlt('Continuity of Care Record (CCR)'); ?></span>\n                                <span class='text'>(<?php echo xlt('Pop ups need to be enabled to see these reports'); ?>)</span>\n                                <br/>\n                                <br/>\n                                <input type='hidden' name='ccrAction' />\n                                <input type='hidden' name='raw' />\n                                <input type=\"checkbox\" name=\"show_date\" id=\"show_date\" onchange=\"show_date_fun();\" ><span class='text'><?php echo xlt('Use Date Range'); ?>\n                                <br />\n                                <br />\n                                <div id=\"date_div\" style=\"display: none\">\n                                    <div class=\"form-row\">\n                                        <div class=\"col-12 col-sm-2\">\n                                        <label for=\"Start\" class='font-weight-bold'><?php echo xlt('Start Date');?>: </label>\n                                        </div>\n                                        <div class=\"col-12 col-sm-4\">\n                                            <input type='text' class='datepicker form-control' size='10' name='Start' id='Start' title='<?php echo xla('yyyy-mm-dd'); ?>' />\n                                        </div>\n                                        <div class=\"col-12 col-sm-2\">\n                                            <label for=\"End\" class='font-weight-bold'><?php echo xlt('End Date');?>: </label>\n                                        </div>\n                                        <div class=\"col-12 col-sm-4\">\n                                            <input type='text' class='datepicker form-control' size='10' name='End' id='End' title='<?php echo xla('yyyy-mm-dd'); ?>' />\n                                        </div>\n                                    </div>\n                                </div>\n                                <br />\n                                <button type=\"button\" class=\"generateCCR btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                                <!--<input type=\"button\" class=\"generateCCR_raw\" value=\"<?php echo xlt('Raw Report'); ?>\" /> -->\n                                <button type=\"button\" class=\"generateCCR_download_p btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download'); ?>\" ><?php echo xlt('Download'); ?></button>\n\n                                <?php\n                                if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccr_enable'] == true) { ?>\n                                    <button type=\"button\" class=\"viewCCR_send_dialog btn btn-primary btn-transmit btn-sm\" value=\"<?php echo xla('Transmit'); ?>\"><?php echo xlt('Transmit'); ?></button>\n                                    <br />\n                                    <div id=\"ccr_send_dialog\" style=\"display: none\">\n                                        <br />\n                                        <div class=\"table-responsive\">\n                                            <table class=\"table border-0\">\n                                                <tr>\n                                                    <td>\n                                                        <span class='font-weight-bold'><?php echo xlt('Enter Recipient\\'s Direct Address');?>: </span>\n                                                        <input type=\"text\" size=\"64\" name=\"ccr_send_to\" id=\"ccr_send_to\" value=\"\" />\n                                                        <input type=\"hidden\" name=\"ccr_sent_by\" id=\"ccr_sent_by\" value=\"user\" />\n                                                        <button type=\"button\" class=\"viewCCR_transmit btn btn-primary btn-send-msg btn-sm\" value=\"<?php echo xla('Send CCR'); ?>\"><?php echo xlt('Send CCR'); ?></button>\n                                                        <div id=\"ccr_send_result\" style=\"display: none\">\n                                                            <span class=\"text\" id=\"ccr_send_message\"></span>\n                                                        </div>\n                                                    </td>\n                                                </tr>\n                                            </table>\n                                        </div>\n                                    </div>\n                                    <?php } ?>\n                            </div>\n                        </fieldset>\n                        <hr/>\n                        <fieldset>\n                            <div class=\"col-sm-12\">\n                                <span class='title oe-report-section-header'><?php echo xlt('Continuity of Care Document (CCD)'); ?></span>&nbsp;&nbsp;\n                                <span class='text'>(<?php echo xlt('Pop ups need to be enabled to see these reports'); ?>)</span>\n                                <br/>\n                                <br/>\n                                <button type=\"button\" class=\"viewCCD btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                                <button type=\"button\" class=\"viewCCD_download btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download'); ?>\" ><?php echo xlt('Download'); ?></button>\n                                <?php\n                                if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccd_enable'] == true) { ?>\n                                    <button type=\"button\" class=\"viewCCD_send_dialog btn btn-primary btn-transmit btn-sm\" value=\"<?php echo xla('Transmit'); ?>\" ><?php echo xlt('Transmit'); ?></button>\n                                    <br />\n                                    <div id=\"ccd_send_dialog\" style=\"display: none\">\n                                        <div class=\"form-row mt-3\">\n                                            <div class=\"col-12\">\n                                                <label for=\"\" class=\"font-weight-bold\">\n                                                    <?php echo xlt('Enter Recipient\\'s Direct Address');?>:\n                                                </label>\n                                            </div>\n                                            <div class=\"col-md\">\n                                                <input type=\"text\" class=\"form-control\" size=\"64\" name=\"ccd_send_to\" id=\"ccd_send_to\" value=\"\" />\n                                                <input type=\"hidden\" name=\"ccd_sent_by\" id=\"ccd_sent_by\" value=\"user\" />\n                                            </div>\n                                            <div class=\"col-md\">\n                                                <button type=\"button\" class=\"viewCCD_transmit btn btn-primary btn-send-msg btn-sm\" value=\"<?php echo xla('Send CCD'); ?>\"><?php echo xlt('Send CCD'); ?></button>\n                                            </div>\n                                        </div>\n                                        <div id=\"ccd_send_result\" style=\"display: none\">\n                                            <span class=\"text\" id=\"ccd_send_message\"></span>\n                                        </div>\n                                    </div>\n                                <?php } ?>\n                            </div>\n                        </fieldset>\n                    </form>\n                    <hr/>\n                </div>\n                <?php\n            } // end CCR/CCD reporting options ?>\n\n            <form name='report_form' id=\"report_form\" method='post' action='custom_report.php'>\n                <fieldset>\n                    <div class=\"col-sm-12\">\n                        <span class='title oe-report-section-header'><?php echo xlt('Patient Report'); ?></span>&nbsp;&nbsp;\n                        <!--\n                        <a class=\"link_submit\" href=\"full_report.php\" onclick=\"top.restoreSession()\">\n                        [<?php echo xlt('View Comprehensive Patient Report'); ?>]</a>\n                        -->\n                        <a class=\"link_submit btn btn-secondary btn-sm btn-save\" href=\"#\" onclick=\"return checkAll(true)\">\n                            <?php echo xla('Check All'); ?>\n                        </a>\n                        <a class=\"link_submit btn btn-secondary btn-sm btn-undo\" href=\"#\" onclick=\"return checkAll(false)\">\n                            <?php echo xla('Clear All'); ?>\n                        </a>\n\n                        <table class=\"includes mt-3\">\n                            <tr>\n                                <td class='text'>\n                                    <input type='checkbox' name='include_demographics' id='include_demographics' value=\"demographics\" checked /><?php echo xlt('Demographics'); ?>\n                                    <br />\n                                    <?php if (AclMain::aclCheckCore('patients', 'med')) : ?>\n                                    <input type='checkbox' name='include_history' id='include_history' value=\"history\" /><?php echo xlt('History'); ?>\n                                    <br />\n                                    <?php endif; ?>\n                                    <!--\n                                    <input type='checkbox' name='include_employer' id='include_employer' value=\"employer\"><?php echo xlt('Employer'); ?><br />\n                                    -->\n                                    <input type='checkbox' name='include_insurance' id='include_insurance' value=\"insurance\" /><?php echo xlt('Insurance'); ?>\n                                    <br />\n                                    <input type='checkbox' name='include_billing' id='include_billing' value=\"billing\"\n                                    <?php\n                                    if (!$GLOBALS['simplified_demographics']) {\n                                        echo 'checked';\n                                    } ?> /><?php echo xlt('Billing'); ?>\n                                    <br />\n                                </td>\n                                <td class='text'>\n                                    <!--\n                                    <input type='checkbox' name='include_allergies' id='include_allergies' value=\"allergies\">Allergies<br />\n                                    <input type='checkbox' name='include_medications' id='include_medications' value=\"medications\">Medications<br />\n                                    -->\n                                    <input type='checkbox' name='include_immunizations' id='include_immunizations' value=\"immunizations\" /><?php echo xlt('Immunizations'); ?>\n                                    <br />\n                                    <!--\n                                    <input type='checkbox' name='include_medical_problems' id='include_medical_problems' value=\"medical_problems\">Medical Problems<br />\n                                    -->\n                                    <input type='checkbox' name='include_notes' id='include_notes' value=\"notes\" /><?php echo xlt('Patient Notes'); ?>\n                                    <br />\n                                    <input type='checkbox' name='include_transactions' id='include_transactions' value=\"transactions\" /><?php echo xlt('Transactions'); ?>\n                                    <br />\n                                    <input type='checkbox' name='include_batchcom' id='include_batchcom' value=\"batchcom\" /><?php echo xlt('Communications'); ?>\n                                    <br />\n                                </td>\n                                <td class=\"text\">\n                                    <input type='checkbox' name='include_recurring_days' id='include_recurring_days' value=\"recurring_days\" /><?php echo  xlt('Recurrent Appointments'); ?>\n                                    <br />\n                                </td>\n                            </tr>\n                        </table>\n                        <br />\n                        <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                        <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n\n                        <?php\n                        if ($oefax) {\n                            $eventDispatcher->dispatch(PatientReportEvent::ACTIONS_RENDER_POST, new GenericEvent());\n                        }\n                        ?>\n                        <input type='hidden' name='pdf' value='0' />\n                        <br />\n\n                        <!-- old ccr button position -->\n                        <hr/>\n\n                        <div class=\"row issues_encounters_forms\">\n                            <!-- Issues -->\n                            <div class=\"col-md-6\">\n                                <div class=\"issues table-responsive\">\n                                    <span class='font-weight-bold oe-report-section-header'><?php echo xlt('Issues'); ?>:</span>\n                                    <br />\n                                    <br />\n\n                                    <?php if (! AclMain::aclCheckCore('patients', 'med')) { ?>\n                                    <br />(Issues not authorized)\n                                    <?php } else { ?>\n                                    <table class=\"table table-borderless\">\n                                        <?php\n                                        // get issues\n                                        $pres = sqlStatement(\"SELECT * FROM lists WHERE pid = ? \" .\n                                        \"ORDER BY type, begdate\", array($pid));\n                                        $lasttype = \"\";\n                                        while ($prow = sqlFetchArray($pres)) {\n                                            if ($lasttype != $prow['type']) {\n                                                $lasttype = $prow['type'];\n\n                                                /****\n                                                $disptype = $lasttype;\n                                                switch ($lasttype) {\n                                                case \"allergy\"        : $disptype = \"Allergies\"       ; break;\n                                                case \"problem\"        :\n                                                case \"medical_problem\": $disptype = \"Medical Problems\"; break;\n                                                case \"medication\"     : $disptype = \"Medications\"     ; break;\n                                                case \"surgery\"        : $disptype = \"Surgeries\"       ; break;\n                                                }\n                                                ****/\n                                                $disptype = $ISSUE_TYPES[$lasttype][0];\n\n                                                echo \" <tr>\\n\";\n                                                echo \"  <td colspan='4' class='font-weight-bold'><span class='oe-report-section-header'>\" . xlt($disptype) . \":</span></td>\\n\";\n                                                echo \" </tr>\\n\";\n                                            }\n\n                                            $rowid = $prow['id'];\n                                            $disptitle = trim($prow['title']) ? $prow['title'] : \"[Missing Title]\";\n\n                                            $ieres = sqlStatement(\"SELECT encounter FROM issue_encounter WHERE \" .\n                                            \"pid = ? AND list_id = ?\", array($pid, $rowid));\n\n                                            echo \"    <tr class='text'>\\n\";\n                                            echo \"     <td>&nbsp;</td>\\n\";\n                                            echo \"     <td>\";\n                                            echo \"<input type='checkbox' name='issue_\" . attr($rowid) . \"' id='issue_\" . attr($rowid) . \"' class='issuecheckbox' value='/\";\n                                            while ($ierow = sqlFetchArray($ieres)) {\n                                                echo attr($ierow['encounter']) . \"/\";\n                                            }\n\n                                            echo \"' />\" . text($disptitle) . \"</td>\\n\";\n                                            echo \"     <td>\" . text($prow['begdate']);\n\n                                            if ($prow['enddate']) {\n                                                echo \" - \" . text($prow['enddate']);\n                                            } else {\n                                                echo \" Active\";\n                                            }\n\n                                            echo \"</td>\\n\";\n                                            echo \"</tr>\\n\";\n                                        }\n                                        ?>\n                                    </table>\n                                    <?php } // end of Issues output ?>\n                                </div> <!-- end issues DIV -->\n                                <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                                <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n                            </div>\n                            <!-- Encounters and Forms -->\n                            <div class=\"col-md-6\">\n                                <div class='encounters table-responsive'>\n                                    <span class='font-weight-bold oe-report-section-header'><?php echo xlt('Encounters & Forms'); ?>:</span>\n                                    <br />\n                                    <br />\n\n                                    <?php\n                                    if (!($auth_notes_a || $auth_notes || $auth_coding_a || $auth_coding || $auth_med || $auth_relaxed)) { ?>\n                                        (Encounters not authorized)\n                                        <?php\n                                    } else { ?>\n                                        <?php\n                                        $isfirst = 1;\n                                        $res = sqlStatement(\"SELECT forms.encounter, forms.form_id, forms.form_name, \" .\n                                        \"forms.formdir, forms.date AS fdate, form_encounter.date \" .\n                                        \",form_encounter.reason \" .\n                                        \"FROM forms, form_encounter WHERE \" .\n                                        \"forms.pid = ? AND form_encounter.pid = ? AND \" .\n                                        \"form_encounter.encounter = forms.encounter \" .\n                                        \" AND forms.deleted=0 \" . // --JRM--\n                                        \"ORDER BY form_encounter.encounter DESC, form_encounter.date DESC, fdate ASC\", array($pid, $pid));\n                                        $res2 = sqlStatement(\"SELECT name FROM registry ORDER BY priority\");\n                                        $html_strings = array();\n                                        $registry_form_name = array();\n                                        while ($result2 = sqlFetchArray($res2)) {\n                                            array_push($registry_form_name, trim($result2['name']));\n                                        }\n\n                                        while ($result = sqlFetchArray($res)) {\n                                            if ($result[\"form_name\"] == \"New Patient Encounter\") {\n                                                if ($isfirst == 0) {\n                                                    foreach ($registry_form_name as $var) {\n                                                        if ($toprint = $html_strings[$var]) {\n                                                            foreach ($toprint as $var) {\n                                                                print $var;\n                                                            }\n                                                        }\n                                                    }\n                                                    $html_strings = array();\n                                                    echo \"</div>\\n\"; // end DIV encounter_forms\n                                                    echo \"</div>\\n\\n\";  //end DIV encounter_data\n                                                    echo \"<br />\";\n                                                }\n                                                $isfirst = 0;\n                                                echo \"<div class='encounter_data'>\\n\";\n                                                echo \"<input type=checkbox \" .\n                                                \" name='\" . attr($result[\"formdir\"]) . \"_\" .  attr($result[\"form_id\"]) . \"'\" .\n                                                \" id='\" . attr($result[\"formdir\"]) . \"_\" .  attr($result[\"form_id\"]) . \"'\" .\n                                                \" value='\" . attr($result[\"encounter\"]) . \"'\" .\n                                                \" class='encounter'\" .\n                                                \" >\";\n                                                // show encounter reason, not just 'New Encounter'\n                                                // trim to a reasonable length for display purposes --cfapress\n                                                $maxReasonLength = 20;\n                                                if (strlen($result[\"reason\"]) > $maxReasonLength) {\n                                                    // The default encoding for this mb_substr() call is set near top of globals.php\n                                                    $result['reason'] = mb_substr($result['reason'], 0, $maxReasonLength) . \" ... \";\n                                                }\n                                                echo text($result[\"reason\"]) .\n                                                \" (\" . text(date(\"Y-m-d\", strtotime($result[\"date\"]))) .\n                                                \")\\n\";\n                                                echo \"<div class='encounter_forms'>\\n\";\n                                            } else {\n                                                $form_name = trim($result[\"form_name\"]);\n                                                //if form name is not in registry, look for the closest match by\n                                                // finding a registry name which is  at the start of the form name.\n                                                //this is to allow for forms to put additional helpful information\n                                                //in the database in the same string as their form name after the name\n                                                $form_name_found_flag = 0;\n                                                foreach ($registry_form_name as $var) {\n                                                    if ($var == $form_name) {\n                                                        $form_name_found_flag = 1;\n                                                    }\n                                                }\n                                                // if the form does not match precisely with any names in the registry, now see if any front partial matches\n                                                // and change $form_name appropriately so it will print above in $toprint = $html_strings[$var]\n                                                if (!$form_name_found_flag) {\n                                                    foreach ($registry_form_name as $var) {\n                                                        if (strpos($form_name, $var) == 0) {\n                                                            $form_name = $var;\n                                                        }\n                                                    }\n                                                }\n                                                if (empty($html_strings[$form_name]) || !is_array($html_strings[$form_name])) {\n                                                    $html_strings[$form_name] = array();\n                                                }\n                                                array_push($html_strings[$form_name], \"<input type='checkbox' \" .\n                                                    \" name='\" . attr($result[\"formdir\"]) . \"_\" . attr($result[\"form_id\"]) . \"'\" .\n                                                    \" id='\" . attr($result[\"formdir\"]) . \"_\" . attr($result[\"form_id\"]) . \"'\" .\n                                                    \" value='\" . attr($result[\"encounter\"]) . \"'\" .\n                                                    \" class='encounter_form' \" .\n                                                    \">\" . text(xl_form_title($result[\"form_name\"])) . \"<br />\\n\");\n                                            }\n                                        }\n\n                                        foreach ($registry_form_name as $var) {\n                                            if (!empty($html_strings[$var])) {\n                                                if ($toprint = $html_strings[$var]) {\n                                                    foreach ($toprint as $var) {\n                                                        print $var;\n                                                    }\n                                                }\n                                            }\n                                        }\n                                        ?>\n\n                                        <?php\n                                    } ?>\n                                </div> <!-- end encounters DIV -->\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"col-sm-12\">\n                        <!-- Procedure Orders -->\n                        <hr/>\n                        <div class=\"table-responsive\">\n                            <table class=\"table table-borderless\">\n                                <tr>\n                                    <td class='font-weight-bold'><span class='oe-report-section-header'><?php echo xlt('Procedures'); ?>:</span></td>\n                                    <td class='text'>&nbsp;<?php echo xlt('Order Date'); ?>&nbsp;&nbsp;</td>\n                                    <td class='text'><?php echo xlt('Encounter Date'); ?>&nbsp;&nbsp;</td>\n                                    <td class='text'><?php echo xlt('Order Descriptions'); ?></td>\n                                </tr>\n                                <?php\n                                $res = sqlStatement(\n                                    \"SELECT po.procedure_order_id, po.date_ordered, fe.date \" .\n                                    \"FROM procedure_order AS po \" .\n                                    \"LEFT JOIN forms AS f ON f.pid = po.patient_id AND f.formdir = 'procedure_order' AND \" .\n                                    \"f.form_id = po.procedure_order_id AND f.deleted = 0 \" .\n                                    \"LEFT JOIN form_encounter AS fe ON fe.pid = f.pid AND fe.encounter = f.encounter \" .\n                                    \"WHERE po.patient_id = ? \" .\n                                    \"ORDER BY po.date_ordered DESC, po.procedure_order_id DESC\",\n                                    array($pid)\n                                );\n                                while ($row = sqlFetchArray($res)) {\n                                    $poid = $row['procedure_order_id'];\n                                    echo \" <tr>\\n\";\n                                    echo \"  <td class='text text-center'>\" .\n                                    \"<input type='checkbox' name='procedures[]' value='\" . attr($poid) . \"' />&nbsp;&nbsp;</td>\\n\";\n                                    echo \"  <td class='text'>\" . text(oeFormatShortDate($row['date_ordered'])) . \"&nbsp;&nbsp;</td>\\n\";\n                                    echo \"  <td class='text'>\" . text(oeFormatShortDate($row['date'])) . \"&nbsp;&nbsp;</td>\\n\";\n                                    echo \"  <td class='text'>\";\n                                    $opres = sqlStatement(\n                                        \"SELECT procedure_code, procedure_name FROM procedure_order_code \" .\n                                        \"WHERE procedure_order_id = ? ORDER BY procedure_order_seq\",\n                                        array($poid)\n                                    );\n                                    while ($oprow = sqlFetchArray($opres)) {\n                                        $tmp = $oprow['procedure_name'];\n                                        if (empty($tmp)) {\n                                            $tmp = $oprow['procedure_code'];\n                                        }\n                                        echo text($tmp) . \"<br />\";\n                                    }\n                                    echo \"</td>\\n\";\n                                    echo \" </tr>\\n\";\n                                }\n                                ?>\n                            </table>\n                        </div>\n\n                        <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                        <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n                        <hr/>\n                    <div>\n\n                    <span class=\"font-weight-bold oe-report-section-header\"><?php echo xlt('Documents'); ?>:</span><br />\n                    <ul>\n                        <?php\n                        // show available documents\n                        $db = $GLOBALS['adodb']['db'];\n                        $sql = \"SELECT d.id, d.url, d.name as document_name, c.name, c.aco_spec FROM documents AS d \" .\n                                \"LEFT JOIN categories_to_documents AS ctd ON d.id=ctd.document_id \" .\n                                \"LEFT JOIN categories AS c ON c.id = ctd.category_id WHERE \" .\n                                \"d.foreign_id = ? AND d.deleted = 0\";\n                        $result = $db->Execute($sql, array($pid));\n                        if ($db->ErrorMsg()) {\n                            echo $db->ErrorMsg();\n                        }\n                        while ($result && !$result->EOF) {\n                            if (empty($result->fields['aco_spec']) || AclMain::aclCheckAcoSpec($result->fields['aco_spec'])) {\n                                echo \"<li class='font-weight-bold'>\";\n                                echo '<input type=\"checkbox\" name=\"documents[]\" value=\"' .\n                                attr($result->fields['id']) . '\">';\n                                echo '&nbsp;&nbsp;<i>' .  text(xl_document_category($result->fields['name'])) . \"</i>\";\n                                echo '&nbsp;&nbsp;' . xlt('Name') . ': <i>' . text($result->fields['document_name']) . '-' . text($result->fields['id']) . \"</i>\";\n                                echo '</li>';\n                            }\n                            $result->MoveNext();\n                        }\n                        ?>\n                    </ul>\n                    <button type=\"button\" class=\"genreport btn btn-primary btn-save btn-sm\" value=\"<?php echo xla('Generate Report'); ?>\" ><?php echo xlt('Generate Report'); ?></button>\n                    <button type=\"button\" class=\"genpdfrep btn btn-primary btn-download btn-sm\" value=\"<?php echo xla('Download PDF'); ?>\" ><?php echo xlt('Download PDF'); ?></button>\n                </fieldset>\n            </form>\n        </div>  <!-- close patient_reports DIV -->\n    </div><!--end of container div-->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n\n<script>\n\n// jQuery stuff to make the page a little easier to use\n$(function () {\n    $('.datepicker').datetimepicker({\n        <?php $datetimepicker_timepicker = false; ?>\n        <?php $datetimepicker_showseconds = false; ?>\n        <?php $datetimepicker_formatInput = false; ?>\n        <?php require($GLOBALS['srcdir'] . '/js/xl/jquery-datetimepicker-2-5-4.js.php'); ?>\n        <?php // can add any additional javascript settings to datetimepicker here; need to prepend first setting with a comma ?>\n    });\n\n    $(\".genreport\").click(function() { top.restoreSession(); document.report_form.pdf.value = 0; $(\"#report_form\").submit(); });\n    $(\".genpdfrep\").click(function() { top.restoreSession(); document.report_form.pdf.value = 1; $(\"#report_form\").submit(); });\n    $(\".genportal\").click(function() { top.restoreSession(); document.report_form.pdf.value = 2; $(\"#report_form\").submit(); });\n    $(\"#genfullreport\").click(function() { location.href='<?php echo \"$rootdir/patient_file/encounter/\" . ($returnurl ?? ''); ?>'; });\n    //$(\"#printform\").click(function() { PrintForm(); });\n    $(\".issuecheckbox\").click(function() { issueClick(this); });\n\n    // check/uncheck all Forms of an encounter\n    $(\".encounter\").click(function() { SelectForms($(this)); });\n\n    $(\".generateCCR\").click(function() {\n        if(document.getElementById('show_date').checked == true){\n            if(document.getElementById('Start').value == '' || document.getElementById('End').value == ''){\n                alert(<?php echo xlj('Please select a start date and end date') ?>);\n                return false;\n            }\n        }\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'no';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".generateCCR_raw\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'yes';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".generateCCR_download_h\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'hybrid';\n        top.restoreSession();\n        $(\"#ccr_form\").submit();\n    });\n    $(\".generateCCR_download_p\").click(function() {\n        if(document.getElementById('show_date').checked == true){\n            if(document.getElementById('Start').value == '' || document.getElementById('End').value == ''){\n                alert(<?php echo xlj('Please select a start date and end date'); ?>);\n                return false;\n            }\n        }\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'generate';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'pure';\n        top.restoreSession();\n        $(\"#ccr_form\").submit();\n    });\n    $(\".viewCCD\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'viewccd';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'no';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".viewCCD_raw\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'viewccd';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'yes';\n        top.restoreSession();\n        ccr_form.setAttribute(\"target\", \"_blank\");\n        $(\"#ccr_form\").submit();\n        ccr_form.setAttribute(\"target\", \"\");\n    });\n    $(\".viewCCD_download\").click(function() {\n        var ccrAction = document.getElementsByName('ccrAction');\n        ccrAction[0].value = 'viewccd';\n        var raw = document.getElementsByName('raw');\n        raw[0].value = 'pure';\n        $(\"#ccr_form\").submit();\n    });\n\n    <?php if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccr_enable'] == true) { ?>\n        $(\".viewCCR_send_dialog\").click(function() {\n            $(\"#ccr_send_dialog\").toggle();\n        });\n        $(\".viewCCR_transmit\").click(function() {\n            $(\".viewCCR_transmit\").attr('disabled','disabled');\n            var ccrAction = document.getElementsByName('ccrAction');\n            ccrAction[0].value = 'generate';\n            var ccrRecipient = $(\"#ccr_send_to\").val();\n            var raw = document.getElementsByName('raw');\n            raw[0].value = 'send '+ccrRecipient;\n            if(ccrRecipient==\"\") {\n                    $(\"#ccr_send_message\").html(<?php\n                        echo xlj('Please enter a valid Direct Address above.'); ?>);\n                    $(\"#ccr_send_result\").show();\n            } else {\n                    $(\".viewCCR_transmit\").attr('disabled','disabled');\n                    $(\"#ccr_send_message\").html(<?php\n                        echo xlj('Working... this may take a minute.'); ?>);\n                    $(\"#ccr_send_result\").show();\n                    var action=$(\"#ccr_form\").attr('action');\n                    $.post(action,\n                        {\n                            ccrAction:'generate',\n                            raw:'send '+ccrRecipient,\n                            requested_by:'user'\n                        },\n                        function(data) {\n                            if(data==\"SUCCESS\") {\n                                $(\"#ccr_send_message\").html(<?php\n                                    echo xlj('Your message was submitted for delivery to');\n                                ?>+ \" \" + ccrRecipient);\n                                $(\"#ccr_send_to\").val(\"\");\n                            } else {\n                                $(\"#ccr_send_message\").html(data);\n                            }\n                            $(\".viewCCR_transmit\").removeAttr('disabled');\n                    });\n                    }\n        });\n    <?php }\n\n    if ($GLOBALS['phimail_enable'] == true && $GLOBALS['phimail_ccd_enable'] == true) { ?>\n        $(\".viewCCD_send_dialog\").click(function() {\n            $(\"#ccd_send_dialog\").toggle();\n        });\n        $(\".viewCCD_transmit\").click(function() {\n            $(\".viewCCD_transmit\").attr('disabled','disabled');\n            var ccrAction = document.getElementsByName('ccrAction');\n            ccrAction[0].value = 'viewccd';\n            var ccdRecipient = $(\"#ccd_send_to\").val();\n            var raw = document.getElementsByName('raw');\n            raw[0].value = 'send '+ccdRecipient;\n                if(ccdRecipient==\"\") {\n                        $(\"#ccd_send_message\").html(<?php\n                            echo xlj('Please enter a valid Direct Address above.'); ?>);\n                        $(\"#ccd_send_result\").show();\n                } else {\n                        $(\".viewCCD_transmit\").attr('disabled','disabled');\n                        $(\"#ccd_send_message\").html(<?php\n                            echo xlj('Working... this may take a minute.'); ?>);\n                        $(\"#ccd_send_result\").show();\n                        var action=$(\"#ccr_form\").attr('action');\n                        $.post(action,\n                            {\n                            ccrAction:'viewccd',\n                            raw:'send '+ccdRecipient,\n                            requested_by:'user'\n                            },\n                            function(data) {\n                            if(data==\"SUCCESS\") {\n                                $(\"#ccd_send_message\").html(<?php\n                                    echo xlj('Your message was submitted for delivery to');\n                                ?> + \" \" + ccdRecipient);\n                                $(\"#ccd_send_to\").val(\"\");\n                            } else {\n                                $(\"#ccd_send_message\").html(data);\n                            }\n                            $(\".viewCCD_transmit\").removeAttr('disabled');\n                        });\n                }\n        });\n    <?php } ?>\n\n    <?php\n    if ($oefax) {\n        $eventDispatcher->dispatch(PatientReportEvent::JAVASCRIPT_READY_POST, new GenericEvent());\n    }\n    ?>\n\n});\n\n// select/deselect the Forms related to the selected Encounter\n// (it ain't pretty code folks)\nvar SelectForms = function (selectedEncounter) {\n    if ($(selectedEncounter).prop(\"checked\")) {\n        $(selectedEncounter).parent().children().each(function(i, obj) {\n            $(this).children().each(function(i, obj) {\n                $(this).prop(\"checked\", true);\n            });\n        });\n    }\n    else {\n        $(selectedEncounter).parent().children().each(function(i, obj) {\n            $(this).children().each(function(i, obj) {\n                $(this).prop(\"checked\", false);\n            });\n        });\n    }\n}\n\n// When an issue is checked, auto-check all the related encounters and forms\nfunction issueClick(issue) {\n    // do nothing when unchecked\n    if (! $(issue).attr(\"checked\")) return;\n\n    $(\"#report_form :checkbox\").each(function(i, obj) {\n        if ($(issue).val().indexOf('/' + $(this).val() + '/') >= 0) {\n            $(this).attr(\"checked\", \"checked\");\n        }\n    });\n}\n\nvar listId = '#' + <?php echo js_escape($list_id); ?>;\n$(function () {\n    $(listId).addClass(\"active\");\n});\n\n</script>\n</body>\n</html>\n", "<?php\n\n/**\n * Multi-Factor Authentication Management\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2018 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018-2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE CNU General Public License 3\n */\n\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\OeUI\\OemrUI;\n\nfunction writeRow($method, $name, $allowEdit = false)\n{\n    echo \"        <tr><td>&nbsp;\";\n    if ($name == '') {\n        echo '<i class=\"fa fa-exclamation-circle oe-text-orange\" aria-hidden=\"true\"></i>' . ' ' . text($method);\n    } else {\n        echo text($method);\n    }\n    echo \"&nbsp;</td><td>&nbsp;\";\n    echo text($name);\n    echo \"&nbsp;</td><td>\";\n    if ($allowEdit) {\n        echo \"<button type='button' class='btn btn-secondary btn-search' onclick='editclick(\" . attr_js($method) . \")'>\" . xlt('View') . \"</button> &nbsp\";\n    }\n    if ($name) {\n        echo \"<button type='button' class='btn btn-secondary btn-delete' onclick='delclick(\" . attr_js($method) . \", \" .\n        attr_js($name) . \")'>\" . xlt('Delete') . \"</button>\";\n    }\n    echo \"</td></tr>\\n\";\n}\n\n$userid = $_SESSION['authUserID'];\n$user_name = getUserIDInfo($userid);\n$user_full_name = $user_name['fname'] . \" \" . $user_name['lname'];\n$message = '';\nif (!empty($_POST['form_delete_method'])) {\n    if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n    // Delete the indicated MFA instance.\n    sqlStatement(\n        \"DELETE FROM login_mfa_registrations WHERE user_id = ? AND method = ? AND name = ?\",\n        array($userid, $_POST['form_delete_method'], $_POST['form_delete_name'])\n    );\n    $message = xl('Delete successful.');\n}\n?>\n<!DOCTYPE html>\n<html>\n<head>\n    <?php Header::setupHeader(); ?>\n\n<title><?php echo xlt('Manage Multi Factor Authentication'); ?></title>\n<script>\n\nfunction delclick(mfamethod, mfaname) {\n    var f = document.forms[0];\n    f.form_delete_method.value = mfamethod;\n    f.form_delete_name.value = mfaname;\n    top.restoreSession();\n    f.submit();\n}\n\nfunction editclick(method) {\n    top.restoreSession();\n    if (method == 'TOTP') {\n        window.location.href = 'mfa_totp.php?action=reg1';\n    }\n    else {\n        alert(<?php echo xlj('Not yet implemented.'); ?>);\n    }\n}\n\nfunction addclick(sel) {\n    top.restoreSession();\n    if (sel.value) {\n        if (sel.value == 'U2F') {\n            window.location.href = 'mfa_u2f.php?action=reg1';\n        } else if (sel.value == 'TOTP') {\n            window.location.href = 'mfa_totp.php?action=reg1';\n        }\n        else {\n            alert(<?php echo xlj('Not yet implemented.'); ?>);\n        }\n    }\n    sel.selectedIndex = 0;\n}\n\n</script>\n<?php\n$arrOeUiSettings = array(\n    'heading_title' => xl('Manage Multi Factor Authentication'),\n    'include_patient_name' => false,\n    'expandable' => false,\n    'expandable_files' => array(),//all file names need suffix _xpd\n    'action' => \"\",//conceal, reveal, search, reset, link or back\n    'action_title' => \"\",\n    'action_href' => \"\",//only for actions - reset, link or back\n    'show_help_icon' => true,\n    'help_file_name' => \"mfa_help.php\"\n);\n$oemr_ui = new OemrUI($arrOeUiSettings);\n?>\n</head>\n<body class=\"body_top\">\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <?php echo $oemr_ui->pageHeading() . \"\\r\\n\"; ?>\n            </div>\n        </div>\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n            <?php\n            if ($message) {?>\n              <div id=\"display_msg\" class=\"alert alert-danger\" style=\"font-size:100%; font-weight:700\"><?php echo text($message); ?></div>\n                <?php\n            }\n            ?>\n            </div>\n        </div>\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <form method='post' action='mfa_registrations.php' onsubmit='return top.restoreSession()'>\n                    <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n                    <div>\n                        <fieldset>\n                            <legend><?php echo xlt('Current Authentication Method for') . \" \" . text($user_full_name); ?></legend>\n                            <table class='table'>\n                                <tr>\n                                  <th align='left'>&nbsp;<?php echo xlt('Method'); ?>&nbsp;</th>\n                                  <th align='left'>&nbsp;<?php echo xlt('Key Name'); ?>&nbsp;</th>\n                                  <th align='left'>&nbsp;<?php echo xlt('Action'); ?>&nbsp;</th>\n                                </tr>\n                                <?php\n                                $res = sqlStatement(\"SELECT name, method FROM login_mfa_registrations WHERE \" .\n                                \"user_id = ? ORDER BY method, name\", array($userid));\n                                $disableNewTotp = false;\n                                if (sqlNumRows($res)) {\n                                    while ($row = sqlFetchArray($res)) {\n                                        if ($row['method'] == \"TOTP\") {\n                                            $disableNewTotp = true;\n                                            writeRow($row['method'], $row['name'], true);\n                                        } else {\n                                            writeRow($row['method'], $row['name']);\n                                        }\n                                    }\n                                } else {\n                                    writeRow(xl(\"No method enabled\"), '');\n                                }\n                                ?>\n                            </table>\n                        </fieldset>\n                    </div>\n                    <div>\n                        <fieldset>\n                            <legend><?php echo xlt('Select/Add New Authentication Method for') . \" \" . text($user_full_name); ?></legend>\n                            <div class='col-sm-4 offset-sm-4'>\n                                <select name='form_add' onchange='addclick(this)'class='col-sm-12'>\n                                    <option value=''><?php echo xlt('Add New...'); ?></option>\n                                    <option value='U2F'><?php echo xlt('U2F USB Device'); ?></option>\n                                    <option value='TOTP'\n                                        <?php echo ($disableNewTotp) ? 'title=\"' . xla('Only one TOTP Key can be set up per user') . '\"' : ''; ?>\n                                        <?php echo ($disableNewTotp) ? 'disabled' : ''; ?>>\n                                        <?php echo xlt('TOTP Key'); ?>\n                                    </option>\n                                </select>\n                            </div>\n                            <input type='hidden' name='form_delete_method' value='' />\n                            <input type='hidden' name='form_delete_name' value='' />\n                        </fieldset>\n                    </div>\n                </form>\n            </div>\n        </div>\n\n    </div><!--end of container div -->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n</body>\n</html>\n", "<?php\n\n/**\n * App Based TOTP Support\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Anthony Zullo <anthonykzullo@gmail.com>\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2019 Anthony Zullo <anthonykzullo@gmail.com>\n * @copyright Copyright (c) 2018 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018-2019 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE CNU General Public License 3\n */\n\n// Set $sessionAllowWrite to true to prevent session concurrency issues during authorization related code\n$sessionAllowWrite = true;\nrequire_once('../globals.php');\nrequire_once(\"$srcdir/classes/Totp.class.php\");\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Auth\\AuthUtils;\nuse OpenEMR\\Common\\Crypto\\CryptoGen;\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\OeUI\\OemrUI;\n\n$userid = $_SESSION['authUserID'];\n$action = $_REQUEST['action'];\n$user_name = getUserIDInfo($userid);\n$user_full_name = $user_name['fname'] . \" \" . $user_name['lname'];\n\n?>\n<html>\n<head>\n    <?php Header::setupHeader(); ?>\n    <title><?php echo xlt('TOTP Registration'); ?></title>\n    <script>\n\n        function doregister(step, error) {\n            var f = document.forms[0];\n            f.action.value = step;\n            if (error) {\n                f.error.value = error;\n            }\n            f.action.value = step;\n            top.restoreSession();\n            f.submit();\n        }\n\n        function docancel() {\n            var redirectUrl = 'mfa_registrations.php';\n            window.location.href = 'mfa_registrations.php';\n        }\n\n        $(function () {\n            $('#clearPass').focus();\n        });\n    </script>\n    <style>\n        p {\n            text-align: center\n        }\n            .alert-msg {\n            font-size:100%;\n            font-weight:700;\n        }\n    </style>\n    <?php\n    $arrOeUiSettings = array(\n        'heading_title' => xl('Register Time Based One Time Password Key') . \" - \" . xl('TOTP'),\n        'include_patient_name' => false,\n        'expandable' => false,\n        'expandable_files' => array(),//all file names need suffix _xpd\n        'action' => \"\",//conceal, reveal, search, reset, link or back\n        'action_title' => \"\",\n        'action_href' => \"\",//only for actions - reset, link or back\n        'show_help_icon' => false,\n        'help_file_name' => \"\"\n    );\n    $oemr_ui = new OemrUI($arrOeUiSettings);\n    ?>\n</head>\n<body class=\"body_top\">\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n    <?php\n    // If current step is reg1 or reg2, display the header\n    if ($action == 'reg1' || $action == 'reg2') { ?>\n        <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n            <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <?php echo $oemr_ui->pageHeading() . \"\\r\\n\"; ?>\n                </div>\n            </div>\n        <?php\n    } ?>    <div class=\"row\">\n                <div class=\"col-sm-12\">\n                    <form method='post' class=\"form-horizontal\" action='mfa_totp.php' onsubmit='return top.restoreSession()'>\n                        <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n\n\n\n\n                        <?php\n                        // step 1 is to verify the password\n                        if ($action == 'reg1') {\n                            $error = (isset($_GET[\"error\"])) ? $_GET[\"error\"] : false;\n                            ?>\n                            <div>\n                                <fieldset>\n                                    <legend><?php echo xlt('Provide Password for') . \" \" . text($user_full_name); ?></legend>\n                                    <div class=\"row\">\n                                        <div class=\"col-sm-12\">\n                                            <?php if ($error == \"auth\") { ?>\n                                                <div class=\"alert alert-danger alert-msg login-failure m-1\">\n                                                    <?php echo xlt('Invalid password'); ?>\n                                                </div>\n                                            <?php } ?>\n                                            <p><?php echo xlt('In order to register your device, please provide your OpenEMR login password'); ?></p>\n                                            <div class=\"col-sm-4 offset-sm-4\">\n                                                <input type=\"password\" class=\"form-control\" id=\"clearPass\" name=\"clearPass\" placeholder=\"<?php echo xla('Password'); ?>:\" >\n                                            </div>\n                                        </div>\n                                    </div>\n                                </fieldset>\n                                <div class=\"form-group clearfix\">\n                                <div class=\"col-sm-12 text-left position-override\">\n                                        <button type=\"button\" class=\"btn btn-secondary btn-save\" value=\"<?php echo xla('Submit'); ?>\" onclick=\"doregister('reg2')\"><?php echo xlt('Submit'); ?></button>\n                                        <button type=\"button\" class=\"btn btn-link btn-cancel\" value=\"<?php echo xla('Cancel'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Cancel'); ?></button>\n                                    </div>\n                                </div>\n                            </div>\n                            <?php\n                        // step 2 is to validate password and display qr code\n                        } elseif ($action == 'reg2') {\n                            if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n                                CsrfUtils::csrfNotVerified();\n                            }\n\n                            // Redirect back to step 1 if user password is incorrect\n                            if (!(new AuthUtils())->confirmPassword($_SESSION['authUser'], $_POST['clearPass'])) {\n                                header(\"Location: mfa_totp.php?action=reg1&error=auth\");\n                                exit();\n                            }\n\n                            // Determines whether existing TOTP method exists already\n                            $existingSecret = privQuery(\n                                \"SELECT var1 FROM login_mfa_registrations WHERE \" .\n                                \"`user_id` = ? AND `method` = 'TOTP'\",\n                                array($userid)\n                            );\n                            if (empty($existingSecret['var1'])) {\n                                $secret = false;\n                                $doesExist = false;\n                            } else {\n                                $cryptoGen = new CryptoGen();\n                                $secret = $cryptoGen->decryptStandard($existingSecret['var1']);\n                                $doesExist = true;\n                            }\n\n                            // Generate a new QR code or existing QR code\n                            $googleAuth = new Totp($secret, $_SESSION['authUser']);\n                            $qr = $googleAuth->generateQrCode();\n\n\n                            // if secret did not exist previously, stores secret in session variable for saving\n                            if (!$doesExist) {\n                                $_SESSION['totpSecret'] = $googleAuth->getSecret();\n                            }\n                            ?>\n                            <fieldset>\n                                <legend><?php echo xlt('Register TOTP Key for') . \" \" . text($user_full_name); ?></legend>\n                                <div class=\"row\">\n                                    <div class=\"col-sm-12\">\n                                        <?php if (!$doesExist) { ?>\n                                            <p>\n                                                <?php echo xlt('Scan the following QR code with your preferred authenticator app to register a new TOTP key.'); ?>\n                                            </p>\n                                        <?php } else { // $doesExist ?>\n                                            <p>\n                                                <?php echo xlt('Your current TOTP key QR code is displayed below.'); ?>\n                                            </p>\n                                        <?php } ?>\n                                            <br />\n                                            <img src=\"<?php echo attr($qr); ?>\" class=\"img-responsive center-block\" style=\"height:200px !Important\"/>\n                                            <br />\n                                            <p><?php echo xlt('Example authenticator apps include'); ?></p>:\n                                            <div class=\"col-sm-4 offset-sm-4\">\n                                                <ul>\n                                                    <li><?php echo xlt('Google Auth'); ?>\n                                                        (<a href=\"https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8\" target=\"_blank\" rel=\"noopener\">\n                                                            <?php echo xlt('ios'); ?>\n                                                        </a>,\n                                                        <a href=\"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en\" target=\"_blank\" rel=\"noopener\">\n                                                            <?php echo xlt('android'); ?>\n                                                        </a>)</li>\n                                                    <li><?php echo xlt('Authy'); ?>\n                                                        (<a href=\"https://itunes.apple.com/us/app/authy/id494168017?mt=8\" target=\"_blank\" rel=\"noopener\"><?php echo xlt('ios'); ?></a>, <a href=\"https://play.google.com/store/apps/details?id=com.authy.authy&hl=en\" target=\"_blank\" rel=\"noopener\"><?php echo xlt('android'); ?></a>)</li>\n                                                </ul>\n                                            </div>\n                                    </div>\n                                </div>\n                            </fieldset>\n                            <div class=\"form-group clearfix\">\n                                <div class=\"col-sm-12 text-left position-override\">\n                                    <?php if (!$doesExist) { ?>\n                                        <button type=\"button\" class=\"btn btn-secondary btn-save\" value=\"<?php echo xla('Register'); ?>\" onclick=\"doregister('reg3')\"><?php echo xlt('Register'); ?></button>\n                                        <button type=\"button\" class=\"btn btn-link btn-cancel\" value=\"<?php echo xla('Cancel'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Cancel'); ?></button>\n                                    <?php } else { // $doesExist ?>\n                                        <button type=\"button\" class=\"btn btn-link btn-back\" value=\"<?php echo xla('Back'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Back'); ?></button>\n                                    <?php } ?>\n                                    </div>\n                                </div>\n                            </div>\n                            <?php\n                        // step 3 is to save the qr code\n                        } elseif ($action == 'reg3') {\n                            if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n                                CsrfUtils::csrfNotVerified();\n                            }\n\n                            echo \"<script>\\n\";\n\n                            // Verify that no TOTP method exists already\n                            $row = privQuery(\n                                \"SELECT COUNT(*) AS count FROM login_mfa_registrations WHERE \" .\n                                \"`user_id` = ? AND `method` = 'TOTP'\",\n                                array($userid)\n                            );\n\n\n                            if (empty($row['count']) && isset($_SESSION['totpSecret'])) {\n                                $cryptoGen = new CryptoGen();\n                                privStatement(\n                                    \"INSERT INTO login_mfa_registrations \" .\n                                    \"(`user_id`, `method`, `name`, `var1`, `var2`) VALUES \" .\n                                    \"(?, 'TOTP', 'App Based 2FA', ?, '')\",\n                                    array($userid, $cryptoGen->encryptStandard($_SESSION['totpSecret']))\n                                );\n                                unset($_SESSION['totpSecret']);\n                            } else {\n                                echo \" alert(\" . xlj('TOTP Method already exists and is enabled. Try again.') . \");\\n\";\n                            }\n\n                            echo \"window.location.href = 'mfa_registrations.php';\\n\";\n                            echo \"</script>\\n\";\n                        }\n                        ?>\n\n                        <input type='hidden' name='action' value='' />\n                        <input type='hidden' name='error' value='' />\n                    </form>\n                </div>\n            </div>\n    </div><!--end of container div -->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n</body>\n</html>\n", "<?php\n\n/**\n * FIDO U2F Support Module\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Rod Roark <rod@sunsetsystems.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2018 Rod Roark <rod@sunsetsystems.com>\n * @copyright Copyright (c) 2018 Brady Miller <brady.g.miller@gmail.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE CNU General Public License 3\n */\n\nrequire_once('../globals.php');\nrequire_once(\"$srcdir/options.inc.php\");\n\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\OeUI\\OemrUI;\n\n// https is required, and with a proxy the server might not see it.\n$scheme = \"https://\"; // isset($_SERVER['HTTPS']) ? \"https://\" : \"http://\";\n$appId = $scheme . $_SERVER['HTTP_HOST'];\n$u2f = new u2flib_server\\U2F($appId);\n\n$userid = $_SESSION['authUserID'];\n$action = $_REQUEST['action'];\n$user_name = getUserIDInfo($userid);\n$user_full_name = $user_name['fname'] . \" \" . $user_name['lname'];\n?>\n<html>\n<head>\n<?php Header::setupHeader(); ?>\n<title><?php echo xlt('U2F Registration'); ?></title>\n<script src=\"<?php echo $GLOBALS['webroot'] ?>/library/js/u2f-api.js\"></script>\n<script>\n\nfunction doregister() {\n  var f = document.forms[0];\n  if (f.form_name.value.trim() == '') {\n    alert(<?php echo xlj(\"Please enter a name for this key.\"); ?>);\n    return;\n  }\n  var request = JSON.parse(f.form_request.value);\n  u2f.register(\n    <?php echo js_escape($appId); ?>,\n    [request],\n    [],\n    function(data) {\n      if(data.errorCode && data.errorCode != 0) {\n        alert(<?php echo xlj(\"Registration failed with error\"); ?> + ' ' + data.errorCode);\n        return;\n      }\n      f.form_registration.value = JSON.stringify(data);\n      f.action.value = 'reg2';\n      top.restoreSession();\n      f.submit();\n    },\n    60\n  );\n}\n\nfunction docancel() {\n  window.location.href = 'mfa_registrations.php';\n}\n\n</script>\n<?php\n    $arrOeUiSettings = array(\n        'heading_title' => xl('Register Universal 2nd Factor Key') . \" - \" . xl('U2F'),\n        'include_patient_name' => false,\n        'expandable' => false,\n        'expandable_files' => array(),//all file names need suffix _xpd\n        'action' => \"\",//conceal, reveal, search, reset, link or back\n        'action_title' => \"\",\n        'action_href' => \"\",//only for actions - reset, link or back\n        'show_help_icon' => false,\n        'help_file_name' => \"\"\n    );\n    $oemr_ui = new OemrUI($arrOeUiSettings);\n    ?>\n</head>\n<body class=\"body_top\">\n    <div id=\"container_div\" class=\"<?php echo $oemr_ui->oeContainer();?>\">\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <?php echo $oemr_ui->pageHeading() . \"\\r\\n\"; ?>\n            </div>\n        </div>\n        <form method='post' action='mfa_u2f.php' onsubmit='return top.restoreSession()'>\n        <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n\n        <?php\n\n        ///////////////////////////////////////////////////////////////////////\n\n        if ($action == 'reg1') {\n            list ($request, $signs) = $u2f->getRegisterData();\n            ?>\n        <div class=\"row\">\n            <div class=\"col-sm-12\">\n                <fieldset>\n                    <legend><?php echo xlt('Register U2F Key for') . \" \" . text($user_full_name); ?></legend>\n                    <div class='col-sm-12'>\n                        <p><?php echo xlt(\"Instructions\");?>:\n                            <ul>\n                                <li><?php echo xlt('This will register a new U2F USB key'); ?></li>\n                                <li><?php echo xlt('Type a name for your key, insert it into a USB port and click the Register button below'); ?></li>\n                                <li><?php echo xlt('Then press the flashing button on your key within 1 minute to complete registration'); ?></li>\n                            </ul>\n                    </div>\n\n                    <div class=\"form-group\">\n                        <label for=\"form_name\" class=\"col-sm-2 col-form-label\"><?php echo xlt('Please give this key a name'); ?></label>\n                        <div class=\"col-sm-4\">\n                            <input type='text' class='form-control' name='form_name' id='form_name'>\n                            <input type='hidden' name='form_request' value='<?php echo attr(json_encode($request)); ?>'>\n                            <input type='hidden' name='form_signs'   value='<?php echo attr(json_encode($signs)); ?>'>\n                            <input type='hidden' name='form_registration' value=''>\n                        </div>\n                    </div>\n\n                    <div class='col-sm-12'>\n                        <ul>\n                            <li><?php echo xlt('A secure (HTTPS) web connection is required for U2F'); ?></li>\n                            <li><?php echo xlt('Chrome browser version 41 and above, Mozilla Firefox browser version 64 and above, Microsoft Edge browser version 19 and above, Safari browser version 13 and above, Opera browser version 40 and Opera browser version 42 and above support FIDO U2F API'); ?></li>\n                            <li><?php echo xlt('Internet Explorer browser version 6 to Internet Explorer browser version 11 does not support FIDO U2F API'); ?></li>\n\n                            <li><?php echo xlt('For U2F support on Linux click'); ?>: <a href='https://www.key-id.com/enable-fido-u2f-linux/' rel=\"noopener\" target='_blank'><?php echo text('Enable FIDO U2F Linux'); ?></a></li>\n                            <li><?php echo xlt('For Firefox click'); ?>: <a href='https://www.trishtech.com/2018/07/enable-fido-u2f-security-key-yubikey-in-mozilla-firefox/' rel=\"noopener\" target='_blank'><?php echo text('Enable FIDO U2F Key in Firefox'); ?></a></li>\n                        </ul>\n                    </div>\n                </fieldset>\n                <div class=\"form-group clearfix\">\n                <div class=\"col-sm-12 text-left position-override\">\n                        <button type=\"button\" class=\"btn btn-secondary btn-save\" value='<?php echo xla('Register'); ?>' onclick='doregister()'><?php echo xlt('Register'); ?></button>\n                        <button type=\"button\" class=\"btn btn-link btn-cancel\" value=\"<?php echo xla('Cancel'); ?>\" onclick=\"docancel()\" ><?php echo xlt('Cancel'); ?></button>\n                    </div>\n                </div>\n            </div>\n        </div>\n            <?php\n        } elseif ($action == 'reg2') {\n            if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n                CsrfUtils::csrfNotVerified();\n            }\n            try {\n                $data = $u2f->doRegister(json_decode($_POST['form_request']), json_decode($_POST['form_registration']));\n            } catch (u2flib_server\\Error $e) {\n                die(xlt('Registration error') . ': ' . text($e->getMessage()));\n            }\n            echo \"<script>\\n\";\n            $row = sqlQuery(\n                \"SELECT COUNT(*) AS count FROM login_mfa_registrations WHERE \" .\n                \"`user_id` = ? AND `name` = ?\",\n                array($userid, $_POST['form_name'])\n            );\n            if (empty($row['count'])) {\n                sqlStatement(\n                    \"INSERT INTO login_mfa_registrations \" .\n                    \"(`user_id`, `method`, `name`, `var1`, `var2`) VALUES \" .\n                    \"(?, 'U2F', ?, ?, ?)\",\n                    array($userid, $_POST['form_name'], json_encode($data), '')\n                );\n            } else {\n                echo \" alert(\" . xlj('This key name is already in use by you. Try again.') . \");\\n\";\n            }\n            echo \" window.location.href = 'mfa_registrations.php';\\n\";\n            echo \"</script>\\n\";\n        }\n\n        ///////////////////////////////////////////////////////////////////////\n\n        ?>\n\n        <input type='hidden' name='action' value='' />\n        </form>\n    </div><!--end of container div -->\n    <?php $oemr_ui->oeBelowContainerDiv();?>\n</body>\n</html>\n", "<?php\n\n/**\n * This script Assign acl 'Emergency login'.\n *\n * @package   OpenEMR\n * @link      http://www.open-emr.org\n * @author    Roberto Vasquez <robertogagliotta@gmail.com>\n * @author    Brady Miller <brady.g.miller@gmail.com>\n * @author    Daniel Pflieger <daniel@mi-squared.com> <daniel@growlingflea.com>\n * @author    Ken Chapple <ken@mi-squared.com>\n * @copyright Copyright (c) 2015 Roberto Vasquez <robertogagliotta@gmail.com>\n * @copyright Copyright (c) 2017-2019 Brady Miller <brady.g.miller@gmail.com>\n * @copyright Copyright (c) 2021 Daniel Pflieger <daniel@mi-squared.com> <daniel@growlingflea.com>\n * @copyright Copyright (c) 2021 Ken Chapple <ken@mi-squared.com>\n * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3\n */\n\n$sessionAllowWrite = true;\nrequire_once(\"../globals.php\");\nrequire_once(\"$srcdir/auth.inc\");\n\nuse OpenEMR\\Common\\Acl\\AclExtended;\nuse OpenEMR\\Common\\Acl\\AclMain;\nuse OpenEMR\\Common\\Auth\\AuthUtils;\nuse OpenEMR\\Common\\Csrf\\CsrfUtils;\nuse OpenEMR\\Core\\Header;\nuse OpenEMR\\Services\\UserService;\nuse OpenEMR\\Events\\User\\UserUpdatedEvent;\nuse OpenEMR\\Events\\User\\UserCreatedEvent;\n\nif (!empty($_POST)) {\n    if (!CsrfUtils::verifyCsrfToken($_POST[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n}\n\nif (!empty($_GET)) {\n    if (!CsrfUtils::verifyCsrfToken($_GET[\"csrf_token_form\"])) {\n        CsrfUtils::csrfNotVerified();\n    }\n}\n\nif (!AclMain::aclCheckCore('admin', 'users')) {\n    die(xlt('Access denied'));\n}\n\nif (!AclMain::aclCheckCore('admin', 'super')) {\n    //block non-administrator user from create administrator\n    foreach ($_POST['access_group'] as $aro_group) {\n        if (AclExtended::isGroupIncludeSuperuser($aro_group)) {\n            die(xlt('Saving denied'));\n        };\n    }\n    if ($_POST['mode'] === 'update') {\n        //block non-administrator user from update administrator\n        $user_service = new UserService();\n        $user = $user_service->getUser($_POST['id']);\n        $aro_groups = AclExtended::aclGetGroupTitles($user['username']);\n        foreach ($aro_groups as $aro_group) {\n            if (AclExtended::isGroupIncludeSuperuser($aro_group)) {\n                die(xlt('Saving denied'));\n            };\n        }\n    }\n}\n\n$alertmsg = '';\n$bg_msg = '';\n$set_active_msg = 0;\n$show_message = 0;\n\n/* Sending a mail to the admin when the breakglass user is activated only if $GLOBALS['Emergency_Login_email'] is set to 1 */\nif (!empty($_POST['access_group']) && is_array($_POST['access_group'])) {\n    $bg_count = count($_POST['access_group']);\n    $mail_id = explode(\".\", $SMTP_HOST);\n    for ($i = 0; $i < $bg_count; $i++) {\n        if (($_POST['access_group'][$i] == \"Emergency Login\") && ($_POST['active'] == 'on') && ($_POST['pre_active'] == 0)) {\n            if (($_POST['get_admin_id'] == 1) && ($_POST['admin_id'] != \"\")) {\n                $res = sqlStatement(\"select username from users where id= ? \", array($_POST[\"id\"]));\n                $row = sqlFetchArray($res);\n                $uname = $row['username'];\n                $mail = new MyMailer();\n                $mail->From = $GLOBALS[\"practice_return_email_path\"];\n                $mail->FromName = \"Administrator OpenEMR\";\n                $text_body = \"Hello Security Admin,\\n\\n The Emergency Login user \" . $uname .\n                    \" was activated at \" . date('l jS \\of F Y h:i:s A') . \" \\n\\nThanks,\\nAdmin OpenEMR.\";\n                $mail->Body = $text_body;\n                $mail->Subject = \"Emergency Login User Activated\";\n                $mail->AddAddress($_POST['admin_id']);\n                $mail->Send();\n            }\n        }\n    }\n}\n\n/* To refresh and save variables in mail frame */\nif (isset($_POST[\"privatemode\"]) && $_POST[\"privatemode\"] == \"user_admin\") {\n    if ($_POST[\"mode\"] == \"update\") {\n        $user_data = sqlFetchArray(sqlStatement(\"select * from users where id= ? \", array($_POST[\"id\"])));\n\n        if (isset($_POST[\"username\"])) {\n            sqlStatement(\"update users set username=? where id= ? \", array(trim($_POST[\"username\"]), $_POST[\"id\"]));\n            sqlStatement(\"update `groups` set user=? where user= ?\", array(trim($_POST[\"username\"]), $user_data[\"username\"]));\n        }\n\n        if ($_POST[\"taxid\"]) {\n            sqlStatement(\"update users set federaltaxid=? where id= ? \", array($_POST[\"taxid\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"state_license_number\"]) {\n            sqlStatement(\"update users set state_license_number=? where id= ? \", array($_POST[\"state_license_number\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"drugid\"]) {\n            sqlStatement(\"update users set federaldrugid=? where id= ? \", array($_POST[\"drugid\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"upin\"]) {\n            sqlStatement(\"update users set upin=? where id= ? \", array($_POST[\"upin\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"npi\"]) {\n            sqlStatement(\"update users set npi=? where id= ? \", array($_POST[\"npi\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"taxonomy\"]) {\n            sqlStatement(\"update users set taxonomy = ? where id= ? \", array($_POST[\"taxonomy\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"lname\"]) {\n            sqlStatement(\"update users set lname=? where id= ? \", array($_POST[\"lname\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"job\"]) {\n            sqlStatement(\"update users set specialty=? where id= ? \", array($_POST[\"job\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"mname\"]) {\n            sqlStatement(\"update users set mname=? where id= ? \", array($_POST[\"mname\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"facility_id\"]) {\n            sqlStatement(\"update users set facility_id = ? where id = ? \", array($_POST[\"facility_id\"], $_POST[\"id\"]));\n            //(CHEMED) Update facility name when changing the id\n            sqlStatement(\"UPDATE users, facility SET users.facility = facility.name WHERE facility.id = ? AND users.id = ?\", array($_POST[\"facility_id\"], $_POST[\"id\"]));\n            //END (CHEMED)\n        }\n\n        if ($GLOBALS['restrict_user_facility'] && $_POST[\"schedule_facility\"]) {\n            $sqlBindArray = [];\n            $scheduledFacilityString = \"\";\n            foreach ($_POST[\"schedule_facility\"] as $scheduledFacility) {\n                $scheduledFacilityString .= \"?,\";\n                array_push($sqlBindArray, $scheduledFacility);\n            }\n            if (!empty($scheduledFacilityString)) {\n                $scheduledFacilityString = substr($scheduledFacilityString, 0, -1);\n            }\n            array_unshift($sqlBindArray, $_POST[\"id\"]);\n            sqlStatement(\"delete from users_facility\n            where tablename='users'\n            and table_id= ?\n            and facility_id not in (\" . $scheduledFacilityString . \")\", $sqlBindArray);\n\n            foreach ($_POST[\"schedule_facility\"] as $tqvar) {\n                sqlStatement(\"replace into users_facility set\n                facility_id = ?,\n                tablename='users',\n                table_id = ?\", array($tqvar, $_POST[\"id\"]));\n            }\n        }\n\n        if ($_POST[\"fname\"]) {\n            sqlStatement(\"update users set fname=? where id= ? \", array($_POST[\"fname\"], $_POST[\"id\"]));\n        }\n\n        if (isset($_POST['default_warehouse'])) {\n            sqlStatement(\"UPDATE users SET default_warehouse = ? WHERE id = ?\", array($_POST['default_warehouse'], $_POST[\"id\"]));\n        }\n\n        if (isset($_POST['irnpool'])) {\n            sqlStatement(\"UPDATE users SET irnpool = ? WHERE id = ?\", array($_POST['irnpool'], $_POST[\"id\"]));\n        }\n\n        if (!empty($_POST['clear_2fa'])) {\n            sqlStatement(\"DELETE FROM login_mfa_registrations WHERE user_id = ?\", array($_POST['id']));\n        }\n\n        if ($_POST[\"adminPass\"] && $_POST[\"clearPass\"]) {\n            $authUtilsUpdatePassword = new AuthUtils();\n            $success = $authUtilsUpdatePassword->updatePassword($_SESSION['authUserID'], $_POST['id'], $_POST['adminPass'], $_POST['clearPass']);\n            if (!$success) {\n                error_log(errorLogEscape($authUtilsUpdatePassword->getErrorMessage()));\n                $alertmsg .= $authUtilsUpdatePassword->getErrorMessage();\n            }\n        }\n\n        $tqvar  = (!empty($_POST[\"authorized\"])) ? 1 : 0;\n        $actvar = (!empty($_POST[\"active\"]))     ? 1 : 0;\n        $calvar = (!empty($_POST[\"calendar\"]))   ? 1 : 0;\n        $portalvar = (!empty($_POST[\"portal_user\"])) ? 1 : 0;\n\n        sqlStatement(\"UPDATE users SET authorized = ?, active = ?, \" .\n        \"calendar = ?, portal_user = ?, see_auth = ? WHERE \" .\n        \"id = ? \", array($tqvar, $actvar, $calvar, $portalvar, $_POST['see_auth'], $_POST[\"id\"]));\n      //Display message when Emergency Login user was activated\n        $bg_count = count($_POST['access_group']);\n        for ($i = 0; $i < $bg_count; $i++) {\n            if (($_POST['access_group'][$i] == \"Emergency Login\") && ($_POST['pre_active'] == 0) && ($actvar == 1)) {\n                $show_message = 1;\n            }\n        }\n\n        if (($_POST['access_group'])) {\n            for ($i = 0; $i < $bg_count; $i++) {\n                if (($_POST['access_group'][$i] == \"Emergency Login\") && ($_POST['user_type']) == \"\" && ($_POST['check_acl'] == 1) && ($_POST['active']) != \"\") {\n                    $set_active_msg = 1;\n                }\n            }\n        }\n\n        if ($_POST[\"comments\"]) {\n            sqlStatement(\"update users set info = ? where id = ? \", array($_POST[\"comments\"], $_POST[\"id\"]));\n        }\n\n        $erxrole = isset($_POST['erxrole']) ? $_POST['erxrole'] : '';\n        sqlStatement(\"update users set newcrop_user_role = ? where id = ? \", array($erxrole, $_POST[\"id\"]));\n\n        if ($_POST[\"physician_type\"]) {\n            sqlStatement(\"update users set physician_type = ? where id = ? \", array($_POST[\"physician_type\"], $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"main_menu_role\"]) {\n              $mainMenuRole = filter_input(INPUT_POST, 'main_menu_role');\n              sqlStatement(\"update `users` set `main_menu_role` = ? where `id` = ? \", array($mainMenuRole, $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"patient_menu_role\"]) {\n            $patientMenuRole = filter_input(INPUT_POST, 'patient_menu_role');\n            sqlStatement(\"update `users` set `patient_menu_role` = ? where `id` = ? \", array($patientMenuRole, $_POST[\"id\"]));\n        }\n\n        if ($_POST[\"erxprid\"]) {\n            sqlStatement(\"update users set weno_prov_id = ? where id = ? \", array($_POST[\"erxprid\"], $_POST[\"id\"]));\n        }\n\n        if (isset($_POST[\"supervisor_id\"])) {\n            sqlStatement(\"update users set supervisor_id = ? where id = ? \", array((int)$_POST[\"supervisor_id\"], $_POST[\"id\"]));\n        }\n        if (isset($_POST[\"google_signin_email\"])) {\n            sqlStatement(\"update users set google_signin_email = ? where id = ? \", array($_POST[\"google_signin_email\"], $_POST[\"id\"]));\n        }\n\n        // Set the access control group of user\n        $user_data = sqlFetchArray(sqlStatement(\"select username from users where id= ?\", array($_POST[\"id\"])));\n        AclExtended::setUserAro(\n            $_POST['access_group'],\n            $user_data[\"username\"],\n            (isset($_POST['fname']) ? $_POST['fname'] : ''),\n            (isset($_POST['mname']) ? $_POST['mname'] : ''),\n            (isset($_POST['lname']) ? $_POST['lname'] : '')\n        );\n\n        $userUpdatedEvent = new UserUpdatedEvent($user_data, $_POST);\n        $GLOBALS[\"kernel\"]->getEventDispatcher()->dispatch(UserUpdatedEvent::EVENT_HANDLE, $userUpdatedEvent, 10);\n    }\n}\n\n/* To refresh and save variables in mail frame  - Arb*/\nif (isset($_POST[\"mode\"])) {\n    if ($_POST[\"mode\"] == \"new_user\") {\n        if (empty($_POST[\"authorized\"]) || $_POST[\"authorized\"] != \"1\") {\n            $_POST[\"authorized\"] = 0;\n        }\n\n        $calvar = (!empty($_POST[\"calendar\"])) ? 1 : 0;\n        $portalvar = (!empty($_POST[\"portal_user\"])) ? 1 : 0;\n\n        $res = sqlQuery(\"select username from users where username = ?\", [trim($_POST['rumple'])]);\n        $doit = true;\n        if (!empty($res['username'])) {\n            $doit = false;\n        }\n\n        if ($doit == true) {\n            $insertUserSQL =\n            \"insert into users set \" .\n            \"username = '\"         . add_escape_custom(trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))) .\n            \"', password = '\"      . 'NoLongerUsed'                  .\n            \"', fname = '\"         . add_escape_custom(trim((isset($_POST['fname']) ? $_POST['fname'] : ''))) .\n            \"', mname = '\"         . add_escape_custom(trim((isset($_POST['mname']) ? $_POST['mname'] : ''))) .\n            \"', lname = '\"         . add_escape_custom(trim((isset($_POST['lname']) ? $_POST['lname'] : ''))) .\n            \"', federaltaxid = '\"  . add_escape_custom(trim((isset($_POST['federaltaxid']) ? $_POST['federaltaxid'] : ''))) .\n            \"', state_license_number = '\"  . add_escape_custom(trim((isset($_POST['state_license_number']) ? $_POST['state_license_number'] : ''))) .\n            \"', newcrop_user_role = '\"  . add_escape_custom(trim((isset($_POST['erxrole']) ? $_POST['erxrole'] : ''))) .\n            \"', physician_type = '\"  . add_escape_custom(trim((isset($_POST['physician_type']) ? $_POST['physician_type'] : ''))) .\n            \"', main_menu_role = '\"  . add_escape_custom(trim((isset($_POST['main_menu_role']) ? $_POST['main_menu_role'] : ''))) .\n            \"', patient_menu_role = '\"  . add_escape_custom(trim((isset($_POST['patient_menu_role']) ? $_POST['patient_menu_role'] : ''))) .\n            \"', weno_prov_id = '\"  . add_escape_custom(trim((isset($_POST['erxprid']) ? $_POST['erxprid'] : ''))) .\n            \"', authorized = '\"    . add_escape_custom(trim((isset($_POST['authorized']) ? $_POST['authorized'] : ''))) .\n            \"', info = '\"          . add_escape_custom(trim((isset($_POST['info']) ? $_POST['info'] : ''))) .\n            \"', federaldrugid = '\" . add_escape_custom(trim((isset($_POST['federaldrugid']) ? $_POST['federaldrugid'] : ''))) .\n            \"', upin = '\"          . add_escape_custom(trim((isset($_POST['upin']) ? $_POST['upin'] : ''))) .\n            \"', npi  = '\"          . add_escape_custom(trim((isset($_POST['npi']) ? $_POST['npi'] : ''))) .\n            \"', taxonomy = '\"      . add_escape_custom(trim((isset($_POST['taxonomy']) ? $_POST['taxonomy'] : ''))) .\n            \"', facility_id = '\"   . add_escape_custom(trim((isset($_POST['facility_id']) ? $_POST['facility_id'] : ''))) .\n            \"', specialty = '\"     . add_escape_custom(trim((isset($_POST['specialty']) ? $_POST['specialty'] : ''))) .\n            \"', see_auth = '\"      . add_escape_custom(trim((isset($_POST['see_auth']) ? $_POST['see_auth'] : ''))) .\n            \"', default_warehouse = '\" . add_escape_custom(trim((isset($_POST['default_warehouse']) ? $_POST['default_warehouse'] : ''))) .\n            \"', irnpool = '\"       . add_escape_custom(trim((isset($_POST['irnpool']) ? $_POST['irnpool'] : ''))) .\n            \"', calendar = '\"      . add_escape_custom($calvar) .\n            \"', portal_user = '\"   . add_escape_custom($portalvar) .\n            \"', supervisor_id = '\" . add_escape_custom((isset($_POST['supervisor_id']) ? (int)$_POST['supervisor_id'] : 0)) .\n            \"'\";\n\n            $authUtilsNewPassword = new AuthUtils();\n            $success = $authUtilsNewPassword->updatePassword(\n                $_SESSION['authUserID'],\n                0,\n                $_POST['adminPass'],\n                $_POST['stiltskin'],\n                true,\n                $insertUserSQL,\n                trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n            );\n            if (!empty($authUtilsNewPassword->getErrorMessage())) {\n                $alertmsg .= $authUtilsNewPassword->getErrorMessage();\n            }\n            if ($success) {\n                //set the facility name from the selected facility_id\n                sqlStatement(\n                    \"UPDATE users, facility SET users.facility = facility.name WHERE facility.id = ? AND users.username = ?\",\n                    array(\n                        trim((isset($_POST['facility_id']) ? $_POST['facility_id'] : '')),\n                        trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n                    )\n                );\n\n                sqlStatement(\n                    \"insert into `groups` set name = ?, user = ?\",\n                    array(\n                        trim((isset($_POST['groupname']) ? $_POST['groupname'] : '')),\n                        trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n                    )\n                );\n\n                if (trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))) {\n                              // Set the access control group of user\n                              AclExtended::setUserAro(\n                                  $_POST['access_group'],\n                                  trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')),\n                                  trim((isset($_POST['fname']) ? $_POST['fname'] : '')),\n                                  trim((isset($_POST['mname']) ? $_POST['mname'] : '')),\n                                  trim((isset($_POST['lname']) ? $_POST['lname'] : ''))\n                              );\n                }\n            }\n        } else {\n            $alertmsg .= xl('User') . ' ' . trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')) . ' ' . xl('already exists.');\n        }\n\n        if ($_POST['access_group']) {\n            $bg_count = count($_POST['access_group']);\n            for ($i = 0; $i < $bg_count; $i++) {\n                if ($_POST['access_group'][$i] == \"Emergency Login\") {\n                      $set_active_msg = 1;\n                }\n            }\n        }\n\n        $userCreatedEvent = new UserCreatedEvent($_POST);\n        $GLOBALS[\"kernel\"]->getEventDispatcher()->dispatch(UserCreatedEvent::EVENT_HANDLE, $userCreatedEvent, 10);\n    } elseif ($_POST[\"mode\"] == \"new_group\") {\n        $res = sqlStatement(\"select distinct name, user from `groups`\");\n        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n            $result[$iter] = $row;\n        }\n\n        $doit = 1;\n        foreach ($result as $iter) {\n            if ($doit == 1 && $iter[\"name\"] == (trim((isset($_POST['groupname']) ? $_POST['groupname'] : ''))) && $iter[\"user\"] == (trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')))) {\n                $doit--;\n            }\n        }\n\n        if ($doit == 1) {\n            sqlStatement(\n                \"insert into `groups` set name = ?, user = ?\",\n                array(\n                    trim((isset($_POST['groupname']) ? $_POST['groupname'] : '')),\n                    trim((isset($_POST['rumple']) ? $_POST['rumple'] : ''))\n                )\n            );\n        } else {\n            $alertmsg .= \"User \" . trim((isset($_POST['rumple']) ? $_POST['rumple'] : '')) .\n            \" is already a member of group \" . trim((isset($_POST['groupname']) ? $_POST['groupname'] : '')) . \". \";\n        }\n    }\n}\n\nif (isset($_GET[\"mode\"])) {\n  /*******************************************************************\n  // This is the code to delete a user.  Note that the link which invokes\n  // this is commented out.  Somebody must have figured it was too dangerous.\n  //\n  if ($_GET[\"mode\"] == \"delete\") {\n    $res = sqlStatement(\"select distinct username, id from users where id = '\" .\n      $_GET[\"id\"] . \"'\");\n    for ($iter = 0; $row = sqlFetchArray($res); $iter++)\n      $result[$iter] = $row;\n\n    // TBD: Before deleting the user, we should check all tables that\n    // reference users to make sure this user is not referenced!\n\n    foreach($result as $iter) {\n      sqlStatement(\"delete from `groups` where user = '\" . $iter[\"username\"] . \"'\");\n    }\n    sqlStatement(\"delete from users where id = '\" . $_GET[\"id\"] . \"'\");\n  }\n  *******************************************************************/\n\n    if ($_GET[\"mode\"] == \"delete_group\") {\n        $res = sqlStatement(\"select distinct user from `groups` where id = ?\", array($_GET[\"id\"]));\n        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n            $result[$iter] = $row;\n        }\n\n        foreach ($result as $iter) {\n            $un = $iter[\"user\"];\n        }\n\n        $res = sqlStatement(\"select name, user from `groups` where user = ? \" .\n        \"and id != ?\", array($un, $_GET[\"id\"]));\n\n        // Remove the user only if they are also in some other group.  I.e. every\n        // user must be a member of at least one group.\n        if (sqlFetchArray($res) != false) {\n              sqlStatement(\"delete from `groups` where id = ?\", array($_GET[\"id\"]));\n        } else {\n              $alertmsg .= \"You must add this user to some other group before \" .\n                \"removing them from this group. \";\n        }\n    }\n}\n// added for form submit's from usergroup_admin_add and user_admin.php\n// sjp 12/29/17\nif (isset($_REQUEST[\"mode\"])) {\n    exit(text(trim($alertmsg)));\n}\n\n$form_inactive = empty($_POST['form_inactive']) ? false : true;\n\n?>\n<html>\n<head>\n<title><?php echo xlt('User / Groups');?></title>\n\n<?php Header::setupHeader(['common']); ?>\n\n<script>\n\n$(function () {\n\n    tabbify();\n\n    $(\".medium_modal\").on('click', function(e) {\n        e.preventDefault();e.stopPropagation();\n        dlgopen('', '', 'modal-mlg', 450, '', '', {\n            type: 'iframe',\n            url: $(this).attr('href')\n        });\n    });\n\n});\n\nfunction authorized_clicked() {\n var f = document.forms[0];\n f.calendar.disabled = !f.authorized.checked;\n f.calendar.checked  =  f.authorized.checked;\n}\n\n</script>\n\n</head>\n<body class=\"body_top\">\n\n<div class=\"container\">\n    <div class=\"row\">\n        <div class=\"col-12\">\n            <div class=\"page-title\">\n                <h2><?php echo xlt('User / Groups');?></h2>\n            </div>\n        </div>\n    </div>\n    <div class=\"row\">\n        <div class=\"col-12\">\n            <div class=\"btn-group\">\n                <a href=\"usergroup_admin_add.php\" class=\"medium_modal btn btn-secondary btn-add\"><?php echo xlt('Add User'); ?></a>\n                <a href=\"facility_user.php\" class=\"btn btn-secondary btn-show\"><?php echo xlt('View Facility Specific User Information'); ?></a>\n            </div>\n            <form name='userlist' method='post' style=\"display: inline;\" class=\"form-inline\" class=\"float-right\" action='usergroup_admin.php' onsubmit='return top.restoreSession()'>\n                <input type=\"hidden\" name=\"csrf_token_form\" value=\"<?php echo attr(CsrfUtils::collectCsrfToken()); ?>\" />\n                <div class=\"checkbox\">\n                    <label for=\"form_inactive\">\n                        <input type='checkbox' class=\"form-control\" id=\"form_inactive\" name='form_inactive' value='1' onclick='submit()' <?php echo ($form_inactive) ? 'checked ' : ''; ?>>\n                        <?php echo xlt('Include inactive users'); ?>\n                    </label>\n                </div>\n            </form>\n        </div>\n    </div>\n    <div class=\"row\">\n        <div class=\"col-12\">\n            <?php\n            if ($set_active_msg == 1) {\n                echo \"<div class='alert alert-danger'>\" . xlt('Emergency Login ACL is chosen. The user is still in active state, please de-activate the user and activate the same when required during emergency situations. Visit Administration->Users for activation or de-activation.') . \"</div><br />\";\n            }\n\n            if ($show_message == 1) {\n                echo \"<div class='alert alert-danger'>\" . xlt('The following Emergency Login User is activated:') . \" \" . \"<b>\" . text($_GET['fname']) . \"</b>\" . \"</div><br />\";\n                echo \"<div class='alert alert-danger'>\" . xlt('Emergency Login activation email will be circulated only if following settings in the interface/globals.php file are configured:') . \" \\$GLOBALS['Emergency_Login_email'], \\$GLOBALS['Emergency_Login_email_id']</div>\";\n            }\n\n            ?>\n            <div class=\"table-responsive\">\n                <table class=\"table table-striped\">\n                    <thead>\n                    <tr>\n                        <th><?php echo xlt('Username'); ?></th>\n                        <th><?php echo xlt('Real Name'); ?></th>\n                        <th><?php echo xlt('Additional Info'); ?></th>\n                        <th><?php echo xlt('Authorized'); ?></th>\n                        <th><?php echo xlt('MFA'); ?></th>\n                        <?php\n                        $checkPassExp = false;\n                        if (($GLOBALS['password_expiration_days'] != 0) && (check_integer($GLOBALS['password_expiration_days'])) && (check_integer($GLOBALS['password_grace_time']))) {\n                            $checkPassExp = true;\n                            echo '<th>' . xlt('Password Expiration') . '</th>';\n                        }\n                        ?>\n                    </tr>\n                    <tbody>\n                        <?php\n                        $query = \"SELECT * FROM users WHERE username != '' \";\n                        if (!$form_inactive) {\n                            $query .= \"AND active = '1' \";\n                        }\n\n                        $query .= \"ORDER BY username\";\n                        $res = sqlStatement($query);\n                        for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n                            $result4[$iter] = $row;\n                        }\n\n                        foreach ($result4 as $iter) {\n                            if ($iter[\"authorized\"]) {\n                                $iter[\"authorized\"] = xl('yes');\n                            } else {\n                                $iter[\"authorized\"] = xl('no');\n                            }\n\n                            $mfa = sqlQuery(\n                                \"SELECT `method` FROM `login_mfa_registrations` \" .\n                                \"WHERE `user_id` = ? AND (`method` = 'TOTP' OR `method` = 'U2F')\",\n                                [$iter['id']]\n                            );\n                            if (!empty($mfa['method'])) {\n                                $isMfa = xl('yes');\n                            } else {\n                                $isMfa = xl('no');\n                            }\n\n                            if ($checkPassExp && !empty($iter[\"active\"])) {\n                                $current_date = date(\"Y-m-d\");\n                                $userSecure = privQuery(\"SELECT `last_update_password` FROM `users_secure` WHERE `id` = ?\", [$iter['id']]);\n                                $pwd_expires = date(\"Y-m-d\", strtotime($userSecure['last_update_password'] . \"+\" . $GLOBALS['password_expiration_days'] . \" days\"));\n                                $grace_time = date(\"Y-m-d\", strtotime($pwd_expires . \"+\" . $GLOBALS['password_grace_time'] . \" days\"));\n                            }\n\n                            print \"<tr>\n                                <td><b><a href='user_admin.php?id=\" . attr_url($iter[\"id\"]) . \"&csrf_token_form=\" . attr_url(CsrfUtils::collectCsrfToken()) .\n                                \"' class='medium_modal' onclick='top.restoreSession()'>\" . text($iter[\"username\"]) . \"</a></b>\" . \"&nbsp;</td>\n                                <td>\" . text($iter[\"fname\"]) . ' ' . text($iter[\"lname\"]) . \"&nbsp;</td>\n                                <td>\" . text($iter[\"info\"]) . \"&nbsp;</td>\n                                <td align='left'><span>\" . text($iter[\"authorized\"]) . \"</td>\n                                <td align='left'><span>\" . text($isMfa) . \"</td>\";\n                            if ($checkPassExp) {\n                                echo '<td>';\n                                if (AuthUtils::useActiveDirectory($iter[\"username\"]) || empty($iter[\"active\"])) {\n                                    // LDAP bypasses expired password mechanism\n                                    echo '<div class=\"alert alert-success\" role=\"alert\">' . xlt('Not Applicable') . '</div>';\n                                } elseif (strtotime($current_date) > strtotime($grace_time)) {\n                                    echo '<div class=\"alert alert-danger\" role=\"alert\">' . xlt('Expired') . '</div>';\n                                } elseif (strtotime($current_date) > strtotime($pwd_expires)) {\n                                    echo '<div class=\"alert alert-warning\" role=\"alert\">' . xlt('Grace Period') . '</div>';\n                                } else {\n                                    echo '<div class=\"alert alert-success\" role=\"alert\">' . text(oeFormatShortDate($pwd_expires)) . '</div>';\n                                }\n                                echo '</td>';\n                            }\n                            print \"</tr>\\n\";\n                        }\n                        ?>\n                    </tbody>\n                </table>\n            </div>\n            <?php\n            if (empty($GLOBALS['disable_non_default_groups'])) {\n                $res = sqlStatement(\"select * from `groups` order by name\");\n                for ($iter = 0; $row = sqlFetchArray($res); $iter++) {\n                    $result5[$iter] = $row;\n                }\n\n                foreach ($result5 as $iter) {\n                    $grouplist[$iter[\"name\"]] .= text($iter[\"user\"]) .\n                        \"(<a class='link_submit' href='usergroup_admin.php?mode=delete_group&id=\" .\n                        attr_url($iter[\"id\"]) . \"&csrf_token_form=\" . attr_url(CsrfUtils::collectCsrfToken()) . \"' onclick='top.restoreSession()'>\" . xlt('Remove') . \"</a>), \";\n                }\n\n                foreach ($grouplist as $groupname => $list) {\n                    print \"<span class='bold'>\" . text($groupname) . \"</span><br />\\n<span>\" .\n                        substr($list, 0, strlen($list) - 2) . \"</span><br />\\n\";\n                }\n            }\n            ?>\n        </div>\n    </div>\n</div>\n<script>\n<?php\nif ($alertmsg = trim($alertmsg)) {\n    echo \"alert(\" . js_escape($alertmsg) . \");\\n\";\n}\n?>\n</script>\n</body>\n</html>\n"], "filenames": ["interface/orders/patient_match_dialog.php", "interface/patient_file/report/patient_report.php", "interface/usergroup/mfa_registrations.php", "interface/usergroup/mfa_totp.php", "interface/usergroup/mfa_u2f.php", "interface/usergroup/usergroup_admin.php"], "buggy_code_start_loc": [55, 332, 139, 112, 104, 280], "buggy_code_end_loc": [56, 333, 169, 174, 105, 286], "fixing_code_start_loc": [55, 332, 139, 112, 104, 280], "fixing_code_end_loc": [56, 333, 169, 174, 105, 284], "type": "CWE-79", "message": "In OpenEMR, versions 2.7.3-rc1 to 6.0.0 are vulnerable to Stored Cross-Site-Scripting (XSS) due to user input not being validated properly in the `Allergies` section. An attacker could lure an admin to enter a malicious payload and by that initiate the exploit.", "other": {"cve": {"id": "CVE-2021-25921", "sourceIdentifier": "vulnerabilitylab@mend.io", "published": "2021-03-22T20:15:17.943", "lastModified": "2021-03-24T18:24:39.170", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In OpenEMR, versions 2.7.3-rc1 to 6.0.0 are vulnerable to Stored Cross-Site-Scripting (XSS) due to user input not being validated properly in the `Allergies` section. An attacker could lure an admin to enter a malicious payload and by that initiate the exploit."}, {"lang": "es", "value": "En OpenEMR, las versiones 2.7.3-rc1 a 6.0.0, son vulnerables a un ataque de tipo Cross-Site-Scripting (XSS) Almacenado debido a que la entrada del usuario no es validada apropiadamente en la secci\u00f3n \"Allergies\".&#xa0;Un atacante podr\u00eda convencer a un administrador para que ingrese una carga \u00fatil maliciosa y as\u00ed iniciar la explotaci\u00f3n"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:open-emr:openemr:*:*:*:*:*:*:*:*", "versionStartIncluding": "2.7.3", "versionEndIncluding": "6.0.0", "matchCriteriaId": "22010AB0-B63C-4F53-8C59-A2288B9B8874"}]}]}], "references": [{"url": "https://github.com/openemr/openemr/commit/0fadc3e592d84bc9dfe9e0403f8bd6e3c7d8427f", "source": "vulnerabilitylab@mend.io", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://www.whitesourcesoftware.com/vulnerability-database/CVE-2021-25921", "source": "vulnerabilitylab@mend.io", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/openemr/openemr/commit/0fadc3e592d84bc9dfe9e0403f8bd6e3c7d8427f"}}