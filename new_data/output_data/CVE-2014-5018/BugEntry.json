{"buggy_code": ["<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');\n/*\n* LimeSurvey\n* Copyright (C) 2007-2011 The LimeSurvey Project Team / Carsten Schmitz\n* All rights reserved.\n* License: GNU/GPL License v2 or later, see LICENSE.php\n* LimeSurvey is free software. This version may have been modified pursuant\n* to the GNU General Public License, and as distributed it includes or\n* is derivative of works licensed under the GNU General Public License or\n* other free or open source software licenses.\n* See COPYRIGHT.php for copyright notices and details.\n*/\nYii::import('application.helpers.sanitize_helper', true);\n\n/**\n* Simple function to sort the permissions by title\n*\n* @param mixed $aPermissionA  Permission A to compare\n* @param mixed $aPermissionB  Permission B to compare\n*/\nfunction comparePermission($aPermissionA,$aPermissionB)\n{\n    if($aPermissionA['title'] >$aPermissionB['title']) {\n        return 1;\n    }\n    else {\n        return -1;\n    }\n}\n\n/**\n * Translation helper function.\n * @param string $string\n * @param string $escapemode\n */\nfunction gT($string, $escapemode = 'html')\n{\n    Yii::import('application.libraries.Limesurvey_lang');\n    if (isset(App()->lang))\n    {\n        return App()->lang->gT($string, $escapemode);\n    }\n    else\n    {\n        return $string;\n    }\n}\n\nfunction eT($string, $escapemode = 'html')\n{\n    echo gT($string, $escapemode);\n}\n\nfunction ngT($single, $plural, $number, $escapemode = 'html')\n{\n    Yii::import('application.libraries.Limesurvey_lang');\n    return App()->lang->ngT($single, $plural, $number, $escapemode);\n}\n/**\n* getQuestionTypeList() Returns list of question types available in LimeSurvey. Edit this if you are adding a new\n*    question type\n*\n* @param string $SelectedCode Value of the Question Type (defaults to \"T\")\n* @param string $ReturnType Type of output from this function (defaults to selector)\n*\n* @return depending on $ReturnType param, returns a straight \"array\" of question types, or an <option></option> list\n*\n*/\nfunction getQuestionTypeList($SelectedCode = \"T\", $ReturnType = \"selector\")\n{\n    $publicurl = Yii::app()->getConfig('publicurl');\n    \n    $qtypes = Question::typeList();\n    if ($ReturnType == \"array\")\n        return $qtypes;\n\n    if ($ReturnType == \"group\")\n    {\n        foreach ($qtypes as $qkey => $qtype)\n        {\n            $newqType[$qtype['group']][$qkey] = $qtype;\n        }\n\n\n        $qtypeselecter = \"\";\n        foreach ($newqType as $group => $members)\n        {\n            $qtypeselecter .= '<optgroup label=\"' . $group . '\">';\n            foreach ($members as $TypeCode => $TypeProperties)\n            {\n                $qtypeselecter .= \"<option value='$TypeCode'\";\n                if ($SelectedCode == $TypeCode)\n                {\n                    $qtypeselecter .= \" selected='selected'\";\n                }\n                $qtypeselecter .= \">{$TypeProperties['description']}</option>\\n\";\n            }\n            $qtypeselecter .= '</optgroup>';\n        }\n\n        return $qtypeselecter;\n    };\n    $qtypeselecter = \"\";\n    foreach ($qtypes as $TypeCode => $TypeProperties)\n    {\n        $qtypeselecter .= \"<option value='$TypeCode'\";\n        if ($SelectedCode == $TypeCode)\n        {\n            $qtypeselecter .= \" selected='selected'\";\n        }\n        $qtypeselecter .= \">{$TypeProperties['description']}</option>\\n\";\n    }\n    return $qtypeselecter;\n}\n\n/**\n* isStandardTemplate returns true if a template is a standard template\n* This function does not check if a template actually exists\n*\n* @param mixed $sTemplateName template name to look for\n* @return bool True if standard template, otherwise false\n*/\nfunction isStandardTemplate($sTemplateName)\n{\n    return in_array($sTemplateName,array('basic',\n    'bluengrey',\n    'business_grey',\n    'citronade',\n    'clear_logo',\n    'default',\n    'eirenicon',\n    'limespired',\n    'mint_idea',\n    'sherpa',\n    'vallendar'));\n}\n\n/**\n* getSurveyList() Queries the database (survey table) for a list of existing surveys\n*\n* @param boolean $returnarray if set to true an array instead of an HTML option list is given back\n* @return string This string is returned containing <option></option> formatted list of existing surveys\n*\n*/\nfunction getSurveyList($returnarray=false, $surveyid=false)\n{\n    static $cached = null;\n\n    $timeadjust = getGlobalSetting('timeadjust');\n    $clang = new Limesurvey_lang(isset(Yii::app()->session['adminlang']) ? Yii::app()->session['adminlang'] : 'en');\n\n    if(is_null($cached)) {\n        $args = array('order'=>'surveyls_title');\n        if (!Permission::model()->hasGlobalPermission('superadmin','read'))\n        {\n            $surveyidresult = Survey::model()->permission(Yii::app()->user->getId())->with(array('languagesettings'=>array('condition'=>'surveyls_language=language')))->findAll($args);\n        } else {\n            $surveyidresult = Survey::model()->with(array('languagesettings'=>array('condition'=>'surveyls_language=language')))->findAll($args);\n        }\n\n        $surveynames = array();\n        foreach ($surveyidresult as $result)\n        {\n            $surveynames[] = array_merge($result->attributes, $result->defaultlanguage->attributes);\n        }\n\n        $cached = $surveynames;\n    } else {\n        $surveynames = $cached;\n    }\n    $surveyselecter = \"\";\n    if ($returnarray===true) return $surveynames;\n    $activesurveys='';\n    $inactivesurveys='';\n    $expiredsurveys='';\n    if ($surveynames)\n    {\n        foreach($surveynames as $sv)\n        {\n\n            $surveylstitle=flattenText($sv['surveyls_title']);\n            if (strlen($surveylstitle)>45)\n            {\n                $surveylstitle = htmlspecialchars(mb_strcut(html_entity_decode($surveylstitle,ENT_QUOTES,'UTF-8'), 0, 45, 'UTF-8')).\"...\";\n            }\n\n            if($sv['active']!='Y')\n            {\n                $inactivesurveys .= \"<option \";\n                if(Yii::app()->user->getId() == $sv['owner_id'])\n                {\n                    $inactivesurveys .= \" class='mysurvey emphasis'\";\n                }\n                if ($sv['sid'] == $surveyid)\n                {\n                    $inactivesurveys .= \" selected='selected'\"; $svexist = 1;\n                }\n                $inactivesurveys .=\" value='{$sv['sid']}'>{$surveylstitle}</option>\\n\";\n            } elseif($sv['expires']!='' && $sv['expires'] < dateShift(date(\"Y-m-d H:i:s\"), \"Y-m-d H:i:s\", $timeadjust))\n            {\n                $expiredsurveys .=\"<option \";\n                if (Yii::app()->user->getId() == $sv['owner_id'])\n                {\n                    $expiredsurveys .= \" class='mysurvey emphasis'\";\n                }\n                if ($sv['sid'] == $surveyid)\n                {\n                    $expiredsurveys .= \" selected='selected'\"; $svexist = 1;\n                }\n                $expiredsurveys .=\" value='{$sv['sid']}'>{$surveylstitle}</option>\\n\";\n            } else\n            {\n                $activesurveys .= \"<option \";\n                if(Yii::app()->user->getId() == $sv['owner_id'])\n                {\n                    $activesurveys .= \" class='mysurvey emphasis'\";\n                }\n                if ($sv['sid'] == $surveyid)\n                {\n                    $activesurveys .= \" selected='selected'\"; $svexist = 1;\n                }\n                $activesurveys .=\" value='{$sv['sid']}'>{$surveylstitle}</option>\\n\";\n            }\n        } // End Foreach\n    }\n\n    //Only show each activesurvey group if there are some\n    if ($activesurveys!='')\n    {\n        $surveyselecter .= \"<optgroup label='\".$clang->gT(\"Active\").\"' class='activesurveyselect'>\\n\";\n        $surveyselecter .= $activesurveys . \"</optgroup>\";\n    }\n    if ($expiredsurveys!='')\n    {\n        $surveyselecter .= \"<optgroup label='\".$clang->gT(\"Expired\").\"' class='expiredsurveyselect'>\\n\";\n        $surveyselecter .= $expiredsurveys . \"</optgroup>\";\n    }\n    if ($inactivesurveys!='')\n    {\n        $surveyselecter .= \"<optgroup label='\".$clang->gT(\"Inactive\").\"' class='inactivesurveyselect'>\\n\";\n        $surveyselecter .= $inactivesurveys . \"</optgroup>\";\n    }\n    if (!isset($svexist))\n    {\n        $surveyselecter = \"<option selected='selected' value=''>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;\n    } else\n    {\n        $surveyselecter = \"<option value=''>\".$clang->gT(\"None\").\"</option>\\n\".$surveyselecter;\n    }\n    return $surveyselecter;\n}\n\nfunction getTemplateList()\n{\n    $usertemplaterootdir=Yii::app()->getConfig(\"usertemplaterootdir\");\n    $standardtemplaterootdir=Yii::app()->getConfig(\"standardtemplaterootdir\");\n\n    if (!$usertemplaterootdir) {die(\"getTemplateList() no template directory\");}\n    if ($handle = opendir($standardtemplaterootdir))\n    {\n        while (false !== ($file = readdir($handle)))\n        {\n            if (!is_file(\"$standardtemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\" && isStandardTemplate($file))\n            {\n                $list_of_files[$file] = $standardtemplaterootdir.DIRECTORY_SEPARATOR.$file;\n            }\n        }\n        closedir($handle);\n    }\n\n    if ($handle = opendir($usertemplaterootdir))\n    {\n        while (false !== ($file = readdir($handle)))\n        {\n            if (!is_file(\"$usertemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\")\n            {\n                $list_of_files[$file] = $usertemplaterootdir.DIRECTORY_SEPARATOR.$file;\n            }\n        }\n        closedir($handle);\n    }\n    ksort($list_of_files);\n\n    return $list_of_files;\n}\n\nfunction getAdminThemeList()\n{\n    // $usertemplaterootdir=Yii::app()->getConfig(\"usertemplaterootdir\");\n    $standardtemplaterootdir=Yii::app()->getConfig(\"styledir\");\n\n    //    if (!$usertemplaterootdir) {die(\"getTemplateList() no template directory\");}\n    if ($handle = opendir($standardtemplaterootdir))\n    {\n        while (false !== ($file = readdir($handle)))\n        {\n            if (!is_file(\"$standardtemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\")\n            {\n                $list_of_files[$file] = $standardtemplaterootdir.DIRECTORY_SEPARATOR.$file;\n            }\n        }\n        closedir($handle);\n    }\n\n    /*    if ($handle = opendir($usertemplaterootdir))\n    {\n    while (false !== ($file = readdir($handle)))\n    {\n    if (!is_file(\"$usertemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\")\n    {\n    $list_of_files[$file] = $usertemplaterootdir.DIRECTORY_SEPARATOR.$file;\n    }\n    }\n    closedir($handle);\n    }         */\n    ksort($list_of_files);\n\n    return $list_of_files;\n}\n\n\n/**\n* getQuestions() queries the database for an list of all questions matching the current survey and group id\n*\n* @return This string is returned containing <option></option> formatted list of questions in the current survey and group\n*/\nfunction getQuestions($surveyid,$gid,$selectedqid)\n{\n   $clang = Yii::app()->lang;\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $qrows = Question::model()->findAllByAttributes(array('sid' => $surveyid, 'gid' => $gid, 'language' => $s_lang, 'parent_qid' => 0),array('order'=>'question_order'));\n\n    if (!isset($sQuestionselecter)) {$sQuestionselecter=\"\";}\n    foreach ($qrows as $qrow)\n    {\n        $qrow = $qrow->attributes;\n        $qrow['title'] = strip_tags($qrow['title']);\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid.\"/gid/\".$gid.\"/qid/\".$qrow['qid']);\n        $sQuestionselecter .= \"<option value='{$link}'\";\n        if ($selectedqid == $qrow['qid'])\n        {\n            $sQuestionselecter .= \" selected='selected'\";\n            $qexists=true;\n        }\n        $sQuestionselecter .=\">{$qrow['title']}:\";\n        $sQuestionselecter .= \" \";\n        $question=flattenText($qrow['question']);\n        if (strlen($question)<35)\n        {\n            $sQuestionselecter .= $question;\n        }\n        else\n        {\n            $sQuestionselecter .= htmlspecialchars(mb_strcut(html_entity_decode($question,ENT_QUOTES,'UTF-8'), 0, 35, 'UTF-8')).\"...\";\n        }\n        $sQuestionselecter .= \"</option>\\n\";\n    }\n\n    if (!isset($qexists))\n    {\n        $sQuestionselecter = \"<option selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$sQuestionselecter;\n    }\n    else\n    {\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid.\"/gid/\".$gid);\n        $sQuestionselecter = \"<option value='{$link}'>\".$clang->gT(\"None\").\"</option>\\n\".$sQuestionselecter;\n    }\n    return $sQuestionselecter;\n}\n\n/**\n* getGidPrevious() returns the Gid of the group prior to the current active group\n*\n* @param string $surveyid\n* @param string $gid\n*\n* @return The Gid of the previous group\n*/\nfunction getGidPrevious($surveyid, $gid)\n{\n    $clang = Yii::app()->lang;\n\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $qresult = QuestionGroup::model()->findAllByAttributes(array('sid' => $surveyid, 'language' => $s_lang), array('order'=>'group_order'));\n\n    $i = 0;\n    $iPrev = -1;\n    foreach ($qresult as $qrow)\n    {\n        $qrow = $qrow->attributes;\n        if ($gid == $qrow['gid']) {$iPrev = $i - 1;}\n        $i += 1;\n    }\n\n    if ($iPrev >= 0) {$GidPrev = $qresult[$iPrev]->gid;}\n    else {$GidPrev = \"\";}\n    return $GidPrev;\n}\n\n/**\n* getQidPrevious() returns the Qid of the question prior to the current active question\n*\n* @param string $surveyid\n* @param string $gid\n* @param string $qid\n*\n* @return This Qid of the previous question\n*/\nfunction getQidPrevious($surveyid, $gid, $qid)\n{\n    $clang = Yii::app()->lang;\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $qrows = Question::model()->findAllByAttributes(array('gid' => $gid, 'sid' => $surveyid, 'language' => $s_lang, 'parent_qid'=>0),array('order'=>'question_order'));\n\n    $i = 0;\n    $iPrev = -1;\n    if (count($qrows) > 0)\n    {\n\n        foreach ($qrows as $qrow)\n        {\n            $qrow = $qrow->attributes;\n            if ($qid == $qrow['qid']) {$iPrev = $i - 1;}\n            $i += 1;\n        }\n    }\n    if ($iPrev >= 0) {$QidPrev = $qrows[$iPrev]->qid;}\n    else {$QidPrev = \"\";}\n\n\n    return $QidPrev;\n}\n\n/**\n* getGidNext() returns the Gid of the group next to the current active group\n*\n* @param string $surveyid\n* @param string $gid\n*\n* @return The Gid of the next group\n*/\nfunction getGidNext($surveyid, $gid)\n{\n    $clang = Yii::app()->lang;\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    $qresult = QuestionGroup::model()->findAllByAttributes(array('sid' => $surveyid, 'language' => $s_lang), array('order'=>'group_order'));\n\n    $GidNext=\"\";\n    $i = 0;\n    $iNext = 0;\n\n    foreach ($qresult as $qrow)\n    {\n        $qrow = $qrow->attributes;\n        if ($gid == $qrow['gid']) {$iNext = $i + 1;}\n        $i += 1;\n    }\n\n    if ($iNext < count($qresult)) {$GidNext = $qresult[$iNext]->gid;}\n    else {$GidNext = \"\";}\n    return $GidNext;\n}\n\n/**\n* getQidNext() returns the Qid of the question prior to the current active question\n*\n* @param string $surveyid\n* @param string $gid\n* @param string $qid\n*\n* @return This Qid of the previous question\n*/\nfunction getQidNext($surveyid, $gid, $qid)\n{\n    $clang = Yii::app()->lang;\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    $qrows = Question::model()->findAllByAttributes(array('gid' => $gid, 'sid' => $surveyid, 'language' => $s_lang, 'parent_qid' => 0), array('order'=>'question_order'));\n    $i = 0;\n    $iNext = 0;\n\n    foreach ($qrows as $qrow)\n    {\n        if ($qid == $qrow->qid && $qid) {$iNext = $i + 1;}\n        $i += 1;\n    }\n\n    if ($iNext < count($qrows)) {$QidNext = $qrows[$iNext]->qid;}\n    else {$QidNext = \"\";}\n    return $QidNext;\n}\n\nfunction convertGETtoPOST($url)\n{\n    // This function must be deprecated and replaced by $.post\n    $url = preg_replace('/&amp;/i','&',$url);\n    $stack = explode('?',$url);\n    $calledscript = array_shift($stack);\n    $query = array_shift($stack);\n    $aqueryitems = explode('&',$query);\n    $arrayParam = Array();\n    $arrayVal = Array();\n\n    foreach ($aqueryitems as $queryitem)\n    {\n        $stack =  explode ('=', $queryitem);\n        $paramname = array_shift($stack);\n        $value = array_shift($stack);\n        $arrayParam[] = \"'\".$paramname.\"'\";\n        $arrayVal[] = substr($value, 0, 9) != \"document.\" ? \"'\".$value.\"'\" : $value;\n    }\n    //    $Paramlist = \"[\" . implode(\",\",$arrayParam) . \"]\";\n    //    $Valuelist = \"[\" . implode(\",\",$arrayVal) . \"]\";\n    $Paramlist = \"new Array(\" . implode(\",\",$arrayParam) . \")\";\n    $Valuelist = \"new Array(\" . implode(\",\",$arrayVal) . \")\";\n    $callscript = \"sendPost('$calledscript','',$Paramlist,$Valuelist);\";\n    return $callscript;\n}\n\n\n/**\n* This function calculates how much space is actually used by all files uploaded\n* using the File Upload question type\n*\n* @returns integer Actual space used in MB\n*/\nfunction calculateTotalFileUploadUsage(){\n    global $uploaddir;\n    $sQuery='select sid from {{surveys}}';\n    $oResult = dbExecuteAssoc($sQuery); //checked\n    $aRows = $oResult->readAll();\n    $iTotalSize=0.0;\n    foreach ($aRows as $aRow)\n    {\n        $sFilesPath=$uploaddir.'/surveys/'.$aRow['sid'].'/files';\n        if (file_exists($sFilesPath))\n        {\n            $iTotalSize+=(float)getDirectorySize($sFilesPath);\n        }\n    }\n    return (float)$iTotalSize/1024/1024;\n}\n\nfunction getDirectorySize($directory) {\n    $size = 0;\n    foreach(new RecursiveIteratorIterator(new RecursiveDirectoryIterator($directory)) as $file){\n        $size+=$file->getSize();\n    }\n    return $size;\n}\n\n\n/**\n* Gets number of groups inside a particular survey\n*\n* @param string $surveyid\n* @param mixed $lang\n*/\nfunction getGroupSum($surveyid, $lang)\n{\n    //$condn = \"WHERE sid=\".$surveyid.\" AND language='\".$lang.\"'\"; //Getting a count of questions for this survey\n    $condn = array('sid'=>$surveyid,'language'=>$lang);\n    $sumresult3 = count(QuestionGroup::model()->findAllByAttributes($condn)); //Checked)\n\n    return $sumresult3 ;\n}\n\n\n/**\n* getMaxGroupOrder($surveyid) queries the database for the maximum sortorder of a group and returns the next higher one.\n*\n* @param mixed $surveyid\n*/\nfunction getMaxGroupOrder($surveyid)\n{\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    //$max_sql = \"SELECT max( group_order ) AS max FROM \".db_table_name('groups').\" WHERE sid =$surveyid AND language='{$s_lang}'\" ;\n    $query = QuestionGroup::model()->find(array('order' => 'group_order desc'));\n    $current_max = !is_null($query) ? $query->group_order : '';\n\n    if($current_max!=\"\")\n    {\n        return ++$current_max ;\n    }\n    else return \"0\" ;\n}\n\n\n/**\n* getGroupOrder($surveyid,$gid) queries the database for the sortorder of a group.\n*\n* @param mixed $surveyid\n* @param mixed $gid\n* @return mixed\n*/\nfunction getGroupOrder($surveyid,$gid)\n{\n\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    //$grporder_sql = \"SELECT group_order FROM \".db_table_name('groups').\" WHERE sid =$surveyid AND language='{$s_lang}' AND gid=$gid\" ;\n    $grporder_result = QuestionGroup::model()->findByAttributes(array('sid' => $surveyid, 'gid' => $gid, 'language' => $s_lang)); //Checked\n    $grporder_row = $grporder_result->attributes ;\n    $group_order = $grporder_row['group_order'];\n    if($group_order==\"\")\n    {\n        return \"0\" ;\n    }\n    else return $group_order ;\n}\n\n/**\n* getMaxQuestionOrder($gid) queries the database for the maximum sortorder of a question.\n*\n*/\nfunction getMaxQuestionOrder($gid,$surveyid)\n{\n    $gid=sanitize_int($gid);\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $max_sql = \"SELECT max( question_order ) AS max FROM {{questions}} WHERE gid='$gid' AND language='$s_lang'\";\n\n    $max_result = Yii::app()->db->createCommand($max_sql)->query(); //Checked\n    $maxrow = $max_result->read() ;\n    $current_max = $maxrow['max'];\n    if($current_max==\"\")\n    {\n        return \"0\" ;\n    }\n    else return $current_max ;\n}\n\n/**\n* getQuestionClass() returns a class name for a given question type to allow custom styling for each question type.\n*\n* @param string $input containing unique character representing each question type.\n* @return string containing the class name for a given question type.\n*/\nfunction getQuestionClass($input)\n{\n\n    switch($input)\n    {   // I think this is a bad solution to adding classes to question\n        // DIVs but I can't think of a better solution. (eric_t_cruiser)\n\n        case 'X': return 'boilerplate';     //  BOILERPLATE QUESTION\n        case '5': return 'choice-5-pt-radio';   //  5 POINT CHOICE radio-buttons\n        case 'D': return 'date';        //  DATE\n        case 'Z': return 'list-radio-flexible'; //  LIST Flexible radio-button\n        case 'L': return 'list-radio';      //  LIST radio-button\n        case 'W': return 'list-dropdown-flexible'; //   LIST drop-down (flexible label)\n        case '!': return 'list-dropdown';   //  List - dropdown\n        case 'O': return 'list-with-comment';   //  LIST radio-button + textarea\n        case 'R': return 'ranking';     //  RANKING STYLE\n        case 'M': return 'multiple-opt';    //  Multiple choice checkbox\n        case 'I': return 'language';        //  Language Question\n        case 'P': return 'multiple-opt-comments'; //    Multiple choice with comments checkbox + text\n        case 'Q': return 'multiple-short-txt';  //  TEXT\n        case 'K': return 'numeric-multi';   //  MULTIPLE NUMERICAL QUESTION\n        case 'N': return 'numeric';     //  NUMERICAL QUESTION TYPE\n        case 'S': return 'text-short';      //  SHORT FREE TEXT\n        case 'T': return 'text-long';       //  LONG FREE TEXT\n        case 'U': return 'text-huge';       //  HUGE FREE TEXT\n        case 'Y': return 'yes-no';      //  YES/NO radio-buttons\n        case 'G': return 'gender';      //  GENDER drop-down list\n        case 'A': return 'array-5-pt';      //  ARRAY (5 POINT CHOICE) radio-buttons\n        case 'B': return 'array-10-pt';     //  ARRAY (10 POINT CHOICE) radio-buttons\n        case 'C': return 'array-yes-uncertain-no'; //   ARRAY (YES/UNCERTAIN/NO) radio-buttons\n        case 'E': return 'array-increase-same-decrease'; // ARRAY (Increase/Same/Decrease) radio-buttons\n        case 'F': return 'array-flexible-row';  //  ARRAY (Flexible) - Row Format\n        case 'H': return 'array-flexible-column'; //    ARRAY (Flexible) - Column Format\n            //      case '^': return 'slider';          //  SLIDER CONTROL\n        case ':': return 'array-multi-flexi';   //  ARRAY (Multi Flexi) 1 to 10\n        case \";\": return 'array-multi-flexi-text';\n        case \"1\": return 'array-flexible-duel-scale'; //    Array dual scale\n        case \"*\": return 'equation';    // Equation\n        default:  return 'generic_question';    //  Should have a default fallback\n    };\n};\n\n/**\n* setupColumns() defines all the html tags to be wrapped around\n* various list type answers.\n*\n* @param integer $columns - the number of columns, usually supplied by $dcols\n* @param integer $answer_count - the number of answers to a question, usually supplied by $anscount\n* @param string $wrapperclass - a global class for the wrapper\n* @param string $itemclass - a class for the item\n* @return array with all the various opening and closing tags to generate a set of columns.\n*\n* It returns an array with the following items:\n*    $wrapper['whole-start']   = Opening wrapper for the whole list\n*    $wrapper['whole-end']     = closing wrapper for the whole list\n*    $wrapper['col-devide']    = normal column devider\n*    $wrapper['col-devide-last'] = the last column devider (to allow\n*                                for different styling of the last\n*                                column\n*    $wrapper['item-start']    = opening wrapper tag for individual\n*                                option\n*    $wrapper['item-start-other'] = opening wrapper tag for other\n*                                option\n*    $wrapper['item-start-noanswer'] = opening wrapper tag for no answer\n*                                option\n*    $wrapper['item-end']      = closing wrapper tag for individual\n*                                option\n*    $wrapper['maxrows']       = maximum number of rows in each\n*                                column\n*    $wrapper['cols']          = Number of columns to be inserted\n*                                (and checked against)\n*\n*\n* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n* Columns are a problem.\n* Really there is no perfect solution to columns at the moment.\n*\n* -  Using Tables is problematic semanticly.\n* -  Using inline or float to create columns, causes the answers\n*    flows horizontally, not vertically which is not ideal visually.\n* -  Using CSS3 columns is also a problem because of browser support\n*    and also because if you have answeres split across two or more\n*    lines, and those answeres happen to fall at the bottom of a\n*    column, the answer might be split across columns as well as\n*    lines.\n* -  Using nested unordered list with the first level of <LI>s\n*    floated is the same as using tables and so is bad semantically\n*    for the same reason tables are bad.\n* -  Breaking the unordered lists into consecutive floated unordered\n*    lists is not great semantically but probably not as bad as\n*    using tables.\n*\n* Because I haven't been able to decide which option is the least\n* bad, I have handed over that responsibility to the admin who sets\n* LimeSurvey up on their server.\n*\n* There are four options:\n*    'css'   using one of the various CSS only methods for\n*            rendering columns.\n*            (Check the CSS file for your chosen template to see\n*             how columns are defined.)\n*    'ul'    using multiple floated unordered lists. (DEFAULT)\n*    'table' using conventional tables based layout.\n*     NULL   blocks the use of columns\n*\n* 'ul' is the default because it's the best possible compromise\n* between semantic markup and visual layout.\n*/\nfunction setupColumns($columns, $answer_count,$wrapperclass=\"\",$itemclass=\"\")\n{\n\n    $column_style = Yii::app()->getConfig('column_style');\n    if ( !in_array($column_style,array('css','ul','table')) && !is_null($column_style) )\n    {\n        $column_style = 'ul';\n    };\n    if(!is_null($column_style) && $columns!=1) // Add a global class for all column.\n    {\n        $wrapperclass.= \" colstyle-{$column_style}\";\n    }\n    if($columns < 2)\n    {\n        $column_style = null;\n        $columns = 1;\n    }\n\n    if(($columns > $answer_count) && $answer_count>0)\n    {\n        $columns = $answer_count;\n    };\n\n\n    $class_first = ' class=\"'.$wrapperclass.'\"';\n    if($columns > 1 && !is_null($column_style))\n    {\n        if($column_style == 'ul')\n        {\n            $ul = '-ul';\n        }\n        else\n        {\n            $ul = '';\n        }\n        $class_first = ' class=\"'.$wrapperclass.' cols-'.$columns . $ul.' first\"';\n        $class = ' class=\"'.$wrapperclass.' cols-'.$columns . $ul.'\"';\n        $class_last_ul = ' class=\"'.$wrapperclass.' cols-'.$columns . $ul.' last\"';\n        $class_last_table = ' class=\"'.$wrapperclass.' cols-'.$columns.' last\"';\n    }\n    else\n    {\n        $class = ' class=\"'.$wrapperclass.'\"';\n        $class_last_ul = ' class=\"'.$wrapperclass.'\"';\n        $class_last_table = ' class=\"'.$wrapperclass.'\"';\n    };\n\n    $wrapper = array(\n    'whole-start'  => \"\\n<ul$class_first>\\n\"\n    ,'whole-end'    => \"</ul>\\n\"\n    ,'col-devide'   => ''\n    ,'col-devide-last' => ''\n    ,'item-start'   => \"\\t<li class=\\\"{$itemclass}\\\">\\n\"\n    ,'item-start-other' => \"\\t<li class=\\\"{$itemclass} other other-item\\\">\\n\"\n    ,'item-start-noanswer' => \"\\t<li class=\\\"{$itemclass} noanswer-item\\\">\\n\"\n    ,'item-end' => \"\\t</li>\\n\"\n    ,'maxrows'  => ceil($answer_count/$columns) //Always rounds up to nearest whole number\n    ,'cols'     => $columns\n    );\n\n    switch($column_style)\n    {\n        case 'ul':  if($columns > 1)\n            {\n                $wrapper['col-devide']  = \"\\n</ul>\\n\\n<ul$class>\\n\";\n                $wrapper['col-devide-last'] = \"\\n</ul>\\n\\n<ul$class_last_ul>\\n\";\n            }\n            break;\n\n        case 'table':   $table_cols = '';\n            for($cols = $columns ; $cols > 0 ; --$cols)\n            {\n                switch($cols)\n                {\n                    case $columns:  $table_cols .= \"\\t<col$class_first />\\n\";\n                        break;\n                    case 1:     $table_cols .= \"\\t<col$class_last_table />\\n\";\n                        break;\n                    default:    $table_cols .= \"\\t<col$class />\\n\";\n                };\n            };\n\n            if($columns > 1)\n            {\n                $wrapper['col-devide']  = \"\\t</ul>\\n</td>\\n\\n<td>\\n\\t<ul>\\n\";\n                $wrapper['col-devide-last'] = \"\\t</ul>\\n</td>\\n\\n<td class=\\\"last\\\">\\n\\t<ul>\\n\";\n            };\n            $wrapper['whole-start'] = \"\\n<table$class>\\n$table_cols\\n\\t<tbody>\\n<tr>\\n<td>\\n\\t<ul>\\n\";\n            $wrapper['whole-end']   = \"\\t</ul>\\n</td>\\n</tr>\\n\\t</tbody>\\n</table>\\n\";\n            $wrapper['item-start']  = \"<li class=\\\"{$itemclass}\\\">\\n\";\n            $wrapper['item-end']    = \"</li class=\\\"{$itemclass}\\\">\\n\";\n    };\n\n    return $wrapper;\n};\n\nfunction alternation($alternate = '' , $type = 'col')\n{\n    /**\n    * alternation() Returns a class identifyer for alternating between\n    * two options. Used to style alternate elements differently. creates\n    * or alternates between the odd string and the even string used in\n    * as column and row classes for array type questions.\n    *\n    * @param string $alternate = '' (empty) (default) , 'array2' ,  'array1' , 'odd' , 'even'\n    * @param string  $type = 'col' (default) or 'row'\n    *\n    * @return string representing either the first alternation or the opposite alternation to the one supplied..\n    */\n    /*\n    // The following allows type to be left blank for row in subsequent\n    // function calls.\n    // It has been left out because 'row' must be defined the first time\n    // alternation() is called. Since it is only ever written once for each\n    // while statement within a function, 'row' is always defined.\n    if(!empty($alternate) && $type != 'row')\n    {   if($alternate == ('array2' || 'array1'))\n    {\n    $type = 'row';\n    };\n    };\n    // It has been left in case it becomes useful but probably should be\n    // removed.\n    */\n    if($type == 'row')\n    {\n        $odd  = 'array2'; // should be row_odd\n        $even = 'array1'; // should be row_even\n    }\n    else\n    {\n        $odd  = 'odd';  // should be col_odd\n        $even = 'even'; // should be col_even\n    };\n    if($alternate == $odd)\n    {\n        $alternate = $even;\n    }\n    else\n    {\n        $alternate = $odd;\n    };\n    return $alternate;\n}\n\n\n/**\n* longestString() returns the length of the longest string past to it.\n* @peram string $new_string\n* @peram integer $longest_length length of the (previously) longest string passed to it.\n* @return integer representing the length of the longest string passed (updated if $new_string was longer than $longest_length)\n*\n* usage should look like this: $longest_length = longestString( $new_string , $longest_length );\n*\n*/\nfunction longestString( $new_string , $longest_length )\n{\n    if($longest_length < strlen(trim(strip_tags($new_string))))\n    {\n        $longest_length = strlen(trim(strip_tags($new_string)));\n    };\n    return $longest_length;\n};\n\n\n\n/**\n* getNotificationList() returns different options for notifications\n*\n* @param string $notificationcode - the currently selected one\n*\n* @return This string is returned containing <option></option> formatted list of notification methods for current survey\n*/\nfunction getNotificationList($notificationcode)\n{\n    $clang = Yii::app()->lang;\n    $ntypes = array(\n    \"0\"=>$clang->gT(\"No email notification\"),\n    \"1\"=>$clang->gT(\"Basic email notification\"),\n    \"2\"=>$clang->gT(\"Detailed email notification with result codes\")\n    );\n    if (!isset($ntypeselector)) {$ntypeselector=\"\";}\n    foreach($ntypes as $ntcode=>$ntdescription)\n    {\n        $ntypeselector .= \"<option value='$ntcode'\";\n        if ($notificationcode == $ntcode) {$ntypeselector .= \" selected='selected'\";}\n        $ntypeselector .= \">$ntdescription</option>\\n\";\n    }\n    return $ntypeselector;\n}\n\n\n/**\n* getGroupList() queries the database for a list of all groups matching the current survey sid\n*\n*\n* @param string $gid - the currently selected gid/group\n*\n* @return This string is returned containing <option></option> formatted list of groups to current survey\n*/\nfunction getGroupList($gid,$surveyid)\n{\n    $clang = Yii::app()->lang;\n    $groupselecter=\"\";\n    $gid=sanitize_int($gid);\n    $surveyid=sanitize_int($surveyid);\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    $gidquery = \"SELECT gid, group_name FROM {{groups}} WHERE sid='{$surveyid}' AND  language='{$s_lang}' ORDER BY group_order\";\n    $gidresult = Yii::app()->db->createCommand($gidquery)->query(); //Checked\n    foreach ($gidresult->readAll() as $gv)\n    {\n        $groupselecter .= \"<option\";\n        if ($gv['gid'] == $gid) {$groupselecter .= \" selected='selected'\"; $gvexist = 1;}\n        $groupselecter .= \" value='\".Yii::app()->getConfig('scriptname').\"?sid=$surveyid&amp;gid=\".$gv['gid'].\"'>\".htmlspecialchars($gv['group_name']).\"</option>\\n\";\n    }\n    if ($groupselecter)\n    {\n        if (!isset($gvexist)) {$groupselecter = \"<option selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$groupselecter;}\n        else {$groupselecter .= \"<option value='\".Yii::app()->getConfig('scriptname').\"?sid=$surveyid&amp;gid='>\".$clang->gT(\"None\").\"</option>\\n\";}\n    }\n    return $groupselecter;\n}\n\n\n\nfunction getGroupList3($gid,$surveyid)\n{\n    //$clang = Yii::app()->lang;\n    $gid=sanitize_int($gid);\n    $surveyid=sanitize_int($surveyid);\n\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $groupselecter = \"\";\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n\n    //$gidquery = \"SELECT gid, group_name FROM \".db_table_name('groups').\" WHERE sid=$surveyid AND language='{$s_lang}' ORDER BY group_order\";\n\n    $gidresult = QuestionGroup::model()->findAllByAttributes(array('sid' => $surveyid, 'language' => $s_lang), array('order'=>'group_order'));\n\n    foreach ($gidresult as $gv)\n    {\n        $gv = $gv->attributes;\n        $groupselecter .= \"<option\";\n        if ($gv['gid'] == $gid) {$groupselecter .= \" selected='selected'\"; }\n        $groupselecter .= \" value='\".$gv['gid'].\"'>\".htmlspecialchars($gv['group_name']).\"</option>\\n\";\n    }\n\n\n    return $groupselecter;\n}\n\n/**\n* put your comment there...\n*\n* @param mixed $gid\n* @param mixed $language\n*/\nfunction getGroupListLang($gid, $language, $surveyid)\n{\n\n    $clang = Yii::app()->lang;\n\n    $groupselecter=\"\";\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n\n    $gidresult = QuestionGroup::model()->findAll(array('condition'=>'sid=:surveyid AND language=:language',\n    'order'=>'group_order',\n    'params'=>array(':surveyid'=>$surveyid,':language'=>$language)));   //Checked)\n    foreach ($gidresult as $gv)\n    {\n        $gv = $gv->attributes;\n        $groupselecter .= \"<option\";\n        if ($gv['gid'] == $gid) {$groupselecter .= \" selected='selected'\"; $gvexist = 1;}\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid.\"/gid/\".$gv['gid']);\n        $groupselecter .= \" value='{$link}'>\";\n        if (strip_tags($gv['group_name']))\n        {\n            $groupselecter .= htmlspecialchars(strip_tags($gv['group_name']));\n        } else {\n            $groupselecter .= htmlspecialchars($gv['group_name']);\n        }\n        $groupselecter .= \"</option>\\n\";\n    }\n    if ($groupselecter)\n    {\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid);\n        if (!isset($gvexist)) {$groupselecter = \"<option selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$groupselecter;}\n        else {$groupselecter .= \"<option value='{$link}'>\".$clang->gT(\"None\").\"</option>\\n\";}\n    }\n    return $groupselecter;\n}\n\n\nfunction getUserList($outputformat='fullinfoarray')\n{\n    $clang = Yii::app()->lang;\n\n    if (!empty(Yii::app()->session['loginID']))\n    {\n        $myuid=sanitize_int(Yii::app()->session['loginID']);\n    }\n    $usercontrolSameGroupPolicy = Yii::app()->getConfig('usercontrolSameGroupPolicy');\n    if (!Permission::model()->hasGlobalPermission('superadmin','read') && isset($usercontrolSameGroupPolicy) &&\n    $usercontrolSameGroupPolicy == true)\n    {\n        if (isset($myuid))\n        {\n            $sDatabaseType = Yii::app()->db->getDriverName();\n            if ($sDatabaseType=='mssql' || $sDatabaseType==\"sqlsrv\" || $sDatabaseType==\"dblib\")\n            {\n                $sSelectFields = 'users_name,uid,email,full_name,parent_id,CAST(password as varchar) as password';\n            }\n            else\n            {\n                $sSelectFields = 'users_name,uid,email,full_name,parent_id,password';\n            }\n\n            // List users from same group as me + all my childs\n            // a subselect is used here because MSSQL does not like to group by text\n            // also Postgres does like this one better\n            $uquery = \" SELECT {$sSelectFields} from {{users}} where uid in (\n                SELECT uid from {{user_in_groups}} where ugid in (\n                    SELECT ugid from {{user_in_groups}} where uid={$myuid}\n                    )\n                )\n            UNION\n            SELECT {$sSelectFields} from {{users}} v where v.parent_id={$myuid}\n            UNION\n            SELECT {$sSelectFields} from {{users}} v where uid={$myuid}\";\n\n        }\n        else\n        {\n            return array(); // Or die maybe\n        }\n\n    }\n    else\n    {\n        $uquery = \"SELECT * FROM {{users}} ORDER BY uid\";\n    }\n\n    $uresult = Yii::app()->db->createCommand($uquery)->query()->readAll(); //Checked\n\n    if (count($uresult)==0)\n    //user is not in a group and usercontrolSameGroupPolicy is activated - at least show his own userinfo\n    {\n        $uquery = \"SELECT u.* FROM {{users}} AS u WHERE u.uid=\".$myuid;\n        $uresult = Yii::app()->db->createCommand($uquery)->query()->readAll();//Checked\n    }\n\n    $userlist = array();\n    $userlist[0] = \"Reserved for logged in user\";\n    foreach ($uresult as $srow)\n    {\n        if ($outputformat != 'onlyuidarray')\n        {\n            if ($srow['uid'] != Yii::app()->session['loginID'])\n            {\n                $userlist[] = array(\"user\"=>$srow['users_name'], \"uid\"=>$srow['uid'], \"email\"=>$srow['email'], \"password\"=>$srow['password'], \"full_name\"=>$srow['full_name'], \"parent_id\"=>$srow['parent_id'] );\n            }\n            else\n            {\n                $userlist[0] = array(\"user\"=>$srow['users_name'], \"uid\"=>$srow['uid'], \"email\"=>$srow['email'], \"password\"=>$srow['password'], \"full_name\"=>$srow['full_name'], \"parent_id\"=>$srow['parent_id'] );\n            }\n        }\n        else\n        {\n            if ($srow['uid'] != Yii::app()->session['loginID'])\n            {\n                $userlist[] = $srow['uid'];\n            }\n            else\n            {\n                $userlist[0] = $srow['uid'];\n            }\n        }\n\n    }\n    return $userlist;\n}\n\n\n/**\n* Gets all survey infos in one big array including the language specific settings\n*\n* @param string $surveyid  The survey ID\n* @param string $languagecode The language code - if not given the base language of the particular survey is used\n* @return array Returns array with survey info or false, if survey does not exist\n*/\nfunction getSurveyInfo($surveyid, $languagecode='')\n{\n    static $staticSurveyInfo = array();// Use some static\n    $surveyid=sanitize_int($surveyid);\n    $languagecode=sanitize_languagecode($languagecode);\n    $thissurvey=false;\n    // Do job only if this survey exist\n    if(!Survey::model()->findByPk($surveyid))\n    {\n        return false;\n    }\n    // if no language code is set then get the base language one\n    if ((!isset($languagecode) || $languagecode==''))\n    {\n        $languagecode=Survey::model()->findByPk($surveyid)->language;\n    }\n\n    if(isset($staticSurveyInfo[$surveyid][$languagecode]) )\n    {\n        $thissurvey=$staticSurveyInfo[$surveyid][$languagecode];\n    }\n    else\n    {\n        $result = SurveyLanguageSetting::model()->with('survey')->findByPk(array('surveyls_survey_id' => $surveyid, 'surveyls_language' => $languagecode));\n        if (is_null($result)) {\n            // When additional language was added, but not saved it does not exists\n            // We should revert to the base language then\n            $languagecode=Survey::model()->findByPk($surveyid)->language;\n            $result = SurveyLanguageSetting::model()->with('survey')->findByPk(array('surveyls_survey_id' => $surveyid, 'surveyls_language' => $languagecode));\n        }\n        if($result)\n        {\n            $thissurvey=array_merge($result->survey->attributes,$result->attributes);\n            $thissurvey['name']=$thissurvey['surveyls_title'];\n            $thissurvey['description']=$thissurvey['surveyls_description'];\n            $thissurvey['welcome']=$thissurvey['surveyls_welcometext'];\n            $thissurvey['templatedir']=$thissurvey['template'];\n            $thissurvey['adminname']=$thissurvey['admin'];\n            $thissurvey['tablename']='{{survey_'.$thissurvey['sid'] . '}}';\n            $thissurvey['urldescrip']=$thissurvey['surveyls_urldescription'];\n            $thissurvey['url']=$thissurvey['surveyls_url'];\n            $thissurvey['expiry']=$thissurvey['expires'];\n            $thissurvey['email_invite_subj']=$thissurvey['surveyls_email_invite_subj'];\n            $thissurvey['email_invite']=$thissurvey['surveyls_email_invite'];\n            $thissurvey['email_remind_subj']=$thissurvey['surveyls_email_remind_subj'];\n            $thissurvey['email_remind']=$thissurvey['surveyls_email_remind'];\n            $thissurvey['email_confirm_subj']=$thissurvey['surveyls_email_confirm_subj'];\n            $thissurvey['email_confirm']=$thissurvey['surveyls_email_confirm'];\n            $thissurvey['email_register_subj']=$thissurvey['surveyls_email_register_subj'];\n            $thissurvey['email_register']=$thissurvey['surveyls_email_register'];\n            $thissurvey['attributedescriptions'] = $result->survey->tokenAttributes;\n            $thissurvey['attributecaptions'] = $result->attributeCaptions;\n            if (!isset($thissurvey['adminname'])) {$thissurvey['adminname']=Yii::app()->getConfig('siteadminemail');}\n            if (!isset($thissurvey['adminemail'])) {$thissurvey['adminemail']=Yii::app()->getConfig('siteadminname');}\n            if (!isset($thissurvey['urldescrip']) || $thissurvey['urldescrip'] == '' ) {$thissurvey['urldescrip']=$thissurvey['surveyls_url'];}\n\n            $staticSurveyInfo[$surveyid][$languagecode]=$thissurvey;\n        }\n\n    }\n\n    return $thissurvey;\n}\n\n/**\n* Returns the default email template texts as array\n*\n* @param mixed $oLanguage Required language translationb object\n* @param string $mode Escape mode for the translation function\n* @return array\n*/\nfunction templateDefaultTexts($oLanguage, $mode='html', $sNewlines='text'){\n    $aDefaultTexts=array(\n    'admin_detailed_notification_subject'=>$oLanguage->gT(\"Response submission for survey {SURVEYNAME} with results\",$mode),\n    'admin_detailed_notification'=>$oLanguage->gT(\"Hello,\\n\\nA new response was submitted for your survey '{SURVEYNAME}'.\\n\\nClick the following link to reload the survey:\\n{RELOADURL}\\n\\nClick the following link to see the individual response:\\n{VIEWRESPONSEURL}\\n\\nClick the following link to edit the individual response:\\n{EDITRESPONSEURL}\\n\\nView statistics by clicking here:\\n{STATISTICSURL}\\n\\n\\nThe following answers were given by the participant:\\n{ANSWERTABLE}\",$mode),\n    'admin_detailed_notification_css'=>'<style type=\"text/css\">\n    .printouttable {\n    margin:1em auto;\n    }\n    .printouttable th {\n    text-align: center;\n    }\n    .printouttable td {\n    border-color: #ddf #ddf #ddf #ddf;\n    border-style: solid;\n    border-width: 1px;\n    padding:0.1em 1em 0.1em 0.5em;\n    }\n\n    .printouttable td:first-child {\n    font-weight: 700;\n    text-align: right;\n    padding-right: 5px;\n    padding-left: 5px;\n\n    }\n    .printouttable .printanswersquestion td{\n    background-color:#F7F8FF;\n    }\n\n    .printouttable .printanswersquestionhead td{\n    text-align: left;\n    background-color:#ddf;\n    }\n\n    .printouttable .printanswersgroup td{\n    text-align: center;\n    font-weight:bold;\n    padding-top:1em;\n    }\n    </style>',\n    'admin_notification_subject'=>$oLanguage->gT(\"Response submission for survey {SURVEYNAME}\",$mode),\n    'admin_notification'=>$oLanguage->gT(\"Hello,\\n\\nA new response was submitted for your survey '{SURVEYNAME}'.\\n\\nClick the following link to reload the survey:\\n{RELOADURL}\\n\\nClick the following link to see the individual response:\\n{VIEWRESPONSEURL}\\n\\nClick the following link to edit the individual response:\\n{EDITRESPONSEURL}\\n\\nView statistics by clicking here:\\n{STATISTICSURL}\",$mode),\n    'confirmation_subject'=>$oLanguage->gT(\"Confirmation of your participation in our survey\"),\n    'confirmation'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nthis email is to confirm that you have completed the survey titled {SURVEYNAME} and your response has been saved. Thank you for participating.\\n\\nIf you have any further questions about this email, please contact {ADMINNAME} on {ADMINEMAIL}.\\n\\nSincerely,\\n\\n{ADMINNAME}\",$mode),\n    'invitation_subject'=>$oLanguage->gT(\"Invitation to participate in a survey\",$mode),\n    'invitation'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nyou have been invited to participate in a survey.\\n\\nThe survey is titled:\\n\\\"{SURVEYNAME}\\\"\\n\\n\\\"{SURVEYDESCRIPTION}\\\"\\n\\nTo participate, please click on the link below.\\n\\nSincerely,\\n\\n{ADMINNAME} ({ADMINEMAIL})\\n\\n----------------------------------------------\\nClick here to do the survey:\\n{SURVEYURL}\",$mode).\"\\n\\n\".$oLanguage->gT(\"If you do not want to participate in this survey and don't want to receive any more invitations please click the following link:\\n{OPTOUTURL}\",$mode).\"\\n\\n\".$oLanguage->gT(\"If you are blacklisted but want to participate in this survey and want to receive invitations please click the following link:\\n{OPTINURL}\",$mode),\n    'reminder_subject'=>$oLanguage->gT(\"Reminder to participate in a survey\",$mode),\n    'reminder'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nRecently we invited you to participate in a survey.\\n\\nWe note that you have not yet completed the survey, and wish to remind you that the survey is still available should you wish to take part.\\n\\nThe survey is titled:\\n\\\"{SURVEYNAME}\\\"\\n\\n\\\"{SURVEYDESCRIPTION}\\\"\\n\\nTo participate, please click on the link below.\\n\\nSincerely,\\n\\n{ADMINNAME} ({ADMINEMAIL})\\n\\n----------------------------------------------\\nClick here to do the survey:\\n{SURVEYURL}\",$mode).\"\\n\\n\".$oLanguage->gT(\"If you do not want to participate in this survey and don't want to receive any more invitations please click the following link:\\n{OPTOUTURL}\",$mode),\n    'registration_subject'=>$oLanguage->gT(\"Survey registration confirmation\",$mode),\n    'registration'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nYou, or someone using your email address, have registered to participate in an online survey titled {SURVEYNAME}.\\n\\nTo complete this survey, click on the following URL:\\n\\n{SURVEYURL}\\n\\nIf you have any questions about this survey, or if you did not register to participate and believe this email is in error, please contact {ADMINNAME} at {ADMINEMAIL}.\",$mode)\n    );\n    if ($sNewlines=='html')\n    {\n        $aDefaultTexts=array_map('nl2br',$aDefaultTexts);\n    }\n    return $aDefaultTexts;\n}\n\n/**\n* Compares two elements from an array (passed by the usort function)\n* and returns -1, 0 or 1 depending on the result of the comparison of\n* the sort order of the group_order and question_order field\n*\n* @param mixed $a\n* @param mixed $b\n* @return int\n*/\nfunction groupOrderThenQuestionOrder($a, $b)\n{\n    if (isset($a['group_order']) && isset($b['group_order']))\n    {\n        $GroupResult = strnatcasecmp($a['group_order'], $b['group_order']);\n    }\n    else\n    {\n        $GroupResult = \"\";\n    }\n    if ($GroupResult == 0)\n    {\n        $TitleResult = strnatcasecmp($a[\"question_order\"], $b[\"question_order\"]);\n        return $TitleResult;\n    }\n    return $GroupResult;\n}\n\n\nfunction fixSortOrderAnswers($qid,$surveyid=null) //Function rewrites the sortorder for a group of answers\n{\n    $qid=sanitize_int($qid);\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n\n    Answer::model()->updateSortOrder($qid,$baselang);\n}\n\n/**\n* This function rewrites the sortorder for questions inside the named group\n* REMOVED the 2012-08-08 : replaced by Question::model()->updateQuestionOrder\n* @param integer $groupid the group id\n* @param integer $surveyid the survey id\n*/\n/**\nfunction fixSortOrderQuestions($groupid, $surveyid) //Function rewrites the sortorder for questions\n{\n    $gid = sanitize_int($groupid);\n    $surveyid = sanitize_int($surveyid);\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n\n    $questions = Question::model()->findAllByAttributes(array('gid' => $gid, 'sid' => $surveyid, 'language' => $baselang));\n    $p = 0;\n    foreach ($questions as $question)\n    {\n        $question->question_order = $p;\n        $question->save();\n        $p++;\n    }\n}\n*/\n\nfunction shiftOrderQuestions($sid,$gid,$shiftvalue) //Function shifts the sortorder for questions\n{\n    $sid=sanitize_int($sid);\n    $gid=sanitize_int($gid);\n    $shiftvalue=sanitize_int($shiftvalue);\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n\n    Question::model()->updateQuestionOrder($gid,$baselang,$shiftvalue);\n}\n\nfunction fixSortOrderGroups($surveyid) //Function rewrites the sortorder for groups\n{\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    QuestionGroup::model()->updateGroupOrder($surveyid,$baselang);\n}\n\nfunction fixMovedQuestionConditions($qid,$oldgid,$newgid) //Function rewrites the cfieldname for a question after group change\n{\n    $surveyid = Yii::app()->getConfig('sid');\n    $qid=sanitize_int($qid);\n    $oldgid=sanitize_int($oldgid);\n    $newgid=sanitize_int($newgid);\n    Condition::model()->updateCFieldName($surveyid,$qid,$oldgid,$newgid);\n    // TMSW Condition->Relevance:  Call LEM->ConvertConditionsToRelevance() when done\n}\n\n\n/**\n* This function returns POST/REQUEST vars, for some vars like SID and others they are also sanitized\n*\n* @param string $stringname\n* @param boolean $bRestrictToString\n*/\nfunction returnGlobal($stringname,$bRestrictToString=false)\n{\n    $urlParam=Yii::app()->request->getParam($stringname); \n    if(is_null($urlParam) && $aCookies=Yii::app()->request->getCookies() && $stringname!='sid')\n    {\n        if(isset($aCookies[$stringname]))\n        {\n            $urlParam = $aCookies[$stringname];\n        } \n    }\n    $bUrlParamIsArray=is_array($urlParam);// Needed to array map or if $bRestrictToString\n    if (!is_null($urlParam) && $stringname!='' && (!$bUrlParamIsArray || !$bRestrictToString))\n    {\n        if ($stringname == 'sid' || $stringname == \"gid\" || $stringname == \"oldqid\" ||\n        $stringname == \"qid\" || $stringname == \"tid\" ||\n        $stringname == \"lid\" || $stringname == \"ugid\"||\n        $stringname == \"thisstep\" || $stringname == \"scenario\" ||\n        $stringname == \"cqid\" || $stringname == \"cid\" ||\n        $stringname == \"qaid\" || $stringname == \"scid\" ||\n        $stringname == \"loadsecurity\")\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_int\",$urlParam);\n            }else{\n                return sanitize_int($urlParam);\n            }\n        }\n        elseif ($stringname ==\"lang\" || $stringname ==\"adminlang\")\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_languagecode\",$urlParam);\n            }else{\n                return sanitize_languagecode($urlParam);\n            }\n        }\n        elseif ($stringname ==\"htmleditormode\" ||\n        $stringname ==\"subaction\" ||\n        $stringname ==\"questionselectormode\" ||\n        $stringname ==\"templateeditormode\"\n        )\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_paranoid_string\",$urlParam);\n            }else{\n                return sanitize_paranoid_string($urlParam);\n            }\n        }\n        elseif ( $stringname ==\"cquestions\")\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_cquestions\",$urlParam);\n            }else{\n                return sanitize_cquestions($urlParam);\n            }\n        }\n        return $urlParam;\n    }\n    else\n    {\n        return NULL;\n    }\n}\n\n\nfunction sendCacheHeaders()\n{\n    global $embedded;\n    if ( $embedded ) return;\n    if (!headers_sent())\n    {\n        header('P3P:CP=\"IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT\"');  // this line lets IE7 run LimeSurvey in an iframe\n        header(\"Expires: Mon, 26 Jul 1997 05:00:00 GMT\");    // Date in the past\n        header(\"Last-Modified: \" . gmdate(\"D, d M Y H:i:s\") . \" GMT\");  // always modified\n        header(\"Cache-Control: no-store, no-cache, must-revalidate\");  // HTTP/1.1\n        header(\"Cache-Control: post-check=0, pre-check=0\", false);\n        header(\"Pragma: no-cache\");\n        header('Content-Type: text/html; charset=utf-8');\n    }\n}\n\n/**\n* @param type $iSurveyID The Survey ID\n* @param type $sFieldCode Field code of the particular field\n* @param type $sValue The stored response value\n* @param object $oLanguage Initialized limesurvey_lang object for the resulting response data\n* @return string\n*/\nfunction getExtendedAnswer($iSurveyID, $sFieldCode, $sValue, $oLanguage)\n{\n    if ($sValue==null || $sValue=='') return '';\n    $sLanguage = $oLanguage->langcode;\n    //Fieldcode used to determine question, $sValue used to match against answer code\n    //Returns NULL if question type does not suit\n    if (strpos($sFieldCode, \"{$iSurveyID}X\")===0) //Only check if it looks like a real fieldcode\n    {\n        $fieldmap = createFieldMap($iSurveyID,'short',false,false,$sLanguage);\n        if (isset($fieldmap[$sFieldCode]))\n            $fields = $fieldmap[$sFieldCode];\n        else\n            return false;\n\n        // If it is a comment field there is nothing to convert here\n        if ($fields['aid']=='comment') return $sValue; \n            \n        //Find out the question type\n        $this_type = $fields['type'];\n        switch($this_type)\n        {\n            case 'D':\n                if (trim($sValue)!='')\n                {\n                    $qidattributes = getQuestionAttributeValues($fields['qid']);\n                    $dateformatdetails = getDateFormatDataForQID($qidattributes, $iSurveyID);\n                    $sValue=convertDateTimeFormat($sValue,\"Y-m-d H:i:s\",$dateformatdetails['phpdate']);\n                }\n                break;\n            case 'N':\n                if (trim($sValue)!='')\n                {\n                    if(strpos($sValue,\".\")!==false)\n                    {\n                        $sValue=rtrim(rtrim($sValue,\"0\"),\".\");\n                    }\n                    $qidattributes = getQuestionAttributeValues($fields['qid']);\n                    if($qidattributes['num_value_int_only'])\n                    {\n                        $sValue=number_format($sValue, 0, '', '');\n                    }\n                }\n                break;\n            case \"L\":\n            case \"!\":\n            case \"O\":\n            case \"^\":\n            case \"I\":\n            case \"R\":\n                $result = Answer::model()->getAnswerFromCode($fields['qid'],$sValue,$sLanguage);\n                foreach($result as $row)\n                {\n                    $this_answer=$row['answer'];\n                } // while\n                if ($sValue == \"-oth-\")\n                {\n                    $this_answer=$oLanguage->gT(\"Other\");\n                }\n                break;\n            case \"M\":\n            case \"J\":\n            case \"P\":\n            switch($sValue)\n            {\n                case \"Y\": $this_answer=$oLanguage->gT(\"Yes\"); break;\n            }\n            break;\n            case \"Y\":\n            switch($sValue)\n            {\n                case \"Y\": $this_answer=$oLanguage->gT(\"Yes\"); break;\n                case \"N\": $this_answer=$oLanguage->gT(\"No\"); break;\n                default: $this_answer=$oLanguage->gT(\"No answer\");\n            }\n            break;\n            case \"G\":\n            switch($sValue)\n            {\n                case \"M\": $this_answer=$oLanguage->gT(\"Male\"); break;\n                case \"F\": $this_answer=$oLanguage->gT(\"Female\"); break;\n                default: $this_answer=$oLanguage->gT(\"No answer\");\n            }\n            break;\n            case \"C\":\n            switch($sValue)\n            {\n                case \"Y\": $this_answer=$oLanguage->gT(\"Yes\"); break;\n                case \"N\": $this_answer=$oLanguage->gT(\"No\"); break;\n                case \"U\": $this_answer=$oLanguage->gT(\"Uncertain\"); break;\n            }\n            break;\n            case \"E\":\n            switch($sValue)\n            {\n                case \"I\": $this_answer=$oLanguage->gT(\"Increase\"); break;\n                case \"D\": $this_answer=$oLanguage->gT(\"Decrease\"); break;\n                case \"S\": $this_answer=$oLanguage->gT(\"Same\"); break;\n            }\n            break;\n            case \"F\":\n            case \"H\":\n            case \"1\":\n                $aConditions=array('qid' => $fields['qid'], 'code' => $sValue, 'language' => $sLanguage);\n                if (isset($fields['scale_id']))\n                {\n                    $iScaleID=$fields['scale_id'];\n                }\n                else\n                {\n                    $iScaleID=0;\n                }\n                $result = Answer::model()->getAnswerFromCode($fields['qid'],$sValue,$sLanguage,$iScaleID);\n                foreach($result as $row)\n                {\n                    $this_answer=$row['answer'];\n                } // while\n                if ($sValue == \"-oth-\")\n                {\n                    $this_answer=$oLanguage->gT(\"Other\");\n                }\n                break;\n            case \"|\": //File upload\n                if (substr($sFieldCode, -9) != 'filecount') {\n                    //Show the filename, size, title and comment -- no link!\n                    $files = json_decode($sValue);\n                    $sValue = '';\n                    if (is_array($files)) {\n                        foreach ($files as $file) {\n                            $sValue .= $file->name .\n                            ' (' . $file->size . 'KB) ' .\n                            strip_tags($file->title) .\n                            ' - ' . strip_tags($file->comment) . \"<br/>\";\n                        }\n                    }\n                }\n                break;\n            default:\n                ;\n        } // switch\n    }\n    switch($sFieldCode)\n    {\n        case 'submitdate':\n        case 'startdate':\n        case 'datestamp':\n            if (trim($sValue)!='')\n            {\n                $dateformatdetails = getDateFormatDataForQID(null, $iSurveyID);\n                $sValue=convertDateTimeFormat($sValue,\"Y-m-d H:i:s\",$dateformatdetails['phpdate'].' H:i:s');\n            }\n            break;\n    }\n    if (isset($this_answer))\n    {\n        return $this_answer.\" [$sValue]\";\n    }\n    else\n    {\n        return $sValue;\n    }\n}\n\n/**\n* Validate an email address - also supports IDN email addresses \n* @returns True/false for valid/invalid\n* \n* @param mixed $sEmailAddress  Email address to check\n*/\nfunction validateEmailAddress($sEmailAddress){\n    require_once(APPPATH.'third_party/idna-convert/idna_convert.class.php');\n    $oIdnConverter = new idna_convert();\n    $sEmailAddress=$oIdnConverter->encode($sEmailAddress);\n    $bResult=filter_var($sEmailAddress, FILTER_VALIDATE_EMAIL);   \n    if ($bResult!==false)\n    {\n        return true;\n    }\n    return false;\n}\n\nfunction validateTemplateDir($sTemplateName)\n{\n    $usertemplaterootdir = Yii::app()->getConfig('usertemplaterootdir');\n    $standardtemplaterootdir = Yii::app()->getConfig('standardtemplaterootdir');\n    $sDefaultTemplate = Yii::app()->getConfig('defaulttemplate');\n    if (is_dir(\"$usertemplaterootdir/{$sTemplateName}/\"))\n    {\n        return $sTemplateName;\n    }\n    elseif (is_dir(\"$standardtemplaterootdir/{$sTemplateName}/\"))\n    {\n        return $sTemplateName;\n    }\n    elseif (is_dir(\"$standardtemplaterootdir/{$sDefaultTemplate}/\"))\n    {\n        return $sDefaultTemplate;\n    }\n    elseif (is_dir(\"$usertemplaterootdir/{$sDefaultTemplate}/\"))\n    {\n        return $sDefaultTemplate;\n    }\n    else\n    {\n        return 'default';\n    }\n}\n\n\n\n/**\n *This functions generates a a summary containing the SGQA for questions of a survey, enriched with options per question\n * It can be used for the generation of statistics. Derived from Statistics_userController\n * @param int $iSurveyID Id of the Survey in question\n * @param array $aFilters an array which is the result of a query in Questions model\n * @param string $sLanguage\n * @return array The summary\n */\n  function createCompleteSGQA($iSurveyID,$aFilters,$sLanguage) {\n\n foreach ($aFilters as $flt)\n {\n    Yii::app()->loadHelper(\"surveytranslator\");\n    $myfield = \"{$iSurveyID}X{$flt['gid']}X{$flt['qid']}\";\n    $oSurvey = Survey::model()->findByPk($iSurveyID);\n    $aAdditionalLanguages = array_filter(explode(\" \", $oSurvey->additional_languages));\n    if (is_null($sLanguage)|| !in_array($sLanguage,$aAdditionalLanguages))\n        $sLanguage = $oSurvey->language;\n\n    switch ($flt['type'])\n            {\n                case \"K\": // Multiple Numerical\n                case \"Q\": // Multiple Short Text\n                    //get answers\n                    $result = Question::model()->getQuestionsForStatistics('title as code, question as answer', \"parent_qid=$flt[qid] AND language = '{$sLanguage}'\", 'question_order');\n\n                    //go through all the (multiple) answers\n                    foreach($result as $row)\n                    {\n                        $myfield2=$flt['type'].$myfield.reset($row);\n                        $allfields[] = $myfield2;\n                    }\n                    break;\n                case \"A\": // ARRAY OF 5 POINT CHOICE QUESTIONS\n                case \"B\": // ARRAY OF 10 POINT CHOICE QUESTIONS\n                case \"C\": // ARRAY OF YES\\No\\$clang->gT(\"Uncertain\") QUESTIONS\n                case \"E\": // ARRAY OF Increase/Same/Decrease QUESTIONS\n                case \"F\": // FlEXIBLE ARRAY\n                case \"H\": // ARRAY (By Column)\n                    //get answers\n                    $result = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}'\", 'question_order');\n\n                    //go through all the (multiple) answers\n                    foreach($result as $row)\n                    {\n                        $myfield2 = $myfield.reset($row);\n                        $allfields[]=$myfield2;\n                    }\n                    break;\n                // all \"free text\" types (T, U, S)  get the same prefix (\"T\")\n                case \"T\": // Long free text\n                case \"U\": // Huge free text\n                case \"S\": // Short free text\n                    $myfield=\"T$myfield\";\n                    $allfields[] = $myfield;\n                    break;\n                case \";\":  //ARRAY (Multi Flex) (Text)\n                case \":\":  //ARRAY (Multi Flex) (Numbers)\n                    $result = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}' AND scale_id = 0\", 'question_order');\n                   \n                    foreach($result as $row)\n                    {\n                        $fresult = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}' AND scale_id = 1\", 'question_order');\n                        foreach($fresult as $frow)\n                        {\n                            $myfield2 = $myfield . reset($row) . \"_\" . $frow['title'];\n                        $allfields[]=$myfield2;\n                    }\n                    }\n                    break;\n                case \"R\": //RANKING\n                    //get some answers\n                    $result = Answer::model()->getQuestionsForStatistics('code, answer', \"qid=$flt[qid] AND language = '{$sLanguage}'\", 'sortorder, answer');\n                    //get number of answers\n                    //loop through all answers. if there are 3 items to rate there will be 3 statistics\n                    $i=0;\n                    foreach($result as $row)\n                    {\n                        $i++;\n                        $myfield2 = \"R\" . $myfield . $i . \"-\" . strlen($i);\n                        $allfields[]=$myfield2;\n                    }\n\n                    break;\n                //Boilerplate questions are only used to put some text between other questions -> no analysis needed\n                case \"X\":  //This is a boilerplate question and it has no business in this script\n                    break;\n                case \"1\": // MULTI SCALE\n                    //get answers\n                    $result = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}'\", 'question_order');\n                    //loop through answers\n                    foreach($result as $row)\n                    {\n                        //----------------- LABEL 1 ---------------------\n                        $myfield2 = $myfield . reset($row).\"#0\";\n                        $allfields[]=$myfield2;\n                        //----------------- LABEL 2 ---------------------\n                        $myfield2 = $myfield . reset($row).\"#1\";\n                        $allfields[]=$myfield2;\n                    }   //end WHILE -> loop through all answers\n                    break;\n\n                case \"P\":  //P - Multiple choice with comments\n                case \"M\":  //M - Multiple choice\n                case \"N\":  //N - Numerical input\n                case \"D\":  //D - Date\n                    $myfield2 = $flt['type'].$myfield;\n                            $allfields[]=$myfield2;\n                    break;\n                default:   //Default settings\n                    $allfields[] = $myfield;\n                    break;\n\n        } //end switch\n }\n\nreturn $allfields;\n\n}\n\n\n\n\n\n/**\n* This function generates an array containing the fieldcode, and matching data in the same order as the activate script\n*\n* @param string $surveyid The Survey ID\n* @param mixed $style 'short' (default) or 'full' - full creates extra information like default values\n* @param mixed $force_refresh - Forces to really refresh the array, not just take the session copy\n* @param int $questionid Limit to a certain qid only (for question preview) - default is false\n* @param string $sQuestionLanguage The language to use\n* @return array\n*/\nfunction createFieldMap($surveyid, $style='short', $force_refresh=false, $questionid=false, $sLanguage) {\n    global $aDuplicateQIDs;\n\n    $sLanguage = sanitize_languagecode($sLanguage);\n    $surveyid = sanitize_int($surveyid);\n\n    //checks to see if fieldmap has already been built for this page.\n    if (isset(Yii::app()->session['fieldmap-' . $surveyid . $sLanguage]) && !$force_refresh && $questionid == false) {\n        return Yii::app()->session['fieldmap-' . $surveyid . $sLanguage];\n    }\n\n    $clang = new Limesurvey_lang($sLanguage);\n    $fieldmap[\"id\"]=array(\"fieldname\"=>\"id\", 'sid'=>$surveyid, 'type'=>\"id\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"id\"]['title']=\"\";\n        $fieldmap[\"id\"]['question']=$clang->gT(\"Response ID\");\n        $fieldmap[\"id\"]['group_name']=\"\";\n    }\n\n    $fieldmap[\"submitdate\"]=array(\"fieldname\"=>\"submitdate\", 'type'=>\"submitdate\", 'sid'=>$surveyid, \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"submitdate\"]['title']=\"\";\n        $fieldmap[\"submitdate\"]['question']=$clang->gT(\"Date submitted\");\n        $fieldmap[\"submitdate\"]['group_name']=\"\";\n    }\n\n    $fieldmap[\"lastpage\"]=array(\"fieldname\"=>\"lastpage\", 'sid'=>$surveyid, 'type'=>\"lastpage\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"lastpage\"]['title']=\"\";\n        $fieldmap[\"lastpage\"]['question']=$clang->gT(\"Last page\");\n        $fieldmap[\"lastpage\"]['group_name']=\"\";\n    }\n\n    $fieldmap[\"startlanguage\"]=array(\"fieldname\"=>\"startlanguage\", 'sid'=>$surveyid, 'type'=>\"startlanguage\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"startlanguage\"]['title']=\"\";\n        $fieldmap[\"startlanguage\"]['question']=$clang->gT(\"Start language\");\n        $fieldmap[\"startlanguage\"]['group_name']=\"\";\n    }\n\n    // Select which question IDs have default values\n    $_aDefaultValues = DefaultValue::model()->with(array('question' => array('condition' => 'question.sid=' . $surveyid)))->findAll();\n    $aDefaultValues = array();\n    foreach ($_aDefaultValues as $k => $v)\n        $aDefaultValues[] = $v->qid;\n\n    //Check for any additional fields for this survey and create necessary fields (token and datestamp and ipaddr)\n    $prow = Survey::model()->findByPk($surveyid)->getAttributes(); //Checked\n\n    if ($prow['anonymized'] == \"N\" && Survey::model()->hasTokens($surveyid)) {\n        $fieldmap[\"token\"]=array(\"fieldname\"=>\"token\", 'sid'=>$surveyid, 'type'=>\"token\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"token\"]['title']=\"\";\n            $fieldmap[\"token\"]['question']=$clang->gT(\"Token\");\n            $fieldmap[\"token\"]['group_name']=\"\";\n        }\n    }\n    if ($prow['datestamp'] == \"Y\")\n    {\n        $fieldmap[\"startdate\"]=array(\"fieldname\"=>\"startdate\",\n        'type'=>\"startdate\",\n        'sid'=>$surveyid,\n        \"gid\"=>\"\",\n        \"qid\"=>\"\",\n        \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"startdate\"]['title']=\"\";\n            $fieldmap[\"startdate\"]['question']=$clang->gT(\"Date started\");\n            $fieldmap[\"startdate\"]['group_name']=\"\";\n        }\n\n        $fieldmap[\"datestamp\"]=array(\"fieldname\"=>\"datestamp\",\n        'type'=>\"datestamp\",\n        'sid'=>$surveyid,\n        \"gid\"=>\"\",\n        \"qid\"=>\"\",\n        \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"datestamp\"]['title']=\"\";\n            $fieldmap[\"datestamp\"]['question']=$clang->gT(\"Date last action\");\n            $fieldmap[\"datestamp\"]['group_name']=\"\";\n        }\n\n    }\n    if ($prow['ipaddr'] == \"Y\")\n    {\n        $fieldmap[\"ipaddr\"]=array(\"fieldname\"=>\"ipaddr\",\n        'type'=>\"ipaddress\",\n        'sid'=>$surveyid,\n        \"gid\"=>\"\",\n        \"qid\"=>\"\",\n        \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"ipaddr\"]['title']=\"\";\n            $fieldmap[\"ipaddr\"]['question']=$clang->gT(\"IP address\");\n            $fieldmap[\"ipaddr\"]['group_name']=\"\";\n        }\n    }\n    // Add 'refurl' to fieldmap.\n    if ($prow['refurl'] == \"Y\")\n    {\n        $fieldmap[\"refurl\"]=array(\"fieldname\"=>\"refurl\", 'type'=>\"url\", 'sid'=>$surveyid, \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"refurl\"]['title']=\"\";\n            $fieldmap[\"refurl\"]['question']=$clang->gT(\"Referrer URL\");\n            $fieldmap[\"refurl\"]['group_name']=\"\";\n        }\n    }\n\n    // Collect all default values once so don't need separate query for each question with defaults\n    // First collect language specific defaults\n    $defaultsQuery = \"SELECT a.qid, a.sqid, a.scale_id, a.specialtype, a.defaultvalue\"\n    . \" FROM {{defaultvalues}} as a, {{questions}} as b\"\n    . \" WHERE a.qid = b.qid\"\n    . \" AND a.language = b.language\"\n    . \" AND a.language = '{$sLanguage}'\"\n    . \" AND b.same_default=0\"\n    . \" AND b.sid = \".$surveyid;\n    $defaultResults = Yii::app()->db->createCommand($defaultsQuery)->queryAll();\n\n    $defaultValues = array();   // indexed by question then subquestion\n    foreach($defaultResults as $dv)\n    {\n        if ($dv['specialtype'] != '') {\n            $sq = $dv['specialtype'];\n        }\n        else {\n            $sq = $dv['sqid'];\n        }\n        $defaultValues[$dv['qid'].'~'.$sq] = $dv['defaultvalue'];\n    }\n\n    // Now overwrite language-specific defaults (if any) base language values for each question that uses same_defaults=1\n    $baseLanguage = getBaseLanguageFromSurveyID($surveyid);\n    $defaultsQuery = \"SELECT a.qid, a.sqid, a.scale_id, a.specialtype, a.defaultvalue\"\n    . \" FROM {{defaultvalues}} as a, {{questions}} as b\"\n    . \" WHERE a.qid = b.qid\"\n    . \" AND a.language = b.language\"\n    . \" AND a.language = '{$baseLanguage}'\"\n    . \" AND b.same_default=1\"\n    . \" AND b.sid = \".$surveyid;\n    $defaultResults = Yii::app()->db->createCommand($defaultsQuery)->queryAll();\n\n    foreach($defaultResults as $dv)\n    {\n        if ($dv['specialtype'] != '') {\n            $sq = $dv['specialtype'];\n        }\n        else {\n            $sq = $dv['sqid'];\n        }\n        $defaultValues[$dv['qid'].'~'.$sq] = $dv['defaultvalue'];\n    }\n    $qtypes=getQuestionTypeList('','array');\n\n    $aquery = \"SELECT * \"\n    .\" FROM {{questions}} as questions, {{groups}} as groups\"\n    .\" WHERE questions.gid=groups.gid AND \"\n    .\" questions.sid=$surveyid AND \"\n    .\" questions.language='{$sLanguage}' AND \"\n    .\" questions.parent_qid=0 AND \"\n    .\" groups.language='{$sLanguage}' \";\n    if ($questionid!==false)\n    {\n        $aquery.=\" and questions.qid={$questionid} \";\n    }\n    $aquery.=\" ORDER BY group_order, question_order\";\n    $aresult = Yii::app()->db->createCommand($aquery)->queryAll();\n    $questionSeq=-1; // this is incremental question sequence across all groups\n    $groupSeq=-1;\n    $_groupOrder=-1;\n\n    foreach ($aresult as $arow) //With each question, create the appropriate field(s))\n    {\n        ++$questionSeq;\n\n        // fix fact taht group_order may have gaps\n        if ($_groupOrder != $arow['group_order']) {\n            $_groupOrder = $arow['group_order'];\n            ++$groupSeq;\n        }\n        // Condition indicators are obsolete with EM.  However, they are so tightly coupled into LS code that easider to just set values to 'N' for now and refactor later.\n        $conditions = 'N';\n        $usedinconditions = 'N';\n\n        // Field identifier\n        // GXQXSXA\n        // G=Group  Q=Question S=Subquestion A=Answer Option\n        // If S or A don't exist then set it to 0\n        // Implicit (subqestion intermal to a question type ) or explicit qubquestions/answer count starts at 1\n\n        // Types \"L\", \"!\", \"O\", \"D\", \"G\", \"N\", \"X\", \"Y\", \"5\", \"S\", \"T\", \"U\"\n        $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}\";\n\n        if ($qtypes[$arow['type']]['subquestions']==0  && $arow['type'] != \"R\" && $arow['type'] != \"|\")\n        {\n            if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n            $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>\"{$arow['type']}\", 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>\"\");\n            if ($style == \"full\")\n            {\n                $fieldmap[$fieldname]['title']=$arow['title'];\n                $fieldmap[$fieldname]['question']=$arow['question'];\n                $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                $fieldmap[$fieldname]['hasconditions']=$conditions;\n                $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                if (isset($defaultValues[$arow['qid'].'~0'])) {\n                    $fieldmap[$fieldname]['defaultvalue'] = $defaultValues[$arow['qid'].'~0'];\n                }\n            }\n            switch($arow['type'])\n            {\n                case \"L\":  //RADIO LIST\n                case \"!\":  //DROPDOWN LIST\n                    if ($arow['other'] == \"Y\")\n                    {\n                        $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}other\";\n                        if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n\n                        $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                        'type'=>$arow['type'],\n                        'sid'=>$surveyid,\n                        \"gid\"=>$arow['gid'],\n                        \"qid\"=>$arow['qid'],\n                        \"aid\"=>\"other\");\n                        // dgk bug fix line above. aid should be set to \"other\" for export to append to the field name in the header line.\n                        if ($style == \"full\")\n                        {\n                            $fieldmap[$fieldname]['title']=$arow['title'];\n                            $fieldmap[$fieldname]['question']=$arow['question'];\n                            $fieldmap[$fieldname]['subquestion']=$clang->gT(\"Other\");\n                            $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                            $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                            $fieldmap[$fieldname]['hasconditions']=$conditions;\n                            $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                            $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                            $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                            if (isset($defaultValues[$arow['qid'].'~other'])) {\n                                $fieldmap[$fieldname]['defaultvalue'] = $defaultValues[$arow['qid'].'~other'];\n                            }\n                        }\n                    }\n                    break;\n                case \"O\": //DROPDOWN LIST WITH COMMENT\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}comment\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                    'type'=>$arow['type'],\n                    'sid'=>$surveyid,\n                    \"gid\"=>$arow['gid'],\n                    \"qid\"=>$arow['qid'],\n                    \"aid\"=>\"comment\");\n                    // dgk bug fix line below. aid should be set to \"comment\" for export to append to the field name in the header line. Also needed set the type element correctly.\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion']=$clang->gT(\"Comment\");\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    }\n                    break;\n            }\n        }\n        // For Multi flexi question types\n        elseif ($qtypes[$arow['type']]['subquestions']==2 && $qtypes[$arow['type']]['answerscales']==0)\n        {\n            //MULTI FLEXI\n            $abrows = getSubQuestions($surveyid,$arow['qid'],$sLanguage);\n            //Now first process scale=1\n            $answerset=array();\n            $answerList = array();\n            foreach ($abrows as $key=>$abrow)\n            {\n                if($abrow['scale_id']==1) {\n                    $answerset[]=$abrow;\n                    $answerList[] = array(\n                    'code'=>$abrow['title'],\n                    'answer'=>$abrow['question'],\n                    );\n                    unset($abrows[$key]);\n                }\n            }\n            reset($abrows);\n            foreach ($abrows as $abrow)\n            {\n                foreach($answerset as $answer)\n                {\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}_{$answer['title']}\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                    'type'=>$arow['type'],\n                    'sid'=>$surveyid,\n                    \"gid\"=>$arow['gid'],\n                    \"qid\"=>$arow['qid'],\n                    \"aid\"=>$abrow['title'].\"_\".$answer['title'],\n                    \"sqid\"=>$abrow['qid']);\n                    if ($abrow['other']==\"Y\") {$alsoother=\"Y\";}\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion1']=$abrow['question'];\n                        $fieldmap[$fieldname]['subquestion2']=$answer['question'];\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                        $fieldmap[$fieldname]['preg']=$arow['preg'];\n                        $fieldmap[$fieldname]['answerList']=$answerList;\n                    }\n                }\n            }\n            unset($answerset);\n        }\n        elseif ($arow['type'] == \"1\")\n        {\n            $abrows = getSubQuestions($surveyid,$arow['qid'],$sLanguage);\n            foreach ($abrows as $abrow)\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}#0\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$abrow['title'], \"scale_id\"=>0);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$abrow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['scale']=$clang->gT('Scale 1');\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}#1\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$abrow['title'], \"scale_id\"=>1);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$abrow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['scale']=$clang->gT('Scale 2');\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n            }\n        }\n\n        elseif ($arow['type'] == \"R\")\n        {\n            //MULTI ENTRY\n            $data = Answer::model()->findAllByAttributes(array('qid' => $arow['qid'], 'language' => $sLanguage));\n            $data = count($data);\n            $slots=$data;\n            for ($i=1; $i<=$slots; $i++)\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}$i\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$i);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=sprintf($clang->gT('Rank %s'),$i);\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n            }\n        }\n        elseif ($arow['type'] == \"|\")\n        {\n            $qidattributes= getQuestionAttributeValues($arow['qid']);\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}\";\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                'type'=>$arow['type'],\n                'sid'=>$surveyid,\n                \"gid\"=>$arow['gid'],\n                \"qid\"=>$arow['qid'],\n                \"aid\"=>''\n                );\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['max_files']=$qidattributes['max_num_of_files'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}\".\"_filecount\";\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                'type'=>$arow['type'],\n                'sid'=>$surveyid,\n                \"gid\"=>$arow['gid'],\n                \"qid\"=>$arow['qid'],\n                \"aid\"=>\"filecount\"\n                );\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=\"filecount - \".$arow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n        }\n        else  // Question types with subquestions and one answer per subquestion  (M/A/B/C/E/F/H/P)\n        {\n            //MULTI ENTRY\n            $abrows = getSubQuestions($surveyid,$arow['qid'],$sLanguage);\n            foreach ($abrows as $abrow)\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                'type'=>$arow['type'],\n                'sid'=>$surveyid,\n                'gid'=>$arow['gid'],\n                'qid'=>$arow['qid'],\n                'aid'=>$abrow['title'],\n                'sqid'=>$abrow['qid']);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$abrow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    $fieldmap[$fieldname]['preg']=$arow['preg'];\n                    if (isset($defaultValues[$arow['qid'].'~'.$abrow['qid']])) {\n                        $fieldmap[$fieldname]['defaultvalue'] = $defaultValues[$arow['qid'].'~'.$abrow['qid']];\n                    }\n                }\n                if ($arow['type'] == \"P\")\n                {\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}comment\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$abrow['title'].\"comment\");\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion']=$clang->gT('Comment');\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    }\n                }\n            }\n            if ($arow['other']==\"Y\" && ($arow['type']==\"M\" || $arow['type']==\"P\"))\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}other\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>\"other\");\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$clang->gT('Other');\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    $fieldmap[$fieldname]['other']=$arow['other'];\n                }\n                if ($arow['type']==\"P\")\n                {\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}othercomment\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>\"othercomment\");\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion']=$clang->gT('Other comment');\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                        $fieldmap[$fieldname]['other']=$arow['other'];\n                    }\n                }\n            }\n        }\n        if (isset($fieldmap[$fieldname]))\n        {\n            $fieldmap[$fieldname]['relevance']=$arow['relevance'];\n            $fieldmap[$fieldname]['grelevance']=$arow['grelevance'];\n            $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n            $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n            $fieldmap[$fieldname]['preg']=$arow['preg'];\n            $fieldmap[$fieldname]['other']=$arow['other'];\n            $fieldmap[$fieldname]['help']=$arow['help'];\n        }\n        else\n        {\n            --$questionSeq; // didn't generate a valid $fieldmap entry, so decrement the question counter to ensure they are sequential\n        }\n    }\n\n    if (isset($fieldmap)) {\n        if ($questionid == false)\n        {\n            // If the fieldmap was randomized, the master will contain the proper order.  Copy that fieldmap with the new language settings.\n            if (isset(Yii::app()->session['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster']))\n            {\n                $masterFieldmap = Yii::app()->session['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster'];\n                $mfieldmap = Yii::app()->session['survey_'.$surveyid][$masterFieldmap];\n\n                foreach ($mfieldmap as $fieldname => $mf)\n                {\n                    if (isset($fieldmap[$fieldname]))\n                    {\n                        // This array holds the keys of translatable attributes\n                        $translatable = array_flip(array('question', 'subquestion', 'subquestion1', 'subquestion2', 'group_name', 'answerList', 'defaultValue', 'help'));\n                        // We take all translatable attributes from the new fieldmap\n                        $newText = array_intersect_key($fieldmap[$fieldname], $translatable);\n                        // And merge them with the other values from the random fieldmap like questionSeq, groupSeq etc.\n                        $mf = $newText + $mf;\n                    }\n                    $mfieldmap[$fieldname] = $mf;\n                }\n                $fieldmap = $mfieldmap;\n            }\n            Yii::app()->session['fieldmap-' . $surveyid . $sLanguage]=$fieldmap;\n        }\n        return $fieldmap;\n    }\n}\n\n/**\n* Returns true if the given survey has a File Upload Question Type\n* @param $surveyid The survey ID\n* @return bool\n*/\nfunction hasFileUploadQuestion($iSurveyID) {\n    $iCount = Question::model()->count( \"sid=:surveyid AND parent_qid=0 AND type='|'\", array(':surveyid' => $iSurveyID));    \n    return $iCount>0 ;\n}\n\n/**\n* This function generates an array containing the fieldcode, and matching data in the same order as the activate script\n*\n* @param string $surveyid The Survey ID\n* @param mixed $style 'short' (default) or 'full' - full creates extra information like default values\n* @param mixed $force_refresh - Forces to really refresh the array, not just take the session copy\n* @param int $questionid Limit to a certain qid only (for question preview) - default is false\n* @param string $sQuestionLanguage The language to use\n* @return array\n*/\nfunction createTimingsFieldMap($surveyid, $style='full', $force_refresh=false, $questionid=false, $sQuestionLanguage=null) {\n\n    global $aDuplicateQIDs;\n    static $timingsFieldMap;\n\n    $sLanguage = sanitize_languagecode($sQuestionLanguage);\n    $surveyid = sanitize_int($surveyid);\n    $clang = new Limesurvey_lang($sLanguage);\n\n    //checks to see if fieldmap has already been built for this page.\n    if (isset($timingsFieldMap[$surveyid][$style][$clang->langcode]) && $force_refresh==false) {\n        return $timingsFieldMap[$surveyid][$style][$clang->langcode];\n    }\n\n    //do something\n    $fields = createFieldMap($surveyid, $style, $force_refresh, $questionid, $sQuestionLanguage);\n    $fieldmap['interviewtime']=array('fieldname'=>'interviewtime','type'=>'interview_time','sid'=>$surveyid, 'gid'=>'', 'qid'=>'', 'aid'=>'', 'question'=>$clang->gT('Total time'), 'title'=>'interviewtime');\n    foreach ($fields as $field) {\n        if (!empty($field['gid'])) {\n            // field for time spent on page\n            $fieldname=\"{$field['sid']}X{$field['gid']}time\";\n            if (!isset($fieldmap[$fieldname]))\n            {\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>\"page_time\", 'sid'=>$surveyid, \"gid\"=>$field['gid'], \"group_name\"=>$field['group_name'], \"qid\"=>'', 'aid'=>'', 'title'=>'groupTime'.$field['gid'], 'question'=>$clang->gT('Group time').\": \".$field['group_name']);\n            }\n\n            // field for time spent on answering a question\n            $fieldname=\"{$field['sid']}X{$field['gid']}X{$field['qid']}time\";\n            if (!isset($fieldmap[$fieldname]))\n            {\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>\"answer_time\", 'sid'=>$surveyid, \"gid\"=>$field['gid'], \"group_name\"=>$field['group_name'], \"qid\"=>$field['qid'], 'aid'=>'', \"title\"=>$field['title'].'Time', \"question\"=>$clang->gT('Question time').\": \".$field['title']);\n            }\n        }\n    }\n\n    $timingsFieldMap[$surveyid][$style][$clang->langcode] = $fieldmap;\n    return $timingsFieldMap[$surveyid][$style][$clang->langcode];\n}\n\n/**\n* put your comment there...\n*\n* @param mixed $needle\n* @param mixed $haystack\n* @param mixed $keyname\n* @param mixed $maxanswers\n*/\nfunction arraySearchByKey($needle, $haystack, $keyname, $maxanswers=\"\") {\n    $output=array();\n    foreach($haystack as $hay) {\n        if (array_key_exists($keyname, $hay)) {\n            if ($hay[$keyname] == $needle) {\n                if ($maxanswers == 1) {\n                    return $hay;\n                } else {\n                    $output[]=$hay;\n                }\n            }\n        }\n    }\n    return $output;\n}\n\n/**\n* set the rights of a user and his children\n*\n* @param int $uid the user id\n* @param mixed $rights rights array\n*/\nfunction setuserpermissions($uid, $rights)\n{\n    $uid=sanitize_int($uid);\n    $updates = \"create_survey=\".$rights['create_survey']\n    . \", create_user=\".$rights['create_user']\n    . \", participant_panel=\".$rights['participant_panel']\n    . \", delete_user=\".$rights['delete_user']\n    . \", superadmin=\".$rights['superadmin']\n    . \", configurator=\".$rights['configurator']\n    . \", manage_template=\".$rights['manage_template']\n    . \", manage_label=\".$rights['manage_label'];\n    $uquery = \"UPDATE {{users}} SET \".$updates.\" WHERE uid = \".$uid;\n    return dbSelectLimitAssoc($uquery);     //Checked\n}\n\n/**\n* This function returns a count of the number of saved responses to a survey\n*\n* @param mixed $surveyid Survey ID\n*/\nfunction getSavedCount($surveyid)\n{\n    $surveyid=(int)$surveyid;\n\n    return SavedControl::model()->getCountOfAll($surveyid);\n}\n\n/**\n* Returns the base language from a survey id\n*\n* @deprecated Use Survey::model()->findByPk($surveyid)->language\n* @param int $surveyid\n* @return string\n*/\nfunction getBaseLanguageFromSurveyID($surveyid)\n{\n    return Survey::model()->findByPk($surveyid)->language;\n}\n\n\nfunction buildLabelSetCheckSumArray()\n{\n    // BUILD CHECKSUMS FOR ALL EXISTING LABEL SETS\n\n    /**$query = \"SELECT lid\n    FROM \".db_table_name('labelsets').\"\n    ORDER BY lid\"; */\n    $result = LabelSet::model()->getLID();//($query) or safeDie(\"safe_died collecting labelset ids<br />$query<br />\");  //Checked)\n    $csarray=array();\n    foreach($result as $row)\n    {\n        $thisset=\"\";\n        $query2 = \"SELECT code, title, sortorder, language, assessment_value\n        FROM {{labels}}\n        WHERE lid={$row['lid']}\n        ORDER BY language, sortorder, code\";\n        $result2 = Yii::app()->db->createCommand($query2)->query();\n        foreach ($result2->readAll() as $row2)\n        {\n            $thisset .= implode('.', $row2);\n        } // while\n        $csarray[$row['lid']]=dechex(crc32($thisset)*1);\n    }\n\n    return $csarray;\n}\n\n\n/**\n* Returns a flat array with all question attributes for the question only (and the qid we gave it)!\n* @param $iQID The question ID\n* @return array$bOrderByNative=>value, attribute=>value} or false if the question ID does not exist (anymore)\n*/\nfunction getQuestionAttributeValues($iQID)\n{\n    return QuestionAttribute::model()->getQuestionAttributes($iQID);\n#    static $cache = array();\n#    static $availableattributesarr = null;\n#    $iQID = sanitize_int($iQID);\n\n#    if (isset($cache[$iQID])) {\n#        return $cache[$iQID];\n#    }\n#    $oQuestion = Question::model()->find(\"qid=:qid\",array('qid'=>$iQuestionID)); // Maybe take parent_qid attribute before this qid attribute\n#    if (!$oQuestion) // Question was deleted while running the survey\n#    {\n#        $cache[$iQID] = false;\n#        return false;\n#    }\n#    else\n#    {\n#        $type = $oQuestion->type;\n#        $surveyid = $oQuestion->type;\n#        $row = $oQuestion->getAttributes();\n#    }\n#    $type = $row['type'];\n#    $surveyid = $row['sid'];\n\n#    $aLanguages = array_merge((array)Survey::model()->findByPk($surveyid)->language, Survey::model()->findByPk($surveyid)->additionalLanguages);\n\n    //Now read available attributes, make sure we do this only once per request to save\n    //processing cycles and memory\n#    if (is_null($availableattributesarr)) $availableattributesarr = questionAttributes();\n#    if (isset($availableattributesarr[$type]))\n#    {\n#        $aAvailableAttributes = $availableattributesarr[$type];\n#    }\n#    else\n#    {\n#        $cache[$iQID] = array();\n#        return array();\n#    }\n\n#    $aResultAttributes = array();\n#    foreach($aAvailableAttributes as $attribute){\n#        if ($attribute['i18n'])\n#        {\n#            foreach ($aLanguages as $sLanguage)\n#            {\n#                $aResultAttributes[$attribute['name']][$sLanguage]=$attribute['default'];\n#            }\n#        }\n#        else\n#        {\n#            $aResultAttributes[$attribute['name']]=$attribute['default'];\n#        }\n#    }\n\n#    $result = QuestionAttribute::model()->findAllByAttributes(array('qid' => $iQID));\n#    foreach ($result as $row)\n#    {\n#        $row = $row->attributes;\n#        if (!isset($aAvailableAttributes[$row['attribute']]))\n#        {\n#            continue; // Sort out attributes not belonging to this question\n#        }\n#        if (!($aAvailableAttributes[$row['attribute']]['i18n']))\n#        {\n#            $aResultAttributes[$row['attribute']]=$row['value'];\n#        }\n#        elseif(!empty($row['language']))\n#        {\n#            $aResultAttributes[$row['attribute']][$row['language']]=$row['value'];\n#        }\n#    }\n#    $cache[$iQID] = $aResultAttributes;\n#    return $aResultAttributes;\n}\n\n/**\n*\n* Returns the questionAttribtue value set or '' if not set\n* @author: lemeur\n* @param $questionAttributeArray\n* @param $attributeName\n* @param $language string Optional: The language if the particualr attributes is localizable\n* @return string\n*/\nfunction getQuestionAttributeValue($questionAttributeArray, $attributeName, $language='')\n{\n    if ($language=='' && isset($questionAttributeArray[$attributeName]))\n    {\n        return $questionAttributeArray[$attributeName];\n    }\n    elseif ($language!='' && isset($questionAttributeArray[$attributeName][$language]))\n    {\n        return $questionAttributeArray[$attributeName][$language];\n    }\n    else\n    {\n        return '';\n    }\n}\n\n/**\n* Returns array of question type chars with attributes\n*\n* @param mixed $returnByName If set to true the array will be by attribute name\n*/\nfunction questionAttributes($returnByName=false)\n{\n    // Use some static\n    static $qattributes=false;\n    static $qat=false;\n    $clang = Yii::app()->lang;\n\n    if (!$qattributes)\n    {\n        //For each question attribute include a key:\n        // name - the display name\n        // types - a string with one character representing each question typy to which the attribute applies\n        // help - a short explanation\n\n        // If you insert a new attribute please do it in correct alphabetical order!\n        // Please also list the new attribute in the function &TSVSurveyExport($sid) in em_manager_helper.php,\n        // so your new attribute will not be \"forgotten\" when the survey is exported to Excel/CSV-format!\n\n        $qattributes[\"alphasort\"]=array(\n        \"types\"=>\"!LOWZ\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Sort the answer options alphabetically\"),\n        \"caption\"=>$clang->gT('Sort answers alphabetically'));\n\n        $qattributes[\"answer_width\"]=array(\n        \"types\"=>\"ABCEF1:;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n        'min'=>'1',\n        'max'=>'100',\n        \"help\"=>$clang->gT('Set the percentage width of the (sub-)question column (1-100)'),\n        \"caption\"=>$clang->gT('(Sub-)question width'));\n\n        $qattributes[\"repeat_headings\"]=array(\n        \"types\"=>\"F:1;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n         'default'=>'',\n        \"help\"=>$clang->gT('Repeat headings every X subquestions (Set to 0 to deactivate heading repeat, deactivate minimum repeat headings from config).'),\n        \"caption\"=>$clang->gT('Repeat headers'));\n\n        $qattributes[\"array_filter\"]=array(\n        \"types\"=>\"1ABCEF:;MPLKQR\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT(\"Enter the code(s) of Multiple choice question(s) (separated by semicolons) to only show the matching answer options in this question.\"),\n        \"caption\"=>$clang->gT('Array filter'));\n\n        $qattributes[\"array_filter_exclude\"]=array(\n        \"types\"=>\"1ABCEF:;MPLKQR\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT(\"Enter the code(s) of Multiple choice question(s) (separated by semicolons) to exclude the matching answer options in this question.\"),\n        \"caption\"=>$clang->gT('Array filter exclusion'));\n\n        $qattributes[\"array_filter_style\"]=array(\n        \"types\"=>\"1ABCEF:;MPLKQR\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Hidden'),\n        1=>$clang->gT('Disabled')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Specify how array-filtered sub-questions should be displayed\"),\n        \"caption\"=>$clang->gT('Array filter style'));\n\n        $qattributes[\"assessment_value\"]=array(\n        \"types\"=>\"MP\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'default'=>'1',\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT(\"If one of the subquestions is marked then for each marked subquestion this value is added as assessment.\"),\n        \"caption\"=>$clang->gT('Assessment value'));\n\n        $qattributes[\"category_separator\"]=array(\n        \"types\"=>\"!\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Category separator'),\n        \"caption\"=>$clang->gT('Category separator'));\n\n        $qattributes[\"code_filter\"]=array(\n        \"types\"=>\"WZ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Filter the available answers by this value'),\n        \"caption\"=>$clang->gT('Code filter'));\n\n        $qattributes[\"commented_checkbox\"]=array(\n        \"types\"=>\"P\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>110,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n            \"allways\"=>$clang->gT('No control on checkbox'),\n            \"checked\"=>$clang->gT('Checkbox is checked'),\n            \"unchecked\"=>$clang->gT('Checkbox is unchecked'),\n            ),\n        'default' => \"checked\",\n        'help'=>$clang->gT('Choose when user can add a comment'),\n        'caption'=>$clang->gT('Comment only when'));\n\n        $qattributes[\"commented_checkbox_auto\"]=array(\n        \"types\"=>\"P\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>111,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n            \"0\"=>$clang->gT('No'),\n            \"1\"=>$clang->gT('Yes'),\n            ),\n        'default' => \"1\",\n        'help'=>$clang->gT('Use javascript function to remove text and uncheck checkbox (or use Expression Manager only).'),\n        'caption'=>$clang->gT('Remove text or uncheck checkbox automatically'));\n\n        $qattributes[\"display_columns\"]=array(\n        \"types\"=>\"LM\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n        'default'=>'1',\n        'min'=>'1',\n        'max'=>'100',\n        \"help\"=>$clang->gT('The answer options will be distributed across the number of columns set here'),\n        \"caption\"=>$clang->gT('Display columns'));\n\n        $qattributes[\"display_rows\"]=array(\n        \"types\"=>\"QSTU\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('How many rows to display'),\n        \"caption\"=>$clang->gT('Display rows'));\n\n        $qattributes[\"dropdown_dates\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use accessible dropdown boxes instead of calendar popup'),\n        \"caption\"=>$clang->gT('Display dropdown boxes'));\n\n        $qattributes[\"date_min\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Minimum date selectable in calendar (YYYY-MM-DD). Only the year is used if dropdown boxes are selected.'),\n        \"caption\"=>$clang->gT('Minimum date'));\n\n        $qattributes[\"date_max\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>111,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum date selectable in calendar (YYYY-MM-DD). Only the year is used if dropdown boxes are selected.'),\n        \"caption\"=>$clang->gT('Maximum date'));\n\n        $qattributes[\"dropdown_prepostfix\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>112,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Prefix|Suffix for dropdown lists'),\n        \"caption\"=>$clang->gT('Dropdown prefix/suffix'));\n\n        $qattributes[\"dropdown_separators\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>120,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Text shown on each subquestion row between both scales in dropdown mode'),\n        \"caption\"=>$clang->gT('Dropdown separator'));\n\n        $qattributes[\"dualscale_headerA\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Enter a header text for the first scale'),\n        \"caption\"=>$clang->gT('Header for first scale'));\n\n        $qattributes[\"dualscale_headerB\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>111,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Enter a header text for the second scale'),\n        \"caption\"=>$clang->gT('Header for second scale'));\n\n        $qattributes[\"equals_num_value\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Multiple numeric inputs sum must equal this value'),\n        \"caption\"=>$clang->gT('Equals sum value'));\n\n        $qattributes[\"em_validation_q\"]=array(\n        \"types\"=>\":;ABCDEFKMNPQRSTU\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>200,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('Enter a boolean equation to validate the whole question.'),\n        \"caption\"=>$clang->gT('Question validation equation'));\n\n        $qattributes[\"em_validation_q_tip\"]=array(\n        \"types\"=>\":;ABCDEFKMNPQRSTU\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>210,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('This is a hint text that will be shown to the participant describing the question validation equation.'),\n        \"caption\"=>$clang->gT('Question validation tip'));\n\n        $qattributes[\"em_validation_sq\"]=array(\n        \"types\"=>\";:KQSTUN\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>220,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('Enter a boolean equation to validate each sub-question.'),\n        \"caption\"=>$clang->gT('Sub-question validation equation'));\n\n        $qattributes[\"em_validation_sq_tip\"]=array(\n        \"types\"=>\";:KQSTUN\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>230,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('This is a tip shown to the participant describing the sub-question validation equation.'),\n        \"caption\"=>$clang->gT('Sub-question validation tip'));\n\n        $qattributes[\"exclude_all_others\"]=array(\n        \"types\"=>\":ABCEFMPKQ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>130,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Excludes all other options if a certain answer is selected - just enter the answer code(s) separated with a semikolon.'),\n        \"caption\"=>$clang->gT('Exclusive option'));\n\n        $qattributes[\"exclude_all_others_auto\"]=array(\n        \"types\"=>\"MP\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>131,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('If the participant marks all options, uncheck all and check the option set in the \"Exclusive option\" setting'),\n        \"caption\"=>$clang->gT('Auto-check exclusive option if all others are checked'));\n\n        // Map Options\n\n        $qattributes[\"location_city\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the city?\"),\n        \"caption\"=>$clang->gT(\"Save city\"));\n\n        $qattributes[\"location_state\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'default'=>0,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the state?\"),\n        \"caption\"=>$clang->gT(\"Save state\"));\n\n        $qattributes[\"location_postal\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the postal code?\"),\n        \"caption\"=>$clang->gT(\"Save postal code\"));\n\n        $qattributes[\"location_country\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the country?\"),\n        \"caption\"=>$clang->gT(\"Save country\"));\n\n        $qattributes[\"statistics_showmap\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Statistics'),\n        'inputtype'=>'singleselect',\n        'sortorder'=>100,\n        'options'=>array(1=>$clang->gT('Yes'), 0=>$clang->gT('No')),\n        'help'=>$clang->gT(\"Show a map in the statistics?\"),\n        'caption'=>$clang->gT(\"Display map\"),\n        'default'=>1\n        );\n\n        $qattributes[\"statistics_showgraph\"]=array(\n        'types'=>'15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Statistics'),\n        'inputtype'=>'singleselect',\n        'sortorder'=>101,\n        'options'=>array(1=>$clang->gT('Yes'), 0=>$clang->gT('No')),\n        'help'=>$clang->gT(\"Display a chart in the statistics?\"),\n        'caption'=>$clang->gT(\"Display chart\"),\n        'default'=>1\n        );\n\n        $qattributes[\"statistics_graphtype\"]=array(\n        \"types\"=>'15ABCDEFGHIKLNOQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Statistics'),\n        'inputtype'=>'singleselect',\n        'sortorder'=>102,\n        'options'=>array(0=>$clang->gT('Bar chart'), 1=>$clang->gT('Pie chart')),\n        'help'=>$clang->gT(\"Select the type of chart to be displayed\"),\n        'caption'=>$clang->gT(\"Chart type\"),\n        'default'=>0\n        );\n\n        $qattributes[\"location_mapservice\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>90,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Off'),\n        1=>$clang->gT('Google Maps')),\n        'default' => 0,\n        \"help\"=>$clang->gT(\"Activate this to show a map above the input field where the user can select a location\"),\n        \"caption\"=>$clang->gT(\"Use mapping service\"));\n\n        $qattributes[\"location_mapwidth\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>102,\n        'inputtype'=>'text',\n        'default'=>'500',\n        \"help\"=>$clang->gT(\"Width of the map in pixel\"),\n        \"caption\"=>$clang->gT(\"Map width\"));\n\n        $qattributes[\"location_mapheight\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>103,\n        'inputtype'=>'text',\n        'default'=>'300',\n        \"help\"=>$clang->gT(\"Height of the map in pixel\"),\n        \"caption\"=>$clang->gT(\"Map height\"));\n\n        $qattributes[\"location_nodefaultfromip\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>91,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        'default' => 0,\n        \"help\"=>$clang->gT(\"Get the default location using the user's IP address?\"),\n        \"caption\"=>$clang->gT(\"IP as default location\"));\n\n        $qattributes[\"location_defaultcoordinates\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>101,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Default coordinates of the map when the page first loads. Format: latitude [space] longtitude'),\n        \"caption\"=>$clang->gT('Default position'));\n\n        $qattributes[\"location_mapzoom\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>101,\n        'inputtype'=>'text',\n        'default'=>'11',\n        \"help\"=>$clang->gT(\"Map zoom level\"),\n        \"caption\"=>$clang->gT(\"Zoom level\"));\n\n        // End Map Options\n\n        $qattributes[\"hide_tip\"]=array(\n        \"types\"=>\"15ABCDEFGHIKLMNOPQRSTUXY!:;|\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Hide the tip that is normally shown with a question'),\n        \"caption\"=>$clang->gT('Hide tip'));\n\n        $qattributes['hidden']=array(\n        'types'=>'15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>101,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        'help'=>$clang->gT('Hide this question at any time. This is useful for including data using answer prefilling.'),\n        'caption'=>$clang->gT('Always hide this question'));\n\n        $qattributes[\"max_answers\"]=array(\n        \"types\"=>\"MPR1:;ABCEFKQ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>11,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Limit the number of possible answers'),\n        \"caption\"=>$clang->gT('Maximum answers'));\n\n        $qattributes[\"max_num_value\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum sum value of multiple numeric input'),\n        \"caption\"=>$clang->gT('Maximum sum value'));\n\n        $qattributes[\"max_num_value_n\"]=array(\n        \"types\"=>\"NK\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>110,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Maximum value of the numeric input'),\n        \"caption\"=>$clang->gT('Maximum value'));\n\n        //    $qattributes[\"max_num_value_sgqa\"]=array(\n        //    \"types\"=>\"K\",\n        //    'category'=>$clang->gT('Logic'),\n        //    'sortorder'=>100,\n        //    'inputtype'=>'text',\n        //    \"help\"=>$clang->gT('Enter the SGQA identifier to use the total of a previous question as the maximum for this question'),\n        //    \"caption\"=>$clang->gT('Max value from SGQA'));\n\n        $qattributes[\"maximum_chars\"]=array(\n        \"types\"=>\"STUNQK:;\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum characters allowed'),\n        \"caption\"=>$clang->gT('Maximum characters'));\n\n        $qattributes[\"min_answers\"]=array(\n        \"types\"=>\"MPR1:;ABCEFKQ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>10,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Ensure a minimum number of possible answers (0=No limit)'),\n        \"caption\"=>$clang->gT('Minimum answers'));\n\n        $qattributes[\"min_num_value\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('The sum of the multiple numeric inputs must be greater than this value'),\n        \"caption\"=>$clang->gT('Minimum sum value'));\n\n        $qattributes[\"min_num_value_n\"]=array(\n        \"types\"=>\"NK\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Minimum value of the numeric input'),\n        \"caption\"=>$clang->gT('Minimum value'));\n\n        //    $qattributes[\"min_num_value_sgqa\"]=array(\n        //    \"types\"=>\"K\",\n        //    'category'=>$clang->gT('Logic'),\n        //    'sortorder'=>100,\n        //    'inputtype'=>'text',\n        //    \"help\"=>$clang->gT('Enter the SGQA identifier to use the total of a previous question as the minimum for this question'),\n        //    \"caption\"=>$clang->gT('Minimum value from SGQA'));\n\n        $qattributes[\"multiflexible_max\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>112,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum value for array(mult-flexible) question type'),\n        \"caption\"=>$clang->gT('Maximum value'));\n\n        $qattributes[\"multiflexible_min\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Minimum value for array(multi-flexible) question type'),\n        \"caption\"=>$clang->gT('Minimum value'));\n\n        $qattributes[\"multiflexible_step\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>111,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Step value'),\n        \"caption\"=>$clang->gT('Step value'));\n\n        $qattributes[\"multiflexible_checkbox\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use checkbox layout'),\n        \"caption\"=>$clang->gT('Checkbox layout'));\n\n        $qattributes[\"reverse\"]=array(\n        \"types\"=>\"D:\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Present answer options in reverse order'),\n        \"caption\"=>$clang->gT('Reverse answer order'));\n\n        //    $qattributes[\"num_value_equals_sgqa\"]=array(\n        //    \"types\"=>\"K\",\n        //    'category'=>$clang->gT('Logic'),\n        //    'sortorder'=>100,\n        //    'inputtype'=>'text',\n        //    \"help\"=>$clang->gT('SGQA identifier to use total of previous question as total for this question'),\n        //    \"caption\"=>$clang->gT('Value equals SGQA'));\n\n        $qattributes[\"num_value_int_only\"]=array(\n        \"types\"=>\"N\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Restrict input to integer values'),\n        \"caption\"=>$clang->gT('Integer only'));\n\n        $qattributes[\"numbers_only\"]=array(\n        \"types\"=>\"Q;S*\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>150,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Allow only numerical input'),\n        \"caption\"=>$clang->gT('Numbers only')\n        );\n\n        $qattributes['show_totals'] =    array(\n        'types' =>    ';',\n        'category' =>    $clang->gT('Other'),\n        'sortorder' =>    151,\n        'inputtype'    => 'singleselect',\n        'options' =>    array(\n        'X' =>    $clang->gT('Off'),\n        'R' =>    $clang->gT('Rows'),\n        'C' =>    $clang->gT('Columns'),\n        'B' =>    $clang->gT('Both rows and columns')\n        ),\n        'default' =>    'X',\n        'help' =>    $clang->gT('Show totals for either rows, columns or both rows and columns'),\n        'caption' =>    $clang->gT('Show totals for')\n        );\n\n        $qattributes['show_grand_total'] =    array(\n        'types' =>    ';',\n        'category' =>    $clang->gT('Other'),\n        'sortorder' =>    152,\n        'inputtype' =>    'singleselect',\n        'options' =>    array(\n        0 =>    $clang->gT('No'),\n        1 =>    $clang->gT('Yes')\n        ),\n        'default' =>    0,\n        'help' =>    $clang->gT('Show grand total for either columns or rows'),\n        'caption' =>    $clang->gT('Show grand total')\n        );\n\n        $qattributes[\"input_boxes\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Present as text input boxes instead of dropdown lists\"),\n        \"caption\"=>$clang->gT(\"Text inputs\"));\n\n        $qattributes[\"other_comment_mandatory\"]=array(\n        \"types\"=>\"PLW!Z\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Make the 'Other:' comment field mandatory when the 'Other:' option is active\"),\n        \"caption\"=>$clang->gT(\"'Other:' comment mandatory\"));\n\n        $qattributes[\"other_numbers_only\"]=array(\n        \"types\"=>\"LMP\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Allow only numerical input for 'Other' text\"),\n        \"caption\"=>$clang->gT(\"Numbers only for 'Other'\"));\n\n        $qattributes[\"other_replace_text\"]=array(\n        \"types\"=>\"LMPWZ!\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"Replaces the label of the 'Other:' answer option with a custom text\"),\n        \"caption\"=>$clang->gT(\"Label for 'Other:' option\"));\n\n        $qattributes[\"page_break\"]=array(\n        \"types\"=>\"15ABCDEFGHKLMNOPQRSTUWXYZ!:;|*\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Insert a page break before this question in printable view by setting this to Yes.'),\n        \"caption\"=>$clang->gT('Insert page break in printable view'));\n\n        $qattributes[\"prefix\"]=array(\n        \"types\"=>\"KNQS\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>10,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Add a prefix to the answer field'),\n        \"caption\"=>$clang->gT('Answer prefix'));\n\n        $qattributes[\"printable_help\"]=array(\n        \"types\"=>\"15ABCDEFGHKLMNOPRWYZ!:*\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>201,\n        \"inputtype\"=>\"text\",\n        'i18n'=>true,\n        'default'=>\"\",\n        \"help\"=>$clang->gT('In the printable version replace the relevance equation with this explanation text.'),\n        \"caption\"=>$clang->gT(\"Relevance help for printable survey\"));    \n        \n        $qattributes[\"public_statistics\"]=array(\n        \"types\"=>\"15ABCEFGHKLMNOPRWYZ!:*\",\n        'category'=>$clang->gT('Statistics'),\n        'sortorder'=>80,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Show statistics of this question in the public statistics page'),\n        \"caption\"=>$clang->gT('Show in public statistics'));\n\n        $qattributes[\"random_order\"]=array(\n        \"types\"=>\"!ABCEFHKLMOPQRWZ1:;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Off'),\n        1=>$clang->gT('Randomize on each page load')\n        //,2=>$clang->gT('Randomize once on survey start')  //Mdekker: commented out as code to handle this was removed in refactoring\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Present subquestions/answer options in random order'),\n        \"caption\"=>$clang->gT('Random order'));\n\n        /*\n        $qattributes['relevance']=array(\n        'types'=>'15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>1,\n        'inputtype'=>'text',\n        'default'=>'1',\n        'help'=>$clang->gT('The relevance equation determines whether a question should be shown (if true) or hiddden and marked as Not Applicable (if false).'\n        . '  The relevance equation can be as complex as you like, using any combination of mathematical operators, nested parentheses,'\n        . ' any variable or token that has already been set, and any of more than 50 functions.  It is parsed by the ExpressionManager.'),\n        'caption'=>$clang->gT('Relevance equation'));\n        */\n\n        $qattributes[\"showpopups\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"caption\"=>$clang->gT('Show javascript alert'),\n        \"help\"=>$clang->gT('Show an alert if answers exceeds the number of max answers'));\n        $qattributes[\"samechoiceheight\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>120,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"caption\"=>$clang->gT('Same height for all answer options'),\n        \"help\"=>$clang->gT('Force each answer option to have the same height'));\n        $qattributes[\"samelistheight\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>121,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"caption\"=>$clang->gT('Same height for lists'),\n        \"help\"=>$clang->gT('Force the choice list and the rank list to have the same height'));\n\n        $qattributes[\"parent_order\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"caption\"=>$clang->gT('Get order from previous question'),\n        \"help\"=>$clang->gT('Enter question ID to get subquestion order from a previous question'));\n\n        $qattributes[\"slider_layout\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>1,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use slider layout'),\n        \"caption\"=>$clang->gT('Use slider layout'));\n\n        $qattributes[\"slider_min\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>10,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider minimum value'),\n        \"caption\"=>$clang->gT('Slider minimum value'));\n\n        $qattributes[\"slider_max\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>11,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider maximum value'),\n        \"caption\"=>$clang->gT('Slider maximum value'));\n\n        $qattributes[\"slider_accuracy\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>30,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider accuracy'),\n        \"caption\"=>$clang->gT('Slider accuracy'));\n\n        $qattributes[\"slider_default\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>50,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider start as this value (this will set the initial value).'),\n        \"caption\"=>$clang->gT('Slider initial value'));\n\n        $qattributes[\"slider_middlestart\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>40,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('The handle is displayed at the middle of the slider except if Slider initial value is set (this will not set the initial value).'),\n        \"caption\"=>$clang->gT('Slider starts at the middle position'));\n\n        $qattributes[\"slider_rating\"]=array(\n        \"types\"=>\"5\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>90,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes - stars'),\n        2=>$clang->gT('Yes - slider with emoticon'),\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use slider layout'),\n        \"caption\"=>$clang->gT('Use slider layout'));\n\n        $qattributes[\"slider_reset\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>50,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes'),\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Add a button to reset the slider. If you choose an start value, it reset at start value, else empty the answer.'),\n        \"caption\"=>$clang->gT('Allow reset the slider'));\n\n        $qattributes[\"slider_showminmax\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Display min and max value under the slider'),\n        \"caption\"=>$clang->gT('Display slider min and max value'));\n\n        $qattributes[\"slider_separator\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Answer|Left-slider-text|Right-slider-text separator character'),\n        \"caption\"=>$clang->gT('Slider left/right text separator'));\n\n        $qattributes[\"suffix\"]=array(\n        \"types\"=>\"KNQS\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>11,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Add a suffix to the answer field'),\n        \"caption\"=>$clang->gT('Answer suffix'));\n\n        $qattributes[\"text_input_width\"]=array(\n        \"types\"=>\"KNSTUQ;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Width of text input box'),\n        \"caption\"=>$clang->gT('Input box width'));\n\n        $qattributes[\"use_dropdown\"]=array(\n        \"types\"=>\"1FO\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>112,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Present dropdown control(s) instead of list of radio buttons'),\n        \"caption\"=>$clang->gT('Use dropdown presentation'));\n\n\n        $qattributes[\"dropdown_size\"]=array(\n        \"types\"=>\"!\",   // TODO add these later?  \"1F\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>200,\n        'inputtype'=>'text',\n        'default'=>0,\n        \"help\"=>$clang->gT('For list dropdown boxes, show up to this many rows'),\n        \"caption\"=>$clang->gT('Height of dropdown'));\n\n        $qattributes[\"dropdown_prefix\"]=array(\n        \"types\"=>\"!\",   // TODO add these later?  \"1F\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>201,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('None'),\n        1=>$clang->gT('Order - like 3)'),\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Accelerator keys for list items'),\n        \"caption\"=>$clang->gT('Prefix for list items'));\n\n        $qattributes[\"scale_export\"]=array(\n        \"types\"=>\"CEFGHLMOPWYZ1!:*\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Default'),\n        1=>$clang->gT('Nominal'),\n        2=>$clang->gT('Ordinal'),\n        3=>$clang->gT('Scale')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Set a specific SPSS export scale type for this question\"),\n        \"caption\"=>$clang->gT('SPSS export scale type'));\n\n        $qattributes[\"choice_title\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>200,\n        \"inputtype\"=>\"text\",\n        'i18n'=>true,\n        'default'=>\"\",\n        \"help\"=>sprintf($clang->gT(\"Replace choice header (default: \\\"%s\\\")\",'js'),$clang->gT(\"Your Choices\")),\n        \"caption\"=>$clang->gT(\"Choice header\"));\n\n        $qattributes[\"rank_title\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>201,\n        \"inputtype\"=>\"text\",\n        'i18n'=>true,\n        'default'=>\"\",\n        \"help\"=>sprintf($clang->gT(\"Replace rank header (default: \\\"%s\\\")\",'js'),$clang->gT(\"Your Ranking\")),\n        \"caption\"=>$clang->gT(\"Rank header\"));\n\n        //Timer attributes\n        $qattributes[\"time_limit\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>90,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Limit time to answer question (in seconds)\"),\n        \"caption\"=>$clang->gT(\"Time limit\"));\n\n        $qattributes[\"time_limit_action\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>92,\n        'inputtype'=>'singleselect',\n        'options'=>array(1=>$clang->gT('Warn and move on'),\n        2=>$clang->gT('Move on without warning'),\n        3=>$clang->gT('Disable only')),\n        \"default\" => 1,\n        \"help\"=>$clang->gT(\"Action to perform when time limit is up\"),\n        \"caption\"=>$clang->gT(\"Time limit action\"));\n\n        $qattributes[\"time_limit_disable_next\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>94,\n        \"inputtype\"=>\"singleselect\",\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        \"help\"=>$clang->gT(\"Disable the next button until time limit expires\"),\n        \"caption\"=>$clang->gT(\"Time limit disable next\"));\n\n        $qattributes[\"time_limit_disable_prev\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>96,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Disable the prev button until the time limit expires\"),\n        \"caption\"=>$clang->gT(\"Time limit disable prev\"));\n\n        $qattributes[\"time_limit_countdown_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>98,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The text message that displays in the countdown timer during the countdown\"),\n        \"caption\"=>$clang->gT(\"Time limit countdown message\"));\n\n        $qattributes[\"time_limit_timer_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS Style for the message that displays in the countdown timer during the countdown\"),\n        \"caption\"=>$clang->gT(\"Time limit timer CSS style\"));\n\n        $qattributes[\"time_limit_message_delay\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>102,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Display the 'time limit expiry message' for this many seconds before performing the 'time limit action' (defaults to 1 second if left blank)\"),\n        \"caption\"=>$clang->gT(\"Time limit expiry message display time\"));\n\n        $qattributes[\"time_limit_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>104,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The message to display when the time limit has expired (a default message will display if this setting is left blank)\"),\n        \"caption\"=>$clang->gT(\"Time limit expiry message\"));\n\n        $qattributes[\"time_limit_message_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>106,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS style for the 'time limit expiry message'\"),\n        \"caption\"=>$clang->gT(\"Time limit message CSS style\"));\n\n        $qattributes[\"time_limit_warning\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>108,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Display a 'time limit warning' when there are this many seconds remaining in the countdown (warning will not display if left blank)\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning message timer\"));\n\n        $qattributes[\"time_limit_warning_display_time\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>110,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"The 'time limit warning' will stay visible for this many seconds (will not turn off if this setting is left blank)\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning message display time\"));\n\n        $qattributes[\"time_limit_warning_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>112,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The message to display as a 'time limit warning' (a default warning will display if this is left blank)\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning message\"));\n\n        $qattributes[\"time_limit_warning_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>114,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS style used when the 'time limit warning' message is displayed\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning CSS style\"));\n\n        $qattributes[\"time_limit_warning_2\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>116,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Display the 2nd 'time limit warning' when there are this many seconds remaining in the countdown (warning will not display if left blank)\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning message timer\"));\n\n        $qattributes[\"time_limit_warning_2_display_time\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>118,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"The 2nd 'time limit warning' will stay visible for this many seconds (will not turn off if this setting is left blank)\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning message display time\"));\n\n        $qattributes[\"time_limit_warning_2_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>120,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The 2nd message to display as a 'time limit warning' (a default warning will display if this is left blank)\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning message\"));\n\n        $qattributes[\"time_limit_warning_2_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>122,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS style used when the 2nd 'time limit warning' message is displayed\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning CSS style\"));\n\n        $qattributes[\"date_format\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"text\",\n        \"help\"=>$clang->gT(\"Specify a custom date/time format (the <i>d/dd m/mm yy/yyyy H/HH M/MM</i> formats and \\\"-./: \\\" characters are allowed for day/month/year/hour/minutes without or with leading zero respectively. Defaults to survey's date format\"),\n        \"caption\"=>$clang->gT(\"Date/Time format\"));\n\n        $qattributes[\"dropdown_dates_minute_step\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"integer\",\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Minute step interval when using select boxes\"),\n        \"caption\"=>$clang->gT(\"Minute step interval\"));\n\n        $qattributes[\"dropdown_dates_month_style\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('Short names'),\n        1=>$clang->gT('Full names'),\n        2=>$clang->gT('Numbers')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Change the display style of the month when using select boxes\"),\n        \"caption\"=>$clang->gT(\"Month display style\"));\n\n        $qattributes[\"show_title\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('File metadata'),\n        'sortorder'=>124,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Is the participant required to give a title to the uploaded file?\"),\n        \"caption\"=>$clang->gT(\"Show title\"));\n\n        $qattributes[\"show_comment\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('File metadata'),\n        'sortorder'=>126,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Is the participant required to give a comment to the uploaded file?\"),\n        \"caption\"=>$clang->gT(\"Show comment\"));\n\n\n        $qattributes[\"max_filesize\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>128,\n        \"inputtype\"=>\"integer\",\n        'default'=>10240,\n        \"help\"=>$clang->gT(\"The participant cannot upload a single file larger than this size\"),\n        \"caption\"=>$clang->gT(\"Maximum file size allowed (in KB)\"));\n\n        $qattributes[\"max_num_of_files\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>130,\n        \"inputtype\"=>\"text\",\n        'default'=>'1',\n        \"help\"=>$clang->gT(\"Maximum number of files that the participant can upload for this question\"),\n        \"caption\"=>$clang->gT(\"Max number of files\"));\n\n        $qattributes[\"min_num_of_files\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>132,\n        \"inputtype\"=>\"text\",\n        'default'=>'0',\n        \"help\"=>$clang->gT(\"Minimum number of files that the participant must upload for this question\"),\n        \"caption\"=>$clang->gT(\"Min number of files\"));\n\n        $qattributes[\"allowed_filetypes\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>134,\n        \"inputtype\"=>\"text\",\n        'default'=>\"png, gif, doc, odt\",\n        \"help\"=>$clang->gT(\"Allowed file types in comma separated format. e.g. pdf,doc,odt\"),\n        \"caption\"=>$clang->gT(\"Allowed file types\"));\n\n        $qattributes[\"random_group\"]=array(\n        \"types\"=>\"15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>180,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT(\"Place questions into a specified randomization group, all questions included in the specified group will appear in a random order\"),\n        \"caption\"=>$clang->gT(\"Randomization group name\"));\n\n        // This is added to support historical behavior.  Early versions of 1.92 used a value of \"No\", so if there was a min_sum_value or equals_sum_value, the question was not valid\n        // unless those criteria were met.  In later releases of 1.92, the default was changed so that missing values were allowed even if those attributes were set\n        // This attribute lets authors control whether missing values should be allowed in those cases without needing to set min_answers\n        // Existing surveys will use the old behavior, but if the author edits the question, the default will be the new behavior.\n        $qattributes[\"value_range_allows_missing\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Is no answer (missing) allowed when either 'Equals sum value' or 'Minimum sum value' are set?\"),\n        \"caption\"=>$clang->gT(\"Value range allows missing\"));\n    }\n    //This builds a more useful array (don't modify)\n    if ($returnByName==false)\n    {\n        if(!$qat)\n        {\n            foreach($qattributes as $qname=>$qvalue)\n            {\n                for ($i=0; $i<=strlen($qvalue['types'])-1; $i++)\n                {\n                    $qat[substr($qvalue['types'], $i, 1)][$qname]=array(\"name\"=>$qname,\n                    \"inputtype\"=>$qvalue['inputtype'],\n                    \"category\"=>$qvalue['category'],\n                    \"sortorder\"=>$qvalue['sortorder'],\n                    \"i18n\"=>isset($qvalue['i18n'])?$qvalue['i18n']:false,\n                    \"readonly\"=>isset($qvalue['readonly_when_active'])?$qvalue['readonly_when_active']:false,\n                    \"options\"=>isset($qvalue['options'])?$qvalue['options']:'',\n                    \"default\"=>isset($qvalue['default'])?$qvalue['default']:'',\n                    \"help\"=>$qvalue['help'],\n                    \"caption\"=>$qvalue['caption']);\n                }\n            }\n        }\n        return $qat;\n    }\n    else {\n        return $qattributes;\n    }\n}\n\nfunction categorySort($a, $b)\n{\n    $result=strnatcasecmp($a['category'], $b['category']);\n    if ($result==0)\n    {\n        $result=$a['sortorder']-$b['sortorder'];\n    }\n    return $result;\n}\n\n// make sure the given string (which comes from a POST or GET variable)\n// is safe to use in MySQL.  This does nothing if gpc_magic_quotes is on.\nfunction autoEscape($str) {\n    if (!get_magic_quotes_gpc()) {\n        return addslashes ($str);\n    }\n    return $str;\n}\n\n// the opposite of the above: takes a POST or GET variable which may or\n// may not have been 'auto-quoted', and return the *unquoted* version.\n// this is useful when the value is destined for a web page (eg) not\n// a SQL query.\nfunction autoUnescape($str) {\n    if (!isset($str)) {return null;};\n    if (!get_magic_quotes_gpc())\n        return $str;\n    return stripslashes($str);\n}\n\n// make a string safe to include in an HTML 'value' attribute.\nfunction HTMLEscape($str) {\n    // escape newline characters, too, in case we put a value from\n    // a TEXTAREA  into an <input type=\"hidden\"> value attribute.\n    return str_replace(array(\"\\x0A\",\"\\x0D\"),array(\"&#10;\",\"&#13;\"),\n    htmlspecialchars( $str, ENT_QUOTES ));\n}\n\n/**\n* Escapes a text value for db\n*\n* @param string $value\n* @return string\n*/\nfunction dbQuoteAll($value)\n{\n    return Yii::app()->db->quoteValue($value);\n}\n\n// make a string safe to include in a JavaScript String parameter.\nfunction javascriptEscape($str, $strip_tags=false, $htmldecode=false) {\n    $new_str ='';\n\n    if ($htmldecode==true) {\n        $str=html_entity_decode($str,ENT_QUOTES,'UTF-8');\n    }\n    if ($strip_tags==true)\n    {\n        $str=strip_tags($str);\n    }\n    return str_replace(array('\\'','\"', \"\\n\", \"\\r\"),\n    array(\"\\\\'\",'\\u0022', \"\\\\n\",'\\r'),\n    $str);\n}\n\n/**\n* This function mails a text $body to the recipient $to.\n* You can use more than one recipient when using a semikolon separated string with recipients.\n*\n* @param string $body Body text of the email in plain text or HTML\n* @param mixed $subject Email subject\n* @param mixed $to Array with several email addresses or single string with one email address\n* @param mixed $from\n* @param mixed $sitename\n* @param mixed $ishtml\n* @param mixed $bouncemail\n* @param mixed $attachment\n* @return bool If successful returns true\n*/\nfunction SendEmailMessage($body, $subject, $to, $from, $sitename, $ishtml=false, $bouncemail=null, $attachments=null, $customheaders=\"\")\n{\n\n    global $maildebug, $maildebugbody;\n\n    $clang = Yii::app()->lang;\n    $emailmethod = Yii::app()->getConfig('emailmethod');\n    $emailsmtphost = Yii::app()->getConfig(\"emailsmtphost\");\n    $emailsmtpuser = Yii::app()->getConfig(\"emailsmtpuser\");\n    $emailsmtppassword = Yii::app()->getConfig(\"emailsmtppassword\");\n    $emailsmtpdebug = Yii::app()->getConfig(\"emailsmtpdebug\");\n    $emailsmtpssl = Yii::app()->getConfig(\"emailsmtpssl\");\n    $defaultlang = Yii::app()->getConfig(\"defaultlang\");\n    $emailcharset = Yii::app()->getConfig(\"emailcharset\");\n\n    if ($emailcharset!='utf-8')\n    {\n        $body=mb_convert_encoding($body,$emailcharset,'utf-8');\n        $subject=mb_convert_encoding($subject,$emailcharset,'utf-8');\n        $sitename=mb_convert_encoding($sitename,$emailcharset,'utf-8');\n    }\n\n    if (!is_array($to)){\n        $to=array($to);\n    }\n\n\n\n    if (!is_array($customheaders) && $customheaders == '')\n    {\n        $customheaders=array();\n    }\n    if (Yii::app()->getConfig('demoMode'))\n    {\n        $maildebug=$clang->gT('Email was not sent because demo-mode is activated.');\n        $maildebugbody='';\n        return false;\n    }\n\n    if (is_null($bouncemail) )\n    {\n        $sender=$from;\n    }\n    else\n    {\n        $sender=$bouncemail;\n    }\n\n\n    require_once(APPPATH.'/third_party/phpmailer/class.phpmailer.php');\n    $mail = new PHPMailer;\n    if (!$mail->SetLanguage($defaultlang,APPPATH.'/third_party/phpmailer/language/'))\n    {\n        $mail->SetLanguage('en',APPPATH.'/third_party/phpmailer/language/');\n    }\n    $mail->CharSet = $emailcharset;\n    if (isset($emailsmtpssl) && trim($emailsmtpssl)!=='' && $emailsmtpssl!==0) {\n        if ($emailsmtpssl===1) {$mail->SMTPSecure = \"ssl\";}\n        else {$mail->SMTPSecure = $emailsmtpssl;}\n    }\n\n    $fromname='';\n    $fromemail=$from;\n    if (strpos($from,'<'))\n    {\n        $fromemail=substr($from,strpos($from,'<')+1,strpos($from,'>')-1-strpos($from,'<'));\n        $fromname=trim(substr($from,0, strpos($from,'<')-1));\n    }\n\n    $sendername='';\n    $senderemail=$sender;\n    if (strpos($sender,'<'))\n    {\n        $senderemail=substr($sender,strpos($sender,'<')+1,strpos($sender,'>')-1-strpos($sender,'<'));\n        $sendername=trim(substr($sender,0, strpos($sender,'<')-1));\n    }\n\n    switch ($emailmethod) {\n        case \"qmail\":\n            $mail->IsQmail();\n            break;\n        case \"smtp\":\n            $mail->IsSMTP();\n            if ($emailsmtpdebug>0)\n            {\n                $mail->SMTPDebug = $emailsmtpdebug;\n            }\n            if (strpos($emailsmtphost,':')>0)\n            {\n                $mail->Host = substr($emailsmtphost,0,strpos($emailsmtphost,':'));\n                $mail->Port = substr($emailsmtphost,strpos($emailsmtphost,':')+1);\n            }\n            else {\n                $mail->Host = $emailsmtphost;\n            }\n            $mail->Username =$emailsmtpuser;\n            $mail->Password =$emailsmtppassword;\n            if (trim($emailsmtpuser)!=\"\")\n            {\n                $mail->SMTPAuth = true;\n            }\n            break;\n        case \"sendmail\":\n            $mail->IsSendmail();\n            break;\n        default:\n            //Set to the default value to rule out incorrect settings.\n            $emailmethod=\"mail\";\n            $mail->IsMail();\n    }\n\n    $mail->SetFrom($fromemail, $fromname);\n    $mail->Sender = $senderemail; // Sets Return-Path for error notifications\n    foreach ($to as $singletoemail)\n    {\n        if (strpos($singletoemail, '<') )\n        {\n            $toemail=substr($singletoemail,strpos($singletoemail,'<')+1,strpos($singletoemail,'>')-1-strpos($singletoemail,'<'));\n            $toname=trim(substr($singletoemail,0, strpos($singletoemail,'<')-1));\n            $mail->AddAddress($toemail,$toname);\n        }\n        else\n        {\n            $mail->AddAddress($singletoemail);\n        }\n    }\n    if (is_array($customheaders))\n    {\n        foreach ($customheaders as $key=>$val) {\n            $mail->AddCustomHeader($val);\n        }\n    }\n    $mail->AddCustomHeader(\"X-Surveymailer: $sitename Emailer (LimeSurvey.sourceforge.net)\");\n    if (get_magic_quotes_gpc() != \"0\")    {$body = stripcslashes($body);}\n    if ($ishtml)\n    {\n        $mail->IsHTML(true);\n        //$mail->AltBody = strip_tags(breakToNewline(html_entity_decode($body,ENT_QUOTES,$emailcharset))); // Use included PHPmailer system see bug #8234\n    }\n    else\n    {\n        $mail->IsHTML(false);\n    }\n    $mail->Body = $body;\n    // Add attachments if they are there.\n    if (is_array($attachments))\n    {\n        foreach ($attachments as $attachment)\n        {\n            // Attachment is either an array with filename and attachment name.\n            if (is_array($attachment))\n            {\n                $mail->AddAttachment($attachment[0], $attachment[1]);\n            }\n            else \n            { // Or a string with the filename.\n                $mail->AddAttachment($attachment);\n            }\n        }\n    }\n\n    if (trim($subject)!='') {$mail->Subject = \"=?$emailcharset?B?\" . base64_encode($subject) . \"?=\";}\n    if ($emailsmtpdebug>0) {\n        ob_start();\n    }\n    $sent=$mail->Send();\n    $maildebug=$mail->ErrorInfo;\n    if ($emailsmtpdebug>0) {\n        $maildebug .= '<li>'. gT('SMTP debug output:').'</li><pre>'.strip_tags(ob_get_contents()).'</pre>';\n        ob_end_clean();\n    }\n    $maildebugbody=$mail->Body;\n    //if(!$sent) var_dump($maildebug);\n    return $sent;\n}\n\n\n/**\n*  This functions removes all HTML tags, Javascript, CRs, linefeeds and other strange chars from a given text\n*\n* @param string $sTextToFlatten  Text you want to clean\n* @param boolan $keepSpan set to true for keep span, used for expression manager. Default: false\n* @param boolan $bDecodeHTMLEntities If set to true then all HTML entities will be decoded to the specified charset. Default: false\n* @param string $sCharset Charset to decode to if $decodeHTMLEntities is set to true. Default: UTF-8\n* @param string $bStripNewLines strip new lines if true, if false replace all new line by \\r\\n. Default: true\n*\n* @return string  Cleaned text\n*/\nfunction flattenText($sTextToFlatten, $keepSpan=false, $bDecodeHTMLEntities=false, $sCharset='UTF-8', $bStripNewLines=true)\n{\n    $sNicetext = stripJavaScript($sTextToFlatten);\n    // When stripping tags, add a space before closing tags so that strings with embedded HTML tables don't get concatenated\n    $sNicetext = str_replace(array('</td','</th'),array(' </td',' </th'), $sNicetext);\n    if ($keepSpan) {\n        // Keep <span> so can show EM syntax-highlighting; add space before tags so that word-wrapping not destroyed when remove tags.\n        $sNicetext = strip_tags($sNicetext,'<span><table><tr><td><th>');\n    }\n    else {\n        $sNicetext = strip_tags($sNicetext);\n    }\n    // ~\\R~u : see \"What \\R matches\" and \"Newline sequences\" in http://www.pcre.org/pcre.txt - only available since PCRE 7.0\n    if ($bStripNewLines ){  // strip new lines\n        if (version_compare(substr(PCRE_VERSION,0,strpos(PCRE_VERSION,' ')),'7.0')>-1)\n        {\n            $sNicetext = preg_replace(array('~\\R~u'),array(' '), $sNicetext);\n        }\n        else\n        {\n            // Poor man's replacement for line feeds\n            $sNicetext = str_replace(array(\"\\r\\n\",\"\\n\", \"\\r\"), array(' ',' ',' '), $sNicetext);\n        }\n    }\n    elseif (version_compare(substr(PCRE_VERSION,0,strpos(PCRE_VERSION,' ')),'7.0')>-1)// unify newlines to \\r\\n\n    {\n        $sNicetext = preg_replace(array('~\\R~u'), array(\"\\r\\n\"), $sNicetext);\n    }\n    if ($bDecodeHTMLEntities==true)\n    {\n        $sNicetext = str_replace('&nbsp;',' ', $sNicetext); // html_entity_decode does not convert &nbsp; to spaces\n        $sNicetext = html_entity_decode($sNicetext, ENT_QUOTES, $sCharset);\n    }\n    $sNicetext = trim($sNicetext);\n    return  $sNicetext;\n}\n\n\n/**\n* getArrayFilterExcludesCascadesForGroup() queries the database and produces a list of array_filter_exclude questions and targets with in the same group\n* @return returns a keyed nested array, keyed by the qid of the question, containing cascade information\n*/\nfunction getArrayFilterExcludesCascadesForGroup($surveyid, $gid=\"\", $output=\"qid\")\n{\n    $surveyid=sanitize_int($surveyid);\n    $gid=sanitize_int($gid);\n\n    $cascaded=array();\n    $sources=array();\n    $qidtotitle=array();\n    $fieldmap = createFieldMap($surveyid,'full',false,false,getBaseLanguageFromSurveyID($surveyid));\n\n    if($gid != \"\") {\n        $qrows = arraySearchByKey($gid, $fieldmap, 'gid');\n    } else {\n        $qrows = $fieldmap;\n    }\n    $grows = array(); //Create an empty array in case query not return any rows\n    // Store each result as an array with in the $grows array\n    foreach ($qrows as $qrow) {\n        if (isset($qrow['gid']) && !empty($qrow['gid'])) {\n            $grows[$qrow['qid']] = array('qid' => $qrow['qid'],'type' => $qrow['type'], 'mandatory' => $qrow['mandatory'], 'title' => $qrow['title'], 'gid' => $qrow['gid']);\n        }\n    }\n    $attrmach = array(); // Stores Matches of filters that have their values as questions within current group\n    foreach ($grows as $qrow) // Cycle through questions to see if any have list_filter attributes\n    {\n        $qidtotitle[$qrow['qid']]=$qrow['title'];\n        $qresult = getQuestionAttributeValues($qrow['qid'],$qrow['type']);\n        if (isset($qresult['array_filter_exclude'])) // We Found a array_filter attribute\n        {\n            $val = $qresult['array_filter_exclude']; // Get the Value of the Attribute ( should be a previous question's title in same group )\n            foreach ($grows as $avalue) // Cycle through all the other questions in this group until we find the source question for this array_filter\n            {\n                if ($avalue['title'] == $val)\n                {\n                    /* This question ($avalue) is the question that provides the source information we use\n                    * to determine which answers show up in the question we're looking at, which is $qrow['qid']\n                    * So, in other words, we're currently working on question $qrow['qid'], trying to find out more\n                    * information about question $avalue['qid'], because that's the source */\n                    $sources[$qrow['qid']]=$avalue['qid']; /* This question ($qrow['qid']) relies on answers in $avalue['qid'] */\n                    if(isset($cascades)) {unset($cascades);}\n                    $cascades=array();                     /* Create an empty array */\n\n                    /* At this stage, we know for sure that this question relies on one other question for the filter */\n                    /* But this function wants to send back information about questions that rely on multiple other questions for the filter */\n                    /* So we don't want to do anything yet */\n\n                    /* What we need to do now, is check whether the question this one relies on, also relies on another */\n\n                    /* The question we are now checking is $avalue['qid'] */\n                    $keepgoing=1;\n                    $questiontocheck=$avalue['qid'];\n                    /* If there is a key in the $sources array that is equal to $avalue['qid'] then we want to add that\n                    * to the $cascades array */\n                    while($keepgoing > 0)\n                    {\n                        if(!empty($sources[$questiontocheck]))\n                        {\n                            $cascades[] = $sources[$questiontocheck];\n                            /* Now we need to move down the chain */\n                            /* We want to check the $sources[$questiontocheck] question */\n                            $questiontocheck=$sources[$questiontocheck];\n                        } else {\n                            /* Since it was empty, there must not be any more questions down the cascade */\n                            $keepgoing=0;\n                        }\n                    }\n                    /* Now add all that info */\n                    if(count($cascades) > 0) {\n                        $cascaded[$qrow['qid']]=$cascades;\n                    }\n                }\n            }\n        }\n    }\n    $cascade2=array();\n    if($output == \"title\")\n    {\n        foreach($cascaded as $key=>$cascade) {\n            foreach($cascade as $item)\n            {\n                $cascade2[$key][]=$qidtotitle[$item];\n            }\n        }\n        $cascaded=$cascade2;\n    }\n    return $cascaded;\n}\n\n\n\n/**\n* getArrayFiltersForQuestion($qid) finds out if a question has an array_filter attribute and what codes where selected on target question\n* @return returns an array of codes that were selected else returns false\n*/\nfunction getArrayFiltersForQuestion($qid)\n{\n    static $cache = array();\n\n    // TODO: Check list_filter values to make sure questions are previous?\n    $qid=sanitize_int($qid);\n    if (isset($cache[$qid])) return $cache[$qid];\n\n    $attributes = getQuestionAttributeValues($qid);\n    if (isset($attributes['array_filter']) && Yii::app()->session['fieldarray']) {\n        $val = $attributes['array_filter']; // Get the Value of the Attribute ( should be a previous question's title in same group )\n        foreach (Yii::app()->session['fieldarray'] as $fields)\n        {\n            if ($fields[2] == $val)\n            {\n                // we found the target question, now we need to know what the answers where, we know its a multi!\n                $fields[0]=sanitize_int($fields[0]);\n                //$query = \"SELECT title FROM \".db_table_name('questions').\" where parent_qid='{$fields[0]}' AND language='\".Yii::app()->session[$surveyid]['s_lang'].\"' order by question_order\";\n                $qresult=Question::model()->findAllByAttributes(array(\"parent_qid\"=> $fields[0], \"language\"=> Yii::app()->session[$surveyid]['s_lang']), array('order' => \"question_order\"));\n                $selected = array();\n                //while ($code = $qresult->fetchRow())\n                foreach ($qresult->readAll() as $code)\n                {\n                    if (Yii::app()->session[$fields[1].$code['title']] == \"Y\"\n                    || Yii::app()->session[$fields[1]] == $code['title'])             array_push($selected,$code['title']);\n                }\n\n                //Now we also need to find out if (a) the question had \"other\" enabled, and (b) if that was selected\n                //$query = \"SELECT other FROM \".db_table_name('questions').\" where qid='{$fields[0]}'\";\n                $qresult=Question::model()->findAllByAttributes(array(\"qid\"=>$fields[0]));\n                foreach ($qresult->readAll() as $row) {$other=$row['other'];}\n                if($other == \"Y\")\n                {\n                    if(Yii::app()->session[$fields[1].'other'] && Yii::app()->session[$fields[1].'other'] !=\"\") {array_push($selected, \"other\");}\n                }\n                $cache[$qid] = $selected;\n                return $cache[$qid];\n            }\n        }\n        $cache[$qid] = false;\n        return $cache[$qid];\n    }\n    $cache[$qid] = false;\n    return $cache[$qid];\n}\n\n/**\n* getGroupsByQuestion($surveyid)\n* @return returns a keyed array of groups to questions ie: array([1]=>[2]) question qid 1, is in group gid 2.\n*/\nfunction getGroupsByQuestion($surveyid) {\n    $output=array();\n\n    $surveyid=sanitize_int($surveyid);\n    $result=Question::model()->findAllByAttributes(array(\"sid\"=>$surveyid));\n\n    foreach ($qresult->readAll() as $val)\n    {\n        $output[$val['qid']]=$val['gid'];\n    }\n    return $output;\n}\n\n\n/**\n* getArrayFilterExcludesForQuestion($qid) finds out if a question has an array_filter_exclude attribute and what codes where selected on target question\n* @return returns an array of codes that were selected else returns false\n*/\nfunction getArrayFilterExcludesForQuestion($qid)\n{\n    static $cascadesCache = array();\n    static $cache = array();\n\n    // TODO: Check list_filter values to make sure questions are previous?\n    //    $surveyid = Yii::app()->getConfig('sid');\n    $surveyid=returnGlobal('sid');\n    $qid=sanitize_int($qid);\n\n    if (isset($cache[$qid])) return $cache[$qid];\n\n    $attributes = getQuestionAttributeValues($qid);\n    $excludevals=array();\n    if (isset($attributes['array_filter_exclude'])) // We Found a array_filter_exclude attribute\n    {\n        $selected=array();\n        $excludevals[] = $attributes['array_filter_exclude']; // Get the Value of the Attribute ( should be a previous question's title in same group )\n        /* Find any cascades and place them in the $excludevals array*/\n        if (!isset($cascadesCache[$surveyid])) {\n            $cascadesCache[$surveyid] = getArrayFilterExcludesCascadesForGroup($surveyid, \"\", \"title\");\n        }\n        $array_filterXqs_cascades = $cascadesCache[$surveyid];\n\n        if(isset($array_filterXqs_cascades[$qid]))\n        {\n            foreach($array_filterXqs_cascades[$qid] as $afc)\n            {\n                $excludevals[]=array(\"value\"=>$afc);\n\n            }\n        }\n        /* For each $val (question title) that applies to this, check what values exist and add them to the $selected array */\n        foreach ($excludevals as $val)\n        {\n            foreach (Yii::app()->session['fieldarray'] as $fields) //iterate through every question in the survey\n            {\n                if ($fields[2] == $val)\n                {\n                    // we found the target question, now we need to know what the answers were!\n                    $fields[0]=sanitize_int($fields[0]);\n                    $query = \"SELECT title FROM {{questions}} where parent_qid='{$fields[0]}' AND language='\".Yii::app()->session[$surveyid]['s_lang'].\"' order by question_order\";\n                    $qresult = dbExecuteAssoc($query);  //Checked\n                    foreach ($qresult->readAll() as $code)\n                    {\n                        if (isset(Yii::app()->session[$fields[1]]))\n                            if ((isset(Yii::app()->session[$fields[1].$code['title']]) && Yii::app()->session[$fields[1].$code['title']] == \"Y\")\n                            || Yii::app()->session[$fields[1]] == $code['title'])\n                                array_push($selected,$code['title']);\n                    }\n                    //Now we also need to find out if (a) the question had \"other\" enabled, and (b) if that was selected\n                    $query = \"SELECT other FROM {{questions}} where qid='{$fields[0]}'\";\n                    $qresult = dbExecuteAssoc($query);\n                    foreach ($qresult->readAll() as $row) {$other=$row['other'];}\n                    if($other == \"Y\")\n                    {\n                        if(Yii::app()->session[$fields[1].'other'] != \"\") {array_push($selected, \"other\");}\n                    }\n                }\n            }\n        }\n        if(count($selected) > 0)\n        {\n            $cache[$qid] = $selected;\n            return $cache[$qid];\n        } else {\n            $cache[$qid] = false;\n            return $cache[$qid];\n        }\n    }\n    $cache[$qid] = false;\n    return $cache[$qid];\n}\n\n\n\nfunction CSVEscape($sString)\n{\n    $sString = preg_replace(array('~\\R~u'), array(PHP_EOL), $sString);\n    return '\"' . str_replace('\"','\"\"', $sString) . '\"';\n}\n\nfunction convertCSVRowToArray($string, $separator, $quotechar)\n{\n    $fields=preg_split('/' . $separator . '(?=([^\"]*\"[^\"]*\")*(?![^\"]*\"))/',trim($string));\n    $fields=array_map('CSVUnquote',$fields);\n    return $fields;\n}\n\nfunction createPassword()\n{\n    $aCharacters = \"ABCDEGHJIKLMNOPQURSTUVWXYZabcdefhjmnpqrstuvwxyz23456789\";\n    $iPasswordLength = 12;\n    $sPassword = '';\n    for ($i=0; $i<$iPasswordLength; $i++)\n    {\n        $sPassword .= $aCharacters[(int)floor(rand(0,strlen($aCharacters)-1))];\n    }\n    return $sPassword;\n}\n\nfunction languageDropdown($surveyid,$selected)\n{\n\n    $homeurl = Yii::app()->getConfig('homeurl');\n    $slangs = Survey::model()->findByPk($surveyid)->additionalLanguages;\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    array_unshift($slangs,$baselang);\n    $html = \"<select class='listboxquestions' name='langselect' onchange=\\\"window.open(this.options[this.selectedIndex].value, '_top')\\\">\\n\";\n\n    foreach ($slangs as $lang)\n    {\n        $link = Yii::app()->homeUrl.(\"/admin/dataentry/sa/view/surveyid/\".$surveyid.\"/lang/\".$lang);\n        if ($lang == $selected) $html .= \"\\t<option value='{$link}' selected='selected'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n        if ($lang != $selected) $html .= \"\\t<option value='{$link}'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n    }\n    $html .= \"</select>\";\n    return $html;\n}\n\nfunction languageDropdownClean($surveyid,$selected)\n{\n    $slangs = Survey::model()->findByPk($surveyid)->additionalLanguages;\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    array_unshift($slangs,$baselang);\n    $html = \"<select class='listboxquestions' id='language' name='language'>\\n\";\n    foreach ($slangs as $lang)\n    {\n        if ($lang == $selected) $html .= \"\\t<option value='$lang' selected='selected'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n        if ($lang != $selected) $html .= \"\\t<option value='$lang'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n    }\n    $html .= \"</select>\";\n    return $html;\n}\n\n/**\n* This function removes a directory recursively\n*\n* @param mixed $dirname\n* @return bool\n*/\nfunction rmdirr($dirname)\n{\n    // Sanity check\n    if (!file_exists($dirname)) {\n        return false;\n    }\n\n    // Simple delete for a file\n    if (is_file($dirname) || is_link($dirname)) {\n        return @unlink($dirname);\n    }\n\n    // Loop through the folder\n    $dir = dir($dirname);\n    while (false !== $entry = $dir->read()) {\n        // Skip pointers\n        if ($entry == '.' || $entry == '..') {\n            continue;\n        }\n\n        // Recurse\n        rmdirr($dirname . DIRECTORY_SEPARATOR . $entry);\n    }\n\n    // Clean up\n    $dir->close();\n    return @rmdir($dirname);\n}\n\n/**\n* This function removes surrounding and masking quotes from the CSV field\n*\n* @param mixed $field\n* @return mixed\n*/\nfunction CSVUnquote($field)\n{\n    //print $field.\":\";\n    $field = preg_replace (\"/^\\040*\\\"/\", \"\", $field);\n    $field = preg_replace (\"/\\\"\\040*$/\", \"\", $field);\n    $field= str_replace('\"\"','\"',$field);\n    //print $field.\"\\n\";\n    return $field;\n}\n\n/**\n* This function return actual completion state\n*\n* @return string (complete|incomplete|all) or false\n*/\nfunction incompleteAnsFilterState()\n{\n    $letsfilter='';\n    $letsfilter = returnGlobal('completionstate'); //read get/post completionstate\n\n    // first let's initialize the incompleteanswers session variable\n    if ($letsfilter != '')\n    { // use the read value if not empty\n        Yii::app()->session['incompleteanswers'] = $letsfilter;\n    }\n    elseif (empty(Yii::app()->session['incompleteanswers']))\n    { // sets default variable value from config file\n        Yii::app()->session['incompleteanswers'] = Yii::app()->getConfig('filterout_incomplete_answers');\n    }\n\n    if  (Yii::app()->session['incompleteanswers']=='complete' || Yii::app()->session['incompleteanswers']=='all' || Yii::app()->session['incompleteanswers']=='incomplete') {\n        return Yii::app()->session['incompleteanswers'];\n    }\n    else\n    { // last resort is to prevent filtering\n        return false;\n    }\n}\n\n\n/**\n* isCaptchaEnabled($screen, $usecaptchamode)\n* @param string $screen - the screen name for which to test captcha activation\n*\n* @return boolean - returns true if captcha must be enabled\n**/\nfunction isCaptchaEnabled($screen, $captchamode='')\n{\n    switch($screen)\n    {\n        case 'registrationscreen':\n            if ($captchamode == 'A' ||\n            $captchamode == 'B' ||\n            $captchamode == 'D' ||\n            $captchamode == 'R')\n            {\n                return true;\n            }\n            else\n            {\n                return false;\n            }\n            break;\n        case 'surveyaccessscreen':\n            if ($captchamode == 'A' ||\n            $captchamode == 'B' ||\n            $captchamode == 'C' ||\n            $captchamode == 'X')\n            {\n                return true;\n            }\n            else\n            {\n                return false;\n            }\n            break;\n        case 'saveandloadscreen':\n            if ($captchamode == 'A' ||\n            $captchamode == 'C' ||\n            $captchamode == 'D' ||\n            $captchamode == 'S')\n            {\n                return true;\n            }\n            else\n            {\n                return false;\n            }\n            return true;\n            break;\n        default:\n            return true;\n            break;\n    }\n}\n\n/**\n* used for import[survey|questions|groups]\n*\n* @param mixed $string\n* @return mixed\n*/\nfunction convertCSVReturnToReturn($string)\n{\n    $string= str_replace('\\n', \"\\n\", $string);\n    return str_replace('\\%n', '\\n', $string);\n}\n\n/**\n* Check if a table does exist in the database\n*\n* @param string $sTableName Table name to check for (without dbprefix!))\n* @return boolean True or false if table exists or not\n*/\nfunction tableExists($sTableName)\n{\n    $sTableName=Yii::app()->db->tablePrefix.str_replace(array('{','}'),array('',''),$sTableName);\n    return in_array($sTableName,Yii::app()->db->schema->getTableNames());\n}\n\n// Returns false if the survey is anonymous,\n// and a token table exists: in this case the completed field of a token\n// will contain 'Y' instead of the submitted date to ensure privacy\n// Returns true otherwise\nfunction isTokenCompletedDatestamped($thesurvey)\n{\n    if ($thesurvey['anonymized'] == 'Y' &&  tableExists('tokens_'.$thesurvey['sid']))\n    {\n        return false;\n    }\n    else\n    {\n        return true;\n    }\n}\n\n/**\n* example usage\n* $date = \"2006-12-31 21:00\";\n* $shift \"+6 hours\"; // could be days, weeks... see function strtotime() for usage\n*\n* echo sql_date_shift($date, \"Y-m-d H:i:s\", $shift);\n*\n* will output: 2007-01-01 03:00:00\n*\n* @param mixed $date\n* @param mixed $dformat\n* @param mixed $shift\n* @return string\n*/\nfunction dateShift($date, $dformat, $shift)\n{\n    return date($dformat, strtotime($shift, strtotime($date)));\n}\n\n\n// getBounceEmail: returns email used to receive error notifications\nfunction getBounceEmail($surveyid)\n{\n    $surveyInfo=getSurveyInfo($surveyid);\n\n    if ($surveyInfo['bounce_email'] == '')\n    {\n        return null; // will be converted to from in MailText\n    }\n    else\n    {\n        return $surveyInfo['bounce_email'];\n    }\n}\n\n// getEmailFormat: returns email format for the survey\n// returns 'text' or 'html'\nfunction getEmailFormat($surveyid)\n{\n    $surveyInfo=getSurveyInfo($surveyid);\n    if ($surveyInfo['htmlemail'] == 'Y')\n    {\n        return 'html';\n    }\n    else\n    {\n        return 'text';\n    }\n\n}\n\n// Check if user has manage rights for a template\nfunction hasTemplateManageRights($userid, $templatefolder) {\n    $userid=sanitize_int($userid);\n    $templatefolder=sanitize_paranoid_string($templatefolder);\n    return Permission::model()->hasTemplatePermission($templatefolder, 'read', $userid);\n}\n\n/**\n* This function creates an incrementing answer code based on the previous source-code\n*\n* @param mixed $sourcecode The previous answer code\n*/\nfunction getNextCode($sourcecode)\n{\n    $i=1;\n    $found=true;\n    $foundnumber=-1;\n    while ($i<=strlen($sourcecode) && $found)\n    {\n        $found=is_numeric(substr($sourcecode,-$i));\n        if ($found)\n        {\n            $foundnumber=substr($sourcecode,-$i);\n            $i++;\n        }\n    }\n    if ($foundnumber==-1)\n    {\n        return($sourcecode);\n    }\n    else\n    {\n        $foundnumber++;\n        $result=substr($sourcecode,0,strlen($sourcecode)-strlen($foundnumber)).$foundnumber;\n        return($result);\n    }\n\n}\n\n/**\n* Translate links which are in any answer/question/survey/email template/label set to their new counterpart\n*\n* @param mixed $sType 'survey' or 'label'\n* @param mixed $iOldSurveyID\n* @param mixed $iNewSurveyID\n* @param mixed $sString\n* @return string\n*/\nfunction translateLinks($sType, $iOldSurveyID, $iNewSurveyID, $sString)\n{\n    if ($sType == 'survey')\n    {\n        $sPattern = \"([^'\\\"]*)/upload/surveys/{$iOldSurveyID}/\";\n        $sReplace = Yii::app()->getConfig(\"publicurl\").\"upload/surveys/{$iNewSurveyID}/\";\n        return preg_replace('#'.$sPattern.'#', $sReplace, $sString);\n    }\n    elseif ($sType == 'label')\n    {\n        $pattern = \"([^'\\\"]*)/upload/labels/{$iOldSurveyID}/\";\n        $replace = Yii::app()->getConfig(\"publicurl\").\"upload/labels/{$iNewSurveyID}/\";\n        return preg_replace('#'.$pattern.'#', $replace, $sString);\n    }\n    else // unkown type\n    {\n        return $sString;\n    }\n}\n\n/**\n* This function creates the old fieldnames for survey import\n*\n* @param mixed $iOldSID  The old survey id\n* @param mixed $iNewSID  The new survey id\n* @param array $aGIDReplacements An array with group ids (oldgid=>newgid)\n* @param array $aQIDReplacements An array with question ids (oldqid=>newqid)\n*/\nfunction reverseTranslateFieldNames($iOldSID,$iNewSID,$aGIDReplacements,$aQIDReplacements)\n{\n    $aGIDReplacements=array_flip($aGIDReplacements);\n    $aQIDReplacements=array_flip($aQIDReplacements);\n    if ($iOldSID==$iNewSID) {\n        $forceRefresh=true; // otherwise grabs the cached copy and throws undefined index exceptions\n    }\n    else {\n        $forceRefresh=false;\n    }\n    $aFieldMap = createFieldMap($iNewSID,'short',$forceRefresh,false,getBaseLanguageFromSurveyID($iNewSID));\n\n    $aFieldMappings=array();\n    foreach ($aFieldMap as $sFieldname=>$aFieldinfo)\n    {\n        if ($aFieldinfo['qid']!=null)\n        {\n            $aFieldMappings[$sFieldname]=$iOldSID.'X'.$aGIDReplacements[$aFieldinfo['gid']].'X'.$aQIDReplacements[$aFieldinfo['qid']].$aFieldinfo['aid'];\n            if ($aFieldinfo['type']=='1')\n            {\n                $aFieldMappings[$sFieldname]=$aFieldMappings[$sFieldname].'#'.$aFieldinfo['scale_id'];\n            }\n            // now also add a shortened field mapping which is needed for certain kind of condition mappings\n            $aFieldMappings[$iNewSID.'X'.$aFieldinfo['gid'].'X'.$aFieldinfo['qid']]=$iOldSID.'X'.$aGIDReplacements[$aFieldinfo['gid']].'X'.$aQIDReplacements[$aFieldinfo['qid']];\n            // Shortened field mapping for timings table\n            $aFieldMappings[$iNewSID.'X'.$aFieldinfo['gid']]=$iOldSID.'X'.$aGIDReplacements[$aFieldinfo['gid']];\n        }\n    }\n    return array_flip($aFieldMappings);\n}\n\n/**\n* put your comment there...\n*\n* @param mixed $id\n* @param mixed $type\n*/\nfunction hasResources($id,$type='survey')\n{\n    $dirname = Yii::app()->getConfig(\"uploaddir\");\n\n    if ($type == 'survey')\n    {\n        $dirname .= \"/surveys/$id\";\n    }\n    elseif ($type == 'label')\n    {\n        $dirname .= \"/labels/$id\";\n    }\n    else\n    {\n        return false;\n    }\n\n    if (is_dir($dirname) && $dh=opendir($dirname))\n    {\n        while(($entry = readdir($dh)) !== false)\n        {\n            if($entry !== '.' && $entry !== '..')\n            {\n                return true;\n                break;\n            }\n        }\n        closedir($dh);\n    }\n    else\n    {\n        return false;\n    }\n\n    return false;\n}\n\n/**\n* Creates a random sequence of characters\n*\n* @param mixed $length Length of resulting string\n* @param string $pattern To define which characters should be in the resulting string\n*/\nfunction randomChars($length,$pattern=\"23456789abcdefghijkmnpqrstuvwxyz\")\n{\n    $patternlength = strlen($pattern)-1;\n    $key = '';\n    for($i=0;$i<$length;$i++)\n    {\n        $key .= $pattern{mt_rand(0,$patternlength)};\n    }\n    return $key;\n}\n\n/**\n* used to translate simple text to html (replacing \\n with <br />\n*\n* @param mixed $mytext\n* @param mixed $ishtml\n* @return mixed\n*/\nfunction conditionalNewlineToBreak($mytext,$ishtml,$encoded='')\n{\n    if ($ishtml === true)\n    {\n        // $mytext has been processed by clang->gT with html mode\n        // and thus \\n has already been translated to &#10;\n        if ($encoded == '')\n        {\n            $mytext=str_replace('&#10;', '<br />',$mytext);\n        }\n        return str_replace(\"\\n\", '<br />',$mytext);\n    }\n    else\n    {\n        return $mytext;\n    }\n}\n\n\nfunction breakToNewline( $data ) {\n    return preg_replace( '!<br.*>!iU', \"\\n\", $data );\n}\n\nfunction safeDie($text)\n{\n    //Only allowed tag: <br />\n    $textarray=explode('<br />',$text);\n    $textarray=array_map('htmlspecialchars',$textarray);\n    die(implode( '<br />',$textarray));\n}\n\nfunction fixCKeditorText($str)\n{\n    $str = str_replace('<br type=\"_moz\" />','',$str);\n    if ($str == \"<br />\" || $str == \" \" || $str == \"&nbsp;\")\n    {\n        $str = \"\";\n    }\n    if (preg_match(\"/^[\\s]+$/\",$str))\n    {\n        $str='';\n    }\n    if ($str == \"\\n\")\n    {\n        $str = \"\";\n    }\n    if (trim($str) == \"&nbsp;\" || trim($str)=='')\n    { // chrome adds a single &nbsp; element to empty fckeditor fields\n        $str = \"\";\n    }\n\n    return $str;\n}\n\n\n/**\n* This is a helper function for getAttributeFieldNames\n*\n* @param mixed $fieldname\n*/\nfunction filterForAttributes ($fieldname)\n{\n    if (strpos($fieldname,'attribute_')===false) return false; else return true;\n}\n\n/**\n* Retrieves the attribute field names from the related token table\n*\n* @param mixed $iSurveyID  The survey ID\n* @return array The fieldnames\n*/\nfunction GetAttributeFieldNames($iSurveyID)\n{\n    if (!tableExists(\"{{tokens_{$iSurveyID}}}\") || !$table = Yii::app()->db->schema->getTable('{{tokens_'.$iSurveyID.'}}'))\n        return Array();\n\n    return array_filter(array_keys($table->columns), 'filterForAttributes');\n\n}\n\n/**\n* Returns the full list of attribute token fields including the properties for each field\n* Use this instead of plain Survey::model()->findByPk($iSurveyID)->tokenAttributes calls because Survey::model()->findByPk($iSurveyID)->tokenAttributes may contain old descriptions where the fields does not physically exist\n*\n* @param integer $iSurveyID The Survey ID\n*/\nfunction GetParticipantAttributes($iSurveyID)\n{\n    if (!tableExists(\"{{tokens_{$iSurveyID}}}\") || !$table = Yii::app()->db->schema->getTable('{{tokens_'.$iSurveyID.'}}'))\n        return Array();\n    return getTokenFieldsAndNames($iSurveyID,true);\n}\n\n\n\n\n\n/**\n* Retrieves the token field names usable for conditions from the related token table\n*\n* @param mixed $surveyid  The survey ID\n* @return array The fieldnames\n*/\nfunction getTokenConditionsFieldNames($surveyid)\n{\n    $extra_attrs=getAttributeFieldNames($surveyid);\n    $basic_attrs=Array('firstname','lastname','email','token','language','sent','remindersent','remindercount');\n    return array_merge($basic_attrs,$extra_attrs);\n}\n\n/**\n* Retrieves the attribute names from the related token table\n*\n* @param mixed $surveyid  The survey ID\n* @param boolean $bOnlyAttributes Set this to true if you only want the fieldnames of the additional attribue fields - defaults to false\n* @return array The fieldnames as key and names as value in an Array\n*/\nfunction getTokenFieldsAndNames($surveyid, $bOnlyAttributes = false)\n{\n    $clang = Yii::app()->lang;\n\n    $aBasicTokenFields=array('firstname'=>array(\n        'description'=>$clang->gT('First name'),\n        'mandatory'=>'N',\n        'showregister'=>'Y'\n        ),\n        'lastname'=>array(\n            'description'=>$clang->gT('Last name'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'email'=>array(\n            'description'=>$clang->gT('Email address'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'emailstatus'=>array(\n            'description'=>$clang->gT(\"Email status\"),\n            'mandatory'=>'N',\n            'showregister'=>'N'\n        ),\n        'token'=>array(\n            'description'=>$clang->gT('Token'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'language'=>array(\n            'description'=>$clang->gT('Language code'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'sent'=>array(\n            'description'=>$clang->gT('Invitation sent date'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'remindersent'=>array(\n            'description'=>$clang->gT('Last reminder sent date'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'remindercount'=>array(\n            'description'=>$clang->gT('Total numbers of sent reminders'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'usesleft'=>array(\n            'description'=>$clang->gT('Uses left'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n    );\n\n    $aExtraTokenFields=getAttributeFieldNames($surveyid);\n    $aSavedExtraTokenFields = Survey::model()->findByPk($surveyid)->tokenAttributes;\n\n    // Drop all fields that are in the saved field description but not in the table definition\n    $aSavedExtraTokenFields=array_intersect_key($aSavedExtraTokenFields,array_flip($aExtraTokenFields));\n\n    // Now add all fields that are in the table but not in the field description\n    foreach ($aExtraTokenFields as $sField)\n    {\n        if (!isset($aSavedExtraTokenFields[$sField]))\n        {\n            $aSavedExtraTokenFields[$sField]=array(\n            'description'=>$sField,\n            'mandatory'=>'N',\n            'showregister'=>'N',\n            'cpdbmap'=>''\n            );\n        }\n        elseif(empty($aSavedExtraTokenFields[$sField]['description']))\n        {\n            $aSavedExtraTokenFields[$sField]['description']=$sField;\n        }\n    }\n    if ($bOnlyAttributes)\n    {\n        return $aSavedExtraTokenFields;\n    }\n    else\n    {\n        return array_merge($aBasicTokenFields,$aSavedExtraTokenFields);\n    }\n}\n\n/**\n* Retrieves the token attribute value from the related token table\n*\n* @param mixed $surveyid  The survey ID\n* @param mixed $attrName  The token-attribute field name\n* @param mixed $token  The token code\n* @return string The token attribute value (or null on error)\n*/\nfunction getAttributeValue($surveyid,$attrName,$token)\n{\n    $attrName=strtolower($attrName);\n    if (!tableExists('tokens_'.$surveyid))\n    {\n        return null;\n    }\n\n    $token = Token::model($surveyid)->findByAttributes(array(\"token\"=>$token));\n    return isset($token->$attrName) ? $token->$attrName : null;\n}\n\n/**\n* This function strips any content between and including <javascript> tags\n*\n* @param string $sContent String to clean\n* @return string  Cleaned string\n*/\nfunction stripJavaScript($sContent){\n    $text = preg_replace('@<script[^>]*?>.*?</script>@si', '', $sContent);\n    return $text;\n}\n\n/**\n* This function converts emebedded Javascript to Text\n*\n* @param string $sContent String to clean\n* @return string  Cleaned string\n*/\nfunction showJavaScript($sContent){\n    $text = preg_replace_callback ('@<script[^>]*?>.*?</script>@si',         create_function(\n            // single quotes are essential here,\n            // or alternative escape all $ as \\$\n            '$matches',\n            'return htmlspecialchars($matches[0]);'\n        ), $sContent);\n    return $text;\n}\n\n/**\n* This function cleans files from the temporary directory being older than 1 day\n* @todo Make the days configurable\n*/\nfunction cleanTempDirectory()\n{\n    $dir =  Yii::app()->getConfig('tempdir').DIRECTORY_SEPARATOR;\n    $dp = opendir($dir) or show_error('Could not open temporary directory');\n    while ($file = readdir($dp)) {\n        if (is_file($dir.$file) && (filemtime($dir.$file)) < (strtotime('-1 days')) && $file!='index.html' && $file!='.gitignore' && $file!='readme.txt') {\n            @unlink($dir.$file);\n        }\n    }\n    $dir=  Yii::app()->getConfig('tempdir').DIRECTORY_SEPARATOR.'upload'.DIRECTORY_SEPARATOR;\n    $dp = opendir($dir) or die ('Could not open temporary upload directory');\n    while ($file = readdir($dp)) {\n        if (is_file($dir.$file) && (filemtime($dir.$file)) < (strtotime('-1 days')) && $file!='index.html' && $file!='.gitignore' && $file!='readme.txt') {\n            @unlink($dir.$file);\n        }\n    }\n    closedir($dp);\n}\n\nfunction useFirebug()\n{\n    if(FIREBUG == true)\n    {\n        App()->getClientScript()->registerScriptFile('http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js');\n    };\n};\n\n/**\n* This is a convenience function for the coversion of datetime values\n*\n* @param mixed $value\n* @param mixed $fromdateformat\n* @param mixed $todateformat\n* @return string\n*/\nfunction convertDateTimeFormat($value, $fromdateformat, $todateformat)\n{\n    Yii::import('application.libraries.Date_Time_Converter', true);\n    $date = new Date_Time_Converter($value, $fromdateformat);\n    return $date->convert($todateformat);\n}\n\n/**\n* This function removes the UTF-8 Byte Order Mark from a string\n*\n* @param string $str\n* @return string\n*/\nfunction removeBOM($str=\"\"){\n    if(substr($str, 0,3) == pack(\"CCC\",0xef,0xbb,0xbf)) {\n        $str=substr($str, 3);\n    }\n    return $str;\n}\n\n/**\n* This function requests the latest update information from the LimeSurvey.org website\n*\n* @returns array Contains update information or false if the request failed for some reason\n*/\n/**********************************************/\n/* This function needs ported still.          */\n/**********************************************/\nfunction getUpdateInfo()\n{\n    if (getGlobalSetting('SessionName')=='')\n    {\n        setGlobalSetting('SessionName',randomChars(64,'ABCDEFGHIJKLMNOPQRSTUVWXYZ!\"$%&/()=?`+*~#\",;.:abcdefghijklmnopqrstuvwxyz123456789'));\n    }\n    Yii::import('application.libraries.admin.http.httpRequestIt');\n    $http=new httpRequestIt;\n\n    $http->proxy_host_name = Yii::app()->getConfig(\"proxy_host_name\",\"\");\n    $http->proxy_host_port = Yii::app()->getConfig(\"proxy_host_port\",80);\n    $http->timeout=0;\n    $http->data_timeout=0;\n    $http->user_agent=\"LimeSurvey \".Yii::app()->getConfig(\"versionnumber\").\" build \".Yii::app()->getConfig(\"buildnumber\");\n    $http->GetRequestArguments(\"http://update.limesurvey.org?build=\".Yii::app()->getConfig(\"buildnumber\").'&id='.md5(getGlobalSetting('SessionName')).'&crosscheck=true',$arguments);\n\n    $updateinfo=false;\n    $error=$http->Open($arguments);\n    $error=$http->SendRequest($arguments);\n\n    $http->ReadReplyHeaders($headers);\n\n\n    if($error==\"\") {\n        $body=''; $full_body='';\n        for(;;){\n            $error = $http->ReadReplyBody($body,10000);\n            if($error != \"\" || strlen($body)==0) break;\n            $full_body .= $body;\n        }\n        $updateinfo=json_decode($full_body,true);\n        if ($http->response_status!='200')\n        {\n            $updateinfo['errorcode']=$http->response_status;\n            $updateinfo['errorhtml']=$full_body;\n        }\n    }\n    else\n    {\n        $updateinfo['errorcode']=$error;\n        $updateinfo['errorhtml']=$error;\n    }\n    unset( $http );\n    return $updateinfo;\n}\n\n/**\n* This function updates the actual global variables if an update is available after using getUpdateInfo\n* @return Array with update or error information\n*/\nfunction updateCheck()\n{\n    $aUpdateVersions=getUpdateInfo();\n    $clang = Yii::app()->lang;\n\n    if (isset($aUpdateVersions['errorcode'])) \n    {\n        Yii::app()->setFlashMessage(sprintf($clang->gT(\"Error when checking for new version: %s\"),$aUpdateVersions['errorcode']).'<br>'.$aUpdateVersions['errorhtml'],'error');\n        $aUpdateVersions=array(); \n    }\n    if (count($aUpdateVersions) && trim(Yii::app()->getConfig('buildnumber'))!='')\n    {\n        $sUpdateNotificationType = getGlobalSetting('updatenotification');\n        switch ($sUpdateNotificationType)\n        {\n            case 'stable':\n                // Only show update if in stable (master) branch\n                if (isset($aUpdateVersions['master'])) {\n                    $aUpdateVersion=$aUpdateVersions['master'];\n                    $aUpdateVersions=array_intersect_key($aUpdateVersions,array('master'=>'1'));\n                }\n                break;\n\n            case 'both':\n                // Show first available update\n                $aUpdateVersion=reset($aUpdateVersions);    \n                break;\n                \n            default:\n                // Never show a notification\n                $aUpdateVersions=array();\n                break;\n        }\n    }\n    \n    setGlobalSetting('updateversions',json_encode($aUpdateVersions));\n    \n    \n    if (isset($aUpdateVersion)) {\n        setGlobalSetting('updateavailable',1);\n        setGlobalSetting('updatebuild',$aUpdateVersion['build']);\n        setGlobalSetting('updateversion',$aUpdateVersion['versionnumber']);\n    } else {\n        setGlobalSetting('updateavailable',0);    \n        $aUpdateVersions = array();\n    }\n    \n    setGlobalSetting('updatelastcheck',date('Y-m-d H:i:s'));\n    return $aUpdateVersions;\n}\n\n/**\n* Return the goodchars to be used when filtering input for numbers.\n*\n* @param $lang     string    language used, for localisation\n* @param $integer    bool    use only integer\n* @param $negative    bool    allow negative values\n*/\nfunction getNumericalFormat($lang = 'en', $integer = false, $negative = true) {\n    $goodchars = \"0123456789\";\n    if ($integer === false) $goodchars .= \".\";    //Todo, add localisation\n    if ($negative === true) $goodchars .= \"-\";    //Todo, check databases\n    return $goodchars;\n}\n\n/**\n* This function returns the complete directory path to a given template name\n*\n* @param mixed $sTemplateName\n*/\nfunction getTemplatePath($sTemplateName = false)\n{\n    if (!$sTemplateName)\n    {\n        $sTemplateName=Yii::app()->getConfig('defaulttemplate'); // if $sTemplateName is NULL or false or \"\"\n    }\n    if (isStandardTemplate($sTemplateName))\n    {\n        return Yii::app()->getConfig(\"standardtemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName;\n    }\n    else\n    {\n        if (is_dir(Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName))\n        {\n            return Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName;\n        }\n        elseif (isStandardTemplate(Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"standardtemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName;\n        }\n        elseif (file_exists(Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.Yii::app()->getConfig('defaulttemplate');\n        }\n        else\n        {\n            return Yii::app()->getConfig(\"standardtemplaterootdir\").DIRECTORY_SEPARATOR.'default';\n        }\n    }\n}\n\n/**\n* This function returns the complete URL path to a given template name\n*\n* @param mixed $sTemplateName\n*/\nfunction getTemplateURL($sTemplateName)\n{\n    if (isStandardTemplate($sTemplateName))\n    {\n        return Yii::app()->getConfig(\"standardtemplaterooturl\").'/'.$sTemplateName;\n    }\n    else\n    {\n        if (file_exists(Yii::app()->getConfig(\"usertemplaterootdir\").'/'.$sTemplateName))\n        {\n            return Yii::app()->getConfig(\"usertemplaterooturl\").'/'.$sTemplateName;\n        }\n        elseif (file_exists(Yii::app()->getConfig(\"usertemplaterootdir\").'/'.Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"usertemplaterooturl\").'/'.Yii::app()->getConfig('defaulttemplate');\n        }\n        elseif (file_exists(Yii::app()->getConfig(\"standardtemplaterootdir\").'/'.Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"standardtemplaterooturl\").'/'.Yii::app()->getConfig('defaulttemplate');\n        }\n        else\n        {\n            return Yii::app()->getConfig(\"standardtemplaterooturl\").'/default';\n        }\n    }\n}\n\n/**\n* Return an array of subquestions for a given sid/qid\n*\n* @param int $sid\n* @param int $qid\n* @param $sLanguage Language of the subquestion text\n*/\nfunction getSubQuestions($sid, $qid, $sLanguage) {\n\n    static $subquestions;\n\n    if (!isset($subquestions[$sid]))\n    {\n        $subquestions[$sid]=array();\n    }\n    if (!isset($subquestions[$sid][$sLanguage])) {\n\n        $query = \"SELECT sq.*, q.other FROM {{questions}} as sq, {{questions}} as q\"\n        .\" WHERE sq.parent_qid=q.qid AND q.sid=\".$sid\n        .\" AND sq.language='\".$sLanguage. \"' \"\n        .\" AND q.language='\".$sLanguage. \"' \"\n        .\" ORDER BY sq.parent_qid, q.question_order,sq.scale_id , sq.question_order\";\n\n        $query = Yii::app()->db->createCommand($query)->query();\n\n        $resultset=array();\n        //while ($row=$result->FetchRow())\n        foreach ($query->readAll() as $row)\n        {\n            $resultset[$row['parent_qid']][] = $row;\n        }\n        $subquestions[$sid][$sLanguage] = $resultset;\n    }\n    if (isset($subquestions[$sid][$sLanguage][$qid])) return $subquestions[$sid][$sLanguage][$qid];\n    return array();\n}\n\n/**\n* Wrapper function to retrieve an xmlwriter object and do error handling if it is not compiled\n* into PHP\n*/\nfunction getXMLWriter() {\n    if (!extension_loaded('xmlwriter')) {\n        safeDie('XMLWriter class not compiled into PHP, please contact your system administrator');\n    } else {\n        $xmlwriter = new XMLWriter();\n    }\n    return $xmlwriter;\n}\n\n/**\n* SSLRedirect() generates a redirect URL for the appropriate SSL mode then applies it.\n* (Was redirect() before CodeIgniter port.)\n*\n* @param $enforceSSLMode string 's' or '' (empty).\n*/\nfunction SSLRedirect($enforceSSLMode)\n{\n    $url = 'http'.$enforceSSLMode.'://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];\n    if (!headers_sent())\n    {    // If headers not sent yet... then do php redirect\n        //ob_clean();\n        header('Location: '.$url);\n        //ob_flush();\n        exit;\n    };\n};\n\n/**\n* enforceSSLMode() $force_ssl is on or off, it checks if the current\n* request is to HTTPS (or not). If $force_ssl is on, and the\n* request is not to HTTPS, it redirects the request to the HTTPS\n* version of the URL, if the request is to HTTPS, it rewrites all\n* the URL variables so they also point to HTTPS.\n*/\nfunction enforceSSLMode()\n{\n    $bSSLActive = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != \"off\")||\n    (isset($_SERVER['HTTP_FORWARDED_PROTO']) && $_SERVER['HTTP_FORWARDED_PROTO']==\"https\")||\n    (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']==\"https\"));\n    if (Yii::app()->getConfig('ssl_emergency_override') !== true )\n    {\n        $force_ssl = strtolower(getGlobalSetting('force_ssl'));\n    }\n    else\n    {\n        $force_ssl = 'off';\n    };\n    if( $force_ssl == 'on' && !$bSSLActive )\n    {\n        SSLRedirect('s');\n    }\n    if( $force_ssl == 'off' && $bSSLActive)\n    {\n        SSLRedirect('');\n    };\n};\n\n/**\n* Returns the number of answers matching the quota\n*\n* @param int $iSurveyId - Survey identification number\n* @param int $quotaid - quota id for which you want to compute the completed field\n* @return mixed - Integer of matching entries in the result DB or 'N/A'\n*/\nfunction getQuotaCompletedCount($iSurveyId, $quotaid)\n{\n    $result = \"N/A\";\n    if(!tableExists(\"survey_{$iSurveyId}\")) // Yii::app()->db->schema->getTable('{{survey_' . $iSurveyId . '}}' are not updated even after Yii::app()->db->schema->refresh();\n        return $result;\n    $quota_info = getQuotaInformation($iSurveyId, Survey::model()->findByPk($iSurveyId)->language, $quotaid);\n    $quota = $quota_info[0];\n    if (Yii::app()->db->schema->getTable('{{survey_' . $iSurveyId . '}}') &&\n    count($quota['members']) > 0)\n    {\n        // Keep a list of fields for easy reference\n        $fields_list = array();\n\n        // Construct an array of value for each $quota['members']['fieldnames']\n        $fields_query = array();\n\n        foreach ($quota['members'] as $member)\n        {\n            $criteria = new CDbCriteria;\n\n            foreach ($member['fieldnames'] as $fieldname)\n            {\n                if (!in_array($fieldname, $fields_list))\n                    $fields_list[] = $fieldname;\n\n                // Yii does not quote column names (duh!) so we have to do it.\n                $criteria->addColumnCondition(array(Yii::app()->db->quoteColumnName($fieldname) => $member['value']), 'OR');\n            }\n\n            $fields_query[$fieldname] = $criteria;\n        }\n\n        $criteria = new CDbCriteria;\n\n        foreach ($fields_list as $fieldname)\n            $criteria->mergeWith($fields_query[$fieldname]);\n        $criteria->mergeWith(array('condition'=>\"submitdate IS NOT NULL\"));\n        $result = SurveyDynamic::model($iSurveyId)->count($criteria);\n    }\n\n    return $result;\n}\n\n/**\n* Creates an array with details on a particular response for display purposes\n* Used in Print answers, Detailed response view and Detailed admin notification email\n*\n* @param mixed $iSurveyID\n* @param mixed $iResponseID\n* @param mixed $sLanguageCode\n* @param boolean $bHonorConditions Apply conditions\n*/\nfunction getFullResponseTable($iSurveyID, $iResponseID, $sLanguageCode, $bHonorConditions=true)\n{\n    $aFieldMap = createFieldMap($iSurveyID,'full',false,false,$sLanguageCode);\n    $oLanguage = new Limesurvey_lang($sLanguageCode);\n\n    //Get response data\n    $idrow = SurveyDynamic::model($iSurveyID)->findByAttributes(array('id'=>$iResponseID));\n\n    // Create array of non-null values - those are the relevant ones\n    $aRelevantFields = array();\n\n    foreach ($aFieldMap as $sKey=>$fname)\n    {\n        if (LimeExpressionManager::QuestionIsRelevant($fname['qid']) || $bHonorConditions==false)\n        {\n            $aRelevantFields[$sKey]=$fname;\n        }\n    }\n\n    $aResultTable=array();\n    $oldgid = 0;\n    $oldqid = 0;\n    foreach ($aRelevantFields as $sKey=>$fname)\n    {\n        if (!empty($fname['qid']))\n        {\n            $attributes = getQuestionAttributeValues($fname['qid']);\n            if (getQuestionAttributeValue($attributes, 'hidden') == 1)\n            {\n                continue;\n            }\n        }\n        $question = $fname['question'];\n        $subquestion='';\n        if (isset($fname['gid']) && !empty($fname['gid'])) {\n            //Check to see if gid is the same as before. if not show group name\n            if ($oldgid !== $fname['gid'])\n            {\n                $oldgid = $fname['gid'];\n                if (LimeExpressionManager::GroupIsRelevant($fname['gid']) || $bHonorConditions==false) {\n                    $aResultTable['gid_'.$fname['gid']]=array($fname['group_name']);\n                }\n            }\n        }\n        if (!empty($fname['qid']))\n        {\n            if ($oldqid !== $fname['qid'])\n            {\n                $oldqid = $fname['qid'];\n                if (isset($fname['subquestion']) || isset($fname['subquestion1']) || isset($fname['subquestion2']))\n                {\n                    $aResultTable['qid_'.$fname['sid'].'X'.$fname['gid'].'X'.$fname['qid']]=array($fname['question'],'','');\n                }\n                else\n                {\n                    $answer = getExtendedAnswer($iSurveyID,$fname['fieldname'], $idrow[$fname['fieldname']],$oLanguage);\n                    $aResultTable[$fname['fieldname']]=array($question,'',$answer);\n                    continue;\n                }\n            }\n        }\n        else\n        {\n            $answer=getExtendedAnswer($iSurveyID,$fname['fieldname'], $idrow[$fname['fieldname']],$oLanguage);\n            $aResultTable[$fname['fieldname']]=array($question,'',$answer);\n            continue;\n        }\n        if (isset($fname['subquestion']))\n            $subquestion = \"{$fname['subquestion']}\";\n\n        if (isset($fname['subquestion1']))\n            $subquestion = \"{$fname['subquestion1']}\";\n\n        if (isset($fname['subquestion2']))\n            $subquestion .= \"[{$fname['subquestion2']}]\";\n\n        $answer = getExtendedAnswer($iSurveyID,$fname['fieldname'], $idrow[$fname['fieldname']],$oLanguage);\n        $aResultTable[$fname['fieldname']]=array('',$subquestion,$answer);\n    }\n    return $aResultTable;\n}\n\n/**\n* Check if $str is an integer, or string representation of an integer\n*\n* @param mixed $mStr\n*/\nfunction isNumericInt($mStr)\n{\n    if(is_int($mStr))\n        return true;\n    elseif(is_string($mStr))\n        return preg_match(\"/^[0-9]+$/\", $mStr);\n    return false;\n}\n\n\n/**\n* Include Keypad headers\n*/\nfunction includeKeypad()\n{\n    $clang = Yii::app()->lang;\n\n    Yii::app()->getClientScript()->registerScriptFile(Yii::app()->getConfig('third_party').'jquery-keypad/jquery.keypad.min.js');\n    $localefile = Yii::app()->getConfig('rootdir').'/third_party/jquery-keypad/jquery.keypad-'.$clang->langcode.'.js';\n    if ($clang->langcode != 'en' && file_exists($localefile))\n    {\n        Yii::app()->getClientScript()->registerScriptFile(Yii::app()->getConfig('third_party').'jquery-keypad/jquery.keypad-'.$clang->langcode.'.js');\n    }\n    Yii::app()->getClientScript()->registerCssFile(Yii::app()->getConfig('third_party') . \"jquery-keypad/jquery.keypad.alt.css\");\n}\n\n/**\n* getQuotaInformation() returns quota information for the current survey\n* @param string $surveyid - Survey identification number\n* @param string $language - Language of the quota\n* @param string $quotaid - Optional quotaid that restricts the result to a given quota\n* @return array - nested array, Quotas->Members->Fields\n*/\nfunction getQuotaInformation($surveyid,$language,$iQuotaID='all')\n{\n    Yii::log('getQuotaInformation');\n    global $clienttoken;\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    $aAttributes=array('sid' => $surveyid);\n    if ($iQuotaID != 'all')\n    {\n        $aAttributes['id'] = $iQuotaID;\n    }\n\n    $result = Quota::model()->with(array('languagesettings' => array('condition' => \"quotals_language='$language'\")))->findAllByAttributes($aAttributes);\n    \n    $quota_info = array();\n    $x=0;\n\n    $surveyinfo=getSurveyInfo($surveyid,$language);\n\n    // Check all quotas for the current survey\n    //if ($result->RecordCount() > 0)\n    if (count($result) > 0)\n    {\n        //while ($survey_quotas = $result->FetchRow())\n        foreach ($result as $_survey_quotas)\n        {\n            $survey_quotas = array_merge($_survey_quotas->attributes,$_survey_quotas->languagesettings[0]->attributes);// We have only one language, then we can use first only\n            // !!! Doubting this\n#            foreach ($_survey_quotas->defaultlanguage as $k => $v)\n#                $survey_quotas[$k] = $v;\n\n            array_push($quota_info,array('Name' => $survey_quotas['name'],\n            'Limit' => $survey_quotas['qlimit'],\n            'Action' => $survey_quotas['action'],\n            'Message' => $survey_quotas['quotals_message'],\n            'Url' => $survey_quotas['quotals_url'],\n            'UrlDescrip' => $survey_quotas['quotals_urldescrip'],\n            'AutoloadUrl' => $survey_quotas['autoload_url']));\n\n            $result_qe = QuotaMember::model()->findAllByAttributes(array('quota_id'=>$survey_quotas['id']));\n            $quota_info[$x]['members'] = array();\n            if (count($result_qe) > 0)\n            {\n                foreach ($result_qe as $quota_entry)\n                {\n                    $quota_entry = $quota_entry->attributes;\n                    $result_quest=Question::model()->findByAttributes(array('qid'=>$quota_entry['qid'], 'language'=>$baselang));\n                    $qtype=$result_quest->attributes;\n\n                    $fieldnames = \"0\";\n\n                    if ($qtype['type'] == \"I\" || $qtype['type'] == \"G\" || $qtype['type'] == \"Y\")\n                    {\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid']);\n                        $value = $quota_entry['code'];\n                    }\n\n                    if($qtype['type'] == \"L\" || $qtype['type'] == \"O\" || $qtype['type'] ==\"!\")\n                    {\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid']);\n                        $value = $quota_entry['code'];\n                    }\n\n                    if($qtype['type'] == \"M\")\n                    {\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid'].$quota_entry['code']);\n                        $value = \"Y\";\n                    }\n\n                    if($qtype['type'] == \"A\" || $qtype['type'] == \"B\")\n                    {\n                        $temp = explode('-',$quota_entry['code']);\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid'].$temp[0]);\n                        $value = $temp[1];\n                    }\n\n                    array_push($quota_info[$x]['members'],array('Title' => $qtype['title'],\n                    'type' => $qtype['type'],\n                    'code' => $quota_entry['code'],\n                    'value' => $value,\n                    'qid' => $quota_entry['qid'],\n                    'fieldnames' => $fieldnames));\n                }\n            }\n            $x++;\n        }\n    }\n    return $quota_info;\n}\n\n/**\n* This function replaces the old insertans tags with new ones across a survey\n*\n* @param string $newsid  Old SID\n* @param string $oldsid  New SID\n* @param mixed $fieldnames Array  array('oldfieldname'=>'newfieldname')\n*/\nfunction translateInsertansTags($newsid,$oldsid,$fieldnames)\n{\n    uksort($fieldnames, create_function('$a,$b', 'return strlen($a) < strlen($b);'));\n\n    Yii::app()->loadHelper('database');\n    $newsid=sanitize_int($newsid);\n    $oldsid=sanitize_int($oldsid);\n\n    # translate 'surveyls_urldescription' and 'surveyls_url' INSERTANS tags in surveyls\n    $sql = \"SELECT surveyls_survey_id, surveyls_language, surveyls_urldescription, surveyls_url from {{surveys_languagesettings}}\n    WHERE surveyls_survey_id=\".$newsid.\" AND (surveyls_urldescription LIKE '%{$oldsid}X%' OR surveyls_url LIKE '%{$oldsid}X%')\";\n    $result = dbExecuteAssoc($sql) or show_error(\"Can't read groups table in transInsertAns \");     // Checked\n\n    //while ($qentry = $res->FetchRow())\n    foreach ($result->readAll() as $qentry)\n    {\n        $urldescription = $qentry['surveyls_urldescription'];\n        $endurl  = $qentry['surveyls_url'];\n        $language = $qentry['surveyls_language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $urldescription=preg_replace('/'.$pattern.'/', $replacement, $urldescription);\n            $endurl=preg_replace('/'.$pattern.'/', $replacement, $endurl);\n        }\n\n        if (strcmp($urldescription,$qentry['surveyls_urldescription']) !=0  ||\n        (strcmp($endurl,$qentry['surveyls_url']) !=0))\n        {\n\n            // Update Field\n\n            $data = array(\n            'surveyls_urldescription' => $urldescription,\n            'surveyls_url' => $endurl\n            );\n\n            $where = array(\n            'surveyls_survey_id' => $newsid,\n            'surveyls_language' => $language\n            );\n\n            SurveyLanguageSetting::model()->updateRecord($data,$where);\n\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'quotals_urldescrip' and 'quotals_url' INSERTANS tags in quota_languagesettings\n    $sql = \"SELECT quotals_id, quotals_urldescrip, quotals_url from {{quota_languagesettings}} qls, {{quota}} q\n    WHERE sid=\".$newsid.\" AND q.id=qls.quotals_quota_id AND (quotals_urldescrip LIKE '%{$oldsid}X%' OR quotals_url LIKE '%{$oldsid}X%')\";\n    $result = dbExecuteAssoc($sql) or safeDie(\"Can't read quota table in transInsertAns\");     // Checked\n\n    foreach ($result->readAll() as $qentry)\n    {\n        $urldescription = $qentry['quotals_urldescrip'];\n        $endurl  = $qentry['quotals_url'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $urldescription=preg_replace('/'.$pattern.'/', $replacement, $urldescription);\n            $endurl=preg_replace('/'.$pattern.'/', $replacement, $endurl);\n        }\n\n        if (strcmp($urldescription,$qentry['quotals_urldescrip']) !=0  || (strcmp($endurl,$qentry['quotals_url']) !=0))\n        {\n            // Update Field\n            $sqlupdate = \"UPDATE {{quota_languagesettings}} SET quotals_urldescrip='\".$urldescription.\"', quotals_url='\".$endurl.\"' WHERE quotals_id={$qentry['quotals_id']}\";\n            $updateres=dbExecuteAssoc($sqlupdate) or safeDie (\"Couldn't update INSERTANS in quota_languagesettings<br />$sqlupdate<br />\");    //Checked\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'description' INSERTANS tags in groups\n    $sql = \"SELECT gid, language, group_name, description from {{groups}}\n    WHERE sid=\".$newsid.\" AND description LIKE '%{$oldsid}X%' OR group_name LIKE '%{$oldsid}X%'\";\n    $res = dbExecuteAssoc($sql) or show_error(\"Can't read groups table in transInsertAns\");     // Checked\n\n    //while ($qentry = $res->FetchRow())\n    foreach ($res->readAll() as $qentry)\n    {\n        $gpname = $qentry['group_name'];\n        $description = $qentry['description'];\n        $gid = $qentry['gid'];\n        $language = $qentry['language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $gpname = preg_replace('/'.$pattern.'/', $replacement, $gpname);\n            $description=preg_replace('/'.$pattern.'/', $replacement, $description);\n        }\n\n        if (strcmp($description,$qentry['description']) !=0  || strcmp($gpname,$qentry['group_name']) !=0)\n        {\n            // Update Fields\n            $where = array(\n            'gid' => $gid,\n            'language' => $language\n            );\n            $oGroup = QuestionGroup::model()->findByAttributes($where);\n            $oGroup->description= $description;\n            $oGroup->group_name= $gpname;\n            $oGroup->save();\n\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'question' and 'help' INSERTANS tags in questions\n    $sql = \"SELECT qid, language, question, help from {{questions}}\n    WHERE sid=\".$newsid.\" AND (question LIKE '%{$oldsid}X%' OR help LIKE '%{$oldsid}X%')\";\n    $result = dbExecuteAssoc($sql) or die(\"Can't read question table in transInsertAns \");     // Checked\n\n    //while ($qentry = $res->FetchRow())\n    $aResultData=$result->readAll() ;\n    foreach ($aResultData as $qentry)\n    {\n        $question = $qentry['question'];\n        $help = $qentry['help'];\n        $qid = $qentry['qid'];\n        $language = $qentry['language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $question=preg_replace('/'.$pattern.'/', $replacement, $question);\n            $help=preg_replace('/'.$pattern.'/', $replacement, $help);\n        }\n\n        if (strcmp($question,$qentry['question']) !=0 ||\n        strcmp($help,$qentry['help']) !=0)\n        {\n            // Update Field\n\n            $data = array(\n            'question' => $question,\n            'help' => $help\n            );\n\n            $where = array(\n            'qid' => $qid,\n            'language' => $language\n            );\n\n            Question::model()->updateByPk($where,$data);\n\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'answer' INSERTANS tags in answers\n    $result=Answer::model()->oldNewInsertansTags($newsid,$oldsid);\n\n    //while ($qentry = $res->FetchRow())\n    foreach ($result as $qentry)\n    {\n        $answer = $qentry['answer'];\n        $code = $qentry['code'];\n        $qid = $qentry['qid'];\n        $language = $qentry['language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $answer=preg_replace('/'.$pattern.'/', $replacement, $answer);\n        }\n\n        if (strcmp($answer,$qentry['answer']) !=0)\n        {\n            // Update Field\n\n            $data = array(\n            'answer' => $answer,\n            'qid' => $qid\n            );\n\n            $where = array(\n            'code' => $code,\n            'language' => $language\n            );\n\n            Answer::model()->update($data,$where);\n\n        } // Enf if modified\n    } // end while qentry\n}\n\n/**\n* Replaces EM variable codes in a current survey with a new one\n* \n* @param mixed $iSurveyID The survey ID\n* @param mixed $aCodeMap The codemap array (old_code=>new_code)\n*/\nfunction replaceExpressionCodes ($iSurveyID, $aCodeMap)\n{\n   $arQuestions=Question::model()->findAll(\"sid=:sid\",array(':sid'=>$iSurveyID));\n   foreach ($arQuestions as $arQuestion)\n   {\n        $bModified=false;\n        foreach ($aCodeMap as $sOldCode=>$sNewCode)\n        {\n            // Don't search/replace old codes that are too short or were numeric (because they would not have been usable in EM expressions anyway)\n            if (strlen($sOldCode)>1 && !is_numeric($sOldCode[0])) \n            {\n                $sOldCode=preg_quote($sOldCode,'/');\n                $arQuestion->relevance=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arQuestion->relevance,-1,$iCount);\n                $bModified = $bModified || $iCount;\n                $arQuestion->question=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arQuestion->question,-1,$iCount);\n                $bModified = $bModified || $iCount;\n            }\n        }\n        if ($bModified)\n        {\n            $arQuestion->save();\n        }\n   }\n   $arGroups=QuestionGroup::model()->findAll(\"sid=:sid\",array(':sid'=>$iSurveyID));\n   foreach ($arGroups as $arGroup)\n   {\n        $bModified=false;\n        foreach ($aCodeMap as $sOldCode=>$sNewCode)\n        {\n            $sOldCode=preg_quote($sOldCode,'/');\n            $arGroup->grelevance=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arGroup->grelevance,-1,$iCount);\n            $bModified = $bModified || $iCount;\n            $arGroup->description=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arGroup->description,-1,$iCount);\n            $bModified = $bModified || $iCount;\n        }\n        if ($bModified)\n        {\n            $arGroup->save();\n        }\n   }\n}\n\n\n/**\n* This function is a replacement of accessDenied.php which return appropriate error message which is then displayed.\n*\n* @params string $action - action for which acces denied error message is to be returned\n* @params string sid - survey id\n* @return $accesssummary - proper access denied error message\n*/\nfunction accessDenied($action,$sid='')\n{\n    $clang = Yii::app()->lang;\n    if (Yii::app()->session['loginID'])\n    {\n        $ugid = Yii::app()->getConfig('ugid');\n        $accesssummary = \"<p><strong>\".$clang->gT(\"Access denied!\").\"</strong><br />\\n\";\n        $scriptname = Yii::app()->getConfig('scriptname');\n        //$action=returnGlobal('action');\n        if  (  $action == \"dumpdb\"  )\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed dump the database!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"dumplabel\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed export a label set!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"edituser\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to change user data!\");\n            $accesssummary .= \"<br /><br /><a href='$scriptname?action=editusers'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"newsurvey\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to create new surveys!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"deletesurvey\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to delete this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"addquestion\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to add new questions for this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"activate\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to activate this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"deactivate\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to stop this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"addgroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to add a group to this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"ordergroups\")\n        {\n            $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/$sid\");\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to order groups in this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$link'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"editsurvey\")\n        {\n            $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/$sid\");\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to edit this survey!\").\"</p>\";\n            $accesssummary .= \"<a href='$link'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"editgroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to edit groups in this survey!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"browse_response\" || $action == \"listcolumn\" || $action == \"vvexport\" || $action == \"vvimport\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to browse responses!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"assessment\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to set assessment rules!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"delusergroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to delete this group!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?action=editusergroups'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"importsurvey\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to import a survey!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n\n        elseif($action == \"importgroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to import a group!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"importquestion\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to to import a question!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"CSRFwarn\") //won't be used.\n        {\n            $sURLID='';\n            if (isset($sid)) {\n                $sURLID=\"?sid={$sid}\";\n            }\n            $accesssummary .= \"<p><span color='errortitle'>\".$clang->gT(\"Security alert\").\"</span>: \".$clang->gT(\"Someone may be trying to use your LimeSurvey session (CSRF attack suspected). If you just clicked on a malicious link, please report this to your system administrator.\").'<br>'.$clang->gT('Also this problem can occur when you are working/editing in LimeSurvey in several browser windows/tabs at the same time.').\"</p>\";\n            $accesssummary .= \"<a href='{$scriptname}{$sURLID}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"FakeGET\")\n        {\n            $accesssummary .= \"<p><span class='errortitle'>\".$clang->gT(\"Security alert\").\"</span>: \".$clang->gT(\"Someone may be trying to use your LimeSurvey session (CSRF attack suspected). If you just clicked on a malicious link, please report this to your system administrator.\").'<br>'.$clang->gT('Also this problem can occur when you are working/editing in LimeSurvey in several browser windows/tabs at the same time.').\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        else\n        {\n            $accesssummary .= \"<br />\".$clang->gT(\"You are not allowed to perform this operation!\").\"<br />\\n\";\n            if(!empty($sid))\n            {\n                $accesssummary .= \"<br /><br /><a href='$scriptname?sid=$sid>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n            }\n            elseif(!empty($ugid))\n            {\n                $accesssummary .= \"<br /><br /><a href='$scriptname?action=editusergroups&ugid={$ugid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n            }\n            else\n            {\n                $accesssummary .= \"<br /><br /><a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n            }\n        }\n        return $accesssummary;\n    }\n\n}\n\n/**\n* cleanLanguagesFromSurvey() removes any languages from survey tables that are not in the passed list\n* @param string $sid - the currently selected survey\n* @param string $availlangs - space separated list of additional languages in survey\n* @return bool - always returns true\n*/\nfunction cleanLanguagesFromSurvey($sid, $availlangs)\n{\n\n    Yii::app()->loadHelper('database');\n    //$clang = Yii::app()->lang;\n    $sid=sanitize_int($sid);\n    $baselang = Survey::model()->findByPk($sid)->language;\n\n    if (!empty($availlangs) && $availlangs != \" \")\n    {\n        $availlangs=sanitize_languagecodeS($availlangs);\n        $langs = explode(\" \",$availlangs);\n        if($langs[count($langs)-1] == \"\") array_pop($langs);\n    }\n\n    $sqllang = \"language <> '\".$baselang.\"' \";\n\n    if (!empty($availlangs) && $availlangs != \" \")\n    {\n        foreach ($langs as $lang)\n        {\n            $sqllang .= \"AND language <> '\".$lang.\"' \";\n        }\n    }\n\n    // Remove From Answer Table\n    $query = \"SELECT qid FROM {{questions}} WHERE sid='{$sid}' AND $sqllang\";\n    $qidresult = dbExecuteAssoc($query);\n\n    foreach ($qidresult->readAll() as $qrow)\n    {\n\n        $myqid = $qrow['qid'];\n        $query = \"DELETE FROM {{answers}} WHERE qid='$myqid' AND $sqllang\";\n        dbExecuteAssoc($query);\n    }\n\n    // Remove From Questions Table\n    $query = \"DELETE FROM {{questions}} WHERE sid='{$sid}' AND $sqllang\";\n    dbExecuteAssoc($query);\n\n    // Remove From QuestionGroup Table\n    $query = \"DELETE FROM {{groups}} WHERE sid='{$sid}' AND $sqllang\";\n    dbExecuteAssoc($query);\n\n    return true;\n}\n\n/**\n* fixLanguageConsistency() fixes missing groups, questions, answers, quotas & assessments for languages on a survey\n* @param string $sid - the currently selected survey\n* @param string $availlangs - space separated list of additional languages in survey - if empty all additional languages of a survey are checked against the base language\n* @return bool - always returns true\n*/\nfunction fixLanguageConsistency($sid, $availlangs='')\n{\n    $sid=sanitize_int($sid);\n    $clang = Yii::app()->lang;\n\n    if (trim($availlangs)!='')\n    {\n        $availlangs=sanitize_languagecodeS($availlangs);\n        $langs = explode(\" \",$availlangs);\n        if($langs[count($langs)-1] == \"\") array_pop($langs);\n    } else {\n        $langs=Survey::model()->findByPk($sid)->additionalLanguages;\n    }\n    if (count($langs)==0) return true; // Survey only has one language\n    $baselang = Survey::model()->findByPk($sid)->language;\n    $query = \"SELECT * FROM {{groups}} WHERE sid='{$sid}' AND language='{$baselang}'  ORDER BY group_order\";\n    $result = Yii::app()->db->createCommand($query)->query();\n    foreach($result->readAll() as $group)\n    {\n        foreach ($langs as $lang)\n        {\n\n            $query = \"SELECT count(gid) FROM {{groups}} WHERE sid='{$sid}' AND gid='{$group['gid']}' AND language='{$lang}'\";\n            $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n            if ($gresult < 1)\n            {\n                $data = array(\n                'gid' => $group['gid'],\n                'sid' => $group['sid'],\n                'group_name' => $group['group_name'],\n                'group_order' => $group['group_order'],\n                'description' => $group['description'],\n                'randomization_group' => $group['randomization_group'],\n                'grelevance' => $group['grelevance'],\n                'language' => $lang\n\n                );\n                switchMSSQLIdentityInsert('groups',true);\n                Yii::app()->db->createCommand()->insert('{{groups}}', $data);\n                switchMSSQLIdentityInsert('groups',false);\n            }\n        }\n        reset($langs);\n    }\n\n    $quests = array();\n    $query = \"SELECT * FROM {{questions}} WHERE sid='{$sid}' AND language='{$baselang}' ORDER BY question_order\";\n    $result = Yii::app()->db->createCommand($query)->query()->readAll();\n    if (count($result) > 0)\n    {\n        foreach($result as $question)\n        {\n            array_push($quests,$question['qid']);\n            foreach ($langs as $lang)\n            {\n                $query = \"SELECT count(qid) FROM {{questions}} WHERE sid='{$sid}' AND qid='{$question['qid']}' AND language='{$lang}' AND scale_id={$question['scale_id']}\";\n                $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n                if ($gresult < 1)\n                {\n                    switchMSSQLIdentityInsert('questions',true);\n                    $data = array(\n                    'qid' => $question['qid'],\n                    'sid' => $question['sid'],\n                    'gid' => $question['gid'],\n                    'type' => $question['type'],\n                    'title' => $question['title'],\n                    'question' => $question['question'],\n                    'preg' => $question['preg'],\n                    'help' => $question['help'],\n                    'other' => $question['other'],\n                    'mandatory' => $question['mandatory'],\n                    'question_order' => $question['question_order'],\n                    'language' => $lang,\n                    'scale_id' => $question['scale_id'],\n                    'parent_qid' => $question['parent_qid'],\n                    'relevance' => $question['relevance']\n                    );\n                    Yii::app()->db->createCommand()->insert('{{questions}}', $data);\n                }\n            }\n            reset($langs);\n        }\n\n        $sqlans = \"\";\n        foreach ($quests as $quest)\n        {\n            $sqlans .= \" OR qid = '\".$quest.\"' \";\n        }\n        $query = \"SELECT * FROM {{answers}} WHERE language='{$baselang}' and (\".trim($sqlans,' OR').\") ORDER BY qid, code\";\n        $result = Yii::app()->db->createCommand($query)->query();\n        foreach($result->readAll() as $answer)\n        {\n            foreach ($langs as $lang)\n            {\n                $query = \"SELECT count(qid) FROM {{answers}} WHERE code='{$answer['code']}' AND qid='{$answer['qid']}' AND language='{$lang}' AND scale_id={$answer['scale_id']}\";\n                $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n                if ($gresult < 1)\n                {\n                    $data = array(\n                    'qid' => $answer['qid'],\n                    'code' => $answer['code'],\n                    'answer' => $answer['answer'],\n                    'scale_id' => $answer['scale_id'],\n                    'sortorder' => $answer['sortorder'],\n                    'language' => $lang,\n                    'assessment_value' =>  $answer['assessment_value']\n                    );\n                    Yii::app()->db->createCommand()->insert('{{answers}}', $data);\n                }\n            }\n            reset($langs);\n        }\n    }\n\n\n    $query = \"SELECT * FROM {{assessments}} WHERE sid='{$sid}' AND language='{$baselang}'\";\n    $result = Yii::app()->db->createCommand($query)->query();\n    foreach($result->readAll() as $assessment)\n    {\n        foreach ($langs as $lang)\n        {\n            $query = \"SELECT count(id) FROM {{assessments}} WHERE sid='{$sid}' AND id='{$assessment['id']}' AND language='{$lang}'\";\n            $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n            if ($gresult < 1)\n            {\n                $data = array(\n                'id' => $assessment['id'],\n                'sid' => $assessment['sid'],\n                'scope' => $assessment['scope'],\n                'gid' => $assessment['gid'],\n                'name' => $assessment['name'],\n                'minimum' => $assessment['minimum'],\n                'maximum' => $assessment['maximum'],\n                'message' => $assessment['message'],\n                'language' => $lang\n                );\n                Yii::app()->db->createCommand()->insert('{{assessments}}', $data);\n            }\n        }\n        reset($langs);\n    }\n\n\n    $query = \"SELECT * FROM {{quota_languagesettings}} join {{quota}} q on quotals_quota_id=q.id WHERE q.sid='{$sid}' AND quotals_language='{$baselang}'\";\n    $result = Yii::app()->db->createCommand($query)->query();\n    foreach($result->readAll() as $qls)\n    {\n        foreach ($langs as $lang)\n        {\n            $query = \"SELECT count(quotals_id) FROM {{quota_languagesettings}} WHERE quotals_quota_id='{$qls['quotals_quota_id']}' AND quotals_language='{$lang}'\";\n            $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n            if ($gresult < 1)\n            {\n                $data = array(\n                'quotals_quota_id' => $qls['quotals_quota_id'],\n                'quotals_name' => $qls['quotals_name'],\n                'quotals_message' => $qls['quotals_message'],\n                'quotals_url' => $qls['quotals_url'],\n                'quotals_urldescrip' => $qls['quotals_urldescrip'],\n                'quotals_language' => $lang\n                );\n                Yii::app()->db->createCommand()->insert('{{quota_languagesettings}}', $data);\n            }\n        }\n        reset($langs);\n    }\n\n    return true;\n}\n\n/**\n* This function switches identity insert on/off for the MSSQL database\n*\n* @param string $table table name (without prefix)\n* @param mixed $state  Set to true to activate ID insert, or false to deactivate\n*/\nfunction switchMSSQLIdentityInsert($table,$state)\n{\n    if (in_array(Yii::app()->db->getDriverName(), array('mssql', 'sqlsrv', 'dblib')))\n    {\n        if ($state == true)\n        {\n            // This needs to be done directly on the PDO object because when using CdbCommand or similar it won't have any effect\n            Yii::app()->db->pdoInstance->exec('SET IDENTITY_INSERT '.Yii::app()->db->tablePrefix.$table.' ON');\n        }\n        else\n        {\n            // This needs to be done directly on the PDO object because when using CdbCommand or similar it won't have any effect\n            Yii::app()->db->pdoInstance->exec('SET IDENTITY_INSERT '.Yii::app()->db->tablePrefix.$table.' OFF');\n        }\n    }\n}\n\n/**\n* Retrieves the last Insert ID realiable for cross-DB applications\n*\n* @param string $sTableName Needed for Postgres and MSSQL\n*/\nfunction getLastInsertID($sTableName)\n{\n    $sDBDriver=Yii::app()->db->getDriverName();\n    if ($sDBDriver=='mysql' || $sDBDriver=='mysqli')\n    {\n        return Yii::app()->db->getLastInsertID();\n    }\n    else\n    {\n        return Yii::app()->db->getCommandBuilder()->getLastInsertID($sTableName);\n    }\n}\n\n// TMSW Condition->Relevance:  This function is not needed?  Optionally replace this with call to EM to get similar info\n/**\n* getGroupDepsForConditions() get Dependencies between groups caused by conditions\n* @param string $sid - the currently selected survey\n* @param string $depgid - (optionnal) get only the dependencies applying to the group with gid depgid\n* @param string $targgid - (optionnal) get only the dependencies for groups dependents on group targgid\n* @param string $index-by - (optionnal) \"by-depgid\" for result indexed with $res[$depgid][$targgid]\n*                   \"by-targgid\" for result indexed with $res[$targgid][$depgid]\n* @return array - returns an array describing the conditions or NULL if no dependecy is found\n*\n* Example outupt assumin $index-by=\"by-depgid\":\n*Array\n*(\n*    [125] => Array             // Group Id 125 is dependent on\n*        (\n*            [123] => Array         // Group Id 123\n*                (\n*                    [depgpname] => G3      // GID-125 has name G3\n*                    [targetgpname] => G1   // GID-123 has name G1\n*                    [conditions] => Array\n*                        (\n*                            [189] => Array // Because Question Id 189\n*                                (\n*                                    [0] => 9   // Have condition 9 set\n*                                    [1] => 10  // and condition 10 set\n*                                    [2] => 14  // and condition 14 set\n*                                )\n*\n*                        )\n*\n*                )\n*\n*            [124] => Array         // GID 125 is also dependent on GID 124\n*                (\n*                    [depgpname] => G3\n*                    [targetgpname] => G2\n*                    [conditions] => Array\n*                        (\n*                            [189] => Array // Because Question Id 189 have conditions set\n*                                (\n*                                    [0] => 11\n*                                )\n*\n*                            [215] => Array // And because Question Id 215 have conditions set\n*                                (\n*                                    [0] => 12\n*                                )\n*\n*                        )\n*\n*                )\n*\n*        )\n*\n*)\n*\n* Usage example:\n*   * Get all group dependencies for SID $sid indexed by depgid:\n*       $result=getGroupDepsForConditions($sid);\n*   * Get all group dependencies for GID $gid in survey $sid indexed by depgid:\n*       $result=getGroupDepsForConditions($sid,$gid);\n*   * Get all group dependents on group $gid in survey $sid indexed by targgid:\n*       $result=getGroupDepsForConditions($sid,\"all\",$gid,\"by-targgid\");\n*/\nfunction getGroupDepsForConditions($sid,$depgid=\"all\",$targgid=\"all\",$indexby=\"by-depgid\")\n{\n    $sid=sanitize_int($sid);\n    $condarray = Array();\n    $sqldepgid=\"\";\n    $sqltarggid=\"\";\n    if ($depgid != \"all\") { $depgid = sanitize_int($depgid); $sqldepgid=\"AND tq.gid=$depgid\";}\n    if ($targgid != \"all\") {$targgid = sanitize_int($targgid); $sqltarggid=\"AND tq2.gid=$targgid\";}\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n    $condquery = \"SELECT tg.gid as depgid, tg.group_name as depgpname, \"\n    . \"tg2.gid as targgid, tg2.group_name as targgpname, tq.qid as depqid, tc.cid FROM \"\n    . \"{{conditions}} AS tc, \"\n    . \"{{questions}} AS tq, \"\n    . \"{{questions}} AS tq2, \"\n    . \"{{groups}} AS tg ,\"\n    . \"{{groups}} AS tg2 \"\n    . \"WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tg.language='{$baselang}' AND tg2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid=$sid \"\n    . \"AND tq.gid = tg.gid AND tg2.gid = tq2.gid \"\n    . \"AND tq2.qid=tc.cqid AND tq.gid != tg2.gid $sqldepgid $sqltarggid\";\n    $condresult = Yii::app()->db->createCommand($condquery)->query()->readAll();\n\n    if (count($condresult) > 0) {\n        foreach ($condresult as $condrow)\n        {\n\n            switch ($indexby)\n            {\n                case \"by-depgid\":\n                    $depgid=$condrow['depgid'];\n                    $targetgid=$condrow['targgid'];\n                    $depqid=$condrow['depqid'];\n                    $cid=$condrow['cid'];\n                    $condarray[$depgid][$targetgid]['depgpname'] = $condrow['depgpname'];\n                    $condarray[$depgid][$targetgid]['targetgpname'] = $condrow['targgpname'];\n                    $condarray[$depgid][$targetgid]['conditions'][$depqid][]=$cid;\n                    break;\n\n                case \"by-targgid\":\n                    $depgid=$condrow['depgid'];\n                    $targetgid=$condrow['targgid'];\n                    $depqid=$condrow['depqid'];\n                    $cid=$condrow['cid'];\n                    $condarray[$targetgid][$depgid]['depgpname'] = $condrow['depgpname'];\n                    $condarray[$targetgid][$depgid]['targetgpname'] = $condrow['targgpname'];\n                    $condarray[$targetgid][$depgid]['conditions'][$depqid][] = $cid;\n                    break;\n            }\n        }\n        return $condarray;\n    }\n    return null;\n}\n\n// TMSW Condition->Relevance:  This function is not needed?  Optionally replace this with call to EM to get similar info\n/**\n* getQuestDepsForConditions() get Dependencies between groups caused by conditions\n* @param string $sid - the currently selected survey\n* @param string $gid - (optionnal) only search dependecies inside the Group Id $gid\n* @param string $depqid - (optionnal) get only the dependencies applying to the question with qid depqid\n* @param string $targqid - (optionnal) get only the dependencies for questions dependents on question Id targqid\n* @param string $index-by - (optionnal) \"by-depqid\" for result indexed with $res[$depqid][$targqid]\n*                   \"by-targqid\" for result indexed with $res[$targqid][$depqid]\n* @return array - returns an array describing the conditions or NULL if no dependecy is found\n*\n* Example outupt assumin $index-by=\"by-depqid\":\n*Array\n*(\n*    [184] => Array     // Question Id 184\n*        (\n*            [183] => Array // Depends on Question Id 183\n*                (\n*                    [0] => 5   // Because of condition Id 5\n*                )\n*\n*        )\n*\n*)\n*\n* Usage example:\n*   * Get all questions dependencies for Survey $sid and group $gid indexed by depqid:\n*       $result=getQuestDepsForConditions($sid,$gid);\n*   * Get all questions dependencies for question $qid in survey/group $sid/$gid indexed by depqid:\n*       $result=getGroupDepsForConditions($sid,$gid,$qid);\n*   * Get all questions dependents on question $qid in survey/group $sid/$gid indexed by targqid:\n*       $result=getGroupDepsForConditions($sid,$gid,\"all\",$qid,\"by-targgid\");\n*/\nfunction getQuestDepsForConditions($sid,$gid=\"all\",$depqid=\"all\",$targqid=\"all\",$indexby=\"by-depqid\", $searchscope=\"samegroup\")\n{\n    $clang = Yii::app()->lang;\n    $condarray = Array();\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n    $sqlgid=\"\";\n    $sqldepqid=\"\";\n    $sqltargqid=\"\";\n    $sqlsearchscope=\"\";\n    if ($gid != \"all\") {$gid = sanitize_int($gid); $sqlgid=\"AND tq.gid=$gid\";}\n    if ($depqid != \"all\") {$depqid = sanitize_int($depqid); $sqldepqid=\"AND tq.qid=$depqid\";}\n    if ($targqid != \"all\") {$targqid = sanitize_int($targqid); $sqltargqid=\"AND tq2.qid=$targqid\";}\n    if ($searchscope == \"samegroup\") {$sqlsearchscope=\"AND tq2.gid=tq.gid\";}\n\n    $condquery = \"SELECT tq.qid as depqid, tq2.qid as targqid, tc.cid\n    FROM {{conditions}} AS tc, {{questions}} AS tq, {{questions}} AS tq2\n    WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid='$sid'\n    AND  tq2.qid=tc.cqid $sqlsearchscope $sqlgid $sqldepqid $sqltargqid\";\n    $condresult=Yii::app()->db->createCommand($condquery)->query()->readAll();\n    if (count($condresult) > 0) {\n        foreach ($condresult as $condrow)\n        {\n            $depqid=$condrow['depqid'];\n            $targetqid=$condrow['targqid'];\n            $condid=$condrow['cid'];\n            switch ($indexby)\n            {\n                case \"by-depqid\":\n                    $condarray[$depqid][$targetqid][] = $condid;\n                    break;\n\n                case \"by-targqid\":\n                    $condarray[$targetqid][$depqid][] = $condid;\n                    break;\n            }\n        }\n        return $condarray;\n    }\n    return null;\n}\n\n// TMSW Condition->Relevance:  This function is not needed - could replace with a message from EM output.\n/**\n* checkMoveQuestionConstraintsForConditions()\n* @param string $sid - the currently selected survey\n* @param string $qid - qid of the question you want to check possible moves\n* @param string $newgid - (optionnal) get only constraints when trying to move to this particular GroupId\n*                                     otherwise, get all moves constraints for this question\n*\n* @return array - returns an array describing the conditions\n*                 Array\n*                 (\n*                   ['notAbove'] = null | Array\n*                       (\n*                         Array ( gid1, group_order1, qid1, cid1 )\n*                       )\n*                   ['notBelow'] = null | Array\n*                       (\n*                         Array ( gid2, group_order2, qid2, cid2 )\n*                       )\n*                 )\n*\n* This should be read as:\n*    - this question can't be move above group gid1 in position group_order1 because of the condition cid1 on question qid1\n*    - this question can't be move below group gid2 in position group_order2 because of the condition cid2 on question qid2\n*\n*/\nfunction checkMoveQuestionConstraintsForConditions($sid,$qid,$newgid=\"all\")\n{\n    $clang = Yii::app()->lang;\n    $resarray=Array();\n    $resarray['notAbove']=null; // defaults to no constraint\n    $resarray['notBelow']=null; // defaults to no constraint\n    $sid=sanitize_int($sid);\n    $qid=sanitize_int($qid);\n\n    if ($newgid != \"all\")\n    {\n        $newgid=sanitize_int($newgid);\n        $newgorder=getGroupOrder($sid,$newgid);\n    }\n    else\n    {\n        $neworder=\"\"; // Not used in this case\n    }\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n\n    // First look for 'my dependencies': questions on which I have set conditions\n    $condquery = \"SELECT tq.qid as depqid, tq.gid as depgid, tg.group_order as depgorder, \"\n    . \"tq2.qid as targqid, tq2.gid as targgid, tg2.group_order as targgorder, \"\n    . \"tc.cid FROM \"\n    . \"{{conditions}} AS tc, \"\n    . \"{{questions}} AS tq, \"\n    . \"{{questions}} AS tq2, \"\n    . \"{{groups}} AS tg, \"\n    . \"{{groups}} AS tg2 \"\n    . \"WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid=$sid \"\n    . \"AND  tq2.qid=tc.cqid AND tg.gid=tq.gid AND tg2.gid=tq2.gid AND tq.qid=$qid ORDER BY tg2.group_order DESC\";\n\n    $condresult=Yii::app()->db->createCommand($condquery)->query();\n\n    foreach ($condresult->readAll() as $condrow )\n    {\n        // This Question can go up to the minimum GID on the 1st row\n        $depqid=$condrow['depqid'];\n        $depgid=$condrow['depgid'];\n        $depgorder=$condrow['depgorder'];\n        $targetqid=$condrow['targqid'];\n        $targetgid=$condrow['targgid'];\n        $targetgorder=$condrow['targgorder'];\n        $condid=$condrow['cid'];\n        //echo \"This question can't go above to GID=$targetgid/order=$targetgorder because of CID=$condid\";\n        if ($newgid != \"all\")\n        { // Get only constraints when trying to move to this group\n            if ($newgorder < $targetgorder)\n            {\n                $resarray['notAbove'][]=Array($targetgid,$targetgorder,$depqid,$condid);\n            }\n        }\n        else\n        { // get all moves constraints\n            $resarray['notAbove'][]=Array($targetgid,$targetgorder,$depqid,$condid);\n        }\n    }\n\n    // Secondly look for 'questions dependent on me': questions that have conditions on my answers\n    $condquery = \"SELECT tq.qid as depqid, tq.gid as depgid, tg.group_order as depgorder, \"\n    . \"tq2.qid as targqid, tq2.gid as targgid, tg2.group_order as targgorder, \"\n    . \"tc.cid FROM {{conditions}} AS tc, \"\n    . \"{{questions}} AS tq, \"\n    . \"{{questions}} AS tq2, \"\n    . \"{{groups}} AS tg, \"\n    . \"{{groups}} AS tg2 \"\n    . \"WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid=$sid \"\n    . \"AND  tq2.qid=tc.cqid AND tg.gid=tq.gid AND tg2.gid=tq2.gid AND tq2.qid=$qid ORDER BY tg.group_order\";\n\n    $condresult=Yii::app()->db->createCommand($condquery)->query();\n\n    foreach ($condresult->readAll() as $condrow)\n    {\n        // This Question can go down to the maximum GID on the 1st row\n        $depqid=$condrow['depqid'];\n        $depgid=$condrow['depgid'];\n        $depgorder=$condrow['depgorder'];\n        $targetqid=$condrow['targqid'];\n        $targetgid=$condrow['targgid'];\n        $targetgorder=$condrow['targgorder'];\n        $condid=$condrow['cid'];\n        //echo \"This question can't go below to GID=$depgid/order=$depgorder because of CID=$condid\";\n        if ($newgid != \"all\")\n        { // Get only constraints when trying to move to this group\n            if ($newgorder > $depgorder)\n            {\n                $resarray['notBelow'][]=Array($depgid,$depgorder,$depqid,$condid);\n            }\n        }\n        else\n        { // get all moves constraints\n            $resarray['notBelow'][]=Array($depgid,$depgorder,$depqid,$condid);\n        }\n    }\n    return $resarray;\n}\n\nfunction getUserGroupList($ugid=NULL,$outputformat='optionlist')\n{\n    $clang = Yii::app()->lang;\n    //$squery = \"SELECT ugid, name FROM \".db_table_name('user_groups') .\" WHERE owner_id = {Yii::app()->session['loginID']} ORDER BY name\";\n    $sQuery = \"SELECT distinct a.ugid, a.name, a.owner_id FROM {{user_groups}} AS a LEFT JOIN {{user_in_groups}} AS b ON a.ugid = b.ugid WHERE 1=1 \";\n    if (!Permission::model()->hasGlobalPermission('superadmin','read'))\n    {\n        $sQuery .=\"AND uid = \".Yii::app()->session['loginID'];\n    }\n    $sQuery .=  \" ORDER BY name\";\n\n    $sresult = Yii::app()->db->createCommand($sQuery)->query(); //Checked\n    if (!$sresult) {return \"Database Error\";}\n    $selecter = \"\";\n    foreach ($sresult->readAll() as $row)\n    {\n        $groupnames[] = $row;\n    }\n\n\n    //$groupnames = $sresult->GetRows();\n    $simplegidarray=array();\n    if (isset($groupnames))\n    {\n        foreach($groupnames as $gn)\n        {\n            $selecter .= \"<option \";\n            if(Yii::app()->session['loginID'] == $gn['owner_id']) {$selecter .= \" style=\\\"font-weight: bold;\\\"\";}\n            //if (isset($_GET['ugid']) && $gn['ugid'] == $_GET['ugid']) {$selecter .= \" selected='selected'\"; $svexist = 1;}\n\n            if ($gn['ugid'] == $ugid) {$selecter .= \" selected='selected'\"; $svexist = 1;}\n            $link = Yii::app()->getController()->createUrl(\"/admin/usergroups/sa/view/ugid/\".$gn['ugid']);\n            $selecter .=\" value='{$link}'>{$gn['name']}</option>\\n\";\n            $simplegidarray[] = $gn['ugid'];\n        }\n    }\n\n    if (!isset($svexist)) {$selecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$selecter;}\n    //else {$selecter = \"<option value='-1'>\".$clang->gT(\"None\").\"</option>\\n\".$selecter;}\n\n    if ($outputformat == 'simplegidarray')\n    {\n        return $simplegidarray;\n    }\n    else\n    {\n        return $selecter;\n    }\n}\n\nfunction getGroupUserList($ugid)\n{\n    Yii::app()->loadHelper('database');\n    $clang = Yii::app()->lang;\n\n    $ugid=sanitize_int($ugid);\n    $surveyidquery = \"SELECT a.uid, a.users_name, a.full_name FROM {{users}} AS a LEFT JOIN (SELECT uid AS id FROM {{user_in_groups}} WHERE ugid = {$ugid}) AS b ON a.uid = b.id WHERE id IS NULL ORDER BY a.users_name\";\n\n    $surveyidresult = dbExecuteAssoc($surveyidquery);  //Checked\n    if (!$surveyidresult) {return \"Database Error\";}\n    $surveyselecter = \"\";\n    foreach ($surveyidresult->readAll() as $row)\n    {\n        $surveynames[] = $row;\n    }\n    //$surveynames = $surveyidresult->GetRows();\n    if (isset($surveynames))\n    {\n        foreach($surveynames as $sv)\n        {\n            $surveyselecter .= \"<option\";\n            $surveyselecter .=\" value='{$sv['uid']}'>{$sv['users_name']} {$sv['full_name']}</option>\\n\";\n        }\n    }\n    $surveyselecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;\n    return $surveyselecter;\n}\n\n/**\n* Run an arbitrary sequence of semicolon-delimited SQL commands\n*\n* Assumes that the input text (file or string) consists of\n* a number of SQL statements ENDING WITH SEMICOLONS.  The\n* semicolons MUST be the last character in a line.\n* Lines that are blank or that start with \"#\" or \"--\" (postgres) are ignored.\n* Only tested with mysql dump files (mysqldump -p -d limesurvey)\n* Function kindly borrowed by Moodle\n* @param string $sqlfile The path where a file with sql commands can be found on the server.\n* @param string $sqlstring If no path is supplied then a string with semicolon delimited sql\n* commands can be supplied in this argument.\n* @return bool Returns true if database was modified successfully.\n*/\nfunction modifyDatabase($sqlfile='', $sqlstring='')\n{\n    Yii::app()->loadHelper('database');\n    $clang = Yii::app()->lang;\n\n    global $siteadminemail;\n    global $siteadminname;\n    global $codeString;\n    global $modifyoutput;\n\n    $success = true;  // Let's be optimistic\n    $modifyoutput='';\n\n    if (!empty($sqlfile)) {\n        if (!is_readable($sqlfile)) {\n            $success = false;\n            echo '<p>Tried to modify database, but \"'. $sqlfile .'\" doesn\\'t exist!</p>';\n            return $success;\n        } else {\n            $lines = file($sqlfile);\n        }\n    } else {\n        $sqlstring = trim($sqlstring);\n        if ($sqlstring{strlen($sqlstring)-1} != \";\") {\n            $sqlstring .= \";\"; // add it in if it's not there.\n        }\n        $lines[] = $sqlstring;\n    }\n\n    $command = '';\n\n    foreach ($lines as $line) {\n        $line = rtrim($line);\n        $length = strlen($line);\n\n        if ($length and $line[0] <> '#' and substr($line,0,2) <> '--') {\n            if (substr($line, $length-1, 1) == ';') {\n                $line = substr($line, 0, $length-1);   // strip ;\n                $command .= $line;\n                $command = str_replace('prefix_', Yii::app()->db->tablePrefix, $command); // Table prefixes\n                $command = str_replace('$defaultuser', Yii::app()->getConfig('defaultuser'), $command);\n                $command = str_replace('$defaultpass', hash('sha256',Yii::app()->getConfig('defaultpass')), $command);\n                $command = str_replace('$siteadminname', $siteadminname, $command);\n                $command = str_replace('$siteadminemail', $siteadminemail, $command);\n                $command = str_replace('$defaultlang', Yii::app()->getConfig('defaultlang'), $command);\n                $command = str_replace('$databasetabletype', Yii::app()->db->getDriverName(), $command);\n\n                try\n                {   Yii::app()->db->createCommand($command)->query(); //Checked\n                    $command=htmlspecialchars($command);\n                    $modifyoutput .=\". \";\n                }\n                catch(CDbException $e)\n                {\n                    $command=htmlspecialchars($command);\n                    $modifyoutput .=\"<br />\".sprintf($clang->gT(\"SQL command failed: %s\"),\"<span style='font-size:10px;'>\".$command.\"</span>\",\"<span style='color:#ee0000;font-size:10px;'></span><br/>\");\n                    $success = false;\n                }\n\n                $command = '';\n            } else {\n                $command .= $line;\n            }\n        }\n    }\n\n    return $success;\n\n}\n\n/**\n* Returns labelsets for given language(s), or for all if null\n*\n* @param string $languages\n* @return array\n*/\nfunction getLabelSets($languages = null)\n{\n\n    $clang = Yii::app()->lang;\n    $languagesarray = array();\n    if ($languages)\n    {\n        $languages=sanitize_languagecodeS($languages);\n        $languagesarray=explode(' ',trim($languages));\n    }\n\n    $criteria = new CDbCriteria;\n    $criteria->order = \"label_name\";\n    foreach ($languagesarray as $k => $item)\n    {\n        $criteria->params[':lang_like1_' . $k] = \"% $item %\";\n        $criteria->params[':lang_' . $k] = $item;\n        $criteria->params[':lang_like2_' . $k] = \"% $item\";\n        $criteria->params[':lang_like3_' . $k] = \"$item %\";\n        $criteria->addCondition(\"\n        ((languages like :lang_like1_$k) or\n        (languages = :lang_$k) or\n        (languages like :lang_like2_$k) or\n        (languages like :lang_like3_$k))\");\n    }\n\n    $result = LabelSet::model()->findAll($criteria);\n    $labelsets=array();\n    foreach ($result as $row)\n        $labelsets[] = array($row->lid, $row->label_name);\n    return $labelsets;\n}\n\nfunction getHeader($meta = false)\n{\n    global $embedded,$surveyid ;\n    Yii::app()->loadHelper('surveytranslator');\n\n    // Set Langage // TODO remove one of the Yii::app()->session see bug #5901\n    if (Yii::app()->session['survey_'.$surveyid]['s_lang'] )\n    {\n        $languagecode =  Yii::app()->session['survey_'.$surveyid]['s_lang'];\n    }\n    elseif (isset($surveyid) && $surveyid  && Survey::model()->findByPk($surveyid))\n    {\n        $languagecode=Survey::model()->findByPk($surveyid)->language;\n    }\n    else\n    {\n        $languagecode = Yii::app()->getConfig('defaultlang');\n    }\n\n    $header=  \"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Transitional//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\\\">\\n\"\n    . \"<html xmlns=\\\"http://www.w3.org/1999/xhtml\\\" xml:lang=\\\"{$languagecode}\\\" lang=\\\"{$languagecode}\\\"\";\n    if (getLanguageRTL($languagecode))\n    {\n        $header.=\" dir=\\\"rtl\\\" \";\n    }\n    $header.= \">\\n\\t<head>\\n\";\n\n    if ($meta)\n        $header .= $meta;\n\n\n    if ( !$embedded )\n    {\n        return $header;\n    }\n\n    global $embedded_headerfunc;\n\n    if ( function_exists( $embedded_headerfunc ) )\n        return $embedded_headerfunc($header);\n}\n\n\nfunction doHeader()\n{\n    echo getHeader();\n}\n\n/**\n* This function returns the header for the printable survey\n* @return String\n*\n*/\nfunction getPrintableHeader()\n{\n    global $rooturl,$homeurl;\n    $headelements = '\n    <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\" />\n    <script type=\"text/javascript\" src=\"'.Yii::app()->getConfig('adminscripts').'printablesurvey.js\"></script>\n    ';\n    return $headelements;\n}\n\n// This function returns the Footer as result string\n// If you want to echo the Footer use doFooter() !\nfunction getFooter()\n{\n    global $embedded;\n    if ( !$embedded )\n    {\n        return \"\\n\\n\\t</body>\\n</html>\\n\";\n    }\n\n    global $embedded_footerfunc;\n\n    if ( function_exists( $embedded_footerfunc ) )\n        return $embedded_footerfunc();\n}\n\nfunction doFooter()\n{\n    echo getFooter();\n}\n\nfunction getDBTableUsage($surveyid){\n    Yii::app()->loadHelper('admin/activate');\n    $arrCols = activateSurvey($surveyid,$surveyid,'admin.php',true);\n\n    $length = 1;\n    foreach ($arrCols['fields'] as $col){\n        switch ($col[0]){\n            case 'C':\n                $length = $length + ($col[1]*3) + 1;\n                break;\n            case 'X':\n            case 'B':\n                $length = $length + 12;\n                break;\n            case 'D':\n                $length = $length + 3;\n                break;\n            case 'T':\n            case 'TS':\n            case 'N':\n                $length = $length + 8;\n                break;\n            case 'L':\n                $legth++;\n                break;\n            case 'I':\n            case 'I4':\n            case 'F':\n                $length = $length + 4;\n                break;\n            case 'I1':\n                $length = $length + 1;\n                break;\n            case 'I2':\n                $length = $length + 2;\n                break;\n            case 'I8':\n                $length = $length + 8;\n                break;\n        }\n    }\n    if ($arrCols['dbtype'] == 'mysql' || $arrCols['dbtype'] == 'mysqli'){\n        if ($arrCols['dbengine']=='myISAM'){\n            $hard_limit = 4096;\n        }\n        elseif ($arrCols['dbengine'] == \"InnoDB\"){\n            $hard_limit = 1000;\n        }\n        else{\n            return false;\n        }\n\n        $size_limit = 65535;\n    }\n    elseif ($arrCols['dbtype'] == 'postgre'){\n        $hard_limit = 1600;\n        $size_limit = 0;\n    }\n    elseif ($arrCols['dbtype'] == 'mssql' || $arrCols['dbtype'] == 'dblib'){ \n        $hard_limit = 1024;\n        $size_limit = 0;\n    }\n    else{\n        return false;\n    }\n\n    $columns_used = count($arrCols['fields']);\n\n\n\n    return (array( 'dbtype'=>$arrCols['dbtype'], 'column'=>array($columns_used,$hard_limit) , 'size' => array($length, $size_limit) ));\n}\n\n/**\n*  Checks that each object from an array of CSV data [question-rows,answer-rows,labelsets-row] supports at least a given language\n*\n* @param mixed $csvarray array with a line of csv data per row\n* @param mixed $idkeysarray  array of integers giving the csv-row numbers of the object keys\n* @param mixed $langfieldnum  integer giving the csv-row number of the language(s) filed\n*        ==> the language field  can be a single language code or a\n*            space separated language code list\n* @param mixed $langcode  the language code to be tested\n* @param mixed $hasheader  if we should strip off the first line (if it contains headers)\n*/\nfunction  doesImportArraySupportLanguage($csvarray,$idkeysarray,$langfieldnum,$langcode, $hasheader = false)\n{\n    // An array with one row per object id and langsupport status as value\n    $objlangsupportarray=Array();\n    if ($hasheader === true )\n    { // stripping first row to skip headers if any\n        array_shift($csvarray);\n    }\n\n    foreach ($csvarray as $csvrow)\n    {\n        $rowcontents = convertCSVRowToArray($csvrow,',','\"');\n        $rowid = \"\";\n        foreach ($idkeysarray as $idfieldnum)\n        {\n            $rowid .= $rowcontents[$idfieldnum].\"-\";\n        }\n        $rowlangarray = explode (\" \", @$rowcontents[$langfieldnum]);\n        if (!isset($objlangsupportarray[$rowid]))\n        {\n            if (array_search($langcode,$rowlangarray)!== false)\n            {\n                $objlangsupportarray[$rowid] = \"true\";\n            }\n            else\n            {\n                $objlangsupportarray[$rowid] = \"false\";\n            }\n        }\n        else\n        {\n            if ($objlangsupportarray[$rowid] == \"false\" &&\n            array_search($langcode,$rowlangarray) !== false)\n            {\n                $objlangsupportarray[$rowid] = \"true\";\n            }\n        }\n    } // end foreach rown\n\n    // If any of the object doesn't support the given language, return false\n    if (array_search(\"false\",$objlangsupportarray) === false)\n    {\n        return true;\n    }\n    else\n    {\n        return false;\n    }\n}\n\n\n/**\n* Retrieve a HTML <OPTION> list of survey admin users\n*\n* @param mixed $bIncludeOwner If the survey owner should be included\n* @param mixed $bIncludeSuperAdmins If Super admins should be included\n* @param int surveyid\n* @return string\n*/\nfunction getSurveyUserList($bIncludeOwner=true, $bIncludeSuperAdmins=true,$surveyid)\n{\n    $clang = Yii::app()->lang;\n    $surveyid=sanitize_int($surveyid);\n\n    $sSurveyIDQuery = \"SELECT a.uid, a.users_name, a.full_name FROM {{users}} AS a\n    LEFT OUTER JOIN (SELECT uid AS id FROM {{permissions}} WHERE entity_id = {$surveyid} and entity='survey') AS b ON a.uid = b.id\n    WHERE id IS NULL \";\n    if (!$bIncludeSuperAdmins)\n    {\n      // @todo: Adjust for new permission system - not urgent since it it just display\n      //   $sSurveyIDQuery.='and superadmin=0 ';     \n    }\n    $sSurveyIDQuery.= 'ORDER BY a.users_name';\n    $oSurveyIDResult = Yii::app()->db->createCommand($sSurveyIDQuery)->query();  //Checked\n    $aSurveyIDResult = $oSurveyIDResult->readAll();\n\n    $surveyselecter = \"\";\n\n    if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == true)\n    {\n\n        $authorizedUsersList = getUserList('onlyuidarray');\n    }\n\n        foreach($aSurveyIDResult as $sv)\n        {\n            if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == false ||\n            in_array($sv['uid'],$authorizedUsersList))\n            {\n                $surveyselecter .= \"<option\";\n                $surveyselecter .=\" value='{$sv['uid']}'>{$sv['users_name']} {$sv['full_name']}</option>\\n\";\n            }\n        }\n    if (!isset($svexist)) {$surveyselecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;}\n    else {$surveyselecter = \"<option value='-1'>\".$clang->gT(\"None\").\"</option>\\n\".$surveyselecter;}\n\n    return $surveyselecter;\n}\n\nfunction getSurveyUserGroupList($outputformat='htmloptions',$surveyid)\n{\n    $clang = Yii::app()->lang;\n    $surveyid=sanitize_int($surveyid);\n\n    $surveyidquery = \"SELECT a.ugid, a.name, MAX(d.ugid) AS da\n    FROM {{user_groups}} AS a\n    LEFT JOIN (\n    SELECT b.ugid\n    FROM {{user_in_groups}} AS b\n    LEFT JOIN (SELECT * FROM {{permissions}}\n    WHERE entity_id = {$surveyid} and entity='survey') AS c ON b.uid = c.uid WHERE c.uid IS NULL\n    ) AS d ON a.ugid = d.ugid GROUP BY a.ugid, a.name HAVING MAX(d.ugid) IS NOT NULL\";\n    $surveyidresult = Yii::app()->db->createCommand($surveyidquery)->query();  //Checked\n    $aResult=$surveyidresult->readAll();\n\n    $surveyselecter = \"\";\n\n    if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == true)\n    {\n        $authorizedGroupsList=getUserGroupList(NULL, 'simplegidarray');\n    }\n\n    foreach($aResult as $sv)\n    {\n        if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == false ||\n        in_array($sv['ugid'],$authorizedGroupsList))\n        {\n            $surveyselecter .= \"<option\";\n            $surveyselecter .=\" value='{$sv['ugid']}'>{$sv['name']}</option>\\n\";\n            $simpleugidarray[] = $sv['ugid'];\n        }\n    }\n\n    if (!isset($svexist)) {$surveyselecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;}\n    else {$surveyselecter = \"<option value='-1'>\".$clang->gT(\"None\").\"</option>\\n\".$surveyselecter;}\n\n    if ($outputformat == 'simpleugidarray')\n    {\n        return $simpleugidarray;\n    }\n    else\n    {\n        return $surveyselecter;\n    }\n}\n\n\n\n/**\n* This function fixes the group ID and type on all subquestions\n*\n*/\nfunction fixSubquestions()\n{\n    $surveyidresult=Yii::app()->db->createCommand(\"select sq.qid, sq.parent_qid, sq.gid as sqgid, q.gid, sq.type as sqtype, q.type\n    from {{questions}} sq JOIN {{questions}} q on sq.parent_qid=q.qid\n    where sq.parent_qid>0 and  (sq.gid!=q.gid or sq.type!=q.type)\")->query();\n    foreach($surveyidresult->readAll() as $sv)\n    {\n        Yii::app()->db->createCommand(\"update {{questions}} set type='{$sv['type']}', gid={$sv['gid']} where qid={$sv['qid']}\")->query();\n    }\n\n}\n\n/**\n* Must use ls_json_encode to json_encode content, otherwise LimeExpressionManager will think that the associative arrays are expressions and try to parse them.\n*/\nfunction ls_json_encode($content)\n{\n    $ans = json_encode($content);\n    $ans = str_replace(array('{','}'),array('{ ',' }'), $ans);\n    return $ans;\n}\n\n/**\n * Decode a json string, sometimes needs stripslashes\n *\n * @param type $jsonString\n * @return type\n */\nfunction json_decode_ls($jsonString)\n{\n    $decoded = json_decode($jsonString, true);\n\n    if (is_null($decoded) && !empty($jsonString))\n    {\n        // probably we need stipslahes\n        $decoded = json_decode(stripslashes($jsonString), true);\n    }\n\n    return $decoded;\n}\n\n/**\n * Return accepted codingsArray for importing files\n *\n * Used in vvimport\n * TODO : use in token and \n * @return array\n */\nfunction aEncodingsArray()\n    {\n        $clang = Yii::app()->lang;\n        return array(\n        \"armscii8\" => $clang->gT(\"ARMSCII-8 Armenian\"),\n        \"ascii\" => $clang->gT(\"US ASCII\"),\n        \"auto\" => $clang->gT(\"Automatic\"),\n        \"big5\" => $clang->gT(\"Big5 Traditional Chinese\"),\n        \"binary\" => $clang->gT(\"Binary pseudo charset\"),\n        \"cp1250\" => $clang->gT(\"Windows Central European (Windows-1250)\"),\n        \"cp1251\" => $clang->gT(\"Windows Cyrillic (Windows-1251)\"),\n        \"cp1256\" => $clang->gT(\"Windows Arabic (Windows-1256)\"),\n        \"cp1257\" => $clang->gT(\"Windows Baltic (Windows-1257)\"),\n        \"cp850\" => $clang->gT(\"DOS West European (cp850)\"),\n        \"cp852\" => $clang->gT(\"DOS Central European (cp852)\"),\n        \"cp866\" => $clang->gT(\"DOS Cyrillic (cp866)\"),\n        \"cp932\" => $clang->gT(\"Windows-31J - SJIS for Windows Japanese (cp932)\"),\n        \"dec8\" => $clang->gT(\"DEC West European\"),\n        \"eucjpms\" => $clang->gT(\"UJIS for Windows Japanese\"),\n        \"euckr\" => $clang->gT(\"EUC-KR Korean\"),\n        \"gb2312\" => $clang->gT(\"GB2312 Simplified Chinese\"),\n        \"gbk\" => $clang->gT(\"GBK Simplified Chinese\"),\n        \"geostd8\" => $clang->gT(\"GEOSTD8 Georgian\"),\n        \"greek\" => $clang->gT(\"ISO 8859-7 Greek\"),\n        \"hebrew\" => $clang->gT(\"ISO 8859-8 Hebrew\"),\n        \"hp8\" => $clang->gT(\"HP West European\"),\n        \"keybcs2\" => $clang->gT(\"DOS Kamenicky Czech-Slovak (cp895)\"),\n        \"koi8r\" => $clang->gT(\"KOI8-R Relcom Russian\"),\n        \"koi8u\" => $clang->gT(\"KOI8-U Ukrainian\"),\n        \"latin1\" => $clang->gT(\"ISO 8859-1 West European (latin1)\"),\n        \"latin2\" => $clang->gT(\"ISO 8859-2 Central European (latin2)\"),\n        \"latin5\" => $clang->gT(\"ISO 8859-9 Turkish (latin5)\"),\n        \"latin7\" => $clang->gT(\"ISO 8859-13 Baltic (latin7)\"),\n        \"macce\" => $clang->gT(\"Mac Central European\"),\n        \"macroman\" => $clang->gT(\"Mac West European\"),\n        \"sjis\" => $clang->gT(\"Shift-JIS Japanese\"),\n        \"swe7\" => $clang->gT(\"7bit Swedish\"),\n        \"tis620\" => $clang->gT(\"TIS620 Thai\"),\n        \"ucs2\" => $clang->gT(\"UCS-2 Unicode\"),\n        \"ujis\" => $clang->gT(\"EUC-JP Japanese\"),\n        \"utf8\" => $clang->gT(\"UTF-8 Unicode\"),\n        );\n    }\n/**\n* Swaps two positions in an array\n*\n* @param mixed $key1\n* @param mixed $key2\n* @param mixed $array\n*/\nfunction arraySwapAssoc($key1, $key2, $array) {\n    $newArray = array ();\n    foreach ($array as $key => $value) {\n        if ($key == $key1) {\n            $newArray[$key2] = $array[$key2];\n        } elseif ($key == $key2) {\n            $newArray[$key1] = $array[$key1];\n        } else {\n            $newArray[$key] = $value;\n        }\n    }\n    return $newArray;\n}\n\n\n/**\n* Ellipsize String\n*\n* This public static function will strip tags from a string, split it at its max_length and ellipsize\n*\n* @param    string        string to ellipsize\n* @param    integer        max length of string\n* @param    mixed        int (1|0) or float, .5, .2, etc for position to split\n* @param    string        ellipsis ; Default '...'\n* @return    string        ellipsized string\n*/\nfunction ellipsize($sString, $iMaxLength, $fPosition = 1, $sEllipsis = '&hellip;')\n{\n    // Strip tags\n    $sString = trim(strip_tags($sString));\n    // Is the string long enough to ellipsize?\n    if (mb_strlen($sString,'UTF-8') <= $iMaxLength+3)\n    {\n        return $sString;\n    }\n\n    $iStrLen=mb_strlen($sString,'UTF-8');\n    $sBegin = mb_substr($sString, 0, floor($iMaxLength * $fPosition),'UTF-8');\n    $sEnd = mb_substr($sString,$iStrLen-($iMaxLength-mb_strlen($sBegin,'UTF-8')),$iStrLen,'UTF-8');\n    return $sBegin.$sEllipsis.$sEnd;\n}\n\n/**\n* This function returns the real IP address under all configurations\n*\n*/\nfunction getIPAddress()\n{\n    if (!empty($_SERVER['HTTP_CLIENT_IP']))   //check ip from share internet\n    {\n        $sIPAddress=$_SERVER['HTTP_CLIENT_IP'];\n    }\n    elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']))   //to check ip is pass from proxy\n    {\n        $sIPAddress= $_SERVER['HTTP_X_FORWARDED_FOR'];\n    }\n    elseif (!empty($_SERVER['REMOTE_ADDR']))\n    {\n        $sIPAddress= $_SERVER['REMOTE_ADDR'];\n    }\n    else\n    {\n        $sIPAddress= '127.0.0.1';\n    }\n    if (!filter_var($sIPAddress, FILTER_VALIDATE_IP))\n    {\n        return 'Invalid';\n    }\n    else\n    {\n       return $sIPAddress;\n    }\n}\n\n\n/**\n* This function tries to find out a valid language code for the language of the browser used\n* If it cannot find it it will return the default language from global settings\n*\n*/\nfunction getBrowserLanguage()\n{\n    $sLanguage=Yii::app()->getRequest()->getPreferredLanguage();\n    Yii::app()->loadHelper(\"surveytranslator\");\n    $aLanguages=getLanguageData();\n    if (!isset($aLanguages[$sLanguage]))\n    {\n        $sLanguage=str_replace('_','-',$sLanguage);\n        if (!isset($aLanguages[$sLanguage]))\n        {\n            $sLanguage=substr($sLanguage,0,strpos($sLanguage,'-'));\n            if (!isset($aLanguages[$sLanguage]))\n            {\n                $sLanguage=Yii::app()->getConfig('defaultlang');\n            }\n        }\n    }\n    return $sLanguage;\n}\n\nfunction array_diff_assoc_recursive($array1, $array2) {\n    $difference=array();\n    foreach($array1 as $key => $value) {\n        if( is_array($value) ) {\n            if( !isset($array2[$key]) || !is_array($array2[$key]) ) {\n                $difference[$key] = $value;\n            } else {\n                $new_diff = array_diff_assoc_recursive($value, $array2[$key]);\n                if( !empty($new_diff) )\n                    $difference[$key] = $new_diff;\n            }\n        } else if( !array_key_exists($key,$array2) || $array2[$key] !== $value ) {\n            $difference[$key] = $value;\n        }\n    }\n    return $difference;\n}\n\n\n    function convertPHPSizeToBytes($sSize)  \n    {  \n        //This function transforms the php.ini notation for numbers (like '2M') to an integer (2*1024*1024 in this case)  \n        $sSuffix = substr($sSize, -1);  \n        $iValue = substr($sSize, 0, -1);  \n        switch(strtoupper($sSuffix)){  \n        case 'P':  \n            $iValue *= 1024;  \n        case 'T':  \n            $iValue *= 1024;  \n        case 'G':  \n            $iValue *= 1024;  \n        case 'M':  \n            $iValue *= 1024;  \n        case 'K':  \n            $iValue *= 1024;  \n            break;  \n        }  \n        return $iValue;  \n    }  \n      \n    function getMaximumFileUploadSize()  \n    {  \n        return min(convertPHPSizeToBytes(ini_get('post_max_size')), convertPHPSizeToBytes(ini_get('upload_max_filesize')));  \n    }  \n\n// Closing PHP tag intentionally omitted - yes, it is okay\n\n", "<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');\n/*\n* LimeSurvey\n* Copyright (C) 2007-2012 The LimeSurvey Project Team / Carsten Schmitz\n* All rights reserved.\n* License: GNU/GPL License v2 or later, see LICENSE.php\n* LimeSurvey is free software. This version may have been modified pursuant\n* to the GNU General Public License, and as distributed it includes or\n* is derivative of works licensed under the GNU General Public License or\n* other free or open source software licenses.\n* See COPYRIGHT.php for copyright notices and details.\n*/\n\nfunction loadanswers()\n{\n    global $surveyid;\n    global $thissurvey, $thisstep;\n    global $clienttoken;\n    $clang = Yii::app()->lang;\n\n    $scid=returnGlobal('scid',true);\n    if (Yii::app()->request->getParam('loadall') == \"reload\")\n    {\n        $query = \"SELECT * FROM {{saved_control}} INNER JOIN {$thissurvey['tablename']}\n        ON {{saved_control}}.srid = {$thissurvey['tablename']}.id\n        WHERE {{saved_control}}.sid=$surveyid\\n\";\n        if (isset($scid)) //Would only come from email\n\n        {\n            $query .= \"AND {{saved_control}}.scid={$scid}\\n\";\n        }\n        $query .=\"AND {{saved_control}}.identifier = '\".autoEscape($_SESSION['survey_'.$surveyid]['holdname']).\"' \";\n\n        if (in_array(Yii::app()->db->getDriverName(), array('mssql', 'sqlsrv', 'dblib')))\n        {\n            $query .=\"AND CAST({{saved_control}}.access_code as varchar(32))= '\".md5($_SESSION['survey_'.$surveyid]['holdpass']).\"'\\n\";\n        }\n        else\n        {\n            $query .=\"AND {{saved_control}}.access_code = '\".md5($_SESSION['survey_'.$surveyid]['holdpass']).\"'\\n\";// md5 don't need to be escaped\n        }\n    }\n    elseif (isset($_SESSION['survey_'.$surveyid]['srid']))\n    {\n        $query = \"SELECT * FROM {$thissurvey['tablename']}\n        WHERE {$thissurvey['tablename']}.id=\".$_SESSION['survey_'.$surveyid]['srid'].\"\\n\";\n    }\n    else\n    {\n        return;\n    }\n    $aRow = Yii::app()->db->createCommand($query)->queryRow();// TODO : use Yii for query\n    if (!$aRow)\n    {\n        return false;\n    }\n    else\n    {\n        //A match has been found. Let's load the values!\n        //If this is from an email, build surveysession first\n        $_SESSION['survey_'.$surveyid]['LEMtokenResume']=true;\n        // Get if survey is been answered\n        $submitdate=$aRow['submitdate'];\n        foreach ($aRow as $column => $value)\n        {\n            if ($column == \"token\")\n            {\n                $clienttoken=$value;\n                $token=$value;\n            }\n            elseif ($column == \"saved_thisstep\" && $thissurvey['alloweditaftercompletion'] != 'Y' )\n            {\n                $_SESSION['survey_'.$surveyid]['step']=($value>1? $value:1) ;\n                $thisstep=$_SESSION['survey_'.$surveyid]['step']-1;\n            }\n            elseif ($column =='lastpage' && isset($_GET['token']))\n            {\n                if(is_null($submitdate) || $submitdate==\"N\")\n                {\n                    $_SESSION['survey_'.$surveyid]['step']=($value>1? $value:1) ;\n                    $thisstep=$_SESSION['survey_'.$surveyid]['step']-1;\n                }\n                else\n                {\n                    $_SESSION['survey_'.$surveyid]['maxstep']=($value>1? $value:1) ;\n                }\n            }\n            /*\n            Commented this part out because otherwise startlanguage would overwrite any other language during a running survey.\n            We will need a new field named 'endlanguage' to save the current language (for example for returning participants)\n            /the language the survey was completed in.\n            elseif ($column =='startlanguage')\n            {\n            $clang = SetSurveyLanguage( $surveyid, $value);\n            UpdateSessionGroupList($value);  // to refresh the language strings in the group list session variable\n            UpdateFieldArray();        // to refresh question titles and question text\n            }*/\n            elseif ($column == \"scid\")\n            {\n                $_SESSION['survey_'.$surveyid]['scid']=$value;\n            }\n            elseif ($column == \"srid\")\n            {\n                $_SESSION['survey_'.$surveyid]['srid']=$value;\n            }\n            elseif ($column == \"datestamp\")\n            {\n                $_SESSION['survey_'.$surveyid]['datestamp']=$value;\n            }\n            if ($column == \"startdate\")\n            {\n                $_SESSION['survey_'.$surveyid]['startdate']=$value;\n            }\n            else\n            {\n                //Only make session variables for those in insertarray[]\n                if (in_array($column, $_SESSION['survey_'.$surveyid]['insertarray']) && isset($_SESSION['survey_'.$surveyid]['fieldmap'][$column]))\n                {\n                    if (($_SESSION['survey_'.$surveyid]['fieldmap'][$column]['type'] == 'N' ||\n                    $_SESSION['survey_'.$surveyid]['fieldmap'][$column]['type'] == 'K' ||\n                    $_SESSION['survey_'.$surveyid]['fieldmap'][$column]['type'] == 'D') && $value == null)\n                    {   // For type N,K,D NULL in DB is to be considered as NoAnswer in any case.\n                        // We need to set the _SESSION[field] value to '' in order to evaluate conditions.\n                        // This is especially important for the deletenonvalue feature,\n                        // otherwise we would erase any answer with condition such as EQUALS-NO-ANSWER on such\n                        // question types (NKD)\n                        $_SESSION['survey_'.$surveyid][$column]='';\n                    }\n                    else\n                    {\n                        $_SESSION['survey_'.$surveyid][$column]=$value;\n                    }\n                }  // if (in_array(\n            }  // else\n        } // foreach\n    }\n    return true;\n}\n\nfunction makegraph($currentstep, $total)\n{\n    global $thissurvey;\n\n    $clang = Yii::app()->lang;\n    Yii::app()->getClientScript()->registerCssFile(Yii::app()->getConfig('publicstyleurl') . 'lime-progress.css');\n    $size = intval(($currentstep-1)/$total*100);\n\n    $graph = '<script type=\"text/javascript\">\n    $(document).ready(function() {\n    $(\"#progressbar\").progressbar({\n    value: '.$size.'\n    });\n    ;});';\n    if (getLanguageRTL($clang->langcode))\n    {\n        $graph.='\n        $(document).ready(function() {\n        $(\"div.ui-progressbar-value\").removeClass(\"ui-corner-left\");\n        $(\"div.ui-progressbar-value\").addClass(\"ui-corner-right\");\n        });';\n    }\n    $graph.='\n    </script>\n\n    <div id=\"progress-wrapper\">\n    <span class=\"hide\">'.sprintf($clang->gT('You have completed %s%% of this survey'),$size).'</span>\n    <div id=\"progress-pre\">';\n    if (getLanguageRTL($clang->langcode))\n    {\n        $graph.='100%';\n    }\n    else\n    {\n        $graph.='0%';\n    }\n\n    $graph.='</div>\n    <div id=\"progressbar\"></div>\n    <div id=\"progress-post\">';\n    if (getLanguageRTL($clang->langcode))\n    {\n        $graph.='0%';\n    }\n    else\n    {\n        $graph.='100%';\n    }\n    $graph.='</div>\n    </div>';\n\n    if ($size == 0) // Progress bar looks dumb if 0\n\n    {\n        $graph.='\n        <script type=\"text/javascript\">\n        $(document).ready(function() {\n        $(\"div.ui-progressbar-value\").hide();\n        });\n        </script>';\n    }\n\n    return $graph;\n}\n\n/**\n* This function creates the language selector for a particular survey\n*\n* @param mixed $sSelectedLanguage The language in which all information is shown\n*/\nfunction makeLanguageChangerSurvey($sSelectedLanguage)\n{\n    $surveyid = Yii::app()->getConfig('surveyID');\n    $clang = Yii::app()->lang;\n    Yii::app()->loadHelper(\"surveytranslator\");\n\n    $aSurveyLangs = Survey::model()->findByPk($surveyid)->getAllLanguages();\n    if (count($aSurveyLangs)>1) // return a dropdow only of there are more than one lanagage\n    {\n        $aAllLanguages=getLanguageData(true);\n        $aSurveyLangs=array_intersect_key($aAllLanguages,array_flip($aSurveyLangs)); // Sort languages by their locale name\n        $sClass=\"languagechanger\";\n        $sHTMLCode=\"\";\n        $sAction=Yii::app()->request->getParam('action','');// Different behaviour if preview\n        $sSelected=\"\";\n        if(substr($sAction,0,7)=='preview')\n        {\n            $route=\"/survey/index/sid/{$surveyid}\";\n            if ($sAction=='previewgroup' && intval(Yii::app()->request->getParam('gid',0)))\n            {\n                $route.=\"/action/previewgroup/gid/\".intval(Yii::app()->request->getParam('gid',0));\n            }\n            if ($sAction=='previewquestion' && intval(Yii::app()->request->getParam('gid',0)) && intval(Yii::app()->request->getParam('qid',0)))\n            {\n                $route.=\"/action/previewquestion/gid/\".intval(Yii::app()->request->getParam('gid',0)).\"/qid/\".intval(Yii::app()->request->getParam('qid',0));\n            }\n            if (!is_null(Yii::app()->request->getParam('token')))\n            {\n                $route.=\"/token/\".Yii::app()->request->getParam('token');\n            }\n            $sClass.=\" previewmode\";\n            // Maybe add other param (for prefilling by URL): then need a real createUrl with array\n#            foreach ($aSurveyLangs as $sLangCode => $aSurveyLang)\n#            {\n#                $sTargetURL=Yii::app()->getController()->createUrl($route.\"/lang/$sLangCode\");\n#                $aListLang[$sTargetURL]=html_entity_decode($aSurveyLang['nativedescription'], ENT_COMPAT,'UTF-8');\n#                if($clang->langcode==$sLangCode)\n#                    $sSelected=$sTargetURL;\n#            }\n        }\n        else\n        {\n            $route=\"/survey/index/sid/{$surveyid}\";\n        }\n        $sTargetURL=Yii::app()->getController()->createUrl($route);\n        foreach ($aSurveyLangs as $sLangCode => $aSurveyLang)\n        {\n            $aListLang[$sLangCode]=html_entity_decode($aSurveyLang['nativedescription'], ENT_COMPAT,'UTF-8');\n        }\n        $sSelected=$clang->langcode;\n        $sHTMLCode=CHtml::label($clang->gT(\"Choose another language\"), 'lang',array('class'=>'hide label'));\n        $sHTMLCode.=CHtml::dropDownList('lang', $sSelected,$aListLang,array('class'=>$sClass,'data-targeturl'=>$sTargetURL));\n        // We don't have to add this button if in previewmode\n        $sHTMLCode.= CHtml::htmlButton($clang->gT(\"Change the language\"),array('type'=>'submit','id'=>\"changelangbtn\",'value'=>'changelang','name'=>'changelang','class'=>'changelang jshide'));\n        return $sHTMLCode;\n    }\n    else\n    {\n        return false;\n    }\n\n}\n\n/**\n* This function creates the language selector for the public survey index page\n*\n* @param mixed $sSelectedLanguage The language in which all information is shown\n*/\nfunction makeLanguageChanger($sSelectedLanguage)\n{\n    $aLanguages=getLanguageDataRestricted(true,$sSelectedLanguage);// Order by native\n    if(count($aLanguages)>1)\n    {\n#        $sHTMLCode = \"<select id='languagechanger' name='languagechanger' class='languagechanger' onchange='javascript:window.location=this.value'>\\n\";\n#        foreach(getLanguageDataRestricted(true, $sSelectedLanguage) as $sLanguageID=>$aLanguageProperties)\n#        {\n#            $sLanguageUrl=Yii::app()->getController()->createUrl('survey/index',array('lang'=>$sLanguageID));\n#            $sHTMLCode .= \"<option value='{$sLanguageUrl}'\";\n#            if($sLanguageID == $sSelectedLanguage)\n#            {\n#                $sHTMLCode .= \" selected='selected' \";\n#                $sHTMLCode .= \">{$aLanguageProperties['nativedescription']}</option>\\n\";\n#            }\n#            else\n#            {\n#                $sHTMLCode .= \">\".$aLanguageProperties['nativedescription'].' - '.$aLanguageProperties['description'].\"</option>\\n\";\n#            }\n#        }\n#        $sHTMLCode .= \"</select>\\n\";\n        $clang = Yii::app()->lang;\n        $sClass= \"languagechanger\";\n        foreach ($aLanguages as $sLangCode => $aLanguage)\n            $aListLang[$sLangCode]=html_entity_decode($aLanguage['nativedescription'], ENT_COMPAT,'UTF-8').' - '.$aLanguage['description'];\n        $sSelected=$sSelectedLanguage;\n\n        $sHTMLCode= CHtml::beginForm(App()->createUrl('surveys/publiclist'),'get');\n        $sHTMLCode.=CHtml::label($clang->gT(\"Choose another language\"), 'lang',array('class'=>'hide label'));\n        $sHTMLCode.= CHtml::dropDownList('lang', $sSelected,$aListLang,array('class'=>$sClass));\n        //$sHTMLCode.= CHtml::htmlButton($clang->gT(\"Change the language\"),array('type'=>'submit','id'=>\"changelangbtn\",'value'=>'changelang','name'=>'changelang','class'=>'jshide'));\n        $sHTMLCode.=\"<button class='changelang jshide' value='changelang' id='changelangbtn' type='submit'>\".$clang->gT(\"Change the language\").\"</button>\";\n        $sHTMLCode.= CHtml::endForm();\n        return $sHTMLCode;\n    }\n    else\n    {\n        return false;\n    }\n}\n\n\n\n/**\n* checkUploadedFileValidity used in SurveyRuntimeHelper\n*/\nfunction checkUploadedFileValidity($surveyid, $move, $backok=null)\n{\n    global $thisstep;\n    $clang = Yii::app()->lang;\n\n    if (!isset($backok) || $backok != \"Y\")\n    {\n        $fieldmap = createFieldMap($surveyid,'full',false,false,$_SESSION['survey_'.$surveyid]['s_lang']);\n\n        if (isset($_POST['fieldnames']) && $_POST['fieldnames']!=\"\")\n        {\n            $fields = explode(\"|\", $_POST['fieldnames']);\n\n            foreach ($fields as $field)\n            {\n                if ($fieldmap[$field]['type'] == \"|\" && !strrpos($fieldmap[$field]['fieldname'], \"_filecount\"))\n                {\n                    $validation= getQuestionAttributeValues($fieldmap[$field]['qid']);\n\n                    $filecount = 0;\n\n                    $json = $_POST[$field];\n                    // if name is blank, its basic, hence check\n                    // else, its ajax, don't check, bypass it.\n\n                    if ($json != \"\" && $json != \"[]\")\n                    {\n                        $phparray = json_decode(stripslashes($json));\n                        if ($phparray[0]->size != \"\")\n                        { // ajax\n                            $filecount = count($phparray);\n                        }\n                        else\n                        { // basic\n                            for ($i = 1; $i <= $validation['max_num_of_files']; $i++)\n                            {\n                                if (!isset($_FILES[$field.\"_file_\".$i]) || $_FILES[$field.\"_file_\".$i]['name'] == '')\n                                    continue;\n\n                                $filecount++;\n\n                                $file = $_FILES[$field.\"_file_\".$i];\n\n                                // File size validation\n                                if ($file['size'] > $validation['max_filesize'] * 1000)\n                                {\n                                    $filenotvalidated = array();\n                                    $filenotvalidated[$field.\"_file_\".$i] = sprintf($clang->gT(\"Sorry, the uploaded file (%s) is larger than the allowed filesize of %s KB.\"), $file['size'], $validation['max_filesize']);\n                                    $append = true;\n                                }\n\n                                // File extension validation\n                                $pathinfo = pathinfo(basename($file['name']));\n                                $ext = $pathinfo['extension'];\n\n                                $validExtensions = explode(\",\", $validation['allowed_filetypes']);\n                                if (!(in_array($ext, $validExtensions)))\n                                {\n                                    if (isset($append) && $append)\n                                    {\n                                        $filenotvalidated[$field.\"_file_\".$i] .= sprintf($clang->gT(\"Sorry, only %s extensions are allowed!\"),$validation['allowed_filetypes']);\n                                        unset($append);\n                                    }\n                                    else\n                                    {\n                                        $filenotvalidated = array();\n                                        $filenotvalidated[$field.\"_file_\".$i] .= sprintf($clang->gT(\"Sorry, only %s extensions are allowed!\"),$validation['allowed_filetypes']);\n                                    }\n                                }\n                            }\n                        }\n                    }\n                    else\n                        $filecount = 0;\n\n                    if (isset($validation['min_num_of_files']) && $filecount < $validation['min_num_of_files'] && LimeExpressionManager::QuestionIsRelevant($fieldmap[$field]['qid']))\n                    {\n                        $filenotvalidated = array();\n                        $filenotvalidated[$field] = $clang->gT(\"The minimum number of files has not been uploaded.\");\n                    }\n                }\n            }\n        }\n        if (isset($filenotvalidated))\n        {\n            if (isset($move) && $move == \"moveprev\")\n                $_SESSION['survey_'.$surveyid]['step'] = $thisstep;\n            if (isset($move) && $move == \"movenext\")\n                $_SESSION['survey_'.$surveyid]['step'] = $thisstep;\n            return $filenotvalidated;\n        }\n    }\n    if (!isset($filenotvalidated))\n        return false;\n    else\n        return $filenotvalidated;\n}\n\n/**\n* Takes two single element arrays and adds second to end of first if value exists\n* Why not use array_merge($array1,array_filter($array2);\n*/\nfunction addtoarray_single($array1, $array2)\n{\n    //\n    if (is_array($array2))\n    {\n        foreach ($array2 as $ar)\n        {\n            if ($ar && $ar !== null)\n            {\n                $array1[]=$ar;\n            }\n        }\n    }\n    return $array1;\n}\n\n/**\n* Marks a tokens as completed and sends a confirmation email to the participiant.\n* If $quotaexit is set to true then the user exited the survey due to a quota\n* restriction and the according token is only marked as 'Q'\n*\n* @param mixed $quotaexit\n*/\nfunction submittokens($quotaexit=false)\n{\n    $surveyid=Yii::app()->getConfig('surveyID');\n    if(isset($_SESSION['survey_'.$surveyid]['s_lang']))\n    {\n        $thissurvey=getSurveyInfo($surveyid,$_SESSION['survey_'.$surveyid]['s_lang']);\n    }\n    else\n    {\n        $thissurvey=getSurveyInfo($surveyid);\n    }\n    $clienttoken = $_SESSION['survey_'.$surveyid]['token'];\n\n    $sitename = Yii::app()->getConfig(\"sitename\");\n    $emailcharset = Yii::app()->getConfig(\"emailcharset\");\n    // Shift the date due to global timeadjust setting\n    $today = dateShift(date(\"Y-m-d H:i:s\"), \"Y-m-d H:i\", Yii::app()->getConfig(\"timeadjust\"));\n\n    // check how many uses the token has left\n\t$token = Token::model($surveyid)->findByAttributes(array('token' => $clienttoken));\n\n\tif ($quotaexit==true)\n    {\n        $token->completed = 'Q';\n        $token->usesleft--;\n    }\n    else\n    {\n        if ($token->usesleft <= 1)\n        {\n            // Finish the token\n            if (isTokenCompletedDatestamped($thissurvey))\n            {\n                $token->completed = $today;\n            } else {\n                $token->completed = 'Y';\n            }\n            if(isset($token->participant_id))\n            {\n                $slquery = SurveyLink::model()->find('participant_id = :pid AND survey_id = :sid AND token_id = :tid', array(':pid'=> $token->participant_id, ':sid'=>$surveyid, ':tid'=>$token->tid));\n                if ($slquery)\n                {                \n                    if (isTokenCompletedDatestamped($thissurvey))\n                    {\n                        $slquery->date_completed = $today;\n                    } else {\n                        // Update the survey_links table if necessary, to protect anonymity, use the date_created field date\n                        $slquery->date_completed = $slquery->date_created;\n                    }\n                    $slquery->save();\n                }\n            }\n        }\n        $token->usesleft--;\n    }\n    $token->save();\n\n    if ($quotaexit==false)\n    {\n        if ($token && trim(strip_tags($thissurvey['email_confirm'])) != \"\" && $thissurvey['sendconfirmation'] == \"Y\")\n        {\n         //   if($token->completed == \"Y\" || $token->completed == $today)\n//            {\n                $from = \"{$thissurvey['adminname']} <{$thissurvey['adminemail']}>\";\n                $to = $token->email;\n                $subject=$thissurvey['email_confirm_subj'];\n\n                $aReplacementVars=array();\n                $aReplacementVars[\"ADMINNAME\"]=$thissurvey['admin'];\n                $aReplacementVars[\"ADMINEMAIL\"]=$thissurvey['adminemail'];\n                $aReplacementVars['ADMINEMAIL'] = $thissurvey['adminemail'];\n                //Fill with token info, because user can have his information with anonimity control\n                $aReplacementVars[\"FIRSTNAME\"]=$token->firstname;\n                $aReplacementVars[\"LASTNAME\"]=$token->lastname;\n                $aReplacementVars[\"TOKEN\"]=$token->token;\n                // added survey url in replacement vars\n                $surveylink = Yii::app()->createAbsoluteUrl(\"/survey/index/sid/{$surveyid}\",array('lang'=>$_SESSION['survey_'.$surveyid]['s_lang'],'token'=>$token->token));\n                $aReplacementVars['SURVEYURL'] = $surveylink;\n                \n                $attrfieldnames=getAttributeFieldNames($surveyid);\n                foreach ($attrfieldnames as $attr_name)\n                {\n                    $aReplacementVars[strtoupper($attr_name)] = $token->$attr_name;\n                }\n\n                $dateformatdatat=getDateFormatData($thissurvey['surveyls_dateformat']);\n                $numberformatdatat = getRadixPointData($thissurvey['surveyls_numberformat']);\n                $redata=array('thissurvey'=>$thissurvey);\n                $subject=templatereplace($subject,$aReplacementVars,$redata);\n\n                $subject=html_entity_decode($subject,ENT_QUOTES,$emailcharset);\n\n                if (getEmailFormat($surveyid) == 'html')\n                {\n                    $ishtml=true;\n                }\n                else\n                {\n                    $ishtml=false;\n                }\n\n                $message=$thissurvey['email_confirm'];\n                //$message=ReplaceFields($message, $fieldsarray, true);\n                $message=templatereplace($message,$aReplacementVars,$redata);\n                if (!$ishtml)\n                {\n                    $message=strip_tags(breakToNewline(html_entity_decode($message,ENT_QUOTES,$emailcharset)));\n                }\n                else\n                {\n                    $message=html_entity_decode($message,ENT_QUOTES, $emailcharset );\n                }\n\n                //Only send confirmation email if there is a valid email address\n            if (validateEmailAddress($to)) {\n                $aAttachments = unserialize($thissurvey['attachments']);\n    \n                $aRelevantAttachments = array();\n                /*\n                 * Iterate through attachments and check them for relevance.\n                 */\n                if (isset($aAttachments['confirmation']))\n                {\n                    foreach ($aAttachments['confirmation'] as $aAttachment)\n                    {\n                        $relevance = $aAttachment['relevance'];\n                        // If the attachment is relevant it will be added to the mail.\n                        if (LimeExpressionManager::ProcessRelevance($relevance) && file_exists($aAttachment['url']))\n                        {\n                            $aRelevantAttachments[] = $aAttachment['url'];\n                        }\n                    }\n                }\n                SendEmailMessage($message, $subject, $to, $from, $sitename, $ishtml, null, $aRelevantAttachments);\n            }\n     //   } else {\n                // Leave it to send optional confirmation at closed token\n  //          }\n        }\n    }\n}\n\n/**\n* Send a submit notification to the email address specified in the notifications tab in the survey settings\n*/\nfunction sendSubmitNotifications($surveyid)\n{\n    // @todo: Remove globals\n    global $thissurvey, $maildebug, $tokensexist;\n    \n    if (trim($thissurvey['adminemail'])=='')\n    {\n        return;\n    }\n    \n    $homeurl=Yii::app()->createAbsoluteUrl('/admin');\n    $clang = Yii::app()->lang;\n    $sitename = Yii::app()->getConfig(\"sitename\");\n\n    $debug=Yii::app()->getConfig('debug');\n    $bIsHTML = ($thissurvey['htmlemail'] == 'Y');\n\n    $aReplacementVars=array();\n\n    if ($thissurvey['allowsave'] == \"Y\" && isset($_SESSION['survey_'.$surveyid]['scid']))\n    {\n        $aReplacementVars['RELOADURL']=\"\".Yii::app()->getController()->createUrl(\"/survey/index/sid/{$surveyid}/loadall/reload/scid/\".$_SESSION['survey_'.$surveyid]['scid'].\"/loadname/\".urlencode($_SESSION['survey_'.$surveyid]['holdname']).\"/loadpass/\".urlencode($_SESSION['survey_'.$surveyid]['holdpass']).\"/lang/\".urlencode($clang->langcode));\n        if ($bIsHTML)\n        {\n            $aReplacementVars['RELOADURL']=\"<a href='{$aReplacementVars['RELOADURL']}'>{$aReplacementVars['RELOADURL']}</a>\";\n        }\n    }\n    else\n    {\n        $aReplacementVars['RELOADURL']='';\n    }\n\n    if (!isset($_SESSION['survey_'.$surveyid]['srid']))\n        $srid = null;\n    else\n        $srid = $_SESSION['survey_'.$surveyid]['srid'];\n    $aReplacementVars['ADMINNAME'] = $thissurvey['adminname'];\n    $aReplacementVars['ADMINEMAIL'] = $thissurvey['adminemail'];\n    $aReplacementVars['VIEWRESPONSEURL']=Yii::app()->createAbsoluteUrl(\"/admin/responses/sa/view/surveyid/{$surveyid}/id/{$srid}\");\n    $aReplacementVars['EDITRESPONSEURL']=Yii::app()->createAbsoluteUrl(\"/admin/dataentry/sa/editdata/subaction/edit/surveyid/{$surveyid}/id/{$srid}\");\n    $aReplacementVars['STATISTICSURL']=Yii::app()->createAbsoluteUrl(\"/admin/statistics/sa/index/surveyid/{$surveyid}\");\n    if ($bIsHTML)\n    {\n        $aReplacementVars['VIEWRESPONSEURL']=\"<a href='{$aReplacementVars['VIEWRESPONSEURL']}'>{$aReplacementVars['VIEWRESPONSEURL']}</a>\";\n        $aReplacementVars['EDITRESPONSEURL']=\"<a href='{$aReplacementVars['EDITRESPONSEURL']}'>{$aReplacementVars['EDITRESPONSEURL']}</a>\";\n        $aReplacementVars['STATISTICSURL']=\"<a href='{$aReplacementVars['STATISTICSURL']}'>{$aReplacementVars['STATISTICSURL']}</a>\";\n    }\n    $aReplacementVars['ANSWERTABLE']='';\n    $aEmailResponseTo=array();\n    $aEmailNotificationTo=array();\n    $sResponseData=\"\";\n\n    if (!empty($thissurvey['emailnotificationto']))\n    {\n        $aRecipient=explode(\";\", ReplaceFields($thissurvey['emailnotificationto'],array('ADMINEMAIL' =>$thissurvey['adminemail'] ), true));\n        foreach($aRecipient as $sRecipient)\n        {\n            if(validateEmailAddress($sRecipient))\n            {\n                $aEmailNotificationTo[]=$sRecipient;\n            }\n        }\n    }\n\n    if (!empty($thissurvey['emailresponseto']))\n    {\n        // there was no token used so lets remove the token field from insertarray\n        if (!isset($_SESSION['survey_'.$surveyid]['token']) && $_SESSION['survey_'.$surveyid]['insertarray'][0]=='token')\n        {\n            unset($_SESSION['survey_'.$surveyid]['insertarray'][0]);\n        }\n        //Make an array of email addresses to send to\n        $aRecipient=explode(\";\", ReplaceFields($thissurvey['emailresponseto'],array('ADMINEMAIL' =>$thissurvey['adminemail'] ), true));\n        foreach($aRecipient as $sRecipient)\n        {\n            if(validateEmailAddress($sRecipient))\n            {\n                $aEmailResponseTo[]=$sRecipient;\n            }\n        }\n\n        $aFullResponseTable=getFullResponseTable($surveyid,$_SESSION['survey_'.$surveyid]['srid'],$_SESSION['survey_'.$surveyid]['s_lang']);\n        $ResultTableHTML = \"<table class='printouttable' >\\n\";\n        $ResultTableText =\"\\n\\n\";\n        $oldgid = 0;\n        $oldqid = 0;\n        foreach ($aFullResponseTable as $sFieldname=>$fname)\n        {\n            if (substr($sFieldname,0,4)=='gid_')\n            {\n\n                $ResultTableHTML .= \"\\t<tr class='printanswersgroup'><td colspan='2'>{$fname[0]}</td></tr>\\n\";\n                $ResultTableText .=\"\\n{$fname[0]}\\n\\n\";\n            }\n            elseif (substr($sFieldname,0,4)=='qid_')\n            {\n                $ResultTableHTML .= \"\\t<tr class='printanswersquestionhead'><td  colspan='2'>{$fname[0]}</td></tr>\\n\";\n                $ResultTableText .=\"\\n{$fname[0]}\\n\";\n            }\n            else\n            {\n                $ResultTableHTML .= \"\\t<tr class='printanswersquestion'><td>{$fname[0]} {$fname[1]}</td><td class='printanswersanswertext'>{$fname[2]}</td></tr>\";\n                $ResultTableText .=\"     {$fname[0]} {$fname[1]}: {$fname[2]}\\n\";\n            }\n        }\n\n        $ResultTableHTML .= \"</table>\\n\";\n        $ResultTableText .= \"\\n\\n\";\n        if ($bIsHTML)\n        {\n            $aReplacementVars['ANSWERTABLE']=$ResultTableHTML;\n        }\n        else\n        {\n            $aReplacementVars['ANSWERTABLE']=$ResultTableText;\n        }\n    }\n\n    $sFrom = $thissurvey['adminname'].' <'.$thissurvey['adminemail'].'>';\n\n    $aAttachments = unserialize($thissurvey['attachments']);\n    \n    $aRelevantAttachments = array();\n    /*\n     * Iterate through attachments and check them for relevance.\n     */\n    if (isset($aAttachments['admin_notification']))\n    {\n        foreach ($aAttachments['admin_notification'] as $aAttachment)\n        {\n            $relevance = $aAttachment['relevance'];\n            // If the attachment is relevant it will be added to the mail.\n            if (LimeExpressionManager::ProcessRelevance($relevance) && file_exists($aAttachment['url']))\n            {\n                $aRelevantAttachments[] = $aAttachment['url'];\n            }\n        }\n    }\n    \n    $redata=compact(array_keys(get_defined_vars()));\n    if (count($aEmailNotificationTo)>0)\n    {\n        $sMessage=templatereplace($thissurvey['email_admin_notification'],$aReplacementVars,$redata,'frontend_helper[1398]',($thissurvey['anonymized'] == \"Y\"),NULL, array(), true);\n        $sSubject=templatereplace($thissurvey['email_admin_notification_subj'],$aReplacementVars,$redata,'frontend_helper[1399]',($thissurvey['anonymized'] == \"Y\"),NULL, array(), true);\n        foreach ($aEmailNotificationTo as $sRecipient)\n        {\n        if (!SendEmailMessage($sMessage, $sSubject, $sRecipient, $sFrom, $sitename, true, getBounceEmail($surveyid), $aRelevantAttachments))\n            {\n                if ($debug>0)\n                {\n                    echo '<br />Email could not be sent. Reason: '.$maildebug.'<br/>';\n                }\n            }\n        }\n    }\n\n        $aRelevantAttachments = array();\n    /*\n     * Iterate through attachments and check them for relevance.\n     */\n    if (isset($aAttachments['detailed_admin_notification']))\n    {\n        foreach ($aAttachments['detailed_admin_notification'] as $aAttachment)\n        {\n            $relevance = $aAttachment['relevance'];\n            // If the attachment is relevant it will be added to the mail.\n            if (LimeExpressionManager::ProcessRelevance($relevance) && file_exists($aAttachment['url']))\n            {\n                $aRelevantAttachments[] = $aAttachment['url'];\n            }\n        }\n    }\n    if (count($aEmailResponseTo)>0)\n    {\n        $sMessage=templatereplace($thissurvey['email_admin_responses'],$aReplacementVars,$redata,'frontend_helper[1414]',($thissurvey['anonymized'] == \"Y\"));\n        $sSubject=templatereplace($thissurvey['email_admin_responses_subj'],$aReplacementVars,$redata,'frontend_helper[1415]',($thissurvey['anonymized'] == \"Y\"));\n        foreach ($aEmailResponseTo as $sRecipient)\n        {\n        if (!SendEmailMessage($sMessage, $sSubject, $sRecipient, $sFrom, $sitename, true, getBounceEmail($surveyid), $aRelevantAttachments))\n            {\n                if ($debug>0)\n                {\n                    echo '<br />Email could not be sent. Reason: '.$maildebug.'<br/>';\n                }\n            }\n        }\n    }\n\n\n}\n\n/**\n* submitfailed : used in em_manager_helper.php\n*/\nfunction submitfailed($errormsg='')\n{\n    global $debug;\n    global $thissurvey;\n    global $subquery, $surveyid;\n\n    $clang = Yii::app()->lang;\n\n    $completed = \"<br /><strong><font size='2' color='red'>\"\n    . $clang->gT(\"Did Not Save\").\"</strong></font><br /><br />\\n\\n\"\n    . $clang->gT(\"An unexpected error has occurred and your responses cannot be saved.\").\"<br /><br />\\n\";\n    if ($thissurvey['adminemail'])\n    {\n        $completed .= $clang->gT(\"Your responses have not been lost and have been emailed to the survey administrator and will be entered into our database at a later point.\").\"<br /><br />\\n\";\n        if ($debug>0)\n        {\n            $completed.='Error message: '.htmlspecialchars($errormsg).'<br />';\n        }\n        $email=$clang->gT(\"An error occurred saving a response to survey id\",\"unescaped\").\" \".$thissurvey['name'].\" - $surveyid\\n\\n\";\n        $email .= $clang->gT(\"DATA TO BE ENTERED\",\"unescaped\").\":\\n\";\n        foreach ($_SESSION['survey_'.$surveyid]['insertarray'] as $value)\n        {\n            $email .= \"$value: {$_SESSION['survey_'.$surveyid][$value]}\\n\";\n        }\n        $email .= \"\\n\".$clang->gT(\"SQL CODE THAT FAILED\",\"unescaped\").\":\\n\"\n        . \"$subquery\\n\\n\"\n        . $clang->gT(\"ERROR MESSAGE\",\"unescaped\").\":\\n\"\n        . $errormsg.\"\\n\\n\";\n        SendEmailMessage($email, $clang->gT(\"Error saving results\",\"unescaped\"), $thissurvey['adminemail'], $thissurvey['adminemail'], \"LimeSurvey\", false, getBounceEmail($surveyid));\n        //echo \"<!-- EMAIL CONTENTS:\\n$email -->\\n\";\n        //An email has been sent, so we can kill off this session.\n        killSurveySession($surveyid);\n    }\n    else\n    {\n        $completed .= \"<a href='javascript:location.reload()'>\".$clang->gT(\"Try to submit again\").\"</a><br /><br />\\n\";\n        $completed .= $subquery;\n    }\n    return $completed;\n}\n\n/**\n* This function builds all the required session variables when a survey is first started and\n* it loads any answer defaults from command line or from the table defaultvalues\n* It is called from the related format script (group.php, question.php, survey.php)\n* if the survey has just started.\n*/\nfunction buildsurveysession($surveyid,$preview=false)\n{\n    global $secerror, $clienttoken;\n    global $tokensexist;\n    //global $surveyid;\n    global $move, $rooturl;\n\n    $clang = Yii::app()->lang;\n    $sLangCode=$clang->langcode;\n    $languagechanger=makeLanguageChangerSurvey($sLangCode);\n    if(!$preview)\n        $preview=Yii::app()->getConfig('previewmode');\n\t$thissurvey = getSurveyInfo($surveyid,$sLangCode);\n\n    $_SESSION['survey_'.$surveyid]['templatename']=validateTemplateDir($thissurvey['template']);\n    $_SESSION['survey_'.$surveyid]['templatepath']=getTemplatePath($_SESSION['survey_'.$surveyid]['templatename']).DIRECTORY_SEPARATOR;\n    $sTemplatePath=$_SESSION['survey_'.$surveyid]['templatepath'];\n\n    $loadsecurity = returnGlobal('loadsecurity',true);\n\n    // NO TOKEN REQUIRED BUT CAPTCHA ENABLED FOR SURVEY ACCESS\n    if ($tokensexist == 0 && isCaptchaEnabled('surveyaccessscreen',$thissurvey['usecaptcha']) && !isset($_SESSION['survey_'.$surveyid]['captcha_surveyaccessscreen'])&& !$preview)\n    {\n        // IF CAPTCHA ANSWER IS NOT CORRECT OR NOT SET\n        if (!isset($loadsecurity) ||\n        !isset($_SESSION['survey_'.$surveyid]['secanswer']) ||\n        $loadsecurity != $_SESSION['survey_'.$surveyid]['secanswer'])\n        {\n            sendCacheHeaders();\n            doHeader();\n            // No or bad answer to required security question\n\n            $redata = compact(array_keys(get_defined_vars()));\n            echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[875]');\n            //echo makedropdownlist();\n            echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[877]');\n\n            if (isset($loadsecurity))\n            { // was a bad answer\n                echo \"<font color='#FF0000'>\".$clang->gT(\"The answer to the security question is incorrect.\").\"</font><br />\";\n            }\n\n            echo \"<p class='captcha'>\".$clang->gT(\"Please confirm access to survey by answering the security question below and click continue.\").\"</p>\"\n            .CHtml::form(array(\"/survey/index/sid/{$surveyid}\"), 'post', array('class'=>'captcha')).\"\n            <table align='center'>\n            <tr>\n            <td align='right' valign='middle'>\n            <input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n            <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n            // In case we this is a direct Reload previous answers URL, then add hidden fields\n            if (isset($_GET['loadall']) && isset($_GET['scid'])\n            && isset($_GET['loadname']) && isset($_GET['loadpass']))\n            {\n                echo \"\n                <input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n            }\n\n            echo \"\n            </td>\n            </tr>\";\n            if (function_exists(\"ImageCreate\") && isCaptchaEnabled('surveyaccessscreen', $thissurvey['usecaptcha']))\n            {\n                echo \"<tr>\n                <td align='center' valign='middle'><label for='captcha'>\".$clang->gT(\"Security question:\").\"</label></td><td align='left' valign='middle'><table><tr><td valign='middle'><img src='\".Yii::app()->getController()->createUrl('/verification/image/sid/'.$surveyid).\"' alt='captcha' /></td>\n                <td valign='middle'><input id='captcha' type='text' size='5' maxlength='3' name='loadsecurity' value='' /></td></tr></table>\n                </td>\n                </tr>\";\n            }\n            echo \"<tr><td colspan='2' align='center'><input class='submit' type='submit' value='\".$clang->gT(\"Continue\").\"' /></td></tr>\n            </table>\n            </form>\";\n\n            echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1567]');\n            doFooter();\n            exit;\n        }\n        else{\n            $_SESSION['survey_'.$surveyid]['captcha_surveyaccessscreen']=true;\n        }\n    }\n\n    //BEFORE BUILDING A NEW SESSION FOR THIS SURVEY, LET'S CHECK TO MAKE SURE THE SURVEY SHOULD PROCEED!\n    // TOKEN REQUIRED BUT NO TOKEN PROVIDED\n    if ($tokensexist == 1 && !$clienttoken && !$preview)\n    {\n\n        if ($thissurvey['nokeyboard']=='Y')\n        {\n            includeKeypad();\n            $kpclass = \"text-keypad\";\n        }\n        else\n        {\n            $kpclass = \"\";\n        }\n\n        // DISPLAY REGISTER-PAGE if needed\n        // DISPLAY CAPTCHA if needed\n        sendCacheHeaders();\n        doHeader();\n\n        $redata = compact(array_keys(get_defined_vars()));\n        echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1594]');\n        //echo makedropdownlist();\n        echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1596]');\n        if (isset($thissurvey) && $thissurvey['allowregister'] == \"Y\")\n        {\n            echo templatereplace(file_get_contents($sTemplatePath.\"register.pstpl\"),array(),$redata,'frontend_helper[1599]');\n        }\n        else\n        {\n            // ->renderPartial('entertoken_view');\n            if (isset($secerror)) echo \"<span class='error'>\".$secerror.\"</span><br />\";\n            echo '<div id=\"wrapper\"><p id=\"tokenmessage\">'.$clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br />\";\n            echo $clang->gT(\"If you have been issued a token, please enter it in the box below and click continue.\").\"</p>\n            <script type='text/javascript'>var focus_element='#token';</script>\"\n            .CHtml::form(array(\"/survey/index/sid/{$surveyid}\"), 'post', array('id'=>'tokenform','autocomplete'=>'off')).\"\n            <ul>\n            <li>\";?>\n            <label for='token'><?php $clang->eT(\"Token:\");?></label><input class='text <?php echo $kpclass?>' id='token' type='password' name='token' value='' />\n            <?php\n            echo \"<input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n            <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n            if (isset($_GET['newtest']) && $_GET['newtest'] == \"Y\")\n            {\n                echo \"  <input type='hidden' name='newtest' value='Y' id='newtest' />\";\n\n            }\n\n            // If this is a direct Reload previous answers URL, then add hidden fields\n            if (isset($_GET['loadall']) && isset($_GET['scid'])\n            && isset($_GET['loadname']) && isset($_GET['loadpass']))\n            {\n                echo \"\n                <input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n            }\n            echo \"</li>\";\n\n            if (function_exists(\"ImageCreate\") && isCaptchaEnabled('surveyaccessscreen', $thissurvey['usecaptcha']))\n            {\n                echo \"<li>\n                <label for='captchaimage'>\".$clang->gT(\"Security Question\").\"</label><img id='captchaimage' src='\".Yii::app()->getController()->createUrl('/verification/image/sid/'.$surveyid).\"' alt='captcha' /><input type='text' size='5' maxlength='3' name='loadsecurity' value='' />\n                </li>\";\n            }\n            echo \"<li>\n            <input class='submit button' type='submit' value='\".$clang->gT(\"Continue\").\"' />\n            </li>\n            </ul>\n            </form></div>\";\n        }\n\n        echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1645]');\n        doFooter();\n        exit;\n    }\n    // TOKENS REQUIRED, A TOKEN PROVIDED\n    // SURVEY WITH NO NEED TO USE CAPTCHA\n    elseif ($tokensexist == 1 && $clienttoken &&\n    !isCaptchaEnabled('surveyaccessscreen',$thissurvey['usecaptcha']))\n    {\n\n        //check if token actually does exist\n        // check also if it is allowed to change survey after completion\n\t\tif ($thissurvey['alloweditaftercompletion'] == 'Y' ) {\n            $oTokenEntry = Token::model($surveyid)->findByAttributes(array('token'=>$clienttoken));\n        } else {\n            $oTokenEntry = Token::model($surveyid)->usable()->incomplete()->findByAttributes(array('token' => $clienttoken));\n        }\n\t\tif (!isset($oTokenEntry))\n        {\n            //TOKEN DOESN'T EXIST OR HAS ALREADY BEEN USED. EXPLAIN PROBLEM AND EXIT\n\n            killSurveySession($surveyid);\n            sendCacheHeaders();\n            doHeader();\n\n            $redata = compact(array_keys(get_defined_vars()));\n            echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1676]');\n            echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1677]');\n            echo '<div id=\"wrapper\"><p id=\"tokenmessage\">'.$clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br /><br />\\n\"\n            .\"\\t\".$clang->gT(\"The token you have provided is either not valid, or has already been used.\").\"<br /><br />\\n\"\n            .\"\\t\".sprintf($clang->gT(\"For further information please contact %s\"), $thissurvey['adminname'])\n            .\" (<a href='mailto:{$thissurvey['adminemail']}'>\"\n            .\"{$thissurvey['adminemail']}</a>)</p></div>\\n\";\n\n            echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1684]');\n            doFooter();\n            exit;\n        }\n   }\n    // TOKENS REQUIRED, A TOKEN PROVIDED\n    // SURVEY CAPTCHA REQUIRED\n    elseif ($tokensexist == 1 && $clienttoken && isCaptchaEnabled('surveyaccessscreen',$thissurvey['usecaptcha']))\n    {\n\n        // IF CAPTCHA ANSWER IS CORRECT\n        if (isset($loadsecurity) &&\n        isset($_SESSION['survey_'.$surveyid]['secanswer']) &&\n        $loadsecurity == $_SESSION['survey_'.$surveyid]['secanswer'])\n        {          \n\t\t\tif ($thissurvey['alloweditaftercompletion'] == 'Y' )\n            {\n                $oTokenEntry = Token::model($surveyid)->findByAttributes(array('token'=> $clienttoken));\n            }\n            else\n            {\n                $oTokenEntry = Token::model($surveyid)->incomplete()->findByAttributes(array(\n\t\t\t\t\t'token' => $clienttoken\n\t\t\t\t));\n           }\n            if (!isset($oTokenEntry))\n            {\n                sendCacheHeaders();\n                doHeader();\n                //TOKEN DOESN'T EXIST OR HAS ALREADY BEEN USED. EXPLAIN PROBLEM AND EXIT\n\n                $redata = compact(array_keys(get_defined_vars()));\n                echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1719]');\n                echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1720]');\n                echo \"\\t<div id='wrapper'>\\n\"\n                .\"\\t<p id='tokenmessage'>\\n\"\n                .\"\\t\".$clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br /><br />\\n\"\n                .\"\\t\".$clang->gT(\"The token you have provided is either not valid, or has already been used.\").\"<br/><br />\\n\"\n                .\"\\t\".sprintf($clang->gT(\"For further information please contact %s\"), $thissurvey['adminname'])\n                .\" (<a href='mailto:{$thissurvey['adminemail']}'>\"\n                .\"{$thissurvey['adminemail']}</a>)\\n\"\n                .\"\\t</p>\\n\"\n                .\"\\t</div>\\n\";\n\n                echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1731]');\n                doFooter();\n                exit;\n            }\n        }\n        // IF CAPTCHA ANSWER IS NOT CORRECT\n        else if (!isset($move) || is_null($move))\n            {\n                unset($_SESSION['survey_'.$surveyid]['srid']);\n                $gettoken = $clienttoken;\n                sendCacheHeaders();\n                doHeader();\n                // No or bad answer to required security question\n                $redata = compact(array_keys(get_defined_vars()));\n                echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1745]');\n                echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1746]');\n                // If token wasn't provided and public registration\n                // is enabled then show registration form\n                if ( !isset($gettoken) && isset($thissurvey) && $thissurvey['allowregister'] == \"Y\")\n                {\n                    echo templatereplace(file_get_contents($sTemplatePath.\"register.pstpl\"),array(),$redata,'frontend_helper[1751]');\n                }\n                else\n                { // only show CAPTCHA\n\n                    echo '<div id=\"wrapper\"><p id=\"tokenmessage\">';\n                    if (isset($loadsecurity))\n                    { // was a bad answer\n                        echo \"<span class='error'>\".$clang->gT(\"The answer to the security question is incorrect.\").\"</span><br />\";\n                    }\n\n                    echo $clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br /><br />\";\n                    // IF TOKEN HAS BEEN GIVEN THEN AUTOFILL IT\n                    // AND HIDE ENTRY FIELD\n                    if (!isset($gettoken))\n                    {\n                        echo $clang->gT(\"If you have been issued a token, please enter it in the box below and click continue.\").\"</p>\n                        <form id='tokenform' method='get' action='\".Yii::app()->getController()->createUrl(\"/survey/index\").\"'>\n                        <ul>\n                        <li>\n                        <input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n                        <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n                        if (isset($_GET['loadall']) && isset($_GET['scid'])\n                        && isset($_GET['loadname']) && isset($_GET['loadpass']))\n                        {\n                            echo \"<input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                            <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                            <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                            <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n                        }\n\n                        echo '<label for=\"token\">'.$clang->gT(\"Token\").\"</label><input class='text' type='password' id='token' name='token'></li>\";\n                }\n                else\n                {\n                    echo $clang->gT(\"Please confirm the token by answering the security question below and click continue.\").\"</p>\n                    <form id='tokenform' method='get' action='\".Yii::app()->getController()->createUrl(\"/survey/index\").\"'>\n                    <ul>\n                    <li>\n                    <input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n                    <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n                    if (isset($_GET['loadall']) && isset($_GET['scid'])\n                    && isset($_GET['loadname']) && isset($_GET['loadpass']))\n                    {\n                        echo \"<input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                        <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                        <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                        <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n                    }\n                    echo '<label for=\"token\">'.$clang->gT(\"Token:\").\"</label><span id='token'>$gettoken</span>\"\n                    .\"<input type='hidden' name='token' value='$gettoken'></li>\";\n                }\n\n\n                if (function_exists(\"ImageCreate\") && isCaptchaEnabled('surveyaccessscreen', $thissurvey['usecaptcha']))\n                {\n                    echo \"<li>\n                    <label for='captchaimage'>\".$clang->gT(\"Security Question\").\"</label><img id='captchaimage' src='\".Yii::app()->getController()->createUrl('/verification/image/sid/'.$surveyid).\"' alt='captcha' /><input type='text' size='5' maxlength='3' name='loadsecurity' value='' />\n                    </li>\";\n                }\n                echo \"<li><input class='submit' type='submit' value='\".$clang->gT(\"Continue\").\"' /></li>\n                </ul>\n                </form>\n                </id>\";\n            }\n\n            echo '</div>'.templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1817]');\n            doFooter();\n            exit;\n        }\n    }\n\n    //RESET ALL THE SESSION VARIABLES AND START AGAIN\n    unset($_SESSION['survey_'.$surveyid]['grouplist']);\n    unset($_SESSION['survey_'.$surveyid]['fieldarray']);\n    unset($_SESSION['survey_'.$surveyid]['insertarray']);\n    unset($_SESSION['survey_'.$surveyid]['fieldnamesInfo']);\n    unset($_SESSION['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster']);\n    unset($_SESSION['survey_'.$surveyid]['groupReMap']);\n    $_SESSION['survey_'.$surveyid]['fieldnamesInfo'] = Array();\n\n\n    //RL: multilingual support\n    if (isset($_GET['token']) && tableExists('{{tokens_'.$surveyid.'}}'))\n    {\n\n        //get language from token (if one exists)\n        $tkquery2 = \"SELECT * FROM {{tokens_\".$surveyid.\"}} WHERE token='\".$clienttoken.\"' AND (completed = 'N' or completed='')\";\n        //echo $tkquery2;\n        $result = dbExecuteAssoc($tkquery2) or safeDie (\"Couldn't get tokens<br />$tkquery<br />\");    //Checked\n        foreach ($result->readAll() as $rw)\n        {\n            $tklanguage=$rw['language'];\n        }\n    }\n    if (returnGlobal('lang',true))\n    {\n        $language_to_set=returnGlobal('lang',true);\n    } elseif (isset($tklanguage))\n    {\n        $language_to_set=$tklanguage;\n    }\n    else\n    {\n        $language_to_set = $thissurvey['language'];\n    }\n\n    if (!isset($_SESSION['survey_'.$surveyid]['s_lang']))\n    {\n        SetSurveyLanguage($surveyid, $language_to_set);\n    }\n\n\n    UpdateGroupList($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n\n    $sQuery = \"SELECT count(*)\\n\"\n    .\" FROM {{groups}} INNER JOIN {{questions}} ON {{groups}}.gid = {{questions}}.gid\\n\"\n    .\" WHERE {{questions}}.sid=\".$surveyid.\"\\n\"\n    .\" AND {{groups}}.language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\\n\"\n    .\" AND {{questions}}.language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\\n\"\n    .\" AND {{questions}}.parent_qid=0\\n\";\n\n    $totalquestions = Yii::app()->db->createCommand($sQuery)->queryScalar();\n\n    // Fix totalquestions by substracting Test Display questions\n    $iNumberofQuestions=dbExecuteAssoc(\"SELECT count(*)\\n\"\n    .\" FROM {{questions}}\"\n    .\" WHERE type in ('X','*')\\n\"\n    .\" AND sid={$surveyid}\"\n    .\" AND language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\"\n    .\" AND parent_qid=0\")->read();\n\n    $_SESSION['survey_'.$surveyid]['totalquestions'] = $totalquestions - (int) reset($iNumberofQuestions);\n\n    //2. SESSION VARIABLE: totalsteps\n    //The number of \"pages\" that will be presented in this survey\n    //The number of pages to be presented will differ depending on the survey format\n    switch($thissurvey['format'])\n    {\n        case \"A\":\n            $_SESSION['survey_'.$surveyid]['totalsteps']=1;\n            break;\n        case \"G\":\n            if (isset($_SESSION['survey_'.$surveyid]['grouplist']))\n            {\n                $_SESSION['survey_'.$surveyid]['totalsteps']=count($_SESSION['survey_'.$surveyid]['grouplist']);\n            }\n            break;\n        case \"S\":\n            $_SESSION['survey_'.$surveyid]['totalsteps']=$totalquestions;\n    }\n\n\n    if ($totalquestions == 0)\t//break out and crash if there are no questions!\n    {\n        sendCacheHeaders();\n        doHeader();\n\n        $redata = compact(array_keys(get_defined_vars()));\n        echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1914]');\n        echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1915]');\n        echo \"\\t<div id='wrapper'>\\n\"\n        .\"\\t<p id='tokenmessage'>\\n\"\n        .\"\\t\".$clang->gT(\"This survey does not yet have any questions and cannot be tested or completed.\").\"<br /><br />\\n\"\n        .\"\\t\".sprintf($clang->gT(\"For further information please contact %s\"), $thissurvey['adminname'])\n        .\" (<a href='mailto:{$thissurvey['adminemail']}'>\"\n        .\"{$thissurvey['adminemail']}</a>)<br /><br />\\n\"\n        .\"\\t</p>\\n\"\n        .\"\\t</div>\\n\";\n\n        echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1925]');\n        doFooter();\n        exit;\n    }\n\n    //Perform a case insensitive natural sort on group name then question title of a multidimensional array\n    //\tusort($arows, 'groupOrderThenQuestionOrder');\n\n    //3. SESSION VARIABLE - insertarray\n    //An array containing information about used to insert the data into the db at the submit stage\n    //4. SESSION VARIABLE - fieldarray\n    //See rem at end..\n\n    if ($tokensexist == 1 && $clienttoken)\n    {\n        $_SESSION['survey_'.$surveyid]['token'] = $clienttoken;\n    }\n\n    if ($thissurvey['anonymized'] == \"N\")\n    {\n        $_SESSION['survey_'.$surveyid]['insertarray'][]= \"token\";\n    }\n\n    $qtypes=getQuestionTypeList('','array');\n    $fieldmap=createFieldMap($surveyid,'full',true,false,$_SESSION['survey_'.$surveyid]['s_lang']);\n\n\n    // Randomization groups for groups\n    $aRandomGroups=array();\n    $aGIDCompleteMap=array();\n    // first find all groups and their groups IDS\n    $criteria = new CDbCriteria;\n    $criteria->addColumnCondition(array('sid' => $surveyid, 'language' => $_SESSION['survey_'.$surveyid]['s_lang']));\n    $criteria->addCondition(\"randomization_group != ''\");\n    $oData = QuestionGroup::model()->findAll($criteria);\n    foreach($oData as $aGroup)\n    {\n        $aRandomGroups[$aGroup['randomization_group']][] = $aGroup['gid'];\n    }\n    // Shuffle each group and create a map for old GID => new GID\n    foreach ($aRandomGroups as $sGroupName=>$aGIDs)\n    {\n        $aShuffledIDs=$aGIDs;\n        shuffle($aShuffledIDs);\n        $aGIDCompleteMap=$aGIDCompleteMap+array_combine($aGIDs,$aShuffledIDs);\n    }\n    $_SESSION['survey_' . $surveyid]['groupReMap'] = $aGIDCompleteMap;\n\n    $randomized = false;    // So we can trigger reorder once for group and question randomization\n    // Now adjust the grouplist\n    if (count($aRandomGroups)>0 && !$preview)\n    {\n        $randomized = true;    // So we can trigger reorder once for group and question randomization\n        // Now adjust the grouplist\n        Yii::import('application.helpers.frontend_helper', true);   // make sure frontend helper is loaded\n        UpdateGroupList($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n        // ... and the fieldmap\n\n        // First create a fieldmap with GID as key\n        foreach ($fieldmap as $aField)\n        {\n            if (isset($aField['gid']))\n            {\n                $GroupFieldMap[$aField['gid']][]=$aField;\n            }\n            else{\n                $GroupFieldMap['other'][]=$aField;\n            }\n        }\n        // swap it\n        foreach ($GroupFieldMap as $iOldGid => $fields)\n        {\n            $iNewGid = $iOldGid;\n            if (isset($aGIDCompleteMap[$iOldGid]))\n            {\n                $iNewGid = $aGIDCompleteMap[$iOldGid];\n            }\n            $newGroupFieldMap[$iNewGid] = $GroupFieldMap[$iNewGid];\n        }\n        $GroupFieldMap = $newGroupFieldMap;\n        // and convert it back to a fieldmap\n        unset($fieldmap);\n        foreach($GroupFieldMap as $aGroupFields)\n        {\n            foreach ($aGroupFields as $aField)\n            {\n                if (isset($aField['fieldname'])) {\n                    $fieldmap[$aField['fieldname']] = $aField;  // isset() because of the shuffled flag above\n                }\n            }\n        }\n        unset($GroupFieldMap);\n    }\n\n    // Randomization groups for questions\n\n    // Find all defined randomization groups through question attribute values\n    $randomGroups=array();\n    if (in_array(Yii::app()->db->getDriverName(), array('mssql', 'sqlsrv', 'dblib')))\n    {\n        $rgquery = \"SELECT attr.qid, CAST(value as varchar(255)) as value FROM {{question_attributes}} as attr right join {{questions}} as quests on attr.qid=quests.qid WHERE attribute='random_group' and CAST(value as varchar(255)) <> '' and sid=$surveyid GROUP BY attr.qid, CAST(value as varchar(255))\";\n    }\n    else\n    {\n        $rgquery = \"SELECT attr.qid, value FROM {{question_attributes}} as attr right join {{questions}} as quests on attr.qid=quests.qid WHERE attribute='random_group' and value <> '' and sid=$surveyid GROUP BY attr.qid, value\";\n    }\n    $rgresult = dbExecuteAssoc($rgquery);\n    foreach($rgresult->readAll() as $rgrow)\n    {\n        // Get the question IDs for each randomization group\n        $randomGroups[$rgrow['value']][] = $rgrow['qid'];\n    }\n\n    // If we have randomization groups set, then lets cycle through each group and\n    // replace questions in the group with a randomly chosen one from the same group\n    if (count($randomGroups) > 0 && !$preview)\n    {\n        $randomized   = true;    // So we can trigger reorder once for group and question randomization\n        $copyFieldMap = array();\n        $oldQuestOrder = array();\n        $newQuestOrder = array();\n        $randGroupNames = array();\n        foreach ($randomGroups as $key=>$value)\n        {\n            $oldQuestOrder[$key] = $randomGroups[$key];\n            $newQuestOrder[$key] = $oldQuestOrder[$key];\n            // We shuffle the question list to get a random key->qid which will be used to swap from the old key\n            shuffle($newQuestOrder[$key]);\n            $randGroupNames[] = $key;\n        }\n\n        // Loop through the fieldmap and swap each question as they come up\n        foreach ($fieldmap as $fieldkey => $fieldval)\n        {\n            $found = 0;\n            foreach ($randomGroups as $gkey => $gval)\n            {\n                // We found a qid that is in the randomization group\n                if (isset($fieldval['qid']) && in_array($fieldval['qid'],$oldQuestOrder[$gkey]))\n                {\n                    // Get the swapped question\n                    $idx = array_search($fieldval['qid'],$oldQuestOrder[$gkey]);\n                    foreach ($fieldmap as $key => $field)\n                    {\n                        if (isset($field['qid']) && $field['qid'] == $newQuestOrder[$gkey][$idx])\n                        {\n                            $field['random_gid'] = $fieldval['gid'];   // It is possible to swap to another group\n                            $copyFieldMap[$key]  = $field;\n                        }\n                    }\n                    $found = 1;\n                    break;\n                } else\n                {\n                    $found = 2;\n                }\n            }\n            if ($found == 2)\n            {\n                $copyFieldMap[$fieldkey]=$fieldval;\n            }\n            reset($randomGroups);\n        }\n        $fieldmap = $copyFieldMap;\n    }\n\n    if ($randomized === true)\n    {\n        // reset the sequencing counts\n        $gseq = -1;\n        $_gid = -1;\n        $qseq = -1;\n        $_qid = -1;\n        $copyFieldMap = array();\n        foreach ($fieldmap as $key => $val)\n        {\n            if ($val['gid'] != '')\n            {\n                if (isset($val['random_gid']))\n                {\n                    $gid = $val['random_gid'];\n                } else {\n                    $gid = $val['gid'];\n                }\n                if ($gid != $_gid)\n                {\n                    $_gid = $gid;\n                    ++$gseq;\n                }\n            }\n\n            if ($val['qid'] != '' && $val['qid'] != $_qid)\n            {\n                $_qid = $val['qid'];\n                ++$qseq;\n            }\n\n            if ($val['gid'] != '' && $val['qid'] != '')\n            {\n                $val['groupSeq']    = $gseq;\n                $val['questionSeq'] = $qseq;\n            }\n\n            $copyFieldMap[$key] = $val;\n        }\n        $fieldmap = $copyFieldMap;\n        unset($copyFieldMap);\n\n        $_SESSION['survey_'.$surveyid]['fieldmap-' . $surveyid . $_SESSION['survey_'.$surveyid]['s_lang']] = $fieldmap;\n        $_SESSION['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster'] = 'fieldmap-' . $surveyid . $_SESSION['survey_'.$surveyid]['s_lang'];\n    }\n    \n    // TMSW Condition->Relevance:  don't need hasconditions, or usedinconditions\n\n    $_SESSION['survey_'.$surveyid]['fieldmap']=$fieldmap;\n    foreach ($fieldmap as $field)\n    {\n        if (isset($field['qid']) && $field['qid']!='')\n        {\n            $_SESSION['survey_'.$surveyid]['fieldnamesInfo'][$field['fieldname']]=$field['sid'].'X'.$field['gid'].'X'.$field['qid'];\n            $_SESSION['survey_'.$surveyid]['insertarray'][]=$field['fieldname'];\n            //fieldarray ARRAY CONTENTS -\n            //            [0]=questions.qid,\n            //\t\t\t[1]=fieldname,\n            //\t\t\t[2]=questions.title,\n            //\t\t\t[3]=questions.question\n            //                 \t[4]=questions.type,\n            //\t\t\t[5]=questions.gid,\n            //\t\t\t[6]=questions.mandatory,\n            //\t\t\t[7]=conditionsexist,\n            //\t\t\t[8]=usedinconditions\n            //\t\t\t[8]=usedinconditions\n            //\t\t\t[9]=used in group.php for question count\n            //\t\t\t[10]=new group id for question in randomization group (GroupbyGroup Mode)\n\n            if (!isset($_SESSION['survey_'.$surveyid]['fieldarray'][$field['sid'].'X'.$field['gid'].'X'.$field['qid']]))\n            {\n                //JUST IN CASE : PRECAUTION!\n                //following variables are set only if $style==\"full\" in createFieldMap() in common_helper.\n                //so, if $style = \"short\", set some default values here!\n                if (isset($field['title']))\n                    $title = $field['title'];\n                else\n                    $title = \"\";\n\n                if (isset($field['question']))\n                    $question = $field['question'];\n                else\n                    $question = \"\";\n\n                if (isset($field['mandatory']))\n                    $mandatory = $field['mandatory'];\n                else\n                    $mandatory = 'N';\n\n                if (isset($field['hasconditions']))\n                    $hasconditions = $field['hasconditions'];\n                else\n                    $hasconditions = 'N';\n\n                if (isset($field['usedinconditions']))\n                    $usedinconditions = $field['usedinconditions'];\n                else\n                    $usedinconditions = 'N';\n                $_SESSION['survey_'.$surveyid]['fieldarray'][$field['sid'].'X'.$field['gid'].'X'.$field['qid']]=array($field['qid'],\n                $field['sid'].'X'.$field['gid'].'X'.$field['qid'],\n                $title,\n                $question,\n                $field['type'],\n                $field['gid'],\n                $mandatory,\n                $hasconditions,\n                $usedinconditions);\n            }\n            if (isset($field['random_gid']))\n            {\n                $_SESSION['survey_'.$surveyid]['fieldarray'][$field['sid'].'X'.$field['gid'].'X'.$field['qid']][10] = $field['random_gid'];\n            }\n        }\n\n    }\n\n    // Prefill questions/answers from command line params\n    $reservedGetValues= array('token','sid','gid','qid','lang','newtest','action');\n    $startingValues=array();\n    if (isset($_GET))\n    {\n\t\tforeach ($_GET as $k=>$v)\n        {\n\t\t\tif (!in_array($k,$reservedGetValues) && isset($_SESSION['survey_'.$surveyid]['fieldmap'][$k]))\n            {\n                $startingValues[$k] = $v;\n            }\n\t\t\telse\n\t\t\t{   // Search question codes to use those for prefilling.\n\t\t\t\tforeach($_SESSION['survey_'.$surveyid]['fieldmap'] as $sgqa => $details)\n\t\t\t\t{\n\t\t\t\t\tif ($details['title'] == $k)\n\t\t\t\t\t{\n\t\t\t\t\t\t$startingValues[$sgqa] = $v;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n        }\n    }\n    $_SESSION['survey_'.$surveyid]['startingValues']=$startingValues;\n\n    if (isset($_SESSION['survey_'.$surveyid]['fieldarray'])) $_SESSION['survey_'.$surveyid]['fieldarray']=array_values($_SESSION['survey_'.$surveyid]['fieldarray']);\n\n    //Check if a passthru label and value have been included in the query url\n    $oResult=SurveyURLParameter::model()->getParametersForSurvey($surveyid);\n    foreach($oResult->readAll() as $aRow)\n    {\n        if(isset($_GET[$aRow['parameter']]) && !$preview)\n        {\n            $_SESSION['survey_'.$surveyid]['urlparams'][$aRow['parameter']]=$_GET[$aRow['parameter']];\n            if ($aRow['targetqid']!='')\n            {\n                foreach ($fieldmap as $sFieldname=>$aField)\n                {\n                    if ($aRow['targetsqid']!='')\n                    {\n                        if ($aField['qid']==$aRow['targetqid'] && $aField['sqid']==$aRow['targetsqid'])\n                        {\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$sFieldname]=$_GET[$aRow['parameter']];\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$aRow['parameter']]=$_GET[$aRow['parameter']];\n                        }\n                    }\n                    else\n                    {\n                        if ($aField['qid']==$aRow['targetqid'])\n                        {\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$sFieldname]=$_GET[$aRow['parameter']];\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$aRow['parameter']]=$_GET[$aRow['parameter']];\n                        }\n                    }\n                }\n\n            }\n        }\n    }\n}\n\n/**\n* This function creates the form elements in the survey navigation bar\n* Adding a hidden input for default behaviour without javascript\n* Use button name=\"move\" for real browser (with or without javascript) and IE6/7/8 with javascript\n*/\nfunction surveymover()\n{\n    $surveyid=Yii::app()->getConfig('surveyID');\n    $thissurvey=getSurveyInfo($surveyid);\n    $clang = Yii::app()->lang;\n\n    $sMoveNext=\"movenext\";\n    $sMovePrev=\"\";\n    $iSessionStep=(isset($_SESSION['survey_'.$surveyid]['step']))?$_SESSION['survey_'.$surveyid]['step']:false;\n    $iSessionMaxStep=(isset($_SESSION['survey_'.$surveyid]['maxstep']))?$_SESSION['survey_'.$surveyid]['maxstep']:false;\n    $iSessionTotalSteps=(isset($_SESSION['survey_'.$surveyid]['totalsteps']))?$_SESSION['survey_'.$surveyid]['totalsteps']:false;\n    $sClass=\"submit button\";\n    $sSurveyMover = \"\";\n\n    // Count down\n    if ($thissurvey['navigationdelay'] > 0 && ($iSessionMaxStep!==false && $iSessionMaxStep == $iSessionStep))\n     {\n        $sClass.=\" disabled\";\n        App()->getClientScript()->registerScriptFile(Yii::app()->getConfig('generalscripts').\"/navigator-countdown.js\");\n        App()->getClientScript()->registerScript('navigator_countdown',\"navigator_countdown(\" . $thissurvey['navigationdelay'] . \");\\n\",CClientScript::POS_BEGIN);\n     }\n\n    // Previous ?\n    if ($thissurvey['format'] != \"A\" && ($thissurvey['allowprev'] != \"N\")\n        && $iSessionStep\n        && !($iSessionStep == 1 && $thissurvey['showwelcome'] == 'N')\n        && !Yii::app()->getConfig('previewmode')\n    )\n    {\n        $sMovePrev=\"moveprev\";\n     }\n\n    // Submit ?\n    if ($iSessionStep && ($iSessionStep == $iSessionTotalSteps)\n        || $thissurvey['format'] == 'A' \n        )\n    {\n        $sMoveNext=\"movesubmit\";\n    }\n\n    // todo Remove Next if needed (exemple quota show previous only: maybe other, but actually don't use surveymover)\n    if(Yii::app()->getConfig('previewmode'))\n    {\n        $sMoveNext=\"\";\n    }\n\n    // Construction of mover\n    if($sMovePrev){\n        $sLangMoveprev=$clang->gT(\"Previous\");\n        $sSurveyMover.= CHtml::htmlButton($sLangMoveprev,array('type'=>'submit','id'=>\"{$sMovePrev}btn\",'value'=>$sMovePrev,'name'=>$sMovePrev,'accesskey'=>'p','class'=>$sClass));\n    }\n    if($sMovePrev && $sMoveNext){\n        $sSurveyMover .= \" \";\n    }\n\n    if($sMoveNext){\n        if($sMoveNext==\"movesubmit\"){\n            $sLangMovenext=$clang->gT(\"Submit\");\n            $sAccessKeyNext='l';// Why l ?\n        }else{\n            $sLangMovenext=$clang->gT(\"Next\");\n            $sAccessKeyNext='n';\n        }\n        $sSurveyMover.= CHtml::htmlButton($sLangMovenext,array('type'=>'submit','id'=>\"{$sMoveNext}btn\",'value'=>$sMoveNext,'name'=>$sMoveNext,'accesskey'=>$sAccessKeyNext,'class'=>$sClass));\n     }\n    return $sSurveyMover;\n}\n\n/**\n* Caculate assessement scores\n*\n* @param mixed $surveyid\n* @param mixed $returndataonly - only returns an array with data\n*/\nfunction doAssessment($surveyid, $returndataonly=false)\n{\n\n    $clang = Yii::app()->lang;\n    $baselang=Survey::model()->findByPk($surveyid)->language;\n    if(Survey::model()->findByPk($surveyid)->assessments!=\"Y\")\n    {\n        return false;\n    }\n    $total=0;\n    if (!isset($_SESSION['survey_'.$surveyid]['s_lang']))\n    {\n        $_SESSION['survey_'.$surveyid]['s_lang']=$baselang;\n    }\n    $query = \"SELECT * FROM {{assessments}}\n    WHERE sid=$surveyid and language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\n    ORDER BY scope, id\";\n\n    if ($result = dbExecuteAssoc($query))   //Checked\n    {\n        $aResultSet=$result->readAll();\n        if (count($aResultSet) > 0)\n        {\n            foreach($aResultSet as $row)\n            {\n                if ($row['scope'] == \"G\")\n                {\n                    $assessment['group'][$row['gid']][]=array(\"name\"=>$row['name'],\n                    \"min\"=>$row['minimum'],\n                    \"max\"=>$row['maximum'],\n                    \"message\"=>$row['message']);\n                }\n                else\n                {\n                    $assessment['total'][]=array( \"name\"=>$row['name'],\n                    \"min\"=>$row['minimum'],\n                    \"max\"=>$row['maximum'],\n                    \"message\"=>$row['message']);\n                }\n            }\n            $fieldmap=createFieldMap($surveyid, \"full\",false,false,$_SESSION['survey_'.$surveyid]['s_lang']);\n            $i=0;\n            $total=0;\n            $groups=array();\n            foreach($fieldmap as $field)\n            {\n                if (in_array($field['type'],array('1','F','H','W','Z','L','!','M','O','P')))\n                {\n                    $fieldmap[$field['fieldname']]['assessment_value']=0;\n                    if (isset($_SESSION['survey_'.$surveyid][$field['fieldname']]))\n                    {\n                        if (($field['type'] == \"M\") || ($field['type'] == \"P\")) //Multiflexi choice  - result is the assessment attribute value\n                        {\n                            if ($_SESSION['survey_'.$surveyid][$field['fieldname']] == \"Y\")\n                            {\n                                $aAttributes=getQuestionAttributeValues($field['qid'],$field['type']);\n                                $fieldmap[$field['fieldname']]['assessment_value']=(int)$aAttributes['assessment_value'];\n                                $total=$total+(int)$aAttributes['assessment_value'];\n                            }\n                        }\n                        else  // Single choice question\n                        {\n                            $usquery = \"SELECT assessment_value FROM {{answers}} where qid=\".$field['qid'].\" and language='$baselang' and code=\".dbQuoteAll($_SESSION['survey_'.$surveyid][$field['fieldname']]);\n                            $usresult = dbExecuteAssoc($usquery);          //Checked\n                            if ($usresult)\n                            {\n                                $usrow = $usresult->read();\n                                $fieldmap[$field['fieldname']]['assessment_value']=$usrow['assessment_value'];\n                                $total=$total+$usrow['assessment_value'];\n                            }\n                        }\n                    }\n                    $groups[]=$field['gid'];\n                }\n                $i++;\n            }\n\n            $groups=array_unique($groups);\n\n            foreach($groups as $group)\n            {\n                $grouptotal=0;\n                foreach ($fieldmap as $field)\n                {\n                    if ($field['gid'] == $group && isset($field['assessment_value']))\n                    {\n                        //$grouptotal=$grouptotal+$field['answer'];\n                        if (isset ($_SESSION['survey_'.$surveyid][$field['fieldname']]))\n                        {\n                            $grouptotal=$grouptotal+$field['assessment_value'];\n                        }\n                    }\n                }\n                $subtotal[$group]=$grouptotal;\n            }\n        }\n        $assessments = \"\";\n        if (isset($subtotal) && is_array($subtotal))\n        {\n            foreach($subtotal as $key=>$val)\n            {\n                if (isset($assessment['group'][$key]))\n                {\n                    foreach($assessment['group'][$key] as $assessed)\n                    {\n                        if ($val >= $assessed['min'] && $val <= $assessed['max'] && $returndataonly===false)\n                        {\n                            $assessments .= \"\\t<!-- GROUP ASSESSMENT: Score: $val Min: \".$assessed['min'].\" Max: \".$assessed['max'].\"-->\n                            <table class='assessments'>\n                            <tr>\n                            <th>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), $assessed['name']).\"\n                            </th>\n                            </tr>\n                            <tr>\n                            <td>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), $assessed['message']).\"\n                            </td>\n                            </tr>\n                            </table><br />\\n\";\n                        }\n                    }\n                }\n            }\n        }\n\n        if (isset($assessment['total']))\n        {\n            foreach($assessment['total'] as $assessed)\n            {\n                if ($total >= $assessed['min'] && $total <= $assessed['max'] && $returndataonly===false)\n                {\n                    $assessments .= \"\\t\\t\\t<!-- TOTAL ASSESSMENT: Score: $total Min: \".$assessed['min'].\" Max: \".$assessed['max'].\"-->\n                    <table class='assessments' align='center'>\n                    <tr>\n                    <th>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), stripslashes($assessed['name'])).\"\n                    </th>\n                    </tr>\n                    <tr>\n                    <td>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), stripslashes($assessed['message'])).\"\n                    </td>\n                    </tr>\n                    </table>\\n\";\n                }\n            }\n        }\n        if ($returndataonly==true)\n        {\n            return array('total'=>$total);\n        }\n        else\n        {\n            return $assessments;\n        }\n    }\n}\n\n/**\n* Update SESSION VARIABLE: grouplist\n* A list of groups in this survey, ordered by group name.\n* @param int surveyid\n* @param string language\n*/\nfunction UpdateGroupList($surveyid, $language)\n{\n    $clang = Yii::app()->lang;\n    unset ($_SESSION['survey_'.$surveyid]['grouplist']);\n    $query = \"SELECT * FROM {{groups}} WHERE sid=$surveyid AND language='\".$language.\"' ORDER BY group_order\";\n    $result = dbExecuteAssoc($query) or safeDie (\"Couldn't get group list<br />$query<br />\");  //Checked\n    $groupList = array();\n    foreach ($result->readAll() as $row)\n    {\n        $group = array(\n            'gid'         => $row['gid'],\n            'group_name'  => $row['group_name'],\n            'description' =>  $row['description']);\n        $groupList[] = $group;\n        $gidList[$row['gid']] = $group;\n    }\n\n    if (!Yii::app()->getConfig('previewmode') && isset($_SESSION['survey_'.$surveyid]['groupReMap']) && count($_SESSION['survey_'.$surveyid]['groupReMap'])>0)\n    {\n        // Now adjust the grouplist\n        $groupRemap = $_SESSION['survey_'.$surveyid]['groupReMap'];\n        $groupListCopy = $groupList;\n        foreach ($groupList as $gseq => $info) {\n            $gid = $info['gid'];\n            if (isset($groupRemap[$gid])) {\n                $gid = $groupRemap[$gid];\n            }\n            $groupListCopy[$gseq] = $gidList[$gid];\n        }\n        $groupList = $groupListCopy;\n     }\n     $_SESSION['survey_'.$surveyid]['grouplist'] = $groupList;\n}\n\n/**\n* FieldArray contains all necessary information regarding the questions\n* This function is needed to update it in case the survey is switched to another language\n* @todo: Make 'fieldarray' obsolete by replacing with EM session info\n*/\nfunction UpdateFieldArray()\n{\n\tglobal $surveyid;\n\t$clang = Yii::app()->lang;\n\n    if (isset($_SESSION['survey_'.$surveyid]['fieldarray']))\n    {\n\t\tforeach ($_SESSION['survey_'.$surveyid]['fieldarray'] as $key => $value)\n        {\n            $questionarray = &$_SESSION['survey_'.$surveyid]['fieldarray'][$key];\n            $query = \"SELECT title, question FROM {{questions}} WHERE qid=\".$questionarray[0].\" AND language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\";\n            $usrow = Yii::app()->db->createCommand($query)->queryRow();\n            if ($usrow)\n            {\n                $questionarray[2]=$usrow['title'];\n                $questionarray[3]=$usrow['question'];\n            }\n            unset($questionarray);\n        }\n    }\n}\n\n/**\n* checkQuota() returns quota information for the current survey\n* @param string $checkaction - action the function must take after completing:\n* \t\t\t\t\t\t\t\tenforce: Enforce the Quota action\n* \t\t\t\t\t\t\t\treturn: Return the updated quota array from getQuotaAnswers()\n* @param string $surveyid - Survey identification number\n* @return array - nested array, Quotas->Members->Fields, includes quota status and which members matched in session.\n*/\nfunction checkQuota($checkaction,$surveyid)\n{\n    global $clienttoken ;\n    if (!isset($_SESSION['survey_'.$surveyid]['srid']))\n    {\n        return;\n    }\n    $thissurvey=getSurveyInfo($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n    $sTemplatePath=getTemplatePath($thissurvey['templatedir']);\n\n    $global_matched = false;\n    $quota_info = getQuotaInformation($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n    $x=0;\n\n    $clang = Yii::app()->lang;\n\n    if(count($quota_info) > 0) // Quota's have to exist\n    {\n        // Check each quota on saved data to see if it is full\n        $querycond = array();\n        foreach ($quota_info as $quota)\n        {\n            if (count($quota['members']) > 0) // Quota can't be empty\n            {\n                $fields_list = array(); // Keep a list of fields for easy reference\n                $y=0;\n                // We need to make the conditions for the select statement here\n                unset($querycond);\n                // fill the array of value and query for each fieldnames\n                $fields_value_array = array();\n                $fields_query_array = array();\n                foreach($quota['members'] as $member)\n                {\n                    foreach($member['fieldnames'] as $fieldname)\n                    {\n                        if (!in_array($fieldname,$fields_list))\n                        {\n                            $fields_list[] = $fieldname;\n                            $fields_value_array[$fieldname] = array();\n                            $fields_query_array[$fieldname] = array();\n                        }\n                        $fields_value_array[$fieldname][]=$member['value'];\n                        $fields_query_array[$fieldname][]= dbQuoteID($fieldname).\" = '{$member['value']}'\";\n                    }\n                }\n\n                // fill the $querycond array with each fields_query grouped by fieldname\n                foreach($fields_list as $fieldname)\n                {\n                    $select_query = \" ( \".implode(' OR ',$fields_query_array[$fieldname]).' )';\n                    $querycond[] = $select_query;\n                }\n                // Test if the fieldname is in the array of value in the session\n                foreach($quota['members'] as $member)\n                {\n                    foreach($member['fieldnames'] as $fieldname)\n                    {\n                        if (isset($_SESSION['survey_'.$surveyid][$fieldname]))\n                        {\n                            if (in_array($_SESSION['survey_'.$surveyid][$fieldname],$fields_value_array[$fieldname])){\n                                $quota_info[$x]['members'][$y]['insession'] = \"true\";\n                            }\n                        }\n                    }\n                    $y++;\n                }\n                unset($fields_query_array);unset($fields_value_array);\n\n                // Lets only continue if any of the quota fields is in the posted page\n                $matched_fields = false;\n                if (isset($_POST['fieldnames']))\n                {\n                    $posted_fields = explode(\"|\",$_POST['fieldnames']);\n                    foreach ($fields_list as $checkfield)\n                    {\n                        if (in_array($checkfield,$posted_fields))\n                        {\n                            $matched_fields = true;\n                            $global_matched = true;\n                        }\n                    }\n                }\n\n                // A field was submitted that is part of the quota\n                if ($matched_fields == true)\n                {\n                    // Check the status of the quota, is it full or not\n                    $sQuery = \"SELECT count(id) FROM {{survey_\".$surveyid.\"}}\n                    WHERE \".implode(' AND ',$querycond).\" \".\"\n                    AND submitdate IS NOT NULL\";\n                    $iRowCount = Yii::app()->db->createCommand($sQuery)->queryScalar();\n                    if ($iRowCount >= $quota['Limit']) // Quota is full!!\n                    {\n                        // Now we have to check if the quota matches in the current session\n                        // This will let us know if this person is going to exceed the quota\n                        $counted_matches = 0;\n                        foreach($quota_info[$x]['members'] as $member)\n                        {\n                            if (isset($member['insession']) && $member['insession'] == \"true\") $counted_matches++;\n                        }\n\n                        if($counted_matches == count($quota['members']))\n                        {\n                            // They are going to exceed the quota if data is submitted\n                            $quota_info[$x]['status']=\"matched\";\n                        }\n                        else\n                        {\n                            $quota_info[$x]['status']=\"notmatched\";\n                        }\n                    }\n                    else\n                    {\n                        // Quota is no in danger of being exceeded.\n                        $quota_info[$x]['status']=\"notmatched\";\n                    }\n                }\n            }\n            $x++;\n        }\n    }\n    else\n    {\n        return false;\n    }\n\n    // Now we have all the information we need about the quotas and their status.\n    // Lets see what we should do now\n    if ($checkaction == 'return')\n    {\n        return $quota_info;\n    }\n    elseif ($global_matched == true && $checkaction == 'enforce')\n    {\n        // Need to add Quota action enforcement here.\n        reset($quota_info);\n\n        $tempmsg =\"\";\n        $found = false;\n        $redata = compact(array_keys(get_defined_vars()));\n        foreach($quota_info as $quota)\n        {\n            $quota['Message'] = templatereplace($quota['Message'],array(),$redata);\n            $quota['Url'] = passthruReplace($quota['Url'], $thissurvey);\n            $quota['Url'] = templatereplace($quota['Url'],array(),$redata);\n            $quota['UrlDescrip'] = templatereplace($quota['UrlDescrip'],array(),$redata);\n            if ((isset($quota['status']) && $quota['status'] == \"matched\") && (isset($quota['Action']) && $quota['Action'] == \"1\"))\n            {\n                // If a token is used then mark the token as completed\n                if (isset($clienttoken) && $clienttoken)\n                {\n                    submittokens(true);\n                }\n\n            sendCacheHeaders();\n            if($quota['AutoloadUrl'] == 1 && $quota['Url'] != \"\")\n            {\n                header(\"Location: \".$quota['Url']);\n                killSurveySession($surveyid);\n            }\n            doHeader();\n\n            echo templatereplace(file_get_contents($sTemplatePath.\"/startpage.pstpl\"),array(),$redata,'frontend_helper[2617]');\n            echo \"\\t<div class='quotamessage'>\\n\";\n            echo \"\\t\".$quota['Message'].\"<br /><br />\\n\";\n            echo \"\\t<a href='\".$quota['Url'].\"'>\".$quota['UrlDescrip'].\"</a><br />\\n\";\n            echo \"\\t</div>\\n\";\n            echo templatereplace(file_get_contents($sTemplatePath.\"/endpage.pstpl\"),array(),$redata,'frontend_helper[2622]');\n            doFooter();\n            killSurveySession($surveyid);\n            exit;\n            }\n\n            if ((isset($quota['status']) && $quota['status'] == \"matched\") && (isset($quota['Action']) && $quota['Action'] == \"2\"))\n            {\n\n                sendCacheHeaders();\n                doHeader();\n\n                $redata = compact(array_keys(get_defined_vars()));\n                echo templatereplace(file_get_contents($sTemplatePath.\"/startpage.pstpl\"),array(),$redata,'frontend_helper[2634]');\n                echo \"\\t<div class='quotamessage'>\\n\";\n                echo \"\\t\".$quota['Message'].\"<br /><br />\\n\";\n                echo \"\\t<a href='\".$quota['Url'].\"'>\".$quota['UrlDescrip'].\"</a><br />\\n\";\n                echo CHtml::form(array(\"/survey/index\"), 'post', array('id'=>'limesurvey','name'=>'limesurvey')).\"\n                <input type='hidden' name='move' value='movenext' id='movenext' />\n                <button class='nav-button nav-button-icon-left ui-corner-all' class='submit' accesskey='p' onclick=\\\"javascript:document.limesurvey.move.value = 'moveprev'; document.limesurvey.submit();\\\" id='moveprevbtn'>\".$clang->gT(\"Previous\").\"</button>\n                <input type='hidden' name='thisstep' value='\".($_SESSION['survey_'.$surveyid]['step']).\"' id='thisstep' />\n                <input type='hidden' name='sid' value='\".returnGlobal('sid',true).\"' id='sid' />\n                <input type='hidden' name='token' value='\".$clienttoken.\"' id='token' />\n                </form>\\n\";\n                echo \"\\t</div>\\n\";\n                echo templatereplace(file_get_contents($sTemplatePath.\"/endpage.pstpl\"),array(),$redata,'frontend_helper[2644]');\n                doFooter();\n                exit;\n            }\n        }\n    }\n    else\n    {\n        // Unknown value\n        return false;\n    }\n\n}\n\n/**\n* encodeEmail : encode admin email in public part\n*\n* @param mixed $mail\n* @param mixed $text\n* @param mixed $class\n* @param mixed $params\n*/\nfunction encodeEmail($mail, $text=\"\", $class=\"\", $params=array())\n{\n    $encmail =\"\";\n    for($i=0; $i<strlen($mail); $i++)\n    {\n        $encMod = rand(0,2);\n        switch ($encMod)\n        {\n            case 0: // None\n                $encmail .= substr($mail,$i,1);\n                break;\n            case 1: // Decimal\n                $encmail .= \"&#\".ord(substr($mail,$i,1)).';';\n                break;\n            case 2: // Hexadecimal\n                $encmail .= \"&#x\".dechex(ord(substr($mail,$i,1))).';';\n                break;\n        }\n    }\n\n    if(!$text)\n    {\n        $text = $encmail;\n    }\n    return $text;\n}\n\n/**\n* GetReferringUrl() returns the referring URL\n* @return string\n*/\nfunction GetReferringUrl()\n{\n    global $clang;\n\n    $clang = Yii::app()->lang;\n\n    // read it from server variable\n    if(isset($_SERVER[\"HTTP_REFERER\"]))\n    {\n        if(!preg_match('/'.$_SERVER[\"SERVER_NAME\"].'/', $_SERVER[\"HTTP_REFERER\"]))\n        {\n            if (!Yii::app()->getConfig('strip_query_from_referer_url'))\n            {\n                return $_SERVER[\"HTTP_REFERER\"];\n            }\n            else\n            {\n                $aRefurl = explode(\"?\",$_SERVER[\"HTTP_REFERER\"]);\n                return $aRefurl[0];\n            }\n        }\n        else\n        {\n            return '-';\n        }\n    }\n    else\n    {\n        return null;\n    }\n}\n\n/**\n* Shows the welcome page, used in group by group and question by question mode\n*/\nfunction display_first_page() {\n    global $token, $surveyid, $thissurvey, $navigator;\n\t$totalquestions = $_SESSION['survey_'.$surveyid]['totalquestions'];\n\n    $clang = Yii::app()->lang;\n\n    // Fill some necessary var for template\n    $navigator = surveymover();\n    $sitename = Yii::app()->getConfig('sitename');\n    $languagechanger=makeLanguageChangerSurvey($clang->langcode);\n\n    sendCacheHeaders();\n    doHeader();\n\n    LimeExpressionManager::StartProcessingPage();\n    LimeExpressionManager::StartProcessingGroup(-1, false, $surveyid);  // start on welcome page\n\n    $redata = compact(array_keys(get_defined_vars()));\n    $sTemplatePath=$_SESSION['survey_'.$surveyid]['templatepath'];\n\n    echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[2757]');\n    echo CHtml::form(array(\"/survey/index\"), 'post', array('id'=>'limesurvey','name'=>'limesurvey','autocomplete'=>'off'));\n    echo \"\\n\\n<!-- START THE SURVEY -->\\n\";\n\n    echo templatereplace(file_get_contents($sTemplatePath.\"welcome.pstpl\"),array(),$redata,'frontend_helper[2762]').\"\\n\";\n    if ($thissurvey['anonymized'] == \"Y\")\n    {\n        echo templatereplace(file_get_contents($sTemplatePath.\"/privacy.pstpl\"),array(),$redata,'frontend_helper[2765]').\"\\n\";\n    }\n    echo templatereplace(file_get_contents($sTemplatePath.\"navigator.pstpl\"),array(),$redata,'frontend_helper[2767]');\n    if ($thissurvey['active'] != \"Y\")\n    {\n        echo \"<p style='text-align:center' class='error'>\".$clang->gT(\"This survey is currently not active. You will not be able to save your responses.\").\"</p>\\n\";\n    }\n    echo \"\\n<input type='hidden' name='sid' value='$surveyid' id='sid' />\\n\";\n    if (isset($token) && !empty($token)) {\n        echo \"\\n<input type='hidden' name='token' value='$token' id='token' />\\n\";\n    }\n    echo \"\\n<input type='hidden' name='lastgroupname' value='_WELCOME_SCREEN_' id='lastgroupname' />\\n\"; //This is to ensure consistency with mandatory checks, and new group test\n    $loadsecurity = returnGlobal('loadsecurity',true);\n    if (isset($loadsecurity)) {\n        echo \"\\n<input type='hidden' name='loadsecurity' value='$loadsecurity' id='loadsecurity' />\\n\";\n    }\n    $_SESSION['survey_'.$surveyid]['LEMpostKey'] = mt_rand();\n    echo \"<input type='hidden' name='LEMpostKey' value='{$_SESSION['survey_'.$surveyid]['LEMpostKey']}' id='LEMpostKey' />\\n\";\n    echo \"<input type='hidden' name='thisstep' id='thisstep' value='0' />\\n\";\n\n    echo \"\\n</form>\\n\";\n    echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[2782]');\n\n    echo LimeExpressionManager::GetRelevanceAndTailoringJavaScript();\n    LimeExpressionManager::FinishProcessingPage();\n    doFooter();\n}\n\n/**\n* killSurveySession : reset $_SESSION part for the survey\n* @param int $iSurveyID\n*/\nfunction killSurveySession($iSurveyID)\n{\n    // Unset the session\n    unset($_SESSION['survey_'.$iSurveyID]);\n    // Force EM to refresh\n    LimeExpressionManager::SetDirtyFlag();\n}\n\n/**\n* Resets all question timers by expiring the related cookie - this needs to be called before any output is done\n* @todo Make cookie survey ID aware\n*/\nfunction resetTimers()\n{\n    $cookie=new CHttpCookie('limesurvey_timers', '');\n    $cookie->expire = time()- 3600;\n    Yii::app()->request->cookies['limesurvey_timers'] = $cookie;\n}\n\n/**\n* Set the public survey language\n* Control if language exist in this survey, else set to survey default language\n* if $surveyid <= 0 : set the language to default site language\n* @param int $surveyid\n* @param string $language\n*/\nfunction SetSurveyLanguage($surveyid, $language)\n{\n    $surveyid=sanitize_int($surveyid);\n    $default_language = Yii::app()->getConfig('defaultlang');\n\n    if (isset($surveyid) && $surveyid>0)\n    {\n        $default_survey_language= Survey::model()->findByPk($surveyid)->language;\n        $additional_survey_languages = Survey::model()->findByPk($surveyid)->getAdditionalLanguages();\n        if (!isset($language) || ($language=='')\n        || !( in_array($language,$additional_survey_languages) || $language==$default_survey_language)\n        )\n        {\n            // Language not supported, fall back to survey's default language\n            $_SESSION['survey_'.$surveyid]['s_lang'] = $default_survey_language;\n        } else {\n            $_SESSION['survey_'.$surveyid]['s_lang'] =  $language;\n        }\n        Yii::import('application.libraries.Limesurvey_lang', true);\n        $clang = new limesurvey_lang($_SESSION['survey_'.$surveyid]['s_lang']);\n        $thissurvey=getSurveyInfo($surveyid, @$_SESSION['survey_'.$surveyid]['s_lang']);\n        Yii::app()->loadHelper('surveytranslator');\n        $_SESSION['dateformats'] = getDateFormatData($thissurvey['surveyls_dateformat'],$_SESSION['survey_'.$surveyid]['s_lang']);\n        LimeExpressionManager::SetEMLanguage($_SESSION['survey_'.$surveyid]['s_lang']);\n    }\n    else\n    {\n        if(!$language)\n        {\n            $language=$default_language;\n        }\n        $_SESSION['survey_'.$surveyid]['s_lang'] = $language;\n        Yii::import('application.libraries.Limesurvey_lang', true);\n        $clang = new Limesurvey_lang($language);\n    }\n\n    $oApplication=Yii::app();\n    $oApplication->lang=$clang;\n    return $clang;\n}\n\n/**\n* getMove get move button clicked\n**/\nfunction getMove()\n{\n#    $clang = Yii::app()->lang;\n    $aAcceptedMove=array('default','movenext','movesubmit','moveprev','saveall','loadall','clearall','changelang');\n    // We can control is save and load are OK : todo fix according to survey settings\n    // Maybe allow $aAcceptedMove in Plugin\n    $move=Yii::app()->request->getParam('move');\n    foreach($aAcceptedMove as $sAccepteMove)\n    {\n        if(Yii::app()->request->getParam($sAccepteMove))\n            $move=$sAccepteMove;\n    }\n    if($move=='clearall' && App()->request->getPost('confirm-clearall')!='confirm'){\n            $move=\"clearcancel\";\n    }\n    if($move=='default')\n    {\n        $surveyid=Yii::app()->getConfig('surveyID');\n        $thissurvey=getsurveyinfo($surveyid);\n        $iSessionStep=(isset($_SESSION['survey_'.$surveyid]['step']))?$_SESSION['survey_'.$surveyid]['step']:false;\n        $iSessionTotalSteps=(isset($_SESSION['survey_'.$surveyid]['totalsteps']))?$_SESSION['survey_'.$surveyid]['totalsteps']:false;\n        if ($iSessionStep && ($iSessionStep == $iSessionTotalSteps)|| $thissurvey['format'] == 'A')\n        {\n            $move=\"movesubmit\";\n        }\n        else\n        {\n            $move=\"movenext\";\n        }\n    }\n    return $move;\n}\n\n"], "fixing_code": ["<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');\n/*\n* LimeSurvey\n* Copyright (C) 2007-2011 The LimeSurvey Project Team / Carsten Schmitz\n* All rights reserved.\n* License: GNU/GPL License v2 or later, see LICENSE.php\n* LimeSurvey is free software. This version may have been modified pursuant\n* to the GNU General Public License, and as distributed it includes or\n* is derivative of works licensed under the GNU General Public License or\n* other free or open source software licenses.\n* See COPYRIGHT.php for copyright notices and details.\n*/\nYii::import('application.helpers.sanitize_helper', true);\n\n/**\n* Simple function to sort the permissions by title\n*\n* @param mixed $aPermissionA  Permission A to compare\n* @param mixed $aPermissionB  Permission B to compare\n*/\nfunction comparePermission($aPermissionA,$aPermissionB)\n{\n    if($aPermissionA['title'] >$aPermissionB['title']) {\n        return 1;\n    }\n    else {\n        return -1;\n    }\n}\n\n/**\n * Translation helper function.\n * @param string $string\n * @param string $escapemode\n */\nfunction gT($string, $escapemode = 'html')\n{\n    Yii::import('application.libraries.Limesurvey_lang');\n    if (isset(App()->lang))\n    {\n        return App()->lang->gT($string, $escapemode);\n    }\n    else\n    {\n        return $string;\n    }\n}\n\nfunction eT($string, $escapemode = 'html')\n{\n    echo gT($string, $escapemode);\n}\n\nfunction ngT($single, $plural, $number, $escapemode = 'html')\n{\n    Yii::import('application.libraries.Limesurvey_lang');\n    return App()->lang->ngT($single, $plural, $number, $escapemode);\n}\n/**\n* getQuestionTypeList() Returns list of question types available in LimeSurvey. Edit this if you are adding a new\n*    question type\n*\n* @param string $SelectedCode Value of the Question Type (defaults to \"T\")\n* @param string $ReturnType Type of output from this function (defaults to selector)\n*\n* @return depending on $ReturnType param, returns a straight \"array\" of question types, or an <option></option> list\n*\n*/\nfunction getQuestionTypeList($SelectedCode = \"T\", $ReturnType = \"selector\")\n{\n    $publicurl = Yii::app()->getConfig('publicurl');\n    \n    $qtypes = Question::typeList();\n    if ($ReturnType == \"array\")\n        return $qtypes;\n\n    if ($ReturnType == \"group\")\n    {\n        foreach ($qtypes as $qkey => $qtype)\n        {\n            $newqType[$qtype['group']][$qkey] = $qtype;\n        }\n\n\n        $qtypeselecter = \"\";\n        foreach ($newqType as $group => $members)\n        {\n            $qtypeselecter .= '<optgroup label=\"' . $group . '\">';\n            foreach ($members as $TypeCode => $TypeProperties)\n            {\n                $qtypeselecter .= \"<option value='$TypeCode'\";\n                if ($SelectedCode == $TypeCode)\n                {\n                    $qtypeselecter .= \" selected='selected'\";\n                }\n                $qtypeselecter .= \">{$TypeProperties['description']}</option>\\n\";\n            }\n            $qtypeselecter .= '</optgroup>';\n        }\n\n        return $qtypeselecter;\n    };\n    $qtypeselecter = \"\";\n    foreach ($qtypes as $TypeCode => $TypeProperties)\n    {\n        $qtypeselecter .= \"<option value='$TypeCode'\";\n        if ($SelectedCode == $TypeCode)\n        {\n            $qtypeselecter .= \" selected='selected'\";\n        }\n        $qtypeselecter .= \">{$TypeProperties['description']}</option>\\n\";\n    }\n    return $qtypeselecter;\n}\n\n/**\n* isStandardTemplate returns true if a template is a standard template\n* This function does not check if a template actually exists\n*\n* @param mixed $sTemplateName template name to look for\n* @return bool True if standard template, otherwise false\n*/\nfunction isStandardTemplate($sTemplateName)\n{\n    return in_array($sTemplateName,array('basic',\n    'bluengrey',\n    'business_grey',\n    'citronade',\n    'clear_logo',\n    'default',\n    'eirenicon',\n    'limespired',\n    'mint_idea',\n    'sherpa',\n    'vallendar'));\n}\n\n/**\n* getSurveyList() Queries the database (survey table) for a list of existing surveys\n*\n* @param boolean $returnarray if set to true an array instead of an HTML option list is given back\n* @return string This string is returned containing <option></option> formatted list of existing surveys\n*\n*/\nfunction getSurveyList($returnarray=false, $surveyid=false)\n{\n    static $cached = null;\n\n    $timeadjust = getGlobalSetting('timeadjust');\n    $clang = new Limesurvey_lang(isset(Yii::app()->session['adminlang']) ? Yii::app()->session['adminlang'] : 'en');\n\n    if(is_null($cached)) {\n        $args = array('order'=>'surveyls_title');\n        if (!Permission::model()->hasGlobalPermission('superadmin','read'))\n        {\n            $surveyidresult = Survey::model()->permission(Yii::app()->user->getId())->with(array('languagesettings'=>array('condition'=>'surveyls_language=language')))->findAll($args);\n        } else {\n            $surveyidresult = Survey::model()->with(array('languagesettings'=>array('condition'=>'surveyls_language=language')))->findAll($args);\n        }\n\n        $surveynames = array();\n        foreach ($surveyidresult as $result)\n        {\n            $surveynames[] = array_merge($result->attributes, $result->defaultlanguage->attributes);\n        }\n\n        $cached = $surveynames;\n    } else {\n        $surveynames = $cached;\n    }\n    $surveyselecter = \"\";\n    if ($returnarray===true) return $surveynames;\n    $activesurveys='';\n    $inactivesurveys='';\n    $expiredsurveys='';\n    if ($surveynames)\n    {\n        foreach($surveynames as $sv)\n        {\n\n            $surveylstitle=flattenText($sv['surveyls_title']);\n            if (strlen($surveylstitle)>45)\n            {\n                $surveylstitle = htmlspecialchars(mb_strcut(html_entity_decode($surveylstitle,ENT_QUOTES,'UTF-8'), 0, 45, 'UTF-8')).\"...\";\n            }\n\n            if($sv['active']!='Y')\n            {\n                $inactivesurveys .= \"<option \";\n                if(Yii::app()->user->getId() == $sv['owner_id'])\n                {\n                    $inactivesurveys .= \" class='mysurvey emphasis'\";\n                }\n                if ($sv['sid'] == $surveyid)\n                {\n                    $inactivesurveys .= \" selected='selected'\"; $svexist = 1;\n                }\n                $inactivesurveys .=\" value='{$sv['sid']}'>{$surveylstitle}</option>\\n\";\n            } elseif($sv['expires']!='' && $sv['expires'] < dateShift(date(\"Y-m-d H:i:s\"), \"Y-m-d H:i:s\", $timeadjust))\n            {\n                $expiredsurveys .=\"<option \";\n                if (Yii::app()->user->getId() == $sv['owner_id'])\n                {\n                    $expiredsurveys .= \" class='mysurvey emphasis'\";\n                }\n                if ($sv['sid'] == $surveyid)\n                {\n                    $expiredsurveys .= \" selected='selected'\"; $svexist = 1;\n                }\n                $expiredsurveys .=\" value='{$sv['sid']}'>{$surveylstitle}</option>\\n\";\n            } else\n            {\n                $activesurveys .= \"<option \";\n                if(Yii::app()->user->getId() == $sv['owner_id'])\n                {\n                    $activesurveys .= \" class='mysurvey emphasis'\";\n                }\n                if ($sv['sid'] == $surveyid)\n                {\n                    $activesurveys .= \" selected='selected'\"; $svexist = 1;\n                }\n                $activesurveys .=\" value='{$sv['sid']}'>{$surveylstitle}</option>\\n\";\n            }\n        } // End Foreach\n    }\n\n    //Only show each activesurvey group if there are some\n    if ($activesurveys!='')\n    {\n        $surveyselecter .= \"<optgroup label='\".$clang->gT(\"Active\").\"' class='activesurveyselect'>\\n\";\n        $surveyselecter .= $activesurveys . \"</optgroup>\";\n    }\n    if ($expiredsurveys!='')\n    {\n        $surveyselecter .= \"<optgroup label='\".$clang->gT(\"Expired\").\"' class='expiredsurveyselect'>\\n\";\n        $surveyselecter .= $expiredsurveys . \"</optgroup>\";\n    }\n    if ($inactivesurveys!='')\n    {\n        $surveyselecter .= \"<optgroup label='\".$clang->gT(\"Inactive\").\"' class='inactivesurveyselect'>\\n\";\n        $surveyselecter .= $inactivesurveys . \"</optgroup>\";\n    }\n    if (!isset($svexist))\n    {\n        $surveyselecter = \"<option selected='selected' value=''>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;\n    } else\n    {\n        $surveyselecter = \"<option value=''>\".$clang->gT(\"None\").\"</option>\\n\".$surveyselecter;\n    }\n    return $surveyselecter;\n}\n\nfunction getTemplateList()\n{\n    $usertemplaterootdir=Yii::app()->getConfig(\"usertemplaterootdir\");\n    $standardtemplaterootdir=Yii::app()->getConfig(\"standardtemplaterootdir\");\n\n    if (!$usertemplaterootdir) {die(\"getTemplateList() no template directory\");}\n    if ($handle = opendir($standardtemplaterootdir))\n    {\n        while (false !== ($file = readdir($handle)))\n        {\n            if (!is_file(\"$standardtemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\" && isStandardTemplate($file))\n            {\n                $list_of_files[$file] = $standardtemplaterootdir.DIRECTORY_SEPARATOR.$file;\n            }\n        }\n        closedir($handle);\n    }\n\n    if ($handle = opendir($usertemplaterootdir))\n    {\n        while (false !== ($file = readdir($handle)))\n        {\n            if (!is_file(\"$usertemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\")\n            {\n                $list_of_files[$file] = $usertemplaterootdir.DIRECTORY_SEPARATOR.$file;\n            }\n        }\n        closedir($handle);\n    }\n    ksort($list_of_files);\n\n    return $list_of_files;\n}\n\nfunction getAdminThemeList()\n{\n    // $usertemplaterootdir=Yii::app()->getConfig(\"usertemplaterootdir\");\n    $standardtemplaterootdir=Yii::app()->getConfig(\"styledir\");\n\n    //    if (!$usertemplaterootdir) {die(\"getTemplateList() no template directory\");}\n    if ($handle = opendir($standardtemplaterootdir))\n    {\n        while (false !== ($file = readdir($handle)))\n        {\n            if (!is_file(\"$standardtemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\")\n            {\n                $list_of_files[$file] = $standardtemplaterootdir.DIRECTORY_SEPARATOR.$file;\n            }\n        }\n        closedir($handle);\n    }\n\n    /*    if ($handle = opendir($usertemplaterootdir))\n    {\n    while (false !== ($file = readdir($handle)))\n    {\n    if (!is_file(\"$usertemplaterootdir/$file\") && $file != \".\" && $file != \"..\" && $file!=\".svn\")\n    {\n    $list_of_files[$file] = $usertemplaterootdir.DIRECTORY_SEPARATOR.$file;\n    }\n    }\n    closedir($handle);\n    }         */\n    ksort($list_of_files);\n\n    return $list_of_files;\n}\n\n\n/**\n* getQuestions() queries the database for an list of all questions matching the current survey and group id\n*\n* @return This string is returned containing <option></option> formatted list of questions in the current survey and group\n*/\nfunction getQuestions($surveyid,$gid,$selectedqid)\n{\n   $clang = Yii::app()->lang;\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $qrows = Question::model()->findAllByAttributes(array('sid' => $surveyid, 'gid' => $gid, 'language' => $s_lang, 'parent_qid' => 0),array('order'=>'question_order'));\n\n    if (!isset($sQuestionselecter)) {$sQuestionselecter=\"\";}\n    foreach ($qrows as $qrow)\n    {\n        $qrow = $qrow->attributes;\n        $qrow['title'] = strip_tags($qrow['title']);\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid.\"/gid/\".$gid.\"/qid/\".$qrow['qid']);\n        $sQuestionselecter .= \"<option value='{$link}'\";\n        if ($selectedqid == $qrow['qid'])\n        {\n            $sQuestionselecter .= \" selected='selected'\";\n            $qexists=true;\n        }\n        $sQuestionselecter .=\">{$qrow['title']}:\";\n        $sQuestionselecter .= \" \";\n        $question=flattenText($qrow['question']);\n        if (strlen($question)<35)\n        {\n            $sQuestionselecter .= $question;\n        }\n        else\n        {\n            $sQuestionselecter .= htmlspecialchars(mb_strcut(html_entity_decode($question,ENT_QUOTES,'UTF-8'), 0, 35, 'UTF-8')).\"...\";\n        }\n        $sQuestionselecter .= \"</option>\\n\";\n    }\n\n    if (!isset($qexists))\n    {\n        $sQuestionselecter = \"<option selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$sQuestionselecter;\n    }\n    else\n    {\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid.\"/gid/\".$gid);\n        $sQuestionselecter = \"<option value='{$link}'>\".$clang->gT(\"None\").\"</option>\\n\".$sQuestionselecter;\n    }\n    return $sQuestionselecter;\n}\n\n/**\n* getGidPrevious() returns the Gid of the group prior to the current active group\n*\n* @param string $surveyid\n* @param string $gid\n*\n* @return The Gid of the previous group\n*/\nfunction getGidPrevious($surveyid, $gid)\n{\n    $clang = Yii::app()->lang;\n\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $qresult = QuestionGroup::model()->findAllByAttributes(array('sid' => $surveyid, 'language' => $s_lang), array('order'=>'group_order'));\n\n    $i = 0;\n    $iPrev = -1;\n    foreach ($qresult as $qrow)\n    {\n        $qrow = $qrow->attributes;\n        if ($gid == $qrow['gid']) {$iPrev = $i - 1;}\n        $i += 1;\n    }\n\n    if ($iPrev >= 0) {$GidPrev = $qresult[$iPrev]->gid;}\n    else {$GidPrev = \"\";}\n    return $GidPrev;\n}\n\n/**\n* getQidPrevious() returns the Qid of the question prior to the current active question\n*\n* @param string $surveyid\n* @param string $gid\n* @param string $qid\n*\n* @return This Qid of the previous question\n*/\nfunction getQidPrevious($surveyid, $gid, $qid)\n{\n    $clang = Yii::app()->lang;\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $qrows = Question::model()->findAllByAttributes(array('gid' => $gid, 'sid' => $surveyid, 'language' => $s_lang, 'parent_qid'=>0),array('order'=>'question_order'));\n\n    $i = 0;\n    $iPrev = -1;\n    if (count($qrows) > 0)\n    {\n\n        foreach ($qrows as $qrow)\n        {\n            $qrow = $qrow->attributes;\n            if ($qid == $qrow['qid']) {$iPrev = $i - 1;}\n            $i += 1;\n        }\n    }\n    if ($iPrev >= 0) {$QidPrev = $qrows[$iPrev]->qid;}\n    else {$QidPrev = \"\";}\n\n\n    return $QidPrev;\n}\n\n/**\n* getGidNext() returns the Gid of the group next to the current active group\n*\n* @param string $surveyid\n* @param string $gid\n*\n* @return The Gid of the next group\n*/\nfunction getGidNext($surveyid, $gid)\n{\n    $clang = Yii::app()->lang;\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    $qresult = QuestionGroup::model()->findAllByAttributes(array('sid' => $surveyid, 'language' => $s_lang), array('order'=>'group_order'));\n\n    $GidNext=\"\";\n    $i = 0;\n    $iNext = 0;\n\n    foreach ($qresult as $qrow)\n    {\n        $qrow = $qrow->attributes;\n        if ($gid == $qrow['gid']) {$iNext = $i + 1;}\n        $i += 1;\n    }\n\n    if ($iNext < count($qresult)) {$GidNext = $qresult[$iNext]->gid;}\n    else {$GidNext = \"\";}\n    return $GidNext;\n}\n\n/**\n* getQidNext() returns the Qid of the question prior to the current active question\n*\n* @param string $surveyid\n* @param string $gid\n* @param string $qid\n*\n* @return This Qid of the previous question\n*/\nfunction getQidNext($surveyid, $gid, $qid)\n{\n    $clang = Yii::app()->lang;\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    $qrows = Question::model()->findAllByAttributes(array('gid' => $gid, 'sid' => $surveyid, 'language' => $s_lang, 'parent_qid' => 0), array('order'=>'question_order'));\n    $i = 0;\n    $iNext = 0;\n\n    foreach ($qrows as $qrow)\n    {\n        if ($qid == $qrow->qid && $qid) {$iNext = $i + 1;}\n        $i += 1;\n    }\n\n    if ($iNext < count($qrows)) {$QidNext = $qrows[$iNext]->qid;}\n    else {$QidNext = \"\";}\n    return $QidNext;\n}\n\nfunction convertGETtoPOST($url)\n{\n    // This function must be deprecated and replaced by $.post\n    $url = preg_replace('/&amp;/i','&',$url);\n    $stack = explode('?',$url);\n    $calledscript = array_shift($stack);\n    $query = array_shift($stack);\n    $aqueryitems = explode('&',$query);\n    $arrayParam = Array();\n    $arrayVal = Array();\n\n    foreach ($aqueryitems as $queryitem)\n    {\n        $stack =  explode ('=', $queryitem);\n        $paramname = array_shift($stack);\n        $value = array_shift($stack);\n        $arrayParam[] = \"'\".$paramname.\"'\";\n        $arrayVal[] = substr($value, 0, 9) != \"document.\" ? \"'\".$value.\"'\" : $value;\n    }\n    //    $Paramlist = \"[\" . implode(\",\",$arrayParam) . \"]\";\n    //    $Valuelist = \"[\" . implode(\",\",$arrayVal) . \"]\";\n    $Paramlist = \"new Array(\" . implode(\",\",$arrayParam) . \")\";\n    $Valuelist = \"new Array(\" . implode(\",\",$arrayVal) . \")\";\n    $callscript = \"sendPost('$calledscript','',$Paramlist,$Valuelist);\";\n    return $callscript;\n}\n\n\n/**\n* This function calculates how much space is actually used by all files uploaded\n* using the File Upload question type\n*\n* @returns integer Actual space used in MB\n*/\nfunction calculateTotalFileUploadUsage(){\n    global $uploaddir;\n    $sQuery='select sid from {{surveys}}';\n    $oResult = dbExecuteAssoc($sQuery); //checked\n    $aRows = $oResult->readAll();\n    $iTotalSize=0.0;\n    foreach ($aRows as $aRow)\n    {\n        $sFilesPath=$uploaddir.'/surveys/'.$aRow['sid'].'/files';\n        if (file_exists($sFilesPath))\n        {\n            $iTotalSize+=(float)getDirectorySize($sFilesPath);\n        }\n    }\n    return (float)$iTotalSize/1024/1024;\n}\n\nfunction getDirectorySize($directory) {\n    $size = 0;\n    foreach(new RecursiveIteratorIterator(new RecursiveDirectoryIterator($directory)) as $file){\n        $size+=$file->getSize();\n    }\n    return $size;\n}\n\n\n/**\n* Gets number of groups inside a particular survey\n*\n* @param string $surveyid\n* @param mixed $lang\n*/\nfunction getGroupSum($surveyid, $lang)\n{\n    //$condn = \"WHERE sid=\".$surveyid.\" AND language='\".$lang.\"'\"; //Getting a count of questions for this survey\n    $condn = array('sid'=>$surveyid,'language'=>$lang);\n    $sumresult3 = count(QuestionGroup::model()->findAllByAttributes($condn)); //Checked)\n\n    return $sumresult3 ;\n}\n\n\n/**\n* getMaxGroupOrder($surveyid) queries the database for the maximum sortorder of a group and returns the next higher one.\n*\n* @param mixed $surveyid\n*/\nfunction getMaxGroupOrder($surveyid)\n{\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    //$max_sql = \"SELECT max( group_order ) AS max FROM \".db_table_name('groups').\" WHERE sid =$surveyid AND language='{$s_lang}'\" ;\n    $query = QuestionGroup::model()->find(array('order' => 'group_order desc'));\n    $current_max = !is_null($query) ? $query->group_order : '';\n\n    if($current_max!=\"\")\n    {\n        return ++$current_max ;\n    }\n    else return \"0\" ;\n}\n\n\n/**\n* getGroupOrder($surveyid,$gid) queries the database for the sortorder of a group.\n*\n* @param mixed $surveyid\n* @param mixed $gid\n* @return mixed\n*/\nfunction getGroupOrder($surveyid,$gid)\n{\n\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    //$grporder_sql = \"SELECT group_order FROM \".db_table_name('groups').\" WHERE sid =$surveyid AND language='{$s_lang}' AND gid=$gid\" ;\n    $grporder_result = QuestionGroup::model()->findByAttributes(array('sid' => $surveyid, 'gid' => $gid, 'language' => $s_lang)); //Checked\n    $grporder_row = $grporder_result->attributes ;\n    $group_order = $grporder_row['group_order'];\n    if($group_order==\"\")\n    {\n        return \"0\" ;\n    }\n    else return $group_order ;\n}\n\n/**\n* getMaxQuestionOrder($gid) queries the database for the maximum sortorder of a question.\n*\n*/\nfunction getMaxQuestionOrder($gid,$surveyid)\n{\n    $gid=sanitize_int($gid);\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n    $max_sql = \"SELECT max( question_order ) AS max FROM {{questions}} WHERE gid='$gid' AND language='$s_lang'\";\n\n    $max_result = Yii::app()->db->createCommand($max_sql)->query(); //Checked\n    $maxrow = $max_result->read() ;\n    $current_max = $maxrow['max'];\n    if($current_max==\"\")\n    {\n        return \"0\" ;\n    }\n    else return $current_max ;\n}\n\n/**\n* getQuestionClass() returns a class name for a given question type to allow custom styling for each question type.\n*\n* @param string $input containing unique character representing each question type.\n* @return string containing the class name for a given question type.\n*/\nfunction getQuestionClass($input)\n{\n\n    switch($input)\n    {   // I think this is a bad solution to adding classes to question\n        // DIVs but I can't think of a better solution. (eric_t_cruiser)\n\n        case 'X': return 'boilerplate';     //  BOILERPLATE QUESTION\n        case '5': return 'choice-5-pt-radio';   //  5 POINT CHOICE radio-buttons\n        case 'D': return 'date';        //  DATE\n        case 'Z': return 'list-radio-flexible'; //  LIST Flexible radio-button\n        case 'L': return 'list-radio';      //  LIST radio-button\n        case 'W': return 'list-dropdown-flexible'; //   LIST drop-down (flexible label)\n        case '!': return 'list-dropdown';   //  List - dropdown\n        case 'O': return 'list-with-comment';   //  LIST radio-button + textarea\n        case 'R': return 'ranking';     //  RANKING STYLE\n        case 'M': return 'multiple-opt';    //  Multiple choice checkbox\n        case 'I': return 'language';        //  Language Question\n        case 'P': return 'multiple-opt-comments'; //    Multiple choice with comments checkbox + text\n        case 'Q': return 'multiple-short-txt';  //  TEXT\n        case 'K': return 'numeric-multi';   //  MULTIPLE NUMERICAL QUESTION\n        case 'N': return 'numeric';     //  NUMERICAL QUESTION TYPE\n        case 'S': return 'text-short';      //  SHORT FREE TEXT\n        case 'T': return 'text-long';       //  LONG FREE TEXT\n        case 'U': return 'text-huge';       //  HUGE FREE TEXT\n        case 'Y': return 'yes-no';      //  YES/NO radio-buttons\n        case 'G': return 'gender';      //  GENDER drop-down list\n        case 'A': return 'array-5-pt';      //  ARRAY (5 POINT CHOICE) radio-buttons\n        case 'B': return 'array-10-pt';     //  ARRAY (10 POINT CHOICE) radio-buttons\n        case 'C': return 'array-yes-uncertain-no'; //   ARRAY (YES/UNCERTAIN/NO) radio-buttons\n        case 'E': return 'array-increase-same-decrease'; // ARRAY (Increase/Same/Decrease) radio-buttons\n        case 'F': return 'array-flexible-row';  //  ARRAY (Flexible) - Row Format\n        case 'H': return 'array-flexible-column'; //    ARRAY (Flexible) - Column Format\n            //      case '^': return 'slider';          //  SLIDER CONTROL\n        case ':': return 'array-multi-flexi';   //  ARRAY (Multi Flexi) 1 to 10\n        case \";\": return 'array-multi-flexi-text';\n        case \"1\": return 'array-flexible-duel-scale'; //    Array dual scale\n        case \"*\": return 'equation';    // Equation\n        default:  return 'generic_question';    //  Should have a default fallback\n    };\n};\n\n/**\n* setupColumns() defines all the html tags to be wrapped around\n* various list type answers.\n*\n* @param integer $columns - the number of columns, usually supplied by $dcols\n* @param integer $answer_count - the number of answers to a question, usually supplied by $anscount\n* @param string $wrapperclass - a global class for the wrapper\n* @param string $itemclass - a class for the item\n* @return array with all the various opening and closing tags to generate a set of columns.\n*\n* It returns an array with the following items:\n*    $wrapper['whole-start']   = Opening wrapper for the whole list\n*    $wrapper['whole-end']     = closing wrapper for the whole list\n*    $wrapper['col-devide']    = normal column devider\n*    $wrapper['col-devide-last'] = the last column devider (to allow\n*                                for different styling of the last\n*                                column\n*    $wrapper['item-start']    = opening wrapper tag for individual\n*                                option\n*    $wrapper['item-start-other'] = opening wrapper tag for other\n*                                option\n*    $wrapper['item-start-noanswer'] = opening wrapper tag for no answer\n*                                option\n*    $wrapper['item-end']      = closing wrapper tag for individual\n*                                option\n*    $wrapper['maxrows']       = maximum number of rows in each\n*                                column\n*    $wrapper['cols']          = Number of columns to be inserted\n*                                (and checked against)\n*\n*\n* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -\n* Columns are a problem.\n* Really there is no perfect solution to columns at the moment.\n*\n* -  Using Tables is problematic semanticly.\n* -  Using inline or float to create columns, causes the answers\n*    flows horizontally, not vertically which is not ideal visually.\n* -  Using CSS3 columns is also a problem because of browser support\n*    and also because if you have answeres split across two or more\n*    lines, and those answeres happen to fall at the bottom of a\n*    column, the answer might be split across columns as well as\n*    lines.\n* -  Using nested unordered list with the first level of <LI>s\n*    floated is the same as using tables and so is bad semantically\n*    for the same reason tables are bad.\n* -  Breaking the unordered lists into consecutive floated unordered\n*    lists is not great semantically but probably not as bad as\n*    using tables.\n*\n* Because I haven't been able to decide which option is the least\n* bad, I have handed over that responsibility to the admin who sets\n* LimeSurvey up on their server.\n*\n* There are four options:\n*    'css'   using one of the various CSS only methods for\n*            rendering columns.\n*            (Check the CSS file for your chosen template to see\n*             how columns are defined.)\n*    'ul'    using multiple floated unordered lists. (DEFAULT)\n*    'table' using conventional tables based layout.\n*     NULL   blocks the use of columns\n*\n* 'ul' is the default because it's the best possible compromise\n* between semantic markup and visual layout.\n*/\nfunction setupColumns($columns, $answer_count,$wrapperclass=\"\",$itemclass=\"\")\n{\n\n    $column_style = Yii::app()->getConfig('column_style');\n    if ( !in_array($column_style,array('css','ul','table')) && !is_null($column_style) )\n    {\n        $column_style = 'ul';\n    };\n    if(!is_null($column_style) && $columns!=1) // Add a global class for all column.\n    {\n        $wrapperclass.= \" colstyle-{$column_style}\";\n    }\n    if($columns < 2)\n    {\n        $column_style = null;\n        $columns = 1;\n    }\n\n    if(($columns > $answer_count) && $answer_count>0)\n    {\n        $columns = $answer_count;\n    };\n\n\n    $class_first = ' class=\"'.$wrapperclass.'\"';\n    if($columns > 1 && !is_null($column_style))\n    {\n        if($column_style == 'ul')\n        {\n            $ul = '-ul';\n        }\n        else\n        {\n            $ul = '';\n        }\n        $class_first = ' class=\"'.$wrapperclass.' cols-'.$columns . $ul.' first\"';\n        $class = ' class=\"'.$wrapperclass.' cols-'.$columns . $ul.'\"';\n        $class_last_ul = ' class=\"'.$wrapperclass.' cols-'.$columns . $ul.' last\"';\n        $class_last_table = ' class=\"'.$wrapperclass.' cols-'.$columns.' last\"';\n    }\n    else\n    {\n        $class = ' class=\"'.$wrapperclass.'\"';\n        $class_last_ul = ' class=\"'.$wrapperclass.'\"';\n        $class_last_table = ' class=\"'.$wrapperclass.'\"';\n    };\n\n    $wrapper = array(\n    'whole-start'  => \"\\n<ul$class_first>\\n\"\n    ,'whole-end'    => \"</ul>\\n\"\n    ,'col-devide'   => ''\n    ,'col-devide-last' => ''\n    ,'item-start'   => \"\\t<li class=\\\"{$itemclass}\\\">\\n\"\n    ,'item-start-other' => \"\\t<li class=\\\"{$itemclass} other other-item\\\">\\n\"\n    ,'item-start-noanswer' => \"\\t<li class=\\\"{$itemclass} noanswer-item\\\">\\n\"\n    ,'item-end' => \"\\t</li>\\n\"\n    ,'maxrows'  => ceil($answer_count/$columns) //Always rounds up to nearest whole number\n    ,'cols'     => $columns\n    );\n\n    switch($column_style)\n    {\n        case 'ul':  if($columns > 1)\n            {\n                $wrapper['col-devide']  = \"\\n</ul>\\n\\n<ul$class>\\n\";\n                $wrapper['col-devide-last'] = \"\\n</ul>\\n\\n<ul$class_last_ul>\\n\";\n            }\n            break;\n\n        case 'table':   $table_cols = '';\n            for($cols = $columns ; $cols > 0 ; --$cols)\n            {\n                switch($cols)\n                {\n                    case $columns:  $table_cols .= \"\\t<col$class_first />\\n\";\n                        break;\n                    case 1:     $table_cols .= \"\\t<col$class_last_table />\\n\";\n                        break;\n                    default:    $table_cols .= \"\\t<col$class />\\n\";\n                };\n            };\n\n            if($columns > 1)\n            {\n                $wrapper['col-devide']  = \"\\t</ul>\\n</td>\\n\\n<td>\\n\\t<ul>\\n\";\n                $wrapper['col-devide-last'] = \"\\t</ul>\\n</td>\\n\\n<td class=\\\"last\\\">\\n\\t<ul>\\n\";\n            };\n            $wrapper['whole-start'] = \"\\n<table$class>\\n$table_cols\\n\\t<tbody>\\n<tr>\\n<td>\\n\\t<ul>\\n\";\n            $wrapper['whole-end']   = \"\\t</ul>\\n</td>\\n</tr>\\n\\t</tbody>\\n</table>\\n\";\n            $wrapper['item-start']  = \"<li class=\\\"{$itemclass}\\\">\\n\";\n            $wrapper['item-end']    = \"</li class=\\\"{$itemclass}\\\">\\n\";\n    };\n\n    return $wrapper;\n};\n\nfunction alternation($alternate = '' , $type = 'col')\n{\n    /**\n    * alternation() Returns a class identifyer for alternating between\n    * two options. Used to style alternate elements differently. creates\n    * or alternates between the odd string and the even string used in\n    * as column and row classes for array type questions.\n    *\n    * @param string $alternate = '' (empty) (default) , 'array2' ,  'array1' , 'odd' , 'even'\n    * @param string  $type = 'col' (default) or 'row'\n    *\n    * @return string representing either the first alternation or the opposite alternation to the one supplied..\n    */\n    /*\n    // The following allows type to be left blank for row in subsequent\n    // function calls.\n    // It has been left out because 'row' must be defined the first time\n    // alternation() is called. Since it is only ever written once for each\n    // while statement within a function, 'row' is always defined.\n    if(!empty($alternate) && $type != 'row')\n    {   if($alternate == ('array2' || 'array1'))\n    {\n    $type = 'row';\n    };\n    };\n    // It has been left in case it becomes useful but probably should be\n    // removed.\n    */\n    if($type == 'row')\n    {\n        $odd  = 'array2'; // should be row_odd\n        $even = 'array1'; // should be row_even\n    }\n    else\n    {\n        $odd  = 'odd';  // should be col_odd\n        $even = 'even'; // should be col_even\n    };\n    if($alternate == $odd)\n    {\n        $alternate = $even;\n    }\n    else\n    {\n        $alternate = $odd;\n    };\n    return $alternate;\n}\n\n\n/**\n* longestString() returns the length of the longest string past to it.\n* @peram string $new_string\n* @peram integer $longest_length length of the (previously) longest string passed to it.\n* @return integer representing the length of the longest string passed (updated if $new_string was longer than $longest_length)\n*\n* usage should look like this: $longest_length = longestString( $new_string , $longest_length );\n*\n*/\nfunction longestString( $new_string , $longest_length )\n{\n    if($longest_length < strlen(trim(strip_tags($new_string))))\n    {\n        $longest_length = strlen(trim(strip_tags($new_string)));\n    };\n    return $longest_length;\n};\n\n\n\n/**\n* getNotificationList() returns different options for notifications\n*\n* @param string $notificationcode - the currently selected one\n*\n* @return This string is returned containing <option></option> formatted list of notification methods for current survey\n*/\nfunction getNotificationList($notificationcode)\n{\n    $clang = Yii::app()->lang;\n    $ntypes = array(\n    \"0\"=>$clang->gT(\"No email notification\"),\n    \"1\"=>$clang->gT(\"Basic email notification\"),\n    \"2\"=>$clang->gT(\"Detailed email notification with result codes\")\n    );\n    if (!isset($ntypeselector)) {$ntypeselector=\"\";}\n    foreach($ntypes as $ntcode=>$ntdescription)\n    {\n        $ntypeselector .= \"<option value='$ntcode'\";\n        if ($notificationcode == $ntcode) {$ntypeselector .= \" selected='selected'\";}\n        $ntypeselector .= \">$ntdescription</option>\\n\";\n    }\n    return $ntypeselector;\n}\n\n\n/**\n* getGroupList() queries the database for a list of all groups matching the current survey sid\n*\n*\n* @param string $gid - the currently selected gid/group\n*\n* @return This string is returned containing <option></option> formatted list of groups to current survey\n*/\nfunction getGroupList($gid,$surveyid)\n{\n    $clang = Yii::app()->lang;\n    $groupselecter=\"\";\n    $gid=sanitize_int($gid);\n    $surveyid=sanitize_int($surveyid);\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n    $gidquery = \"SELECT gid, group_name FROM {{groups}} WHERE sid='{$surveyid}' AND  language='{$s_lang}' ORDER BY group_order\";\n    $gidresult = Yii::app()->db->createCommand($gidquery)->query(); //Checked\n    foreach ($gidresult->readAll() as $gv)\n    {\n        $groupselecter .= \"<option\";\n        if ($gv['gid'] == $gid) {$groupselecter .= \" selected='selected'\"; $gvexist = 1;}\n        $groupselecter .= \" value='\".Yii::app()->getConfig('scriptname').\"?sid=$surveyid&amp;gid=\".$gv['gid'].\"'>\".htmlspecialchars($gv['group_name']).\"</option>\\n\";\n    }\n    if ($groupselecter)\n    {\n        if (!isset($gvexist)) {$groupselecter = \"<option selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$groupselecter;}\n        else {$groupselecter .= \"<option value='\".Yii::app()->getConfig('scriptname').\"?sid=$surveyid&amp;gid='>\".$clang->gT(\"None\").\"</option>\\n\";}\n    }\n    return $groupselecter;\n}\n\n\n\nfunction getGroupList3($gid,$surveyid)\n{\n    //$clang = Yii::app()->lang;\n    $gid=sanitize_int($gid);\n    $surveyid=sanitize_int($surveyid);\n\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n    $groupselecter = \"\";\n    $s_lang = Survey::model()->findByPk($surveyid)->language;\n\n\n    //$gidquery = \"SELECT gid, group_name FROM \".db_table_name('groups').\" WHERE sid=$surveyid AND language='{$s_lang}' ORDER BY group_order\";\n\n    $gidresult = QuestionGroup::model()->findAllByAttributes(array('sid' => $surveyid, 'language' => $s_lang), array('order'=>'group_order'));\n\n    foreach ($gidresult as $gv)\n    {\n        $gv = $gv->attributes;\n        $groupselecter .= \"<option\";\n        if ($gv['gid'] == $gid) {$groupselecter .= \" selected='selected'\"; }\n        $groupselecter .= \" value='\".$gv['gid'].\"'>\".htmlspecialchars($gv['group_name']).\"</option>\\n\";\n    }\n\n\n    return $groupselecter;\n}\n\n/**\n* put your comment there...\n*\n* @param mixed $gid\n* @param mixed $language\n*/\nfunction getGroupListLang($gid, $language, $surveyid)\n{\n\n    $clang = Yii::app()->lang;\n\n    $groupselecter=\"\";\n    if (!$surveyid) {$surveyid=returnGlobal('sid',true);}\n\n    $gidresult = QuestionGroup::model()->findAll(array('condition'=>'sid=:surveyid AND language=:language',\n    'order'=>'group_order',\n    'params'=>array(':surveyid'=>$surveyid,':language'=>$language)));   //Checked)\n    foreach ($gidresult as $gv)\n    {\n        $gv = $gv->attributes;\n        $groupselecter .= \"<option\";\n        if ($gv['gid'] == $gid) {$groupselecter .= \" selected='selected'\"; $gvexist = 1;}\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid.\"/gid/\".$gv['gid']);\n        $groupselecter .= \" value='{$link}'>\";\n        if (strip_tags($gv['group_name']))\n        {\n            $groupselecter .= htmlspecialchars(strip_tags($gv['group_name']));\n        } else {\n            $groupselecter .= htmlspecialchars($gv['group_name']);\n        }\n        $groupselecter .= \"</option>\\n\";\n    }\n    if ($groupselecter)\n    {\n        $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/\".$surveyid);\n        if (!isset($gvexist)) {$groupselecter = \"<option selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$groupselecter;}\n        else {$groupselecter .= \"<option value='{$link}'>\".$clang->gT(\"None\").\"</option>\\n\";}\n    }\n    return $groupselecter;\n}\n\n\nfunction getUserList($outputformat='fullinfoarray')\n{\n    $clang = Yii::app()->lang;\n\n    if (!empty(Yii::app()->session['loginID']))\n    {\n        $myuid=sanitize_int(Yii::app()->session['loginID']);\n    }\n    $usercontrolSameGroupPolicy = Yii::app()->getConfig('usercontrolSameGroupPolicy');\n    if (!Permission::model()->hasGlobalPermission('superadmin','read') && isset($usercontrolSameGroupPolicy) &&\n    $usercontrolSameGroupPolicy == true)\n    {\n        if (isset($myuid))\n        {\n            $sDatabaseType = Yii::app()->db->getDriverName();\n            if ($sDatabaseType=='mssql' || $sDatabaseType==\"sqlsrv\" || $sDatabaseType==\"dblib\")\n            {\n                $sSelectFields = 'users_name,uid,email,full_name,parent_id,CAST(password as varchar) as password';\n            }\n            else\n            {\n                $sSelectFields = 'users_name,uid,email,full_name,parent_id,password';\n            }\n\n            // List users from same group as me + all my childs\n            // a subselect is used here because MSSQL does not like to group by text\n            // also Postgres does like this one better\n            $uquery = \" SELECT {$sSelectFields} from {{users}} where uid in (\n                SELECT uid from {{user_in_groups}} where ugid in (\n                    SELECT ugid from {{user_in_groups}} where uid={$myuid}\n                    )\n                )\n            UNION\n            SELECT {$sSelectFields} from {{users}} v where v.parent_id={$myuid}\n            UNION\n            SELECT {$sSelectFields} from {{users}} v where uid={$myuid}\";\n\n        }\n        else\n        {\n            return array(); // Or die maybe\n        }\n\n    }\n    else\n    {\n        $uquery = \"SELECT * FROM {{users}} ORDER BY uid\";\n    }\n\n    $uresult = Yii::app()->db->createCommand($uquery)->query()->readAll(); //Checked\n\n    if (count($uresult)==0)\n    //user is not in a group and usercontrolSameGroupPolicy is activated - at least show his own userinfo\n    {\n        $uquery = \"SELECT u.* FROM {{users}} AS u WHERE u.uid=\".$myuid;\n        $uresult = Yii::app()->db->createCommand($uquery)->query()->readAll();//Checked\n    }\n\n    $userlist = array();\n    $userlist[0] = \"Reserved for logged in user\";\n    foreach ($uresult as $srow)\n    {\n        if ($outputformat != 'onlyuidarray')\n        {\n            if ($srow['uid'] != Yii::app()->session['loginID'])\n            {\n                $userlist[] = array(\"user\"=>$srow['users_name'], \"uid\"=>$srow['uid'], \"email\"=>$srow['email'], \"password\"=>$srow['password'], \"full_name\"=>$srow['full_name'], \"parent_id\"=>$srow['parent_id'] );\n            }\n            else\n            {\n                $userlist[0] = array(\"user\"=>$srow['users_name'], \"uid\"=>$srow['uid'], \"email\"=>$srow['email'], \"password\"=>$srow['password'], \"full_name\"=>$srow['full_name'], \"parent_id\"=>$srow['parent_id'] );\n            }\n        }\n        else\n        {\n            if ($srow['uid'] != Yii::app()->session['loginID'])\n            {\n                $userlist[] = $srow['uid'];\n            }\n            else\n            {\n                $userlist[0] = $srow['uid'];\n            }\n        }\n\n    }\n    return $userlist;\n}\n\n\n/**\n* Gets all survey infos in one big array including the language specific settings\n*\n* @param string $surveyid  The survey ID\n* @param string $languagecode The language code - if not given the base language of the particular survey is used\n* @return array Returns array with survey info or false, if survey does not exist\n*/\nfunction getSurveyInfo($surveyid, $languagecode='')\n{\n    static $staticSurveyInfo = array();// Use some static\n    $surveyid=sanitize_int($surveyid);\n    $languagecode=sanitize_languagecode($languagecode);\n    $thissurvey=false;\n    // Do job only if this survey exist\n    if(!Survey::model()->findByPk($surveyid))\n    {\n        return false;\n    }\n    // if no language code is set then get the base language one\n    if ((!isset($languagecode) || $languagecode==''))\n    {\n        $languagecode=Survey::model()->findByPk($surveyid)->language;\n    }\n\n    if(isset($staticSurveyInfo[$surveyid][$languagecode]) )\n    {\n        $thissurvey=$staticSurveyInfo[$surveyid][$languagecode];\n    }\n    else\n    {\n        $result = SurveyLanguageSetting::model()->with('survey')->findByPk(array('surveyls_survey_id' => $surveyid, 'surveyls_language' => $languagecode));\n        if (is_null($result)) {\n            // When additional language was added, but not saved it does not exists\n            // We should revert to the base language then\n            $languagecode=Survey::model()->findByPk($surveyid)->language;\n            $result = SurveyLanguageSetting::model()->with('survey')->findByPk(array('surveyls_survey_id' => $surveyid, 'surveyls_language' => $languagecode));\n        }\n        if($result)\n        {\n            $thissurvey=array_merge($result->survey->attributes,$result->attributes);\n            $thissurvey['name']=$thissurvey['surveyls_title'];\n            $thissurvey['description']=$thissurvey['surveyls_description'];\n            $thissurvey['welcome']=$thissurvey['surveyls_welcometext'];\n            $thissurvey['templatedir']=$thissurvey['template'];\n            $thissurvey['adminname']=$thissurvey['admin'];\n            $thissurvey['tablename']='{{survey_'.$thissurvey['sid'] . '}}';\n            $thissurvey['urldescrip']=$thissurvey['surveyls_urldescription'];\n            $thissurvey['url']=$thissurvey['surveyls_url'];\n            $thissurvey['expiry']=$thissurvey['expires'];\n            $thissurvey['email_invite_subj']=$thissurvey['surveyls_email_invite_subj'];\n            $thissurvey['email_invite']=$thissurvey['surveyls_email_invite'];\n            $thissurvey['email_remind_subj']=$thissurvey['surveyls_email_remind_subj'];\n            $thissurvey['email_remind']=$thissurvey['surveyls_email_remind'];\n            $thissurvey['email_confirm_subj']=$thissurvey['surveyls_email_confirm_subj'];\n            $thissurvey['email_confirm']=$thissurvey['surveyls_email_confirm'];\n            $thissurvey['email_register_subj']=$thissurvey['surveyls_email_register_subj'];\n            $thissurvey['email_register']=$thissurvey['surveyls_email_register'];\n            $thissurvey['attributedescriptions'] = $result->survey->tokenAttributes;\n            $thissurvey['attributecaptions'] = $result->attributeCaptions;\n            if (!isset($thissurvey['adminname'])) {$thissurvey['adminname']=Yii::app()->getConfig('siteadminemail');}\n            if (!isset($thissurvey['adminemail'])) {$thissurvey['adminemail']=Yii::app()->getConfig('siteadminname');}\n            if (!isset($thissurvey['urldescrip']) || $thissurvey['urldescrip'] == '' ) {$thissurvey['urldescrip']=$thissurvey['surveyls_url'];}\n\n            $staticSurveyInfo[$surveyid][$languagecode]=$thissurvey;\n        }\n\n    }\n\n    return $thissurvey;\n}\n\n/**\n* Returns the default email template texts as array\n*\n* @param mixed $oLanguage Required language translationb object\n* @param string $mode Escape mode for the translation function\n* @return array\n*/\nfunction templateDefaultTexts($oLanguage, $mode='html', $sNewlines='text'){\n    $aDefaultTexts=array(\n    'admin_detailed_notification_subject'=>$oLanguage->gT(\"Response submission for survey {SURVEYNAME} with results\",$mode),\n    'admin_detailed_notification'=>$oLanguage->gT(\"Hello,\\n\\nA new response was submitted for your survey '{SURVEYNAME}'.\\n\\nClick the following link to reload the survey:\\n{RELOADURL}\\n\\nClick the following link to see the individual response:\\n{VIEWRESPONSEURL}\\n\\nClick the following link to edit the individual response:\\n{EDITRESPONSEURL}\\n\\nView statistics by clicking here:\\n{STATISTICSURL}\\n\\n\\nThe following answers were given by the participant:\\n{ANSWERTABLE}\",$mode),\n    'admin_detailed_notification_css'=>'<style type=\"text/css\">\n    .printouttable {\n    margin:1em auto;\n    }\n    .printouttable th {\n    text-align: center;\n    }\n    .printouttable td {\n    border-color: #ddf #ddf #ddf #ddf;\n    border-style: solid;\n    border-width: 1px;\n    padding:0.1em 1em 0.1em 0.5em;\n    }\n\n    .printouttable td:first-child {\n    font-weight: 700;\n    text-align: right;\n    padding-right: 5px;\n    padding-left: 5px;\n\n    }\n    .printouttable .printanswersquestion td{\n    background-color:#F7F8FF;\n    }\n\n    .printouttable .printanswersquestionhead td{\n    text-align: left;\n    background-color:#ddf;\n    }\n\n    .printouttable .printanswersgroup td{\n    text-align: center;\n    font-weight:bold;\n    padding-top:1em;\n    }\n    </style>',\n    'admin_notification_subject'=>$oLanguage->gT(\"Response submission for survey {SURVEYNAME}\",$mode),\n    'admin_notification'=>$oLanguage->gT(\"Hello,\\n\\nA new response was submitted for your survey '{SURVEYNAME}'.\\n\\nClick the following link to reload the survey:\\n{RELOADURL}\\n\\nClick the following link to see the individual response:\\n{VIEWRESPONSEURL}\\n\\nClick the following link to edit the individual response:\\n{EDITRESPONSEURL}\\n\\nView statistics by clicking here:\\n{STATISTICSURL}\",$mode),\n    'confirmation_subject'=>$oLanguage->gT(\"Confirmation of your participation in our survey\"),\n    'confirmation'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nthis email is to confirm that you have completed the survey titled {SURVEYNAME} and your response has been saved. Thank you for participating.\\n\\nIf you have any further questions about this email, please contact {ADMINNAME} on {ADMINEMAIL}.\\n\\nSincerely,\\n\\n{ADMINNAME}\",$mode),\n    'invitation_subject'=>$oLanguage->gT(\"Invitation to participate in a survey\",$mode),\n    'invitation'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nyou have been invited to participate in a survey.\\n\\nThe survey is titled:\\n\\\"{SURVEYNAME}\\\"\\n\\n\\\"{SURVEYDESCRIPTION}\\\"\\n\\nTo participate, please click on the link below.\\n\\nSincerely,\\n\\n{ADMINNAME} ({ADMINEMAIL})\\n\\n----------------------------------------------\\nClick here to do the survey:\\n{SURVEYURL}\",$mode).\"\\n\\n\".$oLanguage->gT(\"If you do not want to participate in this survey and don't want to receive any more invitations please click the following link:\\n{OPTOUTURL}\",$mode).\"\\n\\n\".$oLanguage->gT(\"If you are blacklisted but want to participate in this survey and want to receive invitations please click the following link:\\n{OPTINURL}\",$mode),\n    'reminder_subject'=>$oLanguage->gT(\"Reminder to participate in a survey\",$mode),\n    'reminder'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nRecently we invited you to participate in a survey.\\n\\nWe note that you have not yet completed the survey, and wish to remind you that the survey is still available should you wish to take part.\\n\\nThe survey is titled:\\n\\\"{SURVEYNAME}\\\"\\n\\n\\\"{SURVEYDESCRIPTION}\\\"\\n\\nTo participate, please click on the link below.\\n\\nSincerely,\\n\\n{ADMINNAME} ({ADMINEMAIL})\\n\\n----------------------------------------------\\nClick here to do the survey:\\n{SURVEYURL}\",$mode).\"\\n\\n\".$oLanguage->gT(\"If you do not want to participate in this survey and don't want to receive any more invitations please click the following link:\\n{OPTOUTURL}\",$mode),\n    'registration_subject'=>$oLanguage->gT(\"Survey registration confirmation\",$mode),\n    'registration'=>$oLanguage->gT(\"Dear {FIRSTNAME},\\n\\nYou, or someone using your email address, have registered to participate in an online survey titled {SURVEYNAME}.\\n\\nTo complete this survey, click on the following URL:\\n\\n{SURVEYURL}\\n\\nIf you have any questions about this survey, or if you did not register to participate and believe this email is in error, please contact {ADMINNAME} at {ADMINEMAIL}.\",$mode)\n    );\n    if ($sNewlines=='html')\n    {\n        $aDefaultTexts=array_map('nl2br',$aDefaultTexts);\n    }\n    return $aDefaultTexts;\n}\n\n/**\n* Compares two elements from an array (passed by the usort function)\n* and returns -1, 0 or 1 depending on the result of the comparison of\n* the sort order of the group_order and question_order field\n*\n* @param mixed $a\n* @param mixed $b\n* @return int\n*/\nfunction groupOrderThenQuestionOrder($a, $b)\n{\n    if (isset($a['group_order']) && isset($b['group_order']))\n    {\n        $GroupResult = strnatcasecmp($a['group_order'], $b['group_order']);\n    }\n    else\n    {\n        $GroupResult = \"\";\n    }\n    if ($GroupResult == 0)\n    {\n        $TitleResult = strnatcasecmp($a[\"question_order\"], $b[\"question_order\"]);\n        return $TitleResult;\n    }\n    return $GroupResult;\n}\n\n\nfunction fixSortOrderAnswers($qid,$surveyid=null) //Function rewrites the sortorder for a group of answers\n{\n    $qid=sanitize_int($qid);\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n\n    Answer::model()->updateSortOrder($qid,$baselang);\n}\n\n/**\n* This function rewrites the sortorder for questions inside the named group\n* REMOVED the 2012-08-08 : replaced by Question::model()->updateQuestionOrder\n* @param integer $groupid the group id\n* @param integer $surveyid the survey id\n*/\n/**\nfunction fixSortOrderQuestions($groupid, $surveyid) //Function rewrites the sortorder for questions\n{\n    $gid = sanitize_int($groupid);\n    $surveyid = sanitize_int($surveyid);\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n\n    $questions = Question::model()->findAllByAttributes(array('gid' => $gid, 'sid' => $surveyid, 'language' => $baselang));\n    $p = 0;\n    foreach ($questions as $question)\n    {\n        $question->question_order = $p;\n        $question->save();\n        $p++;\n    }\n}\n*/\n\nfunction shiftOrderQuestions($sid,$gid,$shiftvalue) //Function shifts the sortorder for questions\n{\n    $sid=sanitize_int($sid);\n    $gid=sanitize_int($gid);\n    $shiftvalue=sanitize_int($shiftvalue);\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n\n    Question::model()->updateQuestionOrder($gid,$baselang,$shiftvalue);\n}\n\nfunction fixSortOrderGroups($surveyid) //Function rewrites the sortorder for groups\n{\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    QuestionGroup::model()->updateGroupOrder($surveyid,$baselang);\n}\n\nfunction fixMovedQuestionConditions($qid,$oldgid,$newgid) //Function rewrites the cfieldname for a question after group change\n{\n    $surveyid = Yii::app()->getConfig('sid');\n    $qid=sanitize_int($qid);\n    $oldgid=sanitize_int($oldgid);\n    $newgid=sanitize_int($newgid);\n    Condition::model()->updateCFieldName($surveyid,$qid,$oldgid,$newgid);\n    // TMSW Condition->Relevance:  Call LEM->ConvertConditionsToRelevance() when done\n}\n\n\n/**\n* This function returns POST/REQUEST vars, for some vars like SID and others they are also sanitized\n*\n* @param string $stringname\n* @param boolean $bRestrictToString\n*/\nfunction returnGlobal($stringname,$bRestrictToString=false)\n{\n    $urlParam=Yii::app()->request->getParam($stringname); \n    if(is_null($urlParam) && $aCookies=Yii::app()->request->getCookies() && $stringname!='sid')\n    {\n        if(isset($aCookies[$stringname]))\n        {\n            $urlParam = $aCookies[$stringname];\n        } \n    }\n    $bUrlParamIsArray=is_array($urlParam);// Needed to array map or if $bRestrictToString\n    if (!is_null($urlParam) && $stringname!='' && (!$bUrlParamIsArray || !$bRestrictToString))\n    {\n        if ($stringname == 'sid' || $stringname == \"gid\" || $stringname == \"oldqid\" ||\n        $stringname == \"qid\" || $stringname == \"tid\" ||\n        $stringname == \"lid\" || $stringname == \"ugid\"||\n        $stringname == \"thisstep\" || $stringname == \"scenario\" ||\n        $stringname == \"cqid\" || $stringname == \"cid\" ||\n        $stringname == \"qaid\" || $stringname == \"scid\" ||\n        $stringname == \"loadsecurity\")\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_int\",$urlParam);\n            }else{\n                return sanitize_int($urlParam);\n            }\n        }\n        elseif ($stringname ==\"lang\" || $stringname ==\"adminlang\")\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_languagecode\",$urlParam);\n            }else{\n                return sanitize_languagecode($urlParam);\n            }\n        }\n        elseif ($stringname ==\"htmleditormode\" ||\n        $stringname ==\"subaction\" ||\n        $stringname ==\"questionselectormode\" ||\n        $stringname ==\"templateeditormode\"\n        )\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_paranoid_string\",$urlParam);\n            }else{\n                return sanitize_paranoid_string($urlParam);\n            }\n        }\n        elseif ( $stringname ==\"cquestions\")\n        {\n            if($bUrlParamIsArray){\n                return array_map(\"sanitize_cquestions\",$urlParam);\n            }else{\n                return sanitize_cquestions($urlParam);\n            }\n        }\n        return $urlParam;\n    }\n    else\n    {\n        return NULL;\n    }\n}\n\n\nfunction sendCacheHeaders()\n{\n    global $embedded;\n    if ( $embedded ) return;\n    if (!headers_sent())\n    {\n        header('P3P:CP=\"IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT\"');  // this line lets IE7 run LimeSurvey in an iframe\n        header(\"Expires: Mon, 26 Jul 1997 05:00:00 GMT\");    // Date in the past\n        header(\"Last-Modified: \" . gmdate(\"D, d M Y H:i:s\") . \" GMT\");  // always modified\n        header(\"Cache-Control: no-store, no-cache, must-revalidate\");  // HTTP/1.1\n        header(\"Cache-Control: post-check=0, pre-check=0\", false);\n        header(\"Pragma: no-cache\");\n        header('Content-Type: text/html; charset=utf-8');\n    }\n}\n\n/**\n* @param type $iSurveyID The Survey ID\n* @param type $sFieldCode Field code of the particular field\n* @param type $sValue The stored response value\n* @param object $oLanguage Initialized limesurvey_lang object for the resulting response data\n* @return string\n*/\nfunction getExtendedAnswer($iSurveyID, $sFieldCode, $sValue, $oLanguage)\n{\n    if ($sValue==null || $sValue=='') return '';\n    $sLanguage = $oLanguage->langcode;\n    //Fieldcode used to determine question, $sValue used to match against answer code\n    //Returns NULL if question type does not suit\n    if (strpos($sFieldCode, \"{$iSurveyID}X\")===0) //Only check if it looks like a real fieldcode\n    {\n        $fieldmap = createFieldMap($iSurveyID,'short',false,false,$sLanguage);\n        if (isset($fieldmap[$sFieldCode]))\n            $fields = $fieldmap[$sFieldCode];\n        else\n            return false;\n\n        // If it is a comment field there is nothing to convert here\n        if ($fields['aid']=='comment') return $sValue; \n            \n        //Find out the question type\n        $this_type = $fields['type'];\n        switch($this_type)\n        {\n            case 'D':\n                if (trim($sValue)!='')\n                {\n                    $qidattributes = getQuestionAttributeValues($fields['qid']);\n                    $dateformatdetails = getDateFormatDataForQID($qidattributes, $iSurveyID);\n                    $sValue=convertDateTimeFormat($sValue,\"Y-m-d H:i:s\",$dateformatdetails['phpdate']);\n                }\n                break;\n            case 'N':\n                if (trim($sValue)!='')\n                {\n                    if(strpos($sValue,\".\")!==false)\n                    {\n                        $sValue=rtrim(rtrim($sValue,\"0\"),\".\");\n                    }\n                    $qidattributes = getQuestionAttributeValues($fields['qid']);\n                    if($qidattributes['num_value_int_only'])\n                    {\n                        $sValue=number_format($sValue, 0, '', '');\n                    }\n                }\n                break;\n            case \"L\":\n            case \"!\":\n            case \"O\":\n            case \"^\":\n            case \"I\":\n            case \"R\":\n                $result = Answer::model()->getAnswerFromCode($fields['qid'],$sValue,$sLanguage);\n                foreach($result as $row)\n                {\n                    $this_answer=$row['answer'];\n                } // while\n                if ($sValue == \"-oth-\")\n                {\n                    $this_answer=$oLanguage->gT(\"Other\");\n                }\n                break;\n            case \"M\":\n            case \"J\":\n            case \"P\":\n            switch($sValue)\n            {\n                case \"Y\": $this_answer=$oLanguage->gT(\"Yes\"); break;\n            }\n            break;\n            case \"Y\":\n            switch($sValue)\n            {\n                case \"Y\": $this_answer=$oLanguage->gT(\"Yes\"); break;\n                case \"N\": $this_answer=$oLanguage->gT(\"No\"); break;\n                default: $this_answer=$oLanguage->gT(\"No answer\");\n            }\n            break;\n            case \"G\":\n            switch($sValue)\n            {\n                case \"M\": $this_answer=$oLanguage->gT(\"Male\"); break;\n                case \"F\": $this_answer=$oLanguage->gT(\"Female\"); break;\n                default: $this_answer=$oLanguage->gT(\"No answer\");\n            }\n            break;\n            case \"C\":\n            switch($sValue)\n            {\n                case \"Y\": $this_answer=$oLanguage->gT(\"Yes\"); break;\n                case \"N\": $this_answer=$oLanguage->gT(\"No\"); break;\n                case \"U\": $this_answer=$oLanguage->gT(\"Uncertain\"); break;\n            }\n            break;\n            case \"E\":\n            switch($sValue)\n            {\n                case \"I\": $this_answer=$oLanguage->gT(\"Increase\"); break;\n                case \"D\": $this_answer=$oLanguage->gT(\"Decrease\"); break;\n                case \"S\": $this_answer=$oLanguage->gT(\"Same\"); break;\n            }\n            break;\n            case \"F\":\n            case \"H\":\n            case \"1\":\n                $aConditions=array('qid' => $fields['qid'], 'code' => $sValue, 'language' => $sLanguage);\n                if (isset($fields['scale_id']))\n                {\n                    $iScaleID=$fields['scale_id'];\n                }\n                else\n                {\n                    $iScaleID=0;\n                }\n                $result = Answer::model()->getAnswerFromCode($fields['qid'],$sValue,$sLanguage,$iScaleID);\n                foreach($result as $row)\n                {\n                    $this_answer=$row['answer'];\n                } // while\n                if ($sValue == \"-oth-\")\n                {\n                    $this_answer=$oLanguage->gT(\"Other\");\n                }\n                break;\n            case \"|\": //File upload\n                if (substr($sFieldCode, -9) != 'filecount') {\n                    //Show the filename, size, title and comment -- no link!\n                    $files = json_decode($sValue);\n                    $sValue = '';\n                    if (is_array($files)) {\n                        foreach ($files as $file) {\n                            $sValue .= $file->name .\n                            ' (' . $file->size . 'KB) ' .\n                            strip_tags($file->title) .\n                            ' - ' . strip_tags($file->comment) . \"<br/>\";\n                        }\n                    }\n                }\n                break;\n            default:\n                ;\n        } // switch\n    }\n    switch($sFieldCode)\n    {\n        case 'submitdate':\n        case 'startdate':\n        case 'datestamp':\n            if (trim($sValue)!='')\n            {\n                $dateformatdetails = getDateFormatDataForQID(null, $iSurveyID);\n                $sValue=convertDateTimeFormat($sValue,\"Y-m-d H:i:s\",$dateformatdetails['phpdate'].' H:i:s');\n            }\n            break;\n    }\n    if (isset($this_answer))\n    {\n        return $this_answer.\" [$sValue]\";\n    }\n    else\n    {\n        return $sValue;\n    }\n}\n\n/**\n* Validate an email address - also supports IDN email addresses \n* @returns True/false for valid/invalid\n* \n* @param mixed $sEmailAddress  Email address to check\n*/\nfunction validateEmailAddress($sEmailAddress){\n    require_once(APPPATH.'third_party/idna-convert/idna_convert.class.php');\n    $oIdnConverter = new idna_convert();\n    $sEmailAddress=$oIdnConverter->encode($sEmailAddress);\n    $bResult=filter_var($sEmailAddress, FILTER_VALIDATE_EMAIL);   \n    if ($bResult!==false)\n    {\n        return true;\n    }\n    return false;\n}\n\nfunction validateTemplateDir($sTemplateName)\n{\n    $usertemplaterootdir = Yii::app()->getConfig('usertemplaterootdir');\n    $standardtemplaterootdir = Yii::app()->getConfig('standardtemplaterootdir');\n    $sDefaultTemplate = Yii::app()->getConfig('defaulttemplate');\n    if (is_dir(\"$usertemplaterootdir/{$sTemplateName}/\"))\n    {\n        return $sTemplateName;\n    }\n    elseif (is_dir(\"$standardtemplaterootdir/{$sTemplateName}/\"))\n    {\n        return $sTemplateName;\n    }\n    elseif (is_dir(\"$standardtemplaterootdir/{$sDefaultTemplate}/\"))\n    {\n        return $sDefaultTemplate;\n    }\n    elseif (is_dir(\"$usertemplaterootdir/{$sDefaultTemplate}/\"))\n    {\n        return $sDefaultTemplate;\n    }\n    else\n    {\n        return 'default';\n    }\n}\n\n\n\n/**\n *This functions generates a a summary containing the SGQA for questions of a survey, enriched with options per question\n * It can be used for the generation of statistics. Derived from Statistics_userController\n * @param int $iSurveyID Id of the Survey in question\n * @param array $aFilters an array which is the result of a query in Questions model\n * @param string $sLanguage\n * @return array The summary\n */\n  function createCompleteSGQA($iSurveyID,$aFilters,$sLanguage) {\n\n foreach ($aFilters as $flt)\n {\n    Yii::app()->loadHelper(\"surveytranslator\");\n    $myfield = \"{$iSurveyID}X{$flt['gid']}X{$flt['qid']}\";\n    $oSurvey = Survey::model()->findByPk($iSurveyID);\n    $aAdditionalLanguages = array_filter(explode(\" \", $oSurvey->additional_languages));\n    if (is_null($sLanguage)|| !in_array($sLanguage,$aAdditionalLanguages))\n        $sLanguage = $oSurvey->language;\n\n    switch ($flt['type'])\n            {\n                case \"K\": // Multiple Numerical\n                case \"Q\": // Multiple Short Text\n                    //get answers\n                    $result = Question::model()->getQuestionsForStatistics('title as code, question as answer', \"parent_qid=$flt[qid] AND language = '{$sLanguage}'\", 'question_order');\n\n                    //go through all the (multiple) answers\n                    foreach($result as $row)\n                    {\n                        $myfield2=$flt['type'].$myfield.reset($row);\n                        $allfields[] = $myfield2;\n                    }\n                    break;\n                case \"A\": // ARRAY OF 5 POINT CHOICE QUESTIONS\n                case \"B\": // ARRAY OF 10 POINT CHOICE QUESTIONS\n                case \"C\": // ARRAY OF YES\\No\\$clang->gT(\"Uncertain\") QUESTIONS\n                case \"E\": // ARRAY OF Increase/Same/Decrease QUESTIONS\n                case \"F\": // FlEXIBLE ARRAY\n                case \"H\": // ARRAY (By Column)\n                    //get answers\n                    $result = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}'\", 'question_order');\n\n                    //go through all the (multiple) answers\n                    foreach($result as $row)\n                    {\n                        $myfield2 = $myfield.reset($row);\n                        $allfields[]=$myfield2;\n                    }\n                    break;\n                // all \"free text\" types (T, U, S)  get the same prefix (\"T\")\n                case \"T\": // Long free text\n                case \"U\": // Huge free text\n                case \"S\": // Short free text\n                    $myfield=\"T$myfield\";\n                    $allfields[] = $myfield;\n                    break;\n                case \";\":  //ARRAY (Multi Flex) (Text)\n                case \":\":  //ARRAY (Multi Flex) (Numbers)\n                    $result = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}' AND scale_id = 0\", 'question_order');\n                   \n                    foreach($result as $row)\n                    {\n                        $fresult = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}' AND scale_id = 1\", 'question_order');\n                        foreach($fresult as $frow)\n                        {\n                            $myfield2 = $myfield . reset($row) . \"_\" . $frow['title'];\n                        $allfields[]=$myfield2;\n                    }\n                    }\n                    break;\n                case \"R\": //RANKING\n                    //get some answers\n                    $result = Answer::model()->getQuestionsForStatistics('code, answer', \"qid=$flt[qid] AND language = '{$sLanguage}'\", 'sortorder, answer');\n                    //get number of answers\n                    //loop through all answers. if there are 3 items to rate there will be 3 statistics\n                    $i=0;\n                    foreach($result as $row)\n                    {\n                        $i++;\n                        $myfield2 = \"R\" . $myfield . $i . \"-\" . strlen($i);\n                        $allfields[]=$myfield2;\n                    }\n\n                    break;\n                //Boilerplate questions are only used to put some text between other questions -> no analysis needed\n                case \"X\":  //This is a boilerplate question and it has no business in this script\n                    break;\n                case \"1\": // MULTI SCALE\n                    //get answers\n                    $result = Question::model()->getQuestionsForStatistics('title, question', \"parent_qid=$flt[qid] AND language = '{$sLanguage}'\", 'question_order');\n                    //loop through answers\n                    foreach($result as $row)\n                    {\n                        //----------------- LABEL 1 ---------------------\n                        $myfield2 = $myfield . reset($row).\"#0\";\n                        $allfields[]=$myfield2;\n                        //----------------- LABEL 2 ---------------------\n                        $myfield2 = $myfield . reset($row).\"#1\";\n                        $allfields[]=$myfield2;\n                    }   //end WHILE -> loop through all answers\n                    break;\n\n                case \"P\":  //P - Multiple choice with comments\n                case \"M\":  //M - Multiple choice\n                case \"N\":  //N - Numerical input\n                case \"D\":  //D - Date\n                    $myfield2 = $flt['type'].$myfield;\n                            $allfields[]=$myfield2;\n                    break;\n                default:   //Default settings\n                    $allfields[] = $myfield;\n                    break;\n\n        } //end switch\n }\n\nreturn $allfields;\n\n}\n\n\n\n\n\n/**\n* This function generates an array containing the fieldcode, and matching data in the same order as the activate script\n*\n* @param string $surveyid The Survey ID\n* @param mixed $style 'short' (default) or 'full' - full creates extra information like default values\n* @param mixed $force_refresh - Forces to really refresh the array, not just take the session copy\n* @param int $questionid Limit to a certain qid only (for question preview) - default is false\n* @param string $sQuestionLanguage The language to use\n* @return array\n*/\nfunction createFieldMap($surveyid, $style='short', $force_refresh=false, $questionid=false, $sLanguage) {\n    global $aDuplicateQIDs;\n\n    $sLanguage = sanitize_languagecode($sLanguage);\n    $surveyid = sanitize_int($surveyid);\n\n    //checks to see if fieldmap has already been built for this page.\n    if (isset(Yii::app()->session['fieldmap-' . $surveyid . $sLanguage]) && !$force_refresh && $questionid == false) {\n        return Yii::app()->session['fieldmap-' . $surveyid . $sLanguage];\n    }\n\n    $clang = new Limesurvey_lang($sLanguage);\n    $fieldmap[\"id\"]=array(\"fieldname\"=>\"id\", 'sid'=>$surveyid, 'type'=>\"id\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"id\"]['title']=\"\";\n        $fieldmap[\"id\"]['question']=$clang->gT(\"Response ID\");\n        $fieldmap[\"id\"]['group_name']=\"\";\n    }\n\n    $fieldmap[\"submitdate\"]=array(\"fieldname\"=>\"submitdate\", 'type'=>\"submitdate\", 'sid'=>$surveyid, \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"submitdate\"]['title']=\"\";\n        $fieldmap[\"submitdate\"]['question']=$clang->gT(\"Date submitted\");\n        $fieldmap[\"submitdate\"]['group_name']=\"\";\n    }\n\n    $fieldmap[\"lastpage\"]=array(\"fieldname\"=>\"lastpage\", 'sid'=>$surveyid, 'type'=>\"lastpage\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"lastpage\"]['title']=\"\";\n        $fieldmap[\"lastpage\"]['question']=$clang->gT(\"Last page\");\n        $fieldmap[\"lastpage\"]['group_name']=\"\";\n    }\n\n    $fieldmap[\"startlanguage\"]=array(\"fieldname\"=>\"startlanguage\", 'sid'=>$surveyid, 'type'=>\"startlanguage\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n    if ($style == \"full\")\n    {\n        $fieldmap[\"startlanguage\"]['title']=\"\";\n        $fieldmap[\"startlanguage\"]['question']=$clang->gT(\"Start language\");\n        $fieldmap[\"startlanguage\"]['group_name']=\"\";\n    }\n\n    // Select which question IDs have default values\n    $_aDefaultValues = DefaultValue::model()->with(array('question' => array('condition' => 'question.sid=' . $surveyid)))->findAll();\n    $aDefaultValues = array();\n    foreach ($_aDefaultValues as $k => $v)\n        $aDefaultValues[] = $v->qid;\n\n    //Check for any additional fields for this survey and create necessary fields (token and datestamp and ipaddr)\n    $prow = Survey::model()->findByPk($surveyid)->getAttributes(); //Checked\n\n    if ($prow['anonymized'] == \"N\" && Survey::model()->hasTokens($surveyid)) {\n        $fieldmap[\"token\"]=array(\"fieldname\"=>\"token\", 'sid'=>$surveyid, 'type'=>\"token\", \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"token\"]['title']=\"\";\n            $fieldmap[\"token\"]['question']=$clang->gT(\"Token\");\n            $fieldmap[\"token\"]['group_name']=\"\";\n        }\n    }\n    if ($prow['datestamp'] == \"Y\")\n    {\n        $fieldmap[\"startdate\"]=array(\"fieldname\"=>\"startdate\",\n        'type'=>\"startdate\",\n        'sid'=>$surveyid,\n        \"gid\"=>\"\",\n        \"qid\"=>\"\",\n        \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"startdate\"]['title']=\"\";\n            $fieldmap[\"startdate\"]['question']=$clang->gT(\"Date started\");\n            $fieldmap[\"startdate\"]['group_name']=\"\";\n        }\n\n        $fieldmap[\"datestamp\"]=array(\"fieldname\"=>\"datestamp\",\n        'type'=>\"datestamp\",\n        'sid'=>$surveyid,\n        \"gid\"=>\"\",\n        \"qid\"=>\"\",\n        \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"datestamp\"]['title']=\"\";\n            $fieldmap[\"datestamp\"]['question']=$clang->gT(\"Date last action\");\n            $fieldmap[\"datestamp\"]['group_name']=\"\";\n        }\n\n    }\n    if ($prow['ipaddr'] == \"Y\")\n    {\n        $fieldmap[\"ipaddr\"]=array(\"fieldname\"=>\"ipaddr\",\n        'type'=>\"ipaddress\",\n        'sid'=>$surveyid,\n        \"gid\"=>\"\",\n        \"qid\"=>\"\",\n        \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"ipaddr\"]['title']=\"\";\n            $fieldmap[\"ipaddr\"]['question']=$clang->gT(\"IP address\");\n            $fieldmap[\"ipaddr\"]['group_name']=\"\";\n        }\n    }\n    // Add 'refurl' to fieldmap.\n    if ($prow['refurl'] == \"Y\")\n    {\n        $fieldmap[\"refurl\"]=array(\"fieldname\"=>\"refurl\", 'type'=>\"url\", 'sid'=>$surveyid, \"gid\"=>\"\", \"qid\"=>\"\", \"aid\"=>\"\");\n        if ($style == \"full\")\n        {\n            $fieldmap[\"refurl\"]['title']=\"\";\n            $fieldmap[\"refurl\"]['question']=$clang->gT(\"Referrer URL\");\n            $fieldmap[\"refurl\"]['group_name']=\"\";\n        }\n    }\n\n    // Collect all default values once so don't need separate query for each question with defaults\n    // First collect language specific defaults\n    $defaultsQuery = \"SELECT a.qid, a.sqid, a.scale_id, a.specialtype, a.defaultvalue\"\n    . \" FROM {{defaultvalues}} as a, {{questions}} as b\"\n    . \" WHERE a.qid = b.qid\"\n    . \" AND a.language = b.language\"\n    . \" AND a.language = '{$sLanguage}'\"\n    . \" AND b.same_default=0\"\n    . \" AND b.sid = \".$surveyid;\n    $defaultResults = Yii::app()->db->createCommand($defaultsQuery)->queryAll();\n\n    $defaultValues = array();   // indexed by question then subquestion\n    foreach($defaultResults as $dv)\n    {\n        if ($dv['specialtype'] != '') {\n            $sq = $dv['specialtype'];\n        }\n        else {\n            $sq = $dv['sqid'];\n        }\n        $defaultValues[$dv['qid'].'~'.$sq] = $dv['defaultvalue'];\n    }\n\n    // Now overwrite language-specific defaults (if any) base language values for each question that uses same_defaults=1\n    $baseLanguage = getBaseLanguageFromSurveyID($surveyid);\n    $defaultsQuery = \"SELECT a.qid, a.sqid, a.scale_id, a.specialtype, a.defaultvalue\"\n    . \" FROM {{defaultvalues}} as a, {{questions}} as b\"\n    . \" WHERE a.qid = b.qid\"\n    . \" AND a.language = b.language\"\n    . \" AND a.language = '{$baseLanguage}'\"\n    . \" AND b.same_default=1\"\n    . \" AND b.sid = \".$surveyid;\n    $defaultResults = Yii::app()->db->createCommand($defaultsQuery)->queryAll();\n\n    foreach($defaultResults as $dv)\n    {\n        if ($dv['specialtype'] != '') {\n            $sq = $dv['specialtype'];\n        }\n        else {\n            $sq = $dv['sqid'];\n        }\n        $defaultValues[$dv['qid'].'~'.$sq] = $dv['defaultvalue'];\n    }\n    $qtypes=getQuestionTypeList('','array');\n\n    $aquery = \"SELECT * \"\n    .\" FROM {{questions}} as questions, {{groups}} as groups\"\n    .\" WHERE questions.gid=groups.gid AND \"\n    .\" questions.sid=$surveyid AND \"\n    .\" questions.language='{$sLanguage}' AND \"\n    .\" questions.parent_qid=0 AND \"\n    .\" groups.language='{$sLanguage}' \";\n    if ($questionid!==false)\n    {\n        $aquery.=\" and questions.qid={$questionid} \";\n    }\n    $aquery.=\" ORDER BY group_order, question_order\";\n    $aresult = Yii::app()->db->createCommand($aquery)->queryAll();\n    $questionSeq=-1; // this is incremental question sequence across all groups\n    $groupSeq=-1;\n    $_groupOrder=-1;\n\n    foreach ($aresult as $arow) //With each question, create the appropriate field(s))\n    {\n        ++$questionSeq;\n\n        // fix fact taht group_order may have gaps\n        if ($_groupOrder != $arow['group_order']) {\n            $_groupOrder = $arow['group_order'];\n            ++$groupSeq;\n        }\n        // Condition indicators are obsolete with EM.  However, they are so tightly coupled into LS code that easider to just set values to 'N' for now and refactor later.\n        $conditions = 'N';\n        $usedinconditions = 'N';\n\n        // Field identifier\n        // GXQXSXA\n        // G=Group  Q=Question S=Subquestion A=Answer Option\n        // If S or A don't exist then set it to 0\n        // Implicit (subqestion intermal to a question type ) or explicit qubquestions/answer count starts at 1\n\n        // Types \"L\", \"!\", \"O\", \"D\", \"G\", \"N\", \"X\", \"Y\", \"5\", \"S\", \"T\", \"U\"\n        $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}\";\n\n        if ($qtypes[$arow['type']]['subquestions']==0  && $arow['type'] != \"R\" && $arow['type'] != \"|\")\n        {\n            if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n            $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>\"{$arow['type']}\", 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>\"\");\n            if ($style == \"full\")\n            {\n                $fieldmap[$fieldname]['title']=$arow['title'];\n                $fieldmap[$fieldname]['question']=$arow['question'];\n                $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                $fieldmap[$fieldname]['hasconditions']=$conditions;\n                $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                if (isset($defaultValues[$arow['qid'].'~0'])) {\n                    $fieldmap[$fieldname]['defaultvalue'] = $defaultValues[$arow['qid'].'~0'];\n                }\n            }\n            switch($arow['type'])\n            {\n                case \"L\":  //RADIO LIST\n                case \"!\":  //DROPDOWN LIST\n                    if ($arow['other'] == \"Y\")\n                    {\n                        $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}other\";\n                        if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n\n                        $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                        'type'=>$arow['type'],\n                        'sid'=>$surveyid,\n                        \"gid\"=>$arow['gid'],\n                        \"qid\"=>$arow['qid'],\n                        \"aid\"=>\"other\");\n                        // dgk bug fix line above. aid should be set to \"other\" for export to append to the field name in the header line.\n                        if ($style == \"full\")\n                        {\n                            $fieldmap[$fieldname]['title']=$arow['title'];\n                            $fieldmap[$fieldname]['question']=$arow['question'];\n                            $fieldmap[$fieldname]['subquestion']=$clang->gT(\"Other\");\n                            $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                            $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                            $fieldmap[$fieldname]['hasconditions']=$conditions;\n                            $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                            $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                            $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                            if (isset($defaultValues[$arow['qid'].'~other'])) {\n                                $fieldmap[$fieldname]['defaultvalue'] = $defaultValues[$arow['qid'].'~other'];\n                            }\n                        }\n                    }\n                    break;\n                case \"O\": //DROPDOWN LIST WITH COMMENT\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}comment\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                    'type'=>$arow['type'],\n                    'sid'=>$surveyid,\n                    \"gid\"=>$arow['gid'],\n                    \"qid\"=>$arow['qid'],\n                    \"aid\"=>\"comment\");\n                    // dgk bug fix line below. aid should be set to \"comment\" for export to append to the field name in the header line. Also needed set the type element correctly.\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion']=$clang->gT(\"Comment\");\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    }\n                    break;\n            }\n        }\n        // For Multi flexi question types\n        elseif ($qtypes[$arow['type']]['subquestions']==2 && $qtypes[$arow['type']]['answerscales']==0)\n        {\n            //MULTI FLEXI\n            $abrows = getSubQuestions($surveyid,$arow['qid'],$sLanguage);\n            //Now first process scale=1\n            $answerset=array();\n            $answerList = array();\n            foreach ($abrows as $key=>$abrow)\n            {\n                if($abrow['scale_id']==1) {\n                    $answerset[]=$abrow;\n                    $answerList[] = array(\n                    'code'=>$abrow['title'],\n                    'answer'=>$abrow['question'],\n                    );\n                    unset($abrows[$key]);\n                }\n            }\n            reset($abrows);\n            foreach ($abrows as $abrow)\n            {\n                foreach($answerset as $answer)\n                {\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}_{$answer['title']}\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                    'type'=>$arow['type'],\n                    'sid'=>$surveyid,\n                    \"gid\"=>$arow['gid'],\n                    \"qid\"=>$arow['qid'],\n                    \"aid\"=>$abrow['title'].\"_\".$answer['title'],\n                    \"sqid\"=>$abrow['qid']);\n                    if ($abrow['other']==\"Y\") {$alsoother=\"Y\";}\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion1']=$abrow['question'];\n                        $fieldmap[$fieldname]['subquestion2']=$answer['question'];\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                        $fieldmap[$fieldname]['preg']=$arow['preg'];\n                        $fieldmap[$fieldname]['answerList']=$answerList;\n                    }\n                }\n            }\n            unset($answerset);\n        }\n        elseif ($arow['type'] == \"1\")\n        {\n            $abrows = getSubQuestions($surveyid,$arow['qid'],$sLanguage);\n            foreach ($abrows as $abrow)\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}#0\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$abrow['title'], \"scale_id\"=>0);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$abrow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['scale']=$clang->gT('Scale 1');\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}#1\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$abrow['title'], \"scale_id\"=>1);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$abrow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['scale']=$clang->gT('Scale 2');\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n            }\n        }\n\n        elseif ($arow['type'] == \"R\")\n        {\n            //MULTI ENTRY\n            $data = Answer::model()->findAllByAttributes(array('qid' => $arow['qid'], 'language' => $sLanguage));\n            $data = count($data);\n            $slots=$data;\n            for ($i=1; $i<=$slots; $i++)\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}$i\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$i);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=sprintf($clang->gT('Rank %s'),$i);\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n            }\n        }\n        elseif ($arow['type'] == \"|\")\n        {\n            $qidattributes= getQuestionAttributeValues($arow['qid']);\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}\";\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                'type'=>$arow['type'],\n                'sid'=>$surveyid,\n                \"gid\"=>$arow['gid'],\n                \"qid\"=>$arow['qid'],\n                \"aid\"=>''\n                );\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['max_files']=$qidattributes['max_num_of_files'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}\".\"_filecount\";\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                'type'=>$arow['type'],\n                'sid'=>$surveyid,\n                \"gid\"=>$arow['gid'],\n                \"qid\"=>$arow['qid'],\n                \"aid\"=>\"filecount\"\n                );\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=\"filecount - \".$arow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                }\n        }\n        else  // Question types with subquestions and one answer per subquestion  (M/A/B/C/E/F/H/P)\n        {\n            //MULTI ENTRY\n            $abrows = getSubQuestions($surveyid,$arow['qid'],$sLanguage);\n            foreach ($abrows as $abrow)\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname,\n                'type'=>$arow['type'],\n                'sid'=>$surveyid,\n                'gid'=>$arow['gid'],\n                'qid'=>$arow['qid'],\n                'aid'=>$abrow['title'],\n                'sqid'=>$abrow['qid']);\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$abrow['question'];\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    $fieldmap[$fieldname]['preg']=$arow['preg'];\n                    if (isset($defaultValues[$arow['qid'].'~'.$abrow['qid']])) {\n                        $fieldmap[$fieldname]['defaultvalue'] = $defaultValues[$arow['qid'].'~'.$abrow['qid']];\n                    }\n                }\n                if ($arow['type'] == \"P\")\n                {\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}{$abrow['title']}comment\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>$abrow['title'].\"comment\");\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion']=$clang->gT('Comment');\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    }\n                }\n            }\n            if ($arow['other']==\"Y\" && ($arow['type']==\"M\" || $arow['type']==\"P\"))\n            {\n                $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}other\";\n                if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>\"other\");\n                if ($style == \"full\")\n                {\n                    $fieldmap[$fieldname]['title']=$arow['title'];\n                    $fieldmap[$fieldname]['question']=$arow['question'];\n                    $fieldmap[$fieldname]['subquestion']=$clang->gT('Other');\n                    $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                    $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                    $fieldmap[$fieldname]['hasconditions']=$conditions;\n                    $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                    $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                    $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                    $fieldmap[$fieldname]['other']=$arow['other'];\n                }\n                if ($arow['type']==\"P\")\n                {\n                    $fieldname=\"{$arow['sid']}X{$arow['gid']}X{$arow['qid']}othercomment\";\n                    if (isset($fieldmap[$fieldname])) $aDuplicateQIDs[$arow['qid']]=array('fieldname'=>$fieldname,'question'=>$arow['question'],'gid'=>$arow['gid']);\n                    $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>$arow['type'], 'sid'=>$surveyid, \"gid\"=>$arow['gid'], \"qid\"=>$arow['qid'], \"aid\"=>\"othercomment\");\n                    if ($style == \"full\")\n                    {\n                        $fieldmap[$fieldname]['title']=$arow['title'];\n                        $fieldmap[$fieldname]['question']=$arow['question'];\n                        $fieldmap[$fieldname]['subquestion']=$clang->gT('Other comment');\n                        $fieldmap[$fieldname]['group_name']=$arow['group_name'];\n                        $fieldmap[$fieldname]['mandatory']=$arow['mandatory'];\n                        $fieldmap[$fieldname]['hasconditions']=$conditions;\n                        $fieldmap[$fieldname]['usedinconditions']=$usedinconditions;\n                        $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n                        $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n                        $fieldmap[$fieldname]['other']=$arow['other'];\n                    }\n                }\n            }\n        }\n        if (isset($fieldmap[$fieldname]))\n        {\n            $fieldmap[$fieldname]['relevance']=$arow['relevance'];\n            $fieldmap[$fieldname]['grelevance']=$arow['grelevance'];\n            $fieldmap[$fieldname]['questionSeq']=$questionSeq;\n            $fieldmap[$fieldname]['groupSeq']=$groupSeq;\n            $fieldmap[$fieldname]['preg']=$arow['preg'];\n            $fieldmap[$fieldname]['other']=$arow['other'];\n            $fieldmap[$fieldname]['help']=$arow['help'];\n        }\n        else\n        {\n            --$questionSeq; // didn't generate a valid $fieldmap entry, so decrement the question counter to ensure they are sequential\n        }\n    }\n\n    if (isset($fieldmap)) {\n        if ($questionid == false)\n        {\n            // If the fieldmap was randomized, the master will contain the proper order.  Copy that fieldmap with the new language settings.\n            if (isset(Yii::app()->session['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster']))\n            {\n                $masterFieldmap = Yii::app()->session['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster'];\n                $mfieldmap = Yii::app()->session['survey_'.$surveyid][$masterFieldmap];\n\n                foreach ($mfieldmap as $fieldname => $mf)\n                {\n                    if (isset($fieldmap[$fieldname]))\n                    {\n                        // This array holds the keys of translatable attributes\n                        $translatable = array_flip(array('question', 'subquestion', 'subquestion1', 'subquestion2', 'group_name', 'answerList', 'defaultValue', 'help'));\n                        // We take all translatable attributes from the new fieldmap\n                        $newText = array_intersect_key($fieldmap[$fieldname], $translatable);\n                        // And merge them with the other values from the random fieldmap like questionSeq, groupSeq etc.\n                        $mf = $newText + $mf;\n                    }\n                    $mfieldmap[$fieldname] = $mf;\n                }\n                $fieldmap = $mfieldmap;\n            }\n            Yii::app()->session['fieldmap-' . $surveyid . $sLanguage]=$fieldmap;\n        }\n        return $fieldmap;\n    }\n}\n\n/**\n* Returns true if the given survey has a File Upload Question Type\n* @param $surveyid The survey ID\n* @return bool\n*/\nfunction hasFileUploadQuestion($iSurveyID) {\n    $iCount = Question::model()->count( \"sid=:surveyid AND parent_qid=0 AND type='|'\", array(':surveyid' => $iSurveyID));    \n    return $iCount>0 ;\n}\n\n/**\n* This function generates an array containing the fieldcode, and matching data in the same order as the activate script\n*\n* @param string $surveyid The Survey ID\n* @param mixed $style 'short' (default) or 'full' - full creates extra information like default values\n* @param mixed $force_refresh - Forces to really refresh the array, not just take the session copy\n* @param int $questionid Limit to a certain qid only (for question preview) - default is false\n* @param string $sQuestionLanguage The language to use\n* @return array\n*/\nfunction createTimingsFieldMap($surveyid, $style='full', $force_refresh=false, $questionid=false, $sQuestionLanguage=null) {\n\n    global $aDuplicateQIDs;\n    static $timingsFieldMap;\n\n    $sLanguage = sanitize_languagecode($sQuestionLanguage);\n    $surveyid = sanitize_int($surveyid);\n    $clang = new Limesurvey_lang($sLanguage);\n\n    //checks to see if fieldmap has already been built for this page.\n    if (isset($timingsFieldMap[$surveyid][$style][$clang->langcode]) && $force_refresh==false) {\n        return $timingsFieldMap[$surveyid][$style][$clang->langcode];\n    }\n\n    //do something\n    $fields = createFieldMap($surveyid, $style, $force_refresh, $questionid, $sQuestionLanguage);\n    $fieldmap['interviewtime']=array('fieldname'=>'interviewtime','type'=>'interview_time','sid'=>$surveyid, 'gid'=>'', 'qid'=>'', 'aid'=>'', 'question'=>$clang->gT('Total time'), 'title'=>'interviewtime');\n    foreach ($fields as $field) {\n        if (!empty($field['gid'])) {\n            // field for time spent on page\n            $fieldname=\"{$field['sid']}X{$field['gid']}time\";\n            if (!isset($fieldmap[$fieldname]))\n            {\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>\"page_time\", 'sid'=>$surveyid, \"gid\"=>$field['gid'], \"group_name\"=>$field['group_name'], \"qid\"=>'', 'aid'=>'', 'title'=>'groupTime'.$field['gid'], 'question'=>$clang->gT('Group time').\": \".$field['group_name']);\n            }\n\n            // field for time spent on answering a question\n            $fieldname=\"{$field['sid']}X{$field['gid']}X{$field['qid']}time\";\n            if (!isset($fieldmap[$fieldname]))\n            {\n                $fieldmap[$fieldname]=array(\"fieldname\"=>$fieldname, 'type'=>\"answer_time\", 'sid'=>$surveyid, \"gid\"=>$field['gid'], \"group_name\"=>$field['group_name'], \"qid\"=>$field['qid'], 'aid'=>'', \"title\"=>$field['title'].'Time', \"question\"=>$clang->gT('Question time').\": \".$field['title']);\n            }\n        }\n    }\n\n    $timingsFieldMap[$surveyid][$style][$clang->langcode] = $fieldmap;\n    return $timingsFieldMap[$surveyid][$style][$clang->langcode];\n}\n\n/**\n* put your comment there...\n*\n* @param mixed $needle\n* @param mixed $haystack\n* @param mixed $keyname\n* @param mixed $maxanswers\n*/\nfunction arraySearchByKey($needle, $haystack, $keyname, $maxanswers=\"\") {\n    $output=array();\n    foreach($haystack as $hay) {\n        if (array_key_exists($keyname, $hay)) {\n            if ($hay[$keyname] == $needle) {\n                if ($maxanswers == 1) {\n                    return $hay;\n                } else {\n                    $output[]=$hay;\n                }\n            }\n        }\n    }\n    return $output;\n}\n\n/**\n* set the rights of a user and his children\n*\n* @param int $uid the user id\n* @param mixed $rights rights array\n*/\nfunction setuserpermissions($uid, $rights)\n{\n    $uid=sanitize_int($uid);\n    $updates = \"create_survey=\".$rights['create_survey']\n    . \", create_user=\".$rights['create_user']\n    . \", participant_panel=\".$rights['participant_panel']\n    . \", delete_user=\".$rights['delete_user']\n    . \", superadmin=\".$rights['superadmin']\n    . \", configurator=\".$rights['configurator']\n    . \", manage_template=\".$rights['manage_template']\n    . \", manage_label=\".$rights['manage_label'];\n    $uquery = \"UPDATE {{users}} SET \".$updates.\" WHERE uid = \".$uid;\n    return dbSelectLimitAssoc($uquery);     //Checked\n}\n\n/**\n* This function returns a count of the number of saved responses to a survey\n*\n* @param mixed $surveyid Survey ID\n*/\nfunction getSavedCount($surveyid)\n{\n    $surveyid=(int)$surveyid;\n\n    return SavedControl::model()->getCountOfAll($surveyid);\n}\n\n/**\n* Returns the base language from a survey id\n*\n* @deprecated Use Survey::model()->findByPk($surveyid)->language\n* @param int $surveyid\n* @return string\n*/\nfunction getBaseLanguageFromSurveyID($surveyid)\n{\n    return Survey::model()->findByPk($surveyid)->language;\n}\n\n\nfunction buildLabelSetCheckSumArray()\n{\n    // BUILD CHECKSUMS FOR ALL EXISTING LABEL SETS\n\n    /**$query = \"SELECT lid\n    FROM \".db_table_name('labelsets').\"\n    ORDER BY lid\"; */\n    $result = LabelSet::model()->getLID();//($query) or safeDie(\"safe_died collecting labelset ids<br />$query<br />\");  //Checked)\n    $csarray=array();\n    foreach($result as $row)\n    {\n        $thisset=\"\";\n        $query2 = \"SELECT code, title, sortorder, language, assessment_value\n        FROM {{labels}}\n        WHERE lid={$row['lid']}\n        ORDER BY language, sortorder, code\";\n        $result2 = Yii::app()->db->createCommand($query2)->query();\n        foreach ($result2->readAll() as $row2)\n        {\n            $thisset .= implode('.', $row2);\n        } // while\n        $csarray[$row['lid']]=dechex(crc32($thisset)*1);\n    }\n\n    return $csarray;\n}\n\n\n/**\n* Returns a flat array with all question attributes for the question only (and the qid we gave it)!\n* @param $iQID The question ID\n* @return array$bOrderByNative=>value, attribute=>value} or false if the question ID does not exist (anymore)\n*/\nfunction getQuestionAttributeValues($iQID)\n{\n    return QuestionAttribute::model()->getQuestionAttributes($iQID);\n#    static $cache = array();\n#    static $availableattributesarr = null;\n#    $iQID = sanitize_int($iQID);\n\n#    if (isset($cache[$iQID])) {\n#        return $cache[$iQID];\n#    }\n#    $oQuestion = Question::model()->find(\"qid=:qid\",array('qid'=>$iQuestionID)); // Maybe take parent_qid attribute before this qid attribute\n#    if (!$oQuestion) // Question was deleted while running the survey\n#    {\n#        $cache[$iQID] = false;\n#        return false;\n#    }\n#    else\n#    {\n#        $type = $oQuestion->type;\n#        $surveyid = $oQuestion->type;\n#        $row = $oQuestion->getAttributes();\n#    }\n#    $type = $row['type'];\n#    $surveyid = $row['sid'];\n\n#    $aLanguages = array_merge((array)Survey::model()->findByPk($surveyid)->language, Survey::model()->findByPk($surveyid)->additionalLanguages);\n\n    //Now read available attributes, make sure we do this only once per request to save\n    //processing cycles and memory\n#    if (is_null($availableattributesarr)) $availableattributesarr = questionAttributes();\n#    if (isset($availableattributesarr[$type]))\n#    {\n#        $aAvailableAttributes = $availableattributesarr[$type];\n#    }\n#    else\n#    {\n#        $cache[$iQID] = array();\n#        return array();\n#    }\n\n#    $aResultAttributes = array();\n#    foreach($aAvailableAttributes as $attribute){\n#        if ($attribute['i18n'])\n#        {\n#            foreach ($aLanguages as $sLanguage)\n#            {\n#                $aResultAttributes[$attribute['name']][$sLanguage]=$attribute['default'];\n#            }\n#        }\n#        else\n#        {\n#            $aResultAttributes[$attribute['name']]=$attribute['default'];\n#        }\n#    }\n\n#    $result = QuestionAttribute::model()->findAllByAttributes(array('qid' => $iQID));\n#    foreach ($result as $row)\n#    {\n#        $row = $row->attributes;\n#        if (!isset($aAvailableAttributes[$row['attribute']]))\n#        {\n#            continue; // Sort out attributes not belonging to this question\n#        }\n#        if (!($aAvailableAttributes[$row['attribute']]['i18n']))\n#        {\n#            $aResultAttributes[$row['attribute']]=$row['value'];\n#        }\n#        elseif(!empty($row['language']))\n#        {\n#            $aResultAttributes[$row['attribute']][$row['language']]=$row['value'];\n#        }\n#    }\n#    $cache[$iQID] = $aResultAttributes;\n#    return $aResultAttributes;\n}\n\n/**\n*\n* Returns the questionAttribtue value set or '' if not set\n* @author: lemeur\n* @param $questionAttributeArray\n* @param $attributeName\n* @param $language string Optional: The language if the particualr attributes is localizable\n* @return string\n*/\nfunction getQuestionAttributeValue($questionAttributeArray, $attributeName, $language='')\n{\n    if ($language=='' && isset($questionAttributeArray[$attributeName]))\n    {\n        return $questionAttributeArray[$attributeName];\n    }\n    elseif ($language!='' && isset($questionAttributeArray[$attributeName][$language]))\n    {\n        return $questionAttributeArray[$attributeName][$language];\n    }\n    else\n    {\n        return '';\n    }\n}\n\n/**\n* Returns array of question type chars with attributes\n*\n* @param mixed $returnByName If set to true the array will be by attribute name\n*/\nfunction questionAttributes($returnByName=false)\n{\n    // Use some static\n    static $qattributes=false;\n    static $qat=false;\n    $clang = Yii::app()->lang;\n\n    if (!$qattributes)\n    {\n        //For each question attribute include a key:\n        // name - the display name\n        // types - a string with one character representing each question typy to which the attribute applies\n        // help - a short explanation\n\n        // If you insert a new attribute please do it in correct alphabetical order!\n        // Please also list the new attribute in the function &TSVSurveyExport($sid) in em_manager_helper.php,\n        // so your new attribute will not be \"forgotten\" when the survey is exported to Excel/CSV-format!\n\n        $qattributes[\"alphasort\"]=array(\n        \"types\"=>\"!LOWZ\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Sort the answer options alphabetically\"),\n        \"caption\"=>$clang->gT('Sort answers alphabetically'));\n\n        $qattributes[\"answer_width\"]=array(\n        \"types\"=>\"ABCEF1:;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n        'min'=>'1',\n        'max'=>'100',\n        \"help\"=>$clang->gT('Set the percentage width of the (sub-)question column (1-100)'),\n        \"caption\"=>$clang->gT('(Sub-)question width'));\n\n        $qattributes[\"repeat_headings\"]=array(\n        \"types\"=>\"F:1;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n         'default'=>'',\n        \"help\"=>$clang->gT('Repeat headings every X subquestions (Set to 0 to deactivate heading repeat, deactivate minimum repeat headings from config).'),\n        \"caption\"=>$clang->gT('Repeat headers'));\n\n        $qattributes[\"array_filter\"]=array(\n        \"types\"=>\"1ABCEF:;MPLKQR\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT(\"Enter the code(s) of Multiple choice question(s) (separated by semicolons) to only show the matching answer options in this question.\"),\n        \"caption\"=>$clang->gT('Array filter'));\n\n        $qattributes[\"array_filter_exclude\"]=array(\n        \"types\"=>\"1ABCEF:;MPLKQR\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT(\"Enter the code(s) of Multiple choice question(s) (separated by semicolons) to exclude the matching answer options in this question.\"),\n        \"caption\"=>$clang->gT('Array filter exclusion'));\n\n        $qattributes[\"array_filter_style\"]=array(\n        \"types\"=>\"1ABCEF:;MPLKQR\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Hidden'),\n        1=>$clang->gT('Disabled')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Specify how array-filtered sub-questions should be displayed\"),\n        \"caption\"=>$clang->gT('Array filter style'));\n\n        $qattributes[\"assessment_value\"]=array(\n        \"types\"=>\"MP\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'default'=>'1',\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT(\"If one of the subquestions is marked then for each marked subquestion this value is added as assessment.\"),\n        \"caption\"=>$clang->gT('Assessment value'));\n\n        $qattributes[\"category_separator\"]=array(\n        \"types\"=>\"!\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Category separator'),\n        \"caption\"=>$clang->gT('Category separator'));\n\n        $qattributes[\"code_filter\"]=array(\n        \"types\"=>\"WZ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Filter the available answers by this value'),\n        \"caption\"=>$clang->gT('Code filter'));\n\n        $qattributes[\"commented_checkbox\"]=array(\n        \"types\"=>\"P\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>110,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n            \"allways\"=>$clang->gT('No control on checkbox'),\n            \"checked\"=>$clang->gT('Checkbox is checked'),\n            \"unchecked\"=>$clang->gT('Checkbox is unchecked'),\n            ),\n        'default' => \"checked\",\n        'help'=>$clang->gT('Choose when user can add a comment'),\n        'caption'=>$clang->gT('Comment only when'));\n\n        $qattributes[\"commented_checkbox_auto\"]=array(\n        \"types\"=>\"P\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>111,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n            \"0\"=>$clang->gT('No'),\n            \"1\"=>$clang->gT('Yes'),\n            ),\n        'default' => \"1\",\n        'help'=>$clang->gT('Use javascript function to remove text and uncheck checkbox (or use Expression Manager only).'),\n        'caption'=>$clang->gT('Remove text or uncheck checkbox automatically'));\n\n        $qattributes[\"display_columns\"]=array(\n        \"types\"=>\"LM\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n        'default'=>'1',\n        'min'=>'1',\n        'max'=>'100',\n        \"help\"=>$clang->gT('The answer options will be distributed across the number of columns set here'),\n        \"caption\"=>$clang->gT('Display columns'));\n\n        $qattributes[\"display_rows\"]=array(\n        \"types\"=>\"QSTU\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('How many rows to display'),\n        \"caption\"=>$clang->gT('Display rows'));\n\n        $qattributes[\"dropdown_dates\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use accessible dropdown boxes instead of calendar popup'),\n        \"caption\"=>$clang->gT('Display dropdown boxes'));\n\n        $qattributes[\"date_min\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Minimum date selectable in calendar (YYYY-MM-DD). Only the year is used if dropdown boxes are selected.'),\n        \"caption\"=>$clang->gT('Minimum date'));\n\n        $qattributes[\"date_max\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>111,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum date selectable in calendar (YYYY-MM-DD). Only the year is used if dropdown boxes are selected.'),\n        \"caption\"=>$clang->gT('Maximum date'));\n\n        $qattributes[\"dropdown_prepostfix\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>112,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Prefix|Suffix for dropdown lists'),\n        \"caption\"=>$clang->gT('Dropdown prefix/suffix'));\n\n        $qattributes[\"dropdown_separators\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>120,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Text shown on each subquestion row between both scales in dropdown mode'),\n        \"caption\"=>$clang->gT('Dropdown separator'));\n\n        $qattributes[\"dualscale_headerA\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Enter a header text for the first scale'),\n        \"caption\"=>$clang->gT('Header for first scale'));\n\n        $qattributes[\"dualscale_headerB\"]=array(\n        \"types\"=>\"1\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>111,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Enter a header text for the second scale'),\n        \"caption\"=>$clang->gT('Header for second scale'));\n\n        $qattributes[\"equals_num_value\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Multiple numeric inputs sum must equal this value'),\n        \"caption\"=>$clang->gT('Equals sum value'));\n\n        $qattributes[\"em_validation_q\"]=array(\n        \"types\"=>\":;ABCDEFKMNPQRSTU\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>200,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('Enter a boolean equation to validate the whole question.'),\n        \"caption\"=>$clang->gT('Question validation equation'));\n\n        $qattributes[\"em_validation_q_tip\"]=array(\n        \"types\"=>\":;ABCDEFKMNPQRSTU\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>210,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('This is a hint text that will be shown to the participant describing the question validation equation.'),\n        \"caption\"=>$clang->gT('Question validation tip'));\n\n        $qattributes[\"em_validation_sq\"]=array(\n        \"types\"=>\";:KQSTUN\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>220,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('Enter a boolean equation to validate each sub-question.'),\n        \"caption\"=>$clang->gT('Sub-question validation equation'));\n\n        $qattributes[\"em_validation_sq_tip\"]=array(\n        \"types\"=>\";:KQSTUN\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>230,\n        'inputtype'=>'textarea',\n        \"help\"=>$clang->gT('This is a tip shown to the participant describing the sub-question validation equation.'),\n        \"caption\"=>$clang->gT('Sub-question validation tip'));\n\n        $qattributes[\"exclude_all_others\"]=array(\n        \"types\"=>\":ABCEFMPKQ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>130,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Excludes all other options if a certain answer is selected - just enter the answer code(s) separated with a semikolon.'),\n        \"caption\"=>$clang->gT('Exclusive option'));\n\n        $qattributes[\"exclude_all_others_auto\"]=array(\n        \"types\"=>\"MP\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>131,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('If the participant marks all options, uncheck all and check the option set in the \"Exclusive option\" setting'),\n        \"caption\"=>$clang->gT('Auto-check exclusive option if all others are checked'));\n\n        // Map Options\n\n        $qattributes[\"location_city\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the city?\"),\n        \"caption\"=>$clang->gT(\"Save city\"));\n\n        $qattributes[\"location_state\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'default'=>0,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the state?\"),\n        \"caption\"=>$clang->gT(\"Save state\"));\n\n        $qattributes[\"location_postal\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the postal code?\"),\n        \"caption\"=>$clang->gT(\"Save postal code\"));\n\n        $qattributes[\"location_country\"]=array(\n        \"types\"=>\"S\",\n        'readonly_when_active'=>true,\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        \"help\"=>$clang->gT(\"Store the country?\"),\n        \"caption\"=>$clang->gT(\"Save country\"));\n\n        $qattributes[\"statistics_showmap\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Statistics'),\n        'inputtype'=>'singleselect',\n        'sortorder'=>100,\n        'options'=>array(1=>$clang->gT('Yes'), 0=>$clang->gT('No')),\n        'help'=>$clang->gT(\"Show a map in the statistics?\"),\n        'caption'=>$clang->gT(\"Display map\"),\n        'default'=>1\n        );\n\n        $qattributes[\"statistics_showgraph\"]=array(\n        'types'=>'15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Statistics'),\n        'inputtype'=>'singleselect',\n        'sortorder'=>101,\n        'options'=>array(1=>$clang->gT('Yes'), 0=>$clang->gT('No')),\n        'help'=>$clang->gT(\"Display a chart in the statistics?\"),\n        'caption'=>$clang->gT(\"Display chart\"),\n        'default'=>1\n        );\n\n        $qattributes[\"statistics_graphtype\"]=array(\n        \"types\"=>'15ABCDEFGHIKLNOQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Statistics'),\n        'inputtype'=>'singleselect',\n        'sortorder'=>102,\n        'options'=>array(0=>$clang->gT('Bar chart'), 1=>$clang->gT('Pie chart')),\n        'help'=>$clang->gT(\"Select the type of chart to be displayed\"),\n        'caption'=>$clang->gT(\"Chart type\"),\n        'default'=>0\n        );\n\n        $qattributes[\"location_mapservice\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>90,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Off'),\n        1=>$clang->gT('Google Maps')),\n        'default' => 0,\n        \"help\"=>$clang->gT(\"Activate this to show a map above the input field where the user can select a location\"),\n        \"caption\"=>$clang->gT(\"Use mapping service\"));\n\n        $qattributes[\"location_mapwidth\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>102,\n        'inputtype'=>'text',\n        'default'=>'500',\n        \"help\"=>$clang->gT(\"Width of the map in pixel\"),\n        \"caption\"=>$clang->gT(\"Map width\"));\n\n        $qattributes[\"location_mapheight\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>103,\n        'inputtype'=>'text',\n        'default'=>'300',\n        \"help\"=>$clang->gT(\"Height of the map in pixel\"),\n        \"caption\"=>$clang->gT(\"Map height\"));\n\n        $qattributes[\"location_nodefaultfromip\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>91,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Yes'),\n        1=>$clang->gT('No')),\n        'default' => 0,\n        \"help\"=>$clang->gT(\"Get the default location using the user's IP address?\"),\n        \"caption\"=>$clang->gT(\"IP as default location\"));\n\n        $qattributes[\"location_defaultcoordinates\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>101,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Default coordinates of the map when the page first loads. Format: latitude [space] longtitude'),\n        \"caption\"=>$clang->gT('Default position'));\n\n        $qattributes[\"location_mapzoom\"]=array(\n        \"types\"=>\"S\",\n        'category'=>$clang->gT('Location'),\n        'sortorder'=>101,\n        'inputtype'=>'text',\n        'default'=>'11',\n        \"help\"=>$clang->gT(\"Map zoom level\"),\n        \"caption\"=>$clang->gT(\"Zoom level\"));\n\n        // End Map Options\n\n        $qattributes[\"hide_tip\"]=array(\n        \"types\"=>\"15ABCDEFGHIKLMNOPQRSTUXY!:;|\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Hide the tip that is normally shown with a question'),\n        \"caption\"=>$clang->gT('Hide tip'));\n\n        $qattributes['hidden']=array(\n        'types'=>'15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>101,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        'help'=>$clang->gT('Hide this question at any time. This is useful for including data using answer prefilling.'),\n        'caption'=>$clang->gT('Always hide this question'));\n\n        $qattributes[\"max_answers\"]=array(\n        \"types\"=>\"MPR1:;ABCEFKQ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>11,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Limit the number of possible answers'),\n        \"caption\"=>$clang->gT('Maximum answers'));\n\n        $qattributes[\"max_num_value\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum sum value of multiple numeric input'),\n        \"caption\"=>$clang->gT('Maximum sum value'));\n\n        $qattributes[\"max_num_value_n\"]=array(\n        \"types\"=>\"NK\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>110,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Maximum value of the numeric input'),\n        \"caption\"=>$clang->gT('Maximum value'));\n\n        //    $qattributes[\"max_num_value_sgqa\"]=array(\n        //    \"types\"=>\"K\",\n        //    'category'=>$clang->gT('Logic'),\n        //    'sortorder'=>100,\n        //    'inputtype'=>'text',\n        //    \"help\"=>$clang->gT('Enter the SGQA identifier to use the total of a previous question as the maximum for this question'),\n        //    \"caption\"=>$clang->gT('Max value from SGQA'));\n\n        $qattributes[\"maximum_chars\"]=array(\n        \"types\"=>\"STUNQK:;\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum characters allowed'),\n        \"caption\"=>$clang->gT('Maximum characters'));\n\n        $qattributes[\"min_answers\"]=array(\n        \"types\"=>\"MPR1:;ABCEFKQ\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>10,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Ensure a minimum number of possible answers (0=No limit)'),\n        \"caption\"=>$clang->gT('Minimum answers'));\n\n        $qattributes[\"min_num_value\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('The sum of the multiple numeric inputs must be greater than this value'),\n        \"caption\"=>$clang->gT('Minimum sum value'));\n\n        $qattributes[\"min_num_value_n\"]=array(\n        \"types\"=>\"NK\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'integer',\n        \"help\"=>$clang->gT('Minimum value of the numeric input'),\n        \"caption\"=>$clang->gT('Minimum value'));\n\n        //    $qattributes[\"min_num_value_sgqa\"]=array(\n        //    \"types\"=>\"K\",\n        //    'category'=>$clang->gT('Logic'),\n        //    'sortorder'=>100,\n        //    'inputtype'=>'text',\n        //    \"help\"=>$clang->gT('Enter the SGQA identifier to use the total of a previous question as the minimum for this question'),\n        //    \"caption\"=>$clang->gT('Minimum value from SGQA'));\n\n        $qattributes[\"multiflexible_max\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>112,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Maximum value for array(mult-flexible) question type'),\n        \"caption\"=>$clang->gT('Maximum value'));\n\n        $qattributes[\"multiflexible_min\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Minimum value for array(multi-flexible) question type'),\n        \"caption\"=>$clang->gT('Minimum value'));\n\n        $qattributes[\"multiflexible_step\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>111,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Step value'),\n        \"caption\"=>$clang->gT('Step value'));\n\n        $qattributes[\"multiflexible_checkbox\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use checkbox layout'),\n        \"caption\"=>$clang->gT('Checkbox layout'));\n\n        $qattributes[\"reverse\"]=array(\n        \"types\"=>\"D:\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Present answer options in reverse order'),\n        \"caption\"=>$clang->gT('Reverse answer order'));\n\n        //    $qattributes[\"num_value_equals_sgqa\"]=array(\n        //    \"types\"=>\"K\",\n        //    'category'=>$clang->gT('Logic'),\n        //    'sortorder'=>100,\n        //    'inputtype'=>'text',\n        //    \"help\"=>$clang->gT('SGQA identifier to use total of previous question as total for this question'),\n        //    \"caption\"=>$clang->gT('Value equals SGQA'));\n\n        $qattributes[\"num_value_int_only\"]=array(\n        \"types\"=>\"N\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Restrict input to integer values'),\n        \"caption\"=>$clang->gT('Integer only'));\n\n        $qattributes[\"numbers_only\"]=array(\n        \"types\"=>\"Q;S*\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>150,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Allow only numerical input'),\n        \"caption\"=>$clang->gT('Numbers only')\n        );\n\n        $qattributes['show_totals'] =    array(\n        'types' =>    ';',\n        'category' =>    $clang->gT('Other'),\n        'sortorder' =>    151,\n        'inputtype'    => 'singleselect',\n        'options' =>    array(\n        'X' =>    $clang->gT('Off'),\n        'R' =>    $clang->gT('Rows'),\n        'C' =>    $clang->gT('Columns'),\n        'B' =>    $clang->gT('Both rows and columns')\n        ),\n        'default' =>    'X',\n        'help' =>    $clang->gT('Show totals for either rows, columns or both rows and columns'),\n        'caption' =>    $clang->gT('Show totals for')\n        );\n\n        $qattributes['show_grand_total'] =    array(\n        'types' =>    ';',\n        'category' =>    $clang->gT('Other'),\n        'sortorder' =>    152,\n        'inputtype' =>    'singleselect',\n        'options' =>    array(\n        0 =>    $clang->gT('No'),\n        1 =>    $clang->gT('Yes')\n        ),\n        'default' =>    0,\n        'help' =>    $clang->gT('Show grand total for either columns or rows'),\n        'caption' =>    $clang->gT('Show grand total')\n        );\n\n        $qattributes[\"input_boxes\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Present as text input boxes instead of dropdown lists\"),\n        \"caption\"=>$clang->gT(\"Text inputs\"));\n\n        $qattributes[\"other_comment_mandatory\"]=array(\n        \"types\"=>\"PLW!Z\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Make the 'Other:' comment field mandatory when the 'Other:' option is active\"),\n        \"caption\"=>$clang->gT(\"'Other:' comment mandatory\"));\n\n        $qattributes[\"other_numbers_only\"]=array(\n        \"types\"=>\"LMP\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Allow only numerical input for 'Other' text\"),\n        \"caption\"=>$clang->gT(\"Numbers only for 'Other'\"));\n\n        $qattributes[\"other_replace_text\"]=array(\n        \"types\"=>\"LMPWZ!\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"Replaces the label of the 'Other:' answer option with a custom text\"),\n        \"caption\"=>$clang->gT(\"Label for 'Other:' option\"));\n\n        $qattributes[\"page_break\"]=array(\n        \"types\"=>\"15ABCDEFGHKLMNOPQRSTUWXYZ!:;|*\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Insert a page break before this question in printable view by setting this to Yes.'),\n        \"caption\"=>$clang->gT('Insert page break in printable view'));\n\n        $qattributes[\"prefix\"]=array(\n        \"types\"=>\"KNQS\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>10,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Add a prefix to the answer field'),\n        \"caption\"=>$clang->gT('Answer prefix'));\n\n        $qattributes[\"printable_help\"]=array(\n        \"types\"=>\"15ABCDEFGHKLMNOPRWYZ!:*\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>201,\n        \"inputtype\"=>\"text\",\n        'i18n'=>true,\n        'default'=>\"\",\n        \"help\"=>$clang->gT('In the printable version replace the relevance equation with this explanation text.'),\n        \"caption\"=>$clang->gT(\"Relevance help for printable survey\"));    \n        \n        $qattributes[\"public_statistics\"]=array(\n        \"types\"=>\"15ABCEFGHKLMNOPRWYZ!:*\",\n        'category'=>$clang->gT('Statistics'),\n        'sortorder'=>80,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Show statistics of this question in the public statistics page'),\n        \"caption\"=>$clang->gT('Show in public statistics'));\n\n        $qattributes[\"random_order\"]=array(\n        \"types\"=>\"!ABCEFHKLMOPQRWZ1:;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Off'),\n        1=>$clang->gT('Randomize on each page load')\n        //,2=>$clang->gT('Randomize once on survey start')  //Mdekker: commented out as code to handle this was removed in refactoring\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Present subquestions/answer options in random order'),\n        \"caption\"=>$clang->gT('Random order'));\n\n        /*\n        $qattributes['relevance']=array(\n        'types'=>'15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|*',\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>1,\n        'inputtype'=>'text',\n        'default'=>'1',\n        'help'=>$clang->gT('The relevance equation determines whether a question should be shown (if true) or hiddden and marked as Not Applicable (if false).'\n        . '  The relevance equation can be as complex as you like, using any combination of mathematical operators, nested parentheses,'\n        . ' any variable or token that has already been set, and any of more than 50 functions.  It is parsed by the ExpressionManager.'),\n        'caption'=>$clang->gT('Relevance equation'));\n        */\n\n        $qattributes[\"showpopups\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>110,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"caption\"=>$clang->gT('Show javascript alert'),\n        \"help\"=>$clang->gT('Show an alert if answers exceeds the number of max answers'));\n        $qattributes[\"samechoiceheight\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>120,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"caption\"=>$clang->gT('Same height for all answer options'),\n        \"help\"=>$clang->gT('Force each answer option to have the same height'));\n        $qattributes[\"samelistheight\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>121,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"caption\"=>$clang->gT('Same height for lists'),\n        \"help\"=>$clang->gT('Force the choice list and the rank list to have the same height'));\n\n        $qattributes[\"parent_order\"]=array(\n        \"types\"=>\":\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"caption\"=>$clang->gT('Get order from previous question'),\n        \"help\"=>$clang->gT('Enter question ID to get subquestion order from a previous question'));\n\n        $qattributes[\"slider_layout\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>1,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use slider layout'),\n        \"caption\"=>$clang->gT('Use slider layout'));\n\n        $qattributes[\"slider_min\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>10,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider minimum value'),\n        \"caption\"=>$clang->gT('Slider minimum value'));\n\n        $qattributes[\"slider_max\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>11,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider maximum value'),\n        \"caption\"=>$clang->gT('Slider maximum value'));\n\n        $qattributes[\"slider_accuracy\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>30,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider accuracy'),\n        \"caption\"=>$clang->gT('Slider accuracy'));\n\n        $qattributes[\"slider_default\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>50,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Slider start as this value (this will set the initial value).'),\n        \"caption\"=>$clang->gT('Slider initial value'));\n\n        $qattributes[\"slider_middlestart\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>40,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('The handle is displayed at the middle of the slider except if Slider initial value is set (this will not set the initial value).'),\n        \"caption\"=>$clang->gT('Slider starts at the middle position'));\n\n        $qattributes[\"slider_rating\"]=array(\n        \"types\"=>\"5\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>90,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes - stars'),\n        2=>$clang->gT('Yes - slider with emoticon'),\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Use slider layout'),\n        \"caption\"=>$clang->gT('Use slider layout'));\n\n        $qattributes[\"slider_reset\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>50,\n        'inputtype'=>'singleselect',\n        'options'=>array(\n        0=>$clang->gT('No'),\n        1=>$clang->gT('Yes'),\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Add a button to reset the slider. If you choose an start value, it reset at start value, else empty the answer.'),\n        \"caption\"=>$clang->gT('Allow reset the slider'));\n\n        $qattributes[\"slider_showminmax\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Display min and max value under the slider'),\n        \"caption\"=>$clang->gT('Display slider min and max value'));\n\n        $qattributes[\"slider_separator\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Slider'),\n        'sortorder'=>110,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Answer|Left-slider-text|Right-slider-text separator character'),\n        \"caption\"=>$clang->gT('Slider left/right text separator'));\n\n        $qattributes[\"suffix\"]=array(\n        \"types\"=>\"KNQS\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>11,\n        'inputtype'=>'text',\n        'i18n'=>true,\n        \"help\"=>$clang->gT('Add a suffix to the answer field'),\n        \"caption\"=>$clang->gT('Answer suffix'));\n\n        $qattributes[\"text_input_width\"]=array(\n        \"types\"=>\"KNSTUQ;\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT('Width of text input box'),\n        \"caption\"=>$clang->gT('Input box width'));\n\n        $qattributes[\"use_dropdown\"]=array(\n        \"types\"=>\"1FO\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>112,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT('Present dropdown control(s) instead of list of radio buttons'),\n        \"caption\"=>$clang->gT('Use dropdown presentation'));\n\n\n        $qattributes[\"dropdown_size\"]=array(\n        \"types\"=>\"!\",   // TODO add these later?  \"1F\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>200,\n        'inputtype'=>'text',\n        'default'=>0,\n        \"help\"=>$clang->gT('For list dropdown boxes, show up to this many rows'),\n        \"caption\"=>$clang->gT('Height of dropdown'));\n\n        $qattributes[\"dropdown_prefix\"]=array(\n        \"types\"=>\"!\",   // TODO add these later?  \"1F\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>201,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('None'),\n        1=>$clang->gT('Order - like 3)'),\n        ),\n        'default'=>0,\n        \"help\"=>$clang->gT('Accelerator keys for list items'),\n        \"caption\"=>$clang->gT('Prefix for list items'));\n\n        $qattributes[\"scale_export\"]=array(\n        \"types\"=>\"CEFGHLMOPWYZ1!:*\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>100,\n        'inputtype'=>'singleselect',\n        'options'=>array(0=>$clang->gT('Default'),\n        1=>$clang->gT('Nominal'),\n        2=>$clang->gT('Ordinal'),\n        3=>$clang->gT('Scale')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Set a specific SPSS export scale type for this question\"),\n        \"caption\"=>$clang->gT('SPSS export scale type'));\n\n        $qattributes[\"choice_title\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>200,\n        \"inputtype\"=>\"text\",\n        'i18n'=>true,\n        'default'=>\"\",\n        \"help\"=>sprintf($clang->gT(\"Replace choice header (default: \\\"%s\\\")\",'js'),$clang->gT(\"Your Choices\")),\n        \"caption\"=>$clang->gT(\"Choice header\"));\n\n        $qattributes[\"rank_title\"]=array(\n        \"types\"=>\"R\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>201,\n        \"inputtype\"=>\"text\",\n        'i18n'=>true,\n        'default'=>\"\",\n        \"help\"=>sprintf($clang->gT(\"Replace rank header (default: \\\"%s\\\")\",'js'),$clang->gT(\"Your Ranking\")),\n        \"caption\"=>$clang->gT(\"Rank header\"));\n\n        //Timer attributes\n        $qattributes[\"time_limit\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>90,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Limit time to answer question (in seconds)\"),\n        \"caption\"=>$clang->gT(\"Time limit\"));\n\n        $qattributes[\"time_limit_action\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>92,\n        'inputtype'=>'singleselect',\n        'options'=>array(1=>$clang->gT('Warn and move on'),\n        2=>$clang->gT('Move on without warning'),\n        3=>$clang->gT('Disable only')),\n        \"default\" => 1,\n        \"help\"=>$clang->gT(\"Action to perform when time limit is up\"),\n        \"caption\"=>$clang->gT(\"Time limit action\"));\n\n        $qattributes[\"time_limit_disable_next\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>94,\n        \"inputtype\"=>\"singleselect\",\n        'default'=>0,\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        \"help\"=>$clang->gT(\"Disable the next button until time limit expires\"),\n        \"caption\"=>$clang->gT(\"Time limit disable next\"));\n\n        $qattributes[\"time_limit_disable_prev\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>96,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Disable the prev button until the time limit expires\"),\n        \"caption\"=>$clang->gT(\"Time limit disable prev\"));\n\n        $qattributes[\"time_limit_countdown_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>98,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The text message that displays in the countdown timer during the countdown\"),\n        \"caption\"=>$clang->gT(\"Time limit countdown message\"));\n\n        $qattributes[\"time_limit_timer_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS Style for the message that displays in the countdown timer during the countdown\"),\n        \"caption\"=>$clang->gT(\"Time limit timer CSS style\"));\n\n        $qattributes[\"time_limit_message_delay\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>102,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Display the 'time limit expiry message' for this many seconds before performing the 'time limit action' (defaults to 1 second if left blank)\"),\n        \"caption\"=>$clang->gT(\"Time limit expiry message display time\"));\n\n        $qattributes[\"time_limit_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>104,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The message to display when the time limit has expired (a default message will display if this setting is left blank)\"),\n        \"caption\"=>$clang->gT(\"Time limit expiry message\"));\n\n        $qattributes[\"time_limit_message_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>106,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS style for the 'time limit expiry message'\"),\n        \"caption\"=>$clang->gT(\"Time limit message CSS style\"));\n\n        $qattributes[\"time_limit_warning\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>108,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Display a 'time limit warning' when there are this many seconds remaining in the countdown (warning will not display if left blank)\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning message timer\"));\n\n        $qattributes[\"time_limit_warning_display_time\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>110,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"The 'time limit warning' will stay visible for this many seconds (will not turn off if this setting is left blank)\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning message display time\"));\n\n        $qattributes[\"time_limit_warning_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>112,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The message to display as a 'time limit warning' (a default warning will display if this is left blank)\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning message\"));\n\n        $qattributes[\"time_limit_warning_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>114,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS style used when the 'time limit warning' message is displayed\"),\n        \"caption\"=>$clang->gT(\"1st time limit warning CSS style\"));\n\n        $qattributes[\"time_limit_warning_2\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>116,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"Display the 2nd 'time limit warning' when there are this many seconds remaining in the countdown (warning will not display if left blank)\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning message timer\"));\n\n        $qattributes[\"time_limit_warning_2_display_time\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>118,\n        \"inputtype\"=>\"integer\",\n        \"help\"=>$clang->gT(\"The 2nd 'time limit warning' will stay visible for this many seconds (will not turn off if this setting is left blank)\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning message display time\"));\n\n        $qattributes[\"time_limit_warning_2_message\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>120,\n        \"inputtype\"=>\"textarea\",\n        'i18n'=>true,\n        \"help\"=>$clang->gT(\"The 2nd message to display as a 'time limit warning' (a default warning will display if this is left blank)\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning message\"));\n\n        $qattributes[\"time_limit_warning_2_style\"]=array(\n        \"types\"=>\"STUXL!\",\n        'category'=>$clang->gT('Timer'),\n        'sortorder'=>122,\n        \"inputtype\"=>\"textarea\",\n        \"help\"=>$clang->gT(\"CSS style used when the 2nd 'time limit warning' message is displayed\"),\n        \"caption\"=>$clang->gT(\"2nd time limit warning CSS style\"));\n\n        $qattributes[\"date_format\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"text\",\n        \"help\"=>$clang->gT(\"Specify a custom date/time format (the <i>d/dd m/mm yy/yyyy H/HH M/MM</i> formats and \\\"-./: \\\" characters are allowed for day/month/year/hour/minutes without or with leading zero respectively. Defaults to survey's date format\"),\n        \"caption\"=>$clang->gT(\"Date/Time format\"));\n\n        $qattributes[\"dropdown_dates_minute_step\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"integer\",\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Minute step interval when using select boxes\"),\n        \"caption\"=>$clang->gT(\"Minute step interval\"));\n\n        $qattributes[\"dropdown_dates_month_style\"]=array(\n        \"types\"=>\"D\",\n        'category'=>$clang->gT('Display'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('Short names'),\n        1=>$clang->gT('Full names'),\n        2=>$clang->gT('Numbers')),\n        'default'=>0,\n        \"help\"=>$clang->gT(\"Change the display style of the month when using select boxes\"),\n        \"caption\"=>$clang->gT(\"Month display style\"));\n\n        $qattributes[\"show_title\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('File metadata'),\n        'sortorder'=>124,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Is the participant required to give a title to the uploaded file?\"),\n        \"caption\"=>$clang->gT(\"Show title\"));\n\n        $qattributes[\"show_comment\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('File metadata'),\n        'sortorder'=>126,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Is the participant required to give a comment to the uploaded file?\"),\n        \"caption\"=>$clang->gT(\"Show comment\"));\n\n\n        $qattributes[\"max_filesize\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>128,\n        \"inputtype\"=>\"integer\",\n        'default'=>10240,\n        \"help\"=>$clang->gT(\"The participant cannot upload a single file larger than this size\"),\n        \"caption\"=>$clang->gT(\"Maximum file size allowed (in KB)\"));\n\n        $qattributes[\"max_num_of_files\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>130,\n        \"inputtype\"=>\"text\",\n        \"help\"=>$clang->gT(\"Maximum number of files that the participant can upload for this question\"),\n        \"caption\"=>$clang->gT(\"Max number of files\"));\n\n        $qattributes[\"min_num_of_files\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>132,\n        \"inputtype\"=>\"text\",\n        'default'=>'0',\n        \"help\"=>$clang->gT(\"Minimum number of files that the participant must upload for this question\"),\n        \"caption\"=>$clang->gT(\"Min number of files\"));\n\n        $qattributes[\"allowed_filetypes\"]=array(\n        \"types\"=>\"|\",\n        'category'=>$clang->gT('Other'),\n        'sortorder'=>134,\n        \"inputtype\"=>\"text\",\n        'default'=>\"png, gif, doc, odt\",\n        \"help\"=>$clang->gT(\"Allowed file types in comma separated format. e.g. pdf,doc,odt\"),\n        \"caption\"=>$clang->gT(\"Allowed file types\"));\n\n        $qattributes[\"random_group\"]=array(\n        \"types\"=>\"15ABCDEFGHIKLMNOPQRSTUWXYZ!:;|\",\n        'category'=>$clang->gT('Logic'),\n        'sortorder'=>180,\n        'inputtype'=>'text',\n        \"help\"=>$clang->gT(\"Place questions into a specified randomization group, all questions included in the specified group will appear in a random order\"),\n        \"caption\"=>$clang->gT(\"Randomization group name\"));\n\n        // This is added to support historical behavior.  Early versions of 1.92 used a value of \"No\", so if there was a min_sum_value or equals_sum_value, the question was not valid\n        // unless those criteria were met.  In later releases of 1.92, the default was changed so that missing values were allowed even if those attributes were set\n        // This attribute lets authors control whether missing values should be allowed in those cases without needing to set min_answers\n        // Existing surveys will use the old behavior, but if the author edits the question, the default will be the new behavior.\n        $qattributes[\"value_range_allows_missing\"]=array(\n        \"types\"=>\"K\",\n        'category'=>$clang->gT('Input'),\n        'sortorder'=>100,\n        \"inputtype\"=>\"singleselect\",\n        'options'=>array(0=>$clang->gT('No'),\n        1=>$clang->gT('Yes')),\n        'default'=>1,\n        \"help\"=>$clang->gT(\"Is no answer (missing) allowed when either 'Equals sum value' or 'Minimum sum value' are set?\"),\n        \"caption\"=>$clang->gT(\"Value range allows missing\"));\n    }\n    //This builds a more useful array (don't modify)\n    if ($returnByName==false)\n    {\n        if(!$qat)\n        {\n            foreach($qattributes as $qname=>$qvalue)\n            {\n                for ($i=0; $i<=strlen($qvalue['types'])-1; $i++)\n                {\n                    $qat[substr($qvalue['types'], $i, 1)][$qname]=array(\"name\"=>$qname,\n                    \"inputtype\"=>$qvalue['inputtype'],\n                    \"category\"=>$qvalue['category'],\n                    \"sortorder\"=>$qvalue['sortorder'],\n                    \"i18n\"=>isset($qvalue['i18n'])?$qvalue['i18n']:false,\n                    \"readonly\"=>isset($qvalue['readonly_when_active'])?$qvalue['readonly_when_active']:false,\n                    \"options\"=>isset($qvalue['options'])?$qvalue['options']:'',\n                    \"default\"=>isset($qvalue['default'])?$qvalue['default']:'',\n                    \"help\"=>$qvalue['help'],\n                    \"caption\"=>$qvalue['caption']);\n                }\n            }\n        }\n        return $qat;\n    }\n    else {\n        return $qattributes;\n    }\n}\n\nfunction categorySort($a, $b)\n{\n    $result=strnatcasecmp($a['category'], $b['category']);\n    if ($result==0)\n    {\n        $result=$a['sortorder']-$b['sortorder'];\n    }\n    return $result;\n}\n\n\n// the opposite of the above: takes a POST or GET variable which may or\n// may not have been 'auto-quoted', and return the *unquoted* version.\n// this is useful when the value is destined for a web page (eg) not\n// a SQL query.\nfunction autoUnescape($str) {\n    if (!isset($str)) {return null;};\n    if (!get_magic_quotes_gpc())\n        return $str;\n    return stripslashes($str);\n}\n\n// make a string safe to include in an HTML 'value' attribute.\nfunction HTMLEscape($str) {\n    // escape newline characters, too, in case we put a value from\n    // a TEXTAREA  into an <input type=\"hidden\"> value attribute.\n    return str_replace(array(\"\\x0A\",\"\\x0D\"),array(\"&#10;\",\"&#13;\"),\n    htmlspecialchars( $str, ENT_QUOTES ));\n}\n\n/**\n* Escapes a text value for db\n*\n* @param string $value\n* @return string\n*/\nfunction dbQuoteAll($value)\n{\n    return Yii::app()->db->quoteValue($value);\n}\n\n// make a string safe to include in a JavaScript String parameter.\nfunction javascriptEscape($str, $strip_tags=false, $htmldecode=false) {\n    $new_str ='';\n\n    if ($htmldecode==true) {\n        $str=html_entity_decode($str,ENT_QUOTES,'UTF-8');\n    }\n    if ($strip_tags==true)\n    {\n        $str=strip_tags($str);\n    }\n    return str_replace(array('\\'','\"', \"\\n\", \"\\r\"),\n    array(\"\\\\'\",'\\u0022', \"\\\\n\",'\\r'),\n    $str);\n}\n\n/**\n* This function mails a text $body to the recipient $to.\n* You can use more than one recipient when using a semikolon separated string with recipients.\n*\n* @param string $body Body text of the email in plain text or HTML\n* @param mixed $subject Email subject\n* @param mixed $to Array with several email addresses or single string with one email address\n* @param mixed $from\n* @param mixed $sitename\n* @param mixed $ishtml\n* @param mixed $bouncemail\n* @param mixed $attachment\n* @return bool If successful returns true\n*/\nfunction SendEmailMessage($body, $subject, $to, $from, $sitename, $ishtml=false, $bouncemail=null, $attachments=null, $customheaders=\"\")\n{\n\n    global $maildebug, $maildebugbody;\n\n    $clang = Yii::app()->lang;\n    $emailmethod = Yii::app()->getConfig('emailmethod');\n    $emailsmtphost = Yii::app()->getConfig(\"emailsmtphost\");\n    $emailsmtpuser = Yii::app()->getConfig(\"emailsmtpuser\");\n    $emailsmtppassword = Yii::app()->getConfig(\"emailsmtppassword\");\n    $emailsmtpdebug = Yii::app()->getConfig(\"emailsmtpdebug\");\n    $emailsmtpssl = Yii::app()->getConfig(\"emailsmtpssl\");\n    $defaultlang = Yii::app()->getConfig(\"defaultlang\");\n    $emailcharset = Yii::app()->getConfig(\"emailcharset\");\n\n    if ($emailcharset!='utf-8')\n    {\n        $body=mb_convert_encoding($body,$emailcharset,'utf-8');\n        $subject=mb_convert_encoding($subject,$emailcharset,'utf-8');\n        $sitename=mb_convert_encoding($sitename,$emailcharset,'utf-8');\n    }\n\n    if (!is_array($to)){\n        $to=array($to);\n    }\n\n\n\n    if (!is_array($customheaders) && $customheaders == '')\n    {\n        $customheaders=array();\n    }\n    if (Yii::app()->getConfig('demoMode'))\n    {\n        $maildebug=$clang->gT('Email was not sent because demo-mode is activated.');\n        $maildebugbody='';\n        return false;\n    }\n\n    if (is_null($bouncemail) )\n    {\n        $sender=$from;\n    }\n    else\n    {\n        $sender=$bouncemail;\n    }\n\n\n    require_once(APPPATH.'/third_party/phpmailer/class.phpmailer.php');\n    $mail = new PHPMailer;\n    if (!$mail->SetLanguage($defaultlang,APPPATH.'/third_party/phpmailer/language/'))\n    {\n        $mail->SetLanguage('en',APPPATH.'/third_party/phpmailer/language/');\n    }\n    $mail->CharSet = $emailcharset;\n    if (isset($emailsmtpssl) && trim($emailsmtpssl)!=='' && $emailsmtpssl!==0) {\n        if ($emailsmtpssl===1) {$mail->SMTPSecure = \"ssl\";}\n        else {$mail->SMTPSecure = $emailsmtpssl;}\n    }\n\n    $fromname='';\n    $fromemail=$from;\n    if (strpos($from,'<'))\n    {\n        $fromemail=substr($from,strpos($from,'<')+1,strpos($from,'>')-1-strpos($from,'<'));\n        $fromname=trim(substr($from,0, strpos($from,'<')-1));\n    }\n\n    $sendername='';\n    $senderemail=$sender;\n    if (strpos($sender,'<'))\n    {\n        $senderemail=substr($sender,strpos($sender,'<')+1,strpos($sender,'>')-1-strpos($sender,'<'));\n        $sendername=trim(substr($sender,0, strpos($sender,'<')-1));\n    }\n\n    switch ($emailmethod) {\n        case \"qmail\":\n            $mail->IsQmail();\n            break;\n        case \"smtp\":\n            $mail->IsSMTP();\n            if ($emailsmtpdebug>0)\n            {\n                $mail->SMTPDebug = $emailsmtpdebug;\n            }\n            if (strpos($emailsmtphost,':')>0)\n            {\n                $mail->Host = substr($emailsmtphost,0,strpos($emailsmtphost,':'));\n                $mail->Port = substr($emailsmtphost,strpos($emailsmtphost,':')+1);\n            }\n            else {\n                $mail->Host = $emailsmtphost;\n            }\n            $mail->Username =$emailsmtpuser;\n            $mail->Password =$emailsmtppassword;\n            if (trim($emailsmtpuser)!=\"\")\n            {\n                $mail->SMTPAuth = true;\n            }\n            break;\n        case \"sendmail\":\n            $mail->IsSendmail();\n            break;\n        default:\n            //Set to the default value to rule out incorrect settings.\n            $emailmethod=\"mail\";\n            $mail->IsMail();\n    }\n\n    $mail->SetFrom($fromemail, $fromname);\n    $mail->Sender = $senderemail; // Sets Return-Path for error notifications\n    foreach ($to as $singletoemail)\n    {\n        if (strpos($singletoemail, '<') )\n        {\n            $toemail=substr($singletoemail,strpos($singletoemail,'<')+1,strpos($singletoemail,'>')-1-strpos($singletoemail,'<'));\n            $toname=trim(substr($singletoemail,0, strpos($singletoemail,'<')-1));\n            $mail->AddAddress($toemail,$toname);\n        }\n        else\n        {\n            $mail->AddAddress($singletoemail);\n        }\n    }\n    if (is_array($customheaders))\n    {\n        foreach ($customheaders as $key=>$val) {\n            $mail->AddCustomHeader($val);\n        }\n    }\n    $mail->AddCustomHeader(\"X-Surveymailer: $sitename Emailer (LimeSurvey.sourceforge.net)\");\n    if (get_magic_quotes_gpc() != \"0\")    {$body = stripcslashes($body);}\n    if ($ishtml)\n    {\n        $mail->IsHTML(true);\n        //$mail->AltBody = strip_tags(breakToNewline(html_entity_decode($body,ENT_QUOTES,$emailcharset))); // Use included PHPmailer system see bug #8234\n    }\n    else\n    {\n        $mail->IsHTML(false);\n    }\n    $mail->Body = $body;\n    // Add attachments if they are there.\n    if (is_array($attachments))\n    {\n        foreach ($attachments as $attachment)\n        {\n            // Attachment is either an array with filename and attachment name.\n            if (is_array($attachment))\n            {\n                $mail->AddAttachment($attachment[0], $attachment[1]);\n            }\n            else \n            { // Or a string with the filename.\n                $mail->AddAttachment($attachment);\n            }\n        }\n    }\n\n    if (trim($subject)!='') {$mail->Subject = \"=?$emailcharset?B?\" . base64_encode($subject) . \"?=\";}\n    if ($emailsmtpdebug>0) {\n        ob_start();\n    }\n    $sent=$mail->Send();\n    $maildebug=$mail->ErrorInfo;\n    if ($emailsmtpdebug>0) {\n        $maildebug .= '<li>'. gT('SMTP debug output:').'</li><pre>'.strip_tags(ob_get_contents()).'</pre>';\n        ob_end_clean();\n    }\n    $maildebugbody=$mail->Body;\n    //if(!$sent) var_dump($maildebug);\n    return $sent;\n}\n\n\n/**\n*  This functions removes all HTML tags, Javascript, CRs, linefeeds and other strange chars from a given text\n*\n* @param string $sTextToFlatten  Text you want to clean\n* @param boolan $keepSpan set to true for keep span, used for expression manager. Default: false\n* @param boolan $bDecodeHTMLEntities If set to true then all HTML entities will be decoded to the specified charset. Default: false\n* @param string $sCharset Charset to decode to if $decodeHTMLEntities is set to true. Default: UTF-8\n* @param string $bStripNewLines strip new lines if true, if false replace all new line by \\r\\n. Default: true\n*\n* @return string  Cleaned text\n*/\nfunction flattenText($sTextToFlatten, $keepSpan=false, $bDecodeHTMLEntities=false, $sCharset='UTF-8', $bStripNewLines=true)\n{\n    $sNicetext = stripJavaScript($sTextToFlatten);\n    // When stripping tags, add a space before closing tags so that strings with embedded HTML tables don't get concatenated\n    $sNicetext = str_replace(array('</td','</th'),array(' </td',' </th'), $sNicetext);\n    if ($keepSpan) {\n        // Keep <span> so can show EM syntax-highlighting; add space before tags so that word-wrapping not destroyed when remove tags.\n        $sNicetext = strip_tags($sNicetext,'<span><table><tr><td><th>');\n    }\n    else {\n        $sNicetext = strip_tags($sNicetext);\n    }\n    // ~\\R~u : see \"What \\R matches\" and \"Newline sequences\" in http://www.pcre.org/pcre.txt - only available since PCRE 7.0\n    if ($bStripNewLines ){  // strip new lines\n        if (version_compare(substr(PCRE_VERSION,0,strpos(PCRE_VERSION,' ')),'7.0')>-1)\n        {\n            $sNicetext = preg_replace(array('~\\R~u'),array(' '), $sNicetext);\n        }\n        else\n        {\n            // Poor man's replacement for line feeds\n            $sNicetext = str_replace(array(\"\\r\\n\",\"\\n\", \"\\r\"), array(' ',' ',' '), $sNicetext);\n        }\n    }\n    elseif (version_compare(substr(PCRE_VERSION,0,strpos(PCRE_VERSION,' ')),'7.0')>-1)// unify newlines to \\r\\n\n    {\n        $sNicetext = preg_replace(array('~\\R~u'), array(\"\\r\\n\"), $sNicetext);\n    }\n    if ($bDecodeHTMLEntities==true)\n    {\n        $sNicetext = str_replace('&nbsp;',' ', $sNicetext); // html_entity_decode does not convert &nbsp; to spaces\n        $sNicetext = html_entity_decode($sNicetext, ENT_QUOTES, $sCharset);\n    }\n    $sNicetext = trim($sNicetext);\n    return  $sNicetext;\n}\n\n\n/**\n* getArrayFilterExcludesCascadesForGroup() queries the database and produces a list of array_filter_exclude questions and targets with in the same group\n* @return returns a keyed nested array, keyed by the qid of the question, containing cascade information\n*/\nfunction getArrayFilterExcludesCascadesForGroup($surveyid, $gid=\"\", $output=\"qid\")\n{\n    $surveyid=sanitize_int($surveyid);\n    $gid=sanitize_int($gid);\n\n    $cascaded=array();\n    $sources=array();\n    $qidtotitle=array();\n    $fieldmap = createFieldMap($surveyid,'full',false,false,getBaseLanguageFromSurveyID($surveyid));\n\n    if($gid != \"\") {\n        $qrows = arraySearchByKey($gid, $fieldmap, 'gid');\n    } else {\n        $qrows = $fieldmap;\n    }\n    $grows = array(); //Create an empty array in case query not return any rows\n    // Store each result as an array with in the $grows array\n    foreach ($qrows as $qrow) {\n        if (isset($qrow['gid']) && !empty($qrow['gid'])) {\n            $grows[$qrow['qid']] = array('qid' => $qrow['qid'],'type' => $qrow['type'], 'mandatory' => $qrow['mandatory'], 'title' => $qrow['title'], 'gid' => $qrow['gid']);\n        }\n    }\n    $attrmach = array(); // Stores Matches of filters that have their values as questions within current group\n    foreach ($grows as $qrow) // Cycle through questions to see if any have list_filter attributes\n    {\n        $qidtotitle[$qrow['qid']]=$qrow['title'];\n        $qresult = getQuestionAttributeValues($qrow['qid'],$qrow['type']);\n        if (isset($qresult['array_filter_exclude'])) // We Found a array_filter attribute\n        {\n            $val = $qresult['array_filter_exclude']; // Get the Value of the Attribute ( should be a previous question's title in same group )\n            foreach ($grows as $avalue) // Cycle through all the other questions in this group until we find the source question for this array_filter\n            {\n                if ($avalue['title'] == $val)\n                {\n                    /* This question ($avalue) is the question that provides the source information we use\n                    * to determine which answers show up in the question we're looking at, which is $qrow['qid']\n                    * So, in other words, we're currently working on question $qrow['qid'], trying to find out more\n                    * information about question $avalue['qid'], because that's the source */\n                    $sources[$qrow['qid']]=$avalue['qid']; /* This question ($qrow['qid']) relies on answers in $avalue['qid'] */\n                    if(isset($cascades)) {unset($cascades);}\n                    $cascades=array();                     /* Create an empty array */\n\n                    /* At this stage, we know for sure that this question relies on one other question for the filter */\n                    /* But this function wants to send back information about questions that rely on multiple other questions for the filter */\n                    /* So we don't want to do anything yet */\n\n                    /* What we need to do now, is check whether the question this one relies on, also relies on another */\n\n                    /* The question we are now checking is $avalue['qid'] */\n                    $keepgoing=1;\n                    $questiontocheck=$avalue['qid'];\n                    /* If there is a key in the $sources array that is equal to $avalue['qid'] then we want to add that\n                    * to the $cascades array */\n                    while($keepgoing > 0)\n                    {\n                        if(!empty($sources[$questiontocheck]))\n                        {\n                            $cascades[] = $sources[$questiontocheck];\n                            /* Now we need to move down the chain */\n                            /* We want to check the $sources[$questiontocheck] question */\n                            $questiontocheck=$sources[$questiontocheck];\n                        } else {\n                            /* Since it was empty, there must not be any more questions down the cascade */\n                            $keepgoing=0;\n                        }\n                    }\n                    /* Now add all that info */\n                    if(count($cascades) > 0) {\n                        $cascaded[$qrow['qid']]=$cascades;\n                    }\n                }\n            }\n        }\n    }\n    $cascade2=array();\n    if($output == \"title\")\n    {\n        foreach($cascaded as $key=>$cascade) {\n            foreach($cascade as $item)\n            {\n                $cascade2[$key][]=$qidtotitle[$item];\n            }\n        }\n        $cascaded=$cascade2;\n    }\n    return $cascaded;\n}\n\n\n\n/**\n* getArrayFiltersForQuestion($qid) finds out if a question has an array_filter attribute and what codes where selected on target question\n* @return returns an array of codes that were selected else returns false\n*/\nfunction getArrayFiltersForQuestion($qid)\n{\n    static $cache = array();\n\n    // TODO: Check list_filter values to make sure questions are previous?\n    $qid=sanitize_int($qid);\n    if (isset($cache[$qid])) return $cache[$qid];\n\n    $attributes = getQuestionAttributeValues($qid);\n    if (isset($attributes['array_filter']) && Yii::app()->session['fieldarray']) {\n        $val = $attributes['array_filter']; // Get the Value of the Attribute ( should be a previous question's title in same group )\n        foreach (Yii::app()->session['fieldarray'] as $fields)\n        {\n            if ($fields[2] == $val)\n            {\n                // we found the target question, now we need to know what the answers where, we know its a multi!\n                $fields[0]=sanitize_int($fields[0]);\n                //$query = \"SELECT title FROM \".db_table_name('questions').\" where parent_qid='{$fields[0]}' AND language='\".Yii::app()->session[$surveyid]['s_lang'].\"' order by question_order\";\n                $qresult=Question::model()->findAllByAttributes(array(\"parent_qid\"=> $fields[0], \"language\"=> Yii::app()->session[$surveyid]['s_lang']), array('order' => \"question_order\"));\n                $selected = array();\n                //while ($code = $qresult->fetchRow())\n                foreach ($qresult->readAll() as $code)\n                {\n                    if (Yii::app()->session[$fields[1].$code['title']] == \"Y\"\n                    || Yii::app()->session[$fields[1]] == $code['title'])             array_push($selected,$code['title']);\n                }\n\n                //Now we also need to find out if (a) the question had \"other\" enabled, and (b) if that was selected\n                //$query = \"SELECT other FROM \".db_table_name('questions').\" where qid='{$fields[0]}'\";\n                $qresult=Question::model()->findAllByAttributes(array(\"qid\"=>$fields[0]));\n                foreach ($qresult->readAll() as $row) {$other=$row['other'];}\n                if($other == \"Y\")\n                {\n                    if(Yii::app()->session[$fields[1].'other'] && Yii::app()->session[$fields[1].'other'] !=\"\") {array_push($selected, \"other\");}\n                }\n                $cache[$qid] = $selected;\n                return $cache[$qid];\n            }\n        }\n        $cache[$qid] = false;\n        return $cache[$qid];\n    }\n    $cache[$qid] = false;\n    return $cache[$qid];\n}\n\n/**\n* getGroupsByQuestion($surveyid)\n* @return returns a keyed array of groups to questions ie: array([1]=>[2]) question qid 1, is in group gid 2.\n*/\nfunction getGroupsByQuestion($surveyid) {\n    $output=array();\n\n    $surveyid=sanitize_int($surveyid);\n    $result=Question::model()->findAllByAttributes(array(\"sid\"=>$surveyid));\n\n    foreach ($qresult->readAll() as $val)\n    {\n        $output[$val['qid']]=$val['gid'];\n    }\n    return $output;\n}\n\n\n/**\n* getArrayFilterExcludesForQuestion($qid) finds out if a question has an array_filter_exclude attribute and what codes where selected on target question\n* @return returns an array of codes that were selected else returns false\n*/\nfunction getArrayFilterExcludesForQuestion($qid)\n{\n    static $cascadesCache = array();\n    static $cache = array();\n\n    // TODO: Check list_filter values to make sure questions are previous?\n    //    $surveyid = Yii::app()->getConfig('sid');\n    $surveyid=returnGlobal('sid');\n    $qid=sanitize_int($qid);\n\n    if (isset($cache[$qid])) return $cache[$qid];\n\n    $attributes = getQuestionAttributeValues($qid);\n    $excludevals=array();\n    if (isset($attributes['array_filter_exclude'])) // We Found a array_filter_exclude attribute\n    {\n        $selected=array();\n        $excludevals[] = $attributes['array_filter_exclude']; // Get the Value of the Attribute ( should be a previous question's title in same group )\n        /* Find any cascades and place them in the $excludevals array*/\n        if (!isset($cascadesCache[$surveyid])) {\n            $cascadesCache[$surveyid] = getArrayFilterExcludesCascadesForGroup($surveyid, \"\", \"title\");\n        }\n        $array_filterXqs_cascades = $cascadesCache[$surveyid];\n\n        if(isset($array_filterXqs_cascades[$qid]))\n        {\n            foreach($array_filterXqs_cascades[$qid] as $afc)\n            {\n                $excludevals[]=array(\"value\"=>$afc);\n\n            }\n        }\n        /* For each $val (question title) that applies to this, check what values exist and add them to the $selected array */\n        foreach ($excludevals as $val)\n        {\n            foreach (Yii::app()->session['fieldarray'] as $fields) //iterate through every question in the survey\n            {\n                if ($fields[2] == $val)\n                {\n                    // we found the target question, now we need to know what the answers were!\n                    $fields[0]=sanitize_int($fields[0]);\n                    $query = \"SELECT title FROM {{questions}} where parent_qid='{$fields[0]}' AND language='\".Yii::app()->session[$surveyid]['s_lang'].\"' order by question_order\";\n                    $qresult = dbExecuteAssoc($query);  //Checked\n                    foreach ($qresult->readAll() as $code)\n                    {\n                        if (isset(Yii::app()->session[$fields[1]]))\n                            if ((isset(Yii::app()->session[$fields[1].$code['title']]) && Yii::app()->session[$fields[1].$code['title']] == \"Y\")\n                            || Yii::app()->session[$fields[1]] == $code['title'])\n                                array_push($selected,$code['title']);\n                    }\n                    //Now we also need to find out if (a) the question had \"other\" enabled, and (b) if that was selected\n                    $query = \"SELECT other FROM {{questions}} where qid='{$fields[0]}'\";\n                    $qresult = dbExecuteAssoc($query);\n                    foreach ($qresult->readAll() as $row) {$other=$row['other'];}\n                    if($other == \"Y\")\n                    {\n                        if(Yii::app()->session[$fields[1].'other'] != \"\") {array_push($selected, \"other\");}\n                    }\n                }\n            }\n        }\n        if(count($selected) > 0)\n        {\n            $cache[$qid] = $selected;\n            return $cache[$qid];\n        } else {\n            $cache[$qid] = false;\n            return $cache[$qid];\n        }\n    }\n    $cache[$qid] = false;\n    return $cache[$qid];\n}\n\n\n\nfunction CSVEscape($sString)\n{\n    $sString = preg_replace(array('~\\R~u'), array(PHP_EOL), $sString);\n    return '\"' . str_replace('\"','\"\"', $sString) . '\"';\n}\n\nfunction convertCSVRowToArray($string, $separator, $quotechar)\n{\n    $fields=preg_split('/' . $separator . '(?=([^\"]*\"[^\"]*\")*(?![^\"]*\"))/',trim($string));\n    $fields=array_map('CSVUnquote',$fields);\n    return $fields;\n}\n\nfunction createPassword()\n{\n    $aCharacters = \"ABCDEGHJIKLMNOPQURSTUVWXYZabcdefhjmnpqrstuvwxyz23456789\";\n    $iPasswordLength = 12;\n    $sPassword = '';\n    for ($i=0; $i<$iPasswordLength; $i++)\n    {\n        $sPassword .= $aCharacters[(int)floor(rand(0,strlen($aCharacters)-1))];\n    }\n    return $sPassword;\n}\n\nfunction languageDropdown($surveyid,$selected)\n{\n\n    $homeurl = Yii::app()->getConfig('homeurl');\n    $slangs = Survey::model()->findByPk($surveyid)->additionalLanguages;\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    array_unshift($slangs,$baselang);\n    $html = \"<select class='listboxquestions' name='langselect' onchange=\\\"window.open(this.options[this.selectedIndex].value, '_top')\\\">\\n\";\n\n    foreach ($slangs as $lang)\n    {\n        $link = Yii::app()->homeUrl.(\"/admin/dataentry/sa/view/surveyid/\".$surveyid.\"/lang/\".$lang);\n        if ($lang == $selected) $html .= \"\\t<option value='{$link}' selected='selected'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n        if ($lang != $selected) $html .= \"\\t<option value='{$link}'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n    }\n    $html .= \"</select>\";\n    return $html;\n}\n\nfunction languageDropdownClean($surveyid,$selected)\n{\n    $slangs = Survey::model()->findByPk($surveyid)->additionalLanguages;\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    array_unshift($slangs,$baselang);\n    $html = \"<select class='listboxquestions' id='language' name='language'>\\n\";\n    foreach ($slangs as $lang)\n    {\n        if ($lang == $selected) $html .= \"\\t<option value='$lang' selected='selected'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n        if ($lang != $selected) $html .= \"\\t<option value='$lang'>\".getLanguageNameFromCode($lang,false).\"</option>\\n\";\n    }\n    $html .= \"</select>\";\n    return $html;\n}\n\n/**\n* This function removes a directory recursively\n*\n* @param mixed $dirname\n* @return bool\n*/\nfunction rmdirr($dirname)\n{\n    // Sanity check\n    if (!file_exists($dirname)) {\n        return false;\n    }\n\n    // Simple delete for a file\n    if (is_file($dirname) || is_link($dirname)) {\n        return @unlink($dirname);\n    }\n\n    // Loop through the folder\n    $dir = dir($dirname);\n    while (false !== $entry = $dir->read()) {\n        // Skip pointers\n        if ($entry == '.' || $entry == '..') {\n            continue;\n        }\n\n        // Recurse\n        rmdirr($dirname . DIRECTORY_SEPARATOR . $entry);\n    }\n\n    // Clean up\n    $dir->close();\n    return @rmdir($dirname);\n}\n\n/**\n* This function removes surrounding and masking quotes from the CSV field\n*\n* @param mixed $field\n* @return mixed\n*/\nfunction CSVUnquote($field)\n{\n    //print $field.\":\";\n    $field = preg_replace (\"/^\\040*\\\"/\", \"\", $field);\n    $field = preg_replace (\"/\\\"\\040*$/\", \"\", $field);\n    $field= str_replace('\"\"','\"',$field);\n    //print $field.\"\\n\";\n    return $field;\n}\n\n/**\n* This function return actual completion state\n*\n* @return string (complete|incomplete|all) or false\n*/\nfunction incompleteAnsFilterState()\n{\n    $letsfilter='';\n    $letsfilter = returnGlobal('completionstate'); //read get/post completionstate\n\n    // first let's initialize the incompleteanswers session variable\n    if ($letsfilter != '')\n    { // use the read value if not empty\n        Yii::app()->session['incompleteanswers'] = $letsfilter;\n    }\n    elseif (empty(Yii::app()->session['incompleteanswers']))\n    { // sets default variable value from config file\n        Yii::app()->session['incompleteanswers'] = Yii::app()->getConfig('filterout_incomplete_answers');\n    }\n\n    if  (Yii::app()->session['incompleteanswers']=='complete' || Yii::app()->session['incompleteanswers']=='all' || Yii::app()->session['incompleteanswers']=='incomplete') {\n        return Yii::app()->session['incompleteanswers'];\n    }\n    else\n    { // last resort is to prevent filtering\n        return false;\n    }\n}\n\n\n/**\n* isCaptchaEnabled($screen, $usecaptchamode)\n* @param string $screen - the screen name for which to test captcha activation\n*\n* @return boolean - returns true if captcha must be enabled\n**/\nfunction isCaptchaEnabled($screen, $captchamode='')\n{\n    switch($screen)\n    {\n        case 'registrationscreen':\n            if ($captchamode == 'A' ||\n            $captchamode == 'B' ||\n            $captchamode == 'D' ||\n            $captchamode == 'R')\n            {\n                return true;\n            }\n            else\n            {\n                return false;\n            }\n            break;\n        case 'surveyaccessscreen':\n            if ($captchamode == 'A' ||\n            $captchamode == 'B' ||\n            $captchamode == 'C' ||\n            $captchamode == 'X')\n            {\n                return true;\n            }\n            else\n            {\n                return false;\n            }\n            break;\n        case 'saveandloadscreen':\n            if ($captchamode == 'A' ||\n            $captchamode == 'C' ||\n            $captchamode == 'D' ||\n            $captchamode == 'S')\n            {\n                return true;\n            }\n            else\n            {\n                return false;\n            }\n            return true;\n            break;\n        default:\n            return true;\n            break;\n    }\n}\n\n/**\n* used for import[survey|questions|groups]\n*\n* @param mixed $string\n* @return mixed\n*/\nfunction convertCSVReturnToReturn($string)\n{\n    $string= str_replace('\\n', \"\\n\", $string);\n    return str_replace('\\%n', '\\n', $string);\n}\n\n/**\n* Check if a table does exist in the database\n*\n* @param string $sTableName Table name to check for (without dbprefix!))\n* @return boolean True or false if table exists or not\n*/\nfunction tableExists($sTableName)\n{\n    $sTableName=Yii::app()->db->tablePrefix.str_replace(array('{','}'),array('',''),$sTableName);\n    return in_array($sTableName,Yii::app()->db->schema->getTableNames());\n}\n\n// Returns false if the survey is anonymous,\n// and a token table exists: in this case the completed field of a token\n// will contain 'Y' instead of the submitted date to ensure privacy\n// Returns true otherwise\nfunction isTokenCompletedDatestamped($thesurvey)\n{\n    if ($thesurvey['anonymized'] == 'Y' &&  tableExists('tokens_'.$thesurvey['sid']))\n    {\n        return false;\n    }\n    else\n    {\n        return true;\n    }\n}\n\n/**\n* example usage\n* $date = \"2006-12-31 21:00\";\n* $shift \"+6 hours\"; // could be days, weeks... see function strtotime() for usage\n*\n* echo sql_date_shift($date, \"Y-m-d H:i:s\", $shift);\n*\n* will output: 2007-01-01 03:00:00\n*\n* @param mixed $date\n* @param mixed $dformat\n* @param mixed $shift\n* @return string\n*/\nfunction dateShift($date, $dformat, $shift)\n{\n    return date($dformat, strtotime($shift, strtotime($date)));\n}\n\n\n// getBounceEmail: returns email used to receive error notifications\nfunction getBounceEmail($surveyid)\n{\n    $surveyInfo=getSurveyInfo($surveyid);\n\n    if ($surveyInfo['bounce_email'] == '')\n    {\n        return null; // will be converted to from in MailText\n    }\n    else\n    {\n        return $surveyInfo['bounce_email'];\n    }\n}\n\n// getEmailFormat: returns email format for the survey\n// returns 'text' or 'html'\nfunction getEmailFormat($surveyid)\n{\n    $surveyInfo=getSurveyInfo($surveyid);\n    if ($surveyInfo['htmlemail'] == 'Y')\n    {\n        return 'html';\n    }\n    else\n    {\n        return 'text';\n    }\n\n}\n\n// Check if user has manage rights for a template\nfunction hasTemplateManageRights($userid, $templatefolder) {\n    $userid=sanitize_int($userid);\n    $templatefolder=sanitize_paranoid_string($templatefolder);\n    return Permission::model()->hasTemplatePermission($templatefolder, 'read', $userid);\n}\n\n/**\n* This function creates an incrementing answer code based on the previous source-code\n*\n* @param mixed $sourcecode The previous answer code\n*/\nfunction getNextCode($sourcecode)\n{\n    $i=1;\n    $found=true;\n    $foundnumber=-1;\n    while ($i<=strlen($sourcecode) && $found)\n    {\n        $found=is_numeric(substr($sourcecode,-$i));\n        if ($found)\n        {\n            $foundnumber=substr($sourcecode,-$i);\n            $i++;\n        }\n    }\n    if ($foundnumber==-1)\n    {\n        return($sourcecode);\n    }\n    else\n    {\n        $foundnumber++;\n        $result=substr($sourcecode,0,strlen($sourcecode)-strlen($foundnumber)).$foundnumber;\n        return($result);\n    }\n\n}\n\n/**\n* Translate links which are in any answer/question/survey/email template/label set to their new counterpart\n*\n* @param mixed $sType 'survey' or 'label'\n* @param mixed $iOldSurveyID\n* @param mixed $iNewSurveyID\n* @param mixed $sString\n* @return string\n*/\nfunction translateLinks($sType, $iOldSurveyID, $iNewSurveyID, $sString)\n{\n    if ($sType == 'survey')\n    {\n        $sPattern = \"([^'\\\"]*)/upload/surveys/{$iOldSurveyID}/\";\n        $sReplace = Yii::app()->getConfig(\"publicurl\").\"upload/surveys/{$iNewSurveyID}/\";\n        return preg_replace('#'.$sPattern.'#', $sReplace, $sString);\n    }\n    elseif ($sType == 'label')\n    {\n        $pattern = \"([^'\\\"]*)/upload/labels/{$iOldSurveyID}/\";\n        $replace = Yii::app()->getConfig(\"publicurl\").\"upload/labels/{$iNewSurveyID}/\";\n        return preg_replace('#'.$pattern.'#', $replace, $sString);\n    }\n    else // unkown type\n    {\n        return $sString;\n    }\n}\n\n/**\n* This function creates the old fieldnames for survey import\n*\n* @param mixed $iOldSID  The old survey id\n* @param mixed $iNewSID  The new survey id\n* @param array $aGIDReplacements An array with group ids (oldgid=>newgid)\n* @param array $aQIDReplacements An array with question ids (oldqid=>newqid)\n*/\nfunction reverseTranslateFieldNames($iOldSID,$iNewSID,$aGIDReplacements,$aQIDReplacements)\n{\n    $aGIDReplacements=array_flip($aGIDReplacements);\n    $aQIDReplacements=array_flip($aQIDReplacements);\n    if ($iOldSID==$iNewSID) {\n        $forceRefresh=true; // otherwise grabs the cached copy and throws undefined index exceptions\n    }\n    else {\n        $forceRefresh=false;\n    }\n    $aFieldMap = createFieldMap($iNewSID,'short',$forceRefresh,false,getBaseLanguageFromSurveyID($iNewSID));\n\n    $aFieldMappings=array();\n    foreach ($aFieldMap as $sFieldname=>$aFieldinfo)\n    {\n        if ($aFieldinfo['qid']!=null)\n        {\n            $aFieldMappings[$sFieldname]=$iOldSID.'X'.$aGIDReplacements[$aFieldinfo['gid']].'X'.$aQIDReplacements[$aFieldinfo['qid']].$aFieldinfo['aid'];\n            if ($aFieldinfo['type']=='1')\n            {\n                $aFieldMappings[$sFieldname]=$aFieldMappings[$sFieldname].'#'.$aFieldinfo['scale_id'];\n            }\n            // now also add a shortened field mapping which is needed for certain kind of condition mappings\n            $aFieldMappings[$iNewSID.'X'.$aFieldinfo['gid'].'X'.$aFieldinfo['qid']]=$iOldSID.'X'.$aGIDReplacements[$aFieldinfo['gid']].'X'.$aQIDReplacements[$aFieldinfo['qid']];\n            // Shortened field mapping for timings table\n            $aFieldMappings[$iNewSID.'X'.$aFieldinfo['gid']]=$iOldSID.'X'.$aGIDReplacements[$aFieldinfo['gid']];\n        }\n    }\n    return array_flip($aFieldMappings);\n}\n\n/**\n* put your comment there...\n*\n* @param mixed $id\n* @param mixed $type\n*/\nfunction hasResources($id,$type='survey')\n{\n    $dirname = Yii::app()->getConfig(\"uploaddir\");\n\n    if ($type == 'survey')\n    {\n        $dirname .= \"/surveys/$id\";\n    }\n    elseif ($type == 'label')\n    {\n        $dirname .= \"/labels/$id\";\n    }\n    else\n    {\n        return false;\n    }\n\n    if (is_dir($dirname) && $dh=opendir($dirname))\n    {\n        while(($entry = readdir($dh)) !== false)\n        {\n            if($entry !== '.' && $entry !== '..')\n            {\n                return true;\n                break;\n            }\n        }\n        closedir($dh);\n    }\n    else\n    {\n        return false;\n    }\n\n    return false;\n}\n\n/**\n* Creates a random sequence of characters\n*\n* @param mixed $length Length of resulting string\n* @param string $pattern To define which characters should be in the resulting string\n*/\nfunction randomChars($length,$pattern=\"23456789abcdefghijkmnpqrstuvwxyz\")\n{\n    $patternlength = strlen($pattern)-1;\n    $key = '';\n    for($i=0;$i<$length;$i++)\n    {\n        $key .= $pattern{mt_rand(0,$patternlength)};\n    }\n    return $key;\n}\n\n/**\n* used to translate simple text to html (replacing \\n with <br />\n*\n* @param mixed $mytext\n* @param mixed $ishtml\n* @return mixed\n*/\nfunction conditionalNewlineToBreak($mytext,$ishtml,$encoded='')\n{\n    if ($ishtml === true)\n    {\n        // $mytext has been processed by clang->gT with html mode\n        // and thus \\n has already been translated to &#10;\n        if ($encoded == '')\n        {\n            $mytext=str_replace('&#10;', '<br />',$mytext);\n        }\n        return str_replace(\"\\n\", '<br />',$mytext);\n    }\n    else\n    {\n        return $mytext;\n    }\n}\n\n\nfunction breakToNewline( $data ) {\n    return preg_replace( '!<br.*>!iU', \"\\n\", $data );\n}\n\nfunction safeDie($text)\n{\n    //Only allowed tag: <br />\n    $textarray=explode('<br />',$text);\n    $textarray=array_map('htmlspecialchars',$textarray);\n    die(implode( '<br />',$textarray));\n}\n\nfunction fixCKeditorText($str)\n{\n    $str = str_replace('<br type=\"_moz\" />','',$str);\n    if ($str == \"<br />\" || $str == \" \" || $str == \"&nbsp;\")\n    {\n        $str = \"\";\n    }\n    if (preg_match(\"/^[\\s]+$/\",$str))\n    {\n        $str='';\n    }\n    if ($str == \"\\n\")\n    {\n        $str = \"\";\n    }\n    if (trim($str) == \"&nbsp;\" || trim($str)=='')\n    { // chrome adds a single &nbsp; element to empty fckeditor fields\n        $str = \"\";\n    }\n\n    return $str;\n}\n\n\n/**\n* This is a helper function for getAttributeFieldNames\n*\n* @param mixed $fieldname\n*/\nfunction filterForAttributes ($fieldname)\n{\n    if (strpos($fieldname,'attribute_')===false) return false; else return true;\n}\n\n/**\n* Retrieves the attribute field names from the related token table\n*\n* @param mixed $iSurveyID  The survey ID\n* @return array The fieldnames\n*/\nfunction GetAttributeFieldNames($iSurveyID)\n{\n    if (!tableExists(\"{{tokens_{$iSurveyID}}}\") || !$table = Yii::app()->db->schema->getTable('{{tokens_'.$iSurveyID.'}}'))\n        return Array();\n\n    return array_filter(array_keys($table->columns), 'filterForAttributes');\n\n}\n\n/**\n* Returns the full list of attribute token fields including the properties for each field\n* Use this instead of plain Survey::model()->findByPk($iSurveyID)->tokenAttributes calls because Survey::model()->findByPk($iSurveyID)->tokenAttributes may contain old descriptions where the fields does not physically exist\n*\n* @param integer $iSurveyID The Survey ID\n*/\nfunction GetParticipantAttributes($iSurveyID)\n{\n    if (!tableExists(\"{{tokens_{$iSurveyID}}}\") || !$table = Yii::app()->db->schema->getTable('{{tokens_'.$iSurveyID.'}}'))\n        return Array();\n    return getTokenFieldsAndNames($iSurveyID,true);\n}\n\n\n\n\n\n/**\n* Retrieves the token field names usable for conditions from the related token table\n*\n* @param mixed $surveyid  The survey ID\n* @return array The fieldnames\n*/\nfunction getTokenConditionsFieldNames($surveyid)\n{\n    $extra_attrs=getAttributeFieldNames($surveyid);\n    $basic_attrs=Array('firstname','lastname','email','token','language','sent','remindersent','remindercount');\n    return array_merge($basic_attrs,$extra_attrs);\n}\n\n/**\n* Retrieves the attribute names from the related token table\n*\n* @param mixed $surveyid  The survey ID\n* @param boolean $bOnlyAttributes Set this to true if you only want the fieldnames of the additional attribue fields - defaults to false\n* @return array The fieldnames as key and names as value in an Array\n*/\nfunction getTokenFieldsAndNames($surveyid, $bOnlyAttributes = false)\n{\n    $clang = Yii::app()->lang;\n\n    $aBasicTokenFields=array('firstname'=>array(\n        'description'=>$clang->gT('First name'),\n        'mandatory'=>'N',\n        'showregister'=>'Y'\n        ),\n        'lastname'=>array(\n            'description'=>$clang->gT('Last name'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'email'=>array(\n            'description'=>$clang->gT('Email address'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'emailstatus'=>array(\n            'description'=>$clang->gT(\"Email status\"),\n            'mandatory'=>'N',\n            'showregister'=>'N'\n        ),\n        'token'=>array(\n            'description'=>$clang->gT('Token'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'language'=>array(\n            'description'=>$clang->gT('Language code'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'sent'=>array(\n            'description'=>$clang->gT('Invitation sent date'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'remindersent'=>array(\n            'description'=>$clang->gT('Last reminder sent date'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'remindercount'=>array(\n            'description'=>$clang->gT('Total numbers of sent reminders'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n        'usesleft'=>array(\n            'description'=>$clang->gT('Uses left'),\n            'mandatory'=>'N',\n            'showregister'=>'Y'\n        ),\n    );\n\n    $aExtraTokenFields=getAttributeFieldNames($surveyid);\n    $aSavedExtraTokenFields = Survey::model()->findByPk($surveyid)->tokenAttributes;\n\n    // Drop all fields that are in the saved field description but not in the table definition\n    $aSavedExtraTokenFields=array_intersect_key($aSavedExtraTokenFields,array_flip($aExtraTokenFields));\n\n    // Now add all fields that are in the table but not in the field description\n    foreach ($aExtraTokenFields as $sField)\n    {\n        if (!isset($aSavedExtraTokenFields[$sField]))\n        {\n            $aSavedExtraTokenFields[$sField]=array(\n            'description'=>$sField,\n            'mandatory'=>'N',\n            'showregister'=>'N',\n            'cpdbmap'=>''\n            );\n        }\n        elseif(empty($aSavedExtraTokenFields[$sField]['description']))\n        {\n            $aSavedExtraTokenFields[$sField]['description']=$sField;\n        }\n    }\n    if ($bOnlyAttributes)\n    {\n        return $aSavedExtraTokenFields;\n    }\n    else\n    {\n        return array_merge($aBasicTokenFields,$aSavedExtraTokenFields);\n    }\n}\n\n/**\n* Retrieves the token attribute value from the related token table\n*\n* @param mixed $surveyid  The survey ID\n* @param mixed $attrName  The token-attribute field name\n* @param mixed $token  The token code\n* @return string The token attribute value (or null on error)\n*/\nfunction getAttributeValue($surveyid,$attrName,$token)\n{\n    $attrName=strtolower($attrName);\n    if (!tableExists('tokens_'.$surveyid))\n    {\n        return null;\n    }\n\n    $token = Token::model($surveyid)->findByAttributes(array(\"token\"=>$token));\n    return isset($token->$attrName) ? $token->$attrName : null;\n}\n\n/**\n* This function strips any content between and including <javascript> tags\n*\n* @param string $sContent String to clean\n* @return string  Cleaned string\n*/\nfunction stripJavaScript($sContent){\n    $text = preg_replace('@<script[^>]*?>.*?</script>@si', '', $sContent);\n    return $text;\n}\n\n/**\n* This function converts emebedded Javascript to Text\n*\n* @param string $sContent String to clean\n* @return string  Cleaned string\n*/\nfunction showJavaScript($sContent){\n    $text = preg_replace_callback ('@<script[^>]*?>.*?</script>@si',         create_function(\n            // single quotes are essential here,\n            // or alternative escape all $ as \\$\n            '$matches',\n            'return htmlspecialchars($matches[0]);'\n        ), $sContent);\n    return $text;\n}\n\n/**\n* This function cleans files from the temporary directory being older than 1 day\n* @todo Make the days configurable\n*/\nfunction cleanTempDirectory()\n{\n    $dir =  Yii::app()->getConfig('tempdir').DIRECTORY_SEPARATOR;\n    $dp = opendir($dir) or show_error('Could not open temporary directory');\n    while ($file = readdir($dp)) {\n        if (is_file($dir.$file) && (filemtime($dir.$file)) < (strtotime('-1 days')) && $file!='index.html' && $file!='.gitignore' && $file!='readme.txt') {\n            @unlink($dir.$file);\n        }\n    }\n    $dir=  Yii::app()->getConfig('tempdir').DIRECTORY_SEPARATOR.'upload'.DIRECTORY_SEPARATOR;\n    $dp = opendir($dir) or die ('Could not open temporary upload directory');\n    while ($file = readdir($dp)) {\n        if (is_file($dir.$file) && (filemtime($dir.$file)) < (strtotime('-1 days')) && $file!='index.html' && $file!='.gitignore' && $file!='readme.txt') {\n            @unlink($dir.$file);\n        }\n    }\n    closedir($dp);\n}\n\nfunction useFirebug()\n{\n    if(FIREBUG == true)\n    {\n        App()->getClientScript()->registerScriptFile('http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js');\n    };\n};\n\n/**\n* This is a convenience function for the coversion of datetime values\n*\n* @param mixed $value\n* @param mixed $fromdateformat\n* @param mixed $todateformat\n* @return string\n*/\nfunction convertDateTimeFormat($value, $fromdateformat, $todateformat)\n{\n    Yii::import('application.libraries.Date_Time_Converter', true);\n    $date = new Date_Time_Converter($value, $fromdateformat);\n    return $date->convert($todateformat);\n}\n\n/**\n* This function removes the UTF-8 Byte Order Mark from a string\n*\n* @param string $str\n* @return string\n*/\nfunction removeBOM($str=\"\"){\n    if(substr($str, 0,3) == pack(\"CCC\",0xef,0xbb,0xbf)) {\n        $str=substr($str, 3);\n    }\n    return $str;\n}\n\n/**\n* This function requests the latest update information from the LimeSurvey.org website\n*\n* @returns array Contains update information or false if the request failed for some reason\n*/\n/**********************************************/\n/* This function needs ported still.          */\n/**********************************************/\nfunction getUpdateInfo()\n{\n    if (getGlobalSetting('SessionName')=='')\n    {\n        setGlobalSetting('SessionName',randomChars(64,'ABCDEFGHIJKLMNOPQRSTUVWXYZ!\"$%&/()=?`+*~#\",;.:abcdefghijklmnopqrstuvwxyz123456789'));\n    }\n    Yii::import('application.libraries.admin.http.httpRequestIt');\n    $http=new httpRequestIt;\n\n    $http->proxy_host_name = Yii::app()->getConfig(\"proxy_host_name\",\"\");\n    $http->proxy_host_port = Yii::app()->getConfig(\"proxy_host_port\",80);\n    $http->timeout=0;\n    $http->data_timeout=0;\n    $http->user_agent=\"LimeSurvey \".Yii::app()->getConfig(\"versionnumber\").\" build \".Yii::app()->getConfig(\"buildnumber\");\n    $http->GetRequestArguments(\"http://update.limesurvey.org?build=\".Yii::app()->getConfig(\"buildnumber\").'&id='.md5(getGlobalSetting('SessionName')).'&crosscheck=true',$arguments);\n\n    $updateinfo=false;\n    $error=$http->Open($arguments);\n    $error=$http->SendRequest($arguments);\n\n    $http->ReadReplyHeaders($headers);\n\n\n    if($error==\"\") {\n        $body=''; $full_body='';\n        for(;;){\n            $error = $http->ReadReplyBody($body,10000);\n            if($error != \"\" || strlen($body)==0) break;\n            $full_body .= $body;\n        }\n        $updateinfo=json_decode($full_body,true);\n        if ($http->response_status!='200')\n        {\n            $updateinfo['errorcode']=$http->response_status;\n            $updateinfo['errorhtml']=$full_body;\n        }\n    }\n    else\n    {\n        $updateinfo['errorcode']=$error;\n        $updateinfo['errorhtml']=$error;\n    }\n    unset( $http );\n    return $updateinfo;\n}\n\n/**\n* This function updates the actual global variables if an update is available after using getUpdateInfo\n* @return Array with update or error information\n*/\nfunction updateCheck()\n{\n    $aUpdateVersions=getUpdateInfo();\n    $clang = Yii::app()->lang;\n\n    if (isset($aUpdateVersions['errorcode'])) \n    {\n        Yii::app()->setFlashMessage(sprintf($clang->gT(\"Error when checking for new version: %s\"),$aUpdateVersions['errorcode']).'<br>'.$aUpdateVersions['errorhtml'],'error');\n        $aUpdateVersions=array(); \n    }\n    if (count($aUpdateVersions) && trim(Yii::app()->getConfig('buildnumber'))!='')\n    {\n        $sUpdateNotificationType = getGlobalSetting('updatenotification');\n        switch ($sUpdateNotificationType)\n        {\n            case 'stable':\n                // Only show update if in stable (master) branch\n                if (isset($aUpdateVersions['master'])) {\n                    $aUpdateVersion=$aUpdateVersions['master'];\n                    $aUpdateVersions=array_intersect_key($aUpdateVersions,array('master'=>'1'));\n                }\n                break;\n\n            case 'both':\n                // Show first available update\n                $aUpdateVersion=reset($aUpdateVersions);    \n                break;\n                \n            default:\n                // Never show a notification\n                $aUpdateVersions=array();\n                break;\n        }\n    }\n    \n    setGlobalSetting('updateversions',json_encode($aUpdateVersions));\n    \n    \n    if (isset($aUpdateVersion)) {\n        setGlobalSetting('updateavailable',1);\n        setGlobalSetting('updatebuild',$aUpdateVersion['build']);\n        setGlobalSetting('updateversion',$aUpdateVersion['versionnumber']);\n    } else {\n        setGlobalSetting('updateavailable',0);    \n        $aUpdateVersions = array();\n    }\n    \n    setGlobalSetting('updatelastcheck',date('Y-m-d H:i:s'));\n    return $aUpdateVersions;\n}\n\n/**\n* Return the goodchars to be used when filtering input for numbers.\n*\n* @param $lang     string    language used, for localisation\n* @param $integer    bool    use only integer\n* @param $negative    bool    allow negative values\n*/\nfunction getNumericalFormat($lang = 'en', $integer = false, $negative = true) {\n    $goodchars = \"0123456789\";\n    if ($integer === false) $goodchars .= \".\";    //Todo, add localisation\n    if ($negative === true) $goodchars .= \"-\";    //Todo, check databases\n    return $goodchars;\n}\n\n/**\n* This function returns the complete directory path to a given template name\n*\n* @param mixed $sTemplateName\n*/\nfunction getTemplatePath($sTemplateName = false)\n{\n    if (!$sTemplateName)\n    {\n        $sTemplateName=Yii::app()->getConfig('defaulttemplate'); // if $sTemplateName is NULL or false or \"\"\n    }\n    if (isStandardTemplate($sTemplateName))\n    {\n        return Yii::app()->getConfig(\"standardtemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName;\n    }\n    else\n    {\n        if (is_dir(Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName))\n        {\n            return Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName;\n        }\n        elseif (isStandardTemplate(Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"standardtemplaterootdir\").DIRECTORY_SEPARATOR.$sTemplateName;\n        }\n        elseif (file_exists(Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"usertemplaterootdir\").DIRECTORY_SEPARATOR.Yii::app()->getConfig('defaulttemplate');\n        }\n        else\n        {\n            return Yii::app()->getConfig(\"standardtemplaterootdir\").DIRECTORY_SEPARATOR.'default';\n        }\n    }\n}\n\n/**\n* This function returns the complete URL path to a given template name\n*\n* @param mixed $sTemplateName\n*/\nfunction getTemplateURL($sTemplateName)\n{\n    if (isStandardTemplate($sTemplateName))\n    {\n        return Yii::app()->getConfig(\"standardtemplaterooturl\").'/'.$sTemplateName;\n    }\n    else\n    {\n        if (file_exists(Yii::app()->getConfig(\"usertemplaterootdir\").'/'.$sTemplateName))\n        {\n            return Yii::app()->getConfig(\"usertemplaterooturl\").'/'.$sTemplateName;\n        }\n        elseif (file_exists(Yii::app()->getConfig(\"usertemplaterootdir\").'/'.Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"usertemplaterooturl\").'/'.Yii::app()->getConfig('defaulttemplate');\n        }\n        elseif (file_exists(Yii::app()->getConfig(\"standardtemplaterootdir\").'/'.Yii::app()->getConfig('defaulttemplate')))\n        {\n            return Yii::app()->getConfig(\"standardtemplaterooturl\").'/'.Yii::app()->getConfig('defaulttemplate');\n        }\n        else\n        {\n            return Yii::app()->getConfig(\"standardtemplaterooturl\").'/default';\n        }\n    }\n}\n\n/**\n* Return an array of subquestions for a given sid/qid\n*\n* @param int $sid\n* @param int $qid\n* @param $sLanguage Language of the subquestion text\n*/\nfunction getSubQuestions($sid, $qid, $sLanguage) {\n\n    static $subquestions;\n\n    if (!isset($subquestions[$sid]))\n    {\n        $subquestions[$sid]=array();\n    }\n    if (!isset($subquestions[$sid][$sLanguage])) {\n\n        $query = \"SELECT sq.*, q.other FROM {{questions}} as sq, {{questions}} as q\"\n        .\" WHERE sq.parent_qid=q.qid AND q.sid=\".$sid\n        .\" AND sq.language='\".$sLanguage. \"' \"\n        .\" AND q.language='\".$sLanguage. \"' \"\n        .\" ORDER BY sq.parent_qid, q.question_order,sq.scale_id , sq.question_order\";\n\n        $query = Yii::app()->db->createCommand($query)->query();\n\n        $resultset=array();\n        //while ($row=$result->FetchRow())\n        foreach ($query->readAll() as $row)\n        {\n            $resultset[$row['parent_qid']][] = $row;\n        }\n        $subquestions[$sid][$sLanguage] = $resultset;\n    }\n    if (isset($subquestions[$sid][$sLanguage][$qid])) return $subquestions[$sid][$sLanguage][$qid];\n    return array();\n}\n\n/**\n* Wrapper function to retrieve an xmlwriter object and do error handling if it is not compiled\n* into PHP\n*/\nfunction getXMLWriter() {\n    if (!extension_loaded('xmlwriter')) {\n        safeDie('XMLWriter class not compiled into PHP, please contact your system administrator');\n    } else {\n        $xmlwriter = new XMLWriter();\n    }\n    return $xmlwriter;\n}\n\n/**\n* SSLRedirect() generates a redirect URL for the appropriate SSL mode then applies it.\n* (Was redirect() before CodeIgniter port.)\n*\n* @param $enforceSSLMode string 's' or '' (empty).\n*/\nfunction SSLRedirect($enforceSSLMode)\n{\n    $url = 'http'.$enforceSSLMode.'://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];\n    if (!headers_sent())\n    {    // If headers not sent yet... then do php redirect\n        //ob_clean();\n        header('Location: '.$url);\n        //ob_flush();\n        exit;\n    };\n};\n\n/**\n* enforceSSLMode() $force_ssl is on or off, it checks if the current\n* request is to HTTPS (or not). If $force_ssl is on, and the\n* request is not to HTTPS, it redirects the request to the HTTPS\n* version of the URL, if the request is to HTTPS, it rewrites all\n* the URL variables so they also point to HTTPS.\n*/\nfunction enforceSSLMode()\n{\n    $bSSLActive = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != \"off\")||\n    (isset($_SERVER['HTTP_FORWARDED_PROTO']) && $_SERVER['HTTP_FORWARDED_PROTO']==\"https\")||\n    (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']==\"https\"));\n    if (Yii::app()->getConfig('ssl_emergency_override') !== true )\n    {\n        $force_ssl = strtolower(getGlobalSetting('force_ssl'));\n    }\n    else\n    {\n        $force_ssl = 'off';\n    };\n    if( $force_ssl == 'on' && !$bSSLActive )\n    {\n        SSLRedirect('s');\n    }\n    if( $force_ssl == 'off' && $bSSLActive)\n    {\n        SSLRedirect('');\n    };\n};\n\n/**\n* Returns the number of answers matching the quota\n*\n* @param int $iSurveyId - Survey identification number\n* @param int $quotaid - quota id for which you want to compute the completed field\n* @return mixed - Integer of matching entries in the result DB or 'N/A'\n*/\nfunction getQuotaCompletedCount($iSurveyId, $quotaid)\n{\n    $result = \"N/A\";\n    if(!tableExists(\"survey_{$iSurveyId}\")) // Yii::app()->db->schema->getTable('{{survey_' . $iSurveyId . '}}' are not updated even after Yii::app()->db->schema->refresh();\n        return $result;\n    $quota_info = getQuotaInformation($iSurveyId, Survey::model()->findByPk($iSurveyId)->language, $quotaid);\n    $quota = $quota_info[0];\n    if (Yii::app()->db->schema->getTable('{{survey_' . $iSurveyId . '}}') &&\n    count($quota['members']) > 0)\n    {\n        // Keep a list of fields for easy reference\n        $fields_list = array();\n\n        // Construct an array of value for each $quota['members']['fieldnames']\n        $fields_query = array();\n\n        foreach ($quota['members'] as $member)\n        {\n            $criteria = new CDbCriteria;\n\n            foreach ($member['fieldnames'] as $fieldname)\n            {\n                if (!in_array($fieldname, $fields_list))\n                    $fields_list[] = $fieldname;\n\n                // Yii does not quote column names (duh!) so we have to do it.\n                $criteria->addColumnCondition(array(Yii::app()->db->quoteColumnName($fieldname) => $member['value']), 'OR');\n            }\n\n            $fields_query[$fieldname] = $criteria;\n        }\n\n        $criteria = new CDbCriteria;\n\n        foreach ($fields_list as $fieldname)\n            $criteria->mergeWith($fields_query[$fieldname]);\n        $criteria->mergeWith(array('condition'=>\"submitdate IS NOT NULL\"));\n        $result = SurveyDynamic::model($iSurveyId)->count($criteria);\n    }\n\n    return $result;\n}\n\n/**\n* Creates an array with details on a particular response for display purposes\n* Used in Print answers, Detailed response view and Detailed admin notification email\n*\n* @param mixed $iSurveyID\n* @param mixed $iResponseID\n* @param mixed $sLanguageCode\n* @param boolean $bHonorConditions Apply conditions\n*/\nfunction getFullResponseTable($iSurveyID, $iResponseID, $sLanguageCode, $bHonorConditions=true)\n{\n    $aFieldMap = createFieldMap($iSurveyID,'full',false,false,$sLanguageCode);\n    $oLanguage = new Limesurvey_lang($sLanguageCode);\n\n    //Get response data\n    $idrow = SurveyDynamic::model($iSurveyID)->findByAttributes(array('id'=>$iResponseID));\n\n    // Create array of non-null values - those are the relevant ones\n    $aRelevantFields = array();\n\n    foreach ($aFieldMap as $sKey=>$fname)\n    {\n        if (LimeExpressionManager::QuestionIsRelevant($fname['qid']) || $bHonorConditions==false)\n        {\n            $aRelevantFields[$sKey]=$fname;\n        }\n    }\n\n    $aResultTable=array();\n    $oldgid = 0;\n    $oldqid = 0;\n    foreach ($aRelevantFields as $sKey=>$fname)\n    {\n        if (!empty($fname['qid']))\n        {\n            $attributes = getQuestionAttributeValues($fname['qid']);\n            if (getQuestionAttributeValue($attributes, 'hidden') == 1)\n            {\n                continue;\n            }\n        }\n        $question = $fname['question'];\n        $subquestion='';\n        if (isset($fname['gid']) && !empty($fname['gid'])) {\n            //Check to see if gid is the same as before. if not show group name\n            if ($oldgid !== $fname['gid'])\n            {\n                $oldgid = $fname['gid'];\n                if (LimeExpressionManager::GroupIsRelevant($fname['gid']) || $bHonorConditions==false) {\n                    $aResultTable['gid_'.$fname['gid']]=array($fname['group_name']);\n                }\n            }\n        }\n        if (!empty($fname['qid']))\n        {\n            if ($oldqid !== $fname['qid'])\n            {\n                $oldqid = $fname['qid'];\n                if (isset($fname['subquestion']) || isset($fname['subquestion1']) || isset($fname['subquestion2']))\n                {\n                    $aResultTable['qid_'.$fname['sid'].'X'.$fname['gid'].'X'.$fname['qid']]=array($fname['question'],'','');\n                }\n                else\n                {\n                    $answer = getExtendedAnswer($iSurveyID,$fname['fieldname'], $idrow[$fname['fieldname']],$oLanguage);\n                    $aResultTable[$fname['fieldname']]=array($question,'',$answer);\n                    continue;\n                }\n            }\n        }\n        else\n        {\n            $answer=getExtendedAnswer($iSurveyID,$fname['fieldname'], $idrow[$fname['fieldname']],$oLanguage);\n            $aResultTable[$fname['fieldname']]=array($question,'',$answer);\n            continue;\n        }\n        if (isset($fname['subquestion']))\n            $subquestion = \"{$fname['subquestion']}\";\n\n        if (isset($fname['subquestion1']))\n            $subquestion = \"{$fname['subquestion1']}\";\n\n        if (isset($fname['subquestion2']))\n            $subquestion .= \"[{$fname['subquestion2']}]\";\n\n        $answer = getExtendedAnswer($iSurveyID,$fname['fieldname'], $idrow[$fname['fieldname']],$oLanguage);\n        $aResultTable[$fname['fieldname']]=array('',$subquestion,$answer);\n    }\n    return $aResultTable;\n}\n\n/**\n* Check if $str is an integer, or string representation of an integer\n*\n* @param mixed $mStr\n*/\nfunction isNumericInt($mStr)\n{\n    if(is_int($mStr))\n        return true;\n    elseif(is_string($mStr))\n        return preg_match(\"/^[0-9]+$/\", $mStr);\n    return false;\n}\n\n\n/**\n* Include Keypad headers\n*/\nfunction includeKeypad()\n{\n    $clang = Yii::app()->lang;\n\n    Yii::app()->getClientScript()->registerScriptFile(Yii::app()->getConfig('third_party').'jquery-keypad/jquery.keypad.min.js');\n    $localefile = Yii::app()->getConfig('rootdir').'/third_party/jquery-keypad/jquery.keypad-'.$clang->langcode.'.js';\n    if ($clang->langcode != 'en' && file_exists($localefile))\n    {\n        Yii::app()->getClientScript()->registerScriptFile(Yii::app()->getConfig('third_party').'jquery-keypad/jquery.keypad-'.$clang->langcode.'.js');\n    }\n    Yii::app()->getClientScript()->registerCssFile(Yii::app()->getConfig('third_party') . \"jquery-keypad/jquery.keypad.alt.css\");\n}\n\n/**\n* getQuotaInformation() returns quota information for the current survey\n* @param string $surveyid - Survey identification number\n* @param string $language - Language of the quota\n* @param string $quotaid - Optional quotaid that restricts the result to a given quota\n* @return array - nested array, Quotas->Members->Fields\n*/\nfunction getQuotaInformation($surveyid,$language,$iQuotaID='all')\n{\n    Yii::log('getQuotaInformation');\n    global $clienttoken;\n    $baselang = Survey::model()->findByPk($surveyid)->language;\n    $aAttributes=array('sid' => $surveyid);\n    if ($iQuotaID != 'all')\n    {\n        $aAttributes['id'] = $iQuotaID;\n    }\n\n    $result = Quota::model()->with(array('languagesettings' => array('condition' => \"quotals_language='$language'\")))->findAllByAttributes($aAttributes);\n    \n    $quota_info = array();\n    $x=0;\n\n    $surveyinfo=getSurveyInfo($surveyid,$language);\n\n    // Check all quotas for the current survey\n    //if ($result->RecordCount() > 0)\n    if (count($result) > 0)\n    {\n        //while ($survey_quotas = $result->FetchRow())\n        foreach ($result as $_survey_quotas)\n        {\n            $survey_quotas = array_merge($_survey_quotas->attributes,$_survey_quotas->languagesettings[0]->attributes);// We have only one language, then we can use first only\n            // !!! Doubting this\n#            foreach ($_survey_quotas->defaultlanguage as $k => $v)\n#                $survey_quotas[$k] = $v;\n\n            array_push($quota_info,array('Name' => $survey_quotas['name'],\n            'Limit' => $survey_quotas['qlimit'],\n            'Action' => $survey_quotas['action'],\n            'Message' => $survey_quotas['quotals_message'],\n            'Url' => $survey_quotas['quotals_url'],\n            'UrlDescrip' => $survey_quotas['quotals_urldescrip'],\n            'AutoloadUrl' => $survey_quotas['autoload_url']));\n\n            $result_qe = QuotaMember::model()->findAllByAttributes(array('quota_id'=>$survey_quotas['id']));\n            $quota_info[$x]['members'] = array();\n            if (count($result_qe) > 0)\n            {\n                foreach ($result_qe as $quota_entry)\n                {\n                    $quota_entry = $quota_entry->attributes;\n                    $result_quest=Question::model()->findByAttributes(array('qid'=>$quota_entry['qid'], 'language'=>$baselang));\n                    $qtype=$result_quest->attributes;\n\n                    $fieldnames = \"0\";\n\n                    if ($qtype['type'] == \"I\" || $qtype['type'] == \"G\" || $qtype['type'] == \"Y\")\n                    {\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid']);\n                        $value = $quota_entry['code'];\n                    }\n\n                    if($qtype['type'] == \"L\" || $qtype['type'] == \"O\" || $qtype['type'] ==\"!\")\n                    {\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid']);\n                        $value = $quota_entry['code'];\n                    }\n\n                    if($qtype['type'] == \"M\")\n                    {\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid'].$quota_entry['code']);\n                        $value = \"Y\";\n                    }\n\n                    if($qtype['type'] == \"A\" || $qtype['type'] == \"B\")\n                    {\n                        $temp = explode('-',$quota_entry['code']);\n                        $fieldnames=array(0 => $surveyid.'X'.$qtype['gid'].'X'.$quota_entry['qid'].$temp[0]);\n                        $value = $temp[1];\n                    }\n\n                    array_push($quota_info[$x]['members'],array('Title' => $qtype['title'],\n                    'type' => $qtype['type'],\n                    'code' => $quota_entry['code'],\n                    'value' => $value,\n                    'qid' => $quota_entry['qid'],\n                    'fieldnames' => $fieldnames));\n                }\n            }\n            $x++;\n        }\n    }\n    return $quota_info;\n}\n\n/**\n* This function replaces the old insertans tags with new ones across a survey\n*\n* @param string $newsid  Old SID\n* @param string $oldsid  New SID\n* @param mixed $fieldnames Array  array('oldfieldname'=>'newfieldname')\n*/\nfunction translateInsertansTags($newsid,$oldsid,$fieldnames)\n{\n    uksort($fieldnames, create_function('$a,$b', 'return strlen($a) < strlen($b);'));\n\n    Yii::app()->loadHelper('database');\n    $newsid=sanitize_int($newsid);\n    $oldsid=sanitize_int($oldsid);\n\n    # translate 'surveyls_urldescription' and 'surveyls_url' INSERTANS tags in surveyls\n    $sql = \"SELECT surveyls_survey_id, surveyls_language, surveyls_urldescription, surveyls_url from {{surveys_languagesettings}}\n    WHERE surveyls_survey_id=\".$newsid.\" AND (surveyls_urldescription LIKE '%{$oldsid}X%' OR surveyls_url LIKE '%{$oldsid}X%')\";\n    $result = dbExecuteAssoc($sql) or show_error(\"Can't read groups table in transInsertAns \");     // Checked\n\n    //while ($qentry = $res->FetchRow())\n    foreach ($result->readAll() as $qentry)\n    {\n        $urldescription = $qentry['surveyls_urldescription'];\n        $endurl  = $qentry['surveyls_url'];\n        $language = $qentry['surveyls_language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $urldescription=preg_replace('/'.$pattern.'/', $replacement, $urldescription);\n            $endurl=preg_replace('/'.$pattern.'/', $replacement, $endurl);\n        }\n\n        if (strcmp($urldescription,$qentry['surveyls_urldescription']) !=0  ||\n        (strcmp($endurl,$qentry['surveyls_url']) !=0))\n        {\n\n            // Update Field\n\n            $data = array(\n            'surveyls_urldescription' => $urldescription,\n            'surveyls_url' => $endurl\n            );\n\n            $where = array(\n            'surveyls_survey_id' => $newsid,\n            'surveyls_language' => $language\n            );\n\n            SurveyLanguageSetting::model()->updateRecord($data,$where);\n\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'quotals_urldescrip' and 'quotals_url' INSERTANS tags in quota_languagesettings\n    $sql = \"SELECT quotals_id, quotals_urldescrip, quotals_url from {{quota_languagesettings}} qls, {{quota}} q\n    WHERE sid=\".$newsid.\" AND q.id=qls.quotals_quota_id AND (quotals_urldescrip LIKE '%{$oldsid}X%' OR quotals_url LIKE '%{$oldsid}X%')\";\n    $result = dbExecuteAssoc($sql) or safeDie(\"Can't read quota table in transInsertAns\");     // Checked\n\n    foreach ($result->readAll() as $qentry)\n    {\n        $urldescription = $qentry['quotals_urldescrip'];\n        $endurl  = $qentry['quotals_url'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $urldescription=preg_replace('/'.$pattern.'/', $replacement, $urldescription);\n            $endurl=preg_replace('/'.$pattern.'/', $replacement, $endurl);\n        }\n\n        if (strcmp($urldescription,$qentry['quotals_urldescrip']) !=0  || (strcmp($endurl,$qentry['quotals_url']) !=0))\n        {\n            // Update Field\n            $sqlupdate = \"UPDATE {{quota_languagesettings}} SET quotals_urldescrip='\".$urldescription.\"', quotals_url='\".$endurl.\"' WHERE quotals_id={$qentry['quotals_id']}\";\n            $updateres=dbExecuteAssoc($sqlupdate) or safeDie (\"Couldn't update INSERTANS in quota_languagesettings<br />$sqlupdate<br />\");    //Checked\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'description' INSERTANS tags in groups\n    $sql = \"SELECT gid, language, group_name, description from {{groups}}\n    WHERE sid=\".$newsid.\" AND description LIKE '%{$oldsid}X%' OR group_name LIKE '%{$oldsid}X%'\";\n    $res = dbExecuteAssoc($sql) or show_error(\"Can't read groups table in transInsertAns\");     // Checked\n\n    //while ($qentry = $res->FetchRow())\n    foreach ($res->readAll() as $qentry)\n    {\n        $gpname = $qentry['group_name'];\n        $description = $qentry['description'];\n        $gid = $qentry['gid'];\n        $language = $qentry['language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $gpname = preg_replace('/'.$pattern.'/', $replacement, $gpname);\n            $description=preg_replace('/'.$pattern.'/', $replacement, $description);\n        }\n\n        if (strcmp($description,$qentry['description']) !=0  || strcmp($gpname,$qentry['group_name']) !=0)\n        {\n            // Update Fields\n            $where = array(\n            'gid' => $gid,\n            'language' => $language\n            );\n            $oGroup = QuestionGroup::model()->findByAttributes($where);\n            $oGroup->description= $description;\n            $oGroup->group_name= $gpname;\n            $oGroup->save();\n\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'question' and 'help' INSERTANS tags in questions\n    $sql = \"SELECT qid, language, question, help from {{questions}}\n    WHERE sid=\".$newsid.\" AND (question LIKE '%{$oldsid}X%' OR help LIKE '%{$oldsid}X%')\";\n    $result = dbExecuteAssoc($sql) or die(\"Can't read question table in transInsertAns \");     // Checked\n\n    //while ($qentry = $res->FetchRow())\n    $aResultData=$result->readAll() ;\n    foreach ($aResultData as $qentry)\n    {\n        $question = $qentry['question'];\n        $help = $qentry['help'];\n        $qid = $qentry['qid'];\n        $language = $qentry['language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $question=preg_replace('/'.$pattern.'/', $replacement, $question);\n            $help=preg_replace('/'.$pattern.'/', $replacement, $help);\n        }\n\n        if (strcmp($question,$qentry['question']) !=0 ||\n        strcmp($help,$qentry['help']) !=0)\n        {\n            // Update Field\n\n            $data = array(\n            'question' => $question,\n            'help' => $help\n            );\n\n            $where = array(\n            'qid' => $qid,\n            'language' => $language\n            );\n\n            Question::model()->updateByPk($where,$data);\n\n        } // Enf if modified\n    } // end while qentry\n\n    # translate 'answer' INSERTANS tags in answers\n    $result=Answer::model()->oldNewInsertansTags($newsid,$oldsid);\n\n    //while ($qentry = $res->FetchRow())\n    foreach ($result as $qentry)\n    {\n        $answer = $qentry['answer'];\n        $code = $qentry['code'];\n        $qid = $qentry['qid'];\n        $language = $qentry['language'];\n\n        foreach ($fieldnames as $sOldFieldname=>$sNewFieldname)\n        {\n            $pattern = $sOldFieldname;\n            $replacement = $sNewFieldname;\n            $answer=preg_replace('/'.$pattern.'/', $replacement, $answer);\n        }\n\n        if (strcmp($answer,$qentry['answer']) !=0)\n        {\n            // Update Field\n\n            $data = array(\n            'answer' => $answer,\n            'qid' => $qid\n            );\n\n            $where = array(\n            'code' => $code,\n            'language' => $language\n            );\n\n            Answer::model()->update($data,$where);\n\n        } // Enf if modified\n    } // end while qentry\n}\n\n/**\n* Replaces EM variable codes in a current survey with a new one\n* \n* @param mixed $iSurveyID The survey ID\n* @param mixed $aCodeMap The codemap array (old_code=>new_code)\n*/\nfunction replaceExpressionCodes ($iSurveyID, $aCodeMap)\n{\n   $arQuestions=Question::model()->findAll(\"sid=:sid\",array(':sid'=>$iSurveyID));\n   foreach ($arQuestions as $arQuestion)\n   {\n        $bModified=false;\n        foreach ($aCodeMap as $sOldCode=>$sNewCode)\n        {\n            // Don't search/replace old codes that are too short or were numeric (because they would not have been usable in EM expressions anyway)\n            if (strlen($sOldCode)>1 && !is_numeric($sOldCode[0])) \n            {\n                $sOldCode=preg_quote($sOldCode,'/');\n                $arQuestion->relevance=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arQuestion->relevance,-1,$iCount);\n                $bModified = $bModified || $iCount;\n                $arQuestion->question=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arQuestion->question,-1,$iCount);\n                $bModified = $bModified || $iCount;\n            }\n        }\n        if ($bModified)\n        {\n            $arQuestion->save();\n        }\n   }\n   $arGroups=QuestionGroup::model()->findAll(\"sid=:sid\",array(':sid'=>$iSurveyID));\n   foreach ($arGroups as $arGroup)\n   {\n        $bModified=false;\n        foreach ($aCodeMap as $sOldCode=>$sNewCode)\n        {\n            $sOldCode=preg_quote($sOldCode,'/');\n            $arGroup->grelevance=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arGroup->grelevance,-1,$iCount);\n            $bModified = $bModified || $iCount;\n            $arGroup->description=preg_replace(\"/\\b{$sOldCode}/\",$sNewCode,$arGroup->description,-1,$iCount);\n            $bModified = $bModified || $iCount;\n        }\n        if ($bModified)\n        {\n            $arGroup->save();\n        }\n   }\n}\n\n\n/**\n* This function is a replacement of accessDenied.php which return appropriate error message which is then displayed.\n*\n* @params string $action - action for which acces denied error message is to be returned\n* @params string sid - survey id\n* @return $accesssummary - proper access denied error message\n*/\nfunction accessDenied($action,$sid='')\n{\n    $clang = Yii::app()->lang;\n    if (Yii::app()->session['loginID'])\n    {\n        $ugid = Yii::app()->getConfig('ugid');\n        $accesssummary = \"<p><strong>\".$clang->gT(\"Access denied!\").\"</strong><br />\\n\";\n        $scriptname = Yii::app()->getConfig('scriptname');\n        //$action=returnGlobal('action');\n        if  (  $action == \"dumpdb\"  )\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed dump the database!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"dumplabel\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed export a label set!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"edituser\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to change user data!\");\n            $accesssummary .= \"<br /><br /><a href='$scriptname?action=editusers'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"newsurvey\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to create new surveys!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"deletesurvey\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to delete this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"addquestion\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to add new questions for this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"activate\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to activate this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"deactivate\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to stop this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"addgroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to add a group to this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"ordergroups\")\n        {\n            $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/$sid\");\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to order groups in this survey!\").\"<br />\";\n            $accesssummary .= \"<a href='$link'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"editsurvey\")\n        {\n            $link = Yii::app()->getController()->createUrl(\"/admin/survey/sa/view/surveyid/$sid\");\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to edit this survey!\").\"</p>\";\n            $accesssummary .= \"<a href='$link'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"editgroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to edit groups in this survey!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"browse_response\" || $action == \"listcolumn\" || $action == \"vvexport\" || $action == \"vvimport\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to browse responses!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"assessment\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to set assessment rules!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"delusergroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to delete this group!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?action=editusergroups'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"importsurvey\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to import a survey!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n\n        elseif($action == \"importgroup\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to import a group!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"importquestion\")\n        {\n            $accesssummary .= \"<p>\".$clang->gT(\"You are not allowed to to import a question!\").\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"CSRFwarn\") //won't be used.\n        {\n            $sURLID='';\n            if (isset($sid)) {\n                $sURLID=\"?sid={$sid}\";\n            }\n            $accesssummary .= \"<p><span color='errortitle'>\".$clang->gT(\"Security alert\").\"</span>: \".$clang->gT(\"Someone may be trying to use your LimeSurvey session (CSRF attack suspected). If you just clicked on a malicious link, please report this to your system administrator.\").'<br>'.$clang->gT('Also this problem can occur when you are working/editing in LimeSurvey in several browser windows/tabs at the same time.').\"</p>\";\n            $accesssummary .= \"<a href='{$scriptname}{$sURLID}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        elseif($action == \"FakeGET\")\n        {\n            $accesssummary .= \"<p><span class='errortitle'>\".$clang->gT(\"Security alert\").\"</span>: \".$clang->gT(\"Someone may be trying to use your LimeSurvey session (CSRF attack suspected). If you just clicked on a malicious link, please report this to your system administrator.\").'<br>'.$clang->gT('Also this problem can occur when you are working/editing in LimeSurvey in several browser windows/tabs at the same time.').\"</p>\";\n            $accesssummary .= \"<a href='$scriptname?sid={$sid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n        }\n        else\n        {\n            $accesssummary .= \"<br />\".$clang->gT(\"You are not allowed to perform this operation!\").\"<br />\\n\";\n            if(!empty($sid))\n            {\n                $accesssummary .= \"<br /><br /><a href='$scriptname?sid=$sid>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n            }\n            elseif(!empty($ugid))\n            {\n                $accesssummary .= \"<br /><br /><a href='$scriptname?action=editusergroups&ugid={$ugid}'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n            }\n            else\n            {\n                $accesssummary .= \"<br /><br /><a href='$scriptname'>\".$clang->gT(\"Continue\").\"</a><br />&nbsp;\\n\";\n            }\n        }\n        return $accesssummary;\n    }\n\n}\n\n/**\n* cleanLanguagesFromSurvey() removes any languages from survey tables that are not in the passed list\n* @param string $sid - the currently selected survey\n* @param string $availlangs - space separated list of additional languages in survey\n* @return bool - always returns true\n*/\nfunction cleanLanguagesFromSurvey($sid, $availlangs)\n{\n\n    Yii::app()->loadHelper('database');\n    //$clang = Yii::app()->lang;\n    $sid=sanitize_int($sid);\n    $baselang = Survey::model()->findByPk($sid)->language;\n\n    if (!empty($availlangs) && $availlangs != \" \")\n    {\n        $availlangs=sanitize_languagecodeS($availlangs);\n        $langs = explode(\" \",$availlangs);\n        if($langs[count($langs)-1] == \"\") array_pop($langs);\n    }\n\n    $sqllang = \"language <> '\".$baselang.\"' \";\n\n    if (!empty($availlangs) && $availlangs != \" \")\n    {\n        foreach ($langs as $lang)\n        {\n            $sqllang .= \"AND language <> '\".$lang.\"' \";\n        }\n    }\n\n    // Remove From Answer Table\n    $query = \"SELECT qid FROM {{questions}} WHERE sid='{$sid}' AND $sqllang\";\n    $qidresult = dbExecuteAssoc($query);\n\n    foreach ($qidresult->readAll() as $qrow)\n    {\n\n        $myqid = $qrow['qid'];\n        $query = \"DELETE FROM {{answers}} WHERE qid='$myqid' AND $sqllang\";\n        dbExecuteAssoc($query);\n    }\n\n    // Remove From Questions Table\n    $query = \"DELETE FROM {{questions}} WHERE sid='{$sid}' AND $sqllang\";\n    dbExecuteAssoc($query);\n\n    // Remove From QuestionGroup Table\n    $query = \"DELETE FROM {{groups}} WHERE sid='{$sid}' AND $sqllang\";\n    dbExecuteAssoc($query);\n\n    return true;\n}\n\n/**\n* fixLanguageConsistency() fixes missing groups, questions, answers, quotas & assessments for languages on a survey\n* @param string $sid - the currently selected survey\n* @param string $availlangs - space separated list of additional languages in survey - if empty all additional languages of a survey are checked against the base language\n* @return bool - always returns true\n*/\nfunction fixLanguageConsistency($sid, $availlangs='')\n{\n    $sid=sanitize_int($sid);\n    $clang = Yii::app()->lang;\n\n    if (trim($availlangs)!='')\n    {\n        $availlangs=sanitize_languagecodeS($availlangs);\n        $langs = explode(\" \",$availlangs);\n        if($langs[count($langs)-1] == \"\") array_pop($langs);\n    } else {\n        $langs=Survey::model()->findByPk($sid)->additionalLanguages;\n    }\n    if (count($langs)==0) return true; // Survey only has one language\n    $baselang = Survey::model()->findByPk($sid)->language;\n    $query = \"SELECT * FROM {{groups}} WHERE sid='{$sid}' AND language='{$baselang}'  ORDER BY group_order\";\n    $result = Yii::app()->db->createCommand($query)->query();\n    foreach($result->readAll() as $group)\n    {\n        foreach ($langs as $lang)\n        {\n\n            $query = \"SELECT count(gid) FROM {{groups}} WHERE sid='{$sid}' AND gid='{$group['gid']}' AND language='{$lang}'\";\n            $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n            if ($gresult < 1)\n            {\n                $data = array(\n                'gid' => $group['gid'],\n                'sid' => $group['sid'],\n                'group_name' => $group['group_name'],\n                'group_order' => $group['group_order'],\n                'description' => $group['description'],\n                'randomization_group' => $group['randomization_group'],\n                'grelevance' => $group['grelevance'],\n                'language' => $lang\n\n                );\n                switchMSSQLIdentityInsert('groups',true);\n                Yii::app()->db->createCommand()->insert('{{groups}}', $data);\n                switchMSSQLIdentityInsert('groups',false);\n            }\n        }\n        reset($langs);\n    }\n\n    $quests = array();\n    $query = \"SELECT * FROM {{questions}} WHERE sid='{$sid}' AND language='{$baselang}' ORDER BY question_order\";\n    $result = Yii::app()->db->createCommand($query)->query()->readAll();\n    if (count($result) > 0)\n    {\n        foreach($result as $question)\n        {\n            array_push($quests,$question['qid']);\n            foreach ($langs as $lang)\n            {\n                $query = \"SELECT count(qid) FROM {{questions}} WHERE sid='{$sid}' AND qid='{$question['qid']}' AND language='{$lang}' AND scale_id={$question['scale_id']}\";\n                $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n                if ($gresult < 1)\n                {\n                    switchMSSQLIdentityInsert('questions',true);\n                    $data = array(\n                    'qid' => $question['qid'],\n                    'sid' => $question['sid'],\n                    'gid' => $question['gid'],\n                    'type' => $question['type'],\n                    'title' => $question['title'],\n                    'question' => $question['question'],\n                    'preg' => $question['preg'],\n                    'help' => $question['help'],\n                    'other' => $question['other'],\n                    'mandatory' => $question['mandatory'],\n                    'question_order' => $question['question_order'],\n                    'language' => $lang,\n                    'scale_id' => $question['scale_id'],\n                    'parent_qid' => $question['parent_qid'],\n                    'relevance' => $question['relevance']\n                    );\n                    Yii::app()->db->createCommand()->insert('{{questions}}', $data);\n                }\n            }\n            reset($langs);\n        }\n\n        $sqlans = \"\";\n        foreach ($quests as $quest)\n        {\n            $sqlans .= \" OR qid = '\".$quest.\"' \";\n        }\n        $query = \"SELECT * FROM {{answers}} WHERE language='{$baselang}' and (\".trim($sqlans,' OR').\") ORDER BY qid, code\";\n        $result = Yii::app()->db->createCommand($query)->query();\n        foreach($result->readAll() as $answer)\n        {\n            foreach ($langs as $lang)\n            {\n                $query = \"SELECT count(qid) FROM {{answers}} WHERE code='{$answer['code']}' AND qid='{$answer['qid']}' AND language='{$lang}' AND scale_id={$answer['scale_id']}\";\n                $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n                if ($gresult < 1)\n                {\n                    $data = array(\n                    'qid' => $answer['qid'],\n                    'code' => $answer['code'],\n                    'answer' => $answer['answer'],\n                    'scale_id' => $answer['scale_id'],\n                    'sortorder' => $answer['sortorder'],\n                    'language' => $lang,\n                    'assessment_value' =>  $answer['assessment_value']\n                    );\n                    Yii::app()->db->createCommand()->insert('{{answers}}', $data);\n                }\n            }\n            reset($langs);\n        }\n    }\n\n\n    $query = \"SELECT * FROM {{assessments}} WHERE sid='{$sid}' AND language='{$baselang}'\";\n    $result = Yii::app()->db->createCommand($query)->query();\n    foreach($result->readAll() as $assessment)\n    {\n        foreach ($langs as $lang)\n        {\n            $query = \"SELECT count(id) FROM {{assessments}} WHERE sid='{$sid}' AND id='{$assessment['id']}' AND language='{$lang}'\";\n            $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n            if ($gresult < 1)\n            {\n                $data = array(\n                'id' => $assessment['id'],\n                'sid' => $assessment['sid'],\n                'scope' => $assessment['scope'],\n                'gid' => $assessment['gid'],\n                'name' => $assessment['name'],\n                'minimum' => $assessment['minimum'],\n                'maximum' => $assessment['maximum'],\n                'message' => $assessment['message'],\n                'language' => $lang\n                );\n                Yii::app()->db->createCommand()->insert('{{assessments}}', $data);\n            }\n        }\n        reset($langs);\n    }\n\n\n    $query = \"SELECT * FROM {{quota_languagesettings}} join {{quota}} q on quotals_quota_id=q.id WHERE q.sid='{$sid}' AND quotals_language='{$baselang}'\";\n    $result = Yii::app()->db->createCommand($query)->query();\n    foreach($result->readAll() as $qls)\n    {\n        foreach ($langs as $lang)\n        {\n            $query = \"SELECT count(quotals_id) FROM {{quota_languagesettings}} WHERE quotals_quota_id='{$qls['quotals_quota_id']}' AND quotals_language='{$lang}'\";\n            $gresult = Yii::app()->db->createCommand($query)->queryScalar();\n            if ($gresult < 1)\n            {\n                $data = array(\n                'quotals_quota_id' => $qls['quotals_quota_id'],\n                'quotals_name' => $qls['quotals_name'],\n                'quotals_message' => $qls['quotals_message'],\n                'quotals_url' => $qls['quotals_url'],\n                'quotals_urldescrip' => $qls['quotals_urldescrip'],\n                'quotals_language' => $lang\n                );\n                Yii::app()->db->createCommand()->insert('{{quota_languagesettings}}', $data);\n            }\n        }\n        reset($langs);\n    }\n\n    return true;\n}\n\n/**\n* This function switches identity insert on/off for the MSSQL database\n*\n* @param string $table table name (without prefix)\n* @param mixed $state  Set to true to activate ID insert, or false to deactivate\n*/\nfunction switchMSSQLIdentityInsert($table,$state)\n{\n    if (in_array(Yii::app()->db->getDriverName(), array('mssql', 'sqlsrv', 'dblib')))\n    {\n        if ($state == true)\n        {\n            // This needs to be done directly on the PDO object because when using CdbCommand or similar it won't have any effect\n            Yii::app()->db->pdoInstance->exec('SET IDENTITY_INSERT '.Yii::app()->db->tablePrefix.$table.' ON');\n        }\n        else\n        {\n            // This needs to be done directly on the PDO object because when using CdbCommand or similar it won't have any effect\n            Yii::app()->db->pdoInstance->exec('SET IDENTITY_INSERT '.Yii::app()->db->tablePrefix.$table.' OFF');\n        }\n    }\n}\n\n/**\n* Retrieves the last Insert ID realiable for cross-DB applications\n*\n* @param string $sTableName Needed for Postgres and MSSQL\n*/\nfunction getLastInsertID($sTableName)\n{\n    $sDBDriver=Yii::app()->db->getDriverName();\n    if ($sDBDriver=='mysql' || $sDBDriver=='mysqli')\n    {\n        return Yii::app()->db->getLastInsertID();\n    }\n    else\n    {\n        return Yii::app()->db->getCommandBuilder()->getLastInsertID($sTableName);\n    }\n}\n\n// TMSW Condition->Relevance:  This function is not needed?  Optionally replace this with call to EM to get similar info\n/**\n* getGroupDepsForConditions() get Dependencies between groups caused by conditions\n* @param string $sid - the currently selected survey\n* @param string $depgid - (optionnal) get only the dependencies applying to the group with gid depgid\n* @param string $targgid - (optionnal) get only the dependencies for groups dependents on group targgid\n* @param string $index-by - (optionnal) \"by-depgid\" for result indexed with $res[$depgid][$targgid]\n*                   \"by-targgid\" for result indexed with $res[$targgid][$depgid]\n* @return array - returns an array describing the conditions or NULL if no dependecy is found\n*\n* Example outupt assumin $index-by=\"by-depgid\":\n*Array\n*(\n*    [125] => Array             // Group Id 125 is dependent on\n*        (\n*            [123] => Array         // Group Id 123\n*                (\n*                    [depgpname] => G3      // GID-125 has name G3\n*                    [targetgpname] => G1   // GID-123 has name G1\n*                    [conditions] => Array\n*                        (\n*                            [189] => Array // Because Question Id 189\n*                                (\n*                                    [0] => 9   // Have condition 9 set\n*                                    [1] => 10  // and condition 10 set\n*                                    [2] => 14  // and condition 14 set\n*                                )\n*\n*                        )\n*\n*                )\n*\n*            [124] => Array         // GID 125 is also dependent on GID 124\n*                (\n*                    [depgpname] => G3\n*                    [targetgpname] => G2\n*                    [conditions] => Array\n*                        (\n*                            [189] => Array // Because Question Id 189 have conditions set\n*                                (\n*                                    [0] => 11\n*                                )\n*\n*                            [215] => Array // And because Question Id 215 have conditions set\n*                                (\n*                                    [0] => 12\n*                                )\n*\n*                        )\n*\n*                )\n*\n*        )\n*\n*)\n*\n* Usage example:\n*   * Get all group dependencies for SID $sid indexed by depgid:\n*       $result=getGroupDepsForConditions($sid);\n*   * Get all group dependencies for GID $gid in survey $sid indexed by depgid:\n*       $result=getGroupDepsForConditions($sid,$gid);\n*   * Get all group dependents on group $gid in survey $sid indexed by targgid:\n*       $result=getGroupDepsForConditions($sid,\"all\",$gid,\"by-targgid\");\n*/\nfunction getGroupDepsForConditions($sid,$depgid=\"all\",$targgid=\"all\",$indexby=\"by-depgid\")\n{\n    $sid=sanitize_int($sid);\n    $condarray = Array();\n    $sqldepgid=\"\";\n    $sqltarggid=\"\";\n    if ($depgid != \"all\") { $depgid = sanitize_int($depgid); $sqldepgid=\"AND tq.gid=$depgid\";}\n    if ($targgid != \"all\") {$targgid = sanitize_int($targgid); $sqltarggid=\"AND tq2.gid=$targgid\";}\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n    $condquery = \"SELECT tg.gid as depgid, tg.group_name as depgpname, \"\n    . \"tg2.gid as targgid, tg2.group_name as targgpname, tq.qid as depqid, tc.cid FROM \"\n    . \"{{conditions}} AS tc, \"\n    . \"{{questions}} AS tq, \"\n    . \"{{questions}} AS tq2, \"\n    . \"{{groups}} AS tg ,\"\n    . \"{{groups}} AS tg2 \"\n    . \"WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tg.language='{$baselang}' AND tg2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid=$sid \"\n    . \"AND tq.gid = tg.gid AND tg2.gid = tq2.gid \"\n    . \"AND tq2.qid=tc.cqid AND tq.gid != tg2.gid $sqldepgid $sqltarggid\";\n    $condresult = Yii::app()->db->createCommand($condquery)->query()->readAll();\n\n    if (count($condresult) > 0) {\n        foreach ($condresult as $condrow)\n        {\n\n            switch ($indexby)\n            {\n                case \"by-depgid\":\n                    $depgid=$condrow['depgid'];\n                    $targetgid=$condrow['targgid'];\n                    $depqid=$condrow['depqid'];\n                    $cid=$condrow['cid'];\n                    $condarray[$depgid][$targetgid]['depgpname'] = $condrow['depgpname'];\n                    $condarray[$depgid][$targetgid]['targetgpname'] = $condrow['targgpname'];\n                    $condarray[$depgid][$targetgid]['conditions'][$depqid][]=$cid;\n                    break;\n\n                case \"by-targgid\":\n                    $depgid=$condrow['depgid'];\n                    $targetgid=$condrow['targgid'];\n                    $depqid=$condrow['depqid'];\n                    $cid=$condrow['cid'];\n                    $condarray[$targetgid][$depgid]['depgpname'] = $condrow['depgpname'];\n                    $condarray[$targetgid][$depgid]['targetgpname'] = $condrow['targgpname'];\n                    $condarray[$targetgid][$depgid]['conditions'][$depqid][] = $cid;\n                    break;\n            }\n        }\n        return $condarray;\n    }\n    return null;\n}\n\n// TMSW Condition->Relevance:  This function is not needed?  Optionally replace this with call to EM to get similar info\n/**\n* getQuestDepsForConditions() get Dependencies between groups caused by conditions\n* @param string $sid - the currently selected survey\n* @param string $gid - (optionnal) only search dependecies inside the Group Id $gid\n* @param string $depqid - (optionnal) get only the dependencies applying to the question with qid depqid\n* @param string $targqid - (optionnal) get only the dependencies for questions dependents on question Id targqid\n* @param string $index-by - (optionnal) \"by-depqid\" for result indexed with $res[$depqid][$targqid]\n*                   \"by-targqid\" for result indexed with $res[$targqid][$depqid]\n* @return array - returns an array describing the conditions or NULL if no dependecy is found\n*\n* Example outupt assumin $index-by=\"by-depqid\":\n*Array\n*(\n*    [184] => Array     // Question Id 184\n*        (\n*            [183] => Array // Depends on Question Id 183\n*                (\n*                    [0] => 5   // Because of condition Id 5\n*                )\n*\n*        )\n*\n*)\n*\n* Usage example:\n*   * Get all questions dependencies for Survey $sid and group $gid indexed by depqid:\n*       $result=getQuestDepsForConditions($sid,$gid);\n*   * Get all questions dependencies for question $qid in survey/group $sid/$gid indexed by depqid:\n*       $result=getGroupDepsForConditions($sid,$gid,$qid);\n*   * Get all questions dependents on question $qid in survey/group $sid/$gid indexed by targqid:\n*       $result=getGroupDepsForConditions($sid,$gid,\"all\",$qid,\"by-targgid\");\n*/\nfunction getQuestDepsForConditions($sid,$gid=\"all\",$depqid=\"all\",$targqid=\"all\",$indexby=\"by-depqid\", $searchscope=\"samegroup\")\n{\n    $clang = Yii::app()->lang;\n    $condarray = Array();\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n    $sqlgid=\"\";\n    $sqldepqid=\"\";\n    $sqltargqid=\"\";\n    $sqlsearchscope=\"\";\n    if ($gid != \"all\") {$gid = sanitize_int($gid); $sqlgid=\"AND tq.gid=$gid\";}\n    if ($depqid != \"all\") {$depqid = sanitize_int($depqid); $sqldepqid=\"AND tq.qid=$depqid\";}\n    if ($targqid != \"all\") {$targqid = sanitize_int($targqid); $sqltargqid=\"AND tq2.qid=$targqid\";}\n    if ($searchscope == \"samegroup\") {$sqlsearchscope=\"AND tq2.gid=tq.gid\";}\n\n    $condquery = \"SELECT tq.qid as depqid, tq2.qid as targqid, tc.cid\n    FROM {{conditions}} AS tc, {{questions}} AS tq, {{questions}} AS tq2\n    WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid='$sid'\n    AND  tq2.qid=tc.cqid $sqlsearchscope $sqlgid $sqldepqid $sqltargqid\";\n    $condresult=Yii::app()->db->createCommand($condquery)->query()->readAll();\n    if (count($condresult) > 0) {\n        foreach ($condresult as $condrow)\n        {\n            $depqid=$condrow['depqid'];\n            $targetqid=$condrow['targqid'];\n            $condid=$condrow['cid'];\n            switch ($indexby)\n            {\n                case \"by-depqid\":\n                    $condarray[$depqid][$targetqid][] = $condid;\n                    break;\n\n                case \"by-targqid\":\n                    $condarray[$targetqid][$depqid][] = $condid;\n                    break;\n            }\n        }\n        return $condarray;\n    }\n    return null;\n}\n\n// TMSW Condition->Relevance:  This function is not needed - could replace with a message from EM output.\n/**\n* checkMoveQuestionConstraintsForConditions()\n* @param string $sid - the currently selected survey\n* @param string $qid - qid of the question you want to check possible moves\n* @param string $newgid - (optionnal) get only constraints when trying to move to this particular GroupId\n*                                     otherwise, get all moves constraints for this question\n*\n* @return array - returns an array describing the conditions\n*                 Array\n*                 (\n*                   ['notAbove'] = null | Array\n*                       (\n*                         Array ( gid1, group_order1, qid1, cid1 )\n*                       )\n*                   ['notBelow'] = null | Array\n*                       (\n*                         Array ( gid2, group_order2, qid2, cid2 )\n*                       )\n*                 )\n*\n* This should be read as:\n*    - this question can't be move above group gid1 in position group_order1 because of the condition cid1 on question qid1\n*    - this question can't be move below group gid2 in position group_order2 because of the condition cid2 on question qid2\n*\n*/\nfunction checkMoveQuestionConstraintsForConditions($sid,$qid,$newgid=\"all\")\n{\n    $clang = Yii::app()->lang;\n    $resarray=Array();\n    $resarray['notAbove']=null; // defaults to no constraint\n    $resarray['notBelow']=null; // defaults to no constraint\n    $sid=sanitize_int($sid);\n    $qid=sanitize_int($qid);\n\n    if ($newgid != \"all\")\n    {\n        $newgid=sanitize_int($newgid);\n        $newgorder=getGroupOrder($sid,$newgid);\n    }\n    else\n    {\n        $neworder=\"\"; // Not used in this case\n    }\n\n    $baselang = Survey::model()->findByPk($sid)->language;\n\n    // First look for 'my dependencies': questions on which I have set conditions\n    $condquery = \"SELECT tq.qid as depqid, tq.gid as depgid, tg.group_order as depgorder, \"\n    . \"tq2.qid as targqid, tq2.gid as targgid, tg2.group_order as targgorder, \"\n    . \"tc.cid FROM \"\n    . \"{{conditions}} AS tc, \"\n    . \"{{questions}} AS tq, \"\n    . \"{{questions}} AS tq2, \"\n    . \"{{groups}} AS tg, \"\n    . \"{{groups}} AS tg2 \"\n    . \"WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid=$sid \"\n    . \"AND  tq2.qid=tc.cqid AND tg.gid=tq.gid AND tg2.gid=tq2.gid AND tq.qid=$qid ORDER BY tg2.group_order DESC\";\n\n    $condresult=Yii::app()->db->createCommand($condquery)->query();\n\n    foreach ($condresult->readAll() as $condrow )\n    {\n        // This Question can go up to the minimum GID on the 1st row\n        $depqid=$condrow['depqid'];\n        $depgid=$condrow['depgid'];\n        $depgorder=$condrow['depgorder'];\n        $targetqid=$condrow['targqid'];\n        $targetgid=$condrow['targgid'];\n        $targetgorder=$condrow['targgorder'];\n        $condid=$condrow['cid'];\n        //echo \"This question can't go above to GID=$targetgid/order=$targetgorder because of CID=$condid\";\n        if ($newgid != \"all\")\n        { // Get only constraints when trying to move to this group\n            if ($newgorder < $targetgorder)\n            {\n                $resarray['notAbove'][]=Array($targetgid,$targetgorder,$depqid,$condid);\n            }\n        }\n        else\n        { // get all moves constraints\n            $resarray['notAbove'][]=Array($targetgid,$targetgorder,$depqid,$condid);\n        }\n    }\n\n    // Secondly look for 'questions dependent on me': questions that have conditions on my answers\n    $condquery = \"SELECT tq.qid as depqid, tq.gid as depgid, tg.group_order as depgorder, \"\n    . \"tq2.qid as targqid, tq2.gid as targgid, tg2.group_order as targgorder, \"\n    . \"tc.cid FROM {{conditions}} AS tc, \"\n    . \"{{questions}} AS tq, \"\n    . \"{{questions}} AS tq2, \"\n    . \"{{groups}} AS tg, \"\n    . \"{{groups}} AS tg2 \"\n    . \"WHERE tq.language='{$baselang}' AND tq2.language='{$baselang}' AND tc.qid = tq.qid AND tq.sid=$sid \"\n    . \"AND  tq2.qid=tc.cqid AND tg.gid=tq.gid AND tg2.gid=tq2.gid AND tq2.qid=$qid ORDER BY tg.group_order\";\n\n    $condresult=Yii::app()->db->createCommand($condquery)->query();\n\n    foreach ($condresult->readAll() as $condrow)\n    {\n        // This Question can go down to the maximum GID on the 1st row\n        $depqid=$condrow['depqid'];\n        $depgid=$condrow['depgid'];\n        $depgorder=$condrow['depgorder'];\n        $targetqid=$condrow['targqid'];\n        $targetgid=$condrow['targgid'];\n        $targetgorder=$condrow['targgorder'];\n        $condid=$condrow['cid'];\n        //echo \"This question can't go below to GID=$depgid/order=$depgorder because of CID=$condid\";\n        if ($newgid != \"all\")\n        { // Get only constraints when trying to move to this group\n            if ($newgorder > $depgorder)\n            {\n                $resarray['notBelow'][]=Array($depgid,$depgorder,$depqid,$condid);\n            }\n        }\n        else\n        { // get all moves constraints\n            $resarray['notBelow'][]=Array($depgid,$depgorder,$depqid,$condid);\n        }\n    }\n    return $resarray;\n}\n\nfunction getUserGroupList($ugid=NULL,$outputformat='optionlist')\n{\n    $clang = Yii::app()->lang;\n    //$squery = \"SELECT ugid, name FROM \".db_table_name('user_groups') .\" WHERE owner_id = {Yii::app()->session['loginID']} ORDER BY name\";\n    $sQuery = \"SELECT distinct a.ugid, a.name, a.owner_id FROM {{user_groups}} AS a LEFT JOIN {{user_in_groups}} AS b ON a.ugid = b.ugid WHERE 1=1 \";\n    if (!Permission::model()->hasGlobalPermission('superadmin','read'))\n    {\n        $sQuery .=\"AND uid = \".Yii::app()->session['loginID'];\n    }\n    $sQuery .=  \" ORDER BY name\";\n\n    $sresult = Yii::app()->db->createCommand($sQuery)->query(); //Checked\n    if (!$sresult) {return \"Database Error\";}\n    $selecter = \"\";\n    foreach ($sresult->readAll() as $row)\n    {\n        $groupnames[] = $row;\n    }\n\n\n    //$groupnames = $sresult->GetRows();\n    $simplegidarray=array();\n    if (isset($groupnames))\n    {\n        foreach($groupnames as $gn)\n        {\n            $selecter .= \"<option \";\n            if(Yii::app()->session['loginID'] == $gn['owner_id']) {$selecter .= \" style=\\\"font-weight: bold;\\\"\";}\n            //if (isset($_GET['ugid']) && $gn['ugid'] == $_GET['ugid']) {$selecter .= \" selected='selected'\"; $svexist = 1;}\n\n            if ($gn['ugid'] == $ugid) {$selecter .= \" selected='selected'\"; $svexist = 1;}\n            $link = Yii::app()->getController()->createUrl(\"/admin/usergroups/sa/view/ugid/\".$gn['ugid']);\n            $selecter .=\" value='{$link}'>{$gn['name']}</option>\\n\";\n            $simplegidarray[] = $gn['ugid'];\n        }\n    }\n\n    if (!isset($svexist)) {$selecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$selecter;}\n    //else {$selecter = \"<option value='-1'>\".$clang->gT(\"None\").\"</option>\\n\".$selecter;}\n\n    if ($outputformat == 'simplegidarray')\n    {\n        return $simplegidarray;\n    }\n    else\n    {\n        return $selecter;\n    }\n}\n\nfunction getGroupUserList($ugid)\n{\n    Yii::app()->loadHelper('database');\n    $clang = Yii::app()->lang;\n\n    $ugid=sanitize_int($ugid);\n    $surveyidquery = \"SELECT a.uid, a.users_name, a.full_name FROM {{users}} AS a LEFT JOIN (SELECT uid AS id FROM {{user_in_groups}} WHERE ugid = {$ugid}) AS b ON a.uid = b.id WHERE id IS NULL ORDER BY a.users_name\";\n\n    $surveyidresult = dbExecuteAssoc($surveyidquery);  //Checked\n    if (!$surveyidresult) {return \"Database Error\";}\n    $surveyselecter = \"\";\n    foreach ($surveyidresult->readAll() as $row)\n    {\n        $surveynames[] = $row;\n    }\n    //$surveynames = $surveyidresult->GetRows();\n    if (isset($surveynames))\n    {\n        foreach($surveynames as $sv)\n        {\n            $surveyselecter .= \"<option\";\n            $surveyselecter .=\" value='{$sv['uid']}'>{$sv['users_name']} {$sv['full_name']}</option>\\n\";\n        }\n    }\n    $surveyselecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;\n    return $surveyselecter;\n}\n\n/**\n* Run an arbitrary sequence of semicolon-delimited SQL commands\n*\n* Assumes that the input text (file or string) consists of\n* a number of SQL statements ENDING WITH SEMICOLONS.  The\n* semicolons MUST be the last character in a line.\n* Lines that are blank or that start with \"#\" or \"--\" (postgres) are ignored.\n* Only tested with mysql dump files (mysqldump -p -d limesurvey)\n* Function kindly borrowed by Moodle\n* @param string $sqlfile The path where a file with sql commands can be found on the server.\n* @param string $sqlstring If no path is supplied then a string with semicolon delimited sql\n* commands can be supplied in this argument.\n* @return bool Returns true if database was modified successfully.\n*/\nfunction modifyDatabase($sqlfile='', $sqlstring='')\n{\n    Yii::app()->loadHelper('database');\n    $clang = Yii::app()->lang;\n\n    global $siteadminemail;\n    global $siteadminname;\n    global $codeString;\n    global $modifyoutput;\n\n    $success = true;  // Let's be optimistic\n    $modifyoutput='';\n\n    if (!empty($sqlfile)) {\n        if (!is_readable($sqlfile)) {\n            $success = false;\n            echo '<p>Tried to modify database, but \"'. $sqlfile .'\" doesn\\'t exist!</p>';\n            return $success;\n        } else {\n            $lines = file($sqlfile);\n        }\n    } else {\n        $sqlstring = trim($sqlstring);\n        if ($sqlstring{strlen($sqlstring)-1} != \";\") {\n            $sqlstring .= \";\"; // add it in if it's not there.\n        }\n        $lines[] = $sqlstring;\n    }\n\n    $command = '';\n\n    foreach ($lines as $line) {\n        $line = rtrim($line);\n        $length = strlen($line);\n\n        if ($length and $line[0] <> '#' and substr($line,0,2) <> '--') {\n            if (substr($line, $length-1, 1) == ';') {\n                $line = substr($line, 0, $length-1);   // strip ;\n                $command .= $line;\n                $command = str_replace('prefix_', Yii::app()->db->tablePrefix, $command); // Table prefixes\n                $command = str_replace('$defaultuser', Yii::app()->getConfig('defaultuser'), $command);\n                $command = str_replace('$defaultpass', hash('sha256',Yii::app()->getConfig('defaultpass')), $command);\n                $command = str_replace('$siteadminname', $siteadminname, $command);\n                $command = str_replace('$siteadminemail', $siteadminemail, $command);\n                $command = str_replace('$defaultlang', Yii::app()->getConfig('defaultlang'), $command);\n                $command = str_replace('$databasetabletype', Yii::app()->db->getDriverName(), $command);\n\n                try\n                {   Yii::app()->db->createCommand($command)->query(); //Checked\n                    $command=htmlspecialchars($command);\n                    $modifyoutput .=\". \";\n                }\n                catch(CDbException $e)\n                {\n                    $command=htmlspecialchars($command);\n                    $modifyoutput .=\"<br />\".sprintf($clang->gT(\"SQL command failed: %s\"),\"<span style='font-size:10px;'>\".$command.\"</span>\",\"<span style='color:#ee0000;font-size:10px;'></span><br/>\");\n                    $success = false;\n                }\n\n                $command = '';\n            } else {\n                $command .= $line;\n            }\n        }\n    }\n\n    return $success;\n\n}\n\n/**\n* Returns labelsets for given language(s), or for all if null\n*\n* @param string $languages\n* @return array\n*/\nfunction getLabelSets($languages = null)\n{\n\n    $clang = Yii::app()->lang;\n    $languagesarray = array();\n    if ($languages)\n    {\n        $languages=sanitize_languagecodeS($languages);\n        $languagesarray=explode(' ',trim($languages));\n    }\n\n    $criteria = new CDbCriteria;\n    $criteria->order = \"label_name\";\n    foreach ($languagesarray as $k => $item)\n    {\n        $criteria->params[':lang_like1_' . $k] = \"% $item %\";\n        $criteria->params[':lang_' . $k] = $item;\n        $criteria->params[':lang_like2_' . $k] = \"% $item\";\n        $criteria->params[':lang_like3_' . $k] = \"$item %\";\n        $criteria->addCondition(\"\n        ((languages like :lang_like1_$k) or\n        (languages = :lang_$k) or\n        (languages like :lang_like2_$k) or\n        (languages like :lang_like3_$k))\");\n    }\n\n    $result = LabelSet::model()->findAll($criteria);\n    $labelsets=array();\n    foreach ($result as $row)\n        $labelsets[] = array($row->lid, $row->label_name);\n    return $labelsets;\n}\n\nfunction getHeader($meta = false)\n{\n    global $embedded,$surveyid ;\n    Yii::app()->loadHelper('surveytranslator');\n\n    // Set Langage // TODO remove one of the Yii::app()->session see bug #5901\n    if (Yii::app()->session['survey_'.$surveyid]['s_lang'] )\n    {\n        $languagecode =  Yii::app()->session['survey_'.$surveyid]['s_lang'];\n    }\n    elseif (isset($surveyid) && $surveyid  && Survey::model()->findByPk($surveyid))\n    {\n        $languagecode=Survey::model()->findByPk($surveyid)->language;\n    }\n    else\n    {\n        $languagecode = Yii::app()->getConfig('defaultlang');\n    }\n\n    $header=  \"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Transitional//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\\\">\\n\"\n    . \"<html xmlns=\\\"http://www.w3.org/1999/xhtml\\\" xml:lang=\\\"{$languagecode}\\\" lang=\\\"{$languagecode}\\\"\";\n    if (getLanguageRTL($languagecode))\n    {\n        $header.=\" dir=\\\"rtl\\\" \";\n    }\n    $header.= \">\\n\\t<head>\\n\";\n\n    if ($meta)\n        $header .= $meta;\n\n\n    if ( !$embedded )\n    {\n        return $header;\n    }\n\n    global $embedded_headerfunc;\n\n    if ( function_exists( $embedded_headerfunc ) )\n        return $embedded_headerfunc($header);\n}\n\n\nfunction doHeader()\n{\n    echo getHeader();\n}\n\n/**\n* This function returns the header for the printable survey\n* @return String\n*\n*/\nfunction getPrintableHeader()\n{\n    global $rooturl,$homeurl;\n    $headelements = '\n    <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\" />\n    <script type=\"text/javascript\" src=\"'.Yii::app()->getConfig('adminscripts').'printablesurvey.js\"></script>\n    ';\n    return $headelements;\n}\n\n// This function returns the Footer as result string\n// If you want to echo the Footer use doFooter() !\nfunction getFooter()\n{\n    global $embedded;\n    if ( !$embedded )\n    {\n        return \"\\n\\n\\t</body>\\n</html>\\n\";\n    }\n\n    global $embedded_footerfunc;\n\n    if ( function_exists( $embedded_footerfunc ) )\n        return $embedded_footerfunc();\n}\n\nfunction doFooter()\n{\n    echo getFooter();\n}\n\nfunction getDBTableUsage($surveyid){\n    Yii::app()->loadHelper('admin/activate');\n    $arrCols = activateSurvey($surveyid,$surveyid,'admin.php',true);\n\n    $length = 1;\n    foreach ($arrCols['fields'] as $col){\n        switch ($col[0]){\n            case 'C':\n                $length = $length + ($col[1]*3) + 1;\n                break;\n            case 'X':\n            case 'B':\n                $length = $length + 12;\n                break;\n            case 'D':\n                $length = $length + 3;\n                break;\n            case 'T':\n            case 'TS':\n            case 'N':\n                $length = $length + 8;\n                break;\n            case 'L':\n                $legth++;\n                break;\n            case 'I':\n            case 'I4':\n            case 'F':\n                $length = $length + 4;\n                break;\n            case 'I1':\n                $length = $length + 1;\n                break;\n            case 'I2':\n                $length = $length + 2;\n                break;\n            case 'I8':\n                $length = $length + 8;\n                break;\n        }\n    }\n    if ($arrCols['dbtype'] == 'mysql' || $arrCols['dbtype'] == 'mysqli'){\n        if ($arrCols['dbengine']=='myISAM'){\n            $hard_limit = 4096;\n        }\n        elseif ($arrCols['dbengine'] == \"InnoDB\"){\n            $hard_limit = 1000;\n        }\n        else{\n            return false;\n        }\n\n        $size_limit = 65535;\n    }\n    elseif ($arrCols['dbtype'] == 'postgre'){\n        $hard_limit = 1600;\n        $size_limit = 0;\n    }\n    elseif ($arrCols['dbtype'] == 'mssql' || $arrCols['dbtype'] == 'dblib'){ \n        $hard_limit = 1024;\n        $size_limit = 0;\n    }\n    else{\n        return false;\n    }\n\n    $columns_used = count($arrCols['fields']);\n\n\n\n    return (array( 'dbtype'=>$arrCols['dbtype'], 'column'=>array($columns_used,$hard_limit) , 'size' => array($length, $size_limit) ));\n}\n\n/**\n*  Checks that each object from an array of CSV data [question-rows,answer-rows,labelsets-row] supports at least a given language\n*\n* @param mixed $csvarray array with a line of csv data per row\n* @param mixed $idkeysarray  array of integers giving the csv-row numbers of the object keys\n* @param mixed $langfieldnum  integer giving the csv-row number of the language(s) filed\n*        ==> the language field  can be a single language code or a\n*            space separated language code list\n* @param mixed $langcode  the language code to be tested\n* @param mixed $hasheader  if we should strip off the first line (if it contains headers)\n*/\nfunction  doesImportArraySupportLanguage($csvarray,$idkeysarray,$langfieldnum,$langcode, $hasheader = false)\n{\n    // An array with one row per object id and langsupport status as value\n    $objlangsupportarray=Array();\n    if ($hasheader === true )\n    { // stripping first row to skip headers if any\n        array_shift($csvarray);\n    }\n\n    foreach ($csvarray as $csvrow)\n    {\n        $rowcontents = convertCSVRowToArray($csvrow,',','\"');\n        $rowid = \"\";\n        foreach ($idkeysarray as $idfieldnum)\n        {\n            $rowid .= $rowcontents[$idfieldnum].\"-\";\n        }\n        $rowlangarray = explode (\" \", @$rowcontents[$langfieldnum]);\n        if (!isset($objlangsupportarray[$rowid]))\n        {\n            if (array_search($langcode,$rowlangarray)!== false)\n            {\n                $objlangsupportarray[$rowid] = \"true\";\n            }\n            else\n            {\n                $objlangsupportarray[$rowid] = \"false\";\n            }\n        }\n        else\n        {\n            if ($objlangsupportarray[$rowid] == \"false\" &&\n            array_search($langcode,$rowlangarray) !== false)\n            {\n                $objlangsupportarray[$rowid] = \"true\";\n            }\n        }\n    } // end foreach rown\n\n    // If any of the object doesn't support the given language, return false\n    if (array_search(\"false\",$objlangsupportarray) === false)\n    {\n        return true;\n    }\n    else\n    {\n        return false;\n    }\n}\n\n\n/**\n* Retrieve a HTML <OPTION> list of survey admin users\n*\n* @param mixed $bIncludeOwner If the survey owner should be included\n* @param mixed $bIncludeSuperAdmins If Super admins should be included\n* @param int surveyid\n* @return string\n*/\nfunction getSurveyUserList($bIncludeOwner=true, $bIncludeSuperAdmins=true,$surveyid)\n{\n    $clang = Yii::app()->lang;\n    $surveyid=sanitize_int($surveyid);\n\n    $sSurveyIDQuery = \"SELECT a.uid, a.users_name, a.full_name FROM {{users}} AS a\n    LEFT OUTER JOIN (SELECT uid AS id FROM {{permissions}} WHERE entity_id = {$surveyid} and entity='survey') AS b ON a.uid = b.id\n    WHERE id IS NULL \";\n    if (!$bIncludeSuperAdmins)\n    {\n      // @todo: Adjust for new permission system - not urgent since it it just display\n      //   $sSurveyIDQuery.='and superadmin=0 ';     \n    }\n    $sSurveyIDQuery.= 'ORDER BY a.users_name';\n    $oSurveyIDResult = Yii::app()->db->createCommand($sSurveyIDQuery)->query();  //Checked\n    $aSurveyIDResult = $oSurveyIDResult->readAll();\n\n    $surveyselecter = \"\";\n\n    if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == true)\n    {\n\n        $authorizedUsersList = getUserList('onlyuidarray');\n    }\n\n        foreach($aSurveyIDResult as $sv)\n        {\n            if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == false ||\n            in_array($sv['uid'],$authorizedUsersList))\n            {\n                $surveyselecter .= \"<option\";\n                $surveyselecter .=\" value='{$sv['uid']}'>{$sv['users_name']} {$sv['full_name']}</option>\\n\";\n            }\n        }\n    if (!isset($svexist)) {$surveyselecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;}\n    else {$surveyselecter = \"<option value='-1'>\".$clang->gT(\"None\").\"</option>\\n\".$surveyselecter;}\n\n    return $surveyselecter;\n}\n\nfunction getSurveyUserGroupList($outputformat='htmloptions',$surveyid)\n{\n    $clang = Yii::app()->lang;\n    $surveyid=sanitize_int($surveyid);\n\n    $surveyidquery = \"SELECT a.ugid, a.name, MAX(d.ugid) AS da\n    FROM {{user_groups}} AS a\n    LEFT JOIN (\n    SELECT b.ugid\n    FROM {{user_in_groups}} AS b\n    LEFT JOIN (SELECT * FROM {{permissions}}\n    WHERE entity_id = {$surveyid} and entity='survey') AS c ON b.uid = c.uid WHERE c.uid IS NULL\n    ) AS d ON a.ugid = d.ugid GROUP BY a.ugid, a.name HAVING MAX(d.ugid) IS NOT NULL\";\n    $surveyidresult = Yii::app()->db->createCommand($surveyidquery)->query();  //Checked\n    $aResult=$surveyidresult->readAll();\n\n    $surveyselecter = \"\";\n\n    if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == true)\n    {\n        $authorizedGroupsList=getUserGroupList(NULL, 'simplegidarray');\n    }\n\n    foreach($aResult as $sv)\n    {\n        if (Yii::app()->getConfig('usercontrolSameGroupPolicy') == false ||\n        in_array($sv['ugid'],$authorizedGroupsList))\n        {\n            $surveyselecter .= \"<option\";\n            $surveyselecter .=\" value='{$sv['ugid']}'>{$sv['name']}</option>\\n\";\n            $simpleugidarray[] = $sv['ugid'];\n        }\n    }\n\n    if (!isset($svexist)) {$surveyselecter = \"<option value='-1' selected='selected'>\".$clang->gT(\"Please choose...\").\"</option>\\n\".$surveyselecter;}\n    else {$surveyselecter = \"<option value='-1'>\".$clang->gT(\"None\").\"</option>\\n\".$surveyselecter;}\n\n    if ($outputformat == 'simpleugidarray')\n    {\n        return $simpleugidarray;\n    }\n    else\n    {\n        return $surveyselecter;\n    }\n}\n\n\n\n/**\n* This function fixes the group ID and type on all subquestions\n*\n*/\nfunction fixSubquestions()\n{\n    $surveyidresult=Yii::app()->db->createCommand(\"select sq.qid, sq.parent_qid, sq.gid as sqgid, q.gid, sq.type as sqtype, q.type\n    from {{questions}} sq JOIN {{questions}} q on sq.parent_qid=q.qid\n    where sq.parent_qid>0 and  (sq.gid!=q.gid or sq.type!=q.type)\")->query();\n    foreach($surveyidresult->readAll() as $sv)\n    {\n        Yii::app()->db->createCommand(\"update {{questions}} set type='{$sv['type']}', gid={$sv['gid']} where qid={$sv['qid']}\")->query();\n    }\n\n}\n\n/**\n* Must use ls_json_encode to json_encode content, otherwise LimeExpressionManager will think that the associative arrays are expressions and try to parse them.\n*/\nfunction ls_json_encode($content)\n{\n    $ans = json_encode($content);\n    $ans = str_replace(array('{','}'),array('{ ',' }'), $ans);\n    return $ans;\n}\n\n/**\n * Decode a json string, sometimes needs stripslashes\n *\n * @param type $jsonString\n * @return type\n */\nfunction json_decode_ls($jsonString)\n{\n    $decoded = json_decode($jsonString, true);\n\n    if (is_null($decoded) && !empty($jsonString))\n    {\n        // probably we need stipslahes\n        $decoded = json_decode(stripslashes($jsonString), true);\n    }\n\n    return $decoded;\n}\n\n/**\n * Return accepted codingsArray for importing files\n *\n * Used in vvimport\n * TODO : use in token and \n * @return array\n */\nfunction aEncodingsArray()\n    {\n        $clang = Yii::app()->lang;\n        return array(\n        \"armscii8\" => $clang->gT(\"ARMSCII-8 Armenian\"),\n        \"ascii\" => $clang->gT(\"US ASCII\"),\n        \"auto\" => $clang->gT(\"Automatic\"),\n        \"big5\" => $clang->gT(\"Big5 Traditional Chinese\"),\n        \"binary\" => $clang->gT(\"Binary pseudo charset\"),\n        \"cp1250\" => $clang->gT(\"Windows Central European (Windows-1250)\"),\n        \"cp1251\" => $clang->gT(\"Windows Cyrillic (Windows-1251)\"),\n        \"cp1256\" => $clang->gT(\"Windows Arabic (Windows-1256)\"),\n        \"cp1257\" => $clang->gT(\"Windows Baltic (Windows-1257)\"),\n        \"cp850\" => $clang->gT(\"DOS West European (cp850)\"),\n        \"cp852\" => $clang->gT(\"DOS Central European (cp852)\"),\n        \"cp866\" => $clang->gT(\"DOS Cyrillic (cp866)\"),\n        \"cp932\" => $clang->gT(\"Windows-31J - SJIS for Windows Japanese (cp932)\"),\n        \"dec8\" => $clang->gT(\"DEC West European\"),\n        \"eucjpms\" => $clang->gT(\"UJIS for Windows Japanese\"),\n        \"euckr\" => $clang->gT(\"EUC-KR Korean\"),\n        \"gb2312\" => $clang->gT(\"GB2312 Simplified Chinese\"),\n        \"gbk\" => $clang->gT(\"GBK Simplified Chinese\"),\n        \"geostd8\" => $clang->gT(\"GEOSTD8 Georgian\"),\n        \"greek\" => $clang->gT(\"ISO 8859-7 Greek\"),\n        \"hebrew\" => $clang->gT(\"ISO 8859-8 Hebrew\"),\n        \"hp8\" => $clang->gT(\"HP West European\"),\n        \"keybcs2\" => $clang->gT(\"DOS Kamenicky Czech-Slovak (cp895)\"),\n        \"koi8r\" => $clang->gT(\"KOI8-R Relcom Russian\"),\n        \"koi8u\" => $clang->gT(\"KOI8-U Ukrainian\"),\n        \"latin1\" => $clang->gT(\"ISO 8859-1 West European (latin1)\"),\n        \"latin2\" => $clang->gT(\"ISO 8859-2 Central European (latin2)\"),\n        \"latin5\" => $clang->gT(\"ISO 8859-9 Turkish (latin5)\"),\n        \"latin7\" => $clang->gT(\"ISO 8859-13 Baltic (latin7)\"),\n        \"macce\" => $clang->gT(\"Mac Central European\"),\n        \"macroman\" => $clang->gT(\"Mac West European\"),\n        \"sjis\" => $clang->gT(\"Shift-JIS Japanese\"),\n        \"swe7\" => $clang->gT(\"7bit Swedish\"),\n        \"tis620\" => $clang->gT(\"TIS620 Thai\"),\n        \"ucs2\" => $clang->gT(\"UCS-2 Unicode\"),\n        \"ujis\" => $clang->gT(\"EUC-JP Japanese\"),\n        \"utf8\" => $clang->gT(\"UTF-8 Unicode\"),\n        );\n    }\n/**\n* Swaps two positions in an array\n*\n* @param mixed $key1\n* @param mixed $key2\n* @param mixed $array\n*/\nfunction arraySwapAssoc($key1, $key2, $array) {\n    $newArray = array ();\n    foreach ($array as $key => $value) {\n        if ($key == $key1) {\n            $newArray[$key2] = $array[$key2];\n        } elseif ($key == $key2) {\n            $newArray[$key1] = $array[$key1];\n        } else {\n            $newArray[$key] = $value;\n        }\n    }\n    return $newArray;\n}\n\n\n/**\n* Ellipsize String\n*\n* This public static function will strip tags from a string, split it at its max_length and ellipsize\n*\n* @param    string        string to ellipsize\n* @param    integer        max length of string\n* @param    mixed        int (1|0) or float, .5, .2, etc for position to split\n* @param    string        ellipsis ; Default '...'\n* @return    string        ellipsized string\n*/\nfunction ellipsize($sString, $iMaxLength, $fPosition = 1, $sEllipsis = '&hellip;')\n{\n    // Strip tags\n    $sString = trim(strip_tags($sString));\n    // Is the string long enough to ellipsize?\n    if (mb_strlen($sString,'UTF-8') <= $iMaxLength+3)\n    {\n        return $sString;\n    }\n\n    $iStrLen=mb_strlen($sString,'UTF-8');\n    $sBegin = mb_substr($sString, 0, floor($iMaxLength * $fPosition),'UTF-8');\n    $sEnd = mb_substr($sString,$iStrLen-($iMaxLength-mb_strlen($sBegin,'UTF-8')),$iStrLen,'UTF-8');\n    return $sBegin.$sEllipsis.$sEnd;\n}\n\n/**\n* This function returns the real IP address under all configurations\n*\n*/\nfunction getIPAddress()\n{\n    if (!empty($_SERVER['HTTP_CLIENT_IP']))   //check ip from share internet\n    {\n        $sIPAddress=$_SERVER['HTTP_CLIENT_IP'];\n    }\n    elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']))   //to check ip is pass from proxy\n    {\n        $sIPAddress= $_SERVER['HTTP_X_FORWARDED_FOR'];\n    }\n    elseif (!empty($_SERVER['REMOTE_ADDR']))\n    {\n        $sIPAddress= $_SERVER['REMOTE_ADDR'];\n    }\n    else\n    {\n        $sIPAddress= '127.0.0.1';\n    }\n    if (!filter_var($sIPAddress, FILTER_VALIDATE_IP))\n    {\n        return 'Invalid';\n    }\n    else\n    {\n       return $sIPAddress;\n    }\n}\n\n\n/**\n* This function tries to find out a valid language code for the language of the browser used\n* If it cannot find it it will return the default language from global settings\n*\n*/\nfunction getBrowserLanguage()\n{\n    $sLanguage=Yii::app()->getRequest()->getPreferredLanguage();\n    Yii::app()->loadHelper(\"surveytranslator\");\n    $aLanguages=getLanguageData();\n    if (!isset($aLanguages[$sLanguage]))\n    {\n        $sLanguage=str_replace('_','-',$sLanguage);\n        if (!isset($aLanguages[$sLanguage]))\n        {\n            $sLanguage=substr($sLanguage,0,strpos($sLanguage,'-'));\n            if (!isset($aLanguages[$sLanguage]))\n            {\n                $sLanguage=Yii::app()->getConfig('defaultlang');\n            }\n        }\n    }\n    return $sLanguage;\n}\n\nfunction array_diff_assoc_recursive($array1, $array2) {\n    $difference=array();\n    foreach($array1 as $key => $value) {\n        if( is_array($value) ) {\n            if( !isset($array2[$key]) || !is_array($array2[$key]) ) {\n                $difference[$key] = $value;\n            } else {\n                $new_diff = array_diff_assoc_recursive($value, $array2[$key]);\n                if( !empty($new_diff) )\n                    $difference[$key] = $new_diff;\n            }\n        } else if( !array_key_exists($key,$array2) || $array2[$key] !== $value ) {\n            $difference[$key] = $value;\n        }\n    }\n    return $difference;\n}\n\n\n    function convertPHPSizeToBytes($sSize)  \n    {  \n        //This function transforms the php.ini notation for numbers (like '2M') to an integer (2*1024*1024 in this case)  \n        $sSuffix = substr($sSize, -1);  \n        $iValue = substr($sSize, 0, -1);  \n        switch(strtoupper($sSuffix)){  \n        case 'P':  \n            $iValue *= 1024;  \n        case 'T':  \n            $iValue *= 1024;  \n        case 'G':  \n            $iValue *= 1024;  \n        case 'M':  \n            $iValue *= 1024;  \n        case 'K':  \n            $iValue *= 1024;  \n            break;  \n        }  \n        return $iValue;  \n    }  \n      \n    function getMaximumFileUploadSize()  \n    {  \n        return min(convertPHPSizeToBytes(ini_get('post_max_size')), convertPHPSizeToBytes(ini_get('upload_max_filesize')));  \n    }  \n\n// Closing PHP tag intentionally omitted - yes, it is okay\n\n", "<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');\n/*\n* LimeSurvey\n* Copyright (C) 2007-2012 The LimeSurvey Project Team / Carsten Schmitz\n* All rights reserved.\n* License: GNU/GPL License v2 or later, see LICENSE.php\n* LimeSurvey is free software. This version may have been modified pursuant\n* to the GNU General Public License, and as distributed it includes or\n* is derivative of works licensed under the GNU General Public License or\n* other free or open source software licenses.\n* See COPYRIGHT.php for copyright notices and details.\n*/\n\nfunction loadanswers()\n{\n    global $surveyid;\n    global $thissurvey, $thisstep;\n    global $clienttoken;\n    $clang = Yii::app()->lang;\n\n    $scid=returnGlobal('scid',true);\n    if (Yii::app()->request->getParam('loadall') == \"reload\")\n    {\n        $query = \"SELECT * FROM {{saved_control}} INNER JOIN {$thissurvey['tablename']}\n        ON {{saved_control}}.srid = {$thissurvey['tablename']}.id\n        WHERE {{saved_control}}.sid=$surveyid\\n\";\n        if (isset($scid)) //Would only come from email\n\n        {\n            $query .= \"AND {{saved_control}}.scid={$scid}\\n\";\n        }\n        $query .=\"AND {{saved_control}}.identifier = '\".Yii::app()->db->quoteValue($_SESSION['survey_'.$surveyid]['holdname']).\"' \";\n\n        if (in_array(Yii::app()->db->getDriverName(), array('mssql', 'sqlsrv', 'dblib')))\n        {\n            $query .=\"AND CAST({{saved_control}}.access_code as varchar(32))= '\".md5($_SESSION['survey_'.$surveyid]['holdpass']).\"'\\n\";\n        }\n        else\n        {\n            $query .=\"AND {{saved_control}}.access_code = '\".md5($_SESSION['survey_'.$surveyid]['holdpass']).\"'\\n\";// md5 don't need to be escaped\n        }\n    }\n    elseif (isset($_SESSION['survey_'.$surveyid]['srid']))\n    {\n        $query = \"SELECT * FROM {$thissurvey['tablename']}\n        WHERE {$thissurvey['tablename']}.id=\".$_SESSION['survey_'.$surveyid]['srid'].\"\\n\";\n    }\n    else\n    {\n        return;\n    }\n    $aRow = Yii::app()->db->createCommand($query)->queryRow();// TODO : use Yii for query\n    if (!$aRow)\n    {\n        return false;\n    }\n    else\n    {\n        //A match has been found. Let's load the values!\n        //If this is from an email, build surveysession first\n        $_SESSION['survey_'.$surveyid]['LEMtokenResume']=true;\n        // Get if survey is been answered\n        $submitdate=$aRow['submitdate'];\n        foreach ($aRow as $column => $value)\n        {\n            if ($column == \"token\")\n            {\n                $clienttoken=$value;\n                $token=$value;\n            }\n            elseif ($column == \"saved_thisstep\" && $thissurvey['alloweditaftercompletion'] != 'Y' )\n            {\n                $_SESSION['survey_'.$surveyid]['step']=($value>1? $value:1) ;\n                $thisstep=$_SESSION['survey_'.$surveyid]['step']-1;\n            }\n            elseif ($column =='lastpage' && isset($_GET['token']))\n            {\n                if(is_null($submitdate) || $submitdate==\"N\")\n                {\n                    $_SESSION['survey_'.$surveyid]['step']=($value>1? $value:1) ;\n                    $thisstep=$_SESSION['survey_'.$surveyid]['step']-1;\n                }\n                else\n                {\n                    $_SESSION['survey_'.$surveyid]['maxstep']=($value>1? $value:1) ;\n                }\n            }\n            /*\n            Commented this part out because otherwise startlanguage would overwrite any other language during a running survey.\n            We will need a new field named 'endlanguage' to save the current language (for example for returning participants)\n            /the language the survey was completed in.\n            elseif ($column =='startlanguage')\n            {\n            $clang = SetSurveyLanguage( $surveyid, $value);\n            UpdateSessionGroupList($value);  // to refresh the language strings in the group list session variable\n            UpdateFieldArray();        // to refresh question titles and question text\n            }*/\n            elseif ($column == \"scid\")\n            {\n                $_SESSION['survey_'.$surveyid]['scid']=$value;\n            }\n            elseif ($column == \"srid\")\n            {\n                $_SESSION['survey_'.$surveyid]['srid']=$value;\n            }\n            elseif ($column == \"datestamp\")\n            {\n                $_SESSION['survey_'.$surveyid]['datestamp']=$value;\n            }\n            if ($column == \"startdate\")\n            {\n                $_SESSION['survey_'.$surveyid]['startdate']=$value;\n            }\n            else\n            {\n                //Only make session variables for those in insertarray[]\n                if (in_array($column, $_SESSION['survey_'.$surveyid]['insertarray']) && isset($_SESSION['survey_'.$surveyid]['fieldmap'][$column]))\n                {\n                    if (($_SESSION['survey_'.$surveyid]['fieldmap'][$column]['type'] == 'N' ||\n                    $_SESSION['survey_'.$surveyid]['fieldmap'][$column]['type'] == 'K' ||\n                    $_SESSION['survey_'.$surveyid]['fieldmap'][$column]['type'] == 'D') && $value == null)\n                    {   // For type N,K,D NULL in DB is to be considered as NoAnswer in any case.\n                        // We need to set the _SESSION[field] value to '' in order to evaluate conditions.\n                        // This is especially important for the deletenonvalue feature,\n                        // otherwise we would erase any answer with condition such as EQUALS-NO-ANSWER on such\n                        // question types (NKD)\n                        $_SESSION['survey_'.$surveyid][$column]='';\n                    }\n                    else\n                    {\n                        $_SESSION['survey_'.$surveyid][$column]=$value;\n                    }\n                }  // if (in_array(\n            }  // else\n        } // foreach\n    }\n    return true;\n}\n\nfunction makegraph($currentstep, $total)\n{\n    global $thissurvey;\n\n    $clang = Yii::app()->lang;\n    Yii::app()->getClientScript()->registerCssFile(Yii::app()->getConfig('publicstyleurl') . 'lime-progress.css');\n    $size = intval(($currentstep-1)/$total*100);\n\n    $graph = '<script type=\"text/javascript\">\n    $(document).ready(function() {\n    $(\"#progressbar\").progressbar({\n    value: '.$size.'\n    });\n    ;});';\n    if (getLanguageRTL($clang->langcode))\n    {\n        $graph.='\n        $(document).ready(function() {\n        $(\"div.ui-progressbar-value\").removeClass(\"ui-corner-left\");\n        $(\"div.ui-progressbar-value\").addClass(\"ui-corner-right\");\n        });';\n    }\n    $graph.='\n    </script>\n\n    <div id=\"progress-wrapper\">\n    <span class=\"hide\">'.sprintf($clang->gT('You have completed %s%% of this survey'),$size).'</span>\n    <div id=\"progress-pre\">';\n    if (getLanguageRTL($clang->langcode))\n    {\n        $graph.='100%';\n    }\n    else\n    {\n        $graph.='0%';\n    }\n\n    $graph.='</div>\n    <div id=\"progressbar\"></div>\n    <div id=\"progress-post\">';\n    if (getLanguageRTL($clang->langcode))\n    {\n        $graph.='0%';\n    }\n    else\n    {\n        $graph.='100%';\n    }\n    $graph.='</div>\n    </div>';\n\n    if ($size == 0) // Progress bar looks dumb if 0\n\n    {\n        $graph.='\n        <script type=\"text/javascript\">\n        $(document).ready(function() {\n        $(\"div.ui-progressbar-value\").hide();\n        });\n        </script>';\n    }\n\n    return $graph;\n}\n\n/**\n* This function creates the language selector for a particular survey\n*\n* @param mixed $sSelectedLanguage The language in which all information is shown\n*/\nfunction makeLanguageChangerSurvey($sSelectedLanguage)\n{\n    $surveyid = Yii::app()->getConfig('surveyID');\n    $clang = Yii::app()->lang;\n    Yii::app()->loadHelper(\"surveytranslator\");\n\n    $aSurveyLangs = Survey::model()->findByPk($surveyid)->getAllLanguages();\n    if (count($aSurveyLangs)>1) // return a dropdow only of there are more than one lanagage\n    {\n        $aAllLanguages=getLanguageData(true);\n        $aSurveyLangs=array_intersect_key($aAllLanguages,array_flip($aSurveyLangs)); // Sort languages by their locale name\n        $sClass=\"languagechanger\";\n        $sHTMLCode=\"\";\n        $sAction=Yii::app()->request->getParam('action','');// Different behaviour if preview\n        $sSelected=\"\";\n        if(substr($sAction,0,7)=='preview')\n        {\n            $route=\"/survey/index/sid/{$surveyid}\";\n            if ($sAction=='previewgroup' && intval(Yii::app()->request->getParam('gid',0)))\n            {\n                $route.=\"/action/previewgroup/gid/\".intval(Yii::app()->request->getParam('gid',0));\n            }\n            if ($sAction=='previewquestion' && intval(Yii::app()->request->getParam('gid',0)) && intval(Yii::app()->request->getParam('qid',0)))\n            {\n                $route.=\"/action/previewquestion/gid/\".intval(Yii::app()->request->getParam('gid',0)).\"/qid/\".intval(Yii::app()->request->getParam('qid',0));\n            }\n            if (!is_null(Yii::app()->request->getParam('token')))\n            {\n                $route.=\"/token/\".Yii::app()->request->getParam('token');\n            }\n            $sClass.=\" previewmode\";\n            // Maybe add other param (for prefilling by URL): then need a real createUrl with array\n#            foreach ($aSurveyLangs as $sLangCode => $aSurveyLang)\n#            {\n#                $sTargetURL=Yii::app()->getController()->createUrl($route.\"/lang/$sLangCode\");\n#                $aListLang[$sTargetURL]=html_entity_decode($aSurveyLang['nativedescription'], ENT_COMPAT,'UTF-8');\n#                if($clang->langcode==$sLangCode)\n#                    $sSelected=$sTargetURL;\n#            }\n        }\n        else\n        {\n            $route=\"/survey/index/sid/{$surveyid}\";\n        }\n        $sTargetURL=Yii::app()->getController()->createUrl($route);\n        foreach ($aSurveyLangs as $sLangCode => $aSurveyLang)\n        {\n            $aListLang[$sLangCode]=html_entity_decode($aSurveyLang['nativedescription'], ENT_COMPAT,'UTF-8');\n        }\n        $sSelected=$clang->langcode;\n        $sHTMLCode=CHtml::label($clang->gT(\"Choose another language\"), 'lang',array('class'=>'hide label'));\n        $sHTMLCode.=CHtml::dropDownList('lang', $sSelected,$aListLang,array('class'=>$sClass,'data-targeturl'=>$sTargetURL));\n        // We don't have to add this button if in previewmode\n        $sHTMLCode.= CHtml::htmlButton($clang->gT(\"Change the language\"),array('type'=>'submit','id'=>\"changelangbtn\",'value'=>'changelang','name'=>'changelang','class'=>'changelang jshide'));\n        return $sHTMLCode;\n    }\n    else\n    {\n        return false;\n    }\n\n}\n\n/**\n* This function creates the language selector for the public survey index page\n*\n* @param mixed $sSelectedLanguage The language in which all information is shown\n*/\nfunction makeLanguageChanger($sSelectedLanguage)\n{\n    $aLanguages=getLanguageDataRestricted(true,$sSelectedLanguage);// Order by native\n    if(count($aLanguages)>1)\n    {\n#        $sHTMLCode = \"<select id='languagechanger' name='languagechanger' class='languagechanger' onchange='javascript:window.location=this.value'>\\n\";\n#        foreach(getLanguageDataRestricted(true, $sSelectedLanguage) as $sLanguageID=>$aLanguageProperties)\n#        {\n#            $sLanguageUrl=Yii::app()->getController()->createUrl('survey/index',array('lang'=>$sLanguageID));\n#            $sHTMLCode .= \"<option value='{$sLanguageUrl}'\";\n#            if($sLanguageID == $sSelectedLanguage)\n#            {\n#                $sHTMLCode .= \" selected='selected' \";\n#                $sHTMLCode .= \">{$aLanguageProperties['nativedescription']}</option>\\n\";\n#            }\n#            else\n#            {\n#                $sHTMLCode .= \">\".$aLanguageProperties['nativedescription'].' - '.$aLanguageProperties['description'].\"</option>\\n\";\n#            }\n#        }\n#        $sHTMLCode .= \"</select>\\n\";\n        $clang = Yii::app()->lang;\n        $sClass= \"languagechanger\";\n        foreach ($aLanguages as $sLangCode => $aLanguage)\n            $aListLang[$sLangCode]=html_entity_decode($aLanguage['nativedescription'], ENT_COMPAT,'UTF-8').' - '.$aLanguage['description'];\n        $sSelected=$sSelectedLanguage;\n\n        $sHTMLCode= CHtml::beginForm(App()->createUrl('surveys/publiclist'),'get');\n        $sHTMLCode.=CHtml::label($clang->gT(\"Choose another language\"), 'lang',array('class'=>'hide label'));\n        $sHTMLCode.= CHtml::dropDownList('lang', $sSelected,$aListLang,array('class'=>$sClass));\n        //$sHTMLCode.= CHtml::htmlButton($clang->gT(\"Change the language\"),array('type'=>'submit','id'=>\"changelangbtn\",'value'=>'changelang','name'=>'changelang','class'=>'jshide'));\n        $sHTMLCode.=\"<button class='changelang jshide' value='changelang' id='changelangbtn' type='submit'>\".$clang->gT(\"Change the language\").\"</button>\";\n        $sHTMLCode.= CHtml::endForm();\n        return $sHTMLCode;\n    }\n    else\n    {\n        return false;\n    }\n}\n\n\n\n/**\n* checkUploadedFileValidity used in SurveyRuntimeHelper\n*/\nfunction checkUploadedFileValidity($surveyid, $move, $backok=null)\n{\n    global $thisstep;\n    $clang = Yii::app()->lang;\n\n    if (!isset($backok) || $backok != \"Y\")\n    {\n        $fieldmap = createFieldMap($surveyid,'full',false,false,$_SESSION['survey_'.$surveyid]['s_lang']);\n\n        if (isset($_POST['fieldnames']) && $_POST['fieldnames']!=\"\")\n        {\n            $fields = explode(\"|\", $_POST['fieldnames']);\n\n            foreach ($fields as $field)\n            {\n                if ($fieldmap[$field]['type'] == \"|\" && !strrpos($fieldmap[$field]['fieldname'], \"_filecount\"))\n                {\n                    $validation= getQuestionAttributeValues($fieldmap[$field]['qid']);\n\n                    $filecount = 0;\n\n                    $json = $_POST[$field];\n                    // if name is blank, its basic, hence check\n                    // else, its ajax, don't check, bypass it.\n\n                    if ($json != \"\" && $json != \"[]\")\n                    {\n                        $phparray = json_decode(stripslashes($json));\n                        if ($phparray[0]->size != \"\")\n                        { // ajax\n                            $filecount = count($phparray);\n                        }\n                        else\n                        { // basic\n                            for ($i = 1; $i <= $validation['max_num_of_files']; $i++)\n                            {\n                                if (!isset($_FILES[$field.\"_file_\".$i]) || $_FILES[$field.\"_file_\".$i]['name'] == '')\n                                    continue;\n\n                                $filecount++;\n\n                                $file = $_FILES[$field.\"_file_\".$i];\n\n                                // File size validation\n                                if ($file['size'] > $validation['max_filesize'] * 1000)\n                                {\n                                    $filenotvalidated = array();\n                                    $filenotvalidated[$field.\"_file_\".$i] = sprintf($clang->gT(\"Sorry, the uploaded file (%s) is larger than the allowed filesize of %s KB.\"), $file['size'], $validation['max_filesize']);\n                                    $append = true;\n                                }\n\n                                // File extension validation\n                                $pathinfo = pathinfo(basename($file['name']));\n                                $ext = $pathinfo['extension'];\n\n                                $validExtensions = explode(\",\", $validation['allowed_filetypes']);\n                                if (!(in_array($ext, $validExtensions)))\n                                {\n                                    if (isset($append) && $append)\n                                    {\n                                        $filenotvalidated[$field.\"_file_\".$i] .= sprintf($clang->gT(\"Sorry, only %s extensions are allowed!\"),$validation['allowed_filetypes']);\n                                        unset($append);\n                                    }\n                                    else\n                                    {\n                                        $filenotvalidated = array();\n                                        $filenotvalidated[$field.\"_file_\".$i] .= sprintf($clang->gT(\"Sorry, only %s extensions are allowed!\"),$validation['allowed_filetypes']);\n                                    }\n                                }\n                            }\n                        }\n                    }\n                    else\n                        $filecount = 0;\n\n                    if (isset($validation['min_num_of_files']) && $filecount < $validation['min_num_of_files'] && LimeExpressionManager::QuestionIsRelevant($fieldmap[$field]['qid']))\n                    {\n                        $filenotvalidated = array();\n                        $filenotvalidated[$field] = $clang->gT(\"The minimum number of files has not been uploaded.\");\n                    }\n                }\n            }\n        }\n        if (isset($filenotvalidated))\n        {\n            if (isset($move) && $move == \"moveprev\")\n                $_SESSION['survey_'.$surveyid]['step'] = $thisstep;\n            if (isset($move) && $move == \"movenext\")\n                $_SESSION['survey_'.$surveyid]['step'] = $thisstep;\n            return $filenotvalidated;\n        }\n    }\n    if (!isset($filenotvalidated))\n        return false;\n    else\n        return $filenotvalidated;\n}\n\n/**\n* Takes two single element arrays and adds second to end of first if value exists\n* Why not use array_merge($array1,array_filter($array2);\n*/\nfunction addtoarray_single($array1, $array2)\n{\n    //\n    if (is_array($array2))\n    {\n        foreach ($array2 as $ar)\n        {\n            if ($ar && $ar !== null)\n            {\n                $array1[]=$ar;\n            }\n        }\n    }\n    return $array1;\n}\n\n/**\n* Marks a tokens as completed and sends a confirmation email to the participiant.\n* If $quotaexit is set to true then the user exited the survey due to a quota\n* restriction and the according token is only marked as 'Q'\n*\n* @param mixed $quotaexit\n*/\nfunction submittokens($quotaexit=false)\n{\n    $surveyid=Yii::app()->getConfig('surveyID');\n    if(isset($_SESSION['survey_'.$surveyid]['s_lang']))\n    {\n        $thissurvey=getSurveyInfo($surveyid,$_SESSION['survey_'.$surveyid]['s_lang']);\n    }\n    else\n    {\n        $thissurvey=getSurveyInfo($surveyid);\n    }\n    $clienttoken = $_SESSION['survey_'.$surveyid]['token'];\n\n    $sitename = Yii::app()->getConfig(\"sitename\");\n    $emailcharset = Yii::app()->getConfig(\"emailcharset\");\n    // Shift the date due to global timeadjust setting\n    $today = dateShift(date(\"Y-m-d H:i:s\"), \"Y-m-d H:i\", Yii::app()->getConfig(\"timeadjust\"));\n\n    // check how many uses the token has left\n\t$token = Token::model($surveyid)->findByAttributes(array('token' => $clienttoken));\n\n\tif ($quotaexit==true)\n    {\n        $token->completed = 'Q';\n        $token->usesleft--;\n    }\n    else\n    {\n        if ($token->usesleft <= 1)\n        {\n            // Finish the token\n            if (isTokenCompletedDatestamped($thissurvey))\n            {\n                $token->completed = $today;\n            } else {\n                $token->completed = 'Y';\n            }\n            if(isset($token->participant_id))\n            {\n                $slquery = SurveyLink::model()->find('participant_id = :pid AND survey_id = :sid AND token_id = :tid', array(':pid'=> $token->participant_id, ':sid'=>$surveyid, ':tid'=>$token->tid));\n                if ($slquery)\n                {                \n                    if (isTokenCompletedDatestamped($thissurvey))\n                    {\n                        $slquery->date_completed = $today;\n                    } else {\n                        // Update the survey_links table if necessary, to protect anonymity, use the date_created field date\n                        $slquery->date_completed = $slquery->date_created;\n                    }\n                    $slquery->save();\n                }\n            }\n        }\n        $token->usesleft--;\n    }\n    $token->save();\n\n    if ($quotaexit==false)\n    {\n        if ($token && trim(strip_tags($thissurvey['email_confirm'])) != \"\" && $thissurvey['sendconfirmation'] == \"Y\")\n        {\n         //   if($token->completed == \"Y\" || $token->completed == $today)\n//            {\n                $from = \"{$thissurvey['adminname']} <{$thissurvey['adminemail']}>\";\n                $to = $token->email;\n                $subject=$thissurvey['email_confirm_subj'];\n\n                $aReplacementVars=array();\n                $aReplacementVars[\"ADMINNAME\"]=$thissurvey['admin'];\n                $aReplacementVars[\"ADMINEMAIL\"]=$thissurvey['adminemail'];\n                $aReplacementVars['ADMINEMAIL'] = $thissurvey['adminemail'];\n                //Fill with token info, because user can have his information with anonimity control\n                $aReplacementVars[\"FIRSTNAME\"]=$token->firstname;\n                $aReplacementVars[\"LASTNAME\"]=$token->lastname;\n                $aReplacementVars[\"TOKEN\"]=$token->token;\n                // added survey url in replacement vars\n                $surveylink = Yii::app()->createAbsoluteUrl(\"/survey/index/sid/{$surveyid}\",array('lang'=>$_SESSION['survey_'.$surveyid]['s_lang'],'token'=>$token->token));\n                $aReplacementVars['SURVEYURL'] = $surveylink;\n                \n                $attrfieldnames=getAttributeFieldNames($surveyid);\n                foreach ($attrfieldnames as $attr_name)\n                {\n                    $aReplacementVars[strtoupper($attr_name)] = $token->$attr_name;\n                }\n\n                $dateformatdatat=getDateFormatData($thissurvey['surveyls_dateformat']);\n                $numberformatdatat = getRadixPointData($thissurvey['surveyls_numberformat']);\n                $redata=array('thissurvey'=>$thissurvey);\n                $subject=templatereplace($subject,$aReplacementVars,$redata);\n\n                $subject=html_entity_decode($subject,ENT_QUOTES,$emailcharset);\n\n                if (getEmailFormat($surveyid) == 'html')\n                {\n                    $ishtml=true;\n                }\n                else\n                {\n                    $ishtml=false;\n                }\n\n                $message=$thissurvey['email_confirm'];\n                //$message=ReplaceFields($message, $fieldsarray, true);\n                $message=templatereplace($message,$aReplacementVars,$redata);\n                if (!$ishtml)\n                {\n                    $message=strip_tags(breakToNewline(html_entity_decode($message,ENT_QUOTES,$emailcharset)));\n                }\n                else\n                {\n                    $message=html_entity_decode($message,ENT_QUOTES, $emailcharset );\n                }\n\n                //Only send confirmation email if there is a valid email address\n            if (validateEmailAddress($to)) {\n                $aAttachments = unserialize($thissurvey['attachments']);\n    \n                $aRelevantAttachments = array();\n                /*\n                 * Iterate through attachments and check them for relevance.\n                 */\n                if (isset($aAttachments['confirmation']))\n                {\n                    foreach ($aAttachments['confirmation'] as $aAttachment)\n                    {\n                        $relevance = $aAttachment['relevance'];\n                        // If the attachment is relevant it will be added to the mail.\n                        if (LimeExpressionManager::ProcessRelevance($relevance) && file_exists($aAttachment['url']))\n                        {\n                            $aRelevantAttachments[] = $aAttachment['url'];\n                        }\n                    }\n                }\n                SendEmailMessage($message, $subject, $to, $from, $sitename, $ishtml, null, $aRelevantAttachments);\n            }\n     //   } else {\n                // Leave it to send optional confirmation at closed token\n  //          }\n        }\n    }\n}\n\n/**\n* Send a submit notification to the email address specified in the notifications tab in the survey settings\n*/\nfunction sendSubmitNotifications($surveyid)\n{\n    // @todo: Remove globals\n    global $thissurvey, $maildebug, $tokensexist;\n    \n    if (trim($thissurvey['adminemail'])=='')\n    {\n        return;\n    }\n    \n    $homeurl=Yii::app()->createAbsoluteUrl('/admin');\n    $clang = Yii::app()->lang;\n    $sitename = Yii::app()->getConfig(\"sitename\");\n\n    $debug=Yii::app()->getConfig('debug');\n    $bIsHTML = ($thissurvey['htmlemail'] == 'Y');\n\n    $aReplacementVars=array();\n\n    if ($thissurvey['allowsave'] == \"Y\" && isset($_SESSION['survey_'.$surveyid]['scid']))\n    {\n        $aReplacementVars['RELOADURL']=\"\".Yii::app()->getController()->createUrl(\"/survey/index/sid/{$surveyid}/loadall/reload/scid/\".$_SESSION['survey_'.$surveyid]['scid'].\"/loadname/\".urlencode($_SESSION['survey_'.$surveyid]['holdname']).\"/loadpass/\".urlencode($_SESSION['survey_'.$surveyid]['holdpass']).\"/lang/\".urlencode($clang->langcode));\n        if ($bIsHTML)\n        {\n            $aReplacementVars['RELOADURL']=\"<a href='{$aReplacementVars['RELOADURL']}'>{$aReplacementVars['RELOADURL']}</a>\";\n        }\n    }\n    else\n    {\n        $aReplacementVars['RELOADURL']='';\n    }\n\n    if (!isset($_SESSION['survey_'.$surveyid]['srid']))\n        $srid = null;\n    else\n        $srid = $_SESSION['survey_'.$surveyid]['srid'];\n    $aReplacementVars['ADMINNAME'] = $thissurvey['adminname'];\n    $aReplacementVars['ADMINEMAIL'] = $thissurvey['adminemail'];\n    $aReplacementVars['VIEWRESPONSEURL']=Yii::app()->createAbsoluteUrl(\"/admin/responses/sa/view/surveyid/{$surveyid}/id/{$srid}\");\n    $aReplacementVars['EDITRESPONSEURL']=Yii::app()->createAbsoluteUrl(\"/admin/dataentry/sa/editdata/subaction/edit/surveyid/{$surveyid}/id/{$srid}\");\n    $aReplacementVars['STATISTICSURL']=Yii::app()->createAbsoluteUrl(\"/admin/statistics/sa/index/surveyid/{$surveyid}\");\n    if ($bIsHTML)\n    {\n        $aReplacementVars['VIEWRESPONSEURL']=\"<a href='{$aReplacementVars['VIEWRESPONSEURL']}'>{$aReplacementVars['VIEWRESPONSEURL']}</a>\";\n        $aReplacementVars['EDITRESPONSEURL']=\"<a href='{$aReplacementVars['EDITRESPONSEURL']}'>{$aReplacementVars['EDITRESPONSEURL']}</a>\";\n        $aReplacementVars['STATISTICSURL']=\"<a href='{$aReplacementVars['STATISTICSURL']}'>{$aReplacementVars['STATISTICSURL']}</a>\";\n    }\n    $aReplacementVars['ANSWERTABLE']='';\n    $aEmailResponseTo=array();\n    $aEmailNotificationTo=array();\n    $sResponseData=\"\";\n\n    if (!empty($thissurvey['emailnotificationto']))\n    {\n        $aRecipient=explode(\";\", ReplaceFields($thissurvey['emailnotificationto'],array('ADMINEMAIL' =>$thissurvey['adminemail'] ), true));\n        foreach($aRecipient as $sRecipient)\n        {\n            if(validateEmailAddress($sRecipient))\n            {\n                $aEmailNotificationTo[]=$sRecipient;\n            }\n        }\n    }\n\n    if (!empty($thissurvey['emailresponseto']))\n    {\n        // there was no token used so lets remove the token field from insertarray\n        if (!isset($_SESSION['survey_'.$surveyid]['token']) && $_SESSION['survey_'.$surveyid]['insertarray'][0]=='token')\n        {\n            unset($_SESSION['survey_'.$surveyid]['insertarray'][0]);\n        }\n        //Make an array of email addresses to send to\n        $aRecipient=explode(\";\", ReplaceFields($thissurvey['emailresponseto'],array('ADMINEMAIL' =>$thissurvey['adminemail'] ), true));\n        foreach($aRecipient as $sRecipient)\n        {\n            if(validateEmailAddress($sRecipient))\n            {\n                $aEmailResponseTo[]=$sRecipient;\n            }\n        }\n\n        $aFullResponseTable=getFullResponseTable($surveyid,$_SESSION['survey_'.$surveyid]['srid'],$_SESSION['survey_'.$surveyid]['s_lang']);\n        $ResultTableHTML = \"<table class='printouttable' >\\n\";\n        $ResultTableText =\"\\n\\n\";\n        $oldgid = 0;\n        $oldqid = 0;\n        foreach ($aFullResponseTable as $sFieldname=>$fname)\n        {\n            if (substr($sFieldname,0,4)=='gid_')\n            {\n\n                $ResultTableHTML .= \"\\t<tr class='printanswersgroup'><td colspan='2'>{$fname[0]}</td></tr>\\n\";\n                $ResultTableText .=\"\\n{$fname[0]}\\n\\n\";\n            }\n            elseif (substr($sFieldname,0,4)=='qid_')\n            {\n                $ResultTableHTML .= \"\\t<tr class='printanswersquestionhead'><td  colspan='2'>{$fname[0]}</td></tr>\\n\";\n                $ResultTableText .=\"\\n{$fname[0]}\\n\";\n            }\n            else\n            {\n                $ResultTableHTML .= \"\\t<tr class='printanswersquestion'><td>{$fname[0]} {$fname[1]}</td><td class='printanswersanswertext'>{$fname[2]}</td></tr>\";\n                $ResultTableText .=\"     {$fname[0]} {$fname[1]}: {$fname[2]}\\n\";\n            }\n        }\n\n        $ResultTableHTML .= \"</table>\\n\";\n        $ResultTableText .= \"\\n\\n\";\n        if ($bIsHTML)\n        {\n            $aReplacementVars['ANSWERTABLE']=$ResultTableHTML;\n        }\n        else\n        {\n            $aReplacementVars['ANSWERTABLE']=$ResultTableText;\n        }\n    }\n\n    $sFrom = $thissurvey['adminname'].' <'.$thissurvey['adminemail'].'>';\n\n    $aAttachments = unserialize($thissurvey['attachments']);\n    \n    $aRelevantAttachments = array();\n    /*\n     * Iterate through attachments and check them for relevance.\n     */\n    if (isset($aAttachments['admin_notification']))\n    {\n        foreach ($aAttachments['admin_notification'] as $aAttachment)\n        {\n            $relevance = $aAttachment['relevance'];\n            // If the attachment is relevant it will be added to the mail.\n            if (LimeExpressionManager::ProcessRelevance($relevance) && file_exists($aAttachment['url']))\n            {\n                $aRelevantAttachments[] = $aAttachment['url'];\n            }\n        }\n    }\n    \n    $redata=compact(array_keys(get_defined_vars()));\n    if (count($aEmailNotificationTo)>0)\n    {\n        $sMessage=templatereplace($thissurvey['email_admin_notification'],$aReplacementVars,$redata,'frontend_helper[1398]',($thissurvey['anonymized'] == \"Y\"),NULL, array(), true);\n        $sSubject=templatereplace($thissurvey['email_admin_notification_subj'],$aReplacementVars,$redata,'frontend_helper[1399]',($thissurvey['anonymized'] == \"Y\"),NULL, array(), true);\n        foreach ($aEmailNotificationTo as $sRecipient)\n        {\n        if (!SendEmailMessage($sMessage, $sSubject, $sRecipient, $sFrom, $sitename, true, getBounceEmail($surveyid), $aRelevantAttachments))\n            {\n                if ($debug>0)\n                {\n                    echo '<br />Email could not be sent. Reason: '.$maildebug.'<br/>';\n                }\n            }\n        }\n    }\n\n        $aRelevantAttachments = array();\n    /*\n     * Iterate through attachments and check them for relevance.\n     */\n    if (isset($aAttachments['detailed_admin_notification']))\n    {\n        foreach ($aAttachments['detailed_admin_notification'] as $aAttachment)\n        {\n            $relevance = $aAttachment['relevance'];\n            // If the attachment is relevant it will be added to the mail.\n            if (LimeExpressionManager::ProcessRelevance($relevance) && file_exists($aAttachment['url']))\n            {\n                $aRelevantAttachments[] = $aAttachment['url'];\n            }\n        }\n    }\n    if (count($aEmailResponseTo)>0)\n    {\n        $sMessage=templatereplace($thissurvey['email_admin_responses'],$aReplacementVars,$redata,'frontend_helper[1414]',($thissurvey['anonymized'] == \"Y\"));\n        $sSubject=templatereplace($thissurvey['email_admin_responses_subj'],$aReplacementVars,$redata,'frontend_helper[1415]',($thissurvey['anonymized'] == \"Y\"));\n        foreach ($aEmailResponseTo as $sRecipient)\n        {\n        if (!SendEmailMessage($sMessage, $sSubject, $sRecipient, $sFrom, $sitename, true, getBounceEmail($surveyid), $aRelevantAttachments))\n            {\n                if ($debug>0)\n                {\n                    echo '<br />Email could not be sent. Reason: '.$maildebug.'<br/>';\n                }\n            }\n        }\n    }\n\n\n}\n\n/**\n* submitfailed : used in em_manager_helper.php\n*/\nfunction submitfailed($errormsg='')\n{\n    global $debug;\n    global $thissurvey;\n    global $subquery, $surveyid;\n\n    $clang = Yii::app()->lang;\n\n    $completed = \"<br /><strong><font size='2' color='red'>\"\n    . $clang->gT(\"Did Not Save\").\"</strong></font><br /><br />\\n\\n\"\n    . $clang->gT(\"An unexpected error has occurred and your responses cannot be saved.\").\"<br /><br />\\n\";\n    if ($thissurvey['adminemail'])\n    {\n        $completed .= $clang->gT(\"Your responses have not been lost and have been emailed to the survey administrator and will be entered into our database at a later point.\").\"<br /><br />\\n\";\n        if ($debug>0)\n        {\n            $completed.='Error message: '.htmlspecialchars($errormsg).'<br />';\n        }\n        $email=$clang->gT(\"An error occurred saving a response to survey id\",\"unescaped\").\" \".$thissurvey['name'].\" - $surveyid\\n\\n\";\n        $email .= $clang->gT(\"DATA TO BE ENTERED\",\"unescaped\").\":\\n\";\n        foreach ($_SESSION['survey_'.$surveyid]['insertarray'] as $value)\n        {\n            $email .= \"$value: {$_SESSION['survey_'.$surveyid][$value]}\\n\";\n        }\n        $email .= \"\\n\".$clang->gT(\"SQL CODE THAT FAILED\",\"unescaped\").\":\\n\"\n        . \"$subquery\\n\\n\"\n        . $clang->gT(\"ERROR MESSAGE\",\"unescaped\").\":\\n\"\n        . $errormsg.\"\\n\\n\";\n        SendEmailMessage($email, $clang->gT(\"Error saving results\",\"unescaped\"), $thissurvey['adminemail'], $thissurvey['adminemail'], \"LimeSurvey\", false, getBounceEmail($surveyid));\n        //echo \"<!-- EMAIL CONTENTS:\\n$email -->\\n\";\n        //An email has been sent, so we can kill off this session.\n        killSurveySession($surveyid);\n    }\n    else\n    {\n        $completed .= \"<a href='javascript:location.reload()'>\".$clang->gT(\"Try to submit again\").\"</a><br /><br />\\n\";\n        $completed .= $subquery;\n    }\n    return $completed;\n}\n\n/**\n* This function builds all the required session variables when a survey is first started and\n* it loads any answer defaults from command line or from the table defaultvalues\n* It is called from the related format script (group.php, question.php, survey.php)\n* if the survey has just started.\n*/\nfunction buildsurveysession($surveyid,$preview=false)\n{\n    global $secerror, $clienttoken;\n    global $tokensexist;\n    //global $surveyid;\n    global $move, $rooturl;\n\n    $clang = Yii::app()->lang;\n    $sLangCode=$clang->langcode;\n    $languagechanger=makeLanguageChangerSurvey($sLangCode);\n    if(!$preview)\n        $preview=Yii::app()->getConfig('previewmode');\n\t$thissurvey = getSurveyInfo($surveyid,$sLangCode);\n\n    $_SESSION['survey_'.$surveyid]['templatename']=validateTemplateDir($thissurvey['template']);\n    $_SESSION['survey_'.$surveyid]['templatepath']=getTemplatePath($_SESSION['survey_'.$surveyid]['templatename']).DIRECTORY_SEPARATOR;\n    $sTemplatePath=$_SESSION['survey_'.$surveyid]['templatepath'];\n\n    $loadsecurity = returnGlobal('loadsecurity',true);\n\n    // NO TOKEN REQUIRED BUT CAPTCHA ENABLED FOR SURVEY ACCESS\n    if ($tokensexist == 0 && isCaptchaEnabled('surveyaccessscreen',$thissurvey['usecaptcha']) && !isset($_SESSION['survey_'.$surveyid]['captcha_surveyaccessscreen'])&& !$preview)\n    {\n        // IF CAPTCHA ANSWER IS NOT CORRECT OR NOT SET\n        if (!isset($loadsecurity) ||\n        !isset($_SESSION['survey_'.$surveyid]['secanswer']) ||\n        $loadsecurity != $_SESSION['survey_'.$surveyid]['secanswer'])\n        {\n            sendCacheHeaders();\n            doHeader();\n            // No or bad answer to required security question\n\n            $redata = compact(array_keys(get_defined_vars()));\n            echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[875]');\n            //echo makedropdownlist();\n            echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[877]');\n\n            if (isset($loadsecurity))\n            { // was a bad answer\n                echo \"<font color='#FF0000'>\".$clang->gT(\"The answer to the security question is incorrect.\").\"</font><br />\";\n            }\n\n            echo \"<p class='captcha'>\".$clang->gT(\"Please confirm access to survey by answering the security question below and click continue.\").\"</p>\"\n            .CHtml::form(array(\"/survey/index/sid/{$surveyid}\"), 'post', array('class'=>'captcha')).\"\n            <table align='center'>\n            <tr>\n            <td align='right' valign='middle'>\n            <input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n            <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n            // In case we this is a direct Reload previous answers URL, then add hidden fields\n            if (isset($_GET['loadall']) && isset($_GET['scid'])\n            && isset($_GET['loadname']) && isset($_GET['loadpass']))\n            {\n                echo \"\n                <input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n            }\n\n            echo \"\n            </td>\n            </tr>\";\n            if (function_exists(\"ImageCreate\") && isCaptchaEnabled('surveyaccessscreen', $thissurvey['usecaptcha']))\n            {\n                echo \"<tr>\n                <td align='center' valign='middle'><label for='captcha'>\".$clang->gT(\"Security question:\").\"</label></td><td align='left' valign='middle'><table><tr><td valign='middle'><img src='\".Yii::app()->getController()->createUrl('/verification/image/sid/'.$surveyid).\"' alt='captcha' /></td>\n                <td valign='middle'><input id='captcha' type='text' size='5' maxlength='3' name='loadsecurity' value='' /></td></tr></table>\n                </td>\n                </tr>\";\n            }\n            echo \"<tr><td colspan='2' align='center'><input class='submit' type='submit' value='\".$clang->gT(\"Continue\").\"' /></td></tr>\n            </table>\n            </form>\";\n\n            echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1567]');\n            doFooter();\n            exit;\n        }\n        else{\n            $_SESSION['survey_'.$surveyid]['captcha_surveyaccessscreen']=true;\n        }\n    }\n\n    //BEFORE BUILDING A NEW SESSION FOR THIS SURVEY, LET'S CHECK TO MAKE SURE THE SURVEY SHOULD PROCEED!\n    // TOKEN REQUIRED BUT NO TOKEN PROVIDED\n    if ($tokensexist == 1 && !$clienttoken && !$preview)\n    {\n\n        if ($thissurvey['nokeyboard']=='Y')\n        {\n            includeKeypad();\n            $kpclass = \"text-keypad\";\n        }\n        else\n        {\n            $kpclass = \"\";\n        }\n\n        // DISPLAY REGISTER-PAGE if needed\n        // DISPLAY CAPTCHA if needed\n        sendCacheHeaders();\n        doHeader();\n\n        $redata = compact(array_keys(get_defined_vars()));\n        echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1594]');\n        //echo makedropdownlist();\n        echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1596]');\n        if (isset($thissurvey) && $thissurvey['allowregister'] == \"Y\")\n        {\n            echo templatereplace(file_get_contents($sTemplatePath.\"register.pstpl\"),array(),$redata,'frontend_helper[1599]');\n        }\n        else\n        {\n            // ->renderPartial('entertoken_view');\n            if (isset($secerror)) echo \"<span class='error'>\".$secerror.\"</span><br />\";\n            echo '<div id=\"wrapper\"><p id=\"tokenmessage\">'.$clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br />\";\n            echo $clang->gT(\"If you have been issued a token, please enter it in the box below and click continue.\").\"</p>\n            <script type='text/javascript'>var focus_element='#token';</script>\"\n            .CHtml::form(array(\"/survey/index/sid/{$surveyid}\"), 'post', array('id'=>'tokenform','autocomplete'=>'off')).\"\n            <ul>\n            <li>\";?>\n            <label for='token'><?php $clang->eT(\"Token:\");?></label><input class='text <?php echo $kpclass?>' id='token' type='password' name='token' value='' />\n            <?php\n            echo \"<input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n            <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n            if (isset($_GET['newtest']) && $_GET['newtest'] == \"Y\")\n            {\n                echo \"  <input type='hidden' name='newtest' value='Y' id='newtest' />\";\n\n            }\n\n            // If this is a direct Reload previous answers URL, then add hidden fields\n            if (isset($_GET['loadall']) && isset($_GET['scid'])\n            && isset($_GET['loadname']) && isset($_GET['loadpass']))\n            {\n                echo \"\n                <input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n            }\n            echo \"</li>\";\n\n            if (function_exists(\"ImageCreate\") && isCaptchaEnabled('surveyaccessscreen', $thissurvey['usecaptcha']))\n            {\n                echo \"<li>\n                <label for='captchaimage'>\".$clang->gT(\"Security Question\").\"</label><img id='captchaimage' src='\".Yii::app()->getController()->createUrl('/verification/image/sid/'.$surveyid).\"' alt='captcha' /><input type='text' size='5' maxlength='3' name='loadsecurity' value='' />\n                </li>\";\n            }\n            echo \"<li>\n            <input class='submit button' type='submit' value='\".$clang->gT(\"Continue\").\"' />\n            </li>\n            </ul>\n            </form></div>\";\n        }\n\n        echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1645]');\n        doFooter();\n        exit;\n    }\n    // TOKENS REQUIRED, A TOKEN PROVIDED\n    // SURVEY WITH NO NEED TO USE CAPTCHA\n    elseif ($tokensexist == 1 && $clienttoken &&\n    !isCaptchaEnabled('surveyaccessscreen',$thissurvey['usecaptcha']))\n    {\n\n        //check if token actually does exist\n        // check also if it is allowed to change survey after completion\n\t\tif ($thissurvey['alloweditaftercompletion'] == 'Y' ) {\n            $oTokenEntry = Token::model($surveyid)->findByAttributes(array('token'=>$clienttoken));\n        } else {\n            $oTokenEntry = Token::model($surveyid)->usable()->incomplete()->findByAttributes(array('token' => $clienttoken));\n        }\n\t\tif (!isset($oTokenEntry))\n        {\n            //TOKEN DOESN'T EXIST OR HAS ALREADY BEEN USED. EXPLAIN PROBLEM AND EXIT\n\n            killSurveySession($surveyid);\n            sendCacheHeaders();\n            doHeader();\n\n            $redata = compact(array_keys(get_defined_vars()));\n            echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1676]');\n            echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1677]');\n            echo '<div id=\"wrapper\"><p id=\"tokenmessage\">'.$clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br /><br />\\n\"\n            .\"\\t\".$clang->gT(\"The token you have provided is either not valid, or has already been used.\").\"<br /><br />\\n\"\n            .\"\\t\".sprintf($clang->gT(\"For further information please contact %s\"), $thissurvey['adminname'])\n            .\" (<a href='mailto:{$thissurvey['adminemail']}'>\"\n            .\"{$thissurvey['adminemail']}</a>)</p></div>\\n\";\n\n            echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1684]');\n            doFooter();\n            exit;\n        }\n   }\n    // TOKENS REQUIRED, A TOKEN PROVIDED\n    // SURVEY CAPTCHA REQUIRED\n    elseif ($tokensexist == 1 && $clienttoken && isCaptchaEnabled('surveyaccessscreen',$thissurvey['usecaptcha']))\n    {\n\n        // IF CAPTCHA ANSWER IS CORRECT\n        if (isset($loadsecurity) &&\n        isset($_SESSION['survey_'.$surveyid]['secanswer']) &&\n        $loadsecurity == $_SESSION['survey_'.$surveyid]['secanswer'])\n        {          \n\t\t\tif ($thissurvey['alloweditaftercompletion'] == 'Y' )\n            {\n                $oTokenEntry = Token::model($surveyid)->findByAttributes(array('token'=> $clienttoken));\n            }\n            else\n            {\n                $oTokenEntry = Token::model($surveyid)->incomplete()->findByAttributes(array(\n\t\t\t\t\t'token' => $clienttoken\n\t\t\t\t));\n           }\n            if (!isset($oTokenEntry))\n            {\n                sendCacheHeaders();\n                doHeader();\n                //TOKEN DOESN'T EXIST OR HAS ALREADY BEEN USED. EXPLAIN PROBLEM AND EXIT\n\n                $redata = compact(array_keys(get_defined_vars()));\n                echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1719]');\n                echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1720]');\n                echo \"\\t<div id='wrapper'>\\n\"\n                .\"\\t<p id='tokenmessage'>\\n\"\n                .\"\\t\".$clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br /><br />\\n\"\n                .\"\\t\".$clang->gT(\"The token you have provided is either not valid, or has already been used.\").\"<br/><br />\\n\"\n                .\"\\t\".sprintf($clang->gT(\"For further information please contact %s\"), $thissurvey['adminname'])\n                .\" (<a href='mailto:{$thissurvey['adminemail']}'>\"\n                .\"{$thissurvey['adminemail']}</a>)\\n\"\n                .\"\\t</p>\\n\"\n                .\"\\t</div>\\n\";\n\n                echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1731]');\n                doFooter();\n                exit;\n            }\n        }\n        // IF CAPTCHA ANSWER IS NOT CORRECT\n        else if (!isset($move) || is_null($move))\n            {\n                unset($_SESSION['survey_'.$surveyid]['srid']);\n                $gettoken = $clienttoken;\n                sendCacheHeaders();\n                doHeader();\n                // No or bad answer to required security question\n                $redata = compact(array_keys(get_defined_vars()));\n                echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1745]');\n                echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1746]');\n                // If token wasn't provided and public registration\n                // is enabled then show registration form\n                if ( !isset($gettoken) && isset($thissurvey) && $thissurvey['allowregister'] == \"Y\")\n                {\n                    echo templatereplace(file_get_contents($sTemplatePath.\"register.pstpl\"),array(),$redata,'frontend_helper[1751]');\n                }\n                else\n                { // only show CAPTCHA\n\n                    echo '<div id=\"wrapper\"><p id=\"tokenmessage\">';\n                    if (isset($loadsecurity))\n                    { // was a bad answer\n                        echo \"<span class='error'>\".$clang->gT(\"The answer to the security question is incorrect.\").\"</span><br />\";\n                    }\n\n                    echo $clang->gT(\"This is a controlled survey. You need a valid token to participate.\").\"<br /><br />\";\n                    // IF TOKEN HAS BEEN GIVEN THEN AUTOFILL IT\n                    // AND HIDE ENTRY FIELD\n                    if (!isset($gettoken))\n                    {\n                        echo $clang->gT(\"If you have been issued a token, please enter it in the box below and click continue.\").\"</p>\n                        <form id='tokenform' method='get' action='\".Yii::app()->getController()->createUrl(\"/survey/index\").\"'>\n                        <ul>\n                        <li>\n                        <input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n                        <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n                        if (isset($_GET['loadall']) && isset($_GET['scid'])\n                        && isset($_GET['loadname']) && isset($_GET['loadpass']))\n                        {\n                            echo \"<input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                            <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                            <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                            <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n                        }\n\n                        echo '<label for=\"token\">'.$clang->gT(\"Token\").\"</label><input class='text' type='password' id='token' name='token'></li>\";\n                }\n                else\n                {\n                    echo $clang->gT(\"Please confirm the token by answering the security question below and click continue.\").\"</p>\n                    <form id='tokenform' method='get' action='\".Yii::app()->getController()->createUrl(\"/survey/index\").\"'>\n                    <ul>\n                    <li>\n                    <input type='hidden' name='sid' value='\".$surveyid.\"' id='sid' />\n                    <input type='hidden' name='lang' value='\".$sLangCode.\"' id='lang' />\";\n                    if (isset($_GET['loadall']) && isset($_GET['scid'])\n                    && isset($_GET['loadname']) && isset($_GET['loadpass']))\n                    {\n                        echo \"<input type='hidden' name='loadall' value='\".htmlspecialchars($_GET['loadall']).\"' id='loadall' />\n                        <input type='hidden' name='scid' value='\".returnGlobal('scid',true).\"' id='scid' />\n                        <input type='hidden' name='loadname' value='\".htmlspecialchars($_GET['loadname']).\"' id='loadname' />\n                        <input type='hidden' name='loadpass' value='\".htmlspecialchars($_GET['loadpass']).\"' id='loadpass' />\";\n                    }\n                    echo '<label for=\"token\">'.$clang->gT(\"Token:\").\"</label><span id='token'>$gettoken</span>\"\n                    .\"<input type='hidden' name='token' value='$gettoken'></li>\";\n                }\n\n\n                if (function_exists(\"ImageCreate\") && isCaptchaEnabled('surveyaccessscreen', $thissurvey['usecaptcha']))\n                {\n                    echo \"<li>\n                    <label for='captchaimage'>\".$clang->gT(\"Security Question\").\"</label><img id='captchaimage' src='\".Yii::app()->getController()->createUrl('/verification/image/sid/'.$surveyid).\"' alt='captcha' /><input type='text' size='5' maxlength='3' name='loadsecurity' value='' />\n                    </li>\";\n                }\n                echo \"<li><input class='submit' type='submit' value='\".$clang->gT(\"Continue\").\"' /></li>\n                </ul>\n                </form>\n                </id>\";\n            }\n\n            echo '</div>'.templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1817]');\n            doFooter();\n            exit;\n        }\n    }\n\n    //RESET ALL THE SESSION VARIABLES AND START AGAIN\n    unset($_SESSION['survey_'.$surveyid]['grouplist']);\n    unset($_SESSION['survey_'.$surveyid]['fieldarray']);\n    unset($_SESSION['survey_'.$surveyid]['insertarray']);\n    unset($_SESSION['survey_'.$surveyid]['fieldnamesInfo']);\n    unset($_SESSION['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster']);\n    unset($_SESSION['survey_'.$surveyid]['groupReMap']);\n    $_SESSION['survey_'.$surveyid]['fieldnamesInfo'] = Array();\n\n\n    //RL: multilingual support\n    if (isset($_GET['token']) && tableExists('{{tokens_'.$surveyid.'}}'))\n    {\n\n        //get language from token (if one exists)\n        $tkquery2 = \"SELECT * FROM {{tokens_\".$surveyid.\"}} WHERE token='\".$clienttoken.\"' AND (completed = 'N' or completed='')\";\n        //echo $tkquery2;\n        $result = dbExecuteAssoc($tkquery2) or safeDie (\"Couldn't get tokens<br />$tkquery<br />\");    //Checked\n        foreach ($result->readAll() as $rw)\n        {\n            $tklanguage=$rw['language'];\n        }\n    }\n    if (returnGlobal('lang',true))\n    {\n        $language_to_set=returnGlobal('lang',true);\n    } elseif (isset($tklanguage))\n    {\n        $language_to_set=$tklanguage;\n    }\n    else\n    {\n        $language_to_set = $thissurvey['language'];\n    }\n\n    if (!isset($_SESSION['survey_'.$surveyid]['s_lang']))\n    {\n        SetSurveyLanguage($surveyid, $language_to_set);\n    }\n\n\n    UpdateGroupList($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n\n    $sQuery = \"SELECT count(*)\\n\"\n    .\" FROM {{groups}} INNER JOIN {{questions}} ON {{groups}}.gid = {{questions}}.gid\\n\"\n    .\" WHERE {{questions}}.sid=\".$surveyid.\"\\n\"\n    .\" AND {{groups}}.language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\\n\"\n    .\" AND {{questions}}.language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\\n\"\n    .\" AND {{questions}}.parent_qid=0\\n\";\n\n    $totalquestions = Yii::app()->db->createCommand($sQuery)->queryScalar();\n\n    // Fix totalquestions by substracting Test Display questions\n    $iNumberofQuestions=dbExecuteAssoc(\"SELECT count(*)\\n\"\n    .\" FROM {{questions}}\"\n    .\" WHERE type in ('X','*')\\n\"\n    .\" AND sid={$surveyid}\"\n    .\" AND language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\"\n    .\" AND parent_qid=0\")->read();\n\n    $_SESSION['survey_'.$surveyid]['totalquestions'] = $totalquestions - (int) reset($iNumberofQuestions);\n\n    //2. SESSION VARIABLE: totalsteps\n    //The number of \"pages\" that will be presented in this survey\n    //The number of pages to be presented will differ depending on the survey format\n    switch($thissurvey['format'])\n    {\n        case \"A\":\n            $_SESSION['survey_'.$surveyid]['totalsteps']=1;\n            break;\n        case \"G\":\n            if (isset($_SESSION['survey_'.$surveyid]['grouplist']))\n            {\n                $_SESSION['survey_'.$surveyid]['totalsteps']=count($_SESSION['survey_'.$surveyid]['grouplist']);\n            }\n            break;\n        case \"S\":\n            $_SESSION['survey_'.$surveyid]['totalsteps']=$totalquestions;\n    }\n\n\n    if ($totalquestions == 0)\t//break out and crash if there are no questions!\n    {\n        sendCacheHeaders();\n        doHeader();\n\n        $redata = compact(array_keys(get_defined_vars()));\n        echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[1914]');\n        echo templatereplace(file_get_contents($sTemplatePath.\"survey.pstpl\"),array(),$redata,'frontend_helper[1915]');\n        echo \"\\t<div id='wrapper'>\\n\"\n        .\"\\t<p id='tokenmessage'>\\n\"\n        .\"\\t\".$clang->gT(\"This survey does not yet have any questions and cannot be tested or completed.\").\"<br /><br />\\n\"\n        .\"\\t\".sprintf($clang->gT(\"For further information please contact %s\"), $thissurvey['adminname'])\n        .\" (<a href='mailto:{$thissurvey['adminemail']}'>\"\n        .\"{$thissurvey['adminemail']}</a>)<br /><br />\\n\"\n        .\"\\t</p>\\n\"\n        .\"\\t</div>\\n\";\n\n        echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[1925]');\n        doFooter();\n        exit;\n    }\n\n    //Perform a case insensitive natural sort on group name then question title of a multidimensional array\n    //\tusort($arows, 'groupOrderThenQuestionOrder');\n\n    //3. SESSION VARIABLE - insertarray\n    //An array containing information about used to insert the data into the db at the submit stage\n    //4. SESSION VARIABLE - fieldarray\n    //See rem at end..\n\n    if ($tokensexist == 1 && $clienttoken)\n    {\n        $_SESSION['survey_'.$surveyid]['token'] = $clienttoken;\n    }\n\n    if ($thissurvey['anonymized'] == \"N\")\n    {\n        $_SESSION['survey_'.$surveyid]['insertarray'][]= \"token\";\n    }\n\n    $qtypes=getQuestionTypeList('','array');\n    $fieldmap=createFieldMap($surveyid,'full',true,false,$_SESSION['survey_'.$surveyid]['s_lang']);\n\n\n    // Randomization groups for groups\n    $aRandomGroups=array();\n    $aGIDCompleteMap=array();\n    // first find all groups and their groups IDS\n    $criteria = new CDbCriteria;\n    $criteria->addColumnCondition(array('sid' => $surveyid, 'language' => $_SESSION['survey_'.$surveyid]['s_lang']));\n    $criteria->addCondition(\"randomization_group != ''\");\n    $oData = QuestionGroup::model()->findAll($criteria);\n    foreach($oData as $aGroup)\n    {\n        $aRandomGroups[$aGroup['randomization_group']][] = $aGroup['gid'];\n    }\n    // Shuffle each group and create a map for old GID => new GID\n    foreach ($aRandomGroups as $sGroupName=>$aGIDs)\n    {\n        $aShuffledIDs=$aGIDs;\n        shuffle($aShuffledIDs);\n        $aGIDCompleteMap=$aGIDCompleteMap+array_combine($aGIDs,$aShuffledIDs);\n    }\n    $_SESSION['survey_' . $surveyid]['groupReMap'] = $aGIDCompleteMap;\n\n    $randomized = false;    // So we can trigger reorder once for group and question randomization\n    // Now adjust the grouplist\n    if (count($aRandomGroups)>0 && !$preview)\n    {\n        $randomized = true;    // So we can trigger reorder once for group and question randomization\n        // Now adjust the grouplist\n        Yii::import('application.helpers.frontend_helper', true);   // make sure frontend helper is loaded\n        UpdateGroupList($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n        // ... and the fieldmap\n\n        // First create a fieldmap with GID as key\n        foreach ($fieldmap as $aField)\n        {\n            if (isset($aField['gid']))\n            {\n                $GroupFieldMap[$aField['gid']][]=$aField;\n            }\n            else{\n                $GroupFieldMap['other'][]=$aField;\n            }\n        }\n        // swap it\n        foreach ($GroupFieldMap as $iOldGid => $fields)\n        {\n            $iNewGid = $iOldGid;\n            if (isset($aGIDCompleteMap[$iOldGid]))\n            {\n                $iNewGid = $aGIDCompleteMap[$iOldGid];\n            }\n            $newGroupFieldMap[$iNewGid] = $GroupFieldMap[$iNewGid];\n        }\n        $GroupFieldMap = $newGroupFieldMap;\n        // and convert it back to a fieldmap\n        unset($fieldmap);\n        foreach($GroupFieldMap as $aGroupFields)\n        {\n            foreach ($aGroupFields as $aField)\n            {\n                if (isset($aField['fieldname'])) {\n                    $fieldmap[$aField['fieldname']] = $aField;  // isset() because of the shuffled flag above\n                }\n            }\n        }\n        unset($GroupFieldMap);\n    }\n\n    // Randomization groups for questions\n\n    // Find all defined randomization groups through question attribute values\n    $randomGroups=array();\n    if (in_array(Yii::app()->db->getDriverName(), array('mssql', 'sqlsrv', 'dblib')))\n    {\n        $rgquery = \"SELECT attr.qid, CAST(value as varchar(255)) as value FROM {{question_attributes}} as attr right join {{questions}} as quests on attr.qid=quests.qid WHERE attribute='random_group' and CAST(value as varchar(255)) <> '' and sid=$surveyid GROUP BY attr.qid, CAST(value as varchar(255))\";\n    }\n    else\n    {\n        $rgquery = \"SELECT attr.qid, value FROM {{question_attributes}} as attr right join {{questions}} as quests on attr.qid=quests.qid WHERE attribute='random_group' and value <> '' and sid=$surveyid GROUP BY attr.qid, value\";\n    }\n    $rgresult = dbExecuteAssoc($rgquery);\n    foreach($rgresult->readAll() as $rgrow)\n    {\n        // Get the question IDs for each randomization group\n        $randomGroups[$rgrow['value']][] = $rgrow['qid'];\n    }\n\n    // If we have randomization groups set, then lets cycle through each group and\n    // replace questions in the group with a randomly chosen one from the same group\n    if (count($randomGroups) > 0 && !$preview)\n    {\n        $randomized   = true;    // So we can trigger reorder once for group and question randomization\n        $copyFieldMap = array();\n        $oldQuestOrder = array();\n        $newQuestOrder = array();\n        $randGroupNames = array();\n        foreach ($randomGroups as $key=>$value)\n        {\n            $oldQuestOrder[$key] = $randomGroups[$key];\n            $newQuestOrder[$key] = $oldQuestOrder[$key];\n            // We shuffle the question list to get a random key->qid which will be used to swap from the old key\n            shuffle($newQuestOrder[$key]);\n            $randGroupNames[] = $key;\n        }\n\n        // Loop through the fieldmap and swap each question as they come up\n        foreach ($fieldmap as $fieldkey => $fieldval)\n        {\n            $found = 0;\n            foreach ($randomGroups as $gkey => $gval)\n            {\n                // We found a qid that is in the randomization group\n                if (isset($fieldval['qid']) && in_array($fieldval['qid'],$oldQuestOrder[$gkey]))\n                {\n                    // Get the swapped question\n                    $idx = array_search($fieldval['qid'],$oldQuestOrder[$gkey]);\n                    foreach ($fieldmap as $key => $field)\n                    {\n                        if (isset($field['qid']) && $field['qid'] == $newQuestOrder[$gkey][$idx])\n                        {\n                            $field['random_gid'] = $fieldval['gid'];   // It is possible to swap to another group\n                            $copyFieldMap[$key]  = $field;\n                        }\n                    }\n                    $found = 1;\n                    break;\n                } else\n                {\n                    $found = 2;\n                }\n            }\n            if ($found == 2)\n            {\n                $copyFieldMap[$fieldkey]=$fieldval;\n            }\n            reset($randomGroups);\n        }\n        $fieldmap = $copyFieldMap;\n    }\n\n    if ($randomized === true)\n    {\n        // reset the sequencing counts\n        $gseq = -1;\n        $_gid = -1;\n        $qseq = -1;\n        $_qid = -1;\n        $copyFieldMap = array();\n        foreach ($fieldmap as $key => $val)\n        {\n            if ($val['gid'] != '')\n            {\n                if (isset($val['random_gid']))\n                {\n                    $gid = $val['random_gid'];\n                } else {\n                    $gid = $val['gid'];\n                }\n                if ($gid != $_gid)\n                {\n                    $_gid = $gid;\n                    ++$gseq;\n                }\n            }\n\n            if ($val['qid'] != '' && $val['qid'] != $_qid)\n            {\n                $_qid = $val['qid'];\n                ++$qseq;\n            }\n\n            if ($val['gid'] != '' && $val['qid'] != '')\n            {\n                $val['groupSeq']    = $gseq;\n                $val['questionSeq'] = $qseq;\n            }\n\n            $copyFieldMap[$key] = $val;\n        }\n        $fieldmap = $copyFieldMap;\n        unset($copyFieldMap);\n\n        $_SESSION['survey_'.$surveyid]['fieldmap-' . $surveyid . $_SESSION['survey_'.$surveyid]['s_lang']] = $fieldmap;\n        $_SESSION['survey_'.$surveyid]['fieldmap-' . $surveyid . '-randMaster'] = 'fieldmap-' . $surveyid . $_SESSION['survey_'.$surveyid]['s_lang'];\n    }\n    \n    // TMSW Condition->Relevance:  don't need hasconditions, or usedinconditions\n\n    $_SESSION['survey_'.$surveyid]['fieldmap']=$fieldmap;\n    foreach ($fieldmap as $field)\n    {\n        if (isset($field['qid']) && $field['qid']!='')\n        {\n            $_SESSION['survey_'.$surveyid]['fieldnamesInfo'][$field['fieldname']]=$field['sid'].'X'.$field['gid'].'X'.$field['qid'];\n            $_SESSION['survey_'.$surveyid]['insertarray'][]=$field['fieldname'];\n            //fieldarray ARRAY CONTENTS -\n            //            [0]=questions.qid,\n            //\t\t\t[1]=fieldname,\n            //\t\t\t[2]=questions.title,\n            //\t\t\t[3]=questions.question\n            //                 \t[4]=questions.type,\n            //\t\t\t[5]=questions.gid,\n            //\t\t\t[6]=questions.mandatory,\n            //\t\t\t[7]=conditionsexist,\n            //\t\t\t[8]=usedinconditions\n            //\t\t\t[8]=usedinconditions\n            //\t\t\t[9]=used in group.php for question count\n            //\t\t\t[10]=new group id for question in randomization group (GroupbyGroup Mode)\n\n            if (!isset($_SESSION['survey_'.$surveyid]['fieldarray'][$field['sid'].'X'.$field['gid'].'X'.$field['qid']]))\n            {\n                //JUST IN CASE : PRECAUTION!\n                //following variables are set only if $style==\"full\" in createFieldMap() in common_helper.\n                //so, if $style = \"short\", set some default values here!\n                if (isset($field['title']))\n                    $title = $field['title'];\n                else\n                    $title = \"\";\n\n                if (isset($field['question']))\n                    $question = $field['question'];\n                else\n                    $question = \"\";\n\n                if (isset($field['mandatory']))\n                    $mandatory = $field['mandatory'];\n                else\n                    $mandatory = 'N';\n\n                if (isset($field['hasconditions']))\n                    $hasconditions = $field['hasconditions'];\n                else\n                    $hasconditions = 'N';\n\n                if (isset($field['usedinconditions']))\n                    $usedinconditions = $field['usedinconditions'];\n                else\n                    $usedinconditions = 'N';\n                $_SESSION['survey_'.$surveyid]['fieldarray'][$field['sid'].'X'.$field['gid'].'X'.$field['qid']]=array($field['qid'],\n                $field['sid'].'X'.$field['gid'].'X'.$field['qid'],\n                $title,\n                $question,\n                $field['type'],\n                $field['gid'],\n                $mandatory,\n                $hasconditions,\n                $usedinconditions);\n            }\n            if (isset($field['random_gid']))\n            {\n                $_SESSION['survey_'.$surveyid]['fieldarray'][$field['sid'].'X'.$field['gid'].'X'.$field['qid']][10] = $field['random_gid'];\n            }\n        }\n\n    }\n\n    // Prefill questions/answers from command line params\n    $reservedGetValues= array('token','sid','gid','qid','lang','newtest','action');\n    $startingValues=array();\n    if (isset($_GET))\n    {\n\t\tforeach ($_GET as $k=>$v)\n        {\n\t\t\tif (!in_array($k,$reservedGetValues) && isset($_SESSION['survey_'.$surveyid]['fieldmap'][$k]))\n            {\n                $startingValues[$k] = $v;\n            }\n\t\t\telse\n\t\t\t{   // Search question codes to use those for prefilling.\n\t\t\t\tforeach($_SESSION['survey_'.$surveyid]['fieldmap'] as $sgqa => $details)\n\t\t\t\t{\n\t\t\t\t\tif ($details['title'] == $k)\n\t\t\t\t\t{\n\t\t\t\t\t\t$startingValues[$sgqa] = $v;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n        }\n    }\n    $_SESSION['survey_'.$surveyid]['startingValues']=$startingValues;\n\n    if (isset($_SESSION['survey_'.$surveyid]['fieldarray'])) $_SESSION['survey_'.$surveyid]['fieldarray']=array_values($_SESSION['survey_'.$surveyid]['fieldarray']);\n\n    //Check if a passthru label and value have been included in the query url\n    $oResult=SurveyURLParameter::model()->getParametersForSurvey($surveyid);\n    foreach($oResult->readAll() as $aRow)\n    {\n        if(isset($_GET[$aRow['parameter']]) && !$preview)\n        {\n            $_SESSION['survey_'.$surveyid]['urlparams'][$aRow['parameter']]=$_GET[$aRow['parameter']];\n            if ($aRow['targetqid']!='')\n            {\n                foreach ($fieldmap as $sFieldname=>$aField)\n                {\n                    if ($aRow['targetsqid']!='')\n                    {\n                        if ($aField['qid']==$aRow['targetqid'] && $aField['sqid']==$aRow['targetsqid'])\n                        {\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$sFieldname]=$_GET[$aRow['parameter']];\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$aRow['parameter']]=$_GET[$aRow['parameter']];\n                        }\n                    }\n                    else\n                    {\n                        if ($aField['qid']==$aRow['targetqid'])\n                        {\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$sFieldname]=$_GET[$aRow['parameter']];\n                            $_SESSION['survey_'.$surveyid]['startingValues'][$aRow['parameter']]=$_GET[$aRow['parameter']];\n                        }\n                    }\n                }\n\n            }\n        }\n    }\n}\n\n/**\n* This function creates the form elements in the survey navigation bar\n* Adding a hidden input for default behaviour without javascript\n* Use button name=\"move\" for real browser (with or without javascript) and IE6/7/8 with javascript\n*/\nfunction surveymover()\n{\n    $surveyid=Yii::app()->getConfig('surveyID');\n    $thissurvey=getSurveyInfo($surveyid);\n    $clang = Yii::app()->lang;\n\n    $sMoveNext=\"movenext\";\n    $sMovePrev=\"\";\n    $iSessionStep=(isset($_SESSION['survey_'.$surveyid]['step']))?$_SESSION['survey_'.$surveyid]['step']:false;\n    $iSessionMaxStep=(isset($_SESSION['survey_'.$surveyid]['maxstep']))?$_SESSION['survey_'.$surveyid]['maxstep']:false;\n    $iSessionTotalSteps=(isset($_SESSION['survey_'.$surveyid]['totalsteps']))?$_SESSION['survey_'.$surveyid]['totalsteps']:false;\n    $sClass=\"submit button\";\n    $sSurveyMover = \"\";\n\n    // Count down\n    if ($thissurvey['navigationdelay'] > 0 && ($iSessionMaxStep!==false && $iSessionMaxStep == $iSessionStep))\n     {\n        $sClass.=\" disabled\";\n        App()->getClientScript()->registerScriptFile(Yii::app()->getConfig('generalscripts').\"/navigator-countdown.js\");\n        App()->getClientScript()->registerScript('navigator_countdown',\"navigator_countdown(\" . $thissurvey['navigationdelay'] . \");\\n\",CClientScript::POS_BEGIN);\n     }\n\n    // Previous ?\n    if ($thissurvey['format'] != \"A\" && ($thissurvey['allowprev'] != \"N\")\n        && $iSessionStep\n        && !($iSessionStep == 1 && $thissurvey['showwelcome'] == 'N')\n        && !Yii::app()->getConfig('previewmode')\n    )\n    {\n        $sMovePrev=\"moveprev\";\n     }\n\n    // Submit ?\n    if ($iSessionStep && ($iSessionStep == $iSessionTotalSteps)\n        || $thissurvey['format'] == 'A' \n        )\n    {\n        $sMoveNext=\"movesubmit\";\n    }\n\n    // todo Remove Next if needed (exemple quota show previous only: maybe other, but actually don't use surveymover)\n    if(Yii::app()->getConfig('previewmode'))\n    {\n        $sMoveNext=\"\";\n    }\n\n    // Construction of mover\n    if($sMovePrev){\n        $sLangMoveprev=$clang->gT(\"Previous\");\n        $sSurveyMover.= CHtml::htmlButton($sLangMoveprev,array('type'=>'submit','id'=>\"{$sMovePrev}btn\",'value'=>$sMovePrev,'name'=>$sMovePrev,'accesskey'=>'p','class'=>$sClass));\n    }\n    if($sMovePrev && $sMoveNext){\n        $sSurveyMover .= \" \";\n    }\n\n    if($sMoveNext){\n        if($sMoveNext==\"movesubmit\"){\n            $sLangMovenext=$clang->gT(\"Submit\");\n            $sAccessKeyNext='l';// Why l ?\n        }else{\n            $sLangMovenext=$clang->gT(\"Next\");\n            $sAccessKeyNext='n';\n        }\n        $sSurveyMover.= CHtml::htmlButton($sLangMovenext,array('type'=>'submit','id'=>\"{$sMoveNext}btn\",'value'=>$sMoveNext,'name'=>$sMoveNext,'accesskey'=>$sAccessKeyNext,'class'=>$sClass));\n     }\n    return $sSurveyMover;\n}\n\n/**\n* Caculate assessement scores\n*\n* @param mixed $surveyid\n* @param mixed $returndataonly - only returns an array with data\n*/\nfunction doAssessment($surveyid, $returndataonly=false)\n{\n\n    $clang = Yii::app()->lang;\n    $baselang=Survey::model()->findByPk($surveyid)->language;\n    if(Survey::model()->findByPk($surveyid)->assessments!=\"Y\")\n    {\n        return false;\n    }\n    $total=0;\n    if (!isset($_SESSION['survey_'.$surveyid]['s_lang']))\n    {\n        $_SESSION['survey_'.$surveyid]['s_lang']=$baselang;\n    }\n    $query = \"SELECT * FROM {{assessments}}\n    WHERE sid=$surveyid and language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\n    ORDER BY scope, id\";\n\n    if ($result = dbExecuteAssoc($query))   //Checked\n    {\n        $aResultSet=$result->readAll();\n        if (count($aResultSet) > 0)\n        {\n            foreach($aResultSet as $row)\n            {\n                if ($row['scope'] == \"G\")\n                {\n                    $assessment['group'][$row['gid']][]=array(\"name\"=>$row['name'],\n                    \"min\"=>$row['minimum'],\n                    \"max\"=>$row['maximum'],\n                    \"message\"=>$row['message']);\n                }\n                else\n                {\n                    $assessment['total'][]=array( \"name\"=>$row['name'],\n                    \"min\"=>$row['minimum'],\n                    \"max\"=>$row['maximum'],\n                    \"message\"=>$row['message']);\n                }\n            }\n            $fieldmap=createFieldMap($surveyid, \"full\",false,false,$_SESSION['survey_'.$surveyid]['s_lang']);\n            $i=0;\n            $total=0;\n            $groups=array();\n            foreach($fieldmap as $field)\n            {\n                if (in_array($field['type'],array('1','F','H','W','Z','L','!','M','O','P')))\n                {\n                    $fieldmap[$field['fieldname']]['assessment_value']=0;\n                    if (isset($_SESSION['survey_'.$surveyid][$field['fieldname']]))\n                    {\n                        if (($field['type'] == \"M\") || ($field['type'] == \"P\")) //Multiflexi choice  - result is the assessment attribute value\n                        {\n                            if ($_SESSION['survey_'.$surveyid][$field['fieldname']] == \"Y\")\n                            {\n                                $aAttributes=getQuestionAttributeValues($field['qid'],$field['type']);\n                                $fieldmap[$field['fieldname']]['assessment_value']=(int)$aAttributes['assessment_value'];\n                                $total=$total+(int)$aAttributes['assessment_value'];\n                            }\n                        }\n                        else  // Single choice question\n                        {\n                            $usquery = \"SELECT assessment_value FROM {{answers}} where qid=\".$field['qid'].\" and language='$baselang' and code=\".dbQuoteAll($_SESSION['survey_'.$surveyid][$field['fieldname']]);\n                            $usresult = dbExecuteAssoc($usquery);          //Checked\n                            if ($usresult)\n                            {\n                                $usrow = $usresult->read();\n                                $fieldmap[$field['fieldname']]['assessment_value']=$usrow['assessment_value'];\n                                $total=$total+$usrow['assessment_value'];\n                            }\n                        }\n                    }\n                    $groups[]=$field['gid'];\n                }\n                $i++;\n            }\n\n            $groups=array_unique($groups);\n\n            foreach($groups as $group)\n            {\n                $grouptotal=0;\n                foreach ($fieldmap as $field)\n                {\n                    if ($field['gid'] == $group && isset($field['assessment_value']))\n                    {\n                        //$grouptotal=$grouptotal+$field['answer'];\n                        if (isset ($_SESSION['survey_'.$surveyid][$field['fieldname']]))\n                        {\n                            $grouptotal=$grouptotal+$field['assessment_value'];\n                        }\n                    }\n                }\n                $subtotal[$group]=$grouptotal;\n            }\n        }\n        $assessments = \"\";\n        if (isset($subtotal) && is_array($subtotal))\n        {\n            foreach($subtotal as $key=>$val)\n            {\n                if (isset($assessment['group'][$key]))\n                {\n                    foreach($assessment['group'][$key] as $assessed)\n                    {\n                        if ($val >= $assessed['min'] && $val <= $assessed['max'] && $returndataonly===false)\n                        {\n                            $assessments .= \"\\t<!-- GROUP ASSESSMENT: Score: $val Min: \".$assessed['min'].\" Max: \".$assessed['max'].\"-->\n                            <table class='assessments'>\n                            <tr>\n                            <th>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), $assessed['name']).\"\n                            </th>\n                            </tr>\n                            <tr>\n                            <td>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), $assessed['message']).\"\n                            </td>\n                            </tr>\n                            </table><br />\\n\";\n                        }\n                    }\n                }\n            }\n        }\n\n        if (isset($assessment['total']))\n        {\n            foreach($assessment['total'] as $assessed)\n            {\n                if ($total >= $assessed['min'] && $total <= $assessed['max'] && $returndataonly===false)\n                {\n                    $assessments .= \"\\t\\t\\t<!-- TOTAL ASSESSMENT: Score: $total Min: \".$assessed['min'].\" Max: \".$assessed['max'].\"-->\n                    <table class='assessments' align='center'>\n                    <tr>\n                    <th>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), stripslashes($assessed['name'])).\"\n                    </th>\n                    </tr>\n                    <tr>\n                    <td>\".str_replace(array(\"{PERC}\", \"{TOTAL}\"), array($val, $total), stripslashes($assessed['message'])).\"\n                    </td>\n                    </tr>\n                    </table>\\n\";\n                }\n            }\n        }\n        if ($returndataonly==true)\n        {\n            return array('total'=>$total);\n        }\n        else\n        {\n            return $assessments;\n        }\n    }\n}\n\n/**\n* Update SESSION VARIABLE: grouplist\n* A list of groups in this survey, ordered by group name.\n* @param int surveyid\n* @param string language\n*/\nfunction UpdateGroupList($surveyid, $language)\n{\n    $clang = Yii::app()->lang;\n    unset ($_SESSION['survey_'.$surveyid]['grouplist']);\n    $query = \"SELECT * FROM {{groups}} WHERE sid=$surveyid AND language='\".$language.\"' ORDER BY group_order\";\n    $result = dbExecuteAssoc($query) or safeDie (\"Couldn't get group list<br />$query<br />\");  //Checked\n    $groupList = array();\n    foreach ($result->readAll() as $row)\n    {\n        $group = array(\n            'gid'         => $row['gid'],\n            'group_name'  => $row['group_name'],\n            'description' =>  $row['description']);\n        $groupList[] = $group;\n        $gidList[$row['gid']] = $group;\n    }\n\n    if (!Yii::app()->getConfig('previewmode') && isset($_SESSION['survey_'.$surveyid]['groupReMap']) && count($_SESSION['survey_'.$surveyid]['groupReMap'])>0)\n    {\n        // Now adjust the grouplist\n        $groupRemap = $_SESSION['survey_'.$surveyid]['groupReMap'];\n        $groupListCopy = $groupList;\n        foreach ($groupList as $gseq => $info) {\n            $gid = $info['gid'];\n            if (isset($groupRemap[$gid])) {\n                $gid = $groupRemap[$gid];\n            }\n            $groupListCopy[$gseq] = $gidList[$gid];\n        }\n        $groupList = $groupListCopy;\n     }\n     $_SESSION['survey_'.$surveyid]['grouplist'] = $groupList;\n}\n\n/**\n* FieldArray contains all necessary information regarding the questions\n* This function is needed to update it in case the survey is switched to another language\n* @todo: Make 'fieldarray' obsolete by replacing with EM session info\n*/\nfunction UpdateFieldArray()\n{\n\tglobal $surveyid;\n\t$clang = Yii::app()->lang;\n\n    if (isset($_SESSION['survey_'.$surveyid]['fieldarray']))\n    {\n\t\tforeach ($_SESSION['survey_'.$surveyid]['fieldarray'] as $key => $value)\n        {\n            $questionarray = &$_SESSION['survey_'.$surveyid]['fieldarray'][$key];\n            $query = \"SELECT title, question FROM {{questions}} WHERE qid=\".$questionarray[0].\" AND language='\".$_SESSION['survey_'.$surveyid]['s_lang'].\"'\";\n            $usrow = Yii::app()->db->createCommand($query)->queryRow();\n            if ($usrow)\n            {\n                $questionarray[2]=$usrow['title'];\n                $questionarray[3]=$usrow['question'];\n            }\n            unset($questionarray);\n        }\n    }\n}\n\n/**\n* checkQuota() returns quota information for the current survey\n* @param string $checkaction - action the function must take after completing:\n* \t\t\t\t\t\t\t\tenforce: Enforce the Quota action\n* \t\t\t\t\t\t\t\treturn: Return the updated quota array from getQuotaAnswers()\n* @param string $surveyid - Survey identification number\n* @return array - nested array, Quotas->Members->Fields, includes quota status and which members matched in session.\n*/\nfunction checkQuota($checkaction,$surveyid)\n{\n    global $clienttoken ;\n    if (!isset($_SESSION['survey_'.$surveyid]['srid']))\n    {\n        return;\n    }\n    $thissurvey=getSurveyInfo($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n    $sTemplatePath=getTemplatePath($thissurvey['templatedir']);\n\n    $global_matched = false;\n    $quota_info = getQuotaInformation($surveyid, $_SESSION['survey_'.$surveyid]['s_lang']);\n    $x=0;\n\n    $clang = Yii::app()->lang;\n\n    if(count($quota_info) > 0) // Quota's have to exist\n    {\n        // Check each quota on saved data to see if it is full\n        $querycond = array();\n        foreach ($quota_info as $quota)\n        {\n            if (count($quota['members']) > 0) // Quota can't be empty\n            {\n                $fields_list = array(); // Keep a list of fields for easy reference\n                $y=0;\n                // We need to make the conditions for the select statement here\n                unset($querycond);\n                // fill the array of value and query for each fieldnames\n                $fields_value_array = array();\n                $fields_query_array = array();\n                foreach($quota['members'] as $member)\n                {\n                    foreach($member['fieldnames'] as $fieldname)\n                    {\n                        if (!in_array($fieldname,$fields_list))\n                        {\n                            $fields_list[] = $fieldname;\n                            $fields_value_array[$fieldname] = array();\n                            $fields_query_array[$fieldname] = array();\n                        }\n                        $fields_value_array[$fieldname][]=$member['value'];\n                        $fields_query_array[$fieldname][]= dbQuoteID($fieldname).\" = '{$member['value']}'\";\n                    }\n                }\n\n                // fill the $querycond array with each fields_query grouped by fieldname\n                foreach($fields_list as $fieldname)\n                {\n                    $select_query = \" ( \".implode(' OR ',$fields_query_array[$fieldname]).' )';\n                    $querycond[] = $select_query;\n                }\n                // Test if the fieldname is in the array of value in the session\n                foreach($quota['members'] as $member)\n                {\n                    foreach($member['fieldnames'] as $fieldname)\n                    {\n                        if (isset($_SESSION['survey_'.$surveyid][$fieldname]))\n                        {\n                            if (in_array($_SESSION['survey_'.$surveyid][$fieldname],$fields_value_array[$fieldname])){\n                                $quota_info[$x]['members'][$y]['insession'] = \"true\";\n                            }\n                        }\n                    }\n                    $y++;\n                }\n                unset($fields_query_array);unset($fields_value_array);\n\n                // Lets only continue if any of the quota fields is in the posted page\n                $matched_fields = false;\n                if (isset($_POST['fieldnames']))\n                {\n                    $posted_fields = explode(\"|\",$_POST['fieldnames']);\n                    foreach ($fields_list as $checkfield)\n                    {\n                        if (in_array($checkfield,$posted_fields))\n                        {\n                            $matched_fields = true;\n                            $global_matched = true;\n                        }\n                    }\n                }\n\n                // A field was submitted that is part of the quota\n                if ($matched_fields == true)\n                {\n                    // Check the status of the quota, is it full or not\n                    $sQuery = \"SELECT count(id) FROM {{survey_\".$surveyid.\"}}\n                    WHERE \".implode(' AND ',$querycond).\" \".\"\n                    AND submitdate IS NOT NULL\";\n                    $iRowCount = Yii::app()->db->createCommand($sQuery)->queryScalar();\n                    if ($iRowCount >= $quota['Limit']) // Quota is full!!\n                    {\n                        // Now we have to check if the quota matches in the current session\n                        // This will let us know if this person is going to exceed the quota\n                        $counted_matches = 0;\n                        foreach($quota_info[$x]['members'] as $member)\n                        {\n                            if (isset($member['insession']) && $member['insession'] == \"true\") $counted_matches++;\n                        }\n\n                        if($counted_matches == count($quota['members']))\n                        {\n                            // They are going to exceed the quota if data is submitted\n                            $quota_info[$x]['status']=\"matched\";\n                        }\n                        else\n                        {\n                            $quota_info[$x]['status']=\"notmatched\";\n                        }\n                    }\n                    else\n                    {\n                        // Quota is no in danger of being exceeded.\n                        $quota_info[$x]['status']=\"notmatched\";\n                    }\n                }\n            }\n            $x++;\n        }\n    }\n    else\n    {\n        return false;\n    }\n\n    // Now we have all the information we need about the quotas and their status.\n    // Lets see what we should do now\n    if ($checkaction == 'return')\n    {\n        return $quota_info;\n    }\n    elseif ($global_matched == true && $checkaction == 'enforce')\n    {\n        // Need to add Quota action enforcement here.\n        reset($quota_info);\n\n        $tempmsg =\"\";\n        $found = false;\n        $redata = compact(array_keys(get_defined_vars()));\n        foreach($quota_info as $quota)\n        {\n            $quota['Message'] = templatereplace($quota['Message'],array(),$redata);\n            $quota['Url'] = passthruReplace($quota['Url'], $thissurvey);\n            $quota['Url'] = templatereplace($quota['Url'],array(),$redata);\n            $quota['UrlDescrip'] = templatereplace($quota['UrlDescrip'],array(),$redata);\n            if ((isset($quota['status']) && $quota['status'] == \"matched\") && (isset($quota['Action']) && $quota['Action'] == \"1\"))\n            {\n                // If a token is used then mark the token as completed\n                if (isset($clienttoken) && $clienttoken)\n                {\n                    submittokens(true);\n                }\n\n            sendCacheHeaders();\n            if($quota['AutoloadUrl'] == 1 && $quota['Url'] != \"\")\n            {\n                header(\"Location: \".$quota['Url']);\n                killSurveySession($surveyid);\n            }\n            doHeader();\n\n            echo templatereplace(file_get_contents($sTemplatePath.\"/startpage.pstpl\"),array(),$redata,'frontend_helper[2617]');\n            echo \"\\t<div class='quotamessage'>\\n\";\n            echo \"\\t\".$quota['Message'].\"<br /><br />\\n\";\n            echo \"\\t<a href='\".$quota['Url'].\"'>\".$quota['UrlDescrip'].\"</a><br />\\n\";\n            echo \"\\t</div>\\n\";\n            echo templatereplace(file_get_contents($sTemplatePath.\"/endpage.pstpl\"),array(),$redata,'frontend_helper[2622]');\n            doFooter();\n            killSurveySession($surveyid);\n            exit;\n            }\n\n            if ((isset($quota['status']) && $quota['status'] == \"matched\") && (isset($quota['Action']) && $quota['Action'] == \"2\"))\n            {\n\n                sendCacheHeaders();\n                doHeader();\n\n                $redata = compact(array_keys(get_defined_vars()));\n                echo templatereplace(file_get_contents($sTemplatePath.\"/startpage.pstpl\"),array(),$redata,'frontend_helper[2634]');\n                echo \"\\t<div class='quotamessage'>\\n\";\n                echo \"\\t\".$quota['Message'].\"<br /><br />\\n\";\n                echo \"\\t<a href='\".$quota['Url'].\"'>\".$quota['UrlDescrip'].\"</a><br />\\n\";\n                echo CHtml::form(array(\"/survey/index\"), 'post', array('id'=>'limesurvey','name'=>'limesurvey')).\"\n                <input type='hidden' name='move' value='movenext' id='movenext' />\n                <button class='nav-button nav-button-icon-left ui-corner-all' class='submit' accesskey='p' onclick=\\\"javascript:document.limesurvey.move.value = 'moveprev'; document.limesurvey.submit();\\\" id='moveprevbtn'>\".$clang->gT(\"Previous\").\"</button>\n                <input type='hidden' name='thisstep' value='\".($_SESSION['survey_'.$surveyid]['step']).\"' id='thisstep' />\n                <input type='hidden' name='sid' value='\".returnGlobal('sid',true).\"' id='sid' />\n                <input type='hidden' name='token' value='\".$clienttoken.\"' id='token' />\n                </form>\\n\";\n                echo \"\\t</div>\\n\";\n                echo templatereplace(file_get_contents($sTemplatePath.\"/endpage.pstpl\"),array(),$redata,'frontend_helper[2644]');\n                doFooter();\n                exit;\n            }\n        }\n    }\n    else\n    {\n        // Unknown value\n        return false;\n    }\n\n}\n\n/**\n* encodeEmail : encode admin email in public part\n*\n* @param mixed $mail\n* @param mixed $text\n* @param mixed $class\n* @param mixed $params\n*/\nfunction encodeEmail($mail, $text=\"\", $class=\"\", $params=array())\n{\n    $encmail =\"\";\n    for($i=0; $i<strlen($mail); $i++)\n    {\n        $encMod = rand(0,2);\n        switch ($encMod)\n        {\n            case 0: // None\n                $encmail .= substr($mail,$i,1);\n                break;\n            case 1: // Decimal\n                $encmail .= \"&#\".ord(substr($mail,$i,1)).';';\n                break;\n            case 2: // Hexadecimal\n                $encmail .= \"&#x\".dechex(ord(substr($mail,$i,1))).';';\n                break;\n        }\n    }\n\n    if(!$text)\n    {\n        $text = $encmail;\n    }\n    return $text;\n}\n\n/**\n* GetReferringUrl() returns the referring URL\n* @return string\n*/\nfunction GetReferringUrl()\n{\n    global $clang;\n\n    $clang = Yii::app()->lang;\n\n    // read it from server variable\n    if(isset($_SERVER[\"HTTP_REFERER\"]))\n    {\n        if(!preg_match('/'.$_SERVER[\"SERVER_NAME\"].'/', $_SERVER[\"HTTP_REFERER\"]))\n        {\n            if (!Yii::app()->getConfig('strip_query_from_referer_url'))\n            {\n                return $_SERVER[\"HTTP_REFERER\"];\n            }\n            else\n            {\n                $aRefurl = explode(\"?\",$_SERVER[\"HTTP_REFERER\"]);\n                return $aRefurl[0];\n            }\n        }\n        else\n        {\n            return '-';\n        }\n    }\n    else\n    {\n        return null;\n    }\n}\n\n/**\n* Shows the welcome page, used in group by group and question by question mode\n*/\nfunction display_first_page() {\n    global $token, $surveyid, $thissurvey, $navigator;\n\t$totalquestions = $_SESSION['survey_'.$surveyid]['totalquestions'];\n\n    $clang = Yii::app()->lang;\n\n    // Fill some necessary var for template\n    $navigator = surveymover();\n    $sitename = Yii::app()->getConfig('sitename');\n    $languagechanger=makeLanguageChangerSurvey($clang->langcode);\n\n    sendCacheHeaders();\n    doHeader();\n\n    LimeExpressionManager::StartProcessingPage();\n    LimeExpressionManager::StartProcessingGroup(-1, false, $surveyid);  // start on welcome page\n\n    $redata = compact(array_keys(get_defined_vars()));\n    $sTemplatePath=$_SESSION['survey_'.$surveyid]['templatepath'];\n\n    echo templatereplace(file_get_contents($sTemplatePath.\"startpage.pstpl\"),array(),$redata,'frontend_helper[2757]');\n    echo CHtml::form(array(\"/survey/index\"), 'post', array('id'=>'limesurvey','name'=>'limesurvey','autocomplete'=>'off'));\n    echo \"\\n\\n<!-- START THE SURVEY -->\\n\";\n\n    echo templatereplace(file_get_contents($sTemplatePath.\"welcome.pstpl\"),array(),$redata,'frontend_helper[2762]').\"\\n\";\n    if ($thissurvey['anonymized'] == \"Y\")\n    {\n        echo templatereplace(file_get_contents($sTemplatePath.\"/privacy.pstpl\"),array(),$redata,'frontend_helper[2765]').\"\\n\";\n    }\n    echo templatereplace(file_get_contents($sTemplatePath.\"navigator.pstpl\"),array(),$redata,'frontend_helper[2767]');\n    if ($thissurvey['active'] != \"Y\")\n    {\n        echo \"<p style='text-align:center' class='error'>\".$clang->gT(\"This survey is currently not active. You will not be able to save your responses.\").\"</p>\\n\";\n    }\n    echo \"\\n<input type='hidden' name='sid' value='$surveyid' id='sid' />\\n\";\n    if (isset($token) && !empty($token)) {\n        echo \"\\n<input type='hidden' name='token' value='$token' id='token' />\\n\";\n    }\n    echo \"\\n<input type='hidden' name='lastgroupname' value='_WELCOME_SCREEN_' id='lastgroupname' />\\n\"; //This is to ensure consistency with mandatory checks, and new group test\n    $loadsecurity = returnGlobal('loadsecurity',true);\n    if (isset($loadsecurity)) {\n        echo \"\\n<input type='hidden' name='loadsecurity' value='$loadsecurity' id='loadsecurity' />\\n\";\n    }\n    $_SESSION['survey_'.$surveyid]['LEMpostKey'] = mt_rand();\n    echo \"<input type='hidden' name='LEMpostKey' value='{$_SESSION['survey_'.$surveyid]['LEMpostKey']}' id='LEMpostKey' />\\n\";\n    echo \"<input type='hidden' name='thisstep' id='thisstep' value='0' />\\n\";\n\n    echo \"\\n</form>\\n\";\n    echo templatereplace(file_get_contents($sTemplatePath.\"endpage.pstpl\"),array(),$redata,'frontend_helper[2782]');\n\n    echo LimeExpressionManager::GetRelevanceAndTailoringJavaScript();\n    LimeExpressionManager::FinishProcessingPage();\n    doFooter();\n}\n\n/**\n* killSurveySession : reset $_SESSION part for the survey\n* @param int $iSurveyID\n*/\nfunction killSurveySession($iSurveyID)\n{\n    // Unset the session\n    unset($_SESSION['survey_'.$iSurveyID]);\n    // Force EM to refresh\n    LimeExpressionManager::SetDirtyFlag();\n}\n\n/**\n* Resets all question timers by expiring the related cookie - this needs to be called before any output is done\n* @todo Make cookie survey ID aware\n*/\nfunction resetTimers()\n{\n    $cookie=new CHttpCookie('limesurvey_timers', '');\n    $cookie->expire = time()- 3600;\n    Yii::app()->request->cookies['limesurvey_timers'] = $cookie;\n}\n\n/**\n* Set the public survey language\n* Control if language exist in this survey, else set to survey default language\n* if $surveyid <= 0 : set the language to default site language\n* @param int $surveyid\n* @param string $language\n*/\nfunction SetSurveyLanguage($surveyid, $language)\n{\n    $surveyid=sanitize_int($surveyid);\n    $default_language = Yii::app()->getConfig('defaultlang');\n\n    if (isset($surveyid) && $surveyid>0)\n    {\n        $default_survey_language= Survey::model()->findByPk($surveyid)->language;\n        $additional_survey_languages = Survey::model()->findByPk($surveyid)->getAdditionalLanguages();\n        if (!isset($language) || ($language=='')\n        || !( in_array($language,$additional_survey_languages) || $language==$default_survey_language)\n        )\n        {\n            // Language not supported, fall back to survey's default language\n            $_SESSION['survey_'.$surveyid]['s_lang'] = $default_survey_language;\n        } else {\n            $_SESSION['survey_'.$surveyid]['s_lang'] =  $language;\n        }\n        Yii::import('application.libraries.Limesurvey_lang', true);\n        $clang = new limesurvey_lang($_SESSION['survey_'.$surveyid]['s_lang']);\n        $thissurvey=getSurveyInfo($surveyid, @$_SESSION['survey_'.$surveyid]['s_lang']);\n        Yii::app()->loadHelper('surveytranslator');\n        $_SESSION['dateformats'] = getDateFormatData($thissurvey['surveyls_dateformat'],$_SESSION['survey_'.$surveyid]['s_lang']);\n        LimeExpressionManager::SetEMLanguage($_SESSION['survey_'.$surveyid]['s_lang']);\n    }\n    else\n    {\n        if(!$language)\n        {\n            $language=$default_language;\n        }\n        $_SESSION['survey_'.$surveyid]['s_lang'] = $language;\n        Yii::import('application.libraries.Limesurvey_lang', true);\n        $clang = new Limesurvey_lang($language);\n    }\n\n    $oApplication=Yii::app();\n    $oApplication->lang=$clang;\n    return $clang;\n}\n\n/**\n* getMove get move button clicked\n**/\nfunction getMove()\n{\n#    $clang = Yii::app()->lang;\n    $aAcceptedMove=array('default','movenext','movesubmit','moveprev','saveall','loadall','clearall','changelang');\n    // We can control is save and load are OK : todo fix according to survey settings\n    // Maybe allow $aAcceptedMove in Plugin\n    $move=Yii::app()->request->getParam('move');\n    foreach($aAcceptedMove as $sAccepteMove)\n    {\n        if(Yii::app()->request->getParam($sAccepteMove))\n            $move=$sAccepteMove;\n    }\n    if($move=='clearall' && App()->request->getPost('confirm-clearall')!='confirm'){\n            $move=\"clearcancel\";\n    }\n    if($move=='default')\n    {\n        $surveyid=Yii::app()->getConfig('surveyID');\n        $thissurvey=getsurveyinfo($surveyid);\n        $iSessionStep=(isset($_SESSION['survey_'.$surveyid]['step']))?$_SESSION['survey_'.$surveyid]['step']:false;\n        $iSessionTotalSteps=(isset($_SESSION['survey_'.$surveyid]['totalsteps']))?$_SESSION['survey_'.$surveyid]['totalsteps']:false;\n        if ($iSessionStep && ($iSessionStep == $iSessionTotalSteps)|| $thissurvey['format'] == 'A')\n        {\n            $move=\"movesubmit\";\n        }\n        else\n        {\n            $move=\"movenext\";\n        }\n    }\n    return $move;\n}\n\n"], "filenames": ["application/helpers/common_helper.php", "application/helpers/frontend_helper.php"], "buggy_code_start_loc": [3802, 32], "buggy_code_end_loc": [3894, 33], "fixing_code_start_loc": [3801, 32], "fixing_code_end_loc": [3884, 33], "type": "NVD-CWE-Other", "message": "Incomplete blacklist vulnerability in the autoEscape function in common_helper.php in LimeSurvey 2.05+ Build 140618 allows remote attackers to conduct cross-site scripting (XSS) attacks via the GBK charset in the loadname parameter to index.php, related to the survey resume.", "other": {"cve": {"id": "CVE-2014-5018", "sourceIdentifier": "cve@mitre.org", "published": "2014-07-21T14:55:07.207", "lastModified": "2014-07-22T14:01:41.993", "vulnStatus": "Analyzed", "evaluatorComment": "<a href=\"http://cwe.mitre.org/data/definitions/184.html\" target=\"_blank\">CWE-184: Incomplete Blacklist</a>", "descriptions": [{"lang": "en", "value": "Incomplete blacklist vulnerability in the autoEscape function in common_helper.php in LimeSurvey 2.05+ Build 140618 allows remote attackers to conduct cross-site scripting (XSS) attacks via the GBK charset in the loadname parameter to index.php, related to the survey resume."}, {"lang": "es", "value": "Vulnerabilidad de lista negra incompleta en la funci\u00f3n autoEscape en common_helper.php en LimeSurvey 2.05+ Build 140618 permite a atacantes remotos realizar ataques de XSS a trav\u00e9s del juego de caracteres GBK en el par\u00e1metro loadname en index.php, relacionado con el resumen de encuestas."}], "metrics": {"cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "NVD-CWE-Other"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:limesurvey:limesurvey:2.05\\+:*:*:*:*:*:*:*", "matchCriteriaId": "311BFB28-CA38-4085-9A74-E9A7CE85E1AB"}]}]}], "references": [{"url": "http://packetstormsecurity.com/files/127369/Lime-Survey-2.05-Build-140618-XSS-SQL-Injection.html", "source": "cve@mitre.org", "tags": ["Exploit"]}, {"url": "https://github.com/LimeSurvey/LimeSurvey/commit/3a6dd6b44cef2fa3f96f403e1cb971d8d0d694b5", "source": "cve@mitre.org", "tags": ["Exploit", "Patch"]}]}, "github_commit_url": "https://github.com/LimeSurvey/LimeSurvey/commit/3a6dd6b44cef2fa3f96f403e1cb971d8d0d694b5"}}