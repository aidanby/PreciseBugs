{"buggy_code": ["<?php\n/***************************************************************************\n * for license information see LICENSE.md\n *  This module contains the main initialisation routine and often used\n *  functions. It is included by web.inc.php and cli.inc.php.\n *  TODO: accept-language des Browser auswerten\n ***************************************************************************/\n\nrequire_once __DIR__ . '/../vendor/autoload.php';\n\n$opt['rootpath'] = __DIR__ . '/../';\n\nspl_autoload_register(\n    function ($className): void {\n        if (!preg_match('/^[\\w]{1,}$/', $className)) {\n            return;\n        }\n\n        $file1 = __DIR__ . '/' . $className . '.class.php';\n        $file2 = __DIR__ . '/logic/' . $className . '.class.php';\n        if (file_exists($file1)) {\n            require_once $file1;\n        } elseif (file_exists($file2)) {\n            require_once $file2;\n        }\n    }\n);\n\nif (!function_exists('bindtextdomain')) {\n    function bindtextdomain(): void\n    {\n        // dummy function for travis\n    }\n}\n\nif (!function_exists('textdomain')) {\n    function textdomain(): void\n    {\n        // dummy function for travis\n    }\n}\n\nif (!function_exists('gettext')) {\n    function gettext(): void\n    {\n        // dummy function for travis\n    }\n}\n\n\n// check for broken browsers\n$useragent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';\n$useragent_msie = preg_match('/MSIE ([1-9]+).[0-9]+/', $useragent, $ua_matches) && !strpos($useragent, 'Opera');\n$useragent_msie_version = null;\nif (count($ua_matches) > 1) {\n    $useragent_msie_version = $ua_matches[1];\n}\n\n// yepp, we will use UTF-8\nmb_internal_encoding('UTF-8');\nmb_regex_encoding('UTF-8');\n\n// set options\nrequire_once __DIR__ . '/../config2/settings-dist.inc.php';\nrequire_once __DIR__ . '/../config2/settings.inc.php';\nrequire_once __DIR__ . '/../config2/verify-settings.inc.php';\n\nforeach ($opt['page']['banned_user_agents'] as $ua) {\n    if (strpos($useragent, $ua) !== false) {\n        die();\n    }\n}\n\n// backward compatibility for old settings\nif ($opt['forum']['url'] == '' &&\n    isset($opt['cron']['phpbbtopics']['url']) && $opt['cron']['phpbbtopics']['url'] != '' &&\n    isset($opt['cron']['phpbbtopics']['name']) && $opt['cron']['phpbbtopics']['name'] != '') {\n    $opt['forum']['url'] = $opt['cron']['phpbbtopics']['url'];\n    $opt['forum']['name'] = $opt['cron']['phpbbtopics']['name'];\n}\n\nset_domain_config();\n\nif (!(isset($_REQUEST['sqldebug']) && $_REQUEST['sqldebug'] == '1')) {\n    $opt['debug'] = $opt['debug'] & ~DEBUG_SQLDEBUGGER;\n}\n\nif (($opt['debug'] & DEBUG_FORCE_TRANSLATE) != DEBUG_FORCE_TRANSLATE) {\n    if (($opt['debug'] & DEBUG_TRANSLATE) == DEBUG_TRANSLATE\n        && isset($_REQUEST['trans']) && $_REQUEST['trans'] == '1'\n    ) {\n        $opt['debug'] = $opt['debug'] | DEBUG_TEMPLATES;\n    } else {\n        $opt['debug'] = $opt['debug'] & ~DEBUG_TRANSLATE;\n    }\n}\n\nrequire_once __DIR__ . '/errorhandler.inc.php';\nconfigure_php();\n\n\n$cookie = new Oc\\Session\\SessionDataCookie();\n\nnormalize_settings();\nset_language();\nset_usercountry();\nset_timezone();\n// set stylepath and langpath\nif (isset($opt['template']['style'])) {\n    if (strpos($opt['template']['style'], '.') !== false ||\n        strpos($opt['template']['style'], '/') !== false\n    ) {\n        $opt['template']['style'] = $opt['template']['default']['style'];\n    }\n\n    if (!is_dir(__DIR__ . '/../templates2/' . $opt['template']['style'])) {\n        $opt['template']['style'] = $opt['template']['default']['style'];\n    }\n} else {\n    $opt['template']['style'] = $opt['template']['default']['style'];\n}\n$opt['stylepath'] = __DIR__ . '/../templates2/' . $opt['template']['style'] . '/';\n\ncheck_useragent();\n\n/* setup smarty\n *\n */\nrequire __DIR__ . '/OcSmarty.class.php';\n$tpl = new OcSmarty();\n\n// include all we need\nrequire_once __DIR__ . '/logic/const.inc.php';\nrequire_once __DIR__ . '/error.inc.php';\nrequire_once __DIR__ . '/util.inc.php';\nrequire_once __DIR__ . '/db.inc.php';\nrequire_once __DIR__ . '/login.class.php';\nrequire_once __DIR__ . '/menu.class.php';\nrequire_once __DIR__ . '/logic/labels.inc.php';\n\n// apply post configuration\nif (function_exists('post_config')) {\n    post_config();\n}\n\n// check for email address problems\n// use direct database access instead of user class for performance reasons - need not\n// to include user.class.php in any script\nif (!isset($disable_verifyemail) &&\n    $login->userid > 0 &&\n    sql_value(\"SELECT `email_problems` FROM `user` WHERE `user_id`='&1'\", 0, $login->userid) != 0\n) {\n    header('Location: verifyemail.php?page=' . basename($_SERVER['REQUEST_URI']));\n    exit;\n}\n\n// normalize paths and urls\nfunction normalize_settings(): void\n{\n    global $opt;\n\n    $opt['charset']['iconv'] = strtoupper($opt['charset']['iconv']);\n\n    if (substr($opt['logic']['pictures']['url'], -1, 1) != '/') {\n        $opt['logic']['pictures']['url'] .= '/';\n    }\n    if (substr($opt['logic']['pictures']['dir'], -1, 1) != '/') {\n        $opt['logic']['pictures']['dir'] .= '/';\n    }\n    if (substr($opt['logic']['pictures']['thumb_url'], -1, 1) != '/') {\n        $opt['logic']['pictures']['thumb_url'] .= '/';\n    }\n    if (substr($opt['logic']['pictures']['thumb_dir'], -1, 1) != '/') {\n        $opt['logic']['pictures']['thumb_dir'] .= '/';\n    }\n\n    if (isset($opt['logic']['cachemaps']['wmsurl']) && strstr($opt['logic']['cachemaps']['wmsurl'], '://')) {\n        $opt['logic']['cachemaps']['wmsurl'] =\n            $opt['page']['protocol'] . strstr($opt['logic']['cachemaps']['wmsurl'], '://');\n    }\n}\n\nfunction configure_php(): void\n{\n    global $opt;\n\n    if ($opt['php']['debug'] == PHP_DEBUG_ON) {\n        ini_set('display_errors', true);\n        ini_set('error_reporting', E_ALL);\n        ini_set('mysql.trace_mode', true);\n        // SQL_CALC_FOUND_ROWS will not work with trace_mode on!\n        // Use the next two functions below as workaround.\n        register_errorhandlers();\n    } else {\n        ini_set('display_errors', false);\n        ini_set('error_reporting', E_ALL & ~E_NOTICE);\n        ini_set('mysql.trace_mode', false);\n        register_errorhandlers();\n    }\n}\n\nfunction sql_enable_foundrows(): void\n{\n    ini_set('mysql.trace_mode', false);\n}\n\nfunction sql_foundrows_done(): void\n{\n    global $opt;\n\n    if ($opt['php']['debug'] == PHP_DEBUG_ON) {\n        ini_set('mysql.trace_mode', true);\n    }\n}\n\nfunction set_domain_config(): void\n{\n    global $opt;\n\n    $domain = $opt['page']['domain'];\n\n    if (isset($opt['domain'][$domain]['style'])) {\n        $opt['template']['default']['style'] = $opt['domain'][$domain]['style'];\n    }\n    if (isset($opt['domain'][$domain]['cookiedomain'])) {\n        $opt['session']['domain'] = $opt['domain'][$domain]['cookiedomain'];\n    }\n\n    set_common_domain_config($opt);\n}\n\nfunction set_language(): void\n{\n    global $opt, $cookie;\n\n    $savelocale = true;\n    if (isset($_REQUEST['locale'])) {\n        $opt['template']['locale'] = strtoupper($_REQUEST['locale']);\n    } elseif (isset($_REQUEST['templocale'])) {\n        $opt['template']['locale'] = strtoupper($_REQUEST['templocale']);\n        $savelocale = false;\n    } else {\n        $opt['template']['locale'] = strtoupper($cookie->get('locale', $opt['template']['default']['locale']));\n    }\n\n    if (isset($opt['template']['locale']) && $opt['template']['locale'] != '') {\n        if (strpos($opt['template']['locale'], '.') !== false ||\n            strpos($opt['template']['locale'], '/') !== false\n        ) {\n            $opt['template']['locale'] = $opt['template']['default']['locale'];\n        }\n\n        if (!isset($opt['locale'][$opt['template']['locale']])) {\n            $opt['template']['locale'] = $opt['template']['default']['locale'];\n        }\n    } else {\n        $opt['template']['locale'] = $opt['template']['default']['locale'];\n    }\n\n    if ($savelocale) {\n        $cookie->set('locale', $opt['template']['locale'], $opt['template']['default']['locale']);\n    }\n\n    bindtextdomain('messages', __DIR__ . '/../var/cache2/translate');\n    set_php_locale();\n    textdomain('messages');\n}\n\nfunction set_usercountry(): void\n{\n    global $cookie;\n\n    if (isset($_REQUEST['usercountry'])) {\n        $cookie->set('usercountry', $_REQUEST['usercountry']);\n    }\n}\n\nfunction set_timezone(): void\n{\n    global $opt;\n\n    date_default_timezone_set($opt['php']['timezone']);\n}\n\nfunction check_useragent(): void\n{\n    global $ocpropping;\n\n    // are we Ocprop?\n    $ocpropping = isset($_SERVER['HTTP_USER_AGENT']) && strpos($_SERVER['HTTP_USER_AGENT'], 'Ocprop/') !== false;\n}\n\n// Exchange the protocol (http or https) in an URL to *this* website to the\n// protocol of the current request. Do not change external links.\n// This prevents i.e. Internet Explorer nag screens when embedding images\n// into a https-requested page.\n\nfunction use_current_protocol($url)\n{\n    global $opt;\n\n    if (strtolower(substr($url, 0, strlen($opt['page']['absolute_http_url']))) == $opt['page']['absolute_http_url']\n        && $opt['page']['https']['active']\n    ) {\n        return 'https' . strstr($url, '://');\n    } elseif (strtolower(substr($url, 0, strlen($opt['page']['absolute_https_url'])))\n        == $opt['page']['absolute_https_url']\n        && !$opt['page']['https']['active']\n    ) {\n        return 'http' . strstr($url, '://');\n    }\n\n    return $url;\n}\n\n\nfunction use_current_protocol_in_html($url)\n{\n    global $opt;\n\n    if ($opt['page']['https']['active']) {\n        return str_replace($opt['page']['absolute_http_url'], $opt['page']['absolute_https_url'], $url);\n    }\n\n    return $url;\n}\n", "{***************************************************************************\n* You can find the license in the docs directory\n***************************************************************************}\n\n<div class=\"content-txtbox-noshade\">\n    <div class=\"content-txtbox-noshade\">\n        <p class=\"startmessage\">{$message}</p>\n        <div class=\"buffer\" style=\"width: 500px;\">&nbsp;</div>\n    </div>\n</div>\n\n{if $core_hq_message.message !=\"\"}\n    <div class=\"note note-{$core_hq_message.type}\">\n        {$core_hq_message.message}\n    </div>\n    <p></p>\n{/if}\n\n{foreach from=$sections item=section}\n\n    {* news or blog *}\n    {if $section == 'news'}\n        <div>\n            <div class=\"content2-container bg-blue02\">\n                <table class=\"none\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\">\n                    <tr>\n                        <td>\n                            <p class=\"content-title-noshade-size3\">\n                                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-news.png\"\n                                     style=\"margin-right: 10px;\" width=\"22\" height=\"22\" alt=\"\"/>\n                                <a href=\"https://blog.opencaching.de/\"\n                                   style=\"color:rgb(88,144,168); text-decoration: none;\">{t}News{/t}</a>\n                                &nbsp; <span class=\"content-title-link\">[<a\n                                            href=\"https://blog.opencaching.de/\">{t}more{/t}...</a>]</span>\n                            </p>\n                        </td>\n                        {if \"$newsfeed\" != \"\"}\n                            <td style=\"text-align:right\">\n                                <a href=\"{$newsfeed}\"><img src=\"resource2/ocstyle/images/media/22x22-feed.png\"\n                                    width=\"22\" height=\"22\"/></a>\n                            </td>\n                            <td width=\"4px\"></td>\n                        {/if}\n                    </tr>\n                </table>\n            </div>\n        </div>\n        {if $extern_news}\n            <div id=\"blog\">\n                {if $news|@count}\n                    {include file=\"res_rssparser.tpl\" rss=$news}\n                {else}\n                    <p><em>{t}currently not available{/t}</em></p>\n                {/if}\n            </div>\n            <div class=\"buffer\" style=\"width: 500px;\">&nbsp;</div>\n        {/if}\n\n        {* next events *}\n    {elseif $section == 'events'}\n        <div class=\"content2-container bg-blue02 content2-section-no-p\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-event.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\" alt=\"\"/>\n                {t 1=$usercountry|escape}The next events in %1{/t}\n                {if $total_events > $events|@count}\n                    &nbsp;\n                    <span class=\"content-title-link\">[<a href=\"newcaches.php?cachetype=6\">{t}more{/t}...</a>]</span>\n                {/if}\n            </p>\n        </div>\n        <div class=\"content2-section-no-p\">\n            {include file=\"res_newevents.tpl\" events=$events}\n        </div>\n        {* new logpix *}\n    {elseif $section == 'logpics'}\n        <div class=\"content2-container bg-blue02\" style=\"margin-bottom:6px\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-pictures.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\"/>\n                <a href=\"newlogpics.php\"\n                   style=\"color:rgb(88,144,168); text-decoration: none;\">{t}New log pictures{/t}</a>\n                &nbsp; <span class=\"content-title-link\">[<a href=\"newlogpics.php\">{t}more{/t}...</a>]</span>\n            </p>\n        </div>\n        <div style=\"height:2px\"></div>\n        {include file=\"res_logpictures.tpl\" logdate=true loguser=true}\n\n        {* recommendations *}\n    {elseif $section == 'recommendations'}\n        <div class=\"content2-container bg-blue02\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-winner.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\" alt=\"\"/>\n                <a href=\"tops.php\" style=\"color:rgb(88,144,168); text-decoration: none;\">{t}Current top ratings{/t}</a>\n            </p>\n        </div>\n        <p style=\"line-height: 1.6em;\">{t 1=$usercountry|escape 2=$toprating_days}Geocaches with most ratings in the last %2 days in %1.{/t}</p>\n        <div style=\"margin-bottom:16px\">\n            {include file=\"res_newratings.tpl\" topratings=$topratings}\n        </div>\n        {* forum news *}\n    {elseif $section == 'forum'}\n        {if $forum_enabled==true}\n            <div class=\"buffer\" style=\"width: 500px;height: 2px;\">&nbsp;</div>\n            <div class=\"content2-container bg-blue02\">\n                <p class=\"content-title-noshade-size3\">\n                    <img src=\"resource2/ocstyle/images/misc/22x22-news.png\" style=\"margin-right: 10px;\" alt=\"\"\n                         width=\"22\" height=\"22\"/>\n                    <a href=\"{$forum_link|escape}\"\n                       style=\"color: rgb(88, 144, 168); text-decoration: none;\">{t 1=$forum_name|escape}New forum topcis (%1){/t}</a>\n                </p>\n            </div>\n            <div id=\"forum\">\n                {if $forum|@count}\n                    {include file=\"res_rssparser.tpl\" rss=$forum}\n                {else}\n                    <p><em>{t}currently not available{/t}</em></p>\n                {/if}\n            </div>\n            <div class=\"buffer\" style=\"width: 500px;\">&nbsp;</div>\n        {/if}\n\n        {* new caches *}\n    {elseif $section == 'newcaches'}\n        <div class=\"content2-container bg-blue02\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-traditional.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\" alt=\"\"/>\n                <a href=\"newcaches.php?country={$usercountryCode}\"\n                   style=\"color:rgb(88,144,168); text-decoration: none;\">{t 1=$usercountry|escape}Newest caches in %1{/t}</a>\n                &nbsp; <span class=\"content-title-link\">[<a href=\"newcaches.php\">{t}more{/t}...</a>]</span>\n            </p>\n        </div>\n        <p style=\"line-height: 1.6em;\">\n            ({t 1=$count_hiddens 2=$count_founds 3=$count_users}Total of %1 active Caches and %2 founds by %3 users{/t}\n            )</p>\n        <div class=\"content2-section-no-p\">\n            {include file=\"res_newcaches.tpl\" newcaches=$newcaches}\n        </div>\n    {/if}\n{/foreach}\n"], "fixing_code": ["<?php\n/***************************************************************************\n * for license information see LICENSE.md\n *  This module contains the main initialisation routine and often used\n *  functions. It is included by web.inc.php and cli.inc.php.\n *  TODO: accept-language des Browser auswerten\n ***************************************************************************/\n\nrequire_once __DIR__ . '/../vendor/autoload.php';\n\n$opt['rootpath'] = __DIR__ . '/../';\n\nspl_autoload_register(\n    function ($className): void {\n        if (!preg_match('/^[\\w]{1,}$/', $className)) {\n            return;\n        }\n\n        $file1 = __DIR__ . '/' . $className . '.class.php';\n        $file2 = __DIR__ . '/logic/' . $className . '.class.php';\n        if (file_exists($file1)) {\n            require_once $file1;\n        } elseif (file_exists($file2)) {\n            require_once $file2;\n        }\n    }\n);\n\nif (!function_exists('bindtextdomain')) {\n    function bindtextdomain(): void\n    {\n        // dummy function for travis\n    }\n}\n\nif (!function_exists('textdomain')) {\n    function textdomain(): void\n    {\n        // dummy function for travis\n    }\n}\n\nif (!function_exists('gettext')) {\n    function gettext(): void\n    {\n        // dummy function for travis\n    }\n}\n\n\n// check for broken browsers\n$useragent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';\n$useragent_msie = preg_match('/MSIE ([1-9]+).[0-9]+/', $useragent, $ua_matches) && !strpos($useragent, 'Opera');\n$useragent_msie_version = null;\nif (count($ua_matches) > 1) {\n    $useragent_msie_version = $ua_matches[1];\n}\n\n// yepp, we will use UTF-8\nmb_internal_encoding('UTF-8');\nmb_regex_encoding('UTF-8');\n\n// set options\nrequire_once __DIR__ . '/../config2/settings-dist.inc.php';\nrequire_once __DIR__ . '/../config2/settings.inc.php';\nrequire_once __DIR__ . '/../config2/verify-settings.inc.php';\n\nforeach ($opt['page']['banned_user_agents'] as $ua) {\n    if (strpos($useragent, $ua) !== false) {\n        die();\n    }\n}\n\n// backward compatibility for old settings\nif ($opt['forum']['url'] == '' &&\n    isset($opt['cron']['phpbbtopics']['url']) && $opt['cron']['phpbbtopics']['url'] != '' &&\n    isset($opt['cron']['phpbbtopics']['name']) && $opt['cron']['phpbbtopics']['name'] != '') {\n    $opt['forum']['url'] = $opt['cron']['phpbbtopics']['url'];\n    $opt['forum']['name'] = $opt['cron']['phpbbtopics']['name'];\n}\n\nset_domain_config();\n\nif (!(isset($_REQUEST['sqldebug']) && $_REQUEST['sqldebug'] == '1')) {\n    $opt['debug'] = $opt['debug'] & ~DEBUG_SQLDEBUGGER;\n}\n\nif (($opt['debug'] & DEBUG_FORCE_TRANSLATE) != DEBUG_FORCE_TRANSLATE) {\n    if (($opt['debug'] & DEBUG_TRANSLATE) == DEBUG_TRANSLATE\n        && isset($_REQUEST['trans']) && $_REQUEST['trans'] == '1'\n    ) {\n        $opt['debug'] = $opt['debug'] | DEBUG_TEMPLATES;\n    } else {\n        $opt['debug'] = $opt['debug'] & ~DEBUG_TRANSLATE;\n    }\n}\n\nrequire_once __DIR__ . '/errorhandler.inc.php';\nconfigure_php();\n\n\n$cookie = new Oc\\Session\\SessionDataCookie();\n\nnormalize_settings();\nset_language();\nset_usercountry();\nset_timezone();\n// set stylepath and langpath\nif (isset($opt['template']['style'])) {\n    if (strpos($opt['template']['style'], '.') !== false ||\n        strpos($opt['template']['style'], '/') !== false\n    ) {\n        $opt['template']['style'] = $opt['template']['default']['style'];\n    }\n\n    if (!is_dir(__DIR__ . '/../templates2/' . $opt['template']['style'])) {\n        $opt['template']['style'] = $opt['template']['default']['style'];\n    }\n} else {\n    $opt['template']['style'] = $opt['template']['default']['style'];\n}\n$opt['stylepath'] = __DIR__ . '/../templates2/' . $opt['template']['style'] . '/';\n\ncheck_useragent();\n\n/* setup smarty\n *\n */\nrequire __DIR__ . '/OcSmarty.class.php';\n$tpl = new OcSmarty();\n\n// include all we need\nrequire_once __DIR__ . '/logic/const.inc.php';\nrequire_once __DIR__ . '/error.inc.php';\nrequire_once __DIR__ . '/util.inc.php';\nrequire_once __DIR__ . '/db.inc.php';\nrequire_once __DIR__ . '/login.class.php';\nrequire_once __DIR__ . '/menu.class.php';\nrequire_once __DIR__ . '/logic/labels.inc.php';\n\n// apply post configuration\nif (function_exists('post_config')) {\n    post_config();\n}\n\n// check for email address problems\n// use direct database access instead of user class for performance reasons - need not\n// to include user.class.php in any script\nif (!isset($disable_verifyemail) &&\n    $login->userid > 0 &&\n    sql_value(\"SELECT `email_problems` FROM `user` WHERE `user_id`='&1'\", 0, $login->userid) != 0\n) {\n    header('Location: verifyemail.php?page=' . basename($_SERVER['REQUEST_URI']));\n    exit;\n}\n\n// normalize paths and urls\nfunction normalize_settings(): void\n{\n    global $opt;\n\n    $opt['charset']['iconv'] = strtoupper($opt['charset']['iconv']);\n\n    if (substr($opt['logic']['pictures']['url'], -1, 1) != '/') {\n        $opt['logic']['pictures']['url'] .= '/';\n    }\n    if (substr($opt['logic']['pictures']['dir'], -1, 1) != '/') {\n        $opt['logic']['pictures']['dir'] .= '/';\n    }\n    if (substr($opt['logic']['pictures']['thumb_url'], -1, 1) != '/') {\n        $opt['logic']['pictures']['thumb_url'] .= '/';\n    }\n    if (substr($opt['logic']['pictures']['thumb_dir'], -1, 1) != '/') {\n        $opt['logic']['pictures']['thumb_dir'] .= '/';\n    }\n\n    if (isset($opt['logic']['cachemaps']['wmsurl']) && strstr($opt['logic']['cachemaps']['wmsurl'], '://')) {\n        $opt['logic']['cachemaps']['wmsurl'] =\n            $opt['page']['protocol'] . strstr($opt['logic']['cachemaps']['wmsurl'], '://');\n    }\n}\n\nfunction configure_php(): void\n{\n    global $opt;\n\n    if ($opt['php']['debug'] == PHP_DEBUG_ON) {\n        ini_set('display_errors', true);\n        ini_set('error_reporting', E_ALL);\n        ini_set('mysql.trace_mode', true);\n        // SQL_CALC_FOUND_ROWS will not work with trace_mode on!\n        // Use the next two functions below as workaround.\n        register_errorhandlers();\n    } else {\n        ini_set('display_errors', false);\n        ini_set('error_reporting', E_ALL & ~E_NOTICE);\n        ini_set('mysql.trace_mode', false);\n        register_errorhandlers();\n    }\n}\n\nfunction sql_enable_foundrows(): void\n{\n    ini_set('mysql.trace_mode', false);\n}\n\nfunction sql_foundrows_done(): void\n{\n    global $opt;\n\n    if ($opt['php']['debug'] == PHP_DEBUG_ON) {\n        ini_set('mysql.trace_mode', true);\n    }\n}\n\nfunction set_domain_config(): void\n{\n    global $opt;\n\n    $domain = $opt['page']['domain'];\n\n    if (isset($opt['domain'][$domain]['style'])) {\n        $opt['template']['default']['style'] = $opt['domain'][$domain]['style'];\n    }\n    if (isset($opt['domain'][$domain]['cookiedomain'])) {\n        $opt['session']['domain'] = $opt['domain'][$domain]['cookiedomain'];\n    }\n\n    set_common_domain_config($opt);\n}\n\nfunction set_language(): void\n{\n    global $opt, $cookie;\n\n    $savelocale = true;\n    if (isset($_REQUEST['locale'])) {\n        $opt['template']['locale'] = strtoupper($_REQUEST['locale']);\n    } elseif (isset($_REQUEST['templocale'])) {\n        $opt['template']['locale'] = strtoupper($_REQUEST['templocale']);\n        $savelocale = false;\n    } else {\n        $opt['template']['locale'] = strtoupper($cookie->get('locale', $opt['template']['default']['locale']));\n    }\n\n    if (isset($opt['template']['locale']) && $opt['template']['locale'] != '') {\n        if (strpos($opt['template']['locale'], '.') !== false ||\n            strpos($opt['template']['locale'], '/') !== false\n        ) {\n            $opt['template']['locale'] = $opt['template']['default']['locale'];\n        }\n\n        if (!isset($opt['locale'][$opt['template']['locale']])) {\n            $opt['template']['locale'] = $opt['template']['default']['locale'];\n        }\n    } else {\n        $opt['template']['locale'] = $opt['template']['default']['locale'];\n    }\n\n    if ($savelocale) {\n        $cookie->set('locale', $opt['template']['locale'], $opt['template']['default']['locale']);\n    }\n\n    bindtextdomain('messages', __DIR__ . '/../var/cache2/translate');\n    set_php_locale();\n    textdomain('messages');\n}\n\nfunction set_usercountry(): void\n{\n    global $cookie;\n\n    if (preg_match('/^[a-z]{2}$/i', $_REQUEST['usercountry'] ?? '')) {\n        $cookie->set('usercountry', $_REQUEST['usercountry']);\n    }\n}\n\nfunction set_timezone(): void\n{\n    global $opt;\n\n    date_default_timezone_set($opt['php']['timezone']);\n}\n\nfunction check_useragent(): void\n{\n    global $ocpropping;\n\n    // are we Ocprop?\n    $ocpropping = isset($_SERVER['HTTP_USER_AGENT']) && strpos($_SERVER['HTTP_USER_AGENT'], 'Ocprop/') !== false;\n}\n\n// Exchange the protocol (http or https) in an URL to *this* website to the\n// protocol of the current request. Do not change external links.\n// This prevents i.e. Internet Explorer nag screens when embedding images\n// into a https-requested page.\n\nfunction use_current_protocol($url)\n{\n    global $opt;\n\n    if (strtolower(substr($url, 0, strlen($opt['page']['absolute_http_url']))) == $opt['page']['absolute_http_url']\n        && $opt['page']['https']['active']\n    ) {\n        return 'https' . strstr($url, '://');\n    } elseif (strtolower(substr($url, 0, strlen($opt['page']['absolute_https_url'])))\n        == $opt['page']['absolute_https_url']\n        && !$opt['page']['https']['active']\n    ) {\n        return 'http' . strstr($url, '://');\n    }\n\n    return $url;\n}\n\n\nfunction use_current_protocol_in_html($url)\n{\n    global $opt;\n\n    if ($opt['page']['https']['active']) {\n        return str_replace($opt['page']['absolute_http_url'], $opt['page']['absolute_https_url'], $url);\n    }\n\n    return $url;\n}\n", "{***************************************************************************\n* You can find the license in the docs directory\n***************************************************************************}\n\n<div class=\"content-txtbox-noshade\">\n    <div class=\"content-txtbox-noshade\">\n        <p class=\"startmessage\">{$message}</p>\n        <div class=\"buffer\" style=\"width: 500px;\">&nbsp;</div>\n    </div>\n</div>\n\n{if $core_hq_message.message !=\"\"}\n    <div class=\"note note-{$core_hq_message.type}\">\n        {$core_hq_message.message}\n    </div>\n    <p></p>\n{/if}\n\n{foreach from=$sections item=section}\n\n    {* news or blog *}\n    {if $section == 'news'}\n        <div>\n            <div class=\"content2-container bg-blue02\">\n                <table class=\"none\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\">\n                    <tr>\n                        <td>\n                            <p class=\"content-title-noshade-size3\">\n                                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-news.png\"\n                                     style=\"margin-right: 10px;\" width=\"22\" height=\"22\" alt=\"\"/>\n                                <a href=\"https://blog.opencaching.de/\"\n                                   style=\"color:rgb(88,144,168); text-decoration: none;\">{t}News{/t}</a>\n                                &nbsp; <span class=\"content-title-link\">[<a\n                                            href=\"https://blog.opencaching.de/\">{t}more{/t}...</a>]</span>\n                            </p>\n                        </td>\n                        {if \"$newsfeed\" != \"\"}\n                            <td style=\"text-align:right\">\n                                <a href=\"{$newsfeed}\"><img src=\"resource2/ocstyle/images/media/22x22-feed.png\"\n                                    width=\"22\" height=\"22\"/></a>\n                            </td>\n                            <td width=\"4px\"></td>\n                        {/if}\n                    </tr>\n                </table>\n            </div>\n        </div>\n        {if $extern_news}\n            <div id=\"blog\">\n                {if $news|@count}\n                    {include file=\"res_rssparser.tpl\" rss=$news}\n                {else}\n                    <p><em>{t}currently not available{/t}</em></p>\n                {/if}\n            </div>\n            <div class=\"buffer\" style=\"width: 500px;\">&nbsp;</div>\n        {/if}\n\n        {* next events *}\n    {elseif $section == 'events'}\n        <div class=\"content2-container bg-blue02 content2-section-no-p\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-event.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\" alt=\"\"/>\n                {t 1=$usercountry|escape}The next events in %1{/t}\n                {if $total_events > $events|@count}\n                    &nbsp;\n                    <span class=\"content-title-link\">[<a href=\"newcaches.php?cachetype=6\">{t}more{/t}...</a>]</span>\n                {/if}\n            </p>\n        </div>\n        <div class=\"content2-section-no-p\">\n            {include file=\"res_newevents.tpl\" events=$events}\n        </div>\n        {* new logpix *}\n    {elseif $section == 'logpics'}\n        <div class=\"content2-container bg-blue02\" style=\"margin-bottom:6px\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-pictures.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\"/>\n                <a href=\"newlogpics.php\"\n                   style=\"color:rgb(88,144,168); text-decoration: none;\">{t}New log pictures{/t}</a>\n                &nbsp; <span class=\"content-title-link\">[<a href=\"newlogpics.php\">{t}more{/t}...</a>]</span>\n            </p>\n        </div>\n        <div style=\"height:2px\"></div>\n        {include file=\"res_logpictures.tpl\" logdate=true loguser=true}\n\n        {* recommendations *}\n    {elseif $section == 'recommendations'}\n        <div class=\"content2-container bg-blue02\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-winner.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\" alt=\"\"/>\n                <a href=\"tops.php\" style=\"color:rgb(88,144,168); text-decoration: none;\">{t}Current top ratings{/t}</a>\n            </p>\n        </div>\n        <p style=\"line-height: 1.6em;\">{t 1=$usercountry|escape 2=$toprating_days}Geocaches with most ratings in the last %2 days in %1.{/t}</p>\n        <div style=\"margin-bottom:16px\">\n            {include file=\"res_newratings.tpl\" topratings=$topratings}\n        </div>\n        {* forum news *}\n    {elseif $section == 'forum'}\n        {if $forum_enabled==true}\n            <div class=\"buffer\" style=\"width: 500px;height: 2px;\">&nbsp;</div>\n            <div class=\"content2-container bg-blue02\">\n                <p class=\"content-title-noshade-size3\">\n                    <img src=\"resource2/ocstyle/images/misc/22x22-news.png\" style=\"margin-right: 10px;\" alt=\"\"\n                         width=\"22\" height=\"22\"/>\n                    <a href=\"{$forum_link|escape}\"\n                       style=\"color: rgb(88, 144, 168); text-decoration: none;\">{t 1=$forum_name|escape}New forum topcis (%1){/t}</a>\n                </p>\n            </div>\n            <div id=\"forum\">\n                {if $forum|@count}\n                    {include file=\"res_rssparser.tpl\" rss=$forum}\n                {else}\n                    <p><em>{t}currently not available{/t}</em></p>\n                {/if}\n            </div>\n            <div class=\"buffer\" style=\"width: 500px;\">&nbsp;</div>\n        {/if}\n\n        {* new caches *}\n    {elseif $section == 'newcaches'}\n        <div class=\"content2-container bg-blue02\">\n            <p class=\"content-title-noshade-size3\">\n                <img src=\"resource2/{$opt.template.style}/images/misc/22x22-traditional.png\" style=\"margin-right: 10px;\"\n                     width=\"22\" height=\"22\" alt=\"\"/>\n                <a href=\"newcaches.php?country={$usercountryCode|escape}\"\n                   style=\"color:rgb(88,144,168); text-decoration: none;\">{t 1=$usercountry|escape}Newest caches in %1{/t}</a>\n                &nbsp; <span class=\"content-title-link\">[<a href=\"newcaches.php\">{t}more{/t}...</a>]</span>\n            </p>\n        </div>\n        <p style=\"line-height: 1.6em;\">\n            ({t 1=$count_hiddens 2=$count_founds 3=$count_users}Total of %1 active Caches and %2 founds by %3 users{/t}\n            )</p>\n        <div class=\"content2-section-no-p\">\n            {include file=\"res_newcaches.tpl\" newcaches=$newcaches}\n        </div>\n    {/if}\n{/foreach}\n"], "filenames": ["htdocs/lib2/common.inc.php", "htdocs/templates2/ocstyle/start.tpl"], "buggy_code_start_loc": [273, 130], "buggy_code_end_loc": [274, 131], "fixing_code_start_loc": [273, 130], "fixing_code_end_loc": [274, 131], "type": "CWE-79", "message": "A vulnerability classified as problematic has been found in Opencaching Deutschland oc-server3. This affects an unknown part of the file htdocs/templates2/ocstyle/start.tpl of the component Cookie Handler. The manipulation of the argument usercountryCode leads to cross site scripting. It is possible to initiate the attack remotely. The name of the patch is c720f2777a452186c67ef30db3679dd409556544. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-216171.", "other": {"cve": {"id": "CVE-2022-4585", "sourceIdentifier": "cna@vuldb.com", "published": "2022-12-17T13:15:09.563", "lastModified": "2022-12-22T15:18:37.820", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability classified as problematic has been found in Opencaching Deutschland oc-server3. This affects an unknown part of the file htdocs/templates2/ocstyle/start.tpl of the component Cookie Handler. The manipulation of the argument usercountryCode leads to cross site scripting. It is possible to initiate the attack remotely. The name of the patch is c720f2777a452186c67ef30db3679dd409556544. It is recommended to apply a patch to fix this issue. The associated identifier of this vulnerability is VDB-216171."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 3.5, "baseSeverity": "LOW"}, "exploitabilityScore": 2.1, "impactScore": 1.4}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}, {"source": "cna@vuldb.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-707"}, {"lang": "en", "value": "CWE-74"}, {"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:oc-server3_project:oc-server3:-:*:*:*:*:*:*:*", "matchCriteriaId": "0539AAA6-04FE-42BD-9851-4F96BFC49220"}]}]}], "references": [{"url": "https://github.com/OpencachingDeutschland/oc-server3/commit/c720f2777a452186c67ef30db3679dd409556544", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/OpencachingDeutschland/oc-server3/pull/894", "source": "cna@vuldb.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://vuldb.com/?id.216171", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/OpencachingDeutschland/oc-server3/commit/c720f2777a452186c67ef30db3679dd409556544"}}