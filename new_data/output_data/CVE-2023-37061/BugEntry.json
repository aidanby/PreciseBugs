{"buggy_code": ["<?php\n\n/* For licensing terms, see /license.txt */\n/**\n * This page allows the platform admin to decide which languages should\n * be available in the language selection menu in the login page. This can be\n * useful for countries with more than one official language (like Belgium:\n * Dutch, French and German) or international organisations that are active in\n * a limited number of countries.\n *\n * @author Patrick Cool, main author\n * @author Roan EMbrechts, code cleaning\n *\n * @since Dokeos 1.6\n */\n\n// we are in the admin area so we do not need a course id\n$cidReset = true;\n\n// include global script\nrequire_once __DIR__.'/../inc/global.inc.php';\n$this_section = SECTION_PLATFORM_ADMIN;\n\napi_protect_admin_script();\n$action = isset($_GET['action']) ? $_GET['action'] : null;\n\n//Ajax request\nif (isset($_POST['sent_http_request'])) {\n    if (isset($_POST['visibility']) &&\n        $_POST['visibility'] == strval(intval($_POST['visibility'])) && $_POST['visibility'] == 0) {\n        if (isset($_POST['id']) && $_POST['id'] == strval(intval($_POST['id']))) {\n            if (SubLanguageManager::check_if_language_is_used($_POST['id']) == false) {\n                SubLanguageManager::make_unavailable_language($_POST['id']);\n                echo 'set_hidden';\n            } else {\n                echo 'confirm:'.intval($_POST['id']);\n            }\n        }\n    }\n    if (isset($_POST['visibility']) &&\n        $_POST['visibility'] == strval(intval($_POST['visibility'])) && $_POST['visibility'] == 1\n    ) {\n        if (isset($_POST['id']) && $_POST['id'] == strval(intval($_POST['id']))) {\n            SubLanguageManager::make_available_language($_POST['id']);\n            echo 'set_visible';\n        }\n    }\n    exit;\n}\n\n$msgLang = isset($_SESSION['disabled_languages']) ? 1 : 0;\n$disabledLang = isset($_SESSION['disabled_languages']) ? $_SESSION['disabled_languages'] : null;\n\n$htmlHeadXtra[] = '<script>\n $(function () {\n    var msgLang = '.$msgLang.';\n    var disabledLang = \"'.$disabledLang.'\"\n\n    if (msgLang == 1) {\n        $(\"#id_content_message\").html(\"<div class=\\\"warning-message alert alert-warning\\\">'.get_lang('ThereAreUsersUsingThisLanguagesDisableItManually').' <br /> \" + disabledLang + \"</div\");\n    }\n\n    $(\"#disable_all_except_default\").click(function () {\n        if(confirm(\"'.get_lang('ConfirmYourChoice').'\")) {\n            $.ajax({\n                contentType: \"application/x-www-form-urlencoded\",\n                beforeSend: function(myObject) {\n                    $(\"#id_content_message\").html(\"<div class=\\\"warning-message alert alert-warning\\\"><em class=\\\"fa fa-refresh fa-spin\\\"></em>  '.get_lang('Loading').'</div>\");\n                },\n                type: \"GET\",\n                url: \"../admin/languages.php\",\n                data: \"action=disable_all_except_default\",\n                success: function(datos) {\n                    window.location.href = \"'.api_get_self().'\";\n                }\n            });\n        }\n\n        return false;\n    });\n\n \t//$(window).load(function () {\n      $(\".make_visible_and_invisible\").attr(\"href\",\"javascript:void(0)\");\n\t//});\n\n \t$(\"td .make_visible_and_invisible\").click(function () {\n\t\tmake_visible=\"visible.png\";\n\t\tmake_invisible=\"invisible.png\";\n\t\tid_link_tool=$(this).attr(\"id\");\n\t\tid_img_link_tool=\"img\"+id_link_tool;\n\t\tpath_name_of_imglinktool=$(\"#\"+id_img_link_tool).attr(\"src\");\n\t\tlink_info_id=id_link_tool.split(\"linktool_\");\n\t\tlink_id=link_info_id[1];\n\n\t\tlink_tool_info=path_name_of_imglinktool.split(\"/\");\n\t\tmy_image_tool=link_tool_info[link_tool_info.length-1];\n\n\n\t\tif (my_image_tool==\"visible.png\") {\n\t\t\tpath_name_of_imglinktool=path_name_of_imglinktool.replace(make_visible,make_invisible);\n\t\t\tmy_visibility=0;\n\t\t} else {\n\t\t\tpath_name_of_imglinktool=path_name_of_imglinktool.replace(make_invisible,make_visible);\n\t\t\tmy_visibility=1;\n\t\t}\n\n\t\t$.ajax({\n\t\t\tcontentType: \"application/x-www-form-urlencoded\",\n\t\t\tbeforeSend: function(myObject) {\n\t\t\t\t$(\"#id_content_message\").html(\"<div class=\\\"warning-message alert alert-warning\\\"><em class=\\\"fa fa-refresh fa-spin\\\"></em>  '.get_lang('Loading').'</div>\");\n\t\t\t},\n\t\t\ttype: \"POST\",\n\t\t\turl: \"../admin/languages.php\",\n\t\t\tdata: \"id=\"+link_id+\"&visibility=\"+my_visibility+\"&sent_http_request=1\",\n\t\t\tsuccess: function(datos) {\n\n                if (datos==\"set_visible\" || datos==\"set_hidden\") {\n                    $(\"#\"+id_img_link_tool).attr(\"src\",path_name_of_imglinktool);\n\n                    if (my_image_tool==\"visible.png\") {\n                        $(\"#\"+id_img_link_tool).attr(\"alt\",\"'.get_lang('MakeAvailable', '').'\");\n                        $(\"#\"+id_img_link_tool).attr(\"title\",\"'.get_lang('MakeAvailable', '').'\");\n                    } else {\n                        $(\"#\"+id_img_link_tool).attr(\"alt\",\"'.get_lang('MakeUnavailable', '').'\");\n                        $(\"#\"+id_img_link_tool).attr(\"title\",\"'.get_lang('MakeUnavailable', '').'\");\n                    }\n\n                    if (datos==\"set_visible\") {\n                        $(\"#id_content_message\").html(\"<div class=\\\"confirmation-message alert alert-success\\\">'.get_lang('LanguageIsNowVisible', '').'</div>\");\n                    }\n\n                    if (datos==\"set_hidden\") {\n                        $(\"#id_content_message\").html(\"<div class=\\\"confirmation-message alert alert-success\\\">'.get_lang('LanguageIsNowHidden', '').'</div>\");\n                    }\n                }\n\n                var action = datos.split(\":\")[0];\n                if (action && action == \"confirm\") {\n                    var id = datos.split(\":\")[1];\n                    var sure = \"<div class=\\\"warning-message alert alert-warning\\\">'.get_lang('ThereAreUsersOrCoursesUsingThisLanguageYouWantToDisableThisLanguageAndSetUsersAndCoursesWithTheDefaultPortalLanguage').'<br /><br /><a href=\\\"languages.php?action=make_unavailable_confirmed&id=\"+id+\"\\\" class=\\\"btn btn-default\\\"><em class=\\\"fa fa-eye\\\"></em> '.get_lang('MakeUnavailable').'</a></div>\";\n                    $(\"#id_content_message\").html(sure);\n                    $(\"html, body\").animate({ scrollTop: 0 }, 200);\n\t\t\t\t}\n\t\t} });\n\t});\n\n });\n</script>';\n\n// unset the msg session variable\nunset($_SESSION['disabled_languages']);\n\n// setting the table that is needed for the styles management (there is a check if it exists later in this code)\n$tbl_admin_languages = Database::get_main_table(TABLE_MAIN_LANGUAGE);\n$tbl_settings_current = Database::get_main_table(TABLE_MAIN_SETTINGS_CURRENT);\n\n// we change the availability\nif ($action == 'makeunavailable') {\n    if (isset($_GET['id']) && $_GET['id'] == strval(intval($_GET['id']))) {\n        SubLanguageManager::make_unavailable_language($_GET['id']);\n    }\n}\n\nif ($action == 'makeavailable') {\n    if (isset($_GET['id']) && $_GET['id'] == strval(intval($_GET['id']))) {\n        SubLanguageManager::make_available_language($_GET['id']);\n    }\n}\n\nif ($action == 'setplatformlanguage') {\n    if (isset($_GET['id']) && $_GET['id'] == strval(intval($_GET['id']))) {\n        SubLanguageManager::set_platform_language($_GET['id']);\n    }\n}\n\nif ($action == 'disable_all_except_default') {\n    $allLanguages = SubLanguageManager::getAllLanguages();\n    $failedDisabledLanguages = '';\n    $checkFailed = false;\n    foreach ($allLanguages as $language) {\n        if (SubLanguageManager::check_if_language_is_used($language['id']) == false) {\n            SubLanguageManager::make_unavailable_language($language['id']);\n        } else {\n            if (intval(SubLanguageManager::get_platform_language_id()) !== intval($language['id'])) {\n                $failedDisabledLanguages .= ' - '.$language['english_name'].'<br />';\n                $checkFailed = true;\n            }\n        }\n    }\n\n    if ($checkFailed) {\n        $_SESSION['disabled_languages'] = $failedDisabledLanguages;\n    }\n}\n\nif (isset($_POST['Submit']) && $_POST['Submit']) {\n    // changing the name\n    $name = Database::escape_string($_POST['txt_name']);\n    $postId = (int) $_POST['edit_id'];\n    $sql = \"UPDATE $tbl_admin_languages SET original_name='$name'\n            WHERE id='$postId'\";\n    $result = Database::query($sql);\n    // changing the Platform language\n    if ($_POST['platformlanguage'] && $_POST['platformlanguage'] != '') {\n        api_set_setting('platformLanguage', $_POST['platformlanguage'], null, null, $_configuration['access_url']);\n    }\n} elseif (isset($_POST['action'])) {\n    switch ($_POST['action']) {\n        case 'makeavailable':\n            if (count($_POST['id']) > 0) {\n                $ids = [];\n                foreach ($_POST['id'] as $index => $id) {\n                    $ids[] = intval($id);\n                }\n                $sql = \"UPDATE $tbl_admin_languages SET available='1' WHERE id IN ('\".implode(\"','\", $ids).\"')\";\n                Database::query($sql);\n            }\n            break;\n        case 'makeunavailable':\n            if (count($_POST['id']) > 0) {\n                $ids = [];\n                foreach ($_POST['id'] as $index => $id) {\n                    $ids[] = intval($id);\n                }\n                $sql = \"UPDATE $tbl_admin_languages SET available='0' WHERE id IN ('\".implode(\"','\", $ids).\"')\";\n                Database::query($sql);\n            }\n            break;\n    }\n}\n\n// setting the name of the tool\n$tool_name = get_lang('PlatformLanguages');\n\n// setting breadcrumbs\n$interbreadcrumb[] = ['url' => 'index.php', 'name' => get_lang('PlatformAdmin')];\n\nif (isset($_GET['action']) && $_GET['action'] == 'make_unavailable_confirmed') {\n    $language_info = SubLanguageManager::get_all_information_of_language($_GET['id']);\n    if ($language_info['available'] == 1) {\n        SubLanguageManager::make_unavailable_language($_GET['id']);\n        $platform_language = api_get_setting('platformLanguage');\n        UserManager::update_all_user_languages($language_info['english_name'], $platform_language);\n        CourseManager::updateAllCourseLanguages($language_info['english_name'], $platform_language);\n        Display::addFlash(Display::return_message(get_lang('LanguageIsNowHidden'), 'confirm'));\n    }\n}\n\n// displaying the explanation for this tool\nDisplay::addFlash(Display::return_message(get_lang('PlatformLanguagesExplanation'), 'normal'));\n\n// including the header file (which includes the banner itself)\nDisplay::display_header($tool_name);\n\necho '<a\n    id=\"disable_all_except_default\"\n    href=\"javascript:void(0)\" class=\"btn btn-primary\">\n    <em class=\"fa fa-eye\"></em> '.get_lang('LanguagesDisableAllExceptDefault').'</a><br /><br />';\n\n// selecting all the languages\n$sql_select = \"SELECT * FROM $tbl_admin_languages\";\n$result_select = Database::query($sql_select);\n\n$sql_select_lang = \"SELECT * FROM $tbl_settings_current WHERE category='Languages'\";\n$result_select_lang = Database::query($sql_select_lang);\n$row_lang = Database::fetch_array($result_select_lang);\n\n// the table data\n$language_data = [];\nwhile ($row = Database::fetch_array($result_select)) {\n    $row_td = [];\n    $row_td[] = $row['id'];\n    // the first column is the original name of the language OR a form containing the original name\n    if ($action == 'edit' and $row['id'] == $_GET['id']) {\n        $checked = '';\n        if ($row['english_name'] == api_get_setting('platformLanguage')) {\n            $checked = ' checked=\"checked\" ';\n        }\n\n        $row_td[] = '<input type=\"hidden\" name=\"edit_id\" value=\"'.Security::remove_XSS($_GET['id']).'\" /><input type=\"text\" name=\"txt_name\" value=\"'.$row['original_name'].'\" /> '\n                .'<input type=\"checkbox\" '.$checked.'name=\"platformlanguage\" id=\"platformlanguage\" value=\"'.$row['english_name'].'\" /><label for=\"platformlanguage\">'.$row['original_name'].' '.get_lang('AsPlatformLanguage').'</label> <input type=\"submit\" name=\"Submit\" value=\"'.get_lang('Ok').'\" /><a name=\"value\" />';\n    } else {\n        $row_td[] = $row['original_name'];\n    }\n\n    // the second column\n    $row_td[] = $row['english_name'];\n\n    // the third column\n    $row_td[] = $row['dokeos_folder'];\n\n    if ($row['english_name'] == $row_lang['selected_value']) {\n        $setplatformlanguage = Display::return_icon('languages.png', get_lang('CurrentLanguagesPortal'), '', ICON_SIZE_SMALL);\n    } else {\n        $setplatformlanguage = \"<a href=\\\"javascript:if (confirm('\".addslashes(get_lang('AreYouSureYouWantToSetThisLanguageAsThePortalDefault')).\"')) { location.href='\".api_get_self().\"?action=setplatformlanguage&id=\".$row['id'].\"'; }\\\">\".Display::return_icon('languages_na.png', get_lang('SetLanguageAsDefault'), '', ICON_SIZE_SMALL).\"</a>\";\n    }\n\n    $allow_delete_sub_language = null;\n    $allow_add_term_sub_language = null;\n    if (api_get_setting('allow_use_sub_language') == 'true') {\n        $verified_if_is_sub_language = SubLanguageManager::check_if_language_is_sub_language($row['id']);\n\n        if ($verified_if_is_sub_language === false) {\n            $verified_if_is_father = SubLanguageManager::check_if_language_is_father($row['id']);\n            $allow_use_sub_language = \"&nbsp;<a href='sub_language_add.php?action=definenewsublanguage&id=\".$row['id'].\"'>\".Display::return_icon('new_language.png', get_lang('CreateSubLanguage'), [], ICON_SIZE_SMALL).\"</a>\";\n            if ($verified_if_is_father === true) {\n                //$allow_add_term_sub_language = \"&nbsp;<a href='sub_language.php?action=registersublanguage&id=\".$row['id'].\"'>\".Display::return_icon('2rightarrow.png', get_lang('AddWordForTheSubLanguage'),array('width'=>ICON_SIZE_SMALL,'height'=>ICON_SIZE_SMALL)).\"</a>\";\n                $allow_add_term_sub_language = '';\n            } else {\n                $allow_add_term_sub_language = '';\n            }\n        } else {\n            $allow_use_sub_language = '';\n            $all_information_of_sub_language = SubLanguageManager::get_all_information_of_language($row['id']);\n            $allow_add_term_sub_language = \"&nbsp;<a href='sub_language.php?action=registersublanguage&id=\".Security::remove_XSS($all_information_of_sub_language['parent_id']).\"&sub_language_id=\".Security::remove_XSS($row['id']).\"'>\".Display::return_icon('2rightarrow.png', get_lang('AddWordForTheSubLanguage'), ['width' => ICON_SIZE_SMALL, 'height' => ICON_SIZE_SMALL]).\"</a>\";\n            $allow_delete_sub_language = \"&nbsp;<a href='sub_language_add.php?action=deletesublanguage&id=\".Security::remove_XSS($all_information_of_sub_language['parent_id']).\"&sub_language_id=\".Security::remove_XSS($row['id']).\"'>\".Display::return_icon('delete.png', get_lang('DeleteSubLanguage'), ['width' => ICON_SIZE_SMALL, 'height' => ICON_SIZE_SMALL]).\"</a>\";\n        }\n    } else {\n        $allow_use_sub_language = '';\n        $allow_add_term_sub_language = '';\n    }\n\n    if ($row['english_name'] == $row_lang['selected_value']) {\n        $row_td[] = Display::return_icon('visible.png', get_lang('Visible')).\"<a href='\".api_get_self().\"?action=edit&id=\".$row['id'].\"#value'>\".Display::return_icon('edit.png', get_lang('Edit'), '', ICON_SIZE_SMALL).\"</a>\n                     &nbsp;\".$setplatformlanguage.$allow_use_sub_language.$allow_add_term_sub_language.$allow_delete_sub_language;\n    } else {\n        if ($row['available'] == 1) {\n            $row_td[] = \"<a class=\\\"make_visible_and_invisible\\\" id=\\\"linktool_\".$row['id'].\"\\\" href='\".api_get_self().\"?action=makeunavailable&id=\".$row['id'].\"'>\".Display::return_icon('visible.png', get_lang('MakeUnavailable'), ['id' => 'imglinktool_'.$row['id']], ICON_SIZE_SMALL).\"</a> <a href='\".api_get_self().\"?action=edit&id=\".$row['id'].\"#value'>\".Display::return_icon('edit.png', get_lang('Edit'), '', ICON_SIZE_SMALL).\"</a>&nbsp;\".$setplatformlanguage.$allow_use_sub_language.$allow_add_term_sub_language.$allow_delete_sub_language;\n        } else {\n            $row_td[] = \"<a class=\\\"make_visible_and_invisible\\\" id=\\\"linktool_\".$row['id'].\"\\\" href='\".api_get_self().\"?action=makeavailable&id=\".$row['id'].\"'>\".Display::return_icon('invisible.png', get_lang('MakeAvailable'), ['id' => 'imglinktool_'.$row['id']], ICON_SIZE_SMALL).\"</a> <a href='\".api_get_self().\"?action=edit&id=\".$row['id'].\"#value'>\".Display::return_icon('edit.png', get_lang('Edit'), '', ICON_SIZE_SMALL).\"</a>&nbsp;\".$setplatformlanguage.$allow_use_sub_language.$allow_add_term_sub_language.$allow_delete_sub_language;\n        }\n    }\n    $language_data[] = $row_td;\n}\n\n$table = new SortableTableFromArrayConfig($language_data, 1, count($language_data));\n$table->set_header(0, '');\n$table->set_header(1, get_lang('OriginalName'));\n$table->set_header(2, get_lang('EnglishName'));\n$table->set_header(3, get_lang('LMSFolder'));\n$table->set_header(4, get_lang('Properties'));\n$form_actions = [];\n$form_actions['makeavailable'] = get_lang('MakeAvailable');\n$form_actions['makeunavailable'] = get_lang('MakeUnavailable');\n$table->set_form_actions($form_actions);\necho '<div id=\"id_content_message\">&nbsp;</div>';\n$table->display();\n\nDisplay::display_footer();\n"], "fixing_code": ["<?php\n\n/* For licensing terms, see /license.txt */\n/**\n * This page allows the platform admin to decide which languages should\n * be available in the language selection menu in the login page. This can be\n * useful for countries with more than one official language (like Belgium:\n * Dutch, French and German) or international organisations that are active in\n * a limited number of countries.\n *\n * @author Patrick Cool, main author\n * @author Roan EMbrechts, code cleaning\n *\n * @since Dokeos 1.6\n */\n\n// we are in the admin area so we do not need a course id\n$cidReset = true;\n\n// include global script\nrequire_once __DIR__.'/../inc/global.inc.php';\n$this_section = SECTION_PLATFORM_ADMIN;\n\napi_protect_admin_script();\n$action = isset($_GET['action']) ? $_GET['action'] : null;\n\n//Ajax request\nif (isset($_POST['sent_http_request'])) {\n    if (isset($_POST['visibility']) &&\n        $_POST['visibility'] == strval(intval($_POST['visibility'])) && $_POST['visibility'] == 0) {\n        if (isset($_POST['id']) && $_POST['id'] == strval(intval($_POST['id']))) {\n            if (SubLanguageManager::check_if_language_is_used($_POST['id']) == false) {\n                SubLanguageManager::make_unavailable_language($_POST['id']);\n                echo 'set_hidden';\n            } else {\n                echo 'confirm:'.intval($_POST['id']);\n            }\n        }\n    }\n    if (isset($_POST['visibility']) &&\n        $_POST['visibility'] == strval(intval($_POST['visibility'])) && $_POST['visibility'] == 1\n    ) {\n        if (isset($_POST['id']) && $_POST['id'] == strval(intval($_POST['id']))) {\n            SubLanguageManager::make_available_language($_POST['id']);\n            echo 'set_visible';\n        }\n    }\n    exit;\n}\n\n$msgLang = isset($_SESSION['disabled_languages']) ? 1 : 0;\n$disabledLang = isset($_SESSION['disabled_languages']) ? $_SESSION['disabled_languages'] : null;\n\n$htmlHeadXtra[] = '<script>\n $(function () {\n    var msgLang = '.$msgLang.';\n    var disabledLang = \"'.$disabledLang.'\"\n\n    if (msgLang == 1) {\n        $(\"#id_content_message\").html(\"<div class=\\\"warning-message alert alert-warning\\\">'.get_lang('ThereAreUsersUsingThisLanguagesDisableItManually').' <br /> \" + disabledLang + \"</div\");\n    }\n\n    $(\"#disable_all_except_default\").click(function () {\n        if(confirm(\"'.get_lang('ConfirmYourChoice').'\")) {\n            $.ajax({\n                contentType: \"application/x-www-form-urlencoded\",\n                beforeSend: function(myObject) {\n                    $(\"#id_content_message\").html(\"<div class=\\\"warning-message alert alert-warning\\\"><em class=\\\"fa fa-refresh fa-spin\\\"></em>  '.get_lang('Loading').'</div>\");\n                },\n                type: \"GET\",\n                url: \"../admin/languages.php\",\n                data: \"action=disable_all_except_default\",\n                success: function(datos) {\n                    window.location.href = \"'.api_get_self().'\";\n                }\n            });\n        }\n\n        return false;\n    });\n\n \t//$(window).load(function () {\n      $(\".make_visible_and_invisible\").attr(\"href\",\"javascript:void(0)\");\n\t//});\n\n \t$(\"td .make_visible_and_invisible\").click(function () {\n\t\tmake_visible=\"visible.png\";\n\t\tmake_invisible=\"invisible.png\";\n\t\tid_link_tool=$(this).attr(\"id\");\n\t\tid_img_link_tool=\"img\"+id_link_tool;\n\t\tpath_name_of_imglinktool=$(\"#\"+id_img_link_tool).attr(\"src\");\n\t\tlink_info_id=id_link_tool.split(\"linktool_\");\n\t\tlink_id=link_info_id[1];\n\n\t\tlink_tool_info=path_name_of_imglinktool.split(\"/\");\n\t\tmy_image_tool=link_tool_info[link_tool_info.length-1];\n\n\n\t\tif (my_image_tool==\"visible.png\") {\n\t\t\tpath_name_of_imglinktool=path_name_of_imglinktool.replace(make_visible,make_invisible);\n\t\t\tmy_visibility=0;\n\t\t} else {\n\t\t\tpath_name_of_imglinktool=path_name_of_imglinktool.replace(make_invisible,make_visible);\n\t\t\tmy_visibility=1;\n\t\t}\n\n\t\t$.ajax({\n\t\t\tcontentType: \"application/x-www-form-urlencoded\",\n\t\t\tbeforeSend: function(myObject) {\n\t\t\t\t$(\"#id_content_message\").html(\"<div class=\\\"warning-message alert alert-warning\\\"><em class=\\\"fa fa-refresh fa-spin\\\"></em>  '.get_lang('Loading').'</div>\");\n\t\t\t},\n\t\t\ttype: \"POST\",\n\t\t\turl: \"../admin/languages.php\",\n\t\t\tdata: \"id=\"+link_id+\"&visibility=\"+my_visibility+\"&sent_http_request=1\",\n\t\t\tsuccess: function(datos) {\n\n                if (datos==\"set_visible\" || datos==\"set_hidden\") {\n                    $(\"#\"+id_img_link_tool).attr(\"src\",path_name_of_imglinktool);\n\n                    if (my_image_tool==\"visible.png\") {\n                        $(\"#\"+id_img_link_tool).attr(\"alt\",\"'.get_lang('MakeAvailable', '').'\");\n                        $(\"#\"+id_img_link_tool).attr(\"title\",\"'.get_lang('MakeAvailable', '').'\");\n                    } else {\n                        $(\"#\"+id_img_link_tool).attr(\"alt\",\"'.get_lang('MakeUnavailable', '').'\");\n                        $(\"#\"+id_img_link_tool).attr(\"title\",\"'.get_lang('MakeUnavailable', '').'\");\n                    }\n\n                    if (datos==\"set_visible\") {\n                        $(\"#id_content_message\").html(\"<div class=\\\"confirmation-message alert alert-success\\\">'.get_lang('LanguageIsNowVisible', '').'</div>\");\n                    }\n\n                    if (datos==\"set_hidden\") {\n                        $(\"#id_content_message\").html(\"<div class=\\\"confirmation-message alert alert-success\\\">'.get_lang('LanguageIsNowHidden', '').'</div>\");\n                    }\n                }\n\n                var action = datos.split(\":\")[0];\n                if (action && action == \"confirm\") {\n                    var id = datos.split(\":\")[1];\n                    var sure = \"<div class=\\\"warning-message alert alert-warning\\\">'.get_lang('ThereAreUsersOrCoursesUsingThisLanguageYouWantToDisableThisLanguageAndSetUsersAndCoursesWithTheDefaultPortalLanguage').'<br /><br /><a href=\\\"languages.php?action=make_unavailable_confirmed&id=\"+id+\"\\\" class=\\\"btn btn-default\\\"><em class=\\\"fa fa-eye\\\"></em> '.get_lang('MakeUnavailable').'</a></div>\";\n                    $(\"#id_content_message\").html(sure);\n                    $(\"html, body\").animate({ scrollTop: 0 }, 200);\n\t\t\t\t}\n\t\t} });\n\t});\n\n });\n</script>';\n\n// unset the msg session variable\nunset($_SESSION['disabled_languages']);\n\n// setting the table that is needed for the styles management (there is a check if it exists later in this code)\n$tbl_admin_languages = Database::get_main_table(TABLE_MAIN_LANGUAGE);\n$tbl_settings_current = Database::get_main_table(TABLE_MAIN_SETTINGS_CURRENT);\n\n// we change the availability\nif ($action == 'makeunavailable') {\n    if (isset($_GET['id']) && $_GET['id'] == strval(intval($_GET['id']))) {\n        SubLanguageManager::make_unavailable_language($_GET['id']);\n    }\n}\n\nif ($action == 'makeavailable') {\n    if (isset($_GET['id']) && $_GET['id'] == strval(intval($_GET['id']))) {\n        SubLanguageManager::make_available_language($_GET['id']);\n    }\n}\n\nif ($action == 'setplatformlanguage') {\n    if (isset($_GET['id']) && $_GET['id'] == strval(intval($_GET['id']))) {\n        SubLanguageManager::set_platform_language($_GET['id']);\n    }\n}\n\nif ($action == 'disable_all_except_default') {\n    $allLanguages = SubLanguageManager::getAllLanguages();\n    $failedDisabledLanguages = '';\n    $checkFailed = false;\n    foreach ($allLanguages as $language) {\n        if (SubLanguageManager::check_if_language_is_used($language['id']) == false) {\n            SubLanguageManager::make_unavailable_language($language['id']);\n        } else {\n            if (intval(SubLanguageManager::get_platform_language_id()) !== intval($language['id'])) {\n                $failedDisabledLanguages .= ' - '.$language['english_name'].'<br />';\n                $checkFailed = true;\n            }\n        }\n    }\n\n    if ($checkFailed) {\n        $_SESSION['disabled_languages'] = $failedDisabledLanguages;\n    }\n}\n\nif (isset($_POST['Submit']) && $_POST['Submit']) {\n    // changing the name\n    $name = html_filter($_POST['txt_name']);\n    $postId = (int) $_POST['edit_id'];\n    Database::update(\n        $tbl_admin_languages,\n        ['original_name' => $name],\n        ['id = ?' => $postId]\n    );\n    // changing the Platform language\n    if (isset($_POST['platformlanguage']) && $_POST['platformlanguage'] != '') {\n        api_set_setting('platformLanguage', $_POST['platformlanguage'], null, null, $_configuration['access_url']);\n    }\n} elseif (isset($_POST['action'])) {\n    switch ($_POST['action']) {\n        case 'makeavailable':\n            if (count($_POST['id']) > 0) {\n                $ids = [];\n                foreach ($_POST['id'] as $index => $id) {\n                    $ids[] = intval($id);\n                }\n                $sql = \"UPDATE $tbl_admin_languages SET available='1' WHERE id IN ('\".implode(\"','\", $ids).\"')\";\n                Database::query($sql);\n            }\n            break;\n        case 'makeunavailable':\n            if (count($_POST['id']) > 0) {\n                $ids = [];\n                foreach ($_POST['id'] as $index => $id) {\n                    $ids[] = intval($id);\n                }\n                $sql = \"UPDATE $tbl_admin_languages SET available='0' WHERE id IN ('\".implode(\"','\", $ids).\"')\";\n                Database::query($sql);\n            }\n            break;\n    }\n}\n\n// setting the name of the tool\n$tool_name = get_lang('PlatformLanguages');\n\n// setting breadcrumbs\n$interbreadcrumb[] = ['url' => 'index.php', 'name' => get_lang('PlatformAdmin')];\n\nif (isset($_GET['action']) && $_GET['action'] == 'make_unavailable_confirmed') {\n    $language_info = SubLanguageManager::get_all_information_of_language($_GET['id']);\n    if ($language_info['available'] == 1) {\n        SubLanguageManager::make_unavailable_language($_GET['id']);\n        $platform_language = api_get_setting('platformLanguage');\n        UserManager::update_all_user_languages($language_info['english_name'], $platform_language);\n        CourseManager::updateAllCourseLanguages($language_info['english_name'], $platform_language);\n        Display::addFlash(Display::return_message(get_lang('LanguageIsNowHidden'), 'confirm'));\n    }\n}\n\n// displaying the explanation for this tool\nDisplay::addFlash(Display::return_message(get_lang('PlatformLanguagesExplanation'), 'normal'));\n\n// including the header file (which includes the banner itself)\nDisplay::display_header($tool_name);\n\necho '<a\n    id=\"disable_all_except_default\"\n    href=\"javascript:void(0)\" class=\"btn btn-primary\">\n    <em class=\"fa fa-eye\"></em> '.get_lang('LanguagesDisableAllExceptDefault').'</a><br /><br />';\n\n// selecting all the languages\n$sql_select = \"SELECT * FROM $tbl_admin_languages\";\n$result_select = Database::query($sql_select);\n\n$sql_select_lang = \"SELECT * FROM $tbl_settings_current WHERE category='Languages'\";\n$result_select_lang = Database::query($sql_select_lang);\n$row_lang = Database::fetch_array($result_select_lang);\n\n// the table data\n$language_data = [];\nwhile ($row = Database::fetch_array($result_select)) {\n    $row_td = [];\n    $row_td[] = $row['id'];\n    // the first column is the original name of the language OR a form containing the original name\n    if ($action == 'edit' and $row['id'] == $_GET['id']) {\n        $checked = '';\n        if ($row['english_name'] == api_get_setting('platformLanguage')) {\n            $checked = ' checked=\"checked\" ';\n        }\n\n        $row_td[] = '<input type=\"hidden\" name=\"edit_id\" value=\"'.Security::remove_XSS($_GET['id']).'\" /><input type=\"text\" name=\"txt_name\" value=\"'.$row['original_name'].'\" /> '\n                .'<input type=\"checkbox\" '.$checked.'name=\"platformlanguage\" id=\"platformlanguage\" value=\"'.$row['english_name'].'\" /><label for=\"platformlanguage\">'.$row['original_name'].' '.get_lang('AsPlatformLanguage').'</label> <input type=\"submit\" name=\"Submit\" value=\"'.get_lang('Ok').'\" /><a name=\"value\" />';\n    } else {\n        $row_td[] = $row['original_name'];\n    }\n\n    // the second column\n    $row_td[] = $row['english_name'];\n\n    // the third column\n    $row_td[] = $row['dokeos_folder'];\n\n    if ($row['english_name'] == $row_lang['selected_value']) {\n        $setplatformlanguage = Display::return_icon('languages.png', get_lang('CurrentLanguagesPortal'), '', ICON_SIZE_SMALL);\n    } else {\n        $setplatformlanguage = \"<a href=\\\"javascript:if (confirm('\".addslashes(get_lang('AreYouSureYouWantToSetThisLanguageAsThePortalDefault')).\"')) { location.href='\".api_get_self().\"?action=setplatformlanguage&id=\".$row['id'].\"'; }\\\">\".Display::return_icon('languages_na.png', get_lang('SetLanguageAsDefault'), '', ICON_SIZE_SMALL).\"</a>\";\n    }\n\n    $allow_delete_sub_language = null;\n    $allow_add_term_sub_language = null;\n    if (api_get_setting('allow_use_sub_language') == 'true') {\n        $verified_if_is_sub_language = SubLanguageManager::check_if_language_is_sub_language($row['id']);\n\n        if ($verified_if_is_sub_language === false) {\n            $verified_if_is_father = SubLanguageManager::check_if_language_is_father($row['id']);\n            $allow_use_sub_language = \"&nbsp;<a href='sub_language_add.php?action=definenewsublanguage&id=\".$row['id'].\"'>\".Display::return_icon('new_language.png', get_lang('CreateSubLanguage'), [], ICON_SIZE_SMALL).\"</a>\";\n            if ($verified_if_is_father === true) {\n                //$allow_add_term_sub_language = \"&nbsp;<a href='sub_language.php?action=registersublanguage&id=\".$row['id'].\"'>\".Display::return_icon('2rightarrow.png', get_lang('AddWordForTheSubLanguage'),array('width'=>ICON_SIZE_SMALL,'height'=>ICON_SIZE_SMALL)).\"</a>\";\n                $allow_add_term_sub_language = '';\n            } else {\n                $allow_add_term_sub_language = '';\n            }\n        } else {\n            $allow_use_sub_language = '';\n            $all_information_of_sub_language = SubLanguageManager::get_all_information_of_language($row['id']);\n            $allow_add_term_sub_language = \"&nbsp;<a href='sub_language.php?action=registersublanguage&id=\".Security::remove_XSS($all_information_of_sub_language['parent_id']).\"&sub_language_id=\".Security::remove_XSS($row['id']).\"'>\".Display::return_icon('2rightarrow.png', get_lang('AddWordForTheSubLanguage'), ['width' => ICON_SIZE_SMALL, 'height' => ICON_SIZE_SMALL]).\"</a>\";\n            $allow_delete_sub_language = \"&nbsp;<a href='sub_language_add.php?action=deletesublanguage&id=\".Security::remove_XSS($all_information_of_sub_language['parent_id']).\"&sub_language_id=\".Security::remove_XSS($row['id']).\"'>\".Display::return_icon('delete.png', get_lang('DeleteSubLanguage'), ['width' => ICON_SIZE_SMALL, 'height' => ICON_SIZE_SMALL]).\"</a>\";\n        }\n    } else {\n        $allow_use_sub_language = '';\n        $allow_add_term_sub_language = '';\n    }\n\n    if ($row['english_name'] == $row_lang['selected_value']) {\n        $row_td[] = Display::return_icon('visible.png', get_lang('Visible')).\"<a href='\".api_get_self().\"?action=edit&id=\".$row['id'].\"#value'>\".Display::return_icon('edit.png', get_lang('Edit'), '', ICON_SIZE_SMALL).\"</a>\n                     &nbsp;\".$setplatformlanguage.$allow_use_sub_language.$allow_add_term_sub_language.$allow_delete_sub_language;\n    } else {\n        if ($row['available'] == 1) {\n            $row_td[] = \"<a class=\\\"make_visible_and_invisible\\\" id=\\\"linktool_\".$row['id'].\"\\\" href='\".api_get_self().\"?action=makeunavailable&id=\".$row['id'].\"'>\".Display::return_icon('visible.png', get_lang('MakeUnavailable'), ['id' => 'imglinktool_'.$row['id']], ICON_SIZE_SMALL).\"</a> <a href='\".api_get_self().\"?action=edit&id=\".$row['id'].\"#value'>\".Display::return_icon('edit.png', get_lang('Edit'), '', ICON_SIZE_SMALL).\"</a>&nbsp;\".$setplatformlanguage.$allow_use_sub_language.$allow_add_term_sub_language.$allow_delete_sub_language;\n        } else {\n            $row_td[] = \"<a class=\\\"make_visible_and_invisible\\\" id=\\\"linktool_\".$row['id'].\"\\\" href='\".api_get_self().\"?action=makeavailable&id=\".$row['id'].\"'>\".Display::return_icon('invisible.png', get_lang('MakeAvailable'), ['id' => 'imglinktool_'.$row['id']], ICON_SIZE_SMALL).\"</a> <a href='\".api_get_self().\"?action=edit&id=\".$row['id'].\"#value'>\".Display::return_icon('edit.png', get_lang('Edit'), '', ICON_SIZE_SMALL).\"</a>&nbsp;\".$setplatformlanguage.$allow_use_sub_language.$allow_add_term_sub_language.$allow_delete_sub_language;\n        }\n    }\n    $language_data[] = $row_td;\n}\n\n$table = new SortableTableFromArrayConfig($language_data, 1, count($language_data));\n$table->set_header(0, '');\n$table->set_header(1, get_lang('OriginalName'));\n$table->set_header(2, get_lang('EnglishName'));\n$table->set_header(3, get_lang('LMSFolder'));\n$table->set_header(4, get_lang('Properties'));\n$form_actions = [];\n$form_actions['makeavailable'] = get_lang('MakeAvailable');\n$form_actions['makeunavailable'] = get_lang('MakeUnavailable');\n$table->set_form_actions($form_actions);\necho '<div id=\"id_content_message\">&nbsp;</div>';\n$table->display();\n\nDisplay::display_footer();\n"], "filenames": ["main/admin/languages.php"], "buggy_code_start_loc": [198], "buggy_code_end_loc": [205], "fixing_code_start_loc": [198], "fixing_code_end_loc": [207], "type": "CWE-79", "message": "Chamilo 1.11.x up to 1.11.20 allows users with an admin privilege account to insert XSS in the languages management section.", "other": {"cve": {"id": "CVE-2023-37061", "sourceIdentifier": "cve@mitre.org", "published": "2023-07-07T17:15:09.827", "lastModified": "2023-07-12T20:58:22.373", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Chamilo 1.11.x up to 1.11.20 allows users with an admin privilege account to insert XSS in the languages management section."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.8, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 1.7, "impactScore": 2.7}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:chamilo:chamilo:*:*:*:*:*:*:*:*", "versionStartIncluding": "1.11.0", "versionEndIncluding": "1.11.20", "matchCriteriaId": "7C09DB8C-2B3F-4EE5-B478-546C468B1E04"}]}]}], "references": [{"url": "https://github.com/chamilo/chamilo-lms/commit/75e9b3e0acac6f7a643da6ff19a00d55a94417a1", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://support.chamilo.org/projects/1/wiki/Security_issues#Issue-116-2023-06-06-Low-impact-Low-risk-XSS-through-admin-account-languages-management", "source": "cve@mitre.org", "tags": ["Patch", "Vendor Advisory"]}]}, "github_commit_url": "https://github.com/chamilo/chamilo-lms/commit/75e9b3e0acac6f7a643da6ff19a00d55a94417a1"}}