{"buggy_code": ["<div class=\"templates form\">\n<?php \n\techo $this->Form->create('Template');\n?>\n\t<fieldset>\n\t\t<legend><?php echo __('Create Template'); ?></legend>\n\t<?php\n\t\techo ($this->Form->input('name', array('div' => 'clear')));\n\t\techo ($this->Form->input('tags', array('id' => 'hiddenTags','div' => 'clear', 'label' => false, 'type' => 'text', 'value' => '[]', 'style' => 'display:none;')));\n\t\t?>\n\t\t\t<div id =\"tagList\">\n\t\t\t\t<label>Tags</label>\n\t\t\t\t<table>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><table><tr id = \"tags\"></tr></table></td>\n\t\t\t\t\t\t<td id = \"addTagButtonTD\">\n\t\t\t\t\t\t\t<span onClick=\"activateTagField()\" id=\"addTagButton\" class=\"btn btn-inverse noPrint\" style=\"line-height:10px; padding: 4px 4px;\">+</span>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td id = \"addTagFieldTD\">\n\t\t\t\t\t\t\t<?php\n\t\t\t\t\t\t\t\techo $this->Form->input('tagsPusher', array(\n\t\t\t\t\t\t\t\t\t'div' => 'clear',\n\t\t\t\t\t\t\t\t\t'id' => 'addTagField',\n\t\t\t\t\t\t\t\t\t'options' => array($tags),\n\t\t\t\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t\t\t\t'onChange' => 'tagFieldChange()',\n\t\t\t\t\t\t\t\t\t'style' => \"height:22px;padding:0px;margin-bottom:0px;display:none;\",\n\t\t\t\t\t\t\t\t\t'empty' => 'Add a tag',\n\t\t\t\t\t\t\t\t));\n\t\t\t\t\t\t\t?>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t</div><br />\t\t\n\t<?php \n\t\techo $this->Form->input('description', array(\n\t\t\t'label' => 'Event Description',\n\t\t\t'div' => 'clear',\n\t\t\t'type' => 'textarea',\n\t\t\t'class' => 'form-control span6',\n\t\t\t'placeholder' => 'A description of the template'\n\t\t));\n\t\techo $this->Form->input('share', array(\n\t\t\t'label' => 'Share this template with others',\n\t\t));\n\t?>\n\t</fieldset>\n<?php echo $this->Form->button(__('Create'), array('class' => 'btn btn-primary'));\n\techo $this->Form->end();?>\n</div>\n<?php \n\techo $this->element('side_menu', array('menuList' => 'templates', 'menuItem' => 'add'));\n?>\n<script type=\"text/javascript\">\nvar selectedTags = [];\nvar allTags = [\n\t<?php \n\t\tforeach ($tagInfo as $tag) {\n\t\t\techo \"{'id' : '\" . $tag['Tags']['id'] . \"', 'name' : '\" . $tag['Tags']['name'] . \"', 'colour' : '\" . $tag['Tags']['colour'] . \"'},\";\n\t\t}\n\t?>\n];\n</script>\n<?php echo $this->Js->writeBuffer();", "<div class=\"templates form\">\n<?php \n\techo $this->Form->create('Template');\n?>\n\t<fieldset>\n\t\t<legend><?php echo __('Edit Template'); ?></legend>\n\t<?php\n\t\techo ($this->Form->input('name', array('div' => 'clear')));\n\t\techo ($this->Form->input('tags', array('id' => 'hiddenTags','div' => 'clear', 'label' => false, 'type' => 'text', 'value' => '[]', 'style' => 'display:none;')));\n\t\t?>\n\t\t\t<div id =\"tagList\">\n\t\t\t\t<label>Tags</label>\n\t\t\t\t<table>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><table><tr id = \"tags\"></tr></table></td>\n\t\t\t\t\t\t<td id = \"addTagButtonTD\">\n\t\t\t\t\t\t\t<span onClick=\"activateTagField()\" id=\"addTagButton\" class=\"btn btn-inverse noPrint\" style=\"line-height:10px; padding: 4px 4px;\">+</span>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td id = \"addTagFieldTD\">\n\t\t\t\t\t\t\t<?php\n\t\t\t\t\t\t\t\techo $this->Form->input('tagsPusher', array(\n\t\t\t\t\t\t\t\t\t'div' => 'clear',\n\t\t\t\t\t\t\t\t\t'id' => 'addTagField',\n\t\t\t\t\t\t\t\t\t'options' => array($tags),\n\t\t\t\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t\t\t\t'onChange' => 'tagFieldChange()',\n\t\t\t\t\t\t\t\t\t'style' => \"height:22px;padding:0px;margin-bottom:0px;display:none;\",\n\t\t\t\t\t\t\t\t\t'empty' => 'Add a tag',\n\t\t\t\t\t\t\t\t));\n\t\t\t\t\t\t\t?>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t</div><br />\t\t\n\t<?php \n\t\techo $this->Form->input('description', array(\n\t\t\t'label' => 'Event Description',\n\t\t\t'div' => 'clear',\n\t\t\t'type' => 'textarea',\n\t\t\t'class' => 'form-control span6',\n\t\t\t'placeholder' => 'A description of the template'\n\t\t));\n\t\techo $this->Form->input('share', array(\n\t\t\t'label' => 'Share this template with others',\n\t\t));\n\t?>\n\t</fieldset>\n<?php echo $this->Form->button(__('Edit'), array('class' => 'btn btn-primary'));\n\techo $this->Form->end();?>\n</div>\n<?php \n\techo $this->element('side_menu', array('menuList' => 'templates', 'menuItem' => 'edit', 'id' => $id, 'mayModify' => $mayModify));\n?>\n<script type=\"text/javascript\">\nvar selectedTags = [\n\t<?php \n\t\tforeach ($currentTags as $k => $t) {\n\t\t\tif ($k != 0) echo ', ';\n\t\t\techo '\"' . $t['Tag']['name'] . '\"';\n\t\t}\n\t?>\n];\nvar allTags = [\n\t<?php \n\t\tforeach ($tagInfo as $tag) {\n\t\t\techo \"{'id' : '\" . $tag['Tags']['id'] . \"', 'name' : '\" . $tag['Tags']['name'] . \"', 'colour' : '\" . $tag['Tags']['colour'] . \"'},\";\n\t\t}\n\t?>\n];\n$(document).ready( function () {\n\tfor (var i = 0, len = selectedTags.length; i < len; i++) {\n\t\tappendTemplateTag(selectedTags[i], 'yes');\n\t}\n});\n</script>\n<?php echo $this->Js->writeBuffer();", "String.prototype.ucfirst = function() {\n\treturn this.charAt(0).toUpperCase() + this.slice(1);\n}\n\nfunction deleteObject(type, action, id, event) {\n\tvar destination = 'attributes';\n\tif (type == 'shadow_attributes') destination = 'shadow_attributes';\n\tif (type == 'template_elements') destination = 'template_elements';\n\t$.get( \"/\" + destination + \"/\" + action + \"/\" + id, function(data) {\n\t\t$(\"#confirmation_box\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#confirmation_box\").html(data);\n\t});\n}\n\nfunction publishPopup(id, type) {\n\tvar action = \"alert\";\n\tif (type == \"publish\") action = \"publish\";\n\tvar destination = 'attributes';\n\t$.get( \"/events/\" + action + \"/\" + id, function(data) {\n\t\t$(\"#confirmation_box\").html(data);\n\t\t$(\"#confirmation_box\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t});\n}\n\nfunction submitPublish(id, type) {\n\t$(\"#PromptForm\").submit();\n}\n\nfunction editTemplateElement(type, id) {\n\t$.get( \"/template_elements/edit/\" + type + \"/\" + id, function(data) {\n\t\t$(\"#popover_form\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#popover_form\").html(data);\n\n\t});\n}\n\nfunction cancelPrompt() {\n\t$(\"#confirmation_box\").fadeIn();\n\t$(\"#gray_out\").fadeOut();\n\t$(\"#confirmation_box\").empty();\n}\n\nfunction submitDeletion(context_id, action, type, id) {\n\tvar context = 'event';\n\tif (type == 'template_elements') context = 'template';\n\tvar formData = $('#PromptForm').serialize();\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdata: formData, \n\t\tsuccess:function (data, textStatus) {\n\t\t\tupdateIndex(context_id, context);\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#confirmation_box\").fadeOut();\n\t\t\t$(\"#gray_out\").fadeOut();\n\t\t},\n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/\" + type + \"/\" + action + \"/\" + id,\n\t});\n}\n\nfunction initiatePasswordReset(id) {\n\t$.get( \"/users/initiatePasswordReset/\" + id, function(data) {\n\t\t$(\"#confirmation_box\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#confirmation_box\").html(data);\n\t});\n}\n\nfunction submitPasswordReset(id) {\n\tvar formData = $('#PromptForm').serialize();\n\tvar url = \"/users/initiatePasswordReset/\" + id;\n\tif ($('#firstTime').is(\":checked\")) url += \"/true\";\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdata: formData, \n\t\tsuccess:function (data, textStatus) {\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#confirmation_box\").fadeOut();\n\t\t\t$(\"#gray_out\").fadeOut();\n\t\t},\n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:url,\n\t});\n}\n\nfunction acceptObject(type, id, event) {\n\tname = '#ShadowAttribute_' + id + '_accept';\n\tvar formData = $(name).serialize();\n\t$.ajax({\n\t\tdata: formData, \n\t\tsuccess:function (data, textStatus) {\n\t\t\tupdateIndex(event, 'event');\n\t\t\teventUnpublish();\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/shadow_attributes/accept/\" + id,\n\t});\n}\t\n\nfunction eventUnpublish() {\n\t$('.publishButtons').show();\n\t$('.exportButtons').hide();\n\t$('.published').hide();\n\t$('.notPublished').show();\n}\n\nfunction updateIndex(id, context, newPage) {\n\tif (typeof newPage !== 'undefined') page = newPage;\n\tvar url, div;\n\tif (context == 'event') {\n\t\turl = \"/events/view/\" + id + \"/attributesPage:\" + page;\n\t\tdiv = \"#attributes_div\";\n\t}\n\tif (context == 'template') {\n\t\turl = \"/template_elements/index/\" + id;\n\t\tdiv = \"#templateElements\";\n\t}\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(div).html(data);\n\t\t}, \n\t\turl: url,\n\t});\n}\n\nfunction updateAttributeFieldOnSuccess(name, type, id, field, event) {\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\tif (field != 'timestamp') {\n\t\t\t\t$(\".loading\").show();\n\t\t\t}\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\tif (field != 'timestamp') {\n\t\t\t\t$(\".loading\").hide();\n\t\t\t\t$(name + '_solid').html(data);\n\t\t\t\t$(name + '_placeholder').empty();\n\t\t\t\t$(name + '_solid').show();\n\t\t\t} else {\n\t\t\t\t$('#' + type + '_' + id + '_' + 'timestamp_solid').html(data);\n\t\t\t}\n\t\t}, \n\t\turl:\"/attributes/fetchViewValue/\" + id + \"/\" + field,\n\t});\n}\n\nfunction activateField(type, id, field, event) {\n\tresetForms();\n\tif (type == 'denyForm') return;\n\tvar objectType = 'attributes';\n\tif (type == 'ShadowAttribute') {\n\t\tobjectType = 'shadow_attributes';\n\t}\n\tvar name = '#' + type + '_' + id + '_' + field;\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(name + '_placeholder').html(data);\n\t\t\tpostActivationScripts(name, type, id, field, event);\n\t\t}, \n\t\turl:\"/\" + objectType + \"/fetchEditForm/\" + id + \"/\" + field,\n\t});\n}\n\n//if someone clicks an inactive field, replace it with the hidden form field. Also, focus it and bind a focusout event, so that it gets saved if the user clicks away.\n//If a user presses enter, submit the form\nfunction postActivationScripts(name, type, id, field, event) {\n\t$(name + '_field').focus();\n\tinputFieldButtonActive(name + '_field');\n\tif (field == 'value' || field == 'comment') {\n\t\tautoresize($(name + '_field')[0]);\n\t\t$(name + '_field').on('keyup', function () {\n\t\t    autoresize(this);\n\t\t});\n\t}\n\t$(name + '_form').submit(function(e){ \n\t\te.preventDefault();\n\t\tsubmitForm(type, id, field, event);\n\t\treturn false;\n\t});\n\t\n\t$(name + '_form').bind(\"focusout\", function() {\n\t\tinputFieldButtonPassive(name + '_field');\n\t});\n\n\t$(name + '_form').bind(\"focusin\", function(){\n\t\tinputFieldButtonActive(name + '_field');\n\t});\n\t\n\t$(name + '_form').bind(\"keydown\", function(e) {\n\t\tif (e.ctrlKey && (e.keyCode == 13 || e.keyCode == 10)) {\n\t\t\tsubmitForm(type, id, field, event);\n\t\t}\n\t});\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-accept').bind('click', function() {\n\t\tsubmitForm(type, id, field, event);\n\t});\n\t\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-decline').bind('click', function() {\n\t\tresetForms();\n\t});\n\n\t$(name + '_solid').hide();\n}\n\nfunction resetForms() {\n\t$('.inline-field-solid').show();\n\t$('.inline-field-placeholder').empty();\n}\n\nfunction inputFieldButtonActive(selector) {\n\t$(selector).closest('.inline-input-container').children('.inline-input-accept').removeClass('inline-input-passive').addClass('inline-input-active');\n\t$(selector).closest('.inline-input-container').children('.inline-input-decline').removeClass('inline-input-passive').addClass('inline-input-active');\n}\n\nfunction inputFieldButtonPassive(selector) {\n\t$(selector).closest('.inline-input-container').children('.inline-input-accept').addClass('inline-input-passive').removeClass('inline-input-active');\n\t$(selector).closest('.inline-input-container').children('.inline-input-daecline').addClass('inline-input-passive').removeClass('inline-input-active');\n}\n\nfunction autoresize(textarea) {\n    textarea.style.height = '20px';\n    textarea.style.height = (textarea.scrollHeight) + 'px';\n}\n\n// submit the form - this can be triggered by unfocusing the activated form field or by submitting the form (hitting enter)\n// after the form is submitted, intercept the response and act on it \nfunction submitForm(type, id, field, context) {\n\tvar object_type = 'attributes';\n\tvar action = \"editField\";\n\tvar name = '#' + type + '_' + id + '_' + field;\n\tif (type == 'ShadowAttribute') {\n\t\tobject_type = 'shadow_attributes';\n\t}\n\t$.ajax({\n\t\tdata: $(name + '_field').closest(\"form\").serialize(),\n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\thandleAjaxEditResponse(data, name, type, id, field, context);\n\t\t}, \n\t\terror:function() {\n\t\t\tshowMessage('fail', 'Request failed for an unknown reason.');\n\t\t\tupdateIndex(context, 'event');\n\t\t},\n\t\ttype:\"post\", \n\t\turl:\"/\" + object_type + \"/\" + action + \"/\" + id\n\t});\n\t$(name + '_field').unbind(\"keyup\");\n\t$(name + '_form').unbind(\"focusout\");\n\treturn false;\n};\n\nfunction submitTagForm(id) {\n\t$.ajax({\n\t\tdata: $('#EventTag').closest(\"form\").serialize(), \n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tsuccess:function (data, textStatus) {\n\t\t\tloadEventTags(id);\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\terror:function() {\n\t\t\tshowMessage('fail', 'Could not add tag.');\n\t\t\tloadEventTags(id);\n\t\t},\n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t},\n\t\ttype:\"post\", \n\t\turl:\"/events/addTag/\" + id\n\t});\n\treturn false;\n}\n\nfunction handleAjaxEditResponse(data, name, type, id, field, event) {\n\tresponseArray = JSON.parse(data);\n\tif (type == 'Attribute') {\n\t\tif (responseArray.saved) {\n\t\t\tshowMessage('success', responseArray.success);\n\t\t\tupdateAttributeFieldOnSuccess(name, type, id, field, event);\n\t\t\tupdateAttributeFieldOnSuccess(name, type, id, 'timestamp', event);\n\t\t\teventUnpublish();\n\t\t} else {\n\t\t\tshowMessage('fail', 'Validation failed: ' + responseArray.errors.value);\n\t\t\tupdateAttributeFieldOnSuccess(name, type, id, field, event);\n\t\t}\n\t}\n\tif (type == 'ShadowAttribute') {\n\t\tupdateIndex(event, 'event');\n\t}\n}\n\nfunction handleGenericAjaxResponse(data) {\n\tif (typeof data == 'string') {\n\t\tresponseArray = JSON.parse(data);\n\t} else {\n\t\tresponseArray = data;\n\t}\n\tif (responseArray.saved) {\n\t\tshowMessage('success', responseArray.success);\n\t\treturn true;\n\t} else {\n\t\tshowMessage('fail', responseArray.errors);\n\t\treturn false;\n\t}\n}\n\nfunction toggleAllAttributeCheckboxes() {\n\tif ($(\".select_all\").is(\":checked\")) {\n\t\t$(\".select_attribute\").prop(\"checked\", true);\n\t\t$(\".select_proposal\").prop(\"checked\", true);\n\t} else {\n\t\t$(\".select_attribute\").prop(\"checked\", false);\n\t\t$(\".select_proposal\").prop(\"checked\", false);\n\t}\n}\n\nfunction attributeListAnyAttributeCheckBoxesChecked() {\n\tif ($('.select_attribute:checked').length > 0) $('.mass-select').show();\n\telse $('.mass-select').hide();\n}\n\nfunction attributeListAnyProposalCheckBoxesChecked() {\n\tif ($('.select_proposal:checked').length > 0) $('.mass-proposal-select').show();\n\telse $('.mass-proposal-select').hide();\n}\n\nfunction multiSelectAction(event, context) {\n\tvar settings = {\n\t\t\tdeleteAttributes: {\n\t\t\t\tconfirmation: \"Are you sure you want to delete all selected attributes?\",\n\t\t\t\tcontroller: \"attributes\",\n\t\t\t\tcamelCase: \"Attribute\",\n\t\t\t\talias: \"attribute\",\n\t\t\t\taction: \"delete\",\n\t\t\t},\n\t\t\tacceptProposals: {\n\t\t\t\tconfirmation: \"Are you sure you want to accept all selected proposals?\",\n\t\t\t\tcontroller: \"shadow_attributes\",\n\t\t\t\tcamelCase: \"ShadowAttribute\",\n\t\t\t\talias: \"proposal\",\n\t\t\t\taction: \"accept\",\n\t\t\t},\n\t\t\tdiscardProposals: {\n\t\t\t\tconfirmation: \"Are you sure you want to discard all selected proposals?\",\n\t\t\t\tcontroller: \"shadow_attributes\",\n\t\t\t\tcamelCase: \"ShadowAttribute\",\n\t\t\t\talias: \"proposal\",\n\t\t\t\taction: \"discard\",\n\t\t\t},\n\t};\n\tvar answer = confirm(\"Are you sure you want to \" + settings[context][\"action\"] + \" all selected \" + settings[context][\"alias\"] + \"s?\");\n\tif (answer) {\n\t\tvar selected = [];\n\t\t$(\".select_\" + settings[context][\"alias\"]).each(function() {\n\t\t\tif ($(this).is(\":checked\")) {\n\t\t\t\tvar temp= $(this).data(\"id\");\n\t\t\t\tselected.push(temp);\n\t\t\t}\n\t\t});\n\t\t$('#' + settings[context][\"camelCase\"] + 'Ids' + settings[context][\"action\"].ucfirst()).attr('value', JSON.stringify(selected));\n\t\tvar formData = $('#' + settings[context][\"action\"] + '_selected').serialize();\n\t\t$.ajax({\n\t\t\tdata: formData, \n\t\t\tcache: false,\n\t\t\ttype:\"POST\", \n\t\t\turl:\"/\" + settings[context][\"controller\"] + \"/\" + settings[context][\"action\"] + \"Selected/\" + event,\n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\tupdateIndex(event, 'event');\n\t\t\t\tvar result = handleGenericAjaxResponse(data);\n\t\t\t\tif (settings[context][\"action\"] != \"discard\" && result == true) eventUnpublish(); \n\t\t\t}, \n\t\t});\n\t}\n\treturn false;\n}\n\nfunction editSelectedAttributes(event) {\n\t$.get(\"/attributes/editSelected/\"+event, function(data) {\n\t\t$(\"#popover_form\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#popover_form\").html(data);\n\t});\n}\n\nfunction getSelected() {\n\tvar selected = [];\n\t$(\".select_attribute\").each(function() {\n\t\tif ($(this).is(\":checked\")) {\n\t\t\tvar test = $(this).data(\"id\");\n\t\t\tselected.push(test);\n\t\t}\n\t});\n\treturn JSON.stringify(selected);\n}\n\nfunction loadEventTags(id) {\n\t$.ajax({\n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".eventTagContainer\").html(data);\n\t\t}, \n\t\turl:\"/tags/showEventTag/\" + id,\n\t});\n}\n\nfunction removeEventTag(event, tag) {\n\tvar answer = confirm(\"Are you sure you want to remove this tag from the event?\");\n\tif (answer) {\n\t\tvar formData = $('#removeTag_' + tag).serialize();\n\t\t$.ajax({\n\t\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t\t$(\".loading\").show();\n\t\t\t}, \n\t\t\tdata: formData, \n\t\t\ttype:\"POST\", \n\t\t\tcache: false,\n\t\t\turl:\"/events/removeTag/\" + event + '/' + tag,\n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\tloadEventTags(event);\n\t\t\t\thandleGenericAjaxResponse(data);\n\t\t\t}, \n\t\t\tcomplete:function() {\n\t\t\t\t$(\".loading\").hide();\n\t\t\t}\n\t\t});\n\t}\n\treturn false;\n}\n\nfunction clickCreateButton(event, type) {\n\tvar destination = 'attributes';\n\tif (type == 'Proposal') destination = 'shadow_attributes';\n\t$.get( \"/\" + destination + \"/add/\" + event, function(data) {\n\t\t$(\"#popover_form\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#popover_form\").html(data);\n\t});\n}\n\nfunction submitPopoverForm(context_id, referer, update_context_id) {\n\tvar url = null;\n\tvar context = 'event';\n\tvar contextNamingConvention = 'Attribute';\n\tswitch (referer) {\n\t\tcase 'add': \n\t\t\turl = \"/attributes/add/\" + context_id;\n\t\t\tbreak;\n\t\tcase 'propose':\n\t\t\turl = \"/shadow_attributes/add/\" + context_id;\n\t\t\tbreak;\n\t\tcase 'massEdit':\n\t\t\turl = \"/attributes/editSelected/\" + context_id;\n\t\t\tbreak;\n\t\tcase 'addTextElement':\n\t\t\turl = \"/templateElements/add/text/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontextNamingConvention = 'TemplateElementText';\n\t\t\tbreak;\n\t\tcase 'editTextElement':\n\t\t\turl = \"/templateElements/edit/text/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontext_id = update_context_id;\n\t\t\tcontextNamingConvention = 'TemplateElementText';\n\t\t\tbreak;\n\t\tcase 'addAttributeElement':\n\t\t\turl = \"/templateElements/add/attribute/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontextNamingConvention = 'TemplateElementAttribute';\n\t\t\tbreak;\n\t\tcase 'editAttributeElement':\n\t\t\turl = \"/templateElements/edit/attribute/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontext_id = update_context_id;\n\t\t\tcontextNamingConvention = 'TemplateElementAttribute';\n\t\t\tbreak;\n\t\tcase 'addFileElement':\n\t\t\turl = \"/templateElements/add/file/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontextNamingConvention = 'TemplateElementFile';\n\t\t\tbreak;\n\t\tcase 'editFileElement':\n\t\t\turl = \"/templateElements/edit/file/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontext_id = update_context_id;\n\t\t\tcontextNamingConvention = 'TemplateElementFile';\n\t\t\tbreak;\n\t\tcase 'replaceAttributes':\n\t\t\turl = \"/attributes/attributeReplace/\" + context_id;\n\t\t\tbreak;\n\t}\n\t\n\tif (url !== null) {\n\t\t$.ajax({\n\t\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t\t$(\".loading\").show();\n\t\t\t\t$(\"#gray_out\").fadeOut();\n\t\t\t\t$(\"#popover_form\").fadeOut();\n\t\t\t}, \n\t\t\tdata: $(\"#submitButton\").closest(\"form\").serialize(), \n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\tvar result = handleAjaxPopoverResponse(data, context_id, url, referer, context, contextNamingConvention);\n\t\t\t\tif (context == 'event' && (referer == 'add' || referer == 'massEdit' || referer == 'replaceAttributes')) eventUnpublish();\n\t\t\t\t$(\".loading\").show();\n\t\t\t}, \n\t\t\ttype:\"post\", \n\t\t\turl:url\n\t\t});\n\t\t$(\"#popover_form\").empty();\n\t}\n};\n\nfunction handleAjaxPopoverResponse(response, context_id, url, referer, context, contextNamingConvention) {\n\tresponseArray = JSON.parse(response);\n\tvar message = null;\n\tif (responseArray.saved) {\n\t\tupdateIndex(context_id, context);\n\t\tif (responseArray.success) {\n\t\t\tshowMessage(\"success\", responseArray.success);\n\t\t}\n\t\tif (responseArray.errors) {\n\t\t\tshowMessage(\"fail\", responseArray.errors);\n\t\t}\n\t} else {\n\t\tvar savedArray = saveValuesForPersistance();\n\t\t$.ajax({\n\t\t\tasync:true, \n\t\t\tdataType:\"html\", \n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\t$(\"#gray_out\").fadeIn();\n\t\t\t\t$(\"#popover_form\").fadeIn();\n\t\t\t\t$(\"#popover_form\").html(data);\n\t\t\t\tvar error_context = context.charAt(0).toUpperCase() + context.slice(1);\n\t\t\t\thandleValidationErrors(responseArray.errors, context, contextNamingConvention);\n\t\t\t\tif (!isEmpty(responseArray)) {\n\t\t\t\t\t$(\"#formWarning\").show();\n\t\t\t\t\t$(\"#formWarning\").html('The object(s) could not be saved. Please, try again.');\n\t\t\t\t}\n\t\t\t\trecoverValuesFromPersistance(savedArray);\n\t\t\t\t$(\".loading\").hide();\n\t\t\t},\n\t\t\turl:url\n\t\t});\t\n\t}\n}\n\nfunction isEmpty(obj) {\n\tvar name;\n\tfor (name in obj) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n\n//before we update the form (in case the action failed), we want to retrieve the data from every field, so that we can set the fields in the new form that we fetch \nfunction saveValuesForPersistance() {\n\tvar formPersistanceArray = new Array();\n\tfor (i = 0; i < fieldsArray.length; i++) {\n\t\tformPersistanceArray[fieldsArray[i]] = document.getElementById(fieldsArray[i]).value;\n\t}\n\treturn formPersistanceArray;\n}\n\nfunction recoverValuesFromPersistance(formPersistanceArray) {\n\tfor (i = 0; i < fieldsArray.length; i++) {\n\t\t document.getElementById(fieldsArray[i]).value = formPersistanceArray[fieldsArray[i]];\n\t}\n}\n\nfunction handleValidationErrors(responseArray, context, contextNamingConvention) {\n\tfor (var k in responseArray) {\n\t\tvar elementName = k.charAt(0).toUpperCase() + k.slice(1);\n\t\t$(\"#\" + contextNamingConvention + elementName).parent().addClass(\"error\");\n\t\t$(\"#\" + contextNamingConvention + elementName).parent().append(\"<div class=\\\"error-message\\\">\" + responseArray[k] + \"</div>\");\n\t}\n}\n\nfunction toggleHistogramType(type, old) {\n\tvar done = false;\n\told.forEach(function(entry) {\n\t\tif (type == entry) {\n\t\t\tdone = true;\n\t\t\told.splice(old.indexOf(entry), 1);\n\t\t}\n\t});\n\tif (done == false) old.push(type);\n\tupdateHistogram(JSON.stringify(old));\n}\n\nfunction updateHistogram(selected) {\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#histogram\").html(data);\n\t\t}, \n\t\turl:\"/users/histogram/\" + selected,\n\t});\n}\n\nfunction showMessage(success, message, context) {\n\tif (typeof context !== \"undefined\") {\n\t\t$(\"#ajax_\" + success, window.parent.document).html(message);\n\t\tvar duration = 1000 + (message.length * 40);\n\t\t$(\"#ajax_\" + success + \"_container\", window.parent.document).fadeIn(\"slow\");\n\t\t$(\"#ajax_\" + success + \"_container\", window.parent.document).delay(duration).fadeOut(\"slow\");\n\t}\n\t$(\"#ajax_\" + success).html(message);\n\tvar duration = 1000 + (message.length * 40);\n\t$(\"#ajax_\" + success + \"_container\").fadeIn(\"slow\");\n\t$(\"#ajax_\" + success + \"_container\").delay(duration).fadeOut(\"slow\");\n}\n\nfunction cancelPopoverForm() {\n\t$(\"#popover_form\").empty();\n\t$('#gray_out').fadeOut();\n\t$('#popover_form').fadeOut();\n}\n\nfunction activateTagField() {\n\t$(\"#addTagButton\").hide();\n\t$(\"#addTagField\").show();\n}\n\nfunction tagFieldChange() {\n\tif ($(\"#addTagField :selected\").val() > 0) {\n\t\tvar selected = $(\"#addTagField :selected\").text();\n\t\tif ($.inArray(selected, selectedTags)==-1) {\n\t\t\tselectedTags.push(selected);\n\t\t\tappendTemplateTag(selected);\n\t\t}\n\t}\n\t$(\"#addTagButton\").show();\n\t$(\"#addTagField\").hide();\n}\n\nfunction appendTemplateTag(selected) {\n\tvar selectedTag;\n\tallTags.forEach(function(tag) {\n\t\tif (tag.name == selected) {\n\t\t\t$.ajax({\n\t\t\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t\t\t$(\".loading\").show();\n\t\t\t\t}, \n\t\t\t\tdataType:\"html\", \n\t\t\t\tcache: false,\n\t\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\t\t$(\".loading\").hide();\n\t\t\t\t\t$(\"#tags\").append(data);\n\t\t\t\t}, \n\t\t\t\turl:\"/tags/viewTag/\" + tag.id,\n\t\t\t});\n\t\t\tupdateSelectedTags();\n\t\t}\n\t});\n}\n\nfunction addAllTags(tagArray) {\n\tparsedTagArray = JSON.parse(tagArray);\n\tparsedTagArray.forEach(function(tag) {\n\t\tappendTemplateTag(tag);\n\t});\n}\n\nfunction removeTemplateTag(id, name) {\n\tselectedTags.forEach(function(tag) {\n\t\tif (tag == name) {\n\t\t\tvar index = selectedTags.indexOf(name);\n\t\t\tif (index > -1) {\n\t\t\t\tselectedTags.splice(index, 1);\n\t\t\t\tupdateSelectedTags();\n\t\t\t}\n\t\t}\n\t});\n\t$('#tag_bubble_' + id).remove();\n}\n\nfunction updateSelectedTags() {\n\t$('#hiddenTags').attr(\"value\", JSON.stringify(selectedTags));\n}\n\nfunction saveElementSorting(order) {\n\t$.ajax({\n\t\tdata: order, \n\t\tdataType:\"json\",\n\t\tcontentType: \"application/json\",\n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/templates/saveElementSorting/\",\n\t});\n}\n\nfunction templateAddElementClicked(id) {\n\t$(\"#gray_out\").fadeIn();\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#popover_form\").html(data);\n\t\t\t$(\"#popover_form\").fadeIn();\n\t\t}, \n\t\turl:\"/template_elements/templateElementAddChoices/\" + id,\n\t});\n}\n\nfunction templateAddElement(type, id) {\n\t$.ajax({\n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\"#popover_form\").html(data);\n\t\t}, \n\t\turl:\"/template_elements/add/\" + type + \"/\" + id,\n\t});\n}\n\nfunction templateUpdateAvailableTypes() {\n\t$(\"#innerTypes\").empty();\n\tvar type = $(\"#TemplateElementAttributeType option:selected\").text();\n\tvar complex = $('#TemplateElementAttributeComplex:checked').val();\n\tif (complex && type != 'Select Type') {\n\t\tcurrentTypes.forEach(function(entry) {\n\t\t\t$(\"#innerTypes\").append(\"<div class=\\\"templateTypeBox\\\" id=\\\"\" + entry + \"TypeBox\\\">\" + entry + \"</div>\");\n\t\t});\n\t\t$('#outerTypes').show();\n\t}\n\telse $('#outerTypes').hide();\n}\n\nfunction populateTemplateTypeDropdown() {\n\tvar cat = $(\"#TemplateElementAttributeCategory option:selected\").text();\n\tcurrentTypes = [];\n\tif (cat == 'Select Category') {\n\t\t$('#TemplateElementAttributeType').html(\"<option>Select Type</option>\");\n\t} else {\n\t\tvar complex = $('#TemplateElementAttributeComplex:checked').val();\n\t\tif (cat in typeGroupCategoryMapping) {\n\t\t\t$('#TemplateElementAttributeType').html(\"<option>Select Type</option>\");\n\t\t\ttypeGroupCategoryMapping[cat].forEach(function(entry) {\n\t\t\t\t$('#TemplateElementAttributeType').append(\"<option>\" + entry + \"</option>\");\n\t\t\t});\n\t\t} else {\n\t\t\tcomplex = false;\n\t\t}\n\t\tif (!complex) {\n\t\t\t$('#TemplateElementAttributeType').html(\"<option>Select Type</option>\");\n\t\t\tcategoryTypes[cat].forEach(function(entry) {\n\t\t\t\t$('#TemplateElementAttributeType').append(\"<option>\" + entry + \"</option>\");\n\t\t\t});\n\t\t}\n\t}\n}\n\nfunction templateElementAttributeTypeChange() {\n\tvar complex = $('#TemplateElementAttributeComplex:checked').val();\n\tvar type = $(\"#TemplateElementAttributeType option:selected\").text();\n\tcurrentTypes = [];\n\tif (type != 'Select Type') {\n\t\tif (complex) {\n\t\t\tcomplexTypes[type][\"types\"].forEach(function(entry) {\n\t\t\t\tcurrentTypes.push(entry);\n\t\t\t});\n\t\t} else {\n\t\t\tcurrentTypes.push(type);\n\t\t}\n\t} else {\n\t\tcurrentTypes = [];\n\t}\n\t$(\"#typeJSON\").html(JSON.stringify(currentTypes));\n\ttemplateUpdateAvailableTypes();\n}\n\nfunction templateElementAttributeCategoryChange(category) {\n\tif (category in typeGroupCategoryMapping) {\n\t\t$('#complexToggle').show();\n\t} else {\n\t\t$('#complexToggle').hide();\n\t}\n\tif (category != 'Select Type') {\n\t\tpopulateTemplateTypeDropdown();\n\t}\n\ttemplateUpdateAvailableTypes();\n}\n\nfunction templateElementFileCategoryChange(category) {\n\tif (category == '') {\n\t\t$(\"#TemplateElementFileMalware\")[0].disabled = true;\n\t\t$(\"#TemplateElementFileMalware\")[0].checked = false;\n\t} else {\n\t\tif (categoryArray[category].length == 2) {\n\t\t\t$(\"#TemplateElementFileMalware\")[0].disabled = false;\n\t\t\t$(\"#TemplateElementFileMalware\")[0].checked = true;\n\t\t} else {\n\t\t\t$(\"#TemplateElementFileMalware\")[0].disabled = true;\n\t\t\tif (categoryArray[category] == 'attachment') $(\"#TemplateElementFileMalware\")[0].checked = false;\n\t\t\telse $(\"#TemplateElementFileMalware\")[0].checked = true;\n\t\t}\n\t}\n}\n\nfunction getPopup(id, context, target) {\n\t$(\"#gray_out\").fadeIn();\n\tvar url = \"\";\n\tif (context != '') url += \"/\" + context;\n\tif (target != '') url += \"/\" + target;\n\tif (id != '') url += \"/\" + id;\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#popover_form\").html(data);\n\t\t\t$(\"#popover_form\").fadeIn();\n\t\t}, \n\t\turl: url,\n\t\t//url:\"/templates/templateChoices/\" + id,\n\t});\n}\n\nfunction resizePopoverBody() {\n\tvar bodyheight = $(window).height();\n\tbodyheight = 3 * bodyheight / 4 - 150;\n\t$(\"#popover_choice_main\").css({\"max-height\": bodyheight});\n}\n\nfunction populateTemplateHiddenFileDiv(files) {\n\t$('#TemplateFileArray').val(JSON.stringify(files));\n}\n\nfunction populateTemplateFileBubbles() {\n\tvar fileObjectArray = JSON.parse($('#TemplateFileArray').val());\n\tfileObjectArray.forEach(function(entry) {\n\t\ttemplateAddFileBubble(entry.element_id, false, entry.filename, entry.tmp_name, 'yes');\n\t});\n}\n\nfunction templateFileHiddenAdd(files, element_id, batch) {\n\tvar fileArray = $.parseJSON($('#TemplateFileArray', window.parent.document).val());\n\tvar contained = false;\n\tfor (var j=0; j< files.length; j++) {\n\t\tfor (var i=0; i< fileArray.length; i++) {\n\t\t\tif (fileArray[i].filename == files[j].filename) {\n\t\t\t\tcontained = true;\n\t\t\t}\n\t\t\tif (batch == 'no' && fileArray[i].element_id == element_id) {\n\t\t\t\ttemplateDeleteFileBubble(fileArray[i].filename, fileArray[i].tmp_name, fileArray[i].element_id, 'iframe', batch);\n\t\t\t\tcontained = false;\n\t\t\t\tvar removeId = i;\n\t\t\t}\n\t\t}\n\t\tif (batch == 'no') fileArray.splice(removeId, 1);\n\t\tif (contained == false) {\n\t\t\tfileArray.push(files[j]);\n\t\t\ttemplateAddFileBubble(element_id, true, files[j].filename, files[j].tmp_name, batch);\n\t\t\t$('#TemplateFileArray', window.parent.document).val(JSON.stringify(fileArray));\n\t\t}\n\t}\n}\n\nfunction templateAddFileBubble(element_id, iframe, filename, tmp_name, batch) {\n\tif (batch == 'no') {\n\t\tif (iframe == true) {\n\t\t\t$('#filenames_' + element_id, window.parent.document).html('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'no\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t} else {\n\t\t\t$('#filenames_' + element_id).html('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'no\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t}\n\t} else {\n\t\tif (iframe == true) {\n\t\t\t$('#filenames_' + element_id, window.parent.document).append('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'yes\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t} else {\n\t\t\t$('#filenames_' + element_id).append('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'yes\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t}\n\t}\n}\n\nfunction templateDeleteFileBubble(filename, tmp_name, element_id, context, batch) {\n\t$(\".loading\").show();\n\t$.ajax({\n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/templates/deleteTemporaryFile/\" + tmp_name,\n\t});\n\tvar c = this;\n\tif (context == 'iframe') {\n\t\t$('#' + tmp_name + '_container', window.parent.document).remove();\n\t\tvar oldArray = JSON.parse($('#TemplateFileArray', window.parent.document).val());\n\t} else {\n\t\t$('#' + tmp_name + '_container').remove();\n\t\tvar oldArray = JSON.parse($('#TemplateFileArray').val());\n\t}\n\tvar newArray = [];\n\toldArray.forEach(function(entry) {\n\t\tif (batch == 'no') {\n\t\t\tif (entry.element_id != element_id) {\n\t\t\t\tnewArray.push(entry);\n\t\t\t}\n\t\t} else {\n\t\t\tif (entry.tmp_name != tmp_name) {\n\t\t\t\tnewArray.push(entry);\n\t\t\t}\n\t\t}\n\t}); \n\tif (batch == 'no') {\n\t\t$('#fileUploadButton_' + element_id, $('#iframe_' + element_id).contents()).html('Upload File');\n\t}\n\tif (context == 'iframe') {\n\t\t$('#TemplateFileArray', window.parent.document).val(JSON.stringify(newArray));\n\t} else {\n\t\t$('#TemplateFileArray').val(JSON.stringify(newArray));\n\t}\n\t$(\".loading\").hide();\n}\n\t\nfunction templateFileUploadTriggerBrowse(id) {\n\t$('#upload_' + id + '_file').click();\n}\n\nfunction freetextRemoveRow(id, event_id) {\n\t$('#row_' + id).hide();\n\t$('#Attribute' + id + 'Save').attr(\"value\", \"0\");\n\tif ($(\".freetext_row:visible\").length == 0) {\n\t\twindow.location = \"/events/\" + event_id;\n\t}\n}\n\nfunction indexEvaluateFiltering() {\n\tif (filterContext == \"event\") {\n\t\tif (filtering.published != 2) {\n\t\t\t$('#value_published').html(publishedOptions[filtering.published]);\n\t\t} else {\n\t\t\t$('#value_published').html(\"\");\n\t\t}\n\t\tif (filtering.date.from != null || filtering.date.from != null) {\n\t\t\tvar text = \"\";\n\t\t\tif (filtering.date.from != \"\") text = \"From: \" + filtering.date.from;\n\t\t\tif (filtering.date.until != \"\") {\n\t\t\t\tif (text != \"\") text += \" \";\n\t\t\t\ttext += \"Until: \" + filtering.date.until;\n\t\t\t}\n\t\t}\n\t\t$('#value_date').html(text);\n\t\tfor (var i = 0; i < simpleFilters.length; i++) {\n\t\t\tindexEvaluateSimpleFiltering(simpleFilters[i]);\n\t\t}\n\t\tindexRuleChange();\n\t} else {\n\t\tfor (var i = 0; i < differentFilters.length; i++) {\n\t\t\tif (filtering[differentFilters[i]] != \"\") {\n\t\t\t\tvar text = \"\";\n\t\t\t\tif (filtering[differentFilters[i]] == 1) text = \"Yes\";\n\t\t\t\telse if (filtering[differentFilters[i]] == 0) text = \"No\";\n\t\t\t\t$('#value_' + differentFilters[i]).html(text);\n\t\t\t} else {\n\t\t\t\t$('#value_' + differentFilters[i]).html(\"\");\n\t\t\t}\n\t\t}\n\t\tfor (var i = 0; i < simpleFilters.length; i++) {\n\t\t\tindexEvaluateSimpleFiltering(simpleFilters[i]);\n\t\t}\n\t}\n\tindexSetTableVisibility();\n\tindexSetRowVisibility();\n\t$('#generatedURLContent').html(indexCreateFilters());\n}\n\nfunction quickFilterEvents(passedArgs) {\n\tpassedArgs[\"searchall\"] = $('#quickFilterField').val();\n\tvar url = \"/events/index\";\n\tfor (var key in passedArgs) {\n\t\turl += \"/\" + key + \":\" + passedArgs[key];\n\t}\n\twindow.location.href=url;\n}\n\n$('#quickFilterField').bind(\"enterKey\",function(e){\n\t$('#quickFilterButton').trigger(\"click\");\n});\n$('#quickFilterField').keyup(function(e){\n\tif(e.keyCode == 13)\n\t{\n    \t$('#quickFilterButton').trigger(\"click\");\n\t}\n});\n\t\nfunction indexApplyFilters() {\n\tvar url = indexCreateFilters();\n\twindow.location.href = url;\n}\n\nfunction indexCreateFilters() {\n\ttext = \"\";\n\tif (filterContext == 'event') {\n\t\tif (filtering.published != \"2\") {\n\t\t\ttext += \"searchpublished:\" + filtering.published;\n\t\t}\n\t} else {\n\t\tfor (var i = 0; i < differentFilters.length; i++) {\n\t\t\tif (filtering[differentFilters[i]]) {\n\t\t\t\tif (text != \"\") text += \"/\";\n\t\t\t\ttext += \"search\" + differentFilters[i] + \":\" + filtering[differentFilters[i]];\n\t\t\t}\n\t\t}\n\t}\n\tfor (var i = 0; i < simpleFilters.length; i++) {\n\t\ttext = indexBuildArray(simpleFilters[i], text);\n\t}\n\tif (filterContext == 'event') {\n\t\tif (filtering.date.from) {\n\t\t\tif (text != \"\") text += \"/\";\n\t\t\ttext += \"searchDatefrom:\" + filtering.date.from; \n\t\t}\n\t\tif (filtering.date.until) {\n\t\t\tif (text != \"\") text += \"/\";\n\t\t\ttext += \"searchDateuntil:\" + filtering.date.until;\n\t\t}\n\t\treturn baseurl + '/events/index/' + text;\n\t} else {\n\t\treturn baseurl + '/admin/users/index/' + text;\n\t}\n}\n\nfunction indexBuildArray(type, text) {\n\ttemp = \"\";\n\tif (text != \"\") temp += \"/\";\n\ttemp += \"search\" + type + \":\";\n\tif (filtering[type].NOT.length == 0 && filtering[type].OR.length == 0) return text;\n\tvar swap = filtering[type].OR.length;\n\tvar temp_array = filtering[type].OR.concat(filtering[type].NOT);\n\tfor (var i = 0; i < temp_array.length; i++) {\n\t\tif (i > 0) temp += \"|\";\n\t\tif (i >= swap) temp +=\"!\";\n\t\ttemp += temp_array[i];\n\t}\n\ttext += temp;\n\treturn text;\n}\n\nfunction indexSetRowVisibility() {\n\tfor (var i = 0; i < allFields.length; i++) {\n\t\tif ($(\"#value_\" + allFields[i]).text().trim() != \"\") {\n\t\t\t$(\"#row_\" + allFields[i]).show();\n\t\t} else {\n\t\t\t$(\"#row_\" + allFields[i]).hide();\n\t\t}\n\t}\n}\n\nfunction indexEvaluateSimpleFiltering(field) {\n\ttext = \"\";\n\tif (filtering[field].OR.length == 0 && filtering[field].NOT.length == 0) {\n\t\t$('#value_' + field).html(text);\n\t\treturn false;\n\t}\n\tif (filtering[field].OR.length !=0) {\n\t\tfor (var i = 0; i < filtering[field].OR.length; i++) {\n\t\t\tif (i > 0) text += '<span class=\"green bold\"> OR </span>';\n\t\t\tif (typedFields.indexOf(field) == -1) {\n\t\t\t\ttext += filtering[field].OR[i];\t\t\n\t\t\t} else {\n\t\t\t\tfor (var j = 0; j < typeArray[field].length; j++) {\n\t\t\t\t\tif (typeArray[field][j].id == filtering[field].OR[i]) {\n\t\t\t\t\t\ttext += typeArray[field][j].value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} \n\t}\n\tif (filtering[field].NOT.length !=0) {\n\t\tfor (var i = 0; i < filtering[field].NOT.length; i++) {\n\t\t\tif (i == 0) {\n\t\t\t\tif (text != \"\") text += '<span class=\"red bold\"> AND NOT </span>';\n\t\t\t\telse text += '<span class=\"red bold\">NOT </span>';\n\t\t\t} else text += '<span class=\"red bold\"> AND NOT </span>';\n\t\t\tif (typedFields.indexOf(field) == -1) {\n\t\t\t\ttext += filtering[field].NOT[i];\t\n\t\t\t} else {\n\t\t\t\tfor (var j = 0; j < typeArray[field].length; j++) {\n\t\t\t\t\tif (typeArray[field][j].id == filtering[field].NOT[i]) {\n\t\t\t\t\t\ttext += typeArray[field][j].value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} \n\t}\n\t$('#value_' + field).html(text);\n}\n\nfunction indexAddRule(param) {\n\tvar found = false;\n\tif (filterContext == 'event') {\n\t\tif (param.data.param1 == \"date\") {\n\t\t\tvar val1 = escape($('#EventSearch' + param.data.param1 + 'from').val());\n\t\t\tvar val2 = escape($('#EventSearch' + param.data.param1 + 'until').val());\n\t\t\tif (val1 != \"\") filtering.date.from = val1;\n\t\t\tif (val2 != \"\") filtering.date.until = val2;\n\t\t} else if (param.data.param1 == \"published\") {\n\t\t\tvar value = escape($('#EventSearchpublished').val());\n\t\t\tif (value != \"\") filtering.published = value;\n\t\t} else {\n\t\t\tvar value = escape($('#EventSearch' + param.data.param1).val());\n\t\t\tvar operator = operators[escape($('#EventSearchbool').val())];\n\t\t\tif (value != \"\" && filtering[param.data.param1][operator].indexOf(value) < 0) filtering[param.data.param1][operator].push(value);\n\t\t}\n\t} else if (filterContext = 'user') {\n\t\tif (differentFilters.indexOf(param.data.param1) != -1) {\n\t\t\tvar value = escape($('#UserSearch' + param.data.param1).val());\n\t\t\tif (value != \"\") filtering[param.data.param1] = value;\n\t\t} else {\n\t\t\tvar value = escape($('#UserSearch' + param.data.param1).val());\n\t\t\tvar operator = operators[escape($('#UserSearchbool').val())];\n\t\t\tif (value != \"\" && filtering[param.data.param1][operator].indexOf(value) < 0) filtering[param.data.param1][operator].push(value);\n\t\t}\n\t}\n\tindexEvaluateFiltering();\n}\n\nfunction indexSetTableVisibility() {\n\tvar visible = false;\n\tif ($(\"[id^='value_']\").text().trim()!=\"\" && $(\"[id^='value_']\").text().trim()!=\"-1\") {\n\t\tvisible = true;\n\t}\n\tif (visible == true) $('#FilterplaceholderTable').hide();\n\telse $('#FilterplaceholderTable').show();\n}\n\nfunction indexRuleChange() {\n\tvar context = filterContext.charAt(0).toUpperCase() + filterContext.slice(1);\n\t$('[id^=' + context + 'Search]').hide();\n\tvar rule = $('#' + context + 'Rule').val();\n\tvar fieldName = '#' + context + 'Search' + rule;\n\tif (fieldName == '#' + context + 'Searchdate') {\n\t\t$(fieldName + 'from').show();\n\t\t$(fieldName + 'until').show();\n\t} else {\n\t\t$(fieldName).show();\n\t}\n\tif (simpleFilters.indexOf(rule) != -1) {\n\t\t$('#' + context + 'Searchbool').show();\n\t} else $('#' + context + 'Searchbool').hide();\n\t\n\t$('#addRuleButton').show();\n\t$('#addRuleButton').unbind(\"click\");\n\t$('#addRuleButton').click({param1: rule}, indexAddRule);\n}\n\nfunction indexFilterClearRow(field) {\n\t$('#value_' + field).html(\"\");\n\t$('#row_' + field).hide();\n\tif (field == \"date\") {\n\t\tfiltering.date.from = \"\";\n\t\tfiltering.date.until = \"\";\n\t} else if (field == \"published\") {\n\t\tfiltering.published = 2;\n\t} else if (differentFilters.indexOf(field) != -1) {\n\t\tfiltering[field] = \"\";\n\t} else {\n\t\tfiltering[field].NOT = [];\n\t\tfiltering[field].OR = [];\n\t}\n\tindexSetTableVisibility();\n\tindexEvaluateFiltering();\n}\n\n\nfunction restrictEventViewPagination() {\n\tvar showPages = new Array();\n\tvar start;\n\tvar end;\n\tvar i;\n\n\tif (page < 6) {\n\t\tstart = 1;\n\t\tif (count - page < 6) {\n\t\t\tend = count;\n\t\t} else {\n\t\t\tend = page + (9 - (page - start));\n\t\t}\n\t} else if (count - page < 6) {\n\t\tend = count;\n\t\tstart = count - 10;\n\t} else {\n\t\tstart = page-5;\n\t\tend = page+5;\n\t}\n\t\n\tif (start > 2) {\n\t\t$(\"#apage\" + start).parent().before(\"<li><a href id='aExpandLeft'>...</a></li>\");\n\t\t$(\"#aExpandLeft\").click(function() {expandPagination(0, 0); return false;});\n\t\t$(\"#bpage\" + start).parent().before(\"<li><a href id='bExpandLeft'>...</a></li>\");\n\t\t$(\"#bExpandLeft\").click(function() {expandPagination(1, 0); return false;})\n\t}\n\n\tif (end < (count - 1)) {\n\t\t$(\"#apage\" + end).parent().after(\"<li><a href id='aExpandRight'>...</a></li>\");\n\t\t$(\"#aExpandRight\").click(function() {expandPagination(0, 1); return false;});\n\t\t$(\"#bpage\" + end).parent().after(\"<li><a href id='bExpandRight'>...</a></li>\");\n\t\t$(\"#bExpandRight\").click(function() {expandPagination(1, 1); return false;})\n\t}\n\t\n\tfor (i = 1; i < (count+1); i++) {\n\t\tif (i != 1 && i != count && (i < start || i > end)) {\n\t\t\t$(\"#apage\" + i).hide();\n\t\t\t$(\"#bpage\" + i).hide();\n\t\t}\t\n\t}\n}\n\nfunction expandPagination(bottom, right) {\n\tvar i;\n\tvar prefix = \"a\";\n\tif (bottom == 1) prefix = \"b\";\n\tvar start = 1;\n\tvar end = page;\n\tif (right == 1) {\n\t\tstart = page;\n\t\tend = count;\n\t\t$(\"#\" + prefix + \"ExpandRight\").remove();\n\t} else $(\"#\" + prefix + \"ExpandLeft\").remove();\n\tfor (i = start; i < end; i++) {\n\t\t$(\"#\" + prefix + \"page\" + i).show();\n\t}\n}\n\nfunction serverSettingsActivateField(setting, id) {\n\tresetForms();\n\t$('.inline-field-placeholder').hide();\n\tvar fieldName = \"#setting_\" + id; \n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(fieldName + \"_placeholder\").html(data);\n\t\t\t$(fieldName + \"_solid\").hide();\n\t\t\t$(fieldName + \"_placeholder\").show();\n\t\t\tserverSettingsPostActivationScripts(fieldName, setting, id);\n\t\t}, \n\t\turl:\"/servers/serverSettingsEdit/\" + setting + \"/\" + id,\n\t});\n}\n\nfunction serverSettingsPostActivationScripts(name, setting, id) {\n\t$(name + '_field').focus();\n\tinputFieldButtonActive(name + '_field');\n\n\t$(name + '_form').submit(function(e){ \n\t\te.preventDefault();\n\t\tserverSettingSubmitForm(name, setting, id);\n\t\treturn false;\n\t});\n\t\n\t$(name + '_form').bind(\"focusout\", function() {\n\t\tinputFieldButtonPassive(name + '_field');\n\t});\n\n\t$(name + '_form').bind(\"focusin\", function(){\n\t\tinputFieldButtonActive(name + '_field');\n\t});\n\t\n\t$(name + '_form').bind(\"keydown\", function(e) {\n\t\tif (e.ctrlKey && (e.keyCode == 13 || e.keyCode == 10)) {\n\t\t\tserverSettingSubmitForm(name, setting, id);\n\t\t}\n\t});\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-accept').bind('click', function() {\n\t\tserverSettingSubmitForm(name, setting, id);\n\t});\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-decline').bind('click', function() {\n\t\tresetForms();\n\t\t$('.inline-field-placeholder').hide();\n\t});\n\n\t$(name + '_solid').hide();\n}\n\nfunction serverSettingSubmitForm(name, setting, id) {\n\tvar name = '#setting_' + id;\n\tvar formData = $(name + '_field').closest(\"form\").serialize();\n\t$.ajax({\n\t\tdata: formData,\n\t\tcache: false,\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tsuccess:function (data, textStatus) {\n\t\t\t$.ajax({\n\t\t\t\ttype:\"get\",\n\t\t\t\turl:\"/servers/serverSettingsReloadSetting/\" + setting + \"/\" + id,\n\t\t\t\tsuccess:function (data2, textStatus2) {\n\t\t\t\t\t$('#' + id + '_row').replaceWith(data2);\n\t\t\t\t\t$(\".loading\").hide();\n\t\t\t\t},\n\t\t\t\terror:function() {\n\t\t\t\t\tshowMessage('fail', 'Could not refresh the table.');\n\t\t\t\t}\n\t\t\t});\n\t\t}, \n\t\terror:function() {\n\t\t\tshowMessage('fail', 'Request failed for an unknown reason.');\n\t\t\tresetForms();\n\t\t\t$('.inline-field-placeholder').hide();\n\t\t},\n\t\ttype:\"post\", \n\t\turl:\"/servers/serverSettingsEdit/\" + setting + \"/\" + id + \"/\" + 1\n\t});\n\t$(name + '_field').unbind(\"keyup\");\n\t$(name + '_form').unbind(\"focusout\");\n\treturn false;\n}\n\nfunction changeFreetextImportFrom() {\n\t$('#changeTo').find('option').remove();\n\toptions[$('#changeFrom').val()].forEach(function(element) {\n\t\t$('#changeTo').append('<option value=\"' + element + '\">' + element + '</option>');\n\t});\n}\n\nfunction changeFreetextImportCommentExecute() {\n\t$('.freetextCommentField').val($('#changeComments').val());\n}\n\nfunction changeFreetextImportExecute() {\n\tvar from = $('#changeFrom').val();\n\tvar to = $('#changeTo').val();\n\t$('.typeToggle').each(function() {\n\t\tif ($( this ).val() == from) {\n\t\t\tif (selectContainsOption(\"#\" + $(this).attr('id'), to)) $( this ).val(to);\n\t\t}\n\t});\n}\n\nfunction selectContainsOption(selectid, value) {\n\tvar exists = false;\n\t$(selectid + ' option').each(function(){\n\t    if (this.value == value) {\n\t        exists = true;\n\t        return false;\n\t    }\n\t});\n\treturn exists;\n}\n\nfunction exportChoiceSelect(url, elementId, checkbox) {\n\tif (checkbox == 1) {\n\t\tif ($('#' + elementId + '_toggle').prop('checked')) {\n\t\t\turl = url + $('#' + elementId + '_set').html();\n\t\t}\n\t}\n\tdocument.location.href = url;\n}\n\nfunction freetextImportResultsSubmit(id, count) {\n\tvar attributeArray = [];\n\tvar temp;\n\tfor (i = 0; i < count; i++) {\n\t\tif ($('#Attribute' + i + 'Save').val() == 1) {\n\t\t\t\ttemp = {\n\t\t\t\t\tvalue:$('#Attribute' + i + 'Value').val(),\n\t\t\t\t\tcategory:$('#Attribute' + i + 'Category').val(),\n\t\t\t\t\ttype:$('#Attribute' + i + 'Type').val(),\n\t\t\t\t\tto_ids:$('#Attribute' + i + 'To_ids')[0].checked,\n\t\t\t\t\tcomment:$('#Attribute' + i + 'Comment').val(),\n\t\t\t\t}\n\t\t\t\tattributeArray[attributeArray.length] = temp;\t\t\n\t\t}\n\t}\n\t$(\"#AttributeJsonObject\").val(JSON.stringify(attributeArray));\n\tvar formData = $(\"#AttributeFreeTextImportForm\").serialize();\n\t$.ajax({\n\t\ttype: \"post\",\n\t\tcache: false,\n\t\turl: \"/events/saveFreeText/\" + id,\n\t\tdata: formData,\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t},\n\t\tsuccess:function (data, textStatus) {\n\t\t\twindow.location = '/events/view/' + id;\n\t\t}, \n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t},\n\t});\n}\n\nfunction pgpChoiceSelect(uri) {\n\t$(\"#popover_form\").fadeOut();\n\t$(\"#gray_out\").fadeOut();\n\t$.ajax({\n\t\ttype: \"get\",\n\t\turl: \"https://pgp.mit.edu/\" + uri,\n\t\tsuccess: function (data) {\n\t\t\tvar result = data.split(\"<pre>\")[1].split(\"</pre>\")[0];\n\t\t\t$(\"#UserGpgkey\").val(result);\n\t\t\tshowMessage('success', \"Key found!\");\n\t\t},\n\t\terror: function (data, textStatus, errorThrown) {\n\t\t\tshowMessage('fail', textStatus + \": \" + errorThrown);\n\t\t}\n\t});\n}\n\nfunction lookupPGPKey(emailFieldName) {\n\t$.ajax({\n\t\ttype: \"get\",\n\t\turl: \"/users/fetchPGPKey/\" + $('#' + emailFieldName).val(),\n\t\tsuccess: function (data) {\n\t\t\t$(\"#popover_form\").fadeIn();\n\t\t\t$(\"#gray_out\").fadeIn();\n\t\t\t$(\"#popover_form\").html(data);\n\t\t},\n\t\terror: function (data, textStatus, errorThrown) {\n\t\t\tshowMessage('fail', textStatus + \": \" + errorThrown);\n\t\t}\n\t});\n}\n\nfunction zeroMQServerAction(action) {\n\t$.ajax({\n\t\ttype: \"get\",\n\t\turl: \"/servers/\" + action + \"ZeroMQServer/\",\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tsuccess: function (data) {\n\t\t\t$(\".loading\").hide();\n\t\t\tif (action !== 'status') {\n\t\t\t\twindow.location.reload();\n\t\t\t} else {\n\t\t\t\t$(\"#confirmation_box\").html(data);\n\t\t\t\t$(\"#confirmation_box\").fadeIn();\n\t\t\t\t$(\"#gray_out\").fadeIn();\n\t\t\t}\n\t\t},\n\t\terror: function (data, textStatus, errorThrown) {\n\t\t\tshowMessage('fail', textStatus + \": \" + errorThrown);\n\t\t}\n\t});\n}\n"], "fixing_code": ["<div class=\"templates form\">\n<?php \n\techo $this->Form->create('Template');\n?>\n\t<fieldset>\n\t\t<legend><?php echo __('Create Template'); ?></legend>\n\t<?php\n\t\techo ($this->Form->input('name', array('div' => 'clear')));\n\t\techo ($this->Form->input('tags', array('id' => 'hiddenTags','div' => 'clear', 'label' => false, 'type' => 'text', 'value' => '[]', 'style' => 'display:none;')));\n\t\t?>\n\t\t\t<div id =\"tagList\">\n\t\t\t\t<label>Tags</label>\n\t\t\t\t<table>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><table><tr id = \"tags\"></tr></table></td>\n\t\t\t\t\t\t<td id = \"addTagButtonTD\">\n\t\t\t\t\t\t\t<span onClick=\"activateTagField()\" id=\"addTagButton\" class=\"btn btn-inverse noPrint\" style=\"line-height:10px; padding: 4px 4px;\">+</span>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td id = \"addTagFieldTD\">\n\t\t\t\t\t\t\t<?php\n\t\t\t\t\t\t\t\techo $this->Form->input('tagsPusher', array(\n\t\t\t\t\t\t\t\t\t'div' => 'clear',\n\t\t\t\t\t\t\t\t\t'id' => 'addTagField',\n\t\t\t\t\t\t\t\t\t'options' => array($tags),\n\t\t\t\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t\t\t\t'onChange' => 'tagFieldChange()',\n\t\t\t\t\t\t\t\t\t'style' => \"height:22px;padding:0px;margin-bottom:0px;display:none;\",\n\t\t\t\t\t\t\t\t\t'empty' => 'Add a tag',\n\t\t\t\t\t\t\t\t));\n\t\t\t\t\t\t\t?>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t</div><br />\t\t\n\t<?php \n\t\techo $this->Form->input('description', array(\n\t\t\t'label' => 'Event Description',\n\t\t\t'div' => 'clear',\n\t\t\t'type' => 'textarea',\n\t\t\t'class' => 'form-control span6',\n\t\t\t'placeholder' => 'A description of the template'\n\t\t));\n\t\techo $this->Form->input('share', array(\n\t\t\t'label' => 'Share this template with others',\n\t\t));\n\t?>\n\t</fieldset>\n<?php echo $this->Form->button(__('Create'), array('class' => 'btn btn-primary'));\n\techo $this->Form->end();?>\n</div>\n<?php \n\techo $this->element('side_menu', array('menuList' => 'templates', 'menuItem' => 'add'));\n?>\n<script type=\"text/javascript\">\nvar selectedTags = [];\nvar allTags = [\n\t<?php \n\t\tforeach ($tagInfo as $tag) {\n\t\t\techo \"{'id' : '\" . h($tag['Tags']['id']) . \"', 'name' : '\" . h($tag['Tags']['name']) . \"', 'colour' : '\" . h($tag['Tags']['colour']) . \"'},\";\n\t\t}\n\t?>\n];\n</script>\n<?php echo $this->Js->writeBuffer();", "<div class=\"templates form\">\n<?php \n\techo $this->Form->create('Template');\n?>\n\t<fieldset>\n\t\t<legend><?php echo __('Edit Template'); ?></legend>\n\t<?php\n\t\techo ($this->Form->input('name', array('div' => 'clear')));\n\t\techo ($this->Form->input('tags', array('id' => 'hiddenTags','div' => 'clear', 'label' => false, 'type' => 'text', 'value' => '[]', 'style' => 'display:none;')));\n\t\t?>\n\t\t\t<div id =\"tagList\">\n\t\t\t\t<label>Tags</label>\n\t\t\t\t<table>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td><table><tr id = \"tags\"></tr></table></td>\n\t\t\t\t\t\t<td id = \"addTagButtonTD\">\n\t\t\t\t\t\t\t<span onClick=\"activateTagField()\" id=\"addTagButton\" class=\"btn btn-inverse noPrint\" style=\"line-height:10px; padding: 4px 4px;\">+</span>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td id = \"addTagFieldTD\">\n\t\t\t\t\t\t\t<?php\n\t\t\t\t\t\t\t\techo $this->Form->input('tagsPusher', array(\n\t\t\t\t\t\t\t\t\t'div' => 'clear',\n\t\t\t\t\t\t\t\t\t'id' => 'addTagField',\n\t\t\t\t\t\t\t\t\t'options' => array($tags),\n\t\t\t\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t\t\t\t'onChange' => 'tagFieldChange()',\n\t\t\t\t\t\t\t\t\t'style' => \"height:22px;padding:0px;margin-bottom:0px;display:none;\",\n\t\t\t\t\t\t\t\t\t'empty' => 'Add a tag',\n\t\t\t\t\t\t\t\t));\n\t\t\t\t\t\t\t?>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t</div><br />\t\t\n\t<?php \n\t\techo $this->Form->input('description', array(\n\t\t\t'label' => 'Event Description',\n\t\t\t'div' => 'clear',\n\t\t\t'type' => 'textarea',\n\t\t\t'class' => 'form-control span6',\n\t\t\t'placeholder' => 'A description of the template'\n\t\t));\n\t\techo $this->Form->input('share', array(\n\t\t\t'label' => 'Share this template with others',\n\t\t));\n\t?>\n\t</fieldset>\n<?php echo $this->Form->button(__('Edit'), array('class' => 'btn btn-primary'));\n\techo $this->Form->end();?>\n</div>\n<?php \n\techo $this->element('side_menu', array('menuList' => 'templates', 'menuItem' => 'edit', 'id' => $id, 'mayModify' => $mayModify));\n?>\n<script type=\"text/javascript\">\nvar selectedTags = [\n\t<?php \n\t\tforeach ($currentTags as $k => $t) {\n\t\t\tif ($k != 0) echo ', ';\n\t\t\techo '\"' . $t['Tag']['name'] . '\"';\n\t\t}\n\t?>\n];\nvar allTags = [\n\t<?php \n\t\tforeach ($tagInfo as $tag) {\n\t\t\techo \"{'id' : '\" . h($tag['Tags']['id']) . \"', 'name' : '\" . h($tag['Tags']['name']) . \"', 'colour' : '\" . h($tag['Tags']['colour']) . \"'},\";\n\t\t}\n\t?>\n];\n$(document).ready( function () {\n\tfor (var i = 0, len = selectedTags.length; i < len; i++) {\n\t\tappendTemplateTag(selectedTags[i], 'yes');\n\t}\n});\n</script>\n<?php echo $this->Js->writeBuffer();", "String.prototype.ucfirst = function() {\n\treturn this.charAt(0).toUpperCase() + this.slice(1);\n}\n\nfunction deleteObject(type, action, id, event) {\n\tvar destination = 'attributes';\n\tif (type == 'shadow_attributes') destination = 'shadow_attributes';\n\tif (type == 'template_elements') destination = 'template_elements';\n\t$.get( \"/\" + destination + \"/\" + action + \"/\" + id, function(data) {\n\t\t$(\"#confirmation_box\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#confirmation_box\").html(data);\n\t});\n}\n\nfunction publishPopup(id, type) {\n\tvar action = \"alert\";\n\tif (type == \"publish\") action = \"publish\";\n\tvar destination = 'attributes';\n\t$.get( \"/events/\" + action + \"/\" + id, function(data) {\n\t\t$(\"#confirmation_box\").html(data);\n\t\t$(\"#confirmation_box\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t});\n}\n\nfunction submitPublish(id, type) {\n\t$(\"#PromptForm\").submit();\n}\n\nfunction editTemplateElement(type, id) {\n\t$.get( \"/template_elements/edit/\" + type + \"/\" + id, function(data) {\n\t\t$(\"#popover_form\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#popover_form\").html(data);\n\n\t});\n}\n\nfunction cancelPrompt() {\n\t$(\"#confirmation_box\").fadeIn();\n\t$(\"#gray_out\").fadeOut();\n\t$(\"#confirmation_box\").empty();\n}\n\nfunction submitDeletion(context_id, action, type, id) {\n\tvar context = 'event';\n\tif (type == 'template_elements') context = 'template';\n\tvar formData = $('#PromptForm').serialize();\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdata: formData, \n\t\tsuccess:function (data, textStatus) {\n\t\t\tupdateIndex(context_id, context);\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#confirmation_box\").fadeOut();\n\t\t\t$(\"#gray_out\").fadeOut();\n\t\t},\n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/\" + type + \"/\" + action + \"/\" + id,\n\t});\n}\n\nfunction initiatePasswordReset(id) {\n\t$.get( \"/users/initiatePasswordReset/\" + id, function(data) {\n\t\t$(\"#confirmation_box\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#confirmation_box\").html(data);\n\t});\n}\n\nfunction submitPasswordReset(id) {\n\tvar formData = $('#PromptForm').serialize();\n\tvar url = \"/users/initiatePasswordReset/\" + id;\n\tif ($('#firstTime').is(\":checked\")) url += \"/true\";\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdata: formData, \n\t\tsuccess:function (data, textStatus) {\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#confirmation_box\").fadeOut();\n\t\t\t$(\"#gray_out\").fadeOut();\n\t\t},\n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:url,\n\t});\n}\n\nfunction acceptObject(type, id, event) {\n\tname = '#ShadowAttribute_' + id + '_accept';\n\tvar formData = $(name).serialize();\n\t$.ajax({\n\t\tdata: formData, \n\t\tsuccess:function (data, textStatus) {\n\t\t\tupdateIndex(event, 'event');\n\t\t\teventUnpublish();\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/shadow_attributes/accept/\" + id,\n\t});\n}\t\n\nfunction eventUnpublish() {\n\t$('.publishButtons').show();\n\t$('.exportButtons').hide();\n\t$('.published').hide();\n\t$('.notPublished').show();\n}\n\nfunction updateIndex(id, context, newPage) {\n\tif (typeof newPage !== 'undefined') page = newPage;\n\tvar url, div;\n\tif (context == 'event') {\n\t\turl = \"/events/view/\" + id + \"/attributesPage:\" + page;\n\t\tdiv = \"#attributes_div\";\n\t}\n\tif (context == 'template') {\n\t\turl = \"/template_elements/index/\" + id;\n\t\tdiv = \"#templateElements\";\n\t}\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(div).html(data);\n\t\t}, \n\t\turl: url,\n\t});\n}\n\nfunction updateAttributeFieldOnSuccess(name, type, id, field, event) {\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\tif (field != 'timestamp') {\n\t\t\t\t$(\".loading\").show();\n\t\t\t}\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\tif (field != 'timestamp') {\n\t\t\t\t$(\".loading\").hide();\n\t\t\t\t$(name + '_solid').html(data);\n\t\t\t\t$(name + '_placeholder').empty();\n\t\t\t\t$(name + '_solid').show();\n\t\t\t} else {\n\t\t\t\t$('#' + type + '_' + id + '_' + 'timestamp_solid').html(data);\n\t\t\t}\n\t\t}, \n\t\turl:\"/attributes/fetchViewValue/\" + id + \"/\" + field,\n\t});\n}\n\nfunction activateField(type, id, field, event) {\n\tresetForms();\n\tif (type == 'denyForm') return;\n\tvar objectType = 'attributes';\n\tif (type == 'ShadowAttribute') {\n\t\tobjectType = 'shadow_attributes';\n\t}\n\tvar name = '#' + type + '_' + id + '_' + field;\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(name + '_placeholder').html(data);\n\t\t\tpostActivationScripts(name, type, id, field, event);\n\t\t}, \n\t\turl:\"/\" + objectType + \"/fetchEditForm/\" + id + \"/\" + field,\n\t});\n}\n\n//if someone clicks an inactive field, replace it with the hidden form field. Also, focus it and bind a focusout event, so that it gets saved if the user clicks away.\n//If a user presses enter, submit the form\nfunction postActivationScripts(name, type, id, field, event) {\n\t$(name + '_field').focus();\n\tinputFieldButtonActive(name + '_field');\n\tif (field == 'value' || field == 'comment') {\n\t\tautoresize($(name + '_field')[0]);\n\t\t$(name + '_field').on('keyup', function () {\n\t\t    autoresize(this);\n\t\t});\n\t}\n\t$(name + '_form').submit(function(e){ \n\t\te.preventDefault();\n\t\tsubmitForm(type, id, field, event);\n\t\treturn false;\n\t});\n\t\n\t$(name + '_form').bind(\"focusout\", function() {\n\t\tinputFieldButtonPassive(name + '_field');\n\t});\n\n\t$(name + '_form').bind(\"focusin\", function(){\n\t\tinputFieldButtonActive(name + '_field');\n\t});\n\t\n\t$(name + '_form').bind(\"keydown\", function(e) {\n\t\tif (e.ctrlKey && (e.keyCode == 13 || e.keyCode == 10)) {\n\t\t\tsubmitForm(type, id, field, event);\n\t\t}\n\t});\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-accept').bind('click', function() {\n\t\tsubmitForm(type, id, field, event);\n\t});\n\t\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-decline').bind('click', function() {\n\t\tresetForms();\n\t});\n\n\t$(name + '_solid').hide();\n}\n\nfunction resetForms() {\n\t$('.inline-field-solid').show();\n\t$('.inline-field-placeholder').empty();\n}\n\nfunction inputFieldButtonActive(selector) {\n\t$(selector).closest('.inline-input-container').children('.inline-input-accept').removeClass('inline-input-passive').addClass('inline-input-active');\n\t$(selector).closest('.inline-input-container').children('.inline-input-decline').removeClass('inline-input-passive').addClass('inline-input-active');\n}\n\nfunction inputFieldButtonPassive(selector) {\n\t$(selector).closest('.inline-input-container').children('.inline-input-accept').addClass('inline-input-passive').removeClass('inline-input-active');\n\t$(selector).closest('.inline-input-container').children('.inline-input-daecline').addClass('inline-input-passive').removeClass('inline-input-active');\n}\n\nfunction autoresize(textarea) {\n    textarea.style.height = '20px';\n    textarea.style.height = (textarea.scrollHeight) + 'px';\n}\n\n// submit the form - this can be triggered by unfocusing the activated form field or by submitting the form (hitting enter)\n// after the form is submitted, intercept the response and act on it \nfunction submitForm(type, id, field, context) {\n\tvar object_type = 'attributes';\n\tvar action = \"editField\";\n\tvar name = '#' + type + '_' + id + '_' + field;\n\tif (type == 'ShadowAttribute') {\n\t\tobject_type = 'shadow_attributes';\n\t}\n\t$.ajax({\n\t\tdata: $(name + '_field').closest(\"form\").serialize(),\n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\thandleAjaxEditResponse(data, name, type, id, field, context);\n\t\t}, \n\t\terror:function() {\n\t\t\tshowMessage('fail', 'Request failed for an unknown reason.');\n\t\t\tupdateIndex(context, 'event');\n\t\t},\n\t\ttype:\"post\", \n\t\turl:\"/\" + object_type + \"/\" + action + \"/\" + id\n\t});\n\t$(name + '_field').unbind(\"keyup\");\n\t$(name + '_form').unbind(\"focusout\");\n\treturn false;\n};\n\nfunction submitTagForm(id) {\n\t$.ajax({\n\t\tdata: $('#EventTag').closest(\"form\").serialize(), \n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tsuccess:function (data, textStatus) {\n\t\t\tloadEventTags(id);\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\terror:function() {\n\t\t\tshowMessage('fail', 'Could not add tag.');\n\t\t\tloadEventTags(id);\n\t\t},\n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t},\n\t\ttype:\"post\", \n\t\turl:\"/events/addTag/\" + id\n\t});\n\treturn false;\n}\n\nfunction handleAjaxEditResponse(data, name, type, id, field, event) {\n\tresponseArray = JSON.parse(data);\n\tif (type == 'Attribute') {\n\t\tif (responseArray.saved) {\n\t\t\tshowMessage('success', responseArray.success);\n\t\t\tupdateAttributeFieldOnSuccess(name, type, id, field, event);\n\t\t\tupdateAttributeFieldOnSuccess(name, type, id, 'timestamp', event);\n\t\t\teventUnpublish();\n\t\t} else {\n\t\t\tshowMessage('fail', 'Validation failed: ' + responseArray.errors.value);\n\t\t\tupdateAttributeFieldOnSuccess(name, type, id, field, event);\n\t\t}\n\t}\n\tif (type == 'ShadowAttribute') {\n\t\tupdateIndex(event, 'event');\n\t}\n}\n\nfunction handleGenericAjaxResponse(data) {\n\tif (typeof data == 'string') {\n\t\tresponseArray = JSON.parse(data);\n\t} else {\n\t\tresponseArray = data;\n\t}\n\tif (responseArray.saved) {\n\t\tshowMessage('success', responseArray.success);\n\t\treturn true;\n\t} else {\n\t\tshowMessage('fail', responseArray.errors);\n\t\treturn false;\n\t}\n}\n\nfunction toggleAllAttributeCheckboxes() {\n\tif ($(\".select_all\").is(\":checked\")) {\n\t\t$(\".select_attribute\").prop(\"checked\", true);\n\t\t$(\".select_proposal\").prop(\"checked\", true);\n\t} else {\n\t\t$(\".select_attribute\").prop(\"checked\", false);\n\t\t$(\".select_proposal\").prop(\"checked\", false);\n\t}\n}\n\nfunction attributeListAnyAttributeCheckBoxesChecked() {\n\tif ($('.select_attribute:checked').length > 0) $('.mass-select').show();\n\telse $('.mass-select').hide();\n}\n\nfunction attributeListAnyProposalCheckBoxesChecked() {\n\tif ($('.select_proposal:checked').length > 0) $('.mass-proposal-select').show();\n\telse $('.mass-proposal-select').hide();\n}\n\nfunction multiSelectAction(event, context) {\n\tvar settings = {\n\t\t\tdeleteAttributes: {\n\t\t\t\tconfirmation: \"Are you sure you want to delete all selected attributes?\",\n\t\t\t\tcontroller: \"attributes\",\n\t\t\t\tcamelCase: \"Attribute\",\n\t\t\t\talias: \"attribute\",\n\t\t\t\taction: \"delete\",\n\t\t\t},\n\t\t\tacceptProposals: {\n\t\t\t\tconfirmation: \"Are you sure you want to accept all selected proposals?\",\n\t\t\t\tcontroller: \"shadow_attributes\",\n\t\t\t\tcamelCase: \"ShadowAttribute\",\n\t\t\t\talias: \"proposal\",\n\t\t\t\taction: \"accept\",\n\t\t\t},\n\t\t\tdiscardProposals: {\n\t\t\t\tconfirmation: \"Are you sure you want to discard all selected proposals?\",\n\t\t\t\tcontroller: \"shadow_attributes\",\n\t\t\t\tcamelCase: \"ShadowAttribute\",\n\t\t\t\talias: \"proposal\",\n\t\t\t\taction: \"discard\",\n\t\t\t},\n\t};\n\tvar answer = confirm(\"Are you sure you want to \" + settings[context][\"action\"] + \" all selected \" + settings[context][\"alias\"] + \"s?\");\n\tif (answer) {\n\t\tvar selected = [];\n\t\t$(\".select_\" + settings[context][\"alias\"]).each(function() {\n\t\t\tif ($(this).is(\":checked\")) {\n\t\t\t\tvar temp= $(this).data(\"id\");\n\t\t\t\tselected.push(temp);\n\t\t\t}\n\t\t});\n\t\t$('#' + settings[context][\"camelCase\"] + 'Ids' + settings[context][\"action\"].ucfirst()).attr('value', JSON.stringify(selected));\n\t\tvar formData = $('#' + settings[context][\"action\"] + '_selected').serialize();\n\t\t$.ajax({\n\t\t\tdata: formData, \n\t\t\tcache: false,\n\t\t\ttype:\"POST\", \n\t\t\turl:\"/\" + settings[context][\"controller\"] + \"/\" + settings[context][\"action\"] + \"Selected/\" + event,\n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\tupdateIndex(event, 'event');\n\t\t\t\tvar result = handleGenericAjaxResponse(data);\n\t\t\t\tif (settings[context][\"action\"] != \"discard\" && result == true) eventUnpublish(); \n\t\t\t}, \n\t\t});\n\t}\n\treturn false;\n}\n\nfunction editSelectedAttributes(event) {\n\t$.get(\"/attributes/editSelected/\"+event, function(data) {\n\t\t$(\"#popover_form\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#popover_form\").html(data);\n\t});\n}\n\nfunction getSelected() {\n\tvar selected = [];\n\t$(\".select_attribute\").each(function() {\n\t\tif ($(this).is(\":checked\")) {\n\t\t\tvar test = $(this).data(\"id\");\n\t\t\tselected.push(test);\n\t\t}\n\t});\n\treturn JSON.stringify(selected);\n}\n\nfunction loadEventTags(id) {\n\t$.ajax({\n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".eventTagContainer\").html(data);\n\t\t}, \n\t\turl:\"/tags/showEventTag/\" + id,\n\t});\n}\n\nfunction removeEventTag(event, tag) {\n\tvar answer = confirm(\"Are you sure you want to remove this tag from the event?\");\n\tif (answer) {\n\t\tvar formData = $('#removeTag_' + tag).serialize();\n\t\t$.ajax({\n\t\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t\t$(\".loading\").show();\n\t\t\t}, \n\t\t\tdata: formData, \n\t\t\ttype:\"POST\", \n\t\t\tcache: false,\n\t\t\turl:\"/events/removeTag/\" + event + '/' + tag,\n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\tloadEventTags(event);\n\t\t\t\thandleGenericAjaxResponse(data);\n\t\t\t}, \n\t\t\tcomplete:function() {\n\t\t\t\t$(\".loading\").hide();\n\t\t\t}\n\t\t});\n\t}\n\treturn false;\n}\n\nfunction clickCreateButton(event, type) {\n\tvar destination = 'attributes';\n\tif (type == 'Proposal') destination = 'shadow_attributes';\n\t$.get( \"/\" + destination + \"/add/\" + event, function(data) {\n\t\t$(\"#popover_form\").fadeIn();\n\t\t$(\"#gray_out\").fadeIn();\n\t\t$(\"#popover_form\").html(data);\n\t});\n}\n\nfunction submitPopoverForm(context_id, referer, update_context_id) {\n\tvar url = null;\n\tvar context = 'event';\n\tvar contextNamingConvention = 'Attribute';\n\tswitch (referer) {\n\t\tcase 'add': \n\t\t\turl = \"/attributes/add/\" + context_id;\n\t\t\tbreak;\n\t\tcase 'propose':\n\t\t\turl = \"/shadow_attributes/add/\" + context_id;\n\t\t\tbreak;\n\t\tcase 'massEdit':\n\t\t\turl = \"/attributes/editSelected/\" + context_id;\n\t\t\tbreak;\n\t\tcase 'addTextElement':\n\t\t\turl = \"/templateElements/add/text/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontextNamingConvention = 'TemplateElementText';\n\t\t\tbreak;\n\t\tcase 'editTextElement':\n\t\t\turl = \"/templateElements/edit/text/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontext_id = update_context_id;\n\t\t\tcontextNamingConvention = 'TemplateElementText';\n\t\t\tbreak;\n\t\tcase 'addAttributeElement':\n\t\t\turl = \"/templateElements/add/attribute/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontextNamingConvention = 'TemplateElementAttribute';\n\t\t\tbreak;\n\t\tcase 'editAttributeElement':\n\t\t\turl = \"/templateElements/edit/attribute/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontext_id = update_context_id;\n\t\t\tcontextNamingConvention = 'TemplateElementAttribute';\n\t\t\tbreak;\n\t\tcase 'addFileElement':\n\t\t\turl = \"/templateElements/add/file/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontextNamingConvention = 'TemplateElementFile';\n\t\t\tbreak;\n\t\tcase 'editFileElement':\n\t\t\turl = \"/templateElements/edit/file/\" + context_id;\n\t\t\tcontext = 'template';\n\t\t\tcontext_id = update_context_id;\n\t\t\tcontextNamingConvention = 'TemplateElementFile';\n\t\t\tbreak;\n\t\tcase 'replaceAttributes':\n\t\t\turl = \"/attributes/attributeReplace/\" + context_id;\n\t\t\tbreak;\n\t}\n\t\n\tif (url !== null) {\n\t\t$.ajax({\n\t\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t\t$(\".loading\").show();\n\t\t\t\t$(\"#gray_out\").fadeOut();\n\t\t\t\t$(\"#popover_form\").fadeOut();\n\t\t\t}, \n\t\t\tdata: $(\"#submitButton\").closest(\"form\").serialize(), \n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\tvar result = handleAjaxPopoverResponse(data, context_id, url, referer, context, contextNamingConvention);\n\t\t\t\tif (context == 'event' && (referer == 'add' || referer == 'massEdit' || referer == 'replaceAttributes')) eventUnpublish();\n\t\t\t\t$(\".loading\").show();\n\t\t\t}, \n\t\t\ttype:\"post\", \n\t\t\turl:url\n\t\t});\n\t\t$(\"#popover_form\").empty();\n\t}\n};\n\nfunction handleAjaxPopoverResponse(response, context_id, url, referer, context, contextNamingConvention) {\n\tresponseArray = JSON.parse(response);\n\tvar message = null;\n\tif (responseArray.saved) {\n\t\tupdateIndex(context_id, context);\n\t\tif (responseArray.success) {\n\t\t\tshowMessage(\"success\", responseArray.success);\n\t\t}\n\t\tif (responseArray.errors) {\n\t\t\tshowMessage(\"fail\", responseArray.errors);\n\t\t}\n\t} else {\n\t\tvar savedArray = saveValuesForPersistance();\n\t\t$.ajax({\n\t\t\tasync:true, \n\t\t\tdataType:\"html\", \n\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\t$(\"#gray_out\").fadeIn();\n\t\t\t\t$(\"#popover_form\").fadeIn();\n\t\t\t\t$(\"#popover_form\").html(data);\n\t\t\t\tvar error_context = context.charAt(0).toUpperCase() + context.slice(1);\n\t\t\t\thandleValidationErrors(responseArray.errors, context, contextNamingConvention);\n\t\t\t\tif (!isEmpty(responseArray)) {\n\t\t\t\t\t$(\"#formWarning\").show();\n\t\t\t\t\t$(\"#formWarning\").html('The object(s) could not be saved. Please, try again.');\n\t\t\t\t}\n\t\t\t\trecoverValuesFromPersistance(savedArray);\n\t\t\t\t$(\".loading\").hide();\n\t\t\t},\n\t\t\turl:url\n\t\t});\t\n\t}\n}\n\nfunction isEmpty(obj) {\n\tvar name;\n\tfor (name in obj) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n\n//before we update the form (in case the action failed), we want to retrieve the data from every field, so that we can set the fields in the new form that we fetch \nfunction saveValuesForPersistance() {\n\tvar formPersistanceArray = new Array();\n\tfor (i = 0; i < fieldsArray.length; i++) {\n\t\tformPersistanceArray[fieldsArray[i]] = document.getElementById(fieldsArray[i]).value;\n\t}\n\treturn formPersistanceArray;\n}\n\nfunction recoverValuesFromPersistance(formPersistanceArray) {\n\tfor (i = 0; i < fieldsArray.length; i++) {\n\t\t document.getElementById(fieldsArray[i]).value = formPersistanceArray[fieldsArray[i]];\n\t}\n}\n\nfunction handleValidationErrors(responseArray, context, contextNamingConvention) {\n\tfor (var k in responseArray) {\n\t\tvar elementName = k.charAt(0).toUpperCase() + k.slice(1);\n\t\t$(\"#\" + contextNamingConvention + elementName).parent().addClass(\"error\");\n\t\t$(\"#\" + contextNamingConvention + elementName).parent().append(\"<div class=\\\"error-message\\\">\" + responseArray[k] + \"</div>\");\n\t}\n}\n\nfunction toggleHistogramType(type, old) {\n\tvar done = false;\n\told.forEach(function(entry) {\n\t\tif (type == entry) {\n\t\t\tdone = true;\n\t\t\told.splice(old.indexOf(entry), 1);\n\t\t}\n\t});\n\tif (done == false) old.push(type);\n\tupdateHistogram(JSON.stringify(old));\n}\n\nfunction updateHistogram(selected) {\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#histogram\").html(data);\n\t\t}, \n\t\turl:\"/users/histogram/\" + selected,\n\t});\n}\n\nfunction showMessage(success, message, context) {\n\tif (typeof context !== \"undefined\") {\n\t\t$(\"#ajax_\" + success, window.parent.document).html(message);\n\t\tvar duration = 1000 + (message.length * 40);\n\t\t$(\"#ajax_\" + success + \"_container\", window.parent.document).fadeIn(\"slow\");\n\t\t$(\"#ajax_\" + success + \"_container\", window.parent.document).delay(duration).fadeOut(\"slow\");\n\t}\n\t$(\"#ajax_\" + success).html(message);\n\tvar duration = 1000 + (message.length * 40);\n\t$(\"#ajax_\" + success + \"_container\").fadeIn(\"slow\");\n\t$(\"#ajax_\" + success + \"_container\").delay(duration).fadeOut(\"slow\");\n}\n\nfunction cancelPopoverForm() {\n\t$(\"#popover_form\").empty();\n\t$('#gray_out').fadeOut();\n\t$('#popover_form').fadeOut();\n}\n\nfunction activateTagField() {\n\t$(\"#addTagButton\").hide();\n\t$(\"#addTagField\").show();\n}\n\nfunction tagFieldChange() {\n\tif ($(\"#addTagField :selected\").val() > 0) {\n\t\tvar selected = $(\"#addTagField :selected\").text();\n\t\tif ($.inArray(selected, selectedTags)==-1) {\n\t\t\tselectedTags.push(selected);\n\t\t\tappendTemplateTag(selected);\n\t\t}\n\t}\n\t$(\"#addTagButton\").show();\n\t$(\"#addTagField\").hide();\n}\n\nfunction appendTemplateTag(selected) {\n\tvar selectedTag;\n\tallTags.forEach(function(tag) {\n\t\tif (tag.name == selected) {\n\t\t\t$.ajax({\n\t\t\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t\t\t$(\".loading\").show();\n\t\t\t\t}, \n\t\t\t\tdataType:\"html\", \n\t\t\t\tcache: false,\n\t\t\t\tsuccess:function (data, textStatus) {\n\t\t\t\t\t$(\".loading\").hide();\n\t\t\t\t\t$(\"#tags\").append(data);\n\t\t\t\t}, \n\t\t\t\turl:\"/tags/viewTag/\" + tag.id,\n\t\t\t});\n\t\t\tupdateSelectedTags();\n\t\t}\n\t});\n}\n\nfunction addAllTags(tagArray) {\n\tparsedTagArray = JSON.parse(tagArray);\n\tparsedTagArray.forEach(function(tag) {\n\t\tappendTemplateTag(tag);\n\t});\n}\n\nfunction removeTemplateTag(id, name) {\n\tselectedTags.forEach(function(tag) {\n\t\tif (tag == name) {\n\t\t\tvar index = selectedTags.indexOf(name);\n\t\t\tif (index > -1) {\n\t\t\t\tselectedTags.splice(index, 1);\n\t\t\t\tupdateSelectedTags();\n\t\t\t}\n\t\t}\n\t});\n\t$('#tag_bubble_' + id).remove();\n}\n\nfunction updateSelectedTags() {\n\t$('#hiddenTags').attr(\"value\", JSON.stringify(selectedTags));\n}\n\nfunction saveElementSorting(order) {\n\t$.ajax({\n\t\tdata: order, \n\t\tdataType:\"json\",\n\t\tcontentType: \"application/json\",\n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\thandleGenericAjaxResponse(data);\n\t\t}, \n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/templates/saveElementSorting/\",\n\t});\n}\n\nfunction templateAddElementClicked(id) {\n\t$(\"#gray_out\").fadeIn();\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#popover_form\").html(data);\n\t\t\t$(\"#popover_form\").fadeIn();\n\t\t}, \n\t\turl:\"/template_elements/templateElementAddChoices/\" + id,\n\t});\n}\n\nfunction templateAddElement(type, id) {\n\t$.ajax({\n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\"#popover_form\").html(data);\n\t\t}, \n\t\turl:\"/template_elements/add/\" + type + \"/\" + id,\n\t});\n}\n\nfunction templateUpdateAvailableTypes() {\n\t$(\"#innerTypes\").empty();\n\tvar type = $(\"#TemplateElementAttributeType option:selected\").text();\n\tvar complex = $('#TemplateElementAttributeComplex:checked').val();\n\tif (complex && type != 'Select Type') {\n\t\tcurrentTypes.forEach(function(entry) {\n\t\t\t$(\"#innerTypes\").append(\"<div class=\\\"templateTypeBox\\\" id=\\\"\" + entry + \"TypeBox\\\">\" + entry + \"</div>\");\n\t\t});\n\t\t$('#outerTypes').show();\n\t}\n\telse $('#outerTypes').hide();\n}\n\nfunction populateTemplateTypeDropdown() {\n\tvar cat = $(\"#TemplateElementAttributeCategory option:selected\").text();\n\tcurrentTypes = [];\n\tif (cat == 'Select Category') {\n\t\t$('#TemplateElementAttributeType').html(\"<option>Select Type</option>\");\n\t} else {\n\t\tvar complex = $('#TemplateElementAttributeComplex:checked').val();\n\t\tif (cat in typeGroupCategoryMapping) {\n\t\t\t$('#TemplateElementAttributeType').html(\"<option>Select Type</option>\");\n\t\t\ttypeGroupCategoryMapping[cat].forEach(function(entry) {\n\t\t\t\t$('#TemplateElementAttributeType').append(\"<option>\" + entry + \"</option>\");\n\t\t\t});\n\t\t} else {\n\t\t\tcomplex = false;\n\t\t}\n\t\tif (!complex) {\n\t\t\t$('#TemplateElementAttributeType').html(\"<option>Select Type</option>\");\n\t\t\tcategoryTypes[cat].forEach(function(entry) {\n\t\t\t\t$('#TemplateElementAttributeType').append(\"<option>\" + entry + \"</option>\");\n\t\t\t});\n\t\t}\n\t}\n}\n\nfunction templateElementAttributeTypeChange() {\n\tvar complex = $('#TemplateElementAttributeComplex:checked').val();\n\tvar type = $(\"#TemplateElementAttributeType option:selected\").text();\n\tcurrentTypes = [];\n\tif (type != 'Select Type') {\n\t\tif (complex) {\n\t\t\tcomplexTypes[type][\"types\"].forEach(function(entry) {\n\t\t\t\tcurrentTypes.push(entry);\n\t\t\t});\n\t\t} else {\n\t\t\tcurrentTypes.push(type);\n\t\t}\n\t} else {\n\t\tcurrentTypes = [];\n\t}\n\t$(\"#typeJSON\").html(JSON.stringify(currentTypes));\n\ttemplateUpdateAvailableTypes();\n}\n\nfunction templateElementAttributeCategoryChange(category) {\n\tif (category in typeGroupCategoryMapping) {\n\t\t$('#complexToggle').show();\n\t} else {\n\t\t$('#complexToggle').hide();\n\t}\n\tif (category != 'Select Type') {\n\t\tpopulateTemplateTypeDropdown();\n\t}\n\ttemplateUpdateAvailableTypes();\n}\n\nfunction templateElementFileCategoryChange(category) {\n\tif (category == '') {\n\t\t$(\"#TemplateElementFileMalware\")[0].disabled = true;\n\t\t$(\"#TemplateElementFileMalware\")[0].checked = false;\n\t} else {\n\t\tif (categoryArray[category].length == 2) {\n\t\t\t$(\"#TemplateElementFileMalware\")[0].disabled = false;\n\t\t\t$(\"#TemplateElementFileMalware\")[0].checked = true;\n\t\t} else {\n\t\t\t$(\"#TemplateElementFileMalware\")[0].disabled = true;\n\t\t\tif (categoryArray[category] == 'attachment') $(\"#TemplateElementFileMalware\")[0].checked = false;\n\t\t\telse $(\"#TemplateElementFileMalware\")[0].checked = true;\n\t\t}\n\t}\n}\n\nfunction getPopup(id, context, target) {\n\t$(\"#gray_out\").fadeIn();\n\tvar url = \"\";\n\tif (context != '') url += \"/\" + context;\n\tif (target != '') url += \"/\" + target;\n\tif (id != '') url += \"/\" + id;\n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(\"#popover_form\").html(data);\n\t\t\t$(\"#popover_form\").fadeIn();\n\t\t}, \n\t\turl: url,\n\t\t//url:\"/templates/templateChoices/\" + id,\n\t});\n}\n\nfunction resizePopoverBody() {\n\tvar bodyheight = $(window).height();\n\tbodyheight = 3 * bodyheight / 4 - 150;\n\t$(\"#popover_choice_main\").css({\"max-height\": bodyheight});\n}\n\nfunction populateTemplateHiddenFileDiv(files) {\n\t$('#TemplateFileArray').val(JSON.stringify(files));\n}\n\nfunction populateTemplateFileBubbles() {\n\tvar fileObjectArray = JSON.parse($('#TemplateFileArray').val());\n\tfileObjectArray.forEach(function(entry) {\n\t\ttemplateAddFileBubble(entry.element_id, false, entry.filename, entry.tmp_name, 'yes');\n\t});\n}\n\nfunction templateFileHiddenAdd(files, element_id, batch) {\n\tvar fileArray = $.parseJSON($('#TemplateFileArray', window.parent.document).val());\n\tvar contained = false;\n\tfor (var j=0; j< files.length; j++) {\n\t\tfor (var i=0; i< fileArray.length; i++) {\n\t\t\tif (fileArray[i].filename == files[j].filename) {\n\t\t\t\tcontained = true;\n\t\t\t}\n\t\t\tif (batch == 'no' && fileArray[i].element_id == element_id) {\n\t\t\t\ttemplateDeleteFileBubble(fileArray[i].filename, fileArray[i].tmp_name, fileArray[i].element_id, 'iframe', batch);\n\t\t\t\tcontained = false;\n\t\t\t\tvar removeId = i;\n\t\t\t}\n\t\t}\n\t\tif (batch == 'no') fileArray.splice(removeId, 1);\n\t\tif (contained == false) {\n\t\t\tfileArray.push(files[j]);\n\t\t\ttemplateAddFileBubble(element_id, true, files[j].filename, files[j].tmp_name, batch);\n\t\t\t$('#TemplateFileArray', window.parent.document).val(JSON.stringify(fileArray));\n\t\t}\n\t}\n}\n\nfunction htmlEncode(value){\n\treturn $('<div/>').text(value).html();\n}\n\nfunction templateAddFileBubble(element_id, iframe, filename, tmp_name, batch) {\n\tfilename = htmlEncode(filename);\n\ttmp_name = htmlEncode(tmp_name);\n\tif (batch == 'no') {\n\t\tif (iframe == true) {\n\t\t\t$('#filenames_' + element_id, window.parent.document).html('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'no\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t} else {\n\t\t\t$('#filenames_' + element_id).html('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'no\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t}\n\t} else {\n\t\tif (iframe == true) {\n\t\t\t$('#filenames_' + element_id, window.parent.document).append('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'yes\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t} else {\n\t\t\t$('#filenames_' + element_id).append('<div id =\"' + tmp_name + '_container\" class =\"template_file_box_container\"><span class=\"tagFirstHalf template_file_box\">' + filename + '</span><span onClick=\"templateDeleteFileBubble(\\'' + filename + '\\', \\'' + tmp_name + '\\', \\'' + element_id + '\\', \\'normal\\', \\'yes\\');\" class=\"tagSecondHalf useCursorPointer\">x</span></div>');\n\t\t}\n\t}\n}\n\nfunction templateDeleteFileBubble(filename, tmp_name, element_id, context, batch) {\n\t$(\".loading\").show();\n\t$.ajax({\n\t\ttype:\"post\", \n\t\tcache: false,\n\t\turl:\"/templates/deleteTemporaryFile/\" + tmp_name,\n\t});\n\tvar c = this;\n\tif (context == 'iframe') {\n\t\t$('#' + tmp_name + '_container', window.parent.document).remove();\n\t\tvar oldArray = JSON.parse($('#TemplateFileArray', window.parent.document).val());\n\t} else {\n\t\t$('#' + tmp_name + '_container').remove();\n\t\tvar oldArray = JSON.parse($('#TemplateFileArray').val());\n\t}\n\tvar newArray = [];\n\toldArray.forEach(function(entry) {\n\t\tif (batch == 'no') {\n\t\t\tif (entry.element_id != element_id) {\n\t\t\t\tnewArray.push(entry);\n\t\t\t}\n\t\t} else {\n\t\t\tif (entry.tmp_name != tmp_name) {\n\t\t\t\tnewArray.push(entry);\n\t\t\t}\n\t\t}\n\t}); \n\tif (batch == 'no') {\n\t\t$('#fileUploadButton_' + element_id, $('#iframe_' + element_id).contents()).html('Upload File');\n\t}\n\tif (context == 'iframe') {\n\t\t$('#TemplateFileArray', window.parent.document).val(JSON.stringify(newArray));\n\t} else {\n\t\t$('#TemplateFileArray').val(JSON.stringify(newArray));\n\t}\n\t$(\".loading\").hide();\n}\n\t\nfunction templateFileUploadTriggerBrowse(id) {\n\t$('#upload_' + id + '_file').click();\n}\n\nfunction freetextRemoveRow(id, event_id) {\n\t$('#row_' + id).hide();\n\t$('#Attribute' + id + 'Save').attr(\"value\", \"0\");\n\tif ($(\".freetext_row:visible\").length == 0) {\n\t\twindow.location = \"/events/\" + event_id;\n\t}\n}\n\nfunction indexEvaluateFiltering() {\n\tif (filterContext == \"event\") {\n\t\tif (filtering.published != 2) {\n\t\t\t$('#value_published').html(publishedOptions[filtering.published]);\n\t\t} else {\n\t\t\t$('#value_published').html(\"\");\n\t\t}\n\t\tif (filtering.date.from != null || filtering.date.from != null) {\n\t\t\tvar text = \"\";\n\t\t\tif (filtering.date.from != \"\") text = \"From: \" + filtering.date.from;\n\t\t\tif (filtering.date.until != \"\") {\n\t\t\t\tif (text != \"\") text += \" \";\n\t\t\t\ttext += \"Until: \" + filtering.date.until;\n\t\t\t}\n\t\t}\n\t\t$('#value_date').html(text);\n\t\tfor (var i = 0; i < simpleFilters.length; i++) {\n\t\t\tindexEvaluateSimpleFiltering(simpleFilters[i]);\n\t\t}\n\t\tindexRuleChange();\n\t} else {\n\t\tfor (var i = 0; i < differentFilters.length; i++) {\n\t\t\tif (filtering[differentFilters[i]] != \"\") {\n\t\t\t\tvar text = \"\";\n\t\t\t\tif (filtering[differentFilters[i]] == 1) text = \"Yes\";\n\t\t\t\telse if (filtering[differentFilters[i]] == 0) text = \"No\";\n\t\t\t\t$('#value_' + differentFilters[i]).html(text);\n\t\t\t} else {\n\t\t\t\t$('#value_' + differentFilters[i]).html(\"\");\n\t\t\t}\n\t\t}\n\t\tfor (var i = 0; i < simpleFilters.length; i++) {\n\t\t\tindexEvaluateSimpleFiltering(simpleFilters[i]);\n\t\t}\n\t}\n\tindexSetTableVisibility();\n\tindexSetRowVisibility();\n\t$('#generatedURLContent').html(indexCreateFilters());\n}\n\nfunction quickFilterEvents(passedArgs) {\n\tpassedArgs[\"searchall\"] = $('#quickFilterField').val();\n\tvar url = \"/events/index\";\n\tfor (var key in passedArgs) {\n\t\turl += \"/\" + key + \":\" + passedArgs[key];\n\t}\n\twindow.location.href=url;\n}\n\n$('#quickFilterField').bind(\"enterKey\",function(e){\n\t$('#quickFilterButton').trigger(\"click\");\n});\n$('#quickFilterField').keyup(function(e){\n\tif(e.keyCode == 13)\n\t{\n    \t$('#quickFilterButton').trigger(\"click\");\n\t}\n});\n\t\nfunction indexApplyFilters() {\n\tvar url = indexCreateFilters();\n\twindow.location.href = url;\n}\n\nfunction indexCreateFilters() {\n\ttext = \"\";\n\tif (filterContext == 'event') {\n\t\tif (filtering.published != \"2\") {\n\t\t\ttext += \"searchpublished:\" + filtering.published;\n\t\t}\n\t} else {\n\t\tfor (var i = 0; i < differentFilters.length; i++) {\n\t\t\tif (filtering[differentFilters[i]]) {\n\t\t\t\tif (text != \"\") text += \"/\";\n\t\t\t\ttext += \"search\" + differentFilters[i] + \":\" + filtering[differentFilters[i]];\n\t\t\t}\n\t\t}\n\t}\n\tfor (var i = 0; i < simpleFilters.length; i++) {\n\t\ttext = indexBuildArray(simpleFilters[i], text);\n\t}\n\tif (filterContext == 'event') {\n\t\tif (filtering.date.from) {\n\t\t\tif (text != \"\") text += \"/\";\n\t\t\ttext += \"searchDatefrom:\" + filtering.date.from; \n\t\t}\n\t\tif (filtering.date.until) {\n\t\t\tif (text != \"\") text += \"/\";\n\t\t\ttext += \"searchDateuntil:\" + filtering.date.until;\n\t\t}\n\t\treturn baseurl + '/events/index/' + text;\n\t} else {\n\t\treturn baseurl + '/admin/users/index/' + text;\n\t}\n}\n\nfunction indexBuildArray(type, text) {\n\ttemp = \"\";\n\tif (text != \"\") temp += \"/\";\n\ttemp += \"search\" + type + \":\";\n\tif (filtering[type].NOT.length == 0 && filtering[type].OR.length == 0) return text;\n\tvar swap = filtering[type].OR.length;\n\tvar temp_array = filtering[type].OR.concat(filtering[type].NOT);\n\tfor (var i = 0; i < temp_array.length; i++) {\n\t\tif (i > 0) temp += \"|\";\n\t\tif (i >= swap) temp +=\"!\";\n\t\ttemp += temp_array[i];\n\t}\n\ttext += temp;\n\treturn text;\n}\n\nfunction indexSetRowVisibility() {\n\tfor (var i = 0; i < allFields.length; i++) {\n\t\tif ($(\"#value_\" + allFields[i]).text().trim() != \"\") {\n\t\t\t$(\"#row_\" + allFields[i]).show();\n\t\t} else {\n\t\t\t$(\"#row_\" + allFields[i]).hide();\n\t\t}\n\t}\n}\n\nfunction indexEvaluateSimpleFiltering(field) {\n\ttext = \"\";\n\tif (filtering[field].OR.length == 0 && filtering[field].NOT.length == 0) {\n\t\t$('#value_' + field).html(text);\n\t\treturn false;\n\t}\n\tif (filtering[field].OR.length !=0) {\n\t\tfor (var i = 0; i < filtering[field].OR.length; i++) {\n\t\t\tif (i > 0) text += '<span class=\"green bold\"> OR </span>';\n\t\t\tif (typedFields.indexOf(field) == -1) {\n\t\t\t\ttext += filtering[field].OR[i];\t\t\n\t\t\t} else {\n\t\t\t\tfor (var j = 0; j < typeArray[field].length; j++) {\n\t\t\t\t\tif (typeArray[field][j].id == filtering[field].OR[i]) {\n\t\t\t\t\t\ttext += typeArray[field][j].value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} \n\t}\n\tif (filtering[field].NOT.length !=0) {\n\t\tfor (var i = 0; i < filtering[field].NOT.length; i++) {\n\t\t\tif (i == 0) {\n\t\t\t\tif (text != \"\") text += '<span class=\"red bold\"> AND NOT </span>';\n\t\t\t\telse text += '<span class=\"red bold\">NOT </span>';\n\t\t\t} else text += '<span class=\"red bold\"> AND NOT </span>';\n\t\t\tif (typedFields.indexOf(field) == -1) {\n\t\t\t\ttext += filtering[field].NOT[i];\t\n\t\t\t} else {\n\t\t\t\tfor (var j = 0; j < typeArray[field].length; j++) {\n\t\t\t\t\tif (typeArray[field][j].id == filtering[field].NOT[i]) {\n\t\t\t\t\t\ttext += typeArray[field][j].value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} \n\t}\n\t$('#value_' + field).html(text);\n}\n\nfunction indexAddRule(param) {\n\tvar found = false;\n\tif (filterContext == 'event') {\n\t\tif (param.data.param1 == \"date\") {\n\t\t\tvar val1 = escape($('#EventSearch' + param.data.param1 + 'from').val());\n\t\t\tvar val2 = escape($('#EventSearch' + param.data.param1 + 'until').val());\n\t\t\tif (val1 != \"\") filtering.date.from = val1;\n\t\t\tif (val2 != \"\") filtering.date.until = val2;\n\t\t} else if (param.data.param1 == \"published\") {\n\t\t\tvar value = escape($('#EventSearchpublished').val());\n\t\t\tif (value != \"\") filtering.published = value;\n\t\t} else {\n\t\t\tvar value = escape($('#EventSearch' + param.data.param1).val());\n\t\t\tvar operator = operators[escape($('#EventSearchbool').val())];\n\t\t\tif (value != \"\" && filtering[param.data.param1][operator].indexOf(value) < 0) filtering[param.data.param1][operator].push(value);\n\t\t}\n\t} else if (filterContext = 'user') {\n\t\tif (differentFilters.indexOf(param.data.param1) != -1) {\n\t\t\tvar value = escape($('#UserSearch' + param.data.param1).val());\n\t\t\tif (value != \"\") filtering[param.data.param1] = value;\n\t\t} else {\n\t\t\tvar value = escape($('#UserSearch' + param.data.param1).val());\n\t\t\tvar operator = operators[escape($('#UserSearchbool').val())];\n\t\t\tif (value != \"\" && filtering[param.data.param1][operator].indexOf(value) < 0) filtering[param.data.param1][operator].push(value);\n\t\t}\n\t}\n\tindexEvaluateFiltering();\n}\n\nfunction indexSetTableVisibility() {\n\tvar visible = false;\n\tif ($(\"[id^='value_']\").text().trim()!=\"\" && $(\"[id^='value_']\").text().trim()!=\"-1\") {\n\t\tvisible = true;\n\t}\n\tif (visible == true) $('#FilterplaceholderTable').hide();\n\telse $('#FilterplaceholderTable').show();\n}\n\nfunction indexRuleChange() {\n\tvar context = filterContext.charAt(0).toUpperCase() + filterContext.slice(1);\n\t$('[id^=' + context + 'Search]').hide();\n\tvar rule = $('#' + context + 'Rule').val();\n\tvar fieldName = '#' + context + 'Search' + rule;\n\tif (fieldName == '#' + context + 'Searchdate') {\n\t\t$(fieldName + 'from').show();\n\t\t$(fieldName + 'until').show();\n\t} else {\n\t\t$(fieldName).show();\n\t}\n\tif (simpleFilters.indexOf(rule) != -1) {\n\t\t$('#' + context + 'Searchbool').show();\n\t} else $('#' + context + 'Searchbool').hide();\n\t\n\t$('#addRuleButton').show();\n\t$('#addRuleButton').unbind(\"click\");\n\t$('#addRuleButton').click({param1: rule}, indexAddRule);\n}\n\nfunction indexFilterClearRow(field) {\n\t$('#value_' + field).html(\"\");\n\t$('#row_' + field).hide();\n\tif (field == \"date\") {\n\t\tfiltering.date.from = \"\";\n\t\tfiltering.date.until = \"\";\n\t} else if (field == \"published\") {\n\t\tfiltering.published = 2;\n\t} else if (differentFilters.indexOf(field) != -1) {\n\t\tfiltering[field] = \"\";\n\t} else {\n\t\tfiltering[field].NOT = [];\n\t\tfiltering[field].OR = [];\n\t}\n\tindexSetTableVisibility();\n\tindexEvaluateFiltering();\n}\n\n\nfunction restrictEventViewPagination() {\n\tvar showPages = new Array();\n\tvar start;\n\tvar end;\n\tvar i;\n\n\tif (page < 6) {\n\t\tstart = 1;\n\t\tif (count - page < 6) {\n\t\t\tend = count;\n\t\t} else {\n\t\t\tend = page + (9 - (page - start));\n\t\t}\n\t} else if (count - page < 6) {\n\t\tend = count;\n\t\tstart = count - 10;\n\t} else {\n\t\tstart = page-5;\n\t\tend = page+5;\n\t}\n\t\n\tif (start > 2) {\n\t\t$(\"#apage\" + start).parent().before(\"<li><a href id='aExpandLeft'>...</a></li>\");\n\t\t$(\"#aExpandLeft\").click(function() {expandPagination(0, 0); return false;});\n\t\t$(\"#bpage\" + start).parent().before(\"<li><a href id='bExpandLeft'>...</a></li>\");\n\t\t$(\"#bExpandLeft\").click(function() {expandPagination(1, 0); return false;})\n\t}\n\n\tif (end < (count - 1)) {\n\t\t$(\"#apage\" + end).parent().after(\"<li><a href id='aExpandRight'>...</a></li>\");\n\t\t$(\"#aExpandRight\").click(function() {expandPagination(0, 1); return false;});\n\t\t$(\"#bpage\" + end).parent().after(\"<li><a href id='bExpandRight'>...</a></li>\");\n\t\t$(\"#bExpandRight\").click(function() {expandPagination(1, 1); return false;})\n\t}\n\t\n\tfor (i = 1; i < (count+1); i++) {\n\t\tif (i != 1 && i != count && (i < start || i > end)) {\n\t\t\t$(\"#apage\" + i).hide();\n\t\t\t$(\"#bpage\" + i).hide();\n\t\t}\t\n\t}\n}\n\nfunction expandPagination(bottom, right) {\n\tvar i;\n\tvar prefix = \"a\";\n\tif (bottom == 1) prefix = \"b\";\n\tvar start = 1;\n\tvar end = page;\n\tif (right == 1) {\n\t\tstart = page;\n\t\tend = count;\n\t\t$(\"#\" + prefix + \"ExpandRight\").remove();\n\t} else $(\"#\" + prefix + \"ExpandLeft\").remove();\n\tfor (i = start; i < end; i++) {\n\t\t$(\"#\" + prefix + \"page\" + i).show();\n\t}\n}\n\nfunction serverSettingsActivateField(setting, id) {\n\tresetForms();\n\t$('.inline-field-placeholder').hide();\n\tvar fieldName = \"#setting_\" + id; \n\t$.ajax({\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tdataType:\"html\", \n\t\tcache: false,\n\t\tsuccess:function (data, textStatus) {\n\t\t\t$(\".loading\").hide();\n\t\t\t$(fieldName + \"_placeholder\").html(data);\n\t\t\t$(fieldName + \"_solid\").hide();\n\t\t\t$(fieldName + \"_placeholder\").show();\n\t\t\tserverSettingsPostActivationScripts(fieldName, setting, id);\n\t\t}, \n\t\turl:\"/servers/serverSettingsEdit/\" + setting + \"/\" + id,\n\t});\n}\n\nfunction serverSettingsPostActivationScripts(name, setting, id) {\n\t$(name + '_field').focus();\n\tinputFieldButtonActive(name + '_field');\n\n\t$(name + '_form').submit(function(e){ \n\t\te.preventDefault();\n\t\tserverSettingSubmitForm(name, setting, id);\n\t\treturn false;\n\t});\n\t\n\t$(name + '_form').bind(\"focusout\", function() {\n\t\tinputFieldButtonPassive(name + '_field');\n\t});\n\n\t$(name + '_form').bind(\"focusin\", function(){\n\t\tinputFieldButtonActive(name + '_field');\n\t});\n\t\n\t$(name + '_form').bind(\"keydown\", function(e) {\n\t\tif (e.ctrlKey && (e.keyCode == 13 || e.keyCode == 10)) {\n\t\t\tserverSettingSubmitForm(name, setting, id);\n\t\t}\n\t});\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-accept').bind('click', function() {\n\t\tserverSettingSubmitForm(name, setting, id);\n\t});\n\t$(name + '_field').closest('.inline-input-container').children('.inline-input-decline').bind('click', function() {\n\t\tresetForms();\n\t\t$('.inline-field-placeholder').hide();\n\t});\n\n\t$(name + '_solid').hide();\n}\n\nfunction serverSettingSubmitForm(name, setting, id) {\n\tvar name = '#setting_' + id;\n\tvar formData = $(name + '_field').closest(\"form\").serialize();\n\t$.ajax({\n\t\tdata: formData,\n\t\tcache: false,\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tsuccess:function (data, textStatus) {\n\t\t\t$.ajax({\n\t\t\t\ttype:\"get\",\n\t\t\t\turl:\"/servers/serverSettingsReloadSetting/\" + setting + \"/\" + id,\n\t\t\t\tsuccess:function (data2, textStatus2) {\n\t\t\t\t\t$('#' + id + '_row').replaceWith(data2);\n\t\t\t\t\t$(\".loading\").hide();\n\t\t\t\t},\n\t\t\t\terror:function() {\n\t\t\t\t\tshowMessage('fail', 'Could not refresh the table.');\n\t\t\t\t}\n\t\t\t});\n\t\t}, \n\t\terror:function() {\n\t\t\tshowMessage('fail', 'Request failed for an unknown reason.');\n\t\t\tresetForms();\n\t\t\t$('.inline-field-placeholder').hide();\n\t\t},\n\t\ttype:\"post\", \n\t\turl:\"/servers/serverSettingsEdit/\" + setting + \"/\" + id + \"/\" + 1\n\t});\n\t$(name + '_field').unbind(\"keyup\");\n\t$(name + '_form').unbind(\"focusout\");\n\treturn false;\n}\n\nfunction changeFreetextImportFrom() {\n\t$('#changeTo').find('option').remove();\n\toptions[$('#changeFrom').val()].forEach(function(element) {\n\t\t$('#changeTo').append('<option value=\"' + element + '\">' + element + '</option>');\n\t});\n}\n\nfunction changeFreetextImportCommentExecute() {\n\t$('.freetextCommentField').val($('#changeComments').val());\n}\n\nfunction changeFreetextImportExecute() {\n\tvar from = $('#changeFrom').val();\n\tvar to = $('#changeTo').val();\n\t$('.typeToggle').each(function() {\n\t\tif ($( this ).val() == from) {\n\t\t\tif (selectContainsOption(\"#\" + $(this).attr('id'), to)) $( this ).val(to);\n\t\t}\n\t});\n}\n\nfunction selectContainsOption(selectid, value) {\n\tvar exists = false;\n\t$(selectid + ' option').each(function(){\n\t    if (this.value == value) {\n\t        exists = true;\n\t        return false;\n\t    }\n\t});\n\treturn exists;\n}\n\nfunction exportChoiceSelect(url, elementId, checkbox) {\n\tif (checkbox == 1) {\n\t\tif ($('#' + elementId + '_toggle').prop('checked')) {\n\t\t\turl = url + $('#' + elementId + '_set').html();\n\t\t}\n\t}\n\tdocument.location.href = url;\n}\n\nfunction freetextImportResultsSubmit(id, count) {\n\tvar attributeArray = [];\n\tvar temp;\n\tfor (i = 0; i < count; i++) {\n\t\tif ($('#Attribute' + i + 'Save').val() == 1) {\n\t\t\t\ttemp = {\n\t\t\t\t\tvalue:$('#Attribute' + i + 'Value').val(),\n\t\t\t\t\tcategory:$('#Attribute' + i + 'Category').val(),\n\t\t\t\t\ttype:$('#Attribute' + i + 'Type').val(),\n\t\t\t\t\tto_ids:$('#Attribute' + i + 'To_ids')[0].checked,\n\t\t\t\t\tcomment:$('#Attribute' + i + 'Comment').val(),\n\t\t\t\t}\n\t\t\t\tattributeArray[attributeArray.length] = temp;\t\t\n\t\t}\n\t}\n\t$(\"#AttributeJsonObject\").val(JSON.stringify(attributeArray));\n\tvar formData = $(\"#AttributeFreeTextImportForm\").serialize();\n\t$.ajax({\n\t\ttype: \"post\",\n\t\tcache: false,\n\t\turl: \"/events/saveFreeText/\" + id,\n\t\tdata: formData,\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t},\n\t\tsuccess:function (data, textStatus) {\n\t\t\twindow.location = '/events/view/' + id;\n\t\t}, \n\t\tcomplete:function() {\n\t\t\t$(\".loading\").hide();\n\t\t},\n\t});\n}\n\nfunction pgpChoiceSelect(uri) {\n\t$(\"#popover_form\").fadeOut();\n\t$(\"#gray_out\").fadeOut();\n\t$.ajax({\n\t\ttype: \"get\",\n\t\turl: \"https://pgp.mit.edu/\" + uri,\n\t\tsuccess: function (data) {\n\t\t\tvar result = data.split(\"<pre>\")[1].split(\"</pre>\")[0];\n\t\t\t$(\"#UserGpgkey\").val(result);\n\t\t\tshowMessage('success', \"Key found!\");\n\t\t},\n\t\terror: function (data, textStatus, errorThrown) {\n\t\t\tshowMessage('fail', textStatus + \": \" + errorThrown);\n\t\t}\n\t});\n}\n\nfunction lookupPGPKey(emailFieldName) {\n\t$.ajax({\n\t\ttype: \"get\",\n\t\turl: \"/users/fetchPGPKey/\" + $('#' + emailFieldName).val(),\n\t\tsuccess: function (data) {\n\t\t\t$(\"#popover_form\").fadeIn();\n\t\t\t$(\"#gray_out\").fadeIn();\n\t\t\t$(\"#popover_form\").html(data);\n\t\t},\n\t\terror: function (data, textStatus, errorThrown) {\n\t\t\tshowMessage('fail', textStatus + \": \" + errorThrown);\n\t\t}\n\t});\n}\n\nfunction zeroMQServerAction(action) {\n\t$.ajax({\n\t\ttype: \"get\",\n\t\turl: \"/servers/\" + action + \"ZeroMQServer/\",\n\t\tbeforeSend: function (XMLHttpRequest) {\n\t\t\t$(\".loading\").show();\n\t\t}, \n\t\tsuccess: function (data) {\n\t\t\t$(\".loading\").hide();\n\t\t\tif (action !== 'status') {\n\t\t\t\twindow.location.reload();\n\t\t\t} else {\n\t\t\t\t$(\"#confirmation_box\").html(data);\n\t\t\t\t$(\"#confirmation_box\").fadeIn();\n\t\t\t\t$(\"#gray_out\").fadeIn();\n\t\t\t}\n\t\t},\n\t\terror: function (data, textStatus, errorThrown) {\n\t\t\tshowMessage('fail', textStatus + \": \" + errorThrown);\n\t\t}\n\t});\n}\n"], "filenames": ["app/View/Templates/add.ctp", "app/View/Templates/edit.ctp", "app/webroot/js/ajaxification.js"], "buggy_code_start_loc": [59, 66, 906], "buggy_code_end_loc": [60, 67, 907], "fixing_code_start_loc": [59, 66, 907], "fixing_code_end_loc": [60, 67, 914], "type": "CWE-79", "message": "Multiple cross-site scripting (XSS) vulnerabilities in the template-creation feature in Malware Information Sharing Platform (MISP) before 2.3.90 allow remote attackers to inject arbitrary web script or HTML via vectors involving (1) add.ctp, (2) edit.ctp, and (3) ajaxification.js.", "other": {"cve": {"id": "CVE-2015-5720", "sourceIdentifier": "cve@mitre.org", "published": "2016-09-03T20:59:01.483", "lastModified": "2016-11-28T19:35:15.623", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Multiple cross-site scripting (XSS) vulnerabilities in the template-creation feature in Malware Information Sharing Platform (MISP) before 2.3.90 allow remote attackers to inject arbitrary web script or HTML via vectors involving (1) add.ctp, (2) edit.ctp, and (3) ajaxification.js."}, {"lang": "es", "value": "M\u00faltiples vulnerabilidades de XSS en la funcionalidad de creaci\u00f3n de plantilla en Malware Information Sharing Platform (MISP) en versiones anteriores a 2.3.90 permiten a atacantes remotos inyectar secuencias de comandos web o HTML arbitrarios a trav\u00e9s de vectores que implican (1) add.ctp, (2) edit.ctp y (3) ajaxification.js."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:misp-project:malware_information_sharing_platform:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.3.89", "matchCriteriaId": "361906F3-7B94-45B4-863A-94DB991A8CB0"}]}]}], "references": [{"url": "http://www.securityfocus.com/bid/92738", "source": "cve@mitre.org"}, {"url": "https://github.com/MISP/MISP/commit/812ac878c3645c02e2a599287117418424cbd4cf", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Patch"]}, {"url": "https://www.circl.lu/advisory/CVE-2015-5720/", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/MISP/MISP/commit/812ac878c3645c02e2a599287117418424cbd4cf"}}