{"buggy_code": ["# CHANGES\n## RosarioSIS Student Information System\n\nChanges in 10.8.1\n-----------------\n- Use CheckBoxOnclick() in StudentBalances.php & Schedule.inc.php\n- Fix SQL error when Quarter with Assignments is deleted in Portal.php\n- SQL Check requested assignment belongs to current Marking Period in Assignments.php\n- MySQL + MariaDB < 10.5 fix FOREIGN KEY constraint syntax in rosariosis_mysql.sql\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in CreateParents.php\n- Fix SQL error cast attendance code to integer in TakeAttendance.php\n- Fix hide Contact Fields according to Emergency/Custody settings in Address.inc.php\n- Fix MultipleCheckboxInput() save all unchecked, add hidden empty checkbox in Inputs.php\n\nChanges in 10.8\n---------------\n- Fix MySQL Periods list in MasterScheduleReport.php\n- SQL explicitly list all columns instead of `SELECT *` in MenuItems.php, Menus.php, EditHistoryMarkingPeriods.php, EditReportcardGrades.php, ReportCardCommentCodes.php, ReportCardComments.php & ReportCardGrades.php\n- Add & use DBSQLCommaSeparatedResult() function (SQL result as comma separated list) in database.inc.php, Dashboard.inc.php, MasterScheduleReport.php & Export.php\n- HTML email input remove pattern, add maxlength in PasswordReset.php, StudentsUsersInfo.fnc.php, NotifyParents.php, CreateParents.php & General_Info.inc.php, Other_Info.inc.php\n- JS Fix #319 Try a full match first to identify selected menu link in warehouse.js\n- Spanish translation add \u00bf character before questions in rosariosis.po\n- HTML add \"Check All\" checkbox after Periods in AddAbsences.php\n- Truncate Assignment title to 36 chars in AnomalousGrades.php\n- SQL resources table: Add PUBLISHED_PROFILES & PUBLISHED_GRADE_LEVELS columns in Update.fnc.php, rosariosis.sql & rosariosis_mysql.sql\n- Add Resource Visibility options in Resources.php\n- Move Resources functions to separate file & rename them in Resources.php & Resources.fnc.php\n- Update French & Spanish translations in rosariosis.po\n- CSS Fix Select2 dropdown hidden when inside colorBox (has z-index 9999) in stylesheet.css\n\nChanges in 10.7.1\n-----------------\n- Fix SQL limit School Periods to Course Period in AddAbsences.php\n\nChanges in 10.7\n---------------\n- CSS add Select2 styles in stylesheet.css & colors.css\n- JS add Select2 jQuery plugin in assets/js/jquery-select2/\n- Add Select2Input() function in Inputs.php\n- Use Select2 instead of Chosen, fixes the overflow issue in Widget.php, MakeReferral.php, Transcripts.fnc.php & Address.inc.php\n- Fix PHP8.2 deprecated Creation of dynamic property in Markdownify/ConverterExtra.php\n- SQL always add space before AND to $extra['WHERE'], program wide\n- Escape SanitizeHTML() & SanitizeMarkDown() before saving to DB, program wide\n- Always use UserStudentID() instead of `$_SESSION['STUDENT_ID']` in PortalPollsNotes.php\n- SQL use EXISTS(SELECT 1) instead of `EXISTS(SELECT *)` in EditReportCardGrades.php, Rollover.php & Moodle/functions.php\n- Remove trailing seconds :00 & add sorting HTML comment to datetime in Date.php\n- HTML set max Event Repeat Days to 300 in Calendar.php\n- Only display Locked column if AllowEdit() in Schedule.php\n- Schedule table: rename Periods column to Period (singular) in PrintSchedules.php & Schedule.inc.php\n- HTML add padding to Assignment options + remove useless table in Grades/Configuration.php\n- Move \"Remove required attribute, TinyMCE bug\" fix to TextAreaInput() in Inputs.php\n- Only display profiles w/Custom if actually used to gain space in PortalPollsNotes.php\n- Add & remove module icons in themes/FlatSIS/modules/\n- Add .dotx,.ppsx,.mdb,.sldx,.odg,.odc,.odb,.odf,.numbers,.pages,.m4a,.tsv,.json,.ics file extensions to whitelist in FileUpload.fnc.php\n- ROLL Gradebook Config's Final Grading Percentages for Admin (overridden) in Rollover.php\n- HTML responsive limit display columns to 3 in Courses.php & Assignments.php\n- SQL remove Period Length<=(Minutes in a Full School Day / 2) for Teacher's Schedule table in Schedule.inc.php\n- SQL include Secondary Teacher Course Periods in Schedule.inc.php\n- HTML move Schedule list inside PopTable & rework table cell in Schedule.inc.php\n- Fix do not display \"Enroll student for next school year\" link if new enrollment record in Enrollment.inc.php\n- Add Class Average row in ReportCards.fnc.php & Grades.fnc.php\n- Fix HTML5 notice Trailing slash on void elements has no effect, but keep `<br />` for `$_ROSARIO['SearchTerms']`, program wide\n- Fix regression since 9.0 show Student Photo in Transcripts.fnc.php\n- Check Assignment is in current MP in StudentAssignments.php & StudentAssignments.fnc.php\n- Corrections for French translation in rosariosis.po\n- CSS FlatSIS .list & .postbox headers adjustments for Chrome in stylesheet.css\n- CSS reduce File input size when inside list in stylesheet.css\n- CSS responsive increase max input size when inside list in zresponsive.css\n- CSS fix Student Comments margin & padding in stylesheet.css\n- Fix regression display Mailing Labels in ReportCards.fnc.php\n- Add Student Photo in ReportCards.fnc.php\n- Fix SQL error ORDER BY for Expanded View + Contact Information in GetStuList.fnc.php\n\nChanges in 10.6.3\n-----------------\n- Fix regression Teacher can save config even if overridden by Admin in Grades/Configuration.php\n- Prevent double encoding single quote (`&#039;`), was encoded by SanitizeHTML() or SanitizeMarkDown() in Inputs.php\n\nChanges in 10.6.2\n-----------------\n- Do not truncate value on List export in Accounting/functions.inc.php, Grades.php, StudentGrades.php, StudentAsignments.fnc.php, Resources.php & Student_Billing/functions.inc.php\n- SQL performance use POSITION()>0 instead of LIKE, program wide\n- SQL remove useless ID='' check in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Fix hide File input if cannot edit in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- Fix SQL use JOIN instead of WHERE EXISTS for Discipline Widgets in Widget.php\n- MySQL fix PHP fatal error when updating Course's Marking Period in Courses.php\n- Fix #338 Only check against Course Periods having overlapping Marking Period in Courses.fnc.php\n\nChanges in 10.6.1\n-----------------\n- PostgreSQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric (exact) in rosariosis.sql, thanks to @fatahou\n- MySQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric(22,16) (exact) in rosariosis_mysql.sql, thanks to @fatahou\n- SQL Fix regression since 10.0, change sum/cum factors & credit_attempted/earned columns type from double precision to numeric in Update.fnc.php\n- Fix Grades input not displaying for Teachers in Widget.php\n- Raise minimum PHP version from 5.4.45 to 5.5.9 in INSTALL.md, README.md, composer.json, diagnostic.php & Portal.php\n- Fix close PopTable wrapper `<div>` in Enrollment.inc.php, General_Info.inc.php, Medical.inc.php & Schedule.inc.php\n\nChanges in 10.6\n---------------\n- Add Pashto to right-to-left languages in Warehouse.php, Inputs.php & PDF.php\n- CSS FixedMenu bug when menu hidden in stylesheet.css\n- Fix JPG image rotation in ImageResizeGD.php\n- Resize, compress & store image using ImageUpload() in FileUpload.fnc.php\n- Fix remove `<span>` HTML tag from Assignment Type in select in Grades.php\n- Truncate Assignment Type to 36 chars only if has words > 36 chars in ProgressReports.php & StudentAssignments.fnc.php\n- Truncate Assignment title to 36 chars in StudentGrades.php\n- CSS Do NOT use global word-break. Use it only on specific elements in stylesheet.css & zresponsive.css\n- CSS responsive Fix list overflow-x scroll inside div.st in stylesheet.css\n- CSS set max-width for City & State select in Address.inc.php\n- Security fix for dynamic include in index.php\n- Fix SQL limit 1 when adding existing Contact in Address.inc.php\n- CSS responsive add .postbox-wrapper class for overflow-x scroll in PopTable.fnc.php & stylesheet.css\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in AssignOtherInfo.php\n\nChanges in 10.5.2\n-----------------\n- Fix PHP8.1 Fatal error when $options is null in StudentsUsersInfo.fnc.php\n- Remove .00 decimal from value of numeric type in Substitutions.fnc.php\n- Truncate Assignment title to 36 chars only if has words > 36 chars in ProgressReports.php, Assignments.php & MassCreateAssignments.php\n- Truncate Assignment title to 36 chars in GradebookBreakdown.php & Grades.php\n- CSS responsive fix List column title prevent word breaking in zresponsive.css\n- Fix photo use mime types, not file extensions so mobile browsers allow camera in General_Info.inc.php & MenuItems.php\n- Fix return processed image upload in case source type != target type in FileUpload.fnc.php\n\nChanges in 10.5.1\n-----------------\n- Fix MySQL error Unknown system variable 'storage_engine' in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.5\n---------------\n- JS responsive add minWidth & minHeight options to inline colorBox in jquery-colorbox.js & warehouse.js\n- Trim white spaces for Contact name & Address fields in RegistrationSave.fnc.php & Address.inc.php\n- Save Student Files fields, upload files in RegistrationSave.fnc.php\n- CSS Do not break text inside button in stylesheet.css\n- CSS responsive raise max-width for mobile & vertical tablet from 736 to 874px in zresponsive.css, rtl.css & colors.css\n- HTML fix responsive table & weekdays in Calendars.php\n- CSS responsive reduce select max-width from 440 to 340px in stylesheet.css & zresponsive.css\n- Fix PHP8.2 utf8_decode() function deprecated in PDF.php\n- MySQL change database charset to utf8mb4 and collation to utf8mb4_unicode_520_ci in InstallDatabase.php\n\nChanges in 10.4.4\n-----------------\n- Fix AllowUse() & AllowEdit() for User Info when on Student Info in AllowEdit.fnc.php\n- CSS fix Calendar header days word-break in zresponsive.css\n- CSS style time input in stylesheet.css & colors.css\n- CSS remove padding for LO_SORT arrow in zresponsive.css\n- HTML fix responsive / stackable table for Course Periods in Courses.php\n\nChanges in 10.4.3\n-----------------\n- MySQL always use InnoDB (default), avoid MyISAM in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.4.2\n-----------------\n- Fix SQL error null value in column \"amount\" in Salaries.php\n- Fix Total row calculation, reset for each student in ReportCards.fnc.php & Transcripts.fnc.php, thanks to @fatahou\n\nChanges in 10.4.1\n-----------------\n- JS fix regression since 9.0 & DOMPurify, open links in new window in warehouse.js\n- Add Database Type and Version, add PHP version to FirstLoginPoll() in FirstLogin.fnc.php\n- Fix typos in INSTALL.md & INSTALL_fr.md\n\nChanges in 10.4\n---------------\n- Modcat is addon module, set custom module icon in Profiles.php & Exceptions.php\n- SQL performance: use NOT EXISTS instead of NOT IN + LIMIT 1000 in Portal.php\n- Add student name to Student's Absences and Grades delete prompt in MassDrops.php\n- Fix display only first letter of attendance code in AttendanceSummary.php\n- Remove \"Minimum assignment points for letter grade\" config option in Grades/Configuration.php & StudentGrades.php\n- Truncate Assignment title to 36 chars in StudentGrades.php & Grades.php\n- CSS date capitalize first letter only in stylesheet.css\n- Add optional $id param to FilesUploadUpdate() in FileUpload.fnc.php\n- JS Only show laoding spinner if file input has selected files in warehouse.js\n- Add File Attached Input for existing Fees/Payments in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Add File Attached Input for existing Salaries/Staff Payments/Incomes/Expenses in Expenses.php, Incomes.php, Salaries, StaffPayments.php & Accounting/functions.inc.php\n- Add-ons can add their custom Widgets in classes/core/Widgets.php & classes/core/StaffWidgets.php\n- Add Widgets init action hook in Actions.php & Widgets.fnc.php\n- Add Staff Widgets init action hook in Actions.php & StaffWidgets.fnc.php\n- Fix SQL check student is actually enrolled in Enrollment.fnc.php\n- Fix date is 1969-12-31 on Windows when PHP intl ext not activated in strftime_compat.php\n\nChanges in 10.3.3\n-----------------\n- SQL ORDER BY END_DATE IS NULL DESC,END_DATE DESC (nulls first) for consistency between PostgreSQL & MySQL in User.fnc.php\n- Fix PostgreSQL error column \"students_join_people.address_id\" must appear in the GROUP BY clause in Address.inc.php\n\nChanges in 10.3.2\n-----------------\n- Fix PostgreSQL error ORDER BY \"full_name\" is ambiguous in DailyTransactions.php\n\nChanges in 10.3.1\n-----------------\n- Fix MySQL error result as comma separated list in Export.php\n- Add recommended php.ini setting session.gc_maxlifetime = 3600 in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.3\n---------------\n- Add \"Cumulative Balance over school years\" checkbox in StudentBalances.php\n- Fix program not found when query string is URL encoded in Modules.php\n- JS fix add new Period below existing Period row in Courses.php\n- Add \"Course Periods\" checkbox in Rollover.php\n- Fix MySQL error 1069 Too many keys specified; max 64 keys allowed in Fields.fnc.php & DisciplineForm.php\n\nChanges in 10.2.3\n-----------------\n- Remove dead link to centresis.org in index.php\n- Fix MySQL error TEXT column used in key specification without a key length in Fields.fnc.php & DisciplineForm.php\n- Add ROLLOVER_ID column to User() in User.fnc.php\n- Get template from last school year (rollover ID) in Template.fnc.php\n\nChanges in 10.2.2\n-----------------\n- Fix PHP fatal error undefined function StudentCanEnrollNextSchoolYear() in PrintStudentInfo.php\n- Set school logo with to 120px in PrintStudentInfo.php\n\nChanges in 10.2.1\n-----------------\n- SQL order by Marking Period Start Date in MarkingPeriods.php, ReportCards.fnc.php, Courses.php, Schedule.php, PrintSchedules.php, MassSchedule.php, MassDrops.php & Side.php\n- Maintain current month on calendar change in Calendar.php\n- Maintain Calendar when closing event popup in Calendar.php\n- CSS FlatSIS smaller font size for Calendar Event title in stylesheet.css\n- Fix SQL error mysqli_fetch_assoc(): Argument 1 must be of type mysqli_result, null given in database.inc.php & StudentsUsersInfo.fnc.php\n- When -Edit- option selected, change the auto pull-down to text field in StudentsUsersInfo.fnc.php\n- HTML remove bold for \"Other students associated with this address/person\" in Address.inc.php\n- SQL order by FULL_NAME (Display Name config option) in PortalPollNotes.fnc.php, Widget.php, GetStaffList.fnc.php, GetStuList.fnc.php, Transcripts.fnc.php, Courses.php, MassRequests.php, ScheduleReport.php & Address.inc.php\n- CSS fix Report Cards PDF columns size when long comments text in ReportCards.fnc.php & stylesheet_wkhtmltopdf.css\n- CSS Add .grade-minmax-wrap,.grade-minmax-min,.grade-minmax-grade & .grade-minmax-max classes & avoid breaking grades in stylesheet.css & ReportCards.fnc.php\n- Fix get Min. Max. grades for students in distinct grade levels in FinalGrades.php\n- Fix SQL syntax error since 10.0 in Administration.php\n- CSS Do not break words inside lists in stylesheet.css\n- SQL handle case when student dropped and then later re-enrolled in course in DuplicateAttendance.php\n- Use DBEscapeIdentifier() for Gradebook ASSIGNMENT_SORTING in Assignments.php, GradebookBreakdown.php & Grades.php\n\nChanges in 10.2\n---------------\n- Add StudentCanEnrollNextSchoolYear() & StudentEnrollNextSchoolYear() functions in Enrollment.fnc.php\n- Add \"Enroll student for next school year\" in Enrollment.inc.php\n- Translate \"Enroll student for next school year\" to French & Spanish in rosariosis.po\n- MySQL fix character encoding when translating database in InstallDatabase.php\n\nChanges in 10.1\n---------------\n- Fix MySQL 5.6 syntax error when WHERE without FROM clause, use dual table in TakeAttendance.php, Reminders.php,  InputFinalGrades.php, Requests.php & Calendar.php\n- Add dual VIEW for compatibility with MySQL 5.6 to avoid syntax error when WHERE without FROM clause in rosariosis.sql & Update.fnc.php\n- Fix MySQL 5.6 syntax error in ORDER BY use report_card_comments table instead of dual in InputFinalGrades.php\n- Fix SQL use cast(extract(DOW) AS int) for PostrgeSQL in Calendar.php\n- Add instructions for MySQL in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.0\n---------------\n- SQL convert table names to lowercase, program wide\n- Fix delete file attached in StudentFees.php\n- Use DBEscapeIdentifier() for reserved 'column' keyword in plugins/Moodle/\n- Avoid regression due to lowercase table names: Maintain compatibility with add-ons using rollover_after action hook & `$_REQUEST['tables']` in Rollover.php\n- Use db_trans_*() functions in DeleteTransaction.fnc.php & DeleteTransactionItem.fnc.php\n- Close popup if no UserSchool in session, happens on login redirect in Warehouse.php\n- SQL order Grade Levels in StudentBreakdown.php\n- Remove semicolon before \"With\" & \"On\" values in PrintRequests.php & unfilledRequests.inc.php\n- HTML Link is selected: bold in ScheduleReport.php\n- Display Period title if no short name set in IncompleteSchedules.php\n- Fix Widget search & add Search Terms header in IncompleteSchedules.php\n- Add Schedule link & photo tooltip to Student name in Scheduling/AddDrop.php\n- HTML add a11y-hidden label to select in GPARankList.php & Attendance/TeacherCompletion.php\n- Fix unset requested dates in MassCreateAssignments.php & Assignments.php\n- Add User / Student photo tooltip in Grades/TeacherCompletion.php, GPARankList.php & EnterEligibility.php\n- SQL order by Period title in TeacherCompletion.php\n- Use Period's Short Name when > 10 columns in the list in TeacherCompletion.php\n- Add note on save in EntryTimes.php\n- Fix PHP8.1 Deprecated passing null to parameter in EmailReferral.fnc.php, CategoryBreakdown.php & StudentGrades.php\n- Add Total sum of balances in StaffBalances.php\n- Fix French translation for \"Waiver\" & \"Refund\" in rosariosis.po\n- Force title & action to lowercase in Prompts.php\n- HTML use .dashboard-module-title CSS class for module titles in Profiles.php & Exceptions.php\n- CSS set input label max-width on Search form in stylesheet.css\n- JS new default popup size: 1200x450 in warehouse.js\n- Use URLEscape() for add button link when appropriate in ListOutput.fnc.php\n- JS set Calendar date to current fields date in warehouse.js & calendar-setup.js\n- HTML add label to select in ActivityReport.php\n- Use Currency() function instead of number_format() in TransactionsReport.php\n- HTML remove line-break in Warning/Minimum columns in Reminders.php\n- HTML CSS make Daily Menus calendar coherent with School Calendar in DailyMenus.php\n- Shorten Referral email subject in EmailReferral.fnc.php\n- Use plural wise ngettext() for \"No %s were found.\" in FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Force result text to lowercase for \"No %s were found.\" in ListOutput.fnc.php, FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Prevent admin from removing own access to User Profiles program in Profiles.php\n- SQL change modname column type from text to varchar(150) to match with MySQL key index limitation in rosariosis.sql\n- SQL change program column type from text to varchar(100) NOT NULL to match with MySQL index limitation in rosariosis.sql\n- SQL change schools column type from text to varchar(150) to match with MySQL index limitation in rosariosis.sql\n- Rename YEAR_MONTH column alias to YEAR_MONTH_DATE: reserved keyword in MySQL in Dashboard.inc.php\n- SQL use DAYOFWEEK() for MySQL or cast(extract(DOW)+1 AS int) for PostrgeSQL, program wide\n- SQL cast(AS UNSIGNED) for MySQL or cast(AS INT) for PostgreSQL, program wide\n- SQL cast custom_fields ID AS char(10) instead of TEXT for MySQL compatibility in GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL rename $field COLUMN (reserved keyword) to COLUMN_NAME for MySQL compatibility in CustomFields.fnc.php, GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL remove use of nextval in rosariosis_fr.sql\n- Rename $pg_dumpPath configuration variable to $DatabaseDumpPath in config.inc.sample.php, diagnostic.php & DatabaseBackup.php\n- Build command for executing mysqldump in DatabaseBackup.php\n- SQL to extract Unix timestamp or epoch from date in Eligibility/Student.php, StudentList.php & TeacherCompletion.php\n- Install module/plugin: execute the install_mysql.sql script for MySQL in Modules.inc.php, Plugins.inc.php & modules/README.md & plugins/README.md\n- Fix typo \"inexistant\" to \"nonexistent\" & update translations in Modules.inc.php, Plugins.inc.php & rosariosis.po\n- HTML fix duplicated #menu-top div on update in Side.php\n- JS fix #body height calculation: include bottom margin in jquery-fixedmenu.js & plugins.min.js\n- Add MySQLRemoveDelimiter() remove DELIMITER $$ declarations before procedures or functions in database.inc.php, Modules.inc.php & Plugins.inc.php\n- SQL ORDER BY SORT_ORDER IS NULL,SORT_ORDER (nulls last) for consistency between PostgreSQL & MySQL, program wide\n- Rollback Fix PostgreSQL error invalid ORDER BY, only result column names can be used, program wide\n- HTML use number input for Gradebook config options in Configuration.php\n- HTML use number input for Grade points & average in ReportCardGrades.php\n- SQL limit results to current school year in AddDrop.php\n- SQL always use INTERVAL to add/subtract days to date for MySQL compatibility in Reminders.php, Transactions.php, ServeMenus.php, Assignments.php, StudentGrades.php, Rollover.php & Portal.php\n- SQL change amount columns type from numeric to numeric(14,2) NOT NULL in rosariosis.sql & StudentFees.php\n- SQL change minutes,minutes_present,points,default_points,length,count_weighted_factors,count_unweighted_factors columns type from numeric to integer in rosariosis.sql, UpdateAttendanceDaily.fnc.php, Assignments.php, MassCreateAssignments.php & Periods.php\n- SQL change gp & gpa columns type from numeric to numeric(7,2) in rosariosis.sql\n- SQL change sum/cum factors & credit_attempted/earned columns type from numeric to double precision in rosariosis.sql\n- Add Can use modname to HACKING ATTEMPT error email in ErrorMessage.fnc.php\n- Fix HACKING ATTEMPT when Grades module inactive in Portal.php & Calendar.php\n- Use GetTemplate() instead of unescaping `$_REQUEST` in CreateParents.php & NotifyParents.php\n- Use `$_POST` to get password instead of unescaping `$_REQUEST` in PasswordReset.php, Student.php & User.php\n- Use DBGetOne() instead of unescaping `$_REQUEST` in Config.fnc.php\n- Add MySQL support in database.inc.php, diagnostic.php, InstallDatabase.php & Warehouse.php\n- Add $DatabaseType configuration variable in database.inc.php, diagnostic.php, InstallDatabase.php, Warehouse.php & config.inc.php\n- Add $show_error parameter to db_start() in database.inc.php\n- Add DBUnescapeString() function in database.inc.php, GetStuList.fnc.php, ListOutput.fnc.php, PreparePHP_SELF.fnc.php & Search.fnc.php\n- PostgreSQL Date format: move query from Date.php to Warehouse.php\n- Compatibility with add-ons version < 10.0, gather CONFIG (uppercase table name) values too in Configuration.php\n- Fix MySQL error Table is specified twice, both as a target for 'INSERT' and as a separate source for data in CopySchool.php & Rollover.php\n- Fix MySQL syntax error: no table alias in DELETE in Rollover.php\n- Fix MySQL syntax error: no FROM allowed inside UPDATE, use subquery or multi-table syntax in Rollover.php\n- Fix MySQL syntax error: replace CAST (NULL AS CHAR(1)) AS CHECKBOX with NULL AS CHECKBOX in AddAbsences.php, AddActivity.php, MassDrops.php, MassRequests.php, MassSchedule.php, AddUsers.php, AssignOtherInfo.php & AddStudents.php\n- Add Installation tutorial for Mac in WHATS_NEW.md & INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Update tested on Ubuntu 18.04 to 20.04 in INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Fix SQL error when column already dropped in Fields.fnc.php\n- SQL fix CREATE INDEX on right table in rosariosis.sql\n- SQL remove unused indices for various tables in rosariosis.sql\n- SQL match index with FOREIGN KEY for various tables in rosariosis.sql\n- SQL ORDER BY fix issue when Transferring to another school & new start date is <= old start date in Enrollment.inc.php\n- Check if student already enrolled on that date when inserting START_DATE in SaveEnrollment.fnc.php\n- Add `_getAddonsSQL()` & `_configTableCheck()` functions in InstallDatabase.php\n- $DatabasePort configuration variable is now optional in config.inc.sample.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- SQL start staff_fields ID sequence at 200000000 for coherence with custom_fields in rosariosis.sql & Fields.fnc.php\n- MySQL use LONGTEXT type for textarea field in Fields.fnc.php & DisciplineForm.php\n- SQL Check requested assignment belongs to teacher in Assignments.php\n- CSS fix responsive when really long string with no space in stylesheet.css\n- Limit `$_POST` array size to a maximum of 16MB in Warehouse.php, thanks to @ahmad0x1\n- Add optional ROSARIO_POST_MAX_SIZE_LIMIT constant in Warehouse.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- Add MySQL database dump in rosariosis_mysql.sql\n- Log \"RosarioSIS HACKING ATTEMPT\" into Apache error.log in HackingLog.fnc.php\n- Force URL & menu reloading, always use JS to redirect in HackingLog.fnc.php\n- Place currency symbol after amount for some locales in Currency.fnc.php\n- SQL use timestamp type: standard & without time zone by default in rosariosis.sql\n- CSS add .accounting-totals, .accounting-staff-payroll-totals, .student-billing-totals classes in Expenses.php, Incomes.php, Salaries.php, StaffPayments.php, StudentFees.php & StudentPayments.php\n- SQL rename KEY (reserved keyword) to SORT_KEY for MySQL compatibility in Search.fnc.php, StudentFieldBreakdown.php, StudentBreakdown.php\n- SQL use GROUP BY instead of DISCTINCT ON for MySQL compatibility in Address.inc.php & EnterEligibility.php\n- SQL cast Config( 'STUDENTS_EMAIL_FIELD' ) to int when custom field in SendNotification.fnc.php, Registration.fnc.php, Moodle/getconfig.inc.php & ImportUsers.fnc.php\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in PortalPollsNotes.fnc.php, DeleteTransaction.fnc.php, DeleteTransactionItem.fnc.php, Rollover.php, CopySchool.php & AssignOtherInfo.php\n- Fix MySQL syntax error: explicitly list all columns instead of wildcard in ActivityReport.php & Statements.php\n- Fix MakeChooseCheckbox() remove parent link to sort column in Inputs.php & ListOutput.fnc.php\n- CSS WPadmin fix menu select width in stylesheet.css\n- Enrollment Start: No N/A option for new student in StudentUsersInfo.fnc.php\n\nChanges in 9.3.2\n----------------\n- Fix regression since 9.2.1 fields other type than Select Multiple from Options in CategoryBreakdownTime.php\n\nChanges in 9.3.1\n----------------\n- Fix regression since 2.9 Schedule multiple courses in plugins/Moodle/Scheduling/MassSchedule.php\n- Fix SQL to select Periods where exists CP in TeacherCompletion.php & Administration.php\n- Fix dummy day (year month date) set to 28 for February in Dashboard.inc.php\n- Fix AllowEdit for Teacher in Users/includes/General_Info.inc.php\n- Security: sanitize filename with no_accents() in Student.php, User.php & Schools.php\n- Fix \"Exclude PDF generated using the \"Print\" button\" option for the PDF Header Footer plugin in Bottom.php\n\nChanges in 9.3\n--------------\n- Handle case where Course Period Parent ID is null in Courses.php\n- SQL order by Period title in Periods.php, DailySummary.php & StudentSummary.php\n- SQL get Period title if no short name set in AddAbsences.php\n- Use DBLastInsertID() instead of DBSeqNextID() in Moodle/includes/ImportUsers.fnc.php\n- Still use DBSeqNextID() for student ID, adapt for MySQL in Student.php & Moodle/includes/ImportUsers.fnc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility, program wide\n- Fix first item in the list not displayed in Accounting/includes/DailyTransactions.php\n- SQL time interval for MySQL compatibility in PasswordReset.php & index.php\n- SQL use CAST(X AS char(X)) instead of to_char() for MySQL compatibility in Dashboard.inc.php & Reminders.php\n- SQL result as comma separated list for MySQL compatibility in Grades/includes/Dashboard.inc.php & MasterScheduleReport.php\n- Use DBEscapeIdentifier() for MySQL reserved 'TIMESTAMP' keyword in ServeMenus.php & Transactions.php\n- SQL add `_SQLUnixTimestamp()` to extract Unix timestamp or epoch from date in Grades.php & Schedule.php\n- Add case for MySQL: get next MP ID & set AUTO_INCREMENT+1 in EditHistoryMarkingPeriods.php\n- Display Name: SQL use CONCAT() instead of pipes || for MySQL compatibility in Configuration.php & GetStuList.fnc.php\n- config table: update DISPLAY_NAME to use CONCAT() instead of pipes || in Update.fnc.php\n\nChanges in 9.2.2\n----------------\n- Fix SQL error lastval is not yet defined when editing field in SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Assignments.php\n\nChanges in 9.2.1\n----------------\n- Remove use of db_seq_nextval(), use auto increment, program wide\n- SQL set default nextval (auto increment) for RosarioSIS version < 5.0 on install & old add-ons in Update.fnc.php\n- SQL no more cast MARKING_PERIOD_ID column as text/varchar in rosariosis.sql & InputFinalGrades.php\n- PLpgSQL compact & consistent function declaration in rosariosis.sql\n- Use DB transaction statements compatible with MySQL in database.inc.php\n- Add DBLastInsertID() & deprecate DBSeqNextID() + db_seq_nextval() in database.inc.php\n- SQL rename character varying & character data types to varchar & char in rosariosis.sql\n- SQL replace use of STRPOS() with LIKE, compatible with MySQL in PortalPollNotes.fnc.php & Courses.php\n- SQL fix French & Spanish translation for Create Parent Users & Notifiy Parents email templates in rosariosis_fr.sql & rosariosis_es.sql\n- Use DBLastInsertID() instead of DBSeqNextID(), program wide\n- SQL TRIM() both compatible with PostgreSQL and MySQL in AttendanceSummary.php & CopySchool.php\n- SQL use extract() or SUBSTRING() or REPLACE() instead of to_char() for MySQL compatibility, program wide\n- Fix No Address contact not properly saved for student / parent in RegistrationSave.fnc.php\n- AddDBField() Change $sequence param to $field_id, adapted for use with DBLastInsertID() in Fields.fnc.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php & UserFields.php\n- Raise Frame file size limit to 5MB in HonorRoll.fnc.php\n- Fix Marking Period not found in user School Year (multiple browser tabs case) in MassSchedule.php & MassDrops.php\n- Fix Course not found in user School Year (multiple browser tabs case) in MassRequests.php\n- HTML add label to inputs in Requests.php\n- Remove help sentence. The Scheduler is not run by the Student Requests program in Help_en.php\n\nChanges in 9.2\n--------------\n- Fix SQL error invalid input syntax for integer in Administration.php\n- SQL student_report_card_grades table: convert MARKING_PERIOD_ID column to integer in Update.fnc.php, rosariosis.sql, EditReportCardGrades.php, FinalGrades.php & ReportCards.fnc.php\n\nChanges in 9.1.1\n----------------\n- Fix PHP8.1 fatal error unsupported operand types: string / int in Assignments.php & MassCreateAssignments.php\n- Fix selected Subject lost on Comment Category delete in ReportCardComments.php\n- Fix Color Input was hidden in ReportCardComments.php\n- Fix use Course ID in session in MassRequests.php\n- Fix SQL error primary key exists on table food_service_staff_accounts in Rollover.php\n- Fix SQL error foreign key exists on tables gradebook_assignments,gradebook_assignment_types,schedule_requests in Rollover.php\n- Fix save State input value in Registration.fnc.php\n- Fix SchoolInfo() on user School Year update in School.php\n\nChanges in 9.1\n--------------\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @domiee13\n- Capitalize month when date is only month and year in Dashboard.inc.php\n- Add decimal & thousands separator configuration in Help_en.php, Currency.fnc.php, Configuration.php, rosariosis.sql & rosariosis_fr.sql\n- Use Currency() for Food Service Balance value in Widget.php & StaffWidget.php\n- Add Class average in InputFinalGrades.php & Grades.fnc.php\n- Update French & Spanish translation in rosariosis.po & help.po\n- Update Default School Year to 2022 in config.inc.sample.php & rosariosis.sql\n\nChanges in 9.0\n--------------\n- CSS add length to previous meals select in DailyMenus.php\n- CSS FlatSIS fix calendar menu text wrapping in stylesheet.css\n- Add Export list button in TransactionsReport.php\n- Add Food Service icon to list in ServeMenus.php\n- Add User / Student photo tooltip in ServeMenus.php, Transactions.php & TeacherCompletion.php\n- HTML add horizontal ruler before each category in MakeReferral.php\n- Fix SQL error when generating Schedule table with PHP8.1 in GetMP.php\n- Reorder PDF list columns to match Schedule columns in PrintSchedules.php\n- SQL order Schedule list by Course Title & Course Period Short Name in Schedule.php, PrintSchedules.php & Schedule.inc.php\n- Fix SQL error more than one row returned by a subquery in Rollover.php\n- Fix update Course Period title when Short Name contains single quote in Courses.php\n- Fix PHP8.1 deprecated function parameter is null, program wide\n- Fix PHP8.1 deprecated automatic conversion of false to array in StudentsUsersInfo.fnc.php\n- Fix PHP8.1 deprecated automatic conversion of float to int in ImageResizeGD.php\n- Add Student Photo Tip Message in AddDrop.php & StudentList.php\n- Format Enrollment Start & End Date in Export.php\n- Add Student name if no Contacts at address in MailingLabel.fnc.php\n- Do not Export Delete column in Periods.php & GradeLevels.php\n- HTML group inputs inside fieldset (tab title or program name) in Configuration.php\n- Hide Comment Codes tip message if Comments unchecked for Marking Period in InputFinalGrades.php\n- Add Get Student Labels Form JS (Disable unchecked fieldset) in StudentLabels.fnc.php & StudentLabels.php\n- Fix PHP8.1 deprecated use PostgreSQL $db_connection global variable in database.inc.php & Grades/includes/Dashboard.inc.php\n- Don't Delete Gender & Birthday Student Fields in Fields.fnc.php\n- CSS set cursor for .tipmsg-label in stylesheet.css\n- Add Username to Password Reset email in PasswordReset.php\n- `intl` PHP extension is now required in diagnostic.php & INSTALL.md\n- Fix PHP8.1 deprecated strftime() use strftime_compat() instead in Side.php, Date.php, PHPCompatibility.php, strftime_compat.php, Dashboard.inc.php & Preferences.php\n- Add $course_period_id param to limit check to a single Course Period in Courses.fnc.php & Courses.php\n- Add title to Contact & Address button images in Address.inc.php & GetStuList.fnc.php\n- CSS select max-width 440px in stylesheet.css & zresponsive.css\n- HTML add label to Points inputs to correct alignment in Grades.php\n- HTML add a11y-hidden label to select in CategoryBreakdown.php, CategoryBreakdownTime.php & StudentFieldBreakdown.php\n- Place Go button right after Timeframe in DailyTransactions.php, DailyTotals.php, CategoryBreakdown.php, CategoryBreakdownTime.php, StudentFieldBreakdown.php & Percent.php\n- Fix French translation for \"Not due\" in rosariosis.po\n- Move Transcript Include form checkboxes up in Transcripts.fnc.php\n- Add Delete button for Submission File in StudentAssignments.fnc.php\n- Fix SQL error null value in column \"title\" violates not-null constraint in MassCreateAssignments.php\n- Reorder & rename Course Periods columns to match Schedule program in MassCreateAssignments.php\n- Fix get History Grades Grade Level short name only if no Grade Level available in Transcripts.fnc.php\n- Fix get Student Photo from previous year in Transcripts.fnc.php\n- Fix SQL error invalid input syntax in PrintSchedules.php & TeacherCompletion.php, thanks to @scgajge12\n- Filter IP, HTTP_* headers can be forged in index.php, PasswordReset.php & ErrorMessage.fnc.php\n- Fix SQL error invalid input syntax for integer, program wide\n- Fix PHP8.1 fatal error checkdate argument must be of type int in Calendar.php\n- Fix SQL error invalid input syntax for type date in Calendar.php\n- Fix SQL error duplicate key value violates unique constraint \"attendance_calendar_pkey\" in Calendar.php\n- Fix PHP fatal error Unsupported operand types in ListOutput.php\n- Add AttrEscape() function in Inputs.php\n- Use AttrEscape() instead of htmlspecialchars(), program wide\n- Add use of AttrEscape(), program wide\n- Maintain Advanced search when editing Timeframe in Percent.php\n- Fix SQL injection escape DB identifier in RegistrationSave.fnc.php, Calendar.php, MarkingPeriods.php, Courses.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Referrals.php\n- JS update marked to v4.0.14 in assets/js/marked/ & warehouse_wkhtmltopdf.js\n- JS add DOMPurify 2.3.6 in assets/js/DOMPurify/ & Gruntfile.js\n- JS fix stored XSS issue related to MarkDown in warehouse.js & plugins.min.js, thanks to @intrapus\n- JS remove logged in check on history back in warehouse.js & plugins.min.js\n- Add CSRF token to protect unauthenticated requests in Warehouse.php & login.php\n- Add CSRF token to logout URL in login.php, Warehouse.php, PasswordReset.php, Bottom.php, Student.php & User.php, thanks to @khanhchauminh\n- Logout after 10 Hacking attempts within 1 minute in HackingLog.fnc.php\n- Destroy session now: some clients do not follow redirection in HackingLog.fnc.php\n- Add use of URLEscape(), program wide\n- Use URLEscape() for img src attribute, program wide\n- Sanitize / escape URL as THEME is often included for button img src attribute in User.fnc.php\n- Better format for \"Add another marking period\" form in EditReportCardGrades.php\n- Fix Improper Access Control security issue: add random string to photo file name in TipMessage.fnc.php, Transcripts.fnc.php, PrintClassPictures.php, Student.php, User.php & General_Info.inc.php, thanks to @dungtuanha\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @khanhchauminh\n- Fix stored XSS security issue: remove inline JS from URL in PreparePHP_SELF.fnc.php, thanks to @intrapus & @domiee13\n- Fix stored XSS security issue: add semicolon to HTML entity so it can be decoded in PreparePHP_SELF.fnc.php, thanks to @intrapus\n- Accessibility: add hidden input label using .a11y-hidden class in ReportCardComments.php, StudentFields.php & Grades/TeacherCompletion.php\n- Accessibility: add select label in Eligibility/TeacherCompletion.php, Student.php, StudentList.php, MassDrops.php & MassSchedule.php\n- Two Lists on same page: export only first, no search in Eligibility/Student.php\n- Remove photos on delete in Student.php & User.php, thank to @jo125ker\n- Remove Student Assignment Submission files on delete in Assignments.php, thank to @khanhchauminh\n- Add microseconds to filename format to make it harder to predict in Assignments.php & StudentAssignments.fnc.php, thanks to @khanhchauminh\n- Restrict Sort Order input number range, program wide\n- Restrict Price / Amount / Balance input number range, program wide, thanks to @nhienit2010\n- Restrict input number step in Courses.fnc.php\n- Restrict diagnostic access to logged in admin in diagnostic.php, thanks to @intrapus\n- Fix SQL error value too long for type character varying(50) in Schools.php\n- Add Secure RosarioSIS link in INSTALL.md\n- Add Calendar days legend in Calendar.php\n- CSS add .legend-square class in stylesheet.css & colors.css\n- Create / Edit / Delete calendar: use button() in Calendar.php\n- Update Calendars help text in Help_en.php & help.po\n- Add translations for Calendar days legend in rosariosis.po\n- Use json_encode() for AjaxLink() URL, program wide\n- SQL skip \"No Address\" contacts to avoid lines with empty Address fields in Export.php\n- French translation: remove capitalization & use articles in rosariosis.po, help.po & rosariosis_fr.sql\n- JS Sanitize string for legal variable name in Export.php & Inputs.php\n- Remove deprecated `_makeTeacher()` function in ReportCards.fnc.php\n- Use multiple select input for grades list to gain space in Widget.php\n- Fix regression since 5.0, allow Administration of \"Lunch\" attendance categories in Administration.php, AttendanceCodes.fnc.php & colors.css\n- SQL set default FAILED_LOGIN_LIMIT to 30 in rosariosis.sql, thanks to @domiee13\n- JS Hide Options textarea if Field not of select type in Fields.fnc.php\n- Add Balance widget in StudentBalances.php\n- Add Total sum of balances in StudentBalances.php\n- Fix SQL error check requested UserSyear & UserSchool exists in DB in Side.php, Search.fnc.php & SaveEnrollment.fnc.php\n- HTML use number input for Class Rank widget in Widget.php\n- Check default if school has no default calendar in Calendar.php\n- CSS do not capitalize date in stylesheet.css\n- Remove unused index ON attendance_period (attendance_code) & ON student_report_card_grades (school_id) in rosariosis.sql & rosariosis_mysql.sql\n- SQL VACUUM & ANALIZE are for PostgreSQL only in Scheduler.php\n\n\n### Old versions CHANGES\n- [CHANGES for versions 7 and 8](CHANGES_V7_8.md).\n- [CHANGES for versions 5 and 6](CHANGES_V5_6.md).\n- [CHANGES for versions 3 and 4](CHANGES_V3_4.md).\n- [CHANGES for versions 1 and 2](CHANGES_V1_2.md).\n", "<?php\n/**\n * Student Assignments functions\n *\n * @package RosarioSIS\n * @subpackage modules/Grades\n */\n\nrequire_once 'ProgramFunctions/FileUpload.fnc.php';\n\n// Assignments Files upload path global.\n\nif ( ! isset( $AssignmentsFilesPath ) )\n{\n\t$AssignmentsFilesPath = 'assets/AssignmentsFiles/';\n}\n\n/**\n * Submit Student Assignment\n * Save eventual uploaded file\n * & TinyMCE message.\n *\n * @example $submitted = StudentAssignmentSubmit( $_REQUEST['assignment_id'], $error );\n *\n * @uses GetAssignment()\n * @uses GetAssignmentsFilesPath()\n * @uses FileUpload()\n * @uses SanitizeHTML()\n * @since 2.9\n * @since 8.9.5 Add microseconds to filename format to make it harder to predict.\n *\n * @param  string  $assignment_id Assignment ID.\n * @param  array   $error         Global errors array.\n * @return boolean False if error(s), else true.\n */\nfunction StudentAssignmentSubmit( $assignment_id, &$error )\n{\n\trequire_once 'ProgramFunctions/MarkDownHTML.fnc.php';\n\n\t$assignment = GetAssignment( $assignment_id );\n\n\tif ( ! $assignment )\n\t{\n\t\t$error[] = _( 'You are not allowed to access this assignment.' );\n\n\t\techo ErrorMessage( $error, 'fatal' );\n\t}\n\n\tif ( ! $assignment['SUBMISSION'] )\n\t{\n\t\t$error[] = _( 'Assignment submission is not enabled.' );\n\n\t\treturn false;\n\t}\n\n\t// Old submission.\n\t$old_submission = GetAssignmentSubmission( $assignment_id, UserStudentID() );\n\n\tif ( $old_submission )\n\t{\n\t\t$old_data = unserialize( $old_submission['DATA'] );\n\t}\n\n\t// TODO: check if Student not dropped?\n\n\t$files = issetVal( $old_data['files'] );\n\n\t$timestamp = new \\DateTime();\n\n\t// @since 8.9.5 Add microseconds to filename format to make it harder to predict.\n\t$timestamp = $timestamp->format( 'Y-m-d H:i:s.u' );\n\n\t$assignments_path = GetAssignmentsFilesPath( $assignment['STAFF_ID'] );\n\n\t// Check if file submitted.\n\tif ( isset( $_FILES['submission_file'] ) )\n\t{\n\t\t$student_name = DBGetOne( \"SELECT \" . DisplayNameSQL() . \" AS NAME\n\t\t\tFROM students\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\" );\n\n\t\t// Filename = [course_title]_[assignment_ID]_[student_name]_[timestamp].ext.\n\t\t$file_name_no_ext = no_accents( $assignment['COURSE_TITLE'] . '_' . $assignment_id . '_' .\n\t\t\t$student_name . '_' . $timestamp );\n\n\t\t// Upload file to AssignmentsFiles/[School_Year]/Teacher[teacher_ID]/Quarter[1,2,3,4...]/.\n\t\t$file = FileUpload(\n\t\t\t'submission_file',\n\t\t\t$assignments_path,\n\t\t\tFileExtensionWhiteList(),\n\t\t\t0,\n\t\t\t$error,\n\t\t\t'',\n\t\t\t$file_name_no_ext\n\t\t);\n\n\t\tif ( $file )\n\t\t{\n\t\t\t$files = [ $file ];\n\t\t}\n\t}\n\n\tif ( isset( $_REQUEST['submission_file'] ) )\n\t{\n\t\t// Submission file input enabled (may be empty).\n\t\tif ( $old_data )\n\t\t{\n\t\t\t$old_file = issetVal( $old_data['files'][0], '' );\n\n\t\t\tif ( file_exists( $old_file ) )\n\t\t\t{\n\t\t\t\t// Delete old file if any.\n\t\t\t\tunlink( $old_file );\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check if HMTL submitted.\n\t$message = isset( $_POST['message'] ) ? SanitizeHTML( $_POST['message'], $assignments_path ) : '';\n\n\t// Serialize Assignment Data.\n\t$data = [ 'files' => $files, 'message' => $message, 'date' => $timestamp ];\n\n\t$data = DBEscapeString( serialize( $data ) );\n\n\t// Save assignment submission.\n\t// Update or insert?\n\tif ( $old_submission )\n\t{\n\t\t// Update.\n\t\t$assignment_submission_sql = \"UPDATE student_assignments\n\t\t\tSET DATA='\" . $data . \"'\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND ASSIGNMENT_ID='\" . (int) $assignment_id . \"'\";\n\t}\n\telse\n\t{\n\t\t// If no file & no message.\n\t\tif ( $message = ''\n\t\t\t&& ! $files )\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\t// Insert.\n\t\t$assignment_submission_sql = \"INSERT INTO student_assignments\n\t\t\t(STUDENT_ID, ASSIGNMENT_ID, DATA)\n\t\t\tVALUES ('\" . UserStudentID() . \"', '\" . $assignment_id . \"', '\" . $data . \"')\";\n\t}\n\n\tDBQuery( $assignment_submission_sql );\n\n\treturn empty( $error );\n}\n\n/**\n * Student Assignment details\n * & Submission form.\n *\n * @example echo StudentAssignmentSubmission( $_REQUEST['assignment_id'] );\n *\n * @uses GetAssignmentSubmission()\n * @uses TinyMCEInput()\n * @since 2.9\n *\n * @since 4.5 Move headers to StudentAssignmentDrawHeaders() function\n *\n * @param  string  $assignment_id Assignment ID.\n * @return boolean true if can submit, else false.\n */\nfunction StudentAssignmentSubmissionOutput( $assignment_id )\n{\n\trequire_once 'ProgramFunctions/FileUpload.fnc.php';\n\n\t$assignment = GetAssignment( $assignment_id );\n\n\tif ( ! $assignment )\n\t{\n\t\t$error[] = _( 'You are not allowed to access this assignment.' );\n\n\t\techo ErrorMessage( $error, 'fatal' );\n\t}\n\n\tStudentAssignmentDrawHeaders( $assignment );\n\n\t// @since 4.1 Submission header action hook.\n\tdo_action( 'Grades/includes/StudentAssignments.fnc.php|submission_header' );\n\n\tif ( ! $assignment['SUBMISSION'] )\n\t{\n\t\treturn false;\n\t}\n\n\t// Get assignment submission if any.\n\t$submission = GetAssignmentSubmission(\n\t\t$assignment_id,\n\t\tUserStudentID()\n\t);\n\n\t$old_file = $old_message = $old_date = '';\n\n\tif ( isset( $submission['DATA'] ) )\n\t{\n\t\t$data = unserialize( $submission['DATA'] );\n\n\t\t$old_file = issetVal( $data['files'][0], '' );\n\n\t\t$old_file = GetAssignmentFileLink( $old_file );\n\n\t\t$old_message = $data['message'];\n\n\t\t$old_date = ProperDateTime( $data['date'], 'short' );\n\t}\n\n\t// Check if Assignment can be submitted (TODAY <= DUE_DATE) or (!DUE_DATE && TODAY > User MP END_DATE).\n\n\tif (  ( $assignment['DUE_DATE']\n\t\t&& DBDate() > $assignment['DUE_DATE'] )\n\t\t|| ( ! $assignment['DUE_DATE']\n\t\t\t&& DBDate() > GetMP( UserMP(), 'END_DATE' ) ) )\n\t{\n\t\tif ( $old_file )\n\t\t{\n\t\t\t// Display assignment file.\n\t\t\tDrawHeader(\n\t\t\t\tNoInput( $old_file, _( 'File' ) ),\n\t\t\t\tNoInput( $old_date, _( 'Submission date' ) )\n\t\t\t);\n\t\t}\n\n\t\tif ( $old_message )\n\t\t{\n\t\t\t// Display assignment message.\n\t\t\tDrawHeader( $old_message . $message .\n\t\t\t\tFormatInputTitle( _( 'Message' ), '', false, '' ) );\n\t\t}\n\n\t\techo ErrorMessage( [ _( 'Submissions for this assignment are closed.' ) ], 'note' );\n\n\t\treturn false;\n\t}\n\n\t// File upload.\n\t$file_html = '<div id=\"submission_file_input\"' . ( $old_file ? 'class=\"hide\"' : '' ) . '>' .\n\tFileInput(\n\t\t'submission_file',\n\t\t_( 'File' ),\n\t\t( $old_file ? 'disabled' : '' )\n\t) . '</div>';\n\n\tif ( $old_file )\n\t{\n\t\t// Delete file icon.\n\t\t$old_file = button(\n\t\t\t'remove',\n\t\t\t'',\n\t\t\t'\"#!\" onclick=\"$(\\'#submission_file_link\\').hide(); $(\\'#submission_file_input\\').show();$(\\'#submission_file\\').prop(\\'disabled\\', false);\"'\n\t\t) . ' ' . $old_file;\n\n\t\t$old_file = '<div id=\"submission_file_link\">' . NoInput( $old_file, _( 'File' ) ) . '</div>';\n\t}\n\n\t// Input div onclick only if old file.\n\tDrawHeader(\n\t\t$old_file ? $old_file . '<br />' . $file_html : $file_html,\n\t\t$old_date ? NoInput( $old_date, _( 'Submission date' ) ) : ''\n\t);\n\n\t// HTML message (TinyMCE).\n\tDrawHeader( TinyMCEInput( $old_message, 'message', _( 'Message' ) ) );\n\n\techo '<br /><div class=\"center\">' . SubmitButton( _( 'Submit Assignment' ), 'submit_assignment' ) . '</div>';\n\n\treturn true;\n}\n\n\n/**\n * Student Assignment Draw Headers with details\n *\n * @since 4.5\n * @since 10.6 Truncate Assignment Title & Category to 36 chars only if has words > 36 chars\n *\n * @param array $assignment Assignment details array\n */\nfunction StudentAssignmentDrawHeaders( $assignment )\n{\n\tif ( ! $assignment\n\t\t|| ! is_array( $assignment ) )\n\t{\n\t\treturn;\n\t}\n\n\t// Past due, in red.\n\t$due_date = $assignment['DUE_DATE'] ? MakeAssignmentDueDate( $assignment['DUE_DATE'] ) : _( 'N/A' );\n\n\t$assigned_date = $assignment['ASSIGNED_DATE'] ? ProperDate( $assignment['ASSIGNED_DATE'] ) : _( 'N/A' );\n\n\t// Display Assignment details.\n\t// Due date - Assigned date.\n\tDrawHeader(\n\t\t_( 'Due Date' ) . ': <b>' . $due_date . '</b>',\n\t\t_( 'Assigned Date' ) . ': <b>' . $assigned_date . '</b>'\n\t);\n\n\t// Course - Teacher.\n\tDrawHeader(\n\t\t_( 'Course Title' ) . ': <b>' . $assignment['COURSE_TITLE'] . '</b>',\n\t\t_( 'Teacher' ) . ': <b>' . GetTeacher( $assignment['STAFF_ID'] ) . '</b>'\n\t);\n\n\t$type_color = '';\n\n\tif ( $assignment['ASSIGNMENT_TYPE_COLOR'] )\n\t{\n\t\t$type_color = '<span style=\"background-color: ' .\n\t\t\tAttrEscape( $assignment['ASSIGNMENT_TYPE_COLOR'] ) . ';\">&nbsp;</span>&nbsp;';\n\t}\n\n\t// Truncate title to 36 chars only if has words > 36 chars.\n\t// Split on spaces.\n\t$title_words = explode( ' ', $assignment['TITLE'] );\n\n\t$truncate = false;\n\n\tforeach ( $title_words as $title_word )\n\t{\n\t\tif ( mb_strlen( $title_word ) > 36 )\n\t\t{\n\t\t\t$truncate = true;\n\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t$title = ! $truncate ?\n\t\t$assignment['TITLE'] :\n\t\t'<span title=\"' . AttrEscape( $assignment['TITLE'] ) . '\">' . mb_substr( $assignment['TITLE'], 0, 33 ) . '...</span>';\n\n\t// Truncate category to 36 chars only if has words > 36 chars.\n\t// Split on spaces.\n\t$category_words = explode( ' ', $assignment['CATEGORY'] );\n\n\t$truncate = false;\n\n\tforeach ( $category_words as $category_word )\n\t{\n\t\tif ( mb_strlen( $category_word ) > 36 )\n\t\t{\n\t\t\t$truncate = true;\n\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t$category = ! $truncate ?\n\t\t$assignment['CATEGORY'] :\n\t\t'<span title=\"' . AttrEscape( $assignment['CATEGORY'] ) . '\">' . mb_substr( $assignment['CATEGORY'], 0, 33 ) . '...</span>';\n\n\t// Title - Type.\n\tDrawHeader(\n\t\t_( 'Title' ) . ': <b>' . $title,\n\t\t_( 'Category' ) . ': <b>' . $type_color . $category . '</b>'\n\t);\n\n\t// @since 4.4 Assignment File.\n\t$file_header = $assignment['FILE'] ?\n\t\t_( 'File' ) . ': ' . GetAssignmentFileLink( $assignment['FILE'] ) :\n\t\t'';\n\n\t// Points.\n\tDrawHeader(\n\t\t_( 'Points' ) . ': <b>' . $assignment['POINTS'] . '</b>',\n\t\t$file_header\n\t);\n\n\tif ( $assignment['DESCRIPTION'] )\n\t{\n\t\t// Description.\n\t\techo $assignment['DESCRIPTION'];\n\t}\n}\n\n\n/**\n * Get Assignment details from DB.\n *\n * @example $assignment = GetAssignment( $assignment_id );\n *\n * @since 2.9\n * @since 4.4 Adapt function for Teachers (no Student).\n * @since 10.7 Check Assignment is in current MP\n *\n * @param  string        $assignment_id Assignment ID.\n * @return boolean|array Assignment details array or false.\n */\nfunction GetAssignment( $assignment_id )\n{\n\t/**\n\t * @var array\n\t */\n\tstatic $assignment = [];\n\n\tif ( isset( $assignment[$assignment_id] ) )\n\t{\n\t\treturn $assignment[$assignment_id];\n\t}\n\n\t// Check Assignment ID is int > 0.\n\tif ( (string) (int) $assignment_id != $assignment_id\n\t\t|| $assignment_id < 1 )\n\t{\n\t\treturn false;\n\t}\n\n\t$where_user = \"1\";\n\n\tif ( User( 'PROFILE' ) === 'teacher' )\n\t{\n\t\t$where_user = \"WHERE ga.STAFF_ID='\" . User( 'STAFF_ID' ) . \"'\n\t\t\tAND c.COURSE_ID=gat.COURSE_ID\n\t\t\tAND (ga.COURSE_PERIOD_ID IS NULL OR ga.COURSE_PERIOD_ID='\" . UserCoursePeriod() . \"')\n\t\t\tAND (ga.COURSE_ID IS NULL OR ga.COURSE_ID=c.COURSE_ID)\";\n\t}\n\telseif ( UserStudentID() )\n\t{\n\t\t$where_user = \",schedule ss WHERE ss.STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND ss.SYEAR='\" . UserSyear() . \"'\n\t\t\tAND ss.SCHOOL_ID='\" . UserSchool() . \"'\n\t\t\tAND ss.MARKING_PERIOD_ID IN (\" . GetAllMP( 'QTR', UserMP() ) . \")\n\t\t\tAND (ga.COURSE_PERIOD_ID IS NULL OR ss.COURSE_PERIOD_ID=ga.COURSE_PERIOD_ID)\n\t\t\tAND (ga.COURSE_ID IS NULL OR ss.COURSE_ID=ga.COURSE_ID)\n\t\t\tAND (ga.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=ga.ASSIGNED_DATE)\n\t\t\tAND ( ga.DUE_DATE IS NULL\n\t\t\t\tOR ( ga.DUE_DATE>=ss.START_DATE\n\t\t\t\t\tAND ( ss.END_DATE IS NULL OR ga.DUE_DATE<=ss.END_DATE ) ) )\n\t\t\tAND c.COURSE_ID=ss.COURSE_ID\";\n\t}\n\n\t$assignment_sql = \"SELECT ga.ASSIGNMENT_ID, ga.STAFF_ID, ga.COURSE_PERIOD_ID, ga.COURSE_ID,\n\t\tga.TITLE, ga.ASSIGNED_DATE, ga.DUE_DATE, ga.POINTS,\n\t\tga.DESCRIPTION, ga.FILE, ga.SUBMISSION, c.TITLE AS COURSE_TITLE,\n\t\tgat.TITLE AS CATEGORY, gat.COLOR AS ASSIGNMENT_TYPE_COLOR\n\t\tFROM gradebook_assignments ga,courses c,gradebook_assignment_types gat\n\t\t\" . $where_user .\n\t\t\" AND ga.ASSIGNMENT_ID='\" . (int) $assignment_id . \"'\n\t\tAND gat.ASSIGNMENT_TYPE_ID=ga.ASSIGNMENT_TYPE_ID\n\t\tAND ga.MARKING_PERIOD_ID='\" . UserMP() . \"'\"; // Why not?\n\n\t$assignment_RET = DBGet( $assignment_sql, [], [ 'ASSIGNMENT_ID' ] );\n\n\t$assignment[$assignment_id] = isset( $assignment_RET[$assignment_id] ) ?\n\t$assignment_RET[$assignment_id][1] : false;\n\n\treturn $assignment[$assignment_id];\n}\n\n/**\n * @param $assignment_id\n * @param $student_id\n */\nfunction GetAssignmentSubmission( $assignment_id, $student_id )\n{\n\t// Check Assignment ID is int > 0 & Student ID.\n\n\tif ( ! $assignment_id\n\t\t|| (string) (int) $assignment_id !== $assignment_id\n\t\t|| $assignment_id < 1\n\t\t|| ! $student_id )\n\t{\n\t\treturn false;\n\t}\n\n\t$submission_sql = \"SELECT DATA\n\t\tFROM student_assignments\n\t\tWHERE ASSIGNMENT_ID='\" . (int) $assignment_id . \"'\n\t\tAND STUDENT_ID='\" . (int) $student_id . \"'\";\n\n\t$submission_RET = DBGet( $submission_sql );\n\n\treturn isset( $submission_RET[1] ) ? $submission_RET[1] : false;\n}\n\n/**\n * Get `AssignmentsFiles/` folder full path\n *\n * @example $assignments_path = GetAssignmentsFilesPath( $assignment['STAFF_ID'] );\n *\n * @global $AssignmentsFilesPath\n * @since 2.9\n *\n * @param  string $teacher_id                                                                Teacher ID.\n * @return string AssignmentsFiles/[School_Year]/Quarter[1,2,3,4...]/Teacher[teacher_ID]/\n */\nfunction GetAssignmentsFilesPath( $teacher_id )\n{\n\tglobal $AssignmentsFilesPath;\n\n\tif ( ! $teacher_id )\n\t{\n\t\treturn $AssignmentsFilesPath;\n\t}\n\n\t// File path = AssignmentsFiles/[School_Year]/Quarter[1,2,3,4...]/Teacher[teacher_ID]/.\n\n\treturn $AssignmentsFilesPath . UserSyear() . '/Quarter' . UserMP() . '/Teacher' . $teacher_id . '/';\n}\n\n\n/**\n * Upload Assignment Teacher File\n * Delete any existing file.\n *\n * @since 4.4\n *\n * @param int    $teacher_id    Teacher staff ID.\n * @param int    $assignment_id Assignment ID.\n * @param string $file_input_id File input ID.\n *\n * @return string File full path.\n */\nfunction UploadAssignmentTeacherFile( $assignment_id, $teacher_id, $file_input_id )\n{\n\tglobal $error;\n\n\t$assignment = GetAssignment( $assignment_id );\n\n\tif ( ! $assignment )\n\t{\n\t\treturn '';\n\t}\n\n\t$microseconds = new \\DateTime();\n\n\t// @since 9.0 Add microseconds to filename format to make it harder to predict.\n\t$microseconds = $microseconds->format( 'u' );\n\n\t// Filename = [course_title]_[assignment_ID].ext.\n\t$file_name_no_ext = no_accents( $assignment['COURSE_TITLE'] . '_' . $assignment_id . '.' . $microseconds );\n\n\tif ( ! empty( $assignment['FILE'] )\n\t\t&& file_exists( $assignment['FILE'] ) )\n\t{\n\t\t// Delete existing Assignment File.\n\t\tunlink( $assignment['FILE'] );\n\t}\n\n\t$assignments_path = GetAssignmentsFilesPath( User( 'STAFF_ID' ) );\n\n\t// Upload file to AssignmentsFiles/[School_Year]/Teacher[teacher_ID]/Quarter[1,2,3,4...]/.\n\t$file = FileUpload(\n\t\t$file_input_id,\n\t\t$assignments_path,\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\treturn $file;\n}\n\n\nfunction StudentAssignmentsListOutput()\n{\n\t// TODO: get Assignment type color!\n\t$assignments_sql = \"SELECT ga.ASSIGNMENT_ID,ga.STAFF_ID,ga.COURSE_PERIOD_ID,ga.COURSE_ID,\n\t\tga.ASSIGNMENT_TYPE_ID,ga.TITLE,ga.ASSIGNED_DATE,ga.DUE_DATE,ga.POINTS,ga.SUBMISSION,\n\t\tc.TITLE AS COURSE_TITLE,\n\t\t(SELECT 1\n\t\t\tFROM student_assignments sa\n\t\t\tWHERE ga.ASSIGNMENT_ID=sa.ASSIGNMENT_ID\n\t\t\tAND sa.STUDENT_ID=ss.STUDENT_ID) AS SUBMITTED\n\t\tFROM gradebook_assignments ga, schedule ss, courses c, course_periods cp\n\t\tWHERE ss.STUDENT_ID='\" . UserStudentID() . \"'\n\t\tAND ss.SYEAR='\" . UserSyear() . \"'\n\t\tAND ss.SCHOOL_ID='\" . UserSchool() . \"'\n\t\tAND ga.MARKING_PERIOD_ID='\" . UserMP() . \"'\n\t\tAND ss.MARKING_PERIOD_ID IN (\" . GetAllMP( 'QTR', UserMP() ) . \")\n\t\tAND (ga.COURSE_PERIOD_ID IS NULL OR ss.COURSE_PERIOD_ID=ga.COURSE_PERIOD_ID)\n\t\tAND (ga.COURSE_ID IS NULL OR ss.COURSE_ID=ga.COURSE_ID)\n\t\tAND ga.STAFF_ID=cp.TEACHER_ID\n\t\tAND cp.COURSE_ID=c.COURSE_ID\n\t\tAND cp.COURSE_PERIOD_ID=ss.COURSE_PERIOD_ID\n\t\tAND (ga.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=ga.ASSIGNED_DATE)\n\t\tAND ( ga.DUE_DATE IS NULL\n\t\t\tOR ( ga.DUE_DATE>=ss.START_DATE\n\t\t\t\tAND ( ss.END_DATE IS NULL OR ga.DUE_DATE<=ss.END_DATE ) ) )\n\t\tAND c.COURSE_ID=ss.COURSE_ID\n\t\tORDER BY ga.SUBMISSION, ga.DUE_DATE\";\n\n\t$assignments_RET = DBGet(\n\t\tDBQuery( $assignments_sql ),\n\t\t[\n\t\t\t'TITLE' => 'MakeAssignmentTitle',\n\t\t\t'STAFF_ID' => 'GetTeacher',\n\t\t\t'DUE_DATE' => 'MakeAssignmentDueDate',\n\t\t\t'ASSIGNED_DATE' => 'ProperDate',\n\t\t\t'SUBMITTED' => 'MakeAssignmentSubmitted',\n\t\t]\n\t);\n\n\t$columns = [\n\t\t'TITLE' => _( 'Title' ),\n\t\t'DUE_DATE' => _( 'Due Date' ),\n\t\t'ASSIGNED_DATE' => _( 'Assigned Date' ),\n\t\t'COURSE_TITLE' => _( 'Course Title' ),\n\t\t'STAFF_ID' => _( 'Teacher' ),\n\t\t'SUBMITTED' => _( 'Submitted' ),\n\t];\n\n\t$LO_options = [\n\t\t'save' => false,\n\t];\n\n\tListOutput(\n\t\t$assignments_RET,\n\t\t$columns,\n\t\t_( 'Assignment' ),\n\t\t_( 'Assignments' ),\n\t\t[],\n\t\t[],\n\t\t$LO_options\n\t);\n\n\treturn true;\n}\n\nif ( ! function_exists( 'MakeAssignmentTitle' ) )\n{\n\t/**\n\t * Make Assignment title and link.\n\t *\n\t * @global $THIS_RET current row from DBGet.\n\t * @since 4.1 Override this function in your custom module or plugin.\n\t *\n\t * @param  string $value  Title value.\n\t * @param  string $column Column, 'TITLE'.\n\t * @return Title  and link.\n\t */\n\tfunction MakeAssignmentTitle( $value, $column )\n\t{\n\t\tglobal $THIS_RET;\n\n\t\tif ( ! empty( $_REQUEST['LO_save'] ) )\n\t\t{\n\t\t\t// Export list.\n\t\t\treturn $value;\n\t\t}\n\n\t\t// Truncate value to 36 chars.\n\t\t$title = mb_strlen( $value ) <= 36 ?\n\t\t$value :\n\t\t'<span title=\"' . AttrEscape( $value ) . '\">' . mb_substr( $value, 0, 33 ) . '...</span>';\n\n\t\tif ( User( 'PROFILE' ) === 'teacher' )\n\t\t{\n\t\t\t$view_assignment_link = 'Modules.php?modname=Grades/Assignments.php';\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$view_assignment_link = 'Modules.php?modname=Grades/StudentAssignments.php';\n\t\t}\n\n\t\tif ( ! empty( $THIS_RET['ASSIGNMENT_ID'] ) )\n\t\t{\n\t\t\t$view_assignment_link .= '&assignment_id=' . $THIS_RET['ASSIGNMENT_ID'];\n\t\t}\n\n\t\tif ( ! empty( $THIS_RET['MARKING_PERIOD_ID'] ) )\n\t\t{\n\t\t\t// @since 3.9 Add MP to outside links (see Portal), so current MP is correct.\n\t\t\t$view_assignment_link .= '&marking_period_id=' . $THIS_RET['MARKING_PERIOD_ID'];\n\t\t}\n\n\t\treturn '<a href=\"' . URLEscape( $view_assignment_link ) . '\">' . $title . '</a>';\n\t}\n}\n\n/**\n * @param $value\n * @param $column\n * @return mixed\n */\nfunction MakeAssignmentDueDate( $value, $column = 'DUE_DATE' )\n{\n\t$due_date = ProperDate( $value );\n\n\tif ( $value\n\t\t&& $value <= DBDate() )\n\t{\n\t\t// Past due, in red.\n\t\t$due_date = '<span style=\"color:red;\">' . $due_date . '</span>';\n\t}\n\n\treturn $due_date;\n}\n\n/**\n * @param $value\n * @param $column\n * @return mixed\n */\nfunction MakeAssignmentSubmitted( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! isset( $THIS_RET['SUBMISSION'] )\n\t\t|| $THIS_RET['SUBMISSION'] !== 'Y' )\n\t{\n\t\treturn '';\n\t}\n\n\treturn $value ? button( 'check' ) : button( 'x' );\n}\n\n\n/**\n * Make Student Assignment Submission View\n *\n * DBGet callback\n *\n * @since 4.2\n *\n * @param string $value\n * @param string $column 'SUBMISSION'\n * @return string Column HTML.\n */\nfunction MakeStudentAssignmentSubmissionView( $value, $column )\n{\n\tglobal $THIS_RET,\n\t\t$submission_column_html;\n\n\t$student_id = UserStudentID() ? UserStudentID() : $THIS_RET['STUDENT_ID'];\n\n\t$submission = GetAssignmentSubmission( $THIS_RET['ASSIGNMENT_ID'], $student_id );\n\n\t$submission_column_html = button( 'x' );\n\n\tif ( $value !== 'Y' )\n\t{\n\t\t$submission_column_html = '';\n\t}\n\n\tif ( $submission )\n\t{\n\t\t$data = unserialize( $submission['DATA'] );\n\n\t\t$file = issetVal( $data['files'][0], '' );\n\n\t\t$message = $data['message'];\n\n\t\t$date = ProperDateTime( $data['date'], 'short' );\n\n\t\t$submission_column_html = '<a class=\"colorboxinline\" href=\"#submission' . $THIS_RET['ASSIGNMENT_ID'] . '-' . $student_id . '\">\n\t\t<img src=\"assets/themes/' . Preferences( 'THEME' ) . '/btn/visualize.png\" class=\"button bigger\" /> ' .\n\t\t_( 'View Online' ) . '</a>';\n\n\t\t$file_html = $message_html = '';\n\n\t\tif ( $file )\n\t\t{\n\t\t\t$file_html = NoInput( GetAssignmentFileLink( $file ), _( 'File' ) ) . '<br />';\n\t\t}\n\n\t\tif ( $message )\n\t\t{\n\t\t\t$message_html = $message . FormatInputTitle( _( 'Message' ), '', false, '' );\n\t\t}\n\n\t\t$submission_column_html .= '<div class=\"hide\">\n\t\t\t<div id=\"submission' . $THIS_RET['ASSIGNMENT_ID'] . '-' . $student_id . '\">' .\n\t\t\tNoInput( $date, _( 'Submission date' ) ) . '<br />' .\n\t\t\t$file_html .\n\t\t\t$message_html .\n\t\t\t'</div></div>';\n\n\t\treturn $submission_column_html;\n\t}\n\n\t/**\n\t * Do action hook\n\t * Assignment Grades Submission column.\n\t *\n\t * Submission Column HTML is a global var so it can be filtered.\n\t *\n\t * @since 4.2\n\t */\n\tdo_action( 'Grades/includes/StudentAssignments.fnc.php|grades_submission_column' );\n\n\treturn $submission_column_html;\n}\n\n\n/**\n * @param $file_path\n */\nfunction GetAssignmentFileLink( $file_path )\n{\n\tif ( ! file_exists( $file_path ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name = mb_substr( mb_strrchr( $file_path, '/' ), 1 );\n\n\t$file_size = HumanFilesize( filesize( $file_path ) );\n\n\treturn button(\n\t\t'download',\n\t\t_( 'Download' ),\n\t\t'\"' . URLEscape( $file_path ) . '\" target=\"_blank\" title=\"' . AttrEscape( $file_name . ' (' . $file_size . ')' ) . '\"',\n\t\t'bigger'\n\t);\n}\n"], "fixing_code": ["# CHANGES\n## RosarioSIS Student Information System\n\nChanges in 10.8.2\n-----------------\n- PHP<7 Fix add microseconds to filename to make it harder to predict in StudentAssignments.fnc.php, thanks to @jeffreygaor\n\nChanges in 10.8.1\n-----------------\n- Use CheckBoxOnclick() in StudentBalances.php & Schedule.inc.php\n- Fix SQL error when Quarter with Assignments is deleted in Portal.php\n- SQL Check requested assignment belongs to current Marking Period in Assignments.php\n- MySQL + MariaDB < 10.5 fix FOREIGN KEY constraint syntax in rosariosis_mysql.sql\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in CreateParents.php\n- Fix SQL error cast attendance code to integer in TakeAttendance.php\n- Fix hide Contact Fields according to Emergency/Custody settings in Address.inc.php\n- Fix MultipleCheckboxInput() save all unchecked, add hidden empty checkbox in Inputs.php\n\nChanges in 10.8\n---------------\n- Fix MySQL Periods list in MasterScheduleReport.php\n- SQL explicitly list all columns instead of `SELECT *` in MenuItems.php, Menus.php, EditHistoryMarkingPeriods.php, EditReportcardGrades.php, ReportCardCommentCodes.php, ReportCardComments.php & ReportCardGrades.php\n- Add & use DBSQLCommaSeparatedResult() function (SQL result as comma separated list) in database.inc.php, Dashboard.inc.php, MasterScheduleReport.php & Export.php\n- HTML email input remove pattern, add maxlength in PasswordReset.php, StudentsUsersInfo.fnc.php, NotifyParents.php, CreateParents.php & General_Info.inc.php, Other_Info.inc.php\n- JS Fix #319 Try a full match first to identify selected menu link in warehouse.js\n- Spanish translation add \u00bf character before questions in rosariosis.po\n- HTML add \"Check All\" checkbox after Periods in AddAbsences.php\n- Truncate Assignment title to 36 chars in AnomalousGrades.php\n- SQL resources table: Add PUBLISHED_PROFILES & PUBLISHED_GRADE_LEVELS columns in Update.fnc.php, rosariosis.sql & rosariosis_mysql.sql\n- Add Resource Visibility options in Resources.php\n- Move Resources functions to separate file & rename them in Resources.php & Resources.fnc.php\n- Update French & Spanish translations in rosariosis.po\n- CSS Fix Select2 dropdown hidden when inside colorBox (has z-index 9999) in stylesheet.css\n\nChanges in 10.7.1\n-----------------\n- Fix SQL limit School Periods to Course Period in AddAbsences.php\n\nChanges in 10.7\n---------------\n- CSS add Select2 styles in stylesheet.css & colors.css\n- JS add Select2 jQuery plugin in assets/js/jquery-select2/\n- Add Select2Input() function in Inputs.php\n- Use Select2 instead of Chosen, fixes the overflow issue in Widget.php, MakeReferral.php, Transcripts.fnc.php & Address.inc.php\n- Fix PHP8.2 deprecated Creation of dynamic property in Markdownify/ConverterExtra.php\n- SQL always add space before AND to $extra['WHERE'], program wide\n- Escape SanitizeHTML() & SanitizeMarkDown() before saving to DB, program wide\n- Always use UserStudentID() instead of `$_SESSION['STUDENT_ID']` in PortalPollsNotes.php\n- SQL use EXISTS(SELECT 1) instead of `EXISTS(SELECT *)` in EditReportCardGrades.php, Rollover.php & Moodle/functions.php\n- Remove trailing seconds :00 & add sorting HTML comment to datetime in Date.php\n- HTML set max Event Repeat Days to 300 in Calendar.php\n- Only display Locked column if AllowEdit() in Schedule.php\n- Schedule table: rename Periods column to Period (singular) in PrintSchedules.php & Schedule.inc.php\n- HTML add padding to Assignment options + remove useless table in Grades/Configuration.php\n- Move \"Remove required attribute, TinyMCE bug\" fix to TextAreaInput() in Inputs.php\n- Only display profiles w/Custom if actually used to gain space in PortalPollsNotes.php\n- Add & remove module icons in themes/FlatSIS/modules/\n- Add .dotx,.ppsx,.mdb,.sldx,.odg,.odc,.odb,.odf,.numbers,.pages,.m4a,.tsv,.json,.ics file extensions to whitelist in FileUpload.fnc.php\n- ROLL Gradebook Config's Final Grading Percentages for Admin (overridden) in Rollover.php\n- HTML responsive limit display columns to 3 in Courses.php & Assignments.php\n- SQL remove Period Length<=(Minutes in a Full School Day / 2) for Teacher's Schedule table in Schedule.inc.php\n- SQL include Secondary Teacher Course Periods in Schedule.inc.php\n- HTML move Schedule list inside PopTable & rework table cell in Schedule.inc.php\n- Fix do not display \"Enroll student for next school year\" link if new enrollment record in Enrollment.inc.php\n- Add Class Average row in ReportCards.fnc.php & Grades.fnc.php\n- Fix HTML5 notice Trailing slash on void elements has no effect, but keep `<br />` for `$_ROSARIO['SearchTerms']`, program wide\n- Fix regression since 9.0 show Student Photo in Transcripts.fnc.php\n- Check Assignment is in current MP in StudentAssignments.php & StudentAssignments.fnc.php\n- Corrections for French translation in rosariosis.po\n- CSS FlatSIS .list & .postbox headers adjustments for Chrome in stylesheet.css\n- CSS reduce File input size when inside list in stylesheet.css\n- CSS responsive increase max input size when inside list in zresponsive.css\n- CSS fix Student Comments margin & padding in stylesheet.css\n- Fix regression display Mailing Labels in ReportCards.fnc.php\n- Add Student Photo in ReportCards.fnc.php\n- Fix SQL error ORDER BY for Expanded View + Contact Information in GetStuList.fnc.php\n\nChanges in 10.6.3\n-----------------\n- Fix regression Teacher can save config even if overridden by Admin in Grades/Configuration.php\n- Prevent double encoding single quote (`&#039;`), was encoded by SanitizeHTML() or SanitizeMarkDown() in Inputs.php\n\nChanges in 10.6.2\n-----------------\n- Do not truncate value on List export in Accounting/functions.inc.php, Grades.php, StudentGrades.php, StudentAsignments.fnc.php, Resources.php & Student_Billing/functions.inc.php\n- SQL performance use POSITION()>0 instead of LIKE, program wide\n- SQL remove useless ID='' check in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Fix hide File input if cannot edit in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- Fix SQL use JOIN instead of WHERE EXISTS for Discipline Widgets in Widget.php\n- MySQL fix PHP fatal error when updating Course's Marking Period in Courses.php\n- Fix #338 Only check against Course Periods having overlapping Marking Period in Courses.fnc.php\n\nChanges in 10.6.1\n-----------------\n- PostgreSQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric (exact) in rosariosis.sql, thanks to @fatahou\n- MySQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric(22,16) (exact) in rosariosis_mysql.sql, thanks to @fatahou\n- SQL Fix regression since 10.0, change sum/cum factors & credit_attempted/earned columns type from double precision to numeric in Update.fnc.php\n- Fix Grades input not displaying for Teachers in Widget.php\n- Raise minimum PHP version from 5.4.45 to 5.5.9 in INSTALL.md, README.md, composer.json, diagnostic.php & Portal.php\n- Fix close PopTable wrapper `<div>` in Enrollment.inc.php, General_Info.inc.php, Medical.inc.php & Schedule.inc.php\n\nChanges in 10.6\n---------------\n- Add Pashto to right-to-left languages in Warehouse.php, Inputs.php & PDF.php\n- CSS FixedMenu bug when menu hidden in stylesheet.css\n- Fix JPG image rotation in ImageResizeGD.php\n- Resize, compress & store image using ImageUpload() in FileUpload.fnc.php\n- Fix remove `<span>` HTML tag from Assignment Type in select in Grades.php\n- Truncate Assignment Type to 36 chars only if has words > 36 chars in ProgressReports.php & StudentAssignments.fnc.php\n- Truncate Assignment title to 36 chars in StudentGrades.php\n- CSS Do NOT use global word-break. Use it only on specific elements in stylesheet.css & zresponsive.css\n- CSS responsive Fix list overflow-x scroll inside div.st in stylesheet.css\n- CSS set max-width for City & State select in Address.inc.php\n- Security fix for dynamic include in index.php\n- Fix SQL limit 1 when adding existing Contact in Address.inc.php\n- CSS responsive add .postbox-wrapper class for overflow-x scroll in PopTable.fnc.php & stylesheet.css\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in AssignOtherInfo.php\n\nChanges in 10.5.2\n-----------------\n- Fix PHP8.1 Fatal error when $options is null in StudentsUsersInfo.fnc.php\n- Remove .00 decimal from value of numeric type in Substitutions.fnc.php\n- Truncate Assignment title to 36 chars only if has words > 36 chars in ProgressReports.php, Assignments.php & MassCreateAssignments.php\n- Truncate Assignment title to 36 chars in GradebookBreakdown.php & Grades.php\n- CSS responsive fix List column title prevent word breaking in zresponsive.css\n- Fix photo use mime types, not file extensions so mobile browsers allow camera in General_Info.inc.php & MenuItems.php\n- Fix return processed image upload in case source type != target type in FileUpload.fnc.php\n\nChanges in 10.5.1\n-----------------\n- Fix MySQL error Unknown system variable 'storage_engine' in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.5\n---------------\n- JS responsive add minWidth & minHeight options to inline colorBox in jquery-colorbox.js & warehouse.js\n- Trim white spaces for Contact name & Address fields in RegistrationSave.fnc.php & Address.inc.php\n- Save Student Files fields, upload files in RegistrationSave.fnc.php\n- CSS Do not break text inside button in stylesheet.css\n- CSS responsive raise max-width for mobile & vertical tablet from 736 to 874px in zresponsive.css, rtl.css & colors.css\n- HTML fix responsive table & weekdays in Calendars.php\n- CSS responsive reduce select max-width from 440 to 340px in stylesheet.css & zresponsive.css\n- Fix PHP8.2 utf8_decode() function deprecated in PDF.php\n- MySQL change database charset to utf8mb4 and collation to utf8mb4_unicode_520_ci in InstallDatabase.php\n\nChanges in 10.4.4\n-----------------\n- Fix AllowUse() & AllowEdit() for User Info when on Student Info in AllowEdit.fnc.php\n- CSS fix Calendar header days word-break in zresponsive.css\n- CSS style time input in stylesheet.css & colors.css\n- CSS remove padding for LO_SORT arrow in zresponsive.css\n- HTML fix responsive / stackable table for Course Periods in Courses.php\n\nChanges in 10.4.3\n-----------------\n- MySQL always use InnoDB (default), avoid MyISAM in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.4.2\n-----------------\n- Fix SQL error null value in column \"amount\" in Salaries.php\n- Fix Total row calculation, reset for each student in ReportCards.fnc.php & Transcripts.fnc.php, thanks to @fatahou\n\nChanges in 10.4.1\n-----------------\n- JS fix regression since 9.0 & DOMPurify, open links in new window in warehouse.js\n- Add Database Type and Version, add PHP version to FirstLoginPoll() in FirstLogin.fnc.php\n- Fix typos in INSTALL.md & INSTALL_fr.md\n\nChanges in 10.4\n---------------\n- Modcat is addon module, set custom module icon in Profiles.php & Exceptions.php\n- SQL performance: use NOT EXISTS instead of NOT IN + LIMIT 1000 in Portal.php\n- Add student name to Student's Absences and Grades delete prompt in MassDrops.php\n- Fix display only first letter of attendance code in AttendanceSummary.php\n- Remove \"Minimum assignment points for letter grade\" config option in Grades/Configuration.php & StudentGrades.php\n- Truncate Assignment title to 36 chars in StudentGrades.php & Grades.php\n- CSS date capitalize first letter only in stylesheet.css\n- Add optional $id param to FilesUploadUpdate() in FileUpload.fnc.php\n- JS Only show laoding spinner if file input has selected files in warehouse.js\n- Add File Attached Input for existing Fees/Payments in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Add File Attached Input for existing Salaries/Staff Payments/Incomes/Expenses in Expenses.php, Incomes.php, Salaries, StaffPayments.php & Accounting/functions.inc.php\n- Add-ons can add their custom Widgets in classes/core/Widgets.php & classes/core/StaffWidgets.php\n- Add Widgets init action hook in Actions.php & Widgets.fnc.php\n- Add Staff Widgets init action hook in Actions.php & StaffWidgets.fnc.php\n- Fix SQL check student is actually enrolled in Enrollment.fnc.php\n- Fix date is 1969-12-31 on Windows when PHP intl ext not activated in strftime_compat.php\n\nChanges in 10.3.3\n-----------------\n- SQL ORDER BY END_DATE IS NULL DESC,END_DATE DESC (nulls first) for consistency between PostgreSQL & MySQL in User.fnc.php\n- Fix PostgreSQL error column \"students_join_people.address_id\" must appear in the GROUP BY clause in Address.inc.php\n\nChanges in 10.3.2\n-----------------\n- Fix PostgreSQL error ORDER BY \"full_name\" is ambiguous in DailyTransactions.php\n\nChanges in 10.3.1\n-----------------\n- Fix MySQL error result as comma separated list in Export.php\n- Add recommended php.ini setting session.gc_maxlifetime = 3600 in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.3\n---------------\n- Add \"Cumulative Balance over school years\" checkbox in StudentBalances.php\n- Fix program not found when query string is URL encoded in Modules.php\n- JS fix add new Period below existing Period row in Courses.php\n- Add \"Course Periods\" checkbox in Rollover.php\n- Fix MySQL error 1069 Too many keys specified; max 64 keys allowed in Fields.fnc.php & DisciplineForm.php\n\nChanges in 10.2.3\n-----------------\n- Remove dead link to centresis.org in index.php\n- Fix MySQL error TEXT column used in key specification without a key length in Fields.fnc.php & DisciplineForm.php\n- Add ROLLOVER_ID column to User() in User.fnc.php\n- Get template from last school year (rollover ID) in Template.fnc.php\n\nChanges in 10.2.2\n-----------------\n- Fix PHP fatal error undefined function StudentCanEnrollNextSchoolYear() in PrintStudentInfo.php\n- Set school logo with to 120px in PrintStudentInfo.php\n\nChanges in 10.2.1\n-----------------\n- SQL order by Marking Period Start Date in MarkingPeriods.php, ReportCards.fnc.php, Courses.php, Schedule.php, PrintSchedules.php, MassSchedule.php, MassDrops.php & Side.php\n- Maintain current month on calendar change in Calendar.php\n- Maintain Calendar when closing event popup in Calendar.php\n- CSS FlatSIS smaller font size for Calendar Event title in stylesheet.css\n- Fix SQL error mysqli_fetch_assoc(): Argument 1 must be of type mysqli_result, null given in database.inc.php & StudentsUsersInfo.fnc.php\n- When -Edit- option selected, change the auto pull-down to text field in StudentsUsersInfo.fnc.php\n- HTML remove bold for \"Other students associated with this address/person\" in Address.inc.php\n- SQL order by FULL_NAME (Display Name config option) in PortalPollNotes.fnc.php, Widget.php, GetStaffList.fnc.php, GetStuList.fnc.php, Transcripts.fnc.php, Courses.php, MassRequests.php, ScheduleReport.php & Address.inc.php\n- CSS fix Report Cards PDF columns size when long comments text in ReportCards.fnc.php & stylesheet_wkhtmltopdf.css\n- CSS Add .grade-minmax-wrap,.grade-minmax-min,.grade-minmax-grade & .grade-minmax-max classes & avoid breaking grades in stylesheet.css & ReportCards.fnc.php\n- Fix get Min. Max. grades for students in distinct grade levels in FinalGrades.php\n- Fix SQL syntax error since 10.0 in Administration.php\n- CSS Do not break words inside lists in stylesheet.css\n- SQL handle case when student dropped and then later re-enrolled in course in DuplicateAttendance.php\n- Use DBEscapeIdentifier() for Gradebook ASSIGNMENT_SORTING in Assignments.php, GradebookBreakdown.php & Grades.php\n\nChanges in 10.2\n---------------\n- Add StudentCanEnrollNextSchoolYear() & StudentEnrollNextSchoolYear() functions in Enrollment.fnc.php\n- Add \"Enroll student for next school year\" in Enrollment.inc.php\n- Translate \"Enroll student for next school year\" to French & Spanish in rosariosis.po\n- MySQL fix character encoding when translating database in InstallDatabase.php\n\nChanges in 10.1\n---------------\n- Fix MySQL 5.6 syntax error when WHERE without FROM clause, use dual table in TakeAttendance.php, Reminders.php,  InputFinalGrades.php, Requests.php & Calendar.php\n- Add dual VIEW for compatibility with MySQL 5.6 to avoid syntax error when WHERE without FROM clause in rosariosis.sql & Update.fnc.php\n- Fix MySQL 5.6 syntax error in ORDER BY use report_card_comments table instead of dual in InputFinalGrades.php\n- Fix SQL use cast(extract(DOW) AS int) for PostrgeSQL in Calendar.php\n- Add instructions for MySQL in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.0\n---------------\n- SQL convert table names to lowercase, program wide\n- Fix delete file attached in StudentFees.php\n- Use DBEscapeIdentifier() for reserved 'column' keyword in plugins/Moodle/\n- Avoid regression due to lowercase table names: Maintain compatibility with add-ons using rollover_after action hook & `$_REQUEST['tables']` in Rollover.php\n- Use db_trans_*() functions in DeleteTransaction.fnc.php & DeleteTransactionItem.fnc.php\n- Close popup if no UserSchool in session, happens on login redirect in Warehouse.php\n- SQL order Grade Levels in StudentBreakdown.php\n- Remove semicolon before \"With\" & \"On\" values in PrintRequests.php & unfilledRequests.inc.php\n- HTML Link is selected: bold in ScheduleReport.php\n- Display Period title if no short name set in IncompleteSchedules.php\n- Fix Widget search & add Search Terms header in IncompleteSchedules.php\n- Add Schedule link & photo tooltip to Student name in Scheduling/AddDrop.php\n- HTML add a11y-hidden label to select in GPARankList.php & Attendance/TeacherCompletion.php\n- Fix unset requested dates in MassCreateAssignments.php & Assignments.php\n- Add User / Student photo tooltip in Grades/TeacherCompletion.php, GPARankList.php & EnterEligibility.php\n- SQL order by Period title in TeacherCompletion.php\n- Use Period's Short Name when > 10 columns in the list in TeacherCompletion.php\n- Add note on save in EntryTimes.php\n- Fix PHP8.1 Deprecated passing null to parameter in EmailReferral.fnc.php, CategoryBreakdown.php & StudentGrades.php\n- Add Total sum of balances in StaffBalances.php\n- Fix French translation for \"Waiver\" & \"Refund\" in rosariosis.po\n- Force title & action to lowercase in Prompts.php\n- HTML use .dashboard-module-title CSS class for module titles in Profiles.php & Exceptions.php\n- CSS set input label max-width on Search form in stylesheet.css\n- JS new default popup size: 1200x450 in warehouse.js\n- Use URLEscape() for add button link when appropriate in ListOutput.fnc.php\n- JS set Calendar date to current fields date in warehouse.js & calendar-setup.js\n- HTML add label to select in ActivityReport.php\n- Use Currency() function instead of number_format() in TransactionsReport.php\n- HTML remove line-break in Warning/Minimum columns in Reminders.php\n- HTML CSS make Daily Menus calendar coherent with School Calendar in DailyMenus.php\n- Shorten Referral email subject in EmailReferral.fnc.php\n- Use plural wise ngettext() for \"No %s were found.\" in FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Force result text to lowercase for \"No %s were found.\" in ListOutput.fnc.php, FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Prevent admin from removing own access to User Profiles program in Profiles.php\n- SQL change modname column type from text to varchar(150) to match with MySQL key index limitation in rosariosis.sql\n- SQL change program column type from text to varchar(100) NOT NULL to match with MySQL index limitation in rosariosis.sql\n- SQL change schools column type from text to varchar(150) to match with MySQL index limitation in rosariosis.sql\n- Rename YEAR_MONTH column alias to YEAR_MONTH_DATE: reserved keyword in MySQL in Dashboard.inc.php\n- SQL use DAYOFWEEK() for MySQL or cast(extract(DOW)+1 AS int) for PostrgeSQL, program wide\n- SQL cast(AS UNSIGNED) for MySQL or cast(AS INT) for PostgreSQL, program wide\n- SQL cast custom_fields ID AS char(10) instead of TEXT for MySQL compatibility in GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL rename $field COLUMN (reserved keyword) to COLUMN_NAME for MySQL compatibility in CustomFields.fnc.php, GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL remove use of nextval in rosariosis_fr.sql\n- Rename $pg_dumpPath configuration variable to $DatabaseDumpPath in config.inc.sample.php, diagnostic.php & DatabaseBackup.php\n- Build command for executing mysqldump in DatabaseBackup.php\n- SQL to extract Unix timestamp or epoch from date in Eligibility/Student.php, StudentList.php & TeacherCompletion.php\n- Install module/plugin: execute the install_mysql.sql script for MySQL in Modules.inc.php, Plugins.inc.php & modules/README.md & plugins/README.md\n- Fix typo \"inexistant\" to \"nonexistent\" & update translations in Modules.inc.php, Plugins.inc.php & rosariosis.po\n- HTML fix duplicated #menu-top div on update in Side.php\n- JS fix #body height calculation: include bottom margin in jquery-fixedmenu.js & plugins.min.js\n- Add MySQLRemoveDelimiter() remove DELIMITER $$ declarations before procedures or functions in database.inc.php, Modules.inc.php & Plugins.inc.php\n- SQL ORDER BY SORT_ORDER IS NULL,SORT_ORDER (nulls last) for consistency between PostgreSQL & MySQL, program wide\n- Rollback Fix PostgreSQL error invalid ORDER BY, only result column names can be used, program wide\n- HTML use number input for Gradebook config options in Configuration.php\n- HTML use number input for Grade points & average in ReportCardGrades.php\n- SQL limit results to current school year in AddDrop.php\n- SQL always use INTERVAL to add/subtract days to date for MySQL compatibility in Reminders.php, Transactions.php, ServeMenus.php, Assignments.php, StudentGrades.php, Rollover.php & Portal.php\n- SQL change amount columns type from numeric to numeric(14,2) NOT NULL in rosariosis.sql & StudentFees.php\n- SQL change minutes,minutes_present,points,default_points,length,count_weighted_factors,count_unweighted_factors columns type from numeric to integer in rosariosis.sql, UpdateAttendanceDaily.fnc.php, Assignments.php, MassCreateAssignments.php & Periods.php\n- SQL change gp & gpa columns type from numeric to numeric(7,2) in rosariosis.sql\n- SQL change sum/cum factors & credit_attempted/earned columns type from numeric to double precision in rosariosis.sql\n- Add Can use modname to HACKING ATTEMPT error email in ErrorMessage.fnc.php\n- Fix HACKING ATTEMPT when Grades module inactive in Portal.php & Calendar.php\n- Use GetTemplate() instead of unescaping `$_REQUEST` in CreateParents.php & NotifyParents.php\n- Use `$_POST` to get password instead of unescaping `$_REQUEST` in PasswordReset.php, Student.php & User.php\n- Use DBGetOne() instead of unescaping `$_REQUEST` in Config.fnc.php\n- Add MySQL support in database.inc.php, diagnostic.php, InstallDatabase.php & Warehouse.php\n- Add $DatabaseType configuration variable in database.inc.php, diagnostic.php, InstallDatabase.php, Warehouse.php & config.inc.php\n- Add $show_error parameter to db_start() in database.inc.php\n- Add DBUnescapeString() function in database.inc.php, GetStuList.fnc.php, ListOutput.fnc.php, PreparePHP_SELF.fnc.php & Search.fnc.php\n- PostgreSQL Date format: move query from Date.php to Warehouse.php\n- Compatibility with add-ons version < 10.0, gather CONFIG (uppercase table name) values too in Configuration.php\n- Fix MySQL error Table is specified twice, both as a target for 'INSERT' and as a separate source for data in CopySchool.php & Rollover.php\n- Fix MySQL syntax error: no table alias in DELETE in Rollover.php\n- Fix MySQL syntax error: no FROM allowed inside UPDATE, use subquery or multi-table syntax in Rollover.php\n- Fix MySQL syntax error: replace CAST (NULL AS CHAR(1)) AS CHECKBOX with NULL AS CHECKBOX in AddAbsences.php, AddActivity.php, MassDrops.php, MassRequests.php, MassSchedule.php, AddUsers.php, AssignOtherInfo.php & AddStudents.php\n- Add Installation tutorial for Mac in WHATS_NEW.md & INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Update tested on Ubuntu 18.04 to 20.04 in INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Fix SQL error when column already dropped in Fields.fnc.php\n- SQL fix CREATE INDEX on right table in rosariosis.sql\n- SQL remove unused indices for various tables in rosariosis.sql\n- SQL match index with FOREIGN KEY for various tables in rosariosis.sql\n- SQL ORDER BY fix issue when Transferring to another school & new start date is <= old start date in Enrollment.inc.php\n- Check if student already enrolled on that date when inserting START_DATE in SaveEnrollment.fnc.php\n- Add `_getAddonsSQL()` & `_configTableCheck()` functions in InstallDatabase.php\n- $DatabasePort configuration variable is now optional in config.inc.sample.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- SQL start staff_fields ID sequence at 200000000 for coherence with custom_fields in rosariosis.sql & Fields.fnc.php\n- MySQL use LONGTEXT type for textarea field in Fields.fnc.php & DisciplineForm.php\n- SQL Check requested assignment belongs to teacher in Assignments.php\n- CSS fix responsive when really long string with no space in stylesheet.css\n- Limit `$_POST` array size to a maximum of 16MB in Warehouse.php, thanks to @ahmad0x1\n- Add optional ROSARIO_POST_MAX_SIZE_LIMIT constant in Warehouse.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- Add MySQL database dump in rosariosis_mysql.sql\n- Log \"RosarioSIS HACKING ATTEMPT\" into Apache error.log in HackingLog.fnc.php\n- Force URL & menu reloading, always use JS to redirect in HackingLog.fnc.php\n- Place currency symbol after amount for some locales in Currency.fnc.php\n- SQL use timestamp type: standard & without time zone by default in rosariosis.sql\n- CSS add .accounting-totals, .accounting-staff-payroll-totals, .student-billing-totals classes in Expenses.php, Incomes.php, Salaries.php, StaffPayments.php, StudentFees.php & StudentPayments.php\n- SQL rename KEY (reserved keyword) to SORT_KEY for MySQL compatibility in Search.fnc.php, StudentFieldBreakdown.php, StudentBreakdown.php\n- SQL use GROUP BY instead of DISCTINCT ON for MySQL compatibility in Address.inc.php & EnterEligibility.php\n- SQL cast Config( 'STUDENTS_EMAIL_FIELD' ) to int when custom field in SendNotification.fnc.php, Registration.fnc.php, Moodle/getconfig.inc.php & ImportUsers.fnc.php\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in PortalPollsNotes.fnc.php, DeleteTransaction.fnc.php, DeleteTransactionItem.fnc.php, Rollover.php, CopySchool.php & AssignOtherInfo.php\n- Fix MySQL syntax error: explicitly list all columns instead of wildcard in ActivityReport.php & Statements.php\n- Fix MakeChooseCheckbox() remove parent link to sort column in Inputs.php & ListOutput.fnc.php\n- CSS WPadmin fix menu select width in stylesheet.css\n- Enrollment Start: No N/A option for new student in StudentUsersInfo.fnc.php\n\nChanges in 9.3.2\n----------------\n- Fix regression since 9.2.1 fields other type than Select Multiple from Options in CategoryBreakdownTime.php\n\nChanges in 9.3.1\n----------------\n- Fix regression since 2.9 Schedule multiple courses in plugins/Moodle/Scheduling/MassSchedule.php\n- Fix SQL to select Periods where exists CP in TeacherCompletion.php & Administration.php\n- Fix dummy day (year month date) set to 28 for February in Dashboard.inc.php\n- Fix AllowEdit for Teacher in Users/includes/General_Info.inc.php\n- Security: sanitize filename with no_accents() in Student.php, User.php & Schools.php\n- Fix \"Exclude PDF generated using the \"Print\" button\" option for the PDF Header Footer plugin in Bottom.php\n\nChanges in 9.3\n--------------\n- Handle case where Course Period Parent ID is null in Courses.php\n- SQL order by Period title in Periods.php, DailySummary.php & StudentSummary.php\n- SQL get Period title if no short name set in AddAbsences.php\n- Use DBLastInsertID() instead of DBSeqNextID() in Moodle/includes/ImportUsers.fnc.php\n- Still use DBSeqNextID() for student ID, adapt for MySQL in Student.php & Moodle/includes/ImportUsers.fnc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility, program wide\n- Fix first item in the list not displayed in Accounting/includes/DailyTransactions.php\n- SQL time interval for MySQL compatibility in PasswordReset.php & index.php\n- SQL use CAST(X AS char(X)) instead of to_char() for MySQL compatibility in Dashboard.inc.php & Reminders.php\n- SQL result as comma separated list for MySQL compatibility in Grades/includes/Dashboard.inc.php & MasterScheduleReport.php\n- Use DBEscapeIdentifier() for MySQL reserved 'TIMESTAMP' keyword in ServeMenus.php & Transactions.php\n- SQL add `_SQLUnixTimestamp()` to extract Unix timestamp or epoch from date in Grades.php & Schedule.php\n- Add case for MySQL: get next MP ID & set AUTO_INCREMENT+1 in EditHistoryMarkingPeriods.php\n- Display Name: SQL use CONCAT() instead of pipes || for MySQL compatibility in Configuration.php & GetStuList.fnc.php\n- config table: update DISPLAY_NAME to use CONCAT() instead of pipes || in Update.fnc.php\n\nChanges in 9.2.2\n----------------\n- Fix SQL error lastval is not yet defined when editing field in SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Assignments.php\n\nChanges in 9.2.1\n----------------\n- Remove use of db_seq_nextval(), use auto increment, program wide\n- SQL set default nextval (auto increment) for RosarioSIS version < 5.0 on install & old add-ons in Update.fnc.php\n- SQL no more cast MARKING_PERIOD_ID column as text/varchar in rosariosis.sql & InputFinalGrades.php\n- PLpgSQL compact & consistent function declaration in rosariosis.sql\n- Use DB transaction statements compatible with MySQL in database.inc.php\n- Add DBLastInsertID() & deprecate DBSeqNextID() + db_seq_nextval() in database.inc.php\n- SQL rename character varying & character data types to varchar & char in rosariosis.sql\n- SQL replace use of STRPOS() with LIKE, compatible with MySQL in PortalPollNotes.fnc.php & Courses.php\n- SQL fix French & Spanish translation for Create Parent Users & Notifiy Parents email templates in rosariosis_fr.sql & rosariosis_es.sql\n- Use DBLastInsertID() instead of DBSeqNextID(), program wide\n- SQL TRIM() both compatible with PostgreSQL and MySQL in AttendanceSummary.php & CopySchool.php\n- SQL use extract() or SUBSTRING() or REPLACE() instead of to_char() for MySQL compatibility, program wide\n- Fix No Address contact not properly saved for student / parent in RegistrationSave.fnc.php\n- AddDBField() Change $sequence param to $field_id, adapted for use with DBLastInsertID() in Fields.fnc.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php & UserFields.php\n- Raise Frame file size limit to 5MB in HonorRoll.fnc.php\n- Fix Marking Period not found in user School Year (multiple browser tabs case) in MassSchedule.php & MassDrops.php\n- Fix Course not found in user School Year (multiple browser tabs case) in MassRequests.php\n- HTML add label to inputs in Requests.php\n- Remove help sentence. The Scheduler is not run by the Student Requests program in Help_en.php\n\nChanges in 9.2\n--------------\n- Fix SQL error invalid input syntax for integer in Administration.php\n- SQL student_report_card_grades table: convert MARKING_PERIOD_ID column to integer in Update.fnc.php, rosariosis.sql, EditReportCardGrades.php, FinalGrades.php & ReportCards.fnc.php\n\nChanges in 9.1.1\n----------------\n- Fix PHP8.1 fatal error unsupported operand types: string / int in Assignments.php & MassCreateAssignments.php\n- Fix selected Subject lost on Comment Category delete in ReportCardComments.php\n- Fix Color Input was hidden in ReportCardComments.php\n- Fix use Course ID in session in MassRequests.php\n- Fix SQL error primary key exists on table food_service_staff_accounts in Rollover.php\n- Fix SQL error foreign key exists on tables gradebook_assignments,gradebook_assignment_types,schedule_requests in Rollover.php\n- Fix save State input value in Registration.fnc.php\n- Fix SchoolInfo() on user School Year update in School.php\n\nChanges in 9.1\n--------------\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @domiee13\n- Capitalize month when date is only month and year in Dashboard.inc.php\n- Add decimal & thousands separator configuration in Help_en.php, Currency.fnc.php, Configuration.php, rosariosis.sql & rosariosis_fr.sql\n- Use Currency() for Food Service Balance value in Widget.php & StaffWidget.php\n- Add Class average in InputFinalGrades.php & Grades.fnc.php\n- Update French & Spanish translation in rosariosis.po & help.po\n- Update Default School Year to 2022 in config.inc.sample.php & rosariosis.sql\n\nChanges in 9.0\n--------------\n- CSS add length to previous meals select in DailyMenus.php\n- CSS FlatSIS fix calendar menu text wrapping in stylesheet.css\n- Add Export list button in TransactionsReport.php\n- Add Food Service icon to list in ServeMenus.php\n- Add User / Student photo tooltip in ServeMenus.php, Transactions.php & TeacherCompletion.php\n- HTML add horizontal ruler before each category in MakeReferral.php\n- Fix SQL error when generating Schedule table with PHP8.1 in GetMP.php\n- Reorder PDF list columns to match Schedule columns in PrintSchedules.php\n- SQL order Schedule list by Course Title & Course Period Short Name in Schedule.php, PrintSchedules.php & Schedule.inc.php\n- Fix SQL error more than one row returned by a subquery in Rollover.php\n- Fix update Course Period title when Short Name contains single quote in Courses.php\n- Fix PHP8.1 deprecated function parameter is null, program wide\n- Fix PHP8.1 deprecated automatic conversion of false to array in StudentsUsersInfo.fnc.php\n- Fix PHP8.1 deprecated automatic conversion of float to int in ImageResizeGD.php\n- Add Student Photo Tip Message in AddDrop.php & StudentList.php\n- Format Enrollment Start & End Date in Export.php\n- Add Student name if no Contacts at address in MailingLabel.fnc.php\n- Do not Export Delete column in Periods.php & GradeLevels.php\n- HTML group inputs inside fieldset (tab title or program name) in Configuration.php\n- Hide Comment Codes tip message if Comments unchecked for Marking Period in InputFinalGrades.php\n- Add Get Student Labels Form JS (Disable unchecked fieldset) in StudentLabels.fnc.php & StudentLabels.php\n- Fix PHP8.1 deprecated use PostgreSQL $db_connection global variable in database.inc.php & Grades/includes/Dashboard.inc.php\n- Don't Delete Gender & Birthday Student Fields in Fields.fnc.php\n- CSS set cursor for .tipmsg-label in stylesheet.css\n- Add Username to Password Reset email in PasswordReset.php\n- `intl` PHP extension is now required in diagnostic.php & INSTALL.md\n- Fix PHP8.1 deprecated strftime() use strftime_compat() instead in Side.php, Date.php, PHPCompatibility.php, strftime_compat.php, Dashboard.inc.php & Preferences.php\n- Add $course_period_id param to limit check to a single Course Period in Courses.fnc.php & Courses.php\n- Add title to Contact & Address button images in Address.inc.php & GetStuList.fnc.php\n- CSS select max-width 440px in stylesheet.css & zresponsive.css\n- HTML add label to Points inputs to correct alignment in Grades.php\n- HTML add a11y-hidden label to select in CategoryBreakdown.php, CategoryBreakdownTime.php & StudentFieldBreakdown.php\n- Place Go button right after Timeframe in DailyTransactions.php, DailyTotals.php, CategoryBreakdown.php, CategoryBreakdownTime.php, StudentFieldBreakdown.php & Percent.php\n- Fix French translation for \"Not due\" in rosariosis.po\n- Move Transcript Include form checkboxes up in Transcripts.fnc.php\n- Add Delete button for Submission File in StudentAssignments.fnc.php\n- Fix SQL error null value in column \"title\" violates not-null constraint in MassCreateAssignments.php\n- Reorder & rename Course Periods columns to match Schedule program in MassCreateAssignments.php\n- Fix get History Grades Grade Level short name only if no Grade Level available in Transcripts.fnc.php\n- Fix get Student Photo from previous year in Transcripts.fnc.php\n- Fix SQL error invalid input syntax in PrintSchedules.php & TeacherCompletion.php, thanks to @scgajge12\n- Filter IP, HTTP_* headers can be forged in index.php, PasswordReset.php & ErrorMessage.fnc.php\n- Fix SQL error invalid input syntax for integer, program wide\n- Fix PHP8.1 fatal error checkdate argument must be of type int in Calendar.php\n- Fix SQL error invalid input syntax for type date in Calendar.php\n- Fix SQL error duplicate key value violates unique constraint \"attendance_calendar_pkey\" in Calendar.php\n- Fix PHP fatal error Unsupported operand types in ListOutput.php\n- Add AttrEscape() function in Inputs.php\n- Use AttrEscape() instead of htmlspecialchars(), program wide\n- Add use of AttrEscape(), program wide\n- Maintain Advanced search when editing Timeframe in Percent.php\n- Fix SQL injection escape DB identifier in RegistrationSave.fnc.php, Calendar.php, MarkingPeriods.php, Courses.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Referrals.php\n- JS update marked to v4.0.14 in assets/js/marked/ & warehouse_wkhtmltopdf.js\n- JS add DOMPurify 2.3.6 in assets/js/DOMPurify/ & Gruntfile.js\n- JS fix stored XSS issue related to MarkDown in warehouse.js & plugins.min.js, thanks to @intrapus\n- JS remove logged in check on history back in warehouse.js & plugins.min.js\n- Add CSRF token to protect unauthenticated requests in Warehouse.php & login.php\n- Add CSRF token to logout URL in login.php, Warehouse.php, PasswordReset.php, Bottom.php, Student.php & User.php, thanks to @khanhchauminh\n- Logout after 10 Hacking attempts within 1 minute in HackingLog.fnc.php\n- Destroy session now: some clients do not follow redirection in HackingLog.fnc.php\n- Add use of URLEscape(), program wide\n- Use URLEscape() for img src attribute, program wide\n- Sanitize / escape URL as THEME is often included for button img src attribute in User.fnc.php\n- Better format for \"Add another marking period\" form in EditReportCardGrades.php\n- Fix Improper Access Control security issue: add random string to photo file name in TipMessage.fnc.php, Transcripts.fnc.php, PrintClassPictures.php, Student.php, User.php & General_Info.inc.php, thanks to @dungtuanha\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @khanhchauminh\n- Fix stored XSS security issue: remove inline JS from URL in PreparePHP_SELF.fnc.php, thanks to @intrapus & @domiee13\n- Fix stored XSS security issue: add semicolon to HTML entity so it can be decoded in PreparePHP_SELF.fnc.php, thanks to @intrapus\n- Accessibility: add hidden input label using .a11y-hidden class in ReportCardComments.php, StudentFields.php & Grades/TeacherCompletion.php\n- Accessibility: add select label in Eligibility/TeacherCompletion.php, Student.php, StudentList.php, MassDrops.php & MassSchedule.php\n- Two Lists on same page: export only first, no search in Eligibility/Student.php\n- Remove photos on delete in Student.php & User.php, thank to @jo125ker\n- Remove Student Assignment Submission files on delete in Assignments.php, thank to @khanhchauminh\n- Add microseconds to filename format to make it harder to predict in Assignments.php & StudentAssignments.fnc.php, thanks to @khanhchauminh\n- Restrict Sort Order input number range, program wide\n- Restrict Price / Amount / Balance input number range, program wide, thanks to @nhienit2010\n- Restrict input number step in Courses.fnc.php\n- Restrict diagnostic access to logged in admin in diagnostic.php, thanks to @intrapus\n- Fix SQL error value too long for type character varying(50) in Schools.php\n- Add Secure RosarioSIS link in INSTALL.md\n- Add Calendar days legend in Calendar.php\n- CSS add .legend-square class in stylesheet.css & colors.css\n- Create / Edit / Delete calendar: use button() in Calendar.php\n- Update Calendars help text in Help_en.php & help.po\n- Add translations for Calendar days legend in rosariosis.po\n- Use json_encode() for AjaxLink() URL, program wide\n- SQL skip \"No Address\" contacts to avoid lines with empty Address fields in Export.php\n- French translation: remove capitalization & use articles in rosariosis.po, help.po & rosariosis_fr.sql\n- JS Sanitize string for legal variable name in Export.php & Inputs.php\n- Remove deprecated `_makeTeacher()` function in ReportCards.fnc.php\n- Use multiple select input for grades list to gain space in Widget.php\n- Fix regression since 5.0, allow Administration of \"Lunch\" attendance categories in Administration.php, AttendanceCodes.fnc.php & colors.css\n- SQL set default FAILED_LOGIN_LIMIT to 30 in rosariosis.sql, thanks to @domiee13\n- JS Hide Options textarea if Field not of select type in Fields.fnc.php\n- Add Balance widget in StudentBalances.php\n- Add Total sum of balances in StudentBalances.php\n- Fix SQL error check requested UserSyear & UserSchool exists in DB in Side.php, Search.fnc.php & SaveEnrollment.fnc.php\n- HTML use number input for Class Rank widget in Widget.php\n- Check default if school has no default calendar in Calendar.php\n- CSS do not capitalize date in stylesheet.css\n- Remove unused index ON attendance_period (attendance_code) & ON student_report_card_grades (school_id) in rosariosis.sql & rosariosis_mysql.sql\n- SQL VACUUM & ANALIZE are for PostgreSQL only in Scheduler.php\n\n\n### Old versions CHANGES\n- [CHANGES for versions 7 and 8](CHANGES_V7_8.md).\n- [CHANGES for versions 5 and 6](CHANGES_V5_6.md).\n- [CHANGES for versions 3 and 4](CHANGES_V3_4.md).\n- [CHANGES for versions 1 and 2](CHANGES_V1_2.md).\n", "<?php\n/**\n * Student Assignments functions\n *\n * @package RosarioSIS\n * @subpackage modules/Grades\n */\n\nrequire_once 'ProgramFunctions/FileUpload.fnc.php';\n\n// Assignments Files upload path global.\n\nif ( ! isset( $AssignmentsFilesPath ) )\n{\n\t$AssignmentsFilesPath = 'assets/AssignmentsFiles/';\n}\n\n/**\n * Submit Student Assignment\n * Save eventual uploaded file\n * & TinyMCE message.\n *\n * @example $submitted = StudentAssignmentSubmit( $_REQUEST['assignment_id'], $error );\n *\n * @uses GetAssignment()\n * @uses GetAssignmentsFilesPath()\n * @uses FileUpload()\n * @uses SanitizeHTML()\n * @since 2.9\n * @since 8.9.5 Add microseconds to filename format to make it harder to predict.\n *\n * @param  string  $assignment_id Assignment ID.\n * @param  array   $error         Global errors array.\n * @return boolean False if error(s), else true.\n */\nfunction StudentAssignmentSubmit( $assignment_id, &$error )\n{\n\trequire_once 'ProgramFunctions/MarkDownHTML.fnc.php';\n\n\t$assignment = GetAssignment( $assignment_id );\n\n\tif ( ! $assignment )\n\t{\n\t\t$error[] = _( 'You are not allowed to access this assignment.' );\n\n\t\techo ErrorMessage( $error, 'fatal' );\n\t}\n\n\tif ( ! $assignment['SUBMISSION'] )\n\t{\n\t\t$error[] = _( 'Assignment submission is not enabled.' );\n\n\t\treturn false;\n\t}\n\n\t// Old submission.\n\t$old_submission = GetAssignmentSubmission( $assignment_id, UserStudentID() );\n\n\tif ( $old_submission )\n\t{\n\t\t$old_data = unserialize( $old_submission['DATA'] );\n\t}\n\n\t// TODO: check if Student not dropped?\n\n\t$files = issetVal( $old_data['files'] );\n\n\t// @since 8.9.5 Add microseconds to filename format to make it harder to predict.\n\t$timestamp = date( 'Y-m-d His' ) . '.' . substr( (string) microtime(), 2, 6 );\n\n\t$assignments_path = GetAssignmentsFilesPath( $assignment['STAFF_ID'] );\n\n\t// Check if file submitted.\n\tif ( isset( $_FILES['submission_file'] ) )\n\t{\n\t\t$student_name = DBGetOne( \"SELECT \" . DisplayNameSQL() . \" AS NAME\n\t\t\tFROM students\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\" );\n\n\t\t// Filename = [course_title]_[assignment_ID]_[student_name]_[timestamp].ext.\n\t\t$file_name_no_ext = no_accents( $assignment['COURSE_TITLE'] . '_' . $assignment_id . '_' .\n\t\t\t$student_name . '_' . $timestamp );\n\n\t\t// Upload file to AssignmentsFiles/[School_Year]/Teacher[teacher_ID]/Quarter[1,2,3,4...]/.\n\t\t$file = FileUpload(\n\t\t\t'submission_file',\n\t\t\t$assignments_path,\n\t\t\tFileExtensionWhiteList(),\n\t\t\t0,\n\t\t\t$error,\n\t\t\t'',\n\t\t\t$file_name_no_ext\n\t\t);\n\n\t\tif ( $file )\n\t\t{\n\t\t\t$files = [ $file ];\n\t\t}\n\t}\n\n\tif ( isset( $_REQUEST['submission_file'] ) )\n\t{\n\t\t// Submission file input enabled (may be empty).\n\t\tif ( $old_data )\n\t\t{\n\t\t\t$old_file = issetVal( $old_data['files'][0], '' );\n\n\t\t\tif ( file_exists( $old_file ) )\n\t\t\t{\n\t\t\t\t// Delete old file if any.\n\t\t\t\tunlink( $old_file );\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check if HMTL submitted.\n\t$message = isset( $_POST['message'] ) ? SanitizeHTML( $_POST['message'], $assignments_path ) : '';\n\n\t// Serialize Assignment Data.\n\t$data = [ 'files' => $files, 'message' => $message, 'date' => $timestamp ];\n\n\t$data = DBEscapeString( serialize( $data ) );\n\n\t// Save assignment submission.\n\t// Update or insert?\n\tif ( $old_submission )\n\t{\n\t\t// Update.\n\t\t$assignment_submission_sql = \"UPDATE student_assignments\n\t\t\tSET DATA='\" . $data . \"'\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND ASSIGNMENT_ID='\" . (int) $assignment_id . \"'\";\n\t}\n\telse\n\t{\n\t\t// If no file & no message.\n\t\tif ( $message = ''\n\t\t\t&& ! $files )\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\t// Insert.\n\t\t$assignment_submission_sql = \"INSERT INTO student_assignments\n\t\t\t(STUDENT_ID, ASSIGNMENT_ID, DATA)\n\t\t\tVALUES ('\" . UserStudentID() . \"', '\" . $assignment_id . \"', '\" . $data . \"')\";\n\t}\n\n\tDBQuery( $assignment_submission_sql );\n\n\treturn empty( $error );\n}\n\n/**\n * Student Assignment details\n * & Submission form.\n *\n * @example echo StudentAssignmentSubmission( $_REQUEST['assignment_id'] );\n *\n * @uses GetAssignmentSubmission()\n * @uses TinyMCEInput()\n * @since 2.9\n *\n * @since 4.5 Move headers to StudentAssignmentDrawHeaders() function\n *\n * @param  string  $assignment_id Assignment ID.\n * @return boolean true if can submit, else false.\n */\nfunction StudentAssignmentSubmissionOutput( $assignment_id )\n{\n\trequire_once 'ProgramFunctions/FileUpload.fnc.php';\n\n\t$assignment = GetAssignment( $assignment_id );\n\n\tif ( ! $assignment )\n\t{\n\t\t$error[] = _( 'You are not allowed to access this assignment.' );\n\n\t\techo ErrorMessage( $error, 'fatal' );\n\t}\n\n\tStudentAssignmentDrawHeaders( $assignment );\n\n\t// @since 4.1 Submission header action hook.\n\tdo_action( 'Grades/includes/StudentAssignments.fnc.php|submission_header' );\n\n\tif ( ! $assignment['SUBMISSION'] )\n\t{\n\t\treturn false;\n\t}\n\n\t// Get assignment submission if any.\n\t$submission = GetAssignmentSubmission(\n\t\t$assignment_id,\n\t\tUserStudentID()\n\t);\n\n\t$old_file = $old_message = $old_date = '';\n\n\tif ( isset( $submission['DATA'] ) )\n\t{\n\t\t$data = unserialize( $submission['DATA'] );\n\n\t\t$old_file = issetVal( $data['files'][0], '' );\n\n\t\t$old_file = GetAssignmentFileLink( $old_file );\n\n\t\t$old_message = $data['message'];\n\n\t\t$old_date = ProperDateTime( $data['date'], 'short' );\n\t}\n\n\t// Check if Assignment can be submitted (TODAY <= DUE_DATE) or (!DUE_DATE && TODAY > User MP END_DATE).\n\n\tif (  ( $assignment['DUE_DATE']\n\t\t&& DBDate() > $assignment['DUE_DATE'] )\n\t\t|| ( ! $assignment['DUE_DATE']\n\t\t\t&& DBDate() > GetMP( UserMP(), 'END_DATE' ) ) )\n\t{\n\t\tif ( $old_file )\n\t\t{\n\t\t\t// Display assignment file.\n\t\t\tDrawHeader(\n\t\t\t\tNoInput( $old_file, _( 'File' ) ),\n\t\t\t\tNoInput( $old_date, _( 'Submission date' ) )\n\t\t\t);\n\t\t}\n\n\t\tif ( $old_message )\n\t\t{\n\t\t\t// Display assignment message.\n\t\t\tDrawHeader( $old_message . $message .\n\t\t\t\tFormatInputTitle( _( 'Message' ), '', false, '' ) );\n\t\t}\n\n\t\techo ErrorMessage( [ _( 'Submissions for this assignment are closed.' ) ], 'note' );\n\n\t\treturn false;\n\t}\n\n\t// File upload.\n\t$file_html = '<div id=\"submission_file_input\"' . ( $old_file ? 'class=\"hide\"' : '' ) . '>' .\n\tFileInput(\n\t\t'submission_file',\n\t\t_( 'File' ),\n\t\t( $old_file ? 'disabled' : '' )\n\t) . '</div>';\n\n\tif ( $old_file )\n\t{\n\t\t// Delete file icon.\n\t\t$old_file = button(\n\t\t\t'remove',\n\t\t\t'',\n\t\t\t'\"#!\" onclick=\"$(\\'#submission_file_link\\').hide(); $(\\'#submission_file_input\\').show();$(\\'#submission_file\\').prop(\\'disabled\\', false);\"'\n\t\t) . ' ' . $old_file;\n\n\t\t$old_file = '<div id=\"submission_file_link\">' . NoInput( $old_file, _( 'File' ) ) . '</div>';\n\t}\n\n\t// Input div onclick only if old file.\n\tDrawHeader(\n\t\t$old_file ? $old_file . '<br />' . $file_html : $file_html,\n\t\t$old_date ? NoInput( $old_date, _( 'Submission date' ) ) : ''\n\t);\n\n\t// HTML message (TinyMCE).\n\tDrawHeader( TinyMCEInput( $old_message, 'message', _( 'Message' ) ) );\n\n\techo '<br /><div class=\"center\">' . SubmitButton( _( 'Submit Assignment' ), 'submit_assignment' ) . '</div>';\n\n\treturn true;\n}\n\n\n/**\n * Student Assignment Draw Headers with details\n *\n * @since 4.5\n * @since 10.6 Truncate Assignment Title & Category to 36 chars only if has words > 36 chars\n *\n * @param array $assignment Assignment details array\n */\nfunction StudentAssignmentDrawHeaders( $assignment )\n{\n\tif ( ! $assignment\n\t\t|| ! is_array( $assignment ) )\n\t{\n\t\treturn;\n\t}\n\n\t// Past due, in red.\n\t$due_date = $assignment['DUE_DATE'] ? MakeAssignmentDueDate( $assignment['DUE_DATE'] ) : _( 'N/A' );\n\n\t$assigned_date = $assignment['ASSIGNED_DATE'] ? ProperDate( $assignment['ASSIGNED_DATE'] ) : _( 'N/A' );\n\n\t// Display Assignment details.\n\t// Due date - Assigned date.\n\tDrawHeader(\n\t\t_( 'Due Date' ) . ': <b>' . $due_date . '</b>',\n\t\t_( 'Assigned Date' ) . ': <b>' . $assigned_date . '</b>'\n\t);\n\n\t// Course - Teacher.\n\tDrawHeader(\n\t\t_( 'Course Title' ) . ': <b>' . $assignment['COURSE_TITLE'] . '</b>',\n\t\t_( 'Teacher' ) . ': <b>' . GetTeacher( $assignment['STAFF_ID'] ) . '</b>'\n\t);\n\n\t$type_color = '';\n\n\tif ( $assignment['ASSIGNMENT_TYPE_COLOR'] )\n\t{\n\t\t$type_color = '<span style=\"background-color: ' .\n\t\t\tAttrEscape( $assignment['ASSIGNMENT_TYPE_COLOR'] ) . ';\">&nbsp;</span>&nbsp;';\n\t}\n\n\t// Truncate title to 36 chars only if has words > 36 chars.\n\t// Split on spaces.\n\t$title_words = explode( ' ', $assignment['TITLE'] );\n\n\t$truncate = false;\n\n\tforeach ( $title_words as $title_word )\n\t{\n\t\tif ( mb_strlen( $title_word ) > 36 )\n\t\t{\n\t\t\t$truncate = true;\n\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t$title = ! $truncate ?\n\t\t$assignment['TITLE'] :\n\t\t'<span title=\"' . AttrEscape( $assignment['TITLE'] ) . '\">' . mb_substr( $assignment['TITLE'], 0, 33 ) . '...</span>';\n\n\t// Truncate category to 36 chars only if has words > 36 chars.\n\t// Split on spaces.\n\t$category_words = explode( ' ', $assignment['CATEGORY'] );\n\n\t$truncate = false;\n\n\tforeach ( $category_words as $category_word )\n\t{\n\t\tif ( mb_strlen( $category_word ) > 36 )\n\t\t{\n\t\t\t$truncate = true;\n\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t$category = ! $truncate ?\n\t\t$assignment['CATEGORY'] :\n\t\t'<span title=\"' . AttrEscape( $assignment['CATEGORY'] ) . '\">' . mb_substr( $assignment['CATEGORY'], 0, 33 ) . '...</span>';\n\n\t// Title - Type.\n\tDrawHeader(\n\t\t_( 'Title' ) . ': <b>' . $title,\n\t\t_( 'Category' ) . ': <b>' . $type_color . $category . '</b>'\n\t);\n\n\t// @since 4.4 Assignment File.\n\t$file_header = $assignment['FILE'] ?\n\t\t_( 'File' ) . ': ' . GetAssignmentFileLink( $assignment['FILE'] ) :\n\t\t'';\n\n\t// Points.\n\tDrawHeader(\n\t\t_( 'Points' ) . ': <b>' . $assignment['POINTS'] . '</b>',\n\t\t$file_header\n\t);\n\n\tif ( $assignment['DESCRIPTION'] )\n\t{\n\t\t// Description.\n\t\techo $assignment['DESCRIPTION'];\n\t}\n}\n\n\n/**\n * Get Assignment details from DB.\n *\n * @example $assignment = GetAssignment( $assignment_id );\n *\n * @since 2.9\n * @since 4.4 Adapt function for Teachers (no Student).\n * @since 10.7 Check Assignment is in current MP\n *\n * @param  string        $assignment_id Assignment ID.\n * @return boolean|array Assignment details array or false.\n */\nfunction GetAssignment( $assignment_id )\n{\n\t/**\n\t * @var array\n\t */\n\tstatic $assignment = [];\n\n\tif ( isset( $assignment[$assignment_id] ) )\n\t{\n\t\treturn $assignment[$assignment_id];\n\t}\n\n\t// Check Assignment ID is int > 0.\n\tif ( (string) (int) $assignment_id != $assignment_id\n\t\t|| $assignment_id < 1 )\n\t{\n\t\treturn false;\n\t}\n\n\t$where_user = \"1\";\n\n\tif ( User( 'PROFILE' ) === 'teacher' )\n\t{\n\t\t$where_user = \"WHERE ga.STAFF_ID='\" . User( 'STAFF_ID' ) . \"'\n\t\t\tAND c.COURSE_ID=gat.COURSE_ID\n\t\t\tAND (ga.COURSE_PERIOD_ID IS NULL OR ga.COURSE_PERIOD_ID='\" . UserCoursePeriod() . \"')\n\t\t\tAND (ga.COURSE_ID IS NULL OR ga.COURSE_ID=c.COURSE_ID)\";\n\t}\n\telseif ( UserStudentID() )\n\t{\n\t\t$where_user = \",schedule ss WHERE ss.STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND ss.SYEAR='\" . UserSyear() . \"'\n\t\t\tAND ss.SCHOOL_ID='\" . UserSchool() . \"'\n\t\t\tAND ss.MARKING_PERIOD_ID IN (\" . GetAllMP( 'QTR', UserMP() ) . \")\n\t\t\tAND (ga.COURSE_PERIOD_ID IS NULL OR ss.COURSE_PERIOD_ID=ga.COURSE_PERIOD_ID)\n\t\t\tAND (ga.COURSE_ID IS NULL OR ss.COURSE_ID=ga.COURSE_ID)\n\t\t\tAND (ga.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=ga.ASSIGNED_DATE)\n\t\t\tAND ( ga.DUE_DATE IS NULL\n\t\t\t\tOR ( ga.DUE_DATE>=ss.START_DATE\n\t\t\t\t\tAND ( ss.END_DATE IS NULL OR ga.DUE_DATE<=ss.END_DATE ) ) )\n\t\t\tAND c.COURSE_ID=ss.COURSE_ID\";\n\t}\n\n\t$assignment_sql = \"SELECT ga.ASSIGNMENT_ID, ga.STAFF_ID, ga.COURSE_PERIOD_ID, ga.COURSE_ID,\n\t\tga.TITLE, ga.ASSIGNED_DATE, ga.DUE_DATE, ga.POINTS,\n\t\tga.DESCRIPTION, ga.FILE, ga.SUBMISSION, c.TITLE AS COURSE_TITLE,\n\t\tgat.TITLE AS CATEGORY, gat.COLOR AS ASSIGNMENT_TYPE_COLOR\n\t\tFROM gradebook_assignments ga,courses c,gradebook_assignment_types gat\n\t\t\" . $where_user .\n\t\t\" AND ga.ASSIGNMENT_ID='\" . (int) $assignment_id . \"'\n\t\tAND gat.ASSIGNMENT_TYPE_ID=ga.ASSIGNMENT_TYPE_ID\n\t\tAND ga.MARKING_PERIOD_ID='\" . UserMP() . \"'\"; // Why not?\n\n\t$assignment_RET = DBGet( $assignment_sql, [], [ 'ASSIGNMENT_ID' ] );\n\n\t$assignment[$assignment_id] = isset( $assignment_RET[$assignment_id] ) ?\n\t$assignment_RET[$assignment_id][1] : false;\n\n\treturn $assignment[$assignment_id];\n}\n\n/**\n * @param $assignment_id\n * @param $student_id\n */\nfunction GetAssignmentSubmission( $assignment_id, $student_id )\n{\n\t// Check Assignment ID is int > 0 & Student ID.\n\n\tif ( ! $assignment_id\n\t\t|| (string) (int) $assignment_id !== $assignment_id\n\t\t|| $assignment_id < 1\n\t\t|| ! $student_id )\n\t{\n\t\treturn false;\n\t}\n\n\t$submission_sql = \"SELECT DATA\n\t\tFROM student_assignments\n\t\tWHERE ASSIGNMENT_ID='\" . (int) $assignment_id . \"'\n\t\tAND STUDENT_ID='\" . (int) $student_id . \"'\";\n\n\t$submission_RET = DBGet( $submission_sql );\n\n\treturn isset( $submission_RET[1] ) ? $submission_RET[1] : false;\n}\n\n/**\n * Get `AssignmentsFiles/` folder full path\n *\n * @example $assignments_path = GetAssignmentsFilesPath( $assignment['STAFF_ID'] );\n *\n * @global $AssignmentsFilesPath\n * @since 2.9\n *\n * @param  string $teacher_id                                                                Teacher ID.\n * @return string AssignmentsFiles/[School_Year]/Quarter[1,2,3,4...]/Teacher[teacher_ID]/\n */\nfunction GetAssignmentsFilesPath( $teacher_id )\n{\n\tglobal $AssignmentsFilesPath;\n\n\tif ( ! $teacher_id )\n\t{\n\t\treturn $AssignmentsFilesPath;\n\t}\n\n\t// File path = AssignmentsFiles/[School_Year]/Quarter[1,2,3,4...]/Teacher[teacher_ID]/.\n\n\treturn $AssignmentsFilesPath . UserSyear() . '/Quarter' . UserMP() . '/Teacher' . $teacher_id . '/';\n}\n\n\n/**\n * Upload Assignment Teacher File\n * Delete any existing file.\n *\n * @since 4.4\n *\n * @param int    $teacher_id    Teacher staff ID.\n * @param int    $assignment_id Assignment ID.\n * @param string $file_input_id File input ID.\n *\n * @return string File full path.\n */\nfunction UploadAssignmentTeacherFile( $assignment_id, $teacher_id, $file_input_id )\n{\n\tglobal $error;\n\n\t$assignment = GetAssignment( $assignment_id );\n\n\tif ( ! $assignment )\n\t{\n\t\treturn '';\n\t}\n\n\t// @since 9.0 Add microseconds to filename format to make it harder to predict.\n\t$microseconds = substr( (string) microtime(), 2, 6 );\n\n\t// Filename = [course_title]_[assignment_ID].ext.\n\t$file_name_no_ext = no_accents( $assignment['COURSE_TITLE'] . '_' . $assignment_id . '.' . $microseconds );\n\n\tif ( ! empty( $assignment['FILE'] )\n\t\t&& file_exists( $assignment['FILE'] ) )\n\t{\n\t\t// Delete existing Assignment File.\n\t\tunlink( $assignment['FILE'] );\n\t}\n\n\t$assignments_path = GetAssignmentsFilesPath( User( 'STAFF_ID' ) );\n\n\t// Upload file to AssignmentsFiles/[School_Year]/Teacher[teacher_ID]/Quarter[1,2,3,4...]/.\n\t$file = FileUpload(\n\t\t$file_input_id,\n\t\t$assignments_path,\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\treturn $file;\n}\n\n\nfunction StudentAssignmentsListOutput()\n{\n\t// TODO: get Assignment type color!\n\t$assignments_sql = \"SELECT ga.ASSIGNMENT_ID,ga.STAFF_ID,ga.COURSE_PERIOD_ID,ga.COURSE_ID,\n\t\tga.ASSIGNMENT_TYPE_ID,ga.TITLE,ga.ASSIGNED_DATE,ga.DUE_DATE,ga.POINTS,ga.SUBMISSION,\n\t\tc.TITLE AS COURSE_TITLE,\n\t\t(SELECT 1\n\t\t\tFROM student_assignments sa\n\t\t\tWHERE ga.ASSIGNMENT_ID=sa.ASSIGNMENT_ID\n\t\t\tAND sa.STUDENT_ID=ss.STUDENT_ID) AS SUBMITTED\n\t\tFROM gradebook_assignments ga, schedule ss, courses c, course_periods cp\n\t\tWHERE ss.STUDENT_ID='\" . UserStudentID() . \"'\n\t\tAND ss.SYEAR='\" . UserSyear() . \"'\n\t\tAND ss.SCHOOL_ID='\" . UserSchool() . \"'\n\t\tAND ga.MARKING_PERIOD_ID='\" . UserMP() . \"'\n\t\tAND ss.MARKING_PERIOD_ID IN (\" . GetAllMP( 'QTR', UserMP() ) . \")\n\t\tAND (ga.COURSE_PERIOD_ID IS NULL OR ss.COURSE_PERIOD_ID=ga.COURSE_PERIOD_ID)\n\t\tAND (ga.COURSE_ID IS NULL OR ss.COURSE_ID=ga.COURSE_ID)\n\t\tAND ga.STAFF_ID=cp.TEACHER_ID\n\t\tAND cp.COURSE_ID=c.COURSE_ID\n\t\tAND cp.COURSE_PERIOD_ID=ss.COURSE_PERIOD_ID\n\t\tAND (ga.ASSIGNED_DATE IS NULL OR CURRENT_DATE>=ga.ASSIGNED_DATE)\n\t\tAND ( ga.DUE_DATE IS NULL\n\t\t\tOR ( ga.DUE_DATE>=ss.START_DATE\n\t\t\t\tAND ( ss.END_DATE IS NULL OR ga.DUE_DATE<=ss.END_DATE ) ) )\n\t\tAND c.COURSE_ID=ss.COURSE_ID\n\t\tORDER BY ga.SUBMISSION, ga.DUE_DATE\";\n\n\t$assignments_RET = DBGet(\n\t\tDBQuery( $assignments_sql ),\n\t\t[\n\t\t\t'TITLE' => 'MakeAssignmentTitle',\n\t\t\t'STAFF_ID' => 'GetTeacher',\n\t\t\t'DUE_DATE' => 'MakeAssignmentDueDate',\n\t\t\t'ASSIGNED_DATE' => 'ProperDate',\n\t\t\t'SUBMITTED' => 'MakeAssignmentSubmitted',\n\t\t]\n\t);\n\n\t$columns = [\n\t\t'TITLE' => _( 'Title' ),\n\t\t'DUE_DATE' => _( 'Due Date' ),\n\t\t'ASSIGNED_DATE' => _( 'Assigned Date' ),\n\t\t'COURSE_TITLE' => _( 'Course Title' ),\n\t\t'STAFF_ID' => _( 'Teacher' ),\n\t\t'SUBMITTED' => _( 'Submitted' ),\n\t];\n\n\t$LO_options = [\n\t\t'save' => false,\n\t];\n\n\tListOutput(\n\t\t$assignments_RET,\n\t\t$columns,\n\t\t_( 'Assignment' ),\n\t\t_( 'Assignments' ),\n\t\t[],\n\t\t[],\n\t\t$LO_options\n\t);\n\n\treturn true;\n}\n\nif ( ! function_exists( 'MakeAssignmentTitle' ) )\n{\n\t/**\n\t * Make Assignment title and link.\n\t *\n\t * @global $THIS_RET current row from DBGet.\n\t * @since 4.1 Override this function in your custom module or plugin.\n\t *\n\t * @param  string $value  Title value.\n\t * @param  string $column Column, 'TITLE'.\n\t * @return Title  and link.\n\t */\n\tfunction MakeAssignmentTitle( $value, $column )\n\t{\n\t\tglobal $THIS_RET;\n\n\t\tif ( ! empty( $_REQUEST['LO_save'] ) )\n\t\t{\n\t\t\t// Export list.\n\t\t\treturn $value;\n\t\t}\n\n\t\t// Truncate value to 36 chars.\n\t\t$title = mb_strlen( $value ) <= 36 ?\n\t\t$value :\n\t\t'<span title=\"' . AttrEscape( $value ) . '\">' . mb_substr( $value, 0, 33 ) . '...</span>';\n\n\t\tif ( User( 'PROFILE' ) === 'teacher' )\n\t\t{\n\t\t\t$view_assignment_link = 'Modules.php?modname=Grades/Assignments.php';\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$view_assignment_link = 'Modules.php?modname=Grades/StudentAssignments.php';\n\t\t}\n\n\t\tif ( ! empty( $THIS_RET['ASSIGNMENT_ID'] ) )\n\t\t{\n\t\t\t$view_assignment_link .= '&assignment_id=' . $THIS_RET['ASSIGNMENT_ID'];\n\t\t}\n\n\t\tif ( ! empty( $THIS_RET['MARKING_PERIOD_ID'] ) )\n\t\t{\n\t\t\t// @since 3.9 Add MP to outside links (see Portal), so current MP is correct.\n\t\t\t$view_assignment_link .= '&marking_period_id=' . $THIS_RET['MARKING_PERIOD_ID'];\n\t\t}\n\n\t\treturn '<a href=\"' . URLEscape( $view_assignment_link ) . '\">' . $title . '</a>';\n\t}\n}\n\n/**\n * @param $value\n * @param $column\n * @return mixed\n */\nfunction MakeAssignmentDueDate( $value, $column = 'DUE_DATE' )\n{\n\t$due_date = ProperDate( $value );\n\n\tif ( $value\n\t\t&& $value <= DBDate() )\n\t{\n\t\t// Past due, in red.\n\t\t$due_date = '<span style=\"color:red;\">' . $due_date . '</span>';\n\t}\n\n\treturn $due_date;\n}\n\n/**\n * @param $value\n * @param $column\n * @return mixed\n */\nfunction MakeAssignmentSubmitted( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! isset( $THIS_RET['SUBMISSION'] )\n\t\t|| $THIS_RET['SUBMISSION'] !== 'Y' )\n\t{\n\t\treturn '';\n\t}\n\n\treturn $value ? button( 'check' ) : button( 'x' );\n}\n\n\n/**\n * Make Student Assignment Submission View\n *\n * DBGet callback\n *\n * @since 4.2\n *\n * @param string $value\n * @param string $column 'SUBMISSION'\n * @return string Column HTML.\n */\nfunction MakeStudentAssignmentSubmissionView( $value, $column )\n{\n\tglobal $THIS_RET,\n\t\t$submission_column_html;\n\n\t$student_id = UserStudentID() ? UserStudentID() : $THIS_RET['STUDENT_ID'];\n\n\t$submission = GetAssignmentSubmission( $THIS_RET['ASSIGNMENT_ID'], $student_id );\n\n\t$submission_column_html = button( 'x' );\n\n\tif ( $value !== 'Y' )\n\t{\n\t\t$submission_column_html = '';\n\t}\n\n\tif ( $submission )\n\t{\n\t\t$data = unserialize( $submission['DATA'] );\n\n\t\t$file = issetVal( $data['files'][0], '' );\n\n\t\t$message = $data['message'];\n\n\t\t$date = ProperDateTime( $data['date'], 'short' );\n\n\t\t$submission_column_html = '<a class=\"colorboxinline\" href=\"#submission' . $THIS_RET['ASSIGNMENT_ID'] . '-' . $student_id . '\">\n\t\t<img src=\"assets/themes/' . Preferences( 'THEME' ) . '/btn/visualize.png\" class=\"button bigger\" /> ' .\n\t\t_( 'View Online' ) . '</a>';\n\n\t\t$file_html = $message_html = '';\n\n\t\tif ( $file )\n\t\t{\n\t\t\t$file_html = NoInput( GetAssignmentFileLink( $file ), _( 'File' ) ) . '<br />';\n\t\t}\n\n\t\tif ( $message )\n\t\t{\n\t\t\t$message_html = $message . FormatInputTitle( _( 'Message' ), '', false, '' );\n\t\t}\n\n\t\t$submission_column_html .= '<div class=\"hide\">\n\t\t\t<div id=\"submission' . $THIS_RET['ASSIGNMENT_ID'] . '-' . $student_id . '\">' .\n\t\t\tNoInput( $date, _( 'Submission date' ) ) . '<br />' .\n\t\t\t$file_html .\n\t\t\t$message_html .\n\t\t\t'</div></div>';\n\n\t\treturn $submission_column_html;\n\t}\n\n\t/**\n\t * Do action hook\n\t * Assignment Grades Submission column.\n\t *\n\t * Submission Column HTML is a global var so it can be filtered.\n\t *\n\t * @since 4.2\n\t */\n\tdo_action( 'Grades/includes/StudentAssignments.fnc.php|grades_submission_column' );\n\n\treturn $submission_column_html;\n}\n\n\n/**\n * @param $file_path\n */\nfunction GetAssignmentFileLink( $file_path )\n{\n\tif ( ! file_exists( $file_path ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name = mb_substr( mb_strrchr( $file_path, '/' ), 1 );\n\n\t$file_size = HumanFilesize( filesize( $file_path ) );\n\n\treturn button(\n\t\t'download',\n\t\t_( 'Download' ),\n\t\t'\"' . URLEscape( $file_path ) . '\" target=\"_blank\" title=\"' . AttrEscape( $file_name . ' (' . $file_size . ')' ) . '\"',\n\t\t'bigger'\n\t);\n}\n"], "filenames": ["CHANGES.md", "modules/Grades/includes/StudentAssignments.fnc.php"], "buggy_code_start_loc": [2, 68], "buggy_code_end_loc": [2, 537], "fixing_code_start_loc": [3, 67], "fixing_code_end_loc": [7, 533], "type": "CWE-200", "message": "Exposure of Sensitive Information to an Unauthorized Actor in GitHub repository francoisjacquet/rosariosis prior to 10.8.2.", "other": {"cve": {"id": "CVE-2023-0994", "sourceIdentifier": "security@huntr.dev", "published": "2023-02-24T02:15:10.523", "lastModified": "2023-04-26T16:15:09.523", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Exposure of Sensitive Information to an Unauthorized Actor in GitHub repository francoisjacquet/rosariosis prior to 10.8.2."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 3.6}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "HIGH", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.1, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.2, "impactScore": 5.9}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-200"}]}, {"source": "nvd@nist.gov", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-200"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:rosariosis:rosariosis:*:*:*:*:*:*:*:*", "versionEndExcluding": "10.8.2", "matchCriteriaId": "A5B1D492-A82F-4C49-9699-35B8EEE8E9E9"}]}]}], "references": [{"url": "https://github.com/francoisjacquet/rosariosis/commit/630d3e3d78270db8dbcbfe87db265bc3e70c5a76", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/a281c586-9b97-4d17-88ff-ca91bb4c45ad", "source": "security@huntr.dev", "tags": ["Exploit", "Patch"]}]}, "github_commit_url": "https://github.com/francoisjacquet/rosariosis/commit/630d3e3d78270db8dbcbfe87db265bc3e70c5a76"}}