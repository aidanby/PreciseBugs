{"buggy_code": ["<?php\n/**\n * Licensed to The Apereo Foundation under one or more contributor license\n * agreements. See the NOTICE file distributed with this work for\n * additional information regarding copyright ownership.\n\n * The Apereo Foundation licenses this file to you under the Apache License,\n * Version 2.0 (the \"License\"); you may not use this file except in\n * compliance with the License. You may obtain a copy of the License at:\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n \nrequire_once(dirname(__FILE__) . \"/config.php\");\nrequire $xerte_toolkits_site->php_library_path . \"user_library.php\";\nrequire $xerte_toolkits_site->php_library_path . \"template_library.php\";\nrequire $xerte_toolkits_site->php_library_path . \"template_status.php\";\n\n// be slightly paranoid over the path the user is requesting to download.\n$unsafe_file_path = $_GET['file'];\nif(!preg_match('/^([0-9]+)-([a-z0-9]+)-/', $unsafe_file_path, $matches)) {\n    die(\"path must start with a number, and then a username - e.g. 20-foobar-\");\n}\n\n$template_id = $matches[1];\n$username = $matches[2];\n\n$has_perms = is_user_admin() || has_rights_to_this_template($template_id,$_SESSION['toolkits_logon_id']);\n\nif($has_perms) { \n    if(is_user_an_editor($template_id,$_SESSION['toolkits_logon_id'])){\n        if($username == $_SESSION['toolkits_logon_username']) { \n            // they're logged in, and hopefully have access to the media contents.\n            $file = dirname(__FILE__) . '/USER-FILES/' . $unsafe_file_path;\n            if(!is_file($file)) { \n                die(\"Fail: file not found on disk\"); \n            }\n            $filename = addslashes(basename($file));\n\n            header(\"Cache-Control: public\");\n            header(\"Content-Length: \" . filesize($file));\n            header(\"Content-Description: File Transfer\");\n            header(\"Content-Type: application/force-download\"); \n            header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n            header(\"Content-Transfer-Encoding: binary\");\n            flush();\n            readfile($file);\n            exit(0);\n        }\n    }\n}\n\necho \"You do not appear to have permission to view this resource.\";\n"], "fixing_code": ["<?php\n/**\n * Licensed to The Apereo Foundation under one or more contributor license\n * agreements. See the NOTICE file distributed with this work for\n * additional information regarding copyright ownership.\n\n * The Apereo Foundation licenses this file to you under the Apache License,\n * Version 2.0 (the \"License\"); you may not use this file except in\n * compliance with the License. You may obtain a copy of the License at:\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n \nrequire_once(dirname(__FILE__) . \"/config.php\");\nrequire $xerte_toolkits_site->php_library_path . \"user_library.php\";\nrequire $xerte_toolkits_site->php_library_path . \"template_library.php\";\nrequire $xerte_toolkits_site->php_library_path . \"template_status.php\";\n\n// be VERY paranoid over the path the user is requesting to download.\n// Even if the file starts with a correct pattern (old implementation) the user could travers path\n// like 542-tom-Notingham/../database.php or like 542-tom-Notingham/../../../../etc/passwd\n$unsafe_file_path = $_GET['file'];\n$full_unsafe_file_path = $xerte_toolkits_site->root_file_path . $xerte_toolkits_site->users_file_area_short . $unsafe_file_path;\n// This gets the canonical file name, so in case of 542-tom-Notingham/../../../../etc/passwd -> /etc/passwd\n$realpath = realpath($full_unsafe_file_path);\n// Check that is start with root_path/USER-FILES\nif ($realpath !== false && $realpath === $full_unsafe_file_path) {\n    if (!preg_match('/^([0-9]+)-([a-z0-9]+)-/', $unsafe_file_path, $matches)) {\n        die(\"path must start with a number, and then a username - e.g. 20-foobar-\");\n    }\n\n    $template_id = $matches[1];\n    $username = $matches[2];\n\n    $has_perms = is_user_admin() || has_rights_to_this_template($template_id, $_SESSION['toolkits_logon_id']);\n\n    if ($has_perms) {\n        if (is_user_an_editor($template_id, $_SESSION['toolkits_logon_id'])) {\n            if ($username == $_SESSION['toolkits_logon_username']) {\n                // they're logged in, and hopefully have access to the media contents.\n                $file = dirname(__FILE__) . '/USER-FILES/' . $unsafe_file_path;\n                if (!is_file($file)) {\n                    die(\"Fail: file not found on disk\");\n                }\n                $filename = addslashes(basename($file));\n\n                header(\"Cache-Control: public\");\n                header(\"Content-Length: \" . filesize($file));\n                header(\"Content-Description: File Transfer\");\n                header(\"Content-Type: application/force-download\");\n                header(\"Content-Disposition: attachment; filename=\\\"$filename\\\"\");\n                header(\"Content-Transfer-Encoding: binary\");\n                flush();\n                readfile($file);\n                exit(0);\n            }\n        }\n    }\n}\necho \"You do not appear to have permission to view this resource.\";\n"], "filenames": ["getfile.php"], "buggy_code_start_loc": [26], "buggy_code_end_loc": [60], "fixing_code_start_loc": [26], "fixing_code_end_loc": [66], "type": "CWE-22", "message": "A Directory Traversal vulnerability exists in the Xerte Project Xerte through 3.10.3 when downloading a project file via download.php.", "other": {"cve": {"id": "CVE-2021-44665", "sourceIdentifier": "cve@mitre.org", "published": "2022-02-24T21:15:07.667", "lastModified": "2022-03-04T19:28:27.730", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A Directory Traversal vulnerability exists in the Xerte Project Xerte through 3.10.3 when downloading a project file via download.php."}, {"lang": "es", "value": "Se presenta una vulnerabilidad de Salto de Directorio en Xerte Project Xerte versiones hasta 3.10.3, cuando es descargado un archivo de proyecto por medio del archivo download.php"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:P/I:N/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:xerte:xerte:*:*:*:*:*:*:*:*", "versionEndIncluding": "3.10.3", "matchCriteriaId": "DB5008F3-ADAF-42C6-ADFE-D0990AFA8B83"}]}]}], "references": [{"url": "http://packetstormsecurity.com/files/166181/Xerte-3.10.3-Directory-Traversal.html", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory", "VDB Entry"]}, {"url": "https://github.com/thexerteproject/xerteonlinetoolkits/commit/48a9880c6ac38f4d215f9143baf3d6e6062a1871", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thexerteproject/xerteonlinetoolkits/commit/48a9880c6ac38f4d215f9143baf3d6e6062a1871"}}