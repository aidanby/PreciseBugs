{"buggy_code": ["<?php\n/* Copyright (C) 2002-2006 Rodolphe Quiedeville <rodolphe@quiedeville.org>\n * Copyright (C) 2002-2003 Jean-Louis Bergamo   <jlb@j1b.org>\n * Copyright (C) 2004-2020 Laurent Destailleur  <eldy@users.sourceforge.net>\n * Copyright (C) 2004      Eric Seigne          <eric.seigne@ryxeo.com>\n * Copyright (C) 2005-2021 Regis Houssin        <regis.houssin@inodbox.com>\n * Copyright (C) 2005      Lionel Cousteix      <etm_ltd@tiscali.co.uk>\n * Copyright (C) 2011      Herve Prot           <herve.prot@symeos.com>\n * Copyright (C) 2012-2018 Juanjo Menent        <jmenent@2byte.es>\n * Copyright (C) 2013      Florian Henry        <florian.henry@open-concept.pro>\n * Copyright (C) 2013-2016 Alexandre Spangaro   <aspangaro@open-dsi.fr>\n * Copyright (C) 2015-2017 Jean-Fran\u00e7ois Ferry  <jfefe@aternatik.fr>\n * Copyright (C) 2015      Ari Elbaz (elarifr)  <github@accedinfo.com>\n * Copyright (C) 2015-2018 Charlene Benke       <charlie@patas-monkey.com>\n * Copyright (C) 2016      Rapha\u00ebl Doursenaud   <rdoursenaud@gpcsolutions.fr>\n * Copyright (C) 2018-2021  Fr\u00e9d\u00e9ric France     <frederic.france@netlogic.fr>\n * Copyright (C) 2018       David Beniamine     <David.Beniamine@Tetras-Libre.fr>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <https://www.gnu.org/licenses/>.\n */\n\n/**\n *       \\file       htdocs/user/card.php\n *       \\brief      Tab of user card\n */\n\nrequire '../main.inc.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/usergroup.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/contact/class/contact.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/company.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/images.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/usergroups.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/extrafields.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formadmin.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formother.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\nif (!empty($conf->ldap->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/ldap.class.php';\n}\nif (!empty($conf->adherent->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';\n}\nif (!empty($conf->categorie->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/categories/class/categorie.class.php';\n}\nif (!empty($conf->stock->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/product/class/html.formproduct.class.php';\n}\n\n$id = GETPOST('id', 'int');\n$action\t\t= GETPOST('action', 'aZ09');\n$mode = GETPOST('mode', 'alpha');\n$confirm\t= GETPOST('confirm', 'alpha');\n$group = GETPOST(\"group\", \"int\", 3);\n$cancel\t\t= GETPOST('cancel', 'alpha');\n$contextpage = GETPOST('contextpage', 'aZ') ?GETPOST('contextpage', 'aZ') : 'useracard'; // To manage different context of search\n\n$dateemployment = dol_mktime(0, 0, 0, GETPOST('dateemploymentmonth', 'int'), GETPOST('dateemploymentday', 'int'), GETPOST('dateemploymentyear', 'int'));\n$dateemploymentend = dol_mktime(0, 0, 0, GETPOST('dateemploymentendmonth', 'int'), GETPOST('dateemploymentendday', 'int'), GETPOST('dateemploymentendyear', 'int'));\n$datestartvalidity = dol_mktime(0, 0, 0, GETPOST('datestartvaliditymonth', 'int'), GETPOST('datestartvalidityday', 'int'), GETPOST('datestartvalidityyear', 'int'));\n$dateendvalidity = dol_mktime(0, 0, 0, GETPOST('dateendvaliditymonth', 'int'), GETPOST('dateendvalidityday', 'int'), GETPOST('dateendvalidityyear', 'int'));\n$dateofbirth = dol_mktime(0, 0, 0, GETPOST('dateofbirthmonth', 'int'), GETPOST('dateofbirthday', 'int'), GETPOST('dateofbirthyear', 'int'));\n\n// Define value to know what current user can do on users\n$canadduser = (!empty($user->admin) || $user->rights->user->user->creer);\n$canreaduser = (!empty($user->admin) || $user->rights->user->user->lire);\n$canedituser = (!empty($user->admin) || $user->rights->user->user->creer);\n$candisableuser = (!empty($user->admin) || $user->rights->user->user->supprimer);\n$canreadgroup = $canreaduser;\n$caneditgroup = $canedituser;\nif (!empty($conf->global->MAIN_USE_ADVANCED_PERMS)) {\n\t$canreadgroup = (!empty($user->admin) || $user->rights->user->group_advance->read);\n\t$caneditgroup = (!empty($user->admin) || $user->rights->user->group_advance->write);\n}\n\n$childids = $user->getAllChildIds(1);\t// For later, test on salary visibility\n\n// Define value to know what current user can do on properties of edited user\nif ($id > 0) {\n\t// $user is the current logged user, $id is the user we want to edit\n\t$caneditfield = ((($user->id == $id) && $user->rights->user->self->creer) || (($user->id != $id) && $user->rights->user->user->creer));\n\t$caneditpassword = ((($user->id == $id) && $user->rights->user->self->password) || (($user->id != $id) && $user->rights->user->user->password));\n}\n\n// Security check\n$socid = 0;\nif ($user->socid > 0) {\n\t$socid = $user->socid;\n}\n$feature2 = 'user';\n$result = restrictedArea($user, 'user', $id, 'user', $feature2);\n\nif ($user->id != $id && !$canreaduser) {\n\taccessforbidden();\n}\n\n// Load translation files required by page\n$langs->loadLangs(array('users', 'companies', 'ldap', 'admin', 'hrm', 'stocks', 'other'));\n\n$object = new User($db);\n$extrafields = new ExtraFields($db);\n\n// fetch optionals attributes and labels\n$extrafields->fetch_name_optionals_label($object->table_element);\n\n$socialnetworks = getArrayOfSocialNetworks();\n\n// Initialize technical object to manage hooks. Note that conf->hooks_modules contains array\n$hookmanager->initHooks(array('usercard', 'globalcard'));\n\n$error = 0;\n\n\n/**\n * Actions\n */\n\n$parameters = array('id' => $id, 'socid' => $socid, 'group' => $group, 'caneditgroup' => $caneditgroup);\n$reshook = $hookmanager->executeHooks('doActions', $parameters, $object, $action); // Note that $action and $object may have been modified by some hooks\nif ($reshook < 0) {\n\tsetEventMessages($hookmanager->error, $hookmanager->errors, 'errors');\n}\n\nif (empty($reshook)) {\n\t$backurlforlist = DOL_URL_ROOT.'/user/list.php';\n\n\tif (empty($backtopage) || ($cancel && empty($id))) {\n\t\tif (empty($backtopage) || ($cancel && strpos($backtopage, '__ID__'))) {\n\t\t\tif (empty($id) && (($action != 'add' && $action != 'create') || $cancel)) {\n\t\t\t\t$backtopage = $backurlforlist;\n\t\t\t} else {\n\t\t\t\t$backtopage = DOL_URL_ROOT.'/user/card.php?id='.((!empty($id) && $id > 0) ? $id : '__ID__');\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($cancel) {\n\t\tif (!empty($backtopageforcancel)) {\n\t\t\theader(\"Location: \".$backtopageforcancel);\n\t\t\texit;\n\t\t} elseif (!empty($backtopage)) {\n\t\t\theader(\"Location: \".$backtopage);\n\t\t\texit;\n\t\t}\n\t\t$action = '';\n\t}\n\n\tif ($action == 'confirm_disable' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id != $user->id) {\t\t// A user can't disable itself\n\t\t\t$object->fetch($id);\n\t\t\tif ($object->admin && empty($user->admin)) {\n\t\t\t\t// If user to delete is an admin user and if logged user is not admin, we deny the operation.\n\t\t\t\t$error++;\n\t\t\t\tsetEventMessages($langs->trans(\"OnlyAdminUsersCanDisableAdminUsers\"), null, 'errors');\n\t\t\t} else {\n\t\t\t\t$object->setstatus(0);\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'confirm_enable' && $confirm == \"yes\" && $candisableuser) {\n\t\t$error = 0;\n\n\t\tif ($id != $user->id) {\n\t\t\t$object->fetch($id);\n\n\t\t\tif (!empty($conf->file->main_limit_users)) {\n\t\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t\t$error++;\n\t\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$error) {\n\t\t\t\t$object->setstatus(1);\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'confirm_delete' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id != $user->id) {\n\t\t\tif (!GETPOSTISSET('token')) {\n\t\t\t\tprint 'Error, token required for this critical operation';\n\t\t\t\texit;\n\t\t\t}\n\n\t\t\t$object = new User($db);\n\t\t\t$object->fetch($id);\n\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t$result = $object->delete($user);\n\t\t\tif ($result < 0) {\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\tsetEventMessages($langs->trans(\"ErrorUserCannotBeDelete\"), null, 'errors');\n\t\t\t} else {\n\t\t\t\tsetEventMessages($langs->trans(\"RecordDeleted\"), null);\n\t\t\t\theader(\"Location: \".DOL_URL_ROOT.\"/user/list.php?restore_lastsearch_values=1\");\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action Add user\n\tif ($action == 'add' && $canadduser) {\n\t\t$error = 0;\n\n\t\tif (!GETPOST(\"lastname\")) {\n\t\t\t$error++;\n\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\"; // Go back to create page\n\t\t}\n\t\tif (!GETPOST(\"login\")) {\n\t\t\t$error++;\n\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\"; // Go back to create page\n\t\t}\n\n\t\tif (!empty($conf->file->main_limit_users)) { // If option to limit users is set\n\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t$error++;\n\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t$action = \"create\"; // Go back to create page\n\t\t\t}\n\t\t}\n\n\t\tif (!$error) {\n\t\t\t$object->civility_code = GETPOST(\"civility_code\", 'aZ09');\n\t\t\t$object->lastname = GETPOST(\"lastname\", 'alphanohtml');\n\t\t\t$object->firstname = GETPOST(\"firstname\", 'alphanohtml');\n\t\t\t$object->login = GETPOST(\"login\", 'alphanohtml');\n\t\t\t$object->api_key = GETPOST(\"api_key\", 'alphanohtml');\n\t\t\t$object->gender = GETPOST(\"gender\", 'aZ09');\n\t\t\t$object->admin = GETPOST(\"admin\", 'int');\n\t\t\t$object->address = GETPOST('address', 'alphanohtml');\n\t\t\t$object->zip = GETPOST('zipcode', 'alphanohtml');\n\t\t\t$object->town = GETPOST('town', 'alphanohtml');\n\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alphanohtml');\n\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alphanohtml');\n\t\t\t$object->user_mobile = GETPOST(\"user_mobile\", 'alphanohtml');\n\n\t\t\tif (!empty($conf->socialnetworks->enabled)) {\n\t\t\t\t$object->socialnetworks = array();\n\t\t\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\t\t\tif (GETPOST($key, 'alphanohtml')) {\n\t\t\t\t\t\t$object->socialnetworks[$key] = GETPOST($key, 'alphanohtml');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alphanohtml'));\n\t\t\t$object->job = GETPOST(\"job\", 'alphanohtml');\n\t\t\t$object->signature = GETPOST(\"signature\", 'restricthtml');\n\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\", 'alphanohtml');\n\t\t\t$object->note = GETPOST(\"note\", 'restricthtml');\n\t\t\t$object->note_private = GETPOST(\"note\", 'restricthtml');\n\t\t\t$object->ldap_sid = GETPOST(\"ldap_sid\", 'alphanohtml');\n\t\t\t$object->fk_user = GETPOST(\"fk_user\", 'int') > 0 ? GETPOST(\"fk_user\", 'int') : 0;\n\t\t\t$object->fk_user_expense_validator = GETPOST(\"fk_user_expense_validator\", 'int') > 0 ? GETPOST(\"fk_user_expense_validator\", 'int') : 0;\n\t\t\t$object->fk_user_holiday_validator = GETPOST(\"fk_user_holiday_validator\", 'int') > 0 ? GETPOST(\"fk_user_holiday_validator\", 'int') : 0;\n\t\t\t$object->employee = GETPOST('employee', 'alphanohtml');\n\n\t\t\t$object->thm = GETPOST(\"thm\", 'alphanohtml') != '' ? GETPOST(\"thm\", 'alphanohtml') : '';\n\t\t\t$object->thm = price2num($object->thm);\n\t\t\t$object->tjm = GETPOST(\"tjm\", 'alphanohtml') != '' ? GETPOST(\"tjm\", 'alphanohtml') : '';\n\t\t\t$object->tjm = price2num($object->tjm);\n\t\t\t$object->salary = GETPOST(\"salary\", 'alphanohtml') != '' ? GETPOST(\"salary\", 'alphanohtml') : '';\n\t\t\t$object->salary = price2num($object->salary);\n\t\t\t$object->salaryextra = GETPOST(\"salaryextra\", 'alphanohtml') != '' ? GETPOST(\"salaryextra\", 'alphanohtml') : '';\n\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\", 'alphanohtml') != '' ? GETPOST(\"weeklyhours\", 'alphanohtml') : '';\n\n\t\t\t$object->color = GETPOST(\"color\", 'alphanohtml') != '' ? GETPOST(\"color\", 'alphanohtml') : '';\n\n\t\t\t$object->dateemployment = $dateemployment;\n\t\t\t$object->dateemploymentend = $dateemploymentend;\n\t\t\t$object->datestartvalidity = $datestartvalidity;\n\t\t\t$object->dateendvalidity = $dateendvalidity;\n\t\t\t$object->birth = $dateofbirth;\n\n\t\t\t$object->fk_warehouse = GETPOST('fk_warehouse', 'int');\n\n\t\t\t$object->lang = GETPOST('default_lang', 'aZ09');\n\n\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t$ret = $extrafields->setOptionalsFromPost(null, $object);\n\t\t\tif ($ret < 0) {\n\t\t\t\t$error++;\n\t\t\t}\n\n\t\t\t// Set entity property\n\t\t\t$entity = GETPOST('entity', 'int');\n\t\t\tif (!empty($conf->multicompany->enabled)) {\n\t\t\t\tif (GETPOST('superadmin', 'int')) {\n\t\t\t\t\t$object->entity = 0;\n\t\t\t\t} else {\n\t\t\t\t\tif (!empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t\t\t\t$object->entity = 1; // all users are forced into master entity\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t/*if ($user->admin && $user->entity == 0 && GETPOST(\"admin\",'alpha'))\n\t\t\t\t{\n\t\t\t\t}*/\n\t\t\t}\n\n\t\t\t$db->begin();\n\n\t\t\t$id = $object->create($user);\n\t\t\tif ($id > 0) {\n\t\t\t\tif (GETPOST('password', 'none')) {\n\t\t\t\t\t$object->setPassword($user, GETPOST('password', 'none'));\n\t\t\t\t}\n\t\t\t\tif (!empty($conf->categorie->enabled)) {\n\t\t\t\t\t// Categories association\n\t\t\t\t\t$usercats = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($usercats);\n\t\t\t\t}\n\t\t\t\t$db->commit();\n\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t} else {\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t$db->rollback();\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t$action = \"create\"; // Go back to create page\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action add usergroup\n\tif (($action == 'addgroup' || $action == 'removegroup') && $caneditgroup) {\n\t\tif ($group) {\n\t\t\t$editgroup = new UserGroup($db);\n\t\t\t$editgroup->fetch($group);\n\t\t\t$editgroup->oldcopy = clone $editgroup;\n\n\t\t\t$object->fetch($id);\n\t\t\tif ($action == 'addgroup') {\n\t\t\t\t$result = $object->SetInGroup($group, $editgroup->entity);\n\t\t\t}\n\t\t\tif ($action == 'removegroup') {\n\t\t\t\t$result = $object->RemoveFromGroup($group, $editgroup->entity);\n\t\t\t}\n\n\t\t\tif ($result > 0) {\n\t\t\t\t$action = '';\n\t\t\t} else {\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'update' && !$cancel) {\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';\n\n\t\tif ($caneditfield) {    // Case we can edit all field\n\t\t\t$error = 0;\n\n\t\t\tif (!GETPOST(\"lastname\", 'alpha')) {\n\t\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\"; // Go back to create page\n\t\t\t\t$error++;\n\t\t\t}\n\t\t\tif (!GETPOST(\"login\", 'alpha')) {\n\t\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\"; // Go back to create page\n\t\t\t\t$error++;\n\t\t\t}\n\n\t\t\tif (!$error) {\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t$db->begin();\n\n\t\t\t\t$object->civility_code = GETPOST(\"civility_code\", 'aZ09');\n\t\t\t\t$object->lastname = GETPOST(\"lastname\", 'alphanohtml');\n\t\t\t\t$object->firstname = GETPOST(\"firstname\", 'alphanohtml');\n\t\t\t\t$object->login = GETPOST(\"login\", 'alphanohtml');\n\t\t\t\t$object->gender = GETPOST(\"gender\", 'aZ09');\n\t\t\t\t$object->pass = GETPOST(\"password\", 'none');\t// We can keep 'none' for password fields\n\t\t\t\t$object->api_key = (GETPOST(\"api_key\", 'alphanohtml')) ? GETPOST(\"api_key\", 'alphanohtml') : $object->api_key;\n\t\t\t\tif (!empty($user->admin)) {\n\t\t\t\t\t$object->admin = GETPOST(\"admin\", \"int\"); // admin flag can only be set/unset by an admin user. A test is also done later when forging sql request\n\t\t\t\t}\n\t\t\t\t$object->address = GETPOST('address', 'alphanohtml');\n\t\t\t\t$object->zip = GETPOST('zipcode', 'alphanohtml');\n\t\t\t\t$object->town = GETPOST('town', 'alphanohtml');\n\t\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alphanohtml');\n\t\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alphanohtml');\n\t\t\t\t$object->user_mobile = GETPOST(\"user_mobile\", 'alphanohtml');\n\n\t\t\t\tif (!empty($conf->socialnetworks->enabled)) {\n\t\t\t\t\t$object->socialnetworks = array();\n\t\t\t\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\t\t\t\tif (GETPOST($key, 'alphanohtml')) {\n\t\t\t\t\t\t\t$object->socialnetworks[$key] = GETPOST($key, 'alphanohtml');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alphanohtml'));\n\t\t\t\t$object->job = GETPOST(\"job\", 'alphanohtml');\n\t\t\t\t$object->signature = GETPOST(\"signature\", 'restricthtml');\n\t\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\", 'alphanohtml');\n\t\t\t\t$object->openid = GETPOST(\"openid\", 'alphanohtml');\n\t\t\t\t$object->fk_user = GETPOST(\"fk_user\", 'int') > 0 ? GETPOST(\"fk_user\", 'int') : 0;\n\t\t\t\t$object->fk_user_expense_validator = GETPOST(\"fk_user_expense_validator\", 'int') > 0 ? GETPOST(\"fk_user_expense_validator\", 'int') : 0;\n\t\t\t\t$object->fk_user_holiday_validator = GETPOST(\"fk_user_holiday_validator\", 'int') > 0 ? GETPOST(\"fk_user_holiday_validator\", 'int') : 0;\n\t\t\t\t$object->employee = GETPOST('employee', 'int');\n\n\t\t\t\t$object->thm = GETPOST(\"thm\", 'alphanohtml') != '' ? GETPOST(\"thm\", 'alphanohtml') : '';\n\t\t\t\t$object->thm = price2num($object->thm);\n\t\t\t\t$object->tjm = GETPOST(\"tjm\", 'alphanohtml') != '' ? GETPOST(\"tjm\", 'alphanohtml') : '';\n\t\t\t\t$object->thm = price2num($object->thm);\n\t\t\t\t$object->salary = GETPOST(\"salary\", 'alphanohtml') != '' ? GETPOST(\"salary\", 'alphanohtml') : '';\n\t\t\t\t$object->salary = price2num($object->salary);\n\t\t\t\t$object->salaryextra = GETPOST(\"salaryextra\", 'alphanohtml') != '' ? GETPOST(\"salaryextra\", 'alphanohtml') : '';\n\t\t\t\t$object->salaryextra = price2num($object->salaryextra);\n\t\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\", 'alphanohtml') != '' ? GETPOST(\"weeklyhours\", 'alphanohtml') : '';\n\t\t\t\t$object->weeklyhours = price2num($object->weeklyhours);\n\n\t\t\t\t$object->color = GETPOST(\"color\", 'alphanohtml') != '' ? GETPOST(\"color\", 'alphanohtml') : '';\n\t\t\t\t$object->dateemployment = $dateemployment;\n\t\t\t\t$object->dateemploymentend = $dateemploymentend;\n\t\t\t\t$object->datestartvalidity = $datestartvalidity;\n\t\t\t\t$object->dateendvalidity = $dateendvalidity;\n\t\t\t\t$object->birth = $dateofbirth;\n\n\t\t\t\tif (!empty($conf->stock->enabled)) {\n\t\t\t\t\t$object->fk_warehouse = GETPOST('fk_warehouse', 'int');\n\t\t\t\t}\n\n\t\t\t\t$object->lang = GETPOST('default_lang', 'aZ09');\n\n\t\t\t\t// Do we update also ->entity ?\n\t\t\t\tif (!empty($conf->multicompany->enabled && $user->entity == 0 && !empty($user->admin))) {\t// If multicompany is not enabled, we never update the entity of a user.\n\t\t\t\t\tif (GETPOST('superadmin', 'int')) {\n\t\t\t\t\t\t$object->entity = 0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t\t\t\t\t$object->entity = 1; // all users are in master entity\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// We try to change the entity of user\n\t\t\t\t\t\t\t$object->entity = (GETPOSTISSET('entity') ? GETPOSTINT('entity') : $object->entity);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t\t$ret = $extrafields->setOptionalsFromPost(null, $object, '@GETPOSTISSET');\n\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t$error++;\n\t\t\t\t}\n\n\t\t\t\tif (GETPOST('deletephoto')) {\n\t\t\t\t\t$object->photo = '';\n\t\t\t\t}\n\t\t\t\tif (!empty($_FILES['photo']['name'])) {\n\t\t\t\t\t$isimage = image_format_supported($_FILES['photo']['name']);\n\t\t\t\t\tif ($isimage > 0) {\n\t\t\t\t\t\t$object->photo = dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorBadImageFormat\"), null, 'errors');\n\t\t\t\t\t\tdol_syslog($langs->transnoentities(\"ErrorBadImageFormat\"), LOG_INFO);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error) {\n\t\t\t\t\t$ret = $object->update($user);\n\t\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\tif ($db->errno() == 'DB_ERROR_RECORD_ALREADY_EXISTS') {\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorLoginAlreadyExists\", $object->login), null, 'errors');\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t\t\t\t$action = 'edit';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && GETPOSTISSET('contactid')) {\n\t\t\t\t\t$contactid = GETPOST('contactid', 'int');\n\t\t\t\t\t$socid = GETPOST('socid', 'int');\n\n\t\t\t\t\tif ($contactid > 0) {\t// The 'contactid' is used inpriority over the 'socid'\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($contactid);\n\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=\".((int) $contactid);\n\t\t\t\t\t\tif (!empty($contact->socid)) {\n\t\t\t\t\t\t\t$sql .= \", fk_soc=\".((int) $contact->socid);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$sql .= \" WHERE rowid = \".((int) $object->id);\n\t\t\t\t\t} elseif ($socid > 0) {\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=NULL, fk_soc=\".((int) $socid);\n\t\t\t\t\t\t$sql .= \" WHERE rowid = \".((int) $object->id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=NULL, fk_soc=NULL\";\n\t\t\t\t\t\t$sql .= \" WHERE rowid = \".((int) $object->id);\n\t\t\t\t\t}\n\t\t\t\t\tdol_syslog(\"usercard::update\", LOG_DEBUG);\n\t\t\t\t\t$resql = $db->query($sql);\n\t\t\t\t\tif (!$resql) {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\tsetEventMessages($db->lasterror(), null, 'errors');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tif (GETPOST('deletephoto') && $object->oldcopy->photo) {\n\t\t\t\t\t\t$fileimg = $conf->user->dir_output.'/'.get_exdir(0, 0, 0, 0, $object, 'user').'photos/'.$object->oldcopy->photo;\n\t\t\t\t\t\t$dirthumbs = $conf->user->dir_output.'/'.get_exdir(0, 0, 0, 0, $object, 'user').'photos/thumbs';\n\t\t\t\t\t\tdol_delete_file($fileimg);\n\t\t\t\t\t\tdol_delete_dir_recursive($dirthumbs);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isset($_FILES['photo']['tmp_name']) && trim($_FILES['photo']['tmp_name'])) {\n\t\t\t\t\t\t$dir = $conf->user->dir_output.'/'.get_exdir(0, 0, 0, 1, $object, 'user').'/photos';\n\n\t\t\t\t\t\tdol_mkdir($dir);\n\n\t\t\t\t\t\tif (@is_dir($dir)) {\n\t\t\t\t\t\t\t$newfile = $dir.'/'.dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t\t\t\t$result = dol_move_uploaded_file($_FILES['photo']['tmp_name'], $newfile, 1, 0, $_FILES['photo']['error']);\n\n\t\t\t\t\t\t\tif (!$result > 0) {\n\t\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSaveFile\"), null, 'errors');\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// Create thumbs\n\t\t\t\t\t\t\t\t$object->addThumbs($newfile);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToCreateDir\", $dir), $mesgs, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\t// Then we add the associated categories\n\t\t\t\t\t$categories = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($categories);\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tsetEventMessages($langs->trans(\"UserModified\"), null, 'mesgs');\n\t\t\t\t\t$db->commit();\n\n\t\t\t\t\t$login = $_SESSION[\"dol_login\"];\n\t\t\t\t\tif ($login && $login == $object->oldcopy->login && $object->oldcopy->login != $object->login) {    // Current user has changed its login\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\tsetEventMessages($langs->transnoentitiesnoconv(\"WarningYourLoginWasModifiedPleaseLogin\"), null, 'warnings');\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$db->rollback();\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tif ($caneditpassword) {    // Case we can edit only password\n\t\t\t\tdol_syslog(\"Not allowed to change fields, only password\");\n\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\tif (GETPOST(\"password\", \"none\")) {\t// If pass is empty, we do not change it.\n\t\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t\t$ret = $object->setPassword($user, GETPOST(\"password\", \"none\"));\n\t\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Change password with a new generated one\n\tif ((($action == 'confirm_password' && $confirm == 'yes')\n\t\t\t|| ($action == 'confirm_passwordsend' && $confirm == 'yes')) && $caneditpassword\n\t) {\n\t\t$object->fetch($id);\n\n\t\t$newpassword = $object->setPassword($user, '');\t// This will generate a new password\n\t\tif ($newpassword < 0) {\n\t\t\t// Echec\n\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSetNewPassword\"), null, 'errors');\n\t\t} else {\n\t\t\t// Succes\n\t\t\tif ($action == 'confirm_passwordsend' && $confirm == 'yes') {\n\t\t\t\tif ($object->send_password($user, $newpassword) > 0) {\n\t\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedAndSentTo\", $object->email), null, 'mesgs');\n\t\t\t\t} else {\n\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedTo\", $newpassword), null, 'warnings');\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action initialisation donnees depuis record LDAP\n\tif ($action == 'adduserldap' && $canadduser) {\n\t\t$selecteduser = GETPOST('users');\n\n\t\t$required_fields = array(\n\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t);\n\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0) {\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields = array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t$ldapusers = $ldap->getRecords($selecteduser, $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields);\n\t\t\t//print_r($ldapusers);\n\n\t\t\tif (is_array($ldapusers)) {\n\t\t\t\tforeach ($ldapusers as $key => $attribute) {\n\t\t\t\t\t$ldap_lastname = $attribute[$conf->global->LDAP_FIELD_NAME];\n\t\t\t\t\t$ldap_firstname = $attribute[$conf->global->LDAP_FIELD_FIRSTNAME];\n\t\t\t\t\t$ldap_login = $attribute[$conf->global->LDAP_FIELD_LOGIN];\n\t\t\t\t\t$ldap_loginsmb = $attribute[$conf->global->LDAP_FIELD_LOGIN_SAMBA];\n\t\t\t\t\t$ldap_pass = $attribute[$conf->global->LDAP_FIELD_PASSWORD];\n\t\t\t\t\t$ldap_pass_crypted = $attribute[$conf->global->LDAP_FIELD_PASSWORD_CRYPTED];\n\t\t\t\t\t$ldap_phone = $attribute[$conf->global->LDAP_FIELD_PHONE];\n\t\t\t\t\t$ldap_fax = $attribute[$conf->global->LDAP_FIELD_FAX];\n\t\t\t\t\t$ldap_mobile = $attribute[$conf->global->LDAP_FIELD_MOBILE];\n\t\t\t\t\t$ldap_social['skype'] = $attribute[$conf->global->LDAP_FIELD_SKYPE];\n\t\t\t\t\t$ldap_social['twitter'] = $attribute[$conf->global->LDAP_FIELD_TWITTER];\n\t\t\t\t\t$ldap_social['facebook'] = $attribute[$conf->global->LDAP_FIELD_FACEBOOK];\n\t\t\t\t\t$ldap_social['linkedin'] = $attribute[$conf->global->LDAP_FIELD_LINKEDIN];\n\t\t\t\t\t$ldap_mail = $attribute[$conf->global->LDAP_FIELD_MAIL];\n\t\t\t\t\t$ldap_sid = $attribute[$conf->global->LDAP_FIELD_SID];\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\t}\n\n\t// Actions to send emails\n\t$triggersendname = 'USER_SENTBYMAIL';\n\t$paramname = 'id'; // Name of param key to open the card\n\t$mode = 'emailfromuser';\n\t$trackid = 'use'.$id;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_sendmails.inc.php';\n\n\t// Actions to build doc\n\t$upload_dir = $conf->user->dir_output;\n\t$permissiontoadd = $user->rights->user->user->creer;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_builddoc.inc.php';\n}\n\n\n/*\n * View\n */\n\n$form = new Form($db);\n$formother = new FormOther($db);\n$formcompany = new FormCompany($db);\n$formadmin = new FormAdmin($db);\n$formfile = new FormFile($db);\nif (!empty($conf->stock->enabled)) {\n\t$formproduct = new FormProduct($db);\n}\n\nllxHeader('', $langs->trans(\"UserCard\"));\n\nif ($action == 'create' || $action == 'adduserldap') {\n\tprint load_fiche_titre($langs->trans(\"NewUser\"), '', 'user');\n\n\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"CreateInternalUserDesc\").\"</span><br>\\n\";\n\tprint \"<br>\";\n\n\n\tif (!empty($conf->ldap->enabled) && (isset($conf->global->LDAP_SYNCHRO_ACTIVE) && getDolGlobalInt('LDAP_SYNCHRO_ACTIVE') === Ldap::SYNCHRO_LDAP_TO_DOLIBARR)) {\n\t\t// Show form to add an account from LDAP if sync LDAP -> Dolibarr is set\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0) {\n\t\t\t$required_fields = array(\n\t\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t\t$conf->global->LDAP_FIELD_FULLNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t\t);\n\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields = array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t// Get from LDAP database an array of results\n\t\t\t$ldapusers = $ldap->getRecords('*', $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields, 1);\n\n\t\t\tif (is_array($ldapusers)) {\n\t\t\t\t$liste = array();\n\t\t\t\tforeach ($ldapusers as $key => $ldapuser) {\n\t\t\t\t\t// Define the label string for this user\n\t\t\t\t\t$label = '';\n\t\t\t\t\tforeach ($required_fields as $value) {\n\t\t\t\t\t\tif ($value === $conf->global->LDAP_FIELD_PASSWORD || $value === $conf->global->LDAP_FIELD_PASSWORD_CRYPTED) {\n\t\t\t\t\t\t\t$label .= $value.\"=******* \";\n\t\t\t\t\t\t} elseif ($value) {\n\t\t\t\t\t\t\t$label .= $value.\"=\".$ldapuser[$value].\" \";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$liste[$key] = $label;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t}\n\t\t} else {\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\n\t\t// If user list is full, we show drop-down list\n\t\tprint \"\\n\\n<!-- Form liste LDAP debut -->\\n\";\n\n\t\tprint '<form name=\"add_user_ldap\" action=\"'.$_SERVER[\"PHP_SELF\"].'\" method=\"post\">';\n\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\">';\n\t\tprint '<table class=\"border centpercent\"><tr>';\n\t\tprint '<td width=\"160\">';\n\t\tprint $langs->trans(\"LDAPUsers\");\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input type=\"hidden\" name=\"action\" value=\"adduserldap\">';\n\t\tif (is_array($liste) && count($liste)) {\n\t\t\tprint $form->selectarray('users', $liste, '', 1, 0, 0, '', 0, 0, 0, '', 'maxwidth500');\n\t\t\tprint ajax_combobox('users');\n\t\t}\n\t\tprint '</td><td class=\"center\">';\n\t\tprint '<input type=\"submit\" class=\"button\" value=\"'.dol_escape_htmltag($langs->trans('Get')).'\"'.(count($liste) ? '' : ' disabled').'>';\n\t\tprint '</td></tr></table>';\n\t\tprint '</form>';\n\n\t\tprint \"\\n<!-- Form liste LDAP fin -->\\n\\n\";\n\t\tprint '<br>';\n\t}\n\n\n\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'\" method=\"POST\" name=\"createuser\">';\n\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\">';\n\tprint '<input type=\"hidden\" name=\"action\" value=\"add\">';\n\tif (!empty($ldap_sid)) {\n\t\tprint '<input type=\"hidden\" name=\"ldap_sid\" value=\"'.dol_escape_htmltag($ldap_sid).'\">';\n\t}\n\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\">';\n\n\tprint dol_get_fiche_head('', '', '', 0, '');\n\n\tdol_set_focus('#lastname');\n\n\tprint '<table class=\"border centpercent\">';\n\n\t// Civility\n\tprint '<tr><td><label for=\"civility_code\">'.$langs->trans(\"UserTitle\").'</label></td><td colspan=\"3\">';\n\tprint $formcompany->select_civility(GETPOSTISSET(\"civility_code\") ? GETPOST(\"civility_code\", 'aZ09') : $object->civility_code, 'civility_code');\n\tprint '</td></tr>';\n\n\t// Lastname\n\tprint '<tr>';\n\tprint '<td class=\"titlefieldcreate\"><span class=\"fieldrequired\">'.$langs->trans(\"Lastname\").'</span></td>';\n\tprint '<td>';\n\tif (!empty($ldap_lastname)) {\n\t\tprint '<input type=\"hidden\" id=\"lastname\" name=\"lastname\" value=\"'.dol_escape_htmltag($ldap_lastname).'\">';\n\t\tprint $ldap_lastname;\n\t} else {\n\t\tprint '<input class=\"minwidth100 maxwidth150onsmartphone\" type=\"text\" id=\"lastname\" name=\"lastname\" value=\"'.dol_escape_htmltag(GETPOST('lastname', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Firstname\n\tprint '<tr><td>'.$langs->trans(\"Firstname\").'</td>';\n\tprint '<td>';\n\tif (!empty($ldap_firstname)) {\n\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.dol_escape_htmltag($ldap_firstname).'\">';\n\t\tprint $ldap_firstname;\n\t} else {\n\t\tprint '<input class=\"minwidth100 maxwidth150onsmartphone\" type=\"text\" name=\"firstname\" value=\"'.dol_escape_htmltag(GETPOST('firstname', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Login\n\tprint '<tr><td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\tprint '<td>';\n\tif (!empty($ldap_login)) {\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.dol_escape_htmltag($ldap_login).'\">';\n\t\tprint $ldap_login;\n\t} elseif (!empty($ldap_loginsmb)) {\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.dol_escape_htmltag($ldap_loginsmb).'\">';\n\t\tprint $ldap_loginsmb;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 maxwidth150onsmartphone\" maxsize=\"24\" type=\"text\" name=\"login\" value=\"'.dol_escape_htmltag(GETPOST('login', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t$generated_password = '';\n\tif (empty($ldap_sid)) {    // ldap_sid is for activedirectory\n\t\t$generated_password = getRandomPassword(false);\n\t}\n\t$password = (GETPOSTISSET('password') ?GETPOST('password') : $generated_password);\n\n\t// Administrator\n\tif (!empty($user->admin)) {\n\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\tprint '<td>';\n\t\tprint $form->selectyesno('admin', GETPOST('admin'), 1);\n\n\t\tif (!empty($conf->multicompany->enabled) && !$user->entity) {\n\t\t\tif (!empty($conf->use_javascript_ajax)) {\n\t\t\t\tprint '<script type=\"text/javascript\">\n                            $(function() {\n                                $(\"select[name=admin]\").change(function() {\n                                     if ( $(this).val() == 0 ) {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", true)\n                                            .prop(\"checked\", false);\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                     } else {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", false);\n                                     }\n                                });\n                                $(\"input[name=superadmin]\").change(function() {\n                                    if ( $(this).is(\":checked\") ) {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", true);\n                                    } else {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                    }\n                                });\n                            });\n                    </script>';\n\t\t\t}\n\t\t\t$checked = (GETPOST('superadmin', 'int') ? ' checked' : '');\n\t\t\t$disabled = (GETPOST('superadmin', 'int') ? '' : ' disabled');\n\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" id=\"superadmin\" value=\"1\"'.$checked.$disabled.' /> <label for=\"superadmin\">'.$langs->trans(\"SuperAdministrator\").'</span>';\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t}\n\n\t// Gender\n\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\tprint '<td>';\n\t$arraygender = array('man'=>$langs->trans(\"Genderman\"), 'woman'=>$langs->trans(\"Genderwoman\"), 'other'=>$langs->trans(\"Genderother\"));\n\tprint $form->selectarray('gender', $arraygender, GETPOST('gender'), 1);\n\tprint '</td></tr>';\n\n\t// Employee\n\t$defaultemployee = '1';\n\tprint '<tr>';\n\tprint '<td>'.$langs->trans('Employee').'</td><td>';\n\tprint '<input type=\"checkbox\" name=\"employee\" value=\"1\"'.(GETPOST('employee') == '1' ? ' checked=\"checked\"' : ($defaultemployee ? ' checked=\"checked\"' : '')).'>';\n\t//print $form->selectyesno(\"employee\", (GETPOST('employee') != '' ?GETPOST('employee') : $defaultemployee), 1);\n\tprint '</td></tr>';\n\n\t// Hierarchy\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'user', 'class=\"pictofixedwidth\"').$form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300 widthcentpercentminusx');\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Expense report validator\n\tif (!empty($conf->expensereport->enabled)) {\n\t\tprint '<tr><td class=\"titlefieldcreate\">';\n\t\t$text = $langs->trans(\"ForceUserExpenseValidator\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint img_picto('', 'user', 'class=\"pictofixedwidth\"').$form->select_dolusers($object->fk_user_expense_validator, 'fk_user_expense_validator', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300 widthcentpercentminusx');\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// Holiday request validator\n\tif (!empty($conf->holiday->enabled)) {\n\t\tprint '<tr><td class=\"titlefieldcreate\">';\n\t\t$text = $langs->trans(\"ForceUserHolidayValidator\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint img_picto('', 'user', 'class=\"pictofixedwidth\"').$form->select_dolusers($object->fk_user_holiday_validator, 'fk_user_holiday_validator', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300 widthcentpercentminusx');\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// External user\n\tprint '<tr><td>'.$langs->trans(\"ExternalUser\").' ?</td>';\n\tprint '<td>';\n\tprint $form->textwithpicto($langs->trans(\"Internal\"), $langs->trans(\"InternalExternalDesc\"), 1, 'help', '', 0, 2);\n\tprint '</td></tr>';\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// Date validity\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"RangeOfLoginValidity\").'</td>';\n\tprint '<td>';\n\tprint $form->selectDate($datestartvalidity, 'datestartvalidity', 0, 0, 1, 'formdatestartvalidity', 1, 1);\n\n\tprint ' &nbsp; ';\n\n\tprint $form->selectDate($dateendvalidity, 'dateendvalidity', 0, 0, 1, 'formdateendvalidity', 1, 0);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Password\n\tprint '<tr><td class=\"fieldrequired\">'.$langs->trans(\"Password\").'</td>';\n\tprint '<td>';\n\t$valuetoshow = '';\n\tif (preg_match('/ldap/', $dolibarr_main_authentication)) {\n\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t}\n\tif (preg_match('/http/', $dolibarr_main_authentication)) {\n\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').$langs->trans(\"HTTPBasicPassword\");\n\t}\n\tif (preg_match('/dolibarr/', $dolibarr_main_authentication)) {\n\t\tif (!empty($ldap_pass)) {\t// For very old system comaptibilty. Now clear password can't be viewed from LDAP read\n\t\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').'<input type=\"hidden\" name=\"password\" value=\"'.$ldap_pass.'\">'; // Dolibarr password is preffiled with LDAP known password\n\t\t\t$valuetoshow .= preg_replace('/./i', '*', $ldap_pass);\n\t\t} else {\n\t\t\t// We do not use a field password but a field text to show new password to use.\n\t\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').'<input maxsize=\"32\" type=\"text\" name=\"password\" value=\"'.$password.'\" autocomplete=\"new-password\">';\n\t\t}\n\t}\n\n\t// Other form for user password\n\t$parameters = array('valuetoshow' => $valuetoshow, 'password' => $password);\n\t$reshook = $hookmanager->executeHooks('printUserPasswordField', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\tif ($reshook > 0) {\n\t\t$valuetoshow = $hookmanager->resPrint; // to replace\n\t} else {\n\t\t$valuetoshow .= $hookmanager->resPrint; // to add\n\t}\n\n\tprint $valuetoshow;\n\tprint '</td></tr>';\n\n\tif (!empty($conf->api->enabled)) {\n\t\t// API key\n\t\t//$generated_password = getRandomPassword(false);\n\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input class=\"minwidth300 widthcentpercentminusx\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.GETPOST('api_key', 'alphanohtml').'\" autocomplete=\"off\">';\n\t\tif (!empty($conf->use_javascript_ajax)) {\n\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\t}\n\t\tprint '</td></tr>';\n\t} else {\n\t\t// PARTIAL WORKAROUND\n\t\t$generated_fake_api_key = getRandomPassword(false);\n\t\tprint '<input type=\"hidden\" name=\"api_key\" value=\"'.$generated_fake_api_key.'\">';\n\t}\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// Address\n\tprint '<tr><td class=\"tdtop titlefieldcreate\">'.$form->editfieldkey('Address', 'address', '', $object, 0).'</td>';\n\tprint '<td><textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\tprint $object->address;\n\tprint '</textarea></td></tr>';\n\n\t// Zip\n\tprint '<tr><td>'.$form->editfieldkey('Zip', 'zipcode', '', $object, 0).'</td><td>';\n\tprint $formcompany->select_ziptown($object->zip, 'zipcode', array('town', 'selectcountry_id', 'state_id'), 6);\n\tprint '</td></tr>';\n\n\t// Town\n\tprint '<tr><td>'.$form->editfieldkey('Town', 'town', '', $object, 0).'</td><td>';\n\tprint $formcompany->select_ziptown($object->town, 'town', array('zipcode', 'selectcountry_id', 'state_id'));\n\tprint '</td></tr>';\n\n\t// Country\n\tprint '<tr><td>'.$form->editfieldkey('Country', 'selectcountry_id', '', $object, 0).'</td><td class=\"maxwidthonsmartphone\">';\n\tprint img_picto('', 'country', 'class=\"pictofixedwidth\"');\n\tprint $form->select_country((GETPOST('country_id') != '' ?GETPOST('country_id') : $object->country_id));\n\tif ($user->admin) {\n\t\tprint info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"), 1);\n\t}\n\tprint '</td></tr>';\n\n\t// State\n\tif (empty($conf->global->USER_DISABLE_STATE)) {\n\t\tprint '<tr><td>'.$form->editfieldkey('State', 'state_id', '', $object, 0).'</td><td class=\"maxwidthonsmartphone\">';\n\t\tprint img_picto('', 'state', 'class=\"pictofixedwidth\"');\n\t\tprint $formcompany->select_state($object->state_id, $object->country_code, 'state_id');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Tel\n\tprint '<tr><td>'.$langs->trans(\"PhonePro\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_phoning', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_phone)) {\n\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.dol_escape_htmltag($ldap_phone).'\">';\n\t\tprint $ldap_phone;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"office_phone\" value=\"'.dol_escape_htmltag(GETPOST('office_phone', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Tel portable\n\tprint '<tr><td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_phoning_mobile', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_mobile)) {\n\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.dol_escape_htmltag($ldap_mobile).'\">';\n\t\tprint $ldap_mobile;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"user_mobile\" value=\"'.dol_escape_htmltag(GETPOST('user_mobile', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Fax\n\tprint '<tr><td>'.$langs->trans(\"Fax\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_phoning_fax', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_fax)) {\n\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.dol_escape_htmltag($ldap_fax).'\">';\n\t\tprint $ldap_fax;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"office_fax\" value=\"'.dol_escape_htmltag(GETPOST('office_fax', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// EMail\n\tprint '<tr><td'.(!empty($conf->global->USER_MAIL_REQUIRED) ? ' class=\"fieldrequired\"' : '').'>'.$langs->trans(\"EMail\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_email', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_mail)) {\n\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.dol_escape_htmltag($ldap_mail).'\">';\n\t\tprint $ldap_mail;\n\t} else {\n\t\tprint '<input type=\"text\" name=\"email\" class=\"maxwidth500 widthcentpercentminusx\" value=\"'.dol_escape_htmltag(GETPOST('email', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Social networks\n\tif (!empty($conf->socialnetworks->enabled)) {\n\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\tif ($value['active']) {\n\t\t\t\tprint '<tr><td>'.$langs->trans($value['label']).'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($value['icon'])) {\n\t\t\t\t\tprint '<span class=\"fa '.$value['icon'].' pictofixedwidth\"></span>';\n\t\t\t\t}\n\t\t\t\tif (!empty($ldap_social[$key])) {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$ldap_social[$key].'\">';\n\t\t\t\t\tprint $ldap_social[$key];\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"'.$key.'\" value=\"'.GETPOST($key, 'alphanohtml').'\">';\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t} else {\n\t\t\t\t// if social network is not active but value exist we do not want to loose it\n\t\t\t\tif (!empty($ldap_social[$key])) {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$ldap_social[$key].'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.GETPOST($key, 'alphanohtml').'\">';\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Accountancy code\n\tif (!empty($conf->accounting->enabled)) {\n\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input type=\"text\" class=\"maxwidthonsmartphone\" name=\"accountancy_code\" value=\"'.dol_escape_htmltag(GETPOST('accountancy_code', 'alphanohtml')).'\">';\n\t\tprint '</td></tr>';\n\t}\n\n\t// User color\n\tif (!empty($conf->agenda->enabled)) {\n\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\tprint '<td>';\n\t\tprint $formother->selectColor(GETPOSTISSET('color') ?GETPOST('color', 'alphanohtml') : $object->color, 'color', null, 1, '', 'hideifnotset');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Categories\n\tif (!empty($conf->categorie->enabled) && !empty($user->rights->categorie->lire)) {\n\t\tprint '<tr><td>'.$form->editfieldkey('Categories', 'usercats', '', $object, 0).'</td><td>';\n\t\t$cate_arbo = $form->select_all_categories('user', null, 'parent', null, null, 1);\n\t\tprint img_picto('', 'category', 'class=\"pictofixedwidth\"').$form->multiselectarray('usercats', $cate_arbo, GETPOST('usercats', 'array'), 0, 0, 'maxwdith300 widthcentpercentminusx', 0, '90%');\n\t\tprint \"</td></tr>\";\n\t}\n\n\tif (!empty($conf->global->MAIN_MULTILANGS)) {\n\t\tprint '<tr><td>'.$form->editfieldkey('DefaultLang', 'default_lang', '', $object, 0, 'string', '', 0, 0, 'id', $langs->trans(\"WarningNotLangOfInterface\", $langs->transnoentitiesnoconv(\"UserGUISetup\"))).'</td>';\n\t\tprint '<td class=\"maxwidthonsmartphone\">'.\"\\n\";\n\t\tprint img_picto('', 'language', 'class=\"pictofixedwidth\"').$formadmin->select_language(GETPOST('default_lang', 'alpha') ?GETPOST('default_lang', 'alpha') : ($object->lang ? $object->lang : ''), 'default_lang', 0, 0, 1, 0, 0, 'maxwidth200onsmartphone widthcentpercentminusx');\n\t\tprint '</td>';\n\t\tprint '</tr>';\n\t}\n\n\t// Multicompany\n\tif (!empty($conf->multicompany->enabled) && is_object($mc)) {\n\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\tif (!method_exists($mc, 'formObjectOptions')) {\n\t\t\tif (empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && !$user->entity) {\t// condition must be same for create and edit mode\n\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t\t\t\t print \"<td>\".$mc->select_entities($conf->entity);\n\t\t\t\t print \"</td></tr>\\n\";\n\t\t\t} else {\n\t\t\t\t print '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t}\n\t\t}\n\t}\n\n\t// Other attributes\n\t$parameters = array();\n\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_add.tpl.php';\n\n\t// Note\n\tprint '<tr><td class=\"tdtop\">';\n\tprint $langs->trans(\"Note\");\n\tprint '</td><td>';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor = new DolEditor('note', GETPOSTISSET('note') ? GETPOST('note', 'restricthtml') : '', '', 120, 'dolibarr_notes', '', false, true, getDolGlobalString('FCKEDITOR_ENABLE_SOCIETE'), ROWS_3, '90%');\n\t$doleditor->Create();\n\tprint \"</td></tr>\\n\";\n\n\t// Signature\n\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\tprint '<td class=\"wordbreak\">';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor = new DolEditor('signature', GETPOST('signature', 'restricthtml'), '', 138, 'dolibarr_notes', 'In', true, true, empty($conf->global->FCKEDITOR_ENABLE_USERSIGN) ? 0 : 1, ROWS_4, '90%');\n\tprint $doleditor->Create(1);\n\tprint '</td></tr>';\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t// Default warehouse\n\tif (!empty($conf->stock->enabled) && !empty($conf->global->MAIN_DEFAULT_WAREHOUSE_USER)) {\n\t\tprint '<tr><td>'.$langs->trans(\"DefaultWarehouse\").'</td><td>';\n\t\tprint $formproduct->selectWarehouses($object->fk_warehouse, 'fk_warehouse', 'warehouseopen', 1);\n\t\tprint '</td></tr>';\n\t}\n\n\t// Position/Job\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\tprint '<td>';\n\tprint '<input class=\"maxwidth200 maxwidth150onsmartphone\" type=\"text\" name=\"job\" value=\"'.dol_escape_htmltag(GETPOST('job', 'alphanohtml')).'\">';\n\tprint '</td></tr>';\n\n\tif ((!empty($conf->salaries->enabled) && !empty($user->rights->salaries->read) && in_array($id, $childids))\n\t\t|| (!empty($conf->salaries->enabled) && !empty($user->rights->salaries->readall))\n\t\t|| (!empty($conf->hrm->enabled) && !empty($user->rights->hrm->employee->read))) {\n\t\t$langs->load(\"salaries\");\n\n\t\t// THM\n\t\tprint '<tr><td>';\n\t\t$text = $langs->trans(\"THM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.dol_escape_htmltag(GETPOST('thm')).'\"> '.$langs->getCurrencySymbol($conf->currency);\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// TJM\n\t\tprint '<tr><td>';\n\t\t$text = $langs->trans(\"TJM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.dol_escape_htmltag(GETPOST('tjm')).'\"> '.$langs->getCurrencySymbol($conf->currency);\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// Salary\n\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\tprint '<td>';\n\t\tprint img_picto('', 'salary', 'class=\"pictofixedwidth paddingright\"').'<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.dol_escape_htmltag(GETPOST('salary')).'\"> '.$langs->getCurrencySymbol($conf->currency);\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// Weeklyhours\n\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\tprint '<td>';\n\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.dol_escape_htmltag(GETPOST('weeklyhours')).'\">';\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date employment\n\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\tprint '<td>';\n\tprint $form->selectDate($dateemployment, 'dateemployment', 0, 0, 1, 'formdateemployment', 1, 1);\n\n\tprint ' - ';\n\n\tprint $form->selectDate($dateemploymentend, 'dateemploymentend', 0, 0, 1, 'formdateemploymentend', 1, 0);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date birth\n\tprint '<tr><td>'.$langs->trans(\"DateOfBirth\").'</td>';\n\tprint '<td>';\n\tprint $form->selectDate($dateofbirth, 'dateofbirth', 0, 0, 1, 'createuser', 1, 0);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\tprint \"</table>\\n\";\n\n\tprint dol_get_fiche_end();\n\n\tprint $form->buttonsSaveCancel(\"CreateUser\");\n\n\tprint \"</form>\";\n} else {\n\t// View and edit mode\n\tif ($id > 0) {\n\t\t$res = $object->fetch($id, '', '', 1);\n\t\tif ($res < 0) {\n\t\t\tdol_print_error($db, $object->error);\n\t\t\texit;\n\t\t}\n\t\t$res = $object->fetch_optionals();\n\n\t\t// Check if user has rights\n\t\tif (empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t$object->getrights();\n\t\t\tif (empty($object->nb_rights) && $object->statut != 0 && empty($object->admin)) {\n\t\t\t\tsetEventMessages($langs->trans('UserHasNoPermissions'), null, 'warnings');\n\t\t\t}\n\t\t}\n\n\t\t// Connexion ldap\n\t\t// pour recuperer passDoNotExpire et userChangePassNextLogon\n\t\tif (!empty($conf->ldap->enabled) && !empty($object->ldap_sid)) {\n\t\t\t$ldap = new Ldap();\n\t\t\t$result = $ldap->connect_bind();\n\t\t\tif ($result > 0) {\n\t\t\t\t$userSearchFilter = '('.$conf->global->LDAP_FILTER_CONNECTION.'('.$ldap->getUserIdentifier().'='.$object->login.'))';\n\t\t\t\t$entries = $ldap->fetch($object->login, $userSearchFilter);\n\t\t\t\tif (!$entries) {\n\t\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t\t}\n\n\t\t\t\t$passDoNotExpire = 0;\n\t\t\t\t$userChangePassNextLogon = 0;\n\t\t\t\t$userDisabled = 0;\n\t\t\t\t$statutUACF = '';\n\n\t\t\t\t// Check options of user account\n\t\t\t\tif (count($ldap->uacf) > 0) {\n\t\t\t\t\tforeach ($ldap->uacf as $key => $statut) {\n\t\t\t\t\t\tif ($key == 65536) {\n\t\t\t\t\t\t\t$passDoNotExpire = 1;\n\t\t\t\t\t\t\t$statutUACF = $statut;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$userDisabled = 1;\n\t\t\t\t\t$statutUACF = \"ACCOUNTDISABLE\";\n\t\t\t\t}\n\n\t\t\t\tif ($ldap->pwdlastset == 0) {\n\t\t\t\t\t$userChangePassNextLogon = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Show tabs\n\t\tif ($mode == 'employee') { // For HRM module development\n\t\t\t$title = $langs->trans(\"Employee\");\n\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/hrm/employee/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t} else {\n\t\t\t$title = $langs->trans(\"User\");\n\t\t\t$linkback = '';\n\n\t\t\tif ($user->rights->user->user->lire || $user->admin) {\n\t\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/user/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t\t}\n\t\t}\n\n\t\t$head = user_prepare_head($object);\n\n\t\t/*\n\t\t * Confirmation reinitialisation mot de passe\n\t\t */\n\t\tif ($action == 'password') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"ReinitPassword\"), $langs->trans(\"ConfirmReinitPassword\", $object->login), \"confirm_password\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirmation envoi mot de passe\n\t\t */\n\t\tif ($action == 'passwordsend') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"SendNewPassword\"), $langs->trans(\"ConfirmSendNewPassword\", $object->login), \"confirm_passwordsend\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirm deactivation\n\t\t */\n\t\tif ($action == 'disable') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"DisableAUser\"), $langs->trans(\"ConfirmDisableUser\", $object->login), \"confirm_disable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirm activation\n\t\t */\n\t\tif ($action == 'enable') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"EnableAUser\"), $langs->trans(\"ConfirmEnableUser\", $object->login), \"confirm_enable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirmation suppression\n\t\t */\n\t\tif ($action == 'delete') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"DeleteAUser\"), $langs->trans(\"ConfirmDeleteUser\", $object->login), \"confirm_delete\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Fiche en mode visu\n\t\t */\n\t\tif ($action != 'edit') {\n\t\t\tprint dol_get_fiche_head($head, 'user', $title, -1, 'user');\n\n\t\t\tdol_banner_tab($object, 'id', $linkback, $user->rights->user->user->lire || $user->admin);\n\n\t\t\tprint '<div class=\"fichecenter\">';\n\t\t\tprint '<div class=\"fichehalfleft\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\t\t\tprint '<table class=\"border tableforfield\" width=\"100%\">';\n\n\t\t\t// Login\n\t\t\tprint '<tr><td class=\"titlefieldmiddle\">'.$langs->trans(\"Login\").'</td>';\n\t\t\tif (!empty($object->ldap_sid) && $object->statut == 0) {\n\t\t\t\tprint '<td class=\"error\">';\n\t\t\t\tprint $langs->trans(\"LoginAccountDisableInDolibarr\");\n\t\t\t\tprint '</td>';\n\t\t\t} else {\n\t\t\t\tprint '<td>';\n\t\t\t\t$addadmin = '';\n\t\t\t\tif (property_exists($object, 'admin')) {\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && !empty($object->admin) && empty($object->entity)) {\n\t\t\t\t\t\t$addadmin .= img_picto($langs->trans(\"SuperAdministratorDesc\"), \"redstar\", 'class=\"paddingleft\"');\n\t\t\t\t\t} elseif (!empty($object->admin)) {\n\t\t\t\t\t\t$addadmin .= img_picto($langs->trans(\"AdministratorDesc\"), \"star\", 'class=\"paddingleft\"');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprint showValueWithClipboardCPButton($object->login).$addadmin;\n\t\t\t\tprint '</td>';\n\t\t\t}\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// Type\n\t\t\tprint '<tr><td>';\n\t\t\t$text = $langs->trans(\"Type\");\n\t\t\tprint $form->textwithpicto($text, $langs->trans(\"InternalExternalDesc\"));\n\t\t\tprint '</td><td>';\n\t\t\t$type = $langs->trans(\"Internal\");\n\t\t\tif ($object->socid > 0) {\n\t\t\t\t$type = $langs->trans(\"External\");\n\t\t\t}\n\t\t\tprint '<span class=\"badgeneutral\">';\n\t\t\tprint $type;\n\t\t\tif ($object->ldap_sid) {\n\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t}\n\t\t\tprint '</span>';\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// Ldap sid\n\t\t\tif ($object->ldap_sid) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Type\").'</td><td>';\n\t\t\t\tprint $langs->trans(\"DomainUser\", $ldap->domainFQDN);\n\t\t\t\tprint '</td></tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Employee\n\t\t\tprint '<tr><td>'.$langs->trans(\"Employee\").'</td><td>';\n\t\t\tprint '<input type=\"checkbox\" disabled name=\"employee\" value=\"1\"'.($object->employee ? ' checked=\"checked\"' : '').'>';\n\t\t\t//print yn($object->employee);\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// TODO This is also available into the tab RH\n\n\t\t\t// Hierarchy\n\t\t\tprint '<tr><td>'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif (empty($object->fk_user)) {\n\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"None\").'</span>';\n\t\t\t} else {\n\t\t\t\t$huser = new User($db);\n\t\t\t\tif ($object->fk_user > 0) {\n\t\t\t\t\t$huser->fetch($object->fk_user);\n\t\t\t\t\tprint $huser->getNomUrl(1);\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"None\").'</span>';\n\t\t\t\t}\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Expense report validator\n\t\t\tif (!empty($conf->expensereport->enabled)) {\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"ForceUserExpenseValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($object->fk_user_expense_validator)) {\n\t\t\t\t\t$evuser = new User($db);\n\t\t\t\t\t$evuser->fetch($object->fk_user_expense_validator);\n\t\t\t\t\tprint $evuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Holiday request validator\n\t\t\tif (!empty($conf->holiday->enabled)) {\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"ForceUserHolidayValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($object->fk_user_holiday_validator)) {\n\t\t\t\t\t$hvuser = new User($db);\n\t\t\t\t\t$hvuser->fetch($object->fk_user_holiday_validator);\n\t\t\t\t\tprint $hvuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td>'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>'.dol_escape_htmltag($object->job).'</td>';\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint price2num($object->weeklyhours);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Sensitive salary/value information\n\t\t\tif ((empty($user->socid) && in_array($id, $childids))\t// A user can always see salary/value information for its subordinates\n\t\t\t\t|| (!empty($conf->salaries->enabled) && !empty($user->rights->salaries->readall))\n\t\t\t\t|| (!empty($conf->hrm->enabled) && !empty($user->rights->hrm->employee->read))) {\n\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->salary != '' ? img_picto('', 'salary', 'class=\"pictofixedwidth paddingright\"').'<span class=\"amount\">'.price($object->salary, '', $langs, 1, -1, -1, $conf->currency) : '').'</span>';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->thm != '' ?price($object->thm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->tjm != '' ?price($object->tjm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateOfEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->dateemployment) {\n\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"FromDate\").'</span> ';\n\t\t\t\tprint dol_print_date($object->dateemployment, 'day');\n\t\t\t}\n\t\t\tif ($object->dateemploymentend) {\n\t\t\t\tprint '<span class=\"opacitymedium\"> - '.$langs->trans(\"To\").'</span> ';\n\t\t\t\tprint dol_print_date($object->dateemploymentend, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Default warehouse\n\t\t\tif (!empty($conf->stock->enabled) && !empty($conf->global->MAIN_DEFAULT_WAREHOUSE_USER)) {\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/product/stock/class/entrepot.class.php';\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"DefaultWarehouse\").'</td><td>';\n\t\t\t\tif ($object->fk_warehouse > 0) {\n\t\t\t\t\t$warehousestatic = new Entrepot($db);\n\t\t\t\t\t$warehousestatic->fetch($object->fk_warehouse);\n\t\t\t\t\tprint $warehousestatic->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Accountancy code\n\t\t\tif (!empty($conf->accounting->enabled)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>'.$object->accountancy_code.'</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table>';\n\n\t\t\tprint '</div>';\n\t\t\tprint '<div class=\"fichehalfright\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\n\t\t\tprint '<table class=\"border tableforfield centpercent\">';\n\n\t\t\t// Color user\n\t\t\tif (!empty($conf->agenda->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $formother->showColor($object->color, '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Categories\n\t\t\tif (!empty($conf->categorie->enabled) && !empty($user->rights->categorie->lire)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Categories\").'</td>';\n\t\t\t\tprint '<td colspan=\"3\">';\n\t\t\t\tprint $form->showCategories($object->id, Categorie::TYPE_USER, 1);\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Default language\n\t\t\tif (!empty($conf->global->MAIN_MULTILANGS)) {\n\t\t\t\t$langs->load(\"languages\");\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';\n\t\t\t\tprint '<tr><td class=\"titlefield\">';\n\t\t\t\tprint $form->textwithpicto($langs->trans(\"DefaultLang\"), $langs->trans(\"WarningNotLangOfInterface\", $langs->transnoentitiesnoconv(\"UserGUISetup\")));\n\t\t\t\tprint '</td><td>';\n\t\t\t\t//$s=picto_from_langcode($object->default_lang);\n\t\t\t\t//print ($s?$s.' ':'');\n\t\t\t\t$labellang = ($object->lang ? $langs->trans('Language_'.$object->lang) : '');\n\t\t\t\tprint $labellang;\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/', $conf->file->main_authentication) && !empty($conf->global->MAIN_OPENIDURL_PERUSER)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>'.$object->openid.'</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Multicompany\n\t\t\tif (!empty($conf->multicompany->enabled) && is_object($mc)) {\n\t\t\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\t\t\tif (!method_exists($mc, 'formObjectOptions')) {\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && !$user->entity) {\n\t\t\t\t\t\tprint '<tr><td>'.$langs->trans(\"Entity\").'</td><td>';\n\t\t\t\t\t\tif (empty($object->entity)) {\n\t\t\t\t\t\t\tprint $langs->trans(\"AllEntities\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$mc->getInfo($object->entity);\n\t\t\t\t\t\t\tprint $mc->label;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_view.tpl.php';\n\n\t\t\t// Company / Contact\n\t\t\tif (!empty($conf->societe->enabled)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\t$s = '';\n\t\t\t\tif (isset($object->socid) && $object->socid > 0) {\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tif ($societe->id > 0) {\n\t\t\t\t\t\t$s .= $societe->getNomUrl(1, '');\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$s .= '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"ThisUserIsNot\").'</span>';\n\t\t\t\t}\n\t\t\t\tif (!empty($object->contact_id)) {\n\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t$contact->fetch($object->contact_id);\n\t\t\t\t\tif ($contact->id > 0) {\n\t\t\t\t\t\tif ($object->socid > 0 && $s) {\n\t\t\t\t\t\t\t$s .= ' / ';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$s .= '<br>';\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$s .= $contact->getNomUrl(1, '');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprint $s;\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (!empty($conf->adherent->enabled)) {\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member) {\n\t\t\t\t\t$adh = new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref = $adh->getFullname($langs); // Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(-1);\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"UserNotLinkedToMember\").'</span>';\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans('Signature').'</td><td class=\"wordbreak\">';\n\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\t// VCard\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"VCard\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint '<a href=\"'.DOL_URL_ROOT.'/user/vcard.php?id='.$object->id.'\">';\n\t\t\tprint img_picto($langs->trans(\"Download\"), 'vcard.png', 'class=\"paddingrightonly\"');\n\t\t\tprint $langs->trans(\"Download\");\n\t\t\tprint '</a>';\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\tprint \"</table>\\n\";\n\n\t\t\t// Credentials\n\t\t\tprint '<div class=\"div-table-responsive-no-min\">';\n\t\t\tprint '<table class=\"border tableforfield margintable centpercent\">';\n\t\t\tprint '<tr class=\"liste_titre\"><td class=\"liste_titre\">';\n\t\t\tprint img_picto('', 'security', 'class=\"paddingleft pictofixedwidth\"').$langs->trans(\"Credentials\");\n\t\t\tprint '</td>';\n\t\t\tprint '<td class=\"liste_titre\"></td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Date login validity\n\t\t\tprint '<tr><td>'.$langs->trans(\"RangeOfLoginValidity\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->datestartvalidity) {\n\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"FromDate\").'</span> ';\n\t\t\t\tprint dol_print_date($object->datestartvalidity, 'day');\n\t\t\t}\n\t\t\tif ($object->dateendvalidity) {\n\t\t\t\tprint '<span class=\"opacitymedium\"> - '.$langs->trans(\"To\").'</span> ';\n\t\t\t\tprint dol_print_date($object->dateendvalidity, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Password\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Password\").'</td>';\n\n\t\t\tprint '<td class=\"wordbreak\">';\n\t\t\t$valuetoshow = '';\n\t\t\tif (preg_match('/ldap/', $dolibarr_main_authentication)) {\n\t\t\t\tif (!empty($object->ldap_sid)) {\n\t\t\t\t\tif ($passDoNotExpire) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"LdapUacf_\".$statutUACF);\n\t\t\t\t\t} elseif ($userChangePassNextLogon) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<span class=\"warning\">'.$langs->trans(\"UserMustChangePassNextLogon\", $ldap->domainFQDN).'</span>';\n\t\t\t\t\t} elseif ($userDisabled) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<span class=\"warning\">'.$langs->trans(\"LdapUacf_\".$statutUACF, $ldap->domainFQDN).'</span>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (preg_match('/http/', $dolibarr_main_authentication)) {\n\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"HTTPBasicPassword\");\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/', $dolibarr_main_authentication)) {\n\t\t\t\tif ($object->pass) {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '');\n\t\t\t\t\t$valuetoshow .= '<span class=\"opacitymedium\">'.$langs->trans(\"Hidden\").'</span>';\n\t\t\t\t} else {\n\t\t\t\t\tif ($user->admin && $user->id == $object->id) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '');\n\t\t\t\t\t\t//$valuetoshow .= '<span class=\"opacitymedium\">'.$langs->trans(\"Crypted\").' - </span>';\n\t\t\t\t\t\t$valuetoshow .= '<span class=\"opacitymedium\">'.$langs->trans(\"Hidden\").'</span>';\n\t\t\t\t\t\t// TODO Add a feature to reveal the hash\n\t\t\t\t\t\t$valuetoshow .= '<!-- Crypted into '.$object->pass_indatabase_crypted.' -->';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<span class=\"opacitymedium\">'.$langs->trans(\"Hidden\").'</span>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters = array('valuetoshow' => $valuetoshow);\n\t\t\t$reshook = $hookmanager->executeHooks('printUserPasswordField', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) {\n\t\t\t\t$valuetoshow = $hookmanager->resPrint; // to replace\n\t\t\t} else {\n\t\t\t\t$valuetoshow .= $hookmanager->resPrint; // to add\n\t\t\t}\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td>\";\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// API key\n\t\t\tif (!empty($conf->api->enabled) && ($user->id == $id || $user->admin || $user->rights->api->apikey->generate)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($object->api_key)) {\n\t\t\t\t\tprint '<span class=\"opacitymedium\">';\n\t\t\t\t\tprint showValueWithClipboardCPButton($object->api_key, 1, $langs->trans(\"Hidden\"));\t\t// TODO Add an option to also reveal the hash, not only copy paste\n\t\t\t\t\tprint '</span>';\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"LastConnexion\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->datepreviouslogin) {\n\t\t\t\tprint dol_print_date($object->datepreviouslogin, \"dayhour\").' <span class=\"opacitymedium\">('.$langs->trans(\"Previous\").')</span>, ';\n\t\t\t}\n\t\t\tif ($object->datelastlogin) {\n\t\t\t\tprint dol_print_date($object->datelastlogin, \"dayhour\").' <span class=\"opacitymedium\">('.$langs->trans(\"Currently\").')</span>';\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '</table></div>';\n\n\t\t\tprint '</div>';\n\n\t\t\tprint '</div>';\n\t\t\tprint '<div style=\"clear:both\"></div>';\n\n\n\t\t\tprint dol_get_fiche_end();\n\n\n\t\t\t/*\n\t\t\t * Buttons actions\n\t\t\t */\n\n\t\t\tprint '<div class=\"tabsAction\">';\n\n\t\t\t$parameters = array();\n\t\t\t$reshook = $hookmanager->executeHooks('addMoreActionsButtons', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tif (empty($reshook)) {\n\t\t\t\tif (empty($user->socid)) {\n\t\t\t\t\tif (!empty($object->email)) {\n\t\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=presend&mode=init#formmailbeforetitle\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ($caneditfield && (empty($conf->multicompany->enabled) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tif (!empty($conf->global->MAIN_ONLY_LOGIN_ALLOWED)) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"DisabledInMonoUserMode\")).'\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=edit&token='.newToken().'\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t} elseif ($caneditpassword && !$object->ldap_sid &&\n\t\t\t\t(empty($conf->multicompany->enabled) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=edit&token='.newToken().'\">'.$langs->trans(\"EditPassword\").'</a></div>';\n\t\t\t\t}\n\n\t\t\t\t// Si on a un gestionnaire de generation de mot de passe actif\n\t\t\t\tif ($conf->global->USER_PASSWORD_GENERATED != 'none') {\n\t\t\t\t\tif ($object->statut == 0) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t} elseif ($caneditpassword && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=password\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($object->statut == 0) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t} elseif ($caneditpassword && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\t\tif ($object->email) {\n\t\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=passwordsend\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Enable user\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 0 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=enable&token='.newToken().'\">'.$langs->trans(\"Reactivate\").'</a></div>';\n\t\t\t\t}\n\t\t\t\t// Disable user\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 1 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?action=disable&id='.$object->id.'&token='.newToken().'\">'.$langs->trans(\"DisableUser\").'</a></div>';\n\t\t\t\t} else {\n\t\t\t\t\tif ($user->id == $id) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.$langs->trans(\"CantDisableYourself\").'\">'.$langs->trans(\"DisableUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Delete\n\t\t\t\tif ($user->id <> $id && $candisableuser &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tif ($user->admin || !$object->admin) { // If user edited is admin, delete is possible on for an admin\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?action=delete&token='.newToken().'&id='.$object->id.'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"MustBeAdminToDeleteOtherAdmin\")).'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tprint \"</div>\\n\";\n\n\n\n\t\t\t//Select mail models is same action as presend\n\t\t\tif (GETPOST('modelselected')) {\n\t\t\t\t$action = 'presend';\n\t\t\t}\n\n\t\t\t// Presend form\n\t\t\t$modelmail = 'user';\n\t\t\t$defaulttopic = 'Information';\n\t\t\t$diroutput = $conf->user->dir_output;\n\t\t\t$trackid = 'use'.$object->id;\n\n\t\t\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/card_presend.tpl.php';\n\n\t\t\tif ($action != 'presend' && $action != 'send') {\n\t\t\t\t/*\n\t\t\t\t * List of groups of user\n\t\t\t\t */\n\n\t\t\t\tif ($canreadgroup) {\n\t\t\t\t\tprint '<!-- Group section -->'.\"\\n\";\n\n\t\t\t\t\tprint load_fiche_titre($langs->trans(\"ListOfGroupsForUser\"), '', '');\n\n\t\t\t\t\t// On selectionne les groupes auquel fait parti le user\n\t\t\t\t\t$exclude = array();\n\n\t\t\t\t\t$usergroup = new UserGroup($db);\n\t\t\t\t\t$groupslist = $usergroup->listGroupsForUser($object->id, false);\n\n\t\t\t\t\tif (!empty($groupslist)) {\n\t\t\t\t\t\tforeach ($groupslist as $groupforuser) {\n\t\t\t\t\t\t\t$exclude[] = $groupforuser->id;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Other form for add user to group\n\t\t\t\t\t$parameters = array('caneditgroup' => $caneditgroup, 'groupslist' => $groupslist, 'exclude' => $exclude);\n\t\t\t\t\t$reshook = $hookmanager->executeHooks('formAddUserToGroup', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\t\t\tprint $hookmanager->resPrint;\n\n\t\t\t\t\tif (empty($reshook)) {\n\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$id.'\" method=\"POST\">'.\"\\n\";\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\" />';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"addgroup\" />';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"page_y\" value=\"\" />';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tprint '<table class=\"noborder centpercent\">'.\"\\n\";\n\t\t\t\t\t\tprint '<tr class=\"liste_titre\"><th class=\"liste_titre\">'.$langs->trans(\"Groups\").'</th>'.\"\\n\";\n\t\t\t\t\t\tprint '<th class=\"liste_titre right\">';\n\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\tprint $form->select_dolgroups('', 'group', 1, $exclude, 0, '', '', $object->entity);\n\t\t\t\t\t\t\tprint ' &nbsp; ';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t\t\t\t\tprint '<input type=\"submit\" class=\"button buttongen button-add reposition\" value=\"'.$langs->trans(\"Add\").'\" />';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint '</th></tr>'.\"\\n\";\n\n\t\t\t\t\t\t// List of groups of user\n\t\t\t\t\t\tif (!empty($groupslist)) {\n\t\t\t\t\t\t\tforeach ($groupslist as $group) {\n\t\t\t\t\t\t\t\tprint '<tr class=\"oddeven\">';\n\t\t\t\t\t\t\t\tprint '<td>';\n\t\t\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\t\t\tprint $group->getNomUrl(1);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tprint img_object($langs->trans(\"ShowGroup\"), \"group\").' '.$group->name;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint '</td>';\n\t\t\t\t\t\t\t\tprint '<td class=\"right\">';\n\t\t\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\t\t\tprint '<a class=\"reposition\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=removegroup&token='.newToken().'&group='.((int) $group->id).'\">';\n\t\t\t\t\t\t\t\t\tprint img_picto($langs->trans(\"RemoveFromGroup\"), 'unlink');\n\t\t\t\t\t\t\t\t\tprint '</a>';\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tprint \"&nbsp;\";\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprint '<tr class=\"oddeven\"><td colspan=\"3\" class=\"opacitymedium\">'.$langs->trans(\"None\").'</td></tr>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tprint \"</table>\";\n\n\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\tprint '</form>';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint \"<br>\";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t/*\n\t\t * Card in edit mode\n\t\t */\n\t\tif ($action == 'edit' && ($canedituser || $caneditfield || $caneditpassword || ($user->id == $object->id))) {\n\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'\" method=\"POST\" name=\"updateuser\" enctype=\"multipart/form-data\">';\n\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\">';\n\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"update\">';\n\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$object->entity.'\">';\n\n\t\t\tprint dol_get_fiche_head($head, 'user', $title, 0, 'user');\n\n\t\t\tprint '<table class=\"border centpercent\">';\n\n\t\t\t// Ref/ID\n\t\t\tif (!empty($conf->global->MAIN_SHOW_TECHNICAL_ID)) {\n\t\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"Ref\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $object->id;\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>';\n\t\t\t}\n\n\t\t\t// Civility\n\t\t\tprint '<tr><td class=\"titlefieldcreate\"><label for=\"civility_code\">'.$langs->trans(\"UserTitle\").'</label></td><td colspan=\"3\">';\n\t\t\tif ($caneditfield && !$object->ldap_sid) {\n\t\t\t\tprint $formcompany->select_civility(GETPOSTISSET(\"civility_code\") ? GETPOST(\"civility_code\", 'aZ09') : $object->civility_code, 'civility_code');\n\t\t\t} elseif ($object->civility_code) {\n\t\t\t\tprint $langs->trans(\"Civility\".$object->civility_code);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Lastname\n\t\t\tprint \"<tr>\";\n\t\t\tprint '<td class=\"titlefieldcreate fieldrequired\">'.$langs->trans(\"Lastname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid) {\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t\tprint $object->lastname;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Firstname\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Firstname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid) {\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t\tprint $object->firstname;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Login\n\t\t\tprint \"<tr>\".'<td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\t\t\tprint '<td>';\n\t\t\tif ($user->admin && !$object->ldap_sid) {\n\t\t\t\tprint '<input maxlength=\"50\" type=\"text\" class=\"flat\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t\tprint $object->login;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Administrator\n\t\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\t\tif ($object->socid > 0) {\n\t\t\t\t$langs->load(\"admin\");\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">'.yn($object->admin);\n\t\t\t\tprint ' ('.$langs->trans(\"ExternalUser\").')';\n\t\t\t\tprint '</td></tr>';\n\t\t\t} else {\n\t\t\t\tprint '<td>';\n\t\t\t\t$nbAdmin = $user->getNbOfUsers('active', '', 1);\n\t\t\t\t$nbSuperAdmin = $user->getNbOfUsers('active', 'superadmin', 1);\n\t\t\t\t//var_dump($nbAdmin);\n\t\t\t\t//var_dump($nbSuperAdmin);\n\t\t\t\tif ($user->admin\t\t\t\t\t\t\t\t// Need to be admin to allow downgrade of an admin\n\t\t\t\t&& ($user->id != $object->id)                   // Don't downgrade ourself\n\t\t\t\t&& (\n\t\t\t\t\t(empty($conf->multicompany->enabled) && $nbAdmin >= 1)\n\t\t\t\t\t|| (!empty($conf->multicompany->enabled) && (($object->entity > 0 || ($user->entity == 0 && $object->entity == 0)) || $nbSuperAdmin > 1))    // Don't downgrade a superadmin if alone\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tprint $form->selectyesno('admin', $object->admin, 1);\n\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && !$user->entity) {\n\t\t\t\t\t\tif ($conf->use_javascript_ajax) {\n\t\t\t\t\t\t\tprint '<script type=\"text/javascript\">\n\t\t\t\t\t\t\t\t\t$(function() {\n\t\t\t\t\t\t\t\t\t\tvar admin = $(\"select[name=admin]\").val();\n\t\t\t\t\t\t\t\t\t\tif (admin == 0) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tif ($(\"input[name=superadmin]\").is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$(\"select[name=admin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\t if ( $(this).val() == 0 ) {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t } else {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t }\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\tif ( $(this).is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t</script>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$checked = (($object->admin && !$object->entity) ? ' checked' : '');\n\t\t\t\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" id=\"superadmin\" value=\"1\"'.$checked.' /> <label for=\"superadmin\">'.$langs->trans(\"SuperAdministrator\").'</span>';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$yn = yn($object->admin);\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">';\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"superadmin\" value=\"'.(empty($object->entity) ? 1 : 0).'\">';\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && empty($object->entity)) {\n\t\t\t\t\t\tprint $form->textwithpicto($yn, $langs->trans(\"DontDowngradeSuperAdmin\"), 1, 'warning');\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint $yn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Gender\n\t\t\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\t\t\tprint '<td>';\n\t\t\t$arraygender = array('man'=>$langs->trans(\"Genderman\"), 'woman'=>$langs->trans(\"Genderwoman\"), 'other'=>$langs->trans(\"Genderother\"));\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectarray('gender', $arraygender, GETPOSTISSET('gender') ?GETPOST('gender') : $object->gender, 1);\n\t\t\t} else {\n\t\t\t\tprint $arraygender[$object->gender];\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Employee\n\t\t\tprint '<tr>';\n\t\t\tprint '<td>'.$form->editfieldkey('Employee', 'employee', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<input type=\"checkbox\" name=\"employee\" value=\"1\"'.($object->employee ? ' checked=\"checked\"' : '').'>';\n\t\t\t\t//print $form->selectyesno(\"employee\", $object->employee, 1);\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"checkbox\" name=\"employee\" disabled value=\"1\"'.($object->employee ? ' checked=\"checked\"' : '').'>';\n\t\t\t\t/*if ($object->employee) {\n\t\t\t\t\tprint $langs->trans(\"Yes\");\n\t\t\t\t} else {\n\t\t\t\t\tprint $langs->trans(\"No\");\n\t\t\t\t}*/\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Hierarchy\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint img_picto('', 'user').$form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'widthcentpercentminusx maxwidth300');\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"fk_user\" value=\"'.$object->fk_user.'\">';\n\t\t\t\t$huser = new User($db);\n\t\t\t\t$huser->fetch($object->fk_user);\n\t\t\t\tprint $huser->getNomUrl(1);\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Expense report validator\n\t\t\tif (!empty($conf->expensereport->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">';\n\t\t\t\t$text = $langs->trans(\"ForceUserExpenseValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint img_picto('', 'user').$form->select_dolusers($object->fk_user_expense_validator, 'fk_user_expense_validator', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'widthcentpercentminusx maxwidth300');\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"fk_user_expense_validator\" value=\"'.$object->fk_user_expense_validator.'\">';\n\t\t\t\t\t$evuser = new User($db);\n\t\t\t\t\t$evuser->fetch($object->fk_user_expense_validator);\n\t\t\t\t\tprint $evuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Holiday request validator\n\t\t\tif (!empty($conf->holiday->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">';\n\t\t\t\t$text = $langs->trans(\"ForceUserHolidayValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint img_picto('', 'user').$form->select_dolusers($object->fk_user_holiday_validator, 'fk_user_holiday_validator', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'widthcentpercentminusx maxwidth300');\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"fk_user_holiday_validator\" value=\"'.$object->fk_user_holiday_validator.'\">';\n\t\t\t\t\t$hvuser = new User($db);\n\t\t\t\t\t$hvuser->fetch($object->fk_user_holiday_validator);\n\t\t\t\t\tprint $hvuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// External user ?\n\t\t\tprint '<tr><td>'.$langs->trans(\"ExternalUser\").' ?</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($user->id == $object->id || !$user->admin) {\n\t\t\t\t// Read mode\n\t\t\t\t$type = $langs->trans(\"Internal\");\n\t\t\t\tif ($object->socid) {\n\t\t\t\t\t$type = $langs->trans(\"External\");\n\t\t\t\t}\n\t\t\t\tprint $form->textwithpicto($type, $langs->trans(\"InternalExternalDesc\"));\n\t\t\t\tif ($object->ldap_sid) {\n\t\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Select mode\n\t\t\t\t$type = 0;\n\t\t\t\tif ($object->contact_id) {\n\t\t\t\t\t$type = $object->contact_id;\n\t\t\t\t}\n\n\t\t\t\tif ($object->socid > 0 && !($object->contact_id > 0)) {\t// external user but no link to a contact\n\t\t\t\t\tprint img_picto('', 'company').$form->select_company($object->socid, 'socid', '', '&nbsp;');\n\t\t\t\t\tprint img_picto('', 'contact').$form->selectcontacts(0, 0, 'contactid', 1, '', '', 1, '', false, 1);\n\t\t\t\t\tif ($object->ldap_sid) {\n\t\t\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t\t\t}\n\t\t\t\t} elseif ($object->socid > 0 && $object->contact_id > 0) {\t// external user with a link to a contact\n\t\t\t\t\tprint img_picto('', 'company').$form->select_company(0, 'socid', '', '&nbsp;'); // We keep thirdparty empty, contact is already set\n\t\t\t\t\tprint img_picto('', 'contact').$form->selectcontacts(0, $object->contact_id, 'contactid', 1, '', '', 1, '', false, 1);\n\t\t\t\t\tif ($object->ldap_sid) {\n\t\t\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t\t\t}\n\t\t\t\t} else {\t// $object->socid is not > 0 here\n\t\t\t\t\tprint img_picto('', 'company').$form->select_company(0, 'socid', '', '&nbsp;'); // We keep thirdparty empty, contact is already set\n\t\t\t\t\tprint img_picto('', 'contact').$form->selectcontacts(0, 0, 'contactid', 1, '', '', 1, '', false, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// Date access validity\n\t\t\tprint '<tr><td>'.$langs->trans(\"RangeOfLoginValidity\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($datestartvalidity ? $datestartvalidity : $object->datestartvalidity, 'datestartvalidity', 0, 0, 1, 'formdatestartvalidity', 1, 1, 0, '', '', '', '', 1, '', '');\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->datestartvalidity, 'day');\n\t\t\t}\n\n\t\t\t/*if ($datestartvalidity && $dateendvalidity) {\n\t\t\t\tprint ' - ';\n\t\t\t}*/\n\t\t\tprint ' &nbsp; ';\n\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($dateendvalidity ? $datendevalidity : $object->dateendvalidity, 'dateendvalidity', 0, 0, 1, 'formdateendvalidity', 1, 0, 0, '', '', '', '', 1, '', '');\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->dateendvalidity, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Pass\n\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"Password\").'</td>';\n\t\t\tprint '<td>';\n\t\t\t$valuetoshow = '';\n\t\t\tif (preg_match('/ldap/', $dolibarr_main_authentication)) {\n\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t}\n\t\t\tif (preg_match('/http/', $dolibarr_main_authentication)) {\n\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$form->textwithpicto($text, $langs->trans(\"DolibarrInHttpAuthenticationSoPasswordUseless\", $dolibarr_main_authentication), 1, 'warning');\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/', $dolibarr_main_authentication)) {\n\t\t\t\tif ($caneditpassword) {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<input maxlength=\"128\" type=\"password\" class=\"flat\" name=\"password\" value=\"'.$object->pass.'\" autocomplete=\"new-password\">';\n\t\t\t\t} else {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').preg_replace('/./i', '*', $object->pass);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters = array('valuetoshow' => $valuetoshow, 'caneditpassword' => $caneditpassword);\n\t\t\t$reshook = $hookmanager->executeHooks('printUserPasswordField', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) {\n\t\t\t\t$valuetoshow = $hookmanager->resPrint; // to replace\n\t\t\t} else {\n\t\t\t\t$valuetoshow .= $hookmanager->resPrint; // to add\n\t\t\t}\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\t// API key\n\t\t\tif (!empty($conf->api->enabled) && ($user->id == $id || $user->admin || $user->rights->api->apikey->generate)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input class=\"minwidth300\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.$object->api_key.'\" autocomplete=\"off\">';\n\t\t\t\tif (!empty($conf->use_javascript_ajax)) {\n\t\t\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// OpenID url\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/', $conf->file->main_authentication) && !empty($conf->global->MAIN_OPENIDURL_PERUSER)) {\n\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input class=\"minwidth100\" type=\"url\" name=\"openid\" class=\"flat\" value=\"'.$object->openid.'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"openid\" value=\"'.$object->openid.'\">';\n\t\t\t\t\tprint $object->openid;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// Address\n\t\t\tprint '<tr><td class=\"tdtop titlefieldcreate\">'.$form->editfieldkey('Address', 'address', '', $object, 0).'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\t\t\t}\n\t\t\tprint $object->address;\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '</textarea>';\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Zip\n\t\t\tprint '<tr><td>'.$form->editfieldkey('Zip', 'zipcode', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $formcompany->select_ziptown($object->zip, 'zipcode', array('town', 'selectcountry_id', 'state_id'), 6);\n\t\t\t} else {\n\t\t\t\tprint $object->zip;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Town\n\t\t\tprint '<tr><td>'.$form->editfieldkey('Town', 'town', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $formcompany->select_ziptown($object->town, 'town', array('zipcode', 'selectcountry_id', 'state_id'));\n\t\t\t} else {\n\t\t\t\tprint $object->town;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Country\n\t\t\tprint '<tr><td>'.$form->editfieldkey('Country', 'selectcounty_id', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->select_country((GETPOST('country_id') != '' ?GETPOST('country_id') : $object->country_id), 'country_id');\n\t\t\t\tif ($user->admin) {\n\t\t\t\t\tprint info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"), 1);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$countrylabel = getCountry($object->country_id, '0');\n\t\t\t\tprint $countrylabel;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// State\n\t\t\tif (empty($conf->global->USER_DISABLE_STATE)) {\n\t\t\t\tprint '<tr><td class=\"tdoverflow\">'.$form->editfieldkey('State', 'state_id', '', $object, 0).'</td><td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint img_picto('', 'state', 'class=\"pictofixedwidth\"');\n\t\t\t\t\tprint $formcompany->select_state($object->state_id, $object->country_code, 'state_id');\n\t\t\t\t} else {\n\t\t\t\t\tprint $object->state_label;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Tel pro\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhonePro\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'phoning', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input type=\"text\" name=\"office_phone\" class=\"flat maxwidth200\" value=\"'.$object->office_phone.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.$object->office_phone.'\">';\n\t\t\t\tprint $object->office_phone;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Tel mobile\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'phoning_mobile', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input type=\"text\" name=\"user_mobile\" class=\"flat maxwidth200\" value=\"'.$object->user_mobile.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.$object->user_mobile.'\">';\n\t\t\t\tprint $object->user_mobile;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Fax\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Fax\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'phoning_fax', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input type=\"text\" name=\"office_fax\" class=\"flat maxwidth200\" value=\"'.$object->office_fax.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.$object->office_fax.'\">';\n\t\t\t\tprint $object->office_fax;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// EMail\n\t\t\tprint \"<tr>\".'<td'.(!empty($conf->global->USER_MAIL_REQUIRED) ? ' class=\"fieldrequired\"' : '').'>'.$langs->trans(\"EMail\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'object_email', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input class=\"minwidth100 maxwidth500 widthcentpercentminusx\" type=\"text\" name=\"email\" class=\"flat\" value=\"'.$object->email.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.$object->email.'\">';\n\t\t\t\tprint $object->email;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\tif (!empty($conf->socialnetworks->enabled)) {\n\t\t\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\t\t\tif ($value['active']) {\n\t\t\t\t\t\tprint '<tr><td>'.$langs->trans($value['label']).'</td>';\n\t\t\t\t\t\tprint '<td>';\n\t\t\t\t\t\tif (!empty($value['icon'])) {\n\t\t\t\t\t\t\tprint '<span class=\"fa '.$value['icon'].' pictofixedwidth\"></span>';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\t\t\t\tprint '<input type=\"text\" name=\"'.$key.'\" class=\"flat maxwidth200\" value=\"'.$object->socialnetworks[$key].'\">';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$object->socialnetworks[$key].'\">';\n\t\t\t\t\t\t\tprint $object->socialnetworks[$key];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint '</td></tr>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// if social network is not active but value exist we do not want to loose it\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$object->socialnetworks[$key].'\">';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\t\t\t// Default warehouse\n\t\t\tif (!empty($conf->stock->enabled) && !empty($conf->global->MAIN_DEFAULT_WAREHOUSE_USER)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"DefaultWarehouse\").'</td><td>';\n\t\t\t\tprint $formproduct->selectWarehouses($object->fk_warehouse, 'fk_warehouse', 'warehouseopen', 1);\n\t\t\t\tprint ' <a href=\"'.DOL_URL_ROOT.'/product/stock/card.php?action=create&token='.newToken().'&backtopage='.urlencode($_SERVER['PHP_SELF'].'?id='.$object->id.'&action=edit&token='.newToken()).'\"><span class=\"fa fa-plus-circle valignmiddle paddingleft\" title=\"'.$langs->trans(\"AddWarehouse\").'\"></span></a>';\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Accountancy code\n\t\t\tif (!empty($conf->accounting->enabled)) {\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint '<td class=\"titlefieldcreate\">'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input type=\"text\" class=\"flat maxwidth300\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t\tprint $object->accountancy_code;\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\";\n\t\t\t}\n\n\t\t\t// User color\n\t\t\tif (!empty($conf->agenda->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint $formother->selectColor(GETPOSTISSET('color') ?GETPOST('color', 'alphanohtml') : $object->color, 'color', null, 1, '', 'hideifnotset');\n\t\t\t\t} else {\n\t\t\t\t\tprint $formother->showColor($object->color, '');\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Photo\n\t\t\tprint '<tr>';\n\t\t\tprint '<td class=\"titlefieldcreate\">'.$langs->trans(\"Photo\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $form->showphoto('userphoto', $object, 60, 0, $caneditfield, 'photowithmargin', 'small', 1, 0, 'user', 1);\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Categories\n\t\t\tif (!empty($conf->categorie->enabled) && !empty($user->rights->categorie->lire)) {\n\t\t\t\tprint '<tr><td>'.$form->editfieldkey('Categories', 'usercats', '', $object, 0).'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint img_picto('', 'category', 'class=\"pictofixedwidth\"');\n\t\t\t\t$cate_arbo = $form->select_all_categories(Categorie::TYPE_USER, null, null, null, null, 1);\n\t\t\t\t$c = new Categorie($db);\n\t\t\t\t$cats = $c->containing($object->id, Categorie::TYPE_USER);\n\t\t\t\tforeach ($cats as $cat) {\n\t\t\t\t\t$arrayselected[] = $cat->id;\n\t\t\t\t}\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint $form->multiselectarray('usercats', $cate_arbo, $arrayselected, '', 0, '', 0, '90%');\n\t\t\t\t} else {\n\t\t\t\t\tprint $form->showCategories($object->id, Categorie::TYPE_USER, 1);\n\t\t\t\t}\n\t\t\t\tprint \"</td></tr>\";\n\t\t\t}\n\n\t\t\t// Default language\n\t\t\tif (!empty($conf->global->MAIN_MULTILANGS)) {\n\t\t\t\tprint '<tr><td>'.$form->editfieldkey('DefaultLang', 'default_lang', '', $object, 0, 'string', '', 0, 0, 'id', $langs->trans(\"WarningNotLangOfInterface\", $langs->transnoentitiesnoconv(\"UserGUISetup\"))).'</td><td colspan=\"3\">'.\"\\n\";\n\t\t\t\tprint img_picto('', 'language', 'class=\"pictofixedwidth\"').$formadmin->select_language($object->lang, 'default_lang', 0, null, '1', 0, 0, 'widthcentpercentminusx maxwidth300');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>';\n\t\t\t}\n\n\t\t\t// Status\n\t\t\tprint '<tr><td>'.$langs->trans(\"Status\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $object->getLibStatut(4);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Company / Contact\n\t\t\tif (!empty($conf->societe->enabled)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->socid > 0) {\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tprint $societe->getNomUrl(1, '');\n\t\t\t\t\tif ($object->contact_id) {\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($object->contact_id);\n\t\t\t\t\t\tprint ' / <a href=\"'.DOL_URL_ROOT.'/contact/card.php?id='.$object->contact_id.'\">'.img_object($langs->trans(\"ShowContact\"), 'contact').' '.dol_trunc($contact->getFullName($langs), 32).'</a>';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"ThisUserIsNot\").'</span>';\n\t\t\t\t}\n\t\t\t\tprint ' <span class=\"opacitymedium hideonsmartphone\">('.$langs->trans(\"UseTypeFieldToChange\").')</span>';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (!empty($conf->adherent->enabled)) {\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member) {\n\t\t\t\t\t$adh = new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref = $adh->login; // Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(1);\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"UserNotLinkedToMember\").'</span>';\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Multicompany\n\t\t\t// TODO check if user not linked with the current entity before change entity (thirdparty, invoice, etc.) !!\n\t\t\tif (!empty($conf->multicompany->enabled) && is_object($mc)) {\n\t\t\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\t\t\tif (!method_exists($mc, 'formObjectOptions')) {\n\t\t\t\t\tif (empty($conf->multicompany->transverse_mode) && $conf->entity == 1 && $user->admin && !$user->entity) {\n\t\t\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t\t\t\t\t\tprint \"<td>\".$mc->select_entities($object->entity, 'entity', '', 0, 1, false, false, 1); // last parameter 1 means, show also a choice 0=>'all entities'\n\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\t$parameters = array('colspan' => ' colspan=\"2\"');\n\t\t\t//include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_edit.tpl.php';\t\t// We do not use common tpl here because we need a special test on $caneditfield\n\t\t\t$reshook = $hookmanager->executeHooks('formObjectOptions', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tprint $hookmanager->resPrint;\n\t\t\tif (empty($reshook)) {\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint $object->showOptionals($extrafields, 'edit');\n\t\t\t\t} else {\n\t\t\t\t\tprint $object->showOptionals($extrafields, 'view');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t\t\t\t$doleditor = new DolEditor('signature', $object->signature, '', 138, 'dolibarr_notes', 'In', false, true, empty($conf->global->FCKEDITOR_ENABLE_USERSIGN) ? 0 : 1, ROWS_4, '90%');\n\t\t\t\tprint $doleditor->Create(1);\n\t\t\t} else {\n\t\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\n\t\t\tprint '</table>';\n\n\t\t\tprint '<hr>';\n\n\n\t\t\tprint '<table class=\"border centpercent\">';\n\n\n\t\t\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<input type=\"text\" class=\"minwidth300 maxwidth500\" name=\"job\" value=\"'.dol_escape_htmltag($object->job).'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"job\" value=\"'.dol_escape_htmltag($object->job).'\">';\n\t\t\t\tprint dol_escape_htmltag($object->job);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.price2num(GETPOST('weeklyhours') ?GETPOST('weeklyhours') : $object->weeklyhours).'\">';\n\t\t\t} else {\n\t\t\t\tprint price2num($object->weeklyhours);\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Sensitive salary/value information\n\t\t\tif ((empty($user->socid) && in_array($id, $childids))\t// A user can always see salary/value information for its subordinates\n\t\t\t\t|| (!empty($conf->salaries->enabled) && !empty($user->rights->salaries->readall))\n\t\t\t\t|| (!empty($conf->hrm->enabled) && !empty($user->rights->hrm->employee->read))) {\n\t\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint img_picto('', 'salary', 'class=\"pictofixedwidth paddingright\"').'<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.price2num(GETPOST('salary') ?GETPOST('salary') : $object->salary).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.price2num(GETPOST('thm') ?GETPOST('thm') : $object->thm).'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint ($object->thm != '' ?price($object->thm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.price2num(GETPOST('tjm') ?GETPOST('tjm') : $object->tjm).'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint ($object->tjm != '' ?price($object->tjm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($dateemployment ? $dateemployment : $object->dateemployment, 'dateemployment', 0, 0, 1, 'formdateemployment', 1, 1);\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->dateemployment, 'day');\n\t\t\t}\n\n\t\t\tif ($dateemployment && $dateemploymentend) {\n\t\t\t\tprint ' - ';\n\t\t\t}\n\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($dateemploymentend ? $dateemploymentend : $object->dateemploymentend, 'dateemploymentend', 0, 0, 1, 'formdateemploymentend', 1, 0);\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->dateemploymentend, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date birth\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateOfBirth\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\techo $form->selectDate($dateofbirth ? $dateofbirth : $object->birth, 'dateofbirth', 0, 0, 1, 'updateuser', 1, 0);\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->birth, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '</table>';\n\n\t\t\tprint dol_get_fiche_end();\n\n\t\t\tprint '<div class=\"center\">';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Save\").'\" class=\"button button-save\" type=\"submit\" name=\"save\">';\n\t\t\tprint '&nbsp; &nbsp; &nbsp;';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Cancel\").'\" class=\"button button-cancel\" type=\"submit\" name=\"cancel\">';\n\t\t\tprint '</div>';\n\n\t\t\tprint '</form>';\n\t\t}\n\n\t\tif ($action != 'edit' && $action != 'presend') {\n\t\t\tprint '<div class=\"fichecenter\"><div class=\"fichehalfleft\">';\n\n\t\t\t// Generated documents\n\t\t\t$filename = dol_sanitizeFileName($object->ref);\n\t\t\t$filedir = $conf->user->dir_output.\"/\".dol_sanitizeFileName($object->ref);\n\t\t\t$urlsource = $_SERVER[\"PHP_SELF\"].\"?id=\".$object->id;\n\t\t\t$genallowed = $user->rights->user->user->lire;\n\t\t\t$delallowed = $user->rights->user->user->creer;\n\n\t\t\tprint $formfile->showdocuments('user', $filename, $filedir, $urlsource, $genallowed, $delallowed, $object->model_pdf, 1, 0, 0, 28, 0, '', 0, '', empty($soc->default_lang) ? '' : $soc->default_lang);\n\t\t\t$somethingshown = $formfile->numoffiles;\n\n\t\t\t// Show links to link elements\n\t\t\t$linktoelem = $form->showLinkToObjectBlock($object, null, null);\n\t\t\t$somethingshown = $form->showLinkedObjectBlock($object, $linktoelem);\n\n\t\t\tprint '</div><div class=\"fichehalfright\">';\n\n\t\t\t// List of actions on element\n\t\t\tinclude_once DOL_DOCUMENT_ROOT.'/core/class/html.formactions.class.php';\n\t\t\t$formactions = new FormActions($db);\n\t\t\t$somethingshown = $formactions->showactions($object, 'user', $socid, 1);\n\n\t\t\tprint '</div></div>';\n\t\t}\n\n\t\tif (!empty($conf->ldap->enabled) && !empty($object->ldap_sid)) {\n\t\t\t$ldap->unbind();\n\t\t}\n\t}\n}\n\nif (!empty($conf->api->enabled) && !empty($conf->use_javascript_ajax)) {\n\tprint \"\\n\".'<script type=\"text/javascript\">';\n\tprint '$(document).ready(function () {\n            $(\"#generate_api_key\").click(function() {\n                $.get( \"'.DOL_URL_ROOT.'/core/ajax/security.php\", {\n                    action: \\'getrandompassword\\',\n                    generic: true\n                },\n                function(token) {\n                    $(\"#api_key\").val(token);\n                });\n            });\n    });';\n\tprint '</script>';\n}\n\n// End of page\nllxFooter();\n$db->close();\n"], "fixing_code": ["<?php\n/* Copyright (C) 2002-2006 Rodolphe Quiedeville <rodolphe@quiedeville.org>\n * Copyright (C) 2002-2003 Jean-Louis Bergamo   <jlb@j1b.org>\n * Copyright (C) 2004-2020 Laurent Destailleur  <eldy@users.sourceforge.net>\n * Copyright (C) 2004      Eric Seigne          <eric.seigne@ryxeo.com>\n * Copyright (C) 2005-2021 Regis Houssin        <regis.houssin@inodbox.com>\n * Copyright (C) 2005      Lionel Cousteix      <etm_ltd@tiscali.co.uk>\n * Copyright (C) 2011      Herve Prot           <herve.prot@symeos.com>\n * Copyright (C) 2012-2018 Juanjo Menent        <jmenent@2byte.es>\n * Copyright (C) 2013      Florian Henry        <florian.henry@open-concept.pro>\n * Copyright (C) 2013-2016 Alexandre Spangaro   <aspangaro@open-dsi.fr>\n * Copyright (C) 2015-2017 Jean-Fran\u00e7ois Ferry  <jfefe@aternatik.fr>\n * Copyright (C) 2015      Ari Elbaz (elarifr)  <github@accedinfo.com>\n * Copyright (C) 2015-2018 Charlene Benke       <charlie@patas-monkey.com>\n * Copyright (C) 2016      Rapha\u00ebl Doursenaud   <rdoursenaud@gpcsolutions.fr>\n * Copyright (C) 2018-2021  Fr\u00e9d\u00e9ric France     <frederic.france@netlogic.fr>\n * Copyright (C) 2018       David Beniamine     <David.Beniamine@Tetras-Libre.fr>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <https://www.gnu.org/licenses/>.\n */\n\n/**\n *       \\file       htdocs/user/card.php\n *       \\brief      Tab of user card\n */\n\nrequire '../main.inc.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/usergroup.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/contact/class/contact.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/company.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/images.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/usergroups.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/extrafields.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formadmin.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formother.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\nif (!empty($conf->ldap->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/ldap.class.php';\n}\nif (!empty($conf->adherent->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';\n}\nif (!empty($conf->categorie->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/categories/class/categorie.class.php';\n}\nif (!empty($conf->stock->enabled)) {\n\trequire_once DOL_DOCUMENT_ROOT.'/product/class/html.formproduct.class.php';\n}\n\n$id = GETPOST('id', 'int');\n$action\t\t= GETPOST('action', 'aZ09');\n$mode = GETPOST('mode', 'alpha');\n$confirm\t= GETPOST('confirm', 'alpha');\n$group = GETPOST(\"group\", \"int\", 3);\n$cancel\t\t= GETPOST('cancel', 'alpha');\n$contextpage = GETPOST('contextpage', 'aZ') ?GETPOST('contextpage', 'aZ') : 'useracard'; // To manage different context of search\n\n$dateemployment = dol_mktime(0, 0, 0, GETPOST('dateemploymentmonth', 'int'), GETPOST('dateemploymentday', 'int'), GETPOST('dateemploymentyear', 'int'));\n$dateemploymentend = dol_mktime(0, 0, 0, GETPOST('dateemploymentendmonth', 'int'), GETPOST('dateemploymentendday', 'int'), GETPOST('dateemploymentendyear', 'int'));\n$datestartvalidity = dol_mktime(0, 0, 0, GETPOST('datestartvaliditymonth', 'int'), GETPOST('datestartvalidityday', 'int'), GETPOST('datestartvalidityyear', 'int'));\n$dateendvalidity = dol_mktime(0, 0, 0, GETPOST('dateendvaliditymonth', 'int'), GETPOST('dateendvalidityday', 'int'), GETPOST('dateendvalidityyear', 'int'));\n$dateofbirth = dol_mktime(0, 0, 0, GETPOST('dateofbirthmonth', 'int'), GETPOST('dateofbirthday', 'int'), GETPOST('dateofbirthyear', 'int'));\n\n// Define value to know what current user can do on users\n$canadduser = (!empty($user->admin) || $user->rights->user->user->creer);\n$canreaduser = (!empty($user->admin) || $user->rights->user->user->lire);\n$canedituser = (!empty($user->admin) || $user->rights->user->user->creer);\n$candisableuser = (!empty($user->admin) || $user->rights->user->user->supprimer);\n$canreadgroup = $canreaduser;\n$caneditgroup = $canedituser;\nif (!empty($conf->global->MAIN_USE_ADVANCED_PERMS)) {\n\t$canreadgroup = (!empty($user->admin) || $user->rights->user->group_advance->read);\n\t$caneditgroup = (!empty($user->admin) || $user->rights->user->group_advance->write);\n}\n\n$childids = $user->getAllChildIds(1);\t// For later, test on salary visibility\n\n// Define value to know what current user can do on properties of edited user\nif ($id > 0) {\n\t// $user is the current logged user, $id is the user we want to edit\n\t$caneditfield = ((($user->id == $id) && $user->rights->user->self->creer) || (($user->id != $id) && $user->rights->user->user->creer));\n\t$caneditpassword = ((($user->id == $id) && $user->rights->user->self->password) || (($user->id != $id) && $user->rights->user->user->password));\n}\n\n// Security check\n$socid = 0;\nif ($user->socid > 0) {\n\t$socid = $user->socid;\n}\n$feature2 = 'user';\n$result = restrictedArea($user, 'user', $id, 'user', $feature2);\n\nif ($user->id != $id && !$canreaduser) {\n\taccessforbidden();\n}\n\n// Load translation files required by page\n$langs->loadLangs(array('users', 'companies', 'ldap', 'admin', 'hrm', 'stocks', 'other'));\n\n$object = new User($db);\n$extrafields = new ExtraFields($db);\n\n// fetch optionals attributes and labels\n$extrafields->fetch_name_optionals_label($object->table_element);\n\n$socialnetworks = getArrayOfSocialNetworks();\n\n// Initialize technical object to manage hooks. Note that conf->hooks_modules contains array\n$hookmanager->initHooks(array('usercard', 'globalcard'));\n\n$error = 0;\n\n\n/**\n * Actions\n */\n\n$parameters = array('id' => $id, 'socid' => $socid, 'group' => $group, 'caneditgroup' => $caneditgroup);\n$reshook = $hookmanager->executeHooks('doActions', $parameters, $object, $action); // Note that $action and $object may have been modified by some hooks\nif ($reshook < 0) {\n\tsetEventMessages($hookmanager->error, $hookmanager->errors, 'errors');\n}\n\nif (empty($reshook)) {\n\t$backurlforlist = DOL_URL_ROOT.'/user/list.php';\n\n\tif (empty($backtopage) || ($cancel && empty($id))) {\n\t\tif (empty($backtopage) || ($cancel && strpos($backtopage, '__ID__'))) {\n\t\t\tif (empty($id) && (($action != 'add' && $action != 'create') || $cancel)) {\n\t\t\t\t$backtopage = $backurlforlist;\n\t\t\t} else {\n\t\t\t\t$backtopage = DOL_URL_ROOT.'/user/card.php?id='.((!empty($id) && $id > 0) ? $id : '__ID__');\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($cancel) {\n\t\tif (!empty($backtopageforcancel)) {\n\t\t\theader(\"Location: \".$backtopageforcancel);\n\t\t\texit;\n\t\t} elseif (!empty($backtopage)) {\n\t\t\theader(\"Location: \".$backtopage);\n\t\t\texit;\n\t\t}\n\t\t$action = '';\n\t}\n\n\tif ($action == 'confirm_disable' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id != $user->id) {\t\t// A user can't disable itself\n\t\t\t$object->fetch($id);\n\t\t\tif ($object->admin && empty($user->admin)) {\n\t\t\t\t// If user to delete is an admin user and if logged user is not admin, we deny the operation.\n\t\t\t\t$error++;\n\t\t\t\tsetEventMessages($langs->trans(\"OnlyAdminUsersCanDisableAdminUsers\"), null, 'errors');\n\t\t\t} else {\n\t\t\t\t$object->setstatus(0);\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'confirm_enable' && $confirm == \"yes\" && $candisableuser) {\n\t\t$error = 0;\n\n\t\tif ($id != $user->id) {\n\t\t\t$object->fetch($id);\n\n\t\t\tif (!empty($conf->file->main_limit_users)) {\n\t\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t\t$error++;\n\t\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$error) {\n\t\t\t\t$object->setstatus(1);\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'confirm_delete' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id != $user->id) {\n\t\t\tif (!GETPOSTISSET('token')) {\n\t\t\t\tprint 'Error, token required for this critical operation';\n\t\t\t\texit;\n\t\t\t}\n\n\t\t\t$object = new User($db);\n\t\t\t$object->fetch($id);\n\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t$result = $object->delete($user);\n\t\t\tif ($result < 0) {\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\tsetEventMessages($langs->trans(\"ErrorUserCannotBeDelete\"), null, 'errors');\n\t\t\t} else {\n\t\t\t\tsetEventMessages($langs->trans(\"RecordDeleted\"), null);\n\t\t\t\theader(\"Location: \".DOL_URL_ROOT.\"/user/list.php?restore_lastsearch_values=1\");\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action Add user\n\tif ($action == 'add' && $canadduser) {\n\t\t$error = 0;\n\n\t\tif (!GETPOST(\"lastname\")) {\n\t\t\t$error++;\n\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\"; // Go back to create page\n\t\t}\n\t\tif (!GETPOST(\"login\")) {\n\t\t\t$error++;\n\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\"; // Go back to create page\n\t\t}\n\n\t\tif (!empty($conf->file->main_limit_users)) { // If option to limit users is set\n\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t$error++;\n\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t$action = \"create\"; // Go back to create page\n\t\t\t}\n\t\t}\n\n\t\tif (!$error) {\n\t\t\t$object->civility_code = GETPOST(\"civility_code\", 'aZ09');\n\t\t\t$object->lastname = GETPOST(\"lastname\", 'alphanohtml');\n\t\t\t$object->firstname = GETPOST(\"firstname\", 'alphanohtml');\n\t\t\t$object->login = GETPOST(\"login\", 'alphanohtml');\n\t\t\t$object->api_key = GETPOST(\"api_key\", 'alphanohtml');\n\t\t\t$object->gender = GETPOST(\"gender\", 'aZ09');\n\t\t\t$object->admin = GETPOST(\"admin\", 'int');\n\t\t\t$object->address = GETPOST('address', 'alphanohtml');\n\t\t\t$object->zip = GETPOST('zipcode', 'alphanohtml');\n\t\t\t$object->town = GETPOST('town', 'alphanohtml');\n\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alphanohtml');\n\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alphanohtml');\n\t\t\t$object->user_mobile = GETPOST(\"user_mobile\", 'alphanohtml');\n\n\t\t\tif (!empty($conf->socialnetworks->enabled)) {\n\t\t\t\t$object->socialnetworks = array();\n\t\t\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\t\t\tif (GETPOST($key, 'alphanohtml')) {\n\t\t\t\t\t\t$object->socialnetworks[$key] = GETPOST($key, 'alphanohtml');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alphanohtml'));\n\t\t\t$object->job = GETPOST(\"job\", 'alphanohtml');\n\t\t\t$object->signature = GETPOST(\"signature\", 'restricthtml');\n\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\", 'alphanohtml');\n\t\t\t$object->note = GETPOST(\"note\", 'restricthtml');\n\t\t\t$object->note_private = GETPOST(\"note\", 'restricthtml');\n\t\t\t$object->ldap_sid = GETPOST(\"ldap_sid\", 'alphanohtml');\n\t\t\t$object->fk_user = GETPOST(\"fk_user\", 'int') > 0 ? GETPOST(\"fk_user\", 'int') : 0;\n\t\t\t$object->fk_user_expense_validator = GETPOST(\"fk_user_expense_validator\", 'int') > 0 ? GETPOST(\"fk_user_expense_validator\", 'int') : 0;\n\t\t\t$object->fk_user_holiday_validator = GETPOST(\"fk_user_holiday_validator\", 'int') > 0 ? GETPOST(\"fk_user_holiday_validator\", 'int') : 0;\n\t\t\t$object->employee = GETPOST('employee', 'alphanohtml');\n\n\t\t\t$object->thm = GETPOST(\"thm\", 'alphanohtml') != '' ? GETPOST(\"thm\", 'alphanohtml') : '';\n\t\t\t$object->thm = price2num($object->thm);\n\t\t\t$object->tjm = GETPOST(\"tjm\", 'alphanohtml') != '' ? GETPOST(\"tjm\", 'alphanohtml') : '';\n\t\t\t$object->tjm = price2num($object->tjm);\n\t\t\t$object->salary = GETPOST(\"salary\", 'alphanohtml') != '' ? GETPOST(\"salary\", 'alphanohtml') : '';\n\t\t\t$object->salary = price2num($object->salary);\n\t\t\t$object->salaryextra = GETPOST(\"salaryextra\", 'alphanohtml') != '' ? GETPOST(\"salaryextra\", 'alphanohtml') : '';\n\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\", 'alphanohtml') != '' ? GETPOST(\"weeklyhours\", 'alphanohtml') : '';\n\n\t\t\t$object->color = GETPOST(\"color\", 'alphanohtml') != '' ? GETPOST(\"color\", 'alphanohtml') : '';\n\n\t\t\t$object->dateemployment = $dateemployment;\n\t\t\t$object->dateemploymentend = $dateemploymentend;\n\t\t\t$object->datestartvalidity = $datestartvalidity;\n\t\t\t$object->dateendvalidity = $dateendvalidity;\n\t\t\t$object->birth = $dateofbirth;\n\n\t\t\t$object->fk_warehouse = GETPOST('fk_warehouse', 'int');\n\n\t\t\t$object->lang = GETPOST('default_lang', 'aZ09');\n\n\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t$ret = $extrafields->setOptionalsFromPost(null, $object);\n\t\t\tif ($ret < 0) {\n\t\t\t\t$error++;\n\t\t\t}\n\n\t\t\t// Set entity property\n\t\t\t$entity = GETPOST('entity', 'int');\n\t\t\tif (!empty($conf->multicompany->enabled)) {\n\t\t\t\tif (GETPOST('superadmin', 'int')) {\n\t\t\t\t\t$object->entity = 0;\n\t\t\t\t} else {\n\t\t\t\t\tif (!empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t\t\t\t$object->entity = 1; // all users are forced into master entity\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t/*if ($user->admin && $user->entity == 0 && GETPOST(\"admin\",'alpha'))\n\t\t\t\t{\n\t\t\t\t}*/\n\t\t\t}\n\n\t\t\t$db->begin();\n\n\t\t\t$id = $object->create($user);\n\t\t\tif ($id > 0) {\n\t\t\t\tif (GETPOST('password', 'none')) {\n\t\t\t\t\t$object->setPassword($user, GETPOST('password', 'none'));\n\t\t\t\t}\n\t\t\t\tif (!empty($conf->categorie->enabled)) {\n\t\t\t\t\t// Categories association\n\t\t\t\t\t$usercats = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($usercats);\n\t\t\t\t}\n\t\t\t\t$db->commit();\n\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t} else {\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t$db->rollback();\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t$action = \"create\"; // Go back to create page\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action add usergroup\n\tif (($action == 'addgroup' || $action == 'removegroup') && $caneditgroup) {\n\t\tif ($group) {\n\t\t\t$editgroup = new UserGroup($db);\n\t\t\t$editgroup->fetch($group);\n\t\t\t$editgroup->oldcopy = clone $editgroup;\n\n\t\t\t$object->fetch($id);\n\t\t\tif ($action == 'addgroup') {\n\t\t\t\t$result = $object->SetInGroup($group, $editgroup->entity);\n\t\t\t}\n\t\t\tif ($action == 'removegroup') {\n\t\t\t\t$result = $object->RemoveFromGroup($group, $editgroup->entity);\n\t\t\t}\n\n\t\t\tif ($result > 0) {\n\t\t\t\t$action = '';\n\t\t\t} else {\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'update' && !$cancel) {\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';\n\n\t\tif ($caneditfield) {    // Case we can edit all field\n\t\t\t$error = 0;\n\n\t\t\tif (!GETPOST(\"lastname\", 'alpha')) {\n\t\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\"; // Go back to create page\n\t\t\t\t$error++;\n\t\t\t}\n\t\t\tif (!GETPOST(\"login\", 'alpha')) {\n\t\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\"; // Go back to create page\n\t\t\t\t$error++;\n\t\t\t}\n\n\t\t\tif (!$error) {\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t$db->begin();\n\n\t\t\t\t$object->civility_code = GETPOST(\"civility_code\", 'aZ09');\n\t\t\t\t$object->lastname = GETPOST(\"lastname\", 'alphanohtml');\n\t\t\t\t$object->firstname = GETPOST(\"firstname\", 'alphanohtml');\n\t\t\t\t$object->gender = GETPOST(\"gender\", 'aZ09');\n\t\t\t\t$object->pass = GETPOST(\"password\", 'none');\t// We can keep 'none' for password fields\n\t\t\t\t$object->api_key = (GETPOST(\"api_key\", 'alphanohtml')) ? GETPOST(\"api_key\", 'alphanohtml') : $object->api_key;\n\t\t\t\tif (!empty($user->admin)) { \t// admin flag can only be set/unset by an admin user. A test is also done later when forging sql request\n\t\t\t\t\t$object->admin = GETPOST(\"admin\", \"int\");\n\t\t\t\t}\n\t\t\t\tif ($user->admin && !$object->ldap_sid) {\t// same test than on edit page\n\t\t\t\t\t$object->login = GETPOST(\"login\", 'alphanohtml');\n\t\t\t\t}\n\t\t\t\t$object->address = GETPOST('address', 'alphanohtml');\n\t\t\t\t$object->zip = GETPOST('zipcode', 'alphanohtml');\n\t\t\t\t$object->town = GETPOST('town', 'alphanohtml');\n\t\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alphanohtml');\n\t\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alphanohtml');\n\t\t\t\t$object->user_mobile = GETPOST(\"user_mobile\", 'alphanohtml');\n\n\t\t\t\tif (!empty($conf->socialnetworks->enabled)) {\n\t\t\t\t\t$object->socialnetworks = array();\n\t\t\t\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\t\t\t\tif (GETPOST($key, 'alphanohtml')) {\n\t\t\t\t\t\t\t$object->socialnetworks[$key] = GETPOST($key, 'alphanohtml');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alphanohtml'));\n\t\t\t\t$object->job = GETPOST(\"job\", 'alphanohtml');\n\t\t\t\t$object->signature = GETPOST(\"signature\", 'restricthtml');\n\t\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\", 'alphanohtml');\n\t\t\t\t$object->openid = GETPOST(\"openid\", 'alphanohtml');\n\t\t\t\t$object->fk_user = GETPOST(\"fk_user\", 'int') > 0 ? GETPOST(\"fk_user\", 'int') : 0;\n\t\t\t\t$object->fk_user_expense_validator = GETPOST(\"fk_user_expense_validator\", 'int') > 0 ? GETPOST(\"fk_user_expense_validator\", 'int') : 0;\n\t\t\t\t$object->fk_user_holiday_validator = GETPOST(\"fk_user_holiday_validator\", 'int') > 0 ? GETPOST(\"fk_user_holiday_validator\", 'int') : 0;\n\t\t\t\t$object->employee = GETPOST('employee', 'int');\n\n\t\t\t\t$object->thm = GETPOST(\"thm\", 'alphanohtml') != '' ? GETPOST(\"thm\", 'alphanohtml') : '';\n\t\t\t\t$object->thm = price2num($object->thm);\n\t\t\t\t$object->tjm = GETPOST(\"tjm\", 'alphanohtml') != '' ? GETPOST(\"tjm\", 'alphanohtml') : '';\n\t\t\t\t$object->thm = price2num($object->thm);\n\t\t\t\t$object->salary = GETPOST(\"salary\", 'alphanohtml') != '' ? GETPOST(\"salary\", 'alphanohtml') : '';\n\t\t\t\t$object->salary = price2num($object->salary);\n\t\t\t\t$object->salaryextra = GETPOST(\"salaryextra\", 'alphanohtml') != '' ? GETPOST(\"salaryextra\", 'alphanohtml') : '';\n\t\t\t\t$object->salaryextra = price2num($object->salaryextra);\n\t\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\", 'alphanohtml') != '' ? GETPOST(\"weeklyhours\", 'alphanohtml') : '';\n\t\t\t\t$object->weeklyhours = price2num($object->weeklyhours);\n\n\t\t\t\t$object->color = GETPOST(\"color\", 'alphanohtml') != '' ? GETPOST(\"color\", 'alphanohtml') : '';\n\t\t\t\t$object->dateemployment = $dateemployment;\n\t\t\t\t$object->dateemploymentend = $dateemploymentend;\n\t\t\t\t$object->datestartvalidity = $datestartvalidity;\n\t\t\t\t$object->dateendvalidity = $dateendvalidity;\n\t\t\t\t$object->birth = $dateofbirth;\n\n\t\t\t\tif (!empty($conf->stock->enabled)) {\n\t\t\t\t\t$object->fk_warehouse = GETPOST('fk_warehouse', 'int');\n\t\t\t\t}\n\n\t\t\t\t$object->lang = GETPOST('default_lang', 'aZ09');\n\n\t\t\t\t// Do we update also ->entity ?\n\t\t\t\tif (!empty($conf->multicompany->enabled && $user->entity == 0 && !empty($user->admin))) {\t// If multicompany is not enabled, we never update the entity of a user.\n\t\t\t\t\tif (GETPOST('superadmin', 'int')) {\n\t\t\t\t\t\t$object->entity = 0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (!empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t\t\t\t\t$object->entity = 1; // all users are in master entity\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// We try to change the entity of user\n\t\t\t\t\t\t\t$object->entity = (GETPOSTISSET('entity') ? GETPOSTINT('entity') : $object->entity);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t\t$ret = $extrafields->setOptionalsFromPost(null, $object, '@GETPOSTISSET');\n\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t$error++;\n\t\t\t\t}\n\n\t\t\t\tif (GETPOST('deletephoto')) {\n\t\t\t\t\t$object->photo = '';\n\t\t\t\t}\n\t\t\t\tif (!empty($_FILES['photo']['name'])) {\n\t\t\t\t\t$isimage = image_format_supported($_FILES['photo']['name']);\n\t\t\t\t\tif ($isimage > 0) {\n\t\t\t\t\t\t$object->photo = dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorBadImageFormat\"), null, 'errors');\n\t\t\t\t\t\tdol_syslog($langs->transnoentities(\"ErrorBadImageFormat\"), LOG_INFO);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error) {\n\t\t\t\t\t$ret = $object->update($user);\n\t\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\tif ($db->errno() == 'DB_ERROR_RECORD_ALREADY_EXISTS') {\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorLoginAlreadyExists\", $object->login), null, 'errors');\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t\t\t\t$action = 'edit';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && GETPOSTISSET('contactid')) {\n\t\t\t\t\t$contactid = GETPOST('contactid', 'int');\n\t\t\t\t\t$socid = GETPOST('socid', 'int');\n\n\t\t\t\t\tif ($contactid > 0) {\t// The 'contactid' is used inpriority over the 'socid'\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($contactid);\n\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=\".((int) $contactid);\n\t\t\t\t\t\tif (!empty($contact->socid)) {\n\t\t\t\t\t\t\t$sql .= \", fk_soc=\".((int) $contact->socid);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$sql .= \" WHERE rowid = \".((int) $object->id);\n\t\t\t\t\t} elseif ($socid > 0) {\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=NULL, fk_soc=\".((int) $socid);\n\t\t\t\t\t\t$sql .= \" WHERE rowid = \".((int) $object->id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=NULL, fk_soc=NULL\";\n\t\t\t\t\t\t$sql .= \" WHERE rowid = \".((int) $object->id);\n\t\t\t\t\t}\n\t\t\t\t\tdol_syslog(\"usercard::update\", LOG_DEBUG);\n\t\t\t\t\t$resql = $db->query($sql);\n\t\t\t\t\tif (!$resql) {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\tsetEventMessages($db->lasterror(), null, 'errors');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tif (GETPOST('deletephoto') && $object->oldcopy->photo) {\n\t\t\t\t\t\t$fileimg = $conf->user->dir_output.'/'.get_exdir(0, 0, 0, 0, $object, 'user').'photos/'.$object->oldcopy->photo;\n\t\t\t\t\t\t$dirthumbs = $conf->user->dir_output.'/'.get_exdir(0, 0, 0, 0, $object, 'user').'photos/thumbs';\n\t\t\t\t\t\tdol_delete_file($fileimg);\n\t\t\t\t\t\tdol_delete_dir_recursive($dirthumbs);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isset($_FILES['photo']['tmp_name']) && trim($_FILES['photo']['tmp_name'])) {\n\t\t\t\t\t\t$dir = $conf->user->dir_output.'/'.get_exdir(0, 0, 0, 1, $object, 'user').'/photos';\n\n\t\t\t\t\t\tdol_mkdir($dir);\n\n\t\t\t\t\t\tif (@is_dir($dir)) {\n\t\t\t\t\t\t\t$newfile = $dir.'/'.dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t\t\t\t$result = dol_move_uploaded_file($_FILES['photo']['tmp_name'], $newfile, 1, 0, $_FILES['photo']['error']);\n\n\t\t\t\t\t\t\tif (!$result > 0) {\n\t\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSaveFile\"), null, 'errors');\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// Create thumbs\n\t\t\t\t\t\t\t\t$object->addThumbs($newfile);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToCreateDir\", $dir), $mesgs, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\t// Then we add the associated categories\n\t\t\t\t\t$categories = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($categories);\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tsetEventMessages($langs->trans(\"UserModified\"), null, 'mesgs');\n\t\t\t\t\t$db->commit();\n\n\t\t\t\t\t$login = $_SESSION[\"dol_login\"];\n\t\t\t\t\tif ($login && $login == $object->oldcopy->login && $object->oldcopy->login != $object->login) {    // Current user has changed its login\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\tsetEventMessages($langs->transnoentitiesnoconv(\"WarningYourLoginWasModifiedPleaseLogin\"), null, 'warnings');\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$db->rollback();\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tif ($caneditpassword) {    // Case we can edit only password\n\t\t\t\tdol_syslog(\"Not allowed to change fields, only password\");\n\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\tif (GETPOST(\"password\", \"none\")) {\t// If pass is empty, we do not change it.\n\t\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t\t$ret = $object->setPassword($user, GETPOST(\"password\", \"none\"));\n\t\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Change password with a new generated one\n\tif ((($action == 'confirm_password' && $confirm == 'yes')\n\t\t\t|| ($action == 'confirm_passwordsend' && $confirm == 'yes')) && $caneditpassword\n\t) {\n\t\t$object->fetch($id);\n\n\t\t$newpassword = $object->setPassword($user, '');\t// This will generate a new password\n\t\tif ($newpassword < 0) {\n\t\t\t// Echec\n\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSetNewPassword\"), null, 'errors');\n\t\t} else {\n\t\t\t// Succes\n\t\t\tif ($action == 'confirm_passwordsend' && $confirm == 'yes') {\n\t\t\t\tif ($object->send_password($user, $newpassword) > 0) {\n\t\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedAndSentTo\", $object->email), null, 'mesgs');\n\t\t\t\t} else {\n\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedTo\", $newpassword), null, 'warnings');\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action initialisation donnees depuis record LDAP\n\tif ($action == 'adduserldap' && $canadduser) {\n\t\t$selecteduser = GETPOST('users');\n\n\t\t$required_fields = array(\n\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t);\n\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0) {\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields = array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t$ldapusers = $ldap->getRecords($selecteduser, $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields);\n\t\t\t//print_r($ldapusers);\n\n\t\t\tif (is_array($ldapusers)) {\n\t\t\t\tforeach ($ldapusers as $key => $attribute) {\n\t\t\t\t\t$ldap_lastname = $attribute[$conf->global->LDAP_FIELD_NAME];\n\t\t\t\t\t$ldap_firstname = $attribute[$conf->global->LDAP_FIELD_FIRSTNAME];\n\t\t\t\t\t$ldap_login = $attribute[$conf->global->LDAP_FIELD_LOGIN];\n\t\t\t\t\t$ldap_loginsmb = $attribute[$conf->global->LDAP_FIELD_LOGIN_SAMBA];\n\t\t\t\t\t$ldap_pass = $attribute[$conf->global->LDAP_FIELD_PASSWORD];\n\t\t\t\t\t$ldap_pass_crypted = $attribute[$conf->global->LDAP_FIELD_PASSWORD_CRYPTED];\n\t\t\t\t\t$ldap_phone = $attribute[$conf->global->LDAP_FIELD_PHONE];\n\t\t\t\t\t$ldap_fax = $attribute[$conf->global->LDAP_FIELD_FAX];\n\t\t\t\t\t$ldap_mobile = $attribute[$conf->global->LDAP_FIELD_MOBILE];\n\t\t\t\t\t$ldap_social['skype'] = $attribute[$conf->global->LDAP_FIELD_SKYPE];\n\t\t\t\t\t$ldap_social['twitter'] = $attribute[$conf->global->LDAP_FIELD_TWITTER];\n\t\t\t\t\t$ldap_social['facebook'] = $attribute[$conf->global->LDAP_FIELD_FACEBOOK];\n\t\t\t\t\t$ldap_social['linkedin'] = $attribute[$conf->global->LDAP_FIELD_LINKEDIN];\n\t\t\t\t\t$ldap_mail = $attribute[$conf->global->LDAP_FIELD_MAIL];\n\t\t\t\t\t$ldap_sid = $attribute[$conf->global->LDAP_FIELD_SID];\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\t}\n\n\t// Actions to send emails\n\t$triggersendname = 'USER_SENTBYMAIL';\n\t$paramname = 'id'; // Name of param key to open the card\n\t$mode = 'emailfromuser';\n\t$trackid = 'use'.$id;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_sendmails.inc.php';\n\n\t// Actions to build doc\n\t$upload_dir = $conf->user->dir_output;\n\t$permissiontoadd = $user->rights->user->user->creer;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_builddoc.inc.php';\n}\n\n\n/*\n * View\n */\n\n$form = new Form($db);\n$formother = new FormOther($db);\n$formcompany = new FormCompany($db);\n$formadmin = new FormAdmin($db);\n$formfile = new FormFile($db);\nif (!empty($conf->stock->enabled)) {\n\t$formproduct = new FormProduct($db);\n}\n\nllxHeader('', $langs->trans(\"UserCard\"));\n\nif ($action == 'create' || $action == 'adduserldap') {\n\tprint load_fiche_titre($langs->trans(\"NewUser\"), '', 'user');\n\n\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"CreateInternalUserDesc\").\"</span><br>\\n\";\n\tprint \"<br>\";\n\n\n\tif (!empty($conf->ldap->enabled) && (isset($conf->global->LDAP_SYNCHRO_ACTIVE) && getDolGlobalInt('LDAP_SYNCHRO_ACTIVE') === Ldap::SYNCHRO_LDAP_TO_DOLIBARR)) {\n\t\t// Show form to add an account from LDAP if sync LDAP -> Dolibarr is set\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0) {\n\t\t\t$required_fields = array(\n\t\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t\t$conf->global->LDAP_FIELD_FULLNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t\t);\n\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields = array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t// Get from LDAP database an array of results\n\t\t\t$ldapusers = $ldap->getRecords('*', $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields, 1);\n\n\t\t\tif (is_array($ldapusers)) {\n\t\t\t\t$liste = array();\n\t\t\t\tforeach ($ldapusers as $key => $ldapuser) {\n\t\t\t\t\t// Define the label string for this user\n\t\t\t\t\t$label = '';\n\t\t\t\t\tforeach ($required_fields as $value) {\n\t\t\t\t\t\tif ($value === $conf->global->LDAP_FIELD_PASSWORD || $value === $conf->global->LDAP_FIELD_PASSWORD_CRYPTED) {\n\t\t\t\t\t\t\t$label .= $value.\"=******* \";\n\t\t\t\t\t\t} elseif ($value) {\n\t\t\t\t\t\t\t$label .= $value.\"=\".$ldapuser[$value].\" \";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$liste[$key] = $label;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t}\n\t\t} else {\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\n\t\t// If user list is full, we show drop-down list\n\t\tprint \"\\n\\n<!-- Form liste LDAP debut -->\\n\";\n\n\t\tprint '<form name=\"add_user_ldap\" action=\"'.$_SERVER[\"PHP_SELF\"].'\" method=\"post\">';\n\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\">';\n\t\tprint '<table class=\"border centpercent\"><tr>';\n\t\tprint '<td width=\"160\">';\n\t\tprint $langs->trans(\"LDAPUsers\");\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input type=\"hidden\" name=\"action\" value=\"adduserldap\">';\n\t\tif (is_array($liste) && count($liste)) {\n\t\t\tprint $form->selectarray('users', $liste, '', 1, 0, 0, '', 0, 0, 0, '', 'maxwidth500');\n\t\t\tprint ajax_combobox('users');\n\t\t}\n\t\tprint '</td><td class=\"center\">';\n\t\tprint '<input type=\"submit\" class=\"button\" value=\"'.dol_escape_htmltag($langs->trans('Get')).'\"'.(count($liste) ? '' : ' disabled').'>';\n\t\tprint '</td></tr></table>';\n\t\tprint '</form>';\n\n\t\tprint \"\\n<!-- Form liste LDAP fin -->\\n\\n\";\n\t\tprint '<br>';\n\t}\n\n\n\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'\" method=\"POST\" name=\"createuser\">';\n\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\">';\n\tprint '<input type=\"hidden\" name=\"action\" value=\"add\">';\n\tif (!empty($ldap_sid)) {\n\t\tprint '<input type=\"hidden\" name=\"ldap_sid\" value=\"'.dol_escape_htmltag($ldap_sid).'\">';\n\t}\n\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\">';\n\n\tprint dol_get_fiche_head('', '', '', 0, '');\n\n\tdol_set_focus('#lastname');\n\n\tprint '<table class=\"border centpercent\">';\n\n\t// Civility\n\tprint '<tr><td><label for=\"civility_code\">'.$langs->trans(\"UserTitle\").'</label></td><td colspan=\"3\">';\n\tprint $formcompany->select_civility(GETPOSTISSET(\"civility_code\") ? GETPOST(\"civility_code\", 'aZ09') : $object->civility_code, 'civility_code');\n\tprint '</td></tr>';\n\n\t// Lastname\n\tprint '<tr>';\n\tprint '<td class=\"titlefieldcreate\"><span class=\"fieldrequired\">'.$langs->trans(\"Lastname\").'</span></td>';\n\tprint '<td>';\n\tif (!empty($ldap_lastname)) {\n\t\tprint '<input type=\"hidden\" id=\"lastname\" name=\"lastname\" value=\"'.dol_escape_htmltag($ldap_lastname).'\">';\n\t\tprint $ldap_lastname;\n\t} else {\n\t\tprint '<input class=\"minwidth100 maxwidth150onsmartphone\" type=\"text\" id=\"lastname\" name=\"lastname\" value=\"'.dol_escape_htmltag(GETPOST('lastname', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Firstname\n\tprint '<tr><td>'.$langs->trans(\"Firstname\").'</td>';\n\tprint '<td>';\n\tif (!empty($ldap_firstname)) {\n\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.dol_escape_htmltag($ldap_firstname).'\">';\n\t\tprint $ldap_firstname;\n\t} else {\n\t\tprint '<input class=\"minwidth100 maxwidth150onsmartphone\" type=\"text\" name=\"firstname\" value=\"'.dol_escape_htmltag(GETPOST('firstname', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Login\n\tprint '<tr><td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\tprint '<td>';\n\tif (!empty($ldap_login)) {\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.dol_escape_htmltag($ldap_login).'\">';\n\t\tprint $ldap_login;\n\t} elseif (!empty($ldap_loginsmb)) {\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.dol_escape_htmltag($ldap_loginsmb).'\">';\n\t\tprint $ldap_loginsmb;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 maxwidth150onsmartphone\" maxsize=\"24\" type=\"text\" name=\"login\" value=\"'.dol_escape_htmltag(GETPOST('login', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t$generated_password = '';\n\tif (empty($ldap_sid)) {    // ldap_sid is for activedirectory\n\t\t$generated_password = getRandomPassword(false);\n\t}\n\t$password = (GETPOSTISSET('password') ?GETPOST('password') : $generated_password);\n\n\t// Administrator\n\tif (!empty($user->admin)) {\n\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\tprint '<td>';\n\t\tprint $form->selectyesno('admin', GETPOST('admin'), 1);\n\n\t\tif (!empty($conf->multicompany->enabled) && !$user->entity) {\n\t\t\tif (!empty($conf->use_javascript_ajax)) {\n\t\t\t\tprint '<script type=\"text/javascript\">\n                            $(function() {\n                                $(\"select[name=admin]\").change(function() {\n                                     if ( $(this).val() == 0 ) {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", true)\n                                            .prop(\"checked\", false);\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                     } else {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", false);\n                                     }\n                                });\n                                $(\"input[name=superadmin]\").change(function() {\n                                    if ( $(this).is(\":checked\") ) {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", true);\n                                    } else {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                    }\n                                });\n                            });\n                    </script>';\n\t\t\t}\n\t\t\t$checked = (GETPOST('superadmin', 'int') ? ' checked' : '');\n\t\t\t$disabled = (GETPOST('superadmin', 'int') ? '' : ' disabled');\n\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" id=\"superadmin\" value=\"1\"'.$checked.$disabled.' /> <label for=\"superadmin\">'.$langs->trans(\"SuperAdministrator\").'</span>';\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t}\n\n\t// Gender\n\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\tprint '<td>';\n\t$arraygender = array('man'=>$langs->trans(\"Genderman\"), 'woman'=>$langs->trans(\"Genderwoman\"), 'other'=>$langs->trans(\"Genderother\"));\n\tprint $form->selectarray('gender', $arraygender, GETPOST('gender'), 1);\n\tprint '</td></tr>';\n\n\t// Employee\n\t$defaultemployee = '1';\n\tprint '<tr>';\n\tprint '<td>'.$langs->trans('Employee').'</td><td>';\n\tprint '<input type=\"checkbox\" name=\"employee\" value=\"1\"'.(GETPOST('employee') == '1' ? ' checked=\"checked\"' : ($defaultemployee ? ' checked=\"checked\"' : '')).'>';\n\t//print $form->selectyesno(\"employee\", (GETPOST('employee') != '' ?GETPOST('employee') : $defaultemployee), 1);\n\tprint '</td></tr>';\n\n\t// Hierarchy\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'user', 'class=\"pictofixedwidth\"').$form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300 widthcentpercentminusx');\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Expense report validator\n\tif (!empty($conf->expensereport->enabled)) {\n\t\tprint '<tr><td class=\"titlefieldcreate\">';\n\t\t$text = $langs->trans(\"ForceUserExpenseValidator\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint img_picto('', 'user', 'class=\"pictofixedwidth\"').$form->select_dolusers($object->fk_user_expense_validator, 'fk_user_expense_validator', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300 widthcentpercentminusx');\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// Holiday request validator\n\tif (!empty($conf->holiday->enabled)) {\n\t\tprint '<tr><td class=\"titlefieldcreate\">';\n\t\t$text = $langs->trans(\"ForceUserHolidayValidator\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint img_picto('', 'user', 'class=\"pictofixedwidth\"').$form->select_dolusers($object->fk_user_holiday_validator, 'fk_user_holiday_validator', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300 widthcentpercentminusx');\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// External user\n\tprint '<tr><td>'.$langs->trans(\"ExternalUser\").' ?</td>';\n\tprint '<td>';\n\tprint $form->textwithpicto($langs->trans(\"Internal\"), $langs->trans(\"InternalExternalDesc\"), 1, 'help', '', 0, 2);\n\tprint '</td></tr>';\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// Date validity\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"RangeOfLoginValidity\").'</td>';\n\tprint '<td>';\n\tprint $form->selectDate($datestartvalidity, 'datestartvalidity', 0, 0, 1, 'formdatestartvalidity', 1, 1);\n\n\tprint ' &nbsp; ';\n\n\tprint $form->selectDate($dateendvalidity, 'dateendvalidity', 0, 0, 1, 'formdateendvalidity', 1, 0);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Password\n\tprint '<tr><td class=\"fieldrequired\">'.$langs->trans(\"Password\").'</td>';\n\tprint '<td>';\n\t$valuetoshow = '';\n\tif (preg_match('/ldap/', $dolibarr_main_authentication)) {\n\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t}\n\tif (preg_match('/http/', $dolibarr_main_authentication)) {\n\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').$langs->trans(\"HTTPBasicPassword\");\n\t}\n\tif (preg_match('/dolibarr/', $dolibarr_main_authentication)) {\n\t\tif (!empty($ldap_pass)) {\t// For very old system comaptibilty. Now clear password can't be viewed from LDAP read\n\t\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').'<input type=\"hidden\" name=\"password\" value=\"'.$ldap_pass.'\">'; // Dolibarr password is preffiled with LDAP known password\n\t\t\t$valuetoshow .= preg_replace('/./i', '*', $ldap_pass);\n\t\t} else {\n\t\t\t// We do not use a field password but a field text to show new password to use.\n\t\t\t$valuetoshow .= ($valuetoshow ? ', ' : '').'<input maxsize=\"32\" type=\"text\" name=\"password\" value=\"'.$password.'\" autocomplete=\"new-password\">';\n\t\t}\n\t}\n\n\t// Other form for user password\n\t$parameters = array('valuetoshow' => $valuetoshow, 'password' => $password);\n\t$reshook = $hookmanager->executeHooks('printUserPasswordField', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\tif ($reshook > 0) {\n\t\t$valuetoshow = $hookmanager->resPrint; // to replace\n\t} else {\n\t\t$valuetoshow .= $hookmanager->resPrint; // to add\n\t}\n\n\tprint $valuetoshow;\n\tprint '</td></tr>';\n\n\tif (!empty($conf->api->enabled)) {\n\t\t// API key\n\t\t//$generated_password = getRandomPassword(false);\n\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input class=\"minwidth300 widthcentpercentminusx\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.GETPOST('api_key', 'alphanohtml').'\" autocomplete=\"off\">';\n\t\tif (!empty($conf->use_javascript_ajax)) {\n\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\t}\n\t\tprint '</td></tr>';\n\t} else {\n\t\t// PARTIAL WORKAROUND\n\t\t$generated_fake_api_key = getRandomPassword(false);\n\t\tprint '<input type=\"hidden\" name=\"api_key\" value=\"'.$generated_fake_api_key.'\">';\n\t}\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// Address\n\tprint '<tr><td class=\"tdtop titlefieldcreate\">'.$form->editfieldkey('Address', 'address', '', $object, 0).'</td>';\n\tprint '<td><textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\tprint $object->address;\n\tprint '</textarea></td></tr>';\n\n\t// Zip\n\tprint '<tr><td>'.$form->editfieldkey('Zip', 'zipcode', '', $object, 0).'</td><td>';\n\tprint $formcompany->select_ziptown($object->zip, 'zipcode', array('town', 'selectcountry_id', 'state_id'), 6);\n\tprint '</td></tr>';\n\n\t// Town\n\tprint '<tr><td>'.$form->editfieldkey('Town', 'town', '', $object, 0).'</td><td>';\n\tprint $formcompany->select_ziptown($object->town, 'town', array('zipcode', 'selectcountry_id', 'state_id'));\n\tprint '</td></tr>';\n\n\t// Country\n\tprint '<tr><td>'.$form->editfieldkey('Country', 'selectcountry_id', '', $object, 0).'</td><td class=\"maxwidthonsmartphone\">';\n\tprint img_picto('', 'country', 'class=\"pictofixedwidth\"');\n\tprint $form->select_country((GETPOST('country_id') != '' ?GETPOST('country_id') : $object->country_id));\n\tif ($user->admin) {\n\t\tprint info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"), 1);\n\t}\n\tprint '</td></tr>';\n\n\t// State\n\tif (empty($conf->global->USER_DISABLE_STATE)) {\n\t\tprint '<tr><td>'.$form->editfieldkey('State', 'state_id', '', $object, 0).'</td><td class=\"maxwidthonsmartphone\">';\n\t\tprint img_picto('', 'state', 'class=\"pictofixedwidth\"');\n\t\tprint $formcompany->select_state($object->state_id, $object->country_code, 'state_id');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Tel\n\tprint '<tr><td>'.$langs->trans(\"PhonePro\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_phoning', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_phone)) {\n\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.dol_escape_htmltag($ldap_phone).'\">';\n\t\tprint $ldap_phone;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"office_phone\" value=\"'.dol_escape_htmltag(GETPOST('office_phone', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Tel portable\n\tprint '<tr><td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_phoning_mobile', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_mobile)) {\n\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.dol_escape_htmltag($ldap_mobile).'\">';\n\t\tprint $ldap_mobile;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"user_mobile\" value=\"'.dol_escape_htmltag(GETPOST('user_mobile', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Fax\n\tprint '<tr><td>'.$langs->trans(\"Fax\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_phoning_fax', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_fax)) {\n\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.dol_escape_htmltag($ldap_fax).'\">';\n\t\tprint $ldap_fax;\n\t} else {\n\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"office_fax\" value=\"'.dol_escape_htmltag(GETPOST('office_fax', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// EMail\n\tprint '<tr><td'.(!empty($conf->global->USER_MAIL_REQUIRED) ? ' class=\"fieldrequired\"' : '').'>'.$langs->trans(\"EMail\").'</td>';\n\tprint '<td>';\n\tprint img_picto('', 'object_email', 'class=\"pictofixedwidth\"');\n\tif (!empty($ldap_mail)) {\n\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.dol_escape_htmltag($ldap_mail).'\">';\n\t\tprint $ldap_mail;\n\t} else {\n\t\tprint '<input type=\"text\" name=\"email\" class=\"maxwidth500 widthcentpercentminusx\" value=\"'.dol_escape_htmltag(GETPOST('email', 'alphanohtml')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Social networks\n\tif (!empty($conf->socialnetworks->enabled)) {\n\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\tif ($value['active']) {\n\t\t\t\tprint '<tr><td>'.$langs->trans($value['label']).'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($value['icon'])) {\n\t\t\t\t\tprint '<span class=\"fa '.$value['icon'].' pictofixedwidth\"></span>';\n\t\t\t\t}\n\t\t\t\tif (!empty($ldap_social[$key])) {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$ldap_social[$key].'\">';\n\t\t\t\t\tprint $ldap_social[$key];\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input class=\"maxwidth200 widthcentpercentminusx\" type=\"text\" name=\"'.$key.'\" value=\"'.GETPOST($key, 'alphanohtml').'\">';\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t} else {\n\t\t\t\t// if social network is not active but value exist we do not want to loose it\n\t\t\t\tif (!empty($ldap_social[$key])) {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$ldap_social[$key].'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.GETPOST($key, 'alphanohtml').'\">';\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Accountancy code\n\tif (!empty($conf->accounting->enabled)) {\n\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input type=\"text\" class=\"maxwidthonsmartphone\" name=\"accountancy_code\" value=\"'.dol_escape_htmltag(GETPOST('accountancy_code', 'alphanohtml')).'\">';\n\t\tprint '</td></tr>';\n\t}\n\n\t// User color\n\tif (!empty($conf->agenda->enabled)) {\n\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\tprint '<td>';\n\t\tprint $formother->selectColor(GETPOSTISSET('color') ?GETPOST('color', 'alphanohtml') : $object->color, 'color', null, 1, '', 'hideifnotset');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Categories\n\tif (!empty($conf->categorie->enabled) && !empty($user->rights->categorie->lire)) {\n\t\tprint '<tr><td>'.$form->editfieldkey('Categories', 'usercats', '', $object, 0).'</td><td>';\n\t\t$cate_arbo = $form->select_all_categories('user', null, 'parent', null, null, 1);\n\t\tprint img_picto('', 'category', 'class=\"pictofixedwidth\"').$form->multiselectarray('usercats', $cate_arbo, GETPOST('usercats', 'array'), 0, 0, 'maxwdith300 widthcentpercentminusx', 0, '90%');\n\t\tprint \"</td></tr>\";\n\t}\n\n\tif (!empty($conf->global->MAIN_MULTILANGS)) {\n\t\tprint '<tr><td>'.$form->editfieldkey('DefaultLang', 'default_lang', '', $object, 0, 'string', '', 0, 0, 'id', $langs->trans(\"WarningNotLangOfInterface\", $langs->transnoentitiesnoconv(\"UserGUISetup\"))).'</td>';\n\t\tprint '<td class=\"maxwidthonsmartphone\">'.\"\\n\";\n\t\tprint img_picto('', 'language', 'class=\"pictofixedwidth\"').$formadmin->select_language(GETPOST('default_lang', 'alpha') ?GETPOST('default_lang', 'alpha') : ($object->lang ? $object->lang : ''), 'default_lang', 0, 0, 1, 0, 0, 'maxwidth200onsmartphone widthcentpercentminusx');\n\t\tprint '</td>';\n\t\tprint '</tr>';\n\t}\n\n\t// Multicompany\n\tif (!empty($conf->multicompany->enabled) && is_object($mc)) {\n\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\tif (!method_exists($mc, 'formObjectOptions')) {\n\t\t\tif (empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && !$user->entity) {\t// condition must be same for create and edit mode\n\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t\t\t\t print \"<td>\".$mc->select_entities($conf->entity);\n\t\t\t\t print \"</td></tr>\\n\";\n\t\t\t} else {\n\t\t\t\t print '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t}\n\t\t}\n\t}\n\n\t// Other attributes\n\t$parameters = array();\n\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_add.tpl.php';\n\n\t// Note\n\tprint '<tr><td class=\"tdtop\">';\n\tprint $langs->trans(\"Note\");\n\tprint '</td><td>';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor = new DolEditor('note', GETPOSTISSET('note') ? GETPOST('note', 'restricthtml') : '', '', 120, 'dolibarr_notes', '', false, true, getDolGlobalString('FCKEDITOR_ENABLE_SOCIETE'), ROWS_3, '90%');\n\t$doleditor->Create();\n\tprint \"</td></tr>\\n\";\n\n\t// Signature\n\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\tprint '<td class=\"wordbreak\">';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor = new DolEditor('signature', GETPOST('signature', 'restricthtml'), '', 138, 'dolibarr_notes', 'In', true, true, empty($conf->global->FCKEDITOR_ENABLE_USERSIGN) ? 0 : 1, ROWS_4, '90%');\n\tprint $doleditor->Create(1);\n\tprint '</td></tr>';\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t// Default warehouse\n\tif (!empty($conf->stock->enabled) && !empty($conf->global->MAIN_DEFAULT_WAREHOUSE_USER)) {\n\t\tprint '<tr><td>'.$langs->trans(\"DefaultWarehouse\").'</td><td>';\n\t\tprint $formproduct->selectWarehouses($object->fk_warehouse, 'fk_warehouse', 'warehouseopen', 1);\n\t\tprint '</td></tr>';\n\t}\n\n\t// Position/Job\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\tprint '<td>';\n\tprint '<input class=\"maxwidth200 maxwidth150onsmartphone\" type=\"text\" name=\"job\" value=\"'.dol_escape_htmltag(GETPOST('job', 'alphanohtml')).'\">';\n\tprint '</td></tr>';\n\n\tif ((!empty($conf->salaries->enabled) && !empty($user->rights->salaries->read) && in_array($id, $childids))\n\t\t|| (!empty($conf->salaries->enabled) && !empty($user->rights->salaries->readall))\n\t\t|| (!empty($conf->hrm->enabled) && !empty($user->rights->hrm->employee->read))) {\n\t\t$langs->load(\"salaries\");\n\n\t\t// THM\n\t\tprint '<tr><td>';\n\t\t$text = $langs->trans(\"THM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.dol_escape_htmltag(GETPOST('thm')).'\"> '.$langs->getCurrencySymbol($conf->currency);\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// TJM\n\t\tprint '<tr><td>';\n\t\t$text = $langs->trans(\"TJM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.dol_escape_htmltag(GETPOST('tjm')).'\"> '.$langs->getCurrencySymbol($conf->currency);\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// Salary\n\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\tprint '<td>';\n\t\tprint img_picto('', 'salary', 'class=\"pictofixedwidth paddingright\"').'<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.dol_escape_htmltag(GETPOST('salary')).'\"> '.$langs->getCurrencySymbol($conf->currency);\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// Weeklyhours\n\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\tprint '<td>';\n\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.dol_escape_htmltag(GETPOST('weeklyhours')).'\">';\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date employment\n\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\tprint '<td>';\n\tprint $form->selectDate($dateemployment, 'dateemployment', 0, 0, 1, 'formdateemployment', 1, 1);\n\n\tprint ' - ';\n\n\tprint $form->selectDate($dateemploymentend, 'dateemploymentend', 0, 0, 1, 'formdateemploymentend', 1, 0);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date birth\n\tprint '<tr><td>'.$langs->trans(\"DateOfBirth\").'</td>';\n\tprint '<td>';\n\tprint $form->selectDate($dateofbirth, 'dateofbirth', 0, 0, 1, 'createuser', 1, 0);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\tprint \"</table>\\n\";\n\n\tprint dol_get_fiche_end();\n\n\tprint $form->buttonsSaveCancel(\"CreateUser\");\n\n\tprint \"</form>\";\n} else {\n\t// View and edit mode\n\tif ($id > 0) {\n\t\t$res = $object->fetch($id, '', '', 1);\n\t\tif ($res < 0) {\n\t\t\tdol_print_error($db, $object->error);\n\t\t\texit;\n\t\t}\n\t\t$res = $object->fetch_optionals();\n\n\t\t// Check if user has rights\n\t\tif (empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t$object->getrights();\n\t\t\tif (empty($object->nb_rights) && $object->statut != 0 && empty($object->admin)) {\n\t\t\t\tsetEventMessages($langs->trans('UserHasNoPermissions'), null, 'warnings');\n\t\t\t}\n\t\t}\n\n\t\t// Connexion ldap\n\t\t// pour recuperer passDoNotExpire et userChangePassNextLogon\n\t\tif (!empty($conf->ldap->enabled) && !empty($object->ldap_sid)) {\n\t\t\t$ldap = new Ldap();\n\t\t\t$result = $ldap->connect_bind();\n\t\t\tif ($result > 0) {\n\t\t\t\t$userSearchFilter = '('.$conf->global->LDAP_FILTER_CONNECTION.'('.$ldap->getUserIdentifier().'='.$object->login.'))';\n\t\t\t\t$entries = $ldap->fetch($object->login, $userSearchFilter);\n\t\t\t\tif (!$entries) {\n\t\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t\t}\n\n\t\t\t\t$passDoNotExpire = 0;\n\t\t\t\t$userChangePassNextLogon = 0;\n\t\t\t\t$userDisabled = 0;\n\t\t\t\t$statutUACF = '';\n\n\t\t\t\t// Check options of user account\n\t\t\t\tif (count($ldap->uacf) > 0) {\n\t\t\t\t\tforeach ($ldap->uacf as $key => $statut) {\n\t\t\t\t\t\tif ($key == 65536) {\n\t\t\t\t\t\t\t$passDoNotExpire = 1;\n\t\t\t\t\t\t\t$statutUACF = $statut;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$userDisabled = 1;\n\t\t\t\t\t$statutUACF = \"ACCOUNTDISABLE\";\n\t\t\t\t}\n\n\t\t\t\tif ($ldap->pwdlastset == 0) {\n\t\t\t\t\t$userChangePassNextLogon = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Show tabs\n\t\tif ($mode == 'employee') { // For HRM module development\n\t\t\t$title = $langs->trans(\"Employee\");\n\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/hrm/employee/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t} else {\n\t\t\t$title = $langs->trans(\"User\");\n\t\t\t$linkback = '';\n\n\t\t\tif ($user->rights->user->user->lire || $user->admin) {\n\t\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/user/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t\t}\n\t\t}\n\n\t\t$head = user_prepare_head($object);\n\n\t\t/*\n\t\t * Confirmation reinitialisation mot de passe\n\t\t */\n\t\tif ($action == 'password') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"ReinitPassword\"), $langs->trans(\"ConfirmReinitPassword\", $object->login), \"confirm_password\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirmation envoi mot de passe\n\t\t */\n\t\tif ($action == 'passwordsend') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"SendNewPassword\"), $langs->trans(\"ConfirmSendNewPassword\", $object->login), \"confirm_passwordsend\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirm deactivation\n\t\t */\n\t\tif ($action == 'disable') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"DisableAUser\"), $langs->trans(\"ConfirmDisableUser\", $object->login), \"confirm_disable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirm activation\n\t\t */\n\t\tif ($action == 'enable') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"EnableAUser\"), $langs->trans(\"ConfirmEnableUser\", $object->login), \"confirm_enable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Confirmation suppression\n\t\t */\n\t\tif ($action == 'delete') {\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\", $langs->trans(\"DeleteAUser\"), $langs->trans(\"ConfirmDeleteUser\", $object->login), \"confirm_delete\", '', 0, 1);\n\t\t}\n\n\t\t/*\n\t\t * Fiche en mode visu\n\t\t */\n\t\tif ($action != 'edit') {\n\t\t\tprint dol_get_fiche_head($head, 'user', $title, -1, 'user');\n\n\t\t\tdol_banner_tab($object, 'id', $linkback, $user->rights->user->user->lire || $user->admin);\n\n\t\t\tprint '<div class=\"fichecenter\">';\n\t\t\tprint '<div class=\"fichehalfleft\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\t\t\tprint '<table class=\"border tableforfield\" width=\"100%\">';\n\n\t\t\t// Login\n\t\t\tprint '<tr><td class=\"titlefieldmiddle\">'.$langs->trans(\"Login\").'</td>';\n\t\t\tif (!empty($object->ldap_sid) && $object->statut == 0) {\n\t\t\t\tprint '<td class=\"error\">';\n\t\t\t\tprint $langs->trans(\"LoginAccountDisableInDolibarr\");\n\t\t\t\tprint '</td>';\n\t\t\t} else {\n\t\t\t\tprint '<td>';\n\t\t\t\t$addadmin = '';\n\t\t\t\tif (property_exists($object, 'admin')) {\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && !empty($object->admin) && empty($object->entity)) {\n\t\t\t\t\t\t$addadmin .= img_picto($langs->trans(\"SuperAdministratorDesc\"), \"redstar\", 'class=\"paddingleft\"');\n\t\t\t\t\t} elseif (!empty($object->admin)) {\n\t\t\t\t\t\t$addadmin .= img_picto($langs->trans(\"AdministratorDesc\"), \"star\", 'class=\"paddingleft\"');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprint showValueWithClipboardCPButton($object->login).$addadmin;\n\t\t\t\tprint '</td>';\n\t\t\t}\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// Type\n\t\t\tprint '<tr><td>';\n\t\t\t$text = $langs->trans(\"Type\");\n\t\t\tprint $form->textwithpicto($text, $langs->trans(\"InternalExternalDesc\"));\n\t\t\tprint '</td><td>';\n\t\t\t$type = $langs->trans(\"Internal\");\n\t\t\tif ($object->socid > 0) {\n\t\t\t\t$type = $langs->trans(\"External\");\n\t\t\t}\n\t\t\tprint '<span class=\"badgeneutral\">';\n\t\t\tprint $type;\n\t\t\tif ($object->ldap_sid) {\n\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t}\n\t\t\tprint '</span>';\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// Ldap sid\n\t\t\tif ($object->ldap_sid) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Type\").'</td><td>';\n\t\t\t\tprint $langs->trans(\"DomainUser\", $ldap->domainFQDN);\n\t\t\t\tprint '</td></tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Employee\n\t\t\tprint '<tr><td>'.$langs->trans(\"Employee\").'</td><td>';\n\t\t\tprint '<input type=\"checkbox\" disabled name=\"employee\" value=\"1\"'.($object->employee ? ' checked=\"checked\"' : '').'>';\n\t\t\t//print yn($object->employee);\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// TODO This is also available into the tab RH\n\n\t\t\t// Hierarchy\n\t\t\tprint '<tr><td>'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif (empty($object->fk_user)) {\n\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"None\").'</span>';\n\t\t\t} else {\n\t\t\t\t$huser = new User($db);\n\t\t\t\tif ($object->fk_user > 0) {\n\t\t\t\t\t$huser->fetch($object->fk_user);\n\t\t\t\t\tprint $huser->getNomUrl(1);\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"None\").'</span>';\n\t\t\t\t}\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Expense report validator\n\t\t\tif (!empty($conf->expensereport->enabled)) {\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"ForceUserExpenseValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($object->fk_user_expense_validator)) {\n\t\t\t\t\t$evuser = new User($db);\n\t\t\t\t\t$evuser->fetch($object->fk_user_expense_validator);\n\t\t\t\t\tprint $evuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Holiday request validator\n\t\t\tif (!empty($conf->holiday->enabled)) {\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"ForceUserHolidayValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($object->fk_user_holiday_validator)) {\n\t\t\t\t\t$hvuser = new User($db);\n\t\t\t\t\t$hvuser->fetch($object->fk_user_holiday_validator);\n\t\t\t\t\tprint $hvuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td>'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>'.dol_escape_htmltag($object->job).'</td>';\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint price2num($object->weeklyhours);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Sensitive salary/value information\n\t\t\tif ((empty($user->socid) && in_array($id, $childids))\t// A user can always see salary/value information for its subordinates\n\t\t\t\t|| (!empty($conf->salaries->enabled) && !empty($user->rights->salaries->readall))\n\t\t\t\t|| (!empty($conf->hrm->enabled) && !empty($user->rights->hrm->employee->read))) {\n\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->salary != '' ? img_picto('', 'salary', 'class=\"pictofixedwidth paddingright\"').'<span class=\"amount\">'.price($object->salary, '', $langs, 1, -1, -1, $conf->currency) : '').'</span>';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->thm != '' ?price($object->thm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->tjm != '' ?price($object->tjm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateOfEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->dateemployment) {\n\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"FromDate\").'</span> ';\n\t\t\t\tprint dol_print_date($object->dateemployment, 'day');\n\t\t\t}\n\t\t\tif ($object->dateemploymentend) {\n\t\t\t\tprint '<span class=\"opacitymedium\"> - '.$langs->trans(\"To\").'</span> ';\n\t\t\t\tprint dol_print_date($object->dateemploymentend, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Default warehouse\n\t\t\tif (!empty($conf->stock->enabled) && !empty($conf->global->MAIN_DEFAULT_WAREHOUSE_USER)) {\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/product/stock/class/entrepot.class.php';\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"DefaultWarehouse\").'</td><td>';\n\t\t\t\tif ($object->fk_warehouse > 0) {\n\t\t\t\t\t$warehousestatic = new Entrepot($db);\n\t\t\t\t\t$warehousestatic->fetch($object->fk_warehouse);\n\t\t\t\t\tprint $warehousestatic->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Accountancy code\n\t\t\tif (!empty($conf->accounting->enabled)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>'.$object->accountancy_code.'</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table>';\n\n\t\t\tprint '</div>';\n\t\t\tprint '<div class=\"fichehalfright\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\n\t\t\tprint '<table class=\"border tableforfield centpercent\">';\n\n\t\t\t// Color user\n\t\t\tif (!empty($conf->agenda->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $formother->showColor($object->color, '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Categories\n\t\t\tif (!empty($conf->categorie->enabled) && !empty($user->rights->categorie->lire)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Categories\").'</td>';\n\t\t\t\tprint '<td colspan=\"3\">';\n\t\t\t\tprint $form->showCategories($object->id, Categorie::TYPE_USER, 1);\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Default language\n\t\t\tif (!empty($conf->global->MAIN_MULTILANGS)) {\n\t\t\t\t$langs->load(\"languages\");\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';\n\t\t\t\tprint '<tr><td class=\"titlefield\">';\n\t\t\t\tprint $form->textwithpicto($langs->trans(\"DefaultLang\"), $langs->trans(\"WarningNotLangOfInterface\", $langs->transnoentitiesnoconv(\"UserGUISetup\")));\n\t\t\t\tprint '</td><td>';\n\t\t\t\t//$s=picto_from_langcode($object->default_lang);\n\t\t\t\t//print ($s?$s.' ':'');\n\t\t\t\t$labellang = ($object->lang ? $langs->trans('Language_'.$object->lang) : '');\n\t\t\t\tprint $labellang;\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/', $conf->file->main_authentication) && !empty($conf->global->MAIN_OPENIDURL_PERUSER)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>'.$object->openid.'</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Multicompany\n\t\t\tif (!empty($conf->multicompany->enabled) && is_object($mc)) {\n\t\t\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\t\t\tif (!method_exists($mc, 'formObjectOptions')) {\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && !$user->entity) {\n\t\t\t\t\t\tprint '<tr><td>'.$langs->trans(\"Entity\").'</td><td>';\n\t\t\t\t\t\tif (empty($object->entity)) {\n\t\t\t\t\t\t\tprint $langs->trans(\"AllEntities\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$mc->getInfo($object->entity);\n\t\t\t\t\t\t\tprint $mc->label;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_view.tpl.php';\n\n\t\t\t// Company / Contact\n\t\t\tif (!empty($conf->societe->enabled)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\t$s = '';\n\t\t\t\tif (isset($object->socid) && $object->socid > 0) {\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tif ($societe->id > 0) {\n\t\t\t\t\t\t$s .= $societe->getNomUrl(1, '');\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$s .= '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"ThisUserIsNot\").'</span>';\n\t\t\t\t}\n\t\t\t\tif (!empty($object->contact_id)) {\n\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t$contact->fetch($object->contact_id);\n\t\t\t\t\tif ($contact->id > 0) {\n\t\t\t\t\t\tif ($object->socid > 0 && $s) {\n\t\t\t\t\t\t\t$s .= ' / ';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$s .= '<br>';\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$s .= $contact->getNomUrl(1, '');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprint $s;\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (!empty($conf->adherent->enabled)) {\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member) {\n\t\t\t\t\t$adh = new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref = $adh->getFullname($langs); // Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(-1);\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"UserNotLinkedToMember\").'</span>';\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans('Signature').'</td><td class=\"wordbreak\">';\n\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\t// VCard\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"VCard\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint '<a href=\"'.DOL_URL_ROOT.'/user/vcard.php?id='.$object->id.'\">';\n\t\t\tprint img_picto($langs->trans(\"Download\"), 'vcard.png', 'class=\"paddingrightonly\"');\n\t\t\tprint $langs->trans(\"Download\");\n\t\t\tprint '</a>';\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\tprint \"</table>\\n\";\n\n\t\t\t// Credentials\n\t\t\tprint '<div class=\"div-table-responsive-no-min\">';\n\t\t\tprint '<table class=\"border tableforfield margintable centpercent\">';\n\t\t\tprint '<tr class=\"liste_titre\"><td class=\"liste_titre\">';\n\t\t\tprint img_picto('', 'security', 'class=\"paddingleft pictofixedwidth\"').$langs->trans(\"Credentials\");\n\t\t\tprint '</td>';\n\t\t\tprint '<td class=\"liste_titre\"></td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Date login validity\n\t\t\tprint '<tr><td>'.$langs->trans(\"RangeOfLoginValidity\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->datestartvalidity) {\n\t\t\t\tprint '<span class=\"opacitymedium\">'.$langs->trans(\"FromDate\").'</span> ';\n\t\t\t\tprint dol_print_date($object->datestartvalidity, 'day');\n\t\t\t}\n\t\t\tif ($object->dateendvalidity) {\n\t\t\t\tprint '<span class=\"opacitymedium\"> - '.$langs->trans(\"To\").'</span> ';\n\t\t\t\tprint dol_print_date($object->dateendvalidity, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Password\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Password\").'</td>';\n\n\t\t\tprint '<td class=\"wordbreak\">';\n\t\t\t$valuetoshow = '';\n\t\t\tif (preg_match('/ldap/', $dolibarr_main_authentication)) {\n\t\t\t\tif (!empty($object->ldap_sid)) {\n\t\t\t\t\tif ($passDoNotExpire) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"LdapUacf_\".$statutUACF);\n\t\t\t\t\t} elseif ($userChangePassNextLogon) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<span class=\"warning\">'.$langs->trans(\"UserMustChangePassNextLogon\", $ldap->domainFQDN).'</span>';\n\t\t\t\t\t} elseif ($userDisabled) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<span class=\"warning\">'.$langs->trans(\"LdapUacf_\".$statutUACF, $ldap->domainFQDN).'</span>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (preg_match('/http/', $dolibarr_main_authentication)) {\n\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"HTTPBasicPassword\");\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/', $dolibarr_main_authentication)) {\n\t\t\t\tif ($object->pass) {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '');\n\t\t\t\t\t$valuetoshow .= '<span class=\"opacitymedium\">'.$langs->trans(\"Hidden\").'</span>';\n\t\t\t\t} else {\n\t\t\t\t\tif ($user->admin && $user->id == $object->id) {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '');\n\t\t\t\t\t\t//$valuetoshow .= '<span class=\"opacitymedium\">'.$langs->trans(\"Crypted\").' - </span>';\n\t\t\t\t\t\t$valuetoshow .= '<span class=\"opacitymedium\">'.$langs->trans(\"Hidden\").'</span>';\n\t\t\t\t\t\t// TODO Add a feature to reveal the hash\n\t\t\t\t\t\t$valuetoshow .= '<!-- Crypted into '.$object->pass_indatabase_crypted.' -->';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<span class=\"opacitymedium\">'.$langs->trans(\"Hidden\").'</span>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters = array('valuetoshow' => $valuetoshow);\n\t\t\t$reshook = $hookmanager->executeHooks('printUserPasswordField', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) {\n\t\t\t\t$valuetoshow = $hookmanager->resPrint; // to replace\n\t\t\t} else {\n\t\t\t\t$valuetoshow .= $hookmanager->resPrint; // to add\n\t\t\t}\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td>\";\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// API key\n\t\t\tif (!empty($conf->api->enabled) && ($user->id == $id || $user->admin || $user->rights->api->apikey->generate)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (!empty($object->api_key)) {\n\t\t\t\t\tprint '<span class=\"opacitymedium\">';\n\t\t\t\t\tprint showValueWithClipboardCPButton($object->api_key, 1, $langs->trans(\"Hidden\"));\t\t// TODO Add an option to also reveal the hash, not only copy paste\n\t\t\t\t\tprint '</span>';\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"LastConnexion\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->datepreviouslogin) {\n\t\t\t\tprint dol_print_date($object->datepreviouslogin, \"dayhour\").' <span class=\"opacitymedium\">('.$langs->trans(\"Previous\").')</span>, ';\n\t\t\t}\n\t\t\tif ($object->datelastlogin) {\n\t\t\t\tprint dol_print_date($object->datelastlogin, \"dayhour\").' <span class=\"opacitymedium\">('.$langs->trans(\"Currently\").')</span>';\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '</table></div>';\n\n\t\t\tprint '</div>';\n\n\t\t\tprint '</div>';\n\t\t\tprint '<div style=\"clear:both\"></div>';\n\n\n\t\t\tprint dol_get_fiche_end();\n\n\n\t\t\t/*\n\t\t\t * Buttons actions\n\t\t\t */\n\n\t\t\tprint '<div class=\"tabsAction\">';\n\n\t\t\t$parameters = array();\n\t\t\t$reshook = $hookmanager->executeHooks('addMoreActionsButtons', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tif (empty($reshook)) {\n\t\t\t\tif (empty($user->socid)) {\n\t\t\t\t\tif (!empty($object->email)) {\n\t\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=presend&mode=init#formmailbeforetitle\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ($caneditfield && (empty($conf->multicompany->enabled) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tif (!empty($conf->global->MAIN_ONLY_LOGIN_ALLOWED)) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"DisabledInMonoUserMode\")).'\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=edit&token='.newToken().'\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t} elseif ($caneditpassword && !$object->ldap_sid &&\n\t\t\t\t(empty($conf->multicompany->enabled) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=edit&token='.newToken().'\">'.$langs->trans(\"EditPassword\").'</a></div>';\n\t\t\t\t}\n\n\t\t\t\t// Si on a un gestionnaire de generation de mot de passe actif\n\t\t\t\tif ($conf->global->USER_PASSWORD_GENERATED != 'none') {\n\t\t\t\t\tif ($object->statut == 0) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t} elseif ($caneditpassword && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=password&token='.newToken().'\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($object->statut == 0) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t} elseif ($caneditpassword && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\t\tif ($object->email) {\n\t\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=passwordsend&token='.newToken().'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Enable user\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 0 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=enable&token='.newToken().'\">'.$langs->trans(\"Reactivate\").'</a></div>';\n\t\t\t\t}\n\t\t\t\t// Disable user\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 1 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=disable&token='.newToken().'\">'.$langs->trans(\"DisableUser\").'</a></div>';\n\t\t\t\t} else {\n\t\t\t\t\tif ($user->id == $id) {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.$langs->trans(\"CantDisableYourself\").'\">'.$langs->trans(\"DisableUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Delete\n\t\t\t\tif ($user->id <> $id && $candisableuser &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || !$user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1))) {\n\t\t\t\t\tif ($user->admin || !$object->admin) { // If user edited is admin, delete is possible on for an admin\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?action=delete&token='.newToken().'&id='.$object->id.'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused classfortooltip\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"MustBeAdminToDeleteOtherAdmin\")).'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tprint \"</div>\\n\";\n\n\n\n\t\t\t//Select mail models is same action as presend\n\t\t\tif (GETPOST('modelselected')) {\n\t\t\t\t$action = 'presend';\n\t\t\t}\n\n\t\t\t// Presend form\n\t\t\t$modelmail = 'user';\n\t\t\t$defaulttopic = 'Information';\n\t\t\t$diroutput = $conf->user->dir_output;\n\t\t\t$trackid = 'use'.$object->id;\n\n\t\t\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/card_presend.tpl.php';\n\n\t\t\tif ($action != 'presend' && $action != 'send') {\n\t\t\t\t/*\n\t\t\t\t * List of groups of user\n\t\t\t\t */\n\n\t\t\t\tif ($canreadgroup) {\n\t\t\t\t\tprint '<!-- Group section -->'.\"\\n\";\n\n\t\t\t\t\tprint load_fiche_titre($langs->trans(\"ListOfGroupsForUser\"), '', '');\n\n\t\t\t\t\t// On selectionne les groupes auquel fait parti le user\n\t\t\t\t\t$exclude = array();\n\n\t\t\t\t\t$usergroup = new UserGroup($db);\n\t\t\t\t\t$groupslist = $usergroup->listGroupsForUser($object->id, false);\n\n\t\t\t\t\tif (!empty($groupslist)) {\n\t\t\t\t\t\tforeach ($groupslist as $groupforuser) {\n\t\t\t\t\t\t\t$exclude[] = $groupforuser->id;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Other form for add user to group\n\t\t\t\t\t$parameters = array('caneditgroup' => $caneditgroup, 'groupslist' => $groupslist, 'exclude' => $exclude);\n\t\t\t\t\t$reshook = $hookmanager->executeHooks('formAddUserToGroup', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\t\t\tprint $hookmanager->resPrint;\n\n\t\t\t\t\tif (empty($reshook)) {\n\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$id.'\" method=\"POST\">'.\"\\n\";\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\" />';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"addgroup\" />';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"page_y\" value=\"\" />';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tprint '<table class=\"noborder centpercent\">'.\"\\n\";\n\t\t\t\t\t\tprint '<tr class=\"liste_titre\"><th class=\"liste_titre\">'.$langs->trans(\"Groups\").'</th>'.\"\\n\";\n\t\t\t\t\t\tprint '<th class=\"liste_titre right\">';\n\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\tprint $form->select_dolgroups('', 'group', 1, $exclude, 0, '', '', $object->entity);\n\t\t\t\t\t\t\tprint ' &nbsp; ';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t\t\t\t\tprint '<input type=\"submit\" class=\"button buttongen button-add reposition\" value=\"'.$langs->trans(\"Add\").'\" />';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint '</th></tr>'.\"\\n\";\n\n\t\t\t\t\t\t// List of groups of user\n\t\t\t\t\t\tif (!empty($groupslist)) {\n\t\t\t\t\t\t\tforeach ($groupslist as $group) {\n\t\t\t\t\t\t\t\tprint '<tr class=\"oddeven\">';\n\t\t\t\t\t\t\t\tprint '<td>';\n\t\t\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\t\t\tprint $group->getNomUrl(1);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tprint img_object($langs->trans(\"ShowGroup\"), \"group\").' '.$group->name;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint '</td>';\n\t\t\t\t\t\t\t\tprint '<td class=\"right\">';\n\t\t\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\t\t\tprint '<a class=\"reposition\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&action=removegroup&token='.newToken().'&group='.((int) $group->id).'\">';\n\t\t\t\t\t\t\t\t\tprint img_picto($langs->trans(\"RemoveFromGroup\"), 'unlink');\n\t\t\t\t\t\t\t\t\tprint '</a>';\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tprint \"&nbsp;\";\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprint '<tr class=\"oddeven\"><td colspan=\"3\" class=\"opacitymedium\">'.$langs->trans(\"None\").'</td></tr>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tprint \"</table>\";\n\n\t\t\t\t\t\tif ($caneditgroup) {\n\t\t\t\t\t\t\tprint '</form>';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint \"<br>\";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t/*\n\t\t * Card in edit mode\n\t\t */\n\t\tif ($action == 'edit' && ($canedituser || $caneditfield || $caneditpassword || ($user->id == $object->id))) {\n\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'\" method=\"POST\" name=\"updateuser\" enctype=\"multipart/form-data\">';\n\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.newToken().'\">';\n\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"update\">';\n\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$object->entity.'\">';\n\n\t\t\tprint dol_get_fiche_head($head, 'user', $title, 0, 'user');\n\n\t\t\tprint '<table class=\"border centpercent\">';\n\n\t\t\t// Ref/ID\n\t\t\tif (!empty($conf->global->MAIN_SHOW_TECHNICAL_ID)) {\n\t\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"Ref\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $object->id;\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>';\n\t\t\t}\n\n\t\t\t// Civility\n\t\t\tprint '<tr><td class=\"titlefieldcreate\"><label for=\"civility_code\">'.$langs->trans(\"UserTitle\").'</label></td><td colspan=\"3\">';\n\t\t\tif ($caneditfield && !$object->ldap_sid) {\n\t\t\t\tprint $formcompany->select_civility(GETPOSTISSET(\"civility_code\") ? GETPOST(\"civility_code\", 'aZ09') : $object->civility_code, 'civility_code');\n\t\t\t} elseif ($object->civility_code) {\n\t\t\t\tprint $langs->trans(\"Civility\".$object->civility_code);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Lastname\n\t\t\tprint \"<tr>\";\n\t\t\tprint '<td class=\"titlefieldcreate fieldrequired\">'.$langs->trans(\"Lastname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid) {\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t\tprint $object->lastname;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Firstname\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Firstname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid) {\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t\tprint $object->firstname;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Login\n\t\t\tprint \"<tr>\".'<td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\t\t\tprint '<td>';\n\t\t\tif ($user->admin && !$object->ldap_sid) {\n\t\t\t\tprint '<input maxlength=\"50\" type=\"text\" class=\"flat\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t\tprint $object->login;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Administrator\n\t\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\t\tif ($object->socid > 0) {\n\t\t\t\t$langs->load(\"admin\");\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">'.yn($object->admin);\n\t\t\t\tprint ' ('.$langs->trans(\"ExternalUser\").')';\n\t\t\t\tprint '</td></tr>';\n\t\t\t} else {\n\t\t\t\tprint '<td>';\n\t\t\t\t$nbAdmin = $user->getNbOfUsers('active', '', 1);\n\t\t\t\t$nbSuperAdmin = $user->getNbOfUsers('active', 'superadmin', 1);\n\t\t\t\t//var_dump($nbAdmin);\n\t\t\t\t//var_dump($nbSuperAdmin);\n\t\t\t\tif ($user->admin\t\t\t\t\t\t\t\t// Need to be admin to allow downgrade of an admin\n\t\t\t\t&& ($user->id != $object->id)                   // Don't downgrade ourself\n\t\t\t\t&& (\n\t\t\t\t\t(empty($conf->multicompany->enabled) && $nbAdmin >= 1)\n\t\t\t\t\t|| (!empty($conf->multicompany->enabled) && (($object->entity > 0 || ($user->entity == 0 && $object->entity == 0)) || $nbSuperAdmin > 1))    // Don't downgrade a superadmin if alone\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tprint $form->selectyesno('admin', $object->admin, 1);\n\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && !$user->entity) {\n\t\t\t\t\t\tif ($conf->use_javascript_ajax) {\n\t\t\t\t\t\t\tprint '<script type=\"text/javascript\">\n\t\t\t\t\t\t\t\t\t$(function() {\n\t\t\t\t\t\t\t\t\t\tvar admin = $(\"select[name=admin]\").val();\n\t\t\t\t\t\t\t\t\t\tif (admin == 0) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tif ($(\"input[name=superadmin]\").is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$(\"select[name=admin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\t if ( $(this).val() == 0 ) {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t } else {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t }\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\tif ( $(this).is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t</script>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$checked = (($object->admin && !$object->entity) ? ' checked' : '');\n\t\t\t\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" id=\"superadmin\" value=\"1\"'.$checked.' /> <label for=\"superadmin\">'.$langs->trans(\"SuperAdministrator\").'</span>';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t$yn = yn($object->admin);\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">';\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"superadmin\" value=\"'.(empty($object->entity) ? 1 : 0).'\">';\n\t\t\t\t\tif (!empty($conf->multicompany->enabled) && empty($object->entity)) {\n\t\t\t\t\t\tprint $form->textwithpicto($yn, $langs->trans(\"DontDowngradeSuperAdmin\"), 1, 'warning');\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint $yn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Gender\n\t\t\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\t\t\tprint '<td>';\n\t\t\t$arraygender = array('man'=>$langs->trans(\"Genderman\"), 'woman'=>$langs->trans(\"Genderwoman\"), 'other'=>$langs->trans(\"Genderother\"));\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectarray('gender', $arraygender, GETPOSTISSET('gender') ?GETPOST('gender') : $object->gender, 1);\n\t\t\t} else {\n\t\t\t\tprint $arraygender[$object->gender];\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Employee\n\t\t\tprint '<tr>';\n\t\t\tprint '<td>'.$form->editfieldkey('Employee', 'employee', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<input type=\"checkbox\" name=\"employee\" value=\"1\"'.($object->employee ? ' checked=\"checked\"' : '').'>';\n\t\t\t\t//print $form->selectyesno(\"employee\", $object->employee, 1);\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"checkbox\" name=\"employee\" disabled value=\"1\"'.($object->employee ? ' checked=\"checked\"' : '').'>';\n\t\t\t\t/*if ($object->employee) {\n\t\t\t\t\tprint $langs->trans(\"Yes\");\n\t\t\t\t} else {\n\t\t\t\t\tprint $langs->trans(\"No\");\n\t\t\t\t}*/\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Hierarchy\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint img_picto('', 'user').$form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'widthcentpercentminusx maxwidth300');\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"fk_user\" value=\"'.$object->fk_user.'\">';\n\t\t\t\t$huser = new User($db);\n\t\t\t\t$huser->fetch($object->fk_user);\n\t\t\t\tprint $huser->getNomUrl(1);\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Expense report validator\n\t\t\tif (!empty($conf->expensereport->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">';\n\t\t\t\t$text = $langs->trans(\"ForceUserExpenseValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint img_picto('', 'user').$form->select_dolusers($object->fk_user_expense_validator, 'fk_user_expense_validator', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'widthcentpercentminusx maxwidth300');\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"fk_user_expense_validator\" value=\"'.$object->fk_user_expense_validator.'\">';\n\t\t\t\t\t$evuser = new User($db);\n\t\t\t\t\t$evuser->fetch($object->fk_user_expense_validator);\n\t\t\t\t\tprint $evuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Holiday request validator\n\t\t\tif (!empty($conf->holiday->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">';\n\t\t\t\t$text = $langs->trans(\"ForceUserHolidayValidator\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"ValidatorIsSupervisorByDefault\"), 1, 'help');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint img_picto('', 'user').$form->select_dolusers($object->fk_user_holiday_validator, 'fk_user_holiday_validator', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'widthcentpercentminusx maxwidth300');\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"fk_user_holiday_validator\" value=\"'.$object->fk_user_holiday_validator.'\">';\n\t\t\t\t\t$hvuser = new User($db);\n\t\t\t\t\t$hvuser->fetch($object->fk_user_holiday_validator);\n\t\t\t\t\tprint $hvuser->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// External user ?\n\t\t\tprint '<tr><td>'.$langs->trans(\"ExternalUser\").' ?</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($user->id == $object->id || !$user->admin) {\n\t\t\t\t// Read mode\n\t\t\t\t$type = $langs->trans(\"Internal\");\n\t\t\t\tif ($object->socid) {\n\t\t\t\t\t$type = $langs->trans(\"External\");\n\t\t\t\t}\n\t\t\t\tprint $form->textwithpicto($type, $langs->trans(\"InternalExternalDesc\"));\n\t\t\t\tif ($object->ldap_sid) {\n\t\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Select mode\n\t\t\t\t$type = 0;\n\t\t\t\tif ($object->contact_id) {\n\t\t\t\t\t$type = $object->contact_id;\n\t\t\t\t}\n\n\t\t\t\tif ($object->socid > 0 && !($object->contact_id > 0)) {\t// external user but no link to a contact\n\t\t\t\t\tprint img_picto('', 'company').$form->select_company($object->socid, 'socid', '', '&nbsp;');\n\t\t\t\t\tprint img_picto('', 'contact').$form->selectcontacts(0, 0, 'contactid', 1, '', '', 1, '', false, 1);\n\t\t\t\t\tif ($object->ldap_sid) {\n\t\t\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t\t\t}\n\t\t\t\t} elseif ($object->socid > 0 && $object->contact_id > 0) {\t// external user with a link to a contact\n\t\t\t\t\tprint img_picto('', 'company').$form->select_company(0, 'socid', '', '&nbsp;'); // We keep thirdparty empty, contact is already set\n\t\t\t\t\tprint img_picto('', 'contact').$form->selectcontacts(0, $object->contact_id, 'contactid', 1, '', '', 1, '', false, 1);\n\t\t\t\t\tif ($object->ldap_sid) {\n\t\t\t\t\t\tprint ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t\t\t}\n\t\t\t\t} else {\t// $object->socid is not > 0 here\n\t\t\t\t\tprint img_picto('', 'company').$form->select_company(0, 'socid', '', '&nbsp;'); // We keep thirdparty empty, contact is already set\n\t\t\t\t\tprint img_picto('', 'contact').$form->selectcontacts(0, 0, 'contactid', 1, '', '', 1, '', false, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// Date access validity\n\t\t\tprint '<tr><td>'.$langs->trans(\"RangeOfLoginValidity\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($datestartvalidity ? $datestartvalidity : $object->datestartvalidity, 'datestartvalidity', 0, 0, 1, 'formdatestartvalidity', 1, 1, 0, '', '', '', '', 1, '', '');\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->datestartvalidity, 'day');\n\t\t\t}\n\n\t\t\t/*if ($datestartvalidity && $dateendvalidity) {\n\t\t\t\tprint ' - ';\n\t\t\t}*/\n\t\t\tprint ' &nbsp; ';\n\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($dateendvalidity ? $datendevalidity : $object->dateendvalidity, 'dateendvalidity', 0, 0, 1, 'formdateendvalidity', 1, 0, 0, '', '', '', '', 1, '', '');\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->dateendvalidity, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Pass\n\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"Password\").'</td>';\n\t\t\tprint '<td>';\n\t\t\t$valuetoshow = '';\n\t\t\tif (preg_match('/ldap/', $dolibarr_main_authentication)) {\n\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t}\n\t\t\tif (preg_match('/http/', $dolibarr_main_authentication)) {\n\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').$form->textwithpicto($text, $langs->trans(\"DolibarrInHttpAuthenticationSoPasswordUseless\", $dolibarr_main_authentication), 1, 'warning');\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/', $dolibarr_main_authentication)) {\n\t\t\t\tif ($caneditpassword) {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').'<input maxlength=\"128\" type=\"password\" class=\"flat\" name=\"password\" value=\"'.$object->pass.'\" autocomplete=\"new-password\">';\n\t\t\t\t} else {\n\t\t\t\t\t$valuetoshow .= ($valuetoshow ? (' '.$langs->trans(\"or\").' ') : '').preg_replace('/./i', '*', $object->pass);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters = array('valuetoshow' => $valuetoshow, 'caneditpassword' => $caneditpassword);\n\t\t\t$reshook = $hookmanager->executeHooks('printUserPasswordField', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) {\n\t\t\t\t$valuetoshow = $hookmanager->resPrint; // to replace\n\t\t\t} else {\n\t\t\t\t$valuetoshow .= $hookmanager->resPrint; // to add\n\t\t\t}\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\t// API key\n\t\t\tif (!empty($conf->api->enabled) && ($user->id == $id || $user->admin || $user->rights->api->apikey->generate)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input class=\"minwidth300\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.$object->api_key.'\" autocomplete=\"off\">';\n\t\t\t\tif (!empty($conf->use_javascript_ajax)) {\n\t\t\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// OpenID url\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/', $conf->file->main_authentication) && !empty($conf->global->MAIN_OPENIDURL_PERUSER)) {\n\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input class=\"minwidth100\" type=\"url\" name=\"openid\" class=\"flat\" value=\"'.$object->openid.'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"openid\" value=\"'.$object->openid.'\">';\n\t\t\t\t\tprint $object->openid;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// Address\n\t\t\tprint '<tr><td class=\"tdtop titlefieldcreate\">'.$form->editfieldkey('Address', 'address', '', $object, 0).'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\t\t\t}\n\t\t\tprint $object->address;\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '</textarea>';\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Zip\n\t\t\tprint '<tr><td>'.$form->editfieldkey('Zip', 'zipcode', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $formcompany->select_ziptown($object->zip, 'zipcode', array('town', 'selectcountry_id', 'state_id'), 6);\n\t\t\t} else {\n\t\t\t\tprint $object->zip;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Town\n\t\t\tprint '<tr><td>'.$form->editfieldkey('Town', 'town', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $formcompany->select_ziptown($object->town, 'town', array('zipcode', 'selectcountry_id', 'state_id'));\n\t\t\t} else {\n\t\t\t\tprint $object->town;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Country\n\t\t\tprint '<tr><td>'.$form->editfieldkey('Country', 'selectcounty_id', '', $object, 0).'</td><td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->select_country((GETPOST('country_id') != '' ?GETPOST('country_id') : $object->country_id), 'country_id');\n\t\t\t\tif ($user->admin) {\n\t\t\t\t\tprint info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"), 1);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$countrylabel = getCountry($object->country_id, '0');\n\t\t\t\tprint $countrylabel;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// State\n\t\t\tif (empty($conf->global->USER_DISABLE_STATE)) {\n\t\t\t\tprint '<tr><td class=\"tdoverflow\">'.$form->editfieldkey('State', 'state_id', '', $object, 0).'</td><td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint img_picto('', 'state', 'class=\"pictofixedwidth\"');\n\t\t\t\t\tprint $formcompany->select_state($object->state_id, $object->country_code, 'state_id');\n\t\t\t\t} else {\n\t\t\t\t\tprint $object->state_label;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Tel pro\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhonePro\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'phoning', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input type=\"text\" name=\"office_phone\" class=\"flat maxwidth200\" value=\"'.$object->office_phone.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.$object->office_phone.'\">';\n\t\t\t\tprint $object->office_phone;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Tel mobile\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'phoning_mobile', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input type=\"text\" name=\"user_mobile\" class=\"flat maxwidth200\" value=\"'.$object->user_mobile.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.$object->user_mobile.'\">';\n\t\t\t\tprint $object->user_mobile;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Fax\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Fax\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'phoning_fax', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input type=\"text\" name=\"office_fax\" class=\"flat maxwidth200\" value=\"'.$object->office_fax.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.$object->office_fax.'\">';\n\t\t\t\tprint $object->office_fax;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// EMail\n\t\t\tprint \"<tr>\".'<td'.(!empty($conf->global->USER_MAIL_REQUIRED) ? ' class=\"fieldrequired\"' : '').'>'.$langs->trans(\"EMail\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint img_picto('', 'object_email', 'class=\"pictofixedwidth\"');\n\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\tprint '<input class=\"minwidth100 maxwidth500 widthcentpercentminusx\" type=\"text\" name=\"email\" class=\"flat\" value=\"'.$object->email.'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.$object->email.'\">';\n\t\t\t\tprint $object->email;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\tif (!empty($conf->socialnetworks->enabled)) {\n\t\t\t\tforeach ($socialnetworks as $key => $value) {\n\t\t\t\t\tif ($value['active']) {\n\t\t\t\t\t\tprint '<tr><td>'.$langs->trans($value['label']).'</td>';\n\t\t\t\t\t\tprint '<td>';\n\t\t\t\t\t\tif (!empty($value['icon'])) {\n\t\t\t\t\t\t\tprint '<span class=\"fa '.$value['icon'].' pictofixedwidth\"></span>';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ($caneditfield && empty($object->ldap_sid)) {\n\t\t\t\t\t\t\tprint '<input type=\"text\" name=\"'.$key.'\" class=\"flat maxwidth200\" value=\"'.$object->socialnetworks[$key].'\">';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$object->socialnetworks[$key].'\">';\n\t\t\t\t\t\t\tprint $object->socialnetworks[$key];\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint '</td></tr>';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// if social network is not active but value exist we do not want to loose it\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"'.$key.'\" value=\"'.$object->socialnetworks[$key].'\">';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\t\t\t// Default warehouse\n\t\t\tif (!empty($conf->stock->enabled) && !empty($conf->global->MAIN_DEFAULT_WAREHOUSE_USER)) {\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"DefaultWarehouse\").'</td><td>';\n\t\t\t\tprint $formproduct->selectWarehouses($object->fk_warehouse, 'fk_warehouse', 'warehouseopen', 1);\n\t\t\t\tprint ' <a href=\"'.DOL_URL_ROOT.'/product/stock/card.php?action=create&token='.newToken().'&backtopage='.urlencode($_SERVER['PHP_SELF'].'?id='.$object->id.'&action=edit&token='.newToken()).'\"><span class=\"fa fa-plus-circle valignmiddle paddingleft\" title=\"'.$langs->trans(\"AddWarehouse\").'\"></span></a>';\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Accountancy code\n\t\t\tif (!empty($conf->accounting->enabled)) {\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint '<td class=\"titlefieldcreate\">'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input type=\"text\" class=\"flat maxwidth300\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t\tprint $object->accountancy_code;\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\";\n\t\t\t}\n\n\t\t\t// User color\n\t\t\tif (!empty($conf->agenda->enabled)) {\n\t\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint $formother->selectColor(GETPOSTISSET('color') ?GETPOST('color', 'alphanohtml') : $object->color, 'color', null, 1, '', 'hideifnotset');\n\t\t\t\t} else {\n\t\t\t\t\tprint $formother->showColor($object->color, '');\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Photo\n\t\t\tprint '<tr>';\n\t\t\tprint '<td class=\"titlefieldcreate\">'.$langs->trans(\"Photo\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $form->showphoto('userphoto', $object, 60, 0, $caneditfield, 'photowithmargin', 'small', 1, 0, 'user', 1);\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Categories\n\t\t\tif (!empty($conf->categorie->enabled) && !empty($user->rights->categorie->lire)) {\n\t\t\t\tprint '<tr><td>'.$form->editfieldkey('Categories', 'usercats', '', $object, 0).'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint img_picto('', 'category', 'class=\"pictofixedwidth\"');\n\t\t\t\t$cate_arbo = $form->select_all_categories(Categorie::TYPE_USER, null, null, null, null, 1);\n\t\t\t\t$c = new Categorie($db);\n\t\t\t\t$cats = $c->containing($object->id, Categorie::TYPE_USER);\n\t\t\t\tforeach ($cats as $cat) {\n\t\t\t\t\t$arrayselected[] = $cat->id;\n\t\t\t\t}\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint $form->multiselectarray('usercats', $cate_arbo, $arrayselected, '', 0, '', 0, '90%');\n\t\t\t\t} else {\n\t\t\t\t\tprint $form->showCategories($object->id, Categorie::TYPE_USER, 1);\n\t\t\t\t}\n\t\t\t\tprint \"</td></tr>\";\n\t\t\t}\n\n\t\t\t// Default language\n\t\t\tif (!empty($conf->global->MAIN_MULTILANGS)) {\n\t\t\t\tprint '<tr><td>'.$form->editfieldkey('DefaultLang', 'default_lang', '', $object, 0, 'string', '', 0, 0, 'id', $langs->trans(\"WarningNotLangOfInterface\", $langs->transnoentitiesnoconv(\"UserGUISetup\"))).'</td><td colspan=\"3\">'.\"\\n\";\n\t\t\t\tprint img_picto('', 'language', 'class=\"pictofixedwidth\"').$formadmin->select_language($object->lang, 'default_lang', 0, null, '1', 0, 0, 'widthcentpercentminusx maxwidth300');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>';\n\t\t\t}\n\n\t\t\t// Status\n\t\t\tprint '<tr><td>'.$langs->trans(\"Status\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $object->getLibStatut(4);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Company / Contact\n\t\t\tif (!empty($conf->societe->enabled)) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->socid > 0) {\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tprint $societe->getNomUrl(1, '');\n\t\t\t\t\tif ($object->contact_id) {\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($object->contact_id);\n\t\t\t\t\t\tprint ' / <a href=\"'.DOL_URL_ROOT.'/contact/card.php?id='.$object->contact_id.'\">'.img_object($langs->trans(\"ShowContact\"), 'contact').' '.dol_trunc($contact->getFullName($langs), 32).'</a>';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"ThisUserIsNot\").'</span>';\n\t\t\t\t}\n\t\t\t\tprint ' <span class=\"opacitymedium hideonsmartphone\">('.$langs->trans(\"UseTypeFieldToChange\").')</span>';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (!empty($conf->adherent->enabled)) {\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member) {\n\t\t\t\t\t$adh = new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref = $adh->login; // Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(1);\n\t\t\t\t} else {\n\t\t\t\t\tprint '<span class=\"opacitymedium hideonsmartphone\">'.$langs->trans(\"UserNotLinkedToMember\").'</span>';\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Multicompany\n\t\t\t// TODO check if user not linked with the current entity before change entity (thirdparty, invoice, etc.) !!\n\t\t\tif (!empty($conf->multicompany->enabled) && is_object($mc)) {\n\t\t\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\t\t\tif (!method_exists($mc, 'formObjectOptions')) {\n\t\t\t\t\tif (empty($conf->multicompany->transverse_mode) && $conf->entity == 1 && $user->admin && !$user->entity) {\n\t\t\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t\t\t\t\t\tprint \"<td>\".$mc->select_entities($object->entity, 'entity', '', 0, 1, false, false, 1); // last parameter 1 means, show also a choice 0=>'all entities'\n\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t} else {\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\t$parameters = array('colspan' => ' colspan=\"2\"');\n\t\t\t//include DOL_DOCUMENT_ROOT.'/core/tpl/extrafields_edit.tpl.php';\t\t// We do not use common tpl here because we need a special test on $caneditfield\n\t\t\t$reshook = $hookmanager->executeHooks('formObjectOptions', $parameters, $object, $action); // Note that $action and $object may have been modified by hook\n\t\t\tprint $hookmanager->resPrint;\n\t\t\tif (empty($reshook)) {\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint $object->showOptionals($extrafields, 'edit');\n\t\t\t\t} else {\n\t\t\t\t\tprint $object->showOptionals($extrafields, 'view');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t\t\t\t$doleditor = new DolEditor('signature', $object->signature, '', 138, 'dolibarr_notes', 'In', false, true, empty($conf->global->FCKEDITOR_ENABLE_USERSIGN) ? 0 : 1, ROWS_4, '90%');\n\t\t\t\tprint $doleditor->Create(1);\n\t\t\t} else {\n\t\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\n\t\t\tprint '</table>';\n\n\t\t\tprint '<hr>';\n\n\n\t\t\tprint '<table class=\"border centpercent\">';\n\n\n\t\t\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<input type=\"text\" class=\"minwidth300 maxwidth500\" name=\"job\" value=\"'.dol_escape_htmltag($object->job).'\">';\n\t\t\t} else {\n\t\t\t\tprint '<input type=\"hidden\" name=\"job\" value=\"'.dol_escape_htmltag($object->job).'\">';\n\t\t\t\tprint dol_escape_htmltag($object->job);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.price2num(GETPOST('weeklyhours') ?GETPOST('weeklyhours') : $object->weeklyhours).'\">';\n\t\t\t} else {\n\t\t\t\tprint price2num($object->weeklyhours);\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Sensitive salary/value information\n\t\t\tif ((empty($user->socid) && in_array($id, $childids))\t// A user can always see salary/value information for its subordinates\n\t\t\t\t|| (!empty($conf->salaries->enabled) && !empty($user->rights->salaries->readall))\n\t\t\t\t|| (!empty($conf->hrm->enabled) && !empty($user->rights->hrm->employee->read))) {\n\t\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint img_picto('', 'salary', 'class=\"pictofixedwidth paddingright\"').'<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.price2num(GETPOST('salary') ?GETPOST('salary') : $object->salary).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.price2num(GETPOST('thm') ?GETPOST('thm') : $object->thm).'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint ($object->thm != '' ?price($object->thm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text = $langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield) {\n\t\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.price2num(GETPOST('tjm') ?GETPOST('tjm') : $object->tjm).'\">';\n\t\t\t\t} else {\n\t\t\t\t\tprint ($object->tjm != '' ?price($object->tjm, '', $langs, 1, -1, -1, $conf->currency) : '');\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($dateemployment ? $dateemployment : $object->dateemployment, 'dateemployment', 0, 0, 1, 'formdateemployment', 1, 1);\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->dateemployment, 'day');\n\t\t\t}\n\n\t\t\tif ($dateemployment && $dateemploymentend) {\n\t\t\t\tprint ' - ';\n\t\t\t}\n\n\t\t\tif ($caneditfield) {\n\t\t\t\tprint $form->selectDate($dateemploymentend ? $dateemploymentend : $object->dateemploymentend, 'dateemploymentend', 0, 0, 1, 'formdateemploymentend', 1, 0);\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->dateemploymentend, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date birth\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateOfBirth\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield) {\n\t\t\t\techo $form->selectDate($dateofbirth ? $dateofbirth : $object->birth, 'dateofbirth', 0, 0, 1, 'updateuser', 1, 0);\n\t\t\t} else {\n\t\t\t\tprint dol_print_date($object->birth, 'day');\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '</table>';\n\n\t\t\tprint dol_get_fiche_end();\n\n\t\t\tprint '<div class=\"center\">';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Save\").'\" class=\"button button-save\" type=\"submit\" name=\"save\">';\n\t\t\tprint '&nbsp; &nbsp; &nbsp;';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Cancel\").'\" class=\"button button-cancel\" type=\"submit\" name=\"cancel\">';\n\t\t\tprint '</div>';\n\n\t\t\tprint '</form>';\n\t\t}\n\n\t\tif ($action != 'edit' && $action != 'presend') {\n\t\t\tprint '<div class=\"fichecenter\"><div class=\"fichehalfleft\">';\n\n\t\t\t// Generated documents\n\t\t\t$filename = dol_sanitizeFileName($object->ref);\n\t\t\t$filedir = $conf->user->dir_output.\"/\".dol_sanitizeFileName($object->ref);\n\t\t\t$urlsource = $_SERVER[\"PHP_SELF\"].\"?id=\".$object->id;\n\t\t\t$genallowed = $user->rights->user->user->lire;\n\t\t\t$delallowed = $user->rights->user->user->creer;\n\n\t\t\tprint $formfile->showdocuments('user', $filename, $filedir, $urlsource, $genallowed, $delallowed, $object->model_pdf, 1, 0, 0, 28, 0, '', 0, '', empty($soc->default_lang) ? '' : $soc->default_lang);\n\t\t\t$somethingshown = $formfile->numoffiles;\n\n\t\t\t// Show links to link elements\n\t\t\t$linktoelem = $form->showLinkToObjectBlock($object, null, null);\n\t\t\t$somethingshown = $form->showLinkedObjectBlock($object, $linktoelem);\n\n\t\t\tprint '</div><div class=\"fichehalfright\">';\n\n\t\t\t// List of actions on element\n\t\t\tinclude_once DOL_DOCUMENT_ROOT.'/core/class/html.formactions.class.php';\n\t\t\t$formactions = new FormActions($db);\n\t\t\t$somethingshown = $formactions->showactions($object, 'user', $socid, 1);\n\n\t\t\tprint '</div></div>';\n\t\t}\n\n\t\tif (!empty($conf->ldap->enabled) && !empty($object->ldap_sid)) {\n\t\t\t$ldap->unbind();\n\t\t}\n\t}\n}\n\nif (!empty($conf->api->enabled) && !empty($conf->use_javascript_ajax)) {\n\tprint \"\\n\".'<script type=\"text/javascript\">';\n\tprint '$(document).ready(function () {\n            $(\"#generate_api_key\").click(function() {\n                $.get( \"'.DOL_URL_ROOT.'/core/ajax/security.php\", {\n                    action: \\'getrandompassword\\',\n                    generic: true\n                },\n                function(token) {\n                    $(\"#api_key\").val(token);\n                });\n            });\n    });';\n\tprint '</script>';\n}\n\n// End of page\nllxFooter();\n$db->close();\n"], "filenames": ["htdocs/user/card.php"], "buggy_code_start_loc": [405], "buggy_code_end_loc": [1883], "fixing_code_start_loc": [404], "fixing_code_end_loc": [1885], "type": "NVD-CWE-Other", "message": "Business Logic Errors in GitHub repository dolibarr/dolibarr prior to 16.0.", "other": {"cve": {"id": "CVE-2022-0746", "sourceIdentifier": "security@huntr.dev", "published": "2022-02-25T09:15:06.890", "lastModified": "2022-11-17T17:42:00.387", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Business Logic Errors in GitHub repository dolibarr/dolibarr prior to 16.0."}, {"lang": "es", "value": "Unos Errores de L\u00f3gica de Negocios en el repositorio de GitHub dolibarr/dolibarr versiones anteriores a 16.0.\n"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 4.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 1.4}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "NVD-CWE-Other"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-840"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:dolibarr:dolibarr_erp\\/crm:*:*:*:*:*:*:*:*", "versionEndExcluding": "16.0.0", "matchCriteriaId": "2A8BD8F5-3FDF-4FF2-8291-C5C9F6C2310A"}]}]}], "references": [{"url": "https://github.com/dolibarr/dolibarr/commit/4973019630d51ad76b7c1a4141ec7a33053a7d21", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/b812ea22-0c02-46fe-b89f-04519dfb1ebd", "source": "security@huntr.dev", "tags": ["Exploit", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/dolibarr/dolibarr/commit/4973019630d51ad76b7c1a4141ec7a33053a7d21"}}