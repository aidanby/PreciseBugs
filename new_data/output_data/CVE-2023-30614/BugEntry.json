{"buggy_code": ["\u2139\ufe0f For upgrade instructions, read the [UPGRADE guide](./UPGRADE.md)\n\n### Unreleased\n\n* Remove unused attributes for `plan` and `quantity` in `app/models/pay/customer.rb`.\n* Add explicit requires for `active_support` and `action_mailer` in `lib/pay.rb`. This should provide better errors for anyone not requiring all of Rails.\n\n### 6.3.1\n\n* Fix `retry_past_due_subscriptions` to now call `pay_open_invoices`\n\n### 6.3.0\n\n* Add `payment_failed` email to notify customers of failed payments and update their billing information\n  This can be disabled with `Pay.emails.payment_failed = true` if you already use a dunning email service\n* `subscription` now sorts by `created_at` to find the latest subscription. This adds compatibility for UUID primary keys on pay tables.\n* Add `unpaid` scope to Pay::Subscription\n* Add `pay_open_invoices` to Pay::Stripe::Subscription\n  If you have a subscription with open invoices (like an unpaid metered billing subscription), you can use this method to pay the open invoices and allow the user to resume the subscription\n\n### 6.2.4\n\n* Set `created_at` on Braintree charges to match transaction created_at\n* Sync Braintree payment method during subscription sync since we already have to look it up\n* Handle missing Braintree subscription when syncing charge\n* Fix `Pay::Charge.payment_processor` scopes to join the customers table\n\n### 6.2.3\n\n* Fix Braintree PaymentMethod sync reference to gateway\n\n### 6.2.2\n\n* Fix `pause_active?` for stripe incorrectly returning `true`\n* Refactor Braintree cancel / cancel_now to use sync\n\n### 6.2.1\n\n* Use `paid_through_date` for `ends_at` with canceled subscriptions\n\n### 6.2.0\n\n* Add `Pay::Braintree::Subscription.sync`\n* Add `Pay::Braintree::Charge.sync`\n* Switch Braintree webhooks to use `sync`\n* Automatically save first charge when subscribing with Braintree\n* Add `email` for PayPal charges and `username` for Venmo charges on Braintree\n\n### 6.1.2\n\n* Fix `refunds` missing on checkout session completed event.\n\n### 6.1.1\n\n* Cast `Pay.support_email` to `Mail::Address` instead of string. This allows us to easily parse out the address, name, etc for use in Receipts and other places.\n* Update Stripe `checkout_session.completed` webhook to sync `latest_charge` for compatibility with Stripe API `2022-11-15` changes\n\n### 6.1.0\n\n* Swapping Braintree subscriptions previously had a bug where if a user had an existing plan and was attempting to switch to a new plan, we would cancel their current plan before subscribing them to the new plan.\n  If subscribing to the new plan failed however, the user would then no longer have any plan at all. This has now been resolved by attempting to subscribe to the new plan first, which if fails will raise an error and\n  preserve the users current plan.\n* Switch `business_name` to `application_name` to receipt & mailers\n  The business name is included on receipts & refunds, but emails should show the `application_name` instead in case a business has multiple applications / products\n* Use `instance_exec` for `mail_arguments` and `mail_to` so lambda/proc has access to all mailer features\n* Add `application_name` to email subjects\n* Add links to root_url in emails\n\n### 6.0.3\n\n* Validate PaymentIntent on `swap` and `retry_failed_payment`\n\n### 6.0.2\n\n* Retrieve PaymentIntent via API to ensure it always matches the Pay Stripe API verison\n\n### 6.0.1\n\n* Handle ActiveRecord::RecordNotUnique error during sync and retry\n* Add retries to Stripe PaymentMethod.sync\n* Fix deprecation warning in tests #735\n\n### 6.0.0\n\n* [Breaking] Require Stripe 8.x\n* [Breaking] Update Stripe API to 2022-11-15\n* [Breaking] `paddle_paused_from` is now `pause_starts_at:datetime` column\n* [Breaking] `active` scope no longer includes paused subscriptions\n* [Breaking] Stripe paused subscriptions have changed:\n  `pause_behavior=void` subscriptions are now considered `active?` until the end of the current period. This is intended for not providing services for a certain period of time.\n  `pause_behavior=mark_uncollectible` is considered active. This is intended for offering services for free.\n  `pause_behavior=keep_as_draft` is considered active. This is intended for offering serivces for free but collecting payments later.\n* [Breaking] Stripe subscriptions now `always_invoice` when swapping plans. Previously, swap would use `proration_behavior: \"create_prorations\"`. This caused some confusion when users upgraded plans and weren't charged until the next period. The default will now automatically invoice immediately.\n* Adds `pause_behavior:string` column\n* Adds `pause_resumes_at:datetime` column\n* Adds `metered:boolean` column for easier querying / indexing\n* Adds `active_or_paused` scope to retrieve active or paused subscriptions\n* Remove `off_session: true` default for Stripe `subscribe`. - @excid3\n  Removing this allows Stripe to attach the PaymentMethod to the Customer once confirmed. You can still pass this option in when subscribing if needed. New subscriptions typically are initiated by users, which shouldn't provide this parameter as true.\n* Add `Pay::Stripe::PaymentMethod.sync_payment_intent` to sync PaymentMethod from PaymentIntent objects\n* Add `Pay::Stripe::PaymentMethod.sync_setup_intent` to sync PaymentMethod from SetupIntent objects\n* Add `Pay::Subscription#retry_failed_payment` for retrying `past_due` subscriptions with failed payments\n* Fix `swap` from always setting status to `active`. Failed swaps with Stripe will be set to `past_due`.\n\n### 5.0.4\n\n* Prepend Pay webhook listeners so they run before user-defined webhook listeners - @excid3 @cjilbert504\n  This is important because a user might define a webhook listener that expects a subscription to be deleted and if the Pay webhook hasn't run yet, the subscription would not be canceled when the user-defined webhook runs.\n* Fix Webhook delegator unsubscribe - @excid3 @cjilbert504\n\n* Fix non-deterministic subscription - @feliperaul @excid3\n\n### 5.0.3\n\n* Old Pay::Subscription records may have `nil` or `[]` for subscription_items. In those cases, we will set the quantity on the Stripe Subscription directly - @excid3\n\n### 5.0.2\n\n* Add `metered_subscription_item` to Pay::Subscriptions to easily retrieve the metered subscription item for Stripe subscriptions - @excid3\n* Add `not_fake_processor` scope to Pay::Customer - @excid3\n\n### 5.0.1\n\n* Fix typo in Stripe API version - @excid3\n\n### 5.0.0\n\n* Upgrade to Stripe API `2022-08-01` and `stripe` rubygem v7 - @excid3\n\n### 4.2.1\n\n* Ensure Customer is created before creating a setup intent - @excid3 @cjilbert504\n\n### 4.2.0\n\n* \u2139\ufe0f  Add `\"paused\"` into `.active` scope and `#active?` on `Pay::Subscription`.\n    Stripe marks paused subscriptions with `status: :active` and  `pause_behavior` not null.\n    Paddle marks paused subscriptions with `status: :paused`.\n    This change allows Pay to treat them both the same. - @cjilbert504 @excid3\n* Add `active_without_paused` scope on `Pay::Subsctiption`. This filters out paused subscriptions from the `active` scope. - @cjilbert504 @GALTdea\n* Add `status: :paused` to update call in `Pay::Paddle::Subscription#pause`. - @cjilbert504 @excid3\n* Change `#paused?` in `Pay::Paddle::Subscription` to check `pay_subscription.status == \"paused\"` instead of `#paddle_paused_from`. - @cjilbert504 @excid3\n    If webhooks have not been utilized, you should run query for any `Pay::Subscriptions` where `status: :active` and `paddle_paused_from` is not null and update to `status: \"paused\"`.\n\n### 4.1.1\n\n* Expand Stripe discounts and taxes when loading a subscription - @excid3\n\n### 4.1.0\n\n* Store Stripe refunds on the Charge - @excid3\n* Include line for each refund in the receipt - @excid3\n\n### 4.0.4\n\n* Fix recording first charge for a subscription - @excid3\n\n### 4.0.3\n\n* Fix tax amounts and skip $0 tax lines in Stripe receipts - @excid3\n\n### 4.0.2\n\n* Support `client_reference_id` on Stripe Checkout Sessions - @excid3 @cjilbert504\n  This is helpful when using the Stripe Pricing Table or any Checkout Session. Requires a Signed GlobalID as the value to prevent tampering.\n\n```ruby\n::Stripe::Checkout::Session.create(\n  mode: \"payment\",\n  client_reference_id: current_user.to_sgid,\n  ...\n)\n```\n\n* Stripe `checkout.session.completed` now syncs payment intents - @excid3\n\n### 4.0.1\n\n* Update `refund!` method in `stripe/charge.rb` to handle multiple refunds on the same charge. - @cjilbert504 @kyleschmolze\n* Add configuration options for mailer - @excid3 @le-doude @cjilbert504\n\n```ruby\nPay.setup do |config|\n  # Change parent mailer for Pay::UserMailer\n  config.parent_mailer = \"MyCustomMailer\"\n\n  # Change the mailer for Pay\n  config.mailer = \"MyCustomMailer\"\n```\n\n### 4.0.0\n\n* [Breaking] Replaced `subscription` and `charge` email params to `pay_subscription` and `pay_charge` respectively. - @cjilbert504\n* [Breaking] Replaced `send_emails` with `emails` config. This allows you to customize which emails can be sent independently. - @cjilbert504\n```ruby\nPay.setup do |config|\n  # Set value to boolean\n  config.emails.receipt = true\n  # Or set value to a lambda that returns a boolean\n  config.emails.subscription_renewing = ->(pay_subscription, price) {\n    (price&.type == \"recurring\") && (price.recurring&.interval == \"year\")\n  }\nend\n```\n\n* Numericality validation on `Pay::Subscription` has been updated from being `greater_than_or_equal_to: 1` to `greater_than_or_equal_to: 0`. This is because metered billing subscriptions do not have a quantity.\n\n* Stripe Tax support\n\n  Using `pay_customer stripe_attributes: :method_name`, you can add an Address to `Stripe::Customer` objects which will be used for calculating taxes.\n  We now record `total_tax_amounts` to `Pay::Charge` records. This includes details for each tax applied to the charge.\n\n  ```ruby\n  @user.payment_processor.subscribe(plan: \"growth\", automatic_tax: { enabled: true })\n  ```\n\n* Stripe Metered Billing support\n  Removes `quantity` when creating a new subscription (metered billing prices do not allow quantity)\n  Adds `create_usage_record` to `Pay::Subscription` for reporting usage on metered billing plans\n  Adds `metered_items?` helper to `Pay::Subscription` to easily check if a subscription has any metered billing items\n  Adds `Pay::Subscription.with_metered_items` method to query for subscriptions with metered billing items\n\n* Raise error when dependencies are not supported versions. This makes sure you're using supported versions of libraries with Pay.\n  Currently supported versions:\n    * `stripe ~> 6.0`\n    * `braintree ~> 4.7`\n    * `paddle_pay ~> 0.2`\n    * `receipts ~> 2.0`\n* Add `credit_note!` to Stripe charges - @excid3\n* `refund!` now issues a Stripe::CreditNote if an invoice is present - @excid3\n  > Refunds of charges associated with an Invoice don\u2019t reduce your overall tax liability and don\u2019t show up in Stripe Tax reporting. https://stripe.com/docs/tax/faq#how-do-refunds-work\n  > In most cases, you should use credit notes instead of refunds. Credit notes reduce your overall tax liability and show up in Stripe Tax reporting. https://stripe.com/docs/tax/faq#how-do-you-handle-credit-notes\n* Stripe.max_network_retries is now set to 2 by default. - @excid3\n  This adds idempotency keys automatically to each request so that they can be safely retried.\n* Stripe Subscriptons can now be paused and resumed - @excid3\n* Separate authorize and capture is now supported on Stripe - @excid3\n  ```ruby\n  pay_charge = pay_customer.authorize(75_00)\n  pay_charge.capture\n  pay_charge.capture(amount_to_capture: 50_00) # or with an amount\n  ```\n* Store `stripe_receipt_url` on Pay::Charge - @mguidetti\n* Replace `update_email!` with `update_customer!` - @excid3\n* Add options for `cancel_now!` to support `invoice_now` and `prorate` flags for Stripe - @excid3\n* Adds `add_payment_processor` to add a payment processor without making it the default - @excid3\n* Setting `pay_name` in Stripe Subscription metadata will be used as the `name` on the `Pay::Subscription` - @excid3\n* `pay_customer` now supports a `stripe_attributes:` option to add attributes to Stripe::Customers - @excid3\n* `pay_customer` now supports a `braintree_attributes:` option to add attributes to Braintree::Customers - @excid3\n* `pay_customer` now supports a `default_payment_processor` option to automatically create a Pay::Customer record - @excid3\n* Added `enabled_processors` to Pay config. This lets you choose exactly which processors will be enabled. - @cjilbert504\n* Add `sync!` method to Pay::Subscription instances - @excid3\n* Ignore Stripe charges that don't have a customer ID - @excid3\n\n### 3.0.24\n\n* Make payment method and charges consistent for Fake procsesor - @excid3\n\n### 3.0.23\n\n* Merge Stripe Checkout `session_id` param into `success_url` automatically - @excid3\n\n### 3.0.22\n\n* Update to `@hotwired/stimulus` for payments view - @excid3\n* Update test/dummy app to Pay 3 - @excid3\n\n### 3.0.21\n\n* Add `update_customer` methods for SyncCustomer job - @excid3\n\n### 3.0.20\n\n* Safely handle receipts for users without `extra_billing_info` - @excid3\n\n### 3.0.19\n\n* Correctly handle cancelling a paused Paddle subscription - @excid3\n\n### 3.0.18\n\n* Add `generic_trial?` to `Pay::Subscription` for checking if fake processor trial - @excid3\n* Charge succeeded should send email even when receipts gem isn't available - @excid3\n* Update mailers to use `Pay::Customer#customer_name` - @excid3\n* Use `pay_customer` instead of `billable` in mailers - @excid3\n* Remove payment methods when cancelling Paddle subscription - @excid3\n\n### 3.0.17\n\n* Convert `paddle_paused_from` to Time - @excid3\n\n### 3.0.16\n\n* Remove hardcoded currency in emails - @excid3\n\n### 3.0.15\n\n* Accept options for `Pay::Currency.format` - @excid3\n\n### 3.0.14\n\n* Add `amount_with_currency` to `Pay::Payment` - @excid3\n\n### 3.0.13\n\n* Add `Pay::Currency` for formatting amounts with currency - @excid3\n* Add `amount_with_currency` and `amount_refunded_with_currency` to `Pay::Charge` - @excid3\n* Safer pay processor lookup when processor is blank - @excid3\n* Store `stripe_account` when syncing Stripe payment methods - @excid3\n\n### 3.0.12\n\n* Add `CHECKOUT_SESSION_ID` to checkout URLs by default and document how to add them - @excid3\n* Fix invoice bill_to to use `customer.owner` instead of `owner` - @excid3\n\n### 3.0.11\n\n* Fix Stripe charge.refunded webhook - @excid3\n\n### 3.0.10\n\n* Fix Pay::Subscription charges association - @excid3\n* Remove Pay::Charge default sort - @excid3\n\n### 3.0.9\n\n* Fix translation key - @excid3\n\n### 3.0.8\n\n* Better invoice line items format - @excid3\n\n### 3.0.7\n\n* Namespace locales under `pay` - @excid3\n* I18n receipt and invoice dates - @excid3\n* Add `business_logo` config - @excid3\n* Add `refunded?` `partial_refund?` and `full_refund?` methods to `Pay::Charge` - @excid3\n\n### 3.0.6\n\n* Fix payment method sync on customer updated - @excid3\n\n### 3.0.5\n\n* Fix Stripe customer.updated webhook - @excid3\n\n### 3.0.4\n\n* Add retries for payment method sync in case of rate limiting - @excid3\n* Add `on_generic_trial?` to Pay::Customer for easier checking - @excid3\n\n### 3.0.3\n\nYanked\n\n### 3.0.2\n\n* Add payment methods to Pay::Charge `charged_to` helper - @excid3\n* Improve `swap` error message - @excid3\n\n### 3.0.1\n\n* Add `rake pay:payment_methods:sync_default` task for easily upgrading to Pay 3 - @excid3\n\n### 3.0.0\n\nSee the [UPGRADE](UPGRADE.md) guide for steps on upgrading from Pay 2.x.\n\n* **Requires Rails 6+**\n* Migrates `processor` and `processor_id` from models to `Pay::Customer` model\n* Replaces include Pay::Billable with pay_customer method\n* Replaces include Pay::Merchant with pay_merchant method\n* Changes Pay::Charge to associate with Pay::Customer instead of `owner{polymorphic}`\n* Changes Pay::Subscription to associate with `Pay::Customer` instead of `owner{polymorphic}`\n* Migrates card fields from models to `Pay::PaymentMethod` model\n* Queues webhooks in `Pay::Webhook` for processing with ActiveJob to handle large volumes of webhooks\n* Subscriptions are automatically canceled when a Pay::Subscription deleted - @stevepolitodesign\n* Active subscriptions are canceled when a Pay::Customer's owner is deleted - @stevepolitodesign\n* Add `invoice` to Pay::Charge\n\n### 2.7.2\n\n* Don't validate SetupIntent for trialing subscriptions - @archonic\n* Validate uniqueness of charges and subscriptions - @excid3\n* Better handle out of order webhooks and race conditions - @excid3\n\n### 2.7.1\n\n* Refactor Stripe webhooks to always retrieve latest records - @excid3\n* Associate charges with subscriptions if possible - @excid3\n\n### 2.7.0\n\n* Add `Pay::Merchant` and Stripe Connect functionality - @excid3\n* Save `currency` on Pay::Charge records - @excid3\n\n### 2.6.11\n\n* Add `subscription` method to payment processor classes for direct access to the processor subscription object.\n  The owner is not guaranteed to be on the same payment processor, which can cause problems. - @excid3\n\n### 2.6.10\n\n* Improve the Stripe Checkout URLs so your Rails app doesn't need a `root_url` #309 - @excid3\n* Fix `currency` with Stripe Checkout #308 - @excid3\n\n### 2.6.9\n\n* Update Stripe & Braintree default card automatically when the customer is accessed (ie. on charge, subscribe, etc) #300 - @excid3\n\n### 2.6.8\n\n* Add passthrough fallback for paddle payment succeeded webhook #302 - @nm\n\n### 2.6.7\n\n* Add Stripe `payment_intent.succeeded` webhook listener\n\n### 2.6.6\n\n* Improve error wrappers to delegate message to original cause\n\n### 2.6.5\n\n* [NEW] Raise error if payment processor name is nil\n* [FIX] Pay::Error now uses the correct message in to_s\n* Create braintree customer on update_card if needed\n\n# 2.6.4\n\n* [NEW] Fake payment processor for testing and giving users free access to your application\n* [FIX] Delegate trial_ends_at for subscriptions - @archonic\n\n# 2.6.3\n\n* [FIX] Default to empty hash when default_url_options is nil so proper error is raised\n* [FIX] Fix inquiry when processor is nil\n\n### 2.6.2\n\n* [FIX] Correctly handle updating payment method in Stripe\n\n### 2.6.1\n\n* [NEW] Add Stripe Customer Billing Portal - @excid3\n* Include `customer` on Stripe Checkout sessions - @excid3\n\n### 2.6.0\n\n* [NEW] Stripe Checkout support - @excid3\n\n### 2.5.0\n\n* [BREAKING] Webhooks that can't be verified respond with 400 instead of 200 - @excid3\n* [BREAKING] Remove StripeEvent dependency - excid3\n* [BREAKING] Remove old configuration for mailer subjects in favor of locales - @excid3\n* [NEW] Add `Pay::Webhook.delegator` for subscribing to webhooks - @excid3\n\n### 2.4.4\n\n* [Fix] Fixed missing require for version file - @excid3\n\n### 2.4.3\n\n* Add Stripe app info and join the Stripe Partner program for better support for Pay! - @excid3\n\n### 2.4.2\n\n* [FIX] Update migration to check for symobl keys on ActiveRecord adapter with Rails 6.1 - @excid3\n\n### 2.4.1\n\n* [FIX] Move Paddle logic into paddle methods - @excid3\n\n### 2.4.0\n\n* [BREAKING] Use locales for email subjects and remove configuration - @excid3\n\n### 2.3.1\n\n* [FIX] Subject for payment action required emails referenced an invalid config - @excid3\n\n### 2.3.0\n\n* Add `data` json column to Charge and Subscription models - @excid3\n\nTo add the new migrations to your app, run:\n\n```\nrails pay:install:migrations\n```\n\n* Add Paddle initial support - @nm\n* `Pay.model_parent_class` defaults to `ApplicationRecord` - @excid3\n* Test suite now runs against sqlite, mysql, and postgresql - @excid3\n* [FIX] Lookup billable on invoice.payment_action_required events - @excid3\n\n### 2.2.2\n\n* Bugfixes\n\n### 2.2.1\n\n* [NEW] Allow passing `?back=/path/to/item` for customizing the back link for SCA payments page\n\n### 2.2.0\n\nStripe API 2020-08-27 changes:\n\n* Use `proration_behavior` instead of `prorate` for Stripe subscription changes\n* Switch to `::Stripe::Subscription.create` instead of `customer.subscriptions` as Stripe no longer includes this by default for performance\n* Set Stripe API version for easier gem management\n\n### 2.1.3\n\n* Add support for `quantity` option on `subscribe` for subscription quantities\n* Added `Pay::BraintreeAuthorizationError` to catch Braintree actions\n  with malformed data or unauthorized API access.\n\n### 2.1.2\n\n* [FIX] Remove old billable migration\n\n### 2.1.1\n\n* [FIX] The `charge` method now raises `Pay::BraintreeError` when a\n  charge fails. This makes it work consistently with the Stripe\n  implementation which raises an error on charge failure.\n\n### 2.1.0\n\n* [BREAKING] Subscription & Charge associations to `owner` are now polymorphic.\n\n  Requires adding `owner_type:string` to both Pay::Charge and Pay::Subscription models and setting the value for all existing records to your model name.\n\n```ruby\nclass AddOwnerTypeToPay < ActiveRecord::Migration[6.0]\n  def change\n    add_column :pay_charges, :owner_type, :string\n    add_column :pay_subscriptions, :owner_type, :string\n\n    # Backfill owner_type column to match your Billable model\n    Pay::Charge.update_all owner_type: \"User\"\n    Pay::Subscription.update_all owner_type: \"User\"\n  end\nend\n```\n\n  `Pay.billable_class` is now deprecated and will be removed in a future version. You should also update your existing Pay migrations to reference the `:users` table rather than `Pay.billable_class` and any other code you may have that references this method.\n\n### 2.0.3\n\n* [FIX] Stripe subscription cancel shouldn't change status\n* [FIX] Stripe test payment methods should now work (ie. `pm_card_visa`)\n\n### 2.0.2\n\n* [FIX] Styling tweaks for payment intent page\n\n### 2.0.1\n\n* [FIX] Stripe Refund and Charge references weren't matching the right\n  class\n\n### 2.0.0\n\n* [NEW] Stripe SCA support\n* [BREAKING] Requires using PaymentMethods instead of Source and Tokens\n* [BREAKING] Drops Ruby 2.4 support\n* [BREAKING] `automount_webhook_routes` config option has been renamed to `automount_routes`\n* [BREAKING]`webhooks_path` config option has been renamed to `routes_path`\n* Added `status` column to payments to keep in sync with Stripe. We're\n  also adding statuses to Braintree subscriptions to keep them in sync as best we can.\n* Added `payments#show` route to handle SCA payments that require action\n* Added webhook handler for payments that require action\n* Added `trial_period_days` when creating a subscription that works the\n  same on Stripe and Braintree\n\n### 1.0.3\n\n* Set default from email to `Pay.support_email`\n\n### 1.0.2\n\n* Add `on_trial_or_subscribed?` convenience method\n\n### 1.0.1\n\n* Removed Rails HTML Sanitizer dependency since it wasn't being used\n\n### 1.0.0\n\n* Add `stripe?`, `braintree?`, and `paypal?` to Pay::Charge\n* Add webhook mounting and path options\n\n### 1.0.0.beta4 - 2019-03-26\n\n* Makes `stripe?`, `braintree?`, and `paypal?` helper methods always\n  available on Billable.\n\n### 1.0.0.beta3 - 2019-03-12\n\n* Update migration to reference Billable instead of Users\n\n### 1.0.0.beta2 - 2019-03-11\n\n* Check ENV first when looking up keys to allow for overrides\n", "module Pay\n  class PaymentsController < ApplicationController\n    layout \"pay/application\"\n\n    def show\n      @redirect_to = params[:back].presence || root_path\n      @payment = Payment.from_id(params[:id])\n    end\n  end\nend\n", "<div\n  data-controller=\"payment-intent\"\n  data-payment-intent-client-secret-value=\"<%= @payment.client_secret %>\"\n  data-payment-intent-status-value=\"<%= @payment.status %>\"\n  data-payment-intent-customer-value=\"<%= @payment.customer %>\"\n  class=\"h-screen md:flex md:justify-center md:items-center\">\n  <div class=\"w-full max-w-lg\">\n    <!-- Status Messages -->\n    <p data-payment-intent-target=\"error\" class=\"hidden items-center mb-4 bg-red-100 border border-red-200 px-5 py-2 rounded-lg text-red-500\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"flex-shrink-0 text-red-500 h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n        <path fill-rule=\"evenodd\" d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z\" clip-rule=\"evenodd\" />\n      </svg>\n\n      <span data-payment-intent-target=\"errorMessage\" class=\"ml-3\"></span>\n    </p>\n\n    <p data-payment-intent-target=\"success\" class=\"hidden items-center mb-4 bg-green-100 border border-green-200 px-5 py-4 rounded-lg text-green-700\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"flex-shrink-0 text-green-500 h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n        <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clip-rule=\"evenodd\" />\n      </svg>\n\n      <span data-payment-intent-target=\"successMessage\" class=\"ml-3\"></span>\n    </p>\n\n    <div class=\"bg-white rounded-lg shadow-xl p-4 sm:py-6 sm:px-10 mb-5\">\n      <% if @payment.succeeded? %>\n        <h1 class=\"text-xl mt-2 mb-4 text-gray-700\"><%=t \"pay.successful.header\" %></h1>\n        <p class=\"mb-6\"><%=t \"pay.successful.description\" %></p>\n\n      <% elsif @payment.canceled? %>\n        <h1 class=\"text-xl mt-2 mb-4 text-gray-700\"><%=t \"pay.cancelled.header\" %></h1>\n        <p class=\"mb-6\"><%=t \"pay.cancelled.description\" %></p>\n\n      <% else %>\n        <div data-payment-intent-target=\"form\" id=\"payment-elements\">\n          <!-- Instructions -->\n          <h1 class=\"text-xl mt-2 mb-4 text-gray-700\"><%=t \"pay.requires_action.header\", amount: @payment.amount_with_currency %></h1>\n          <p class=\"mb-6\"><%=t \"pay.requires_action.description\" %></p>\n\n          <div data-payment-intent-target=\"cardFields\" class=\"hidden\">\n            <!-- Name -->\n            <label for=\"cardholder-name\" class=\"inline-block text-sm text-gray-700 font-semibold mb-2\"><%=t \"pay.requires_action.full_name\" %></label>\n            <input data-payment-intent-target=\"name\" id=\"cardholder-name\" type=\"text\" placeholder=\"Jane Doe\" required autofocus class=\"mt-1 mb-6 block w-full px-3 py-2 rounded-md border border-gray-300 shadow-sm focus:outline-none focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50\">\n\n            <!-- Card -->\n            <label for=\"card-element\" class=\"inline-block text-sm text-gray-700 font-semibold mb-2\"><%=t \"pay.requires_action.card\" %></label>\n            <div data-payment-intent-target=\"card\" id=\"card-element\" class=\"mt-1 mb-6 block w-full px-3 py-4 rounded-md border border-gray-300 shadow-sm focus:outline-none focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50\"></div>\n          </div>\n\n          <!-- Pay Button -->\n          <button data-payment-intent-target=\"button\" data-action=\"click->payment-intent#confirmPayment\" class=\"inline-block w-full px-4 py-3 mb-4 text-white rounded-lg bg-blue-400 hover:bg-blue-500\">\n            <%=t \"pay.requires_action.button\", amount: @payment.amount_with_currency %>\n          </button>\n        </div>\n      <% end %>\n\n      <%= link_to t(\"pay.back\"), @redirect_to, class: \"inline-block w-full px-4 py-3 bg-gray-100 hover:bg-gray-200 text-center text-gray-600 rounded-lg\" %>\n    </div>\n\n    <p class=\"text-center text-gray-500 text-sm\">\n      \u00a9 <%= Date.current.year %> <%= Pay.business_name %> <%=t \"pay.all_rights_reserved\" %>\n    </p>\n  </div>\n</div>\n\n<script type=\"module\">\n  window.stripe = Stripe('<%= Pay::Stripe.public_key %>');\n\n  import { Application, Controller } from 'https://unpkg.com/@hotwired/stimulus'\n  const application = Application.start()\n\n  application.register('payment-intent', class extends Controller {\n    static targets = [\"error\", \"errorMessage\", \"success\", \"successMessage\", \"form\", \"button\", \"name\", \"card\", \"cardFields\"]\n    static values = {\n      clientSecret: String,\n      customer: String,\n      status: String,\n      errorMessage: String,\n      successMessage: String,\n      complete: Boolean,\n      processing: Boolean\n    }\n\n    connect() {\n      if (this.hasCardTarget) {\n        this.elements = stripe.elements()\n        this.cardElement = this.elements.create(\"card\")\n        this.cardElement.mount(this.cardTarget)\n      }\n    }\n\n    statusValueChanged() {\n      switch(this.statusValue) {\n        case \"requires_action\":\n          stripe.confirmCardPayment(this.clientSecretValue).then(this.handleConfirmResult.bind(this))\n          break;\n        case \"requires_payment_method\":\n          this.cardFieldsTarget.classList.toggle(\"hidden\", false)\n          break;\n      }\n    }\n\n    confirmPayment() {\n      this.processingValue = true\n      this.completeValue = false\n      stripe.confirmCardPayment(this.clientSecretValue, {\n        payment_method: {\n          card: this.cardElement,\n          billing_details: { name: this.nameTarget.value }\n        },\n        save_payment_method: this.customerValue != \"\",\n        setup_future_usage: 'off_session',\n      }).then(this.handleConfirmResult.bind(this))\n    }\n\n    handleConfirmResult(result) {\n      this.processingValue = false\n\n      if (result.error) {\n        if (result.error.code === 'parameter_invalid_empty' &&\n          result.error.param === 'payment_method_data[billing_details][name]') {\n          this.errorMessageValue = '<%=t \"pay.requires_action.name_missing\" %>'\n        } else {\n          this.errorMessageValue = result.error.message\n          this.statusValue = result.error.payment_intent.status\n        }\n      } else {\n        this.completeValue = true;\n        this.successMessageValue = '<%=t \"pay.requires_action.success\" %>'\n      }\n    }\n\n    completeValueChanged() {\n      if (this.hasFormTarget) {\n        this.formTarget.classList.toggle(\"hidden\", this.completeValue)\n      }\n    }\n\n    processingValueChanged() {\n      if (this.hasButtonTarget) {\n        this.buttonTarget.disabled = this.processingValue\n        this.buttonTarget.classList.toggle(\"bg-blue-400\", this.processingValue)\n        this.buttonTarget.classList.toggle(\"bg-blue-500\", !this.processingValue)\n      }\n    }\n\n    errorMessageValueChanged() {\n      this.errorMessageTarget.textContent = this.errorMessageValue\n      const enabled = (this.errorMessageValue != '')\n      this.errorTarget.classList.toggle(\"flex\", enabled)\n      this.errorTarget.classList.toggle(\"hidden\", !enabled)\n    }\n\n    successMessageValueChanged() {\n      this.successMessageTarget.textContent = this.successMessageValue\n      const enabled = (this.successMessageValue != '')\n      this.successTarget.classList.toggle(\"flex\", enabled)\n      this.successTarget.classList.toggle(\"hidden\", !enabled)\n    }\n  })\n</script>\n"], "fixing_code": ["\u2139\ufe0f For upgrade instructions, read the [UPGRADE guide](./UPGRADE.md)\n\n### Unreleased\n\n* [SECURITY] Fix XSS vulnerability in back parameter on Stripe payment page\n  Previously, an attacker could inject Javascript or redirect the user to any URL by changing the `back` parameter in the URL.\n  The `back` parameter is now sanitized and restricted to relative paths.\n* Remove unused attributes for `plan` and `quantity` in `app/models/pay/customer.rb`.\n* Add explicit requires for `active_support` and `action_mailer` in `lib/pay.rb`. This should provide better errors for anyone not requiring all of Rails.\n\n### 6.3.1\n\n* Fix `retry_past_due_subscriptions` to now call `pay_open_invoices`\n\n### 6.3.0\n\n* Add `payment_failed` email to notify customers of failed payments and update their billing information\n  This can be disabled with `Pay.emails.payment_failed = true` if you already use a dunning email service\n* `subscription` now sorts by `created_at` to find the latest subscription. This adds compatibility for UUID primary keys on pay tables.\n* Add `unpaid` scope to Pay::Subscription\n* Add `pay_open_invoices` to Pay::Stripe::Subscription\n  If you have a subscription with open invoices (like an unpaid metered billing subscription), you can use this method to pay the open invoices and allow the user to resume the subscription\n\n### 6.2.4\n\n* Set `created_at` on Braintree charges to match transaction created_at\n* Sync Braintree payment method during subscription sync since we already have to look it up\n* Handle missing Braintree subscription when syncing charge\n* Fix `Pay::Charge.payment_processor` scopes to join the customers table\n\n### 6.2.3\n\n* Fix Braintree PaymentMethod sync reference to gateway\n\n### 6.2.2\n\n* Fix `pause_active?` for stripe incorrectly returning `true`\n* Refactor Braintree cancel / cancel_now to use sync\n\n### 6.2.1\n\n* Use `paid_through_date` for `ends_at` with canceled subscriptions\n\n### 6.2.0\n\n* Add `Pay::Braintree::Subscription.sync`\n* Add `Pay::Braintree::Charge.sync`\n* Switch Braintree webhooks to use `sync`\n* Automatically save first charge when subscribing with Braintree\n* Add `email` for PayPal charges and `username` for Venmo charges on Braintree\n\n### 6.1.2\n\n* Fix `refunds` missing on checkout session completed event.\n\n### 6.1.1\n\n* Cast `Pay.support_email` to `Mail::Address` instead of string. This allows us to easily parse out the address, name, etc for use in Receipts and other places.\n* Update Stripe `checkout_session.completed` webhook to sync `latest_charge` for compatibility with Stripe API `2022-11-15` changes\n\n### 6.1.0\n\n* Swapping Braintree subscriptions previously had a bug where if a user had an existing plan and was attempting to switch to a new plan, we would cancel their current plan before subscribing them to the new plan.\n  If subscribing to the new plan failed however, the user would then no longer have any plan at all. This has now been resolved by attempting to subscribe to the new plan first, which if fails will raise an error and\n  preserve the users current plan.\n* Switch `business_name` to `application_name` to receipt & mailers\n  The business name is included on receipts & refunds, but emails should show the `application_name` instead in case a business has multiple applications / products\n* Use `instance_exec` for `mail_arguments` and `mail_to` so lambda/proc has access to all mailer features\n* Add `application_name` to email subjects\n* Add links to root_url in emails\n\n### 6.0.3\n\n* Validate PaymentIntent on `swap` and `retry_failed_payment`\n\n### 6.0.2\n\n* Retrieve PaymentIntent via API to ensure it always matches the Pay Stripe API verison\n\n### 6.0.1\n\n* Handle ActiveRecord::RecordNotUnique error during sync and retry\n* Add retries to Stripe PaymentMethod.sync\n* Fix deprecation warning in tests #735\n\n### 6.0.0\n\n* [Breaking] Require Stripe 8.x\n* [Breaking] Update Stripe API to 2022-11-15\n* [Breaking] `paddle_paused_from` is now `pause_starts_at:datetime` column\n* [Breaking] `active` scope no longer includes paused subscriptions\n* [Breaking] Stripe paused subscriptions have changed:\n  `pause_behavior=void` subscriptions are now considered `active?` until the end of the current period. This is intended for not providing services for a certain period of time.\n  `pause_behavior=mark_uncollectible` is considered active. This is intended for offering services for free.\n  `pause_behavior=keep_as_draft` is considered active. This is intended for offering serivces for free but collecting payments later.\n* [Breaking] Stripe subscriptions now `always_invoice` when swapping plans. Previously, swap would use `proration_behavior: \"create_prorations\"`. This caused some confusion when users upgraded plans and weren't charged until the next period. The default will now automatically invoice immediately.\n* Adds `pause_behavior:string` column\n* Adds `pause_resumes_at:datetime` column\n* Adds `metered:boolean` column for easier querying / indexing\n* Adds `active_or_paused` scope to retrieve active or paused subscriptions\n* Remove `off_session: true` default for Stripe `subscribe`. - @excid3\n  Removing this allows Stripe to attach the PaymentMethod to the Customer once confirmed. You can still pass this option in when subscribing if needed. New subscriptions typically are initiated by users, which shouldn't provide this parameter as true.\n* Add `Pay::Stripe::PaymentMethod.sync_payment_intent` to sync PaymentMethod from PaymentIntent objects\n* Add `Pay::Stripe::PaymentMethod.sync_setup_intent` to sync PaymentMethod from SetupIntent objects\n* Add `Pay::Subscription#retry_failed_payment` for retrying `past_due` subscriptions with failed payments\n* Fix `swap` from always setting status to `active`. Failed swaps with Stripe will be set to `past_due`.\n\n### 5.0.4\n\n* Prepend Pay webhook listeners so they run before user-defined webhook listeners - @excid3 @cjilbert504\n  This is important because a user might define a webhook listener that expects a subscription to be deleted and if the Pay webhook hasn't run yet, the subscription would not be canceled when the user-defined webhook runs.\n* Fix Webhook delegator unsubscribe - @excid3 @cjilbert504\n\n* Fix non-deterministic subscription - @feliperaul @excid3\n\n### 5.0.3\n\n* Old Pay::Subscription records may have `nil` or `[]` for subscription_items. In those cases, we will set the quantity on the Stripe Subscription directly - @excid3\n\n### 5.0.2\n\n* Add `metered_subscription_item` to Pay::Subscriptions to easily retrieve the metered subscription item for Stripe subscriptions - @excid3\n* Add `not_fake_processor` scope to Pay::Customer - @excid3\n\n### 5.0.1\n\n* Fix typo in Stripe API version - @excid3\n\n### 5.0.0\n\n* Upgrade to Stripe API `2022-08-01` and `stripe` rubygem v7 - @excid3\n\n### 4.2.1\n\n* Ensure Customer is created before creating a setup intent - @excid3 @cjilbert504\n\n### 4.2.0\n\n* \u2139\ufe0f  Add `\"paused\"` into `.active` scope and `#active?` on `Pay::Subscription`.\n    Stripe marks paused subscriptions with `status: :active` and  `pause_behavior` not null.\n    Paddle marks paused subscriptions with `status: :paused`.\n    This change allows Pay to treat them both the same. - @cjilbert504 @excid3\n* Add `active_without_paused` scope on `Pay::Subsctiption`. This filters out paused subscriptions from the `active` scope. - @cjilbert504 @GALTdea\n* Add `status: :paused` to update call in `Pay::Paddle::Subscription#pause`. - @cjilbert504 @excid3\n* Change `#paused?` in `Pay::Paddle::Subscription` to check `pay_subscription.status == \"paused\"` instead of `#paddle_paused_from`. - @cjilbert504 @excid3\n    If webhooks have not been utilized, you should run query for any `Pay::Subscriptions` where `status: :active` and `paddle_paused_from` is not null and update to `status: \"paused\"`.\n\n### 4.1.1\n\n* Expand Stripe discounts and taxes when loading a subscription - @excid3\n\n### 4.1.0\n\n* Store Stripe refunds on the Charge - @excid3\n* Include line for each refund in the receipt - @excid3\n\n### 4.0.4\n\n* Fix recording first charge for a subscription - @excid3\n\n### 4.0.3\n\n* Fix tax amounts and skip $0 tax lines in Stripe receipts - @excid3\n\n### 4.0.2\n\n* Support `client_reference_id` on Stripe Checkout Sessions - @excid3 @cjilbert504\n  This is helpful when using the Stripe Pricing Table or any Checkout Session. Requires a Signed GlobalID as the value to prevent tampering.\n\n```ruby\n::Stripe::Checkout::Session.create(\n  mode: \"payment\",\n  client_reference_id: current_user.to_sgid,\n  ...\n)\n```\n\n* Stripe `checkout.session.completed` now syncs payment intents - @excid3\n\n### 4.0.1\n\n* Update `refund!` method in `stripe/charge.rb` to handle multiple refunds on the same charge. - @cjilbert504 @kyleschmolze\n* Add configuration options for mailer - @excid3 @le-doude @cjilbert504\n\n```ruby\nPay.setup do |config|\n  # Change parent mailer for Pay::UserMailer\n  config.parent_mailer = \"MyCustomMailer\"\n\n  # Change the mailer for Pay\n  config.mailer = \"MyCustomMailer\"\n```\n\n### 4.0.0\n\n* [Breaking] Replaced `subscription` and `charge` email params to `pay_subscription` and `pay_charge` respectively. - @cjilbert504\n* [Breaking] Replaced `send_emails` with `emails` config. This allows you to customize which emails can be sent independently. - @cjilbert504\n```ruby\nPay.setup do |config|\n  # Set value to boolean\n  config.emails.receipt = true\n  # Or set value to a lambda that returns a boolean\n  config.emails.subscription_renewing = ->(pay_subscription, price) {\n    (price&.type == \"recurring\") && (price.recurring&.interval == \"year\")\n  }\nend\n```\n\n* Numericality validation on `Pay::Subscription` has been updated from being `greater_than_or_equal_to: 1` to `greater_than_or_equal_to: 0`. This is because metered billing subscriptions do not have a quantity.\n\n* Stripe Tax support\n\n  Using `pay_customer stripe_attributes: :method_name`, you can add an Address to `Stripe::Customer` objects which will be used for calculating taxes.\n  We now record `total_tax_amounts` to `Pay::Charge` records. This includes details for each tax applied to the charge.\n\n  ```ruby\n  @user.payment_processor.subscribe(plan: \"growth\", automatic_tax: { enabled: true })\n  ```\n\n* Stripe Metered Billing support\n  Removes `quantity` when creating a new subscription (metered billing prices do not allow quantity)\n  Adds `create_usage_record` to `Pay::Subscription` for reporting usage on metered billing plans\n  Adds `metered_items?` helper to `Pay::Subscription` to easily check if a subscription has any metered billing items\n  Adds `Pay::Subscription.with_metered_items` method to query for subscriptions with metered billing items\n\n* Raise error when dependencies are not supported versions. This makes sure you're using supported versions of libraries with Pay.\n  Currently supported versions:\n    * `stripe ~> 6.0`\n    * `braintree ~> 4.7`\n    * `paddle_pay ~> 0.2`\n    * `receipts ~> 2.0`\n* Add `credit_note!` to Stripe charges - @excid3\n* `refund!` now issues a Stripe::CreditNote if an invoice is present - @excid3\n  > Refunds of charges associated with an Invoice don\u2019t reduce your overall tax liability and don\u2019t show up in Stripe Tax reporting. https://stripe.com/docs/tax/faq#how-do-refunds-work\n  > In most cases, you should use credit notes instead of refunds. Credit notes reduce your overall tax liability and show up in Stripe Tax reporting. https://stripe.com/docs/tax/faq#how-do-you-handle-credit-notes\n* Stripe.max_network_retries is now set to 2 by default. - @excid3\n  This adds idempotency keys automatically to each request so that they can be safely retried.\n* Stripe Subscriptons can now be paused and resumed - @excid3\n* Separate authorize and capture is now supported on Stripe - @excid3\n  ```ruby\n  pay_charge = pay_customer.authorize(75_00)\n  pay_charge.capture\n  pay_charge.capture(amount_to_capture: 50_00) # or with an amount\n  ```\n* Store `stripe_receipt_url` on Pay::Charge - @mguidetti\n* Replace `update_email!` with `update_customer!` - @excid3\n* Add options for `cancel_now!` to support `invoice_now` and `prorate` flags for Stripe - @excid3\n* Adds `add_payment_processor` to add a payment processor without making it the default - @excid3\n* Setting `pay_name` in Stripe Subscription metadata will be used as the `name` on the `Pay::Subscription` - @excid3\n* `pay_customer` now supports a `stripe_attributes:` option to add attributes to Stripe::Customers - @excid3\n* `pay_customer` now supports a `braintree_attributes:` option to add attributes to Braintree::Customers - @excid3\n* `pay_customer` now supports a `default_payment_processor` option to automatically create a Pay::Customer record - @excid3\n* Added `enabled_processors` to Pay config. This lets you choose exactly which processors will be enabled. - @cjilbert504\n* Add `sync!` method to Pay::Subscription instances - @excid3\n* Ignore Stripe charges that don't have a customer ID - @excid3\n\n### 3.0.24\n\n* Make payment method and charges consistent for Fake procsesor - @excid3\n\n### 3.0.23\n\n* Merge Stripe Checkout `session_id` param into `success_url` automatically - @excid3\n\n### 3.0.22\n\n* Update to `@hotwired/stimulus` for payments view - @excid3\n* Update test/dummy app to Pay 3 - @excid3\n\n### 3.0.21\n\n* Add `update_customer` methods for SyncCustomer job - @excid3\n\n### 3.0.20\n\n* Safely handle receipts for users without `extra_billing_info` - @excid3\n\n### 3.0.19\n\n* Correctly handle cancelling a paused Paddle subscription - @excid3\n\n### 3.0.18\n\n* Add `generic_trial?` to `Pay::Subscription` for checking if fake processor trial - @excid3\n* Charge succeeded should send email even when receipts gem isn't available - @excid3\n* Update mailers to use `Pay::Customer#customer_name` - @excid3\n* Use `pay_customer` instead of `billable` in mailers - @excid3\n* Remove payment methods when cancelling Paddle subscription - @excid3\n\n### 3.0.17\n\n* Convert `paddle_paused_from` to Time - @excid3\n\n### 3.0.16\n\n* Remove hardcoded currency in emails - @excid3\n\n### 3.0.15\n\n* Accept options for `Pay::Currency.format` - @excid3\n\n### 3.0.14\n\n* Add `amount_with_currency` to `Pay::Payment` - @excid3\n\n### 3.0.13\n\n* Add `Pay::Currency` for formatting amounts with currency - @excid3\n* Add `amount_with_currency` and `amount_refunded_with_currency` to `Pay::Charge` - @excid3\n* Safer pay processor lookup when processor is blank - @excid3\n* Store `stripe_account` when syncing Stripe payment methods - @excid3\n\n### 3.0.12\n\n* Add `CHECKOUT_SESSION_ID` to checkout URLs by default and document how to add them - @excid3\n* Fix invoice bill_to to use `customer.owner` instead of `owner` - @excid3\n\n### 3.0.11\n\n* Fix Stripe charge.refunded webhook - @excid3\n\n### 3.0.10\n\n* Fix Pay::Subscription charges association - @excid3\n* Remove Pay::Charge default sort - @excid3\n\n### 3.0.9\n\n* Fix translation key - @excid3\n\n### 3.0.8\n\n* Better invoice line items format - @excid3\n\n### 3.0.7\n\n* Namespace locales under `pay` - @excid3\n* I18n receipt and invoice dates - @excid3\n* Add `business_logo` config - @excid3\n* Add `refunded?` `partial_refund?` and `full_refund?` methods to `Pay::Charge` - @excid3\n\n### 3.0.6\n\n* Fix payment method sync on customer updated - @excid3\n\n### 3.0.5\n\n* Fix Stripe customer.updated webhook - @excid3\n\n### 3.0.4\n\n* Add retries for payment method sync in case of rate limiting - @excid3\n* Add `on_generic_trial?` to Pay::Customer for easier checking - @excid3\n\n### 3.0.3\n\nYanked\n\n### 3.0.2\n\n* Add payment methods to Pay::Charge `charged_to` helper - @excid3\n* Improve `swap` error message - @excid3\n\n### 3.0.1\n\n* Add `rake pay:payment_methods:sync_default` task for easily upgrading to Pay 3 - @excid3\n\n### 3.0.0\n\nSee the [UPGRADE](UPGRADE.md) guide for steps on upgrading from Pay 2.x.\n\n* **Requires Rails 6+**\n* Migrates `processor` and `processor_id` from models to `Pay::Customer` model\n* Replaces include Pay::Billable with pay_customer method\n* Replaces include Pay::Merchant with pay_merchant method\n* Changes Pay::Charge to associate with Pay::Customer instead of `owner{polymorphic}`\n* Changes Pay::Subscription to associate with `Pay::Customer` instead of `owner{polymorphic}`\n* Migrates card fields from models to `Pay::PaymentMethod` model\n* Queues webhooks in `Pay::Webhook` for processing with ActiveJob to handle large volumes of webhooks\n* Subscriptions are automatically canceled when a Pay::Subscription deleted - @stevepolitodesign\n* Active subscriptions are canceled when a Pay::Customer's owner is deleted - @stevepolitodesign\n* Add `invoice` to Pay::Charge\n\n### 2.7.2\n\n* Don't validate SetupIntent for trialing subscriptions - @archonic\n* Validate uniqueness of charges and subscriptions - @excid3\n* Better handle out of order webhooks and race conditions - @excid3\n\n### 2.7.1\n\n* Refactor Stripe webhooks to always retrieve latest records - @excid3\n* Associate charges with subscriptions if possible - @excid3\n\n### 2.7.0\n\n* Add `Pay::Merchant` and Stripe Connect functionality - @excid3\n* Save `currency` on Pay::Charge records - @excid3\n\n### 2.6.11\n\n* Add `subscription` method to payment processor classes for direct access to the processor subscription object.\n  The owner is not guaranteed to be on the same payment processor, which can cause problems. - @excid3\n\n### 2.6.10\n\n* Improve the Stripe Checkout URLs so your Rails app doesn't need a `root_url` #309 - @excid3\n* Fix `currency` with Stripe Checkout #308 - @excid3\n\n### 2.6.9\n\n* Update Stripe & Braintree default card automatically when the customer is accessed (ie. on charge, subscribe, etc) #300 - @excid3\n\n### 2.6.8\n\n* Add passthrough fallback for paddle payment succeeded webhook #302 - @nm\n\n### 2.6.7\n\n* Add Stripe `payment_intent.succeeded` webhook listener\n\n### 2.6.6\n\n* Improve error wrappers to delegate message to original cause\n\n### 2.6.5\n\n* [NEW] Raise error if payment processor name is nil\n* [FIX] Pay::Error now uses the correct message in to_s\n* Create braintree customer on update_card if needed\n\n# 2.6.4\n\n* [NEW] Fake payment processor for testing and giving users free access to your application\n* [FIX] Delegate trial_ends_at for subscriptions - @archonic\n\n# 2.6.3\n\n* [FIX] Default to empty hash when default_url_options is nil so proper error is raised\n* [FIX] Fix inquiry when processor is nil\n\n### 2.6.2\n\n* [FIX] Correctly handle updating payment method in Stripe\n\n### 2.6.1\n\n* [NEW] Add Stripe Customer Billing Portal - @excid3\n* Include `customer` on Stripe Checkout sessions - @excid3\n\n### 2.6.0\n\n* [NEW] Stripe Checkout support - @excid3\n\n### 2.5.0\n\n* [BREAKING] Webhooks that can't be verified respond with 400 instead of 200 - @excid3\n* [BREAKING] Remove StripeEvent dependency - excid3\n* [BREAKING] Remove old configuration for mailer subjects in favor of locales - @excid3\n* [NEW] Add `Pay::Webhook.delegator` for subscribing to webhooks - @excid3\n\n### 2.4.4\n\n* [Fix] Fixed missing require for version file - @excid3\n\n### 2.4.3\n\n* Add Stripe app info and join the Stripe Partner program for better support for Pay! - @excid3\n\n### 2.4.2\n\n* [FIX] Update migration to check for symobl keys on ActiveRecord adapter with Rails 6.1 - @excid3\n\n### 2.4.1\n\n* [FIX] Move Paddle logic into paddle methods - @excid3\n\n### 2.4.0\n\n* [BREAKING] Use locales for email subjects and remove configuration - @excid3\n\n### 2.3.1\n\n* [FIX] Subject for payment action required emails referenced an invalid config - @excid3\n\n### 2.3.0\n\n* Add `data` json column to Charge and Subscription models - @excid3\n\nTo add the new migrations to your app, run:\n\n```\nrails pay:install:migrations\n```\n\n* Add Paddle initial support - @nm\n* `Pay.model_parent_class` defaults to `ApplicationRecord` - @excid3\n* Test suite now runs against sqlite, mysql, and postgresql - @excid3\n* [FIX] Lookup billable on invoice.payment_action_required events - @excid3\n\n### 2.2.2\n\n* Bugfixes\n\n### 2.2.1\n\n* [NEW] Allow passing `?back=/path/to/item` for customizing the back link for SCA payments page\n\n### 2.2.0\n\nStripe API 2020-08-27 changes:\n\n* Use `proration_behavior` instead of `prorate` for Stripe subscription changes\n* Switch to `::Stripe::Subscription.create` instead of `customer.subscriptions` as Stripe no longer includes this by default for performance\n* Set Stripe API version for easier gem management\n\n### 2.1.3\n\n* Add support for `quantity` option on `subscribe` for subscription quantities\n* Added `Pay::BraintreeAuthorizationError` to catch Braintree actions\n  with malformed data or unauthorized API access.\n\n### 2.1.2\n\n* [FIX] Remove old billable migration\n\n### 2.1.1\n\n* [FIX] The `charge` method now raises `Pay::BraintreeError` when a\n  charge fails. This makes it work consistently with the Stripe\n  implementation which raises an error on charge failure.\n\n### 2.1.0\n\n* [BREAKING] Subscription & Charge associations to `owner` are now polymorphic.\n\n  Requires adding `owner_type:string` to both Pay::Charge and Pay::Subscription models and setting the value for all existing records to your model name.\n\n```ruby\nclass AddOwnerTypeToPay < ActiveRecord::Migration[6.0]\n  def change\n    add_column :pay_charges, :owner_type, :string\n    add_column :pay_subscriptions, :owner_type, :string\n\n    # Backfill owner_type column to match your Billable model\n    Pay::Charge.update_all owner_type: \"User\"\n    Pay::Subscription.update_all owner_type: \"User\"\n  end\nend\n```\n\n  `Pay.billable_class` is now deprecated and will be removed in a future version. You should also update your existing Pay migrations to reference the `:users` table rather than `Pay.billable_class` and any other code you may have that references this method.\n\n### 2.0.3\n\n* [FIX] Stripe subscription cancel shouldn't change status\n* [FIX] Stripe test payment methods should now work (ie. `pm_card_visa`)\n\n### 2.0.2\n\n* [FIX] Styling tweaks for payment intent page\n\n### 2.0.1\n\n* [FIX] Stripe Refund and Charge references weren't matching the right\n  class\n\n### 2.0.0\n\n* [NEW] Stripe SCA support\n* [BREAKING] Requires using PaymentMethods instead of Source and Tokens\n* [BREAKING] Drops Ruby 2.4 support\n* [BREAKING] `automount_webhook_routes` config option has been renamed to `automount_routes`\n* [BREAKING]`webhooks_path` config option has been renamed to `routes_path`\n* Added `status` column to payments to keep in sync with Stripe. We're\n  also adding statuses to Braintree subscriptions to keep them in sync as best we can.\n* Added `payments#show` route to handle SCA payments that require action\n* Added webhook handler for payments that require action\n* Added `trial_period_days` when creating a subscription that works the\n  same on Stripe and Braintree\n\n### 1.0.3\n\n* Set default from email to `Pay.support_email`\n\n### 1.0.2\n\n* Add `on_trial_or_subscribed?` convenience method\n\n### 1.0.1\n\n* Removed Rails HTML Sanitizer dependency since it wasn't being used\n\n### 1.0.0\n\n* Add `stripe?`, `braintree?`, and `paypal?` to Pay::Charge\n* Add webhook mounting and path options\n\n### 1.0.0.beta4 - 2019-03-26\n\n* Makes `stripe?`, `braintree?`, and `paypal?` helper methods always\n  available on Billable.\n\n### 1.0.0.beta3 - 2019-03-12\n\n* Update migration to reference Billable instead of Users\n\n### 1.0.0.beta2 - 2019-03-11\n\n* Check ENV first when looking up keys to allow for overrides\n", "module Pay\n  class PaymentsController < ApplicationController\n    layout \"pay/application\"\n\n    before_action :set_redirect_to\n\n    def show\n      @payment = Payment.from_id(params[:id])\n    end\n\n    private\n\n    # Ensure the back parameter is a valid path\n    # This safely handles XSS or external redirects\n    def set_redirect_to\n      @redirect_to = URI.parse(params[:back].to_s).path || root_path\n    end\n  end\nend\n", "<div\n  data-controller=\"payment-intent\"\n  data-payment-intent-client-secret-value=\"<%= @payment.client_secret %>\"\n  data-payment-intent-status-value=\"<%= @payment.status %>\"\n  data-payment-intent-customer-value=\"<%= @payment.customer %>\"\n  class=\"h-screen md:flex md:justify-center md:items-center\">\n  <div class=\"w-full max-w-lg\">\n    <!-- Status Messages -->\n    <p data-payment-intent-target=\"error\" class=\"hidden items-center mb-4 bg-red-100 border border-red-200 px-5 py-2 rounded-lg text-red-500\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"flex-shrink-0 text-red-500 h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n        <path fill-rule=\"evenodd\" d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z\" clip-rule=\"evenodd\" />\n      </svg>\n\n      <span data-payment-intent-target=\"errorMessage\" class=\"ml-3\"></span>\n    </p>\n\n    <p data-payment-intent-target=\"success\" class=\"hidden items-center mb-4 bg-green-100 border border-green-200 px-5 py-4 rounded-lg text-green-700\">\n      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"flex-shrink-0 text-green-500 h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n        <path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clip-rule=\"evenodd\" />\n      </svg>\n\n      <span data-payment-intent-target=\"successMessage\" class=\"ml-3\"></span>\n    </p>\n\n    <div class=\"bg-white rounded-lg shadow-xl p-4 sm:py-6 sm:px-10 mb-5\">\n      <% if @payment.succeeded? %>\n        <h1 class=\"text-xl mt-2 mb-4 text-gray-700\"><%=t \"pay.successful.header\" %></h1>\n        <p class=\"mb-6\"><%=t \"pay.successful.description\" %></p>\n\n      <% elsif @payment.canceled? %>\n        <h1 class=\"text-xl mt-2 mb-4 text-gray-700\"><%=t \"pay.cancelled.header\" %></h1>\n        <p class=\"mb-6\"><%=t \"pay.cancelled.description\" %></p>\n\n      <% else %>\n        <div data-payment-intent-target=\"form\" id=\"payment-elements\">\n          <!-- Instructions -->\n          <h1 class=\"text-xl mt-2 mb-4 text-gray-700\"><%=t \"pay.requires_action.header\", amount: @payment.amount_with_currency %></h1>\n          <p class=\"mb-6\"><%=t \"pay.requires_action.description\" %></p>\n\n          <div data-payment-intent-target=\"cardFields\" class=\"hidden\">\n            <!-- Name -->\n            <label for=\"cardholder-name\" class=\"inline-block text-sm text-gray-700 font-semibold mb-2\"><%=t \"pay.requires_action.full_name\" %></label>\n            <input data-payment-intent-target=\"name\" id=\"cardholder-name\" type=\"text\" placeholder=\"Jane Doe\" required autofocus class=\"mt-1 mb-6 block w-full px-3 py-2 rounded-md border border-gray-300 shadow-sm focus:outline-none focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50\">\n\n            <!-- Card -->\n            <label for=\"card-element\" class=\"inline-block text-sm text-gray-700 font-semibold mb-2\"><%=t \"pay.requires_action.card\" %></label>\n            <div data-payment-intent-target=\"card\" id=\"card-element\" class=\"mt-1 mb-6 block w-full px-3 py-4 rounded-md border border-gray-300 shadow-sm focus:outline-none focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50\"></div>\n          </div>\n\n          <!-- Pay Button -->\n          <button data-payment-intent-target=\"button\" data-action=\"click->payment-intent#confirmPayment\" class=\"inline-block w-full px-4 py-3 mb-4 text-white rounded-lg bg-blue-400 hover:bg-blue-500\">\n            <%=t \"pay.requires_action.button\", amount: @payment.amount_with_currency %>\n          </button>\n        </div>\n      <% end %>\n\n      <%= sanitize link_to(t(\"pay.back\"), @redirect_to, class: \"inline-block w-full px-4 py-3 bg-gray-100 hover:bg-gray-200 text-center text-gray-600 rounded-lg\") %>\n    </div>\n\n    <p class=\"text-center text-gray-500 text-sm\">\n      \u00a9 <%= Date.current.year %> <%= Pay.business_name %> <%=t \"pay.all_rights_reserved\" %>\n    </p>\n  </div>\n</div>\n\n<script type=\"module\">\n  window.stripe = Stripe('<%= Pay::Stripe.public_key %>');\n\n  import { Application, Controller } from 'https://unpkg.com/@hotwired/stimulus'\n  const application = Application.start()\n\n  application.register('payment-intent', class extends Controller {\n    static targets = [\"error\", \"errorMessage\", \"success\", \"successMessage\", \"form\", \"button\", \"name\", \"card\", \"cardFields\"]\n    static values = {\n      clientSecret: String,\n      customer: String,\n      status: String,\n      errorMessage: String,\n      successMessage: String,\n      complete: Boolean,\n      processing: Boolean\n    }\n\n    connect() {\n      if (this.hasCardTarget) {\n        this.elements = stripe.elements()\n        this.cardElement = this.elements.create(\"card\")\n        this.cardElement.mount(this.cardTarget)\n      }\n    }\n\n    statusValueChanged() {\n      switch(this.statusValue) {\n        case \"requires_action\":\n          stripe.confirmCardPayment(this.clientSecretValue).then(this.handleConfirmResult.bind(this))\n          break;\n        case \"requires_payment_method\":\n          this.cardFieldsTarget.classList.toggle(\"hidden\", false)\n          break;\n      }\n    }\n\n    confirmPayment() {\n      this.processingValue = true\n      this.completeValue = false\n      stripe.confirmCardPayment(this.clientSecretValue, {\n        payment_method: {\n          card: this.cardElement,\n          billing_details: { name: this.nameTarget.value }\n        },\n        save_payment_method: this.customerValue != \"\",\n        setup_future_usage: 'off_session',\n      }).then(this.handleConfirmResult.bind(this))\n    }\n\n    handleConfirmResult(result) {\n      this.processingValue = false\n\n      if (result.error) {\n        if (result.error.code === 'parameter_invalid_empty' &&\n          result.error.param === 'payment_method_data[billing_details][name]') {\n          this.errorMessageValue = '<%=t \"pay.requires_action.name_missing\" %>'\n        } else {\n          this.errorMessageValue = result.error.message\n          this.statusValue = result.error.payment_intent.status\n        }\n      } else {\n        this.completeValue = true;\n        this.successMessageValue = '<%=t \"pay.requires_action.success\" %>'\n      }\n    }\n\n    completeValueChanged() {\n      if (this.hasFormTarget) {\n        this.formTarget.classList.toggle(\"hidden\", this.completeValue)\n      }\n    }\n\n    processingValueChanged() {\n      if (this.hasButtonTarget) {\n        this.buttonTarget.disabled = this.processingValue\n        this.buttonTarget.classList.toggle(\"bg-blue-400\", this.processingValue)\n        this.buttonTarget.classList.toggle(\"bg-blue-500\", !this.processingValue)\n      }\n    }\n\n    errorMessageValueChanged() {\n      this.errorMessageTarget.textContent = this.errorMessageValue\n      const enabled = (this.errorMessageValue != '')\n      this.errorTarget.classList.toggle(\"flex\", enabled)\n      this.errorTarget.classList.toggle(\"hidden\", !enabled)\n    }\n\n    successMessageValueChanged() {\n      this.successMessageTarget.textContent = this.successMessageValue\n      const enabled = (this.successMessageValue != '')\n      this.successTarget.classList.toggle(\"flex\", enabled)\n      this.successTarget.classList.toggle(\"hidden\", !enabled)\n    }\n  })\n</script>\n"], "filenames": ["CHANGELOG.md", "app/controllers/pay/payments_controller.rb", "app/views/pay/payments/show.html.erb"], "buggy_code_start_loc": [4, 4, 57], "buggy_code_end_loc": [4, 7, 58], "fixing_code_start_loc": [5, 5, 57], "fixing_code_end_loc": [8, 17, 58], "type": "CWE-79", "message": "Pay is a payments engine for Ruby on Rails 6.0 and higher. In versions prior to 6.3.2 a payments info page of Pay is susceptible to reflected Cross-site scripting. An attacker could create a working URL that renders a javascript link to a user on a Rails application that integrates Pay. This URL could be distributed via email to specifically target certain individuals. If the targeted application contains a functionality to submit user-generated content (such as comments) the attacker could even distribute the URL using that functionality. This has been patched in version 6.3.2 and above. Users are advised to upgrade. There are no known workarounds for this vulnerability.", "other": {"cve": {"id": "CVE-2023-30614", "sourceIdentifier": "security-advisories@github.com", "published": "2023-04-19T18:15:07.637", "lastModified": "2023-05-15T19:27:42.637", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Pay is a payments engine for Ruby on Rails 6.0 and higher. In versions prior to 6.3.2 a payments info page of Pay is susceptible to reflected Cross-site scripting. An attacker could create a working URL that renders a javascript link to a user on a Rails application that integrates Pay. This URL could be distributed via email to specifically target certain individuals. If the targeted application contains a functionality to submit user-generated content (such as comments) the attacker could even distribute the URL using that functionality. This has been patched in version 6.3.2 and above. Users are advised to upgrade. There are no known workarounds for this vulnerability."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 7.1, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 3.7}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:pay_project:pay:*:*:*:*:*:ruby:*:*", "versionEndExcluding": "6.3.2", "matchCriteriaId": "088D4CFF-C244-4E06-A3C4-667D1CDE88CC"}]}]}], "references": [{"url": "https://github.com/pay-rails/pay/commit/5d6283a24062bd272a524ec48415f536a67ad57f", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/pay-rails/pay/security/advisories/GHSA-cqf3-vpx7-rxhw", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}]}, "github_commit_url": "https://github.com/pay-rails/pay/commit/5d6283a24062bd272a524ec48415f536a67ad57f"}}