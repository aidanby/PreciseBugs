{"buggy_code": ["<?php\nif(!defined('OSTADMININC') || !$thisstaff || !$thisstaff->isAdmin()) die('Access Denied');\n\n$qs = array();\nif($_REQUEST['type'])\n    $qs += array('type' => $_REQUEST['type']);\n$type='D';\n\nif ($_REQUEST['type'])\n  $type=$_REQUEST['type'];\n\nif($_REQUEST['state'])\n    $qs += array('state' => $_REQUEST['state']);\n$state=__('All');\n\nif ($_REQUEST['state'])\n  $state=$_REQUEST['state'];\n\n//dates\n$startTime  =($_REQUEST['startDate'] && (strlen($_REQUEST['startDate'])>=8))?strtotime($_REQUEST['startDate']):0;\n$endTime    =($_REQUEST['endDate'] && (strlen($_REQUEST['endDate'])>=8))?strtotime($_REQUEST['endDate']):0;\nif( ($startTime && $startTime>time()) or ($startTime>$endTime && $endTime>0)){\n    $errors['err']=__('Entered date span is invalid. Selection ignored.');\n    $startTime=$endTime=0;\n} else {\n    if($startTime)\n        $qs += array('startDate' => $_REQUEST['startDate']);\n    if($endTime)\n        $qs += array('endDate' => $_REQUEST['endDate']);\n}\n$order = AuditEntry::getOrder($_REQUEST['order']);\n$qs += array('order' => (($order=='DESC') ? 'ASC' : 'DESC'));\n$qstr = '&amp;'. Http::build_query($qs);\n\n$args = array();\nparse_str($_SERVER['QUERY_STRING'], $args);\nunset($args['p'], $args['_pjax']);\n\n// Apply pagination\n$events = AuditEntry::getTableInfo('AuditEntry');\n$total = count($events);\n$qwhere = AuditEntry::getQwhere('AuditEntry');\n$pageNav=AuditEntry::getPageNav($qwhere);\n$pageNav->setURL('audits.php', $args);\n?>\n\n<div id=\"basic_search\">\n    <div style=\"height:25px\">\n        <div id='filter' >\n            <form action=\"audits.php\" method=\"get\">\n                <div style=\"padding-left:2px;\">\n                    <i class=\"help-tip icon-question-sign\" href=\"#date_span\"></i>\n                    <?php echo __('Between'); ?>:\n                    <input class=\"dp\" id=\"sd\" size=15 name=\"startDate\" value=\"<?php echo Format::htmlchars($_REQUEST['startDate']); ?>\" autocomplete=OFF>\n                    &nbsp;&nbsp;\n                    <input class=\"dp\" id=\"ed\" size=15 name=\"endDate\" value=\"<?php echo Format::htmlchars($_REQUEST['endDate']); ?>\" autocomplete=OFF>\n                    &nbsp;<?php echo __('Type'); ?>:&nbsp;<i class=\"help-tip icon-question-sign\" href=\"#type\"></i>\n                    <select name='type'>\n                        <?php\n                        foreach (AuditEntry::getTypes() as $abbrev => $info) {\n                            $name = AuditEntry::getObjectName($info[0]);\n                            ?>\n                            <option value=\"<?php echo $abbrev; ?>\"\n                            <?php echo ($type==$abbrev)?'selected=\"selected\"':''; ?>>\n                            <?php echo __($name); ?>\n                          </option>\n                        <?php  } ?>\n                        ?>\n                    </select>\n                    &nbsp;<?php echo __('Events'); ?>:&nbsp;<i class=\"help-tip icon-question-sign\" href=\"#events\"></i>\n                    <select name='state'>\n                        <?php\n                        foreach (Event::getStates(true) as $title) {\n                            ?>\n                            <option value=\"<?php echo $title; ?>\"\n                              <?php echo ($state==$title)?'selected=\"selected\"':''; ?>>\n                              <?php echo __($title); ?>\n                            </option>\n                        <?php  } ?>\n                        ?>\n                    </select>\n                    &nbsp;&nbsp;\n                    <input type=\"submit\" Value=\"<?php echo __('Go!');?>\" />\n                </div>\n            </form>\n        </div>\n    </div>\n</div>\n<div class=\"error\"><?php echo $errors['err']; ?></div>\n<div class=\"clear\"></div>\n<form action=\"audits.php\" method=\"POST\" name=\"audits\">\n    <div style=\"margin-bottom:20px; padding-top:5px;\">\n        <div class=\"sticky bar opaque\">\n            <div class=\"content\">\n                <div class=\"pull-left flush-left\">\n                    <h2><?php echo __('Audit Logs');?>\n            <i class=\"help-tip icon-question-sign\" href=\"#audit_logs\"></i>\n            </h2>\n                </div>\n            </div>\n        </div>\n    </div>\n<?php csrf_token(); ?>\n <div class=\"pull-right\" style=\"margin-top:5px;\">\n    <?php\n     if ($total)\n         echo '<strong>'.$pageNav->showing().'</strong>';\n     else\n        echo __('No audits found');\n    ?>\n </div>\n\n <table class=\"list\" id=\"dashboard-audit\" style=\"width:100%\">\n     <thead>\n     <tr>\n         <th>Description</th>\n         <th><a <?php echo $timestamp_sort; ?> href=\"audits.php?<?php echo $qstr; ?>&sort=timestamp\"><?php echo __('Timestamp');?></a></th>\n         <th>IP Address</th>\n     </tr>\n     </thead>\n     <tbody>\n         <?php\n              foreach ($events as $data) { ?>\n                <tr audit-id=\"<?php echo $data['id']; ?>\">\n                    <td><?php echo $data['description']; ?></td>\n                    <td><?php echo $data['timestamp']; ?></td>\n                    <td><?php echo $data['ip']; ?></td>\n                </tr>\n              <?php\n              }\n              ?>\n       </tbody>\n       <?php if (!$total){ ?>\n       <tfoot>\n        <tr>\n           <td colspan=\"6\">\n               <?php echo __('No Audits found'); ?>\n           </td>\n        </tr>\n       </tfoot>\n     <?php }?>\n   </table>\n<?php\necho '<div>';\nif ($total) { //Show options..\n    echo '&nbsp;'.__('Page').':'.$pageNav->getPageLinks().'&nbsp;';\n}\necho sprintf('<a href=\"#audit/export/%s/%s\" id=\"%s\" class=\"no-pjax nomodalexport\">%s</a>',\n    $type,\n    $state,\n    'audit-export',\n    __('Export'));\n?>\n</form>\n"], "fixing_code": ["<?php\nif(!defined('OSTADMININC') || !$thisstaff || !$thisstaff->isAdmin()) die('Access Denied');\n\n$qs = array();\nif($_REQUEST['type'])\n    $qs += array('type' => Format::htmlchars($_REQUEST['type']));\n$type='D';\n\nif ($_REQUEST['type'])\n  $type=Format::htmlchars($_REQUEST['type']);\n\nif($_REQUEST['state'])\n    $qs += array('state' => Format::htmlchars($_REQUEST['state']));\n$state=__('All');\n\nif ($_REQUEST['state'])\n  $state=Format::htmlchars($_REQUEST['state']);\n\n//dates\n$startTime  =($_REQUEST['startDate'] && (strlen($_REQUEST['startDate'])>=8))?strtotime($_REQUEST['startDate']):0;\n$endTime    =($_REQUEST['endDate'] && (strlen($_REQUEST['endDate'])>=8))?strtotime($_REQUEST['endDate']):0;\nif( ($startTime && $startTime>time()) or ($startTime>$endTime && $endTime>0)){\n    $errors['err']=__('Entered date span is invalid. Selection ignored.');\n    $startTime=$endTime=0;\n} else {\n    if($startTime)\n        $qs += array('startDate' => $_REQUEST['startDate']);\n    if($endTime)\n        $qs += array('endDate' => $_REQUEST['endDate']);\n}\n$order = AuditEntry::getOrder(Format::htmlchars($_REQUEST['order']));\n$qs += array('order' => (($order=='DESC') ? 'ASC' : 'DESC'));\n$qstr = '&amp;'. Http::build_query($qs);\n\n$args = array();\nparse_str($_SERVER['QUERY_STRING'], $args);\nunset($args['p'], $args['_pjax']);\n\n// Apply pagination\n$events = AuditEntry::getTableInfo('AuditEntry');\n$total = count($events);\n$qwhere = AuditEntry::getQwhere('AuditEntry');\n$pageNav=AuditEntry::getPageNav($qwhere);\n$pageNav->setURL('audits.php', $args);\n?>\n\n<div id=\"basic_search\">\n    <div style=\"height:25px\">\n        <div id='filter' >\n            <form action=\"audits.php\" method=\"get\">\n                <div style=\"padding-left:2px;\">\n                    <i class=\"help-tip icon-question-sign\" href=\"#date_span\"></i>\n                    <?php echo __('Between'); ?>:\n                    <input class=\"dp\" id=\"sd\" size=15 name=\"startDate\" value=\"<?php echo Format::htmlchars($_REQUEST['startDate']); ?>\" autocomplete=OFF>\n                    &nbsp;&nbsp;\n                    <input class=\"dp\" id=\"ed\" size=15 name=\"endDate\" value=\"<?php echo Format::htmlchars($_REQUEST['endDate']); ?>\" autocomplete=OFF>\n                    &nbsp;<?php echo __('Type'); ?>:&nbsp;<i class=\"help-tip icon-question-sign\" href=\"#type\"></i>\n                    <select name='type'>\n                        <?php\n                        foreach (AuditEntry::getTypes() as $abbrev => $info) {\n                            $name = AuditEntry::getObjectName($info[0]);\n                            ?>\n                            <option value=\"<?php echo $abbrev; ?>\"\n                            <?php echo ($type==$abbrev)?'selected=\"selected\"':''; ?>>\n                            <?php echo __($name); ?>\n                          </option>\n                        <?php  } ?>\n                        ?>\n                    </select>\n                    &nbsp;<?php echo __('Events'); ?>:&nbsp;<i class=\"help-tip icon-question-sign\" href=\"#events\"></i>\n                    <select name='state'>\n                        <?php\n                        foreach (Event::getStates(true) as $title) {\n                            ?>\n                            <option value=\"<?php echo $title; ?>\"\n                              <?php echo ($state==$title)?'selected=\"selected\"':''; ?>>\n                              <?php echo __($title); ?>\n                            </option>\n                        <?php  } ?>\n                        ?>\n                    </select>\n                    &nbsp;&nbsp;\n                    <input type=\"submit\" Value=\"<?php echo __('Go!');?>\" />\n                </div>\n            </form>\n        </div>\n    </div>\n</div>\n<div class=\"error\"><?php echo $errors['err']; ?></div>\n<div class=\"clear\"></div>\n<form action=\"audits.php\" method=\"POST\" name=\"audits\">\n    <div style=\"margin-bottom:20px; padding-top:5px;\">\n        <div class=\"sticky bar opaque\">\n            <div class=\"content\">\n                <div class=\"pull-left flush-left\">\n                    <h2><?php echo __('Audit Logs');?>\n            <i class=\"help-tip icon-question-sign\" href=\"#audit_logs\"></i>\n            </h2>\n                </div>\n            </div>\n        </div>\n    </div>\n<?php csrf_token(); ?>\n <div class=\"pull-right\" style=\"margin-top:5px;\">\n    <?php\n     if ($total)\n         echo '<strong>'.$pageNav->showing().'</strong>';\n     else\n        echo __('No audits found');\n    ?>\n </div>\n\n <table class=\"list\" id=\"dashboard-audit\" style=\"width:100%\">\n     <thead>\n     <tr>\n         <th>Description</th>\n         <th><a <?php echo $timestamp_sort; ?> href=\"audits.php?<?php echo $qstr; ?>&sort=timestamp\"><?php echo __('Timestamp');?></a></th>\n         <th>IP Address</th>\n     </tr>\n     </thead>\n     <tbody>\n         <?php\n              foreach ($events as $data) { ?>\n                <tr audit-id=\"<?php echo $data['id']; ?>\">\n                    <td><?php echo $data['description']; ?></td>\n                    <td><?php echo $data['timestamp']; ?></td>\n                    <td><?php echo $data['ip']; ?></td>\n                </tr>\n              <?php\n              }\n              ?>\n       </tbody>\n       <?php if (!$total){ ?>\n       <tfoot>\n        <tr>\n           <td colspan=\"6\">\n               <?php echo __('No Audits found'); ?>\n           </td>\n        </tr>\n       </tfoot>\n     <?php }?>\n   </table>\n<?php\necho '<div>';\nif ($total) { //Show options..\n    echo '&nbsp;'.__('Page').':'.$pageNav->getPageLinks().'&nbsp;';\n}\necho sprintf('<a href=\"#audit/export/%s/%s\" id=\"%s\" class=\"no-pjax nomodalexport\">%s</a>',\n    $type,\n    $state,\n    'audit-export',\n    __('Export'));\n?>\n</form>\n"], "filenames": ["audit/templates/auditlogs.tmpl.php"], "buggy_code_start_loc": [6], "buggy_code_end_loc": [32], "fixing_code_start_loc": [6], "fixing_code_end_loc": [32], "type": "CWE-79", "message": "Cross Site Scripting (XSS) vulnerability in audit/templates/auditlogs.tmpl.php in osTicket osTicket-plugins before commit a7842d494889fd5533d13deb3c6a7789768795ae.", "other": {"cve": {"id": "CVE-2022-31889", "sourceIdentifier": "cve@mitre.org", "published": "2023-04-05T22:15:07.220", "lastModified": "2023-04-12T19:18:23.390", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Cross Site Scripting (XSS) vulnerability in audit/templates/auditlogs.tmpl.php in osTicket osTicket-plugins before commit a7842d494889fd5533d13deb3c6a7789768795ae."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:enhancesoft:audit_log:*:*:*:*:*:osticket:*:*", "versionEndExcluding": "2022-04-21", "matchCriteriaId": "B57B9660-8763-4663-BD09-FA1CA69E9E54"}]}]}], "references": [{"url": "https://checkmarx.com/blog/securing-open-source-solutions-a-study-of-osticket-vulnerabilities/", "source": "cve@mitre.org", "tags": ["Exploit", "Third Party Advisory"]}, {"url": "https://github.com/osTicket/osTicket-plugins/commit/047a1c3ae4f12f8952bbdad8143d5b74fdac14b1", "source": "cve@mitre.org", "tags": ["Patch"]}]}, "github_commit_url": "https://github.com/osTicket/osTicket-plugins/commit/047a1c3ae4f12f8952bbdad8143d5b74fdac14b1"}}