{"buggy_code": ["# Changelog\n\nAll notable, unreleased changes to this project will be documented in this file. For the released changes, please visit the [Releases](https://github.com/mirumee/saleor/releases) page.\n\n\n# Unreleased\n\n### Breaking changes\n\n### Other changes\n- Filter Customer/Order/Sale/Product/ProductVariant by datetime of last modification - #9137 by @rafalp\n- Add possibility for plugins to execute code before each mutation - #9193 by @NyanKiyoshi\n- Add support for hiding plugins - #9219 by @NyanKiyoshi\n- Remove `graphene-federation` dependency - #9184 by @rafalp\n\n\n# 3.1.0\n\n### Breaking changes\n\n#### Plugins\n\n- Don't run plugins when calculating checkout's total price for available shipping methods resolution - #9121 by @rafalp\n  - Use either net or gross price depending on store configuration.\n\n### Other changes\n\n#### Saleor Apps\n\n- Add API for webhook payloads and deliveries - #8227 by @jakubkuc\n- Extend app by `AppExtension` - #7701 by @korycins\n- Add webhooks for stock changes: `PRODUCT_VARIANT_OUT_OF_STOCK` and `PRODUCT_VARIANT_BACK_IN_STOCK` - #7590 by @mstrumeck\n- Add `COLLECTION_CREATED`, `COLLECTION_UPDATED`, `COLLECTION_DELETED` events and webhooks - #8974 by @rafalp\n- Add draft orders webhooks by @jakubkuc\n- Add support for providing shipping methods by Saleor Apps - #7975 by @bogdal:\n  - Add `SHIPPING_LIST_METHODS_FOR_CHECKOUT` sync webhook\n- Add sales webhooks - #8157 @kuchichan\n- Allow fetching unpublished pages by apps with manage pages permission - #9181 by @IKarbowiak\n\n#### Metadata\n- Add ability to use metadata mutations with tokens as an identifier for orders and checkouts - #8426 by @IKarbowiak\n\n#### Attributes\n- Introduce swatch attributes - #7261 by @IKarbowiak\n- Add `variant_selection` to `ProductAttributeAssign` operations - #8235 by @kuchichan\n- Refactor attributes validation - #8905 by @IKarbowiak\n  - in create mutations: require all required attributes\n  - in update mutations: do not require providing any attributes; when any attribute is given, validate provided values.\n\n#### Other features and changes\n- Add gift cards - #7827 by @IKarbowiak, @tomaszszymanski129\n- Add Click & Collect - #7673 by @kuchichan\n- Add fulfillment confirmation - #7675 by @tomaszszymanski129\n- Make SKU an optional field on `ProductVariant` - #7633 by @rafalp\n- Possibility to pass metadata in input of `checkoutPaymentCreate` - #8076 by @mateuszgrzyb\n- Add `ExternalNotificationTrigger` mutation - #7821 by @mstrumeck\n- Extend `accountRegister` mutation to consume first & last name - #8184 by @piotrgrundas\n- Introduce sales/vouchers per product variant - #8064 by @kuchichan\n- Batch loads in queries for Apollo Federation - #8273 by @rafalp\n- Reserve stocks for checkouts - #7589 by @rafalp\n- Add query complexity limit to GraphQL API - #8526 by @rafalp\n- Add `quantity_limit_per_customer` field to ProductVariant #8405 by @kuchichan\n- Make collections names non-unique - #8986 by @rafalp\n- Add validation of unavailable products in the checkout. Mutations: `CheckoutShippingMethodUpdate`,\n  `CheckoutAddPromoCode`, `CheckoutPaymentCreate` will raise a ValidationError when product in the checkout is\n  unavailable - #8978 by @IKarbowiak\n- Add `withChoices` flag for Attribute type - #7733 by @dexon44\n- Update required permissions for attribute options - #9204 by @IKarbowiak\n  - Product attribute options can be fetched by requestors with manage product types and attributes permission.\n  - Page attribute options can be fetched by requestors with manage page types and attributes permission.\n- Deprecate interface field `PaymentData.reuse_source` - #7988 by @mateuszgrzyb\n- Deprecate `setup_future_usage` from `checkoutComplete.paymentData` input - will be removed in Saleor 4.0 - #7994 by @mateuszgrzyb\n- Fix shipping address issue in `availableCollectionPoints` resolver for checkout - #8143 by @kuchichan\n- Fix cursor-based pagination in products search - #8011 by @rafalp\n- Fix crash when querying external shipping methods `translation` field - #8971 by @rafalp\n- Fix crash when too long translation strings were passed to `translate` mutations - #8942 by @rafalp\n- Raise ValidationError in `CheckoutAddPromoCode`, `CheckoutPaymentCreate` when product in the checkout is\nunavailable - #8978 by @IKarbowiak\n- Remove `graphene-django` dependency - #9170 by @rafalp\n\n\n# 3.0.0\n\n### Breaking changes\n\n#### Behavior\n\n- Add multichannel - #6242 by @fowczarek @d-wysocki\n- Add email interface as a plugin - #6301 by @korycins\n- Add unconfirmed order editing - #6829 by @tomaszszymanski129\n  - Removed mutations for draft order lines manipulation: `draftOrderLinesCreate`, `draftOrderLineDelete`, `draftOrderLineUpdate`\n  - Added instead: `orderLinesCreate`, `orderLineDelete`, `orderLineUpdate` mutations instead.\n  - Order events enums `DRAFT_ADDED_PRODUCTS` and `DRAFT_REMOVED_PRODUCTS` are now `ADDED_PRODUCTS` and `REMOVED_PRODUCTS`\n- Remove resolving users location from GeoIP; drop `PaymentInput.billingAddress` input field - #6784 by @maarcingebala\n- Always create new checkout in `checkoutCreate` mutation - #7318 by @IKarbowiak\n  - deprecate `created` return field on `checkoutCreate` mutation\n- Return empty values list for attribute without choices - #7394 by @fowczarek\n  - `values` for attributes without choices from now are empty list.\n  - attributes with choices - `DROPDOWN` and `MULTISELECT`\n  - attributes without choices - `FILE`, `REFERENCE`, `NUMERIC` and `RICH_TEXT`\n- Unify checkout identifier in checkout mutations and queries - #7511 by @IKarbowiak\n- Propagate sale and voucher discounts over specific lines - #8793 by @korycins\n  - Use a new interface for response received from plugins/pluginManager. Methods `calculate_checkout_line_unit_price`\n    and `calculate_checkout_line_total` returns `TaxedPricesData` instead of `TaxedMoney`.\n- Attach sale discount info to the line when adding variant to order - #8821 by @IKarbowiak\n  - Use a new interface for the response received from plugins/pluginManager.\n    Methods `calculate_order_line_unit` and `calculate_order_line_total` returns\n    `OrderTaxedPricesData` instead of `TaxedMoney`.\n  - Rename checkout interfaces: `CheckoutTaxedPricesData` instead of `TaxedPricesData`\n    and `CheckoutPricesData` instead of `PricesData`\n- Sign JWT tokens with RS256 instead of HS256 - #7990 by @korycins\n- Add support for filtering available shipping methods by Saleor Apps - #8399 by @kczan, @stnatic\n  - Introduce `ShippingMethodData` interface as a root object type for ShippingMethod object\n- Limit number of user addresses - #9173 by @IKarbowiak\n\n#### GraphQL Schema\n\n- Drop deprecated meta mutations - #6422 by @maarcingebala\n- Drop deprecated service accounts and webhooks API - #6431 by @maarcingebala\n- Drop deprecated fields from the `ProductVariant` type: `quantity`, `quantityAllocated`, `stockQuantity`, `isAvailable` - #6436 by @maarcingebala\n- Drop authorization keys API - #6631 by @maarcingebala\n- Drop `type` field from `AttributeValue` type - #6710 by @IKarbowiak\n- Drop deprecated `taxRate` field from `ProductType` - #6795 by @d-wysocki\n- Drop deprecated queries and mutations - #7199 by @IKarbowiak\n  - drop `url` field from `Category` type\n  - drop `url` field from `Category` type\n  - drop `url` field from `Product` type\n  - drop `localized` fild from `Money` type\n  - drop `permissions` field from `User` type\n  - drop `navigation` field from `Shop` type\n  - drop `isActive` from `AppInput`\n  - drop `value` from `AttributeInput`\n  - drop `customerId` from `checkoutCustomerAttach`\n  - drop `stockAvailability` argument from `products` query\n  - drop `created` and `status` arguments from `orders` query\n  - drop `created` argument from `draftOrders` query\n  - drop `productType` from `ProductFilter`\n  - deprecate specific error fields `<TypeName>Errors`, typed `errors` fields and remove deprecation\n- Drop top-level `checkoutLine` query from the schema with related resolver, use `checkout` query instead - #7623 by @dexon44\n- Change error class in `CollectionBulkDelete` to `CollectionErrors` - #7061 by @d-wysocki\n- Make quantity field on `StockInput` required - #7082 by @IKarbowiak\n- Add description to shipping method - #7116 by @IKarbowiak\n  - `ShippingMethod` was extended with `description` field.\n  - `ShippingPriceInput` was extended with `description` field\n  - Extended `shippingPriceUpdate`, `shippingPriceCreate` mutation to add/edit description\n  - Input field in `shippingPriceTranslate` changed to `ShippingPriceTranslationInput`\n- Split `ShippingMethod` into `ShippingMethod` and `ShippingMethodType` (#8399):\n  - `ShippingMethod` is used to represent methods offered for checkouts and orders\n  - `ShippingMethodType` is used to manage shipping method configurations in Saleor\n  - Deprecate `availableShippingMethods` on `Order` and `Checkout`. Use `shippingMethods` and refer to the `active` field instead\n\n#### Saleor Apps\n\n- Drop `CHECKOUT_QUANTITY_CHANGED` webhook - #6797 by @d-wysocki\n- Change the payload of the order webhook to handle discounts list - #6874 by @korycins:\n  - added fields: `Order.discounts`, `OrderLine.unit_discount_amount`, `OrderLine.unit_discount_type`, `OrderLine.unit_discount_reason`,\n  - removed fields: `Order.discount_amount`, `Order.discount_name`, `Order.translated_discount_name`\n- Remove triggering a webhook event `PRODUCT_UPDATED` when calling `ProductVariantCreate` mutation. Use `PRODUCT_VARIANT_CREATED` instead - #6963 by @piotrgrundas\n- Make `order` property of invoice webhook payload contain order instead of order lines - #7081 by @pdblaszczyk\n  - Affected webhook events: `INVOICE_REQUESTED`, `INVOICE_SENT`, `INVOICE_DELETED`\n- Added `CHECKOUT_FILTER_SHIPPING_METHODS`, `ORDER_FILTER_SHIPPING_METHODS` sync webhooks - #8399 by @kczan, @stnatic\n\n#### Plugins\n\n- Drop `apply_taxes_to_shipping_price_range` plugin hook - #6746 by @maarcingebala\n- Refactor listing payment gateways - #7050 by @maarcingebala:\n  - Breaking changes in plugin methods: removed `get_payment_gateway` and `get_payment_gateway_for_checkout`; instead `get_payment_gateways` was added.\n- Improve checkout performance - introduce `CheckoutInfo` data class - #6958 by @IKarbowiak;\n  - Introduced changes in plugin methods definitions in the following methods, the `checkout` parameter changed to `checkout_info`:\n    - `calculate_checkout_total`\n    - `calculate_checkout_subtotal`\n    - `calculate_checkout_shipping`\n    - `get_checkout_shipping_tax_rate`\n    - `calculate_checkout_line_total`\n    - `calculate_checkout_line_unit_price`\n    - `get_checkout_line_tax_rate`\n    - `preprocess_order_creation`\n  - `preprocess_order_creation` was extend with `lines_info` parameter\n- Fix Avalara caching - #7036 by @fowczarek:\n  - Introduced changes in plugin methods definitions:\n    - `calculate_checkout_line_total` was extended with `lines` parameter\n    - `calculate_checkout_line_unit_price` was extended with `lines` parameter\n    - `get_checkout_line_tax_rate` was extended with `lines` parameter\n  - To get proper taxes we should always send the whole checkout to Avalara.\n- Extend plugins manager to configure plugins for each plugins - #7198 by @korycins:\n  - Introduce changes in API:\n    - `paymentInitialize` - add `channel` parameter. Optional when only one channel exists.\n    - `pluginUpdate` - add `channel` parameter.\n    - `availablePaymentGateways` - add `channel` parameter.\n    - `storedPaymentSources` - add `channel` parameter.\n    - `requestPasswordReset` - add `channel` parameter.\n    - `requestEmailChange` - add `channel` parameter.\n    - `confirmEmailChange` - add `channel` parameter.\n    - `accountRequestDeletion` - add `channel` parameter.\n    - change structure of type `Plugin`:\n      - add `globalConfiguration` field for storing configuration when a plugin is globally configured\n      - add `channelConfigurations` field for storing plugin configuration for each channel\n      - removed `configuration` field, use `globalConfiguration` and `channelConfigurations` instead\n    - change structure of input `PluginFilterInput`:\n      - add `statusInChannels` field\n      - add `type` field\n      - removed `active` field. Use `statusInChannels` instead\n  - Change plugin webhook endpoint - #7332 by @korycins.\n    - Use /plugins/channel/<channel_slug>/<plugin_id> for plugins with channel configuration\n    - Use /plugins/global/<plugin_id> for plugins with global configuration\n    - Remove /plugin/<plugin_id> endpoint\n- Fix doubling price in checkout for products without tax - #7056 by @IKarbowiak:\n  - Introduce changes in plugins method:\n    - `calculate_checkout_subtotal` has been dropped from plugins;\n    - for correct subtotal calculation, `calculate_checkout_line_total` must be set (manager method for calculating checkout subtotal uses `calculate_checkout_line_total` method)\n- Deprecated Stripe plugin - will be removed in Saleor 4.0\n  - rename `StripeGatewayPlugin` to `DeprecatedStripeGatewayPlugin`.\n  - introduce new `StripeGatewayPlugin` plugin.\n\n### Other changes\n\n#### Features\n\n- Migrate from Draft.js to Editor.js format - #6430, #6456 by @IKarbowiak\n- Allow using `Bearer` as an authorization prefix - #6996 by @korycins\n- Add product rating - #6284 by @korycins\n- Add order confirmation - #6498 by @tomaszszymanski12\n- Extend Vatlayer functionalities - #7101 by @korycins:\n  - Allow users to enter a list of exceptions (country ISO codes) that will use the source country rather than the destination country for tax purposes.\n  - Allow users to enter a list of countries for which no VAT will be added.\n- Extend order with origin and original order values - #7326 by @IKarbowiak\n- Allow impersonating user by an app/staff - #7754 by @korycins:\n  - Add `customerId` to `checkoutCustomerAttach` mutation\n  - Add new permission `IMPERSONATE_USER`\n- Add possibility to apply a discount to order/order line with status `DRAFT` - #6930 by @korycins\n- Implement database read replicas - #8516, #8751 by @fowczarek\n- Propagate sale and voucher discounts over specific lines - #8793 by @korycins\n  - The created order lines from checkout will now have fulfilled all undiscounted fields with a default price value\n    (without any discounts).\n  - Order line will now include a voucher discount (in the case when the voucher is for specific products or have a\n    flag apply_once_per_order). In that case, `Order.discounts` will not have a relation to `OrderDiscount` object.\n  - Webhook payload for `OrderLine` will now include two new fields, `sale_id` (graphql ID of applied sale) and\n    `voucher_code` (code of the valid voucher applied to this line).\n  - When any sale or voucher discount was applied, `line.discount_reason` will be fulfilled.\n  - New interface for handling more data for prices: `PricesData` and `TaxedPricesData` used in checkout calculations\n    and in plugins/pluginManager.\n- Attach sale discount info to the line when adding variant to order - #8821 by @IKarbowiak\n  - Rename checkout interfaces: `CheckoutTaxedPricesData` instead of `TaxedPricesData`\n    and `CheckoutPricesData` instead of `PricesData`\n  - New interface for handling more data for prices: `OrderTaxedPricesData` used in plugins/pluginManager.\n- Add uploading video URLs to product gallery - #6838 by @GrzegorzDerdak\n- Add generic `FileUpload` mutation - #6470 by @IKarbowiak\n\n#### Metadata\n- Allow passing metadata to `accountRegister` mutation - #7152 by @piotrgrundas\n- Copy metadata fields when creating reissue - #7358 by @IKarbowiak\n- Add metadata to shipping zones and shipping methods - #6340 by @maarcingebala\n- Add metadata to menu and menu item - #6648 by @tomaszszymanski129\n- Add metadata to warehouse - #6727 by @d-wysocki\n- Added support for querying objects by metadata fields - #6683 by @LeOndaz, #7421 by @korycins\n- Change metadata mutations to use token for order and checkout as an identifier - #8542 by @IKarbowiak\n  - After changes, using the order `id` for changing order metadata is deprecated\n\n#### Attributes\n- Add rich text attribute input - #7059 by @piotrgrundas\n- Support setting value for AttributeValue mutations - #7037 by @piotrgrundas\n- Add boolean attributes - #7454 by @piotrgrundas\n- Add date & date time attributes - #7500 by @piotrgrundas\n- Add file attributes - #6568 by @IKarbowiak\n- Add page reference attributes - #6624 by @IKarbowiak\n- Add product reference attributes - #6711 by @IKarbowiak\n- Add numeric attributes - #6790 by @IKarbowiak\n- Add `withChoices` flag for Attribute type - #7733 by @CossackDex\n- Return empty results when filtering by non-existing attribute - #7025 by @maarcingebala\n- Add Page Types - #6261 by @IKarbowiak\n\n#### Plugins\n- Add interface for integrating the auth plugins - #6799 by @korycins\n- Add Sendgrid plugin - #6793 by @korycins\n- Trigger `checkout_updated` plugin method for checkout metadata mutations - #7392 by @maarcingebala\n\n#### Saleor Apps\n- Add synchronous payment webhooks - #7044 by @maarcingebala\n- Add `CUSTOMER_UPDATED` webhook, add addresses field to customer `CUSTOMER_CREATED` webhook - #6898 by @piotrgrundas\n- Add `PRODUCT_VARIANT_CREATED`, `PRODUCT_VARIANT_UPDATED`, `PRODUCT_VARIANT_DELETED` webhooks, fix attributes field for `PRODUCT_CREATED`, `PRODUCT_UPDATED` webhooks - #6963 by @piotrgrundas\n- Trigger `PRODUCT_UPDATED` webhook for collections and categories mutations - #7051 by @d-wysocki\n- Extend order webhook payload with fulfillment fields - #7364, #7347 by @korycins\n  - fulfillments extended with:\n    - `total_refund_amount`\n    - `shipping_refund_amount`\n    - `lines`\n  - fulfillment lines extended with:\n    - `total_price_net_amount`\n    - `total_price_gross_amount`\n    - `undiscounted_unit_price_net`\n    - `undiscounted_unit_price_gross`\n    - `unit_price_net`\n- Extend order payload with undiscounted prices and add psp_reference to payment model - #7339 by @IKarbowiak\n  - order payload extended with the following fields:\n    - `undiscounted_total_net_amount`\n    - `undiscounted_total_gross_amount`\n    - `psp_reference` on `payment`\n  - order lines extended with:\n    - `undiscounted_unit_price_net_amount`\n    - `undiscounted_unit_price_gross_amount`\n    - `undiscounted_total_price_net_amount`\n    - `undiscounted_total_price_gross_amount`\n- Add `product_id`, `product_variant_id`, `attribute_id` and `page_id` when it is possible for `AttributeValue` translations webhook - #7783 by @fowczarek\n- Add draft orders webhooks - #8102 by @jakubkuc\n- Add page webhooks: `PAGE_CREATED`, `PAGE_UPDATED` and `PAGE_DELETED` - #6787 by @d-wysocki\n- Add `PRODUCT_DELETED` webhook - #6794 by @d-wysocki\n- Add `page_type_id` in translations webhook - #7825 by @fowczarek\n- Fix failing account mutations for app - #7569 by @IKarbowiak\n- Add app support for events - #7622 by @IKarbowiak\n- Fix creating translations with app - #6804 by @krzysztofwolski\n- Change the `app` query to return info about the currently authenticated app - #6928 by @d-wysocki\n- Mark `X-` headers as deprecated and add headers without prefix. All deprecated headers will be removed in Saleor 4.0 - #8179 by @L3str4nge\n  - X-Saleor-Event -> Saleor-Event\n  - X-Saleor-Domain -> Saleor-Domain\n  - X-Saleor-Signature -> Saleor-Signature\n  - X-Saleor-HMAC-SHA256 -> Saleor-HMAC-SHA256\n\n#### Other changes\n- Add query contains only schema validation - #6827 by @fowczarek\n- Add introspection caching - #6871 by @fowczarek\n- Fix Sentry reporting - #6902 by @fowczarek\n- Deprecate API fields `Order.discount`, `Order.discountName`, `Order.translatedDiscountName` - #6874 by @korycins\n- Fix argument validation in page resolver - #6960 by @fowczarek\n- Drop `data` field from checkout line model - #6961 by @fowczarek\n- Fix `totalCount` on connection resolver without `first` or `last` - #6975 by @fowczarek\n- Fix variant resolver on `DigitalContent` - #6983 by @fowczarek\n- Fix resolver by id and slug for product and product variant - #6985 by @d-wysocki\n- Add optional support for reporting resource limits via a stub field in `shop` - #6967 by @NyanKiyoshi\n- Update checkout quantity when checkout lines are deleted - #7002 by @IKarbowiak\n- Fix available shipping methods - return also weight methods without weight limits - #7021 by @IKarbowiak\n- Validate discount value for percentage vouchers and sales - #7033 by @d-wysocki\n- Add field `languageCode` to types: `AccountInput`, `AccountRegisterInput`, `CheckoutCreateInput`, `CustomerInput`, `Order`, `User`. Add field `languageCodeEnum` to `Order` type. Add new mutation `CheckoutLanguageCodeUpdate`. Deprecate field `Order.languageCode`. - #6609 by @korycins\n- Extend `Transaction` type with gateway response and `Payment` type with filter - #7062 by @IKarbowiak\n- Fix invalid tax rates for lines - #7058 by @IKarbowiak\n- Allow seeing unconfirmed orders - #7072 by @IKarbowiak\n- Raise `GraphQLError` when too big integer value is provided - #7076 by @IKarbowiak\n- Do not update draft order addresses when user is changing - #7088 by @IKarbowiak\n- Recalculate draft order when product/variant was deleted - #7085 by @d-wysocki\n- Added validation for `DraftOrderCreate` with negative quantity line - #7085 by @d-wysocki\n- Remove HTML tags from product `description_plaintext` - #7094 by @d-wysocki\n- Fix failing product tasks when instances are removed - #7092 by @IKarbowiak\n- Update GraphQL endpoint to only match exactly `/graphql/` without trailing characters - #7117 by @IKarbowiak\n- Introduce `traced_resolver` decorator instead of Graphene middleware - #7159 by @tomaszszymanski129\n- Fix failing export when exporting attribute without values - #7131 by @IKarbowiak\n- Fix incorrect payment data for Klarna - #7150 by @IKarbowiak\n- Drop deleted images from storage - #7129 by @IKarbowiak\n- Fix export with empty assignment values - #7214 by @IKarbowiak\n- Change exported file name - #7222 by @IKarbowiak\n- Fix core sorting on related fields - #7195 by @tomaszszymanski129\n- Use GraphQL IDs instead of database IDs in export - #7240 by @IKarbowiak\n- Fix draft order tax mismatch - #7226 by @IKarbowiak\n  - Introduce `calculate_order_line_total` plugin method\n- Update core logging for better Celery tasks handling - #7251 by @tomaszszymanski129\n- Raise `ValidationError` when refund cannot be performed - #7260 by @IKarbowiak\n- Fix customer addresses missing after customer creation - #7327 by @tomaszszymanski129\n- Fix invoice generation - #7376 by @tomaszszymanski129\n- Allow defining only one field in translations - #7363 by @IKarbowiak\n- Allow filtering pages by ids - #7393 by @IKarbowiak\n- Fix validate `min_spent` on vouchers to use net or gross value depends on `settings.display_gross_prices` - #7408 by @d-wysocki\n- Fix invoice generation - #7376 by tomaszszymanski129\n- Add hash to uploading images #7453 by @IKarbowiak\n- Add file format validation for uploaded images - #7447 by @IKarbowiak\n- Fix attaching params for address form errors - #7485 by @IKarbowiak\n- Update draft order validation - #7253 by @IKarbowiak\n  - Extend Order type with errors: [OrderError!]! field\n  - Create tasks for deleting order lines by deleting products or variants\n- Fix doubled checkout total price for one line and zero shipping price - #7532 by @IKarbowiak\n- Deprecate nested objects in `TranslatableContent` types - #7522 by @IKarbowiak\n- Modify order of auth middleware calls - #7572 by @tomaszszymanski129\n- Drop assigning cheapest shipping method in checkout - #7767 by @maarcingebala\n- Deprecate `query` argument in `sales` and `vouchers` queries - #7806 by @maarcingebala\n- Allow translating objects by translatable content ID - #7803 by @maarcingebala\n- Configure a periodic task for removing empty allocations - #7885 by @fowczarek\n- Fix missing transaction id in Braintree - #8110 by @fowczarek\n- Fix GraphQL federation support - #7771 #8107 by @rafalp\n- Fix cursor-based pagination in products search - #8011 #8211 by @rafalp\n- Batch loads in queries for Apollo Federation - #8362 by @rafalp\n- Add workaround for failing Avatax when line has price 0 - #8610 by @korycins\n- Add option to set tax code for shipping in Avatax configuration view - #8596 by @korycins\n- Fix Avalara tax fetching from cache - #8647 by @fowczarek\n- Fix incorrect stock allocation - #8931 by @IKarbowiak\n- Fix incorrect handling of unavailable products in checkout - #8978, #9119 by @IKarbowiak, @korycins\n- Add draft orders webhooks - #8102 by @jakubkuc\n- Handle `SameSite` cookie attribute in jwt refresh token middleware - #8209 by @jakubkuc\n- Fix creating translations with app - #6804 by @krzysztofwolski\n- Add possibility to provide external payment ID during the conversion draft order to order - #6320 by @korycins\n- Add basic rating for `Products` - #6284 by @korycins\n- Add metadata to shipping zones and shipping methods - #6340 by @maarcingebala\n- Add Page Types - #6261 by @IKarbowiak\n- Migrate draftjs content to editorjs format - #6430 by @IKarbowiak\n- Add editorjs sanitizer - #6456 by @IKarbowiak\n- Add generic FileUpload mutation - #6470 by @IKarbowiak\n- Order confirmation backend - #6498 by @tomaszszymanski129\n- Handle `SameSite` cookie attribute in JWT refresh token middleware - #8209 by @jakubkuc\n- Add possibility to provide external payment ID during the conversion draft order to order - #6320 by @korycins9\n- Fix password reset request - #6351 by @Manfred-Madelaine-pro, Ambroise and Pierre\n- Refund products support - #6530 by @korycins\n- Add possibility to exclude products from shipping method - #6506 by @korycins\n- Add `Shop.availableShippingMethods` query - #6551 by @IKarbowiak\n- Add delivery time to shipping method - #6564 by @IKarbowiak\n- Shipping zone description - #6653 by @tomaszszymanski129\n- Get tax rate from plugins - #6649 by @IKarbowiak\n- Added support for querying user by email - #6632 @LeOndaz\n- Add order shipping tax rate - #6678 by @IKarbowiak\n- Deprecate field `descriptionJSON` from `Product`, `Category`, `Collection` and field `contentJSON` from `Page` - #6692 by @d-wysocki\n- Fix products visibility - #6704 by @IKarbowiak\n- Fix page `contentJson` field to return JSON - #6832 by @d-wysocki\n- Add SearchRank to search product by name and description. New enum added to `ProductOrderField` - `RANK` - which returns results sorted by search rank - #6872 by @d-wysocki\n- Allocate stocks for order lines in a bulk way - #6877 by @IKarbowiak\n- Deallocate stocks for order lines in a bulk way - #6896 by @IKarbowiak\n- Prevent negative available quantity - #6897 by @d-wysocki\n- Add default sorting by rank for search products - #6936 by @d-wysocki\n- Fix exporting product description to xlsx - #6959 by @IKarbowiak\n- Add `Shop.version` field to query API version - #6980 by @maarcingebala\n- Add new authorization header `Authorization-Bearer` - #6998 by @korycins\n- Add field `paymentMethodType` to `Payment` object - #7073 by @korycins\n- Unify Warehouse Address API - #7481 by @d-wysocki\n  - deprecate `companyName` on `Warehouse` type\n  - remove `companyName` on `WarehouseInput` type\n  - remove `WarehouseAddressInput` on `WarehouseUpdateInput` and `WarehouseCreateInput`, and change it to `AddressInput`\n- Fix passing incorrect customer email to payment gateways - #7486 by @korycins\n- Add HTTP meta tag for Content-Security-Policy in GraphQL Playground - #7662 by @NyanKiyoshi\n- Add additional validation for `from_global_id_or_error` function - #8780 by @CossackDex\n# 2.11.1\n\n- Add support for Apple Pay on the web - #6466 by @korycins\n\n## 2.11.0\n\n### Features\n\n- Add products export - #5255 by @IKarbowiak\n- Add external apps support - #5767 by @korycins\n- Invoices backend - #5732 by @tomaszszymanski129\n- Adyen drop-in integration - #5914 by @korycins, @IKarbowiak\n- Add a callback view to plugins - #5884 by @korycins\n- Support pushing webhook events to message queues - #5940 by @patrys, @korycins\n- Send a confirmation email when the order is canceled or refunded - #6017\n- No secure cookie in debug mode - #6082 by @patrys, @orzechdev\n- Add searchable and available for purchase flags to product - #6060 by @IKarbowiak\n- Add `TotalPrice` to `OrderLine` - #6068 @fowczarek\n- Add `PRODUCT_UPDATED` webhook event - #6100 by @tomaszszymanski129\n- Search orders by GraphQL payment ID - #6135 by @korycins\n- Search orders by a custom key provided by payment gateway - #6135 by @korycins\n- Add ability to set a default product variant - #6140 by @tomaszszymanski129\n- Allow product variants to be sortable - #6138 by @tomaszszymanski129\n- Allow fetching stocks for staff users only with `MANAGE_ORDERS` permissions - #6139 by @fowczarek\n- Add filtering to `ProductVariants` query and option to fetch variant by SKU in `ProductVariant` query - #6190 by @fowczarek\n- Add filtering by Product IDs to `products` query - #6224 by @GrzegorzDerdak\n- Add `change_currency` command - #6016 by @maarcingebala\n- Add dummy credit card payment - #5822 by @IKarbowiak\n- Add custom implementation of UUID scalar - #5646 by @koradon\n- Add `AppTokenVerify` mutation - #5716 by @korycins\n\n### Breaking Changes\n\n- Refactored JWT support. Requires handling of JWT token in the storefront (a case when the backend returns the exception about the invalid token). - #5734, #5816 by @korycins\n- New logging setup will now output JSON logs in production mode for ease of feeding them into log collection systems like Logstash or CloudWatch Logs - #5699 by @patrys\n- Deprecate `WebhookEventType.CHECKOUT_QUANTITY_CHANGED` - #5837 by @korycins\n- Anonymize and update order and payment fields; drop `PaymentSecureConfirm` mutation, drop Payment type fields: `extraData`, `billingAddress`, `billingEmail`, drop `gatewayResponse` from `Transaction` type - #5926 by @IKarbowiak\n- Switch the HTTP stack from WSGI to ASGI based on Uvicorn - #5960 by @patrys\n- Add `MANAGE_PRODUCT_TYPES_AND_ATTRIBUTES` permission, which is now required to access all attributes and product types related mutations - #6219 by @IKarbowiak\n\n### Fixes\n\n- Fix payment fields in order payload for webhooks - #5862 by @korycins\n- Fix specific product voucher in draft orders - #5727 by @fowczarek\n- Explicit country assignment in default shipping zones - #5736 by @maarcingebala\n- Drop `json_content` field from the `Menu` model - #5761 by @maarcingebala\n- Strip warehouse name in mutations - #5766 by @koradon\n- Add missing order events during checkout flow - #5684 by @koradon\n- Update Google Merchant to get tax rate based by plugin manager - #5823 by @gabmartinez\n- Allow unicode in slug fields - #5877 by @IKarbowiak\n- Fix empty plugin object result after `PluginUpdate` mutation - #5968 by @gabmartinez\n- Allow finishing checkout when price amount is 0 - #6064 by @IKarbowiak\n- Fix incorrect tax calculation for Avatax - #6035 by @korycins\n- Fix incorrect calculation of subtotal with active Avatax - #6035 by @korycins\n- Fix incorrect assignment of tax code for Avatax - #6035 by @korycins\n- Do not allow negative product price - #6091 by @IKarbowiak\n- Handle None as attribute value - #6092 by @IKarbowiak\n- Fix for calling `order_created` before the order was saved - #6095 by @korycins\n- Update default decimal places - #6098 by @IKarbowiak\n- Avoid assigning the same pictures twice to a variant - #6112 by @IKarbowiak\n- Fix crashing system when Avalara is improperly configured - #6117 by @IKarbowiak\n- Fix for failing finalising draft order - #6133 by @korycins\n- Remove corresponding draft order lines when variant is removing - #6119 by @IKarbowiak\n- Update required perms for apps management - #6173 by @IKarbowiak\n- Raise an error for an empty key in metadata - #6176 by @IKarbowiak\n- Add attributes to product error - #6181 by @IKarbowiak\n- Allow to add product variant with 0 price to draft order - #6189 by @IKarbowiak\n- Fix deleting product when default variant is deleted - #6186 by @IKarbowiak\n- Fix get unpublished products, product variants and collection as app - #6194 by @fowczarek\n- Set `OrderFulfillStockInput` fields as required - #6196 by @IKarbowiak\n- Fix attribute filtering by categories and collections - #6214 by @fowczarek\n- Fix `is_visible` when `publication_date` is today - #6225 by @korycins\n- Fix filtering products by multiple attributes - #6215 by @GrzegorzDerdak\n- Add attributes validation while creating/updating a product's variant - #6269 by @GrzegorzDerdak\n- Add metadata to page model - #6292 by @dominik-zeglen\n- Fix for unnecessary attributes validation while updating simple product - #6300 by @GrzegorzDerdak\n- Include order line total price to webhook payload - #6354 by @korycins\n- Fix for fulfilling an order when product quantity equals allocated quantity - #6333 by @GrzegorzDerdak\n- Fix for the ability to filter products on collection - #6363 by @GrzegorzDerdak\n\n## 2.10.2\n\n- Add command to change currencies in the database - #5906 by @d-wysocki\n\n## 2.10.1\n\n- Fix multiplied stock quantity - #5675 by @fowczarek\n- Fix invalid allocation after migration - #5678 by @fowczarek\n- Fix order mutations as app - #5680 by @fowczarek\n- Prevent creating checkout/draft order with unpublished product - #5676 by @d-wysocki\n\n## 2.10.0\n\n- OpenTracing support - #5188 by @tomaszszymanski129\n- Account confirmation email - #5126 by @tomaszszymanski129\n- Relocate `Checkout` and `CheckoutLine` methods into separate module and update checkout related plugins to use them - #4980 by @krzysztofwolski\n- Fix problem with free shipping voucher - #4942 by @IKarbowiak\n- Add sub-categories to random data - #4949 by @IKarbowiak\n- Deprecate `localized` field in Money type - #4952 by @IKarbowiak\n- Fix for shipping API not applying taxes - #4913 by @kswiatek92\n- Query object translation with only `manage_translation` permission - #4914 by @fowczarek\n- Add customer note to draft orders API - #4973 by @IKarbowiak\n- Allow to delete category and leave products - #4970 by @IKarbowiak\n- Remove thumbnail generation from migration - #3494 by @kswiatek92\n- Rename 'shipping_date' field in fulfillment model to 'created' - #2433 by @kswiatek92\n- Reduce number of queries for 'checkoutComplete' mutation - #4989 by @IKarbowiak\n- Force PyTest to ignore the environment variable containing the Django settings module - #4992 by @NyanKiyoshi\n- Extend JWT token payload with user information - #4987 by @salwator\n- Optimize the queries for product list in the dashboard - #4995 by @IKarbowiak\n- Drop dashboard 1.0 - #5000 by @IKarbowiak\n- Fixed serialization error on weight fields when running `loaddata` and `dumpdb` - #5005 by @NyanKiyoshi\n- Fixed JSON encoding error on Google Analytics reporting - #5004 by @NyanKiyoshi\n- Create custom field to translation, use new translation types in translations query - #5007 by @fowczarek\n- Take allocated stock into account in `StockAvailability` filter - #5019 by @simonbru\n- Generate matching postal codes for US addresses - #5033 by @maarcingebala\n- Update debug toolbar - #5032 by @IKarbowiak\n- Allow staff member to receive notification about customers orders - #4993 by @kswiatek92\n- Add user's global id to the JWT payload - #5039 by @salwator\n- Make middleware path resolving lazy - #5041 by @NyanKiyoshi\n- Generate slug on saving the attribute value - #5055 by @fowczarek\n- Fix order status after order update - #5072 by @fowczarek\n- Extend top-level connection resolvers with ability to sort results - #5018 by @fowczarek\n- Drop storefront 1.0 - #5043 by @IKarbowiak\n- Replace permissions strings with enums - #5038 by @kswiatek92\n- Remove gateways forms and templates - #5075 by @IKarbowiak\n- Add `Wishlist` models and GraphQL endpoints - #5021 by @derenio\n- Remove deprecated code - #5107 by @IKarbowiak\n- Fix voucher start date filtering - #5133 by @dominik-zeglen\n- Search by sku in products query - #5117 by @fowczarek\n- Send fulfillment update email - #5118 by @IKarbowiak\n- Add address query - #5148 by @kswiatek92\n- Add `checkout_quantity_changed` webhook - #5042 by @derenio\n- Remove unnecessary `manage_orders` permission - #5142 by @kswiatek92\n- Mutation to change the user email - #5076 by @kswiatek92\n- Add MyPy checks - #5150 by @IKarbowiak\n- Move extracting user or service account to utils - #5152 by @kswiatek92\n- Deprecate order status/created arguments - #5076 by @kswiatek92\n- Fix getting title field in page mutations #5160 by @maarcingebala\n- Copy public and private metadata from the checkout to the order upon creation - #5165 by @dankolbman\n- Add warehouses and stocks- #4986 by @szewczykmira\n- Add permission groups - #5176, #5513 by @IKarbowiak\n- Drop `gettext` occurrences - #5189 by @IKarbowiak\n- Fix `product_created` webhook - #5187 by @dzkb\n- Drop unused resolver `resolve_availability` - #5190 by @maarcingebala\n- Fix permission for `checkoutCustomerAttach` mutation - #5192 by @maarcingebala\n- Restrict access to user field - #5194 by @maarcingebala\n- Unify permission for service account API client in test - #5197 by @fowczarek\n- Add additional confirmation step to `checkoutComplete` mutation - #5179 by @salwator\n- Allow sorting warehouses by name - #5211 by @dominik-zeglen\n- Add anonymization to GraphQL's `webhookSamplePayload` endpoint - #5161 @derenio\n- Add slug to `Warehouse`, `Product` and `ProductType` models - #5196 by @IKarbowiak\n- Add mutation for assigning, unassigning shipping zones to warehouse - #5217 by @kswiatek92\n- Fix passing addresses to `PaymentData` objects - #5223 by @maarcingebala\n- Return `null` when querying `me` as an anonymous user - #5231 by @maarcingebala\n- Added `PLAYGROUND_ENABLED` environment variable/setting to allow to enable the GraphQL playground when `DEBUG` is disabled - #5254 by @NyanKiyoshi\n- Fix access to order query when request from service account - #5258 by @fowczarek\n- Customer shouldn't be able to see draft orders by token - #5259 by @fowczarek\n- Customer shouldn't be able to query checkout with another customer - #5268 by @fowczarek\n- Added integration support of Jaeger Tracing - #5282 by @NyanKiyoshi\n- Return `null` when querying `me` as an anonymous user - #5231 as @maarcingebala\n- Add `fulfillment created` webhook - @szewczykmira\n- Unify metadata API - #5178 by @fowczarek\n- Add compiled versions of emails to the repository - #5260 by @tomaszszymanski129\n- Add required prop to fields where applicable - #5293 by @dominik-zeglen\n- Drop `get_absolute_url` methods - #5299 by @IKarbowiak\n- Add `--force` flag to `cleardb` command - #5302 by @maarcingebala\n- Require non-empty message in `orderAddNote` mutation - #5316 by @maarcingebala\n- Stock management refactor - #5323 by @IKarbowiak\n- Add discount error codes - #5348 by @IKarbowiak\n- Add benchmarks to checkout mutations - #5339 by @fowczarek\n- Add pagination tests - #5363 by @fowczarek\n- Add ability to assign multiple warehouses in mutations to create/update a shipping zone - #5399 by @fowczarek\n- Add filter by ids to the `warehouses` query - #5414 by @fowczarek\n- Add shipping rate price validation - #5411 by @kswiatek92\n- Remove unused settings and environment variables - #5420 by @maarcingebala\n- Add product price validation - #5413 by @kswiatek92\n- Add attribute validation to `attributeAssign` mutation - #5423 by @kswiatek92\n- Add possibility to update/delete more than one item in metadata - #5446 by @koradon\n- Check if image exists before validating - #5425 by @kswiatek92\n- Fix warehouses query not working without id - #5441 by @koradon\n- Add `accountErrors` to `CreateToken` mutation - #5437, #5465 by @koradon\n- Raise `GraphQLError` if filter has invalid IDs - #5460 by @gabmartinez\n- Use `AccountErrorCode.INVALID_CREDENTIALS` instead of `INVALID_PASSWORD` - #5495 by @koradon\n- Add tests for pagination - #5468 by @koradon\n- Add `Job` abstract model and interface - #5510 by @IKarbowiak\n- Refactor implementation of allocation - #5445 by @fowczarek\n- Fix `WeightScalar` - #5530 by @koradon\n- Add `OrderFulfill` mutation - #5525 by @fowczarek\n- Add \"It Works\" page - #5494 by @IKarbowiak and @dominik-zeglen\n- Extend errors in `OrderFulfill` mutation - #5553 by @fowczarek\n- Refactor `OrderCancel` mutation for multiple warehouses - #5554 by @fowczarek\n- Add negative weight validation - #5564 by @fowczarek\n- Add error when user pass empty object as address - #5585 by @fowczarek\n- Fix payment creation without shipping method - #5444 by @d-wysocki\n- Fix checkout and order flow with variant without inventory tracking - #5599 by @fowczarek\n- Fixed JWT expired token being flagged as unhandled error rather than handled. - #5603 by @NyanKiyoshi\n- Refactor read-only middleware - #5602 by @maarcingebala\n- Fix availability for variants without inventory tracking - #5605 by @fowczarek\n- Drop support for configuring Vatlayer plugin from settings file. - #5614 by @korycins\n- Add ability to query category, collection or product by slug - #5574 by @koradon\n- Add `quantityAvailable` field to `ProductVariant` type - #5628 by @fowczarek\n- Use tags rather than time-based logs for information on requests - #5608 by @NyanKiyoshi\n\n## 2.9.0\n\n### API\n\n- Add mutation to change customer's first name last name - #4489 by @fowczarek\n- Add mutation to delete customer's account - #4494 by @fowczarek\n- Add mutation to change customer's password - #4656 by @fowczarek\n- Add ability to customize email sender address in emails sent by Saleor - #4820 by @NyanKiyoshi\n- Add ability to filter attributes per global ID - #4640 by @NyanKiyoshi\n- Add ability to search product types by value (through the name) - #4647 by @NyanKiyoshi\n- Add queries and mutation for serving and saving the configuration of all plugins - #4576 by @korycins\n- Add `redirectUrl` to staff and user create mutations - #4717 by @fowczarek\n- Add error codes to mutations responses - #4676 by @Kwaidan00\n- Add translations to countries in `shop` query - #4732 by @fowczarek\n- Add support for sorting product by their attribute values through given attribute ID - #4740 by @NyanKiyoshi\n- Add descriptions for queries and query arguments - #4758 by @maarcingebala\n- Add support for Apollo Federation - #4825 by @salwator\n- Add mutation to create multiple product variants at once - #4735 by @fowczarek\n- Add default value to custom errors - #4797 by @fowczarek\n- Extend `availablePaymentGateways` field with gateways' configuration data - #4774 by @salwator\n- Change `AddressValidationRules` API - #4655 by @Kwaidan00\n- Use search in a consistent way; add sort by product type name and publication status to `products` query. - #4715 by @fowczarek\n- Unify `menuItemMove` mutation with other reordering mutations - #4734 by @NyanKiyoshi\n- Don't create an order when the payment was unsuccessful - #4500 by @NyanKiyoshi\n- Don't require shipping information in checkout for digital orders - #4573 by @NyanKiyoshi\n- Drop `manage_users` permission from the `permissions` query - #4854 by @maarcingebala\n- Deprecate `inCategory` and `inCollection` attributes filters in favor of `filter` argument - #4700 by @NyanKiyoshi & @khalibloo\n- Remove `PaymentGatewayEnum` from the schema, as gateways now are dynamic plugins - #4756 by @salwator\n- Require `manage_products` permission to query `costPrice` and `stockQuantity` fields - #4753 by @NyanKiyoshi\n- Refactor account mutations - #4510, #4668 by @fowczarek\n- Fix generating random avatars when updating staff accounts - #4521 by @maarcingebala\n- Fix updating JSON menu representation in mutations - #4524 by @maarcingebala\n- Fix setting variant's `priceOverride` and `costPrice` to `null` - #4754 by @NyanKiyoshi\n- Fix fetching staff user without `manage_users` permission - #4835 by @fowczarek\n- Ensure that a GraphQL query is a string - #4836 by @nix010\n- Add ability to configure the password reset link - #4863 by @fowczarek\n- Fixed a performance issue where Saleor would sometimes run huge, unneeded prefetches when resolving categories or collections - #5291 by @NyanKiyoshi\n- uWSGI now forces the django application to directly load on startup instead of being lazy - #5357 by @NyanKiyoshi\n\n### Core\n\n- Add enterprise-grade attributes management - #4351 by @dominik-zeglen and @NyanKiyoshi\n- Add extensions manager - #4497 by @korycins\n- Add service accounts - backend support - #4689 by @korycins\n- Add support for webhooks - #4731 by @korycins\n- Migrate the attributes mapping from HStore to many-to-many relation - #4663 by @NyanKiyoshi\n- Create general abstraction for object metadata - #4447 by @salwator\n- Add metadata to `Order` and `Fulfillment` models - #4513, #4866 by @szewczykmira\n- Migrate the tax calculations to plugins - #4497 by @korycins\n- Rewrite payment gateways using plugin architecture - #4669 by @salwator\n- Rewrite Stripe integration to use PaymentIntents API - #4606 by @salwator\n- Refactor password recovery system - #4617 by @fowczarek\n- Add functionality to sort products by their \"minimal variant price\" - #4416 by @derenio\n- Add voucher's \"once per customer\" feature - #4442 by @fowczarek\n- Add validations for minimum password length in settings - #4735 by @fowczarek\n- Add form to configure payments in the dashboard - #4807 by @szewczykmira\n- Change `unique_together` in `AttributeValue` - #4805 by @fowczarek\n- Change max length of SKU to 255 characters - #4811 by @lex111\n- Distinguish `OrderLine` product name and variant name - #4702 by @fowczarek\n- Fix updating order status after automatic fulfillment of digital products - #4709 by @korycins\n- Fix error when updating or creating a sale with missing required values - #4778 by @NyanKiyoshi\n- Fix error filtering pages by URL in the dashboard 1.0 - #4776 by @NyanKiyoshi\n- Fix display of the products tax rate in the details page of dashboard 1.0 - #4780 by @NyanKiyoshi\n- Fix adding the same product into a collection multiple times - #4518 by @NyanKiyoshi\n- Fix crash when placing an order when a customer happens to have the same address more than once - #4824 by @NyanKiyoshi\n- Fix time zone based tests - #4468 by @fowczarek\n- Fix serializing empty URLs as a string when creating menu items - #4616 by @maarcingebala\n- The invalid IP address in HTTP requests now fallback to the requester's IP address. - #4597 by @NyanKiyoshi\n- Fix product variant update with current attribute values - #4936 by @fowczarek\n- Update checkout last field and add auto now fields to save with update_fields parameter - #5177 by @IKarbowiak\n\n### Dashboard 2.0\n\n- Allow selecting the number of rows displayed in dashboard's list views - #4414 by @benekex2\n- Add ability to toggle visible columns in product list - #4608 by @dominik-zeglen\n- Add voucher settings - #4556 by @benekex2\n- Contrast improvements - #4508 by @benekex2\n- Display menu item form errors - #4551 by @dominik-zeglen\n- Do not allow random IDs to appear in snapshots - #4495 by @dominik-zeglen\n- Input UI changes - #4542 by @benekex2\n- Implement new menu design - #4476 by @benekex2\n- Refetch attribute list after closing modal - #4615 by @dominik-zeglen\n- Add config for Testcafe - #4553 by @dominik-zeglen\n- Fix product type taxes select - #4453 by @benekex2\n- Fix form reloading - #4467 by @dominik-zeglen\n- Fix voucher limit value when checkbox unchecked - #4456 by @benekex2\n- Fix searches and pickers - #4487 by @dominik-zeglen\n- Fix dashboard menu styles - #4491 by @benekex2\n- Fix menu responsiveness - #4511 by @benekex2\n- Fix loosing focus while typing in the product description field - #4549 by @dominik-zeglen\n- Fix MUI warnings - #4588 by @dominik-zeglen\n- Fix bulk action checkboxes - #4618 by @dominik-zeglen\n- Fix rendering user avatar when it's empty #4546 by @maarcingebala\n- Remove Dashboard 2.0 files form Saleor repository - #4631 by @dominik-zeglen\n- Fix CreateToken mutation to use NonNull on errors field #5415 by @gabmartinez\n\n### Other notable changes\n\n- Replace Pipenv with Poetry - #3894 by @michaljelonek\n- Upgrade `django-prices` to v2.1 - #4639 by @NyanKiyoshi\n- Disable reports from uWSGI about broken pipe and write errors from disconnected clients - #4596 by @NyanKiyoshi\n- Fix the random failures of `populatedb` trying to create users with an existing email - #4769 by @NyanKiyoshi\n- Enforce `pydocstyle` for Python docstrings over the project - #4562 by @NyanKiyoshi\n- Move Django Debug Toolbar to dev requirements - #4454 by @derenio\n- Change license for artwork to CC-BY 4.0\n- New translations:\n  - Greek\n\n## 2.8.0\n\n### Core\n\n- Avatax backend support - #4310 by @korycins\n- Add ability to store used payment sources in gateways (first implemented in Braintree) - #4195 by @salwator\n- Add ability to specify a minimal quantity of checkout items for a voucher - #4427 by @fowczarek\n- Change the type of start and end date fields from Date to DateTime - #4293 by @fowczarek\n- Revert the custom dynamic middlewares - #4452 by @NyanKiyoshi\n\n### Dashboard 2.0\n\n- UX improvements in Vouchers section - #4362 by @benekex2\n- Add company address configuration - #4432 by @benekex2\n- Require name when saving a custom list filter - #4269 by @benekex2\n- Use `esModuleInterop` flag in `tsconfig.json` to simplify imports - #4372 by @dominik-zeglen\n- Use hooks instead of a class component in forms - #4374 by @dominik-zeglen\n- Drop CSRF token header from API client - #4357 by @dominik-zeglen\n- Fix various bugs in the product section - #4429 by @dominik-zeglen\n\n### Other notable changes\n\n- Fix error when creating a checkout with voucher code - #4292 by @NyanKiyoshi\n- Fix error when users enter an invalid phone number in an address - #4404 by @NyanKiyoshi\n- Fix error when adding a note to an anonymous order - #4319 by @NyanKiyoshi\n- Fix gift card duplication error in the `populatedb` script - #4336 by @fowczarek\n- Fix vouchers apply once per order - #4339 by @fowczarek\n- Fix discount tests failing at random - #4401 by @korycins\n- Add `SPECIFIC_PRODUCT` type to `VoucherType` - #4344 by @fowczarek\n- New translations:\n  - Icelandic\n- Refactored the backend side of `checkoutCreate` to improve performances and prevent side effects over the user's checkout if the checkout creation was to fail. - #4367 by @NyanKiyoshi\n- Refactored the logic of cleaning the checkout shipping method over the API, so users do not lose the shipping method when updating their checkout. If the shipping method becomes invalid, it will be replaced by the cheapest available. - #4367 by @NyanKiyoshi & @szewczykmira\n- Refactored process of getting available shipping methods to make it easier to understand and prevent human-made errors. - #4367 by @NyanKiyoshi\n- Moved 3D secure option to Braintree plugin configuration and update config structure mechanism - #4751 by @salwator\n\n## 2.7.0\n\n### API\n\n- Create order only when payment is successful - #4154 by @NyanKiyoshi\n- Order Events containing order lines or fulfillment lines now return the line object in the GraphQL API - #4114 by @NyanKiyoshi\n- GraphQL now prints exceptions to stderr as well as returning them or not - #4148 by @NyanKiyoshi\n- Refactored API resolvers to static methods with root typing - #4155 by @NyanKiyoshi\n- Add phone validation in the GraphQL API to handle the library upgrade - #4156 by @NyanKiyoshi\n\n### Core\n\n- Add basic Gift Cards support in the backend - #4025 by @fowczarek\n- Add the ability to sort products within a collection - #4123 by @NyanKiyoshi\n- Implement customer events - #4094 by @NyanKiyoshi\n- Merge \"authorize\" and \"capture\" operations - #4098 by @korycins, @NyanKiyoshi\n- Separate the Django middlewares from the GraphQL API middlewares - #4102 by @NyanKiyoshi, #4186 by @cmiacz\n\n### Dashboard 2.0\n\n- Add navigation section - #4012 by @dominik-zeglen\n- Add filtering on product list - #4193 by @dominik-zeglen\n- Add filtering on orders list - #4237 by @dominik-zeglen\n- Change input style and improve Storybook stories - #4115 by @dominik-zeglen\n- Migrate deprecated fields in Dashboard 2.0 - #4121 by @benekex2\n- Add multiple select checkbox - #4133, #4146 by @benekex2\n- Rename menu items in Dashboard 2.0 - #4172 by @benekex2\n- Category delete modal improvements - #4171 by @benekex2\n- Close modals on click outside - #4236 - by @benekex2\n- Use date localize hook in translations - #4202 by @dominik-zeglen\n- Unify search API - #4200 by @dominik-zeglen\n- Default default PAGINATE_BY - #4238 by @dominik-zeglen\n- Create generic filtering interface - #4221 by @dominik-zeglen\n- Add default state to rich text editor = #4281 by @dominik-zeglen\n- Fix translation discard button - #4109 by @benekex2\n- Fix draftail options and icons - #4132 by @benekex2\n- Fix typos and messages in Dashboard 2.0 - #4168 by @benekex2\n- Fix view all orders button - #4173 by @benekex2\n- Fix visibility card view - #4198 by @benekex2\n- Fix query refetch after selecting an object in list - #4272 by @dominik-zeglen\n- Fix image selection in variants - #4270 by @benekex2\n- Fix collection search - #4267 by @dominik-zeglen\n- Fix quantity height in draft order edit - #4273 by @benekex2\n- Fix checkbox clickable area size - #4280 by @dominik-zeglen\n- Fix breaking object selection in menu section - #4282 by @dominik-zeglen\n- Reset selected items when tab switch - #4268 by @benekex2\n\n### Other notable changes\n\n- Add support for Google Cloud Storage - #4127 by @chetabahana\n- Adding a nonexistent variant to checkout no longer crashes - #4166 by @NyanKiyoshi\n- Disable storage of Celery results - #4169 by @NyanKiyoshi\n- Disable polling in Playground - #4188 by @maarcingebala\n- Cleanup code for updated function names and unused argument - #4090 by @jxltom\n- Users can now add multiple \"Add to Cart\" forms in a single page - #4165 by @NyanKiyoshi\n- Fix incorrect argument in `get_client_token` in Braintree integration - #4182 by @maarcingebala\n- Fix resolving attribute values when transforming them to HStore - #4161 by @maarcingebala\n- Fix wrong calculation of subtotal in cart page - #4145 by @korycins\n- Fix margin calculations when product/variant price is set to zero - #4170 by @MahmoudRizk\n- Fix applying discounts in checkout's subtotal calculation in API - #4192 by @maarcingebala\n- Fix GATEWAYS_ENUM to always contain all implemented payment gateways - #4108 by @koradon\n\n## 2.6.0\n\n### API\n\n- Add unified filtering interface in resolvers - #3952, #4078 by @korycins\n- Add mutations for bulk actions - #3935, #3954, #3967, #3969, #3970 by @akjanik\n- Add mutation for reordering menu items - #3958 by @NyanKiyoshi\n- Optimize queries for single nodes - #3968 @NyanKiyoshi\n- Refactor error handling in mutations #3891 by @maarcingebala & @akjanik\n- Specify mutation permissions through Meta classes - #3980 by @NyanKiyoshi\n- Unify pricing access in products and variants - #3948 by @NyanKiyoshi\n- Use only_fields instead of exclude_fields in type definitions - #3940 by @michaljelonek\n- Prefetch collections when getting sales of a bunch of products - #3961 by @NyanKiyoshi\n- Remove unnecessary dedents from GraphQL schema so new Playground can work - #4045 by @salwator\n- Restrict resolving payment by ID - #4009 @NyanKiyoshi\n- Require `checkoutId` for updating checkout's shipping and billing address - #4074 by @jxltom\n- Handle errors in `TokenVerify` mutation - #3981 by @fowczarek\n- Unify argument names in types and resolvers - #3942 by @NyanKiyoshi\n\n### Core\n\n- Use Black as the default code formatting tool - #3852 by @krzysztofwolski and @NyanKiyoshi\n- Dropped Python 3.5 support - #4028 by @korycins\n- Rename Cart to Checkout - #3963 by @michaljelonek\n- Use data classes to exchange data with payment gateways - #4028 by @korycins\n- Refactor order events - #4018 by @NyanKiyoshi\n\n### Dashboard 2.0\n\n- Add bulk actions - #3955 by @dominik-zeglen\n- Add user avatar management - #4030 by @benekex2\n- Add navigation drawer support on mobile devices - #3839 by @benekex2\n- Fix rendering validation errors in product form - #4024 by @benekex2\n- Move dialog windows to query string rather than router paths - #3953 by @dominik-zeglen\n- Update order events types - #4089 by @jxltom\n- Code cleanup by replacing render props with react hooks - #4010 by @dominik-zeglen\n\n### Other notable changes\n\n- Add setting to enable Django Debug Toolbar - #3983 by @koradon\n- Use newest GraphQL Playground - #3971 by @salwator\n- Ensure adding to quantities in the checkout is respecting the limits - #4005 by @NyanKiyoshi\n- Fix country area choices - #4008 by @fowczarek\n- Fix price_range_as_dict function - #3999 by @zodiacfireworks\n- Fix the product listing not showing in the voucher when there were products selected - #4062 by @NyanKiyoshi\n- Fix crash in Dashboard 1.0 when updating an order address's phone number - #4061 by @NyanKiyoshi\n- Reduce the time of tests execution by using dummy password hasher - #4083 by @korycins\n- Set up explicit **hash** function - #3979 by @akjanik\n- Unit tests use none as media root - #3975 by @korycins\n- Update file field styles with materializecss template filter - #3998 by @zodiacfireworks\n- New translations:\n  - Albanian\n  - Colombian Spanish\n  - Lithuanian\n\n## 2.5.0\n\n### API\n\n- Add query to fetch draft orders - #3809 by @michaljelonek\n- Add bulk delete mutations - #3838 by @michaljelonek\n- Add `languageCode` enum to API - #3819 by @michaljelonek, #3854 by @jxltom\n- Duplicate address instances in checkout mutations - #3866 by @pawelzar\n- Restrict access to `orders` query for unauthorized users - #3861 by @pawelzar\n- Support setting address as default in address mutations - #3787 by @jxltom\n- Fix phone number validation in GraphQL when country prefix not given - #3905 by @patrys\n- Report pretty stack traces in DEBUG mode - #3918 by @patrys\n\n### Core\n\n- Drop support for Django 2.1 and Django 1.11 (previous LTS) - #3929 by @patrys\n- Fulfillment of digital products - #3868 by @korycins\n- Introduce avatars for staff accounts - #3878 by @pawelzar\n- Refactor the account avatars path from a relative to absolute - #3938 by @NyanKiyoshi\n\n### Dashboard 2.0\n\n- Add translations section - #3884 by @dominik-zeglen\n- Add light/dark theme - #3856 by @dominik-zeglen\n- Add customer's address book view - #3826 by @dominik-zeglen\n- Add \"Add variant\" button on the variant details page = #3914 by @dominik-zeglen\n- Add back arrows in \"Configure\" subsections - #3917 by @dominik-zeglen\n- Display avatars in staff views - #3922 by @dominik-zeglen\n- Prevent user from changing his own status and permissions - #3922 by @dominik-zeglen\n- Fix crashing product create view - #3837, #3910 by @dominik-zeglen\n- Fix layout in staff members details page - #3857 by @dominik-zeglen\n- Fix unfocusing rich text editor - #3902 by @dominik-zeglen\n- Improve accessibility - #3856 by @dominik-zeglen\n\n### Other notable changes\n\n- Improve user and staff management in dashboard 1.0 - #3781 by @jxltom\n- Fix default product tax rate in Dashboard 1.0 - #3880 by @pawelzar\n- Fix logo in docs - #3928 by @michaljelonek\n- Fix name of logo file - #3867 by @jxltom\n- Fix variants for juices in example data - #3926 by @michaljelonek\n- Fix alignment of the cart dropdown on new bootstrap version - #3937 by @NyanKiyoshi\n- Refactor the account avatars path from a relative to absolute - #3938 by @NyanKiyoshi\n- New translations:\n  - Armenian\n  - Portuguese\n  - Swahili\n  - Thai\n\n## 2.4.0\n\n### API\n\n- Add model translations support in GraphQL API - #3789 by @michaljelonek\n- Add mutations to manage addresses for authenticated customers - #3772 by @Kwaidan00, @maarcingebala\n- Add mutation to apply vouchers in checkout - #3739 by @Kwaidan00\n- Add thumbnail field to `OrderLine` type - #3737 by @michaljelonek\n- Add a query to fetch order by token - #3740 by @michaljelonek\n- Add city choices and city area type to address validator API - #3788 by @jxltom\n- Fix access to unpublished objects in API - #3724 by @Kwaidan00\n- Fix bug where errors are not returned when creating fulfillment with a non-existent order line - #3777 by @jxltom\n- Fix `productCreate` mutation when no product type was provided - #3804 by @michaljelonek\n- Enable database search in products query - #3736 by @michaljelonek\n- Use authenticated user's email as default email in creating checkout - #3726 by @jxltom\n- Generate voucher code if it wasn't provided in mutation - #3717 by @Kwaidan00\n- Improve limitation of vouchers by country - #3707 by @michaljelonek\n- Only include canceled fulfillments for staff in fulfillment API - #3778 by @jxltom\n- Support setting address as when creating customer address #3782 by @jxltom\n- Fix generating slug from title - #3816 by @maarcingebala\n- Add `variant` field to `OrderLine` type - #3820 by @maarcingebala\n\n### Core\n\n- Add JSON fields to store rich-text content - #3756 by @michaljelonek\n- Add function to recalculate total order weight - #3755 by @Kwaidan00, @maarcingebala\n- Unify cart creation logic in API and Django views - #3761, #3790 by @maarcingebala\n- Unify payment creation logic in API and Django views - #3715 by @maarcingebala\n- Support partially charged and refunded payments - #3735 by @jxltom\n- Support partial fulfillment of ordered items - #3754 by @jxltom\n- Fix applying discounts when a sale has no end date - #3595 by @cprinos\n\n### Dashboard 2.0\n\n- Add \"Discounts\" section - #3654 by @dominik-zeglen\n- Add \"Pages\" section; introduce Draftail WYSIWYG editor - #3751 by @dominik-zeglen\n- Add \"Shipping Methods\" section - #3770 by @dominik-zeglen\n- Add support for date and datetime components - #3708 by @dominik-zeglen\n- Restyle app layout - #3811 by @dominik-zeglen\n\n### Other notable changes\n\n- Unify model field names related to models' public access - `publication_date` and `is_published` - #3706 by @michaljelonek\n- Improve filter orders by payment status - #3749 @jxltom\n- Refactor translations in emails - #3701 by @Kwaidan00\n- Use exact image versions in docker-compose - #3742 by @ashishnitinpatil\n- Sort order payment and history in descending order - #3747 by @jxltom\n- Disable style-loader in dev mode - #3720 by @jxltom\n- Add ordering to shipping method - #3806 by @michaljelonek\n- Add missing type definition for dashboard 2.0 - #3776 by @jxltom\n- Add header and footer for checkout success pages #3752 by @jxltom\n- Add instructions for using local assets in Docker - #3723 by @michaljelonek\n- Update S3 deployment documentation to include CORS configuration note - #3743 by @NyanKiyoshi\n- Fix missing migrations for is_published field of product and page model - #3757 by @jxltom\n- Fix problem with l10n in Braintree payment gateway template - #3691 by @Kwaidan00\n- Fix bug where payment is not filtered from active ones when creating payment - #3732 by @jxltom\n- Fix incorrect cart badge location - #3786 by @jxltom\n- Fix storefront styles after bootstrap is updated to 4.3.1 - #3753 by @jxltom\n- Fix logo size in different browser and devices with different sizes - #3722 by @jxltom\n- Rename dumpdata file `db.json` to `populatedb_data.json` - #3810 by @maarcingebala\n- Prefetch collections for product availability - #3813 by @michaljelonek\n- Bump django-graphql-jwt - #3814 by @michaljelonek\n- Fix generating slug from title - #3816 by @maarcingebala\n- New translations:\n  - Estonian\n  - Indonesian\n\n## 2.3.1\n\n- Fix access to private variant fields in API - #3773 by maarcingebala\n- Limit access of quantity and allocated quantity to staff in GraphQL API #3780 by @jxltom\n\n## 2.3.0\n\n### API\n\n- Return user's last checkout in the `User` type - #3578 by @fowczarek\n- Automatically assign checkout to the logged in user - #3587 by @fowczarek\n- Expose `chargeTaxesOnShipping` field in the `Shop` type - #3603 by @fowczarek\n- Expose list of enabled payment gateways - #3639 by @fowczarek\n- Validate uploaded files in a unified way - #3633 by @fowczarek\n- Add mutation to trigger fetching tax rates - #3622 by @fowczarek\n- Use USERNAME_FIELD instead of hard-code email field when resolving user - #3577 by @jxltom\n- Require variant and quantity fields in `CheckoutLineInput` type - #3592 by @jxltom\n- Preserve order of nodes in `get_nodes_or_error` function - #3632 by @jxltom\n- Add list mutations for `Voucher` and `Sale` models - #3669 by @michaljelonek\n- Use proper type for countries in `Voucher` type - #3664 by @michaljelonek\n- Require email in when creating checkout in API - #3667 by @michaljelonek\n- Unify returning errors in the `tokenCreate` mutation - #3666 by @michaljelonek\n- Use `Date` field in Sale/Voucher inputs - #3672 by @michaljelonek\n- Refactor checkout mutations - #3610 by @fowczarek\n- Refactor `clean_instance`, so it does not returns errors anymore - #3597 by @akjanik\n- Handle GraphqQL syntax errors - #3576 by @jxltom\n\n### Core\n\n- Refactor payments architecture - #3519 by @michaljelonek\n- Improve Docker and `docker-compose` configuration - #3657 by @michaljelonek\n- Allow setting payment status manually for dummy gateway in Storefront 1.0 - #3648 by @jxltom\n- Infer default transaction kind from operation type - #3646 by @jxltom\n- Get correct payment status for order without any payments - #3605 by @jxltom\n- Add default ordering by `id` for `CartLine` model - #3593 by @jxltom\n- Fix \"set password\" email sent to customer created in the dashboard - #3688 by @Kwaidan00\n\n### Dashboard 2.0\n\n- \ufe0fAdd taxes section - #3622 by @dominik-zeglen\n- Add drag'n'drop image upload - #3611 by @dominik-zeglen\n- Unify grid handling - #3520 by @dominik-zeglen\n- Add component generator - #3670 by @dominik-zeglen\n- Throw Typescript errors while snapshotting - #3611 by @dominik-zeglen\n- Simplify mutation's error checking - #3589 by @dominik-zeglen\n- Fix order cancelling - #3624 by @dominik-zeglen\n- Fix logo placement - #3602 by @dominik-zeglen\n\n### Other notable changes\n\n- Register Celery task for updating exchange rates - #3599 by @jxltom\n- Fix handling different attributes with the same slug - #3626 by @jxltom\n- Add missing migrations for tax rate choices - #3629 by @jxltom\n- Fix `TypeError` on calling `get_client_token` - #3660 by @michaljelonek\n- Make shipping required as default when creating product types - #3655 by @jxltom\n- Display payment status on customer's account page in Storefront 1.0 - #3637 by @jxltom\n- Make order fields sequence in Dashboard 1.0 same as in Dashboard 2.0 - #3606 by @jxltom\n- Fix returning products for homepage for the currently viewing user - #3598 by @jxltom\n- Allow filtering payments by status in Dashboard 1.0 - #3608 by @jxltom\n- Fix typo in the definition of order status - #3649 by @jxltom\n- Add margin for order notes section - #3650 by @jxltom\n- Fix logo position - #3609, #3616 by @jxltom\n- Storefront visual improvements - #3696 by @piotrgrundas\n- Fix product list price filter - #3697 by @Kwaidan00\n- Redirect to success page after successful payment - #3693 by @Kwaidan00\n\n## 2.2.0\n\n### API\n\n- Use `PermissionEnum` as input parameter type for `permissions` field - #3434 by @maarcingebala\n- Add \"authorize\" and \"charge\" mutations for payments - #3426 by @jxltom\n- Add alt text to product thumbnails and background images of collections and categories - #3429 by @fowczarek\n- Fix passing decimal arguments = #3457 by @fowczarek\n- Allow sorting products by the update date - #3470 by @jxltom\n- Validate and clear the shipping method in draft order mutations - #3472 by @fowczarek\n- Change tax rate field to choice field - #3478 by @fowczarek\n- Allow filtering attributes by collections - #3508 by @maarcingebala\n- Resolve to `None` when empty object ID was passed as mutation argument - #3497 by @maarcingebala\n- Change `errors` field type from [Error] to [Error!] - #3489 by @fowczarek\n- Support creating default variant for product types that don't use multiple variants - #3505 by @fowczarek\n- Validate SKU when creating a default variant - #3555 by @fowczarek\n- Extract enums to separate files - #3523 by @maarcingebala\n\n### Core\n\n- Add Stripe payment gateway - #3408 by @jxltom\n- Add `first_name` and `last_name` fields to the `User` model - #3101 by @fowczarek\n- Improve several payment validations - #3418 by @jxltom\n- Optimize payments related database queries - #3455 by @jxltom\n- Add publication date to collections - #3369 by @k-brk\n- Fix hard-coded site name in order PDFs - #3526 by @NyanKiyoshi\n- Update favicons to the new style - #3483 by @dominik-zeglen\n- Fix migrations for default currency - #3235 by @bykof\n- Remove Elasticsearch from `docker-compose.yml` - #3482 by @maarcingebala\n- Resort imports in tests - #3471 by @jxltom\n- Fix the no shipping orders payment crash on Stripe - #3550 by @NyanKiyoshi\n- Bump backend dependencies - #3557 by @maarcingebala. This PR removes security issue CVE-2019-3498 which was present in Django 2.1.4. Saleor however wasn't vulnerable to this issue as it doesn't use the affected `django.views.defaults.page_not_found()` view.\n- Generate random data using the default currency - #3512 by @stephenmoloney\n- New translations:\n  - Catalan\n  - Serbian\n\n### Dashboard 2.0\n\n- Restyle product selection dialogs - #3499 by @dominik-zeglen, @maarcingebala\n- Fix minor visual bugs in Dashboard 2.0 - #3433 by @dominik-zeglen\n- Display warning if order draft has missing data - #3431 by @dominik-zeglen\n- Add description field to collections - #3435 by @dominik-zeglen\n- Add query batching - #3443 by @dominik-zeglen\n- Use autocomplete fields in country selection - #3443 by @dominik-zeglen\n- Add alt text to categories and collections - #3461 by @dominik-zeglen\n- Use first and last name of a customer or staff member in UI - #3247 by @Bonifacy1, @dominik-zeglen\n- Show error page if an object was not found - #3463 by @dominik-zeglen\n- Fix simple product's inventory data saving bug - #3474 by @dominik-zeglen\n- Replace `thumbnailUrl` with `thumbnail { url }` - #3484 by @dominik-zeglen\n- Change \"Feature on Homepage\" switch behavior - #3481 by @dominik-zeglen\n- Expand payment section in order view - #3502 by @dominik-zeglen\n- Change TypeScript loader to speed up the build process - #3545 by @patrys\n\n### Bugfixes\n\n- Do not show `Pay For Order` if order is partly paid since partial payment is not supported - #3398 by @jxltom\n- Fix attribute filters in the products category view - #3535 by @fowczarek\n- Fix storybook dependencies conflict - #3544 by @dominik-zeglen\n\n## 2.1.0\n\n### API\n\n- Change selected connection fields to lists - #3307 by @fowczarek\n- Require pagination in connections - #3352 by @maarcingebala\n- Replace Graphene view with a custom one - #3263 by @patrys\n- Change `sortBy` parameter to use enum type - #3345 by @fowczarek\n- Add `me` query to fetch data of a logged-in user - #3202, #3316 by @fowczarek\n- Add `canFinalize` field to the Order type - #3356 by @fowczarek\n- Extract resolvers and mutations to separate files - #3248 by @fowczarek\n- Add VAT tax rates field to country - #3392 by @michaljelonek\n- Allow creating orders without users - #3396 by @fowczarek\n\n### Core\n\n- Add Razorpay payment gatway - #3205 by @NyanKiyoshi\n- Use standard tax rate as a default tax rate value - #3340 by @fowczarek\n- Add description field to the Collection model - #3275 by @fowczarek\n- Enforce the POST method on VAT rates fetching - #3337 by @NyanKiyoshi\n- Generate thumbnails for category/collection background images - #3270 by @NyanKiyoshi\n- Add warm-up support in product image creation mutation - #3276 by @NyanKiyoshi\n- Fix error in the `populatedb` script when running it not from the project root - #3272 by @NyanKiyoshi\n- Make Webpack rebuilds fast - #3290 by @patrys\n- Skip installing Chromium to make deployment faster - #3227 by @jxltom\n- Add default test runner - #3258 by @jxltom\n- Add Transifex client to Pipfile - #3321 by @jxltom\n- Remove additional pytest arguments in tox - #3338 by @jxltom\n- Remove test warnings - #3339 by @jxltom\n- Remove runtime warning when product has discount - #3310 by @jxltom\n- Remove `django-graphene-jwt` warnings - #3228 by @jxltom\n- Disable deprecated warnings - #3229 by @jxltom\n- Add `AWS_S3_ENDPOINT_URL` setting to support DigitalOcean spaces. - #3281 by @hairychris\n- Add `.gitattributes` file to hide diffs for generated files on Github - #3055 by @NyanKiyoshi\n- Add database sequence reset to `populatedb` - #3406 by @michaljelonek\n- Get authorized amount from succeeded auth transactions - #3417 by @jxltom\n- Resort imports by `isort` - #3412 by @jxltom\n\n### Dashboard 2.0\n\n- Add confirmation modal when leaving view with unsaved changes - #3375 by @dominik-zeglen\n- Add dialog loading and error states - #3359 by @dominik-zeglen\n- Split paths and urls - #3350 by @dominik-zeglen\n- Derive state from props in forms - #3360 by @dominik-zeglen\n- Apply debounce to autocomplete fields - #3351 by @dominik-zeglen\n- Use Apollo signatures - #3353 by @dominik-zeglen\n- Add order note field in the order details view - #3346 by @dominik-zeglen\n- Add app-wide progress bar - #3312 by @dominik-zeglen\n- Ensure that all queries are built on top of TypedQuery - #3309 by @dominik-zeglen\n- Close modal windows automatically - #3296 by @dominik-zeglen\n- Move URLs to separate files - #3295 by @dominik-zeglen\n- Add basic filters for products and orders list - #3237 by @Bonifacy1\n- Fetch default currency from API - #3280 by @dominik-zeglen\n- Add `displayName` property to components - #3238 by @Bonifacy1\n- Add window titles - #3279 by @dominik-zeglen\n- Add paginator component - #3265 by @dominik-zeglen\n- Update Material UI to 3.6 - #3387 by @patrys\n- Upgrade React, Apollo, Webpack and Babel - #3393 by @patrys\n- Add pagination for required connections - #3411 by @dominik-zeglen\n\n### Bugfixes\n\n- Fix language codes - #3311 by @jxltom\n- Fix resolving empty attributes list - #3293 by @maarcingebala\n- Fix range filters not being applied - #3385 by @michaljelonek\n- Remove timeout for updating image height - #3344 by @jxltom\n- Return error if checkout was not found - #3289 by @maarcingebala\n- Solve an auto-resize conflict between Materialize and medium-editor - #3367 by @adonig\n- Fix calls to `ngettext_lazy` - #3380 by @patrys\n- Filter preauthorized order from succeeded transactions - #3399 by @jxltom\n- Fix incorrect country code in fixtures - #3349 by @bingimar\n- Fix updating background image of a collection - #3362 by @fowczarek & @dominik-zeglen\n\n### Docs\n\n- Document settings related to generating thumbnails on demand - #3329 by @NyanKiyoshi\n- Improve documentation for Heroku deployment - #3170 by @raybesiga\n- Update documentation on Docker deployment - #3326 by @jxltom\n- Document payment gateway configuration - #3376 by @NyanKiyoshi\n\n## 2.0.0\n\n### API\n\n- Add mutation to delete a customer; add `isActive` field in `customerUpdate` mutation - #3177 by @maarcingebala\n- Add mutations to manage authorization keys - #3082 by @maarcingebala\n- Add queries for dashboard homepage - #3146 by @maarcingebala\n- Allows user to unset homepage collection - #3140 by @oldPadavan\n- Use enums as permission codes - #3095 by @the-bionic\n- Return absolute image URLs - #3182 by @maarcingebala\n- Add `backgroundImage` field to `CategoryInput` - #3153 by @oldPadavan\n- Add `dateJoined` and `lastLogin` fields in `User` type - #3169 by @maarcingebala\n- Separate `parent` input field from `CategoryInput` - #3150 by @akjanik\n- Remove duplicated field in Order type - #3180 by @maarcingebala\n- Handle empty `backgroundImage` field in API - #3159 by @maarcingebala\n- Generate name-based slug in collection mutations - #3145 by @akjanik\n- Remove products field from `collectionUpdate` mutation - #3141 by @oldPadavan\n- Change `items` field in `Menu` type from connection to list - #3032 by @oldPadavan\n- Make `Meta.description` required in `BaseMutation` - #3034 by @oldPadavan\n- Apply `textwrap.dedent` to GraphQL descriptions - #3167 by @fowczarek\n\n### Dashboard 2.0\n\n- Add collection management - #3135 by @dominik-zeglen\n- Add customer management - #3176 by @dominik-zeglen\n- Add homepage view - #3155, #3178 by @Bonifacy1 and @dominik-zeglen\n- Add product type management - #3052 by @dominik-zeglen\n- Add site settings management - #3071 by @dominik-zeglen\n- Escape node IDs in URLs - #3115 by @dominik-zeglen\n- Restyle categories section - #3072 by @Bonifacy1\n\n### Other\n\n- Change relation between `ProductType` and `Attribute` models - #3097 by @maarcingebala\n- Remove `quantity-allocated` generation in `populatedb` script - #3084 by @MartinSeibert\n- Handle `Money` serialization - #3131 by @Pacu2\n- Do not collect unnecessary static files - #3050 by @jxltom\n- Remove host mounted volume in `docker-compose` - #3091 by @tiangolo\n- Remove custom services names in `docker-compose` - #3092 by @tiangolo\n- Replace COUNTRIES with countries.countries - #3079 by @neeraj1909\n- Installing dev packages in docker since tests are needed - #3078 by @jxltom\n- Remove comparing string in address-form-panel template - #3074 by @tomcio1205\n- Move updating variant names to a Celery task - #3189 by @fowczarek\n\n### Bugfixes\n\n- Fix typo in `clean_input` method - #3100 by @the-bionic\n- Fix typo in `ShippingMethod` model - #3099 by @the-bionic\n- Remove duplicated variable declaration - #3094 by @the-bionic\n\n### Docs\n\n- Add createdb note to getting started for Windows - #3106 by @ajostergaard\n- Update docs on pipenv - #3045 by @jxltom\n", "from unittest.mock import MagicMock\n\nimport graphene\nimport pytest\nfrom django.contrib.auth.models import Group\nfrom django.core.files import File\n\nfrom .....account.models import User\nfrom ....tests.utils import get_graphql_content\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_query_staff_user(\n    staff_api_client,\n    address,\n    permission_manage_users,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n    permission_manage_staff,\n    count_queries,\n):\n    group = permission_group_manage_users\n    group.permissions.add(permission_manage_products)\n\n    staff_user = group.user_set.first()\n    staff_user.user_permissions.add(permission_manage_orders, permission_manage_staff)\n    staff_user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    staff_user.avatar = avatar_mock\n    staff_user.save()\n\n    query = \"\"\"\n        query User($id: ID!) {\n            user(id: $id) {\n                email\n                firstName\n                lastName\n                isStaff\n                isActive\n                addresses {\n                    id\n                    isDefaultShippingAddress\n                    isDefaultBillingAddress\n                }\n                orders {\n                    totalCount\n                }\n                dateJoined\n                lastLogin\n                defaultShippingAddress {\n                    firstName\n                    lastName\n                    companyName\n                    streetAddress1\n                    streetAddress2\n                    city\n                    cityArea\n                    postalCode\n                    countryArea\n                    phone\n                    country {\n                        code\n                    }\n                    isDefaultShippingAddress\n                    isDefaultBillingAddress\n                }\n                defaultBillingAddress {\n                    firstName\n                    lastName\n                    companyName\n                    streetAddress1\n                    streetAddress2\n                    city\n                    cityArea\n                    postalCode\n                    countryArea\n                    phone\n                    country {\n                        code\n                    }\n                    isDefaultShippingAddress\n                    isDefaultBillingAddress\n                }\n                avatar {\n                    url\n                }\n                userPermissions {\n                    code\n                    name\n                }\n                permissionGroups {\n                    name\n                    permissions {\n                        code\n                    }\n                }\n            }\n        }\n    \"\"\"\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert data\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_staff_create(\n    staff_api_client,\n    staff_user,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_users,\n    count_queries,\n):\n    query = \"\"\"\n        mutation CreateStaff(\n                $email: String, $redirect_url: String, $add_groups: [ID!]\n            ) {\n            staffCreate(input: {email: $email, redirectUrl: $redirect_url,\n                    addGroups: $add_groups }) {\n                errors {\n                    field\n                    code\n                    permissions\n                    groups\n                }\n                user {\n                    id\n                    email\n                    isStaff\n                    isActive\n                    userPermissions {\n                        code\n                    }\n                    permissionGroups {\n                        name\n                        permissions {\n                            code\n                        }\n                    }\n                    avatar {\n                        url\n                    }\n                }\n            }\n        }\n    \"\"\"\n    group = permission_group_manage_users\n    staff_user.user_permissions.add(permission_manage_products, permission_manage_users)\n    email = \"api_user@example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": \"https://www.example.com\",\n        \"add_groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    staff_count = User.objects.filter(is_staff=True).count()\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n\n    assert User.objects.filter(is_staff=True).count() == staff_count + 1\n    assert data[\"user\"]\n    assert not data[\"errors\"]\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_staff_update_groups_and_permissions(\n    staff_api_client,\n    staff_users,\n    media_root,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n    count_queries,\n):\n    query = \"\"\"\n    mutation UpdateStaff(\n                $id: ID!, $input: StaffUpdateInput!) {\n            staffUpdate(\n                    id: $id,\n                    input: $input) {\n                errors {\n                    field\n                    code\n                    message\n                    permissions\n                    groups\n                }\n                user {\n                    userPermissions {\n                        code\n                    }\n                    permissionGroups {\n                        name\n                    }\n                    isActive\n                }\n            }\n        }\n    \"\"\"\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders and products\"),\n        ]\n    )\n    group1, group2, group3 = groups\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders, permission_manage_products)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1, staff_user2)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user2)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group2, group3]\n            ],\n            \"removeGroups\": [graphene.Node.to_global_id(\"Group\", group1.pk)],\n        },\n    }\n\n    staff_api_client.user.user_permissions.add(\n        permission_manage_users, permission_manage_orders, permission_manage_products\n    )\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert len(data[\"user\"][\"userPermissions\"]) == 3\n    assert {perm[\"code\"].lower() for perm in data[\"user\"][\"userPermissions\"]} == {\n        permission_manage_orders.codename,\n        permission_manage_products.codename,\n        permission_manage_staff.codename,\n    }\n    assert len(data[\"user\"][\"permissionGroups\"]) == 2\n    assert {group[\"name\"] for group in data[\"user\"][\"permissionGroups\"]} == {\n        group2.name,\n        group3.name,\n    }\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_delete_staff_members(\n    staff_api_client,\n    staff_users,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n    count_queries,\n):\n    \"\"\"Ensure user can delete users when all permissions will be manageable.\"\"\"\n    query = \"\"\"\n        mutation staffBulkDelete($ids: [ID]!) {\n            staffBulkDelete(ids: $ids) {\n                count\n                errors{\n                    code\n                    field\n                    permissions\n                    users\n                }\n            }\n        }\n    \"\"\"\n\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage users and orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders, permission_manage_users)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2, staff_user1, staff_user)\n    group3.user_set.add(staff_user1, staff_user)\n\n    staff_user.user_permissions.add(\n        permission_manage_users, permission_manage_orders, permission_manage_staff\n    )\n    variables = {\n        \"ids\": [\n            graphene.Node.to_global_id(\"User\", user.id)\n            for user in [staff_user1, staff_user2]\n        ]\n    }\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffBulkDelete\"]\n    errors = data[\"errors\"]\n\n    assert not errors\n    assert data[\"count\"] == 2\n    assert not User.objects.filter(\n        id__in=[user.id for user in [staff_user1, staff_user2]]\n    ).exists()\n\n\nCUSTOMERS_QUERY = \"\"\"\n    query accounts {\n        customers(first: 10) {\n            edges {\n                node {\n                    events { id }\n                    orders(first: 10) { edges { node { id } } }\n                    addresses { id }\n                    giftCards(first: 10) { edges { node { id } } }\n                    permissionGroups { id }\n                }\n            }\n        }\n    }\n\"\"\"\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_customers_query(\n    staff_api_client,\n    permission_manage_users,\n    users_for_customers_benchmarks,\n    count_queries,\n):\n    staff_api_client.user.user_permissions.set([permission_manage_users])\n    content = get_graphql_content(staff_api_client.post_graphql(CUSTOMERS_QUERY))\n    assert content[\"data\"][\"customers\"] is not None\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_users_for_federation_query_count(\n    customer_user,\n    customer_user2,\n    staff_api_client,\n    permission_manage_staff,\n    permission_manage_users,\n    django_assert_num_queries,\n    count_queries,\n):\n    query = \"\"\"\n        query GetUserInFederation($representations: [_Any]) {\n            _entities(representations: $representations) {\n                __typename\n                ... on User {\n                    id\n                    email\n                }\n            }\n        }\n    \"\"\"\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": graphene.Node.to_global_id(\"User\", customer_user.pk),\n            },\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    with django_assert_num_queries(4):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_staff, permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 2\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": graphene.Node.to_global_id(\"User\", customer_user.pk),\n            },\n            {\n                \"__typename\": \"User\",\n                \"id\": graphene.Node.to_global_id(\"User\", customer_user2.pk),\n            },\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user2.email,\n            },\n        ],\n    }\n\n    with django_assert_num_queries(4):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_staff, permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 4\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_addresses_for_federation_query_count(\n    address,\n    customer_user,\n    customer_user2,\n    staff_api_client,\n    permission_manage_users,\n    django_assert_num_queries,\n    count_queries,\n):\n    address2 = address.get_copy()\n    customer_user.addresses.add(address)\n    customer_user2.addresses.add(address2)\n\n    query = \"\"\"\n        query GetAddressInFederation($representations: [_Any]) {\n            _entities(representations: $representations) {\n                __typename\n                ... on Address {\n                    id\n                    city\n                }\n            }\n        }\n    \"\"\"\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": graphene.Node.to_global_id(\"Address\", address.pk),\n            },\n        ],\n    }\n\n    with django_assert_num_queries(3):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 1\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": graphene.Node.to_global_id(\"Address\", address.pk),\n            },\n            {\n                \"__typename\": \"Address\",\n                \"id\": graphene.Node.to_global_id(\"Address\", address2.pk),\n            },\n        ],\n    }\n\n    with django_assert_num_queries(3):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 2\n", "import datetime\nimport os\nimport re\nimport uuid\nfrom collections import defaultdict\nfrom datetime import timedelta\nfrom unittest.mock import ANY, MagicMock, Mock, patch\nfrom urllib.parse import urlencode\n\nimport graphene\nimport pytest\nfrom django.contrib.auth.models import Group\nfrom django.contrib.auth.tokens import default_token_generator\nfrom django.core.exceptions import ValidationError\nfrom django.core.files import File\nfrom django.test import override_settings\nfrom django.utils import timezone\nfrom freezegun import freeze_time\n\nfrom ....account import events as account_events\nfrom ....account.error_codes import AccountErrorCode\nfrom ....account.models import Address, User\nfrom ....account.notifications import get_default_user_payload\nfrom ....account.search import (\n    generate_address_search_document_value,\n    generate_user_fields_search_document_value,\n    prepare_user_search_document_value,\n)\nfrom ....checkout import AddressType\nfrom ....core.jwt import create_token\nfrom ....core.notify_events import NotifyEventType\nfrom ....core.permissions import AccountPermissions, OrderPermissions\nfrom ....core.tokens import account_delete_token_generator\nfrom ....core.utils.url import prepare_url\nfrom ....order import OrderStatus\nfrom ....order.models import FulfillmentStatus, Order\nfrom ....product.tests.utils import create_image\nfrom ...core.utils import str_to_enum\nfrom ...tests.utils import (\n    assert_graphql_error_with_message,\n    assert_no_permission,\n    get_graphql_content,\n    get_graphql_content_from_response,\n    get_multipart_request_body,\n)\nfrom ..mutations.base import INVALID_TOKEN\nfrom ..mutations.staff import CustomerDelete, StaffDelete, StaffUpdate, UserDelete\nfrom ..tests.utils import convert_dict_keys_to_camel_case\n\n\n@pytest.fixture\ndef query_customer_with_filter():\n    query = \"\"\"\n    query ($filter: CustomerFilterInput!, ) {\n        customers(first: 5, filter: $filter) {\n            totalCount\n            edges {\n                node {\n                    id\n                    lastName\n                    firstName\n                }\n            }\n        }\n    }\n    \"\"\"\n    return query\n\n\n@pytest.fixture\ndef query_staff_users_with_filter():\n    query = \"\"\"\n    query ($filter: StaffUserInput!, ) {\n        staffUsers(first: 5, filter: $filter) {\n            totalCount\n            edges {\n                node {\n                    id\n                    lastName\n                    firstName\n                }\n            }\n        }\n    }\n    \"\"\"\n    return query\n\n\nFULL_USER_QUERY = \"\"\"\n    query User($id: ID!) {\n        user(id: $id) {\n            email\n            firstName\n            lastName\n            isStaff\n            isActive\n            addresses {\n                id\n                isDefaultShippingAddress\n                isDefaultBillingAddress\n            }\n            orders(first: 10) {\n                totalCount\n                edges {\n                    node {\n                        id\n                    }\n                }\n            }\n            languageCode\n            dateJoined\n            lastLogin\n            defaultShippingAddress {\n                firstName\n                lastName\n                companyName\n                streetAddress1\n                streetAddress2\n                city\n                cityArea\n                postalCode\n                countryArea\n                phone\n                country {\n                    code\n                }\n                isDefaultShippingAddress\n                isDefaultBillingAddress\n            }\n            defaultBillingAddress {\n                firstName\n                lastName\n                companyName\n                streetAddress1\n                streetAddress2\n                city\n                cityArea\n                postalCode\n                countryArea\n                phone\n                country {\n                    code\n                }\n                isDefaultShippingAddress\n                isDefaultBillingAddress\n            }\n            avatar {\n                url\n            }\n            userPermissions {\n                code\n                sourcePermissionGroups(userId: $id) {\n                    name\n                }\n            }\n            permissionGroups {\n                name\n                permissions {\n                    code\n                }\n            }\n            editableGroups {\n                name\n            }\n            giftCards(first: 10) {\n                edges {\n                    node {\n                        id\n                    }\n                }\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_query_customer_user(\n    staff_api_client,\n    customer_user,\n    gift_card_used,\n    gift_card_expiry_date,\n    address,\n    permission_manage_users,\n    media_root,\n    settings,\n):\n    user = customer_user\n    user.default_shipping_address.country = \"US\"\n    user.default_shipping_address.save()\n    user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    Group.objects.create(name=\"empty group\")\n\n    query = FULL_USER_QUERY\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    staff_api_client.user.user_permissions.add(permission_manage_users)\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert data[\"email\"] == user.email\n    assert data[\"firstName\"] == user.first_name\n    assert data[\"lastName\"] == user.last_name\n    assert data[\"isStaff\"] == user.is_staff\n    assert data[\"isActive\"] == user.is_active\n    assert data[\"orders\"][\"totalCount\"] == user.orders.count()\n    assert data[\"avatar\"][\"url\"]\n    assert data[\"languageCode\"] == settings.LANGUAGE_CODE.upper()\n    assert len(data[\"editableGroups\"]) == 0\n\n    assert len(data[\"addresses\"]) == user.addresses.count()\n    for address in data[\"addresses\"]:\n        if address[\"isDefaultShippingAddress\"]:\n            address_id = graphene.Node.to_global_id(\n                \"Address\", user.default_shipping_address.id\n            )\n            assert address[\"id\"] == address_id\n        if address[\"isDefaultBillingAddress\"]:\n            address_id = graphene.Node.to_global_id(\n                \"Address\", user.default_billing_address.id\n            )\n            assert address[\"id\"] == address_id\n\n    address = data[\"defaultShippingAddress\"]\n    user_address = user.default_shipping_address\n    assert address[\"firstName\"] == user_address.first_name\n    assert address[\"lastName\"] == user_address.last_name\n    assert address[\"companyName\"] == user_address.company_name\n    assert address[\"streetAddress1\"] == user_address.street_address_1\n    assert address[\"streetAddress2\"] == user_address.street_address_2\n    assert address[\"city\"] == user_address.city\n    assert address[\"cityArea\"] == user_address.city_area\n    assert address[\"postalCode\"] == user_address.postal_code\n    assert address[\"country\"][\"code\"] == user_address.country.code\n    assert address[\"countryArea\"] == user_address.country_area\n    assert address[\"phone\"] == user_address.phone.as_e164\n    assert address[\"isDefaultShippingAddress\"] is None\n    assert address[\"isDefaultBillingAddress\"] is None\n\n    address = data[\"defaultBillingAddress\"]\n    user_address = user.default_billing_address\n    assert address[\"firstName\"] == user_address.first_name\n    assert address[\"lastName\"] == user_address.last_name\n    assert address[\"companyName\"] == user_address.company_name\n    assert address[\"streetAddress1\"] == user_address.street_address_1\n    assert address[\"streetAddress2\"] == user_address.street_address_2\n    assert address[\"city\"] == user_address.city\n    assert address[\"cityArea\"] == user_address.city_area\n    assert address[\"postalCode\"] == user_address.postal_code\n    assert address[\"country\"][\"code\"] == user_address.country.code\n    assert address[\"countryArea\"] == user_address.country_area\n    assert address[\"phone\"] == user_address.phone.as_e164\n    assert address[\"isDefaultShippingAddress\"] is None\n    assert address[\"isDefaultBillingAddress\"] is None\n    assert len(data[\"giftCards\"]) == 1\n    assert data[\"giftCards\"][\"edges\"][0][\"node\"][\"id\"] == graphene.Node.to_global_id(\n        \"GiftCard\", gift_card_used.pk\n    )\n\n\ndef test_query_customer_user_with_orders(\n    staff_api_client,\n    customer_user,\n    order_list,\n    permission_manage_users,\n):\n    # given\n    query = FULL_USER_QUERY\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = customer_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = customer_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = customer_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": id}\n\n    # when\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # then\n    content = get_graphql_content(response)\n    user = content[\"data\"][\"user\"]\n    assert {order[\"node\"][\"id\"] for order in user[\"orders\"][\"edges\"]} == {\n        graphene.Node.to_global_id(\"Order\", order.pk)\n        for order in [order_unfulfilled, order_unconfirmed]\n    }\n\n\ndef test_query_customer_user_app(\n    app_api_client,\n    customer_user,\n    address,\n    permission_manage_users,\n    permission_manage_staff,\n    media_root,\n    app,\n):\n    user = customer_user\n    user.default_shipping_address.country = \"US\"\n    user.default_shipping_address.save()\n    user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    Group.objects.create(name=\"empty group\")\n\n    query = FULL_USER_QUERY\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    app.permissions.add(permission_manage_staff, permission_manage_users)\n    response = app_api_client.post_graphql(query, variables)\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert data[\"email\"] == user.email\n\n\ndef test_query_customer_user_app_no_permission(\n    app_api_client,\n    customer_user,\n    address,\n    permission_manage_users,\n    permission_manage_staff,\n    media_root,\n    app,\n):\n    user = customer_user\n    user.default_shipping_address.country = \"US\"\n    user.default_shipping_address.save()\n    user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    Group.objects.create(name=\"empty group\")\n\n    query = FULL_USER_QUERY\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    app.permissions.add(permission_manage_staff)\n    response = app_api_client.post_graphql(query, variables)\n\n    assert_no_permission(response)\n\n\ndef test_query_staff_user(\n    staff_api_client,\n    staff_user,\n    address,\n    permission_manage_users,\n    media_root,\n    permission_manage_orders,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_menus,\n):\n    staff_user.user_permissions.add(permission_manage_orders, permission_manage_staff)\n\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"another user group\"),\n            Group(name=\"another group\"),\n            Group(name=\"empty group\"),\n        ]\n    )\n    group1, group2, group3, group4 = groups\n\n    group1.permissions.add(permission_manage_users, permission_manage_products)\n\n    # user groups\n    staff_user.groups.add(group1, group2)\n\n    # another group (not user group) with permission_manage_users\n    group3.permissions.add(permission_manage_users, permission_manage_menus)\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image2.jpg\"\n    staff_user.avatar = avatar_mock\n    staff_user.save()\n\n    query = FULL_USER_QUERY\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n\n    assert data[\"email\"] == staff_user.email\n    assert data[\"firstName\"] == staff_user.first_name\n    assert data[\"lastName\"] == staff_user.last_name\n    assert data[\"isStaff\"] == staff_user.is_staff\n    assert data[\"isActive\"] == staff_user.is_active\n    assert data[\"orders\"][\"totalCount\"] == staff_user.orders.count()\n    assert data[\"avatar\"][\"url\"]\n\n    assert len(data[\"permissionGroups\"]) == 2\n    assert {group_data[\"name\"] for group_data in data[\"permissionGroups\"]} == {\n        group1.name,\n        group2.name,\n    }\n    assert len(data[\"userPermissions\"]) == 4\n    assert len(data[\"editableGroups\"]) == Group.objects.count() - 1\n    assert {data_group[\"name\"] for data_group in data[\"editableGroups\"]} == {\n        group1.name,\n        group2.name,\n        group4.name,\n    }\n\n    formated_user_permissions_result = [\n        {\n            \"code\": perm[\"code\"].lower(),\n            \"groups\": {group[\"name\"] for group in perm[\"sourcePermissionGroups\"]},\n        }\n        for perm in data[\"userPermissions\"]\n    ]\n    all_permissions = group1.permissions.all() | staff_user.user_permissions.all()\n    for perm in all_permissions:\n        source_groups = {group.name for group in perm.group_set.filter(user=staff_user)}\n        expected_data = {\"code\": perm.codename, \"groups\": source_groups}\n        assert expected_data in formated_user_permissions_result\n\n\ndef test_query_staff_user_with_order_and_without_manage_orders_perm(\n    staff_api_client,\n    staff_user,\n    order_list,\n    permission_manage_staff,\n):\n    # given\n    staff_user.user_permissions.add(permission_manage_staff)\n\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = staff_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = staff_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = staff_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    query = FULL_USER_QUERY\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n\n    assert data[\"email\"] == staff_user.email\n    assert data[\"orders\"][\"totalCount\"] == 2\n    assert {node[\"node\"][\"id\"] for node in data[\"orders\"][\"edges\"]} == {\n        graphene.Node.to_global_id(\"Order\", order.pk)\n        for order in [order_unfulfilled, order_unconfirmed]\n    }\n\n\ndef test_query_staff_user_with_orders_and_manage_orders_perm(\n    staff_api_client,\n    staff_user,\n    order_list,\n    permission_manage_staff,\n    permission_manage_orders,\n):\n    # given\n    staff_user.user_permissions.add(permission_manage_staff, permission_manage_orders)\n\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = staff_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = staff_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = staff_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    query = FULL_USER_QUERY\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n\n    assert data[\"email\"] == staff_user.email\n    assert data[\"orders\"][\"totalCount\"] == 3\n    assert {node[\"node\"][\"id\"] for node in data[\"orders\"][\"edges\"]} == {\n        graphene.Node.to_global_id(\"Order\", order.pk)\n        for order in [order_unfulfilled, order_unconfirmed, order_draft]\n    }\n\n\nUSER_QUERY = \"\"\"\n    query User($id: ID $email: String) {\n        user(id: $id, email: $email) {\n            id\n            email\n        }\n    }\n\"\"\"\n\n\ndef test_query_user_by_email_address(\n    user_api_client, customer_user, permission_manage_users\n):\n    email = customer_user.email\n    variables = {\"email\": email}\n    response = user_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert customer_user.email == data[\"email\"]\n\n\ndef test_query_user_by_id_and_email(\n    user_api_client, customer_user, permission_manage_users\n):\n    email = customer_user.email\n    id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\n        \"id\": id,\n        \"email\": email,\n    }\n    response = user_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    assert_graphql_error_with_message(\n        response, \"Argument 'id' cannot be combined with 'email'\"\n    )\n\n\ndef test_customer_can_not_see_other_users_data(user_api_client, staff_user):\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id}\n    response = user_api_client.post_graphql(USER_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_user_query_anonymous_user(api_client):\n    variables = {\"id\": \"\"}\n    response = api_client.post_graphql(USER_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_user_query_permission_manage_users_get_customer(\n    staff_api_client, customer_user, permission_manage_users\n):\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\"id\": customer_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert customer_user.email == data[\"email\"]\n\n\ndef test_user_query_as_app(app_api_client, customer_user, permission_manage_users):\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\"id\": customer_id}\n    response = app_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert customer_user.email == data[\"email\"]\n\n\ndef test_user_query_permission_manage_users_get_staff(\n    staff_api_client, staff_user, permission_manage_users\n):\n    staff_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": staff_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    assert not content[\"data\"][\"user\"]\n\n\ndef test_user_query_permission_manage_staff_get_customer(\n    staff_api_client, customer_user, permission_manage_staff\n):\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\"id\": customer_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    assert not content[\"data\"][\"user\"]\n\n\ndef test_user_query_permission_manage_staff_get_staff(\n    staff_api_client, staff_user, permission_manage_staff\n):\n    staff_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": staff_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert staff_user.email == data[\"email\"]\n\n\n@pytest.mark.parametrize(\"id\", [\"'\", \"abc\"])\ndef test_user_query_invalid_id(\n    id, staff_api_client, customer_user, permission_manage_users\n):\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n\n    content = get_graphql_content_from_response(response)\n    assert len(content[\"errors\"]) == 1\n    assert content[\"errors\"][0][\"message\"] == f\"Couldn't resolve id: {id}.\"\n    assert content[\"data\"][\"user\"] is None\n\n\ndef test_user_query_object_with_given_id_does_not_exist(\n    staff_api_client, permission_manage_users\n):\n    id = graphene.Node.to_global_id(\"User\", -1)\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"user\"] is None\n\n\ndef test_user_query_object_with_invalid_object_type(\n    staff_api_client, customer_user, permission_manage_users\n):\n    id = graphene.Node.to_global_id(\"Order\", customer_user.pk)\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"user\"] is None\n\n\ndef test_query_customers(staff_api_client, user_api_client, permission_manage_users):\n    query = \"\"\"\n    query Users {\n        customers(first: 20) {\n            totalCount\n            edges {\n                node {\n                    isStaff\n                }\n            }\n        }\n    }\n    \"\"\"\n    variables = {}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert users\n    assert all([not user[\"node\"][\"isStaff\"] for user in users])\n\n    # check permissions\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_query_staff(\n    staff_api_client, user_api_client, staff_user, admin_user, permission_manage_staff\n):\n    query = \"\"\"\n    {\n        staffUsers(first: 20) {\n            edges {\n                node {\n                    email\n                    isStaff\n                }\n            }\n        }\n    }\n    \"\"\"\n    variables = {}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUsers\"][\"edges\"]\n    assert len(data) == 2\n    staff_emails = [user[\"node\"][\"email\"] for user in data]\n    assert sorted(staff_emails) == [admin_user.email, staff_user.email]\n    assert all([user[\"node\"][\"isStaff\"] for user in data])\n\n    # check permissions\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_who_can_see_user(\n    staff_user, customer_user, staff_api_client, permission_manage_users\n):\n    query = \"\"\"\n    query Users {\n        customers {\n            totalCount\n        }\n    }\n    \"\"\"\n\n    # Random person (even staff) can't see users data without permissions\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    response = staff_api_client.post_graphql(USER_QUERY, variables)\n    assert_no_permission(response)\n\n    response = staff_api_client.post_graphql(query)\n    assert_no_permission(response)\n\n    # Add permission and ensure staff can see user(s)\n    staff_user.user_permissions.add(permission_manage_users)\n    response = staff_api_client.post_graphql(USER_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"user\"][\"email\"] == customer_user.email\n\n    response = staff_api_client.post_graphql(query)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"customers\"][\"totalCount\"] == 1\n\n\nME_QUERY = \"\"\"\n    query Me {\n        me {\n            id\n            email\n            checkout {\n                token\n            }\n            userPermissions {\n                code\n                name\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_me_query(user_api_client):\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert data[\"email\"] == user_api_client.user.email\n\n\ndef test_me_user_permissions_query(\n    user_api_client, permission_manage_users, permission_group_manage_users\n):\n    user = user_api_client.user\n    user.user_permissions.add(permission_manage_users)\n    user.groups.add(permission_group_manage_users)\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    user_permissions = content[\"data\"][\"me\"][\"userPermissions\"]\n\n    assert len(user_permissions) == 1\n    assert user_permissions[0][\"code\"] == permission_manage_users.codename.upper()\n\n\ndef test_me_query_anonymous_client(api_client):\n    response = api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"me\"] is None\n\n\ndef test_me_query_customer_can_not_see_note(\n    staff_user, staff_api_client, permission_manage_users\n):\n    query = \"\"\"\n    query Me {\n        me {\n            id\n            email\n            note\n        }\n    }\n    \"\"\"\n    # Random person (even staff) can't see own note without permissions\n    response = staff_api_client.post_graphql(query)\n    assert_no_permission(response)\n\n    # Add permission and ensure staff can see own note\n    response = staff_api_client.post_graphql(\n        query, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert data[\"email\"] == staff_api_client.user.email\n    assert data[\"note\"] == staff_api_client.user.note\n\n\ndef test_me_query_checkout(user_api_client, checkout):\n    user = user_api_client.user\n    checkout.user = user\n    checkout.save()\n\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert data[\"checkout\"][\"token\"] == str(checkout.token)\n\n\ndef test_me_query_checkout_with_inactive_channel(user_api_client, checkout):\n    user = user_api_client.user\n    channel = checkout.channel\n    channel.is_active = False\n    channel.save()\n    checkout.user = user\n    checkout.save()\n\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert not data[\"checkout\"]\n\n\nQUERY_ME_CHECKOUT_TOKENS = \"\"\"\nquery getCheckoutTokens($channel: String) {\n  me {\n    checkoutTokens(channel: $channel)\n  }\n}\n\"\"\"\n\n\ndef test_me_checkout_tokens_without_channel_param(\n    user_api_client, checkouts_assigned_to_customer\n):\n    # given\n    checkouts = checkouts_assigned_to_customer\n\n    # when\n    response = user_api_client.post_graphql(QUERY_ME_CHECKOUT_TOKENS)\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert len(data[\"checkoutTokens\"]) == len(checkouts)\n    for checkout in checkouts:\n        assert str(checkout.token) in data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_without_channel_param_inactive_channel(\n    user_api_client, channel_PLN, checkouts_assigned_to_customer\n):\n    # given\n    channel_PLN.is_active = False\n    channel_PLN.save()\n    checkouts = checkouts_assigned_to_customer\n\n    # when\n    response = user_api_client.post_graphql(QUERY_ME_CHECKOUT_TOKENS)\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert str(checkouts[0].token) in data[\"checkoutTokens\"]\n    assert not str(checkouts[1].token) in data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_with_channel(\n    user_api_client, channel_USD, checkouts_assigned_to_customer\n):\n    # given\n    checkouts = checkouts_assigned_to_customer\n\n    # when\n    response = user_api_client.post_graphql(\n        QUERY_ME_CHECKOUT_TOKENS, {\"channel\": channel_USD.slug}\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert str(checkouts[0].token) in data[\"checkoutTokens\"]\n    assert not str(checkouts[1].token) in data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_with_inactive_channel(\n    user_api_client, channel_USD, checkouts_assigned_to_customer\n):\n    # given\n    channel_USD.is_active = False\n    channel_USD.save()\n\n    # when\n    response = user_api_client.post_graphql(\n        QUERY_ME_CHECKOUT_TOKENS, {\"channel\": channel_USD.slug}\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert not data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_with_not_existing_channel(\n    user_api_client, checkouts_assigned_to_customer\n):\n    # given\n\n    # when\n    response = user_api_client.post_graphql(\n        QUERY_ME_CHECKOUT_TOKENS, {\"channel\": \"Not-existing\"}\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert not data[\"checkoutTokens\"]\n\n\ndef test_me_with_cancelled_fulfillments(\n    user_api_client, fulfilled_order_with_cancelled_fulfillment\n):\n    query = \"\"\"\n    query Me {\n        me {\n            orders (first: 1) {\n                edges {\n                    node {\n                        id\n                        fulfillments {\n                            status\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \"\"\"\n    response = user_api_client.post_graphql(query)\n    content = get_graphql_content(response)\n    order_id = graphene.Node.to_global_id(\n        \"Order\", fulfilled_order_with_cancelled_fulfillment.id\n    )\n    data = content[\"data\"][\"me\"]\n    order = data[\"orders\"][\"edges\"][0][\"node\"]\n    assert order[\"id\"] == order_id\n    fulfillments = order[\"fulfillments\"]\n    assert len(fulfillments) == 1\n    assert fulfillments[0][\"status\"] == FulfillmentStatus.FULFILLED.upper()\n\n\ndef test_user_with_cancelled_fulfillments(\n    staff_api_client,\n    customer_user,\n    permission_manage_users,\n    fulfilled_order_with_cancelled_fulfillment,\n):\n    query = \"\"\"\n    query User($id: ID!) {\n        user(id: $id) {\n            orders (first: 1) {\n                edges {\n                    node {\n                        id\n                        fulfillments {\n                            status\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \"\"\"\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": user_id}\n    staff_api_client.user.user_permissions.add(permission_manage_users)\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    order_id = graphene.Node.to_global_id(\n        \"Order\", fulfilled_order_with_cancelled_fulfillment.id\n    )\n    data = content[\"data\"][\"user\"]\n    order = data[\"orders\"][\"edges\"][0][\"node\"]\n    assert order[\"id\"] == order_id\n    fulfillments = order[\"fulfillments\"]\n    assert len(fulfillments) == 2\n    assert fulfillments[0][\"status\"] == FulfillmentStatus.FULFILLED.upper()\n    assert fulfillments[1][\"status\"] == FulfillmentStatus.CANCELED.upper()\n\n\nACCOUNT_REGISTER_MUTATION = \"\"\"\n    mutation RegisterAccount(\n        $password: String!,\n        $email: String!,\n        $firstName: String,\n        $lastName: String,\n        $redirectUrl: String,\n        $languageCode: LanguageCodeEnum\n        $metadata: [MetadataInput!],\n        $channel: String\n    ) {\n        accountRegister(\n            input: {\n                password: $password,\n                email: $email,\n                firstName: $firstName,\n                lastName: $lastName,\n                redirectUrl: $redirectUrl,\n                languageCode: $languageCode,\n                metadata: $metadata,\n                channel: $channel\n            }\n        ) {\n            errors {\n                field\n                message\n                code\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\n@override_settings(\n    ENABLE_ACCOUNT_CONFIRMATION_BY_EMAIL=True, ALLOWED_CLIENT_HOSTS=[\"localhost\"]\n)\n@patch(\"saleor.account.notifications.default_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_register(\n    mocked_notify,\n    mocked_generator,\n    api_client,\n    channel_PLN,\n    order,\n):\n    mocked_generator.return_value = \"token\"\n    email = \"customer@example.com\"\n\n    redirect_url = \"http://localhost:3000\"\n    variables = {\n        \"email\": email,\n        \"password\": \"Password\",\n        \"redirectUrl\": redirect_url,\n        \"firstName\": \"saleor\",\n        \"lastName\": \"rocks\",\n        \"languageCode\": \"PL\",\n        \"metadata\": [{\"key\": \"meta\", \"value\": \"data\"}],\n        \"channel\": channel_PLN.slug,\n    }\n    query = ACCOUNT_REGISTER_MUTATION\n    mutation_name = \"accountRegister\"\n\n    response = api_client.post_graphql(query, variables)\n\n    new_user = User.objects.get(email=email)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    params = urlencode({\"email\": email, \"token\": \"token\"})\n    confirm_url = prepare_url(params, redirect_url)\n\n    expected_payload = {\n        \"user\": get_default_user_payload(new_user),\n        \"token\": \"token\",\n        \"confirm_url\": confirm_url,\n        \"recipient_email\": new_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n    assert new_user.metadata == {\"meta\": \"data\"}\n    assert new_user.language_code == \"pl\"\n    assert new_user.first_name == variables[\"firstName\"]\n    assert new_user.last_name == variables[\"lastName\"]\n    assert new_user.search_document == generate_user_fields_search_document_value(\n        new_user\n    )\n    assert not data[\"errors\"]\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_CONFIRMATION,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n    response = api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert data[\"errors\"]\n    assert data[\"errors\"][0][\"field\"] == \"email\"\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.UNIQUE.name\n\n    customer_creation_event = account_events.CustomerEvent.objects.get()\n    assert customer_creation_event.type == account_events.CustomerEvents.ACCOUNT_CREATED\n    assert customer_creation_event.user == new_user\n\n\n@override_settings(ENABLE_ACCOUNT_CONFIRMATION_BY_EMAIL=False)\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_register_disabled_email_confirmation(mocked_notify, api_client):\n    email = \"customer@example.com\"\n    variables = {\"email\": email, \"password\": \"Password\"}\n    response = api_client.post_graphql(ACCOUNT_REGISTER_MUTATION, variables)\n    errors = response.json()[\"data\"][\"accountRegister\"][\"errors\"]\n\n    assert errors == []\n    created_user = User.objects.get()\n    expected_payload = get_default_user_payload(created_user)\n    expected_payload[\"token\"] = \"token\"\n    expected_payload[\"redirect_url\"] = \"http://localhost:3000\"\n    mocked_notify.assert_not_called()\n\n\n@override_settings(ENABLE_ACCOUNT_CONFIRMATION_BY_EMAIL=True)\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_register_no_redirect_url(mocked_notify, api_client):\n    variables = {\"email\": \"customer@example.com\", \"password\": \"Password\"}\n    response = api_client.post_graphql(ACCOUNT_REGISTER_MUTATION, variables)\n    errors = response.json()[\"data\"][\"accountRegister\"][\"errors\"]\n    assert \"redirectUrl\" in map(lambda error: error[\"field\"], errors)\n    mocked_notify.assert_not_called()\n\n\nCUSTOMER_CREATE_MUTATION = \"\"\"\n    mutation CreateCustomer(\n        $email: String, $firstName: String, $lastName: String, $channel: String\n        $note: String, $billing: AddressInput, $shipping: AddressInput,\n        $redirect_url: String, $languageCode: LanguageCodeEnum) {\n        customerCreate(input: {\n            email: $email,\n            firstName: $firstName,\n            lastName: $lastName,\n            note: $note,\n            defaultShippingAddress: $shipping,\n            defaultBillingAddress: $billing,\n            redirectUrl: $redirect_url,\n            languageCode: $languageCode,\n            channel: $channel,\n        }) {\n            errors {\n                field\n                code\n                message\n            }\n            user {\n                id\n                defaultBillingAddress {\n                    id\n                }\n                defaultShippingAddress {\n                    id\n                }\n                languageCode\n                email\n                firstName\n                lastName\n                isActive\n                isStaff\n                note\n            }\n        }\n    }\n\"\"\"\n\n\n@patch(\"saleor.account.notifications.default_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_create(\n    mocked_notify,\n    mocked_generator,\n    staff_api_client,\n    address,\n    permission_manage_users,\n    channel_PLN,\n):\n    mocked_generator.return_value = \"token\"\n    email = \"api_user@example.com\"\n    first_name = \"api_first_name\"\n    last_name = \"api_last_name\"\n    note = \"Test user\"\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": email,\n        \"firstName\": first_name,\n        \"lastName\": last_name,\n        \"note\": note,\n        \"shipping\": address_data,\n        \"billing\": address_data,\n        \"redirect_url\": redirect_url,\n        \"languageCode\": \"PL\",\n        \"channel\": channel_PLN.slug,\n    }\n\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n\n    new_customer = User.objects.get(email=email)\n\n    shipping_address, billing_address = (\n        new_customer.default_shipping_address,\n        new_customer.default_billing_address,\n    )\n    assert shipping_address == address\n    assert billing_address == address\n    assert shipping_address.pk != billing_address.pk\n\n    data = content[\"data\"][\"customerCreate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"email\"] == email\n    assert data[\"user\"][\"firstName\"] == first_name\n    assert data[\"user\"][\"lastName\"] == last_name\n    assert data[\"user\"][\"note\"] == note\n    assert data[\"user\"][\"languageCode\"] == \"PL\"\n    assert not data[\"user\"][\"isStaff\"]\n    assert data[\"user\"][\"isActive\"]\n\n    new_user = User.objects.get(email=email)\n    assert (\n        generate_user_fields_search_document_value(new_user) in new_user.search_document\n    )\n    assert generate_address_search_document_value(address) in new_user.search_document\n    params = urlencode({\"email\": new_user.email, \"token\": \"token\"})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(new_user),\n        \"token\": \"token\",\n        \"password_set_url\": password_set_url,\n        \"recipient_email\": new_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_CUSTOMER_PASSWORD,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n    assert set([shipping_address, billing_address]) == set(new_user.addresses.all())\n    customer_creation_event = account_events.CustomerEvent.objects.get()\n    assert customer_creation_event.type == account_events.CustomerEvents.ACCOUNT_CREATED\n    assert customer_creation_event.user == new_customer\n\n\n@patch(\"saleor.account.notifications.default_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_create_send_password_with_url(\n    mocked_notify,\n    mocked_generator,\n    staff_api_client,\n    permission_manage_users,\n    channel_PLN,\n):\n    mocked_generator.return_value = \"token\"\n    email = \"api_user@example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": \"https://www.example.com\",\n        \"channel\": channel_PLN.slug,\n    }\n\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert not data[\"errors\"]\n\n    new_customer = User.objects.get(email=email)\n    assert new_customer\n    redirect_url = \"https://www.example.com\"\n    params = urlencode({\"email\": email, \"token\": \"token\"})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(new_customer),\n        \"password_set_url\": password_set_url,\n        \"token\": \"token\",\n        \"recipient_email\": new_customer.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_CUSTOMER_PASSWORD,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\ndef test_customer_create_without_send_password(\n    staff_api_client, permission_manage_users\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email}\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert not data[\"errors\"]\n    User.objects.get(email=email)\n\n\ndef test_customer_create_with_invalid_url(staff_api_client, permission_manage_users):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"invalid\"}\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"message\": ANY,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\ndef test_customer_create_with_not_allowed_url(\n    staff_api_client, permission_manage_users\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"https://www.fake.com\"}\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"message\": ANY,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\ndef test_customer_update(\n    staff_api_client, staff_user, customer_user, address, permission_manage_users\n):\n    query = \"\"\"\n    mutation UpdateCustomer(\n            $id: ID!, $firstName: String, $lastName: String,\n            $isActive: Boolean, $note: String, $billing: AddressInput,\n            $shipping: AddressInput, $languageCode: LanguageCodeEnum) {\n        customerUpdate(id: $id, input: {\n            isActive: $isActive,\n            firstName: $firstName,\n            lastName: $lastName,\n            note: $note,\n            defaultBillingAddress: $billing\n            defaultShippingAddress: $shipping,\n            languageCode: $languageCode\n        }) {\n            errors {\n                field\n                message\n            }\n            user {\n                id\n                firstName\n                lastName\n                defaultBillingAddress {\n                    id\n                }\n                defaultShippingAddress {\n                    id\n                }\n                languageCode\n                isActive\n                note\n            }\n        }\n    }\n    \"\"\"\n\n    # this test requires addresses to be set and checks whether new address\n    # instances weren't created, but the existing ones got updated\n    assert customer_user.default_billing_address\n    assert customer_user.default_shipping_address\n    billing_address_pk = customer_user.default_billing_address.pk\n    shipping_address_pk = customer_user.default_shipping_address.pk\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    first_name = \"new_first_name\"\n    last_name = \"new_last_name\"\n    note = \"Test update note\"\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": first_name,\n        \"lastName\": last_name,\n        \"isActive\": False,\n        \"note\": note,\n        \"billing\": address_data,\n        \"shipping\": address_data,\n        \"languageCode\": \"PL\",\n    }\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n\n    customer = User.objects.get(email=customer_user.email)\n\n    # check that existing instances are updated\n    shipping_address, billing_address = (\n        customer.default_shipping_address,\n        customer.default_billing_address,\n    )\n    assert billing_address.pk == billing_address_pk\n    assert shipping_address.pk == shipping_address_pk\n\n    assert billing_address.street_address_1 == new_street_address\n    assert shipping_address.street_address_1 == new_street_address\n\n    data = content[\"data\"][\"customerUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"firstName\"] == first_name\n    assert data[\"user\"][\"lastName\"] == last_name\n    assert data[\"user\"][\"note\"] == note\n    assert data[\"user\"][\"languageCode\"] == \"PL\"\n    assert not data[\"user\"][\"isActive\"]\n\n    # The name was changed, an event should have been triggered\n    name_changed_event = account_events.CustomerEvent.objects.get()\n    assert name_changed_event.type == account_events.CustomerEvents.NAME_ASSIGNED\n    assert name_changed_event.user.pk == staff_user.pk\n    assert name_changed_event.parameters == {\"message\": customer.get_full_name()}\n    customer_user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(billing_address)\n        in customer_user.search_document\n    )\n    assert (\n        generate_address_search_document_value(shipping_address)\n        in customer_user.search_document\n    )\n\n\nUPDATE_CUSTOMER_EMAIL_MUTATION = \"\"\"\n    mutation UpdateCustomer(\n            $id: ID!, $firstName: String, $lastName: String, $email: String) {\n        customerUpdate(id: $id, input: {\n            firstName: $firstName,\n            lastName: $lastName,\n            email: $email\n        }) {\n            errors {\n                field\n                message\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_customer_update_generates_event_when_changing_email(\n    staff_api_client, staff_user, customer_user, address, permission_manage_users\n):\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": \"mirumee@example.com\",\n    }\n    staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # The email was changed, an event should have been triggered\n    email_changed_event = account_events.CustomerEvent.objects.get()\n    assert email_changed_event.type == account_events.CustomerEvents.EMAIL_ASSIGNED\n    assert email_changed_event.user.pk == staff_user.pk\n    assert email_changed_event.parameters == {\"message\": \"mirumee@example.com\"}\n\n\ndef test_customer_update_without_any_changes_generates_no_event(\n    staff_api_client, customer_user, address, permission_manage_users\n):\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": customer_user.email,\n    }\n    staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # No event should have been generated\n    assert not account_events.CustomerEvent.objects.exists()\n\n\ndef test_customer_update_generates_event_when_changing_email_by_app(\n    app_api_client, staff_user, customer_user, address, permission_manage_users\n):\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": \"mirumee@example.com\",\n    }\n    app_api_client.post_graphql(query, variables, permissions=[permission_manage_users])\n\n    # The email was changed, an event should have been triggered\n    email_changed_event = account_events.CustomerEvent.objects.get()\n    assert email_changed_event.type == account_events.CustomerEvents.EMAIL_ASSIGNED\n    assert email_changed_event.user is None\n    assert email_changed_event.parameters == {\"message\": \"mirumee@example.com\"}\n\n\ndef test_customer_update_assign_gift_cards_and_orders(\n    staff_api_client,\n    staff_user,\n    customer_user,\n    address,\n    gift_card,\n    order,\n    permission_manage_users,\n):\n    # given\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n    new_email = \"mirumee@example.com\"\n\n    gift_card.created_by = None\n    gift_card.created_by_email = new_email\n    gift_card.save(update_fields=[\"created_by\", \"created_by_email\"])\n\n    order.user = None\n    order.user_email = new_email\n    order.save(update_fields=[\"user_email\", \"user\"])\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": new_email,\n    }\n\n    # when\n    staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # then\n    email_changed_event = account_events.CustomerEvent.objects.get()\n    assert email_changed_event.type == account_events.CustomerEvents.EMAIL_ASSIGNED\n    gift_card.refresh_from_db()\n    customer_user.refresh_from_db()\n    assert gift_card.created_by == customer_user\n    assert gift_card.created_by_email == customer_user.email\n    order.refresh_from_db()\n    assert order.user == customer_user\n\n\nACCOUNT_UPDATE_QUERY = \"\"\"\n    mutation accountUpdate(\n        $billing: AddressInput\n        $shipping: AddressInput\n        $firstName: String,\n        $lastName: String\n        $languageCode: LanguageCodeEnum\n    ) {\n        accountUpdate(\n          input: {\n            defaultBillingAddress: $billing,\n            defaultShippingAddress: $shipping,\n            firstName: $firstName,\n            lastName: $lastName,\n            languageCode: $languageCode\n        }) {\n            errors {\n                field\n                code\n                message\n                addressType\n            }\n            user {\n                firstName\n                lastName\n                email\n                defaultBillingAddress {\n                    id\n                }\n                defaultShippingAddress {\n                    id\n                }\n                languageCode\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_logged_customer_updates_language_code(user_api_client):\n    language_code = \"PL\"\n    user = user_api_client.user\n    assert user.language_code != language_code\n    variables = {\"languageCode\": language_code}\n\n    response = user_api_client.post_graphql(ACCOUNT_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountUpdate\"]\n\n    assert not data[\"errors\"]\n    assert data[\"user\"][\"languageCode\"] == language_code\n    user.refresh_from_db()\n    assert user.language_code == language_code.lower()\n    assert user.search_document\n\n\ndef test_logged_customer_update_names(user_api_client):\n    first_name = \"first\"\n    last_name = \"last\"\n    user = user_api_client.user\n    assert user.first_name != first_name\n    assert user.last_name != last_name\n\n    variables = {\"firstName\": first_name, \"lastName\": last_name}\n    response = user_api_client.post_graphql(ACCOUNT_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountUpdate\"]\n\n    user.refresh_from_db()\n    assert not data[\"errors\"]\n    assert user.first_name == first_name\n    assert user.last_name == last_name\n\n\ndef test_logged_customer_update_addresses(user_api_client, graphql_address_data):\n    # this test requires addresses to be set and checks whether new address\n    # instances weren't created, but the existing ones got updated\n    user = user_api_client.user\n    new_first_name = graphql_address_data[\"firstName\"]\n    assert user.default_billing_address\n    assert user.default_shipping_address\n    assert user.default_billing_address.first_name != new_first_name\n    assert user.default_shipping_address.first_name != new_first_name\n\n    query = ACCOUNT_UPDATE_QUERY\n    mutation_name = \"accountUpdate\"\n    variables = {\"billing\": graphql_address_data, \"shipping\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    # check that existing instances are updated\n    billing_address_pk = user.default_billing_address.pk\n    shipping_address_pk = user.default_shipping_address.pk\n    user = User.objects.get(email=user.email)\n    assert user.default_billing_address.pk == billing_address_pk\n    assert user.default_shipping_address.pk == shipping_address_pk\n\n    assert user.default_billing_address.first_name == new_first_name\n    assert user.default_shipping_address.first_name == new_first_name\n    assert user.search_document\n\n\ndef test_logged_customer_update_addresses_invalid_shipping_address(\n    user_api_client, graphql_address_data\n):\n    shipping_address = graphql_address_data.copy()\n    del shipping_address[\"country\"]\n\n    query = ACCOUNT_UPDATE_QUERY\n    mutation_name = \"accountUpdate\"\n    variables = {\"billing\": graphql_address_data, \"shipping\": shipping_address}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert len(data[\"errors\"]) == 1\n    errors = data[\"errors\"]\n    assert errors[0][\"field\"] == \"country\"\n    assert errors[0][\"code\"] == AccountErrorCode.REQUIRED.name\n    assert errors[0][\"addressType\"] == AddressType.SHIPPING.upper()\n\n\ndef test_logged_customer_update_addresses_invalid_billing_address(\n    user_api_client, graphql_address_data\n):\n    billing_address = graphql_address_data.copy()\n    del billing_address[\"country\"]\n\n    query = ACCOUNT_UPDATE_QUERY\n    mutation_name = \"accountUpdate\"\n    variables = {\"billing\": billing_address, \"shipping\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert len(data[\"errors\"]) == 1\n    errors = data[\"errors\"]\n    assert errors[0][\"field\"] == \"country\"\n    assert errors[0][\"code\"] == AccountErrorCode.REQUIRED.name\n    assert errors[0][\"addressType\"] == AddressType.BILLING.upper()\n\n\ndef test_logged_customer_update_anonymous_user(api_client):\n    query = ACCOUNT_UPDATE_QUERY\n    response = api_client.post_graphql(query, {})\n    assert_no_permission(response)\n\n\nACCOUNT_REQUEST_DELETION_MUTATION = \"\"\"\n    mutation accountRequestDeletion($redirectUrl: String!, $channel: String) {\n        accountRequestDeletion(redirectUrl: $redirectUrl, channel: $channel) {\n            errors {\n                field\n                code\n                message\n            }\n        }\n    }\n\"\"\"\n\n\n@patch(\"saleor.account.notifications.account_delete_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion(\n    mocked_notify, mocked_token, user_api_client, channel_PLN\n):\n    mocked_token.return_value = \"token\"\n    user = user_api_client.user\n    redirect_url = \"https://www.example.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n    params = urlencode({\"token\": \"token\"})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": \"token\",\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_token_validation(\n    mocked_notify, user_api_client, channel_PLN\n):\n    user = user_api_client.user\n    token = account_delete_token_generator.make_token(user)\n    redirect_url = \"https://www.example.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n    params = urlencode({\"token\": token})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": token,\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_anonymous_user(mocked_notify, api_client):\n    variables = {\"redirectUrl\": \"https://www.example.com\"}\n    response = api_client.post_graphql(ACCOUNT_REQUEST_DELETION_MUTATION, variables)\n    assert_no_permission(response)\n    mocked_notify.assert_not_called()\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_storefront_hosts_not_allowed(\n    mocked_notify, user_api_client\n):\n    variables = {\"redirectUrl\": \"https://www.fake.com\"}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"message\": ANY,\n    }\n    mocked_notify.assert_not_called()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_all_storefront_hosts_allowed(\n    mocked_notify, user_api_client, settings, channel_PLN\n):\n    user = user_api_client.user\n    user.last_login = timezone.now()\n    user.save(update_fields=[\"last_login\"])\n\n    token = account_delete_token_generator.make_token(user)\n    settings.ALLOWED_CLIENT_HOSTS = [\"*\"]\n    redirect_url = \"https://www.test.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n\n    params = urlencode({\"token\": token})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": token,\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_subdomain(\n    mocked_notify, user_api_client, settings, channel_PLN\n):\n    user = user_api_client.user\n    token = account_delete_token_generator.make_token(user)\n    settings.ALLOWED_CLIENT_HOSTS = [\".example.com\"]\n    redirect_url = \"https://sub.example.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n    params = urlencode({\"token\": token})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": token,\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\nACCOUNT_DELETE_MUTATION = \"\"\"\n    mutation AccountDelete($token: String!){\n        accountDelete(token: $token){\n            errors{\n                field\n                message\n            }\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete(user_api_client):\n    user = user_api_client.user\n    user.last_login = timezone.now()\n    user.save(update_fields=[\"last_login\"])\n    token = account_delete_token_generator.make_token(user)\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert not data[\"errors\"]\n    assert not User.objects.filter(pk=user.id).exists()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete_user_never_log_in(user_api_client):\n    user = user_api_client.user\n    token = account_delete_token_generator.make_token(user)\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert not data[\"errors\"]\n    assert not User.objects.filter(pk=user.id).exists()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete_log_out_after_deletion_request(user_api_client):\n    user = user_api_client.user\n    user.last_login = timezone.now()\n    user.save(update_fields=[\"last_login\"])\n\n    token = account_delete_token_generator.make_token(user)\n\n    # simulate re-login\n    user.last_login = timezone.now() + datetime.timedelta(hours=1)\n    user.save(update_fields=[\"last_login\"])\n\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert not data[\"errors\"]\n    assert not User.objects.filter(pk=user.id).exists()\n\n\ndef test_account_delete_invalid_token(user_api_client):\n    user = user_api_client.user\n    variables = {\"token\": \"invalid\"}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"message\"] == \"Invalid or expired token.\"\n    assert User.objects.filter(pk=user.id).exists()\n\n\ndef test_account_delete_anonymous_user(api_client):\n    variables = {\"token\": \"invalid\"}\n\n    response = api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    assert_no_permission(response)\n\n\ndef test_account_delete_staff_user(staff_api_client):\n    user = staff_api_client.user\n    variables = {\"token\": \"invalid\"}\n\n    response = staff_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"message\"] == \"Cannot delete a staff account.\"\n    assert User.objects.filter(pk=user.id).exists()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete_other_customer_token(user_api_client):\n    user = user_api_client.user\n    other_user = User.objects.create(email=\"temp@example.com\")\n    token = account_delete_token_generator.make_token(other_user)\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"message\"] == \"Invalid or expired token.\"\n    assert User.objects.filter(pk=user.id).exists()\n    assert User.objects.filter(pk=other_user.id).exists()\n\n\nCUSTOMER_DELETE_MUTATION = \"\"\"\n    mutation CustomerDelete($id: ID!) {\n        customerDelete(id: $id){\n            errors {\n                field\n                message\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\n@patch(\"saleor.account.signals.delete_versatile_image\")\n@patch(\"saleor.graphql.account.utils.account_events.customer_deleted_event\")\ndef test_customer_delete(\n    mocked_deletion_event,\n    delete_versatile_image_mock,\n    staff_api_client,\n    staff_user,\n    customer_user,\n    image,\n    permission_manage_users,\n    media_root,\n):\n    \"\"\"Ensure deleting a customer actually deletes the customer and creates proper\n    related events\"\"\"\n\n    query = CUSTOMER_DELETE_MUTATION\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    customer_user.avatar = image\n    customer_user.save(update_fields=[\"avatar\"])\n    variables = {\"id\": customer_id}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerDelete\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"id\"] == customer_id\n\n    # Ensure the customer was properly deleted\n    # and any related event was properly triggered\n    mocked_deletion_event.assert_called_once_with(\n        staff_user=staff_user, app=None, deleted_count=1\n    )\n    delete_versatile_image_mock.assert_called_once_with(customer_user.avatar)\n\n\n@patch(\"saleor.account.signals.delete_versatile_image\")\n@patch(\"saleor.graphql.account.utils.account_events.customer_deleted_event\")\ndef test_customer_delete_by_app(\n    mocked_deletion_event,\n    delete_versatile_image_mock,\n    app_api_client,\n    app,\n    customer_user,\n    image,\n    permission_manage_users,\n    media_root,\n):\n    \"\"\"Ensure deleting a customer actually deletes the customer and creates proper\n    related events\"\"\"\n\n    query = CUSTOMER_DELETE_MUTATION\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    customer_user.avatar = image\n    customer_user.save(update_fields=[\"avatar\"])\n    variables = {\"id\": customer_id}\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerDelete\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"id\"] == customer_id\n\n    # Ensure the customer was properly deleted\n    # and any related event was properly triggered\n    assert mocked_deletion_event.call_count == 1\n    args, kwargs = mocked_deletion_event.call_args\n    assert kwargs[\"deleted_count\"] == 1\n    assert kwargs[\"staff_user\"].is_anonymous\n    assert kwargs[\"app\"] == app\n    delete_versatile_image_mock.assert_called_once_with(customer_user.avatar)\n\n\ndef test_customer_delete_errors(customer_user, admin_user, staff_user):\n    info = Mock(context=Mock(user=admin_user))\n    with pytest.raises(ValidationError) as e:\n        CustomerDelete.clean_instance(info, staff_user)\n\n    msg = \"Cannot delete a staff account.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n    # should not raise any errors\n    CustomerDelete.clean_instance(info, customer_user)\n\n\nSTAFF_CREATE_MUTATION = \"\"\"\n    mutation CreateStaff(\n            $email: String, $redirect_url: String, $add_groups: [ID!]\n        ) {\n        staffCreate(input: {email: $email, redirectUrl: $redirect_url,\n            addGroups: $add_groups}\n        ) {\n            errors {\n                field\n                code\n                permissions\n                groups\n            }\n            user {\n                id\n                email\n                isStaff\n                isActive\n                userPermissions {\n                    code\n                }\n                permissionGroups {\n                    name\n                    permissions {\n                        code\n                    }\n                }\n                avatar {\n                    url\n                }\n            }\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_staff_create(\n    mocked_notify,\n    staff_api_client,\n    staff_user,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_users,\n    channel_PLN,\n):\n    group = permission_group_manage_users\n    group.permissions.add(permission_manage_products)\n    staff_user.user_permissions.add(permission_manage_products, permission_manage_users)\n    email = \"api_user@example.com\"\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": redirect_url,\n        \"add_groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"email\"] == email\n    assert data[\"user\"][\"isStaff\"]\n    assert data[\"user\"][\"isActive\"]\n\n    expected_perms = {\n        permission_manage_products.codename,\n        permission_manage_users.codename,\n    }\n    permissions = data[\"user\"][\"userPermissions\"]\n    assert {perm[\"code\"].lower() for perm in permissions} == expected_perms\n\n    staff_user = User.objects.get(email=email)\n\n    assert staff_user.is_staff\n    assert staff_user.search_document == f\"{email}\\n\".lower()\n\n    groups = data[\"user\"][\"permissionGroups\"]\n    assert len(groups) == 1\n    assert {perm[\"code\"].lower() for perm in groups[0][\"permissions\"]} == expected_perms\n\n    token = default_token_generator.make_token(staff_user)\n    params = urlencode({\"email\": email, \"token\": token})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_user),\n        \"password_set_url\": password_set_url,\n        \"token\": token,\n        \"recipient_email\": staff_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_STAFF_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\ndef test_staff_create_app_no_permission(\n    app_api_client,\n    staff_user,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_users,\n):\n    group = permission_group_manage_users\n    group.permissions.add(permission_manage_products)\n    staff_user.user_permissions.add(permission_manage_products, permission_manage_users)\n    email = \"api_user@example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": \"https://www.example.com\",\n        \"add_groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    response = app_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_staff_create_out_of_scope_group(\n    mocked_notify,\n    staff_api_client,\n    superuser_api_client,\n    media_root,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_group_manage_users,\n    channel_PLN,\n):\n    \"\"\"Ensure user can't create staff with groups which are out of user scope.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    group = permission_group_manage_users\n    group2 = Group.objects.create(name=\"second group\")\n    group2.permissions.add(permission_manage_staff)\n    email = \"api_user@example.com\"\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": redirect_url,\n        \"add_groups\": [\n            graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group, group2]\n        ],\n    }\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    errors = data[\"errors\"]\n    assert not data[\"user\"]\n    assert len(errors) == 1\n\n    expected_error = {\n        \"field\": \"addGroups\",\n        \"code\": AccountErrorCode.OUT_OF_SCOPE_GROUP.name,\n        \"permissions\": None,\n        \"groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    assert errors[0] == expected_error\n\n    mocked_notify.assert_not_called()\n\n    # for superuser\n    response = superuser_api_client.post_graphql(STAFF_CREATE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"email\"] == email\n    assert data[\"user\"][\"isStaff\"]\n    assert data[\"user\"][\"isActive\"]\n    expected_perms = {\n        permission_manage_staff.codename,\n        permission_manage_users.codename,\n    }\n    permissions = data[\"user\"][\"userPermissions\"]\n    assert {perm[\"code\"].lower() for perm in permissions} == expected_perms\n\n    staff_user = User.objects.get(email=email)\n\n    assert staff_user.is_staff\n\n    expected_groups = [\n        {\n            \"name\": group.name,\n            \"permissions\": [{\"code\": permission_manage_users.codename.upper()}],\n        },\n        {\n            \"name\": group2.name,\n            \"permissions\": [{\"code\": permission_manage_staff.codename.upper()}],\n        },\n    ]\n    groups = data[\"user\"][\"permissionGroups\"]\n    assert len(groups) == 2\n    for group in expected_groups:\n        assert group in groups\n    token = default_token_generator.make_token(staff_user)\n    params = urlencode({\"email\": email, \"token\": token})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_user),\n        \"password_set_url\": password_set_url,\n        \"token\": token,\n        \"recipient_email\": staff_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_STAFF_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_staff_create_send_password_with_url(\n    mocked_notify,\n    staff_api_client,\n    media_root,\n    permission_manage_staff,\n):\n    email = \"api_user@example.com\"\n    redirect_url = \"https://www.example.com\"\n    variables = {\"email\": email, \"redirect_url\": redirect_url}\n\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert not data[\"errors\"]\n\n    staff_user = User.objects.get(email=email)\n    assert staff_user.is_staff\n\n    token = default_token_generator.make_token(staff_user)\n    params = urlencode({\"email\": email, \"token\": token})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_user),\n        \"password_set_url\": password_set_url,\n        \"token\": token,\n        \"recipient_email\": staff_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_STAFF_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\ndef test_staff_create_without_send_password(\n    staff_api_client, media_root, permission_manage_staff\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email}\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert not data[\"errors\"]\n    User.objects.get(email=email)\n\n\ndef test_staff_create_with_invalid_url(\n    staff_api_client, media_root, permission_manage_staff\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"invalid\"}\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"permissions\": None,\n        \"groups\": None,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\ndef test_staff_create_with_not_allowed_url(\n    staff_api_client, media_root, permission_manage_staff\n):\n    email = \"api_userrr@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"https://www.fake.com\"}\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"permissions\": None,\n        \"groups\": None,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\nSTAFF_UPDATE_MUTATIONS = \"\"\"\n    mutation UpdateStaff(\n            $id: ID!, $input: StaffUpdateInput!) {\n        staffUpdate(\n                id: $id,\n                input: $input) {\n            errors {\n                field\n                code\n                message\n                permissions\n                groups\n            }\n            user {\n                userPermissions {\n                    code\n                }\n                permissionGroups {\n                    name\n                }\n                isActive\n                email\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_staff_update(staff_api_client, permission_manage_staff, media_root):\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    assert not staff_user.search_document\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert not data[\"user\"][\"isActive\"]\n    staff_user.refresh_from_db()\n    assert not staff_user.search_document\n\n\ndef test_staff_update_email(staff_api_client, permission_manage_staff, media_root):\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    assert not staff_user.search_document\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    new_email = \"test@email.com\"\n    variables = {\"id\": id, \"input\": {\"email\": new_email}}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert data[\"user\"][\"isActive\"]\n    staff_user.refresh_from_db()\n    assert staff_user.search_document == f\"{new_email}\\n\"\n\n\n@pytest.mark.parametrize(\"field\", [\"firstName\", \"lastName\"])\ndef test_staff_update_name_field(\n    field, staff_api_client, permission_manage_staff, media_root\n):\n    query = STAFF_UPDATE_MUTATIONS\n    email = \"staffuser@example.com\"\n    staff_user = User.objects.create(email=email, is_staff=True)\n    assert not staff_user.search_document\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    value = \"Name\"\n    variables = {\"id\": id, \"input\": {field: value}}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert data[\"user\"][\"isActive\"]\n    staff_user.refresh_from_db()\n    assert staff_user.search_document == f\"{email}\\n{value.lower()}\\n\"\n\n\ndef test_staff_update_app_no_permission(\n    app_api_client, permission_manage_staff, media_root\n):\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\ndef test_staff_update_groups_and_permissions(\n    staff_api_client,\n    media_root,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n):\n    query = STAFF_UPDATE_MUTATIONS\n    groups = Group.objects.bulk_create(\n        [Group(name=\"manage users\"), Group(name=\"manage orders\"), Group(name=\"empty\")]\n    )\n    group1, group2, group3 = groups\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_orders)\n\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_user.groups.add(group1)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group2, group3]\n            ],\n            \"removeGroups\": [graphene.Node.to_global_id(\"Group\", group1.pk)],\n        },\n    }\n\n    staff_api_client.user.user_permissions.add(\n        permission_manage_users, permission_manage_orders, permission_manage_products\n    )\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert {perm[\"code\"].lower() for perm in data[\"user\"][\"userPermissions\"]} == {\n        permission_manage_orders.codename,\n    }\n    assert {group[\"name\"] for group in data[\"user\"][\"permissionGroups\"]} == {\n        group2.name,\n        group3.name,\n    }\n\n\ndef test_staff_update_out_of_scope_user(\n    staff_api_client,\n    superuser_api_client,\n    permission_manage_staff,\n    permission_manage_orders,\n    media_root,\n):\n    \"\"\"Ensure that staff user cannot update user with wider scope of permission.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_user.user_permissions.add(permission_manage_orders)\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert not data[\"user\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"field\"] == \"id\"\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.OUT_OF_SCOPE_USER.name\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"user\"][\"email\"] == staff_user.email\n    assert data[\"user\"][\"isActive\"] is False\n    assert not data[\"errors\"]\n\n\ndef test_staff_update_out_of_scope_groups(\n    staff_api_client,\n    superuser_api_client,\n    permission_manage_staff,\n    media_root,\n    permission_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n):\n    \"\"\"Ensure that staff user cannot add to groups which permission scope is wider\n    than user's scope.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    query = STAFF_UPDATE_MUTATIONS\n\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage orders\"),\n            Group(name=\"manage products\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_orders)\n    group3.permissions.add(permission_manage_products)\n\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_api_client.user.user_permissions.add(permission_manage_orders)\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"isActive\": False,\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group1, group2]\n            ],\n            \"removeGroups\": [graphene.Node.to_global_id(\"Group\", group3.pk)],\n        },\n    }\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n    assert not data[\"user\"]\n    assert len(errors) == 2\n\n    expected_errors = [\n        {\n            \"field\": \"addGroups\",\n            \"code\": AccountErrorCode.OUT_OF_SCOPE_GROUP.name,\n            \"permissions\": None,\n            \"groups\": [graphene.Node.to_global_id(\"Group\", group1.pk)],\n        },\n        {\n            \"field\": \"removeGroups\",\n            \"code\": AccountErrorCode.OUT_OF_SCOPE_GROUP.name,\n            \"permissions\": None,\n            \"groups\": [graphene.Node.to_global_id(\"Group\", group3.pk)],\n        },\n    ]\n    for error in errors:\n        error.pop(\"message\")\n        assert error in expected_errors\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n    assert not errors\n    assert data[\"user\"][\"email\"] == staff_user.email\n    assert {group[\"name\"] for group in data[\"user\"][\"permissionGroups\"]} == {\n        group1.name,\n        group2.name,\n    }\n\n\ndef test_staff_update_duplicated_input_items(\n    staff_api_client,\n    permission_manage_staff,\n    media_root,\n    permission_manage_orders,\n    permission_manage_users,\n):\n    query = STAFF_UPDATE_MUTATIONS\n\n    groups = Group.objects.bulk_create(\n        [Group(name=\"manage users\"), Group(name=\"manage orders\"), Group(name=\"empty\")]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_orders)\n\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_api_client.user.user_permissions.add(\n        permission_manage_orders, permission_manage_users\n    )\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group1, group2]\n            ],\n            \"removeGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk)\n                for gr in [group1, group2, group3]\n            ],\n        },\n    }\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    assert len(errors) == 1\n    assert errors[0][\"field\"] is None\n    assert errors[0][\"code\"] == AccountErrorCode.DUPLICATED_INPUT_ITEM.name\n    assert set(errors[0][\"groups\"]) == {\n        graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group1, group2]\n    }\n    assert errors[0][\"permissions\"] is None\n\n\ndef test_staff_update_doesnt_change_existing_avatar(\n    staff_api_client,\n    permission_manage_staff,\n    media_root,\n    staff_users,\n):\n    query = STAFF_UPDATE_MUTATIONS\n\n    mock_file = MagicMock(spec=File)\n    mock_file.name = \"image.jpg\"\n\n    staff_user, staff_user1, _ = staff_users\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n\n    staff_user.refresh_from_db()\n    assert not staff_user.avatar\n\n\ndef test_staff_update_deactivate_with_manage_staff_left_not_manageable_perms(\n    staff_api_client,\n    superuser_api_client,\n    staff_users,\n    permission_manage_users,\n    permission_manage_staff,\n    permission_manage_orders,\n    media_root,\n):\n    \"\"\"Ensure that staff user can't and superuser can deactivate user where some\n    permissions will be not manageable.\n    \"\"\"\n    query = STAFF_UPDATE_MUTATIONS\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user2)\n\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    assert not data[\"user\"]\n    assert len(errors) == 1\n    assert errors[0][\"field\"] == \"isActive\"\n    assert errors[0][\"code\"] == AccountErrorCode.LEFT_NOT_MANAGEABLE_PERMISSION.name\n    assert len(errors[0][\"permissions\"]) == 1\n    assert errors[0][\"permissions\"][0] == AccountPermissions.MANAGE_USERS.name\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    staff_user1.refresh_from_db()\n    assert data[\"user\"][\"email\"] == staff_user1.email\n    assert data[\"user\"][\"isActive\"] is False\n    assert not errors\n    assert not staff_user1.is_active\n\n\ndef test_staff_update_deactivate_with_manage_staff_all_perms_manageable(\n    staff_api_client,\n    staff_users,\n    permission_manage_users,\n    permission_manage_staff,\n    permission_manage_orders,\n    media_root,\n):\n    query = STAFF_UPDATE_MUTATIONS\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1, staff_user2)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user2)\n\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    staff_user1.refresh_from_db()\n    assert not errors\n    assert staff_user1.is_active is False\n\n\ndef test_staff_update_update_email_assign_gift_cards_and_orders(\n    staff_api_client, permission_manage_staff, gift_card, order\n):\n    # given\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n\n    new_email = \"testuser@example.com\"\n\n    gift_card.created_by = None\n    gift_card.created_by_email = new_email\n    gift_card.save(update_fields=[\"created_by\", \"created_by_email\"])\n\n    order.user = None\n    order.user_email = new_email\n    order.save(update_fields=[\"user_email\", \"user\"])\n\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"email\": new_email}}\n\n    # when\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert data[\"user\"][\"email\"] == new_email\n    gift_card.refresh_from_db()\n    staff_user.refresh_from_db()\n    assert gift_card.created_by == staff_user\n    assert gift_card.created_by_email == staff_user.email\n    order.refresh_from_db()\n    assert order.user == staff_user\n\n\nSTAFF_DELETE_MUTATION = \"\"\"\n        mutation DeleteStaff($id: ID!) {\n            staffDelete(id: $id) {\n                errors {\n                    field\n                    code\n                    message\n                    permissions\n                }\n                user {\n                    id\n                }\n            }\n        }\n    \"\"\"\n\n\ndef test_staff_delete(staff_api_client, permission_manage_staff):\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    assert data[\"errors\"] == []\n    assert not User.objects.filter(pk=staff_user.id).exists()\n\n\n@patch(\"saleor.account.signals.delete_versatile_image\")\ndef test_staff_delete_with_avatar(\n    delete_versatile_image_mock,\n    staff_api_client,\n    image,\n    permission_manage_staff,\n    media_root,\n):\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(\n        email=\"staffuser@example.com\", avatar=image, is_staff=True\n    )\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    assert data[\"errors\"] == []\n    assert not User.objects.filter(pk=staff_user.id).exists()\n    delete_versatile_image_mock.assert_called_once_with(staff_user.avatar)\n\n\ndef test_staff_delete_app_no_permission(app_api_client, permission_manage_staff):\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\ndef test_staff_delete_out_of_scope_user(\n    staff_api_client,\n    superuser_api_client,\n    permission_manage_staff,\n    permission_manage_products,\n):\n    \"\"\"Ensure staff user cannot delete users even when some of user permissions are\n    out of requestor scope.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_user.user_permissions.add(permission_manage_products)\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    assert not data[\"user\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"field\"] == \"id\"\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.OUT_OF_SCOPE_USER.name\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n\n    assert data[\"errors\"] == []\n    assert not User.objects.filter(pk=staff_user.id).exists()\n\n\ndef test_staff_delete_left_not_manageable_permissions(\n    staff_api_client,\n    superuser_api_client,\n    staff_users,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n):\n    \"\"\"Ensure staff user can't and superuser can delete staff user when some of\n    permissions will be not manageable.\n    \"\"\"\n    query = STAFF_DELETE_MUTATION\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user1)\n\n    user_id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": user_id}\n\n    # for staff user\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    errors = data[\"errors\"]\n\n    assert len(errors) == 1\n    assert errors[0][\"field\"] == \"id\"\n    assert errors[0][\"code\"] == AccountErrorCode.LEFT_NOT_MANAGEABLE_PERMISSION.name\n    assert set(errors[0][\"permissions\"]) == {\n        AccountPermissions.MANAGE_USERS.name,\n        OrderPermissions.MANAGE_ORDERS.name,\n    }\n    assert User.objects.filter(pk=staff_user1.id).exists()\n\n    # for superuser\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    errors = data[\"errors\"]\n\n    assert not errors\n    assert not User.objects.filter(pk=staff_user1.id).exists()\n\n\ndef test_staff_delete_all_permissions_manageable(\n    staff_api_client,\n    staff_users,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n):\n    query = STAFF_DELETE_MUTATION\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage users and orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_users, permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2)\n    group3.user_set.add(staff_user1)\n\n    user_id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": user_id}\n\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    errors = data[\"errors\"]\n\n    assert len(errors) == 0\n    assert not User.objects.filter(pk=staff_user1.id).exists()\n\n\ndef test_user_delete_errors(staff_user, admin_user):\n    info = Mock(context=Mock(user=staff_user))\n    with pytest.raises(ValidationError) as e:\n        UserDelete.clean_instance(info, staff_user)\n\n    msg = \"You cannot delete your own account.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n    info = Mock(context=Mock(user=staff_user))\n    with pytest.raises(ValidationError) as e:\n        UserDelete.clean_instance(info, admin_user)\n\n    msg = \"Cannot delete this account.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n\ndef test_staff_delete_errors(staff_user, customer_user, admin_user):\n    info = Mock(context=Mock(user=staff_user))\n    with pytest.raises(ValidationError) as e:\n        StaffDelete.clean_instance(info, customer_user)\n    msg = \"Cannot delete a non-staff users.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n    # should not raise any errors\n    info = Mock(context=Mock(user=admin_user))\n    StaffDelete.clean_instance(info, staff_user)\n\n\ndef test_staff_update_errors(staff_user, customer_user, admin_user):\n    errors = defaultdict(list)\n    input = {\"is_active\": None}\n    StaffUpdate.clean_is_active(input, customer_user, staff_user, errors)\n    assert not errors[\"is_active\"]\n\n    input[\"is_active\"] = False\n    StaffUpdate.clean_is_active(input, staff_user, staff_user, errors)\n    assert len(errors[\"is_active\"]) == 1\n    assert (\n        errors[\"is_active\"][0].code.upper()\n        == AccountErrorCode.DEACTIVATE_OWN_ACCOUNT.name\n    )\n\n    errors = defaultdict(list)\n    StaffUpdate.clean_is_active(input, admin_user, staff_user, errors)\n    assert len(errors[\"is_active\"]) == 2\n    assert {error.code.upper() for error in errors[\"is_active\"]} == {\n        AccountErrorCode.DEACTIVATE_SUPERUSER_ACCOUNT.name,\n        AccountErrorCode.LEFT_NOT_MANAGEABLE_PERMISSION.name,\n    }\n\n    errors = defaultdict(list)\n    # should not raise any errors\n    StaffUpdate.clean_is_active(input, customer_user, staff_user, errors)\n    assert not errors[\"is_active\"]\n\n\nSET_PASSWORD_MUTATION = \"\"\"\n    mutation SetPassword($email: String!, $token: String!, $password: String!) {\n        setPassword(email: $email, token: $token, password: $password) {\n            errors {\n                field\n                message\n            }\n            errors {\n                field\n                message\n                code\n            }\n            user {\n                id\n            }\n            token\n            refreshToken\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_set_password(user_api_client, customer_user):\n    token = default_token_generator.make_token(customer_user)\n    password = \"spanish-inquisition\"\n\n    variables = {\"email\": customer_user.email, \"password\": password, \"token\": token}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"setPassword\"]\n    assert data[\"user\"][\"id\"]\n    assert data[\"token\"]\n\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(password)\n\n    password_resent_event = account_events.CustomerEvent.objects.get()\n    assert password_resent_event.type == account_events.CustomerEvents.PASSWORD_RESET\n    assert password_resent_event.user == customer_user\n\n\ndef test_set_password_invalid_token(user_api_client, customer_user):\n    variables = {\"email\": customer_user.email, \"password\": \"pass\", \"token\": \"token\"}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert errors[0][\"message\"] == INVALID_TOKEN\n\n    account_errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert account_errors[0][\"message\"] == INVALID_TOKEN\n    assert account_errors[0][\"code\"] == AccountErrorCode.INVALID.name\n\n\ndef test_set_password_invalid_email(user_api_client):\n    variables = {\"email\": \"fake@example.com\", \"password\": \"pass\", \"token\": \"token\"}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert len(errors) == 1\n    assert errors[0][\"field\"] == \"email\"\n\n    account_errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert len(account_errors) == 1\n    assert account_errors[0][\"field\"] == \"email\"\n    assert account_errors[0][\"code\"] == AccountErrorCode.NOT_FOUND.name\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_set_password_invalid_password(user_api_client, customer_user, settings):\n    settings.AUTH_PASSWORD_VALIDATORS = [\n        {\n            \"NAME\": \"django.contrib.auth.password_validation.MinimumLengthValidator\",\n            \"OPTIONS\": {\"min_length\": 5},\n        },\n        {\"NAME\": \"django.contrib.auth.password_validation.NumericPasswordValidator\"},\n    ]\n\n    token = default_token_generator.make_token(customer_user)\n    variables = {\"email\": customer_user.email, \"password\": \"1234\", \"token\": token}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert len(errors) == 2\n    assert (\n        errors[0][\"message\"]\n        == \"This password is too short. It must contain at least 5 characters.\"\n    )\n    assert errors[1][\"message\"] == \"This password is entirely numeric.\"\n\n    account_errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert account_errors[0][\"code\"] == str_to_enum(\"password_too_short\")\n    assert account_errors[1][\"code\"] == str_to_enum(\"password_entirely_numeric\")\n\n\nCHANGE_PASSWORD_MUTATION = \"\"\"\n    mutation PasswordChange($oldPassword: String!, $newPassword: String!) {\n        passwordChange(oldPassword: $oldPassword, newPassword: $newPassword) {\n            errors {\n                field\n                message\n            }\n            user {\n                email\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_password_change(user_api_client):\n    customer_user = user_api_client.user\n    new_password = \"spanish-inquisition\"\n\n    variables = {\"oldPassword\": \"password\", \"newPassword\": new_password}\n    response = user_api_client.post_graphql(CHANGE_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"passwordChange\"]\n    assert not data[\"errors\"]\n    assert data[\"user\"][\"email\"] == customer_user.email\n\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(new_password)\n\n    password_change_event = account_events.CustomerEvent.objects.get()\n    assert password_change_event.type == account_events.CustomerEvents.PASSWORD_CHANGED\n    assert password_change_event.user == customer_user\n\n\ndef test_password_change_incorrect_old_password(user_api_client):\n    customer_user = user_api_client.user\n    variables = {\"oldPassword\": \"incorrect\", \"newPassword\": \"\"}\n    response = user_api_client.post_graphql(CHANGE_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"passwordChange\"]\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(\"password\")\n    assert data[\"errors\"]\n    assert data[\"errors\"][0][\"field\"] == \"oldPassword\"\n\n\ndef test_password_change_invalid_new_password(user_api_client, settings):\n    settings.AUTH_PASSWORD_VALIDATORS = [\n        {\n            \"NAME\": \"django.contrib.auth.password_validation.MinimumLengthValidator\",\n            \"OPTIONS\": {\"min_length\": 5},\n        },\n        {\"NAME\": \"django.contrib.auth.password_validation.NumericPasswordValidator\"},\n    ]\n\n    customer_user = user_api_client.user\n    variables = {\"oldPassword\": \"password\", \"newPassword\": \"1234\"}\n    response = user_api_client.post_graphql(CHANGE_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"passwordChange\"][\"errors\"]\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(\"password\")\n    assert len(errors) == 2\n    assert errors[1][\"field\"] == \"newPassword\"\n    assert (\n        errors[0][\"message\"]\n        == \"This password is too short. It must contain at least 5 characters.\"\n    )\n    assert errors[1][\"field\"] == \"newPassword\"\n    assert errors[1][\"message\"] == \"This password is entirely numeric.\"\n\n\nADDRESS_CREATE_MUTATION = \"\"\"\n    mutation CreateUserAddress($user: ID!, $city: String!, $country: CountryCode!) {\n        addressCreate(userId: $user, input: {city: $city, country: $country}) {\n            errors {\n                field\n                message\n            }\n            address {\n                id\n                city\n                country {\n                    code\n                }\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_create_address_mutation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    query = ADDRESS_CREATE_MUTATION\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"user\": user_id, \"city\": \"Dummy\", \"country\": \"PL\"}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"addressCreate\"][\"errors\"] == []\n    data = content[\"data\"][\"addressCreate\"]\n    assert data[\"address\"][\"city\"] == \"Dummy\"\n    assert data[\"address\"][\"country\"][\"code\"] == \"PL\"\n    address_obj = Address.objects.get(city=\"Dummy\")\n    assert address_obj.user_addresses.first() == customer_user\n    assert data[\"user\"][\"id\"] == user_id\n\n    customer_user.refresh_from_db()\n    for field in [\"city\", \"country\"]:\n        assert variables[field].lower() in customer_user.search_document\n\n\n@override_settings(MAX_USER_ADDRESSES=2)\ndef test_create_address_mutation_the_oldest_address_is_deleted(\n    staff_api_client, customer_user, address, permission_manage_users\n):\n    same_address = Address.objects.create(**address.as_data())\n    customer_user.addresses.set([address, same_address])\n\n    user_addresses_count = customer_user.addresses.count()\n\n    query = ADDRESS_CREATE_MUTATION\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"user\": user_id, \"city\": \"Dummy\", \"country\": \"PL\"}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"addressCreate\"][\"errors\"] == []\n    data = content[\"data\"][\"addressCreate\"]\n    assert data[\"address\"][\"city\"] == \"Dummy\"\n    assert data[\"address\"][\"country\"][\"code\"] == \"PL\"\n    address_obj = Address.objects.get(city=\"Dummy\")\n    assert address_obj.user_addresses.first() == customer_user\n    assert data[\"user\"][\"id\"] == user_id\n\n    customer_user.refresh_from_db()\n    assert customer_user.addresses.count() == user_addresses_count\n\n    with pytest.raises(address._meta.model.DoesNotExist):\n        address.refresh_from_db()\n\n\nADDRESS_UPDATE_MUTATION = \"\"\"\n    mutation updateUserAddress($addressId: ID!, $address: AddressInput!) {\n        addressUpdate(id: $addressId, input: $address) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_address_update_mutation(\n    staff_api_client, customer_user, permission_manage_users, graphql_address_data\n):\n    query = ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n    assert staff_api_client.user not in address_obj.user_addresses.all()\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": graphql_address_data,\n    }\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressUpdate\"]\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n    address_obj.refresh_from_db()\n    assert address_obj.city == graphql_address_data[\"city\"].upper()\n    customer_user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(address_obj)\n        in customer_user.search_document\n    )\n\n\nACCOUNT_ADDRESS_UPDATE_MUTATION = \"\"\"\n    mutation updateAccountAddress($addressId: ID!, $address: AddressInput!) {\n        accountAddressUpdate(id: $addressId, input: $address) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_customer_update_own_address(\n    user_api_client, customer_user, graphql_address_data\n):\n    query = ACCOUNT_ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n    address_data = graphql_address_data\n    address_data[\"city\"] = \"Pozna\u0144\"\n    assert address_data[\"city\"] != address_obj.city\n    user = user_api_client.user\n\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": address_data,\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountAddressUpdate\"]\n    assert data[\"address\"][\"city\"] == address_data[\"city\"].upper()\n    address_obj.refresh_from_db()\n    assert address_obj.city == address_data[\"city\"].upper()\n    user.refresh_from_db()\n    assert generate_address_search_document_value(address_obj) in user.search_document\n\n\ndef test_update_address_as_anonymous_user(\n    api_client, customer_user, graphql_address_data\n):\n    query = ACCOUNT_ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": graphql_address_data,\n    }\n    response = api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_customer_update_own_address_not_updated_when_validation_fails(\n    user_api_client, customer_user, graphql_address_data\n):\n    query = ACCOUNT_ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n    address_data = graphql_address_data\n    address_data[\"city\"] = \"Pozna\u0144\"\n    address_data[\"postalCode\"] = \"wrong postal code\"\n    assert address_data[\"city\"] != address_obj.city\n\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": address_data,\n    }\n    user_api_client.post_graphql(query, variables)\n    address_obj.refresh_from_db()\n    assert address_obj.city != address_data[\"city\"]\n    assert address_obj.postal_code != address_data[\"postalCode\"]\n\n\n@pytest.mark.parametrize(\n    \"query\", [ADDRESS_UPDATE_MUTATION, ACCOUNT_ADDRESS_UPDATE_MUTATION]\n)\ndef test_customer_update_address_for_other(\n    user_api_client, customer_user, address_other_country, graphql_address_data, query\n):\n    address_obj = address_other_country\n    assert customer_user not in address_obj.user_addresses.all()\n\n    address_data = graphql_address_data\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": address_data,\n    }\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\nADDRESS_DELETE_MUTATION = \"\"\"\n    mutation deleteUserAddress($id: ID!) {\n        addressDelete(id: $id) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_address_delete_mutation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    query = ADDRESS_DELETE_MUTATION\n    address_obj = customer_user.addresses.first()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressDelete\"]\n    assert data[\"address\"][\"city\"] == address_obj.city\n    assert data[\"user\"][\"id\"] == graphene.Node.to_global_id(\"User\", customer_user.pk)\n    with pytest.raises(address_obj._meta.model.DoesNotExist):\n        address_obj.refresh_from_db()\n\n    customer_user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(address_obj)\n        not in customer_user.search_document\n    )\n\n\ndef test_address_delete_mutation_as_app(\n    app_api_client, customer_user, permission_manage_users\n):\n    query = ADDRESS_DELETE_MUTATION\n    address_obj = customer_user.addresses.first()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressDelete\"]\n    assert data[\"address\"][\"city\"] == address_obj.city\n    assert data[\"user\"][\"id\"] == graphene.Node.to_global_id(\"User\", customer_user.pk)\n    with pytest.raises(address_obj._meta.model.DoesNotExist):\n        address_obj.refresh_from_db()\n\n\nACCOUNT_ADDRESS_DELETE_MUTATION = \"\"\"\n    mutation deleteUserAddress($id: ID!) {\n        accountAddressDelete(id: $id) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_customer_delete_own_address(user_api_client, customer_user):\n    query = ACCOUNT_ADDRESS_DELETE_MUTATION\n    address_obj = customer_user.addresses.first()\n    user = user_api_client.user\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountAddressDelete\"]\n    assert data[\"address\"][\"city\"] == address_obj.city\n    with pytest.raises(address_obj._meta.model.DoesNotExist):\n        address_obj.refresh_from_db()\n    user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(address_obj) not in user.search_document\n    )\n\n\n@pytest.mark.parametrize(\n    \"query\", [ADDRESS_DELETE_MUTATION, ACCOUNT_ADDRESS_DELETE_MUTATION]\n)\ndef test_customer_delete_address_for_other(\n    user_api_client, customer_user, address_other_country, query\n):\n    address_obj = address_other_country\n    assert customer_user not in address_obj.user_addresses.all()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n    address_obj.refresh_from_db()\n\n\nSET_DEFAULT_ADDRESS_MUTATION = \"\"\"\nmutation($address_id: ID!, $user_id: ID!, $type: AddressTypeEnum!) {\n  addressSetDefault(addressId: $address_id, userId: $user_id, type: $type) {\n    errors {\n      field\n      message\n    }\n    user {\n      defaultBillingAddress {\n        id\n      }\n      defaultShippingAddress {\n        id\n      }\n    }\n  }\n}\n\"\"\"\n\n\ndef test_set_default_address(\n    staff_api_client, address_other_country, customer_user, permission_manage_users\n):\n    customer_user.default_billing_address = None\n    customer_user.default_shipping_address = None\n    customer_user.save()\n\n    # try to set an address that doesn't belong to that user\n    address = address_other_country\n\n    variables = {\n        \"address_id\": graphene.Node.to_global_id(\"Address\", address.id),\n        \"user_id\": graphene.Node.to_global_id(\"User\", customer_user.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n\n    response = staff_api_client.post_graphql(\n        SET_DEFAULT_ADDRESS_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressSetDefault\"]\n    assert data[\"errors\"][0][\"field\"] == \"addressId\"\n\n    # try to set a new billing address using one of user's addresses\n    address = customer_user.addresses.first()\n    address_id = graphene.Node.to_global_id(\"Address\", address.id)\n\n    variables[\"address_id\"] = address_id\n    response = staff_api_client.post_graphql(SET_DEFAULT_ADDRESS_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressSetDefault\"]\n    assert data[\"user\"][\"defaultShippingAddress\"][\"id\"] == address_id\n\n\nGET_ADDRESS_VALIDATION_RULES_QUERY = \"\"\"\n    query getValidator(\n        $country_code: CountryCode!, $country_area: String, $city_area: String) {\n        addressValidationRules(\n                countryCode: $country_code,\n                countryArea: $country_area,\n                cityArea: $city_area) {\n            countryCode\n            countryName\n            addressFormat\n            addressLatinFormat\n            allowedFields\n            requiredFields\n            upperFields\n            countryAreaType\n            countryAreaChoices {\n                verbose\n                raw\n            }\n            cityType\n            cityChoices {\n                raw\n                verbose\n            }\n            cityAreaType\n            cityAreaChoices {\n                raw\n                verbose\n            }\n            postalCodeType\n            postalCodeMatchers\n            postalCodeExamples\n            postalCodePrefix\n        }\n    }\n\"\"\"\n\n\ndef test_address_validation_rules(user_api_client):\n    query = GET_ADDRESS_VALIDATION_RULES_QUERY\n    variables = {\"country_code\": \"PL\", \"country_area\": None, \"city_area\": None}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressValidationRules\"]\n    assert data[\"countryCode\"] == \"PL\"\n    assert data[\"countryName\"] == \"POLAND\"\n    assert data[\"addressFormat\"] is not None\n    assert data[\"addressLatinFormat\"] is not None\n    assert data[\"cityType\"] == \"city\"\n    assert data[\"cityAreaType\"] == \"suburb\"\n    matcher = data[\"postalCodeMatchers\"][0]\n    matcher = re.compile(matcher)\n    assert matcher.match(\"00-123\")\n    assert not data[\"cityAreaChoices\"]\n    assert not data[\"cityChoices\"]\n    assert not data[\"countryAreaChoices\"]\n    assert data[\"postalCodeExamples\"]\n    assert data[\"postalCodeType\"] == \"postal\"\n    assert set(data[\"allowedFields\"]) == {\n        \"companyName\",\n        \"city\",\n        \"postalCode\",\n        \"streetAddress1\",\n        \"name\",\n        \"streetAddress2\",\n    }\n    assert set(data[\"requiredFields\"]) == {\"postalCode\", \"streetAddress1\", \"city\"}\n    assert set(data[\"upperFields\"]) == {\"city\"}\n\n\ndef test_address_validation_rules_with_country_area(user_api_client):\n    query = GET_ADDRESS_VALIDATION_RULES_QUERY\n    variables = {\n        \"country_code\": \"CN\",\n        \"country_area\": \"Fujian Sheng\",\n        \"city_area\": None,\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressValidationRules\"]\n    assert data[\"countryCode\"] == \"CN\"\n    assert data[\"countryName\"] == \"CHINA\"\n    assert data[\"countryAreaType\"] == \"province\"\n    assert data[\"countryAreaChoices\"]\n    assert data[\"cityType\"] == \"city\"\n    assert data[\"cityChoices\"]\n    assert data[\"cityAreaType\"] == \"district\"\n    assert not data[\"cityAreaChoices\"]\n    assert data[\"cityChoices\"]\n    assert data[\"countryAreaChoices\"]\n    assert data[\"postalCodeExamples\"]\n    assert data[\"postalCodeType\"] == \"postal\"\n    assert set(data[\"allowedFields\"]) == {\n        \"city\",\n        \"postalCode\",\n        \"streetAddress1\",\n        \"name\",\n        \"streetAddress2\",\n        \"countryArea\",\n        \"companyName\",\n        \"cityArea\",\n    }\n    assert set(data[\"requiredFields\"]) == {\n        \"postalCode\",\n        \"streetAddress1\",\n        \"city\",\n        \"countryArea\",\n    }\n    assert set(data[\"upperFields\"]) == {\"countryArea\"}\n\n\ndef test_address_validation_rules_fields_in_camel_case(user_api_client):\n    query = \"\"\"\n    query getValidator(\n        $country_code: CountryCode!) {\n        addressValidationRules(countryCode: $country_code) {\n            requiredFields\n            allowedFields\n        }\n    }\n    \"\"\"\n    variables = {\"country_code\": \"PL\"}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressValidationRules\"]\n    required_fields = data[\"requiredFields\"]\n    allowed_fields = data[\"allowedFields\"]\n    assert \"streetAddress1\" in required_fields\n    assert \"streetAddress2\" not in required_fields\n    assert \"streetAddress1\" in allowed_fields\n    assert \"streetAddress2\" in allowed_fields\n\n\nREQUEST_PASSWORD_RESET_MUTATION = \"\"\"\n    mutation RequestPasswordReset(\n        $email: String!, $redirectUrl: String!, $channel: String) {\n        requestPasswordReset(\n            email: $email, redirectUrl: $redirectUrl, channel: $channel) {\n            errors {\n                field\n                message\n            }\n        }\n    }\n\"\"\"\n\nCONFIRM_ACCOUNT_MUTATION = \"\"\"\n    mutation ConfirmAccount($email: String!, $token: String!) {\n        confirmAccount(email: $email, token: $token) {\n            errors {\n                field\n                code\n            }\n            user {\n                id\n                email\n            }\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password(\n    mocked_notify, user_api_client, customer_user, channel_PLN, channel_USD\n):\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": redirect_url,\n        \"channel\": channel_PLN.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n    token = default_token_generator.make_token(customer_user)\n    params = urlencode({\"email\": customer_user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(customer_user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": customer_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_PASSWORD_RESET,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.graphql.account.mutations.base.assign_user_gift_cards\")\n@patch(\"saleor.graphql.account.mutations.base.match_orders_with_new_user\")\ndef test_account_confirmation(\n    match_orders_with_new_user_mock,\n    assign_gift_cards_mock,\n    api_client,\n    customer_user,\n    channel_USD,\n):\n    customer_user.is_active = False\n    customer_user.save()\n\n    variables = {\n        \"email\": customer_user.email,\n        \"token\": default_token_generator.make_token(customer_user),\n        \"channel\": channel_USD.slug,\n    }\n    response = api_client.post_graphql(CONFIRM_ACCOUNT_MUTATION, variables)\n    content = get_graphql_content(response)\n    assert not content[\"data\"][\"confirmAccount\"][\"errors\"]\n    assert content[\"data\"][\"confirmAccount\"][\"user\"][\"email\"] == customer_user.email\n    customer_user.refresh_from_db()\n    match_orders_with_new_user_mock.assert_called_once_with(customer_user)\n    assign_gift_cards_mock.assert_called_once_with(customer_user)\n    assert customer_user.is_active is True\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.graphql.account.mutations.base.assign_user_gift_cards\")\n@patch(\"saleor.graphql.account.mutations.base.match_orders_with_new_user\")\ndef test_account_confirmation_invalid_user(\n    match_orders_with_new_user_mock,\n    assign_gift_cards_mock,\n    user_api_client,\n    customer_user,\n    channel_USD,\n):\n    variables = {\n        \"email\": \"non-existing@example.com\",\n        \"token\": default_token_generator.make_token(customer_user),\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(CONFIRM_ACCOUNT_MUTATION, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"field\"] == \"email\"\n    assert (\n        content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"code\"]\n        == AccountErrorCode.NOT_FOUND.name\n    )\n    match_orders_with_new_user_mock.assert_not_called()\n    assign_gift_cards_mock.assert_not_called()\n\n\n@patch(\"saleor.graphql.account.mutations.base.assign_user_gift_cards\")\n@patch(\"saleor.graphql.account.mutations.base.match_orders_with_new_user\")\ndef test_account_confirmation_invalid_token(\n    match_orders_with_new_user_mock,\n    assign_gift_cards_mock,\n    user_api_client,\n    customer_user,\n    channel_USD,\n):\n    variables = {\n        \"email\": customer_user.email,\n        \"token\": \"invalid_token\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(CONFIRM_ACCOUNT_MUTATION, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"field\"] == \"token\"\n    assert (\n        content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"code\"]\n        == AccountErrorCode.INVALID.name\n    )\n    match_orders_with_new_user_mock.assert_not_called()\n    assign_gift_cards_mock.assert_not_called()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_request_password_reset_email_for_staff(\n    mocked_notify, staff_api_client, channel_USD\n):\n    redirect_url = \"https://www.example.com\"\n    variables = {\"email\": staff_api_client.user.email, \"redirectUrl\": redirect_url}\n    response = staff_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n    token = default_token_generator.make_token(staff_api_client.user)\n    params = urlencode({\"email\": staff_api_client.user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_api_client.user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": staff_api_client.user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_STAFF_RESET_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_invalid_email(\n    mocked_notify, user_api_client, channel_USD\n):\n    variables = {\n        \"email\": \"non-existing-email@email.com\",\n        \"redirectUrl\": \"https://www.example.com\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert len(data[\"errors\"]) == 1\n    mocked_notify.assert_not_called()\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_user_is_inactive(\n    mocked_notify, user_api_client, customer_user, channel_USD\n):\n    user = customer_user\n    user.is_active = False\n    user.save()\n\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": \"https://www.example.com\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert data[\"errors\"] == [\n        {\"field\": \"email\", \"message\": \"User with this email is inactive\"}\n    ]\n    assert not mocked_notify.called\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_storefront_hosts_not_allowed(\n    mocked_notify, user_api_client, customer_user, channel_USD\n):\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": \"https://www.fake.com\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"field\"] == \"redirectUrl\"\n    mocked_notify.assert_not_called()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_all_storefront_hosts_allowed(\n    mocked_notify, user_api_client, customer_user, settings, channel_PLN, channel_USD\n):\n    settings.ALLOWED_CLIENT_HOSTS = [\"*\"]\n    redirect_url = \"https://www.test.com\"\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": redirect_url,\n        \"channel\": channel_PLN.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n\n    token = default_token_generator.make_token(customer_user)\n    params = urlencode({\"email\": customer_user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(customer_user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": customer_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_PASSWORD_RESET,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_subdomain(\n    mocked_notify, user_api_client, customer_user, settings, channel_PLN\n):\n    settings.ALLOWED_CLIENT_HOSTS = [\".example.com\"]\n    redirect_url = \"https://sub.example.com\"\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": redirect_url,\n        \"channel\": channel_PLN.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n\n    token = default_token_generator.make_token(customer_user)\n    params = urlencode({\"email\": customer_user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(customer_user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": customer_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_PASSWORD_RESET,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\nACCOUNT_ADDRESS_CREATE_MUTATION = \"\"\"\nmutation($addressInput: AddressInput!, $addressType: AddressTypeEnum) {\n  accountAddressCreate(input: $addressInput, type: $addressType) {\n    address {\n        id,\n        city\n    }\n    user {\n        email\n    }\n    errors {\n        code\n        field\n        addressType\n    }\n  }\n}\n\"\"\"\n\n\ndef test_customer_create_address(user_api_client, graphql_address_data):\n    user = user_api_client.user\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    mutation_name = \"accountAddressCreate\"\n\n    variables = {\"addressInput\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count + 1\n    assert (\n        generate_address_search_document_value(user.addresses.last())\n        in user.search_document\n    )\n\n\ndef test_account_address_create_return_user(user_api_client, graphql_address_data):\n    user = user_api_client.user\n    variables = {\"addressInput\": graphql_address_data}\n    response = user_api_client.post_graphql(ACCOUNT_ADDRESS_CREATE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountAddressCreate\"][\"user\"]\n    assert data[\"email\"] == user.email\n\n\ndef test_customer_create_default_address(user_api_client, graphql_address_data):\n    user = user_api_client.user\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    mutation_name = \"accountAddressCreate\"\n\n    address_type = AddressType.SHIPPING.upper()\n    variables = {\"addressInput\": graphql_address_data, \"addressType\": address_type}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count + 1\n    assert user.default_shipping_address.id == int(\n        graphene.Node.from_global_id(data[\"address\"][\"id\"])[1]\n    )\n\n    address_type = AddressType.BILLING.upper()\n    variables = {\"addressInput\": graphql_address_data, \"addressType\": address_type}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count + 2\n    assert user.default_billing_address.id == int(\n        graphene.Node.from_global_id(data[\"address\"][\"id\"])[1]\n    )\n\n\n@override_settings(MAX_USER_ADDRESSES=2)\ndef test_customer_create_address_the_oldest_address_is_deleted(\n    user_api_client, graphql_address_data, address\n):\n    \"\"\"Ensure that when mew address it added to user with max amount of addressess,\n    the oldest address will be removed.\"\"\"\n    user = user_api_client.user\n    same_address = Address.objects.create(**address.as_data())\n    user.addresses.set([address, same_address])\n\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    mutation_name = \"accountAddressCreate\"\n\n    variables = {\"addressInput\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count\n\n    with pytest.raises(address._meta.model.DoesNotExist):\n        address.refresh_from_db()\n\n\ndef test_anonymous_user_create_address(api_client, graphql_address_data):\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    variables = {\"addressInput\": graphql_address_data}\n    response = api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_address_not_created_after_validation_fails(\n    user_api_client, graphql_address_data\n):\n    user = user_api_client.user\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n\n    graphql_address_data[\"postalCode\"] = \"wrong postal code\"\n\n    address_type = AddressType.SHIPPING.upper()\n    variables = {\"addressInput\": graphql_address_data, \"addressType\": address_type}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n\n    data = content[\"data\"][\"accountAddressCreate\"]\n    assert not data[\"address\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.INVALID.name\n    assert data[\"errors\"][0][\"field\"] == \"postalCode\"\n    assert data[\"errors\"][0][\"addressType\"] == address_type\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count\n\n\nACCOUNT_SET_DEFAULT_ADDRESS_MUTATION = \"\"\"\nmutation($id: ID!, $type: AddressTypeEnum!) {\n  accountSetDefaultAddress(id: $id, type: $type) {\n    errors {\n      field,\n      message\n    }\n  }\n}\n\"\"\"\n\n\ndef test_customer_set_address_as_default(user_api_client):\n    user = user_api_client.user\n    user.default_billing_address = None\n    user.default_shipping_address = None\n    user.save()\n    assert not user.default_billing_address\n    assert not user.default_shipping_address\n    assert user.addresses.exists()\n\n    address = user.addresses.first()\n    query = ACCOUNT_SET_DEFAULT_ADDRESS_MUTATION\n    mutation_name = \"accountSetDefaultAddress\"\n\n    variables = {\n        \"id\": graphene.Node.to_global_id(\"Address\", address.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    user.refresh_from_db()\n    assert user.default_shipping_address == address\n\n    variables[\"type\"] = AddressType.BILLING.upper()\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    user.refresh_from_db()\n    assert user.default_billing_address == address\n\n\ndef test_customer_change_default_address(user_api_client, address_other_country):\n    user = user_api_client.user\n    assert user.default_billing_address\n    assert user.default_billing_address\n    address = user.default_shipping_address\n    assert address in user.addresses.all()\n    assert address_other_country not in user.addresses.all()\n\n    user.default_shipping_address = address_other_country\n    user.save()\n    user.refresh_from_db()\n    assert address_other_country not in user.addresses.all()\n\n    query = ACCOUNT_SET_DEFAULT_ADDRESS_MUTATION\n    mutation_name = \"accountSetDefaultAddress\"\n\n    variables = {\n        \"id\": graphene.Node.to_global_id(\"Address\", address.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    user.refresh_from_db()\n    assert user.default_shipping_address == address\n    assert address_other_country in user.addresses.all()\n\n\ndef test_customer_change_default_address_invalid_address(\n    user_api_client, address_other_country\n):\n    user = user_api_client.user\n    assert address_other_country not in user.addresses.all()\n\n    query = ACCOUNT_SET_DEFAULT_ADDRESS_MUTATION\n    mutation_name = \"accountSetDefaultAddress\"\n\n    variables = {\n        \"id\": graphene.Node.to_global_id(\"Address\", address_other_country.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][mutation_name][\"errors\"][0][\"field\"] == \"id\"\n\n\nUSER_AVATAR_UPDATE_MUTATION = \"\"\"\n    mutation userAvatarUpdate($image: Upload!) {\n        userAvatarUpdate(image: $image) {\n            user {\n                avatar {\n                    url\n                }\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_user_avatar_update_mutation_permission(api_client):\n    \"\"\"Should raise error if user is not staff.\"\"\"\n\n    query = USER_AVATAR_UPDATE_MUTATION\n\n    image_file, image_name = create_image(\"avatar\")\n    variables = {\"image\": image_name}\n    body = get_multipart_request_body(query, variables, image_file, image_name)\n    response = api_client.post_multipart(body)\n\n    assert_no_permission(response)\n\n\ndef test_user_avatar_update_mutation(monkeypatch, staff_api_client, media_root):\n    query = USER_AVATAR_UPDATE_MUTATION\n\n    user = staff_api_client.user\n\n    mock_create_thumbnails = Mock(return_value=None)\n    monkeypatch.setattr(\n        (\n            \"saleor.graphql.account.mutations.staff.\"\n            \"create_user_avatar_thumbnails.delay\"\n        ),\n        mock_create_thumbnails,\n    )\n\n    image_file, image_name = create_image(\"avatar\")\n    variables = {\"image\": image_name}\n    body = get_multipart_request_body(query, variables, image_file, image_name)\n    response = staff_api_client.post_multipart(body)\n    content = get_graphql_content(response)\n\n    data = content[\"data\"][\"userAvatarUpdate\"]\n    user.refresh_from_db()\n\n    assert user.avatar\n    assert data[\"user\"][\"avatar\"][\"url\"].startswith(\n        \"http://testserver/media/user-avatars/avatar\"\n    )\n    img_name, format = os.path.splitext(image_file._name)\n    file_name = user.avatar.name\n    assert file_name != image_file._name\n    assert file_name.startswith(f\"user-avatars/{img_name}\")\n    assert file_name.endswith(format)\n\n    # The image creation should have triggered a warm-up\n    mock_create_thumbnails.assert_called_once_with(user_id=user.pk)\n\n\ndef test_user_avatar_update_mutation_image_exists(staff_api_client, media_root):\n    query = USER_AVATAR_UPDATE_MUTATION\n\n    user = staff_api_client.user\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    image_file, image_name = create_image(\"new_image\")\n    variables = {\"image\": image_name}\n    body = get_multipart_request_body(query, variables, image_file, image_name)\n    response = staff_api_client.post_multipart(body)\n    content = get_graphql_content(response)\n\n    data = content[\"data\"][\"userAvatarUpdate\"]\n    user.refresh_from_db()\n\n    assert user.avatar != avatar_mock\n    assert data[\"user\"][\"avatar\"][\"url\"].startswith(\n        \"http://testserver/media/user-avatars/new_image\"\n    )\n\n\nUSER_AVATAR_DELETE_MUTATION = \"\"\"\n    mutation userAvatarDelete {\n        userAvatarDelete {\n            user {\n                avatar {\n                    url\n                }\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_user_avatar_delete_mutation_permission(api_client):\n    \"\"\"Should raise error if user is not staff.\"\"\"\n\n    query = USER_AVATAR_DELETE_MUTATION\n\n    response = api_client.post_graphql(query)\n\n    assert_no_permission(response)\n\n\ndef test_user_avatar_delete_mutation(staff_api_client):\n    query = USER_AVATAR_DELETE_MUTATION\n\n    user = staff_api_client.user\n\n    response = staff_api_client.post_graphql(query)\n    content = get_graphql_content(response)\n\n    user.refresh_from_db()\n\n    assert not user.avatar\n    assert not content[\"data\"][\"userAvatarDelete\"][\"user\"][\"avatar\"]\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"placedOrders\": {\"gte\": \"2019-04-18\"}}, 1),\n        ({\"placedOrders\": {\"lte\": \"2012-01-14\"}}, 1),\n        ({\"placedOrders\": {\"lte\": \"2012-01-14\", \"gte\": \"2012-01-13\"}}, 1),\n        ({\"placedOrders\": {\"gte\": \"2012-01-14\"}}, 2),\n    ],\n)\ndef test_query_customers_with_filter_placed_orders(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n    channel_USD,\n):\n    Order.objects.create(user=customer_user, channel=channel_USD)\n    second_customer = User.objects.create(email=\"second_example@example.com\")\n    with freeze_time(\"2012-01-14 11:00:00\"):\n        Order.objects.create(user=second_customer, channel=channel_USD)\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    assert len(users) == count\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"dateJoined\": {\"gte\": \"2019-04-18\"}}, 1),\n        ({\"dateJoined\": {\"lte\": \"2012-01-14\"}}, 1),\n        ({\"dateJoined\": {\"lte\": \"2012-01-14\", \"gte\": \"2012-01-13\"}}, 1),\n        ({\"dateJoined\": {\"gte\": \"2012-01-14\"}}, 2),\n        ({\"updatedAt\": {\"gte\": \"2012-01-14T10:59:00+00:00\"}}, 2),\n        ({\"updatedAt\": {\"gte\": \"2012-01-14T11:01:00+00:00\"}}, 1),\n        ({\"updatedAt\": {\"lte\": \"2012-01-14T12:00:00+00:00\"}}, 1),\n        ({\"updatedAt\": {\"lte\": \"2011-01-14T10:59:00+00:00\"}}, 0),\n        (\n            {\n                \"updatedAt\": {\n                    \"lte\": \"2012-01-14T12:00:00+00:00\",\n                    \"gte\": \"2012-01-14T10:00:00+00:00\",\n                }\n            },\n            1,\n        ),\n        ({\"updatedAt\": {\"gte\": \"2012-01-14T10:00:00+00:00\"}}, 2),\n    ],\n)\ndef test_query_customers_with_filter_date_joined_and_updated_at(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n):\n    with freeze_time(\"2012-01-14 11:00:00\"):\n        User.objects.create(email=\"second_example@example.com\")\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == count\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"numberOfOrders\": {\"gte\": 0, \"lte\": 1}}, 1),\n        ({\"numberOfOrders\": {\"gte\": 1, \"lte\": 3}}, 2),\n        ({\"numberOfOrders\": {\"gte\": 0}}, 2),\n        ({\"numberOfOrders\": {\"lte\": 3}}, 2),\n    ],\n)\ndef test_query_customers_with_filter_placed_orders_(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n    channel_USD,\n):\n    Order.objects.bulk_create(\n        [\n            Order(user=customer_user, token=str(uuid.uuid4()), channel=channel_USD),\n            Order(user=customer_user, token=str(uuid.uuid4()), channel=channel_USD),\n            Order(user=customer_user, token=str(uuid.uuid4()), channel=channel_USD),\n        ]\n    )\n    second_customer = User.objects.create(email=\"second_example@example.com\")\n    with freeze_time(\"2012-01-14 11:00:00\"):\n        Order.objects.create(user=second_customer, channel=channel_USD)\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    assert len(users) == count\n\n\ndef test_query_customers_with_filter_metadata(\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n    channel_USD,\n):\n    second_customer = User.objects.create(email=\"second_example@example.com\")\n    second_customer.store_value_in_metadata({\"metakey\": \"metavalue\"})\n    second_customer.save()\n\n    variables = {\"filter\": {\"metadata\": [{\"key\": \"metakey\", \"value\": \"metavalue\"}]}}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == 1\n    user = users[0]\n    _, user_id = graphene.Node.from_global_id(user[\"node\"][\"id\"])\n    assert second_customer.id == int(user_id)\n\n\ndef test_query_customers_search_without_duplications(\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    permission_manage_orders,\n):\n    customer = User.objects.create(email=\"david@example.com\")\n    customer.addresses.create(first_name=\"David\")\n    customer.addresses.create(first_name=\"David\")\n    customer.search_document = prepare_user_search_document_value(customer)\n    customer.save(update_fields=[\"search_document\"])\n\n    variables = {\"filter\": {\"search\": \"David\"}}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == 1\n\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter,\n        variables,\n        permissions=[permission_manage_orders],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == 1\n\n\ndef test_query_customers_with_permission_manage_orders(\n    query_customer_with_filter,\n    customer_user,\n    staff_api_client,\n    permission_manage_orders,\n):\n    variables = {\"filter\": {}}\n\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter,\n        variables,\n        permissions=[permission_manage_orders],\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"totalCount\"]\n    assert users == 1\n\n\nQUERY_CUSTOMERS_WITH_SORT = \"\"\"\n    query ($sort_by: UserSortingInput!) {\n        customers(first:5, sortBy: $sort_by) {\n                edges{\n                    node{\n                        firstName\n                    }\n                }\n            }\n        }\n\"\"\"\n\n\n@pytest.mark.parametrize(\n    \"customer_sort, result_order\",\n    [\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"ASC\"}, [\"Joe\", \"John\", \"Leslie\"]),\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"John\", \"Joe\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"ASC\"}, [\"John\", \"Joe\", \"Leslie\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"Joe\", \"John\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"Joe\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"DESC\"}, [\"Joe\", \"Leslie\", \"John\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"Joe\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"DESC\"}, [\"Joe\", \"Leslie\", \"John\"]),\n    ],\n)\ndef test_query_customers_with_sort(\n    customer_sort, result_order, staff_api_client, permission_manage_users, channel_USD\n):\n    User.objects.bulk_create(\n        [\n            User(\n                first_name=\"John\",\n                last_name=\"Allen\",\n                email=\"allen@example.com\",\n                is_staff=False,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Joe\",\n                last_name=\"Doe\",\n                email=\"zordon01@example.com\",\n                is_staff=False,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Leslie\",\n                last_name=\"Wade\",\n                email=\"leslie@example.com\",\n                is_staff=False,\n                is_active=True,\n            ),\n        ]\n    )\n    Order.objects.create(\n        user=User.objects.get(email=\"zordon01@example.com\"), channel=channel_USD\n    )\n    variables = {\"sort_by\": customer_sort}\n    staff_api_client.user.user_permissions.add(permission_manage_users)\n    response = staff_api_client.post_graphql(QUERY_CUSTOMERS_WITH_SORT, variables)\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    for order, user_first_name in enumerate(result_order):\n        assert users[order][\"node\"][\"firstName\"] == user_first_name\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"search\": \"mirumee.com\"}, 2),\n        ({\"search\": \"Alice\"}, 1),\n        ({\"search\": \"Kowalski\"}, 1),\n        ({\"search\": \"John\"}, 1),  # first_name\n        ({\"search\": \"Doe\"}, 1),  # last_name\n        ({\"search\": \"wroc\"}, 1),  # city\n        ({\"search\": \"pl\"}, 1),  # country\n        ({\"search\": \"+48713988102\"}, 1),\n        ({\"search\": \"alice Kowalski\"}, 1),\n        ({\"search\": \"kowalski alice\"}, 1),\n        ({\"search\": \"John doe\"}, 1),\n        ({\"search\": \"Alice Doe\"}, 0),\n    ],\n)\ndef test_query_customer_members_with_filter_search(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    address,\n    staff_user,\n):\n    users = User.objects.bulk_create(\n        [\n            User(\n                email=\"second@mirumee.com\",\n                first_name=\"Alice\",\n                last_name=\"Kowalski\",\n                is_active=False,\n            ),\n            User(\n                email=\"third@mirumee.com\",\n                is_active=True,\n            ),\n        ]\n    )\n    users[1].addresses.set([address])\n\n    for user in users:\n        user.search_document = prepare_user_search_document_value(user)\n    User.objects.bulk_update(users, [\"search_document\"])\n\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    assert len(users) == count\n\n\n@pytest.mark.parametrize(\n    \"staff_member_filter, count\",\n    [({\"status\": \"DEACTIVATED\"}, 1), ({\"status\": \"ACTIVE\"}, 2)],\n)\ndef test_query_staff_members_with_filter_status(\n    staff_member_filter,\n    count,\n    query_staff_users_with_filter,\n    staff_api_client,\n    permission_manage_staff,\n    staff_user,\n):\n\n    User.objects.bulk_create(\n        [\n            User(email=\"second@example.com\", is_staff=True, is_active=False),\n            User(email=\"third@example.com\", is_staff=True, is_active=True),\n        ]\n    )\n\n    variables = {\"filter\": staff_member_filter}\n    response = staff_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n\n    assert len(users) == count\n\n\ndef test_query_staff_members_with_filter_by_ids(\n    query_staff_users_with_filter,\n    staff_api_client,\n    permission_manage_staff,\n    staff_user,\n):\n    # given\n    variables = {\n        \"filter\": {\n            \"ids\": [graphene.Node.to_global_id(\"User\", staff_user.pk)],\n        }\n    }\n\n    # when\n    response = staff_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n\n    # then\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n    assert len(users) == 1\n\n\ndef test_query_staff_members_app_no_permission(\n    query_staff_users_with_filter,\n    app_api_client,\n    permission_manage_staff,\n):\n\n    User.objects.bulk_create(\n        [\n            User(email=\"second@example.com\", is_staff=True, is_active=False),\n            User(email=\"third@example.com\", is_staff=True, is_active=True),\n        ]\n    )\n\n    variables = {\"filter\": {\"status\": \"DEACTIVATED\"}}\n    response = app_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\n@pytest.mark.parametrize(\n    \"staff_member_filter, count\",\n    [\n        ({\"search\": \"mirumee.com\"}, 2),\n        ({\"search\": \"alice\"}, 1),\n        ({\"search\": \"kowalski\"}, 1),\n        ({\"search\": \"John\"}, 1),  # first_name\n        ({\"search\": \"Doe\"}, 1),  # last_name\n        ({\"search\": \"irv\"}, 1),  # city\n        ({\"search\": \"us\"}, 1),  # country\n        ({\"search\": \"Alice Kowalski\"}, 1),\n        ({\"search\": \"Kowalski Alice\"}, 1),\n        ({\"search\": \"john doe\"}, 1),\n        ({\"search\": \"Alice Doe\"}, 0),\n    ],\n)\ndef test_query_staff_members_with_filter_search(\n    staff_member_filter,\n    count,\n    query_staff_users_with_filter,\n    staff_api_client,\n    permission_manage_staff,\n    address_usa,\n    staff_user,\n):\n    users = User.objects.bulk_create(\n        [\n            User(\n                email=\"second@mirumee.com\",\n                first_name=\"Alice\",\n                last_name=\"Kowalski\",\n                is_staff=True,\n                is_active=False,\n            ),\n            User(\n                email=\"third@mirumee.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n            User(\n                email=\"customer@mirumee.com\",\n                first_name=\"Alice\",\n                last_name=\"Kowalski\",\n                is_staff=False,\n                is_active=True,\n            ),\n        ]\n    )\n    users[1].addresses.set([address_usa])\n    for user in users:\n        user.search_document = prepare_user_search_document_value(user)\n    User.objects.bulk_update(users, [\"search_document\"])\n\n    variables = {\"filter\": staff_member_filter}\n    response = staff_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n\n    assert len(users) == count\n\n\nQUERY_STAFF_USERS_WITH_SORT = \"\"\"\n    query ($sort_by: UserSortingInput!) {\n        staffUsers(first:5, sortBy: $sort_by) {\n                edges{\n                    node{\n                        firstName\n                    }\n                }\n            }\n        }\n\"\"\"\n\n\n@pytest.mark.parametrize(\n    \"customer_sort, result_order\",\n    [\n        # Empty string in result is first_name for staff_api_client.\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"ASC\"}, [\"\", \"Joe\", \"John\", \"Leslie\"]),\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"John\", \"Joe\", \"\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"ASC\"}, [\"\", \"John\", \"Joe\", \"Leslie\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"Joe\", \"John\", \"\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"\", \"Joe\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"DESC\"}, [\"Joe\", \"\", \"Leslie\", \"John\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"\", \"Joe\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"DESC\"}, [\"Joe\", \"\", \"Leslie\", \"John\"]),\n    ],\n)\ndef test_query_staff_members_with_sort(\n    customer_sort, result_order, staff_api_client, permission_manage_staff, channel_USD\n):\n    User.objects.bulk_create(\n        [\n            User(\n                first_name=\"John\",\n                last_name=\"Allen\",\n                email=\"allen@example.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Joe\",\n                last_name=\"Doe\",\n                email=\"zordon01@example.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Leslie\",\n                last_name=\"Wade\",\n                email=\"leslie@example.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n        ]\n    )\n    Order.objects.create(\n        user=User.objects.get(email=\"zordon01@example.com\"), channel=channel_USD\n    )\n    variables = {\"sort_by\": customer_sort}\n    staff_api_client.user.user_permissions.add(permission_manage_staff)\n    response = staff_api_client.post_graphql(QUERY_STAFF_USERS_WITH_SORT, variables)\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n\n    for order, user_first_name in enumerate(result_order):\n        assert users[order][\"node\"][\"firstName\"] == user_first_name\n\n\nUSER_CHANGE_ACTIVE_STATUS_MUTATION = \"\"\"\n    mutation userChangeActiveStatus($ids: [ID]!, $is_active: Boolean!) {\n        userBulkSetActive(ids: $ids, isActive: $is_active) {\n            count\n            errors {\n                field\n                message\n            }\n        }\n    }\n    \"\"\"\n\n\ndef test_staff_bulk_set_active(\n    staff_api_client, user_list_not_active, permission_manage_users\n):\n    users = user_list_not_active\n    active_status = True\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"count\"] == users.count()\n    users = User.objects.filter(pk__in=[user.pk for user in users])\n    assert all(user.is_active for user in users)\n\n\ndef test_staff_bulk_set_not_active(\n    staff_api_client, user_list, permission_manage_users\n):\n    users = user_list\n    active_status = False\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"count\"] == len(users)\n    users = User.objects.filter(pk__in=[user.pk for user in users])\n    assert not any(user.is_active for user in users)\n\n\ndef test_change_active_status_for_superuser(\n    staff_api_client, superuser, permission_manage_users\n):\n    users = [superuser]\n    superuser_id = graphene.Node.to_global_id(\"User\", superuser.id)\n    active_status = False\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"errors\"][0][\"field\"] == superuser_id\n    assert (\n        data[\"errors\"][0][\"message\"] == \"Cannot activate or deactivate \"\n        \"superuser's account.\"\n    )\n\n\ndef test_change_active_status_for_himself(staff_api_client, permission_manage_users):\n    users = [staff_api_client.user]\n    user_id = graphene.Node.to_global_id(\"User\", staff_api_client.user.id)\n    active_status = False\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"errors\"][0][\"field\"] == user_id\n    assert (\n        data[\"errors\"][0][\"message\"] == \"Cannot activate or deactivate \"\n        \"your own account.\"\n    )\n\n\nADDRESS_QUERY = \"\"\"\nquery address($id: ID!) {\n    address(id: $id) {\n        postalCode\n        lastName\n        firstName\n        city\n        country {\n          code\n        }\n    }\n}\n\"\"\"\n\n\ndef test_address_query_as_owner(user_api_client, customer_user):\n    address = customer_user.addresses.first()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address.pk)}\n    response = user_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"address\"]\n    assert data[\"country\"][\"code\"] == address.country.code\n\n\ndef test_address_query_as_not_owner(\n    user_api_client, customer_user, address_other_country\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = user_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"address\"]\n    assert not data\n\n\ndef test_address_query_as_app_with_permission(\n    app_api_client,\n    address_other_country,\n    permission_manage_users,\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = app_api_client.post_graphql(\n        ADDRESS_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"address\"]\n    assert data[\"country\"][\"code\"] == address_other_country.country.code\n\n\ndef test_address_query_as_app_without_permission(\n    app_api_client, app, address_other_country\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = app_api_client.post_graphql(ADDRESS_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_address_query_as_anonymous_user(api_client, address_other_country):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = api_client.post_graphql(ADDRESS_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_address_query_invalid_id(\n    staff_api_client,\n    address_other_country,\n):\n    id = \"..afs\"\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content_from_response(response)\n    assert len(content[\"errors\"]) == 1\n    assert content[\"errors\"][0][\"message\"] == f\"Couldn't resolve id: {id}.\"\n    assert content[\"data\"][\"address\"] is None\n\n\ndef test_address_query_with_invalid_object_type(\n    staff_api_client,\n    address_other_country,\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Order\", address_other_country.pk)}\n    response = staff_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"address\"] is None\n\n\nREQUEST_EMAIL_CHANGE_QUERY = \"\"\"\nmutation requestEmailChange(\n    $password: String!, $new_email: String!, $redirect_url: String!, $channel:String\n) {\n    requestEmailChange(\n        password: $password,\n        newEmail: $new_email,\n        redirectUrl: $redirect_url,\n        channel: $channel\n    ) {\n        user {\n            email\n        }\n        errors {\n            code\n            message\n            field\n        }\n  }\n}\n\"\"\"\n\n\ndef test_request_email_change(user_api_client, customer_user, channel_PLN):\n    variables = {\n        \"password\": \"password\",\n        \"new_email\": \"new_email@example.com\",\n        \"redirect_url\": \"http://www.example.com\",\n        \"channel\": channel_PLN.slug,\n    }\n\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert data[\"user\"][\"email\"] == customer_user.email\n\n\ndef test_request_email_change_to_existing_email(\n    user_api_client, customer_user, staff_user\n):\n    variables = {\n        \"password\": \"password\",\n        \"new_email\": staff_user.email,\n        \"redirect_url\": \"http://www.example.com\",\n    }\n\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"] == [\n        {\n            \"code\": \"UNIQUE\",\n            \"message\": \"Email is used by other user.\",\n            \"field\": \"newEmail\",\n        }\n    ]\n\n\ndef test_request_email_change_with_invalid_redirect_url(\n    user_api_client, customer_user, staff_user\n):\n    variables = {\n        \"password\": \"password\",\n        \"new_email\": \"new_email@example.com\",\n        \"redirect_url\": \"www.example.com\",\n    }\n\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"] == [\n        {\n            \"code\": \"INVALID\",\n            \"message\": \"Invalid URL. Please check if URL is in RFC 1808 format.\",\n            \"field\": \"redirectUrl\",\n        }\n    ]\n\n\ndef test_request_email_change_with_invalid_password(user_api_client, customer_user):\n    variables = {\n        \"password\": \"spanishinquisition\",\n        \"new_email\": \"new_email@example.com\",\n        \"redirect_url\": \"http://www.example.com\",\n    }\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.INVALID_CREDENTIALS.name\n    assert data[\"errors\"][0][\"field\"] == \"password\"\n\n\nEMAIL_UPDATE_QUERY = \"\"\"\nmutation emailUpdate($token: String!, $channel: String) {\n    confirmEmailChange(token: $token, channel: $channel){\n        user {\n            email\n        }\n        errors {\n            code\n            message\n            field\n        }\n  }\n}\n\"\"\"\n\n\n@patch(\"saleor.graphql.account.mutations.account.match_orders_with_new_user\")\n@patch(\"saleor.graphql.account.mutations.account.assign_user_gift_cards\")\ndef test_email_update(\n    assign_gift_cards_mock,\n    assign_orders_mock,\n    user_api_client,\n    customer_user,\n    channel_PLN,\n):\n    new_email = \"new_email@example.com\"\n    payload = {\n        \"old_email\": customer_user.email,\n        \"new_email\": new_email,\n        \"user_pk\": customer_user.pk,\n    }\n    user = user_api_client.user\n\n    token = create_token(payload, timedelta(hours=1))\n    variables = {\"token\": token, \"channel\": channel_PLN.slug}\n\n    response = user_api_client.post_graphql(EMAIL_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"confirmEmailChange\"]\n    assert data[\"user\"][\"email\"] == new_email\n    user.refresh_from_db()\n    assert new_email in user.search_document\n    assign_gift_cards_mock.assert_called_once_with(customer_user)\n    assign_orders_mock.assert_called_once_with(customer_user)\n\n\ndef test_email_update_to_existing_email(user_api_client, customer_user, staff_user):\n    payload = {\n        \"old_email\": customer_user.email,\n        \"new_email\": staff_user.email,\n        \"user_pk\": customer_user.pk,\n    }\n    token = create_token(payload, timedelta(hours=1))\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(EMAIL_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"confirmEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"] == [\n        {\n            \"code\": \"UNIQUE\",\n            \"message\": \"Email is used by other user.\",\n            \"field\": \"newEmail\",\n        }\n    ]\n\n\nUSER_FEDERATION_QUERY = \"\"\"\n  query GetUserInFederation($representations: [_Any]) {\n    _entities(representations: $representations) {\n      __typename\n      ... on User {\n        id\n        email\n      }\n    }\n  }\n\"\"\"\n\n\ndef test_staff_query_user_by_id_for_federation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_staff_query_user_by_email_for_federation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_staff_query_user_by_id_without_permission_for_federation(\n    staff_api_client, customer_user\n):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(USER_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_staff_query_user_by_email_without_permission_for_federation(\n    staff_api_client, customer_user\n):\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(USER_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_customer_query_self_by_id_for_federation(user_api_client, customer_user):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_customer_query_self_by_email_for_federation(user_api_client, customer_user):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_customer_query_user_by_id_for_federation(\n    user_api_client, customer_user, staff_user\n):\n    staff_user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": staff_user_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_customer_query_user_by_email_for_federation(\n    user_api_client, customer_user, staff_user\n):\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": staff_user.email,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_user_by_id_for_federation(api_client, customer_user):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_user_by_email_for_federation(api_client, customer_user):\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\nADDRESS_FEDERATION_QUERY = \"\"\"\n  query GetUserInFederation($representations: [_Any]) {\n    _entities(representations: $representations) {\n      __typename\n      ... on Address {\n        id\n        city\n      }\n    }\n  }\n\"\"\"\n\n\ndef test_customer_query_address_federation(user_api_client, customer_user, address):\n    customer_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Address\",\n            \"id\": address_id,\n            \"city\": address.city,\n        }\n    ]\n\n\ndef test_customer_query_other_user_address_federation(\n    user_api_client, staff_user, customer_user, address\n):\n    staff_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_staff_query_other_user_address_federation(\n    staff_api_client, customer_user, address\n):\n    customer_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_staff_query_other_user_address_with_permission_federation(\n    staff_api_client, customer_user, address, permission_manage_users\n):\n    customer_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        ADDRESS_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_app_query_address_federation(app_api_client, address, permission_manage_users):\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(\n        ADDRESS_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Address\",\n            \"id\": address_id,\n            \"city\": address.city,\n        }\n    ]\n\n\ndef test_app_no_permission_query_address_federation(app_api_client, address):\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_address_federation(api_client, address):\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\nGROUP_FEDERATION_QUERY = \"\"\"\n  query GetGroupInFederation($representations: [_Any]) {\n    _entities(representations: $representations) {\n      __typename\n      ... on Group {\n        id\n        name\n      }\n    }\n  }\n\"\"\"\n\n\ndef test_staff_query_group_federation(staff_api_client, permission_manage_staff):\n    group = Group.objects.create(name=\"empty group\")\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        GROUP_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_staff],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Group\",\n            \"id\": group_id,\n            \"name\": group.name,\n        }\n    ]\n\n\ndef test_app_query_group_federation(app_api_client, permission_manage_staff):\n    group = Group.objects.create(name=\"empty group\")\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(\n        GROUP_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_staff],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Group\",\n            \"id\": group_id,\n            \"name\": group.name,\n        }\n    ]\n\n\ndef test_app_no_permission_query_group_federation(app_api_client):\n    group = Group.objects.create(name=\"empty group\")\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(GROUP_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_client_query_group_federation(user_api_client):\n    group = Group.objects.create(name=\"empty group\")\n\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(GROUP_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_group_federation(api_client):\n    group = Group.objects.create(name=\"empty group\")\n\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(GROUP_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n", "from typing import List\n\nimport graphene\nfrom django.contrib.auth import get_user_model\nfrom django.contrib.auth import models as auth_models\nfrom graphene import relay\n\nfrom ...account import models\nfrom ...checkout.utils import get_user_checkout\nfrom ...core.exceptions import PermissionDenied\nfrom ...core.permissions import AccountPermissions, AppPermission, OrderPermissions\nfrom ...core.tracing import traced_resolver\nfrom ...order import OrderStatus\nfrom ..account.utils import requestor_has_access\nfrom ..app.dataloaders import AppByIdLoader\nfrom ..app.types import App\nfrom ..checkout.dataloaders import CheckoutByUserAndChannelLoader, CheckoutByUserLoader\nfrom ..checkout.types import Checkout\nfrom ..core.connection import CountableConnection, create_connection_slice\nfrom ..core.descriptions import DEPRECATED_IN_3X_FIELD\nfrom ..core.enums import LanguageCodeEnum\nfrom ..core.federation import federated_entity, resolve_federation_references\nfrom ..core.fields import ConnectionField\nfrom ..core.scalars import UUID\nfrom ..core.types import CountryDisplay, Image, ModelObjectType, Permission\nfrom ..core.utils import from_global_id_or_error, str_to_enum\nfrom ..decorators import one_of_permissions_required, permission_required\nfrom ..giftcard.dataloaders import GiftCardsByUserLoader\nfrom ..meta.types import ObjectWithMetadata\nfrom ..order.dataloaders import OrderLineByIdLoader, OrdersByUserLoader\nfrom ..utils import format_permissions_for_display, get_user_or_app_from_context\nfrom .dataloaders import CustomerEventsByUserLoader\nfrom .enums import CountryCodeEnum, CustomerEventsEnum\nfrom .utils import can_user_manage_group, get_groups_which_user_can_manage\n\n\nclass AddressInput(graphene.InputObjectType):\n    first_name = graphene.String(description=\"Given name.\")\n    last_name = graphene.String(description=\"Family name.\")\n    company_name = graphene.String(description=\"Company or organization.\")\n    street_address_1 = graphene.String(description=\"Address.\")\n    street_address_2 = graphene.String(description=\"Address.\")\n    city = graphene.String(description=\"City.\")\n    city_area = graphene.String(description=\"District.\")\n    postal_code = graphene.String(description=\"Postal code.\")\n    country = CountryCodeEnum(description=\"Country.\")\n    country_area = graphene.String(description=\"State or province.\")\n    phone = graphene.String(description=\"Phone number.\")\n\n\n@federated_entity(\"id\")\nclass Address(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    first_name = graphene.String(required=True)\n    last_name = graphene.String(required=True)\n    company_name = graphene.String(required=True)\n    street_address_1 = graphene.String(required=True)\n    street_address_2 = graphene.String(required=True)\n    city = graphene.String(required=True)\n    city_area = graphene.String(required=True)\n    postal_code = graphene.String(required=True)\n    country = graphene.Field(\n        CountryDisplay, required=True, description=\"Shop's default country.\"\n    )\n    country_area = graphene.String(required=True)\n    phone = graphene.String()\n    is_default_shipping_address = graphene.Boolean(\n        required=False, description=\"Address is user's default shipping address.\"\n    )\n    is_default_billing_address = graphene.Boolean(\n        required=False, description=\"Address is user's default billing address.\"\n    )\n\n    class Meta:\n        description = \"Represents user address data.\"\n        interfaces = [relay.Node]\n        model = models.Address\n\n    @staticmethod\n    def resolve_country(root: models.Address, _info):\n        return CountryDisplay(code=root.country.code, country=root.country.name)\n\n    @staticmethod\n    def resolve_is_default_shipping_address(root: models.Address, _info):\n        \"\"\"Look if the address is the default shipping address of the user.\n\n        This field is added through annotation when using the\n        `resolve_addresses` resolver. It's invalid for\n        `resolve_default_shipping_address` and\n        `resolve_default_billing_address`\n        \"\"\"\n        if not hasattr(root, \"user_default_shipping_address_pk\"):\n            return None\n\n        user_default_shipping_address_pk = getattr(\n            root, \"user_default_shipping_address_pk\"\n        )\n        if user_default_shipping_address_pk == root.pk:\n            return True\n        return False\n\n    @staticmethod\n    def resolve_is_default_billing_address(root: models.Address, _info):\n        \"\"\"Look if the address is the default billing address of the user.\n\n        This field is added through annotation when using the\n        `resolve_addresses` resolver. It's invalid for\n        `resolve_default_shipping_address` and\n        `resolve_default_billing_address`\n        \"\"\"\n        if not hasattr(root, \"user_default_billing_address_pk\"):\n            return None\n\n        user_default_billing_address_pk = getattr(\n            root, \"user_default_billing_address_pk\"\n        )\n        if user_default_billing_address_pk == root.pk:\n            return True\n        return False\n\n    @staticmethod\n    def __resolve_references(roots: List[\"Address\"], info, **_kwargs):\n        from .resolvers import resolve_addresses\n\n        root_ids = [root.id for root in roots]\n        addresses = {\n            address.id: address for address in resolve_addresses(info, root_ids)\n        }\n\n        result = []\n        for root_id in root_ids:\n            _, root_id = from_global_id_or_error(root_id, Address)\n            result.append(addresses.get(int(root_id)))\n        return result\n\n\nclass CustomerEvent(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    date = graphene.types.datetime.DateTime(\n        description=\"Date when event happened at in ISO 8601 format.\"\n    )\n    type = CustomerEventsEnum(description=\"Customer event type.\")\n    user = graphene.Field(lambda: User, description=\"User who performed the action.\")\n    app = graphene.Field(App, description=\"App that performed the action.\")\n    message = graphene.String(description=\"Content of the event.\")\n    count = graphene.Int(description=\"Number of objects concerned by the event.\")\n    order = graphene.Field(\n        \"saleor.graphql.order.types.Order\", description=\"The concerned order.\"\n    )\n    order_line = graphene.Field(\n        \"saleor.graphql.order.types.OrderLine\", description=\"The concerned order line.\"\n    )\n\n    class Meta:\n        description = \"History log of the customer.\"\n        interfaces = [relay.Node]\n        model = models.CustomerEvent\n\n    @staticmethod\n    def resolve_user(root: models.CustomerEvent, info):\n        user = info.context.user\n        if (\n            user == root.user\n            or user.has_perm(AccountPermissions.MANAGE_USERS)\n            or user.has_perm(AccountPermissions.MANAGE_STAFF)\n        ):\n            return root.user\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_app(root: models.CustomerEvent, info):\n        requestor = get_user_or_app_from_context(info.context)\n        if requestor_has_access(requestor, root.user, AppPermission.MANAGE_APPS):\n            return (\n                AppByIdLoader(info.context).load(root.app_id) if root.app_id else None\n            )\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_message(root: models.CustomerEvent, _info):\n        return root.parameters.get(\"message\", None)\n\n    @staticmethod\n    def resolve_count(root: models.CustomerEvent, _info):\n        return root.parameters.get(\"count\", None)\n\n    @staticmethod\n    def resolve_order_line(root: models.CustomerEvent, info):\n        if \"order_line_pk\" in root.parameters:\n            return OrderLineByIdLoader(info.context).load(\n                root.parameters[\"order_line_pk\"]\n            )\n        return None\n\n\nclass UserPermission(Permission):\n    source_permission_groups = graphene.List(\n        graphene.NonNull(\"saleor.graphql.account.types.Group\"),\n        description=\"List of user permission groups which contains this permission.\",\n        user_id=graphene.Argument(\n            graphene.ID,\n            description=\"ID of user whose groups should be returned.\",\n            required=True,\n        ),\n        required=False,\n    )\n\n    @traced_resolver\n    def resolve_source_permission_groups(root: Permission, _info, user_id, **_kwargs):\n        _type, user_id = from_global_id_or_error(user_id, only_type=\"User\")\n        groups = auth_models.Group.objects.filter(\n            user__pk=user_id, permissions__name=root.name\n        )\n        return groups\n\n\n@federated_entity(\"id\")\n@federated_entity(\"email\")\nclass User(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    email = graphene.String(required=True)\n    first_name = graphene.String(required=True)\n    last_name = graphene.String(required=True)\n    is_staff = graphene.Boolean(required=True)\n    is_active = graphene.Boolean(required=True)\n    addresses = graphene.List(Address, description=\"List of all user's addresses.\")\n    checkout = graphene.Field(\n        Checkout,\n        description=\"Returns the last open checkout of this user.\",\n        deprecation_reason=(\n            f\"{DEPRECATED_IN_3X_FIELD} \"\n            \"Use the `checkout_tokens` field to fetch the user checkouts.\"\n        ),\n    )\n    checkout_tokens = graphene.List(\n        graphene.NonNull(UUID),\n        description=\"Returns the checkout UUID's assigned to this user.\",\n        channel=graphene.String(\n            description=\"Slug of a channel for which the data should be returned.\"\n        ),\n    )\n    gift_cards = ConnectionField(\n        \"saleor.graphql.giftcard.types.GiftCardCountableConnection\",\n        description=\"List of the user gift cards.\",\n    )\n    note = graphene.String(description=\"A note about the customer.\")\n    orders = ConnectionField(\n        \"saleor.graphql.order.types.OrderCountableConnection\",\n        description=\"List of user's orders.\",\n    )\n    user_permissions = graphene.List(\n        UserPermission, description=\"List of user's permissions.\"\n    )\n    permission_groups = graphene.List(\n        \"saleor.graphql.account.types.Group\",\n        description=\"List of user's permission groups.\",\n    )\n    editable_groups = graphene.List(\n        \"saleor.graphql.account.types.Group\",\n        description=\"List of user's permission groups which user can manage.\",\n    )\n    avatar = graphene.Field(Image, size=graphene.Int(description=\"Size of the avatar.\"))\n    events = graphene.List(\n        CustomerEvent, description=\"List of events associated with the user.\"\n    )\n    stored_payment_sources = graphene.List(\n        \"saleor.graphql.payment.types.PaymentSource\",\n        description=\"List of stored payment sources.\",\n        channel=graphene.String(\n            description=\"Slug of a channel for which the data should be returned.\"\n        ),\n    )\n    language_code = graphene.Field(\n        LanguageCodeEnum, description=\"User language code.\", required=True\n    )\n    default_shipping_address = graphene.Field(Address)\n    default_billing_address = graphene.Field(Address)\n\n    last_login = graphene.DateTime()\n    date_joined = graphene.DateTime(required=True)\n    updated_at = graphene.DateTime(required=True)\n\n    class Meta:\n        description = \"Represents user data.\"\n        interfaces = [relay.Node, ObjectWithMetadata]\n        model = get_user_model()\n\n    @staticmethod\n    def resolve_addresses(root: models.User, _info, **_kwargs):\n        return root.addresses.annotate_default(root).all()  # type: ignore\n\n    @staticmethod\n    def resolve_checkout(root: models.User, _info, **_kwargs):\n        return get_user_checkout(root)\n\n    @staticmethod\n    @traced_resolver\n    def resolve_checkout_tokens(root: models.User, info, channel=None, **_kwargs):\n        def return_checkout_tokens(checkouts):\n            if not checkouts:\n                return []\n            checkout_global_ids = []\n            for checkout in checkouts:\n                checkout_global_ids.append(checkout.token)\n            return checkout_global_ids\n\n        if not channel:\n            return (\n                CheckoutByUserLoader(info.context)\n                .load(root.id)\n                .then(return_checkout_tokens)\n            )\n        return (\n            CheckoutByUserAndChannelLoader(info.context)\n            .load((root.id, channel))\n            .then(return_checkout_tokens)\n        )\n\n    @staticmethod\n    def resolve_gift_cards(root: models.User, info, **kwargs):\n        from ..giftcard.types import GiftCardCountableConnection\n\n        def _resolve_gift_cards(gift_cards):\n            return create_connection_slice(\n                gift_cards, info, kwargs, GiftCardCountableConnection\n            )\n\n        return (\n            GiftCardsByUserLoader(info.context).load(root.id).then(_resolve_gift_cards)\n        )\n\n    @staticmethod\n    def resolve_user_permissions(root: models.User, _info, **_kwargs):\n        from .resolvers import resolve_permissions\n\n        return resolve_permissions(root)\n\n    @staticmethod\n    def resolve_permission_groups(root: models.User, _info, **_kwargs):\n        return root.groups.all()\n\n    @staticmethod\n    def resolve_editable_groups(root: models.User, _info, **_kwargs):\n        return get_groups_which_user_can_manage(root)\n\n    @staticmethod\n    @one_of_permissions_required(\n        [AccountPermissions.MANAGE_USERS, AccountPermissions.MANAGE_STAFF]\n    )\n    def resolve_note(root: models.User, info):\n        return root.note\n\n    @staticmethod\n    @one_of_permissions_required(\n        [AccountPermissions.MANAGE_USERS, AccountPermissions.MANAGE_STAFF]\n    )\n    def resolve_events(root: models.User, info):\n        return CustomerEventsByUserLoader(info.context).load(root.id)\n\n    @staticmethod\n    def resolve_orders(root: models.User, info, **kwargs):\n        from ..order.types import OrderCountableConnection\n\n        def _resolve_orders(orders):\n            requester = get_user_or_app_from_context(info.context)\n            if not requester.has_perm(OrderPermissions.MANAGE_ORDERS):\n                orders = list(\n                    filter(lambda order: order.status != OrderStatus.DRAFT, orders)\n                )\n\n            return create_connection_slice(\n                orders, info, kwargs, OrderCountableConnection\n            )\n\n        return OrdersByUserLoader(info.context).load(root.id).then(_resolve_orders)\n\n    @staticmethod\n    def resolve_avatar(root: models.User, info, size=None, **_kwargs):\n        if root.avatar:\n            return Image.get_adjusted(\n                image=root.avatar,\n                alt=None,\n                size=size,\n                rendition_key_set=\"user_avatars\",\n                info=info,\n            )\n\n    @staticmethod\n    def resolve_stored_payment_sources(root: models.User, info, channel=None):\n        from .resolvers import resolve_payment_sources\n\n        if root == info.context.user:\n            return resolve_payment_sources(info, root, channel_slug=channel)\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_language_code(root, _info, **_kwargs):\n        return LanguageCodeEnum[str_to_enum(root.language_code)]\n\n    @staticmethod\n    def __resolve_references(roots: List[\"User\"], info, **_kwargs):\n        from .resolvers import resolve_users\n\n        ids = set()\n        emails = set()\n        for root in roots:\n            if root.id is not None:\n                ids.add(root.id)\n            else:\n                emails.add(root.email)\n\n        users = list(resolve_users(info, ids=ids, emails=emails))\n        users_by_id = {user.id: user for user in users}\n        users_by_email = {user.email: user for user in users}\n\n        results = []\n        for root in roots:\n            if root.id is not None:\n                _, user_id = from_global_id_or_error(root.id, User)\n                results.append(users_by_id.get(int(user_id)))\n            else:\n                results.append(users_by_email.get(root.email))\n        return results\n\n\nclass UserCountableConnection(CountableConnection):\n    class Meta:\n        node = User\n\n\nclass ChoiceValue(graphene.ObjectType):\n    raw = graphene.String()\n    verbose = graphene.String()\n\n\nclass AddressValidationData(graphene.ObjectType):\n    country_code = graphene.String()\n    country_name = graphene.String()\n    address_format = graphene.String()\n    address_latin_format = graphene.String()\n    allowed_fields = graphene.List(graphene.String)\n    required_fields = graphene.List(graphene.String)\n    upper_fields = graphene.List(graphene.String)\n    country_area_type = graphene.String()\n    country_area_choices = graphene.List(ChoiceValue)\n    city_type = graphene.String()\n    city_choices = graphene.List(ChoiceValue)\n    city_area_type = graphene.String()\n    city_area_choices = graphene.List(ChoiceValue)\n    postal_code_type = graphene.String()\n    postal_code_matchers = graphene.List(graphene.String)\n    postal_code_examples = graphene.List(graphene.String)\n    postal_code_prefix = graphene.String()\n\n\nclass StaffNotificationRecipient(graphene.ObjectType):\n    id = graphene.ID(required=True)\n    user = graphene.Field(\n        User,\n        description=\"Returns a user subscribed to email notifications.\",\n        required=False,\n    )\n    email = graphene.String(\n        description=(\n            \"Returns email address of a user subscribed to email notifications.\"\n        ),\n        required=False,\n    )\n    active = graphene.Boolean(description=\"Determines if a notification active.\")\n\n    class Meta:\n        description = (\n            \"Represents a recipient of email notifications send by Saleor, \"\n            \"such as notifications about new orders. Notifications can be \"\n            \"assigned to staff users or arbitrary email addresses.\"\n        )\n        interfaces = [relay.Node]\n        model = models.StaffNotificationRecipient\n\n    @staticmethod\n    def get_node(info, id):\n        try:\n            return models.StaffNotificationRecipient.objects.get(pk=id)\n        except models.StaffNotificationRecipient.DoesNotExist:\n            return None\n\n    @staticmethod\n    def resolve_user(root: models.StaffNotificationRecipient, info):\n        user = info.context.user\n        if user == root.user or user.has_perm(AccountPermissions.MANAGE_STAFF):\n            return root.user\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_email(root: models.StaffNotificationRecipient, _info):\n        return root.get_email()\n\n\n@federated_entity(\"id\")\nclass Group(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    name = graphene.String(required=True)\n    users = graphene.List(User, description=\"List of group users\")\n    permissions = graphene.List(Permission, description=\"List of group permissions\")\n    user_can_manage = graphene.Boolean(\n        required=True,\n        description=(\n            \"True, if the currently authenticated user has rights to manage a group.\"\n        ),\n    )\n\n    class Meta:\n        description = \"Represents permission group data.\"\n        interfaces = [relay.Node]\n        model = auth_models.Group\n\n    @staticmethod\n    @permission_required(AccountPermissions.MANAGE_STAFF)\n    def resolve_users(root: auth_models.Group, _info):\n        return root.user_set.all()\n\n    @staticmethod\n    def resolve_permissions(root: auth_models.Group, _info):\n        permissions = root.permissions.prefetch_related(\"content_type\").order_by(\n            \"codename\"\n        )\n        return format_permissions_for_display(permissions)\n\n    @staticmethod\n    def resolve_user_can_manage(root: auth_models.Group, info):\n        user = info.context.user\n        return can_user_manage_group(user, root)\n\n    @staticmethod\n    def __resolve_references(roots: List[\"Group\"], info, **_kwargs):\n        from .resolvers import resolve_permission_groups\n\n        requestor = get_user_or_app_from_context(info.context)\n        if not requestor.has_perm(AccountPermissions.MANAGE_STAFF):\n            qs = auth_models.Group.objects.none()\n        else:\n            qs = resolve_permission_groups(info)\n\n        return resolve_federation_references(Group, roots, qs)\n\n\nclass GroupCountableConnection(CountableConnection):\n    class Meta:\n        node = Group\n"], "fixing_code": ["# Changelog\n\nAll notable, unreleased changes to this project will be documented in this file. For the released changes, please visit the [Releases](https://github.com/mirumee/saleor/releases) page.\n\n\n# Unreleased\n\n### Breaking changes\n- Require manage orders for fetching `user.orders` - #9128 by @IKarbowiak\n  - only staff with `manage orders` and can fetch customer orders\n  - the customer can fetch his own orders, except drafts\n\n### Other changes\n- Filter Customer/Order/Sale/Product/ProductVariant by datetime of last modification - #9137 by @rafalp\n- Add possibility for plugins to execute code before each mutation - #9193 by @NyanKiyoshi\n- Add support for hiding plugins - #9219 by @NyanKiyoshi\n- Remove `graphene-federation` dependency - #9184 by @rafalp\n\n\n# 3.1.0\n\n### Breaking changes\n\n#### Plugins\n\n- Don't run plugins when calculating checkout's total price for available shipping methods resolution - #9121 by @rafalp\n  - Use either net or gross price depending on store configuration.\n\n### Other changes\n\n#### Saleor Apps\n\n- Add API for webhook payloads and deliveries - #8227 by @jakubkuc\n- Extend app by `AppExtension` - #7701 by @korycins\n- Add webhooks for stock changes: `PRODUCT_VARIANT_OUT_OF_STOCK` and `PRODUCT_VARIANT_BACK_IN_STOCK` - #7590 by @mstrumeck\n- Add `COLLECTION_CREATED`, `COLLECTION_UPDATED`, `COLLECTION_DELETED` events and webhooks - #8974 by @rafalp\n- Add draft orders webhooks by @jakubkuc\n- Add support for providing shipping methods by Saleor Apps - #7975 by @bogdal:\n  - Add `SHIPPING_LIST_METHODS_FOR_CHECKOUT` sync webhook\n- Add sales webhooks - #8157 @kuchichan\n- Allow fetching unpublished pages by apps with manage pages permission - #9181 by @IKarbowiak\n\n#### Metadata\n- Add ability to use metadata mutations with tokens as an identifier for orders and checkouts - #8426 by @IKarbowiak\n\n#### Attributes\n- Introduce swatch attributes - #7261 by @IKarbowiak\n- Add `variant_selection` to `ProductAttributeAssign` operations - #8235 by @kuchichan\n- Refactor attributes validation - #8905 by @IKarbowiak\n  - in create mutations: require all required attributes\n  - in update mutations: do not require providing any attributes; when any attribute is given, validate provided values.\n\n#### Other features and changes\n- Add gift cards - #7827 by @IKarbowiak, @tomaszszymanski129\n- Add Click & Collect - #7673 by @kuchichan\n- Add fulfillment confirmation - #7675 by @tomaszszymanski129\n- Make SKU an optional field on `ProductVariant` - #7633 by @rafalp\n- Possibility to pass metadata in input of `checkoutPaymentCreate` - #8076 by @mateuszgrzyb\n- Add `ExternalNotificationTrigger` mutation - #7821 by @mstrumeck\n- Extend `accountRegister` mutation to consume first & last name - #8184 by @piotrgrundas\n- Introduce sales/vouchers per product variant - #8064 by @kuchichan\n- Batch loads in queries for Apollo Federation - #8273 by @rafalp\n- Reserve stocks for checkouts - #7589 by @rafalp\n- Add query complexity limit to GraphQL API - #8526 by @rafalp\n- Add `quantity_limit_per_customer` field to ProductVariant #8405 by @kuchichan\n- Make collections names non-unique - #8986 by @rafalp\n- Add validation of unavailable products in the checkout. Mutations: `CheckoutShippingMethodUpdate`,\n  `CheckoutAddPromoCode`, `CheckoutPaymentCreate` will raise a ValidationError when product in the checkout is\n  unavailable - #8978 by @IKarbowiak\n- Add `withChoices` flag for Attribute type - #7733 by @dexon44\n- Update required permissions for attribute options - #9204 by @IKarbowiak\n  - Product attribute options can be fetched by requestors with manage product types and attributes permission.\n  - Page attribute options can be fetched by requestors with manage page types and attributes permission.\n- Deprecate interface field `PaymentData.reuse_source` - #7988 by @mateuszgrzyb\n- Deprecate `setup_future_usage` from `checkoutComplete.paymentData` input - will be removed in Saleor 4.0 - #7994 by @mateuszgrzyb\n- Fix shipping address issue in `availableCollectionPoints` resolver for checkout - #8143 by @kuchichan\n- Fix cursor-based pagination in products search - #8011 by @rafalp\n- Fix crash when querying external shipping methods `translation` field - #8971 by @rafalp\n- Fix crash when too long translation strings were passed to `translate` mutations - #8942 by @rafalp\n- Raise ValidationError in `CheckoutAddPromoCode`, `CheckoutPaymentCreate` when product in the checkout is\nunavailable - #8978 by @IKarbowiak\n- Remove `graphene-django` dependency - #9170 by @rafalp\n\n\n# 3.0.0\n\n### Breaking changes\n\n#### Behavior\n\n- Add multichannel - #6242 by @fowczarek @d-wysocki\n- Add email interface as a plugin - #6301 by @korycins\n- Add unconfirmed order editing - #6829 by @tomaszszymanski129\n  - Removed mutations for draft order lines manipulation: `draftOrderLinesCreate`, `draftOrderLineDelete`, `draftOrderLineUpdate`\n  - Added instead: `orderLinesCreate`, `orderLineDelete`, `orderLineUpdate` mutations instead.\n  - Order events enums `DRAFT_ADDED_PRODUCTS` and `DRAFT_REMOVED_PRODUCTS` are now `ADDED_PRODUCTS` and `REMOVED_PRODUCTS`\n- Remove resolving users location from GeoIP; drop `PaymentInput.billingAddress` input field - #6784 by @maarcingebala\n- Always create new checkout in `checkoutCreate` mutation - #7318 by @IKarbowiak\n  - deprecate `created` return field on `checkoutCreate` mutation\n- Return empty values list for attribute without choices - #7394 by @fowczarek\n  - `values` for attributes without choices from now are empty list.\n  - attributes with choices - `DROPDOWN` and `MULTISELECT`\n  - attributes without choices - `FILE`, `REFERENCE`, `NUMERIC` and `RICH_TEXT`\n- Unify checkout identifier in checkout mutations and queries - #7511 by @IKarbowiak\n- Propagate sale and voucher discounts over specific lines - #8793 by @korycins\n  - Use a new interface for response received from plugins/pluginManager. Methods `calculate_checkout_line_unit_price`\n    and `calculate_checkout_line_total` returns `TaxedPricesData` instead of `TaxedMoney`.\n- Attach sale discount info to the line when adding variant to order - #8821 by @IKarbowiak\n  - Use a new interface for the response received from plugins/pluginManager.\n    Methods `calculate_order_line_unit` and `calculate_order_line_total` returns\n    `OrderTaxedPricesData` instead of `TaxedMoney`.\n  - Rename checkout interfaces: `CheckoutTaxedPricesData` instead of `TaxedPricesData`\n    and `CheckoutPricesData` instead of `PricesData`\n- Sign JWT tokens with RS256 instead of HS256 - #7990 by @korycins\n- Add support for filtering available shipping methods by Saleor Apps - #8399 by @kczan, @stnatic\n  - Introduce `ShippingMethodData` interface as a root object type for ShippingMethod object\n- Limit number of user addresses - #9173 by @IKarbowiak\n\n#### GraphQL Schema\n\n- Drop deprecated meta mutations - #6422 by @maarcingebala\n- Drop deprecated service accounts and webhooks API - #6431 by @maarcingebala\n- Drop deprecated fields from the `ProductVariant` type: `quantity`, `quantityAllocated`, `stockQuantity`, `isAvailable` - #6436 by @maarcingebala\n- Drop authorization keys API - #6631 by @maarcingebala\n- Drop `type` field from `AttributeValue` type - #6710 by @IKarbowiak\n- Drop deprecated `taxRate` field from `ProductType` - #6795 by @d-wysocki\n- Drop deprecated queries and mutations - #7199 by @IKarbowiak\n  - drop `url` field from `Category` type\n  - drop `url` field from `Category` type\n  - drop `url` field from `Product` type\n  - drop `localized` fild from `Money` type\n  - drop `permissions` field from `User` type\n  - drop `navigation` field from `Shop` type\n  - drop `isActive` from `AppInput`\n  - drop `value` from `AttributeInput`\n  - drop `customerId` from `checkoutCustomerAttach`\n  - drop `stockAvailability` argument from `products` query\n  - drop `created` and `status` arguments from `orders` query\n  - drop `created` argument from `draftOrders` query\n  - drop `productType` from `ProductFilter`\n  - deprecate specific error fields `<TypeName>Errors`, typed `errors` fields and remove deprecation\n- Drop top-level `checkoutLine` query from the schema with related resolver, use `checkout` query instead - #7623 by @dexon44\n- Change error class in `CollectionBulkDelete` to `CollectionErrors` - #7061 by @d-wysocki\n- Make quantity field on `StockInput` required - #7082 by @IKarbowiak\n- Add description to shipping method - #7116 by @IKarbowiak\n  - `ShippingMethod` was extended with `description` field.\n  - `ShippingPriceInput` was extended with `description` field\n  - Extended `shippingPriceUpdate`, `shippingPriceCreate` mutation to add/edit description\n  - Input field in `shippingPriceTranslate` changed to `ShippingPriceTranslationInput`\n- Split `ShippingMethod` into `ShippingMethod` and `ShippingMethodType` (#8399):\n  - `ShippingMethod` is used to represent methods offered for checkouts and orders\n  - `ShippingMethodType` is used to manage shipping method configurations in Saleor\n  - Deprecate `availableShippingMethods` on `Order` and `Checkout`. Use `shippingMethods` and refer to the `active` field instead\n\n#### Saleor Apps\n\n- Drop `CHECKOUT_QUANTITY_CHANGED` webhook - #6797 by @d-wysocki\n- Change the payload of the order webhook to handle discounts list - #6874 by @korycins:\n  - added fields: `Order.discounts`, `OrderLine.unit_discount_amount`, `OrderLine.unit_discount_type`, `OrderLine.unit_discount_reason`,\n  - removed fields: `Order.discount_amount`, `Order.discount_name`, `Order.translated_discount_name`\n- Remove triggering a webhook event `PRODUCT_UPDATED` when calling `ProductVariantCreate` mutation. Use `PRODUCT_VARIANT_CREATED` instead - #6963 by @piotrgrundas\n- Make `order` property of invoice webhook payload contain order instead of order lines - #7081 by @pdblaszczyk\n  - Affected webhook events: `INVOICE_REQUESTED`, `INVOICE_SENT`, `INVOICE_DELETED`\n- Added `CHECKOUT_FILTER_SHIPPING_METHODS`, `ORDER_FILTER_SHIPPING_METHODS` sync webhooks - #8399 by @kczan, @stnatic\n\n#### Plugins\n\n- Drop `apply_taxes_to_shipping_price_range` plugin hook - #6746 by @maarcingebala\n- Refactor listing payment gateways - #7050 by @maarcingebala:\n  - Breaking changes in plugin methods: removed `get_payment_gateway` and `get_payment_gateway_for_checkout`; instead `get_payment_gateways` was added.\n- Improve checkout performance - introduce `CheckoutInfo` data class - #6958 by @IKarbowiak;\n  - Introduced changes in plugin methods definitions in the following methods, the `checkout` parameter changed to `checkout_info`:\n    - `calculate_checkout_total`\n    - `calculate_checkout_subtotal`\n    - `calculate_checkout_shipping`\n    - `get_checkout_shipping_tax_rate`\n    - `calculate_checkout_line_total`\n    - `calculate_checkout_line_unit_price`\n    - `get_checkout_line_tax_rate`\n    - `preprocess_order_creation`\n  - `preprocess_order_creation` was extend with `lines_info` parameter\n- Fix Avalara caching - #7036 by @fowczarek:\n  - Introduced changes in plugin methods definitions:\n    - `calculate_checkout_line_total` was extended with `lines` parameter\n    - `calculate_checkout_line_unit_price` was extended with `lines` parameter\n    - `get_checkout_line_tax_rate` was extended with `lines` parameter\n  - To get proper taxes we should always send the whole checkout to Avalara.\n- Extend plugins manager to configure plugins for each plugins - #7198 by @korycins:\n  - Introduce changes in API:\n    - `paymentInitialize` - add `channel` parameter. Optional when only one channel exists.\n    - `pluginUpdate` - add `channel` parameter.\n    - `availablePaymentGateways` - add `channel` parameter.\n    - `storedPaymentSources` - add `channel` parameter.\n    - `requestPasswordReset` - add `channel` parameter.\n    - `requestEmailChange` - add `channel` parameter.\n    - `confirmEmailChange` - add `channel` parameter.\n    - `accountRequestDeletion` - add `channel` parameter.\n    - change structure of type `Plugin`:\n      - add `globalConfiguration` field for storing configuration when a plugin is globally configured\n      - add `channelConfigurations` field for storing plugin configuration for each channel\n      - removed `configuration` field, use `globalConfiguration` and `channelConfigurations` instead\n    - change structure of input `PluginFilterInput`:\n      - add `statusInChannels` field\n      - add `type` field\n      - removed `active` field. Use `statusInChannels` instead\n  - Change plugin webhook endpoint - #7332 by @korycins.\n    - Use /plugins/channel/<channel_slug>/<plugin_id> for plugins with channel configuration\n    - Use /plugins/global/<plugin_id> for plugins with global configuration\n    - Remove /plugin/<plugin_id> endpoint\n- Fix doubling price in checkout for products without tax - #7056 by @IKarbowiak:\n  - Introduce changes in plugins method:\n    - `calculate_checkout_subtotal` has been dropped from plugins;\n    - for correct subtotal calculation, `calculate_checkout_line_total` must be set (manager method for calculating checkout subtotal uses `calculate_checkout_line_total` method)\n- Deprecated Stripe plugin - will be removed in Saleor 4.0\n  - rename `StripeGatewayPlugin` to `DeprecatedStripeGatewayPlugin`.\n  - introduce new `StripeGatewayPlugin` plugin.\n\n### Other changes\n\n#### Features\n\n- Migrate from Draft.js to Editor.js format - #6430, #6456 by @IKarbowiak\n- Allow using `Bearer` as an authorization prefix - #6996 by @korycins\n- Add product rating - #6284 by @korycins\n- Add order confirmation - #6498 by @tomaszszymanski12\n- Extend Vatlayer functionalities - #7101 by @korycins:\n  - Allow users to enter a list of exceptions (country ISO codes) that will use the source country rather than the destination country for tax purposes.\n  - Allow users to enter a list of countries for which no VAT will be added.\n- Extend order with origin and original order values - #7326 by @IKarbowiak\n- Allow impersonating user by an app/staff - #7754 by @korycins:\n  - Add `customerId` to `checkoutCustomerAttach` mutation\n  - Add new permission `IMPERSONATE_USER`\n- Add possibility to apply a discount to order/order line with status `DRAFT` - #6930 by @korycins\n- Implement database read replicas - #8516, #8751 by @fowczarek\n- Propagate sale and voucher discounts over specific lines - #8793 by @korycins\n  - The created order lines from checkout will now have fulfilled all undiscounted fields with a default price value\n    (without any discounts).\n  - Order line will now include a voucher discount (in the case when the voucher is for specific products or have a\n    flag apply_once_per_order). In that case, `Order.discounts` will not have a relation to `OrderDiscount` object.\n  - Webhook payload for `OrderLine` will now include two new fields, `sale_id` (graphql ID of applied sale) and\n    `voucher_code` (code of the valid voucher applied to this line).\n  - When any sale or voucher discount was applied, `line.discount_reason` will be fulfilled.\n  - New interface for handling more data for prices: `PricesData` and `TaxedPricesData` used in checkout calculations\n    and in plugins/pluginManager.\n- Attach sale discount info to the line when adding variant to order - #8821 by @IKarbowiak\n  - Rename checkout interfaces: `CheckoutTaxedPricesData` instead of `TaxedPricesData`\n    and `CheckoutPricesData` instead of `PricesData`\n  - New interface for handling more data for prices: `OrderTaxedPricesData` used in plugins/pluginManager.\n- Add uploading video URLs to product gallery - #6838 by @GrzegorzDerdak\n- Add generic `FileUpload` mutation - #6470 by @IKarbowiak\n\n#### Metadata\n- Allow passing metadata to `accountRegister` mutation - #7152 by @piotrgrundas\n- Copy metadata fields when creating reissue - #7358 by @IKarbowiak\n- Add metadata to shipping zones and shipping methods - #6340 by @maarcingebala\n- Add metadata to menu and menu item - #6648 by @tomaszszymanski129\n- Add metadata to warehouse - #6727 by @d-wysocki\n- Added support for querying objects by metadata fields - #6683 by @LeOndaz, #7421 by @korycins\n- Change metadata mutations to use token for order and checkout as an identifier - #8542 by @IKarbowiak\n  - After changes, using the order `id` for changing order metadata is deprecated\n\n#### Attributes\n- Add rich text attribute input - #7059 by @piotrgrundas\n- Support setting value for AttributeValue mutations - #7037 by @piotrgrundas\n- Add boolean attributes - #7454 by @piotrgrundas\n- Add date & date time attributes - #7500 by @piotrgrundas\n- Add file attributes - #6568 by @IKarbowiak\n- Add page reference attributes - #6624 by @IKarbowiak\n- Add product reference attributes - #6711 by @IKarbowiak\n- Add numeric attributes - #6790 by @IKarbowiak\n- Add `withChoices` flag for Attribute type - #7733 by @CossackDex\n- Return empty results when filtering by non-existing attribute - #7025 by @maarcingebala\n- Add Page Types - #6261 by @IKarbowiak\n\n#### Plugins\n- Add interface for integrating the auth plugins - #6799 by @korycins\n- Add Sendgrid plugin - #6793 by @korycins\n- Trigger `checkout_updated` plugin method for checkout metadata mutations - #7392 by @maarcingebala\n\n#### Saleor Apps\n- Add synchronous payment webhooks - #7044 by @maarcingebala\n- Add `CUSTOMER_UPDATED` webhook, add addresses field to customer `CUSTOMER_CREATED` webhook - #6898 by @piotrgrundas\n- Add `PRODUCT_VARIANT_CREATED`, `PRODUCT_VARIANT_UPDATED`, `PRODUCT_VARIANT_DELETED` webhooks, fix attributes field for `PRODUCT_CREATED`, `PRODUCT_UPDATED` webhooks - #6963 by @piotrgrundas\n- Trigger `PRODUCT_UPDATED` webhook for collections and categories mutations - #7051 by @d-wysocki\n- Extend order webhook payload with fulfillment fields - #7364, #7347 by @korycins\n  - fulfillments extended with:\n    - `total_refund_amount`\n    - `shipping_refund_amount`\n    - `lines`\n  - fulfillment lines extended with:\n    - `total_price_net_amount`\n    - `total_price_gross_amount`\n    - `undiscounted_unit_price_net`\n    - `undiscounted_unit_price_gross`\n    - `unit_price_net`\n- Extend order payload with undiscounted prices and add psp_reference to payment model - #7339 by @IKarbowiak\n  - order payload extended with the following fields:\n    - `undiscounted_total_net_amount`\n    - `undiscounted_total_gross_amount`\n    - `psp_reference` on `payment`\n  - order lines extended with:\n    - `undiscounted_unit_price_net_amount`\n    - `undiscounted_unit_price_gross_amount`\n    - `undiscounted_total_price_net_amount`\n    - `undiscounted_total_price_gross_amount`\n- Add `product_id`, `product_variant_id`, `attribute_id` and `page_id` when it is possible for `AttributeValue` translations webhook - #7783 by @fowczarek\n- Add draft orders webhooks - #8102 by @jakubkuc\n- Add page webhooks: `PAGE_CREATED`, `PAGE_UPDATED` and `PAGE_DELETED` - #6787 by @d-wysocki\n- Add `PRODUCT_DELETED` webhook - #6794 by @d-wysocki\n- Add `page_type_id` in translations webhook - #7825 by @fowczarek\n- Fix failing account mutations for app - #7569 by @IKarbowiak\n- Add app support for events - #7622 by @IKarbowiak\n- Fix creating translations with app - #6804 by @krzysztofwolski\n- Change the `app` query to return info about the currently authenticated app - #6928 by @d-wysocki\n- Mark `X-` headers as deprecated and add headers without prefix. All deprecated headers will be removed in Saleor 4.0 - #8179 by @L3str4nge\n  - X-Saleor-Event -> Saleor-Event\n  - X-Saleor-Domain -> Saleor-Domain\n  - X-Saleor-Signature -> Saleor-Signature\n  - X-Saleor-HMAC-SHA256 -> Saleor-HMAC-SHA256\n\n#### Other changes\n- Add query contains only schema validation - #6827 by @fowczarek\n- Add introspection caching - #6871 by @fowczarek\n- Fix Sentry reporting - #6902 by @fowczarek\n- Deprecate API fields `Order.discount`, `Order.discountName`, `Order.translatedDiscountName` - #6874 by @korycins\n- Fix argument validation in page resolver - #6960 by @fowczarek\n- Drop `data` field from checkout line model - #6961 by @fowczarek\n- Fix `totalCount` on connection resolver without `first` or `last` - #6975 by @fowczarek\n- Fix variant resolver on `DigitalContent` - #6983 by @fowczarek\n- Fix resolver by id and slug for product and product variant - #6985 by @d-wysocki\n- Add optional support for reporting resource limits via a stub field in `shop` - #6967 by @NyanKiyoshi\n- Update checkout quantity when checkout lines are deleted - #7002 by @IKarbowiak\n- Fix available shipping methods - return also weight methods without weight limits - #7021 by @IKarbowiak\n- Validate discount value for percentage vouchers and sales - #7033 by @d-wysocki\n- Add field `languageCode` to types: `AccountInput`, `AccountRegisterInput`, `CheckoutCreateInput`, `CustomerInput`, `Order`, `User`. Add field `languageCodeEnum` to `Order` type. Add new mutation `CheckoutLanguageCodeUpdate`. Deprecate field `Order.languageCode`. - #6609 by @korycins\n- Extend `Transaction` type with gateway response and `Payment` type with filter - #7062 by @IKarbowiak\n- Fix invalid tax rates for lines - #7058 by @IKarbowiak\n- Allow seeing unconfirmed orders - #7072 by @IKarbowiak\n- Raise `GraphQLError` when too big integer value is provided - #7076 by @IKarbowiak\n- Do not update draft order addresses when user is changing - #7088 by @IKarbowiak\n- Recalculate draft order when product/variant was deleted - #7085 by @d-wysocki\n- Added validation for `DraftOrderCreate` with negative quantity line - #7085 by @d-wysocki\n- Remove HTML tags from product `description_plaintext` - #7094 by @d-wysocki\n- Fix failing product tasks when instances are removed - #7092 by @IKarbowiak\n- Update GraphQL endpoint to only match exactly `/graphql/` without trailing characters - #7117 by @IKarbowiak\n- Introduce `traced_resolver` decorator instead of Graphene middleware - #7159 by @tomaszszymanski129\n- Fix failing export when exporting attribute without values - #7131 by @IKarbowiak\n- Fix incorrect payment data for Klarna - #7150 by @IKarbowiak\n- Drop deleted images from storage - #7129 by @IKarbowiak\n- Fix export with empty assignment values - #7214 by @IKarbowiak\n- Change exported file name - #7222 by @IKarbowiak\n- Fix core sorting on related fields - #7195 by @tomaszszymanski129\n- Use GraphQL IDs instead of database IDs in export - #7240 by @IKarbowiak\n- Fix draft order tax mismatch - #7226 by @IKarbowiak\n  - Introduce `calculate_order_line_total` plugin method\n- Update core logging for better Celery tasks handling - #7251 by @tomaszszymanski129\n- Raise `ValidationError` when refund cannot be performed - #7260 by @IKarbowiak\n- Fix customer addresses missing after customer creation - #7327 by @tomaszszymanski129\n- Fix invoice generation - #7376 by @tomaszszymanski129\n- Allow defining only one field in translations - #7363 by @IKarbowiak\n- Allow filtering pages by ids - #7393 by @IKarbowiak\n- Fix validate `min_spent` on vouchers to use net or gross value depends on `settings.display_gross_prices` - #7408 by @d-wysocki\n- Fix invoice generation - #7376 by tomaszszymanski129\n- Add hash to uploading images #7453 by @IKarbowiak\n- Add file format validation for uploaded images - #7447 by @IKarbowiak\n- Fix attaching params for address form errors - #7485 by @IKarbowiak\n- Update draft order validation - #7253 by @IKarbowiak\n  - Extend Order type with errors: [OrderError!]! field\n  - Create tasks for deleting order lines by deleting products or variants\n- Fix doubled checkout total price for one line and zero shipping price - #7532 by @IKarbowiak\n- Deprecate nested objects in `TranslatableContent` types - #7522 by @IKarbowiak\n- Modify order of auth middleware calls - #7572 by @tomaszszymanski129\n- Drop assigning cheapest shipping method in checkout - #7767 by @maarcingebala\n- Deprecate `query` argument in `sales` and `vouchers` queries - #7806 by @maarcingebala\n- Allow translating objects by translatable content ID - #7803 by @maarcingebala\n- Configure a periodic task for removing empty allocations - #7885 by @fowczarek\n- Fix missing transaction id in Braintree - #8110 by @fowczarek\n- Fix GraphQL federation support - #7771 #8107 by @rafalp\n- Fix cursor-based pagination in products search - #8011 #8211 by @rafalp\n- Batch loads in queries for Apollo Federation - #8362 by @rafalp\n- Add workaround for failing Avatax when line has price 0 - #8610 by @korycins\n- Add option to set tax code for shipping in Avatax configuration view - #8596 by @korycins\n- Fix Avalara tax fetching from cache - #8647 by @fowczarek\n- Fix incorrect stock allocation - #8931 by @IKarbowiak\n- Fix incorrect handling of unavailable products in checkout - #8978, #9119 by @IKarbowiak, @korycins\n- Add draft orders webhooks - #8102 by @jakubkuc\n- Handle `SameSite` cookie attribute in jwt refresh token middleware - #8209 by @jakubkuc\n- Fix creating translations with app - #6804 by @krzysztofwolski\n- Add possibility to provide external payment ID during the conversion draft order to order - #6320 by @korycins\n- Add basic rating for `Products` - #6284 by @korycins\n- Add metadata to shipping zones and shipping methods - #6340 by @maarcingebala\n- Add Page Types - #6261 by @IKarbowiak\n- Migrate draftjs content to editorjs format - #6430 by @IKarbowiak\n- Add editorjs sanitizer - #6456 by @IKarbowiak\n- Add generic FileUpload mutation - #6470 by @IKarbowiak\n- Order confirmation backend - #6498 by @tomaszszymanski129\n- Handle `SameSite` cookie attribute in JWT refresh token middleware - #8209 by @jakubkuc\n- Add possibility to provide external payment ID during the conversion draft order to order - #6320 by @korycins9\n- Fix password reset request - #6351 by @Manfred-Madelaine-pro, Ambroise and Pierre\n- Refund products support - #6530 by @korycins\n- Add possibility to exclude products from shipping method - #6506 by @korycins\n- Add `Shop.availableShippingMethods` query - #6551 by @IKarbowiak\n- Add delivery time to shipping method - #6564 by @IKarbowiak\n- Shipping zone description - #6653 by @tomaszszymanski129\n- Get tax rate from plugins - #6649 by @IKarbowiak\n- Added support for querying user by email - #6632 @LeOndaz\n- Add order shipping tax rate - #6678 by @IKarbowiak\n- Deprecate field `descriptionJSON` from `Product`, `Category`, `Collection` and field `contentJSON` from `Page` - #6692 by @d-wysocki\n- Fix products visibility - #6704 by @IKarbowiak\n- Fix page `contentJson` field to return JSON - #6832 by @d-wysocki\n- Add SearchRank to search product by name and description. New enum added to `ProductOrderField` - `RANK` - which returns results sorted by search rank - #6872 by @d-wysocki\n- Allocate stocks for order lines in a bulk way - #6877 by @IKarbowiak\n- Deallocate stocks for order lines in a bulk way - #6896 by @IKarbowiak\n- Prevent negative available quantity - #6897 by @d-wysocki\n- Add default sorting by rank for search products - #6936 by @d-wysocki\n- Fix exporting product description to xlsx - #6959 by @IKarbowiak\n- Add `Shop.version` field to query API version - #6980 by @maarcingebala\n- Add new authorization header `Authorization-Bearer` - #6998 by @korycins\n- Add field `paymentMethodType` to `Payment` object - #7073 by @korycins\n- Unify Warehouse Address API - #7481 by @d-wysocki\n  - deprecate `companyName` on `Warehouse` type\n  - remove `companyName` on `WarehouseInput` type\n  - remove `WarehouseAddressInput` on `WarehouseUpdateInput` and `WarehouseCreateInput`, and change it to `AddressInput`\n- Fix passing incorrect customer email to payment gateways - #7486 by @korycins\n- Add HTTP meta tag for Content-Security-Policy in GraphQL Playground - #7662 by @NyanKiyoshi\n- Add additional validation for `from_global_id_or_error` function - #8780 by @CossackDex\n# 2.11.1\n\n- Add support for Apple Pay on the web - #6466 by @korycins\n\n## 2.11.0\n\n### Features\n\n- Add products export - #5255 by @IKarbowiak\n- Add external apps support - #5767 by @korycins\n- Invoices backend - #5732 by @tomaszszymanski129\n- Adyen drop-in integration - #5914 by @korycins, @IKarbowiak\n- Add a callback view to plugins - #5884 by @korycins\n- Support pushing webhook events to message queues - #5940 by @patrys, @korycins\n- Send a confirmation email when the order is canceled or refunded - #6017\n- No secure cookie in debug mode - #6082 by @patrys, @orzechdev\n- Add searchable and available for purchase flags to product - #6060 by @IKarbowiak\n- Add `TotalPrice` to `OrderLine` - #6068 @fowczarek\n- Add `PRODUCT_UPDATED` webhook event - #6100 by @tomaszszymanski129\n- Search orders by GraphQL payment ID - #6135 by @korycins\n- Search orders by a custom key provided by payment gateway - #6135 by @korycins\n- Add ability to set a default product variant - #6140 by @tomaszszymanski129\n- Allow product variants to be sortable - #6138 by @tomaszszymanski129\n- Allow fetching stocks for staff users only with `MANAGE_ORDERS` permissions - #6139 by @fowczarek\n- Add filtering to `ProductVariants` query and option to fetch variant by SKU in `ProductVariant` query - #6190 by @fowczarek\n- Add filtering by Product IDs to `products` query - #6224 by @GrzegorzDerdak\n- Add `change_currency` command - #6016 by @maarcingebala\n- Add dummy credit card payment - #5822 by @IKarbowiak\n- Add custom implementation of UUID scalar - #5646 by @koradon\n- Add `AppTokenVerify` mutation - #5716 by @korycins\n\n### Breaking Changes\n\n- Refactored JWT support. Requires handling of JWT token in the storefront (a case when the backend returns the exception about the invalid token). - #5734, #5816 by @korycins\n- New logging setup will now output JSON logs in production mode for ease of feeding them into log collection systems like Logstash or CloudWatch Logs - #5699 by @patrys\n- Deprecate `WebhookEventType.CHECKOUT_QUANTITY_CHANGED` - #5837 by @korycins\n- Anonymize and update order and payment fields; drop `PaymentSecureConfirm` mutation, drop Payment type fields: `extraData`, `billingAddress`, `billingEmail`, drop `gatewayResponse` from `Transaction` type - #5926 by @IKarbowiak\n- Switch the HTTP stack from WSGI to ASGI based on Uvicorn - #5960 by @patrys\n- Add `MANAGE_PRODUCT_TYPES_AND_ATTRIBUTES` permission, which is now required to access all attributes and product types related mutations - #6219 by @IKarbowiak\n\n### Fixes\n\n- Fix payment fields in order payload for webhooks - #5862 by @korycins\n- Fix specific product voucher in draft orders - #5727 by @fowczarek\n- Explicit country assignment in default shipping zones - #5736 by @maarcingebala\n- Drop `json_content` field from the `Menu` model - #5761 by @maarcingebala\n- Strip warehouse name in mutations - #5766 by @koradon\n- Add missing order events during checkout flow - #5684 by @koradon\n- Update Google Merchant to get tax rate based by plugin manager - #5823 by @gabmartinez\n- Allow unicode in slug fields - #5877 by @IKarbowiak\n- Fix empty plugin object result after `PluginUpdate` mutation - #5968 by @gabmartinez\n- Allow finishing checkout when price amount is 0 - #6064 by @IKarbowiak\n- Fix incorrect tax calculation for Avatax - #6035 by @korycins\n- Fix incorrect calculation of subtotal with active Avatax - #6035 by @korycins\n- Fix incorrect assignment of tax code for Avatax - #6035 by @korycins\n- Do not allow negative product price - #6091 by @IKarbowiak\n- Handle None as attribute value - #6092 by @IKarbowiak\n- Fix for calling `order_created` before the order was saved - #6095 by @korycins\n- Update default decimal places - #6098 by @IKarbowiak\n- Avoid assigning the same pictures twice to a variant - #6112 by @IKarbowiak\n- Fix crashing system when Avalara is improperly configured - #6117 by @IKarbowiak\n- Fix for failing finalising draft order - #6133 by @korycins\n- Remove corresponding draft order lines when variant is removing - #6119 by @IKarbowiak\n- Update required perms for apps management - #6173 by @IKarbowiak\n- Raise an error for an empty key in metadata - #6176 by @IKarbowiak\n- Add attributes to product error - #6181 by @IKarbowiak\n- Allow to add product variant with 0 price to draft order - #6189 by @IKarbowiak\n- Fix deleting product when default variant is deleted - #6186 by @IKarbowiak\n- Fix get unpublished products, product variants and collection as app - #6194 by @fowczarek\n- Set `OrderFulfillStockInput` fields as required - #6196 by @IKarbowiak\n- Fix attribute filtering by categories and collections - #6214 by @fowczarek\n- Fix `is_visible` when `publication_date` is today - #6225 by @korycins\n- Fix filtering products by multiple attributes - #6215 by @GrzegorzDerdak\n- Add attributes validation while creating/updating a product's variant - #6269 by @GrzegorzDerdak\n- Add metadata to page model - #6292 by @dominik-zeglen\n- Fix for unnecessary attributes validation while updating simple product - #6300 by @GrzegorzDerdak\n- Include order line total price to webhook payload - #6354 by @korycins\n- Fix for fulfilling an order when product quantity equals allocated quantity - #6333 by @GrzegorzDerdak\n- Fix for the ability to filter products on collection - #6363 by @GrzegorzDerdak\n\n## 2.10.2\n\n- Add command to change currencies in the database - #5906 by @d-wysocki\n\n## 2.10.1\n\n- Fix multiplied stock quantity - #5675 by @fowczarek\n- Fix invalid allocation after migration - #5678 by @fowczarek\n- Fix order mutations as app - #5680 by @fowczarek\n- Prevent creating checkout/draft order with unpublished product - #5676 by @d-wysocki\n\n## 2.10.0\n\n- OpenTracing support - #5188 by @tomaszszymanski129\n- Account confirmation email - #5126 by @tomaszszymanski129\n- Relocate `Checkout` and `CheckoutLine` methods into separate module and update checkout related plugins to use them - #4980 by @krzysztofwolski\n- Fix problem with free shipping voucher - #4942 by @IKarbowiak\n- Add sub-categories to random data - #4949 by @IKarbowiak\n- Deprecate `localized` field in Money type - #4952 by @IKarbowiak\n- Fix for shipping API not applying taxes - #4913 by @kswiatek92\n- Query object translation with only `manage_translation` permission - #4914 by @fowczarek\n- Add customer note to draft orders API - #4973 by @IKarbowiak\n- Allow to delete category and leave products - #4970 by @IKarbowiak\n- Remove thumbnail generation from migration - #3494 by @kswiatek92\n- Rename 'shipping_date' field in fulfillment model to 'created' - #2433 by @kswiatek92\n- Reduce number of queries for 'checkoutComplete' mutation - #4989 by @IKarbowiak\n- Force PyTest to ignore the environment variable containing the Django settings module - #4992 by @NyanKiyoshi\n- Extend JWT token payload with user information - #4987 by @salwator\n- Optimize the queries for product list in the dashboard - #4995 by @IKarbowiak\n- Drop dashboard 1.0 - #5000 by @IKarbowiak\n- Fixed serialization error on weight fields when running `loaddata` and `dumpdb` - #5005 by @NyanKiyoshi\n- Fixed JSON encoding error on Google Analytics reporting - #5004 by @NyanKiyoshi\n- Create custom field to translation, use new translation types in translations query - #5007 by @fowczarek\n- Take allocated stock into account in `StockAvailability` filter - #5019 by @simonbru\n- Generate matching postal codes for US addresses - #5033 by @maarcingebala\n- Update debug toolbar - #5032 by @IKarbowiak\n- Allow staff member to receive notification about customers orders - #4993 by @kswiatek92\n- Add user's global id to the JWT payload - #5039 by @salwator\n- Make middleware path resolving lazy - #5041 by @NyanKiyoshi\n- Generate slug on saving the attribute value - #5055 by @fowczarek\n- Fix order status after order update - #5072 by @fowczarek\n- Extend top-level connection resolvers with ability to sort results - #5018 by @fowczarek\n- Drop storefront 1.0 - #5043 by @IKarbowiak\n- Replace permissions strings with enums - #5038 by @kswiatek92\n- Remove gateways forms and templates - #5075 by @IKarbowiak\n- Add `Wishlist` models and GraphQL endpoints - #5021 by @derenio\n- Remove deprecated code - #5107 by @IKarbowiak\n- Fix voucher start date filtering - #5133 by @dominik-zeglen\n- Search by sku in products query - #5117 by @fowczarek\n- Send fulfillment update email - #5118 by @IKarbowiak\n- Add address query - #5148 by @kswiatek92\n- Add `checkout_quantity_changed` webhook - #5042 by @derenio\n- Remove unnecessary `manage_orders` permission - #5142 by @kswiatek92\n- Mutation to change the user email - #5076 by @kswiatek92\n- Add MyPy checks - #5150 by @IKarbowiak\n- Move extracting user or service account to utils - #5152 by @kswiatek92\n- Deprecate order status/created arguments - #5076 by @kswiatek92\n- Fix getting title field in page mutations #5160 by @maarcingebala\n- Copy public and private metadata from the checkout to the order upon creation - #5165 by @dankolbman\n- Add warehouses and stocks- #4986 by @szewczykmira\n- Add permission groups - #5176, #5513 by @IKarbowiak\n- Drop `gettext` occurrences - #5189 by @IKarbowiak\n- Fix `product_created` webhook - #5187 by @dzkb\n- Drop unused resolver `resolve_availability` - #5190 by @maarcingebala\n- Fix permission for `checkoutCustomerAttach` mutation - #5192 by @maarcingebala\n- Restrict access to user field - #5194 by @maarcingebala\n- Unify permission for service account API client in test - #5197 by @fowczarek\n- Add additional confirmation step to `checkoutComplete` mutation - #5179 by @salwator\n- Allow sorting warehouses by name - #5211 by @dominik-zeglen\n- Add anonymization to GraphQL's `webhookSamplePayload` endpoint - #5161 @derenio\n- Add slug to `Warehouse`, `Product` and `ProductType` models - #5196 by @IKarbowiak\n- Add mutation for assigning, unassigning shipping zones to warehouse - #5217 by @kswiatek92\n- Fix passing addresses to `PaymentData` objects - #5223 by @maarcingebala\n- Return `null` when querying `me` as an anonymous user - #5231 by @maarcingebala\n- Added `PLAYGROUND_ENABLED` environment variable/setting to allow to enable the GraphQL playground when `DEBUG` is disabled - #5254 by @NyanKiyoshi\n- Fix access to order query when request from service account - #5258 by @fowczarek\n- Customer shouldn't be able to see draft orders by token - #5259 by @fowczarek\n- Customer shouldn't be able to query checkout with another customer - #5268 by @fowczarek\n- Added integration support of Jaeger Tracing - #5282 by @NyanKiyoshi\n- Return `null` when querying `me` as an anonymous user - #5231 as @maarcingebala\n- Add `fulfillment created` webhook - @szewczykmira\n- Unify metadata API - #5178 by @fowczarek\n- Add compiled versions of emails to the repository - #5260 by @tomaszszymanski129\n- Add required prop to fields where applicable - #5293 by @dominik-zeglen\n- Drop `get_absolute_url` methods - #5299 by @IKarbowiak\n- Add `--force` flag to `cleardb` command - #5302 by @maarcingebala\n- Require non-empty message in `orderAddNote` mutation - #5316 by @maarcingebala\n- Stock management refactor - #5323 by @IKarbowiak\n- Add discount error codes - #5348 by @IKarbowiak\n- Add benchmarks to checkout mutations - #5339 by @fowczarek\n- Add pagination tests - #5363 by @fowczarek\n- Add ability to assign multiple warehouses in mutations to create/update a shipping zone - #5399 by @fowczarek\n- Add filter by ids to the `warehouses` query - #5414 by @fowczarek\n- Add shipping rate price validation - #5411 by @kswiatek92\n- Remove unused settings and environment variables - #5420 by @maarcingebala\n- Add product price validation - #5413 by @kswiatek92\n- Add attribute validation to `attributeAssign` mutation - #5423 by @kswiatek92\n- Add possibility to update/delete more than one item in metadata - #5446 by @koradon\n- Check if image exists before validating - #5425 by @kswiatek92\n- Fix warehouses query not working without id - #5441 by @koradon\n- Add `accountErrors` to `CreateToken` mutation - #5437, #5465 by @koradon\n- Raise `GraphQLError` if filter has invalid IDs - #5460 by @gabmartinez\n- Use `AccountErrorCode.INVALID_CREDENTIALS` instead of `INVALID_PASSWORD` - #5495 by @koradon\n- Add tests for pagination - #5468 by @koradon\n- Add `Job` abstract model and interface - #5510 by @IKarbowiak\n- Refactor implementation of allocation - #5445 by @fowczarek\n- Fix `WeightScalar` - #5530 by @koradon\n- Add `OrderFulfill` mutation - #5525 by @fowczarek\n- Add \"It Works\" page - #5494 by @IKarbowiak and @dominik-zeglen\n- Extend errors in `OrderFulfill` mutation - #5553 by @fowczarek\n- Refactor `OrderCancel` mutation for multiple warehouses - #5554 by @fowczarek\n- Add negative weight validation - #5564 by @fowczarek\n- Add error when user pass empty object as address - #5585 by @fowczarek\n- Fix payment creation without shipping method - #5444 by @d-wysocki\n- Fix checkout and order flow with variant without inventory tracking - #5599 by @fowczarek\n- Fixed JWT expired token being flagged as unhandled error rather than handled. - #5603 by @NyanKiyoshi\n- Refactor read-only middleware - #5602 by @maarcingebala\n- Fix availability for variants without inventory tracking - #5605 by @fowczarek\n- Drop support for configuring Vatlayer plugin from settings file. - #5614 by @korycins\n- Add ability to query category, collection or product by slug - #5574 by @koradon\n- Add `quantityAvailable` field to `ProductVariant` type - #5628 by @fowczarek\n- Use tags rather than time-based logs for information on requests - #5608 by @NyanKiyoshi\n\n## 2.9.0\n\n### API\n\n- Add mutation to change customer's first name last name - #4489 by @fowczarek\n- Add mutation to delete customer's account - #4494 by @fowczarek\n- Add mutation to change customer's password - #4656 by @fowczarek\n- Add ability to customize email sender address in emails sent by Saleor - #4820 by @NyanKiyoshi\n- Add ability to filter attributes per global ID - #4640 by @NyanKiyoshi\n- Add ability to search product types by value (through the name) - #4647 by @NyanKiyoshi\n- Add queries and mutation for serving and saving the configuration of all plugins - #4576 by @korycins\n- Add `redirectUrl` to staff and user create mutations - #4717 by @fowczarek\n- Add error codes to mutations responses - #4676 by @Kwaidan00\n- Add translations to countries in `shop` query - #4732 by @fowczarek\n- Add support for sorting product by their attribute values through given attribute ID - #4740 by @NyanKiyoshi\n- Add descriptions for queries and query arguments - #4758 by @maarcingebala\n- Add support for Apollo Federation - #4825 by @salwator\n- Add mutation to create multiple product variants at once - #4735 by @fowczarek\n- Add default value to custom errors - #4797 by @fowczarek\n- Extend `availablePaymentGateways` field with gateways' configuration data - #4774 by @salwator\n- Change `AddressValidationRules` API - #4655 by @Kwaidan00\n- Use search in a consistent way; add sort by product type name and publication status to `products` query. - #4715 by @fowczarek\n- Unify `menuItemMove` mutation with other reordering mutations - #4734 by @NyanKiyoshi\n- Don't create an order when the payment was unsuccessful - #4500 by @NyanKiyoshi\n- Don't require shipping information in checkout for digital orders - #4573 by @NyanKiyoshi\n- Drop `manage_users` permission from the `permissions` query - #4854 by @maarcingebala\n- Deprecate `inCategory` and `inCollection` attributes filters in favor of `filter` argument - #4700 by @NyanKiyoshi & @khalibloo\n- Remove `PaymentGatewayEnum` from the schema, as gateways now are dynamic plugins - #4756 by @salwator\n- Require `manage_products` permission to query `costPrice` and `stockQuantity` fields - #4753 by @NyanKiyoshi\n- Refactor account mutations - #4510, #4668 by @fowczarek\n- Fix generating random avatars when updating staff accounts - #4521 by @maarcingebala\n- Fix updating JSON menu representation in mutations - #4524 by @maarcingebala\n- Fix setting variant's `priceOverride` and `costPrice` to `null` - #4754 by @NyanKiyoshi\n- Fix fetching staff user without `manage_users` permission - #4835 by @fowczarek\n- Ensure that a GraphQL query is a string - #4836 by @nix010\n- Add ability to configure the password reset link - #4863 by @fowczarek\n- Fixed a performance issue where Saleor would sometimes run huge, unneeded prefetches when resolving categories or collections - #5291 by @NyanKiyoshi\n- uWSGI now forces the django application to directly load on startup instead of being lazy - #5357 by @NyanKiyoshi\n\n### Core\n\n- Add enterprise-grade attributes management - #4351 by @dominik-zeglen and @NyanKiyoshi\n- Add extensions manager - #4497 by @korycins\n- Add service accounts - backend support - #4689 by @korycins\n- Add support for webhooks - #4731 by @korycins\n- Migrate the attributes mapping from HStore to many-to-many relation - #4663 by @NyanKiyoshi\n- Create general abstraction for object metadata - #4447 by @salwator\n- Add metadata to `Order` and `Fulfillment` models - #4513, #4866 by @szewczykmira\n- Migrate the tax calculations to plugins - #4497 by @korycins\n- Rewrite payment gateways using plugin architecture - #4669 by @salwator\n- Rewrite Stripe integration to use PaymentIntents API - #4606 by @salwator\n- Refactor password recovery system - #4617 by @fowczarek\n- Add functionality to sort products by their \"minimal variant price\" - #4416 by @derenio\n- Add voucher's \"once per customer\" feature - #4442 by @fowczarek\n- Add validations for minimum password length in settings - #4735 by @fowczarek\n- Add form to configure payments in the dashboard - #4807 by @szewczykmira\n- Change `unique_together` in `AttributeValue` - #4805 by @fowczarek\n- Change max length of SKU to 255 characters - #4811 by @lex111\n- Distinguish `OrderLine` product name and variant name - #4702 by @fowczarek\n- Fix updating order status after automatic fulfillment of digital products - #4709 by @korycins\n- Fix error when updating or creating a sale with missing required values - #4778 by @NyanKiyoshi\n- Fix error filtering pages by URL in the dashboard 1.0 - #4776 by @NyanKiyoshi\n- Fix display of the products tax rate in the details page of dashboard 1.0 - #4780 by @NyanKiyoshi\n- Fix adding the same product into a collection multiple times - #4518 by @NyanKiyoshi\n- Fix crash when placing an order when a customer happens to have the same address more than once - #4824 by @NyanKiyoshi\n- Fix time zone based tests - #4468 by @fowczarek\n- Fix serializing empty URLs as a string when creating menu items - #4616 by @maarcingebala\n- The invalid IP address in HTTP requests now fallback to the requester's IP address. - #4597 by @NyanKiyoshi\n- Fix product variant update with current attribute values - #4936 by @fowczarek\n- Update checkout last field and add auto now fields to save with update_fields parameter - #5177 by @IKarbowiak\n\n### Dashboard 2.0\n\n- Allow selecting the number of rows displayed in dashboard's list views - #4414 by @benekex2\n- Add ability to toggle visible columns in product list - #4608 by @dominik-zeglen\n- Add voucher settings - #4556 by @benekex2\n- Contrast improvements - #4508 by @benekex2\n- Display menu item form errors - #4551 by @dominik-zeglen\n- Do not allow random IDs to appear in snapshots - #4495 by @dominik-zeglen\n- Input UI changes - #4542 by @benekex2\n- Implement new menu design - #4476 by @benekex2\n- Refetch attribute list after closing modal - #4615 by @dominik-zeglen\n- Add config for Testcafe - #4553 by @dominik-zeglen\n- Fix product type taxes select - #4453 by @benekex2\n- Fix form reloading - #4467 by @dominik-zeglen\n- Fix voucher limit value when checkbox unchecked - #4456 by @benekex2\n- Fix searches and pickers - #4487 by @dominik-zeglen\n- Fix dashboard menu styles - #4491 by @benekex2\n- Fix menu responsiveness - #4511 by @benekex2\n- Fix loosing focus while typing in the product description field - #4549 by @dominik-zeglen\n- Fix MUI warnings - #4588 by @dominik-zeglen\n- Fix bulk action checkboxes - #4618 by @dominik-zeglen\n- Fix rendering user avatar when it's empty #4546 by @maarcingebala\n- Remove Dashboard 2.0 files form Saleor repository - #4631 by @dominik-zeglen\n- Fix CreateToken mutation to use NonNull on errors field #5415 by @gabmartinez\n\n### Other notable changes\n\n- Replace Pipenv with Poetry - #3894 by @michaljelonek\n- Upgrade `django-prices` to v2.1 - #4639 by @NyanKiyoshi\n- Disable reports from uWSGI about broken pipe and write errors from disconnected clients - #4596 by @NyanKiyoshi\n- Fix the random failures of `populatedb` trying to create users with an existing email - #4769 by @NyanKiyoshi\n- Enforce `pydocstyle` for Python docstrings over the project - #4562 by @NyanKiyoshi\n- Move Django Debug Toolbar to dev requirements - #4454 by @derenio\n- Change license for artwork to CC-BY 4.0\n- New translations:\n  - Greek\n\n## 2.8.0\n\n### Core\n\n- Avatax backend support - #4310 by @korycins\n- Add ability to store used payment sources in gateways (first implemented in Braintree) - #4195 by @salwator\n- Add ability to specify a minimal quantity of checkout items for a voucher - #4427 by @fowczarek\n- Change the type of start and end date fields from Date to DateTime - #4293 by @fowczarek\n- Revert the custom dynamic middlewares - #4452 by @NyanKiyoshi\n\n### Dashboard 2.0\n\n- UX improvements in Vouchers section - #4362 by @benekex2\n- Add company address configuration - #4432 by @benekex2\n- Require name when saving a custom list filter - #4269 by @benekex2\n- Use `esModuleInterop` flag in `tsconfig.json` to simplify imports - #4372 by @dominik-zeglen\n- Use hooks instead of a class component in forms - #4374 by @dominik-zeglen\n- Drop CSRF token header from API client - #4357 by @dominik-zeglen\n- Fix various bugs in the product section - #4429 by @dominik-zeglen\n\n### Other notable changes\n\n- Fix error when creating a checkout with voucher code - #4292 by @NyanKiyoshi\n- Fix error when users enter an invalid phone number in an address - #4404 by @NyanKiyoshi\n- Fix error when adding a note to an anonymous order - #4319 by @NyanKiyoshi\n- Fix gift card duplication error in the `populatedb` script - #4336 by @fowczarek\n- Fix vouchers apply once per order - #4339 by @fowczarek\n- Fix discount tests failing at random - #4401 by @korycins\n- Add `SPECIFIC_PRODUCT` type to `VoucherType` - #4344 by @fowczarek\n- New translations:\n  - Icelandic\n- Refactored the backend side of `checkoutCreate` to improve performances and prevent side effects over the user's checkout if the checkout creation was to fail. - #4367 by @NyanKiyoshi\n- Refactored the logic of cleaning the checkout shipping method over the API, so users do not lose the shipping method when updating their checkout. If the shipping method becomes invalid, it will be replaced by the cheapest available. - #4367 by @NyanKiyoshi & @szewczykmira\n- Refactored process of getting available shipping methods to make it easier to understand and prevent human-made errors. - #4367 by @NyanKiyoshi\n- Moved 3D secure option to Braintree plugin configuration and update config structure mechanism - #4751 by @salwator\n\n## 2.7.0\n\n### API\n\n- Create order only when payment is successful - #4154 by @NyanKiyoshi\n- Order Events containing order lines or fulfillment lines now return the line object in the GraphQL API - #4114 by @NyanKiyoshi\n- GraphQL now prints exceptions to stderr as well as returning them or not - #4148 by @NyanKiyoshi\n- Refactored API resolvers to static methods with root typing - #4155 by @NyanKiyoshi\n- Add phone validation in the GraphQL API to handle the library upgrade - #4156 by @NyanKiyoshi\n\n### Core\n\n- Add basic Gift Cards support in the backend - #4025 by @fowczarek\n- Add the ability to sort products within a collection - #4123 by @NyanKiyoshi\n- Implement customer events - #4094 by @NyanKiyoshi\n- Merge \"authorize\" and \"capture\" operations - #4098 by @korycins, @NyanKiyoshi\n- Separate the Django middlewares from the GraphQL API middlewares - #4102 by @NyanKiyoshi, #4186 by @cmiacz\n\n### Dashboard 2.0\n\n- Add navigation section - #4012 by @dominik-zeglen\n- Add filtering on product list - #4193 by @dominik-zeglen\n- Add filtering on orders list - #4237 by @dominik-zeglen\n- Change input style and improve Storybook stories - #4115 by @dominik-zeglen\n- Migrate deprecated fields in Dashboard 2.0 - #4121 by @benekex2\n- Add multiple select checkbox - #4133, #4146 by @benekex2\n- Rename menu items in Dashboard 2.0 - #4172 by @benekex2\n- Category delete modal improvements - #4171 by @benekex2\n- Close modals on click outside - #4236 - by @benekex2\n- Use date localize hook in translations - #4202 by @dominik-zeglen\n- Unify search API - #4200 by @dominik-zeglen\n- Default default PAGINATE_BY - #4238 by @dominik-zeglen\n- Create generic filtering interface - #4221 by @dominik-zeglen\n- Add default state to rich text editor = #4281 by @dominik-zeglen\n- Fix translation discard button - #4109 by @benekex2\n- Fix draftail options and icons - #4132 by @benekex2\n- Fix typos and messages in Dashboard 2.0 - #4168 by @benekex2\n- Fix view all orders button - #4173 by @benekex2\n- Fix visibility card view - #4198 by @benekex2\n- Fix query refetch after selecting an object in list - #4272 by @dominik-zeglen\n- Fix image selection in variants - #4270 by @benekex2\n- Fix collection search - #4267 by @dominik-zeglen\n- Fix quantity height in draft order edit - #4273 by @benekex2\n- Fix checkbox clickable area size - #4280 by @dominik-zeglen\n- Fix breaking object selection in menu section - #4282 by @dominik-zeglen\n- Reset selected items when tab switch - #4268 by @benekex2\n\n### Other notable changes\n\n- Add support for Google Cloud Storage - #4127 by @chetabahana\n- Adding a nonexistent variant to checkout no longer crashes - #4166 by @NyanKiyoshi\n- Disable storage of Celery results - #4169 by @NyanKiyoshi\n- Disable polling in Playground - #4188 by @maarcingebala\n- Cleanup code for updated function names and unused argument - #4090 by @jxltom\n- Users can now add multiple \"Add to Cart\" forms in a single page - #4165 by @NyanKiyoshi\n- Fix incorrect argument in `get_client_token` in Braintree integration - #4182 by @maarcingebala\n- Fix resolving attribute values when transforming them to HStore - #4161 by @maarcingebala\n- Fix wrong calculation of subtotal in cart page - #4145 by @korycins\n- Fix margin calculations when product/variant price is set to zero - #4170 by @MahmoudRizk\n- Fix applying discounts in checkout's subtotal calculation in API - #4192 by @maarcingebala\n- Fix GATEWAYS_ENUM to always contain all implemented payment gateways - #4108 by @koradon\n\n## 2.6.0\n\n### API\n\n- Add unified filtering interface in resolvers - #3952, #4078 by @korycins\n- Add mutations for bulk actions - #3935, #3954, #3967, #3969, #3970 by @akjanik\n- Add mutation for reordering menu items - #3958 by @NyanKiyoshi\n- Optimize queries for single nodes - #3968 @NyanKiyoshi\n- Refactor error handling in mutations #3891 by @maarcingebala & @akjanik\n- Specify mutation permissions through Meta classes - #3980 by @NyanKiyoshi\n- Unify pricing access in products and variants - #3948 by @NyanKiyoshi\n- Use only_fields instead of exclude_fields in type definitions - #3940 by @michaljelonek\n- Prefetch collections when getting sales of a bunch of products - #3961 by @NyanKiyoshi\n- Remove unnecessary dedents from GraphQL schema so new Playground can work - #4045 by @salwator\n- Restrict resolving payment by ID - #4009 @NyanKiyoshi\n- Require `checkoutId` for updating checkout's shipping and billing address - #4074 by @jxltom\n- Handle errors in `TokenVerify` mutation - #3981 by @fowczarek\n- Unify argument names in types and resolvers - #3942 by @NyanKiyoshi\n\n### Core\n\n- Use Black as the default code formatting tool - #3852 by @krzysztofwolski and @NyanKiyoshi\n- Dropped Python 3.5 support - #4028 by @korycins\n- Rename Cart to Checkout - #3963 by @michaljelonek\n- Use data classes to exchange data with payment gateways - #4028 by @korycins\n- Refactor order events - #4018 by @NyanKiyoshi\n\n### Dashboard 2.0\n\n- Add bulk actions - #3955 by @dominik-zeglen\n- Add user avatar management - #4030 by @benekex2\n- Add navigation drawer support on mobile devices - #3839 by @benekex2\n- Fix rendering validation errors in product form - #4024 by @benekex2\n- Move dialog windows to query string rather than router paths - #3953 by @dominik-zeglen\n- Update order events types - #4089 by @jxltom\n- Code cleanup by replacing render props with react hooks - #4010 by @dominik-zeglen\n\n### Other notable changes\n\n- Add setting to enable Django Debug Toolbar - #3983 by @koradon\n- Use newest GraphQL Playground - #3971 by @salwator\n- Ensure adding to quantities in the checkout is respecting the limits - #4005 by @NyanKiyoshi\n- Fix country area choices - #4008 by @fowczarek\n- Fix price_range_as_dict function - #3999 by @zodiacfireworks\n- Fix the product listing not showing in the voucher when there were products selected - #4062 by @NyanKiyoshi\n- Fix crash in Dashboard 1.0 when updating an order address's phone number - #4061 by @NyanKiyoshi\n- Reduce the time of tests execution by using dummy password hasher - #4083 by @korycins\n- Set up explicit **hash** function - #3979 by @akjanik\n- Unit tests use none as media root - #3975 by @korycins\n- Update file field styles with materializecss template filter - #3998 by @zodiacfireworks\n- New translations:\n  - Albanian\n  - Colombian Spanish\n  - Lithuanian\n\n## 2.5.0\n\n### API\n\n- Add query to fetch draft orders - #3809 by @michaljelonek\n- Add bulk delete mutations - #3838 by @michaljelonek\n- Add `languageCode` enum to API - #3819 by @michaljelonek, #3854 by @jxltom\n- Duplicate address instances in checkout mutations - #3866 by @pawelzar\n- Restrict access to `orders` query for unauthorized users - #3861 by @pawelzar\n- Support setting address as default in address mutations - #3787 by @jxltom\n- Fix phone number validation in GraphQL when country prefix not given - #3905 by @patrys\n- Report pretty stack traces in DEBUG mode - #3918 by @patrys\n\n### Core\n\n- Drop support for Django 2.1 and Django 1.11 (previous LTS) - #3929 by @patrys\n- Fulfillment of digital products - #3868 by @korycins\n- Introduce avatars for staff accounts - #3878 by @pawelzar\n- Refactor the account avatars path from a relative to absolute - #3938 by @NyanKiyoshi\n\n### Dashboard 2.0\n\n- Add translations section - #3884 by @dominik-zeglen\n- Add light/dark theme - #3856 by @dominik-zeglen\n- Add customer's address book view - #3826 by @dominik-zeglen\n- Add \"Add variant\" button on the variant details page = #3914 by @dominik-zeglen\n- Add back arrows in \"Configure\" subsections - #3917 by @dominik-zeglen\n- Display avatars in staff views - #3922 by @dominik-zeglen\n- Prevent user from changing his own status and permissions - #3922 by @dominik-zeglen\n- Fix crashing product create view - #3837, #3910 by @dominik-zeglen\n- Fix layout in staff members details page - #3857 by @dominik-zeglen\n- Fix unfocusing rich text editor - #3902 by @dominik-zeglen\n- Improve accessibility - #3856 by @dominik-zeglen\n\n### Other notable changes\n\n- Improve user and staff management in dashboard 1.0 - #3781 by @jxltom\n- Fix default product tax rate in Dashboard 1.0 - #3880 by @pawelzar\n- Fix logo in docs - #3928 by @michaljelonek\n- Fix name of logo file - #3867 by @jxltom\n- Fix variants for juices in example data - #3926 by @michaljelonek\n- Fix alignment of the cart dropdown on new bootstrap version - #3937 by @NyanKiyoshi\n- Refactor the account avatars path from a relative to absolute - #3938 by @NyanKiyoshi\n- New translations:\n  - Armenian\n  - Portuguese\n  - Swahili\n  - Thai\n\n## 2.4.0\n\n### API\n\n- Add model translations support in GraphQL API - #3789 by @michaljelonek\n- Add mutations to manage addresses for authenticated customers - #3772 by @Kwaidan00, @maarcingebala\n- Add mutation to apply vouchers in checkout - #3739 by @Kwaidan00\n- Add thumbnail field to `OrderLine` type - #3737 by @michaljelonek\n- Add a query to fetch order by token - #3740 by @michaljelonek\n- Add city choices and city area type to address validator API - #3788 by @jxltom\n- Fix access to unpublished objects in API - #3724 by @Kwaidan00\n- Fix bug where errors are not returned when creating fulfillment with a non-existent order line - #3777 by @jxltom\n- Fix `productCreate` mutation when no product type was provided - #3804 by @michaljelonek\n- Enable database search in products query - #3736 by @michaljelonek\n- Use authenticated user's email as default email in creating checkout - #3726 by @jxltom\n- Generate voucher code if it wasn't provided in mutation - #3717 by @Kwaidan00\n- Improve limitation of vouchers by country - #3707 by @michaljelonek\n- Only include canceled fulfillments for staff in fulfillment API - #3778 by @jxltom\n- Support setting address as when creating customer address #3782 by @jxltom\n- Fix generating slug from title - #3816 by @maarcingebala\n- Add `variant` field to `OrderLine` type - #3820 by @maarcingebala\n\n### Core\n\n- Add JSON fields to store rich-text content - #3756 by @michaljelonek\n- Add function to recalculate total order weight - #3755 by @Kwaidan00, @maarcingebala\n- Unify cart creation logic in API and Django views - #3761, #3790 by @maarcingebala\n- Unify payment creation logic in API and Django views - #3715 by @maarcingebala\n- Support partially charged and refunded payments - #3735 by @jxltom\n- Support partial fulfillment of ordered items - #3754 by @jxltom\n- Fix applying discounts when a sale has no end date - #3595 by @cprinos\n\n### Dashboard 2.0\n\n- Add \"Discounts\" section - #3654 by @dominik-zeglen\n- Add \"Pages\" section; introduce Draftail WYSIWYG editor - #3751 by @dominik-zeglen\n- Add \"Shipping Methods\" section - #3770 by @dominik-zeglen\n- Add support for date and datetime components - #3708 by @dominik-zeglen\n- Restyle app layout - #3811 by @dominik-zeglen\n\n### Other notable changes\n\n- Unify model field names related to models' public access - `publication_date` and `is_published` - #3706 by @michaljelonek\n- Improve filter orders by payment status - #3749 @jxltom\n- Refactor translations in emails - #3701 by @Kwaidan00\n- Use exact image versions in docker-compose - #3742 by @ashishnitinpatil\n- Sort order payment and history in descending order - #3747 by @jxltom\n- Disable style-loader in dev mode - #3720 by @jxltom\n- Add ordering to shipping method - #3806 by @michaljelonek\n- Add missing type definition for dashboard 2.0 - #3776 by @jxltom\n- Add header and footer for checkout success pages #3752 by @jxltom\n- Add instructions for using local assets in Docker - #3723 by @michaljelonek\n- Update S3 deployment documentation to include CORS configuration note - #3743 by @NyanKiyoshi\n- Fix missing migrations for is_published field of product and page model - #3757 by @jxltom\n- Fix problem with l10n in Braintree payment gateway template - #3691 by @Kwaidan00\n- Fix bug where payment is not filtered from active ones when creating payment - #3732 by @jxltom\n- Fix incorrect cart badge location - #3786 by @jxltom\n- Fix storefront styles after bootstrap is updated to 4.3.1 - #3753 by @jxltom\n- Fix logo size in different browser and devices with different sizes - #3722 by @jxltom\n- Rename dumpdata file `db.json` to `populatedb_data.json` - #3810 by @maarcingebala\n- Prefetch collections for product availability - #3813 by @michaljelonek\n- Bump django-graphql-jwt - #3814 by @michaljelonek\n- Fix generating slug from title - #3816 by @maarcingebala\n- New translations:\n  - Estonian\n  - Indonesian\n\n## 2.3.1\n\n- Fix access to private variant fields in API - #3773 by maarcingebala\n- Limit access of quantity and allocated quantity to staff in GraphQL API #3780 by @jxltom\n\n## 2.3.0\n\n### API\n\n- Return user's last checkout in the `User` type - #3578 by @fowczarek\n- Automatically assign checkout to the logged in user - #3587 by @fowczarek\n- Expose `chargeTaxesOnShipping` field in the `Shop` type - #3603 by @fowczarek\n- Expose list of enabled payment gateways - #3639 by @fowczarek\n- Validate uploaded files in a unified way - #3633 by @fowczarek\n- Add mutation to trigger fetching tax rates - #3622 by @fowczarek\n- Use USERNAME_FIELD instead of hard-code email field when resolving user - #3577 by @jxltom\n- Require variant and quantity fields in `CheckoutLineInput` type - #3592 by @jxltom\n- Preserve order of nodes in `get_nodes_or_error` function - #3632 by @jxltom\n- Add list mutations for `Voucher` and `Sale` models - #3669 by @michaljelonek\n- Use proper type for countries in `Voucher` type - #3664 by @michaljelonek\n- Require email in when creating checkout in API - #3667 by @michaljelonek\n- Unify returning errors in the `tokenCreate` mutation - #3666 by @michaljelonek\n- Use `Date` field in Sale/Voucher inputs - #3672 by @michaljelonek\n- Refactor checkout mutations - #3610 by @fowczarek\n- Refactor `clean_instance`, so it does not returns errors anymore - #3597 by @akjanik\n- Handle GraphqQL syntax errors - #3576 by @jxltom\n\n### Core\n\n- Refactor payments architecture - #3519 by @michaljelonek\n- Improve Docker and `docker-compose` configuration - #3657 by @michaljelonek\n- Allow setting payment status manually for dummy gateway in Storefront 1.0 - #3648 by @jxltom\n- Infer default transaction kind from operation type - #3646 by @jxltom\n- Get correct payment status for order without any payments - #3605 by @jxltom\n- Add default ordering by `id` for `CartLine` model - #3593 by @jxltom\n- Fix \"set password\" email sent to customer created in the dashboard - #3688 by @Kwaidan00\n\n### Dashboard 2.0\n\n- \ufe0fAdd taxes section - #3622 by @dominik-zeglen\n- Add drag'n'drop image upload - #3611 by @dominik-zeglen\n- Unify grid handling - #3520 by @dominik-zeglen\n- Add component generator - #3670 by @dominik-zeglen\n- Throw Typescript errors while snapshotting - #3611 by @dominik-zeglen\n- Simplify mutation's error checking - #3589 by @dominik-zeglen\n- Fix order cancelling - #3624 by @dominik-zeglen\n- Fix logo placement - #3602 by @dominik-zeglen\n\n### Other notable changes\n\n- Register Celery task for updating exchange rates - #3599 by @jxltom\n- Fix handling different attributes with the same slug - #3626 by @jxltom\n- Add missing migrations for tax rate choices - #3629 by @jxltom\n- Fix `TypeError` on calling `get_client_token` - #3660 by @michaljelonek\n- Make shipping required as default when creating product types - #3655 by @jxltom\n- Display payment status on customer's account page in Storefront 1.0 - #3637 by @jxltom\n- Make order fields sequence in Dashboard 1.0 same as in Dashboard 2.0 - #3606 by @jxltom\n- Fix returning products for homepage for the currently viewing user - #3598 by @jxltom\n- Allow filtering payments by status in Dashboard 1.0 - #3608 by @jxltom\n- Fix typo in the definition of order status - #3649 by @jxltom\n- Add margin for order notes section - #3650 by @jxltom\n- Fix logo position - #3609, #3616 by @jxltom\n- Storefront visual improvements - #3696 by @piotrgrundas\n- Fix product list price filter - #3697 by @Kwaidan00\n- Redirect to success page after successful payment - #3693 by @Kwaidan00\n\n## 2.2.0\n\n### API\n\n- Use `PermissionEnum` as input parameter type for `permissions` field - #3434 by @maarcingebala\n- Add \"authorize\" and \"charge\" mutations for payments - #3426 by @jxltom\n- Add alt text to product thumbnails and background images of collections and categories - #3429 by @fowczarek\n- Fix passing decimal arguments = #3457 by @fowczarek\n- Allow sorting products by the update date - #3470 by @jxltom\n- Validate and clear the shipping method in draft order mutations - #3472 by @fowczarek\n- Change tax rate field to choice field - #3478 by @fowczarek\n- Allow filtering attributes by collections - #3508 by @maarcingebala\n- Resolve to `None` when empty object ID was passed as mutation argument - #3497 by @maarcingebala\n- Change `errors` field type from [Error] to [Error!] - #3489 by @fowczarek\n- Support creating default variant for product types that don't use multiple variants - #3505 by @fowczarek\n- Validate SKU when creating a default variant - #3555 by @fowczarek\n- Extract enums to separate files - #3523 by @maarcingebala\n\n### Core\n\n- Add Stripe payment gateway - #3408 by @jxltom\n- Add `first_name` and `last_name` fields to the `User` model - #3101 by @fowczarek\n- Improve several payment validations - #3418 by @jxltom\n- Optimize payments related database queries - #3455 by @jxltom\n- Add publication date to collections - #3369 by @k-brk\n- Fix hard-coded site name in order PDFs - #3526 by @NyanKiyoshi\n- Update favicons to the new style - #3483 by @dominik-zeglen\n- Fix migrations for default currency - #3235 by @bykof\n- Remove Elasticsearch from `docker-compose.yml` - #3482 by @maarcingebala\n- Resort imports in tests - #3471 by @jxltom\n- Fix the no shipping orders payment crash on Stripe - #3550 by @NyanKiyoshi\n- Bump backend dependencies - #3557 by @maarcingebala. This PR removes security issue CVE-2019-3498 which was present in Django 2.1.4. Saleor however wasn't vulnerable to this issue as it doesn't use the affected `django.views.defaults.page_not_found()` view.\n- Generate random data using the default currency - #3512 by @stephenmoloney\n- New translations:\n  - Catalan\n  - Serbian\n\n### Dashboard 2.0\n\n- Restyle product selection dialogs - #3499 by @dominik-zeglen, @maarcingebala\n- Fix minor visual bugs in Dashboard 2.0 - #3433 by @dominik-zeglen\n- Display warning if order draft has missing data - #3431 by @dominik-zeglen\n- Add description field to collections - #3435 by @dominik-zeglen\n- Add query batching - #3443 by @dominik-zeglen\n- Use autocomplete fields in country selection - #3443 by @dominik-zeglen\n- Add alt text to categories and collections - #3461 by @dominik-zeglen\n- Use first and last name of a customer or staff member in UI - #3247 by @Bonifacy1, @dominik-zeglen\n- Show error page if an object was not found - #3463 by @dominik-zeglen\n- Fix simple product's inventory data saving bug - #3474 by @dominik-zeglen\n- Replace `thumbnailUrl` with `thumbnail { url }` - #3484 by @dominik-zeglen\n- Change \"Feature on Homepage\" switch behavior - #3481 by @dominik-zeglen\n- Expand payment section in order view - #3502 by @dominik-zeglen\n- Change TypeScript loader to speed up the build process - #3545 by @patrys\n\n### Bugfixes\n\n- Do not show `Pay For Order` if order is partly paid since partial payment is not supported - #3398 by @jxltom\n- Fix attribute filters in the products category view - #3535 by @fowczarek\n- Fix storybook dependencies conflict - #3544 by @dominik-zeglen\n\n## 2.1.0\n\n### API\n\n- Change selected connection fields to lists - #3307 by @fowczarek\n- Require pagination in connections - #3352 by @maarcingebala\n- Replace Graphene view with a custom one - #3263 by @patrys\n- Change `sortBy` parameter to use enum type - #3345 by @fowczarek\n- Add `me` query to fetch data of a logged-in user - #3202, #3316 by @fowczarek\n- Add `canFinalize` field to the Order type - #3356 by @fowczarek\n- Extract resolvers and mutations to separate files - #3248 by @fowczarek\n- Add VAT tax rates field to country - #3392 by @michaljelonek\n- Allow creating orders without users - #3396 by @fowczarek\n\n### Core\n\n- Add Razorpay payment gatway - #3205 by @NyanKiyoshi\n- Use standard tax rate as a default tax rate value - #3340 by @fowczarek\n- Add description field to the Collection model - #3275 by @fowczarek\n- Enforce the POST method on VAT rates fetching - #3337 by @NyanKiyoshi\n- Generate thumbnails for category/collection background images - #3270 by @NyanKiyoshi\n- Add warm-up support in product image creation mutation - #3276 by @NyanKiyoshi\n- Fix error in the `populatedb` script when running it not from the project root - #3272 by @NyanKiyoshi\n- Make Webpack rebuilds fast - #3290 by @patrys\n- Skip installing Chromium to make deployment faster - #3227 by @jxltom\n- Add default test runner - #3258 by @jxltom\n- Add Transifex client to Pipfile - #3321 by @jxltom\n- Remove additional pytest arguments in tox - #3338 by @jxltom\n- Remove test warnings - #3339 by @jxltom\n- Remove runtime warning when product has discount - #3310 by @jxltom\n- Remove `django-graphene-jwt` warnings - #3228 by @jxltom\n- Disable deprecated warnings - #3229 by @jxltom\n- Add `AWS_S3_ENDPOINT_URL` setting to support DigitalOcean spaces. - #3281 by @hairychris\n- Add `.gitattributes` file to hide diffs for generated files on Github - #3055 by @NyanKiyoshi\n- Add database sequence reset to `populatedb` - #3406 by @michaljelonek\n- Get authorized amount from succeeded auth transactions - #3417 by @jxltom\n- Resort imports by `isort` - #3412 by @jxltom\n\n### Dashboard 2.0\n\n- Add confirmation modal when leaving view with unsaved changes - #3375 by @dominik-zeglen\n- Add dialog loading and error states - #3359 by @dominik-zeglen\n- Split paths and urls - #3350 by @dominik-zeglen\n- Derive state from props in forms - #3360 by @dominik-zeglen\n- Apply debounce to autocomplete fields - #3351 by @dominik-zeglen\n- Use Apollo signatures - #3353 by @dominik-zeglen\n- Add order note field in the order details view - #3346 by @dominik-zeglen\n- Add app-wide progress bar - #3312 by @dominik-zeglen\n- Ensure that all queries are built on top of TypedQuery - #3309 by @dominik-zeglen\n- Close modal windows automatically - #3296 by @dominik-zeglen\n- Move URLs to separate files - #3295 by @dominik-zeglen\n- Add basic filters for products and orders list - #3237 by @Bonifacy1\n- Fetch default currency from API - #3280 by @dominik-zeglen\n- Add `displayName` property to components - #3238 by @Bonifacy1\n- Add window titles - #3279 by @dominik-zeglen\n- Add paginator component - #3265 by @dominik-zeglen\n- Update Material UI to 3.6 - #3387 by @patrys\n- Upgrade React, Apollo, Webpack and Babel - #3393 by @patrys\n- Add pagination for required connections - #3411 by @dominik-zeglen\n\n### Bugfixes\n\n- Fix language codes - #3311 by @jxltom\n- Fix resolving empty attributes list - #3293 by @maarcingebala\n- Fix range filters not being applied - #3385 by @michaljelonek\n- Remove timeout for updating image height - #3344 by @jxltom\n- Return error if checkout was not found - #3289 by @maarcingebala\n- Solve an auto-resize conflict between Materialize and medium-editor - #3367 by @adonig\n- Fix calls to `ngettext_lazy` - #3380 by @patrys\n- Filter preauthorized order from succeeded transactions - #3399 by @jxltom\n- Fix incorrect country code in fixtures - #3349 by @bingimar\n- Fix updating background image of a collection - #3362 by @fowczarek & @dominik-zeglen\n\n### Docs\n\n- Document settings related to generating thumbnails on demand - #3329 by @NyanKiyoshi\n- Improve documentation for Heroku deployment - #3170 by @raybesiga\n- Update documentation on Docker deployment - #3326 by @jxltom\n- Document payment gateway configuration - #3376 by @NyanKiyoshi\n\n## 2.0.0\n\n### API\n\n- Add mutation to delete a customer; add `isActive` field in `customerUpdate` mutation - #3177 by @maarcingebala\n- Add mutations to manage authorization keys - #3082 by @maarcingebala\n- Add queries for dashboard homepage - #3146 by @maarcingebala\n- Allows user to unset homepage collection - #3140 by @oldPadavan\n- Use enums as permission codes - #3095 by @the-bionic\n- Return absolute image URLs - #3182 by @maarcingebala\n- Add `backgroundImage` field to `CategoryInput` - #3153 by @oldPadavan\n- Add `dateJoined` and `lastLogin` fields in `User` type - #3169 by @maarcingebala\n- Separate `parent` input field from `CategoryInput` - #3150 by @akjanik\n- Remove duplicated field in Order type - #3180 by @maarcingebala\n- Handle empty `backgroundImage` field in API - #3159 by @maarcingebala\n- Generate name-based slug in collection mutations - #3145 by @akjanik\n- Remove products field from `collectionUpdate` mutation - #3141 by @oldPadavan\n- Change `items` field in `Menu` type from connection to list - #3032 by @oldPadavan\n- Make `Meta.description` required in `BaseMutation` - #3034 by @oldPadavan\n- Apply `textwrap.dedent` to GraphQL descriptions - #3167 by @fowczarek\n\n### Dashboard 2.0\n\n- Add collection management - #3135 by @dominik-zeglen\n- Add customer management - #3176 by @dominik-zeglen\n- Add homepage view - #3155, #3178 by @Bonifacy1 and @dominik-zeglen\n- Add product type management - #3052 by @dominik-zeglen\n- Add site settings management - #3071 by @dominik-zeglen\n- Escape node IDs in URLs - #3115 by @dominik-zeglen\n- Restyle categories section - #3072 by @Bonifacy1\n\n### Other\n\n- Change relation between `ProductType` and `Attribute` models - #3097 by @maarcingebala\n- Remove `quantity-allocated` generation in `populatedb` script - #3084 by @MartinSeibert\n- Handle `Money` serialization - #3131 by @Pacu2\n- Do not collect unnecessary static files - #3050 by @jxltom\n- Remove host mounted volume in `docker-compose` - #3091 by @tiangolo\n- Remove custom services names in `docker-compose` - #3092 by @tiangolo\n- Replace COUNTRIES with countries.countries - #3079 by @neeraj1909\n- Installing dev packages in docker since tests are needed - #3078 by @jxltom\n- Remove comparing string in address-form-panel template - #3074 by @tomcio1205\n- Move updating variant names to a Celery task - #3189 by @fowczarek\n\n### Bugfixes\n\n- Fix typo in `clean_input` method - #3100 by @the-bionic\n- Fix typo in `ShippingMethod` model - #3099 by @the-bionic\n- Remove duplicated variable declaration - #3094 by @the-bionic\n\n### Docs\n\n- Add createdb note to getting started for Windows - #3106 by @ajostergaard\n- Update docs on pipenv - #3045 by @jxltom\n", "from unittest.mock import MagicMock\n\nimport graphene\nimport pytest\nfrom django.contrib.auth.models import Group\nfrom django.core.files import File\n\nfrom .....account.models import User\nfrom ....tests.utils import get_graphql_content\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_query_staff_user(\n    staff_api_client,\n    address,\n    permission_manage_users,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n    permission_manage_staff,\n    count_queries,\n):\n    group = permission_group_manage_users\n    group.permissions.add(permission_manage_products)\n\n    staff_user = group.user_set.first()\n    staff_user.user_permissions.add(permission_manage_orders, permission_manage_staff)\n    staff_user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    staff_user.avatar = avatar_mock\n    staff_user.save()\n\n    query = \"\"\"\n        query User($id: ID!) {\n            user(id: $id) {\n                email\n                firstName\n                lastName\n                isStaff\n                isActive\n                addresses {\n                    id\n                    isDefaultShippingAddress\n                    isDefaultBillingAddress\n                }\n                orders {\n                    totalCount\n                }\n                dateJoined\n                lastLogin\n                defaultShippingAddress {\n                    firstName\n                    lastName\n                    companyName\n                    streetAddress1\n                    streetAddress2\n                    city\n                    cityArea\n                    postalCode\n                    countryArea\n                    phone\n                    country {\n                        code\n                    }\n                    isDefaultShippingAddress\n                    isDefaultBillingAddress\n                }\n                defaultBillingAddress {\n                    firstName\n                    lastName\n                    companyName\n                    streetAddress1\n                    streetAddress2\n                    city\n                    cityArea\n                    postalCode\n                    countryArea\n                    phone\n                    country {\n                        code\n                    }\n                    isDefaultShippingAddress\n                    isDefaultBillingAddress\n                }\n                avatar {\n                    url\n                }\n                userPermissions {\n                    code\n                    name\n                }\n                permissionGroups {\n                    name\n                    permissions {\n                        code\n                    }\n                }\n            }\n        }\n    \"\"\"\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(\n        query,\n        variables,\n        permissions=[permission_manage_staff, permission_manage_orders],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert data\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_staff_create(\n    staff_api_client,\n    staff_user,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_users,\n    count_queries,\n):\n    query = \"\"\"\n        mutation CreateStaff(\n                $email: String, $redirect_url: String, $add_groups: [ID!]\n            ) {\n            staffCreate(input: {email: $email, redirectUrl: $redirect_url,\n                    addGroups: $add_groups }) {\n                errors {\n                    field\n                    code\n                    permissions\n                    groups\n                }\n                user {\n                    id\n                    email\n                    isStaff\n                    isActive\n                    userPermissions {\n                        code\n                    }\n                    permissionGroups {\n                        name\n                        permissions {\n                            code\n                        }\n                    }\n                    avatar {\n                        url\n                    }\n                }\n            }\n        }\n    \"\"\"\n    group = permission_group_manage_users\n    staff_user.user_permissions.add(permission_manage_products, permission_manage_users)\n    email = \"api_user@example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": \"https://www.example.com\",\n        \"add_groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    staff_count = User.objects.filter(is_staff=True).count()\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n\n    assert User.objects.filter(is_staff=True).count() == staff_count + 1\n    assert data[\"user\"]\n    assert not data[\"errors\"]\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_staff_update_groups_and_permissions(\n    staff_api_client,\n    staff_users,\n    media_root,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n    count_queries,\n):\n    query = \"\"\"\n    mutation UpdateStaff(\n                $id: ID!, $input: StaffUpdateInput!) {\n            staffUpdate(\n                    id: $id,\n                    input: $input) {\n                errors {\n                    field\n                    code\n                    message\n                    permissions\n                    groups\n                }\n                user {\n                    userPermissions {\n                        code\n                    }\n                    permissionGroups {\n                        name\n                    }\n                    isActive\n                }\n            }\n        }\n    \"\"\"\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders and products\"),\n        ]\n    )\n    group1, group2, group3 = groups\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders, permission_manage_products)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1, staff_user2)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user2)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group2, group3]\n            ],\n            \"removeGroups\": [graphene.Node.to_global_id(\"Group\", group1.pk)],\n        },\n    }\n\n    staff_api_client.user.user_permissions.add(\n        permission_manage_users, permission_manage_orders, permission_manage_products\n    )\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert len(data[\"user\"][\"userPermissions\"]) == 3\n    assert {perm[\"code\"].lower() for perm in data[\"user\"][\"userPermissions\"]} == {\n        permission_manage_orders.codename,\n        permission_manage_products.codename,\n        permission_manage_staff.codename,\n    }\n    assert len(data[\"user\"][\"permissionGroups\"]) == 2\n    assert {group[\"name\"] for group in data[\"user\"][\"permissionGroups\"]} == {\n        group2.name,\n        group3.name,\n    }\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_delete_staff_members(\n    staff_api_client,\n    staff_users,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n    count_queries,\n):\n    \"\"\"Ensure user can delete users when all permissions will be manageable.\"\"\"\n    query = \"\"\"\n        mutation staffBulkDelete($ids: [ID]!) {\n            staffBulkDelete(ids: $ids) {\n                count\n                errors{\n                    code\n                    field\n                    permissions\n                    users\n                }\n            }\n        }\n    \"\"\"\n\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage users and orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders, permission_manage_users)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2, staff_user1, staff_user)\n    group3.user_set.add(staff_user1, staff_user)\n\n    staff_user.user_permissions.add(\n        permission_manage_users, permission_manage_orders, permission_manage_staff\n    )\n    variables = {\n        \"ids\": [\n            graphene.Node.to_global_id(\"User\", user.id)\n            for user in [staff_user1, staff_user2]\n        ]\n    }\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffBulkDelete\"]\n    errors = data[\"errors\"]\n\n    assert not errors\n    assert data[\"count\"] == 2\n    assert not User.objects.filter(\n        id__in=[user.id for user in [staff_user1, staff_user2]]\n    ).exists()\n\n\nCUSTOMERS_QUERY = \"\"\"\n    query accounts {\n        customers(first: 10) {\n            edges {\n                node {\n                    events { id }\n                    orders(first: 10) { edges { node { id } } }\n                    addresses { id }\n                    giftCards(first: 10) { edges { node { id } } }\n                    permissionGroups { id }\n                }\n            }\n        }\n    }\n\"\"\"\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_customers_query(\n    staff_api_client,\n    permission_manage_users,\n    permission_manage_orders,\n    users_for_customers_benchmarks,\n    count_queries,\n):\n    staff_api_client.user.user_permissions.set(\n        [permission_manage_users, permission_manage_orders]\n    )\n    content = get_graphql_content(staff_api_client.post_graphql(CUSTOMERS_QUERY))\n    assert content[\"data\"][\"customers\"] is not None\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_users_for_federation_query_count(\n    customer_user,\n    customer_user2,\n    staff_api_client,\n    permission_manage_staff,\n    permission_manage_users,\n    django_assert_num_queries,\n    count_queries,\n):\n    query = \"\"\"\n        query GetUserInFederation($representations: [_Any]) {\n            _entities(representations: $representations) {\n                __typename\n                ... on User {\n                    id\n                    email\n                }\n            }\n        }\n    \"\"\"\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": graphene.Node.to_global_id(\"User\", customer_user.pk),\n            },\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    with django_assert_num_queries(4):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_staff, permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 2\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": graphene.Node.to_global_id(\"User\", customer_user.pk),\n            },\n            {\n                \"__typename\": \"User\",\n                \"id\": graphene.Node.to_global_id(\"User\", customer_user2.pk),\n            },\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user2.email,\n            },\n        ],\n    }\n\n    with django_assert_num_queries(4):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_staff, permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 4\n\n\n@pytest.mark.django_db\n@pytest.mark.count_queries(autouse=False)\ndef test_addresses_for_federation_query_count(\n    address,\n    customer_user,\n    customer_user2,\n    staff_api_client,\n    permission_manage_users,\n    django_assert_num_queries,\n    count_queries,\n):\n    address2 = address.get_copy()\n    customer_user.addresses.add(address)\n    customer_user2.addresses.add(address2)\n\n    query = \"\"\"\n        query GetAddressInFederation($representations: [_Any]) {\n            _entities(representations: $representations) {\n                __typename\n                ... on Address {\n                    id\n                    city\n                }\n            }\n        }\n    \"\"\"\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": graphene.Node.to_global_id(\"Address\", address.pk),\n            },\n        ],\n    }\n\n    with django_assert_num_queries(3):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 1\n\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": graphene.Node.to_global_id(\"Address\", address.pk),\n            },\n            {\n                \"__typename\": \"Address\",\n                \"id\": graphene.Node.to_global_id(\"Address\", address2.pk),\n            },\n        ],\n    }\n\n    with django_assert_num_queries(3):\n        response = staff_api_client.post_graphql(\n            query,\n            variables,\n            permissions=[permission_manage_users],\n            check_no_permissions=False,\n        )\n        content = get_graphql_content(response)\n        assert len(content[\"data\"][\"_entities\"]) == 2\n", "import datetime\nimport os\nimport re\nimport uuid\nfrom collections import defaultdict\nfrom datetime import timedelta\nfrom unittest.mock import ANY, MagicMock, Mock, patch\nfrom urllib.parse import urlencode\n\nimport graphene\nimport pytest\nfrom django.contrib.auth.models import Group\nfrom django.contrib.auth.tokens import default_token_generator\nfrom django.core.exceptions import ValidationError\nfrom django.core.files import File\nfrom django.test import override_settings\nfrom django.utils import timezone\nfrom freezegun import freeze_time\n\nfrom ....account import events as account_events\nfrom ....account.error_codes import AccountErrorCode\nfrom ....account.models import Address, User\nfrom ....account.notifications import get_default_user_payload\nfrom ....account.search import (\n    generate_address_search_document_value,\n    generate_user_fields_search_document_value,\n    prepare_user_search_document_value,\n)\nfrom ....checkout import AddressType\nfrom ....core.jwt import create_token\nfrom ....core.notify_events import NotifyEventType\nfrom ....core.permissions import AccountPermissions, OrderPermissions\nfrom ....core.tokens import account_delete_token_generator\nfrom ....core.utils.url import prepare_url\nfrom ....order import OrderStatus\nfrom ....order.models import FulfillmentStatus, Order\nfrom ....product.tests.utils import create_image\nfrom ...core.utils import str_to_enum\nfrom ...tests.utils import (\n    assert_graphql_error_with_message,\n    assert_no_permission,\n    get_graphql_content,\n    get_graphql_content_from_response,\n    get_multipart_request_body,\n)\nfrom ..mutations.base import INVALID_TOKEN\nfrom ..mutations.staff import CustomerDelete, StaffDelete, StaffUpdate, UserDelete\nfrom ..tests.utils import convert_dict_keys_to_camel_case\n\n\n@pytest.fixture\ndef query_customer_with_filter():\n    query = \"\"\"\n    query ($filter: CustomerFilterInput!, ) {\n        customers(first: 5, filter: $filter) {\n            totalCount\n            edges {\n                node {\n                    id\n                    lastName\n                    firstName\n                }\n            }\n        }\n    }\n    \"\"\"\n    return query\n\n\n@pytest.fixture\ndef query_staff_users_with_filter():\n    query = \"\"\"\n    query ($filter: StaffUserInput!, ) {\n        staffUsers(first: 5, filter: $filter) {\n            totalCount\n            edges {\n                node {\n                    id\n                    lastName\n                    firstName\n                }\n            }\n        }\n    }\n    \"\"\"\n    return query\n\n\nFULL_USER_QUERY = \"\"\"\n    query User($id: ID!) {\n        user(id: $id) {\n            email\n            firstName\n            lastName\n            isStaff\n            isActive\n            addresses {\n                id\n                isDefaultShippingAddress\n                isDefaultBillingAddress\n            }\n            orders(first: 10) {\n                totalCount\n                edges {\n                    node {\n                        id\n                    }\n                }\n            }\n            languageCode\n            dateJoined\n            lastLogin\n            defaultShippingAddress {\n                firstName\n                lastName\n                companyName\n                streetAddress1\n                streetAddress2\n                city\n                cityArea\n                postalCode\n                countryArea\n                phone\n                country {\n                    code\n                }\n                isDefaultShippingAddress\n                isDefaultBillingAddress\n            }\n            defaultBillingAddress {\n                firstName\n                lastName\n                companyName\n                streetAddress1\n                streetAddress2\n                city\n                cityArea\n                postalCode\n                countryArea\n                phone\n                country {\n                    code\n                }\n                isDefaultShippingAddress\n                isDefaultBillingAddress\n            }\n            avatar {\n                url\n            }\n            userPermissions {\n                code\n                sourcePermissionGroups(userId: $id) {\n                    name\n                }\n            }\n            permissionGroups {\n                name\n                permissions {\n                    code\n                }\n            }\n            editableGroups {\n                name\n            }\n            giftCards(first: 10) {\n                edges {\n                    node {\n                        id\n                    }\n                }\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_query_customer_user(\n    staff_api_client,\n    customer_user,\n    gift_card_used,\n    gift_card_expiry_date,\n    address,\n    permission_manage_users,\n    permission_manage_orders,\n    media_root,\n    settings,\n):\n    user = customer_user\n    user.default_shipping_address.country = \"US\"\n    user.default_shipping_address.save()\n    user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    Group.objects.create(name=\"empty group\")\n\n    query = FULL_USER_QUERY\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    staff_api_client.user.user_permissions.add(\n        permission_manage_users, permission_manage_orders\n    )\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert data[\"email\"] == user.email\n    assert data[\"firstName\"] == user.first_name\n    assert data[\"lastName\"] == user.last_name\n    assert data[\"isStaff\"] == user.is_staff\n    assert data[\"isActive\"] == user.is_active\n    assert data[\"orders\"][\"totalCount\"] == user.orders.count()\n    assert data[\"avatar\"][\"url\"]\n    assert data[\"languageCode\"] == settings.LANGUAGE_CODE.upper()\n    assert len(data[\"editableGroups\"]) == 0\n\n    assert len(data[\"addresses\"]) == user.addresses.count()\n    for address in data[\"addresses\"]:\n        if address[\"isDefaultShippingAddress\"]:\n            address_id = graphene.Node.to_global_id(\n                \"Address\", user.default_shipping_address.id\n            )\n            assert address[\"id\"] == address_id\n        if address[\"isDefaultBillingAddress\"]:\n            address_id = graphene.Node.to_global_id(\n                \"Address\", user.default_billing_address.id\n            )\n            assert address[\"id\"] == address_id\n\n    address = data[\"defaultShippingAddress\"]\n    user_address = user.default_shipping_address\n    assert address[\"firstName\"] == user_address.first_name\n    assert address[\"lastName\"] == user_address.last_name\n    assert address[\"companyName\"] == user_address.company_name\n    assert address[\"streetAddress1\"] == user_address.street_address_1\n    assert address[\"streetAddress2\"] == user_address.street_address_2\n    assert address[\"city\"] == user_address.city\n    assert address[\"cityArea\"] == user_address.city_area\n    assert address[\"postalCode\"] == user_address.postal_code\n    assert address[\"country\"][\"code\"] == user_address.country.code\n    assert address[\"countryArea\"] == user_address.country_area\n    assert address[\"phone\"] == user_address.phone.as_e164\n    assert address[\"isDefaultShippingAddress\"] is None\n    assert address[\"isDefaultBillingAddress\"] is None\n\n    address = data[\"defaultBillingAddress\"]\n    user_address = user.default_billing_address\n    assert address[\"firstName\"] == user_address.first_name\n    assert address[\"lastName\"] == user_address.last_name\n    assert address[\"companyName\"] == user_address.company_name\n    assert address[\"streetAddress1\"] == user_address.street_address_1\n    assert address[\"streetAddress2\"] == user_address.street_address_2\n    assert address[\"city\"] == user_address.city\n    assert address[\"cityArea\"] == user_address.city_area\n    assert address[\"postalCode\"] == user_address.postal_code\n    assert address[\"country\"][\"code\"] == user_address.country.code\n    assert address[\"countryArea\"] == user_address.country_area\n    assert address[\"phone\"] == user_address.phone.as_e164\n    assert address[\"isDefaultShippingAddress\"] is None\n    assert address[\"isDefaultBillingAddress\"] is None\n    assert len(data[\"giftCards\"]) == 1\n    assert data[\"giftCards\"][\"edges\"][0][\"node\"][\"id\"] == graphene.Node.to_global_id(\n        \"GiftCard\", gift_card_used.pk\n    )\n\n\ndef test_query_customer_user_with_orders(\n    staff_api_client,\n    customer_user,\n    order_list,\n    permission_manage_users,\n    permission_manage_orders,\n):\n    # given\n    query = FULL_USER_QUERY\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = customer_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = customer_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = customer_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": id}\n\n    # when\n    response = staff_api_client.post_graphql(\n        query,\n        variables,\n        permissions=[permission_manage_users, permission_manage_orders],\n    )\n\n    # then\n    content = get_graphql_content(response)\n    user = content[\"data\"][\"user\"]\n    assert {order[\"node\"][\"id\"] for order in user[\"orders\"][\"edges\"]} == {\n        graphene.Node.to_global_id(\"Order\", order.pk) for order in order_list\n    }\n\n\ndef test_query_customer_user_with_orders_no_manage_orders_perm(\n    staff_api_client,\n    customer_user,\n    order_list,\n    permission_manage_users,\n):\n    # given\n    query = FULL_USER_QUERY\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = customer_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = customer_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = customer_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": id}\n\n    # when\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # then\n    assert_no_permission(response)\n\n\ndef test_query_customer_user_app(\n    app_api_client,\n    customer_user,\n    address,\n    permission_manage_users,\n    permission_manage_staff,\n    permission_manage_orders,\n    media_root,\n    app,\n):\n    user = customer_user\n    user.default_shipping_address.country = \"US\"\n    user.default_shipping_address.save()\n    user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    Group.objects.create(name=\"empty group\")\n\n    query = FULL_USER_QUERY\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    app.permissions.add(\n        permission_manage_staff, permission_manage_users, permission_manage_orders\n    )\n    response = app_api_client.post_graphql(query, variables)\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert data[\"email\"] == user.email\n\n\ndef test_query_customer_user_app_no_permission(\n    app_api_client,\n    customer_user,\n    address,\n    permission_manage_users,\n    permission_manage_staff,\n    media_root,\n    app,\n):\n    user = customer_user\n    user.default_shipping_address.country = \"US\"\n    user.default_shipping_address.save()\n    user.addresses.add(address.get_copy())\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    Group.objects.create(name=\"empty group\")\n\n    query = FULL_USER_QUERY\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    app.permissions.add(permission_manage_staff)\n    response = app_api_client.post_graphql(query, variables)\n\n    assert_no_permission(response)\n\n\ndef test_query_customer_user_with_orders_by_app_no_manage_orders_perm(\n    app_api_client,\n    customer_user,\n    order_list,\n    permission_manage_users,\n):\n    # given\n    query = FULL_USER_QUERY\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = customer_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = customer_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = customer_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": id}\n\n    # when\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # then\n    assert_no_permission(response)\n\n\ndef test_query_staff_user(\n    staff_api_client,\n    staff_user,\n    address,\n    permission_manage_users,\n    media_root,\n    permission_manage_orders,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_menus,\n):\n    staff_user.user_permissions.add(permission_manage_orders, permission_manage_staff)\n\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"another user group\"),\n            Group(name=\"another group\"),\n            Group(name=\"empty group\"),\n        ]\n    )\n    group1, group2, group3, group4 = groups\n\n    group1.permissions.add(permission_manage_users, permission_manage_products)\n\n    # user groups\n    staff_user.groups.add(group1, group2)\n\n    # another group (not user group) with permission_manage_users\n    group3.permissions.add(permission_manage_users, permission_manage_menus)\n\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image2.jpg\"\n    staff_user.avatar = avatar_mock\n    staff_user.save()\n\n    query = FULL_USER_QUERY\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n\n    assert data[\"email\"] == staff_user.email\n    assert data[\"firstName\"] == staff_user.first_name\n    assert data[\"lastName\"] == staff_user.last_name\n    assert data[\"isStaff\"] == staff_user.is_staff\n    assert data[\"isActive\"] == staff_user.is_active\n    assert data[\"orders\"][\"totalCount\"] == staff_user.orders.count()\n    assert data[\"avatar\"][\"url\"]\n\n    assert len(data[\"permissionGroups\"]) == 2\n    assert {group_data[\"name\"] for group_data in data[\"permissionGroups\"]} == {\n        group1.name,\n        group2.name,\n    }\n    assert len(data[\"userPermissions\"]) == 4\n    assert len(data[\"editableGroups\"]) == Group.objects.count() - 1\n    assert {data_group[\"name\"] for data_group in data[\"editableGroups\"]} == {\n        group1.name,\n        group2.name,\n        group4.name,\n    }\n\n    formated_user_permissions_result = [\n        {\n            \"code\": perm[\"code\"].lower(),\n            \"groups\": {group[\"name\"] for group in perm[\"sourcePermissionGroups\"]},\n        }\n        for perm in data[\"userPermissions\"]\n    ]\n    all_permissions = group1.permissions.all() | staff_user.user_permissions.all()\n    for perm in all_permissions:\n        source_groups = {group.name for group in perm.group_set.filter(user=staff_user)}\n        expected_data = {\"code\": perm.codename, \"groups\": source_groups}\n        assert expected_data in formated_user_permissions_result\n\n\ndef test_query_staff_user_with_order_and_without_manage_orders_perm(\n    staff_api_client,\n    staff_user,\n    order_list,\n    permission_manage_staff,\n):\n    # given\n    staff_user.user_permissions.add(permission_manage_staff)\n\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = staff_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = staff_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = staff_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    query = FULL_USER_QUERY\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n\n    assert data[\"email\"] == staff_user.email\n    assert data[\"orders\"][\"totalCount\"] == 2\n    assert {node[\"node\"][\"id\"] for node in data[\"orders\"][\"edges\"]} == {\n        graphene.Node.to_global_id(\"Order\", order.pk)\n        for order in [order_unfulfilled, order_unconfirmed]\n    }\n\n\ndef test_query_staff_user_with_orders_and_manage_orders_perm(\n    staff_api_client,\n    staff_user,\n    order_list,\n    permission_manage_staff,\n    permission_manage_orders,\n):\n    # given\n    staff_user.user_permissions.add(permission_manage_staff, permission_manage_orders)\n\n    order_unfulfilled = order_list[0]\n    order_unfulfilled.user = staff_user\n\n    order_unconfirmed = order_list[1]\n    order_unconfirmed.status = OrderStatus.UNCONFIRMED\n    order_unconfirmed.user = staff_user\n\n    order_draft = order_list[2]\n    order_draft.status = OrderStatus.DRAFT\n    order_draft.user = staff_user\n\n    Order.objects.bulk_update(\n        [order_unconfirmed, order_draft, order_unfulfilled], [\"user\", \"status\"]\n    )\n\n    query = FULL_USER_QUERY\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": user_id}\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n\n    assert data[\"email\"] == staff_user.email\n    assert data[\"orders\"][\"totalCount\"] == 3\n    assert {node[\"node\"][\"id\"] for node in data[\"orders\"][\"edges\"]} == {\n        graphene.Node.to_global_id(\"Order\", order.pk)\n        for order in [order_unfulfilled, order_unconfirmed, order_draft]\n    }\n\n\nUSER_QUERY = \"\"\"\n    query User($id: ID $email: String) {\n        user(id: $id, email: $email) {\n            id\n            email\n        }\n    }\n\"\"\"\n\n\ndef test_query_user_by_email_address(\n    user_api_client, customer_user, permission_manage_users\n):\n    email = customer_user.email\n    variables = {\"email\": email}\n    response = user_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert customer_user.email == data[\"email\"]\n\n\ndef test_query_user_by_id_and_email(\n    user_api_client, customer_user, permission_manage_users\n):\n    email = customer_user.email\n    id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\n        \"id\": id,\n        \"email\": email,\n    }\n    response = user_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    assert_graphql_error_with_message(\n        response, \"Argument 'id' cannot be combined with 'email'\"\n    )\n\n\ndef test_customer_can_not_see_other_users_data(user_api_client, staff_user):\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id}\n    response = user_api_client.post_graphql(USER_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_user_query_anonymous_user(api_client):\n    variables = {\"id\": \"\"}\n    response = api_client.post_graphql(USER_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_user_query_permission_manage_users_get_customer(\n    staff_api_client, customer_user, permission_manage_users\n):\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\"id\": customer_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert customer_user.email == data[\"email\"]\n\n\ndef test_user_query_as_app(app_api_client, customer_user, permission_manage_users):\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\"id\": customer_id}\n    response = app_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert customer_user.email == data[\"email\"]\n\n\ndef test_user_query_permission_manage_users_get_staff(\n    staff_api_client, staff_user, permission_manage_users\n):\n    staff_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": staff_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    assert not content[\"data\"][\"user\"]\n\n\ndef test_user_query_permission_manage_staff_get_customer(\n    staff_api_client, customer_user, permission_manage_staff\n):\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\"id\": customer_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    assert not content[\"data\"][\"user\"]\n\n\ndef test_user_query_permission_manage_staff_get_staff(\n    staff_api_client, staff_user, permission_manage_staff\n):\n    staff_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\"id\": staff_id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"user\"]\n    assert staff_user.email == data[\"email\"]\n\n\n@pytest.mark.parametrize(\"id\", [\"'\", \"abc\"])\ndef test_user_query_invalid_id(\n    id, staff_api_client, customer_user, permission_manage_users\n):\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n\n    content = get_graphql_content_from_response(response)\n    assert len(content[\"errors\"]) == 1\n    assert content[\"errors\"][0][\"message\"] == f\"Couldn't resolve id: {id}.\"\n    assert content[\"data\"][\"user\"] is None\n\n\ndef test_user_query_object_with_given_id_does_not_exist(\n    staff_api_client, permission_manage_users\n):\n    id = graphene.Node.to_global_id(\"User\", -1)\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"user\"] is None\n\n\ndef test_user_query_object_with_invalid_object_type(\n    staff_api_client, customer_user, permission_manage_users\n):\n    id = graphene.Node.to_global_id(\"Order\", customer_user.pk)\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(\n        USER_QUERY, variables, permissions=[permission_manage_users]\n    )\n\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"user\"] is None\n\n\ndef test_query_customers(staff_api_client, user_api_client, permission_manage_users):\n    query = \"\"\"\n    query Users {\n        customers(first: 20) {\n            totalCount\n            edges {\n                node {\n                    isStaff\n                }\n            }\n        }\n    }\n    \"\"\"\n    variables = {}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert users\n    assert all([not user[\"node\"][\"isStaff\"] for user in users])\n\n    # check permissions\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_query_staff(\n    staff_api_client, user_api_client, staff_user, admin_user, permission_manage_staff\n):\n    query = \"\"\"\n    {\n        staffUsers(first: 20) {\n            edges {\n                node {\n                    email\n                    isStaff\n                }\n            }\n        }\n    }\n    \"\"\"\n    variables = {}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUsers\"][\"edges\"]\n    assert len(data) == 2\n    staff_emails = [user[\"node\"][\"email\"] for user in data]\n    assert sorted(staff_emails) == [admin_user.email, staff_user.email]\n    assert all([user[\"node\"][\"isStaff\"] for user in data])\n\n    # check permissions\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_who_can_see_user(\n    staff_user, customer_user, staff_api_client, permission_manage_users\n):\n    query = \"\"\"\n    query Users {\n        customers {\n            totalCount\n        }\n    }\n    \"\"\"\n\n    # Random person (even staff) can't see users data without permissions\n    ID = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": ID}\n    response = staff_api_client.post_graphql(USER_QUERY, variables)\n    assert_no_permission(response)\n\n    response = staff_api_client.post_graphql(query)\n    assert_no_permission(response)\n\n    # Add permission and ensure staff can see user(s)\n    staff_user.user_permissions.add(permission_manage_users)\n    response = staff_api_client.post_graphql(USER_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"user\"][\"email\"] == customer_user.email\n\n    response = staff_api_client.post_graphql(query)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"customers\"][\"totalCount\"] == 1\n\n\nME_QUERY = \"\"\"\n    query Me {\n        me {\n            id\n            email\n            checkout {\n                token\n            }\n            userPermissions {\n                code\n                name\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_me_query(user_api_client):\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert data[\"email\"] == user_api_client.user.email\n\n\ndef test_me_user_permissions_query(\n    user_api_client, permission_manage_users, permission_group_manage_users\n):\n    user = user_api_client.user\n    user.user_permissions.add(permission_manage_users)\n    user.groups.add(permission_group_manage_users)\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    user_permissions = content[\"data\"][\"me\"][\"userPermissions\"]\n\n    assert len(user_permissions) == 1\n    assert user_permissions[0][\"code\"] == permission_manage_users.codename.upper()\n\n\ndef test_me_query_anonymous_client(api_client):\n    response = api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"me\"] is None\n\n\ndef test_me_query_customer_can_not_see_note(\n    staff_user, staff_api_client, permission_manage_users\n):\n    query = \"\"\"\n    query Me {\n        me {\n            id\n            email\n            note\n        }\n    }\n    \"\"\"\n    # Random person (even staff) can't see own note without permissions\n    response = staff_api_client.post_graphql(query)\n    assert_no_permission(response)\n\n    # Add permission and ensure staff can see own note\n    response = staff_api_client.post_graphql(\n        query, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert data[\"email\"] == staff_api_client.user.email\n    assert data[\"note\"] == staff_api_client.user.note\n\n\ndef test_me_query_checkout(user_api_client, checkout):\n    user = user_api_client.user\n    checkout.user = user\n    checkout.save()\n\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert data[\"checkout\"][\"token\"] == str(checkout.token)\n\n\ndef test_me_query_checkout_with_inactive_channel(user_api_client, checkout):\n    user = user_api_client.user\n    channel = checkout.channel\n    channel.is_active = False\n    channel.save()\n    checkout.user = user\n    checkout.save()\n\n    response = user_api_client.post_graphql(ME_QUERY)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert not data[\"checkout\"]\n\n\nQUERY_ME_CHECKOUT_TOKENS = \"\"\"\nquery getCheckoutTokens($channel: String) {\n  me {\n    checkoutTokens(channel: $channel)\n  }\n}\n\"\"\"\n\n\ndef test_me_checkout_tokens_without_channel_param(\n    user_api_client, checkouts_assigned_to_customer\n):\n    # given\n    checkouts = checkouts_assigned_to_customer\n\n    # when\n    response = user_api_client.post_graphql(QUERY_ME_CHECKOUT_TOKENS)\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert len(data[\"checkoutTokens\"]) == len(checkouts)\n    for checkout in checkouts:\n        assert str(checkout.token) in data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_without_channel_param_inactive_channel(\n    user_api_client, channel_PLN, checkouts_assigned_to_customer\n):\n    # given\n    channel_PLN.is_active = False\n    channel_PLN.save()\n    checkouts = checkouts_assigned_to_customer\n\n    # when\n    response = user_api_client.post_graphql(QUERY_ME_CHECKOUT_TOKENS)\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert str(checkouts[0].token) in data[\"checkoutTokens\"]\n    assert not str(checkouts[1].token) in data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_with_channel(\n    user_api_client, channel_USD, checkouts_assigned_to_customer\n):\n    # given\n    checkouts = checkouts_assigned_to_customer\n\n    # when\n    response = user_api_client.post_graphql(\n        QUERY_ME_CHECKOUT_TOKENS, {\"channel\": channel_USD.slug}\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert str(checkouts[0].token) in data[\"checkoutTokens\"]\n    assert not str(checkouts[1].token) in data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_with_inactive_channel(\n    user_api_client, channel_USD, checkouts_assigned_to_customer\n):\n    # given\n    channel_USD.is_active = False\n    channel_USD.save()\n\n    # when\n    response = user_api_client.post_graphql(\n        QUERY_ME_CHECKOUT_TOKENS, {\"channel\": channel_USD.slug}\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert not data[\"checkoutTokens\"]\n\n\ndef test_me_checkout_tokens_with_not_existing_channel(\n    user_api_client, checkouts_assigned_to_customer\n):\n    # given\n\n    # when\n    response = user_api_client.post_graphql(\n        QUERY_ME_CHECKOUT_TOKENS, {\"channel\": \"Not-existing\"}\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"me\"]\n    assert not data[\"checkoutTokens\"]\n\n\ndef test_me_with_cancelled_fulfillments(\n    user_api_client, fulfilled_order_with_cancelled_fulfillment\n):\n    query = \"\"\"\n    query Me {\n        me {\n            orders (first: 1) {\n                edges {\n                    node {\n                        id\n                        fulfillments {\n                            status\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \"\"\"\n    response = user_api_client.post_graphql(query)\n    content = get_graphql_content(response)\n    order_id = graphene.Node.to_global_id(\n        \"Order\", fulfilled_order_with_cancelled_fulfillment.id\n    )\n    data = content[\"data\"][\"me\"]\n    order = data[\"orders\"][\"edges\"][0][\"node\"]\n    assert order[\"id\"] == order_id\n    fulfillments = order[\"fulfillments\"]\n    assert len(fulfillments) == 1\n    assert fulfillments[0][\"status\"] == FulfillmentStatus.FULFILLED.upper()\n\n\ndef test_user_with_cancelled_fulfillments(\n    staff_api_client,\n    customer_user,\n    permission_manage_users,\n    permission_manage_orders,\n    fulfilled_order_with_cancelled_fulfillment,\n):\n    query = \"\"\"\n    query User($id: ID!) {\n        user(id: $id) {\n            orders (first: 1) {\n                edges {\n                    node {\n                        id\n                        fulfillments {\n                            status\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \"\"\"\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"id\": user_id}\n    staff_api_client.user.user_permissions.add(\n        permission_manage_users, permission_manage_orders\n    )\n    response = staff_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    order_id = graphene.Node.to_global_id(\n        \"Order\", fulfilled_order_with_cancelled_fulfillment.id\n    )\n    data = content[\"data\"][\"user\"]\n    order = data[\"orders\"][\"edges\"][0][\"node\"]\n    assert order[\"id\"] == order_id\n    fulfillments = order[\"fulfillments\"]\n    assert len(fulfillments) == 2\n    assert fulfillments[0][\"status\"] == FulfillmentStatus.FULFILLED.upper()\n    assert fulfillments[1][\"status\"] == FulfillmentStatus.CANCELED.upper()\n\n\nACCOUNT_REGISTER_MUTATION = \"\"\"\n    mutation RegisterAccount(\n        $password: String!,\n        $email: String!,\n        $firstName: String,\n        $lastName: String,\n        $redirectUrl: String,\n        $languageCode: LanguageCodeEnum\n        $metadata: [MetadataInput!],\n        $channel: String\n    ) {\n        accountRegister(\n            input: {\n                password: $password,\n                email: $email,\n                firstName: $firstName,\n                lastName: $lastName,\n                redirectUrl: $redirectUrl,\n                languageCode: $languageCode,\n                metadata: $metadata,\n                channel: $channel\n            }\n        ) {\n            errors {\n                field\n                message\n                code\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\n@override_settings(\n    ENABLE_ACCOUNT_CONFIRMATION_BY_EMAIL=True, ALLOWED_CLIENT_HOSTS=[\"localhost\"]\n)\n@patch(\"saleor.account.notifications.default_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_register(\n    mocked_notify,\n    mocked_generator,\n    api_client,\n    channel_PLN,\n    order,\n):\n    mocked_generator.return_value = \"token\"\n    email = \"customer@example.com\"\n\n    redirect_url = \"http://localhost:3000\"\n    variables = {\n        \"email\": email,\n        \"password\": \"Password\",\n        \"redirectUrl\": redirect_url,\n        \"firstName\": \"saleor\",\n        \"lastName\": \"rocks\",\n        \"languageCode\": \"PL\",\n        \"metadata\": [{\"key\": \"meta\", \"value\": \"data\"}],\n        \"channel\": channel_PLN.slug,\n    }\n    query = ACCOUNT_REGISTER_MUTATION\n    mutation_name = \"accountRegister\"\n\n    response = api_client.post_graphql(query, variables)\n\n    new_user = User.objects.get(email=email)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    params = urlencode({\"email\": email, \"token\": \"token\"})\n    confirm_url = prepare_url(params, redirect_url)\n\n    expected_payload = {\n        \"user\": get_default_user_payload(new_user),\n        \"token\": \"token\",\n        \"confirm_url\": confirm_url,\n        \"recipient_email\": new_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n    assert new_user.metadata == {\"meta\": \"data\"}\n    assert new_user.language_code == \"pl\"\n    assert new_user.first_name == variables[\"firstName\"]\n    assert new_user.last_name == variables[\"lastName\"]\n    assert new_user.search_document == generate_user_fields_search_document_value(\n        new_user\n    )\n    assert not data[\"errors\"]\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_CONFIRMATION,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n    response = api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert data[\"errors\"]\n    assert data[\"errors\"][0][\"field\"] == \"email\"\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.UNIQUE.name\n\n    customer_creation_event = account_events.CustomerEvent.objects.get()\n    assert customer_creation_event.type == account_events.CustomerEvents.ACCOUNT_CREATED\n    assert customer_creation_event.user == new_user\n\n\n@override_settings(ENABLE_ACCOUNT_CONFIRMATION_BY_EMAIL=False)\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_register_disabled_email_confirmation(mocked_notify, api_client):\n    email = \"customer@example.com\"\n    variables = {\"email\": email, \"password\": \"Password\"}\n    response = api_client.post_graphql(ACCOUNT_REGISTER_MUTATION, variables)\n    errors = response.json()[\"data\"][\"accountRegister\"][\"errors\"]\n\n    assert errors == []\n    created_user = User.objects.get()\n    expected_payload = get_default_user_payload(created_user)\n    expected_payload[\"token\"] = \"token\"\n    expected_payload[\"redirect_url\"] = \"http://localhost:3000\"\n    mocked_notify.assert_not_called()\n\n\n@override_settings(ENABLE_ACCOUNT_CONFIRMATION_BY_EMAIL=True)\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_register_no_redirect_url(mocked_notify, api_client):\n    variables = {\"email\": \"customer@example.com\", \"password\": \"Password\"}\n    response = api_client.post_graphql(ACCOUNT_REGISTER_MUTATION, variables)\n    errors = response.json()[\"data\"][\"accountRegister\"][\"errors\"]\n    assert \"redirectUrl\" in map(lambda error: error[\"field\"], errors)\n    mocked_notify.assert_not_called()\n\n\nCUSTOMER_CREATE_MUTATION = \"\"\"\n    mutation CreateCustomer(\n        $email: String, $firstName: String, $lastName: String, $channel: String\n        $note: String, $billing: AddressInput, $shipping: AddressInput,\n        $redirect_url: String, $languageCode: LanguageCodeEnum) {\n        customerCreate(input: {\n            email: $email,\n            firstName: $firstName,\n            lastName: $lastName,\n            note: $note,\n            defaultShippingAddress: $shipping,\n            defaultBillingAddress: $billing,\n            redirectUrl: $redirect_url,\n            languageCode: $languageCode,\n            channel: $channel,\n        }) {\n            errors {\n                field\n                code\n                message\n            }\n            user {\n                id\n                defaultBillingAddress {\n                    id\n                }\n                defaultShippingAddress {\n                    id\n                }\n                languageCode\n                email\n                firstName\n                lastName\n                isActive\n                isStaff\n                note\n            }\n        }\n    }\n\"\"\"\n\n\n@patch(\"saleor.account.notifications.default_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_create(\n    mocked_notify,\n    mocked_generator,\n    staff_api_client,\n    address,\n    permission_manage_users,\n    channel_PLN,\n):\n    mocked_generator.return_value = \"token\"\n    email = \"api_user@example.com\"\n    first_name = \"api_first_name\"\n    last_name = \"api_last_name\"\n    note = \"Test user\"\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": email,\n        \"firstName\": first_name,\n        \"lastName\": last_name,\n        \"note\": note,\n        \"shipping\": address_data,\n        \"billing\": address_data,\n        \"redirect_url\": redirect_url,\n        \"languageCode\": \"PL\",\n        \"channel\": channel_PLN.slug,\n    }\n\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n\n    new_customer = User.objects.get(email=email)\n\n    shipping_address, billing_address = (\n        new_customer.default_shipping_address,\n        new_customer.default_billing_address,\n    )\n    assert shipping_address == address\n    assert billing_address == address\n    assert shipping_address.pk != billing_address.pk\n\n    data = content[\"data\"][\"customerCreate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"email\"] == email\n    assert data[\"user\"][\"firstName\"] == first_name\n    assert data[\"user\"][\"lastName\"] == last_name\n    assert data[\"user\"][\"note\"] == note\n    assert data[\"user\"][\"languageCode\"] == \"PL\"\n    assert not data[\"user\"][\"isStaff\"]\n    assert data[\"user\"][\"isActive\"]\n\n    new_user = User.objects.get(email=email)\n    assert (\n        generate_user_fields_search_document_value(new_user) in new_user.search_document\n    )\n    assert generate_address_search_document_value(address) in new_user.search_document\n    params = urlencode({\"email\": new_user.email, \"token\": \"token\"})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(new_user),\n        \"token\": \"token\",\n        \"password_set_url\": password_set_url,\n        \"recipient_email\": new_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_CUSTOMER_PASSWORD,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n    assert set([shipping_address, billing_address]) == set(new_user.addresses.all())\n    customer_creation_event = account_events.CustomerEvent.objects.get()\n    assert customer_creation_event.type == account_events.CustomerEvents.ACCOUNT_CREATED\n    assert customer_creation_event.user == new_customer\n\n\n@patch(\"saleor.account.notifications.default_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_customer_create_send_password_with_url(\n    mocked_notify,\n    mocked_generator,\n    staff_api_client,\n    permission_manage_users,\n    channel_PLN,\n):\n    mocked_generator.return_value = \"token\"\n    email = \"api_user@example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": \"https://www.example.com\",\n        \"channel\": channel_PLN.slug,\n    }\n\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert not data[\"errors\"]\n\n    new_customer = User.objects.get(email=email)\n    assert new_customer\n    redirect_url = \"https://www.example.com\"\n    params = urlencode({\"email\": email, \"token\": \"token\"})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(new_customer),\n        \"password_set_url\": password_set_url,\n        \"token\": \"token\",\n        \"recipient_email\": new_customer.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_CUSTOMER_PASSWORD,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\ndef test_customer_create_without_send_password(\n    staff_api_client, permission_manage_users\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email}\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert not data[\"errors\"]\n    User.objects.get(email=email)\n\n\ndef test_customer_create_with_invalid_url(staff_api_client, permission_manage_users):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"invalid\"}\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"message\": ANY,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\ndef test_customer_create_with_not_allowed_url(\n    staff_api_client, permission_manage_users\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"https://www.fake.com\"}\n    response = staff_api_client.post_graphql(\n        CUSTOMER_CREATE_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"message\": ANY,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\ndef test_customer_update(\n    staff_api_client, staff_user, customer_user, address, permission_manage_users\n):\n    query = \"\"\"\n    mutation UpdateCustomer(\n            $id: ID!, $firstName: String, $lastName: String,\n            $isActive: Boolean, $note: String, $billing: AddressInput,\n            $shipping: AddressInput, $languageCode: LanguageCodeEnum) {\n        customerUpdate(id: $id, input: {\n            isActive: $isActive,\n            firstName: $firstName,\n            lastName: $lastName,\n            note: $note,\n            defaultBillingAddress: $billing\n            defaultShippingAddress: $shipping,\n            languageCode: $languageCode\n        }) {\n            errors {\n                field\n                message\n            }\n            user {\n                id\n                firstName\n                lastName\n                defaultBillingAddress {\n                    id\n                }\n                defaultShippingAddress {\n                    id\n                }\n                languageCode\n                isActive\n                note\n            }\n        }\n    }\n    \"\"\"\n\n    # this test requires addresses to be set and checks whether new address\n    # instances weren't created, but the existing ones got updated\n    assert customer_user.default_billing_address\n    assert customer_user.default_shipping_address\n    billing_address_pk = customer_user.default_billing_address.pk\n    shipping_address_pk = customer_user.default_shipping_address.pk\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    first_name = \"new_first_name\"\n    last_name = \"new_last_name\"\n    note = \"Test update note\"\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": first_name,\n        \"lastName\": last_name,\n        \"isActive\": False,\n        \"note\": note,\n        \"billing\": address_data,\n        \"shipping\": address_data,\n        \"languageCode\": \"PL\",\n    }\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n\n    customer = User.objects.get(email=customer_user.email)\n\n    # check that existing instances are updated\n    shipping_address, billing_address = (\n        customer.default_shipping_address,\n        customer.default_billing_address,\n    )\n    assert billing_address.pk == billing_address_pk\n    assert shipping_address.pk == shipping_address_pk\n\n    assert billing_address.street_address_1 == new_street_address\n    assert shipping_address.street_address_1 == new_street_address\n\n    data = content[\"data\"][\"customerUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"firstName\"] == first_name\n    assert data[\"user\"][\"lastName\"] == last_name\n    assert data[\"user\"][\"note\"] == note\n    assert data[\"user\"][\"languageCode\"] == \"PL\"\n    assert not data[\"user\"][\"isActive\"]\n\n    # The name was changed, an event should have been triggered\n    name_changed_event = account_events.CustomerEvent.objects.get()\n    assert name_changed_event.type == account_events.CustomerEvents.NAME_ASSIGNED\n    assert name_changed_event.user.pk == staff_user.pk\n    assert name_changed_event.parameters == {\"message\": customer.get_full_name()}\n    customer_user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(billing_address)\n        in customer_user.search_document\n    )\n    assert (\n        generate_address_search_document_value(shipping_address)\n        in customer_user.search_document\n    )\n\n\nUPDATE_CUSTOMER_EMAIL_MUTATION = \"\"\"\n    mutation UpdateCustomer(\n            $id: ID!, $firstName: String, $lastName: String, $email: String) {\n        customerUpdate(id: $id, input: {\n            firstName: $firstName,\n            lastName: $lastName,\n            email: $email\n        }) {\n            errors {\n                field\n                message\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_customer_update_generates_event_when_changing_email(\n    staff_api_client, staff_user, customer_user, address, permission_manage_users\n):\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": \"mirumee@example.com\",\n    }\n    staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # The email was changed, an event should have been triggered\n    email_changed_event = account_events.CustomerEvent.objects.get()\n    assert email_changed_event.type == account_events.CustomerEvents.EMAIL_ASSIGNED\n    assert email_changed_event.user.pk == staff_user.pk\n    assert email_changed_event.parameters == {\"message\": \"mirumee@example.com\"}\n\n\ndef test_customer_update_without_any_changes_generates_no_event(\n    staff_api_client, customer_user, address, permission_manage_users\n):\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": customer_user.email,\n    }\n    staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # No event should have been generated\n    assert not account_events.CustomerEvent.objects.exists()\n\n\ndef test_customer_update_generates_event_when_changing_email_by_app(\n    app_api_client, staff_user, customer_user, address, permission_manage_users\n):\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": \"mirumee@example.com\",\n    }\n    app_api_client.post_graphql(query, variables, permissions=[permission_manage_users])\n\n    # The email was changed, an event should have been triggered\n    email_changed_event = account_events.CustomerEvent.objects.get()\n    assert email_changed_event.type == account_events.CustomerEvents.EMAIL_ASSIGNED\n    assert email_changed_event.user is None\n    assert email_changed_event.parameters == {\"message\": \"mirumee@example.com\"}\n\n\ndef test_customer_update_assign_gift_cards_and_orders(\n    staff_api_client,\n    staff_user,\n    customer_user,\n    address,\n    gift_card,\n    order,\n    permission_manage_users,\n):\n    # given\n    query = UPDATE_CUSTOMER_EMAIL_MUTATION\n\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    address_data = convert_dict_keys_to_camel_case(address.as_data())\n\n    new_street_address = \"Updated street address\"\n    address_data[\"streetAddress1\"] = new_street_address\n    new_email = \"mirumee@example.com\"\n\n    gift_card.created_by = None\n    gift_card.created_by_email = new_email\n    gift_card.save(update_fields=[\"created_by\", \"created_by_email\"])\n\n    order.user = None\n    order.user_email = new_email\n    order.save(update_fields=[\"user_email\", \"user\"])\n\n    variables = {\n        \"id\": user_id,\n        \"firstName\": customer_user.first_name,\n        \"lastName\": customer_user.last_name,\n        \"email\": new_email,\n    }\n\n    # when\n    staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n\n    # then\n    email_changed_event = account_events.CustomerEvent.objects.get()\n    assert email_changed_event.type == account_events.CustomerEvents.EMAIL_ASSIGNED\n    gift_card.refresh_from_db()\n    customer_user.refresh_from_db()\n    assert gift_card.created_by == customer_user\n    assert gift_card.created_by_email == customer_user.email\n    order.refresh_from_db()\n    assert order.user == customer_user\n\n\nACCOUNT_UPDATE_QUERY = \"\"\"\n    mutation accountUpdate(\n        $billing: AddressInput\n        $shipping: AddressInput\n        $firstName: String,\n        $lastName: String\n        $languageCode: LanguageCodeEnum\n    ) {\n        accountUpdate(\n          input: {\n            defaultBillingAddress: $billing,\n            defaultShippingAddress: $shipping,\n            firstName: $firstName,\n            lastName: $lastName,\n            languageCode: $languageCode\n        }) {\n            errors {\n                field\n                code\n                message\n                addressType\n            }\n            user {\n                firstName\n                lastName\n                email\n                defaultBillingAddress {\n                    id\n                }\n                defaultShippingAddress {\n                    id\n                }\n                languageCode\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_logged_customer_updates_language_code(user_api_client):\n    language_code = \"PL\"\n    user = user_api_client.user\n    assert user.language_code != language_code\n    variables = {\"languageCode\": language_code}\n\n    response = user_api_client.post_graphql(ACCOUNT_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountUpdate\"]\n\n    assert not data[\"errors\"]\n    assert data[\"user\"][\"languageCode\"] == language_code\n    user.refresh_from_db()\n    assert user.language_code == language_code.lower()\n    assert user.search_document\n\n\ndef test_logged_customer_update_names(user_api_client):\n    first_name = \"first\"\n    last_name = \"last\"\n    user = user_api_client.user\n    assert user.first_name != first_name\n    assert user.last_name != last_name\n\n    variables = {\"firstName\": first_name, \"lastName\": last_name}\n    response = user_api_client.post_graphql(ACCOUNT_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountUpdate\"]\n\n    user.refresh_from_db()\n    assert not data[\"errors\"]\n    assert user.first_name == first_name\n    assert user.last_name == last_name\n\n\ndef test_logged_customer_update_addresses(user_api_client, graphql_address_data):\n    # this test requires addresses to be set and checks whether new address\n    # instances weren't created, but the existing ones got updated\n    user = user_api_client.user\n    new_first_name = graphql_address_data[\"firstName\"]\n    assert user.default_billing_address\n    assert user.default_shipping_address\n    assert user.default_billing_address.first_name != new_first_name\n    assert user.default_shipping_address.first_name != new_first_name\n\n    query = ACCOUNT_UPDATE_QUERY\n    mutation_name = \"accountUpdate\"\n    variables = {\"billing\": graphql_address_data, \"shipping\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    # check that existing instances are updated\n    billing_address_pk = user.default_billing_address.pk\n    shipping_address_pk = user.default_shipping_address.pk\n    user = User.objects.get(email=user.email)\n    assert user.default_billing_address.pk == billing_address_pk\n    assert user.default_shipping_address.pk == shipping_address_pk\n\n    assert user.default_billing_address.first_name == new_first_name\n    assert user.default_shipping_address.first_name == new_first_name\n    assert user.search_document\n\n\ndef test_logged_customer_update_addresses_invalid_shipping_address(\n    user_api_client, graphql_address_data\n):\n    shipping_address = graphql_address_data.copy()\n    del shipping_address[\"country\"]\n\n    query = ACCOUNT_UPDATE_QUERY\n    mutation_name = \"accountUpdate\"\n    variables = {\"billing\": graphql_address_data, \"shipping\": shipping_address}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert len(data[\"errors\"]) == 1\n    errors = data[\"errors\"]\n    assert errors[0][\"field\"] == \"country\"\n    assert errors[0][\"code\"] == AccountErrorCode.REQUIRED.name\n    assert errors[0][\"addressType\"] == AddressType.SHIPPING.upper()\n\n\ndef test_logged_customer_update_addresses_invalid_billing_address(\n    user_api_client, graphql_address_data\n):\n    billing_address = graphql_address_data.copy()\n    del billing_address[\"country\"]\n\n    query = ACCOUNT_UPDATE_QUERY\n    mutation_name = \"accountUpdate\"\n    variables = {\"billing\": billing_address, \"shipping\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert len(data[\"errors\"]) == 1\n    errors = data[\"errors\"]\n    assert errors[0][\"field\"] == \"country\"\n    assert errors[0][\"code\"] == AccountErrorCode.REQUIRED.name\n    assert errors[0][\"addressType\"] == AddressType.BILLING.upper()\n\n\ndef test_logged_customer_update_anonymous_user(api_client):\n    query = ACCOUNT_UPDATE_QUERY\n    response = api_client.post_graphql(query, {})\n    assert_no_permission(response)\n\n\nACCOUNT_REQUEST_DELETION_MUTATION = \"\"\"\n    mutation accountRequestDeletion($redirectUrl: String!, $channel: String) {\n        accountRequestDeletion(redirectUrl: $redirectUrl, channel: $channel) {\n            errors {\n                field\n                code\n                message\n            }\n        }\n    }\n\"\"\"\n\n\n@patch(\"saleor.account.notifications.account_delete_token_generator.make_token\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion(\n    mocked_notify, mocked_token, user_api_client, channel_PLN\n):\n    mocked_token.return_value = \"token\"\n    user = user_api_client.user\n    redirect_url = \"https://www.example.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n    params = urlencode({\"token\": \"token\"})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": \"token\",\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_token_validation(\n    mocked_notify, user_api_client, channel_PLN\n):\n    user = user_api_client.user\n    token = account_delete_token_generator.make_token(user)\n    redirect_url = \"https://www.example.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n    params = urlencode({\"token\": token})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": token,\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_anonymous_user(mocked_notify, api_client):\n    variables = {\"redirectUrl\": \"https://www.example.com\"}\n    response = api_client.post_graphql(ACCOUNT_REQUEST_DELETION_MUTATION, variables)\n    assert_no_permission(response)\n    mocked_notify.assert_not_called()\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_storefront_hosts_not_allowed(\n    mocked_notify, user_api_client\n):\n    variables = {\"redirectUrl\": \"https://www.fake.com\"}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"message\": ANY,\n    }\n    mocked_notify.assert_not_called()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_all_storefront_hosts_allowed(\n    mocked_notify, user_api_client, settings, channel_PLN\n):\n    user = user_api_client.user\n    user.last_login = timezone.now()\n    user.save(update_fields=[\"last_login\"])\n\n    token = account_delete_token_generator.make_token(user)\n    settings.ALLOWED_CLIENT_HOSTS = [\"*\"]\n    redirect_url = \"https://www.test.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n\n    params = urlencode({\"token\": token})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": token,\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_request_deletion_subdomain(\n    mocked_notify, user_api_client, settings, channel_PLN\n):\n    user = user_api_client.user\n    token = account_delete_token_generator.make_token(user)\n    settings.ALLOWED_CLIENT_HOSTS = [\".example.com\"]\n    redirect_url = \"https://sub.example.com\"\n    variables = {\"redirectUrl\": redirect_url, \"channel\": channel_PLN.slug}\n    response = user_api_client.post_graphql(\n        ACCOUNT_REQUEST_DELETION_MUTATION, variables\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountRequestDeletion\"]\n    assert not data[\"errors\"]\n    params = urlencode({\"token\": token})\n    delete_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(user),\n        \"delete_url\": delete_url,\n        \"token\": token,\n        \"recipient_email\": user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_DELETE,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\nACCOUNT_DELETE_MUTATION = \"\"\"\n    mutation AccountDelete($token: String!){\n        accountDelete(token: $token){\n            errors{\n                field\n                message\n            }\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete(user_api_client):\n    user = user_api_client.user\n    user.last_login = timezone.now()\n    user.save(update_fields=[\"last_login\"])\n    token = account_delete_token_generator.make_token(user)\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert not data[\"errors\"]\n    assert not User.objects.filter(pk=user.id).exists()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete_user_never_log_in(user_api_client):\n    user = user_api_client.user\n    token = account_delete_token_generator.make_token(user)\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert not data[\"errors\"]\n    assert not User.objects.filter(pk=user.id).exists()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete_log_out_after_deletion_request(user_api_client):\n    user = user_api_client.user\n    user.last_login = timezone.now()\n    user.save(update_fields=[\"last_login\"])\n\n    token = account_delete_token_generator.make_token(user)\n\n    # simulate re-login\n    user.last_login = timezone.now() + datetime.timedelta(hours=1)\n    user.save(update_fields=[\"last_login\"])\n\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert not data[\"errors\"]\n    assert not User.objects.filter(pk=user.id).exists()\n\n\ndef test_account_delete_invalid_token(user_api_client):\n    user = user_api_client.user\n    variables = {\"token\": \"invalid\"}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"message\"] == \"Invalid or expired token.\"\n    assert User.objects.filter(pk=user.id).exists()\n\n\ndef test_account_delete_anonymous_user(api_client):\n    variables = {\"token\": \"invalid\"}\n\n    response = api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    assert_no_permission(response)\n\n\ndef test_account_delete_staff_user(staff_api_client):\n    user = staff_api_client.user\n    variables = {\"token\": \"invalid\"}\n\n    response = staff_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"message\"] == \"Cannot delete a staff account.\"\n    assert User.objects.filter(pk=user.id).exists()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_account_delete_other_customer_token(user_api_client):\n    user = user_api_client.user\n    other_user = User.objects.create(email=\"temp@example.com\")\n    token = account_delete_token_generator.make_token(other_user)\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(ACCOUNT_DELETE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountDelete\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"message\"] == \"Invalid or expired token.\"\n    assert User.objects.filter(pk=user.id).exists()\n    assert User.objects.filter(pk=other_user.id).exists()\n\n\nCUSTOMER_DELETE_MUTATION = \"\"\"\n    mutation CustomerDelete($id: ID!) {\n        customerDelete(id: $id){\n            errors {\n                field\n                message\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\n@patch(\"saleor.account.signals.delete_versatile_image\")\n@patch(\"saleor.graphql.account.utils.account_events.customer_deleted_event\")\ndef test_customer_delete(\n    mocked_deletion_event,\n    delete_versatile_image_mock,\n    staff_api_client,\n    staff_user,\n    customer_user,\n    image,\n    permission_manage_users,\n    media_root,\n):\n    \"\"\"Ensure deleting a customer actually deletes the customer and creates proper\n    related events\"\"\"\n\n    query = CUSTOMER_DELETE_MUTATION\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    customer_user.avatar = image\n    customer_user.save(update_fields=[\"avatar\"])\n    variables = {\"id\": customer_id}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerDelete\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"id\"] == customer_id\n\n    # Ensure the customer was properly deleted\n    # and any related event was properly triggered\n    mocked_deletion_event.assert_called_once_with(\n        staff_user=staff_user, app=None, deleted_count=1\n    )\n    delete_versatile_image_mock.assert_called_once_with(customer_user.avatar)\n\n\n@patch(\"saleor.account.signals.delete_versatile_image\")\n@patch(\"saleor.graphql.account.utils.account_events.customer_deleted_event\")\ndef test_customer_delete_by_app(\n    mocked_deletion_event,\n    delete_versatile_image_mock,\n    app_api_client,\n    app,\n    customer_user,\n    image,\n    permission_manage_users,\n    media_root,\n):\n    \"\"\"Ensure deleting a customer actually deletes the customer and creates proper\n    related events\"\"\"\n\n    query = CUSTOMER_DELETE_MUTATION\n    customer_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    customer_user.avatar = image\n    customer_user.save(update_fields=[\"avatar\"])\n    variables = {\"id\": customer_id}\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"customerDelete\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"id\"] == customer_id\n\n    # Ensure the customer was properly deleted\n    # and any related event was properly triggered\n    assert mocked_deletion_event.call_count == 1\n    args, kwargs = mocked_deletion_event.call_args\n    assert kwargs[\"deleted_count\"] == 1\n    assert kwargs[\"staff_user\"].is_anonymous\n    assert kwargs[\"app\"] == app\n    delete_versatile_image_mock.assert_called_once_with(customer_user.avatar)\n\n\ndef test_customer_delete_errors(customer_user, admin_user, staff_user):\n    info = Mock(context=Mock(user=admin_user))\n    with pytest.raises(ValidationError) as e:\n        CustomerDelete.clean_instance(info, staff_user)\n\n    msg = \"Cannot delete a staff account.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n    # should not raise any errors\n    CustomerDelete.clean_instance(info, customer_user)\n\n\nSTAFF_CREATE_MUTATION = \"\"\"\n    mutation CreateStaff(\n            $email: String, $redirect_url: String, $add_groups: [ID!]\n        ) {\n        staffCreate(input: {email: $email, redirectUrl: $redirect_url,\n            addGroups: $add_groups}\n        ) {\n            errors {\n                field\n                code\n                permissions\n                groups\n            }\n            user {\n                id\n                email\n                isStaff\n                isActive\n                userPermissions {\n                    code\n                }\n                permissionGroups {\n                    name\n                    permissions {\n                        code\n                    }\n                }\n                avatar {\n                    url\n                }\n            }\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_staff_create(\n    mocked_notify,\n    staff_api_client,\n    staff_user,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_users,\n    channel_PLN,\n):\n    group = permission_group_manage_users\n    group.permissions.add(permission_manage_products)\n    staff_user.user_permissions.add(permission_manage_products, permission_manage_users)\n    email = \"api_user@example.com\"\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": redirect_url,\n        \"add_groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"email\"] == email\n    assert data[\"user\"][\"isStaff\"]\n    assert data[\"user\"][\"isActive\"]\n\n    expected_perms = {\n        permission_manage_products.codename,\n        permission_manage_users.codename,\n    }\n    permissions = data[\"user\"][\"userPermissions\"]\n    assert {perm[\"code\"].lower() for perm in permissions} == expected_perms\n\n    staff_user = User.objects.get(email=email)\n\n    assert staff_user.is_staff\n    assert staff_user.search_document == f\"{email}\\n\".lower()\n\n    groups = data[\"user\"][\"permissionGroups\"]\n    assert len(groups) == 1\n    assert {perm[\"code\"].lower() for perm in groups[0][\"permissions\"]} == expected_perms\n\n    token = default_token_generator.make_token(staff_user)\n    params = urlencode({\"email\": email, \"token\": token})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_user),\n        \"password_set_url\": password_set_url,\n        \"token\": token,\n        \"recipient_email\": staff_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_STAFF_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\ndef test_staff_create_app_no_permission(\n    app_api_client,\n    staff_user,\n    media_root,\n    permission_group_manage_users,\n    permission_manage_products,\n    permission_manage_staff,\n    permission_manage_users,\n):\n    group = permission_group_manage_users\n    group.permissions.add(permission_manage_products)\n    staff_user.user_permissions.add(permission_manage_products, permission_manage_users)\n    email = \"api_user@example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": \"https://www.example.com\",\n        \"add_groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    response = app_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_staff_create_out_of_scope_group(\n    mocked_notify,\n    staff_api_client,\n    superuser_api_client,\n    media_root,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_group_manage_users,\n    channel_PLN,\n):\n    \"\"\"Ensure user can't create staff with groups which are out of user scope.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    group = permission_group_manage_users\n    group2 = Group.objects.create(name=\"second group\")\n    group2.permissions.add(permission_manage_staff)\n    email = \"api_user@example.com\"\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": email,\n        \"redirect_url\": redirect_url,\n        \"add_groups\": [\n            graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group, group2]\n        ],\n    }\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    errors = data[\"errors\"]\n    assert not data[\"user\"]\n    assert len(errors) == 1\n\n    expected_error = {\n        \"field\": \"addGroups\",\n        \"code\": AccountErrorCode.OUT_OF_SCOPE_GROUP.name,\n        \"permissions\": None,\n        \"groups\": [graphene.Node.to_global_id(\"Group\", group.pk)],\n    }\n\n    assert errors[0] == expected_error\n\n    mocked_notify.assert_not_called()\n\n    # for superuser\n    response = superuser_api_client.post_graphql(STAFF_CREATE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"email\"] == email\n    assert data[\"user\"][\"isStaff\"]\n    assert data[\"user\"][\"isActive\"]\n    expected_perms = {\n        permission_manage_staff.codename,\n        permission_manage_users.codename,\n    }\n    permissions = data[\"user\"][\"userPermissions\"]\n    assert {perm[\"code\"].lower() for perm in permissions} == expected_perms\n\n    staff_user = User.objects.get(email=email)\n\n    assert staff_user.is_staff\n\n    expected_groups = [\n        {\n            \"name\": group.name,\n            \"permissions\": [{\"code\": permission_manage_users.codename.upper()}],\n        },\n        {\n            \"name\": group2.name,\n            \"permissions\": [{\"code\": permission_manage_staff.codename.upper()}],\n        },\n    ]\n    groups = data[\"user\"][\"permissionGroups\"]\n    assert len(groups) == 2\n    for group in expected_groups:\n        assert group in groups\n    token = default_token_generator.make_token(staff_user)\n    params = urlencode({\"email\": email, \"token\": token})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_user),\n        \"password_set_url\": password_set_url,\n        \"token\": token,\n        \"recipient_email\": staff_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_STAFF_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_staff_create_send_password_with_url(\n    mocked_notify,\n    staff_api_client,\n    media_root,\n    permission_manage_staff,\n):\n    email = \"api_user@example.com\"\n    redirect_url = \"https://www.example.com\"\n    variables = {\"email\": email, \"redirect_url\": redirect_url}\n\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert not data[\"errors\"]\n\n    staff_user = User.objects.get(email=email)\n    assert staff_user.is_staff\n\n    token = default_token_generator.make_token(staff_user)\n    params = urlencode({\"email\": email, \"token\": token})\n    password_set_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_user),\n        \"password_set_url\": password_set_url,\n        \"token\": token,\n        \"recipient_email\": staff_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_SET_STAFF_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\ndef test_staff_create_without_send_password(\n    staff_api_client, media_root, permission_manage_staff\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email}\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert not data[\"errors\"]\n    User.objects.get(email=email)\n\n\ndef test_staff_create_with_invalid_url(\n    staff_api_client, media_root, permission_manage_staff\n):\n    email = \"api_user@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"invalid\"}\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"permissions\": None,\n        \"groups\": None,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\ndef test_staff_create_with_not_allowed_url(\n    staff_api_client, media_root, permission_manage_staff\n):\n    email = \"api_userrr@example.com\"\n    variables = {\"email\": email, \"redirect_url\": \"https://www.fake.com\"}\n    response = staff_api_client.post_graphql(\n        STAFF_CREATE_MUTATION, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffCreate\"]\n    assert data[\"errors\"][0] == {\n        \"field\": \"redirectUrl\",\n        \"code\": AccountErrorCode.INVALID.name,\n        \"permissions\": None,\n        \"groups\": None,\n    }\n    staff_user = User.objects.filter(email=email)\n    assert not staff_user\n\n\nSTAFF_UPDATE_MUTATIONS = \"\"\"\n    mutation UpdateStaff(\n            $id: ID!, $input: StaffUpdateInput!) {\n        staffUpdate(\n                id: $id,\n                input: $input) {\n            errors {\n                field\n                code\n                message\n                permissions\n                groups\n            }\n            user {\n                userPermissions {\n                    code\n                }\n                permissionGroups {\n                    name\n                }\n                isActive\n                email\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_staff_update(staff_api_client, permission_manage_staff, media_root):\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    assert not staff_user.search_document\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert not data[\"user\"][\"isActive\"]\n    staff_user.refresh_from_db()\n    assert not staff_user.search_document\n\n\ndef test_staff_update_email(staff_api_client, permission_manage_staff, media_root):\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    assert not staff_user.search_document\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    new_email = \"test@email.com\"\n    variables = {\"id\": id, \"input\": {\"email\": new_email}}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert data[\"user\"][\"isActive\"]\n    staff_user.refresh_from_db()\n    assert staff_user.search_document == f\"{new_email}\\n\"\n\n\n@pytest.mark.parametrize(\"field\", [\"firstName\", \"lastName\"])\ndef test_staff_update_name_field(\n    field, staff_api_client, permission_manage_staff, media_root\n):\n    query = STAFF_UPDATE_MUTATIONS\n    email = \"staffuser@example.com\"\n    staff_user = User.objects.create(email=email, is_staff=True)\n    assert not staff_user.search_document\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    value = \"Name\"\n    variables = {\"id\": id, \"input\": {field: value}}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert data[\"user\"][\"isActive\"]\n    staff_user.refresh_from_db()\n    assert staff_user.search_document == f\"{email}\\n{value.lower()}\\n\"\n\n\ndef test_staff_update_app_no_permission(\n    app_api_client, permission_manage_staff, media_root\n):\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\ndef test_staff_update_groups_and_permissions(\n    staff_api_client,\n    media_root,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n):\n    query = STAFF_UPDATE_MUTATIONS\n    groups = Group.objects.bulk_create(\n        [Group(name=\"manage users\"), Group(name=\"manage orders\"), Group(name=\"empty\")]\n    )\n    group1, group2, group3 = groups\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_orders)\n\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_user.groups.add(group1)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group2, group3]\n            ],\n            \"removeGroups\": [graphene.Node.to_global_id(\"Group\", group1.pk)],\n        },\n    }\n\n    staff_api_client.user.user_permissions.add(\n        permission_manage_users, permission_manage_orders, permission_manage_products\n    )\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert {perm[\"code\"].lower() for perm in data[\"user\"][\"userPermissions\"]} == {\n        permission_manage_orders.codename,\n    }\n    assert {group[\"name\"] for group in data[\"user\"][\"permissionGroups\"]} == {\n        group2.name,\n        group3.name,\n    }\n\n\ndef test_staff_update_out_of_scope_user(\n    staff_api_client,\n    superuser_api_client,\n    permission_manage_staff,\n    permission_manage_orders,\n    media_root,\n):\n    \"\"\"Ensure that staff user cannot update user with wider scope of permission.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_user.user_permissions.add(permission_manage_orders)\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert not data[\"user\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"field\"] == \"id\"\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.OUT_OF_SCOPE_USER.name\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"user\"][\"email\"] == staff_user.email\n    assert data[\"user\"][\"isActive\"] is False\n    assert not data[\"errors\"]\n\n\ndef test_staff_update_out_of_scope_groups(\n    staff_api_client,\n    superuser_api_client,\n    permission_manage_staff,\n    media_root,\n    permission_manage_users,\n    permission_manage_orders,\n    permission_manage_products,\n):\n    \"\"\"Ensure that staff user cannot add to groups which permission scope is wider\n    than user's scope.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    query = STAFF_UPDATE_MUTATIONS\n\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage orders\"),\n            Group(name=\"manage products\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_orders)\n    group3.permissions.add(permission_manage_products)\n\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_api_client.user.user_permissions.add(permission_manage_orders)\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"isActive\": False,\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group1, group2]\n            ],\n            \"removeGroups\": [graphene.Node.to_global_id(\"Group\", group3.pk)],\n        },\n    }\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n    assert not data[\"user\"]\n    assert len(errors) == 2\n\n    expected_errors = [\n        {\n            \"field\": \"addGroups\",\n            \"code\": AccountErrorCode.OUT_OF_SCOPE_GROUP.name,\n            \"permissions\": None,\n            \"groups\": [graphene.Node.to_global_id(\"Group\", group1.pk)],\n        },\n        {\n            \"field\": \"removeGroups\",\n            \"code\": AccountErrorCode.OUT_OF_SCOPE_GROUP.name,\n            \"permissions\": None,\n            \"groups\": [graphene.Node.to_global_id(\"Group\", group3.pk)],\n        },\n    ]\n    for error in errors:\n        error.pop(\"message\")\n        assert error in expected_errors\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n    assert not errors\n    assert data[\"user\"][\"email\"] == staff_user.email\n    assert {group[\"name\"] for group in data[\"user\"][\"permissionGroups\"]} == {\n        group1.name,\n        group2.name,\n    }\n\n\ndef test_staff_update_duplicated_input_items(\n    staff_api_client,\n    permission_manage_staff,\n    media_root,\n    permission_manage_orders,\n    permission_manage_users,\n):\n    query = STAFF_UPDATE_MUTATIONS\n\n    groups = Group.objects.bulk_create(\n        [Group(name=\"manage users\"), Group(name=\"manage orders\"), Group(name=\"empty\")]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_orders)\n\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_api_client.user.user_permissions.add(\n        permission_manage_orders, permission_manage_users\n    )\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\n        \"id\": id,\n        \"input\": {\n            \"addGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group1, group2]\n            ],\n            \"removeGroups\": [\n                graphene.Node.to_global_id(\"Group\", gr.pk)\n                for gr in [group1, group2, group3]\n            ],\n        },\n    }\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    assert len(errors) == 1\n    assert errors[0][\"field\"] is None\n    assert errors[0][\"code\"] == AccountErrorCode.DUPLICATED_INPUT_ITEM.name\n    assert set(errors[0][\"groups\"]) == {\n        graphene.Node.to_global_id(\"Group\", gr.pk) for gr in [group1, group2]\n    }\n    assert errors[0][\"permissions\"] is None\n\n\ndef test_staff_update_doesnt_change_existing_avatar(\n    staff_api_client,\n    permission_manage_staff,\n    media_root,\n    staff_users,\n):\n    query = STAFF_UPDATE_MUTATIONS\n\n    mock_file = MagicMock(spec=File)\n    mock_file.name = \"image.jpg\"\n\n    staff_user, staff_user1, _ = staff_users\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n\n    staff_user.refresh_from_db()\n    assert not staff_user.avatar\n\n\ndef test_staff_update_deactivate_with_manage_staff_left_not_manageable_perms(\n    staff_api_client,\n    superuser_api_client,\n    staff_users,\n    permission_manage_users,\n    permission_manage_staff,\n    permission_manage_orders,\n    media_root,\n):\n    \"\"\"Ensure that staff user can't and superuser can deactivate user where some\n    permissions will be not manageable.\n    \"\"\"\n    query = STAFF_UPDATE_MUTATIONS\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user2)\n\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    assert not data[\"user\"]\n    assert len(errors) == 1\n    assert errors[0][\"field\"] == \"isActive\"\n    assert errors[0][\"code\"] == AccountErrorCode.LEFT_NOT_MANAGEABLE_PERMISSION.name\n    assert len(errors[0][\"permissions\"]) == 1\n    assert errors[0][\"permissions\"][0] == AccountPermissions.MANAGE_USERS.name\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    staff_user1.refresh_from_db()\n    assert data[\"user\"][\"email\"] == staff_user1.email\n    assert data[\"user\"][\"isActive\"] is False\n    assert not errors\n    assert not staff_user1.is_active\n\n\ndef test_staff_update_deactivate_with_manage_staff_all_perms_manageable(\n    staff_api_client,\n    staff_users,\n    permission_manage_users,\n    permission_manage_staff,\n    permission_manage_orders,\n    media_root,\n):\n    query = STAFF_UPDATE_MUTATIONS\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1, staff_user2)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user2)\n\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n\n    id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": id, \"input\": {\"isActive\": False}}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    errors = data[\"errors\"]\n\n    staff_user1.refresh_from_db()\n    assert not errors\n    assert staff_user1.is_active is False\n\n\ndef test_staff_update_update_email_assign_gift_cards_and_orders(\n    staff_api_client, permission_manage_staff, gift_card, order\n):\n    # given\n    query = STAFF_UPDATE_MUTATIONS\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n\n    new_email = \"testuser@example.com\"\n\n    gift_card.created_by = None\n    gift_card.created_by_email = new_email\n    gift_card.save(update_fields=[\"created_by\", \"created_by_email\"])\n\n    order.user = None\n    order.user_email = new_email\n    order.save(update_fields=[\"user_email\", \"user\"])\n\n    id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": id, \"input\": {\"email\": new_email}}\n\n    # when\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    # then\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffUpdate\"]\n    assert data[\"errors\"] == []\n    assert data[\"user\"][\"userPermissions\"] == []\n    assert data[\"user\"][\"email\"] == new_email\n    gift_card.refresh_from_db()\n    staff_user.refresh_from_db()\n    assert gift_card.created_by == staff_user\n    assert gift_card.created_by_email == staff_user.email\n    order.refresh_from_db()\n    assert order.user == staff_user\n\n\nSTAFF_DELETE_MUTATION = \"\"\"\n        mutation DeleteStaff($id: ID!) {\n            staffDelete(id: $id) {\n                errors {\n                    field\n                    code\n                    message\n                    permissions\n                }\n                user {\n                    id\n                }\n            }\n        }\n    \"\"\"\n\n\ndef test_staff_delete(staff_api_client, permission_manage_staff):\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    assert data[\"errors\"] == []\n    assert not User.objects.filter(pk=staff_user.id).exists()\n\n\n@patch(\"saleor.account.signals.delete_versatile_image\")\ndef test_staff_delete_with_avatar(\n    delete_versatile_image_mock,\n    staff_api_client,\n    image,\n    permission_manage_staff,\n    media_root,\n):\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(\n        email=\"staffuser@example.com\", avatar=image, is_staff=True\n    )\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    assert data[\"errors\"] == []\n    assert not User.objects.filter(pk=staff_user.id).exists()\n    delete_versatile_image_mock.assert_called_once_with(staff_user.avatar)\n\n\ndef test_staff_delete_app_no_permission(app_api_client, permission_manage_staff):\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\ndef test_staff_delete_out_of_scope_user(\n    staff_api_client,\n    superuser_api_client,\n    permission_manage_staff,\n    permission_manage_products,\n):\n    \"\"\"Ensure staff user cannot delete users even when some of user permissions are\n    out of requestor scope.\n    Ensure superuser pass restrictions.\n    \"\"\"\n    query = STAFF_DELETE_MUTATION\n    staff_user = User.objects.create(email=\"staffuser@example.com\", is_staff=True)\n    staff_user.user_permissions.add(permission_manage_products)\n    user_id = graphene.Node.to_global_id(\"User\", staff_user.id)\n    variables = {\"id\": user_id}\n\n    # for staff user\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    assert not data[\"user\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"field\"] == \"id\"\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.OUT_OF_SCOPE_USER.name\n\n    # for superuser\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n\n    assert data[\"errors\"] == []\n    assert not User.objects.filter(pk=staff_user.id).exists()\n\n\ndef test_staff_delete_left_not_manageable_permissions(\n    staff_api_client,\n    superuser_api_client,\n    staff_users,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n):\n    \"\"\"Ensure staff user can't and superuser can delete staff user when some of\n    permissions will be not manageable.\n    \"\"\"\n    query = STAFF_DELETE_MUTATION\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2, staff_user1)\n    group3.user_set.add(staff_user1)\n\n    user_id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": user_id}\n\n    # for staff user\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    errors = data[\"errors\"]\n\n    assert len(errors) == 1\n    assert errors[0][\"field\"] == \"id\"\n    assert errors[0][\"code\"] == AccountErrorCode.LEFT_NOT_MANAGEABLE_PERMISSION.name\n    assert set(errors[0][\"permissions\"]) == {\n        AccountPermissions.MANAGE_USERS.name,\n        OrderPermissions.MANAGE_ORDERS.name,\n    }\n    assert User.objects.filter(pk=staff_user1.id).exists()\n\n    # for superuser\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n    response = superuser_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    errors = data[\"errors\"]\n\n    assert not errors\n    assert not User.objects.filter(pk=staff_user1.id).exists()\n\n\ndef test_staff_delete_all_permissions_manageable(\n    staff_api_client,\n    staff_users,\n    permission_manage_staff,\n    permission_manage_users,\n    permission_manage_orders,\n):\n    query = STAFF_DELETE_MUTATION\n    groups = Group.objects.bulk_create(\n        [\n            Group(name=\"manage users\"),\n            Group(name=\"manage staff\"),\n            Group(name=\"manage users and orders\"),\n        ]\n    )\n    group1, group2, group3 = groups\n\n    group1.permissions.add(permission_manage_users)\n    group2.permissions.add(permission_manage_staff)\n    group3.permissions.add(permission_manage_users, permission_manage_orders)\n\n    staff_user, staff_user1, staff_user2 = staff_users\n    group1.user_set.add(staff_user1)\n    group2.user_set.add(staff_user2)\n    group3.user_set.add(staff_user1)\n\n    user_id = graphene.Node.to_global_id(\"User\", staff_user1.id)\n    variables = {\"id\": user_id}\n\n    staff_user.user_permissions.add(permission_manage_users, permission_manage_orders)\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"staffDelete\"]\n    errors = data[\"errors\"]\n\n    assert len(errors) == 0\n    assert not User.objects.filter(pk=staff_user1.id).exists()\n\n\ndef test_user_delete_errors(staff_user, admin_user):\n    info = Mock(context=Mock(user=staff_user))\n    with pytest.raises(ValidationError) as e:\n        UserDelete.clean_instance(info, staff_user)\n\n    msg = \"You cannot delete your own account.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n    info = Mock(context=Mock(user=staff_user))\n    with pytest.raises(ValidationError) as e:\n        UserDelete.clean_instance(info, admin_user)\n\n    msg = \"Cannot delete this account.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n\ndef test_staff_delete_errors(staff_user, customer_user, admin_user):\n    info = Mock(context=Mock(user=staff_user))\n    with pytest.raises(ValidationError) as e:\n        StaffDelete.clean_instance(info, customer_user)\n    msg = \"Cannot delete a non-staff users.\"\n    assert e.value.error_dict[\"id\"][0].message == msg\n\n    # should not raise any errors\n    info = Mock(context=Mock(user=admin_user))\n    StaffDelete.clean_instance(info, staff_user)\n\n\ndef test_staff_update_errors(staff_user, customer_user, admin_user):\n    errors = defaultdict(list)\n    input = {\"is_active\": None}\n    StaffUpdate.clean_is_active(input, customer_user, staff_user, errors)\n    assert not errors[\"is_active\"]\n\n    input[\"is_active\"] = False\n    StaffUpdate.clean_is_active(input, staff_user, staff_user, errors)\n    assert len(errors[\"is_active\"]) == 1\n    assert (\n        errors[\"is_active\"][0].code.upper()\n        == AccountErrorCode.DEACTIVATE_OWN_ACCOUNT.name\n    )\n\n    errors = defaultdict(list)\n    StaffUpdate.clean_is_active(input, admin_user, staff_user, errors)\n    assert len(errors[\"is_active\"]) == 2\n    assert {error.code.upper() for error in errors[\"is_active\"]} == {\n        AccountErrorCode.DEACTIVATE_SUPERUSER_ACCOUNT.name,\n        AccountErrorCode.LEFT_NOT_MANAGEABLE_PERMISSION.name,\n    }\n\n    errors = defaultdict(list)\n    # should not raise any errors\n    StaffUpdate.clean_is_active(input, customer_user, staff_user, errors)\n    assert not errors[\"is_active\"]\n\n\nSET_PASSWORD_MUTATION = \"\"\"\n    mutation SetPassword($email: String!, $token: String!, $password: String!) {\n        setPassword(email: $email, token: $token, password: $password) {\n            errors {\n                field\n                message\n            }\n            errors {\n                field\n                message\n                code\n            }\n            user {\n                id\n            }\n            token\n            refreshToken\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_set_password(user_api_client, customer_user):\n    token = default_token_generator.make_token(customer_user)\n    password = \"spanish-inquisition\"\n\n    variables = {\"email\": customer_user.email, \"password\": password, \"token\": token}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"setPassword\"]\n    assert data[\"user\"][\"id\"]\n    assert data[\"token\"]\n\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(password)\n\n    password_resent_event = account_events.CustomerEvent.objects.get()\n    assert password_resent_event.type == account_events.CustomerEvents.PASSWORD_RESET\n    assert password_resent_event.user == customer_user\n\n\ndef test_set_password_invalid_token(user_api_client, customer_user):\n    variables = {\"email\": customer_user.email, \"password\": \"pass\", \"token\": \"token\"}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert errors[0][\"message\"] == INVALID_TOKEN\n\n    account_errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert account_errors[0][\"message\"] == INVALID_TOKEN\n    assert account_errors[0][\"code\"] == AccountErrorCode.INVALID.name\n\n\ndef test_set_password_invalid_email(user_api_client):\n    variables = {\"email\": \"fake@example.com\", \"password\": \"pass\", \"token\": \"token\"}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert len(errors) == 1\n    assert errors[0][\"field\"] == \"email\"\n\n    account_errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert len(account_errors) == 1\n    assert account_errors[0][\"field\"] == \"email\"\n    assert account_errors[0][\"code\"] == AccountErrorCode.NOT_FOUND.name\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\ndef test_set_password_invalid_password(user_api_client, customer_user, settings):\n    settings.AUTH_PASSWORD_VALIDATORS = [\n        {\n            \"NAME\": \"django.contrib.auth.password_validation.MinimumLengthValidator\",\n            \"OPTIONS\": {\"min_length\": 5},\n        },\n        {\"NAME\": \"django.contrib.auth.password_validation.NumericPasswordValidator\"},\n    ]\n\n    token = default_token_generator.make_token(customer_user)\n    variables = {\"email\": customer_user.email, \"password\": \"1234\", \"token\": token}\n    response = user_api_client.post_graphql(SET_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert len(errors) == 2\n    assert (\n        errors[0][\"message\"]\n        == \"This password is too short. It must contain at least 5 characters.\"\n    )\n    assert errors[1][\"message\"] == \"This password is entirely numeric.\"\n\n    account_errors = content[\"data\"][\"setPassword\"][\"errors\"]\n    assert account_errors[0][\"code\"] == str_to_enum(\"password_too_short\")\n    assert account_errors[1][\"code\"] == str_to_enum(\"password_entirely_numeric\")\n\n\nCHANGE_PASSWORD_MUTATION = \"\"\"\n    mutation PasswordChange($oldPassword: String!, $newPassword: String!) {\n        passwordChange(oldPassword: $oldPassword, newPassword: $newPassword) {\n            errors {\n                field\n                message\n            }\n            user {\n                email\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_password_change(user_api_client):\n    customer_user = user_api_client.user\n    new_password = \"spanish-inquisition\"\n\n    variables = {\"oldPassword\": \"password\", \"newPassword\": new_password}\n    response = user_api_client.post_graphql(CHANGE_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"passwordChange\"]\n    assert not data[\"errors\"]\n    assert data[\"user\"][\"email\"] == customer_user.email\n\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(new_password)\n\n    password_change_event = account_events.CustomerEvent.objects.get()\n    assert password_change_event.type == account_events.CustomerEvents.PASSWORD_CHANGED\n    assert password_change_event.user == customer_user\n\n\ndef test_password_change_incorrect_old_password(user_api_client):\n    customer_user = user_api_client.user\n    variables = {\"oldPassword\": \"incorrect\", \"newPassword\": \"\"}\n    response = user_api_client.post_graphql(CHANGE_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"passwordChange\"]\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(\"password\")\n    assert data[\"errors\"]\n    assert data[\"errors\"][0][\"field\"] == \"oldPassword\"\n\n\ndef test_password_change_invalid_new_password(user_api_client, settings):\n    settings.AUTH_PASSWORD_VALIDATORS = [\n        {\n            \"NAME\": \"django.contrib.auth.password_validation.MinimumLengthValidator\",\n            \"OPTIONS\": {\"min_length\": 5},\n        },\n        {\"NAME\": \"django.contrib.auth.password_validation.NumericPasswordValidator\"},\n    ]\n\n    customer_user = user_api_client.user\n    variables = {\"oldPassword\": \"password\", \"newPassword\": \"1234\"}\n    response = user_api_client.post_graphql(CHANGE_PASSWORD_MUTATION, variables)\n    content = get_graphql_content(response)\n    errors = content[\"data\"][\"passwordChange\"][\"errors\"]\n    customer_user.refresh_from_db()\n    assert customer_user.check_password(\"password\")\n    assert len(errors) == 2\n    assert errors[1][\"field\"] == \"newPassword\"\n    assert (\n        errors[0][\"message\"]\n        == \"This password is too short. It must contain at least 5 characters.\"\n    )\n    assert errors[1][\"field\"] == \"newPassword\"\n    assert errors[1][\"message\"] == \"This password is entirely numeric.\"\n\n\nADDRESS_CREATE_MUTATION = \"\"\"\n    mutation CreateUserAddress($user: ID!, $city: String!, $country: CountryCode!) {\n        addressCreate(userId: $user, input: {city: $city, country: $country}) {\n            errors {\n                field\n                message\n            }\n            address {\n                id\n                city\n                country {\n                    code\n                }\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_create_address_mutation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    query = ADDRESS_CREATE_MUTATION\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"user\": user_id, \"city\": \"Dummy\", \"country\": \"PL\"}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"addressCreate\"][\"errors\"] == []\n    data = content[\"data\"][\"addressCreate\"]\n    assert data[\"address\"][\"city\"] == \"Dummy\"\n    assert data[\"address\"][\"country\"][\"code\"] == \"PL\"\n    address_obj = Address.objects.get(city=\"Dummy\")\n    assert address_obj.user_addresses.first() == customer_user\n    assert data[\"user\"][\"id\"] == user_id\n\n    customer_user.refresh_from_db()\n    for field in [\"city\", \"country\"]:\n        assert variables[field].lower() in customer_user.search_document\n\n\n@override_settings(MAX_USER_ADDRESSES=2)\ndef test_create_address_mutation_the_oldest_address_is_deleted(\n    staff_api_client, customer_user, address, permission_manage_users\n):\n    same_address = Address.objects.create(**address.as_data())\n    customer_user.addresses.set([address, same_address])\n\n    user_addresses_count = customer_user.addresses.count()\n\n    query = ADDRESS_CREATE_MUTATION\n    user_id = graphene.Node.to_global_id(\"User\", customer_user.id)\n    variables = {\"user\": user_id, \"city\": \"Dummy\", \"country\": \"PL\"}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"addressCreate\"][\"errors\"] == []\n    data = content[\"data\"][\"addressCreate\"]\n    assert data[\"address\"][\"city\"] == \"Dummy\"\n    assert data[\"address\"][\"country\"][\"code\"] == \"PL\"\n    address_obj = Address.objects.get(city=\"Dummy\")\n    assert address_obj.user_addresses.first() == customer_user\n    assert data[\"user\"][\"id\"] == user_id\n\n    customer_user.refresh_from_db()\n    assert customer_user.addresses.count() == user_addresses_count\n\n    with pytest.raises(address._meta.model.DoesNotExist):\n        address.refresh_from_db()\n\n\nADDRESS_UPDATE_MUTATION = \"\"\"\n    mutation updateUserAddress($addressId: ID!, $address: AddressInput!) {\n        addressUpdate(id: $addressId, input: $address) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_address_update_mutation(\n    staff_api_client, customer_user, permission_manage_users, graphql_address_data\n):\n    query = ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n    assert staff_api_client.user not in address_obj.user_addresses.all()\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": graphql_address_data,\n    }\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressUpdate\"]\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n    address_obj.refresh_from_db()\n    assert address_obj.city == graphql_address_data[\"city\"].upper()\n    customer_user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(address_obj)\n        in customer_user.search_document\n    )\n\n\nACCOUNT_ADDRESS_UPDATE_MUTATION = \"\"\"\n    mutation updateAccountAddress($addressId: ID!, $address: AddressInput!) {\n        accountAddressUpdate(id: $addressId, input: $address) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_customer_update_own_address(\n    user_api_client, customer_user, graphql_address_data\n):\n    query = ACCOUNT_ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n    address_data = graphql_address_data\n    address_data[\"city\"] = \"Pozna\u0144\"\n    assert address_data[\"city\"] != address_obj.city\n    user = user_api_client.user\n\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": address_data,\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountAddressUpdate\"]\n    assert data[\"address\"][\"city\"] == address_data[\"city\"].upper()\n    address_obj.refresh_from_db()\n    assert address_obj.city == address_data[\"city\"].upper()\n    user.refresh_from_db()\n    assert generate_address_search_document_value(address_obj) in user.search_document\n\n\ndef test_update_address_as_anonymous_user(\n    api_client, customer_user, graphql_address_data\n):\n    query = ACCOUNT_ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": graphql_address_data,\n    }\n    response = api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_customer_update_own_address_not_updated_when_validation_fails(\n    user_api_client, customer_user, graphql_address_data\n):\n    query = ACCOUNT_ADDRESS_UPDATE_MUTATION\n    address_obj = customer_user.addresses.first()\n    address_data = graphql_address_data\n    address_data[\"city\"] = \"Pozna\u0144\"\n    address_data[\"postalCode\"] = \"wrong postal code\"\n    assert address_data[\"city\"] != address_obj.city\n\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": address_data,\n    }\n    user_api_client.post_graphql(query, variables)\n    address_obj.refresh_from_db()\n    assert address_obj.city != address_data[\"city\"]\n    assert address_obj.postal_code != address_data[\"postalCode\"]\n\n\n@pytest.mark.parametrize(\n    \"query\", [ADDRESS_UPDATE_MUTATION, ACCOUNT_ADDRESS_UPDATE_MUTATION]\n)\ndef test_customer_update_address_for_other(\n    user_api_client, customer_user, address_other_country, graphql_address_data, query\n):\n    address_obj = address_other_country\n    assert customer_user not in address_obj.user_addresses.all()\n\n    address_data = graphql_address_data\n    variables = {\n        \"addressId\": graphene.Node.to_global_id(\"Address\", address_obj.id),\n        \"address\": address_data,\n    }\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\nADDRESS_DELETE_MUTATION = \"\"\"\n    mutation deleteUserAddress($id: ID!) {\n        addressDelete(id: $id) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_address_delete_mutation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    query = ADDRESS_DELETE_MUTATION\n    address_obj = customer_user.addresses.first()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = staff_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressDelete\"]\n    assert data[\"address\"][\"city\"] == address_obj.city\n    assert data[\"user\"][\"id\"] == graphene.Node.to_global_id(\"User\", customer_user.pk)\n    with pytest.raises(address_obj._meta.model.DoesNotExist):\n        address_obj.refresh_from_db()\n\n    customer_user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(address_obj)\n        not in customer_user.search_document\n    )\n\n\ndef test_address_delete_mutation_as_app(\n    app_api_client, customer_user, permission_manage_users\n):\n    query = ADDRESS_DELETE_MUTATION\n    address_obj = customer_user.addresses.first()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = app_api_client.post_graphql(\n        query, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressDelete\"]\n    assert data[\"address\"][\"city\"] == address_obj.city\n    assert data[\"user\"][\"id\"] == graphene.Node.to_global_id(\"User\", customer_user.pk)\n    with pytest.raises(address_obj._meta.model.DoesNotExist):\n        address_obj.refresh_from_db()\n\n\nACCOUNT_ADDRESS_DELETE_MUTATION = \"\"\"\n    mutation deleteUserAddress($id: ID!) {\n        accountAddressDelete(id: $id) {\n            address {\n                city\n            }\n            user {\n                id\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_customer_delete_own_address(user_api_client, customer_user):\n    query = ACCOUNT_ADDRESS_DELETE_MUTATION\n    address_obj = customer_user.addresses.first()\n    user = user_api_client.user\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountAddressDelete\"]\n    assert data[\"address\"][\"city\"] == address_obj.city\n    with pytest.raises(address_obj._meta.model.DoesNotExist):\n        address_obj.refresh_from_db()\n    user.refresh_from_db()\n    assert (\n        generate_address_search_document_value(address_obj) not in user.search_document\n    )\n\n\n@pytest.mark.parametrize(\n    \"query\", [ADDRESS_DELETE_MUTATION, ACCOUNT_ADDRESS_DELETE_MUTATION]\n)\ndef test_customer_delete_address_for_other(\n    user_api_client, customer_user, address_other_country, query\n):\n    address_obj = address_other_country\n    assert customer_user not in address_obj.user_addresses.all()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_obj.id)}\n    response = user_api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n    address_obj.refresh_from_db()\n\n\nSET_DEFAULT_ADDRESS_MUTATION = \"\"\"\nmutation($address_id: ID!, $user_id: ID!, $type: AddressTypeEnum!) {\n  addressSetDefault(addressId: $address_id, userId: $user_id, type: $type) {\n    errors {\n      field\n      message\n    }\n    user {\n      defaultBillingAddress {\n        id\n      }\n      defaultShippingAddress {\n        id\n      }\n    }\n  }\n}\n\"\"\"\n\n\ndef test_set_default_address(\n    staff_api_client, address_other_country, customer_user, permission_manage_users\n):\n    customer_user.default_billing_address = None\n    customer_user.default_shipping_address = None\n    customer_user.save()\n\n    # try to set an address that doesn't belong to that user\n    address = address_other_country\n\n    variables = {\n        \"address_id\": graphene.Node.to_global_id(\"Address\", address.id),\n        \"user_id\": graphene.Node.to_global_id(\"User\", customer_user.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n\n    response = staff_api_client.post_graphql(\n        SET_DEFAULT_ADDRESS_MUTATION, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressSetDefault\"]\n    assert data[\"errors\"][0][\"field\"] == \"addressId\"\n\n    # try to set a new billing address using one of user's addresses\n    address = customer_user.addresses.first()\n    address_id = graphene.Node.to_global_id(\"Address\", address.id)\n\n    variables[\"address_id\"] = address_id\n    response = staff_api_client.post_graphql(SET_DEFAULT_ADDRESS_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressSetDefault\"]\n    assert data[\"user\"][\"defaultShippingAddress\"][\"id\"] == address_id\n\n\nGET_ADDRESS_VALIDATION_RULES_QUERY = \"\"\"\n    query getValidator(\n        $country_code: CountryCode!, $country_area: String, $city_area: String) {\n        addressValidationRules(\n                countryCode: $country_code,\n                countryArea: $country_area,\n                cityArea: $city_area) {\n            countryCode\n            countryName\n            addressFormat\n            addressLatinFormat\n            allowedFields\n            requiredFields\n            upperFields\n            countryAreaType\n            countryAreaChoices {\n                verbose\n                raw\n            }\n            cityType\n            cityChoices {\n                raw\n                verbose\n            }\n            cityAreaType\n            cityAreaChoices {\n                raw\n                verbose\n            }\n            postalCodeType\n            postalCodeMatchers\n            postalCodeExamples\n            postalCodePrefix\n        }\n    }\n\"\"\"\n\n\ndef test_address_validation_rules(user_api_client):\n    query = GET_ADDRESS_VALIDATION_RULES_QUERY\n    variables = {\"country_code\": \"PL\", \"country_area\": None, \"city_area\": None}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressValidationRules\"]\n    assert data[\"countryCode\"] == \"PL\"\n    assert data[\"countryName\"] == \"POLAND\"\n    assert data[\"addressFormat\"] is not None\n    assert data[\"addressLatinFormat\"] is not None\n    assert data[\"cityType\"] == \"city\"\n    assert data[\"cityAreaType\"] == \"suburb\"\n    matcher = data[\"postalCodeMatchers\"][0]\n    matcher = re.compile(matcher)\n    assert matcher.match(\"00-123\")\n    assert not data[\"cityAreaChoices\"]\n    assert not data[\"cityChoices\"]\n    assert not data[\"countryAreaChoices\"]\n    assert data[\"postalCodeExamples\"]\n    assert data[\"postalCodeType\"] == \"postal\"\n    assert set(data[\"allowedFields\"]) == {\n        \"companyName\",\n        \"city\",\n        \"postalCode\",\n        \"streetAddress1\",\n        \"name\",\n        \"streetAddress2\",\n    }\n    assert set(data[\"requiredFields\"]) == {\"postalCode\", \"streetAddress1\", \"city\"}\n    assert set(data[\"upperFields\"]) == {\"city\"}\n\n\ndef test_address_validation_rules_with_country_area(user_api_client):\n    query = GET_ADDRESS_VALIDATION_RULES_QUERY\n    variables = {\n        \"country_code\": \"CN\",\n        \"country_area\": \"Fujian Sheng\",\n        \"city_area\": None,\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressValidationRules\"]\n    assert data[\"countryCode\"] == \"CN\"\n    assert data[\"countryName\"] == \"CHINA\"\n    assert data[\"countryAreaType\"] == \"province\"\n    assert data[\"countryAreaChoices\"]\n    assert data[\"cityType\"] == \"city\"\n    assert data[\"cityChoices\"]\n    assert data[\"cityAreaType\"] == \"district\"\n    assert not data[\"cityAreaChoices\"]\n    assert data[\"cityChoices\"]\n    assert data[\"countryAreaChoices\"]\n    assert data[\"postalCodeExamples\"]\n    assert data[\"postalCodeType\"] == \"postal\"\n    assert set(data[\"allowedFields\"]) == {\n        \"city\",\n        \"postalCode\",\n        \"streetAddress1\",\n        \"name\",\n        \"streetAddress2\",\n        \"countryArea\",\n        \"companyName\",\n        \"cityArea\",\n    }\n    assert set(data[\"requiredFields\"]) == {\n        \"postalCode\",\n        \"streetAddress1\",\n        \"city\",\n        \"countryArea\",\n    }\n    assert set(data[\"upperFields\"]) == {\"countryArea\"}\n\n\ndef test_address_validation_rules_fields_in_camel_case(user_api_client):\n    query = \"\"\"\n    query getValidator(\n        $country_code: CountryCode!) {\n        addressValidationRules(countryCode: $country_code) {\n            requiredFields\n            allowedFields\n        }\n    }\n    \"\"\"\n    variables = {\"country_code\": \"PL\"}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"addressValidationRules\"]\n    required_fields = data[\"requiredFields\"]\n    allowed_fields = data[\"allowedFields\"]\n    assert \"streetAddress1\" in required_fields\n    assert \"streetAddress2\" not in required_fields\n    assert \"streetAddress1\" in allowed_fields\n    assert \"streetAddress2\" in allowed_fields\n\n\nREQUEST_PASSWORD_RESET_MUTATION = \"\"\"\n    mutation RequestPasswordReset(\n        $email: String!, $redirectUrl: String!, $channel: String) {\n        requestPasswordReset(\n            email: $email, redirectUrl: $redirectUrl, channel: $channel) {\n            errors {\n                field\n                message\n            }\n        }\n    }\n\"\"\"\n\nCONFIRM_ACCOUNT_MUTATION = \"\"\"\n    mutation ConfirmAccount($email: String!, $token: String!) {\n        confirmAccount(email: $email, token: $token) {\n            errors {\n                field\n                code\n            }\n            user {\n                id\n                email\n            }\n        }\n    }\n\"\"\"\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password(\n    mocked_notify, user_api_client, customer_user, channel_PLN, channel_USD\n):\n    redirect_url = \"https://www.example.com\"\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": redirect_url,\n        \"channel\": channel_PLN.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n    token = default_token_generator.make_token(customer_user)\n    params = urlencode({\"email\": customer_user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(customer_user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": customer_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_PASSWORD_RESET,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.graphql.account.mutations.base.assign_user_gift_cards\")\n@patch(\"saleor.graphql.account.mutations.base.match_orders_with_new_user\")\ndef test_account_confirmation(\n    match_orders_with_new_user_mock,\n    assign_gift_cards_mock,\n    api_client,\n    customer_user,\n    channel_USD,\n):\n    customer_user.is_active = False\n    customer_user.save()\n\n    variables = {\n        \"email\": customer_user.email,\n        \"token\": default_token_generator.make_token(customer_user),\n        \"channel\": channel_USD.slug,\n    }\n    response = api_client.post_graphql(CONFIRM_ACCOUNT_MUTATION, variables)\n    content = get_graphql_content(response)\n    assert not content[\"data\"][\"confirmAccount\"][\"errors\"]\n    assert content[\"data\"][\"confirmAccount\"][\"user\"][\"email\"] == customer_user.email\n    customer_user.refresh_from_db()\n    match_orders_with_new_user_mock.assert_called_once_with(customer_user)\n    assign_gift_cards_mock.assert_called_once_with(customer_user)\n    assert customer_user.is_active is True\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.graphql.account.mutations.base.assign_user_gift_cards\")\n@patch(\"saleor.graphql.account.mutations.base.match_orders_with_new_user\")\ndef test_account_confirmation_invalid_user(\n    match_orders_with_new_user_mock,\n    assign_gift_cards_mock,\n    user_api_client,\n    customer_user,\n    channel_USD,\n):\n    variables = {\n        \"email\": \"non-existing@example.com\",\n        \"token\": default_token_generator.make_token(customer_user),\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(CONFIRM_ACCOUNT_MUTATION, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"field\"] == \"email\"\n    assert (\n        content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"code\"]\n        == AccountErrorCode.NOT_FOUND.name\n    )\n    match_orders_with_new_user_mock.assert_not_called()\n    assign_gift_cards_mock.assert_not_called()\n\n\n@patch(\"saleor.graphql.account.mutations.base.assign_user_gift_cards\")\n@patch(\"saleor.graphql.account.mutations.base.match_orders_with_new_user\")\ndef test_account_confirmation_invalid_token(\n    match_orders_with_new_user_mock,\n    assign_gift_cards_mock,\n    user_api_client,\n    customer_user,\n    channel_USD,\n):\n    variables = {\n        \"email\": customer_user.email,\n        \"token\": \"invalid_token\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(CONFIRM_ACCOUNT_MUTATION, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"field\"] == \"token\"\n    assert (\n        content[\"data\"][\"confirmAccount\"][\"errors\"][0][\"code\"]\n        == AccountErrorCode.INVALID.name\n    )\n    match_orders_with_new_user_mock.assert_not_called()\n    assign_gift_cards_mock.assert_not_called()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_request_password_reset_email_for_staff(\n    mocked_notify, staff_api_client, channel_USD\n):\n    redirect_url = \"https://www.example.com\"\n    variables = {\"email\": staff_api_client.user.email, \"redirectUrl\": redirect_url}\n    response = staff_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n    token = default_token_generator.make_token(staff_api_client.user)\n    params = urlencode({\"email\": staff_api_client.user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(staff_api_client.user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": staff_api_client.user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": None,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_STAFF_RESET_PASSWORD,\n        payload=expected_payload,\n        channel_slug=None,\n    )\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_invalid_email(\n    mocked_notify, user_api_client, channel_USD\n):\n    variables = {\n        \"email\": \"non-existing-email@email.com\",\n        \"redirectUrl\": \"https://www.example.com\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert len(data[\"errors\"]) == 1\n    mocked_notify.assert_not_called()\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_user_is_inactive(\n    mocked_notify, user_api_client, customer_user, channel_USD\n):\n    user = customer_user\n    user.is_active = False\n    user.save()\n\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": \"https://www.example.com\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert data[\"errors\"] == [\n        {\"field\": \"email\", \"message\": \"User with this email is inactive\"}\n    ]\n    assert not mocked_notify.called\n\n\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_storefront_hosts_not_allowed(\n    mocked_notify, user_api_client, customer_user, channel_USD\n):\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": \"https://www.fake.com\",\n        \"channel\": channel_USD.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"field\"] == \"redirectUrl\"\n    mocked_notify.assert_not_called()\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_all_storefront_hosts_allowed(\n    mocked_notify, user_api_client, customer_user, settings, channel_PLN, channel_USD\n):\n    settings.ALLOWED_CLIENT_HOSTS = [\"*\"]\n    redirect_url = \"https://www.test.com\"\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": redirect_url,\n        \"channel\": channel_PLN.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n\n    token = default_token_generator.make_token(customer_user)\n    params = urlencode({\"email\": customer_user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(customer_user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": customer_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_PASSWORD_RESET,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\n@freeze_time(\"2018-05-31 12:00:01\")\n@patch(\"saleor.plugins.manager.PluginsManager.notify\")\ndef test_account_reset_password_subdomain(\n    mocked_notify, user_api_client, customer_user, settings, channel_PLN\n):\n    settings.ALLOWED_CLIENT_HOSTS = [\".example.com\"]\n    redirect_url = \"https://sub.example.com\"\n    variables = {\n        \"email\": customer_user.email,\n        \"redirectUrl\": redirect_url,\n        \"channel\": channel_PLN.slug,\n    }\n    response = user_api_client.post_graphql(REQUEST_PASSWORD_RESET_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestPasswordReset\"]\n    assert not data[\"errors\"]\n\n    token = default_token_generator.make_token(customer_user)\n    params = urlencode({\"email\": customer_user.email, \"token\": token})\n    reset_url = prepare_url(params, redirect_url)\n    expected_payload = {\n        \"user\": get_default_user_payload(customer_user),\n        \"reset_url\": reset_url,\n        \"token\": token,\n        \"recipient_email\": customer_user.email,\n        \"site_name\": \"mirumee.com\",\n        \"domain\": \"mirumee.com\",\n        \"channel_slug\": channel_PLN.slug,\n    }\n\n    mocked_notify.assert_called_once_with(\n        NotifyEventType.ACCOUNT_PASSWORD_RESET,\n        payload=expected_payload,\n        channel_slug=channel_PLN.slug,\n    )\n\n\nACCOUNT_ADDRESS_CREATE_MUTATION = \"\"\"\nmutation($addressInput: AddressInput!, $addressType: AddressTypeEnum) {\n  accountAddressCreate(input: $addressInput, type: $addressType) {\n    address {\n        id,\n        city\n    }\n    user {\n        email\n    }\n    errors {\n        code\n        field\n        addressType\n    }\n  }\n}\n\"\"\"\n\n\ndef test_customer_create_address(user_api_client, graphql_address_data):\n    user = user_api_client.user\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    mutation_name = \"accountAddressCreate\"\n\n    variables = {\"addressInput\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count + 1\n    assert (\n        generate_address_search_document_value(user.addresses.last())\n        in user.search_document\n    )\n\n\ndef test_account_address_create_return_user(user_api_client, graphql_address_data):\n    user = user_api_client.user\n    variables = {\"addressInput\": graphql_address_data}\n    response = user_api_client.post_graphql(ACCOUNT_ADDRESS_CREATE_MUTATION, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"accountAddressCreate\"][\"user\"]\n    assert data[\"email\"] == user.email\n\n\ndef test_customer_create_default_address(user_api_client, graphql_address_data):\n    user = user_api_client.user\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    mutation_name = \"accountAddressCreate\"\n\n    address_type = AddressType.SHIPPING.upper()\n    variables = {\"addressInput\": graphql_address_data, \"addressType\": address_type}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count + 1\n    assert user.default_shipping_address.id == int(\n        graphene.Node.from_global_id(data[\"address\"][\"id\"])[1]\n    )\n\n    address_type = AddressType.BILLING.upper()\n    variables = {\"addressInput\": graphql_address_data, \"addressType\": address_type}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count + 2\n    assert user.default_billing_address.id == int(\n        graphene.Node.from_global_id(data[\"address\"][\"id\"])[1]\n    )\n\n\n@override_settings(MAX_USER_ADDRESSES=2)\ndef test_customer_create_address_the_oldest_address_is_deleted(\n    user_api_client, graphql_address_data, address\n):\n    \"\"\"Ensure that when mew address it added to user with max amount of addressess,\n    the oldest address will be removed.\"\"\"\n    user = user_api_client.user\n    same_address = Address.objects.create(**address.as_data())\n    user.addresses.set([address, same_address])\n\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    mutation_name = \"accountAddressCreate\"\n\n    variables = {\"addressInput\": graphql_address_data}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n\n    assert data[\"address\"][\"city\"] == graphql_address_data[\"city\"].upper()\n\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count\n\n    with pytest.raises(address._meta.model.DoesNotExist):\n        address.refresh_from_db()\n\n\ndef test_anonymous_user_create_address(api_client, graphql_address_data):\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n    variables = {\"addressInput\": graphql_address_data}\n    response = api_client.post_graphql(query, variables)\n    assert_no_permission(response)\n\n\ndef test_address_not_created_after_validation_fails(\n    user_api_client, graphql_address_data\n):\n    user = user_api_client.user\n    user_addresses_count = user.addresses.count()\n\n    query = ACCOUNT_ADDRESS_CREATE_MUTATION\n\n    graphql_address_data[\"postalCode\"] = \"wrong postal code\"\n\n    address_type = AddressType.SHIPPING.upper()\n    variables = {\"addressInput\": graphql_address_data, \"addressType\": address_type}\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n\n    data = content[\"data\"][\"accountAddressCreate\"]\n    assert not data[\"address\"]\n    assert len(data[\"errors\"]) == 1\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.INVALID.name\n    assert data[\"errors\"][0][\"field\"] == \"postalCode\"\n    assert data[\"errors\"][0][\"addressType\"] == address_type\n    user.refresh_from_db()\n    assert user.addresses.count() == user_addresses_count\n\n\nACCOUNT_SET_DEFAULT_ADDRESS_MUTATION = \"\"\"\nmutation($id: ID!, $type: AddressTypeEnum!) {\n  accountSetDefaultAddress(id: $id, type: $type) {\n    errors {\n      field,\n      message\n    }\n  }\n}\n\"\"\"\n\n\ndef test_customer_set_address_as_default(user_api_client):\n    user = user_api_client.user\n    user.default_billing_address = None\n    user.default_shipping_address = None\n    user.save()\n    assert not user.default_billing_address\n    assert not user.default_shipping_address\n    assert user.addresses.exists()\n\n    address = user.addresses.first()\n    query = ACCOUNT_SET_DEFAULT_ADDRESS_MUTATION\n    mutation_name = \"accountSetDefaultAddress\"\n\n    variables = {\n        \"id\": graphene.Node.to_global_id(\"Address\", address.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    user.refresh_from_db()\n    assert user.default_shipping_address == address\n\n    variables[\"type\"] = AddressType.BILLING.upper()\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    user.refresh_from_db()\n    assert user.default_billing_address == address\n\n\ndef test_customer_change_default_address(user_api_client, address_other_country):\n    user = user_api_client.user\n    assert user.default_billing_address\n    assert user.default_billing_address\n    address = user.default_shipping_address\n    assert address in user.addresses.all()\n    assert address_other_country not in user.addresses.all()\n\n    user.default_shipping_address = address_other_country\n    user.save()\n    user.refresh_from_db()\n    assert address_other_country not in user.addresses.all()\n\n    query = ACCOUNT_SET_DEFAULT_ADDRESS_MUTATION\n    mutation_name = \"accountSetDefaultAddress\"\n\n    variables = {\n        \"id\": graphene.Node.to_global_id(\"Address\", address.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][mutation_name]\n    assert not data[\"errors\"]\n\n    user.refresh_from_db()\n    assert user.default_shipping_address == address\n    assert address_other_country in user.addresses.all()\n\n\ndef test_customer_change_default_address_invalid_address(\n    user_api_client, address_other_country\n):\n    user = user_api_client.user\n    assert address_other_country not in user.addresses.all()\n\n    query = ACCOUNT_SET_DEFAULT_ADDRESS_MUTATION\n    mutation_name = \"accountSetDefaultAddress\"\n\n    variables = {\n        \"id\": graphene.Node.to_global_id(\"Address\", address_other_country.id),\n        \"type\": AddressType.SHIPPING.upper(),\n    }\n    response = user_api_client.post_graphql(query, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][mutation_name][\"errors\"][0][\"field\"] == \"id\"\n\n\nUSER_AVATAR_UPDATE_MUTATION = \"\"\"\n    mutation userAvatarUpdate($image: Upload!) {\n        userAvatarUpdate(image: $image) {\n            user {\n                avatar {\n                    url\n                }\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_user_avatar_update_mutation_permission(api_client):\n    \"\"\"Should raise error if user is not staff.\"\"\"\n\n    query = USER_AVATAR_UPDATE_MUTATION\n\n    image_file, image_name = create_image(\"avatar\")\n    variables = {\"image\": image_name}\n    body = get_multipart_request_body(query, variables, image_file, image_name)\n    response = api_client.post_multipart(body)\n\n    assert_no_permission(response)\n\n\ndef test_user_avatar_update_mutation(monkeypatch, staff_api_client, media_root):\n    query = USER_AVATAR_UPDATE_MUTATION\n\n    user = staff_api_client.user\n\n    mock_create_thumbnails = Mock(return_value=None)\n    monkeypatch.setattr(\n        (\n            \"saleor.graphql.account.mutations.staff.\"\n            \"create_user_avatar_thumbnails.delay\"\n        ),\n        mock_create_thumbnails,\n    )\n\n    image_file, image_name = create_image(\"avatar\")\n    variables = {\"image\": image_name}\n    body = get_multipart_request_body(query, variables, image_file, image_name)\n    response = staff_api_client.post_multipart(body)\n    content = get_graphql_content(response)\n\n    data = content[\"data\"][\"userAvatarUpdate\"]\n    user.refresh_from_db()\n\n    assert user.avatar\n    assert data[\"user\"][\"avatar\"][\"url\"].startswith(\n        \"http://testserver/media/user-avatars/avatar\"\n    )\n    img_name, format = os.path.splitext(image_file._name)\n    file_name = user.avatar.name\n    assert file_name != image_file._name\n    assert file_name.startswith(f\"user-avatars/{img_name}\")\n    assert file_name.endswith(format)\n\n    # The image creation should have triggered a warm-up\n    mock_create_thumbnails.assert_called_once_with(user_id=user.pk)\n\n\ndef test_user_avatar_update_mutation_image_exists(staff_api_client, media_root):\n    query = USER_AVATAR_UPDATE_MUTATION\n\n    user = staff_api_client.user\n    avatar_mock = MagicMock(spec=File)\n    avatar_mock.name = \"image.jpg\"\n    user.avatar = avatar_mock\n    user.save()\n\n    image_file, image_name = create_image(\"new_image\")\n    variables = {\"image\": image_name}\n    body = get_multipart_request_body(query, variables, image_file, image_name)\n    response = staff_api_client.post_multipart(body)\n    content = get_graphql_content(response)\n\n    data = content[\"data\"][\"userAvatarUpdate\"]\n    user.refresh_from_db()\n\n    assert user.avatar != avatar_mock\n    assert data[\"user\"][\"avatar\"][\"url\"].startswith(\n        \"http://testserver/media/user-avatars/new_image\"\n    )\n\n\nUSER_AVATAR_DELETE_MUTATION = \"\"\"\n    mutation userAvatarDelete {\n        userAvatarDelete {\n            user {\n                avatar {\n                    url\n                }\n            }\n        }\n    }\n\"\"\"\n\n\ndef test_user_avatar_delete_mutation_permission(api_client):\n    \"\"\"Should raise error if user is not staff.\"\"\"\n\n    query = USER_AVATAR_DELETE_MUTATION\n\n    response = api_client.post_graphql(query)\n\n    assert_no_permission(response)\n\n\ndef test_user_avatar_delete_mutation(staff_api_client):\n    query = USER_AVATAR_DELETE_MUTATION\n\n    user = staff_api_client.user\n\n    response = staff_api_client.post_graphql(query)\n    content = get_graphql_content(response)\n\n    user.refresh_from_db()\n\n    assert not user.avatar\n    assert not content[\"data\"][\"userAvatarDelete\"][\"user\"][\"avatar\"]\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"placedOrders\": {\"gte\": \"2019-04-18\"}}, 1),\n        ({\"placedOrders\": {\"lte\": \"2012-01-14\"}}, 1),\n        ({\"placedOrders\": {\"lte\": \"2012-01-14\", \"gte\": \"2012-01-13\"}}, 1),\n        ({\"placedOrders\": {\"gte\": \"2012-01-14\"}}, 2),\n    ],\n)\ndef test_query_customers_with_filter_placed_orders(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n    channel_USD,\n):\n    Order.objects.create(user=customer_user, channel=channel_USD)\n    second_customer = User.objects.create(email=\"second_example@example.com\")\n    with freeze_time(\"2012-01-14 11:00:00\"):\n        Order.objects.create(user=second_customer, channel=channel_USD)\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    assert len(users) == count\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"dateJoined\": {\"gte\": \"2019-04-18\"}}, 1),\n        ({\"dateJoined\": {\"lte\": \"2012-01-14\"}}, 1),\n        ({\"dateJoined\": {\"lte\": \"2012-01-14\", \"gte\": \"2012-01-13\"}}, 1),\n        ({\"dateJoined\": {\"gte\": \"2012-01-14\"}}, 2),\n        ({\"updatedAt\": {\"gte\": \"2012-01-14T10:59:00+00:00\"}}, 2),\n        ({\"updatedAt\": {\"gte\": \"2012-01-14T11:01:00+00:00\"}}, 1),\n        ({\"updatedAt\": {\"lte\": \"2012-01-14T12:00:00+00:00\"}}, 1),\n        ({\"updatedAt\": {\"lte\": \"2011-01-14T10:59:00+00:00\"}}, 0),\n        (\n            {\n                \"updatedAt\": {\n                    \"lte\": \"2012-01-14T12:00:00+00:00\",\n                    \"gte\": \"2012-01-14T10:00:00+00:00\",\n                }\n            },\n            1,\n        ),\n        ({\"updatedAt\": {\"gte\": \"2012-01-14T10:00:00+00:00\"}}, 2),\n    ],\n)\ndef test_query_customers_with_filter_date_joined_and_updated_at(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n):\n    with freeze_time(\"2012-01-14 11:00:00\"):\n        User.objects.create(email=\"second_example@example.com\")\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == count\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"numberOfOrders\": {\"gte\": 0, \"lte\": 1}}, 1),\n        ({\"numberOfOrders\": {\"gte\": 1, \"lte\": 3}}, 2),\n        ({\"numberOfOrders\": {\"gte\": 0}}, 2),\n        ({\"numberOfOrders\": {\"lte\": 3}}, 2),\n    ],\n)\ndef test_query_customers_with_filter_placed_orders_(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n    channel_USD,\n):\n    Order.objects.bulk_create(\n        [\n            Order(user=customer_user, token=str(uuid.uuid4()), channel=channel_USD),\n            Order(user=customer_user, token=str(uuid.uuid4()), channel=channel_USD),\n            Order(user=customer_user, token=str(uuid.uuid4()), channel=channel_USD),\n        ]\n    )\n    second_customer = User.objects.create(email=\"second_example@example.com\")\n    with freeze_time(\"2012-01-14 11:00:00\"):\n        Order.objects.create(user=second_customer, channel=channel_USD)\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    assert len(users) == count\n\n\ndef test_query_customers_with_filter_metadata(\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    customer_user,\n    channel_USD,\n):\n    second_customer = User.objects.create(email=\"second_example@example.com\")\n    second_customer.store_value_in_metadata({\"metakey\": \"metavalue\"})\n    second_customer.save()\n\n    variables = {\"filter\": {\"metadata\": [{\"key\": \"metakey\", \"value\": \"metavalue\"}]}}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == 1\n    user = users[0]\n    _, user_id = graphene.Node.from_global_id(user[\"node\"][\"id\"])\n    assert second_customer.id == int(user_id)\n\n\ndef test_query_customers_search_without_duplications(\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    permission_manage_orders,\n):\n    customer = User.objects.create(email=\"david@example.com\")\n    customer.addresses.create(first_name=\"David\")\n    customer.addresses.create(first_name=\"David\")\n    customer.search_document = prepare_user_search_document_value(customer)\n    customer.save(update_fields=[\"search_document\"])\n\n    variables = {\"filter\": {\"search\": \"David\"}}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == 1\n\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter,\n        variables,\n        permissions=[permission_manage_orders],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n    assert len(users) == 1\n\n\ndef test_query_customers_with_permission_manage_orders(\n    query_customer_with_filter,\n    customer_user,\n    staff_api_client,\n    permission_manage_orders,\n):\n    variables = {\"filter\": {}}\n\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter,\n        variables,\n        permissions=[permission_manage_orders],\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"totalCount\"]\n    assert users == 1\n\n\nQUERY_CUSTOMERS_WITH_SORT = \"\"\"\n    query ($sort_by: UserSortingInput!) {\n        customers(first:5, sortBy: $sort_by) {\n                edges{\n                    node{\n                        firstName\n                    }\n                }\n            }\n        }\n\"\"\"\n\n\n@pytest.mark.parametrize(\n    \"customer_sort, result_order\",\n    [\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"ASC\"}, [\"Joe\", \"John\", \"Leslie\"]),\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"John\", \"Joe\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"ASC\"}, [\"John\", \"Joe\", \"Leslie\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"Joe\", \"John\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"Joe\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"DESC\"}, [\"Joe\", \"Leslie\", \"John\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"Joe\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"DESC\"}, [\"Joe\", \"Leslie\", \"John\"]),\n    ],\n)\ndef test_query_customers_with_sort(\n    customer_sort, result_order, staff_api_client, permission_manage_users, channel_USD\n):\n    User.objects.bulk_create(\n        [\n            User(\n                first_name=\"John\",\n                last_name=\"Allen\",\n                email=\"allen@example.com\",\n                is_staff=False,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Joe\",\n                last_name=\"Doe\",\n                email=\"zordon01@example.com\",\n                is_staff=False,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Leslie\",\n                last_name=\"Wade\",\n                email=\"leslie@example.com\",\n                is_staff=False,\n                is_active=True,\n            ),\n        ]\n    )\n    Order.objects.create(\n        user=User.objects.get(email=\"zordon01@example.com\"), channel=channel_USD\n    )\n    variables = {\"sort_by\": customer_sort}\n    staff_api_client.user.user_permissions.add(permission_manage_users)\n    response = staff_api_client.post_graphql(QUERY_CUSTOMERS_WITH_SORT, variables)\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    for order, user_first_name in enumerate(result_order):\n        assert users[order][\"node\"][\"firstName\"] == user_first_name\n\n\n@pytest.mark.parametrize(\n    \"customer_filter, count\",\n    [\n        ({\"search\": \"mirumee.com\"}, 2),\n        ({\"search\": \"Alice\"}, 1),\n        ({\"search\": \"Kowalski\"}, 1),\n        ({\"search\": \"John\"}, 1),  # first_name\n        ({\"search\": \"Doe\"}, 1),  # last_name\n        ({\"search\": \"wroc\"}, 1),  # city\n        ({\"search\": \"pl\"}, 1),  # country\n        ({\"search\": \"+48713988102\"}, 1),\n        ({\"search\": \"alice Kowalski\"}, 1),\n        ({\"search\": \"kowalski alice\"}, 1),\n        ({\"search\": \"John doe\"}, 1),\n        ({\"search\": \"Alice Doe\"}, 0),\n    ],\n)\ndef test_query_customer_members_with_filter_search(\n    customer_filter,\n    count,\n    query_customer_with_filter,\n    staff_api_client,\n    permission_manage_users,\n    address,\n    staff_user,\n):\n    users = User.objects.bulk_create(\n        [\n            User(\n                email=\"second@mirumee.com\",\n                first_name=\"Alice\",\n                last_name=\"Kowalski\",\n                is_active=False,\n            ),\n            User(\n                email=\"third@mirumee.com\",\n                is_active=True,\n            ),\n        ]\n    )\n    users[1].addresses.set([address])\n\n    for user in users:\n        user.search_document = prepare_user_search_document_value(user)\n    User.objects.bulk_update(users, [\"search_document\"])\n\n    variables = {\"filter\": customer_filter}\n    response = staff_api_client.post_graphql(\n        query_customer_with_filter, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"customers\"][\"edges\"]\n\n    assert len(users) == count\n\n\n@pytest.mark.parametrize(\n    \"staff_member_filter, count\",\n    [({\"status\": \"DEACTIVATED\"}, 1), ({\"status\": \"ACTIVE\"}, 2)],\n)\ndef test_query_staff_members_with_filter_status(\n    staff_member_filter,\n    count,\n    query_staff_users_with_filter,\n    staff_api_client,\n    permission_manage_staff,\n    staff_user,\n):\n\n    User.objects.bulk_create(\n        [\n            User(email=\"second@example.com\", is_staff=True, is_active=False),\n            User(email=\"third@example.com\", is_staff=True, is_active=True),\n        ]\n    )\n\n    variables = {\"filter\": staff_member_filter}\n    response = staff_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n\n    assert len(users) == count\n\n\ndef test_query_staff_members_with_filter_by_ids(\n    query_staff_users_with_filter,\n    staff_api_client,\n    permission_manage_staff,\n    staff_user,\n):\n    # given\n    variables = {\n        \"filter\": {\n            \"ids\": [graphene.Node.to_global_id(\"User\", staff_user.pk)],\n        }\n    }\n\n    # when\n    response = staff_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n\n    # then\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n    assert len(users) == 1\n\n\ndef test_query_staff_members_app_no_permission(\n    query_staff_users_with_filter,\n    app_api_client,\n    permission_manage_staff,\n):\n\n    User.objects.bulk_create(\n        [\n            User(email=\"second@example.com\", is_staff=True, is_active=False),\n            User(email=\"third@example.com\", is_staff=True, is_active=True),\n        ]\n    )\n\n    variables = {\"filter\": {\"status\": \"DEACTIVATED\"}}\n    response = app_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n\n    assert_no_permission(response)\n\n\n@pytest.mark.parametrize(\n    \"staff_member_filter, count\",\n    [\n        ({\"search\": \"mirumee.com\"}, 2),\n        ({\"search\": \"alice\"}, 1),\n        ({\"search\": \"kowalski\"}, 1),\n        ({\"search\": \"John\"}, 1),  # first_name\n        ({\"search\": \"Doe\"}, 1),  # last_name\n        ({\"search\": \"irv\"}, 1),  # city\n        ({\"search\": \"us\"}, 1),  # country\n        ({\"search\": \"Alice Kowalski\"}, 1),\n        ({\"search\": \"Kowalski Alice\"}, 1),\n        ({\"search\": \"john doe\"}, 1),\n        ({\"search\": \"Alice Doe\"}, 0),\n    ],\n)\ndef test_query_staff_members_with_filter_search(\n    staff_member_filter,\n    count,\n    query_staff_users_with_filter,\n    staff_api_client,\n    permission_manage_staff,\n    address_usa,\n    staff_user,\n):\n    users = User.objects.bulk_create(\n        [\n            User(\n                email=\"second@mirumee.com\",\n                first_name=\"Alice\",\n                last_name=\"Kowalski\",\n                is_staff=True,\n                is_active=False,\n            ),\n            User(\n                email=\"third@mirumee.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n            User(\n                email=\"customer@mirumee.com\",\n                first_name=\"Alice\",\n                last_name=\"Kowalski\",\n                is_staff=False,\n                is_active=True,\n            ),\n        ]\n    )\n    users[1].addresses.set([address_usa])\n    for user in users:\n        user.search_document = prepare_user_search_document_value(user)\n    User.objects.bulk_update(users, [\"search_document\"])\n\n    variables = {\"filter\": staff_member_filter}\n    response = staff_api_client.post_graphql(\n        query_staff_users_with_filter, variables, permissions=[permission_manage_staff]\n    )\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n\n    assert len(users) == count\n\n\nQUERY_STAFF_USERS_WITH_SORT = \"\"\"\n    query ($sort_by: UserSortingInput!) {\n        staffUsers(first:5, sortBy: $sort_by) {\n                edges{\n                    node{\n                        firstName\n                    }\n                }\n            }\n        }\n\"\"\"\n\n\n@pytest.mark.parametrize(\n    \"customer_sort, result_order\",\n    [\n        # Empty string in result is first_name for staff_api_client.\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"ASC\"}, [\"\", \"Joe\", \"John\", \"Leslie\"]),\n        ({\"field\": \"FIRST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"John\", \"Joe\", \"\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"ASC\"}, [\"\", \"John\", \"Joe\", \"Leslie\"]),\n        ({\"field\": \"LAST_NAME\", \"direction\": \"DESC\"}, [\"Leslie\", \"Joe\", \"John\", \"\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"\", \"Joe\"]),\n        ({\"field\": \"EMAIL\", \"direction\": \"DESC\"}, [\"Joe\", \"\", \"Leslie\", \"John\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"ASC\"}, [\"John\", \"Leslie\", \"\", \"Joe\"]),\n        ({\"field\": \"ORDER_COUNT\", \"direction\": \"DESC\"}, [\"Joe\", \"\", \"Leslie\", \"John\"]),\n    ],\n)\ndef test_query_staff_members_with_sort(\n    customer_sort, result_order, staff_api_client, permission_manage_staff, channel_USD\n):\n    User.objects.bulk_create(\n        [\n            User(\n                first_name=\"John\",\n                last_name=\"Allen\",\n                email=\"allen@example.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Joe\",\n                last_name=\"Doe\",\n                email=\"zordon01@example.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n            User(\n                first_name=\"Leslie\",\n                last_name=\"Wade\",\n                email=\"leslie@example.com\",\n                is_staff=True,\n                is_active=True,\n            ),\n        ]\n    )\n    Order.objects.create(\n        user=User.objects.get(email=\"zordon01@example.com\"), channel=channel_USD\n    )\n    variables = {\"sort_by\": customer_sort}\n    staff_api_client.user.user_permissions.add(permission_manage_staff)\n    response = staff_api_client.post_graphql(QUERY_STAFF_USERS_WITH_SORT, variables)\n    content = get_graphql_content(response)\n    users = content[\"data\"][\"staffUsers\"][\"edges\"]\n\n    for order, user_first_name in enumerate(result_order):\n        assert users[order][\"node\"][\"firstName\"] == user_first_name\n\n\nUSER_CHANGE_ACTIVE_STATUS_MUTATION = \"\"\"\n    mutation userChangeActiveStatus($ids: [ID]!, $is_active: Boolean!) {\n        userBulkSetActive(ids: $ids, isActive: $is_active) {\n            count\n            errors {\n                field\n                message\n            }\n        }\n    }\n    \"\"\"\n\n\ndef test_staff_bulk_set_active(\n    staff_api_client, user_list_not_active, permission_manage_users\n):\n    users = user_list_not_active\n    active_status = True\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"count\"] == users.count()\n    users = User.objects.filter(pk__in=[user.pk for user in users])\n    assert all(user.is_active for user in users)\n\n\ndef test_staff_bulk_set_not_active(\n    staff_api_client, user_list, permission_manage_users\n):\n    users = user_list\n    active_status = False\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"count\"] == len(users)\n    users = User.objects.filter(pk__in=[user.pk for user in users])\n    assert not any(user.is_active for user in users)\n\n\ndef test_change_active_status_for_superuser(\n    staff_api_client, superuser, permission_manage_users\n):\n    users = [superuser]\n    superuser_id = graphene.Node.to_global_id(\"User\", superuser.id)\n    active_status = False\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"errors\"][0][\"field\"] == superuser_id\n    assert (\n        data[\"errors\"][0][\"message\"] == \"Cannot activate or deactivate \"\n        \"superuser's account.\"\n    )\n\n\ndef test_change_active_status_for_himself(staff_api_client, permission_manage_users):\n    users = [staff_api_client.user]\n    user_id = graphene.Node.to_global_id(\"User\", staff_api_client.user.id)\n    active_status = False\n    variables = {\n        \"ids\": [graphene.Node.to_global_id(\"User\", user.id) for user in users],\n        \"is_active\": active_status,\n    }\n    response = staff_api_client.post_graphql(\n        USER_CHANGE_ACTIVE_STATUS_MUTATION,\n        variables,\n        permissions=[permission_manage_users],\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"userBulkSetActive\"]\n    assert data[\"errors\"][0][\"field\"] == user_id\n    assert (\n        data[\"errors\"][0][\"message\"] == \"Cannot activate or deactivate \"\n        \"your own account.\"\n    )\n\n\nADDRESS_QUERY = \"\"\"\nquery address($id: ID!) {\n    address(id: $id) {\n        postalCode\n        lastName\n        firstName\n        city\n        country {\n          code\n        }\n    }\n}\n\"\"\"\n\n\ndef test_address_query_as_owner(user_api_client, customer_user):\n    address = customer_user.addresses.first()\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address.pk)}\n    response = user_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"address\"]\n    assert data[\"country\"][\"code\"] == address.country.code\n\n\ndef test_address_query_as_not_owner(\n    user_api_client, customer_user, address_other_country\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = user_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"address\"]\n    assert not data\n\n\ndef test_address_query_as_app_with_permission(\n    app_api_client,\n    address_other_country,\n    permission_manage_users,\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = app_api_client.post_graphql(\n        ADDRESS_QUERY, variables, permissions=[permission_manage_users]\n    )\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"address\"]\n    assert data[\"country\"][\"code\"] == address_other_country.country.code\n\n\ndef test_address_query_as_app_without_permission(\n    app_api_client, app, address_other_country\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = app_api_client.post_graphql(ADDRESS_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_address_query_as_anonymous_user(api_client, address_other_country):\n    variables = {\"id\": graphene.Node.to_global_id(\"Address\", address_other_country.pk)}\n    response = api_client.post_graphql(ADDRESS_QUERY, variables)\n    assert_no_permission(response)\n\n\ndef test_address_query_invalid_id(\n    staff_api_client,\n    address_other_country,\n):\n    id = \"..afs\"\n    variables = {\"id\": id}\n    response = staff_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content_from_response(response)\n    assert len(content[\"errors\"]) == 1\n    assert content[\"errors\"][0][\"message\"] == f\"Couldn't resolve id: {id}.\"\n    assert content[\"data\"][\"address\"] is None\n\n\ndef test_address_query_with_invalid_object_type(\n    staff_api_client,\n    address_other_country,\n):\n    variables = {\"id\": graphene.Node.to_global_id(\"Order\", address_other_country.pk)}\n    response = staff_api_client.post_graphql(ADDRESS_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"address\"] is None\n\n\nREQUEST_EMAIL_CHANGE_QUERY = \"\"\"\nmutation requestEmailChange(\n    $password: String!, $new_email: String!, $redirect_url: String!, $channel:String\n) {\n    requestEmailChange(\n        password: $password,\n        newEmail: $new_email,\n        redirectUrl: $redirect_url,\n        channel: $channel\n    ) {\n        user {\n            email\n        }\n        errors {\n            code\n            message\n            field\n        }\n  }\n}\n\"\"\"\n\n\ndef test_request_email_change(user_api_client, customer_user, channel_PLN):\n    variables = {\n        \"password\": \"password\",\n        \"new_email\": \"new_email@example.com\",\n        \"redirect_url\": \"http://www.example.com\",\n        \"channel\": channel_PLN.slug,\n    }\n\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert data[\"user\"][\"email\"] == customer_user.email\n\n\ndef test_request_email_change_to_existing_email(\n    user_api_client, customer_user, staff_user\n):\n    variables = {\n        \"password\": \"password\",\n        \"new_email\": staff_user.email,\n        \"redirect_url\": \"http://www.example.com\",\n    }\n\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"] == [\n        {\n            \"code\": \"UNIQUE\",\n            \"message\": \"Email is used by other user.\",\n            \"field\": \"newEmail\",\n        }\n    ]\n\n\ndef test_request_email_change_with_invalid_redirect_url(\n    user_api_client, customer_user, staff_user\n):\n    variables = {\n        \"password\": \"password\",\n        \"new_email\": \"new_email@example.com\",\n        \"redirect_url\": \"www.example.com\",\n    }\n\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"] == [\n        {\n            \"code\": \"INVALID\",\n            \"message\": \"Invalid URL. Please check if URL is in RFC 1808 format.\",\n            \"field\": \"redirectUrl\",\n        }\n    ]\n\n\ndef test_request_email_change_with_invalid_password(user_api_client, customer_user):\n    variables = {\n        \"password\": \"spanishinquisition\",\n        \"new_email\": \"new_email@example.com\",\n        \"redirect_url\": \"http://www.example.com\",\n    }\n    response = user_api_client.post_graphql(REQUEST_EMAIL_CHANGE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"requestEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"][0][\"code\"] == AccountErrorCode.INVALID_CREDENTIALS.name\n    assert data[\"errors\"][0][\"field\"] == \"password\"\n\n\nEMAIL_UPDATE_QUERY = \"\"\"\nmutation emailUpdate($token: String!, $channel: String) {\n    confirmEmailChange(token: $token, channel: $channel){\n        user {\n            email\n        }\n        errors {\n            code\n            message\n            field\n        }\n  }\n}\n\"\"\"\n\n\n@patch(\"saleor.graphql.account.mutations.account.match_orders_with_new_user\")\n@patch(\"saleor.graphql.account.mutations.account.assign_user_gift_cards\")\ndef test_email_update(\n    assign_gift_cards_mock,\n    assign_orders_mock,\n    user_api_client,\n    customer_user,\n    channel_PLN,\n):\n    new_email = \"new_email@example.com\"\n    payload = {\n        \"old_email\": customer_user.email,\n        \"new_email\": new_email,\n        \"user_pk\": customer_user.pk,\n    }\n    user = user_api_client.user\n\n    token = create_token(payload, timedelta(hours=1))\n    variables = {\"token\": token, \"channel\": channel_PLN.slug}\n\n    response = user_api_client.post_graphql(EMAIL_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"confirmEmailChange\"]\n    assert data[\"user\"][\"email\"] == new_email\n    user.refresh_from_db()\n    assert new_email in user.search_document\n    assign_gift_cards_mock.assert_called_once_with(customer_user)\n    assign_orders_mock.assert_called_once_with(customer_user)\n\n\ndef test_email_update_to_existing_email(user_api_client, customer_user, staff_user):\n    payload = {\n        \"old_email\": customer_user.email,\n        \"new_email\": staff_user.email,\n        \"user_pk\": customer_user.pk,\n    }\n    token = create_token(payload, timedelta(hours=1))\n    variables = {\"token\": token}\n\n    response = user_api_client.post_graphql(EMAIL_UPDATE_QUERY, variables)\n    content = get_graphql_content(response)\n    data = content[\"data\"][\"confirmEmailChange\"]\n    assert not data[\"user\"]\n    assert data[\"errors\"] == [\n        {\n            \"code\": \"UNIQUE\",\n            \"message\": \"Email is used by other user.\",\n            \"field\": \"newEmail\",\n        }\n    ]\n\n\nUSER_FEDERATION_QUERY = \"\"\"\n  query GetUserInFederation($representations: [_Any]) {\n    _entities(representations: $representations) {\n      __typename\n      ... on User {\n        id\n        email\n      }\n    }\n  }\n\"\"\"\n\n\ndef test_staff_query_user_by_id_for_federation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_staff_query_user_by_email_for_federation(\n    staff_api_client, customer_user, permission_manage_users\n):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_staff_query_user_by_id_without_permission_for_federation(\n    staff_api_client, customer_user\n):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(USER_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_staff_query_user_by_email_without_permission_for_federation(\n    staff_api_client, customer_user\n):\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(USER_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_customer_query_self_by_id_for_federation(user_api_client, customer_user):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_customer_query_self_by_email_for_federation(user_api_client, customer_user):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"User\",\n            \"id\": customer_user_id,\n            \"email\": customer_user.email,\n        }\n    ]\n\n\ndef test_customer_query_user_by_id_for_federation(\n    user_api_client, customer_user, staff_user\n):\n    staff_user_id = graphene.Node.to_global_id(\"User\", staff_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": staff_user_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_customer_query_user_by_email_for_federation(\n    user_api_client, customer_user, staff_user\n):\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": staff_user.email,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_user_by_id_for_federation(api_client, customer_user):\n    customer_user_id = graphene.Node.to_global_id(\"User\", customer_user.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"id\": customer_user_id,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_user_by_email_for_federation(api_client, customer_user):\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"User\",\n                \"email\": customer_user.email,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(\n        USER_FEDERATION_QUERY,\n        variables,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\nADDRESS_FEDERATION_QUERY = \"\"\"\n  query GetUserInFederation($representations: [_Any]) {\n    _entities(representations: $representations) {\n      __typename\n      ... on Address {\n        id\n        city\n      }\n    }\n  }\n\"\"\"\n\n\ndef test_customer_query_address_federation(user_api_client, customer_user, address):\n    customer_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Address\",\n            \"id\": address_id,\n            \"city\": address.city,\n        }\n    ]\n\n\ndef test_customer_query_other_user_address_federation(\n    user_api_client, staff_user, customer_user, address\n):\n    staff_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_staff_query_other_user_address_federation(\n    staff_api_client, customer_user, address\n):\n    customer_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_staff_query_other_user_address_with_permission_federation(\n    staff_api_client, customer_user, address, permission_manage_users\n):\n    customer_user.addresses.add(address)\n\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        ADDRESS_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_app_query_address_federation(app_api_client, address, permission_manage_users):\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(\n        ADDRESS_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_users],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Address\",\n            \"id\": address_id,\n            \"city\": address.city,\n        }\n    ]\n\n\ndef test_app_no_permission_query_address_federation(app_api_client, address):\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_address_federation(api_client, address):\n    address_id = graphene.Node.to_global_id(\"Address\", address.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Address\",\n                \"id\": address_id,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(ADDRESS_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\nGROUP_FEDERATION_QUERY = \"\"\"\n  query GetGroupInFederation($representations: [_Any]) {\n    _entities(representations: $representations) {\n      __typename\n      ... on Group {\n        id\n        name\n      }\n    }\n  }\n\"\"\"\n\n\ndef test_staff_query_group_federation(staff_api_client, permission_manage_staff):\n    group = Group.objects.create(name=\"empty group\")\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = staff_api_client.post_graphql(\n        GROUP_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_staff],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Group\",\n            \"id\": group_id,\n            \"name\": group.name,\n        }\n    ]\n\n\ndef test_app_query_group_federation(app_api_client, permission_manage_staff):\n    group = Group.objects.create(name=\"empty group\")\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(\n        GROUP_FEDERATION_QUERY,\n        variables,\n        permissions=[permission_manage_staff],\n        check_no_permissions=False,\n    )\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [\n        {\n            \"__typename\": \"Group\",\n            \"id\": group_id,\n            \"name\": group.name,\n        }\n    ]\n\n\ndef test_app_no_permission_query_group_federation(app_api_client):\n    group = Group.objects.create(name=\"empty group\")\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = app_api_client.post_graphql(GROUP_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_client_query_group_federation(user_api_client):\n    group = Group.objects.create(name=\"empty group\")\n\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = user_api_client.post_graphql(GROUP_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n\n\ndef test_unauthenticated_query_group_federation(api_client):\n    group = Group.objects.create(name=\"empty group\")\n\n    group_id = graphene.Node.to_global_id(\"Group\", group.pk)\n    variables = {\n        \"representations\": [\n            {\n                \"__typename\": \"Group\",\n                \"id\": group_id,\n            },\n        ],\n    }\n\n    response = api_client.post_graphql(GROUP_FEDERATION_QUERY, variables)\n    content = get_graphql_content(response)\n    assert content[\"data\"][\"_entities\"] == [None]\n", "from typing import List\n\nimport graphene\nfrom django.contrib.auth import get_user_model\nfrom django.contrib.auth import models as auth_models\nfrom graphene import relay\n\nfrom ...account import models\nfrom ...checkout.utils import get_user_checkout\nfrom ...core.exceptions import PermissionDenied\nfrom ...core.permissions import AccountPermissions, AppPermission, OrderPermissions\nfrom ...core.tracing import traced_resolver\nfrom ...order import OrderStatus\nfrom ..account.utils import requestor_has_access\nfrom ..app.dataloaders import AppByIdLoader\nfrom ..app.types import App\nfrom ..checkout.dataloaders import CheckoutByUserAndChannelLoader, CheckoutByUserLoader\nfrom ..checkout.types import Checkout\nfrom ..core.connection import CountableConnection, create_connection_slice\nfrom ..core.descriptions import DEPRECATED_IN_3X_FIELD\nfrom ..core.enums import LanguageCodeEnum\nfrom ..core.federation import federated_entity, resolve_federation_references\nfrom ..core.fields import ConnectionField\nfrom ..core.scalars import UUID\nfrom ..core.types import CountryDisplay, Image, ModelObjectType, Permission\nfrom ..core.utils import from_global_id_or_error, str_to_enum\nfrom ..decorators import one_of_permissions_required, permission_required\nfrom ..giftcard.dataloaders import GiftCardsByUserLoader\nfrom ..meta.types import ObjectWithMetadata\nfrom ..order.dataloaders import OrderLineByIdLoader, OrdersByUserLoader\nfrom ..utils import format_permissions_for_display, get_user_or_app_from_context\nfrom .dataloaders import CustomerEventsByUserLoader\nfrom .enums import CountryCodeEnum, CustomerEventsEnum\nfrom .utils import can_user_manage_group, get_groups_which_user_can_manage\n\n\nclass AddressInput(graphene.InputObjectType):\n    first_name = graphene.String(description=\"Given name.\")\n    last_name = graphene.String(description=\"Family name.\")\n    company_name = graphene.String(description=\"Company or organization.\")\n    street_address_1 = graphene.String(description=\"Address.\")\n    street_address_2 = graphene.String(description=\"Address.\")\n    city = graphene.String(description=\"City.\")\n    city_area = graphene.String(description=\"District.\")\n    postal_code = graphene.String(description=\"Postal code.\")\n    country = CountryCodeEnum(description=\"Country.\")\n    country_area = graphene.String(description=\"State or province.\")\n    phone = graphene.String(description=\"Phone number.\")\n\n\n@federated_entity(\"id\")\nclass Address(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    first_name = graphene.String(required=True)\n    last_name = graphene.String(required=True)\n    company_name = graphene.String(required=True)\n    street_address_1 = graphene.String(required=True)\n    street_address_2 = graphene.String(required=True)\n    city = graphene.String(required=True)\n    city_area = graphene.String(required=True)\n    postal_code = graphene.String(required=True)\n    country = graphene.Field(\n        CountryDisplay, required=True, description=\"Shop's default country.\"\n    )\n    country_area = graphene.String(required=True)\n    phone = graphene.String()\n    is_default_shipping_address = graphene.Boolean(\n        required=False, description=\"Address is user's default shipping address.\"\n    )\n    is_default_billing_address = graphene.Boolean(\n        required=False, description=\"Address is user's default billing address.\"\n    )\n\n    class Meta:\n        description = \"Represents user address data.\"\n        interfaces = [relay.Node]\n        model = models.Address\n\n    @staticmethod\n    def resolve_country(root: models.Address, _info):\n        return CountryDisplay(code=root.country.code, country=root.country.name)\n\n    @staticmethod\n    def resolve_is_default_shipping_address(root: models.Address, _info):\n        \"\"\"Look if the address is the default shipping address of the user.\n\n        This field is added through annotation when using the\n        `resolve_addresses` resolver. It's invalid for\n        `resolve_default_shipping_address` and\n        `resolve_default_billing_address`\n        \"\"\"\n        if not hasattr(root, \"user_default_shipping_address_pk\"):\n            return None\n\n        user_default_shipping_address_pk = getattr(\n            root, \"user_default_shipping_address_pk\"\n        )\n        if user_default_shipping_address_pk == root.pk:\n            return True\n        return False\n\n    @staticmethod\n    def resolve_is_default_billing_address(root: models.Address, _info):\n        \"\"\"Look if the address is the default billing address of the user.\n\n        This field is added through annotation when using the\n        `resolve_addresses` resolver. It's invalid for\n        `resolve_default_shipping_address` and\n        `resolve_default_billing_address`\n        \"\"\"\n        if not hasattr(root, \"user_default_billing_address_pk\"):\n            return None\n\n        user_default_billing_address_pk = getattr(\n            root, \"user_default_billing_address_pk\"\n        )\n        if user_default_billing_address_pk == root.pk:\n            return True\n        return False\n\n    @staticmethod\n    def __resolve_references(roots: List[\"Address\"], info, **_kwargs):\n        from .resolvers import resolve_addresses\n\n        root_ids = [root.id for root in roots]\n        addresses = {\n            address.id: address for address in resolve_addresses(info, root_ids)\n        }\n\n        result = []\n        for root_id in root_ids:\n            _, root_id = from_global_id_or_error(root_id, Address)\n            result.append(addresses.get(int(root_id)))\n        return result\n\n\nclass CustomerEvent(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    date = graphene.types.datetime.DateTime(\n        description=\"Date when event happened at in ISO 8601 format.\"\n    )\n    type = CustomerEventsEnum(description=\"Customer event type.\")\n    user = graphene.Field(lambda: User, description=\"User who performed the action.\")\n    app = graphene.Field(App, description=\"App that performed the action.\")\n    message = graphene.String(description=\"Content of the event.\")\n    count = graphene.Int(description=\"Number of objects concerned by the event.\")\n    order = graphene.Field(\n        \"saleor.graphql.order.types.Order\", description=\"The concerned order.\"\n    )\n    order_line = graphene.Field(\n        \"saleor.graphql.order.types.OrderLine\", description=\"The concerned order line.\"\n    )\n\n    class Meta:\n        description = \"History log of the customer.\"\n        interfaces = [relay.Node]\n        model = models.CustomerEvent\n\n    @staticmethod\n    def resolve_user(root: models.CustomerEvent, info):\n        user = info.context.user\n        if (\n            user == root.user\n            or user.has_perm(AccountPermissions.MANAGE_USERS)\n            or user.has_perm(AccountPermissions.MANAGE_STAFF)\n        ):\n            return root.user\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_app(root: models.CustomerEvent, info):\n        requestor = get_user_or_app_from_context(info.context)\n        if requestor_has_access(requestor, root.user, AppPermission.MANAGE_APPS):\n            return (\n                AppByIdLoader(info.context).load(root.app_id) if root.app_id else None\n            )\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_message(root: models.CustomerEvent, _info):\n        return root.parameters.get(\"message\", None)\n\n    @staticmethod\n    def resolve_count(root: models.CustomerEvent, _info):\n        return root.parameters.get(\"count\", None)\n\n    @staticmethod\n    def resolve_order_line(root: models.CustomerEvent, info):\n        if \"order_line_pk\" in root.parameters:\n            return OrderLineByIdLoader(info.context).load(\n                root.parameters[\"order_line_pk\"]\n            )\n        return None\n\n\nclass UserPermission(Permission):\n    source_permission_groups = graphene.List(\n        graphene.NonNull(\"saleor.graphql.account.types.Group\"),\n        description=\"List of user permission groups which contains this permission.\",\n        user_id=graphene.Argument(\n            graphene.ID,\n            description=\"ID of user whose groups should be returned.\",\n            required=True,\n        ),\n        required=False,\n    )\n\n    @traced_resolver\n    def resolve_source_permission_groups(root: Permission, _info, user_id, **_kwargs):\n        _type, user_id = from_global_id_or_error(user_id, only_type=\"User\")\n        groups = auth_models.Group.objects.filter(\n            user__pk=user_id, permissions__name=root.name\n        )\n        return groups\n\n\n@federated_entity(\"id\")\n@federated_entity(\"email\")\nclass User(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    email = graphene.String(required=True)\n    first_name = graphene.String(required=True)\n    last_name = graphene.String(required=True)\n    is_staff = graphene.Boolean(required=True)\n    is_active = graphene.Boolean(required=True)\n    addresses = graphene.List(Address, description=\"List of all user's addresses.\")\n    checkout = graphene.Field(\n        Checkout,\n        description=\"Returns the last open checkout of this user.\",\n        deprecation_reason=(\n            f\"{DEPRECATED_IN_3X_FIELD} \"\n            \"Use the `checkout_tokens` field to fetch the user checkouts.\"\n        ),\n    )\n    checkout_tokens = graphene.List(\n        graphene.NonNull(UUID),\n        description=\"Returns the checkout UUID's assigned to this user.\",\n        channel=graphene.String(\n            description=\"Slug of a channel for which the data should be returned.\"\n        ),\n    )\n    gift_cards = ConnectionField(\n        \"saleor.graphql.giftcard.types.GiftCardCountableConnection\",\n        description=\"List of the user gift cards.\",\n    )\n    note = graphene.String(description=\"A note about the customer.\")\n    orders = ConnectionField(\n        \"saleor.graphql.order.types.OrderCountableConnection\",\n        description=\"List of user's orders.\",\n    )\n    user_permissions = graphene.List(\n        UserPermission, description=\"List of user's permissions.\"\n    )\n    permission_groups = graphene.List(\n        \"saleor.graphql.account.types.Group\",\n        description=\"List of user's permission groups.\",\n    )\n    editable_groups = graphene.List(\n        \"saleor.graphql.account.types.Group\",\n        description=\"List of user's permission groups which user can manage.\",\n    )\n    avatar = graphene.Field(Image, size=graphene.Int(description=\"Size of the avatar.\"))\n    events = graphene.List(\n        CustomerEvent, description=\"List of events associated with the user.\"\n    )\n    stored_payment_sources = graphene.List(\n        \"saleor.graphql.payment.types.PaymentSource\",\n        description=\"List of stored payment sources.\",\n        channel=graphene.String(\n            description=\"Slug of a channel for which the data should be returned.\"\n        ),\n    )\n    language_code = graphene.Field(\n        LanguageCodeEnum, description=\"User language code.\", required=True\n    )\n    default_shipping_address = graphene.Field(Address)\n    default_billing_address = graphene.Field(Address)\n\n    last_login = graphene.DateTime()\n    date_joined = graphene.DateTime(required=True)\n    updated_at = graphene.DateTime(required=True)\n\n    class Meta:\n        description = \"Represents user data.\"\n        interfaces = [relay.Node, ObjectWithMetadata]\n        model = get_user_model()\n\n    @staticmethod\n    def resolve_addresses(root: models.User, _info, **_kwargs):\n        return root.addresses.annotate_default(root).all()  # type: ignore\n\n    @staticmethod\n    def resolve_checkout(root: models.User, _info, **_kwargs):\n        return get_user_checkout(root)\n\n    @staticmethod\n    @traced_resolver\n    def resolve_checkout_tokens(root: models.User, info, channel=None, **_kwargs):\n        def return_checkout_tokens(checkouts):\n            if not checkouts:\n                return []\n            checkout_global_ids = []\n            for checkout in checkouts:\n                checkout_global_ids.append(checkout.token)\n            return checkout_global_ids\n\n        if not channel:\n            return (\n                CheckoutByUserLoader(info.context)\n                .load(root.id)\n                .then(return_checkout_tokens)\n            )\n        return (\n            CheckoutByUserAndChannelLoader(info.context)\n            .load((root.id, channel))\n            .then(return_checkout_tokens)\n        )\n\n    @staticmethod\n    def resolve_gift_cards(root: models.User, info, **kwargs):\n        from ..giftcard.types import GiftCardCountableConnection\n\n        def _resolve_gift_cards(gift_cards):\n            return create_connection_slice(\n                gift_cards, info, kwargs, GiftCardCountableConnection\n            )\n\n        return (\n            GiftCardsByUserLoader(info.context).load(root.id).then(_resolve_gift_cards)\n        )\n\n    @staticmethod\n    def resolve_user_permissions(root: models.User, _info, **_kwargs):\n        from .resolvers import resolve_permissions\n\n        return resolve_permissions(root)\n\n    @staticmethod\n    def resolve_permission_groups(root: models.User, _info, **_kwargs):\n        return root.groups.all()\n\n    @staticmethod\n    def resolve_editable_groups(root: models.User, _info, **_kwargs):\n        return get_groups_which_user_can_manage(root)\n\n    @staticmethod\n    @one_of_permissions_required(\n        [AccountPermissions.MANAGE_USERS, AccountPermissions.MANAGE_STAFF]\n    )\n    def resolve_note(root: models.User, info):\n        return root.note\n\n    @staticmethod\n    @one_of_permissions_required(\n        [AccountPermissions.MANAGE_USERS, AccountPermissions.MANAGE_STAFF]\n    )\n    def resolve_events(root: models.User, info):\n        return CustomerEventsByUserLoader(info.context).load(root.id)\n\n    @staticmethod\n    def resolve_orders(root: models.User, info, **kwargs):\n        from ..order.types import OrderCountableConnection\n\n        def _resolve_orders(orders):\n            requester = get_user_or_app_from_context(info.context)\n            if not requester.has_perm(OrderPermissions.MANAGE_ORDERS):\n                # allow fetch requestor orders (except drafts)\n                if root == info.context.user:\n                    orders = list(\n                        filter(lambda order: order.status != OrderStatus.DRAFT, orders)\n                    )\n                else:\n                    raise PermissionDenied()\n\n            return create_connection_slice(\n                orders, info, kwargs, OrderCountableConnection\n            )\n\n        return OrdersByUserLoader(info.context).load(root.id).then(_resolve_orders)\n\n    @staticmethod\n    def resolve_avatar(root: models.User, info, size=None, **_kwargs):\n        if root.avatar:\n            return Image.get_adjusted(\n                image=root.avatar,\n                alt=None,\n                size=size,\n                rendition_key_set=\"user_avatars\",\n                info=info,\n            )\n\n    @staticmethod\n    def resolve_stored_payment_sources(root: models.User, info, channel=None):\n        from .resolvers import resolve_payment_sources\n\n        if root == info.context.user:\n            return resolve_payment_sources(info, root, channel_slug=channel)\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_language_code(root, _info, **_kwargs):\n        return LanguageCodeEnum[str_to_enum(root.language_code)]\n\n    @staticmethod\n    def __resolve_references(roots: List[\"User\"], info, **_kwargs):\n        from .resolvers import resolve_users\n\n        ids = set()\n        emails = set()\n        for root in roots:\n            if root.id is not None:\n                ids.add(root.id)\n            else:\n                emails.add(root.email)\n\n        users = list(resolve_users(info, ids=ids, emails=emails))\n        users_by_id = {user.id: user for user in users}\n        users_by_email = {user.email: user for user in users}\n\n        results = []\n        for root in roots:\n            if root.id is not None:\n                _, user_id = from_global_id_or_error(root.id, User)\n                results.append(users_by_id.get(int(user_id)))\n            else:\n                results.append(users_by_email.get(root.email))\n        return results\n\n\nclass UserCountableConnection(CountableConnection):\n    class Meta:\n        node = User\n\n\nclass ChoiceValue(graphene.ObjectType):\n    raw = graphene.String()\n    verbose = graphene.String()\n\n\nclass AddressValidationData(graphene.ObjectType):\n    country_code = graphene.String()\n    country_name = graphene.String()\n    address_format = graphene.String()\n    address_latin_format = graphene.String()\n    allowed_fields = graphene.List(graphene.String)\n    required_fields = graphene.List(graphene.String)\n    upper_fields = graphene.List(graphene.String)\n    country_area_type = graphene.String()\n    country_area_choices = graphene.List(ChoiceValue)\n    city_type = graphene.String()\n    city_choices = graphene.List(ChoiceValue)\n    city_area_type = graphene.String()\n    city_area_choices = graphene.List(ChoiceValue)\n    postal_code_type = graphene.String()\n    postal_code_matchers = graphene.List(graphene.String)\n    postal_code_examples = graphene.List(graphene.String)\n    postal_code_prefix = graphene.String()\n\n\nclass StaffNotificationRecipient(graphene.ObjectType):\n    id = graphene.ID(required=True)\n    user = graphene.Field(\n        User,\n        description=\"Returns a user subscribed to email notifications.\",\n        required=False,\n    )\n    email = graphene.String(\n        description=(\n            \"Returns email address of a user subscribed to email notifications.\"\n        ),\n        required=False,\n    )\n    active = graphene.Boolean(description=\"Determines if a notification active.\")\n\n    class Meta:\n        description = (\n            \"Represents a recipient of email notifications send by Saleor, \"\n            \"such as notifications about new orders. Notifications can be \"\n            \"assigned to staff users or arbitrary email addresses.\"\n        )\n        interfaces = [relay.Node]\n        model = models.StaffNotificationRecipient\n\n    @staticmethod\n    def get_node(info, id):\n        try:\n            return models.StaffNotificationRecipient.objects.get(pk=id)\n        except models.StaffNotificationRecipient.DoesNotExist:\n            return None\n\n    @staticmethod\n    def resolve_user(root: models.StaffNotificationRecipient, info):\n        user = info.context.user\n        if user == root.user or user.has_perm(AccountPermissions.MANAGE_STAFF):\n            return root.user\n        raise PermissionDenied()\n\n    @staticmethod\n    def resolve_email(root: models.StaffNotificationRecipient, _info):\n        return root.get_email()\n\n\n@federated_entity(\"id\")\nclass Group(ModelObjectType):\n    id = graphene.GlobalID(required=True)\n    name = graphene.String(required=True)\n    users = graphene.List(User, description=\"List of group users\")\n    permissions = graphene.List(Permission, description=\"List of group permissions\")\n    user_can_manage = graphene.Boolean(\n        required=True,\n        description=(\n            \"True, if the currently authenticated user has rights to manage a group.\"\n        ),\n    )\n\n    class Meta:\n        description = \"Represents permission group data.\"\n        interfaces = [relay.Node]\n        model = auth_models.Group\n\n    @staticmethod\n    @permission_required(AccountPermissions.MANAGE_STAFF)\n    def resolve_users(root: auth_models.Group, _info):\n        return root.user_set.all()\n\n    @staticmethod\n    def resolve_permissions(root: auth_models.Group, _info):\n        permissions = root.permissions.prefetch_related(\"content_type\").order_by(\n            \"codename\"\n        )\n        return format_permissions_for_display(permissions)\n\n    @staticmethod\n    def resolve_user_can_manage(root: auth_models.Group, info):\n        user = info.context.user\n        return can_user_manage_group(user, root)\n\n    @staticmethod\n    def __resolve_references(roots: List[\"Group\"], info, **_kwargs):\n        from .resolvers import resolve_permission_groups\n\n        requestor = get_user_or_app_from_context(info.context)\n        if not requestor.has_perm(AccountPermissions.MANAGE_STAFF):\n            qs = auth_models.Group.objects.none()\n        else:\n            qs = resolve_permission_groups(info)\n\n        return resolve_federation_references(Group, roots, qs)\n\n\nclass GroupCountableConnection(CountableConnection):\n    class Meta:\n        node = Group\n"], "filenames": ["CHANGELOG.md", "saleor/graphql/account/tests/benchmark/test_account.py", "saleor/graphql/account/tests/test_account.py", "saleor/graphql/account/types.py"], "buggy_code_start_loc": [8, 108, 183, 367], "buggy_code_end_loc": [8, 359, 1017, 370], "fixing_code_start_loc": [9, 108, 184, 367], "fixing_code_end_loc": [12, 364, 1098, 374], "type": "CWE-863", "message": "Improper Authorization in GitHub repository saleor/saleor prior to 3.1.2.", "other": {"cve": {"id": "CVE-2022-0932", "sourceIdentifier": "security@huntr.dev", "published": "2022-03-11T15:15:09.857", "lastModified": "2022-03-18T15:54:05.863", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Improper Authorization in GitHub repository saleor/saleor prior to 3.1.2."}, {"lang": "es", "value": "Una Autorizaci\u00f3n Inapropiada en el repositorio GitHub saleor/saleor versiones anteriores a 3.1.2"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 6.5, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:N/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 4.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-863"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-285"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:saleor:saleor:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.1.2", "matchCriteriaId": "41F39D73-015E-4F84-8E41-7B28FED5949C"}]}]}], "references": [{"url": "https://github.com/saleor/saleor/commit/521dfd6394f3926a77c60d8633c058e16d0f916d", "source": "security@huntr.dev", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://huntr.dev/bounties/88ae4cbc-c697-401b-8b04-7dc4e03ad8eb", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/saleor/saleor/commit/521dfd6394f3926a77c60d8633c058e16d0f916d"}}