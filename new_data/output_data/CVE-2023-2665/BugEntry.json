{"buggy_code": ["# CHANGES\n## RosarioSIS Student Information System\n\nChanges in 11.0\n---------------\n- Add Weight Assignments option in Grades/Configuration.php, Assignments.php & MassCreateAssignments.php\n- Add Weight field in Assignments.php & MassCreateAssignments.php\n- Calculate Weighted Grade in Grades.php, InputFinalGrades.php & ProgressReports.php\n- Add Assignment Weight in StudentGrades.php & StudentAssignments.fnc.php\n- Translate \"Zip\" & \"Zipcode\" to \"Zip Code\" in GetStuList.fnc.php, MyReport.php, Registration.fnc.php, Schools.php & Address.inc.php\n- HTML Text input min size is 2 in Inputs.php\n- Skip School Period column if has no students scheduled for selected date in Administration.php\n\nChanges in 10.9.3\n-----------------\n- Security Fix browser loading cached page when page full reload (F5) + logout + Back button in warehouse.js, thanks to @b1tch3s\n\nChanges in 10.9.2\n-----------------\n- Fix Format Contact Field value based on its Type in ViewContact.php\n- Fix regression add Contact Info columns to list in MyReport.php\n- ETag + Cache-Control header: use no-cache directive in Warehouse.php\n- Set `$_SESSION['is_secondary_teacher']` in SetUserCoursePeriod() in Current.php\n- Fix Set current User Course Period before Secondary Teacher logic in TakeAttendance.php, AnomalousGrades.php, Assignments.php, Grades.php, InputFinalGrades.php & ProgressReports.php\n- SQL Show Gradebook Grades of Inactive Students (Only if has grades) in StudentGrades.php\n\nChanges in 10.9.1\n-----------------\n- Fix Anonymous Statistics bar overflow in StudentGrades.php\n- SQL Show Gradebook Grades of Inactive Students (Course status, maybe dropped as of today) in StudentGrades.php\n- Show Gradebook Grades of Inactive Students (School status) in StudentGrades.php\n- Fix PHP error if date.timezone ini setting is an invalid time zone identifier in Warehouse.php\n\nChanges in 10.9\n---------------\n- Fix do not add new Enrollment Record if existing has no Dropped date in Student.php, Enrollment.inc.php & SaveEnrollment.fnc.php\n- Enrollment Start: No N/A option for first entry in StudentsUsersInfo.fnc.php\n- Hide End Date input for Inactive Students (no Attendance Start Date) in StudentsUsersInfo.fnc.php\n- SQL ORDER BY DEFAULT_CALENDAR IS NULL,DEFAULT_CALENDAR ASC (nulls first) for consistency between PostgreSQL & MySQL in Courses.fnc.php, Calendar.php & Enrollment.inc.php\n- Simplify & harmonize code, use GetAllMP() in GPARankList.php, InputFinalGrades.php & TeacherCompletion.php\n- Exclude already associated parents/students from Search() in AddUsers.php & AddStudents.php\n- Replace \"Course Title\" in TipMessage with actual Course title in Attendance/, Eligibility/ & Grades/TeacherCompletion.php\n- Handle multiple Course Periods on the same Period for same Teacher in Attendance/ & Eligibility/TeacherCompletion.php\n- JS Remove \"Go\" button & submit form on select change in Eligibility/TeacherCompletion.php\n- Add SetUserCoursePeriod() function in Current.php\n- Set current User Course Period using SetUserCoursePeriod() in Side.php, TakeAttendance.php, EnterEligibility.php, AnomalousGrades.php, Assignments.php, Grades.php, InputFinalGrades.php, ProgressReports.php & TeacherPrograms.php\n- Add `'&period=' . UserCoursePeriod()` to Teacher form URL in TakeAttendance.php, EnterEligibility.php, Assignments.php, Grades.php, InputFinalGrades.php, ProgressReports.php, StudentAssignments.fnc.php & Portal.php\n- Remove period from URL when switching School / Year / MP / CP in Side.php\n- HTML Rename \"period\" select input ID to \"school_period\" to avoid conflicts in Attendance/, Eligibility/, Food_Service/ & Grades/TeacherCompletion.php\n- CSS Add modname class, ie .modname-grades-reportcards-php for modname=Grades/ReportCards.php in PDF.php\n- CSS Add .list-column-[column_name] class in ListOutput.fnc.php\n- CSS Set Report Cards Comments column (max) width to 33% in wkhtmltopdf.css\n- Temporary AllowEdit so SelectInput() is displayed to everyone in DailyTransactions.php\n- SQL ORDER BY Assignment Type first, then order Assignments in Grades.php\n- Remove $count & $has_count_text variables in ListOutput.fnc.php\n- Add pagination option (defaults to false) in ListOutput.fnc.php\n- Add pagination for list > 1000 results in AccessLog.php & ReportCardGrades.php\n- SQL gradebook_assignments table: Add WEIGHT column in Update.fnc.php, rosariosis.sql & rosariosis_mysql.sql\n- Fix security issue, unset any FILE_ATTACHED column first in PortalNotes.php\n- Use `_makeAutoSelectInputX()` for Contact Information Description in Address.inc.php\n- SQL courses ORDER BY TITLE in Requests.php\n- HTML remove \"Add a Request\" & hide \"Subject\" input label in Requests.php\n- Update command to install wkhtmltopdf & dependencies in INSTALL.md\n- Add link to Softaculous installation directions in INSTALL.md\n- Fix wkhtmltopdf not rendering URL in CSS in PDF.php\n- CSS Fix breaking words inside .header2 in stylesheet.css\n- SQL set N/A grade GPA to NULL in rosariosis.sql, rosariosis_es.sql, rosariosis_fr.sql & rosariosis_mysql.sql\n- Add Portuguese (Brazil) translation in InstallDatabase.php, REFERENCE.md, locale/pt_BR.utf8/ & rosariosis_pt_BR.sql, thanks to Emerson Barros\n\nChanges in 10.8.5\n-----------------\n- Fix \"Folder not writable\" error on add-on zip upload in Modules.inc.php & Plugins.inc.php\n\nChanges in 10.8.4\n-----------------\n- Fix SQL error escape menu title in DailyMenus.php, ServeMenus.php\n- Fix MySQL date interval in Food_Service/Students/ServeMenus.php\n- SQL order Transactions by ID in Transactions.php\n- Fix regression since 10.6.2 SQL error invalid reference to FROM-clause entry for table \"ssm\" in Widget.php\n- Fix do not set empty Grade Points to 0 in Grades.php\n- Fix save multiple SelectInput() when none selected, add hidden empty input in Inputs.php\n- Fix check if Available Seats < selected students calculation in MassSchedule.php\n- SQL order Requests by Course in Requests.php\n- CSS set minimum colorBox width to 50% view width in StudentGrades.php\n- Fix SQL error when Phone > 30 chars in Address.inc.php\n- If City length > 22 without space, force stackable table in Address.inc.php\n- CSS responsive stack Address & Contacts table below Laptop MDPI screen in zresponsive.css\n- Fix PHP fatal error Unsupported operand types: string - int when not a date in Date.php\n- Fix do not display Rollover default check warning if modfunc=remove in EnrollmentCodes.php\n- Fix check for Description & Value when saving new Contact Information in Address.inc.php\n\nChanges in 10.8.3\n-----------------\n- Add assets/FileUploads/ directory\n- Fix regression since 10.8.2 PHP fatal error $timestamp is not a valid date-time string in StudentAssignments.fnc.php\n- Catch strftime_compat() exception $timestamp is not a valid date-time string in Date.php\n\nChanges in 10.8.2\n-----------------\n- PHP<7 Fix add microseconds to filename to make it harder to predict in StudentAssignments.fnc.php, thanks to @jeffreygaor\n- Add datetime to filename to make it harder to predict in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- HTML add maxlength to Field Category & Name inputs in Fields.fnc.php\n- Do not check username uniqueness if empty in Student.php & User.php\n- CSS FLatSIS adjust fieldset border color & MD to HTML line-height in colors.css & stylesheet.css\n- Fix MySQL 8 syntax error, 'rank' is a reserved keyword in rosariosis_mysql.sql\n- Add MySQL global setting to allow function creation in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.8.1\n-----------------\n- Use CheckBoxOnclick() in StudentBalances.php & Schedule.inc.php\n- Fix SQL error when Quarter with Assignments is deleted in Portal.php\n- SQL Check requested assignment belongs to current Marking Period in Assignments.php\n- MySQL + MariaDB < 10.5 fix FOREIGN KEY constraint syntax in rosariosis_mysql.sql\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in CreateParents.php\n- Fix SQL error cast attendance code to integer in TakeAttendance.php\n- Fix hide Contact Fields according to Emergency/Custody settings in Address.inc.php\n- Fix MultipleCheckboxInput() save all unchecked, add hidden empty checkbox in Inputs.php\n\nChanges in 10.8\n---------------\n- Fix MySQL Periods list in MasterScheduleReport.php\n- SQL explicitly list all columns instead of `SELECT *` in MenuItems.php, Menus.php, EditHistoryMarkingPeriods.php, EditReportcardGrades.php, ReportCardCommentCodes.php, ReportCardComments.php & ReportCardGrades.php\n- Add & use DBSQLCommaSeparatedResult() function (SQL result as comma separated list) in database.inc.php, Dashboard.inc.php, MasterScheduleReport.php & Export.php\n- HTML email input remove pattern, add maxlength in PasswordReset.php, StudentsUsersInfo.fnc.php, NotifyParents.php, CreateParents.php & General_Info.inc.php, Other_Info.inc.php\n- JS Fix #319 Try a full match first to identify selected menu link in warehouse.js\n- Spanish translation add \u00bf character before questions in rosariosis.po\n- HTML add \"Check All\" checkbox after Periods in AddAbsences.php\n- Truncate Assignment title to 36 chars in AnomalousGrades.php\n- SQL resources table: Add PUBLISHED_PROFILES & PUBLISHED_GRADE_LEVELS columns in Update.fnc.php, rosariosis.sql & rosariosis_mysql.sql\n- Add Resource Visibility options in Resources.php\n- Move Resources functions to separate file & rename them in Resources.php & Resources.fnc.php\n- Update French & Spanish translations in rosariosis.po\n- CSS Fix Select2 dropdown hidden when inside colorBox (has z-index 9999) in stylesheet.css\n\nChanges in 10.7.1\n-----------------\n- Fix SQL limit School Periods to Course Period in AddAbsences.php\n\nChanges in 10.7\n---------------\n- CSS add Select2 styles in stylesheet.css & colors.css\n- JS add Select2 jQuery plugin in assets/js/jquery-select2/\n- Add Select2Input() function in Inputs.php\n- Use Select2 instead of Chosen, fixes the overflow issue in Widget.php, MakeReferral.php, Transcripts.fnc.php & Address.inc.php\n- Fix PHP8.2 deprecated Creation of dynamic property in Markdownify/ConverterExtra.php\n- SQL always add space before AND to $extra['WHERE'], program wide\n- Escape SanitizeHTML() & SanitizeMarkDown() before saving to DB, program wide\n- Always use UserStudentID() instead of `$_SESSION['STUDENT_ID']` in PortalPollsNotes.php\n- SQL use EXISTS(SELECT 1) instead of `EXISTS(SELECT *)` in EditReportCardGrades.php, Rollover.php & Moodle/functions.php\n- Remove trailing seconds :00 & add sorting HTML comment to datetime in Date.php\n- HTML set max Event Repeat Days to 300 in Calendar.php\n- Only display Locked column if AllowEdit() in Schedule.php\n- Schedule table: rename Periods column to Period (singular) in PrintSchedules.php & Schedule.inc.php\n- HTML add padding to Assignment options + remove useless table in Grades/Configuration.php\n- Move \"Remove required attribute, TinyMCE bug\" fix to TextAreaInput() in Inputs.php\n- Only display profiles w/Custom if actually used to gain space in PortalPollsNotes.php\n- Add & remove module icons in themes/FlatSIS/modules/\n- Add .dotx,.ppsx,.mdb,.sldx,.odg,.odc,.odb,.odf,.numbers,.pages,.m4a,.tsv,.json,.ics file extensions to whitelist in FileUpload.fnc.php\n- ROLL Gradebook Config's Final Grading Percentages for Admin (overridden) in Rollover.php\n- HTML responsive limit display columns to 3 in Courses.php & Assignments.php\n- SQL remove Period Length<=(Minutes in a Full School Day / 2) for Teacher's Schedule table in Schedule.inc.php\n- SQL include Secondary Teacher Course Periods in Schedule.inc.php\n- HTML move Schedule list inside PopTable & rework table cell in Schedule.inc.php\n- Fix do not display \"Enroll student for next school year\" link if new enrollment record in Enrollment.inc.php\n- Add Class Average row in ReportCards.fnc.php & Grades.fnc.php\n- Fix HTML5 notice Trailing slash on void elements has no effect, but keep `<br />` for `$_ROSARIO['SearchTerms']`, program wide\n- Fix regression since 9.0 show Student Photo in Transcripts.fnc.php\n- Check Assignment is in current MP in StudentAssignments.php & StudentAssignments.fnc.php\n- Corrections for French translation in rosariosis.po\n- CSS FlatSIS .list & .postbox headers adjustments for Chrome in stylesheet.css\n- CSS reduce File input size when inside list in stylesheet.css\n- CSS responsive increase max input size when inside list in zresponsive.css\n- CSS fix Student Comments margin & padding in stylesheet.css\n- Fix regression display Mailing Labels in ReportCards.fnc.php\n- Add Student Photo in ReportCards.fnc.php\n- Fix SQL error ORDER BY for Expanded View + Contact Information in GetStuList.fnc.php\n\nChanges in 10.6.3\n-----------------\n- Fix regression Teacher can save config even if overridden by Admin in Grades/Configuration.php\n- Prevent double encoding single quote (`&#039;`), was encoded by SanitizeHTML() or SanitizeMarkDown() in Inputs.php\n\nChanges in 10.6.2\n-----------------\n- Do not truncate value on List export in Accounting/functions.inc.php, Grades.php, StudentGrades.php, StudentAsignments.fnc.php, Resources.php & Student_Billing/functions.inc.php\n- SQL performance use POSITION()>0 instead of LIKE, program wide\n- SQL remove useless ID='' check in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Fix hide File input if cannot edit in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- Fix SQL use JOIN instead of WHERE EXISTS for Discipline Widgets in Widget.php\n- MySQL fix PHP fatal error when updating Course's Marking Period in Courses.php\n- Fix #338 Only check against Course Periods having overlapping Marking Period in Courses.fnc.php\n\nChanges in 10.6.1\n-----------------\n- PostgreSQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric (exact) in rosariosis.sql, thanks to @fatahou\n- MySQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric(22,16) (exact) in rosariosis_mysql.sql, thanks to @fatahou\n- SQL Fix regression since 10.0, change sum/cum factors & credit_attempted/earned columns type from double precision to numeric in Update.fnc.php\n- Fix Grades input not displaying for Teachers in Widget.php\n- Raise minimum PHP version from 5.4.45 to 5.5.9 in INSTALL.md, README.md, composer.json, diagnostic.php & Portal.php\n- Fix close PopTable wrapper `<div>` in Enrollment.inc.php, General_Info.inc.php, Medical.inc.php & Schedule.inc.php\n\nChanges in 10.6\n---------------\n- Add Pashto to right-to-left languages in Warehouse.php, Inputs.php & PDF.php\n- CSS FixedMenu bug when menu hidden in stylesheet.css\n- Fix JPG image rotation in ImageResizeGD.php\n- Resize, compress & store image using ImageUpload() in FileUpload.fnc.php\n- Fix remove `<span>` HTML tag from Assignment Type in select in Grades.php\n- Truncate Assignment Type to 36 chars only if has words > 36 chars in ProgressReports.php & StudentAssignments.fnc.php\n- Truncate Assignment title to 36 chars in StudentGrades.php\n- CSS Do NOT use global word-break. Use it only on specific elements in stylesheet.css & zresponsive.css\n- CSS responsive Fix list overflow-x scroll inside div.st in stylesheet.css\n- CSS set max-width for City & State select in Address.inc.php\n- Security fix for dynamic include in index.php\n- Fix SQL limit 1 when adding existing Contact in Address.inc.php\n- CSS responsive add .postbox-wrapper class for overflow-x scroll in PopTable.fnc.php & stylesheet.css\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in AssignOtherInfo.php\n\nChanges in 10.5.2\n-----------------\n- Fix PHP8.1 Fatal error when $options is null in StudentsUsersInfo.fnc.php\n- Remove .00 decimal from value of numeric type in Substitutions.fnc.php\n- Truncate Assignment title to 36 chars only if has words > 36 chars in ProgressReports.php, Assignments.php & MassCreateAssignments.php\n- Truncate Assignment title to 36 chars in GradebookBreakdown.php & Grades.php\n- CSS responsive fix List column title prevent word breaking in zresponsive.css\n- Fix photo use mime types, not file extensions so mobile browsers allow camera in General_Info.inc.php & MenuItems.php\n- Fix return processed image upload in case source type != target type in FileUpload.fnc.php\n\nChanges in 10.5.1\n-----------------\n- Fix MySQL error Unknown system variable 'storage_engine' in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.5\n---------------\n- JS responsive add minWidth & minHeight options to inline colorBox in jquery-colorbox.js & warehouse.js\n- Trim white spaces for Contact name & Address fields in RegistrationSave.fnc.php & Address.inc.php\n- Save Student Files fields, upload files in RegistrationSave.fnc.php\n- CSS Do not break text inside button in stylesheet.css\n- CSS responsive raise max-width for mobile & vertical tablet from 736 to 874px in zresponsive.css, rtl.css & colors.css\n- HTML fix responsive table & weekdays in Calendars.php\n- CSS responsive reduce select max-width from 440 to 340px in stylesheet.css & zresponsive.css\n- Fix PHP8.2 utf8_decode() function deprecated in PDF.php\n- MySQL change database charset to utf8mb4 and collation to utf8mb4_unicode_520_ci in InstallDatabase.php\n\nChanges in 10.4.4\n-----------------\n- Fix AllowUse() & AllowEdit() for User Info when on Student Info in AllowEdit.fnc.php\n- CSS fix Calendar header days word-break in zresponsive.css\n- CSS style time input in stylesheet.css & colors.css\n- CSS remove padding for LO_SORT arrow in zresponsive.css\n- HTML fix responsive / stackable table for Course Periods in Courses.php\n\nChanges in 10.4.3\n-----------------\n- MySQL always use InnoDB (default), avoid MyISAM in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.4.2\n-----------------\n- Fix SQL error null value in column \"amount\" in Salaries.php\n- Fix Total row calculation, reset for each student in ReportCards.fnc.php & Transcripts.fnc.php, thanks to @fatahou\n\nChanges in 10.4.1\n-----------------\n- JS fix regression since 9.0 & DOMPurify, open links in new window in warehouse.js\n- Add Database Type and Version, add PHP version to FirstLoginPoll() in FirstLogin.fnc.php\n- Fix typos in INSTALL.md & INSTALL_fr.md\n\nChanges in 10.4\n---------------\n- Modcat is addon module, set custom module icon in Profiles.php & Exceptions.php\n- SQL performance: use NOT EXISTS instead of NOT IN + LIMIT 1000 in Portal.php\n- Add student name to Student's Absences and Grades delete prompt in MassDrops.php\n- Fix display only first letter of attendance code in AttendanceSummary.php\n- Remove \"Minimum assignment points for letter grade\" config option in Grades/Configuration.php & StudentGrades.php\n- Truncate Assignment title to 36 chars in StudentGrades.php & Grades.php\n- CSS date capitalize first letter only in stylesheet.css\n- Add optional $id param to FilesUploadUpdate() in FileUpload.fnc.php\n- JS Only show laoding spinner if file input has selected files in warehouse.js\n- Add File Attached Input for existing Fees/Payments in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Add File Attached Input for existing Salaries/Staff Payments/Incomes/Expenses in Expenses.php, Incomes.php, Salaries, StaffPayments.php & Accounting/functions.inc.php\n- Add-ons can add their custom Widgets in classes/core/Widgets.php & classes/core/StaffWidgets.php\n- Add Widgets init action hook in Actions.php & Widgets.fnc.php\n- Add Staff Widgets init action hook in Actions.php & StaffWidgets.fnc.php\n- Fix SQL check student is actually enrolled in Enrollment.fnc.php\n- Fix date is 1969-12-31 on Windows when PHP intl ext not activated in strftime_compat.php\n\nChanges in 10.3.3\n-----------------\n- SQL ORDER BY END_DATE IS NULL DESC,END_DATE DESC (nulls first) for consistency between PostgreSQL & MySQL in User.fnc.php\n- Fix PostgreSQL error column \"students_join_people.address_id\" must appear in the GROUP BY clause in Address.inc.php\n\nChanges in 10.3.2\n-----------------\n- Fix PostgreSQL error ORDER BY \"full_name\" is ambiguous in DailyTransactions.php\n\nChanges in 10.3.1\n-----------------\n- Fix MySQL error result as comma separated list in Export.php\n- Add recommended php.ini setting session.gc_maxlifetime = 3600 in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.3\n---------------\n- Add \"Cumulative Balance over school years\" checkbox in StudentBalances.php\n- Fix program not found when query string is URL encoded in Modules.php\n- JS fix add new Period below existing Period row in Courses.php\n- Add \"Course Periods\" checkbox in Rollover.php\n- Fix MySQL error 1069 Too many keys specified; max 64 keys allowed in Fields.fnc.php & DisciplineForm.php\n\nChanges in 10.2.3\n-----------------\n- Remove dead link to centresis.org in index.php\n- Fix MySQL error TEXT column used in key specification without a key length in Fields.fnc.php & DisciplineForm.php\n- Add ROLLOVER_ID column to User() in User.fnc.php\n- Get template from last school year (rollover ID) in Template.fnc.php\n\nChanges in 10.2.2\n-----------------\n- Fix PHP fatal error undefined function StudentCanEnrollNextSchoolYear() in PrintStudentInfo.php\n- Set school logo with to 120px in PrintStudentInfo.php\n\nChanges in 10.2.1\n-----------------\n- SQL order by Marking Period Start Date in MarkingPeriods.php, ReportCards.fnc.php, Courses.php, Schedule.php, PrintSchedules.php, MassSchedule.php, MassDrops.php & Side.php\n- Maintain current month on calendar change in Calendar.php\n- Maintain Calendar when closing event popup in Calendar.php\n- CSS FlatSIS smaller font size for Calendar Event title in stylesheet.css\n- Fix SQL error mysqli_fetch_assoc(): Argument 1 must be of type mysqli_result, null given in database.inc.php & StudentsUsersInfo.fnc.php\n- When -Edit- option selected, change the auto pull-down to text field in StudentsUsersInfo.fnc.php\n- HTML remove bold for \"Other students associated with this address/person\" in Address.inc.php\n- SQL order by FULL_NAME (Display Name config option) in PortalPollNotes.fnc.php, Widget.php, GetStaffList.fnc.php, GetStuList.fnc.php, Transcripts.fnc.php, Courses.php, MassRequests.php, ScheduleReport.php & Address.inc.php\n- CSS fix Report Cards PDF columns size when long comments text in ReportCards.fnc.php & stylesheet_wkhtmltopdf.css\n- CSS Add .grade-minmax-wrap,.grade-minmax-min,.grade-minmax-grade & .grade-minmax-max classes & avoid breaking grades in stylesheet.css & ReportCards.fnc.php\n- Fix get Min. Max. grades for students in distinct grade levels in FinalGrades.php\n- Fix SQL syntax error since 10.0 in Administration.php\n- CSS Do not break words inside lists in stylesheet.css\n- SQL handle case when student dropped and then later re-enrolled in course in DuplicateAttendance.php\n- Use DBEscapeIdentifier() for Gradebook ASSIGNMENT_SORTING in Assignments.php, GradebookBreakdown.php & Grades.php\n\nChanges in 10.2\n---------------\n- Add StudentCanEnrollNextSchoolYear() & StudentEnrollNextSchoolYear() functions in Enrollment.fnc.php\n- Add \"Enroll student for next school year\" in Enrollment.inc.php\n- Translate \"Enroll student for next school year\" to French & Spanish in rosariosis.po\n- MySQL fix character encoding when translating database in InstallDatabase.php\n\nChanges in 10.1\n---------------\n- Fix MySQL 5.6 syntax error when WHERE without FROM clause, use dual table in TakeAttendance.php, Reminders.php,  InputFinalGrades.php, Requests.php & Calendar.php\n- Add dual VIEW for compatibility with MySQL 5.6 to avoid syntax error when WHERE without FROM clause in rosariosis.sql & Update.fnc.php\n- Fix MySQL 5.6 syntax error in ORDER BY use report_card_comments table instead of dual in InputFinalGrades.php\n- Fix SQL use cast(extract(DOW) AS int) for PostrgeSQL in Calendar.php\n- Add instructions for MySQL in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.0\n---------------\n- SQL convert table names to lowercase, program wide\n- Fix delete file attached in StudentFees.php\n- Use DBEscapeIdentifier() for reserved 'column' keyword in plugins/Moodle/\n- Avoid regression due to lowercase table names: Maintain compatibility with add-ons using rollover_after action hook & `$_REQUEST['tables']` in Rollover.php\n- Use db_trans_*() functions in DeleteTransaction.fnc.php & DeleteTransactionItem.fnc.php\n- Close popup if no UserSchool in session, happens on login redirect in Warehouse.php\n- SQL order Grade Levels in StudentBreakdown.php\n- Remove semicolon before \"With\" & \"On\" values in PrintRequests.php & unfilledRequests.inc.php\n- HTML Link is selected: bold in ScheduleReport.php\n- Display Period title if no short name set in IncompleteSchedules.php\n- Fix Widget search & add Search Terms header in IncompleteSchedules.php\n- Add Schedule link & photo tooltip to Student name in Scheduling/AddDrop.php\n- HTML add a11y-hidden label to select in GPARankList.php & Attendance/TeacherCompletion.php\n- Fix unset requested dates in MassCreateAssignments.php & Assignments.php\n- Add User / Student photo tooltip in Grades/TeacherCompletion.php, GPARankList.php & EnterEligibility.php\n- SQL order by Period title in TeacherCompletion.php\n- Use Period's Short Name when > 10 columns in the list in TeacherCompletion.php\n- Add note on save in EntryTimes.php\n- Fix PHP8.1 Deprecated passing null to parameter in EmailReferral.fnc.php, CategoryBreakdown.php & StudentGrades.php\n- Add Total sum of balances in StaffBalances.php\n- Fix French translation for \"Waiver\" & \"Refund\" in rosariosis.po\n- Force title & action to lowercase in Prompts.php\n- HTML use .dashboard-module-title CSS class for module titles in Profiles.php & Exceptions.php\n- CSS set input label max-width on Search form in stylesheet.css\n- JS new default popup size: 1200x450 in warehouse.js\n- Use URLEscape() for add button link when appropriate in ListOutput.fnc.php\n- JS set Calendar date to current fields date in warehouse.js & calendar-setup.js\n- HTML add label to select in ActivityReport.php\n- Use Currency() function instead of number_format() in TransactionsReport.php\n- HTML remove line-break in Warning/Minimum columns in Reminders.php\n- HTML CSS make Daily Menus calendar coherent with School Calendar in DailyMenus.php\n- Shorten Referral email subject in EmailReferral.fnc.php\n- Use plural wise ngettext() for \"No %s were found.\" in FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Force result text to lowercase for \"No %s were found.\" in ListOutput.fnc.php, FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Prevent admin from removing own access to User Profiles program in Profiles.php\n- SQL change modname column type from text to varchar(150) to match with MySQL key index limitation in rosariosis.sql\n- SQL change program column type from text to varchar(100) NOT NULL to match with MySQL index limitation in rosariosis.sql\n- SQL change schools column type from text to varchar(150) to match with MySQL index limitation in rosariosis.sql\n- Rename YEAR_MONTH column alias to YEAR_MONTH_DATE: reserved keyword in MySQL in Dashboard.inc.php\n- SQL use DAYOFWEEK() for MySQL or cast(extract(DOW)+1 AS int) for PostrgeSQL, program wide\n- SQL cast(AS UNSIGNED) for MySQL or cast(AS INT) for PostgreSQL, program wide\n- SQL cast custom_fields ID AS char(10) instead of TEXT for MySQL compatibility in GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL rename $field COLUMN (reserved keyword) to COLUMN_NAME for MySQL compatibility in CustomFields.fnc.php, GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL remove use of nextval in rosariosis_fr.sql\n- Rename $pg_dumpPath configuration variable to $DatabaseDumpPath in config.inc.sample.php, diagnostic.php & DatabaseBackup.php\n- Build command for executing mysqldump in DatabaseBackup.php\n- SQL to extract Unix timestamp or epoch from date in Eligibility/Student.php, StudentList.php & TeacherCompletion.php\n- Install module/plugin: execute the install_mysql.sql script for MySQL in Modules.inc.php, Plugins.inc.php & modules/README.md & plugins/README.md\n- Fix typo \"inexistant\" to \"nonexistent\" & update translations in Modules.inc.php, Plugins.inc.php & rosariosis.po\n- HTML fix duplicated #menu-top div on update in Side.php\n- JS fix #body height calculation: include bottom margin in jquery-fixedmenu.js & plugins.min.js\n- Add MySQLRemoveDelimiter() remove DELIMITER $$ declarations before procedures or functions in database.inc.php, Modules.inc.php & Plugins.inc.php\n- SQL ORDER BY SORT_ORDER IS NULL,SORT_ORDER (nulls last) for consistency between PostgreSQL & MySQL, program wide\n- Rollback Fix PostgreSQL error invalid ORDER BY, only result column names can be used, program wide\n- HTML use number input for Gradebook config options in Configuration.php\n- HTML use number input for Grade points & average in ReportCardGrades.php\n- SQL limit results to current school year in AddDrop.php\n- SQL always use INTERVAL to add/subtract days to date for MySQL compatibility in Reminders.php, Transactions.php, ServeMenus.php, Assignments.php, StudentGrades.php, Rollover.php & Portal.php\n- SQL change amount columns type from numeric to numeric(14,2) NOT NULL in rosariosis.sql & StudentFees.php\n- SQL change minutes,minutes_present,points,default_points,length,count_weighted_factors,count_unweighted_factors columns type from numeric to integer in rosariosis.sql, UpdateAttendanceDaily.fnc.php, Assignments.php, MassCreateAssignments.php & Periods.php\n- SQL change gp & gpa columns type from numeric to numeric(7,2) in rosariosis.sql\n- SQL change sum/cum factors & credit_attempted/earned columns type from numeric to double precision in rosariosis.sql\n- Add Can use modname to HACKING ATTEMPT error email in ErrorMessage.fnc.php\n- Fix HACKING ATTEMPT when Grades module inactive in Portal.php & Calendar.php\n- Use GetTemplate() instead of unescaping `$_REQUEST` in CreateParents.php & NotifyParents.php\n- Use `$_POST` to get password instead of unescaping `$_REQUEST` in PasswordReset.php, Student.php & User.php\n- Use DBGetOne() instead of unescaping `$_REQUEST` in Config.fnc.php\n- Add MySQL support in database.inc.php, diagnostic.php, InstallDatabase.php & Warehouse.php\n- Add $DatabaseType configuration variable in database.inc.php, diagnostic.php, InstallDatabase.php, Warehouse.php & config.inc.php\n- Add $show_error parameter to db_start() in database.inc.php\n- Add DBUnescapeString() function in database.inc.php, GetStuList.fnc.php, ListOutput.fnc.php, PreparePHP_SELF.fnc.php & Search.fnc.php\n- PostgreSQL Date format: move query from Date.php to Warehouse.php\n- Compatibility with add-ons version < 10.0, gather CONFIG (uppercase table name) values too in Configuration.php\n- Fix MySQL error Table is specified twice, both as a target for 'INSERT' and as a separate source for data in CopySchool.php & Rollover.php\n- Fix MySQL syntax error: no table alias in DELETE in Rollover.php\n- Fix MySQL syntax error: no FROM allowed inside UPDATE, use subquery or multi-table syntax in Rollover.php\n- Fix MySQL syntax error: replace CAST (NULL AS CHAR(1)) AS CHECKBOX with NULL AS CHECKBOX in AddAbsences.php, AddActivity.php, MassDrops.php, MassRequests.php, MassSchedule.php, AddUsers.php, AssignOtherInfo.php & AddStudents.php\n- Add Installation tutorial for Mac in WHATS_NEW.md & INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Update tested on Ubuntu 18.04 to 20.04 in INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Fix SQL error when column already dropped in Fields.fnc.php\n- SQL fix CREATE INDEX on right table in rosariosis.sql\n- SQL remove unused indices for various tables in rosariosis.sql\n- SQL match index with FOREIGN KEY for various tables in rosariosis.sql\n- SQL ORDER BY fix issue when Transferring to another school & new start date is <= old start date in Enrollment.inc.php\n- Check if student already enrolled on that date when inserting START_DATE in SaveEnrollment.fnc.php\n- Add `_getAddonsSQL()` & `_configTableCheck()` functions in InstallDatabase.php\n- $DatabasePort configuration variable is now optional in config.inc.sample.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- SQL start staff_fields ID sequence at 200000000 for coherence with custom_fields in rosariosis.sql & Fields.fnc.php\n- MySQL use LONGTEXT type for textarea field in Fields.fnc.php & DisciplineForm.php\n- SQL Check requested assignment belongs to teacher in Assignments.php\n- CSS fix responsive when really long string with no space in stylesheet.css\n- Limit `$_POST` array size to a maximum of 16MB in Warehouse.php, thanks to @ahmad0x1\n- Add optional ROSARIO_POST_MAX_SIZE_LIMIT constant in Warehouse.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- Add MySQL database dump in rosariosis_mysql.sql\n- Log \"RosarioSIS HACKING ATTEMPT\" into Apache error.log in HackingLog.fnc.php\n- Force URL & menu reloading, always use JS to redirect in HackingLog.fnc.php\n- Place currency symbol after amount for some locales in Currency.fnc.php\n- SQL use timestamp type: standard & without time zone by default in rosariosis.sql\n- CSS add .accounting-totals, .accounting-staff-payroll-totals, .student-billing-totals classes in Expenses.php, Incomes.php, Salaries.php, StaffPayments.php, StudentFees.php & StudentPayments.php\n- SQL rename KEY (reserved keyword) to SORT_KEY for MySQL compatibility in Search.fnc.php, StudentFieldBreakdown.php, StudentBreakdown.php\n- SQL use GROUP BY instead of DISCTINCT ON for MySQL compatibility in Address.inc.php & EnterEligibility.php\n- SQL cast Config( 'STUDENTS_EMAIL_FIELD' ) to int when custom field in SendNotification.fnc.php, Registration.fnc.php, Moodle/getconfig.inc.php & ImportUsers.fnc.php\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in PortalPollsNotes.fnc.php, DeleteTransaction.fnc.php, DeleteTransactionItem.fnc.php, Rollover.php, CopySchool.php & AssignOtherInfo.php\n- Fix MySQL syntax error: explicitly list all columns instead of wildcard in ActivityReport.php & Statements.php\n- Fix MakeChooseCheckbox() remove parent link to sort column in Inputs.php & ListOutput.fnc.php\n- CSS WPadmin fix menu select width in stylesheet.css\n- Enrollment Start: No N/A option for new student in StudentUsersInfo.fnc.php\n\nChanges in 9.3.2\n----------------\n- Fix regression since 9.2.1 fields other type than Select Multiple from Options in CategoryBreakdownTime.php\n\nChanges in 9.3.1\n----------------\n- Fix regression since 2.9 Schedule multiple courses in plugins/Moodle/Scheduling/MassSchedule.php\n- Fix SQL to select Periods where exists CP in TeacherCompletion.php & Administration.php\n- Fix dummy day (year month date) set to 28 for February in Dashboard.inc.php\n- Fix AllowEdit for Teacher in Users/includes/General_Info.inc.php\n- Security: sanitize filename with no_accents() in Student.php, User.php & Schools.php\n- Fix \"Exclude PDF generated using the \"Print\" button\" option for the PDF Header Footer plugin in Bottom.php\n\nChanges in 9.3\n--------------\n- Handle case where Course Period Parent ID is null in Courses.php\n- SQL order by Period title in Periods.php, DailySummary.php & StudentSummary.php\n- SQL get Period title if no short name set in AddAbsences.php\n- Use DBLastInsertID() instead of DBSeqNextID() in Moodle/includes/ImportUsers.fnc.php\n- Still use DBSeqNextID() for student ID, adapt for MySQL in Student.php & Moodle/includes/ImportUsers.fnc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility, program wide\n- Fix first item in the list not displayed in Accounting/includes/DailyTransactions.php\n- SQL time interval for MySQL compatibility in PasswordReset.php & index.php\n- SQL use CAST(X AS char(X)) instead of to_char() for MySQL compatibility in Dashboard.inc.php & Reminders.php\n- SQL result as comma separated list for MySQL compatibility in Grades/includes/Dashboard.inc.php & MasterScheduleReport.php\n- Use DBEscapeIdentifier() for MySQL reserved 'TIMESTAMP' keyword in ServeMenus.php & Transactions.php\n- SQL add `_SQLUnixTimestamp()` to extract Unix timestamp or epoch from date in Grades.php & Schedule.php\n- Add case for MySQL: get next MP ID & set AUTO_INCREMENT+1 in EditHistoryMarkingPeriods.php\n- Display Name: SQL use CONCAT() instead of pipes || for MySQL compatibility in Configuration.php & GetStuList.fnc.php\n- config table: update DISPLAY_NAME to use CONCAT() instead of pipes || in Update.fnc.php\n\nChanges in 9.2.2\n----------------\n- Fix SQL error lastval is not yet defined when editing field in SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Assignments.php\n\nChanges in 9.2.1\n----------------\n- Remove use of db_seq_nextval(), use auto increment, program wide\n- SQL set default nextval (auto increment) for RosarioSIS version < 5.0 on install & old add-ons in Update.fnc.php\n- SQL no more cast MARKING_PERIOD_ID column as text/varchar in rosariosis.sql & InputFinalGrades.php\n- PLpgSQL compact & consistent function declaration in rosariosis.sql\n- Use DB transaction statements compatible with MySQL in database.inc.php\n- Add DBLastInsertID() & deprecate DBSeqNextID() + db_seq_nextval() in database.inc.php\n- SQL rename character varying & character data types to varchar & char in rosariosis.sql\n- SQL replace use of STRPOS() with LIKE, compatible with MySQL in PortalPollNotes.fnc.php & Courses.php\n- SQL fix French & Spanish translation for Create Parent Users & Notifiy Parents email templates in rosariosis_fr.sql & rosariosis_es.sql\n- Use DBLastInsertID() instead of DBSeqNextID(), program wide\n- SQL TRIM() both compatible with PostgreSQL and MySQL in AttendanceSummary.php & CopySchool.php\n- SQL use extract() or SUBSTRING() or REPLACE() instead of to_char() for MySQL compatibility, program wide\n- Fix No Address contact not properly saved for student / parent in RegistrationSave.fnc.php\n- AddDBField() Change $sequence param to $field_id, adapted for use with DBLastInsertID() in Fields.fnc.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php & UserFields.php\n- Raise Frame file size limit to 5MB in HonorRoll.fnc.php\n- Fix Marking Period not found in user School Year (multiple browser tabs case) in MassSchedule.php & MassDrops.php\n- Fix Course not found in user School Year (multiple browser tabs case) in MassRequests.php\n- HTML add label to inputs in Requests.php\n- Remove help sentence. The Scheduler is not run by the Student Requests program in Help_en.php\n\nChanges in 9.2\n--------------\n- Fix SQL error invalid input syntax for integer in Administration.php\n- SQL student_report_card_grades table: convert MARKING_PERIOD_ID column to integer in Update.fnc.php, rosariosis.sql, EditReportCardGrades.php, FinalGrades.php & ReportCards.fnc.php\n\nChanges in 9.1.1\n----------------\n- Fix PHP8.1 fatal error unsupported operand types: string / int in Assignments.php & MassCreateAssignments.php\n- Fix selected Subject lost on Comment Category delete in ReportCardComments.php\n- Fix Color Input was hidden in ReportCardComments.php\n- Fix use Course ID in session in MassRequests.php\n- Fix SQL error primary key exists on table food_service_staff_accounts in Rollover.php\n- Fix SQL error foreign key exists on tables gradebook_assignments,gradebook_assignment_types,schedule_requests in Rollover.php\n- Fix save State input value in Registration.fnc.php\n- Fix SchoolInfo() on user School Year update in School.php\n\nChanges in 9.1\n--------------\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @domiee13\n- Capitalize month when date is only month and year in Dashboard.inc.php\n- Add decimal & thousands separator configuration in Help_en.php, Currency.fnc.php, Configuration.php, rosariosis.sql & rosariosis_fr.sql\n- Use Currency() for Food Service Balance value in Widget.php & StaffWidget.php\n- Add Class average in InputFinalGrades.php & Grades.fnc.php\n- Update French & Spanish translation in rosariosis.po & help.po\n- Update Default School Year to 2022 in config.inc.sample.php & rosariosis.sql\n\nChanges in 9.0\n--------------\n- CSS add length to previous meals select in DailyMenus.php\n- CSS FlatSIS fix calendar menu text wrapping in stylesheet.css\n- Add Export list button in TransactionsReport.php\n- Add Food Service icon to list in ServeMenus.php\n- Add User / Student photo tooltip in ServeMenus.php, Transactions.php & TeacherCompletion.php\n- HTML add horizontal ruler before each category in MakeReferral.php\n- Fix SQL error when generating Schedule table with PHP8.1 in GetMP.php\n- Reorder PDF list columns to match Schedule columns in PrintSchedules.php\n- SQL order Schedule list by Course Title & Course Period Short Name in Schedule.php, PrintSchedules.php & Schedule.inc.php\n- Fix SQL error more than one row returned by a subquery in Rollover.php\n- Fix update Course Period title when Short Name contains single quote in Courses.php\n- Fix PHP8.1 deprecated function parameter is null, program wide\n- Fix PHP8.1 deprecated automatic conversion of false to array in StudentsUsersInfo.fnc.php\n- Fix PHP8.1 deprecated automatic conversion of float to int in ImageResizeGD.php\n- Add Student Photo Tip Message in AddDrop.php & StudentList.php\n- Format Enrollment Start & End Date in Export.php\n- Add Student name if no Contacts at address in MailingLabel.fnc.php\n- Do not Export Delete column in Periods.php & GradeLevels.php\n- HTML group inputs inside fieldset (tab title or program name) in Configuration.php\n- Hide Comment Codes tip message if Comments unchecked for Marking Period in InputFinalGrades.php\n- Add Get Student Labels Form JS (Disable unchecked fieldset) in StudentLabels.fnc.php & StudentLabels.php\n- Fix PHP8.1 deprecated use PostgreSQL $db_connection global variable in database.inc.php & Grades/includes/Dashboard.inc.php\n- Don't Delete Gender & Birthday Student Fields in Fields.fnc.php\n- CSS set cursor for .tipmsg-label in stylesheet.css\n- Add Username to Password Reset email in PasswordReset.php\n- `intl` PHP extension is now required in diagnostic.php & INSTALL.md\n- Fix PHP8.1 deprecated strftime() use strftime_compat() instead in Side.php, Date.php, PHPCompatibility.php, strftime_compat.php, Dashboard.inc.php & Preferences.php\n- Add $course_period_id param to limit check to a single Course Period in Courses.fnc.php & Courses.php\n- Add title to Contact & Address button images in Address.inc.php & GetStuList.fnc.php\n- CSS select max-width 440px in stylesheet.css & zresponsive.css\n- HTML add label to Points inputs to correct alignment in Grades.php\n- HTML add a11y-hidden label to select in CategoryBreakdown.php, CategoryBreakdownTime.php & StudentFieldBreakdown.php\n- Place Go button right after Timeframe in DailyTransactions.php, DailyTotals.php, CategoryBreakdown.php, CategoryBreakdownTime.php, StudentFieldBreakdown.php & Percent.php\n- Fix French translation for \"Not due\" in rosariosis.po\n- Move Transcript Include form checkboxes up in Transcripts.fnc.php\n- Add Delete button for Submission File in StudentAssignments.fnc.php\n- Fix SQL error null value in column \"title\" violates not-null constraint in MassCreateAssignments.php\n- Reorder & rename Course Periods columns to match Schedule program in MassCreateAssignments.php\n- Fix get History Grades Grade Level short name only if no Grade Level available in Transcripts.fnc.php\n- Fix get Student Photo from previous year in Transcripts.fnc.php\n- Fix SQL error invalid input syntax in PrintSchedules.php & TeacherCompletion.php, thanks to @scgajge12\n- Filter IP, HTTP_* headers can be forged in index.php, PasswordReset.php & ErrorMessage.fnc.php\n- Fix SQL error invalid input syntax for integer, program wide\n- Fix PHP8.1 fatal error checkdate argument must be of type int in Calendar.php\n- Fix SQL error invalid input syntax for type date in Calendar.php\n- Fix SQL error duplicate key value violates unique constraint \"attendance_calendar_pkey\" in Calendar.php\n- Fix PHP fatal error Unsupported operand types in ListOutput.php\n- Add AttrEscape() function in Inputs.php\n- Use AttrEscape() instead of htmlspecialchars(), program wide\n- Add use of AttrEscape(), program wide\n- Maintain Advanced search when editing Timeframe in Percent.php\n- Fix SQL injection escape DB identifier in RegistrationSave.fnc.php, Calendar.php, MarkingPeriods.php, Courses.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Referrals.php\n- JS update marked to v4.0.14 in assets/js/marked/ & warehouse_wkhtmltopdf.js\n- JS add DOMPurify 2.3.6 in assets/js/DOMPurify/ & Gruntfile.js\n- JS fix stored XSS issue related to MarkDown in warehouse.js & plugins.min.js, thanks to @intrapus\n- JS remove logged in check on history back in warehouse.js & plugins.min.js\n- Add CSRF token to protect unauthenticated requests in Warehouse.php & login.php\n- Add CSRF token to logout URL in login.php, Warehouse.php, PasswordReset.php, Bottom.php, Student.php & User.php, thanks to @khanhchauminh\n- Logout after 10 Hacking attempts within 1 minute in HackingLog.fnc.php\n- Destroy session now: some clients do not follow redirection in HackingLog.fnc.php\n- Add use of URLEscape(), program wide\n- Use URLEscape() for img src attribute, program wide\n- Sanitize / escape URL as THEME is often included for button img src attribute in User.fnc.php\n- Better format for \"Add another marking period\" form in EditReportCardGrades.php\n- Fix Improper Access Control security issue: add random string to photo file name in TipMessage.fnc.php, Transcripts.fnc.php, PrintClassPictures.php, Student.php, User.php & General_Info.inc.php, thanks to @dungtuanha\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @khanhchauminh\n- Fix stored XSS security issue: remove inline JS from URL in PreparePHP_SELF.fnc.php, thanks to @intrapus & @domiee13\n- Fix stored XSS security issue: add semicolon to HTML entity so it can be decoded in PreparePHP_SELF.fnc.php, thanks to @intrapus\n- Accessibility: add hidden input label using .a11y-hidden class in ReportCardComments.php, StudentFields.php & Grades/TeacherCompletion.php\n- Accessibility: add select label in Eligibility/TeacherCompletion.php, Student.php, StudentList.php, MassDrops.php & MassSchedule.php\n- Two Lists on same page: export only first, no search in Eligibility/Student.php\n- Remove photos on delete in Student.php & User.php, thank to @jo125ker\n- Remove Student Assignment Submission files on delete in Assignments.php, thank to @khanhchauminh\n- Add microseconds to filename format to make it harder to predict in Assignments.php & StudentAssignments.fnc.php, thanks to @khanhchauminh\n- Restrict Sort Order input number range, program wide\n- Restrict Price / Amount / Balance input number range, program wide, thanks to @nhienit2010\n- Restrict input number step in Courses.fnc.php\n- Restrict diagnostic access to logged in admin in diagnostic.php, thanks to @intrapus\n- Fix SQL error value too long for type character varying(50) in Schools.php\n- Add Secure RosarioSIS link in INSTALL.md\n- Add Calendar days legend in Calendar.php\n- CSS add .legend-square class in stylesheet.css & colors.css\n- Create / Edit / Delete calendar: use button() in Calendar.php\n- Update Calendars help text in Help_en.php & help.po\n- Add translations for Calendar days legend in rosariosis.po\n- Use json_encode() for AjaxLink() URL, program wide\n- SQL skip \"No Address\" contacts to avoid lines with empty Address fields in Export.php\n- French translation: remove capitalization & use articles in rosariosis.po, help.po & rosariosis_fr.sql\n- JS Sanitize string for legal variable name in Export.php & Inputs.php\n- Remove deprecated `_makeTeacher()` function in ReportCards.fnc.php\n- Use multiple select input for grades list to gain space in Widget.php\n- Fix regression since 5.0, allow Administration of \"Lunch\" attendance categories in Administration.php, AttendanceCodes.fnc.php & colors.css\n- SQL set default FAILED_LOGIN_LIMIT to 30 in rosariosis.sql, thanks to @domiee13\n- JS Hide Options textarea if Field not of select type in Fields.fnc.php\n- Add Balance widget in StudentBalances.php\n- Add Total sum of balances in StudentBalances.php\n- Fix SQL error check requested UserSyear & UserSchool exists in DB in Side.php, Search.fnc.php & SaveEnrollment.fnc.php\n- HTML use number input for Class Rank widget in Widget.php\n- Check default if school has no default calendar in Calendar.php\n- CSS do not capitalize date in stylesheet.css\n- Remove unused index ON attendance_period (attendance_code) & ON student_report_card_grades (school_id) in rosariosis.sql & rosariosis_mysql.sql\n- SQL VACUUM & ANALIZE are for PostgreSQL only in Scheduler.php\n\n\n### Old versions CHANGES\n- [CHANGES for versions 7 and 8](CHANGES_V7_8.md).\n- [CHANGES for versions 5 and 6](CHANGES_V5_6.md).\n- [CHANGES for versions 3 and 4](CHANGES_V3_4.md).\n- [CHANGES for versions 1 and 2](CHANGES_V1_2.md).\n", "<?php\n/**\n * File Upload functions\n *\n * @package RosarioSIS\n * @subpackage ProgramFunctions\n */\n\n/**\n * File Upload\n *\n * @example FileUpload( 'FILE_ATTACHED', $FileUploadsPath . UserSyear() . '/staff_' . User( 'STAFF_ID' ) . '/', FileExtensionWhiteList(), 0, $error );\n *\n * @global $_FILES\n *\n * @since 10.6 Resize, compress & store image using ImageUpload()\n *\n * @param string $input            Name of the input file field, for example 'photo'.\n * @param string $path             Final path with trailing slash, for example $StudentPicturesPath . UserSyear() . '/'.\n * @param array  $ext_white_list   Extensions white list, for example array('.jpg', '.jpeg').\n * @param float  $size_limit       Size Limit in Mb, set it to 0 to use server limit (upload_max_filesize).\n * @param array  $error            The global errors array.\n * @param string $final_ext        Final file extension (useful for .jpg, if .jpeg submitted) (optional).\n * @param string $file_name_no_ext Final file name without extension, for example UserStudentID() (optional).\n *\n * @return string|boolean Full path to file, or false if error\n */\nfunction FileUpload( $input, $path, $ext_white_list, $size_limit, &$error, $final_ext = '', $file_name_no_ext = '' )\n{\n\t$file_name = $full_path = false;\n\n\tif ( ! $final_ext )\n\t{\n\t\t$final_ext = empty( $_FILES[ $input ]['tmp_name'] ) ? '' :\n\t\t\tmb_strtolower( mb_strrchr( $_FILES[ $input ]['name'], '.' ) );\n\t}\n\n\tif ( $file_name_no_ext )\n\t{\n\t\t$file_name = $file_name_no_ext . $final_ext;\n\t}\n\n\t$caller_function = debug_backtrace();\n\n\t$caller_function = isset( $caller_function[1]['function'] ) ? $caller_function[1]['function'] : '';\n\n\tif ( empty( $_FILES[ $input ]['tmp_name'] )\n\t\t|| ! is_uploaded_file( $_FILES[ $input ]['tmp_name'] ) )\n\t{\n\t\t// Check the post_max_size & php_value upload_max_filesize values in the php.ini file.\n\t\t$error[] = _( 'File not uploaded' );\n\t}\n\n\telseif ( ! in_array( mb_strtolower( mb_strrchr( $_FILES[ $input ]['name'], '.' ) ), $ext_white_list ) )\n\t{\n\t\t$error[] = sprintf(\n\t\t\t_( 'Wrong file type: %s (%s required)' ),\n\t\t\t// Fix reflected XSS via mime-type.\n\t\t\tstrip_tags( $_FILES[ $input ]['type'] ),\n\t\t\timplode( ', ', $ext_white_list )\n\t\t);\n\t}\n\n\telseif ( $size_limit\n\t\t&& $_FILES[ $input ]['size'] > $size_limit * 1024 * 1024 )\n\t{\n\t\t$error[] = sprintf(\n\t\t\t_( 'File size > %01.2fMb: %01.2fMb' ),\n\t\t\t$size_limit,\n\t\t\t( $_FILES[ $input ]['size'] / 1024 ) / 1024\n\t\t);\n\t}\n\n\t// If folder doesnt exist, create it!\n\telseif ( ! is_dir( $path )\n\t\t&& ! @mkdir( $path, 0755, true ) ) // Fix shared hosting: permission 755 for directories.\n\t{\n\t\t$error[] = sprintf( _( 'Folder not created' ) . ': %s', $path );\n\t}\n\n\telseif ( ! is_writable( $path ) )\n\t{\n\t\t// See PHP / Apache user rights for folder.\n\t\t$error[] = sprintf( _( 'Folder not writable' ) . ': %s', $path );\n\t}\n\n\t// Check if file is image.\n\telseif ( $caller_function !== 'ImageUpload'\n\t\t&& in_array( $final_ext, [ '.jpg', '.jpeg', '.png', '.gif' ] ) )\n\t{\n\t\t// Resize, compress & store image using ImageUpload().\n\t\treturn ImageUpload(\n\t\t\t$input,\n\t\t\t[],\n\t\t\t$path,\n\t\t\t[],\n\t\t\t$final_ext,\n\t\t\t$file_name_no_ext\n\t\t);\n\t}\n\n\t// Store file.\n\telseif ( ! move_uploaded_file(\n\t\t$_FILES[ $input ]['tmp_name'],\n\t\t$full_path = ( $path . ( $file_name ?\n\t\t\t$file_name :\n\t\t\tno_accents( mb_substr(\n\t\t\t\t$_FILES[ $input ]['name'],\n\t\t\t\t0,\n\t\t\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t\t\t) ) . $final_ext\n\t\t) )\n\t) )\n\t{\n\t\t$error[] = sprintf( _( 'File invalid or not moveable' ) . ': %s', $_FILES[ $input ]['tmp_name'] );\n\t}\n\n\treturn $full_path;\n}\n\n\n/**\n * Image File Upload\n *\n * @example ImageUpload( 'photo', [ 'width' => 150, 'height' => '150' ], $StudentPicturesPath . UserSyear() . '/', [], '.jpg', UserStudentID() . '.' . bin2hex( openssl_random_pseudo_bytes( 16 ) ) );\n * @example ImageUpload( $base64_img, [ 'width' => 640, 'height' => '320' ] );\n *\n * @since 3.3\n *\n * @uses FileUpload()\n * @uses ImageResizeGD class.\n *\n * @param string $input            Name of the input file field, for example 'photo', or base64 encoded data, src attribute value.\n * @param array  $target_dim       Target dimensions to determine if can be resized. Defaults to [ 'width' => 994, 'height' => 1405 ] (optional).\n * @param string $path             Final path with trailing slash, for example $StudentPicturesPath . UserSyear() . '/'. Defaults to \"assets/FileUploads/[Syear]/[staff_or_student_ID]/\" (optional).\n * @param array  $ext_white_list   Extensions white list, for example ['.jpg', '.jpeg'].\n * @param string $final_ext        Final file extension (useful for .jpg, if .jpeg submitted) (optional).\n * @param string $file_name_no_ext Final file name without extension, for example UserStudentID() . '.' . bin2hex( openssl_random_pseudo_bytes( 16 ) ) (optional).\n *\n * @return string|boolean Full path to file, or false (or base64 data) if error\n */\nfunction ImageUpload( $input, $target_dim = [], $path = '', $ext_white_list = [], $final_ext = null, $file_name_no_ext = '' )\n{\n\tglobal $FileUploadsPath,\n\t\t$PNGQuantPath,\n\t\t$error;\n\n\trequire_once 'classes/ImageResizeGD.php';\n\n\t$is_base64 = ( strpos( $input, 'data:image' ) === 0 );\n\n\tif ( ! $path )\n\t{\n\t\t// Path defaults to \"assets/FileUploads/[Syear]/[staff_or_student_ID]/\".\n\t\t$user_folder = User( 'STAFF_ID' ) ? 'staff_' . User( 'STAFF_ID' ) : 'student_' . UserStudentID();\n\n\t\t$path = $FileUploadsPath . UserSyear() . '/' . $user_folder . '/';\n\t}\n\n\tif ( ! $ext_white_list )\n\t{\n\t\t// Defaults to JPG, PNG & GIF.\n\t\t$ext_white_list = [ '.jpg', '.jpeg', '.png', '.gif' ];\n\t}\n\n\t// Defaults to horizontal PDF target dimensions.\n\t$target_dim_default = [ 'width' => 994, 'height' => 1405 ];\n\n\t$target_dim = array_replace_recursive( $target_dim_default, (array) $target_dim );\n\n\tif ( ImageResizeGD::test() )\n\t{\n\t\t// If folder doesnt exist, create it!\n\t\tif ( ! is_dir( $path )\n\t\t\t&& ! @mkdir( $path, 0755, true ) ) // Fix shared hosting: permission 755 for directories.\n\t\t{\n\t\t\t$error[] = sprintf( _( 'Folder not created' ) . ': %s', $path );\n\n\t\t\treturn ( $is_base64 ? $input : false );\n\t\t}\n\t\telseif ( ! is_writable( $path ) )\n\t\t{\n\t\t\t// See PHP / Apache user rights for folder.\n\t\t\t$error[] = sprintf( _( 'Folder not writable' ) . ': %s', $path );\n\n\t\t\treturn ( $is_base64 ? $input : false );\n\t\t}\n\n\t\tif ( ! $is_base64 )\n\t\t{\n\t\t\tif ( ! is_uploaded_file( $_FILES[ $input ]['tmp_name'] ) )\n\t\t\t{\n\t\t\t\t// Check the post_max_size & php_value upload_max_filesize values in the php.ini file.\n\t\t\t\t$error[] = _( 'File not uploaded' );\n\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$image_path_or_string = $_FILES[ $input ]['tmp_name'];\n\n\t\t\t$original_image_size = filesize( $image_path_or_string );\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$image_path_or_string = $input;\n\n\t\t\t// http://stackoverflow.com/questions/5373544/php-size-of-base64-encode-string-file\n\t\t\t$original_image_size = (int) ( strlen( rtrim( $image_path_or_string, '=' ) ) * 3 / 4 );\n\t\t}\n\n\t\t// Build file name.\n\t\tif ( $file_name_no_ext )\n\t\t{\n\t\t\t$file_name = $file_name_no_ext . $final_ext;\n\t\t}\n\t\telseif ( $is_base64 )\n\t\t{\n\t\t\t// Use MD5 sum for base64 images.\n\t\t\t$file_name = md5( $image_path_or_string ) . $final_ext;\n\n\t\t\t$full_path = $path . $file_name;\n\n\t\t\t// Check if file already exists?\n\t\t\tif ( $final_ext\n\t\t\t\t&& file_exists( $full_path ) )\n\t\t\t{\n\t\t\t\treturn $full_path;\n\t\t\t}\n\t\t\telseif ( file_exists( $full_path . '.jpg' ) )\n\t\t\t{\n\t\t\t\treturn $full_path . '.jpg';\n\t\t\t}\n\t\t\telseif ( file_exists( $full_path . '.png' ) )\n\t\t\t{\n\t\t\t\treturn $full_path . '.png';\n\t\t\t}\n\t\t\telseif ( file_exists( $full_path . '.gif' ) )\n\t\t\t{\n\t\t\t\treturn $full_path . '.gif';\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// Use original file name.\n\t\t\t$file_name = no_accents( mb_substr(\n\t\t\t\t$_FILES[ $input ]['name'],\n\t\t\t\t0,\n\t\t\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t\t\t) ) . $final_ext;\n\t\t}\n\n\t\t$extension = null;\n\n\t\tif ( $final_ext )\n\t\t{\n\t\t\tif ( mb_strtolower( $final_ext ) === '.jpg'\n\t\t\t\t|| mb_strtolower( $final_ext ) === '.jpeg' )\n\t\t\t{\n\t\t\t\t$extension = IMAGETYPE_JPEG;\n\t\t\t}\n\t\t\telseif ( mb_strtolower( $final_ext ) === '.png' )\n\t\t\t{\n\t\t\t\t$extension = IMAGETYPE_PNG;\n\t\t\t}\n\t\t\telseif ( mb_strtolower( $final_ext ) === '.gif' )\n\t\t\t{\n\t\t\t\t$extension = IMAGETYPE_GIF;\n\t\t\t}\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\t$target_jpg_compression = 85;\n\n\t\t\t$image_resize_gd = new ImageResizeGD(\n\t\t\t\t$image_path_or_string,\n\t\t\t\t$target_jpg_compression,\n\t\t\t\t9,\n\t\t\t\t$PNGQuantPath\n\t\t\t);\n\n\t\t\t// 3x or 2x Retina factor depending if small target image.\n\t\t\t$factor = $target_dim['width'] < 994 ? 3 : 2;\n\n\t\t\tif ( $image_resize_gd->getSourceWidth() > $target_dim['width'] * $factor\n\t\t\t\t|| $image_resize_gd->getSourceHeight() > $target_dim['height'] * $factor )\n\t\t\t{\n\t\t\t\t// Image dimensions > target dimensions *2 or 3 (enough for Retina), resize & compress more.\n\t\t\t\t$image_resize_gd->resizeWithinDimensions(\n\t\t\t\t\t$target_dim['width'] * $factor,\n\t\t\t\t\t$target_dim['height'] * $factor\n\t\t\t\t);\n\n\t\t\t\t$target_jpg_compression = 65;\n\t\t\t}\n\t\t\telseif ( $image_resize_gd->getSourceWidth() > $target_dim['width']\n\t\t\t\t|| $image_resize_gd->getSourceHeight() > $target_dim['height'] )\n\t\t\t{\n\t\t\t\t// Image dimensions > target dimensions, compress a bit more.\n\t\t\t\t$target_jpg_compression = 75;\n\t\t\t}\n\n\t\t\t// Upload image and return path.\n\t\t\t$full_path = $image_resize_gd->saveImageFile(\n\t\t\t\t$path . $file_name,\n\t\t\t\t$extension,\n\t\t\t\t$target_jpg_compression,\n\t\t\t\t// White background for JPEG.\n\t\t\t\t( $extension === IMAGETYPE_JPEG ? 'FFFFFF' : null )\n\t\t\t);\n\n\t\t\tif ( filesize( $full_path ) < $original_image_size\n\t\t\t\t|| ( $extension && $extension !== $image_resize_gd->getSourceType() ) )\n\t\t\t{\n\t\t\t\treturn $full_path;\n\t\t\t}\n\t\t\telseif ( $is_base64 )\n\t\t\t{\n\t\t\t\t// Our \"optimized\" file results bigger than the original one...\n\t\t\t\t$image_data = $image_path_or_string;\n\n\t\t\t\t$image_data = substr( $image_data, ( strpos( $image_data, 'base64' ) + 6 ) );\n\n\t\t\t\t$image_data = base64_decode( $image_data );\n\n\t\t\t\t// Save the original base64 image instead.\n\t\t\t\tfile_put_contents( $full_path, $image_data );\n\n\t\t\t\treturn $full_path;\n\t\t\t}\n\t\t}\n\t\tcatch ( Exception $e )\n\t\t{\n\t\t\t$error[] = 'ImageResizeGD: ' . $e->getMessage();\n\t\t}\n\t\tcatch ( InvalidArgumentException $e )\n\t\t{\n\t\t\t$error[] = 'ImageResizeGD: ' . $e->getMessage();\n\t\t}\n\t}\n\n\t// No GD library or ImageResizeGD exception...\n\tif ( $is_base64 )\n\t{\n\t\t// We return the base64 image as is...\n\t\treturn $input;\n\t}\n\n\t// Use regular FileUpload() function.\n\treturn (string) FileUpload(\n\t\t$input,\n\t\t$path,\n\t\t$ext_white_list,\n\t\t0,\n\t\t$error,\n\t\t(string) $final_ext,\n\t\t$file_name_no_ext\n\t);\n}\n\n\n/**\n * Files field Upload and Update\n * Upload custom Files field & update corresponding DB table.\n * Input name must BEGIN with $request, for example: \"valuesCUSTOM_3\".\n *\n * @since 4.6\n * @since 10.4 Add optional $id param\n *\n * @example FilesUploadUpdate( 'schools', 'values',\t$FileUploadsPath . 'Schools/' . UserSchool() . '/' );\n * @example FilesUploadUpdate( $table, 'tables' . $id, $FileUploadsPath . 'Hostel/', $id );\n *\n * @uses FileUpload()\n *\n * @param string $table   DB Table name.\n * @param string $request Request part of the input name.\n * @param string $path    Path, folder where the files will be uploaded to.\n * @param int    $id      Table row ID. Optional.\n *\n * @return string Empty or last file full path.\n */\nfunction FilesUploadUpdate( $table, $request, $path, $id = 0 )\n{\n\tglobal $error;\n\n\tif ( ! $table\n\t\t|| ! $path\n\t\t|| empty( $_FILES ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$table = mb_strtolower( $table );\n\n\t$new_file = '';\n\n\tforeach ( $_FILES as $input => $file )\n\t{\n\t\tif ( mb_strpos( $input, $request ) !== 0 )\n\t\t{\n\t\t\t// Input name must BEGIN with $request, for example: \"valuesCUSTOM_3\".\n\t\t\tcontinue;\n\t\t}\n\n\t\t$file_name_no_ext = no_accents( mb_substr(\n\t\t\t$_FILES[ $input ]['name'],\n\t\t\t0,\n\t\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t\t) );\n\n\t\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' );\n\n\t\t$new_file = FileUpload(\n\t\t\t$input,\n\t\t\t$path,\n\t\t\tFileExtensionWhiteList(),\n\t\t\t0,\n\t\t\t$error,\n\t\t\t'',\n\t\t\t$file_name_no_ext\n\t\t);\n\n\t\tif ( $new_file )\n\t\t{\n\t\t\t$value_append = $new_file . '||';\n\n\t\t\t$column = str_replace( $request, '', $input );\n\n\t\t\tif ( $table === 'schools' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : UserSchool();\n\n\t\t\t\t$where_sql = \"ID='\" . (int) $id . \"' AND SYEAR='\" . UserSyear() . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'students' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : UserStudentID();\n\n\t\t\t\t$where_sql = \"STUDENT_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'address' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : $_REQUEST['address_id'];\n\n\t\t\t\t$where_sql = \"ADDRESS_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'people' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : $_REQUEST['person_id'];\n\n\t\t\t\t$where_sql = \"PERSON_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'staff' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : UserStaffID();\n\n\t\t\t\t$where_sql = \"STAFF_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$id = $id ? $id : $_REQUEST['id'];\n\n\t\t\t\t$where_sql = \"ID='\" . (int) $id . \"'\";\n\t\t\t}\n\n\t\t\tDBQuery( \"UPDATE \" . DBEscapeIdentifier( $table ) . \"\n\t\t\t\tSET \" . DBEscapeIdentifier( $column ) . \"=CONCAT(COALESCE(\" .\n\t\t\t\tDBEscapeIdentifier( $column ) . \",''),'\" . DBEscapeString( $value_append ) . \"')\n\t\t\t\tWHERE \" . $where_sql );\n\t\t}\n\t}\n\n\treturn $new_file;\n}\n\n/**\n * Handle `multiple` files attribute for FileUpload().\n * Move $_FILES[ $input ][...][ $i ] to $_FILES[ {$input}_{$i} ] so FileUpload() can handle it.\n *\n * @since 7.8\n *\n * @example foreach ( FileUploadMultiple( 'files' ) as $input ) { FileUpload( $input ) }\n *\n * @param string $input Input name, without square brackets [].\n *\n * @return array Empty if no files. $input if not multiple. {$input}_{$i} if multiple.\n */\nfunction FileUploadMultiple( $input )\n{\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn [];\n\t}\n\n\tif ( ! is_array( $_FILES[ $input ]['name'] ) )\n\t{\n\t\t// Not multiple files, return $input.\n\t\treturn [ $input ];\n\t}\n\n\t$inputs = [];\n\n\t$files = [];\n\n\tforeach ( $_FILES[ $input ] as $attribute => $files_info )\n\t{\n\t\tforeach ( $files_info as $i => $file_info )\n\t\t{\n\t\t\tif ( ! isset( $files[ $i ] ) )\n\t\t\t{\n\t\t\t\t$files[ $i ] = [];\n\t\t\t}\n\n\t\t\t$files[ $i ][ $attribute ] = $file_info;\n\t\t}\n\t}\n\n\tforeach ( $files as $i => $file )\n\t{\n\n\t\t$input_new_index = $input . '_' . $i;\n\n\t\t$inputs[] = $input_new_index;\n\n\t\t// Move $_FILES[ $input ][...][ $i ] to $_FILES[ {$input}_{$i} ] so FileUpload() can handle it.\n\t\t$_FILES[ $input_new_index ] = $file;\n\t}\n\n\tunset( $_FILES[ $input ] );\n\n\treturn $inputs;\n}\n\n/**\n * Removes accents from string.\n * Also replaces characters others than letters, space, numbers & points\n * with underscores '_'.\n * Perfect to sanitize a filename.\n *\n * @since 3.4 uses PHP intl extension or return microtime in case string does not contain ASCII chars.\n * @since 8.2 Fix replace regex: remove slash & allow space\n *\n * @link http://stackoverflow.com/questions/1017599/how-do-i-remove-accents-from-characters-in-a-php-string\n *\n * @example no_accents( '\u0440\u0443\u043b\u043e\u043d\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439' )\n * Will return 'rulonpol_zovatelej' if PHP intl extension is activated\n * Else it will return microtime, for example '14976328319110'\n *\n * @example no_accents( '\u96c6\u56e2\u5206\u914d\u5b66\u751f\u4fe1\u606f' )\n * Will return 'ji_tuan_fen_pei_xue_sheng_xin_xi' if PHP intl extension is activated\n * Else it will return microtime, for example '14976328319110'\n *\n * @param string $string String with maybe accents.\n *\n * @return string String with no accents or microtime.\n */\nfunction no_accents( $string )\n{\n\tif ( ! preg_match( '/[\\x80-\\xff]/', $string) )\n\t{\n\t\t// Replace characters others than letters, space, numbers & points with underscores  \"_\".\n\t\t$string = preg_replace(\n\t\t\t'/([^ _\\-.a-z0-9]+)/i',\n\t\t\t'_',\n\t\t\t$string\n\t\t);\n\t}\n\n\tif ( function_exists( 'transliterator_transliterate' ) )\n\t{\n\t\t/**\n\t\t * Requires PHP intl extension.\n\t\t * Will transliterate to latin ASCII chars.\n\t\t *\n\t\t * @example \u0440\u0443\u043b\u043e\u043d\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 => rulonpol_zovatelej\n\t\t * @example \u96c6\u56e2\u5206\u914d\u5b66\u751f\u4fe1\u606f => ji_tuan_fen_pei_xue_sheng_xin_xi\n\t\t */\n\t\t$string = transliterator_transliterate(\n\t\t\t'Any-Latin; Latin-ASCII; Lower()',\n\t\t\t$string\n\t\t);\n\n\t\t// Replace characters others than letters, space, numbers & points with underscores  \"_\".\n\t\t$string = preg_replace(\n\t\t\t'/([^ _\\-.a-z0-9]+)/i',\n\t\t\t'_',\n\t\t\t$string\n\t\t);\n\n\t\treturn $string;\n\t}\n\n\t$c195 = chr( 195 );\n\t$c196 = chr( 196 );\n\t$c197 = chr( 197 );\n\n\t$chars = [\n\t// Decompositions for Latin-1 Supplement.\n\t$c195 . chr(128) => 'A', $c195 . chr(129) => 'A',\n\t$c195 . chr(130) => 'A', $c195 . chr(131) => 'A',\n\t$c195 . chr(132) => 'A', $c195 . chr(133) => 'A',\n\t$c195 . chr(135) => 'C', $c195 . chr(136) => 'E',\n\t$c195 . chr(137) => 'E', $c195 . chr(138) => 'E',\n\t$c195 . chr(139) => 'E', $c195 . chr(140) => 'I',\n\t$c195 . chr(141) => 'I', $c195 . chr(142) => 'I',\n\t$c195 . chr(143) => 'I', $c195 . chr(145) => 'N',\n\t$c195 . chr(146) => 'O', $c195 . chr(147) => 'O',\n\t$c195 . chr(148) => 'O', $c195 . chr(149) => 'O',\n\t$c195 . chr(150) => 'O', $c195 . chr(153) => 'U',\n\t$c195 . chr(154) => 'U', $c195 . chr(155) => 'U',\n\t$c195 . chr(156) => 'U', $c195 . chr(157) => 'Y',\n\t$c195 . chr(159) => 's', $c195 . chr(160) => 'a',\n\t$c195 . chr(161) => 'a', $c195 . chr(162) => 'a',\n\t$c195 . chr(163) => 'a', $c195 . chr(164) => 'a',\n\t$c195 . chr(165) => 'a', $c195 . chr(167) => 'c',\n\t$c195 . chr(168) => 'e', $c195 . chr(169) => 'e',\n\t$c195 . chr(170) => 'e', $c195 . chr(171) => 'e',\n\t$c195 . chr(172) => 'i', $c195 . chr(173) => 'i',\n\t$c195 . chr(174) => 'i', $c195 . chr(175) => 'i',\n\t$c195 . chr(177) => 'n', $c195 . chr(178) => 'o',\n\t$c195 . chr(179) => 'o', $c195 . chr(180) => 'o',\n\t$c195 . chr(181) => 'o',\n\t$c195 . chr(182) => 'o', $c195 . chr(185) => 'u',\n\t$c195 . chr(186) => 'u', $c195 . chr(187) => 'u',\n\t$c195 . chr(188) => 'u', $c195 . chr(189) => 'y',\n\t$c195 . chr(191) => 'y',\n\t// Decompositions for Latin Extended-A.\n\t$c196 . chr(128) => 'A', $c196 . chr(129) => 'a',\n\t$c196 . chr(130) => 'A', $c196 . chr(131) => 'a',\n\t$c196 . chr(132) => 'A', $c196 . chr(133) => 'a',\n\t$c196 . chr(134) => 'C', $c196 . chr(135) => 'c',\n\t$c196 . chr(136) => 'C', $c196 . chr(137) => 'c',\n\t$c196 . chr(138) => 'C', $c196 . chr(139) => 'c',\n\t$c196 . chr(140) => 'C', $c196 . chr(141) => 'c',\n\t$c196 . chr(142) => 'D', $c196 . chr(143) => 'd',\n\t$c196 . chr(144) => 'D', $c196 . chr(145) => 'd',\n\t$c196 . chr(146) => 'E', $c196 . chr(147) => 'e',\n\t$c196 . chr(148) => 'E', $c196 . chr(149) => 'e',\n\t$c196 . chr(150) => 'E', $c196 . chr(151) => 'e',\n\t$c196 . chr(152) => 'E', $c196 . chr(153) => 'e',\n\t$c196 . chr(154) => 'E', $c196 . chr(155) => 'e',\n\t$c196 . chr(156) => 'G', $c196 . chr(157) => 'g',\n\t$c196 . chr(158) => 'G', $c196 . chr(159) => 'g',\n\t$c196 . chr(160) => 'G', $c196 . chr(161) => 'g',\n\t$c196 . chr(162) => 'G', $c196 . chr(163) => 'g',\n\t$c196 . chr(164) => 'H', $c196 . chr(165) => 'h',\n\t$c196 . chr(166) => 'H', $c196 . chr(167) => 'h',\n\t$c196 . chr(168) => 'I', $c196 . chr(169) => 'i',\n\t$c196 . chr(170) => 'I', $c196 . chr(171) => 'i',\n\t$c196 . chr(172) => 'I', $c196 . chr(173) => 'i',\n\t$c196 . chr(174) => 'I', $c196 . chr(175) => 'i',\n\t$c196 . chr(176) => 'I', $c196 . chr(177) => 'i',\n\t$c196 . chr(178) => 'IJ',$c196 . chr(179) => 'ij',\n\t$c196 . chr(180) => 'J', $c196 . chr(181) => 'j',\n\t$c196 . chr(182) => 'K', $c196 . chr(183) => 'k',\n\t$c196 . chr(184) => 'k', $c196 . chr(185) => 'L',\n\t$c196 . chr(186) => 'l', $c196 . chr(187) => 'L',\n\t$c196 . chr(188) => 'l', $c196 . chr(189) => 'L',\n\t$c196 . chr(190) => 'l', $c196 . chr(191) => 'L',\n\t$c197 . chr(128) => 'l', $c197 . chr(129) => 'L',\n\t$c197 . chr(130) => 'l', $c197 . chr(131) => 'N',\n\t$c197 . chr(132) => 'n', $c197 . chr(133) => 'N',\n\t$c197 . chr(134) => 'n', $c197 . chr(135) => 'N',\n\t$c197 . chr(136) => 'n', $c197 . chr(137) => 'N',\n\t$c197 . chr(138) => 'n', $c197 . chr(139) => 'N',\n\t$c197 . chr(140) => 'O', $c197 . chr(141) => 'o',\n\t$c197 . chr(142) => 'O', $c197 . chr(143) => 'o',\n\t$c197 . chr(144) => 'O', $c197 . chr(145) => 'o',\n\t$c197 . chr(146) => 'OE',$c197 . chr(147) => 'oe',\n\t$c197 . chr(148) => 'R', $c197 . chr(149) => 'r',\n\t$c197 . chr(150) => 'R', $c197 . chr(151) => 'r',\n\t$c197 . chr(152) => 'R', $c197 . chr(153) => 'r',\n\t$c197 . chr(154) => 'S', $c197 . chr(155) => 's',\n\t$c197 . chr(156) => 'S', $c197 . chr(157) => 's',\n\t$c197 . chr(158) => 'S', $c197 . chr(159) => 's',\n\t$c197 . chr(160) => 'S', $c197 . chr(161) => 's',\n\t$c197 . chr(162) => 'T', $c197 . chr(163) => 't',\n\t$c197 . chr(164) => 'T', $c197 . chr(165) => 't',\n\t$c197 . chr(166) => 'T', $c197 . chr(167) => 't',\n\t$c197 . chr(168) => 'U', $c197 . chr(169) => 'u',\n\t$c197 . chr(170) => 'U', $c197 . chr(171) => 'u',\n\t$c197 . chr(172) => 'U', $c197 . chr(173) => 'u',\n\t$c197 . chr(174) => 'U', $c197 . chr(175) => 'u',\n\t$c197 . chr(176) => 'U', $c197 . chr(177) => 'u',\n\t$c197 . chr(178) => 'U', $c197 . chr(179) => 'u',\n\t$c197 . chr(180) => 'W', $c197 . chr(181) => 'w',\n\t$c197 . chr(182) => 'Y', $c197 . chr(183) => 'y',\n\t$c197 . chr(184) => 'Y', $c197 . chr(185) => 'Z',\n\t$c197 . chr(186) => 'z', $c197 . chr(187) => 'Z',\n\t$c197 . chr(188) => 'z', $c197 . chr(189) => 'Z',\n\t$c197 . chr(190) => 'z', $c197 . chr(191) => 's'\n\t];\n\n\t$string = strtr( $string, $chars );\n\n\t// Replace characters others than letters, space, numbers & points with underscores  \"_\".\n\t$string = preg_replace(\n\t\t'/([^ _\\-.a-z0-9]+)/i',\n\t\t'_',\n\t\t$string\n\t);\n\n\tif ( $string === '_' )\n\t{\n\t\t// String does not contain any latin ASCII char return microtime!\n\t\t$string = number_format( microtime( true ), 4, '', '' );\n\t}\n\n\treturn $string;\n}\n\n\n\n/**\n * Get server maximum file upload size (Mb)\n *\n * @see  php.ini directives (upload_max_filesize & post_max_size)\n *\n * @uses ReturnMegabytes() function\n *\n * @return float maximum file upload size in Mega Bytes (Mb)\n */\nfunction FileUploadMaxSize()\n{\n\t// Size is limited by server configuration (upload_max_filesize & post_max_size).\n\treturn (float) min(\n\t\tReturnMegabytes( ini_get( 'post_max_size' ) ),\n\t\tReturnMegabytes( ini_get( 'upload_max_filesize' ) )\n\t);\n}\n\n\n/**\n * Return value in Mega Bytes (MB)\n *\n * @example ReturnMegabytes( ini_get( 'upload_max_filesize' ) )\n *\n * @param  string $val php.ini value, shorthand notation.\n *\n * @return string      value in Mega Bytes (MB)\n */\nfunction ReturnMegabytes( $val ) {\n\n\t$val = trim( $val );\n\n\t$last = strtolower( $val[ strlen( $val ) - 1 ] );\n\n\t$val = (int) $val;\n\n\tswitch ( $last ) {\n\n\t\t// The 'G' modifier is available since PHP 5.1.0.\n\t\tcase 'g':\n\n\t\t\t$val *= 1024;\n\n\t\tcase 'm':\n\n\t\t\t$val *= 1;\n\n\t\tbreak;\n\n\t\tdefault:\n\n\t\t\t$val /= 1024;\n\n\t\tcase 'k':\n\n\t\t\t$val /= 1024;\n\t}\n\n\treturn $val;\n}\n\n\n/**\n * Human filesize\n * Converts bytes into human readable file size.\n *\n * @example $file_size = HumanFilesize( filesize( $file_name ) );\n *\n * @link http://php.net/manual/en/function.filesize.php#106569\n *\n * @since  2.9\n *\n * @param  integer $bytes    File size in Bytes.\n * @param  integer $decimals Decimals (optional). Defaults to 1.\n *\n * @return string            Human readable file size.\n */\nfunction HumanFilesize( $bytes, $decimals = 1 )\n{\n\t$sz = 'BKMGTP';\n\n\t$factor = floor( ( strlen( $bytes ) - 1 ) / 3 );\n\n\treturn sprintf( \"%.{$decimals}f\", $bytes / pow( 1024, $factor ) ) . @$sz[ $factor ];\n}\n\n\n/**\n * Extensions white list.\n * Common file types.\n * Obviously, we won't include executable types\n * .php, .sql, .js, .exe...\n * If you file type is not white listed,\n * put it in a ZIP archive!\n *\n * @since 3.8.1\n *\n * @link http://fileinfo.com/filetypes/common\n */\nfunction FileExtensionWhiteList() {\n\treturn [\n\t\t// Micro$oft Office.\n\t\t'.doc',\n\t\t'.docx',\n\t\t'.dotx',\n\t\t'.xls',\n\t\t'.xlsm',\n\t\t'.xlsx',\n\t\t'.xlr',\n\t\t'.pps',\n\t\t'.ppsx',\n\t\t'.ppt',\n\t\t'.pptx',\n\t\t'.wps',\n\t\t'.wpd',\n\t\t'.rtf',\n\t\t'.mdb',\n\t\t'.sldx',\n\t\t// Libre Office.\n\t\t'.odt',\n\t\t'.ods',\n\t\t'.odp',\n\t\t'.odg',\n\t\t'.odc',\n\t\t'.odb',\n\t\t'.odf',\n\t\t// Apple iWork.\n\t\t'.key',\n\t\t'.numbers',\n\t\t'.pages',\n\t\t// Images.\n\t\t'.jpg',\n\t\t'.jpeg',\n\t\t'.png',\n\t\t'.gif',\n\t\t'.bmp',\n\t\t// @since 8.9.3 Fix stored XSS security issue: do not allow unsanitized SVG\n\t\t// '.svg',\n\t\t'.ico',\n\t\t'.psd',\n\t\t'.ai',\n\t\t'.eps',\n\t\t'.ps',\n\t\t'.webp',\n\t\t// Audio.\n\t\t'.mp3',\n\t\t'.m4a',\n\t\t'.ogg',\n\t\t'.wav',\n\t\t'.mid',\n\t\t'.midi',\n\t\t'.wma',\n\t\t'.aif',\n\t\t'.flac',\n\t\t'.mka',\n\t\t// Video.\n\t\t'.avi',\n\t\t'.mp4',\n\t\t'.mpg',\n\t\t'.mpeg',\n\t\t'.ogv',\n\t\t'.webm',\n\t\t'.wmv',\n\t\t'.h264',\n\t\t'.mkv',\n\t\t'.mov',\n\t\t'.m4v',\n\t\t'.flv', // @deprecated Adobe Flash.\n\t\t'.swf', // @deprecated Adobe Flash.\n\t\t// Text.\n\t\t'.txt',\n\t\t'.pdf',\n\t\t'.md',\n\t\t'.csv',\n\t\t'.tsv',\n\t\t'.tex',\n\t\t'.log',\n\t\t'.json',\n\t\t'.ics',\n\t\t// Email.\n\t\t'.email',\n\t\t'.eml',\n\t\t'.emlx',\n\t\t'.msg',\n\t\t'.vcf',\n\t\t// Web.\n\t\t// @since 8.9.5 Fix stored XSS security issue: do not allow unsanitized XML & HTML\n\t\t// '.xml',\n\t\t// '.xhtml',\n\t\t// '.html',\n\t\t// '.htm',\n\t\t'.css',\n\t\t'.rss',\n\t\t// Compressed.\n\t\t'.zip',\n\t\t'.rar',\n\t\t'.7z',\n\t\t'.tar',\n\t\t'.gz',\n\t];\n}\n", "<?php\nfunction _makeIncomesRemove( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\treturn button(\n\t\t'remove',\n\t\t_( 'Delete' ),\n\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] . '&modfunc=remove&id=' . $THIS_RET['ID'] ) . '\"'\n\t);\n}\n\nfunction _makeSalariesRemove( $value, $column )\n{\n\treturn _makeIncomesRemove( $value, $column );\n}\n\nfunction _makePaymentsRemove( $value, $column )\n{\n\treturn _makeIncomesRemove( $value, $column );\n}\n\nfunction _makeIncomesTextInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t\t$div = 'force';\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t\t$div = false;\n\t}\n\n\t$extra = 'maxlength=255';\n\n\tif ( $column === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput( $value, 'values[' . $id . '][' . $column . ']', '', $extra, $div );\n}\n\n\nfunction _makeIncomesDateInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\treturn DateInput( $value, 'values[' . $id . '][' . $column . ']', '', ( $id !== 'new' ), false );\n}\n\nfunction _makePaymentsDateInput( $value, $name )\n{\n\treturn _makeIncomesDateInput( $value, $name );\n}\n\nfunction _makeSalariesTextInput( $value, $name )\n{\n\treturn _makeIncomesTextInput( $value, $name );\n}\n\nfunction _makeSalariesDateInput( $value, $name )\n{\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$name = 'values[' . $id . '][' . $name . ']';\n\n\treturn DateInput( $value, $name );\n}\n\nfunction _makePaymentsTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\t$extra = 'maxlength=255';\n\n\tif ( $name === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput( $value, 'values[' . $id . '][' . $name . ']', '', $extra );\n}\n\n\n/**\n * Make Payments Comments Input\n * Add Salaries dropdown to reconcile Payment:\n * Automatically fills the Comments & Amount inputs.\n *\n * @since 5.1\n * @since 7.7 Remove Salaries having a Payment (same Amount & Comments (Title), after or on Assigned Date).\n *\n * @uses _makePaymentsTextInput()\n *\n * @param  string $value Comments value.\n * @param  string $name  Column name, 'COMMENTS'.\n *\n * @return string Text input if not new or if no Salaries found, else Text input & Salaries dropdown.\n */\nfunction _makePaymentsCommentsInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\t$text_input = _makePaymentsTextInput( $value, $name );\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t// Add Salaries dropdown to reconcile Payment.\n\t$salaries_RET = DBGet( \"SELECT ID,TITLE,ASSIGNED_DATE,DUE_DATE,AMOUNT\n\t\tFROM accounting_salaries sal\n\t\tWHERE STAFF_ID='\" . UserStaffID() . \"'\n\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\tAND NOT EXISTS(SELECT 1\n\t\t\tFROM accounting_payments\n\t\t\tWHERE STAFF_ID='\" . UserStaffID() . \"'\n\t\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\t\tAND AMOUNT=sal.AMOUNT\n\t\t\tAND (COMMENTS=sal.TITLE OR COMMENTS LIKE CONCAT('%',sal.TITLE) OR COMMENTS LIKE CONCAT(sal.TITLE,'%'))\n\t\t\tAND PAYMENT_DATE>=sal.ASSIGNED_DATE)\n\t\tORDER BY ASSIGNED_DATE DESC\n\t\tLIMIT 20\" );\n\n\tif ( ! $salaries_RET )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t$salaries_options = [];\n\n\tforeach ( $salaries_RET as $salary )\n\t{\n\t\t$salaries_options[ $salary['AMOUNT'] . '|' . $salary['TITLE'] ] = ProperDate( $salary['ASSIGNED_DATE'], 'short' ) .\n\t\t\t' \u2014 ' . Currency( $salary['AMOUNT'] ) .\n\t\t\t' \u2014 ' . $salary['TITLE'];\n\t}\n\n\t// JS automatically fills the Comments & Amount inputs.\n\tob_start();\n\t?>\n\t<script>\n\t\tvar accountingPaymentsSalariesReconcile = function( amountComments ) {\n\t\t\tvar separatorIndex = amountComments.indexOf( '|' ),\n\t\t\t\tamount = amountComments.substring( 0, separatorIndex ),\n\t\t\t\tcomments = amountComments.substring( separatorIndex + 1 );\n\n\t\t\t$('#valuesnewAMOUNT').val( amount );\n\t\t\t$('#valuesnewCOMMENTS').val( comments );\n\t\t};\n\t</script>\n\t<?php\n\t$js = ob_get_clean();\n\n\t// Select so we can search Salaries by date, amount, & title.\n\t$select_input = SelectInput(\n\t\t'',\n\t\t'accounting_salaries',\n\t\t'',\n\t\t$salaries_options,\n\t\t'N/A',\n\t\t'onchange=\"accountingPaymentsSalariesReconcile(this.value);\" style=\"width: 250px;\"'\n\t);\n\n\treturn $text_input . ' ' . $js . $select_input;\n}\n\nfunction _makeSalariesAmount( $value, $column )\n{\n\tglobal $salaries_total;\n\n\t$salaries_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _makeIncomesAmount( $value, $column )\n{\n\tglobal $incomes_total;\n\n\t$incomes_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _makePaymentsAmount( $value, $column )\n{\n\tglobal $payments_total;\n\n\t$payments_total += $value;\n\n\treturn Currency( $value );\n}\n\n/**\n * Make Salaries File Attached Input\n *\n * @since 8.1\n * @since 10.4 Add File Attached Input for existing Salaries\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makeSalariesFileInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn FileInput(\n\t\t\t'FILE_ATTACHED'\n\t\t);\n\t}\n\n\tif ( empty( $value )\n\t\t|| ! file_exists( $value ) )\n\t{\n\t\tif ( isset( $_REQUEST['_ROSARIO_PDF'] )\n\t\t\t|| ! AllowEdit() )\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\t// Add hidden FILE_ATTACHED input so it gets saved even if no other columns to save.\n\t\treturn '<input type=\"hidden\" name=\"values[' . $THIS_RET['ID'] . '][FILE_ATTACHED]\" value=\"\" />' .\n\t\tFileInput(\n\t\t\t'FILE_ATTACHED_' . $THIS_RET['ID']\n\t\t);\n\t}\n\n\tif ( ! empty( $_REQUEST['LO_save'] ) )\n\t{\n\t\t// Export list.\n\t\treturn $value;\n\t}\n\n\t$file_path = $value;\n\n\t$file_name = mb_substr( mb_strrchr( $file_path, '/' ), 1 );\n\n\t$file_size = HumanFilesize( filesize( $file_path ) );\n\n\t// Truncate file name if > 36 chars.\n\t$file_name_display = mb_strlen( $file_name ) <= 36 ?\n\t\t$file_name :\n\t\tmb_substr( $file_name, 0, 30 ) . '..' . mb_strrchr( $file_name, '.' );\n\n\t$file = button(\n\t\t'download',\n\t\t$file_name_display,\n\t\t'\"' . URLEscape( $file_path ) . '\" target=\"_blank\" title=\"' . AttrEscape( $file_name . ' (' . $file_size . ')' ) . '\"',\n\t\t'bigger'\n\t);\n\n\treturn $file;\n}\n\n/**\n * Make Payments File Attached Input\n *\n * @since 8.3\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makePaymentsFileInput( $value, $column )\n{\n\treturn _makeSalariesFileInput( $value, $column );\n}\n\n/**\n * Make Incomes File Attached Input\n *\n * @since 8.4\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makeIncomesFileInput( $value, $column )\n{\n\treturn _makeSalariesFileInput( $value, $column );\n}\n\n/**\n * Save Salaries File\n *\n * @since 10.4\n * @since 10.8.2 Add datetime to filename to make it harder to predict\n *\n * @param  int|string $id Salary ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveSalariesFile( $id )\n{\n\tglobal $error,\n\t\t$FileUploadsPath;\n\n\t$input = $id === 'new' ? 'FILE_ATTACHED' : 'FILE_ATTACHED_' . $id;\n\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name_no_ext = no_accents( mb_substr(\n\t\t$_FILES[ $input ]['name'],\n\t\t0,\n\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t) );\n\n\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' );\n\n\t$file_attached = FileUpload(\n\t\t$input,\n\t\t$FileUploadsPath . UserSyear() . '/staff_' . UserStaffID() . '/',\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\t// Fix SQL error when quote in uploaded file name.\n\treturn DBEscapeString( $file_attached );\n}\n\n/**\n * Save Payments File\n *\n * @since 10.4\n *\n * @param  int|string $id Payment ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _savePaymentsFile( $id )\n{\n\treturn _saveSalariesFile( $id );\n}\n\n/**\n * Save Incomes File\n *\n * @since 10.4\n * @since 10.8.2 Add datetime to filename to make it harder to predict\n *\n * @param  int|string $id Income ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveIncomesFile( $id )\n{\n\tglobal $error,\n\t\t$FileUploadsPath;\n\n\t$input = $id === 'new' ? 'FILE_ATTACHED' : 'FILE_ATTACHED_' . $id;\n\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name_no_ext = no_accents( mb_substr(\n\t\t$_FILES[ $input ]['name'],\n\t\t0,\n\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t) );\n\n\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' );\n\n\t$file_attached = FileUpload(\n\t\t$input,\n\t\t$FileUploadsPath . UserSyear() . '/staff_' . User( 'STAFF_ID' ) . '/',\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\t// Fix SQL error when quote in uploaded file name.\n\treturn DBEscapeString( $file_attached );\n}\n\n/**\n * Save Expenses File\n *\n * @since 10.4\n *\n * @param  int|string $id Expense ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveExpensesFile( $id )\n{\n\treturn _saveIncomesFile( $id );\n}\n", "<?php\nrequire_once 'ProgramFunctions/PortalPollsNotes.fnc.php';\nrequire_once 'ProgramFunctions/FileUpload.fnc.php';\nrequire_once 'ProgramFunctions/MarkDownHTML.fnc.php';\n\nDrawHeader( ProgramTitle() );\n\n// Add eventual Dates to $_REQUEST['values'].\nAddRequestedDates( 'values', 'post' );\n\n$profiles_RET = DBGet( \"SELECT ID,TITLE FROM user_profiles ORDER BY ID\" );\n\nif ( $_REQUEST['modfunc'] === 'update'\n\t&& (  ( $_REQUEST['profiles']\n\t\t&& $_POST['profiles'] )\n\t\t|| ( $_REQUEST['values']\n\t\t\t&& $_POST['values'] ) )\n\t&& AllowEdit() )\n{\n\t$notes_RET = DBGet( \"SELECT ID FROM portal_notes WHERE SCHOOL_ID='\" . UserSchool() . \"' AND SYEAR='\" . UserSyear() . \"'\" );\n\n\tforeach ( (array) $notes_RET as $note_id )\n\t{\n\t\t$note_id = $note_id['ID'];\n\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] = '';\n\n\t\tforeach ( [ 'admin', 'teacher', 'parent' ] as $profile_id )\n\t\t{\n\t\t\tif ( ! empty( $_REQUEST['profiles'][$note_id][$profile_id] ) )\n\t\t\t{\n\t\t\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] .= ',' . $profile_id;\n\t\t\t}\n\t\t}\n\n\t\tif ( ! empty( $_REQUEST['profiles'][$note_id] ) )\n\t\t{\n\t\t\tforeach ( (array) $profiles_RET as $profile )\n\t\t\t{\n\t\t\t\t$profile_id = $profile['ID'];\n\n\t\t\t\tif ( ! empty( $_REQUEST['profiles'][$note_id][$profile_id] ) )\n\t\t\t\t{\n\t\t\t\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] .= ',' . $profile_id;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ( ! empty( $_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] ) )\n\t\t{\n\t\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] .= ',';\n\t\t}\n\t}\n}\n\nif ( $_REQUEST['modfunc'] === 'update'\n\t&& $_REQUEST['values']\n\t&& $_POST['values']\n\t&& AllowEdit() )\n{\n\tforeach ( (array) $_REQUEST['values'] as $id => $columns )\n\t{\n\t\t// FJ fix SQL bug invalid sort order.\n\n\t\tif ( empty( $columns['SORT_ORDER'] ) || is_numeric( $columns['SORT_ORDER'] ) )\n\t\t{\n\t\t\t// FJ textarea fields MarkDown sanitize.\n\n\t\t\tif ( isset( $columns['CONTENT'] ) )\n\t\t\t{\n\t\t\t\t$columns['CONTENT'] = DBEscapeString( SanitizeMarkDown( $_POST['values'][$id]['CONTENT'] ) );\n\t\t\t}\n\n\t\t\tif ( $id !== 'new' )\n\t\t\t{\n\t\t\t\t$sql = \"UPDATE portal_notes SET \";\n\n\t\t\t\tforeach ( (array) $columns as $column => $value )\n\t\t\t\t{\n\t\t\t\t\t$sql .= DBEscapeIdentifier( $column ) . \"='\" . $value . \"',\";\n\t\t\t\t}\n\n\t\t\t\t$sql = mb_substr( $sql, 0, -1 ) . \" WHERE ID='\" . (int) $id . \"'\";\n\n\t\t\t\tDBQuery( $sql );\n\n\t\t\t\t//hook\n\t\t\t\tdo_action( 'School_Setup/PortalNotes.php|update_portal_note' );\n\t\t\t}\n\n\t\t\t// New: check for Title.\n\t\t\telseif ( $columns['TITLE'] )\n\t\t\t{\n\t\t\t\t$_REQUEST['values']['new']['PUBLISHED_PROFILES'] = '';\n\n\t\t\t\tforeach ( [ 'admin', 'teacher', 'parent' ] as $profile_id )\n\t\t\t\t{\n\t\t\t\t\tif ( isset( $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t\t&& $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t{\n\t\t\t\t\t\t$_REQUEST['values']['new']['PUBLISHED_PROFILES'] .= $profile_id . ',';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tforeach ( (array) $profiles_RET as $profile )\n\t\t\t\t{\n\t\t\t\t\t$profile_id = $profile['ID'];\n\n\t\t\t\t\tif ( isset( $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t\t&& $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t{\n\t\t\t\t\t\t$_REQUEST['values']['new']['PUBLISHED_PROFILES'] .= $profile_id . ',';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$columns['PUBLISHED_PROFILES'] = $_REQUEST['values']['new']['PUBLISHED_PROFILES'] ?\n\t\t\t\t',' . $_REQUEST['values']['new']['PUBLISHED_PROFILES'] :\n\t\t\t\t'';\n\n\t\t\t\t$sql = \"INSERT INTO portal_notes \";\n\n\t\t\t\t//FJ file attached to portal notes\n\t\t\t\t$fields = 'SCHOOL_ID,SYEAR,PUBLISHED_DATE,PUBLISHED_USER,';\n\n\t\t\t\t$values = \"'\" . UserSchool() . \"','\" . UserSyear() . \"',CURRENT_TIMESTAMP,'\" . User( 'STAFF_ID' ) . \"',\";\n\t\t\t\t// @since 10.9 Fix security issue, unset any FILE_ATTACHED column first.\n\t\t\t\t$columns['FILE_ATTACHED'] = '';\n\n\t\t\t\tif ( isset( $_FILES['FILE_ATTACHED_FILE'] ) )\n\t\t\t\t{\n\t\t\t\t\t$columns['FILE_ATTACHED'] = FileUpload(\n\t\t\t\t\t\t'FILE_ATTACHED_FILE',\n\t\t\t\t\t\t$PortalNotesFilesPath,\n\t\t\t\t\t\tFileExtensionWhiteList(),\n\t\t\t\t\t\t0,\n\t\t\t\t\t\t$error\n\t\t\t\t\t);\n\n\t\t\t\t\t// @since 6.8 Fix SQL error when quote in uploaded file name.\n\t\t\t\t\t$columns['FILE_ATTACHED'] = DBEscapeString( $columns['FILE_ATTACHED'] );\n\t\t\t\t}\n\t\t\t\telseif ( filter_var( $columns['FILE_ATTACHED_EMBED'], FILTER_VALIDATE_URL ) !== false )\n\t\t\t\t{\n\t\t\t\t\t$columns['FILE_ATTACHED'] = $columns['FILE_ATTACHED_EMBED'];\n\t\t\t\t}\n\n\t\t\t\tunset( $columns['FILE_ATTACHED_EMBED'] );\n\n\t\t\t\t$go = 0;\n\n\t\t\t\tforeach ( (array) $columns as $column => $value )\n\t\t\t\t{\n\t\t\t\t\tif ( ! empty( $value ) || $value == '0' )\n\t\t\t\t\t{\n\t\t\t\t\t\t$fields .= DBEscapeIdentifier( $column ) . ',';\n\t\t\t\t\t\t$values .= \"'\" . $value . \"',\";\n\t\t\t\t\t\t$go = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$sql .= '(' . mb_substr( $fields, 0, -1 ) . ') values(' . mb_substr( $values, 0, -1 ) . ')';\n\n\t\t\t\tif ( $go && empty( $error ) )\n\t\t\t\t{\n\t\t\t\t\tDBQuery( $sql );\n\n\t\t\t\t\t// Global var used by Moodle plugin.\n\t\t\t\t\t$portal_note_id = DBLastInsertID();\n\n\t\t\t\t\t//hook\n\t\t\t\t\tdo_action( 'School_Setup/PortalNotes.php|create_portal_note' );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$error[] = _( 'Please enter a valid Sort Order.' );\n\t\t}\n\t}\n\n\t// Unset modfunc & values & profiles & redirect URL.\n\tRedirectURL( [ 'modfunc', 'values', 'profiles' ] );\n}\n\nif ( $_REQUEST['modfunc'] === 'remove'\n\t&& AllowEdit() )\n{\n\tif ( DeletePrompt( _( 'Note' ) ) )\n\t{\n\t\t// FJ file attached to portal notes.\n\t\t$file_to_remove = DBGetOne( \"SELECT FILE_ATTACHED\n\t\t\tFROM portal_notes\n\t\t\tWHERE ID='\" . (int) $_REQUEST['id'] . \"'\" );\n\n\t\tif ( $file_to_remove\n\t\t\t&& file_exists( $file_to_remove ) )\n\t\t{\n\t\t\tunlink( $file_to_remove );\n\t\t}\n\n\t\tDBQuery( \"DELETE FROM portal_notes WHERE ID='\" . (int) $_REQUEST['id'] . \"'\" );\n\n\t\t//hook\n\t\tdo_action( 'School_Setup/PortalNotes.php|delete_portal_note' );\n\n\t\t// Unset modfunc & ID & redirect URL.\n\t\tRedirectURL( [ 'modfunc', 'id' ] );\n\t}\n}\n\necho ErrorMessage( $error );\n\nif ( ! $_REQUEST['modfunc'] )\n{\n\t// File attached to portal notes.\n\t$notes_RET = DBGet( \"SELECT ID,SORT_ORDER,TITLE,CONTENT,START_DATE,END_DATE,PUBLISHED_PROFILES,FILE_ATTACHED,\n\t\tCASE WHEN END_DATE IS NOT NULL AND END_DATE<CURRENT_DATE THEN 'Y' ELSE NULL END AS EXPIRED\n\tFROM portal_notes\n\tWHERE SCHOOL_ID='\" . UserSchool() . \"'\n\tAND SYEAR='\" . UserSyear() . \"'\n\tORDER BY EXPIRED DESC,SORT_ORDER IS NULL,SORT_ORDER,PUBLISHED_DATE DESC\", [\n\t\t'TITLE' => '_makeTextInput',\n\t\t'CONTENT' => '_makeContentInput',\n\t\t'SORT_ORDER' => '_makeTextInput',\n\t\t'FILE_ATTACHED' => 'makeFileAttached',\n\t\t'START_DATE' => 'makePublishing'\n\t] );\n\n\t$columns = [\n\t\t'TITLE' => _( 'Title' ),\n\t\t'CONTENT' => _( 'Note' ),\n\t\t'SORT_ORDER' => _( 'Sort Order' ),\n\t\t'FILE_ATTACHED' => _( 'File Attached' ),\n\t\t'START_DATE' => _( 'Publishing Options' ),\n\t];\n\n\t//,'START_TIME' => 'Start Time','END_TIME' => 'End Time'\n\t$link['add']['html'] = [\n\t\t'TITLE' => _makeTextInput( '', 'TITLE' ),\n\t\t'CONTENT' => _makeContentInput( '', 'CONTENT' ),\n\t\t'SHORT_NAME' => _makeTextInput( '', 'SHORT_NAME' ),\n\t\t'SORT_ORDER' => _makeTextInput( '', 'SORT_ORDER' ),\n\t\t'FILE_ATTACHED' => makeFileAttached( '', 'FILE_ATTACHED' ),\n\t\t'START_DATE' => makePublishing( '', 'START_DATE' ),\n\t];\n\n\t$link['remove']['link'] = 'Modules.php?modname=' . $_REQUEST['modname'] . '&modfunc=remove';\n\t$link['remove']['variables'] = [ 'id' => 'ID' ];\n\n\techo '<form action=\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] . '&modfunc=update' ) . '\" method=\"POST\" enctype=\"multipart/form-data\">';\n\n\tDrawHeader( '', SubmitButton() );\n\n\tListOutput( $notes_RET, $columns, 'Note', 'Notes', $link );\n\n\techo '<br /><div class=\"center\">' . SubmitButton() . '</div>';\n\techo '</form>';\n}\n\n/**\n * @param $value\n * @param $name\n */\nfunction _makeTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$extra = '';\n\n\tif ( $name === 'SORT_ORDER' )\n\t{\n\t\t$extra = ' type=\"number\" min=\"-9999\" max=\"9999\"';\n\t}\n\telseif ( $name !== 'TITLE' )\n\t{\n\t\t$extra = 'size=5 maxlength=10';\n\t}\n\telseif ( $id !== 'new' )\n\t{\n\t\t$extra = 'required';\n\t}\n\n\treturn TextInput(\n\t\t( $name == 'TITLE' && ! empty( $THIS_RET['EXPIRED'] ) ?\n\t\t\t[ $value, '<span style=\"color:red\">' . $value . '</span>' ] :\n\t\t\t$value ),\n\t\t'values[' . $id . '][' . $name . ']',\n\t\t'',\n\t\t$extra\n\t);\n}\n\n/**\n * @param $value\n * @param $name\n * @return mixed\n */\nfunction _makeContentInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$return = '<div id=\"divNoteContent' . $id . '\" class=\"rt2colorBox\">' .\n\t\tTextAreaInput( $value, \"values[\" . $id . \"][\" . $name . \"]\", '', 'rows=5' ) .\n\t\t'</div>';\n\n\treturn $return;\n}\n", "<?php\n\nfunction _makeFeesRemove( $value, $column )\n{\n\tglobal $THIS_RET,\n\t\t$waived_fees_RET;\n\n\tif ( ! $waived_fees_RET )\n\t{\n\t\t$waived_fees_RET = DBGet( \"SELECT f.WAIVED_FEE_ID\n\t\t\tFROM billing_fees f\n\t\t\tWHERE f.STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND f.WAIVED_FEE_ID IS NOT NULL\n\t\t\tAND f.SYEAR='\" . UserSyear() . \"'\n\t\t\tAND f.SCHOOL_ID='\" . UserSchool() . \"'\", [], [ 'WAIVED_FEE_ID' ] );\n\t}\n\n\t$return = '';\n\n\tif ( empty( $THIS_RET['WAIVED_FEE_ID'] )\n\t\t&& empty( $waived_fees_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\t$return = button(\n\t\t\t'remove',\n\t\t\t_( 'Waive' ),\n\t\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t\t'&modfunc=waive&id=' . $THIS_RET['ID'] ) . '\"'\n\t\t) . ' ';\n\t}\n\telseif ( ! empty( $waived_fees_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\t$return = '<span style=\"color:#00A642\">' . _( 'Waived' ) . '</span> ';\n\t}\n\n\treturn $return . button(\n\t\t'remove',\n\t\t_( 'Delete' ),\n\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t'&modfunc=remove&id=' . $THIS_RET['ID'] ) . '\"'\n\t);\n}\n\nfunction _makePaymentsRemove( $value, $column )\n{\n\tglobal $THIS_RET,\n\t\t$refunded_payments_RET;\n\n\tif ( ! $refunded_payments_RET )\n\t{\n\t\t$refunded_payments_RET = DBGet( \"SELECT p.REFUNDED_PAYMENT_ID\n\t\t\tFROM billing_payments p\n\t\t\tWHERE p.STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND (p.REFUNDED_PAYMENT_ID IS NOT NULL)\n\t\t\tAND p.SYEAR='\" . UserSyear() . \"'\n\t\t\tAND p.SCHOOL_ID='\" . UserSchool() . \"'\", [], [ 'REFUNDED_PAYMENT_ID' ] );\n\t}\n\n\t$return = '';\n\n\tif ( empty( $THIS_RET['REFUNDED_PAYMENT_ID'] )\n\t\t&& empty( $refunded_payments_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\tif ( AllowEdit( 'Student_Billing/StudentPayments.php&modfunc=remove' ) )\n\t\t{\n\t\t\t// @since 8.5 Admin Student Payments Delete restriction.\n\t\t\t// @since 8.6 Also exclude Refund.\n\t\t\t$return = button(\n\t\t\t\t'remove',\n\t\t\t\t_( 'Refund' ),\n\t\t\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t\t\t'&modfunc=refund&id=' . $THIS_RET['ID'] ) . '\"'\n\t\t\t) . ' ';\n\t\t}\n\t}\n\telseif ( ! empty( $refunded_payments_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\t$return = '<span style=\"color:#00A642\">' . _( 'Refunded' ) . '</span> ';\n\t}\n\n\tif ( AllowEdit( 'Student_Billing/StudentPayments.php&modfunc=remove' ) )\n\t{\n\t\t// @since 8.5 Admin Student Payments Delete restriction.\n\t\t$return .= button(\n\t\t\t'remove',\n\t\t\t_( 'Delete' ),\n\t\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t\t'&modfunc=remove&id=' . $THIS_RET['ID'] ) . '\"'\n\t\t);\n\t}\n\n\treturn $return;\n}\n\nfunction _makeFeesTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['WAIVED_FEE_ID'] ) )\n\t{\n\t\t$THIS_RET['row_colow'] = 'FFFFFF';\n\t}\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t\t$div = 'force';\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t\t$div = false;\n\t}\n\n\t$extra = 'maxlength=255';\n\n\tif ( $name === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput(\n\t\t$value,\n\t\t'values[' . $id . '][' . $name . ']',\n\t\t'',\n\t\t$extra,\n\t\t$div\n\t);\n}\n\nfunction _makeFeesDateInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$name = 'values[' . $id . '][' . $name . ']';\n\n\treturn DateInput( $value, $name );\n}\n\nfunction _makeFeesAmount( $value, $column )\n{\n\tglobal $fees_total;\n\n\t$fees_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _makePaymentsTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\t$extra = 'maxlength=255';\n\n\tif ( $name === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput( $value, 'values[' . $id . '][' . $name . ']', '', $extra );\n}\n\n/**\n * Make Payments Comments Input\n * Add Fees dropdown to reconcile Payment:\n * Automatically fills the Comments & Amount inputs.\n *\n * @since 5.1\n * @since 6.2 Remove Fees having a Payment (same Amount & Comments (Title), after or on Assigned Date).\n * @since 8.0 Remove Waived Fees from list.\n *\n * @uses _makePaymentsTextInput()\n *\n * @param  string $value Comments value.\n * @param  string $name  Column name, 'COMMENTS'.\n *\n * @return string Text input if not new or if no Fees found, else Text input & Fees dropdown.\n */\nfunction _makePaymentsCommentsInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\t$text_input = _makePaymentsTextInput( $value, $name );\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t// Add Fees dropdown to reconcile Payment.\n\t// Remove Fees having a Payment (same Amount & Comments (Title), after or on Assigned Date).\n\t// Remove Waived Fees from list.\n\t$fees_RET = DBGet( \"SELECT ID,TITLE,ASSIGNED_DATE,DUE_DATE,AMOUNT\n\t\tFROM billing_fees bf\n\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\tAND WAIVED_FEE_ID IS NULL\n\t\tAND NOT EXISTS(SELECT 1\n\t\t\tFROM billing_payments\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\t\tAND AMOUNT=bf.AMOUNT\n\t\t\tAND (COMMENTS=bf.TITLE OR COMMENTS LIKE CONCAT('%',bf.TITLE) OR COMMENTS LIKE CONCAT(bf.TITLE,'%'))\n\t\t\tAND PAYMENT_DATE>=bf.ASSIGNED_DATE)\n\t\tAND NOT EXISTS(SELECT 1\n\t\t\tFROM billing_fees\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\t\tAND WAIVED_FEE_ID=bf.ID)\n\t\tORDER BY ASSIGNED_DATE DESC\n\t\tLIMIT 20\" );\n\n\tif ( ! $fees_RET )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t$fees_options = [];\n\n\tforeach ( $fees_RET as $fee )\n\t{\n\t\t$fees_options[ $fee['AMOUNT'] . '|' . $fee['TITLE'] . '|' . $fee['ASSIGNED_DATE'] ] = ProperDate( $fee['ASSIGNED_DATE'], 'short' ) .\n\t\t\t' \u2014 ' . Currency( $fee['AMOUNT'] ) .\n\t\t\t' \u2014 ' . $fee['TITLE'];\n\t}\n\n\t// JS automatically fills the Comments & Amount inputs.\n\tob_start();\n\t?>\n\t<script>\n\t\tvar billingPaymentsFeeReconcile = function( amountCommentsDate ) {\n\t\t\tvar amountCommentsDateSplit = amountCommentsDate.split( '|' ),\n\t\t\t\tamount = amountCommentsDateSplit[0],\n\t\t\t\tcomments = amountCommentsDateSplit[1],\n\t\t\t\tdate = amountCommentsDateSplit[2];\n\n\t\t\t$('#valuesnewAMOUNT').val( amount );\n\t\t\t$('#valuesnewCOMMENTS').val( comments );\n\t\t};\n\t</script>\n\t<?php\n\t$js = ob_get_clean();\n\n\t$select_input = SelectInput(\n\t\t'',\n\t\t'billing_fees',\n\t\t'',\n\t\t$fees_options,\n\t\t'N/A',\n\t\t'onchange=\"billingPaymentsFeeReconcile(this.value);\" style=\"width: 158px;\"'\n\t);\n\n\treturn $text_input . ' ' . $js . $select_input;\n}\n\nfunction _makePaymentsDateInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\treturn DateInput( $value, 'values[' . $id . '][' . $name . ']', '', ( $id !== 'new' ), false );\n}\n\nfunction _makePaymentsAmount( $value, $column )\n{\n\tglobal $payments_total;\n\n\t$payments_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _lunchInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\treturn CheckboxInput(\n\t\t$value,\n\t\t'values[' . $id . '][' . $column . ']',\n\t\t'',\n\t\t'',\n\t\t( $id === 'new' )\n\t);\n}\n\n/**\n * Make Fees File Attached Input\n *\n * @since 8.1\n * @since 10.4 Add File Attached Input for existing Fees\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makeFeesFileInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn FileInput(\n\t\t\t'FILE_ATTACHED'\n\t\t);\n\t}\n\n\tif ( empty( $value )\n\t\t|| ! file_exists( $value ) )\n\t{\n\t\tif ( isset( $_REQUEST['_ROSARIO_PDF'] )\n\t\t\t|| ! AllowEdit() )\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\t// Add hidden FILE_ATTACHED input so it gets saved even if no other columns to save.\n\t\treturn '<input type=\"hidden\" name=\"values[' . $THIS_RET['ID'] . '][FILE_ATTACHED]\" value=\"\" />' .\n\t\tFileInput(\n\t\t\t'FILE_ATTACHED_' . $THIS_RET['ID']\n\t\t);\n\t}\n\n\tif ( ! empty( $_REQUEST['LO_save'] ) )\n\t{\n\t\t// Export list.\n\t\treturn $value;\n\t}\n\n\t$file_path = $value;\n\n\t$file_name = mb_substr( mb_strrchr( $file_path, '/' ), 1 );\n\n\t$file_size = HumanFilesize( filesize( $file_path ) );\n\n\t// Truncate file name if > 36 chars.\n\t$file_name_display = mb_strlen( $file_name ) <= 36 ?\n\t\t$file_name :\n\t\tmb_substr( $file_name, 0, 30 ) . '..' . mb_strrchr( $file_name, '.' );\n\n\t$file = button(\n\t\t'download',\n\t\t$file_name_display,\n\t\t'\"' . URLEscape( $file_path ) . '\" target=\"_blank\" title=\"' . AttrEscape( $file_name . ' (' . $file_size . ')' ) . '\"',\n\t\t'bigger'\n\t);\n\n\treturn $file;\n}\n\n/**\n * Make Payments File Attached Input\n *\n * @since 8.3\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makePaymentsFileInput( $value, $column )\n{\n\treturn _makeFeesFileInput( $value, $column );\n}\n\n/**\n * Save Fees File\n *\n * @since 10.4\n * @since 10.8.2 Add datetime to filename to make it harder to predict\n *\n * @param  int|string $id Fee ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveFeesFile( $id )\n{\n\tglobal $error,\n\t\t$FileUploadsPath;\n\n\t$input = $id === 'new' ? 'FILE_ATTACHED' : 'FILE_ATTACHED_' . $id;\n\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name_no_ext = no_accents( mb_substr(\n\t\t$_FILES[ $input ]['name'],\n\t\t0,\n\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t) );\n\n\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' );\n\n\t$file_attached = FileUpload(\n\t\t$input,\n\t\t$FileUploadsPath . UserSyear() . '/student_' . UserStudentID() . '/',\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\t// Fix SQL error when quote in uploaded file name.\n\treturn DBEscapeString( $file_attached );\n}\n\n/**\n * Save Payments File\n *\n * @since 10.4\n *\n * @param  int|string $id Payment ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _savePaymentsFile( $id )\n{\n\treturn _saveFeesFile( $id );\n}\n"], "fixing_code": ["# CHANGES\n## RosarioSIS Student Information System\n\nChanges in 11.0\n---------------\n- Add Weight Assignments option in Grades/Configuration.php, Assignments.php & MassCreateAssignments.php\n- Add Weight field in Assignments.php & MassCreateAssignments.php\n- Calculate Weighted Grade in Grades.php, InputFinalGrades.php & ProgressReports.php\n- Add Assignment Weight in StudentGrades.php & StudentAssignments.fnc.php\n- Translate \"Zip\" & \"Zipcode\" to \"Zip Code\" in GetStuList.fnc.php, MyReport.php, Registration.fnc.php, Schools.php & Address.inc.php\n- HTML Text input min size is 2 in Inputs.php\n- Skip School Period column if has no students scheduled for selected date in Administration.php\n- Add microseconds to filename format to make it harder to predict in FileUpload.fnc.php, Accounting/functions.php, PortalNotes.php & Student_Billing/functions.php\n\nChanges in 10.9.3\n-----------------\n- Security Fix browser loading cached page when page full reload (F5) + logout + Back button in warehouse.js, thanks to @b1tch3s\n\nChanges in 10.9.2\n-----------------\n- Fix Format Contact Field value based on its Type in ViewContact.php\n- Fix regression add Contact Info columns to list in MyReport.php\n- ETag + Cache-Control header: use no-cache directive in Warehouse.php\n- Set `$_SESSION['is_secondary_teacher']` in SetUserCoursePeriod() in Current.php\n- Fix Set current User Course Period before Secondary Teacher logic in TakeAttendance.php, AnomalousGrades.php, Assignments.php, Grades.php, InputFinalGrades.php & ProgressReports.php\n- SQL Show Gradebook Grades of Inactive Students (Only if has grades) in StudentGrades.php\n\nChanges in 10.9.1\n-----------------\n- Fix Anonymous Statistics bar overflow in StudentGrades.php\n- SQL Show Gradebook Grades of Inactive Students (Course status, maybe dropped as of today) in StudentGrades.php\n- Show Gradebook Grades of Inactive Students (School status) in StudentGrades.php\n- Fix PHP error if date.timezone ini setting is an invalid time zone identifier in Warehouse.php\n\nChanges in 10.9\n---------------\n- Fix do not add new Enrollment Record if existing has no Dropped date in Student.php, Enrollment.inc.php & SaveEnrollment.fnc.php\n- Enrollment Start: No N/A option for first entry in StudentsUsersInfo.fnc.php\n- Hide End Date input for Inactive Students (no Attendance Start Date) in StudentsUsersInfo.fnc.php\n- SQL ORDER BY DEFAULT_CALENDAR IS NULL,DEFAULT_CALENDAR ASC (nulls first) for consistency between PostgreSQL & MySQL in Courses.fnc.php, Calendar.php & Enrollment.inc.php\n- Simplify & harmonize code, use GetAllMP() in GPARankList.php, InputFinalGrades.php & TeacherCompletion.php\n- Exclude already associated parents/students from Search() in AddUsers.php & AddStudents.php\n- Replace \"Course Title\" in TipMessage with actual Course title in Attendance/, Eligibility/ & Grades/TeacherCompletion.php\n- Handle multiple Course Periods on the same Period for same Teacher in Attendance/ & Eligibility/TeacherCompletion.php\n- JS Remove \"Go\" button & submit form on select change in Eligibility/TeacherCompletion.php\n- Add SetUserCoursePeriod() function in Current.php\n- Set current User Course Period using SetUserCoursePeriod() in Side.php, TakeAttendance.php, EnterEligibility.php, AnomalousGrades.php, Assignments.php, Grades.php, InputFinalGrades.php, ProgressReports.php & TeacherPrograms.php\n- Add `'&period=' . UserCoursePeriod()` to Teacher form URL in TakeAttendance.php, EnterEligibility.php, Assignments.php, Grades.php, InputFinalGrades.php, ProgressReports.php, StudentAssignments.fnc.php & Portal.php\n- Remove period from URL when switching School / Year / MP / CP in Side.php\n- HTML Rename \"period\" select input ID to \"school_period\" to avoid conflicts in Attendance/, Eligibility/, Food_Service/ & Grades/TeacherCompletion.php\n- CSS Add modname class, ie .modname-grades-reportcards-php for modname=Grades/ReportCards.php in PDF.php\n- CSS Add .list-column-[column_name] class in ListOutput.fnc.php\n- CSS Set Report Cards Comments column (max) width to 33% in wkhtmltopdf.css\n- Temporary AllowEdit so SelectInput() is displayed to everyone in DailyTransactions.php\n- SQL ORDER BY Assignment Type first, then order Assignments in Grades.php\n- Remove $count & $has_count_text variables in ListOutput.fnc.php\n- Add pagination option (defaults to false) in ListOutput.fnc.php\n- Add pagination for list > 1000 results in AccessLog.php & ReportCardGrades.php\n- SQL gradebook_assignments table: Add WEIGHT column in Update.fnc.php, rosariosis.sql & rosariosis_mysql.sql\n- Fix security issue, unset any FILE_ATTACHED column first in PortalNotes.php\n- Use `_makeAutoSelectInputX()` for Contact Information Description in Address.inc.php\n- SQL courses ORDER BY TITLE in Requests.php\n- HTML remove \"Add a Request\" & hide \"Subject\" input label in Requests.php\n- Update command to install wkhtmltopdf & dependencies in INSTALL.md\n- Add link to Softaculous installation directions in INSTALL.md\n- Fix wkhtmltopdf not rendering URL in CSS in PDF.php\n- CSS Fix breaking words inside .header2 in stylesheet.css\n- SQL set N/A grade GPA to NULL in rosariosis.sql, rosariosis_es.sql, rosariosis_fr.sql & rosariosis_mysql.sql\n- Add Portuguese (Brazil) translation in InstallDatabase.php, REFERENCE.md, locale/pt_BR.utf8/ & rosariosis_pt_BR.sql, thanks to Emerson Barros\n\nChanges in 10.8.5\n-----------------\n- Fix \"Folder not writable\" error on add-on zip upload in Modules.inc.php & Plugins.inc.php\n\nChanges in 10.8.4\n-----------------\n- Fix SQL error escape menu title in DailyMenus.php, ServeMenus.php\n- Fix MySQL date interval in Food_Service/Students/ServeMenus.php\n- SQL order Transactions by ID in Transactions.php\n- Fix regression since 10.6.2 SQL error invalid reference to FROM-clause entry for table \"ssm\" in Widget.php\n- Fix do not set empty Grade Points to 0 in Grades.php\n- Fix save multiple SelectInput() when none selected, add hidden empty input in Inputs.php\n- Fix check if Available Seats < selected students calculation in MassSchedule.php\n- SQL order Requests by Course in Requests.php\n- CSS set minimum colorBox width to 50% view width in StudentGrades.php\n- Fix SQL error when Phone > 30 chars in Address.inc.php\n- If City length > 22 without space, force stackable table in Address.inc.php\n- CSS responsive stack Address & Contacts table below Laptop MDPI screen in zresponsive.css\n- Fix PHP fatal error Unsupported operand types: string - int when not a date in Date.php\n- Fix do not display Rollover default check warning if modfunc=remove in EnrollmentCodes.php\n- Fix check for Description & Value when saving new Contact Information in Address.inc.php\n\nChanges in 10.8.3\n-----------------\n- Add assets/FileUploads/ directory\n- Fix regression since 10.8.2 PHP fatal error $timestamp is not a valid date-time string in StudentAssignments.fnc.php\n- Catch strftime_compat() exception $timestamp is not a valid date-time string in Date.php\n\nChanges in 10.8.2\n-----------------\n- PHP<7 Fix add microseconds to filename to make it harder to predict in StudentAssignments.fnc.php, thanks to @jeffreygaor\n- Add datetime to filename to make it harder to predict in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- HTML add maxlength to Field Category & Name inputs in Fields.fnc.php\n- Do not check username uniqueness if empty in Student.php & User.php\n- CSS FLatSIS adjust fieldset border color & MD to HTML line-height in colors.css & stylesheet.css\n- Fix MySQL 8 syntax error, 'rank' is a reserved keyword in rosariosis_mysql.sql\n- Add MySQL global setting to allow function creation in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.8.1\n-----------------\n- Use CheckBoxOnclick() in StudentBalances.php & Schedule.inc.php\n- Fix SQL error when Quarter with Assignments is deleted in Portal.php\n- SQL Check requested assignment belongs to current Marking Period in Assignments.php\n- MySQL + MariaDB < 10.5 fix FOREIGN KEY constraint syntax in rosariosis_mysql.sql\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in CreateParents.php\n- Fix SQL error cast attendance code to integer in TakeAttendance.php\n- Fix hide Contact Fields according to Emergency/Custody settings in Address.inc.php\n- Fix MultipleCheckboxInput() save all unchecked, add hidden empty checkbox in Inputs.php\n\nChanges in 10.8\n---------------\n- Fix MySQL Periods list in MasterScheduleReport.php\n- SQL explicitly list all columns instead of `SELECT *` in MenuItems.php, Menus.php, EditHistoryMarkingPeriods.php, EditReportcardGrades.php, ReportCardCommentCodes.php, ReportCardComments.php & ReportCardGrades.php\n- Add & use DBSQLCommaSeparatedResult() function (SQL result as comma separated list) in database.inc.php, Dashboard.inc.php, MasterScheduleReport.php & Export.php\n- HTML email input remove pattern, add maxlength in PasswordReset.php, StudentsUsersInfo.fnc.php, NotifyParents.php, CreateParents.php & General_Info.inc.php, Other_Info.inc.php\n- JS Fix #319 Try a full match first to identify selected menu link in warehouse.js\n- Spanish translation add \u00bf character before questions in rosariosis.po\n- HTML add \"Check All\" checkbox after Periods in AddAbsences.php\n- Truncate Assignment title to 36 chars in AnomalousGrades.php\n- SQL resources table: Add PUBLISHED_PROFILES & PUBLISHED_GRADE_LEVELS columns in Update.fnc.php, rosariosis.sql & rosariosis_mysql.sql\n- Add Resource Visibility options in Resources.php\n- Move Resources functions to separate file & rename them in Resources.php & Resources.fnc.php\n- Update French & Spanish translations in rosariosis.po\n- CSS Fix Select2 dropdown hidden when inside colorBox (has z-index 9999) in stylesheet.css\n\nChanges in 10.7.1\n-----------------\n- Fix SQL limit School Periods to Course Period in AddAbsences.php\n\nChanges in 10.7\n---------------\n- CSS add Select2 styles in stylesheet.css & colors.css\n- JS add Select2 jQuery plugin in assets/js/jquery-select2/\n- Add Select2Input() function in Inputs.php\n- Use Select2 instead of Chosen, fixes the overflow issue in Widget.php, MakeReferral.php, Transcripts.fnc.php & Address.inc.php\n- Fix PHP8.2 deprecated Creation of dynamic property in Markdownify/ConverterExtra.php\n- SQL always add space before AND to $extra['WHERE'], program wide\n- Escape SanitizeHTML() & SanitizeMarkDown() before saving to DB, program wide\n- Always use UserStudentID() instead of `$_SESSION['STUDENT_ID']` in PortalPollsNotes.php\n- SQL use EXISTS(SELECT 1) instead of `EXISTS(SELECT *)` in EditReportCardGrades.php, Rollover.php & Moodle/functions.php\n- Remove trailing seconds :00 & add sorting HTML comment to datetime in Date.php\n- HTML set max Event Repeat Days to 300 in Calendar.php\n- Only display Locked column if AllowEdit() in Schedule.php\n- Schedule table: rename Periods column to Period (singular) in PrintSchedules.php & Schedule.inc.php\n- HTML add padding to Assignment options + remove useless table in Grades/Configuration.php\n- Move \"Remove required attribute, TinyMCE bug\" fix to TextAreaInput() in Inputs.php\n- Only display profiles w/Custom if actually used to gain space in PortalPollsNotes.php\n- Add & remove module icons in themes/FlatSIS/modules/\n- Add .dotx,.ppsx,.mdb,.sldx,.odg,.odc,.odb,.odf,.numbers,.pages,.m4a,.tsv,.json,.ics file extensions to whitelist in FileUpload.fnc.php\n- ROLL Gradebook Config's Final Grading Percentages for Admin (overridden) in Rollover.php\n- HTML responsive limit display columns to 3 in Courses.php & Assignments.php\n- SQL remove Period Length<=(Minutes in a Full School Day / 2) for Teacher's Schedule table in Schedule.inc.php\n- SQL include Secondary Teacher Course Periods in Schedule.inc.php\n- HTML move Schedule list inside PopTable & rework table cell in Schedule.inc.php\n- Fix do not display \"Enroll student for next school year\" link if new enrollment record in Enrollment.inc.php\n- Add Class Average row in ReportCards.fnc.php & Grades.fnc.php\n- Fix HTML5 notice Trailing slash on void elements has no effect, but keep `<br />` for `$_ROSARIO['SearchTerms']`, program wide\n- Fix regression since 9.0 show Student Photo in Transcripts.fnc.php\n- Check Assignment is in current MP in StudentAssignments.php & StudentAssignments.fnc.php\n- Corrections for French translation in rosariosis.po\n- CSS FlatSIS .list & .postbox headers adjustments for Chrome in stylesheet.css\n- CSS reduce File input size when inside list in stylesheet.css\n- CSS responsive increase max input size when inside list in zresponsive.css\n- CSS fix Student Comments margin & padding in stylesheet.css\n- Fix regression display Mailing Labels in ReportCards.fnc.php\n- Add Student Photo in ReportCards.fnc.php\n- Fix SQL error ORDER BY for Expanded View + Contact Information in GetStuList.fnc.php\n\nChanges in 10.6.3\n-----------------\n- Fix regression Teacher can save config even if overridden by Admin in Grades/Configuration.php\n- Prevent double encoding single quote (`&#039;`), was encoded by SanitizeHTML() or SanitizeMarkDown() in Inputs.php\n\nChanges in 10.6.2\n-----------------\n- Do not truncate value on List export in Accounting/functions.inc.php, Grades.php, StudentGrades.php, StudentAsignments.fnc.php, Resources.php & Student_Billing/functions.inc.php\n- SQL performance use POSITION()>0 instead of LIKE, program wide\n- SQL remove useless ID='' check in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Fix hide File input if cannot edit in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility in Accounting/functions.inc.php & Student_Billing/functions.inc.php\n- Fix SQL use JOIN instead of WHERE EXISTS for Discipline Widgets in Widget.php\n- MySQL fix PHP fatal error when updating Course's Marking Period in Courses.php\n- Fix #338 Only check against Course Periods having overlapping Marking Period in Courses.fnc.php\n\nChanges in 10.6.1\n-----------------\n- PostgreSQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric (exact) in rosariosis.sql, thanks to @fatahou\n- MySQL Fix Class Rank float comparison issue: do NOT use double precision type (inexact), use numeric(22,16) (exact) in rosariosis_mysql.sql, thanks to @fatahou\n- SQL Fix regression since 10.0, change sum/cum factors & credit_attempted/earned columns type from double precision to numeric in Update.fnc.php\n- Fix Grades input not displaying for Teachers in Widget.php\n- Raise minimum PHP version from 5.4.45 to 5.5.9 in INSTALL.md, README.md, composer.json, diagnostic.php & Portal.php\n- Fix close PopTable wrapper `<div>` in Enrollment.inc.php, General_Info.inc.php, Medical.inc.php & Schedule.inc.php\n\nChanges in 10.6\n---------------\n- Add Pashto to right-to-left languages in Warehouse.php, Inputs.php & PDF.php\n- CSS FixedMenu bug when menu hidden in stylesheet.css\n- Fix JPG image rotation in ImageResizeGD.php\n- Resize, compress & store image using ImageUpload() in FileUpload.fnc.php\n- Fix remove `<span>` HTML tag from Assignment Type in select in Grades.php\n- Truncate Assignment Type to 36 chars only if has words > 36 chars in ProgressReports.php & StudentAssignments.fnc.php\n- Truncate Assignment title to 36 chars in StudentGrades.php\n- CSS Do NOT use global word-break. Use it only on specific elements in stylesheet.css & zresponsive.css\n- CSS responsive Fix list overflow-x scroll inside div.st in stylesheet.css\n- CSS set max-width for City & State select in Address.inc.php\n- Security fix for dynamic include in index.php\n- Fix SQL limit 1 when adding existing Contact in Address.inc.php\n- CSS responsive add .postbox-wrapper class for overflow-x scroll in PopTable.fnc.php & stylesheet.css\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in AssignOtherInfo.php\n\nChanges in 10.5.2\n-----------------\n- Fix PHP8.1 Fatal error when $options is null in StudentsUsersInfo.fnc.php\n- Remove .00 decimal from value of numeric type in Substitutions.fnc.php\n- Truncate Assignment title to 36 chars only if has words > 36 chars in ProgressReports.php, Assignments.php & MassCreateAssignments.php\n- Truncate Assignment title to 36 chars in GradebookBreakdown.php & Grades.php\n- CSS responsive fix List column title prevent word breaking in zresponsive.css\n- Fix photo use mime types, not file extensions so mobile browsers allow camera in General_Info.inc.php & MenuItems.php\n- Fix return processed image upload in case source type != target type in FileUpload.fnc.php\n\nChanges in 10.5.1\n-----------------\n- Fix MySQL error Unknown system variable 'storage_engine' in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.5\n---------------\n- JS responsive add minWidth & minHeight options to inline colorBox in jquery-colorbox.js & warehouse.js\n- Trim white spaces for Contact name & Address fields in RegistrationSave.fnc.php & Address.inc.php\n- Save Student Files fields, upload files in RegistrationSave.fnc.php\n- CSS Do not break text inside button in stylesheet.css\n- CSS responsive raise max-width for mobile & vertical tablet from 736 to 874px in zresponsive.css, rtl.css & colors.css\n- HTML fix responsive table & weekdays in Calendars.php\n- CSS responsive reduce select max-width from 440 to 340px in stylesheet.css & zresponsive.css\n- Fix PHP8.2 utf8_decode() function deprecated in PDF.php\n- MySQL change database charset to utf8mb4 and collation to utf8mb4_unicode_520_ci in InstallDatabase.php\n\nChanges in 10.4.4\n-----------------\n- Fix AllowUse() & AllowEdit() for User Info when on Student Info in AllowEdit.fnc.php\n- CSS fix Calendar header days word-break in zresponsive.css\n- CSS style time input in stylesheet.css & colors.css\n- CSS remove padding for LO_SORT arrow in zresponsive.css\n- HTML fix responsive / stackable table for Course Periods in Courses.php\n\nChanges in 10.4.3\n-----------------\n- MySQL always use InnoDB (default), avoid MyISAM in InstallDatabase.php, Modules.inc.php, Plugins.inc.php & rosariosis_mysql.sql\n\nChanges in 10.4.2\n-----------------\n- Fix SQL error null value in column \"amount\" in Salaries.php\n- Fix Total row calculation, reset for each student in ReportCards.fnc.php & Transcripts.fnc.php, thanks to @fatahou\n\nChanges in 10.4.1\n-----------------\n- JS fix regression since 9.0 & DOMPurify, open links in new window in warehouse.js\n- Add Database Type and Version, add PHP version to FirstLoginPoll() in FirstLogin.fnc.php\n- Fix typos in INSTALL.md & INSTALL_fr.md\n\nChanges in 10.4\n---------------\n- Modcat is addon module, set custom module icon in Profiles.php & Exceptions.php\n- SQL performance: use NOT EXISTS instead of NOT IN + LIMIT 1000 in Portal.php\n- Add student name to Student's Absences and Grades delete prompt in MassDrops.php\n- Fix display only first letter of attendance code in AttendanceSummary.php\n- Remove \"Minimum assignment points for letter grade\" config option in Grades/Configuration.php & StudentGrades.php\n- Truncate Assignment title to 36 chars in StudentGrades.php & Grades.php\n- CSS date capitalize first letter only in stylesheet.css\n- Add optional $id param to FilesUploadUpdate() in FileUpload.fnc.php\n- JS Only show laoding spinner if file input has selected files in warehouse.js\n- Add File Attached Input for existing Fees/Payments in StudentFees.php, StudentPayments.php & Student_Billing/functions.inc.php\n- Add File Attached Input for existing Salaries/Staff Payments/Incomes/Expenses in Expenses.php, Incomes.php, Salaries, StaffPayments.php & Accounting/functions.inc.php\n- Add-ons can add their custom Widgets in classes/core/Widgets.php & classes/core/StaffWidgets.php\n- Add Widgets init action hook in Actions.php & Widgets.fnc.php\n- Add Staff Widgets init action hook in Actions.php & StaffWidgets.fnc.php\n- Fix SQL check student is actually enrolled in Enrollment.fnc.php\n- Fix date is 1969-12-31 on Windows when PHP intl ext not activated in strftime_compat.php\n\nChanges in 10.3.3\n-----------------\n- SQL ORDER BY END_DATE IS NULL DESC,END_DATE DESC (nulls first) for consistency between PostgreSQL & MySQL in User.fnc.php\n- Fix PostgreSQL error column \"students_join_people.address_id\" must appear in the GROUP BY clause in Address.inc.php\n\nChanges in 10.3.2\n-----------------\n- Fix PostgreSQL error ORDER BY \"full_name\" is ambiguous in DailyTransactions.php\n\nChanges in 10.3.1\n-----------------\n- Fix MySQL error result as comma separated list in Export.php\n- Add recommended php.ini setting session.gc_maxlifetime = 3600 in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.3\n---------------\n- Add \"Cumulative Balance over school years\" checkbox in StudentBalances.php\n- Fix program not found when query string is URL encoded in Modules.php\n- JS fix add new Period below existing Period row in Courses.php\n- Add \"Course Periods\" checkbox in Rollover.php\n- Fix MySQL error 1069 Too many keys specified; max 64 keys allowed in Fields.fnc.php & DisciplineForm.php\n\nChanges in 10.2.3\n-----------------\n- Remove dead link to centresis.org in index.php\n- Fix MySQL error TEXT column used in key specification without a key length in Fields.fnc.php & DisciplineForm.php\n- Add ROLLOVER_ID column to User() in User.fnc.php\n- Get template from last school year (rollover ID) in Template.fnc.php\n\nChanges in 10.2.2\n-----------------\n- Fix PHP fatal error undefined function StudentCanEnrollNextSchoolYear() in PrintStudentInfo.php\n- Set school logo with to 120px in PrintStudentInfo.php\n\nChanges in 10.2.1\n-----------------\n- SQL order by Marking Period Start Date in MarkingPeriods.php, ReportCards.fnc.php, Courses.php, Schedule.php, PrintSchedules.php, MassSchedule.php, MassDrops.php & Side.php\n- Maintain current month on calendar change in Calendar.php\n- Maintain Calendar when closing event popup in Calendar.php\n- CSS FlatSIS smaller font size for Calendar Event title in stylesheet.css\n- Fix SQL error mysqli_fetch_assoc(): Argument 1 must be of type mysqli_result, null given in database.inc.php & StudentsUsersInfo.fnc.php\n- When -Edit- option selected, change the auto pull-down to text field in StudentsUsersInfo.fnc.php\n- HTML remove bold for \"Other students associated with this address/person\" in Address.inc.php\n- SQL order by FULL_NAME (Display Name config option) in PortalPollNotes.fnc.php, Widget.php, GetStaffList.fnc.php, GetStuList.fnc.php, Transcripts.fnc.php, Courses.php, MassRequests.php, ScheduleReport.php & Address.inc.php\n- CSS fix Report Cards PDF columns size when long comments text in ReportCards.fnc.php & stylesheet_wkhtmltopdf.css\n- CSS Add .grade-minmax-wrap,.grade-minmax-min,.grade-minmax-grade & .grade-minmax-max classes & avoid breaking grades in stylesheet.css & ReportCards.fnc.php\n- Fix get Min. Max. grades for students in distinct grade levels in FinalGrades.php\n- Fix SQL syntax error since 10.0 in Administration.php\n- CSS Do not break words inside lists in stylesheet.css\n- SQL handle case when student dropped and then later re-enrolled in course in DuplicateAttendance.php\n- Use DBEscapeIdentifier() for Gradebook ASSIGNMENT_SORTING in Assignments.php, GradebookBreakdown.php & Grades.php\n\nChanges in 10.2\n---------------\n- Add StudentCanEnrollNextSchoolYear() & StudentEnrollNextSchoolYear() functions in Enrollment.fnc.php\n- Add \"Enroll student for next school year\" in Enrollment.inc.php\n- Translate \"Enroll student for next school year\" to French & Spanish in rosariosis.po\n- MySQL fix character encoding when translating database in InstallDatabase.php\n\nChanges in 10.1\n---------------\n- Fix MySQL 5.6 syntax error when WHERE without FROM clause, use dual table in TakeAttendance.php, Reminders.php,  InputFinalGrades.php, Requests.php & Calendar.php\n- Add dual VIEW for compatibility with MySQL 5.6 to avoid syntax error when WHERE without FROM clause in rosariosis.sql & Update.fnc.php\n- Fix MySQL 5.6 syntax error in ORDER BY use report_card_comments table instead of dual in InputFinalGrades.php\n- Fix SQL use cast(extract(DOW) AS int) for PostrgeSQL in Calendar.php\n- Add instructions for MySQL in INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n\nChanges in 10.0\n---------------\n- SQL convert table names to lowercase, program wide\n- Fix delete file attached in StudentFees.php\n- Use DBEscapeIdentifier() for reserved 'column' keyword in plugins/Moodle/\n- Avoid regression due to lowercase table names: Maintain compatibility with add-ons using rollover_after action hook & `$_REQUEST['tables']` in Rollover.php\n- Use db_trans_*() functions in DeleteTransaction.fnc.php & DeleteTransactionItem.fnc.php\n- Close popup if no UserSchool in session, happens on login redirect in Warehouse.php\n- SQL order Grade Levels in StudentBreakdown.php\n- Remove semicolon before \"With\" & \"On\" values in PrintRequests.php & unfilledRequests.inc.php\n- HTML Link is selected: bold in ScheduleReport.php\n- Display Period title if no short name set in IncompleteSchedules.php\n- Fix Widget search & add Search Terms header in IncompleteSchedules.php\n- Add Schedule link & photo tooltip to Student name in Scheduling/AddDrop.php\n- HTML add a11y-hidden label to select in GPARankList.php & Attendance/TeacherCompletion.php\n- Fix unset requested dates in MassCreateAssignments.php & Assignments.php\n- Add User / Student photo tooltip in Grades/TeacherCompletion.php, GPARankList.php & EnterEligibility.php\n- SQL order by Period title in TeacherCompletion.php\n- Use Period's Short Name when > 10 columns in the list in TeacherCompletion.php\n- Add note on save in EntryTimes.php\n- Fix PHP8.1 Deprecated passing null to parameter in EmailReferral.fnc.php, CategoryBreakdown.php & StudentGrades.php\n- Add Total sum of balances in StaffBalances.php\n- Fix French translation for \"Waiver\" & \"Refund\" in rosariosis.po\n- Force title & action to lowercase in Prompts.php\n- HTML use .dashboard-module-title CSS class for module titles in Profiles.php & Exceptions.php\n- CSS set input label max-width on Search form in stylesheet.css\n- JS new default popup size: 1200x450 in warehouse.js\n- Use URLEscape() for add button link when appropriate in ListOutput.fnc.php\n- JS set Calendar date to current fields date in warehouse.js & calendar-setup.js\n- HTML add label to select in ActivityReport.php\n- Use Currency() function instead of number_format() in TransactionsReport.php\n- HTML remove line-break in Warning/Minimum columns in Reminders.php\n- HTML CSS make Daily Menus calendar coherent with School Calendar in DailyMenus.php\n- Shorten Referral email subject in EmailReferral.fnc.php\n- Use plural wise ngettext() for \"No %s were found.\" in FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Force result text to lowercase for \"No %s were found.\" in ListOutput.fnc.php, FinalGrades.php, GradeBreakdown.php, ReportCardComments.php, ReportCards.php & Transcripts.php\n- Prevent admin from removing own access to User Profiles program in Profiles.php\n- SQL change modname column type from text to varchar(150) to match with MySQL key index limitation in rosariosis.sql\n- SQL change program column type from text to varchar(100) NOT NULL to match with MySQL index limitation in rosariosis.sql\n- SQL change schools column type from text to varchar(150) to match with MySQL index limitation in rosariosis.sql\n- Rename YEAR_MONTH column alias to YEAR_MONTH_DATE: reserved keyword in MySQL in Dashboard.inc.php\n- SQL use DAYOFWEEK() for MySQL or cast(extract(DOW)+1 AS int) for PostrgeSQL, program wide\n- SQL cast(AS UNSIGNED) for MySQL or cast(AS INT) for PostgreSQL, program wide\n- SQL cast custom_fields ID AS char(10) instead of TEXT for MySQL compatibility in GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL rename $field COLUMN (reserved keyword) to COLUMN_NAME for MySQL compatibility in CustomFields.fnc.php, GetStaffList.fnc.php, GetStuList.fnc.php & Search.fnc.php\n- SQL remove use of nextval in rosariosis_fr.sql\n- Rename $pg_dumpPath configuration variable to $DatabaseDumpPath in config.inc.sample.php, diagnostic.php & DatabaseBackup.php\n- Build command for executing mysqldump in DatabaseBackup.php\n- SQL to extract Unix timestamp or epoch from date in Eligibility/Student.php, StudentList.php & TeacherCompletion.php\n- Install module/plugin: execute the install_mysql.sql script for MySQL in Modules.inc.php, Plugins.inc.php & modules/README.md & plugins/README.md\n- Fix typo \"inexistant\" to \"nonexistent\" & update translations in Modules.inc.php, Plugins.inc.php & rosariosis.po\n- HTML fix duplicated #menu-top div on update in Side.php\n- JS fix #body height calculation: include bottom margin in jquery-fixedmenu.js & plugins.min.js\n- Add MySQLRemoveDelimiter() remove DELIMITER $$ declarations before procedures or functions in database.inc.php, Modules.inc.php & Plugins.inc.php\n- SQL ORDER BY SORT_ORDER IS NULL,SORT_ORDER (nulls last) for consistency between PostgreSQL & MySQL, program wide\n- Rollback Fix PostgreSQL error invalid ORDER BY, only result column names can be used, program wide\n- HTML use number input for Gradebook config options in Configuration.php\n- HTML use number input for Grade points & average in ReportCardGrades.php\n- SQL limit results to current school year in AddDrop.php\n- SQL always use INTERVAL to add/subtract days to date for MySQL compatibility in Reminders.php, Transactions.php, ServeMenus.php, Assignments.php, StudentGrades.php, Rollover.php & Portal.php\n- SQL change amount columns type from numeric to numeric(14,2) NOT NULL in rosariosis.sql & StudentFees.php\n- SQL change minutes,minutes_present,points,default_points,length,count_weighted_factors,count_unweighted_factors columns type from numeric to integer in rosariosis.sql, UpdateAttendanceDaily.fnc.php, Assignments.php, MassCreateAssignments.php & Periods.php\n- SQL change gp & gpa columns type from numeric to numeric(7,2) in rosariosis.sql\n- SQL change sum/cum factors & credit_attempted/earned columns type from numeric to double precision in rosariosis.sql\n- Add Can use modname to HACKING ATTEMPT error email in ErrorMessage.fnc.php\n- Fix HACKING ATTEMPT when Grades module inactive in Portal.php & Calendar.php\n- Use GetTemplate() instead of unescaping `$_REQUEST` in CreateParents.php & NotifyParents.php\n- Use `$_POST` to get password instead of unescaping `$_REQUEST` in PasswordReset.php, Student.php & User.php\n- Use DBGetOne() instead of unescaping `$_REQUEST` in Config.fnc.php\n- Add MySQL support in database.inc.php, diagnostic.php, InstallDatabase.php & Warehouse.php\n- Add $DatabaseType configuration variable in database.inc.php, diagnostic.php, InstallDatabase.php, Warehouse.php & config.inc.php\n- Add $show_error parameter to db_start() in database.inc.php\n- Add DBUnescapeString() function in database.inc.php, GetStuList.fnc.php, ListOutput.fnc.php, PreparePHP_SELF.fnc.php & Search.fnc.php\n- PostgreSQL Date format: move query from Date.php to Warehouse.php\n- Compatibility with add-ons version < 10.0, gather CONFIG (uppercase table name) values too in Configuration.php\n- Fix MySQL error Table is specified twice, both as a target for 'INSERT' and as a separate source for data in CopySchool.php & Rollover.php\n- Fix MySQL syntax error: no table alias in DELETE in Rollover.php\n- Fix MySQL syntax error: no FROM allowed inside UPDATE, use subquery or multi-table syntax in Rollover.php\n- Fix MySQL syntax error: replace CAST (NULL AS CHAR(1)) AS CHECKBOX with NULL AS CHECKBOX in AddAbsences.php, AddActivity.php, MassDrops.php, MassRequests.php, MassSchedule.php, AddUsers.php, AssignOtherInfo.php & AddStudents.php\n- Add Installation tutorial for Mac in WHATS_NEW.md & INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Update tested on Ubuntu 18.04 to 20.04 in INSTALL.md, INSTALL_fr.md & INSTALL_es.md\n- Fix SQL error when column already dropped in Fields.fnc.php\n- SQL fix CREATE INDEX on right table in rosariosis.sql\n- SQL remove unused indices for various tables in rosariosis.sql\n- SQL match index with FOREIGN KEY for various tables in rosariosis.sql\n- SQL ORDER BY fix issue when Transferring to another school & new start date is <= old start date in Enrollment.inc.php\n- Check if student already enrolled on that date when inserting START_DATE in SaveEnrollment.fnc.php\n- Add `_getAddonsSQL()` & `_configTableCheck()` functions in InstallDatabase.php\n- $DatabasePort configuration variable is now optional in config.inc.sample.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- SQL start staff_fields ID sequence at 200000000 for coherence with custom_fields in rosariosis.sql & Fields.fnc.php\n- MySQL use LONGTEXT type for textarea field in Fields.fnc.php & DisciplineForm.php\n- SQL Check requested assignment belongs to teacher in Assignments.php\n- CSS fix responsive when really long string with no space in stylesheet.css\n- Limit `$_POST` array size to a maximum of 16MB in Warehouse.php, thanks to @ahmad0x1\n- Add optional ROSARIO_POST_MAX_SIZE_LIMIT constant in Warehouse.php, INSTALL.md, INSTALL_es.md & INSTALL_fr.md\n- Add MySQL database dump in rosariosis_mysql.sql\n- Log \"RosarioSIS HACKING ATTEMPT\" into Apache error.log in HackingLog.fnc.php\n- Force URL & menu reloading, always use JS to redirect in HackingLog.fnc.php\n- Place currency symbol after amount for some locales in Currency.fnc.php\n- SQL use timestamp type: standard & without time zone by default in rosariosis.sql\n- CSS add .accounting-totals, .accounting-staff-payroll-totals, .student-billing-totals classes in Expenses.php, Incomes.php, Salaries.php, StaffPayments.php, StudentFees.php & StudentPayments.php\n- SQL rename KEY (reserved keyword) to SORT_KEY for MySQL compatibility in Search.fnc.php, StudentFieldBreakdown.php, StudentBreakdown.php\n- SQL use GROUP BY instead of DISCTINCT ON for MySQL compatibility in Address.inc.php & EnterEligibility.php\n- SQL cast Config( 'STUDENTS_EMAIL_FIELD' ) to int when custom field in SendNotification.fnc.php, Registration.fnc.php, Moodle/getconfig.inc.php & ImportUsers.fnc.php\n- Fix MySQL 5.6 error Can't specify target table for update in FROM clause in PortalPollsNotes.fnc.php, DeleteTransaction.fnc.php, DeleteTransactionItem.fnc.php, Rollover.php, CopySchool.php & AssignOtherInfo.php\n- Fix MySQL syntax error: explicitly list all columns instead of wildcard in ActivityReport.php & Statements.php\n- Fix MakeChooseCheckbox() remove parent link to sort column in Inputs.php & ListOutput.fnc.php\n- CSS WPadmin fix menu select width in stylesheet.css\n- Enrollment Start: No N/A option for new student in StudentUsersInfo.fnc.php\n\nChanges in 9.3.2\n----------------\n- Fix regression since 9.2.1 fields other type than Select Multiple from Options in CategoryBreakdownTime.php\n\nChanges in 9.3.1\n----------------\n- Fix regression since 2.9 Schedule multiple courses in plugins/Moodle/Scheduling/MassSchedule.php\n- Fix SQL to select Periods where exists CP in TeacherCompletion.php & Administration.php\n- Fix dummy day (year month date) set to 28 for February in Dashboard.inc.php\n- Fix AllowEdit for Teacher in Users/includes/General_Info.inc.php\n- Security: sanitize filename with no_accents() in Student.php, User.php & Schools.php\n- Fix \"Exclude PDF generated using the \"Print\" button\" option for the PDF Header Footer plugin in Bottom.php\n\nChanges in 9.3\n--------------\n- Handle case where Course Period Parent ID is null in Courses.php\n- SQL order by Period title in Periods.php, DailySummary.php & StudentSummary.php\n- SQL get Period title if no short name set in AddAbsences.php\n- Use DBLastInsertID() instead of DBSeqNextID() in Moodle/includes/ImportUsers.fnc.php\n- Still use DBSeqNextID() for student ID, adapt for MySQL in Student.php & Moodle/includes/ImportUsers.fnc.php\n- SQL use CONCAT() instead of pipes || for MySQL compatibility, program wide\n- Fix first item in the list not displayed in Accounting/includes/DailyTransactions.php\n- SQL time interval for MySQL compatibility in PasswordReset.php & index.php\n- SQL use CAST(X AS char(X)) instead of to_char() for MySQL compatibility in Dashboard.inc.php & Reminders.php\n- SQL result as comma separated list for MySQL compatibility in Grades/includes/Dashboard.inc.php & MasterScheduleReport.php\n- Use DBEscapeIdentifier() for MySQL reserved 'TIMESTAMP' keyword in ServeMenus.php & Transactions.php\n- SQL add `_SQLUnixTimestamp()` to extract Unix timestamp or epoch from date in Grades.php & Schedule.php\n- Add case for MySQL: get next MP ID & set AUTO_INCREMENT+1 in EditHistoryMarkingPeriods.php\n- Display Name: SQL use CONCAT() instead of pipes || for MySQL compatibility in Configuration.php & GetStuList.fnc.php\n- config table: update DISPLAY_NAME to use CONCAT() instead of pipes || in Update.fnc.php\n\nChanges in 9.2.2\n----------------\n- Fix SQL error lastval is not yet defined when editing field in SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Assignments.php\n\nChanges in 9.2.1\n----------------\n- Remove use of db_seq_nextval(), use auto increment, program wide\n- SQL set default nextval (auto increment) for RosarioSIS version < 5.0 on install & old add-ons in Update.fnc.php\n- SQL no more cast MARKING_PERIOD_ID column as text/varchar in rosariosis.sql & InputFinalGrades.php\n- PLpgSQL compact & consistent function declaration in rosariosis.sql\n- Use DB transaction statements compatible with MySQL in database.inc.php\n- Add DBLastInsertID() & deprecate DBSeqNextID() + db_seq_nextval() in database.inc.php\n- SQL rename character varying & character data types to varchar & char in rosariosis.sql\n- SQL replace use of STRPOS() with LIKE, compatible with MySQL in PortalPollNotes.fnc.php & Courses.php\n- SQL fix French & Spanish translation for Create Parent Users & Notifiy Parents email templates in rosariosis_fr.sql & rosariosis_es.sql\n- Use DBLastInsertID() instead of DBSeqNextID(), program wide\n- SQL TRIM() both compatible with PostgreSQL and MySQL in AttendanceSummary.php & CopySchool.php\n- SQL use extract() or SUBSTRING() or REPLACE() instead of to_char() for MySQL compatibility, program wide\n- Fix No Address contact not properly saved for student / parent in RegistrationSave.fnc.php\n- AddDBField() Change $sequence param to $field_id, adapted for use with DBLastInsertID() in Fields.fnc.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php & UserFields.php\n- Raise Frame file size limit to 5MB in HonorRoll.fnc.php\n- Fix Marking Period not found in user School Year (multiple browser tabs case) in MassSchedule.php & MassDrops.php\n- Fix Course not found in user School Year (multiple browser tabs case) in MassRequests.php\n- HTML add label to inputs in Requests.php\n- Remove help sentence. The Scheduler is not run by the Student Requests program in Help_en.php\n\nChanges in 9.2\n--------------\n- Fix SQL error invalid input syntax for integer in Administration.php\n- SQL student_report_card_grades table: convert MARKING_PERIOD_ID column to integer in Update.fnc.php, rosariosis.sql, EditReportCardGrades.php, FinalGrades.php & ReportCards.fnc.php\n\nChanges in 9.1.1\n----------------\n- Fix PHP8.1 fatal error unsupported operand types: string / int in Assignments.php & MassCreateAssignments.php\n- Fix selected Subject lost on Comment Category delete in ReportCardComments.php\n- Fix Color Input was hidden in ReportCardComments.php\n- Fix use Course ID in session in MassRequests.php\n- Fix SQL error primary key exists on table food_service_staff_accounts in Rollover.php\n- Fix SQL error foreign key exists on tables gradebook_assignments,gradebook_assignment_types,schedule_requests in Rollover.php\n- Fix save State input value in Registration.fnc.php\n- Fix SchoolInfo() on user School Year update in School.php\n\nChanges in 9.1\n--------------\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @domiee13\n- Capitalize month when date is only month and year in Dashboard.inc.php\n- Add decimal & thousands separator configuration in Help_en.php, Currency.fnc.php, Configuration.php, rosariosis.sql & rosariosis_fr.sql\n- Use Currency() for Food Service Balance value in Widget.php & StaffWidget.php\n- Add Class average in InputFinalGrades.php & Grades.fnc.php\n- Update French & Spanish translation in rosariosis.po & help.po\n- Update Default School Year to 2022 in config.inc.sample.php & rosariosis.sql\n\nChanges in 9.0\n--------------\n- CSS add length to previous meals select in DailyMenus.php\n- CSS FlatSIS fix calendar menu text wrapping in stylesheet.css\n- Add Export list button in TransactionsReport.php\n- Add Food Service icon to list in ServeMenus.php\n- Add User / Student photo tooltip in ServeMenus.php, Transactions.php & TeacherCompletion.php\n- HTML add horizontal ruler before each category in MakeReferral.php\n- Fix SQL error when generating Schedule table with PHP8.1 in GetMP.php\n- Reorder PDF list columns to match Schedule columns in PrintSchedules.php\n- SQL order Schedule list by Course Title & Course Period Short Name in Schedule.php, PrintSchedules.php & Schedule.inc.php\n- Fix SQL error more than one row returned by a subquery in Rollover.php\n- Fix update Course Period title when Short Name contains single quote in Courses.php\n- Fix PHP8.1 deprecated function parameter is null, program wide\n- Fix PHP8.1 deprecated automatic conversion of false to array in StudentsUsersInfo.fnc.php\n- Fix PHP8.1 deprecated automatic conversion of float to int in ImageResizeGD.php\n- Add Student Photo Tip Message in AddDrop.php & StudentList.php\n- Format Enrollment Start & End Date in Export.php\n- Add Student name if no Contacts at address in MailingLabel.fnc.php\n- Do not Export Delete column in Periods.php & GradeLevels.php\n- HTML group inputs inside fieldset (tab title or program name) in Configuration.php\n- Hide Comment Codes tip message if Comments unchecked for Marking Period in InputFinalGrades.php\n- Add Get Student Labels Form JS (Disable unchecked fieldset) in StudentLabels.fnc.php & StudentLabels.php\n- Fix PHP8.1 deprecated use PostgreSQL $db_connection global variable in database.inc.php & Grades/includes/Dashboard.inc.php\n- Don't Delete Gender & Birthday Student Fields in Fields.fnc.php\n- CSS set cursor for .tipmsg-label in stylesheet.css\n- Add Username to Password Reset email in PasswordReset.php\n- `intl` PHP extension is now required in diagnostic.php & INSTALL.md\n- Fix PHP8.1 deprecated strftime() use strftime_compat() instead in Side.php, Date.php, PHPCompatibility.php, strftime_compat.php, Dashboard.inc.php & Preferences.php\n- Add $course_period_id param to limit check to a single Course Period in Courses.fnc.php & Courses.php\n- Add title to Contact & Address button images in Address.inc.php & GetStuList.fnc.php\n- CSS select max-width 440px in stylesheet.css & zresponsive.css\n- HTML add label to Points inputs to correct alignment in Grades.php\n- HTML add a11y-hidden label to select in CategoryBreakdown.php, CategoryBreakdownTime.php & StudentFieldBreakdown.php\n- Place Go button right after Timeframe in DailyTransactions.php, DailyTotals.php, CategoryBreakdown.php, CategoryBreakdownTime.php, StudentFieldBreakdown.php & Percent.php\n- Fix French translation for \"Not due\" in rosariosis.po\n- Move Transcript Include form checkboxes up in Transcripts.fnc.php\n- Add Delete button for Submission File in StudentAssignments.fnc.php\n- Fix SQL error null value in column \"title\" violates not-null constraint in MassCreateAssignments.php\n- Reorder & rename Course Periods columns to match Schedule program in MassCreateAssignments.php\n- Fix get History Grades Grade Level short name only if no Grade Level available in Transcripts.fnc.php\n- Fix get Student Photo from previous year in Transcripts.fnc.php\n- Fix SQL error invalid input syntax in PrintSchedules.php & TeacherCompletion.php, thanks to @scgajge12\n- Filter IP, HTTP_* headers can be forged in index.php, PasswordReset.php & ErrorMessage.fnc.php\n- Fix SQL error invalid input syntax for integer, program wide\n- Fix PHP8.1 fatal error checkdate argument must be of type int in Calendar.php\n- Fix SQL error invalid input syntax for type date in Calendar.php\n- Fix SQL error duplicate key value violates unique constraint \"attendance_calendar_pkey\" in Calendar.php\n- Fix PHP fatal error Unsupported operand types in ListOutput.php\n- Add AttrEscape() function in Inputs.php\n- Use AttrEscape() instead of htmlspecialchars(), program wide\n- Add use of AttrEscape(), program wide\n- Maintain Advanced search when editing Timeframe in Percent.php\n- Fix SQL injection escape DB identifier in RegistrationSave.fnc.php, Calendar.php, MarkingPeriods.php, Courses.php, SchoolFields.php, AddressFields.php, PeopleFields.php, StudentFields.php, UserFields.php & Referrals.php\n- JS update marked to v4.0.14 in assets/js/marked/ & warehouse_wkhtmltopdf.js\n- JS add DOMPurify 2.3.6 in assets/js/DOMPurify/ & Gruntfile.js\n- JS fix stored XSS issue related to MarkDown in warehouse.js & plugins.min.js, thanks to @intrapus\n- JS remove logged in check on history back in warehouse.js & plugins.min.js\n- Add CSRF token to protect unauthenticated requests in Warehouse.php & login.php\n- Add CSRF token to logout URL in login.php, Warehouse.php, PasswordReset.php, Bottom.php, Student.php & User.php, thanks to @khanhchauminh\n- Logout after 10 Hacking attempts within 1 minute in HackingLog.fnc.php\n- Destroy session now: some clients do not follow redirection in HackingLog.fnc.php\n- Add use of URLEscape(), program wide\n- Use URLEscape() for img src attribute, program wide\n- Sanitize / escape URL as THEME is often included for button img src attribute in User.fnc.php\n- Better format for \"Add another marking period\" form in EditReportCardGrades.php\n- Fix Improper Access Control security issue: add random string to photo file name in TipMessage.fnc.php, Transcripts.fnc.php, PrintClassPictures.php, Student.php, User.php & General_Info.inc.php, thanks to @dungtuanha\n- Fix stored XSS security issue: decode HTML entities from URL in PreparePHP_SELF.fnc.php, thanks to @khanhchauminh\n- Fix stored XSS security issue: remove inline JS from URL in PreparePHP_SELF.fnc.php, thanks to @intrapus & @domiee13\n- Fix stored XSS security issue: add semicolon to HTML entity so it can be decoded in PreparePHP_SELF.fnc.php, thanks to @intrapus\n- Accessibility: add hidden input label using .a11y-hidden class in ReportCardComments.php, StudentFields.php & Grades/TeacherCompletion.php\n- Accessibility: add select label in Eligibility/TeacherCompletion.php, Student.php, StudentList.php, MassDrops.php & MassSchedule.php\n- Two Lists on same page: export only first, no search in Eligibility/Student.php\n- Remove photos on delete in Student.php & User.php, thank to @jo125ker\n- Remove Student Assignment Submission files on delete in Assignments.php, thank to @khanhchauminh\n- Add microseconds to filename format to make it harder to predict in Assignments.php & StudentAssignments.fnc.php, thanks to @khanhchauminh\n- Restrict Sort Order input number range, program wide\n- Restrict Price / Amount / Balance input number range, program wide, thanks to @nhienit2010\n- Restrict input number step in Courses.fnc.php\n- Restrict diagnostic access to logged in admin in diagnostic.php, thanks to @intrapus\n- Fix SQL error value too long for type character varying(50) in Schools.php\n- Add Secure RosarioSIS link in INSTALL.md\n- Add Calendar days legend in Calendar.php\n- CSS add .legend-square class in stylesheet.css & colors.css\n- Create / Edit / Delete calendar: use button() in Calendar.php\n- Update Calendars help text in Help_en.php & help.po\n- Add translations for Calendar days legend in rosariosis.po\n- Use json_encode() for AjaxLink() URL, program wide\n- SQL skip \"No Address\" contacts to avoid lines with empty Address fields in Export.php\n- French translation: remove capitalization & use articles in rosariosis.po, help.po & rosariosis_fr.sql\n- JS Sanitize string for legal variable name in Export.php & Inputs.php\n- Remove deprecated `_makeTeacher()` function in ReportCards.fnc.php\n- Use multiple select input for grades list to gain space in Widget.php\n- Fix regression since 5.0, allow Administration of \"Lunch\" attendance categories in Administration.php, AttendanceCodes.fnc.php & colors.css\n- SQL set default FAILED_LOGIN_LIMIT to 30 in rosariosis.sql, thanks to @domiee13\n- JS Hide Options textarea if Field not of select type in Fields.fnc.php\n- Add Balance widget in StudentBalances.php\n- Add Total sum of balances in StudentBalances.php\n- Fix SQL error check requested UserSyear & UserSchool exists in DB in Side.php, Search.fnc.php & SaveEnrollment.fnc.php\n- HTML use number input for Class Rank widget in Widget.php\n- Check default if school has no default calendar in Calendar.php\n- CSS do not capitalize date in stylesheet.css\n- Remove unused index ON attendance_period (attendance_code) & ON student_report_card_grades (school_id) in rosariosis.sql & rosariosis_mysql.sql\n- SQL VACUUM & ANALIZE are for PostgreSQL only in Scheduler.php\n\n\n### Old versions CHANGES\n- [CHANGES for versions 7 and 8](CHANGES_V7_8.md).\n- [CHANGES for versions 5 and 6](CHANGES_V5_6.md).\n- [CHANGES for versions 3 and 4](CHANGES_V3_4.md).\n- [CHANGES for versions 1 and 2](CHANGES_V1_2.md).\n", "<?php\n/**\n * File Upload functions\n *\n * @package RosarioSIS\n * @subpackage ProgramFunctions\n */\n\n/**\n * File Upload\n *\n * @example FileUpload( 'FILE_ATTACHED', $FileUploadsPath . UserSyear() . '/staff_' . User( 'STAFF_ID' ) . '/', FileExtensionWhiteList(), 0, $error );\n *\n * @global $_FILES\n *\n * @since 10.6 Resize, compress & store image using ImageUpload()\n *\n * @param string $input            Name of the input file field, for example 'photo'.\n * @param string $path             Final path with trailing slash, for example $StudentPicturesPath . UserSyear() . '/'.\n * @param array  $ext_white_list   Extensions white list, for example array('.jpg', '.jpeg').\n * @param float  $size_limit       Size Limit in Mb, set it to 0 to use server limit (upload_max_filesize).\n * @param array  $error            The global errors array.\n * @param string $final_ext        Final file extension (useful for .jpg, if .jpeg submitted) (optional).\n * @param string $file_name_no_ext Final file name without extension, for example UserStudentID() (optional).\n *\n * @return string|boolean Full path to file, or false if error\n */\nfunction FileUpload( $input, $path, $ext_white_list, $size_limit, &$error, $final_ext = '', $file_name_no_ext = '' )\n{\n\t$file_name = $full_path = false;\n\n\tif ( ! $final_ext )\n\t{\n\t\t$final_ext = empty( $_FILES[ $input ]['tmp_name'] ) ? '' :\n\t\t\tmb_strtolower( mb_strrchr( $_FILES[ $input ]['name'], '.' ) );\n\t}\n\n\tif ( $file_name_no_ext )\n\t{\n\t\t$file_name = $file_name_no_ext . $final_ext;\n\t}\n\n\t$caller_function = debug_backtrace();\n\n\t$caller_function = isset( $caller_function[1]['function'] ) ? $caller_function[1]['function'] : '';\n\n\tif ( empty( $_FILES[ $input ]['tmp_name'] )\n\t\t|| ! is_uploaded_file( $_FILES[ $input ]['tmp_name'] ) )\n\t{\n\t\t// Check the post_max_size & php_value upload_max_filesize values in the php.ini file.\n\t\t$error[] = _( 'File not uploaded' );\n\t}\n\n\telseif ( ! in_array( mb_strtolower( mb_strrchr( $_FILES[ $input ]['name'], '.' ) ), $ext_white_list ) )\n\t{\n\t\t$error[] = sprintf(\n\t\t\t_( 'Wrong file type: %s (%s required)' ),\n\t\t\t// Fix reflected XSS via mime-type.\n\t\t\tstrip_tags( $_FILES[ $input ]['type'] ),\n\t\t\timplode( ', ', $ext_white_list )\n\t\t);\n\t}\n\n\telseif ( $size_limit\n\t\t&& $_FILES[ $input ]['size'] > $size_limit * 1024 * 1024 )\n\t{\n\t\t$error[] = sprintf(\n\t\t\t_( 'File size > %01.2fMb: %01.2fMb' ),\n\t\t\t$size_limit,\n\t\t\t( $_FILES[ $input ]['size'] / 1024 ) / 1024\n\t\t);\n\t}\n\n\t// If folder doesnt exist, create it!\n\telseif ( ! is_dir( $path )\n\t\t&& ! @mkdir( $path, 0755, true ) ) // Fix shared hosting: permission 755 for directories.\n\t{\n\t\t$error[] = sprintf( _( 'Folder not created' ) . ': %s', $path );\n\t}\n\n\telseif ( ! is_writable( $path ) )\n\t{\n\t\t// See PHP / Apache user rights for folder.\n\t\t$error[] = sprintf( _( 'Folder not writable' ) . ': %s', $path );\n\t}\n\n\t// Check if file is image.\n\telseif ( $caller_function !== 'ImageUpload'\n\t\t&& in_array( $final_ext, [ '.jpg', '.jpeg', '.png', '.gif' ] ) )\n\t{\n\t\t// Resize, compress & store image using ImageUpload().\n\t\treturn ImageUpload(\n\t\t\t$input,\n\t\t\t[],\n\t\t\t$path,\n\t\t\t[],\n\t\t\t$final_ext,\n\t\t\t$file_name_no_ext\n\t\t);\n\t}\n\n\t// Store file.\n\telseif ( ! move_uploaded_file(\n\t\t$_FILES[ $input ]['tmp_name'],\n\t\t$full_path = ( $path . ( $file_name ?\n\t\t\t$file_name :\n\t\t\tno_accents( mb_substr(\n\t\t\t\t$_FILES[ $input ]['name'],\n\t\t\t\t0,\n\t\t\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t\t\t) ) . $final_ext\n\t\t) )\n\t) )\n\t{\n\t\t$error[] = sprintf( _( 'File invalid or not moveable' ) . ': %s', $_FILES[ $input ]['tmp_name'] );\n\t}\n\n\treturn $full_path;\n}\n\n\n/**\n * Image File Upload\n *\n * @example ImageUpload( 'photo', [ 'width' => 150, 'height' => '150' ], $StudentPicturesPath . UserSyear() . '/', [], '.jpg', UserStudentID() . '.' . bin2hex( openssl_random_pseudo_bytes( 16 ) ) );\n * @example ImageUpload( $base64_img, [ 'width' => 640, 'height' => '320' ] );\n *\n * @since 3.3\n *\n * @uses FileUpload()\n * @uses ImageResizeGD class.\n *\n * @param string $input            Name of the input file field, for example 'photo', or base64 encoded data, src attribute value.\n * @param array  $target_dim       Target dimensions to determine if can be resized. Defaults to [ 'width' => 994, 'height' => 1405 ] (optional).\n * @param string $path             Final path with trailing slash, for example $StudentPicturesPath . UserSyear() . '/'. Defaults to \"assets/FileUploads/[Syear]/[staff_or_student_ID]/\" (optional).\n * @param array  $ext_white_list   Extensions white list, for example ['.jpg', '.jpeg'].\n * @param string $final_ext        Final file extension (useful for .jpg, if .jpeg submitted) (optional).\n * @param string $file_name_no_ext Final file name without extension, for example UserStudentID() . '.' . bin2hex( openssl_random_pseudo_bytes( 16 ) ) (optional).\n *\n * @return string|boolean Full path to file, or false (or base64 data) if error\n */\nfunction ImageUpload( $input, $target_dim = [], $path = '', $ext_white_list = [], $final_ext = null, $file_name_no_ext = '' )\n{\n\tglobal $FileUploadsPath,\n\t\t$PNGQuantPath,\n\t\t$error;\n\n\trequire_once 'classes/ImageResizeGD.php';\n\n\t$is_base64 = ( strpos( $input, 'data:image' ) === 0 );\n\n\tif ( ! $path )\n\t{\n\t\t// Path defaults to \"assets/FileUploads/[Syear]/[staff_or_student_ID]/\".\n\t\t$user_folder = User( 'STAFF_ID' ) ? 'staff_' . User( 'STAFF_ID' ) : 'student_' . UserStudentID();\n\n\t\t$path = $FileUploadsPath . UserSyear() . '/' . $user_folder . '/';\n\t}\n\n\tif ( ! $ext_white_list )\n\t{\n\t\t// Defaults to JPG, PNG & GIF.\n\t\t$ext_white_list = [ '.jpg', '.jpeg', '.png', '.gif' ];\n\t}\n\n\t// Defaults to horizontal PDF target dimensions.\n\t$target_dim_default = [ 'width' => 994, 'height' => 1405 ];\n\n\t$target_dim = array_replace_recursive( $target_dim_default, (array) $target_dim );\n\n\tif ( ImageResizeGD::test() )\n\t{\n\t\t// If folder doesnt exist, create it!\n\t\tif ( ! is_dir( $path )\n\t\t\t&& ! @mkdir( $path, 0755, true ) ) // Fix shared hosting: permission 755 for directories.\n\t\t{\n\t\t\t$error[] = sprintf( _( 'Folder not created' ) . ': %s', $path );\n\n\t\t\treturn ( $is_base64 ? $input : false );\n\t\t}\n\t\telseif ( ! is_writable( $path ) )\n\t\t{\n\t\t\t// See PHP / Apache user rights for folder.\n\t\t\t$error[] = sprintf( _( 'Folder not writable' ) . ': %s', $path );\n\n\t\t\treturn ( $is_base64 ? $input : false );\n\t\t}\n\n\t\tif ( ! $is_base64 )\n\t\t{\n\t\t\tif ( ! is_uploaded_file( $_FILES[ $input ]['tmp_name'] ) )\n\t\t\t{\n\t\t\t\t// Check the post_max_size & php_value upload_max_filesize values in the php.ini file.\n\t\t\t\t$error[] = _( 'File not uploaded' );\n\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t$image_path_or_string = $_FILES[ $input ]['tmp_name'];\n\n\t\t\t$original_image_size = filesize( $image_path_or_string );\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$image_path_or_string = $input;\n\n\t\t\t// http://stackoverflow.com/questions/5373544/php-size-of-base64-encode-string-file\n\t\t\t$original_image_size = (int) ( strlen( rtrim( $image_path_or_string, '=' ) ) * 3 / 4 );\n\t\t}\n\n\t\t// Build file name.\n\t\tif ( $file_name_no_ext )\n\t\t{\n\t\t\t$file_name = $file_name_no_ext . $final_ext;\n\t\t}\n\t\telseif ( $is_base64 )\n\t\t{\n\t\t\t// Use MD5 sum for base64 images.\n\t\t\t$file_name = md5( $image_path_or_string ) . $final_ext;\n\n\t\t\t$full_path = $path . $file_name;\n\n\t\t\t// Check if file already exists?\n\t\t\tif ( $final_ext\n\t\t\t\t&& file_exists( $full_path ) )\n\t\t\t{\n\t\t\t\treturn $full_path;\n\t\t\t}\n\t\t\telseif ( file_exists( $full_path . '.jpg' ) )\n\t\t\t{\n\t\t\t\treturn $full_path . '.jpg';\n\t\t\t}\n\t\t\telseif ( file_exists( $full_path . '.png' ) )\n\t\t\t{\n\t\t\t\treturn $full_path . '.png';\n\t\t\t}\n\t\t\telseif ( file_exists( $full_path . '.gif' ) )\n\t\t\t{\n\t\t\t\treturn $full_path . '.gif';\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// Use original file name.\n\t\t\t$file_name = no_accents( mb_substr(\n\t\t\t\t$_FILES[ $input ]['name'],\n\t\t\t\t0,\n\t\t\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t\t\t) ) . $final_ext;\n\t\t}\n\n\t\t$extension = null;\n\n\t\tif ( $final_ext )\n\t\t{\n\t\t\tif ( mb_strtolower( $final_ext ) === '.jpg'\n\t\t\t\t|| mb_strtolower( $final_ext ) === '.jpeg' )\n\t\t\t{\n\t\t\t\t$extension = IMAGETYPE_JPEG;\n\t\t\t}\n\t\t\telseif ( mb_strtolower( $final_ext ) === '.png' )\n\t\t\t{\n\t\t\t\t$extension = IMAGETYPE_PNG;\n\t\t\t}\n\t\t\telseif ( mb_strtolower( $final_ext ) === '.gif' )\n\t\t\t{\n\t\t\t\t$extension = IMAGETYPE_GIF;\n\t\t\t}\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\t$target_jpg_compression = 85;\n\n\t\t\t$image_resize_gd = new ImageResizeGD(\n\t\t\t\t$image_path_or_string,\n\t\t\t\t$target_jpg_compression,\n\t\t\t\t9,\n\t\t\t\t$PNGQuantPath\n\t\t\t);\n\n\t\t\t// 3x or 2x Retina factor depending if small target image.\n\t\t\t$factor = $target_dim['width'] < 994 ? 3 : 2;\n\n\t\t\tif ( $image_resize_gd->getSourceWidth() > $target_dim['width'] * $factor\n\t\t\t\t|| $image_resize_gd->getSourceHeight() > $target_dim['height'] * $factor )\n\t\t\t{\n\t\t\t\t// Image dimensions > target dimensions *2 or 3 (enough for Retina), resize & compress more.\n\t\t\t\t$image_resize_gd->resizeWithinDimensions(\n\t\t\t\t\t$target_dim['width'] * $factor,\n\t\t\t\t\t$target_dim['height'] * $factor\n\t\t\t\t);\n\n\t\t\t\t$target_jpg_compression = 65;\n\t\t\t}\n\t\t\telseif ( $image_resize_gd->getSourceWidth() > $target_dim['width']\n\t\t\t\t|| $image_resize_gd->getSourceHeight() > $target_dim['height'] )\n\t\t\t{\n\t\t\t\t// Image dimensions > target dimensions, compress a bit more.\n\t\t\t\t$target_jpg_compression = 75;\n\t\t\t}\n\n\t\t\t// Upload image and return path.\n\t\t\t$full_path = $image_resize_gd->saveImageFile(\n\t\t\t\t$path . $file_name,\n\t\t\t\t$extension,\n\t\t\t\t$target_jpg_compression,\n\t\t\t\t// White background for JPEG.\n\t\t\t\t( $extension === IMAGETYPE_JPEG ? 'FFFFFF' : null )\n\t\t\t);\n\n\t\t\tif ( filesize( $full_path ) < $original_image_size\n\t\t\t\t|| ( $extension && $extension !== $image_resize_gd->getSourceType() ) )\n\t\t\t{\n\t\t\t\treturn $full_path;\n\t\t\t}\n\t\t\telseif ( $is_base64 )\n\t\t\t{\n\t\t\t\t// Our \"optimized\" file results bigger than the original one...\n\t\t\t\t$image_data = $image_path_or_string;\n\n\t\t\t\t$image_data = substr( $image_data, ( strpos( $image_data, 'base64' ) + 6 ) );\n\n\t\t\t\t$image_data = base64_decode( $image_data );\n\n\t\t\t\t// Save the original base64 image instead.\n\t\t\t\tfile_put_contents( $full_path, $image_data );\n\n\t\t\t\treturn $full_path;\n\t\t\t}\n\t\t}\n\t\tcatch ( Exception $e )\n\t\t{\n\t\t\t$error[] = 'ImageResizeGD: ' . $e->getMessage();\n\t\t}\n\t\tcatch ( InvalidArgumentException $e )\n\t\t{\n\t\t\t$error[] = 'ImageResizeGD: ' . $e->getMessage();\n\t\t}\n\t}\n\n\t// No GD library or ImageResizeGD exception...\n\tif ( $is_base64 )\n\t{\n\t\t// We return the base64 image as is...\n\t\treturn $input;\n\t}\n\n\t// Use regular FileUpload() function.\n\treturn (string) FileUpload(\n\t\t$input,\n\t\t$path,\n\t\t$ext_white_list,\n\t\t0,\n\t\t$error,\n\t\t(string) $final_ext,\n\t\t$file_name_no_ext\n\t);\n}\n\n\n/**\n * Files field Upload and Update\n * Upload custom Files field & update corresponding DB table.\n * Input name must BEGIN with $request, for example: \"valuesCUSTOM_3\".\n *\n * @since 4.6\n * @since 10.4 Add optional $id param\n *\n * @example FilesUploadUpdate( 'schools', 'values',\t$FileUploadsPath . 'Schools/' . UserSchool() . '/' );\n * @example FilesUploadUpdate( $table, 'tables' . $id, $FileUploadsPath . 'Hostel/', $id );\n *\n * @uses FileUpload()\n *\n * @param string $table   DB Table name.\n * @param string $request Request part of the input name.\n * @param string $path    Path, folder where the files will be uploaded to.\n * @param int    $id      Table row ID. Optional.\n *\n * @return string Empty or last file full path.\n */\nfunction FilesUploadUpdate( $table, $request, $path, $id = 0 )\n{\n\tglobal $error;\n\n\tif ( ! $table\n\t\t|| ! $path\n\t\t|| empty( $_FILES ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$table = mb_strtolower( $table );\n\n\t$new_file = '';\n\n\tforeach ( $_FILES as $input => $file )\n\t{\n\t\tif ( mb_strpos( $input, $request ) !== 0 )\n\t\t{\n\t\t\t// Input name must BEGIN with $request, for example: \"valuesCUSTOM_3\".\n\t\t\tcontinue;\n\t\t}\n\n\t\t$file_name_no_ext = no_accents( mb_substr(\n\t\t\t$_FILES[ $input ]['name'],\n\t\t\t0,\n\t\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t\t) );\n\n\t\t// @since 11.0 Add microseconds to filename format to make it harder to predict.\n\t\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' ) . '.' . substr( (string) microtime(), 2, 6 );\n\n\t\t$new_file = FileUpload(\n\t\t\t$input,\n\t\t\t$path,\n\t\t\tFileExtensionWhiteList(),\n\t\t\t0,\n\t\t\t$error,\n\t\t\t'',\n\t\t\t$file_name_no_ext\n\t\t);\n\n\t\tif ( $new_file )\n\t\t{\n\t\t\t$value_append = $new_file . '||';\n\n\t\t\t$column = str_replace( $request, '', $input );\n\n\t\t\tif ( $table === 'schools' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : UserSchool();\n\n\t\t\t\t$where_sql = \"ID='\" . (int) $id . \"' AND SYEAR='\" . UserSyear() . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'students' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : UserStudentID();\n\n\t\t\t\t$where_sql = \"STUDENT_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'address' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : $_REQUEST['address_id'];\n\n\t\t\t\t$where_sql = \"ADDRESS_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'people' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : $_REQUEST['person_id'];\n\n\t\t\t\t$where_sql = \"PERSON_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telseif ( $table === 'staff' )\n\t\t\t{\n\t\t\t\t$id = $id ? $id : UserStaffID();\n\n\t\t\t\t$where_sql = \"STAFF_ID='\" . (int) $id . \"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$id = $id ? $id : $_REQUEST['id'];\n\n\t\t\t\t$where_sql = \"ID='\" . (int) $id . \"'\";\n\t\t\t}\n\n\t\t\tDBQuery( \"UPDATE \" . DBEscapeIdentifier( $table ) . \"\n\t\t\t\tSET \" . DBEscapeIdentifier( $column ) . \"=CONCAT(COALESCE(\" .\n\t\t\t\tDBEscapeIdentifier( $column ) . \",''),'\" . DBEscapeString( $value_append ) . \"')\n\t\t\t\tWHERE \" . $where_sql );\n\t\t}\n\t}\n\n\treturn $new_file;\n}\n\n/**\n * Handle `multiple` files attribute for FileUpload().\n * Move $_FILES[ $input ][...][ $i ] to $_FILES[ {$input}_{$i} ] so FileUpload() can handle it.\n *\n * @since 7.8\n *\n * @example foreach ( FileUploadMultiple( 'files' ) as $input ) { FileUpload( $input ) }\n *\n * @param string $input Input name, without square brackets [].\n *\n * @return array Empty if no files. $input if not multiple. {$input}_{$i} if multiple.\n */\nfunction FileUploadMultiple( $input )\n{\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn [];\n\t}\n\n\tif ( ! is_array( $_FILES[ $input ]['name'] ) )\n\t{\n\t\t// Not multiple files, return $input.\n\t\treturn [ $input ];\n\t}\n\n\t$inputs = [];\n\n\t$files = [];\n\n\tforeach ( $_FILES[ $input ] as $attribute => $files_info )\n\t{\n\t\tforeach ( $files_info as $i => $file_info )\n\t\t{\n\t\t\tif ( ! isset( $files[ $i ] ) )\n\t\t\t{\n\t\t\t\t$files[ $i ] = [];\n\t\t\t}\n\n\t\t\t$files[ $i ][ $attribute ] = $file_info;\n\t\t}\n\t}\n\n\tforeach ( $files as $i => $file )\n\t{\n\n\t\t$input_new_index = $input . '_' . $i;\n\n\t\t$inputs[] = $input_new_index;\n\n\t\t// Move $_FILES[ $input ][...][ $i ] to $_FILES[ {$input}_{$i} ] so FileUpload() can handle it.\n\t\t$_FILES[ $input_new_index ] = $file;\n\t}\n\n\tunset( $_FILES[ $input ] );\n\n\treturn $inputs;\n}\n\n/**\n * Removes accents from string.\n * Also replaces characters others than letters, space, numbers & points\n * with underscores '_'.\n * Perfect to sanitize a filename.\n *\n * @since 3.4 uses PHP intl extension or return microtime in case string does not contain ASCII chars.\n * @since 8.2 Fix replace regex: remove slash & allow space\n *\n * @link http://stackoverflow.com/questions/1017599/how-do-i-remove-accents-from-characters-in-a-php-string\n *\n * @example no_accents( '\u0440\u0443\u043b\u043e\u043d\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439' )\n * Will return 'rulonpol_zovatelej' if PHP intl extension is activated\n * Else it will return microtime, for example '14976328319110'\n *\n * @example no_accents( '\u96c6\u56e2\u5206\u914d\u5b66\u751f\u4fe1\u606f' )\n * Will return 'ji_tuan_fen_pei_xue_sheng_xin_xi' if PHP intl extension is activated\n * Else it will return microtime, for example '14976328319110'\n *\n * @param string $string String with maybe accents.\n *\n * @return string String with no accents or microtime.\n */\nfunction no_accents( $string )\n{\n\tif ( ! preg_match( '/[\\x80-\\xff]/', $string) )\n\t{\n\t\t// Replace characters others than letters, space, numbers & points with underscores  \"_\".\n\t\t$string = preg_replace(\n\t\t\t'/([^ _\\-.a-z0-9]+)/i',\n\t\t\t'_',\n\t\t\t$string\n\t\t);\n\t}\n\n\tif ( function_exists( 'transliterator_transliterate' ) )\n\t{\n\t\t/**\n\t\t * Requires PHP intl extension.\n\t\t * Will transliterate to latin ASCII chars.\n\t\t *\n\t\t * @example \u0440\u0443\u043b\u043e\u043d\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 => rulonpol_zovatelej\n\t\t * @example \u96c6\u56e2\u5206\u914d\u5b66\u751f\u4fe1\u606f => ji_tuan_fen_pei_xue_sheng_xin_xi\n\t\t */\n\t\t$string = transliterator_transliterate(\n\t\t\t'Any-Latin; Latin-ASCII; Lower()',\n\t\t\t$string\n\t\t);\n\n\t\t// Replace characters others than letters, space, numbers & points with underscores  \"_\".\n\t\t$string = preg_replace(\n\t\t\t'/([^ _\\-.a-z0-9]+)/i',\n\t\t\t'_',\n\t\t\t$string\n\t\t);\n\n\t\treturn $string;\n\t}\n\n\t$c195 = chr( 195 );\n\t$c196 = chr( 196 );\n\t$c197 = chr( 197 );\n\n\t$chars = [\n\t// Decompositions for Latin-1 Supplement.\n\t$c195 . chr(128) => 'A', $c195 . chr(129) => 'A',\n\t$c195 . chr(130) => 'A', $c195 . chr(131) => 'A',\n\t$c195 . chr(132) => 'A', $c195 . chr(133) => 'A',\n\t$c195 . chr(135) => 'C', $c195 . chr(136) => 'E',\n\t$c195 . chr(137) => 'E', $c195 . chr(138) => 'E',\n\t$c195 . chr(139) => 'E', $c195 . chr(140) => 'I',\n\t$c195 . chr(141) => 'I', $c195 . chr(142) => 'I',\n\t$c195 . chr(143) => 'I', $c195 . chr(145) => 'N',\n\t$c195 . chr(146) => 'O', $c195 . chr(147) => 'O',\n\t$c195 . chr(148) => 'O', $c195 . chr(149) => 'O',\n\t$c195 . chr(150) => 'O', $c195 . chr(153) => 'U',\n\t$c195 . chr(154) => 'U', $c195 . chr(155) => 'U',\n\t$c195 . chr(156) => 'U', $c195 . chr(157) => 'Y',\n\t$c195 . chr(159) => 's', $c195 . chr(160) => 'a',\n\t$c195 . chr(161) => 'a', $c195 . chr(162) => 'a',\n\t$c195 . chr(163) => 'a', $c195 . chr(164) => 'a',\n\t$c195 . chr(165) => 'a', $c195 . chr(167) => 'c',\n\t$c195 . chr(168) => 'e', $c195 . chr(169) => 'e',\n\t$c195 . chr(170) => 'e', $c195 . chr(171) => 'e',\n\t$c195 . chr(172) => 'i', $c195 . chr(173) => 'i',\n\t$c195 . chr(174) => 'i', $c195 . chr(175) => 'i',\n\t$c195 . chr(177) => 'n', $c195 . chr(178) => 'o',\n\t$c195 . chr(179) => 'o', $c195 . chr(180) => 'o',\n\t$c195 . chr(181) => 'o',\n\t$c195 . chr(182) => 'o', $c195 . chr(185) => 'u',\n\t$c195 . chr(186) => 'u', $c195 . chr(187) => 'u',\n\t$c195 . chr(188) => 'u', $c195 . chr(189) => 'y',\n\t$c195 . chr(191) => 'y',\n\t// Decompositions for Latin Extended-A.\n\t$c196 . chr(128) => 'A', $c196 . chr(129) => 'a',\n\t$c196 . chr(130) => 'A', $c196 . chr(131) => 'a',\n\t$c196 . chr(132) => 'A', $c196 . chr(133) => 'a',\n\t$c196 . chr(134) => 'C', $c196 . chr(135) => 'c',\n\t$c196 . chr(136) => 'C', $c196 . chr(137) => 'c',\n\t$c196 . chr(138) => 'C', $c196 . chr(139) => 'c',\n\t$c196 . chr(140) => 'C', $c196 . chr(141) => 'c',\n\t$c196 . chr(142) => 'D', $c196 . chr(143) => 'd',\n\t$c196 . chr(144) => 'D', $c196 . chr(145) => 'd',\n\t$c196 . chr(146) => 'E', $c196 . chr(147) => 'e',\n\t$c196 . chr(148) => 'E', $c196 . chr(149) => 'e',\n\t$c196 . chr(150) => 'E', $c196 . chr(151) => 'e',\n\t$c196 . chr(152) => 'E', $c196 . chr(153) => 'e',\n\t$c196 . chr(154) => 'E', $c196 . chr(155) => 'e',\n\t$c196 . chr(156) => 'G', $c196 . chr(157) => 'g',\n\t$c196 . chr(158) => 'G', $c196 . chr(159) => 'g',\n\t$c196 . chr(160) => 'G', $c196 . chr(161) => 'g',\n\t$c196 . chr(162) => 'G', $c196 . chr(163) => 'g',\n\t$c196 . chr(164) => 'H', $c196 . chr(165) => 'h',\n\t$c196 . chr(166) => 'H', $c196 . chr(167) => 'h',\n\t$c196 . chr(168) => 'I', $c196 . chr(169) => 'i',\n\t$c196 . chr(170) => 'I', $c196 . chr(171) => 'i',\n\t$c196 . chr(172) => 'I', $c196 . chr(173) => 'i',\n\t$c196 . chr(174) => 'I', $c196 . chr(175) => 'i',\n\t$c196 . chr(176) => 'I', $c196 . chr(177) => 'i',\n\t$c196 . chr(178) => 'IJ',$c196 . chr(179) => 'ij',\n\t$c196 . chr(180) => 'J', $c196 . chr(181) => 'j',\n\t$c196 . chr(182) => 'K', $c196 . chr(183) => 'k',\n\t$c196 . chr(184) => 'k', $c196 . chr(185) => 'L',\n\t$c196 . chr(186) => 'l', $c196 . chr(187) => 'L',\n\t$c196 . chr(188) => 'l', $c196 . chr(189) => 'L',\n\t$c196 . chr(190) => 'l', $c196 . chr(191) => 'L',\n\t$c197 . chr(128) => 'l', $c197 . chr(129) => 'L',\n\t$c197 . chr(130) => 'l', $c197 . chr(131) => 'N',\n\t$c197 . chr(132) => 'n', $c197 . chr(133) => 'N',\n\t$c197 . chr(134) => 'n', $c197 . chr(135) => 'N',\n\t$c197 . chr(136) => 'n', $c197 . chr(137) => 'N',\n\t$c197 . chr(138) => 'n', $c197 . chr(139) => 'N',\n\t$c197 . chr(140) => 'O', $c197 . chr(141) => 'o',\n\t$c197 . chr(142) => 'O', $c197 . chr(143) => 'o',\n\t$c197 . chr(144) => 'O', $c197 . chr(145) => 'o',\n\t$c197 . chr(146) => 'OE',$c197 . chr(147) => 'oe',\n\t$c197 . chr(148) => 'R', $c197 . chr(149) => 'r',\n\t$c197 . chr(150) => 'R', $c197 . chr(151) => 'r',\n\t$c197 . chr(152) => 'R', $c197 . chr(153) => 'r',\n\t$c197 . chr(154) => 'S', $c197 . chr(155) => 's',\n\t$c197 . chr(156) => 'S', $c197 . chr(157) => 's',\n\t$c197 . chr(158) => 'S', $c197 . chr(159) => 's',\n\t$c197 . chr(160) => 'S', $c197 . chr(161) => 's',\n\t$c197 . chr(162) => 'T', $c197 . chr(163) => 't',\n\t$c197 . chr(164) => 'T', $c197 . chr(165) => 't',\n\t$c197 . chr(166) => 'T', $c197 . chr(167) => 't',\n\t$c197 . chr(168) => 'U', $c197 . chr(169) => 'u',\n\t$c197 . chr(170) => 'U', $c197 . chr(171) => 'u',\n\t$c197 . chr(172) => 'U', $c197 . chr(173) => 'u',\n\t$c197 . chr(174) => 'U', $c197 . chr(175) => 'u',\n\t$c197 . chr(176) => 'U', $c197 . chr(177) => 'u',\n\t$c197 . chr(178) => 'U', $c197 . chr(179) => 'u',\n\t$c197 . chr(180) => 'W', $c197 . chr(181) => 'w',\n\t$c197 . chr(182) => 'Y', $c197 . chr(183) => 'y',\n\t$c197 . chr(184) => 'Y', $c197 . chr(185) => 'Z',\n\t$c197 . chr(186) => 'z', $c197 . chr(187) => 'Z',\n\t$c197 . chr(188) => 'z', $c197 . chr(189) => 'Z',\n\t$c197 . chr(190) => 'z', $c197 . chr(191) => 's'\n\t];\n\n\t$string = strtr( $string, $chars );\n\n\t// Replace characters others than letters, space, numbers & points with underscores  \"_\".\n\t$string = preg_replace(\n\t\t'/([^ _\\-.a-z0-9]+)/i',\n\t\t'_',\n\t\t$string\n\t);\n\n\tif ( $string === '_' )\n\t{\n\t\t// String does not contain any latin ASCII char return microtime!\n\t\t$string = number_format( microtime( true ), 4, '', '' );\n\t}\n\n\treturn $string;\n}\n\n\n\n/**\n * Get server maximum file upload size (Mb)\n *\n * @see  php.ini directives (upload_max_filesize & post_max_size)\n *\n * @uses ReturnMegabytes() function\n *\n * @return float maximum file upload size in Mega Bytes (Mb)\n */\nfunction FileUploadMaxSize()\n{\n\t// Size is limited by server configuration (upload_max_filesize & post_max_size).\n\treturn (float) min(\n\t\tReturnMegabytes( ini_get( 'post_max_size' ) ),\n\t\tReturnMegabytes( ini_get( 'upload_max_filesize' ) )\n\t);\n}\n\n\n/**\n * Return value in Mega Bytes (MB)\n *\n * @example ReturnMegabytes( ini_get( 'upload_max_filesize' ) )\n *\n * @param  string $val php.ini value, shorthand notation.\n *\n * @return string      value in Mega Bytes (MB)\n */\nfunction ReturnMegabytes( $val ) {\n\n\t$val = trim( $val );\n\n\t$last = strtolower( $val[ strlen( $val ) - 1 ] );\n\n\t$val = (int) $val;\n\n\tswitch ( $last ) {\n\n\t\t// The 'G' modifier is available since PHP 5.1.0.\n\t\tcase 'g':\n\n\t\t\t$val *= 1024;\n\n\t\tcase 'm':\n\n\t\t\t$val *= 1;\n\n\t\tbreak;\n\n\t\tdefault:\n\n\t\t\t$val /= 1024;\n\n\t\tcase 'k':\n\n\t\t\t$val /= 1024;\n\t}\n\n\treturn $val;\n}\n\n\n/**\n * Human filesize\n * Converts bytes into human readable file size.\n *\n * @example $file_size = HumanFilesize( filesize( $file_name ) );\n *\n * @link http://php.net/manual/en/function.filesize.php#106569\n *\n * @since  2.9\n *\n * @param  integer $bytes    File size in Bytes.\n * @param  integer $decimals Decimals (optional). Defaults to 1.\n *\n * @return string            Human readable file size.\n */\nfunction HumanFilesize( $bytes, $decimals = 1 )\n{\n\t$sz = 'BKMGTP';\n\n\t$factor = floor( ( strlen( $bytes ) - 1 ) / 3 );\n\n\treturn sprintf( \"%.{$decimals}f\", $bytes / pow( 1024, $factor ) ) . @$sz[ $factor ];\n}\n\n\n/**\n * Extensions white list.\n * Common file types.\n * Obviously, we won't include executable types\n * .php, .sql, .js, .exe...\n * If you file type is not white listed,\n * put it in a ZIP archive!\n *\n * @since 3.8.1\n *\n * @link http://fileinfo.com/filetypes/common\n */\nfunction FileExtensionWhiteList() {\n\treturn [\n\t\t// Micro$oft Office.\n\t\t'.doc',\n\t\t'.docx',\n\t\t'.dotx',\n\t\t'.xls',\n\t\t'.xlsm',\n\t\t'.xlsx',\n\t\t'.xlr',\n\t\t'.pps',\n\t\t'.ppsx',\n\t\t'.ppt',\n\t\t'.pptx',\n\t\t'.wps',\n\t\t'.wpd',\n\t\t'.rtf',\n\t\t'.mdb',\n\t\t'.sldx',\n\t\t// Libre Office.\n\t\t'.odt',\n\t\t'.ods',\n\t\t'.odp',\n\t\t'.odg',\n\t\t'.odc',\n\t\t'.odb',\n\t\t'.odf',\n\t\t// Apple iWork.\n\t\t'.key',\n\t\t'.numbers',\n\t\t'.pages',\n\t\t// Images.\n\t\t'.jpg',\n\t\t'.jpeg',\n\t\t'.png',\n\t\t'.gif',\n\t\t'.bmp',\n\t\t// @since 8.9.3 Fix stored XSS security issue: do not allow unsanitized SVG\n\t\t// '.svg',\n\t\t'.ico',\n\t\t'.psd',\n\t\t'.ai',\n\t\t'.eps',\n\t\t'.ps',\n\t\t'.webp',\n\t\t// Audio.\n\t\t'.mp3',\n\t\t'.m4a',\n\t\t'.ogg',\n\t\t'.wav',\n\t\t'.mid',\n\t\t'.midi',\n\t\t'.wma',\n\t\t'.aif',\n\t\t'.flac',\n\t\t'.mka',\n\t\t// Video.\n\t\t'.avi',\n\t\t'.mp4',\n\t\t'.mpg',\n\t\t'.mpeg',\n\t\t'.ogv',\n\t\t'.webm',\n\t\t'.wmv',\n\t\t'.h264',\n\t\t'.mkv',\n\t\t'.mov',\n\t\t'.m4v',\n\t\t'.flv', // @deprecated Adobe Flash.\n\t\t'.swf', // @deprecated Adobe Flash.\n\t\t// Text.\n\t\t'.txt',\n\t\t'.pdf',\n\t\t'.md',\n\t\t'.csv',\n\t\t'.tsv',\n\t\t'.tex',\n\t\t'.log',\n\t\t'.json',\n\t\t'.ics',\n\t\t// Email.\n\t\t'.email',\n\t\t'.eml',\n\t\t'.emlx',\n\t\t'.msg',\n\t\t'.vcf',\n\t\t// Web.\n\t\t// @since 8.9.5 Fix stored XSS security issue: do not allow unsanitized XML & HTML\n\t\t// '.xml',\n\t\t// '.xhtml',\n\t\t// '.html',\n\t\t// '.htm',\n\t\t'.css',\n\t\t'.rss',\n\t\t// Compressed.\n\t\t'.zip',\n\t\t'.rar',\n\t\t'.7z',\n\t\t'.tar',\n\t\t'.gz',\n\t];\n}\n", "<?php\nfunction _makeIncomesRemove( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\treturn button(\n\t\t'remove',\n\t\t_( 'Delete' ),\n\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] . '&modfunc=remove&id=' . $THIS_RET['ID'] ) . '\"'\n\t);\n}\n\nfunction _makeSalariesRemove( $value, $column )\n{\n\treturn _makeIncomesRemove( $value, $column );\n}\n\nfunction _makePaymentsRemove( $value, $column )\n{\n\treturn _makeIncomesRemove( $value, $column );\n}\n\nfunction _makeIncomesTextInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t\t$div = 'force';\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t\t$div = false;\n\t}\n\n\t$extra = 'maxlength=255';\n\n\tif ( $column === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput( $value, 'values[' . $id . '][' . $column . ']', '', $extra, $div );\n}\n\n\nfunction _makeIncomesDateInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\treturn DateInput( $value, 'values[' . $id . '][' . $column . ']', '', ( $id !== 'new' ), false );\n}\n\nfunction _makePaymentsDateInput( $value, $name )\n{\n\treturn _makeIncomesDateInput( $value, $name );\n}\n\nfunction _makeSalariesTextInput( $value, $name )\n{\n\treturn _makeIncomesTextInput( $value, $name );\n}\n\nfunction _makeSalariesDateInput( $value, $name )\n{\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$name = 'values[' . $id . '][' . $name . ']';\n\n\treturn DateInput( $value, $name );\n}\n\nfunction _makePaymentsTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\t$extra = 'maxlength=255';\n\n\tif ( $name === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput( $value, 'values[' . $id . '][' . $name . ']', '', $extra );\n}\n\n\n/**\n * Make Payments Comments Input\n * Add Salaries dropdown to reconcile Payment:\n * Automatically fills the Comments & Amount inputs.\n *\n * @since 5.1\n * @since 7.7 Remove Salaries having a Payment (same Amount & Comments (Title), after or on Assigned Date).\n *\n * @uses _makePaymentsTextInput()\n *\n * @param  string $value Comments value.\n * @param  string $name  Column name, 'COMMENTS'.\n *\n * @return string Text input if not new or if no Salaries found, else Text input & Salaries dropdown.\n */\nfunction _makePaymentsCommentsInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\t$text_input = _makePaymentsTextInput( $value, $name );\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t// Add Salaries dropdown to reconcile Payment.\n\t$salaries_RET = DBGet( \"SELECT ID,TITLE,ASSIGNED_DATE,DUE_DATE,AMOUNT\n\t\tFROM accounting_salaries sal\n\t\tWHERE STAFF_ID='\" . UserStaffID() . \"'\n\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\tAND NOT EXISTS(SELECT 1\n\t\t\tFROM accounting_payments\n\t\t\tWHERE STAFF_ID='\" . UserStaffID() . \"'\n\t\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\t\tAND AMOUNT=sal.AMOUNT\n\t\t\tAND (COMMENTS=sal.TITLE OR COMMENTS LIKE CONCAT('%',sal.TITLE) OR COMMENTS LIKE CONCAT(sal.TITLE,'%'))\n\t\t\tAND PAYMENT_DATE>=sal.ASSIGNED_DATE)\n\t\tORDER BY ASSIGNED_DATE DESC\n\t\tLIMIT 20\" );\n\n\tif ( ! $salaries_RET )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t$salaries_options = [];\n\n\tforeach ( $salaries_RET as $salary )\n\t{\n\t\t$salaries_options[ $salary['AMOUNT'] . '|' . $salary['TITLE'] ] = ProperDate( $salary['ASSIGNED_DATE'], 'short' ) .\n\t\t\t' \u2014 ' . Currency( $salary['AMOUNT'] ) .\n\t\t\t' \u2014 ' . $salary['TITLE'];\n\t}\n\n\t// JS automatically fills the Comments & Amount inputs.\n\tob_start();\n\t?>\n\t<script>\n\t\tvar accountingPaymentsSalariesReconcile = function( amountComments ) {\n\t\t\tvar separatorIndex = amountComments.indexOf( '|' ),\n\t\t\t\tamount = amountComments.substring( 0, separatorIndex ),\n\t\t\t\tcomments = amountComments.substring( separatorIndex + 1 );\n\n\t\t\t$('#valuesnewAMOUNT').val( amount );\n\t\t\t$('#valuesnewCOMMENTS').val( comments );\n\t\t};\n\t</script>\n\t<?php\n\t$js = ob_get_clean();\n\n\t// Select so we can search Salaries by date, amount, & title.\n\t$select_input = SelectInput(\n\t\t'',\n\t\t'accounting_salaries',\n\t\t'',\n\t\t$salaries_options,\n\t\t'N/A',\n\t\t'onchange=\"accountingPaymentsSalariesReconcile(this.value);\" style=\"width: 250px;\"'\n\t);\n\n\treturn $text_input . ' ' . $js . $select_input;\n}\n\nfunction _makeSalariesAmount( $value, $column )\n{\n\tglobal $salaries_total;\n\n\t$salaries_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _makeIncomesAmount( $value, $column )\n{\n\tglobal $incomes_total;\n\n\t$incomes_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _makePaymentsAmount( $value, $column )\n{\n\tglobal $payments_total;\n\n\t$payments_total += $value;\n\n\treturn Currency( $value );\n}\n\n/**\n * Make Salaries File Attached Input\n *\n * @since 8.1\n * @since 10.4 Add File Attached Input for existing Salaries\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makeSalariesFileInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn FileInput(\n\t\t\t'FILE_ATTACHED'\n\t\t);\n\t}\n\n\tif ( empty( $value )\n\t\t|| ! file_exists( $value ) )\n\t{\n\t\tif ( isset( $_REQUEST['_ROSARIO_PDF'] )\n\t\t\t|| ! AllowEdit() )\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\t// Add hidden FILE_ATTACHED input so it gets saved even if no other columns to save.\n\t\treturn '<input type=\"hidden\" name=\"values[' . $THIS_RET['ID'] . '][FILE_ATTACHED]\" value=\"\" />' .\n\t\tFileInput(\n\t\t\t'FILE_ATTACHED_' . $THIS_RET['ID']\n\t\t);\n\t}\n\n\tif ( ! empty( $_REQUEST['LO_save'] ) )\n\t{\n\t\t// Export list.\n\t\treturn $value;\n\t}\n\n\t$file_path = $value;\n\n\t$file_name = mb_substr( mb_strrchr( $file_path, '/' ), 1 );\n\n\t$file_size = HumanFilesize( filesize( $file_path ) );\n\n\t// Truncate file name if > 36 chars.\n\t$file_name_display = mb_strlen( $file_name ) <= 36 ?\n\t\t$file_name :\n\t\tmb_substr( $file_name, 0, 30 ) . '..' . mb_strrchr( $file_name, '.' );\n\n\t$file = button(\n\t\t'download',\n\t\t$file_name_display,\n\t\t'\"' . URLEscape( $file_path ) . '\" target=\"_blank\" title=\"' . AttrEscape( $file_name . ' (' . $file_size . ')' ) . '\"',\n\t\t'bigger'\n\t);\n\n\treturn $file;\n}\n\n/**\n * Make Payments File Attached Input\n *\n * @since 8.3\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makePaymentsFileInput( $value, $column )\n{\n\treturn _makeSalariesFileInput( $value, $column );\n}\n\n/**\n * Make Incomes File Attached Input\n *\n * @since 8.4\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makeIncomesFileInput( $value, $column )\n{\n\treturn _makeSalariesFileInput( $value, $column );\n}\n\n/**\n * Save Salaries File\n *\n * @since 10.4\n * @since 10.8.2 Add datetime to filename to make it harder to predict\n *\n * @param  int|string $id Salary ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveSalariesFile( $id )\n{\n\tglobal $error,\n\t\t$FileUploadsPath;\n\n\t$input = $id === 'new' ? 'FILE_ATTACHED' : 'FILE_ATTACHED_' . $id;\n\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name_no_ext = no_accents( mb_substr(\n\t\t$_FILES[ $input ]['name'],\n\t\t0,\n\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t) );\n\n\t// @since 11.0 Add microseconds to filename format to make it harder to predict.\n\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' ) . '.' . substr( (string) microtime(), 2, 6 );\n\n\t$file_attached = FileUpload(\n\t\t$input,\n\t\t$FileUploadsPath . UserSyear() . '/staff_' . UserStaffID() . '/',\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\t// Fix SQL error when quote in uploaded file name.\n\treturn DBEscapeString( $file_attached );\n}\n\n/**\n * Save Payments File\n *\n * @since 10.4\n *\n * @param  int|string $id Payment ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _savePaymentsFile( $id )\n{\n\treturn _saveSalariesFile( $id );\n}\n\n/**\n * Save Incomes File\n *\n * @since 10.4\n * @since 10.8.2 Add datetime to filename to make it harder to predict\n *\n * @param  int|string $id Income ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveIncomesFile( $id )\n{\n\tglobal $error,\n\t\t$FileUploadsPath;\n\n\t$input = $id === 'new' ? 'FILE_ATTACHED' : 'FILE_ATTACHED_' . $id;\n\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name_no_ext = no_accents( mb_substr(\n\t\t$_FILES[ $input ]['name'],\n\t\t0,\n\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t) );\n\n\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' );\n\n\t$file_attached = FileUpload(\n\t\t$input,\n\t\t$FileUploadsPath . UserSyear() . '/staff_' . User( 'STAFF_ID' ) . '/',\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\t// Fix SQL error when quote in uploaded file name.\n\treturn DBEscapeString( $file_attached );\n}\n\n/**\n * Save Expenses File\n *\n * @since 10.4\n *\n * @param  int|string $id Expense ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveExpensesFile( $id )\n{\n\treturn _saveIncomesFile( $id );\n}\n", "<?php\nrequire_once 'ProgramFunctions/PortalPollsNotes.fnc.php';\nrequire_once 'ProgramFunctions/FileUpload.fnc.php';\nrequire_once 'ProgramFunctions/MarkDownHTML.fnc.php';\n\nDrawHeader( ProgramTitle() );\n\n// Add eventual Dates to $_REQUEST['values'].\nAddRequestedDates( 'values', 'post' );\n\n$profiles_RET = DBGet( \"SELECT ID,TITLE FROM user_profiles ORDER BY ID\" );\n\nif ( $_REQUEST['modfunc'] === 'update'\n\t&& (  ( $_REQUEST['profiles']\n\t\t&& $_POST['profiles'] )\n\t\t|| ( $_REQUEST['values']\n\t\t\t&& $_POST['values'] ) )\n\t&& AllowEdit() )\n{\n\t$notes_RET = DBGet( \"SELECT ID FROM portal_notes WHERE SCHOOL_ID='\" . UserSchool() . \"' AND SYEAR='\" . UserSyear() . \"'\" );\n\n\tforeach ( (array) $notes_RET as $note_id )\n\t{\n\t\t$note_id = $note_id['ID'];\n\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] = '';\n\n\t\tforeach ( [ 'admin', 'teacher', 'parent' ] as $profile_id )\n\t\t{\n\t\t\tif ( ! empty( $_REQUEST['profiles'][$note_id][$profile_id] ) )\n\t\t\t{\n\t\t\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] .= ',' . $profile_id;\n\t\t\t}\n\t\t}\n\n\t\tif ( ! empty( $_REQUEST['profiles'][$note_id] ) )\n\t\t{\n\t\t\tforeach ( (array) $profiles_RET as $profile )\n\t\t\t{\n\t\t\t\t$profile_id = $profile['ID'];\n\n\t\t\t\tif ( ! empty( $_REQUEST['profiles'][$note_id][$profile_id] ) )\n\t\t\t\t{\n\t\t\t\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] .= ',' . $profile_id;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ( ! empty( $_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] ) )\n\t\t{\n\t\t\t$_REQUEST['values'][$note_id]['PUBLISHED_PROFILES'] .= ',';\n\t\t}\n\t}\n}\n\nif ( $_REQUEST['modfunc'] === 'update'\n\t&& $_REQUEST['values']\n\t&& $_POST['values']\n\t&& AllowEdit() )\n{\n\tforeach ( (array) $_REQUEST['values'] as $id => $columns )\n\t{\n\t\t// FJ fix SQL bug invalid sort order.\n\n\t\tif ( empty( $columns['SORT_ORDER'] ) || is_numeric( $columns['SORT_ORDER'] ) )\n\t\t{\n\t\t\t// FJ textarea fields MarkDown sanitize.\n\n\t\t\tif ( isset( $columns['CONTENT'] ) )\n\t\t\t{\n\t\t\t\t$columns['CONTENT'] = DBEscapeString( SanitizeMarkDown( $_POST['values'][$id]['CONTENT'] ) );\n\t\t\t}\n\n\t\t\tif ( $id !== 'new' )\n\t\t\t{\n\t\t\t\t$sql = \"UPDATE portal_notes SET \";\n\n\t\t\t\tforeach ( (array) $columns as $column => $value )\n\t\t\t\t{\n\t\t\t\t\t$sql .= DBEscapeIdentifier( $column ) . \"='\" . $value . \"',\";\n\t\t\t\t}\n\n\t\t\t\t$sql = mb_substr( $sql, 0, -1 ) . \" WHERE ID='\" . (int) $id . \"'\";\n\n\t\t\t\tDBQuery( $sql );\n\n\t\t\t\t//hook\n\t\t\t\tdo_action( 'School_Setup/PortalNotes.php|update_portal_note' );\n\t\t\t}\n\n\t\t\t// New: check for Title.\n\t\t\telseif ( $columns['TITLE'] )\n\t\t\t{\n\t\t\t\t$_REQUEST['values']['new']['PUBLISHED_PROFILES'] = '';\n\n\t\t\t\tforeach ( [ 'admin', 'teacher', 'parent' ] as $profile_id )\n\t\t\t\t{\n\t\t\t\t\tif ( isset( $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t\t&& $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t{\n\t\t\t\t\t\t$_REQUEST['values']['new']['PUBLISHED_PROFILES'] .= $profile_id . ',';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tforeach ( (array) $profiles_RET as $profile )\n\t\t\t\t{\n\t\t\t\t\t$profile_id = $profile['ID'];\n\n\t\t\t\t\tif ( isset( $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t\t&& $_REQUEST['profiles']['new'][$profile_id] )\n\t\t\t\t\t{\n\t\t\t\t\t\t$_REQUEST['values']['new']['PUBLISHED_PROFILES'] .= $profile_id . ',';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$columns['PUBLISHED_PROFILES'] = $_REQUEST['values']['new']['PUBLISHED_PROFILES'] ?\n\t\t\t\t',' . $_REQUEST['values']['new']['PUBLISHED_PROFILES'] :\n\t\t\t\t'';\n\n\t\t\t\t$sql = \"INSERT INTO portal_notes \";\n\n\t\t\t\t//FJ file attached to portal notes\n\t\t\t\t$fields = 'SCHOOL_ID,SYEAR,PUBLISHED_DATE,PUBLISHED_USER,';\n\n\t\t\t\t$values = \"'\" . UserSchool() . \"','\" . UserSyear() . \"',CURRENT_TIMESTAMP,'\" . User( 'STAFF_ID' ) . \"',\";\n\t\t\t\t// @since 10.9 Fix security issue, unset any FILE_ATTACHED column first.\n\t\t\t\t$columns['FILE_ATTACHED'] = '';\n\n\t\t\t\tif ( isset( $_FILES['FILE_ATTACHED_FILE'] ) )\n\t\t\t\t{\n\t\t\t\t\t$file_name_no_ext = no_accents( mb_substr(\n\t\t\t\t\t\t$_FILES['FILE_ATTACHED_FILE']['name'],\n\t\t\t\t\t\t0,\n\t\t\t\t\t\tmb_strrpos( $_FILES['FILE_ATTACHED_FILE']['name'], '.' )\n\t\t\t\t\t) );\n\n\t\t\t\t\t// @since 11.0 Add microseconds to filename format to make it harder to predict.\n\t\t\t\t\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' ) . '.' . substr( (string) microtime(), 2, 6 );\n\n\t\t\t\t\t// File attached to portal notes\n\t\t\t\t\t$columns['FILE_ATTACHED'] = FileUpload(\n\t\t\t\t\t\t'FILE_ATTACHED_FILE',\n\t\t\t\t\t\t$PortalNotesFilesPath,\n\t\t\t\t\t\tFileExtensionWhiteList(),\n\t\t\t\t\t\t0,\n\t\t\t\t\t\t$error,\n\t\t\t\t\t\t'',\n\t\t\t\t\t\t$file_name_no_ext\n\t\t\t\t\t);\n\n\t\t\t\t\t// @since 6.8 Fix SQL error when quote in uploaded file name.\n\t\t\t\t\t$columns['FILE_ATTACHED'] = DBEscapeString( $columns['FILE_ATTACHED'] );\n\t\t\t\t}\n\t\t\t\telseif ( filter_var( $columns['FILE_ATTACHED_EMBED'], FILTER_VALIDATE_URL ) !== false )\n\t\t\t\t{\n\t\t\t\t\t$columns['FILE_ATTACHED'] = $columns['FILE_ATTACHED_EMBED'];\n\t\t\t\t}\n\n\t\t\t\tunset( $columns['FILE_ATTACHED_EMBED'] );\n\n\t\t\t\t$go = 0;\n\n\t\t\t\tforeach ( (array) $columns as $column => $value )\n\t\t\t\t{\n\t\t\t\t\tif ( ! empty( $value ) || $value == '0' )\n\t\t\t\t\t{\n\t\t\t\t\t\t$fields .= DBEscapeIdentifier( $column ) . ',';\n\t\t\t\t\t\t$values .= \"'\" . $value . \"',\";\n\t\t\t\t\t\t$go = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$sql .= '(' . mb_substr( $fields, 0, -1 ) . ') values(' . mb_substr( $values, 0, -1 ) . ')';\n\n\t\t\t\tif ( $go && empty( $error ) )\n\t\t\t\t{\n\t\t\t\t\tDBQuery( $sql );\n\n\t\t\t\t\t// Global var used by Moodle plugin.\n\t\t\t\t\t$portal_note_id = DBLastInsertID();\n\n\t\t\t\t\t//hook\n\t\t\t\t\tdo_action( 'School_Setup/PortalNotes.php|create_portal_note' );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$error[] = _( 'Please enter a valid Sort Order.' );\n\t\t}\n\t}\n\n\t// Unset modfunc & values & profiles & redirect URL.\n\tRedirectURL( [ 'modfunc', 'values', 'profiles' ] );\n}\n\nif ( $_REQUEST['modfunc'] === 'remove'\n\t&& AllowEdit() )\n{\n\tif ( DeletePrompt( _( 'Note' ) ) )\n\t{\n\t\t// FJ file attached to portal notes.\n\t\t$file_to_remove = DBGetOne( \"SELECT FILE_ATTACHED\n\t\t\tFROM portal_notes\n\t\t\tWHERE ID='\" . (int) $_REQUEST['id'] . \"'\" );\n\n\t\tif ( $file_to_remove\n\t\t\t&& file_exists( $file_to_remove ) )\n\t\t{\n\t\t\tunlink( $file_to_remove );\n\t\t}\n\n\t\tDBQuery( \"DELETE FROM portal_notes WHERE ID='\" . (int) $_REQUEST['id'] . \"'\" );\n\n\t\t//hook\n\t\tdo_action( 'School_Setup/PortalNotes.php|delete_portal_note' );\n\n\t\t// Unset modfunc & ID & redirect URL.\n\t\tRedirectURL( [ 'modfunc', 'id' ] );\n\t}\n}\n\necho ErrorMessage( $error );\n\nif ( ! $_REQUEST['modfunc'] )\n{\n\t// File attached to portal notes.\n\t$notes_RET = DBGet( \"SELECT ID,SORT_ORDER,TITLE,CONTENT,START_DATE,END_DATE,PUBLISHED_PROFILES,FILE_ATTACHED,\n\t\tCASE WHEN END_DATE IS NOT NULL AND END_DATE<CURRENT_DATE THEN 'Y' ELSE NULL END AS EXPIRED\n\tFROM portal_notes\n\tWHERE SCHOOL_ID='\" . UserSchool() . \"'\n\tAND SYEAR='\" . UserSyear() . \"'\n\tORDER BY EXPIRED DESC,SORT_ORDER IS NULL,SORT_ORDER,PUBLISHED_DATE DESC\", [\n\t\t'TITLE' => '_makeTextInput',\n\t\t'CONTENT' => '_makeContentInput',\n\t\t'SORT_ORDER' => '_makeTextInput',\n\t\t'FILE_ATTACHED' => 'makeFileAttached',\n\t\t'START_DATE' => 'makePublishing'\n\t] );\n\n\t$columns = [\n\t\t'TITLE' => _( 'Title' ),\n\t\t'CONTENT' => _( 'Note' ),\n\t\t'SORT_ORDER' => _( 'Sort Order' ),\n\t\t'FILE_ATTACHED' => _( 'File Attached' ),\n\t\t'START_DATE' => _( 'Publishing Options' ),\n\t];\n\n\t//,'START_TIME' => 'Start Time','END_TIME' => 'End Time'\n\t$link['add']['html'] = [\n\t\t'TITLE' => _makeTextInput( '', 'TITLE' ),\n\t\t'CONTENT' => _makeContentInput( '', 'CONTENT' ),\n\t\t'SHORT_NAME' => _makeTextInput( '', 'SHORT_NAME' ),\n\t\t'SORT_ORDER' => _makeTextInput( '', 'SORT_ORDER' ),\n\t\t'FILE_ATTACHED' => makeFileAttached( '', 'FILE_ATTACHED' ),\n\t\t'START_DATE' => makePublishing( '', 'START_DATE' ),\n\t];\n\n\t$link['remove']['link'] = 'Modules.php?modname=' . $_REQUEST['modname'] . '&modfunc=remove';\n\t$link['remove']['variables'] = [ 'id' => 'ID' ];\n\n\techo '<form action=\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] . '&modfunc=update' ) . '\" method=\"POST\" enctype=\"multipart/form-data\">';\n\n\tDrawHeader( '', SubmitButton() );\n\n\tListOutput( $notes_RET, $columns, 'Note', 'Notes', $link );\n\n\techo '<br /><div class=\"center\">' . SubmitButton() . '</div>';\n\techo '</form>';\n}\n\n/**\n * @param $value\n * @param $name\n */\nfunction _makeTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$extra = '';\n\n\tif ( $name === 'SORT_ORDER' )\n\t{\n\t\t$extra = ' type=\"number\" min=\"-9999\" max=\"9999\"';\n\t}\n\telseif ( $name !== 'TITLE' )\n\t{\n\t\t$extra = 'size=5 maxlength=10';\n\t}\n\telseif ( $id !== 'new' )\n\t{\n\t\t$extra = 'required';\n\t}\n\n\treturn TextInput(\n\t\t( $name == 'TITLE' && ! empty( $THIS_RET['EXPIRED'] ) ?\n\t\t\t[ $value, '<span style=\"color:red\">' . $value . '</span>' ] :\n\t\t\t$value ),\n\t\t'values[' . $id . '][' . $name . ']',\n\t\t'',\n\t\t$extra\n\t);\n}\n\n/**\n * @param $value\n * @param $name\n * @return mixed\n */\nfunction _makeContentInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$return = '<div id=\"divNoteContent' . $id . '\" class=\"rt2colorBox\">' .\n\t\tTextAreaInput( $value, \"values[\" . $id . \"][\" . $name . \"]\", '', 'rows=5' ) .\n\t\t'</div>';\n\n\treturn $return;\n}\n", "<?php\n\nfunction _makeFeesRemove( $value, $column )\n{\n\tglobal $THIS_RET,\n\t\t$waived_fees_RET;\n\n\tif ( ! $waived_fees_RET )\n\t{\n\t\t$waived_fees_RET = DBGet( \"SELECT f.WAIVED_FEE_ID\n\t\t\tFROM billing_fees f\n\t\t\tWHERE f.STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND f.WAIVED_FEE_ID IS NOT NULL\n\t\t\tAND f.SYEAR='\" . UserSyear() . \"'\n\t\t\tAND f.SCHOOL_ID='\" . UserSchool() . \"'\", [], [ 'WAIVED_FEE_ID' ] );\n\t}\n\n\t$return = '';\n\n\tif ( empty( $THIS_RET['WAIVED_FEE_ID'] )\n\t\t&& empty( $waived_fees_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\t$return = button(\n\t\t\t'remove',\n\t\t\t_( 'Waive' ),\n\t\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t\t'&modfunc=waive&id=' . $THIS_RET['ID'] ) . '\"'\n\t\t) . ' ';\n\t}\n\telseif ( ! empty( $waived_fees_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\t$return = '<span style=\"color:#00A642\">' . _( 'Waived' ) . '</span> ';\n\t}\n\n\treturn $return . button(\n\t\t'remove',\n\t\t_( 'Delete' ),\n\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t'&modfunc=remove&id=' . $THIS_RET['ID'] ) . '\"'\n\t);\n}\n\nfunction _makePaymentsRemove( $value, $column )\n{\n\tglobal $THIS_RET,\n\t\t$refunded_payments_RET;\n\n\tif ( ! $refunded_payments_RET )\n\t{\n\t\t$refunded_payments_RET = DBGet( \"SELECT p.REFUNDED_PAYMENT_ID\n\t\t\tFROM billing_payments p\n\t\t\tWHERE p.STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND (p.REFUNDED_PAYMENT_ID IS NOT NULL)\n\t\t\tAND p.SYEAR='\" . UserSyear() . \"'\n\t\t\tAND p.SCHOOL_ID='\" . UserSchool() . \"'\", [], [ 'REFUNDED_PAYMENT_ID' ] );\n\t}\n\n\t$return = '';\n\n\tif ( empty( $THIS_RET['REFUNDED_PAYMENT_ID'] )\n\t\t&& empty( $refunded_payments_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\tif ( AllowEdit( 'Student_Billing/StudentPayments.php&modfunc=remove' ) )\n\t\t{\n\t\t\t// @since 8.5 Admin Student Payments Delete restriction.\n\t\t\t// @since 8.6 Also exclude Refund.\n\t\t\t$return = button(\n\t\t\t\t'remove',\n\t\t\t\t_( 'Refund' ),\n\t\t\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t\t\t'&modfunc=refund&id=' . $THIS_RET['ID'] ) . '\"'\n\t\t\t) . ' ';\n\t\t}\n\t}\n\telseif ( ! empty( $refunded_payments_RET[ $THIS_RET['ID'] ] ) )\n\t{\n\t\t$return = '<span style=\"color:#00A642\">' . _( 'Refunded' ) . '</span> ';\n\t}\n\n\tif ( AllowEdit( 'Student_Billing/StudentPayments.php&modfunc=remove' ) )\n\t{\n\t\t// @since 8.5 Admin Student Payments Delete restriction.\n\t\t$return .= button(\n\t\t\t'remove',\n\t\t\t_( 'Delete' ),\n\t\t\t'\"' . URLEscape( 'Modules.php?modname=' . $_REQUEST['modname'] .\n\t\t\t\t'&modfunc=remove&id=' . $THIS_RET['ID'] ) . '\"'\n\t\t);\n\t}\n\n\treturn $return;\n}\n\nfunction _makeFeesTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['WAIVED_FEE_ID'] ) )\n\t{\n\t\t$THIS_RET['row_colow'] = 'FFFFFF';\n\t}\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t\t$div = 'force';\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t\t$div = false;\n\t}\n\n\t$extra = 'maxlength=255';\n\n\tif ( $name === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput(\n\t\t$value,\n\t\t'values[' . $id . '][' . $name . ']',\n\t\t'',\n\t\t$extra,\n\t\t$div\n\t);\n}\n\nfunction _makeFeesDateInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\t$name = 'values[' . $id . '][' . $name . ']';\n\n\treturn DateInput( $value, $name );\n}\n\nfunction _makeFeesAmount( $value, $column )\n{\n\tglobal $fees_total;\n\n\t$fees_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _makePaymentsTextInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\t$extra = 'maxlength=255';\n\n\tif ( $name === 'AMOUNT' )\n\t{\n\t\t$extra = ' type=\"number\" step=\"0.01\" max=\"999999999999\" min=\"-999999999999\"';\n\t}\n\telseif ( ! $value )\n\t{\n\t\t$extra .= ' size=15';\n\t}\n\n\treturn TextInput( $value, 'values[' . $id . '][' . $name . ']', '', $extra );\n}\n\n/**\n * Make Payments Comments Input\n * Add Fees dropdown to reconcile Payment:\n * Automatically fills the Comments & Amount inputs.\n *\n * @since 5.1\n * @since 6.2 Remove Fees having a Payment (same Amount & Comments (Title), after or on Assigned Date).\n * @since 8.0 Remove Waived Fees from list.\n *\n * @uses _makePaymentsTextInput()\n *\n * @param  string $value Comments value.\n * @param  string $name  Column name, 'COMMENTS'.\n *\n * @return string Text input if not new or if no Fees found, else Text input & Fees dropdown.\n */\nfunction _makePaymentsCommentsInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\t$text_input = _makePaymentsTextInput( $value, $name );\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t// Add Fees dropdown to reconcile Payment.\n\t// Remove Fees having a Payment (same Amount & Comments (Title), after or on Assigned Date).\n\t// Remove Waived Fees from list.\n\t$fees_RET = DBGet( \"SELECT ID,TITLE,ASSIGNED_DATE,DUE_DATE,AMOUNT\n\t\tFROM billing_fees bf\n\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\tAND WAIVED_FEE_ID IS NULL\n\t\tAND NOT EXISTS(SELECT 1\n\t\t\tFROM billing_payments\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\t\tAND AMOUNT=bf.AMOUNT\n\t\t\tAND (COMMENTS=bf.TITLE OR COMMENTS LIKE CONCAT('%',bf.TITLE) OR COMMENTS LIKE CONCAT(bf.TITLE,'%'))\n\t\t\tAND PAYMENT_DATE>=bf.ASSIGNED_DATE)\n\t\tAND NOT EXISTS(SELECT 1\n\t\t\tFROM billing_fees\n\t\t\tWHERE STUDENT_ID='\" . UserStudentID() . \"'\n\t\t\tAND SYEAR='\" . UserSyear() . \"'\n\t\t\tAND WAIVED_FEE_ID=bf.ID)\n\t\tORDER BY ASSIGNED_DATE DESC\n\t\tLIMIT 20\" );\n\n\tif ( ! $fees_RET )\n\t{\n\t\treturn $text_input;\n\t}\n\n\t$fees_options = [];\n\n\tforeach ( $fees_RET as $fee )\n\t{\n\t\t$fees_options[ $fee['AMOUNT'] . '|' . $fee['TITLE'] . '|' . $fee['ASSIGNED_DATE'] ] = ProperDate( $fee['ASSIGNED_DATE'], 'short' ) .\n\t\t\t' \u2014 ' . Currency( $fee['AMOUNT'] ) .\n\t\t\t' \u2014 ' . $fee['TITLE'];\n\t}\n\n\t// JS automatically fills the Comments & Amount inputs.\n\tob_start();\n\t?>\n\t<script>\n\t\tvar billingPaymentsFeeReconcile = function( amountCommentsDate ) {\n\t\t\tvar amountCommentsDateSplit = amountCommentsDate.split( '|' ),\n\t\t\t\tamount = amountCommentsDateSplit[0],\n\t\t\t\tcomments = amountCommentsDateSplit[1],\n\t\t\t\tdate = amountCommentsDateSplit[2];\n\n\t\t\t$('#valuesnewAMOUNT').val( amount );\n\t\t\t$('#valuesnewCOMMENTS').val( comments );\n\t\t};\n\t</script>\n\t<?php\n\t$js = ob_get_clean();\n\n\t$select_input = SelectInput(\n\t\t'',\n\t\t'billing_fees',\n\t\t'',\n\t\t$fees_options,\n\t\t'N/A',\n\t\t'onchange=\"billingPaymentsFeeReconcile(this.value);\" style=\"width: 158px;\"'\n\t);\n\n\treturn $text_input . ' ' . $js . $select_input;\n}\n\nfunction _makePaymentsDateInput( $value, $name )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t\t$id = 'new';\n\n\treturn DateInput( $value, 'values[' . $id . '][' . $name . ']', '', ( $id !== 'new' ), false );\n}\n\nfunction _makePaymentsAmount( $value, $column )\n{\n\tglobal $payments_total;\n\n\t$payments_total += $value;\n\n\treturn Currency( $value );\n}\n\nfunction _lunchInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( ! empty( $THIS_RET['ID'] ) )\n\t{\n\t\t$id = $THIS_RET['ID'];\n\t}\n\telse\n\t{\n\t\t$id = 'new';\n\t}\n\n\treturn CheckboxInput(\n\t\t$value,\n\t\t'values[' . $id . '][' . $column . ']',\n\t\t'',\n\t\t'',\n\t\t( $id === 'new' )\n\t);\n}\n\n/**\n * Make Fees File Attached Input\n *\n * @since 8.1\n * @since 10.4 Add File Attached Input for existing Fees\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makeFeesFileInput( $value, $column )\n{\n\tglobal $THIS_RET;\n\n\tif ( empty( $THIS_RET['ID'] ) )\n\t{\n\t\treturn FileInput(\n\t\t\t'FILE_ATTACHED'\n\t\t);\n\t}\n\n\tif ( empty( $value )\n\t\t|| ! file_exists( $value ) )\n\t{\n\t\tif ( isset( $_REQUEST['_ROSARIO_PDF'] )\n\t\t\t|| ! AllowEdit() )\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\t// Add hidden FILE_ATTACHED input so it gets saved even if no other columns to save.\n\t\treturn '<input type=\"hidden\" name=\"values[' . $THIS_RET['ID'] . '][FILE_ATTACHED]\" value=\"\" />' .\n\t\tFileInput(\n\t\t\t'FILE_ATTACHED_' . $THIS_RET['ID']\n\t\t);\n\t}\n\n\tif ( ! empty( $_REQUEST['LO_save'] ) )\n\t{\n\t\t// Export list.\n\t\treturn $value;\n\t}\n\n\t$file_path = $value;\n\n\t$file_name = mb_substr( mb_strrchr( $file_path, '/' ), 1 );\n\n\t$file_size = HumanFilesize( filesize( $file_path ) );\n\n\t// Truncate file name if > 36 chars.\n\t$file_name_display = mb_strlen( $file_name ) <= 36 ?\n\t\t$file_name :\n\t\tmb_substr( $file_name, 0, 30 ) . '..' . mb_strrchr( $file_name, '.' );\n\n\t$file = button(\n\t\t'download',\n\t\t$file_name_display,\n\t\t'\"' . URLEscape( $file_path ) . '\" target=\"_blank\" title=\"' . AttrEscape( $file_name . ' (' . $file_size . ')' ) . '\"',\n\t\t'bigger'\n\t);\n\n\treturn $file;\n}\n\n/**\n * Make Payments File Attached Input\n *\n * @since 8.3\n *\n * @param  string $value File path value.\n * @param  string $name  Column name, 'FILE_ATTACHED'.\n *\n * @return string        File Input HTML or link to download File.\n */\nfunction _makePaymentsFileInput( $value, $column )\n{\n\treturn _makeFeesFileInput( $value, $column );\n}\n\n/**\n * Save Fees File\n *\n * @since 10.4\n * @since 10.8.2 Add datetime to filename to make it harder to predict\n *\n * @param  int|string $id Fee ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _saveFeesFile( $id )\n{\n\tglobal $error,\n\t\t$FileUploadsPath;\n\n\t$input = $id === 'new' ? 'FILE_ATTACHED' : 'FILE_ATTACHED_' . $id;\n\n\tif ( ! isset( $_FILES[ $input ] ) )\n\t{\n\t\treturn '';\n\t}\n\n\t$file_name_no_ext = no_accents( mb_substr(\n\t\t$_FILES[ $input ]['name'],\n\t\t0,\n\t\tmb_strrpos( $_FILES[ $input ]['name'], '.' )\n\t) );\n\n\t// @since 11.0 Add microseconds to filename format to make it harder to predict.\n\t$file_name_no_ext .= '_' . date( 'Y-m-d_His' ) . '.' . substr( (string) microtime(), 2, 6 );\n\n\t$file_attached = FileUpload(\n\t\t$input,\n\t\t$FileUploadsPath . UserSyear() . '/student_' . UserStudentID() . '/',\n\t\tFileExtensionWhiteList(),\n\t\t0,\n\t\t$error,\n\t\t'',\n\t\t$file_name_no_ext\n\t);\n\n\t// Fix SQL error when quote in uploaded file name.\n\treturn DBEscapeString( $file_attached );\n}\n\n/**\n * Save Payments File\n *\n * @since 10.4\n *\n * @param  int|string $id Payment ID or 'new'.\n *\n * @return string     File path or empty.\n */\nfunction _savePaymentsFile( $id )\n{\n\treturn _saveFeesFile( $id );\n}\n"], "filenames": ["CHANGES.md", "ProgramFunctions/FileUpload.fnc.php", "modules/Accounting/functions.inc.php", "modules/School_Setup/PortalNotes.php", "modules/Student_Billing/functions.inc.php"], "buggy_code_start_loc": [12, 411, 354, 129, 432], "buggy_code_end_loc": [12, 412, 355, 136, 433], "fixing_code_start_loc": [13, 411, 354, 130, 432], "fixing_code_end_loc": [14, 413, 356, 148, 434], "type": "CWE-922", "message": "Storage of Sensitive Data in a Mechanism without Access Control in GitHub repository francoisjacquet/rosariosis prior to 11.0.", "other": {"cve": {"id": "CVE-2023-2665", "sourceIdentifier": "security@huntr.dev", "published": "2023-05-12T01:15:09.783", "lastModified": "2023-05-19T17:12:43.687", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Storage of Sensitive Data in a Mechanism without Access Control in GitHub repository francoisjacquet/rosariosis prior to 11.0."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 3.6}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 3.6}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-922"}]}, {"source": "security@huntr.dev", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-921"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:rosariosis:rosariosis:*:*:*:*:*:*:*:*", "versionEndExcluding": "11.0", "matchCriteriaId": "31CD218D-312D-41C8-95B7-4DB70C8801FC"}]}]}], "references": [{"url": "https://github.com/francoisjacquet/rosariosis/commit/09d5afaa6be07688ca1a7ac3b755b5438109e986", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/42f38a84-8954-484d-b5ff-706ca0918194", "source": "security@huntr.dev", "tags": ["Permissions Required"]}]}, "github_commit_url": "https://github.com/francoisjacquet/rosariosis/commit/09d5afaa6be07688ca1a7ac3b755b5438109e986"}}