{"buggy_code": ["# Change Log\nAll notable changes to this project will be documented in this file.\n\n## Version 1.0\n\n### Changed\n\n- FIX : Can't create more product prices if multidevise is enable - *01/06/2022* - 1.1.6\n- FIX : UX Changes between DOL 13.0 and 14.0 so we pull the qsp form under addline tpl - *02/05/2022* - 1.1.5\n- FIX : tvatx must not be converted to int, because it can have decimals and specific tva code - *30/03/2022* - 1.1.4\n- FIX : Fill the unit price to be used by the addline action of fourn/commande/card.php which has changed between V12 and V13 - *22/12/2021* - 1.1.3\n- FIX : Compatibility V13 - Add token renewal - *18/05/2021* - 1.1.2\n- FIX [2020-12-10] Fetch and display the OF select value when link an OF on CF (OF select on Dolibarr form AND OF select on Quicksupplier form)\n", "<?php\n/* Copyright (C) 2003      Rodolphe Quiedeville <rodolphe@quiedeville.org>\n * Copyright (C) 2004-2012 Laurent Destailleur  <eldy@users.sourceforge.net>\n * Copyright (C) 2005-2012 Regis Houssin        <regis.houssin@capnetworks.com>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * \t\\defgroup   quicksupplierprice     Module quicksupplierprice\n *  \\brief      Example of a module descriptor.\n *\t\t\t\tSuch a file must be copied into htdocs/quicksupplierprice/core/modules directory.\n *  \\file       htdocs/quicksupplierprice/core/modules/modquicksupplierprice.class.php\n *  \\ingroup    quicksupplierprice\n *  \\brief      Description and activation file for module quicksupplierprice\n */\ninclude_once DOL_DOCUMENT_ROOT .'/core/modules/DolibarrModules.class.php';\n\n\n/**\n *  Description and activation class for module quicksupplierprice\n */\nclass modquicksupplierprice extends DolibarrModules\n{\n\t/**\n\t *   Constructor. Define names, constants, directories, boxes, permissions\n\t *\n\t *   @param      DoliDB\t\t$db      Database handler\n\t */\n\tfunction __construct($db)\n\t{\n        global $langs,$conf;\n\n        $this->db = $db;\n\n\t\t// Id for module (must be unique).\n\t\t// Use here a free id (See in Home -> System information -> Dolibarr for list of used modules id).\n\t\t$this->numero = 104750; // 104000 to 104999 for ATM CONSULTING\n\t\t// Key text used to identify module (for permissions, menus, etc...)\n\t\t$this->rights_class = 'quicksupplierprice';\n\n\t\t// Family can be 'crm','financial','hr','projects','products','ecm','technic','other'\n\t\t// It is used to group modules in module setup page\n\t\t$this->family = \"crm\";\n\t\t// Module label (no space allowed), used if translation string 'ModuleXXXName' not found (where XXX is value of numeric property 'numero' of module)\n\t\t$this->name = preg_replace('/^mod/i','',get_class($this));\n\t\t// Module description, used if translation string 'ModuleXXXDesc' not found (where XXX is value of numeric property 'numero' of module)\n\t\t$this->description = \"Description of module quicksupplierprice\";\n\t\t// Possible values for version are: 'development', 'experimental', 'dolibarr' or version\n\t\t$this->version = '1.1.6';\n\t\t// Key used in llx_const table to save module status enabled/disabled (where MYMODULE is value of property name of module in uppercase)\n\t\t$this->const_name = 'MAIN_MODULE_'.strtoupper($this->name);\n\t\t// Where to store the module in setup page (0=common,1=interface,2=others,3=very specific)\n\t\t$this->special = 0;\n\t\t// Name of image file used for this module.\n\t\t// If file is in theme/yourtheme/img directory under name object_pictovalue.png, use this->picto='pictovalue'\n\t\t// If file is in module/img directory under name object_pictovalue.png, use this->picto='pictovalue@module'\n\t\t$this->picto='quicksupplierprice@quicksupplierprice';\n\n\t\t// Defined all module parts (triggers, login, substitutions, menus, css, etc...)\n\t\t// for default path (eg: /quicksupplierprice/core/xxxxx) (0=disable, 1=enable)\n\t\t// for specific path of parts (eg: /quicksupplierprice/core/modules/barcode)\n\t\t// for specific css file (eg: /quicksupplierprice/css/quicksupplierprice.css.php)\n\t\t//$this->module_parts = array(\n\t\t//                        \t'triggers' => 0,                                 \t// Set this to 1 if module has its own trigger directory (core/triggers)\n\t\t//\t\t\t\t\t\t\t'login' => 0,                                    \t// Set this to 1 if module has its own login method directory (core/login)\n\t\t//\t\t\t\t\t\t\t'substitutions' => 0,                            \t// Set this to 1 if module has its own substitution function file (core/substitutions)\n\t\t//\t\t\t\t\t\t\t'menus' => 0,                                    \t// Set this to 1 if module has its own menus handler directory (core/menus)\n\t\t//\t\t\t\t\t\t\t'theme' => 0,                                    \t// Set this to 1 if module has its own theme directory (theme)\n\t\t//                        \t'tpl' => 0,                                      \t// Set this to 1 if module overwrite template dir (core/tpl)\n\t\t//\t\t\t\t\t\t\t'barcode' => 0,                                  \t// Set this to 1 if module has its own barcode directory (core/modules/barcode)\n\t\t//\t\t\t\t\t\t\t'models' => 0,                                   \t// Set this to 1 if module has its own models directory (core/modules/xxx)\n\t\t//\t\t\t\t\t\t\t'css' => array('/quicksupplierprice/css/quicksupplierprice.css.php'),\t// Set this to relative path of css file if module has its own css file\n\t \t//\t\t\t\t\t\t\t'js' => array('/quicksupplierprice/js/quicksupplierprice.js'),          // Set this to relative path of js file if module must load a js on all pages\n\t\t//\t\t\t\t\t\t\t'hooks' => array('hookcontext1','hookcontext2')  \t// Set here all hooks context managed by module\n\t\t//\t\t\t\t\t\t\t'dir' => array('output' => 'othermodulename'),      // To force the default directories names\n\t\t//\t\t\t\t\t\t\t'workflow' => array('WORKFLOW_MODULE1_YOURACTIONTYPE_MODULE2'=>array('enabled'=>'! empty($conf->module1->enabled) && ! empty($conf->module2->enabled)', 'picto'=>'yourpicto@quicksupplierprice')) // Set here all workflow context managed by module\n\t\t//                        );\n\t\t$this->module_parts = array(\n            'hooks'=>array('ordersuppliercard','invoicesuppliercard')\n        );\n\n\t\t// Data directories to create when module is enabled.\n\t\t// Example: this->dirs = array(\"/quicksupplierprice/temp\");\n\t\t$this->dirs = array();\n\n\t\t// Config pages. Put here list of php page, stored into quicksupplierprice/admin directory, to use to setup module.\n\t\t$this->config_page_url = array(\"quicksupplierprice_setup.php@quicksupplierprice\");\n\n\t\t// Dependencies\n\t\t$this->hidden = false;\t\t\t// A condition to hide module\n\t\t$this->depends = array();\t\t// List of modules id that must be enabled if this module is enabled\n\t\t$this->requiredby = array();\t// List of modules id to disable if this one is disabled\n\t\t$this->conflictwith = array();\t// List of modules id this module is in conflict with\n\t\t$this->phpmin = array(5,0);\t\t\t\t\t// Minimum version of PHP required by module\n\t\t$this->need_dolibarr_version = array(3,0);\t// Minimum version of Dolibarr required by module\n\t\t$this->langfiles = array(\"quicksupplierprice@quicksupplierprice\");\n\n\t\t// Constants\n\t\t// List of particular constants to add when module is enabled (key, 'chaine', value, desc, visible, 'current' or 'allentities', deleteonunactive)\n\t\t// Example: $this->const=array(0=>array('MYMODULE_MYNEWCONST1','chaine','myvalue','This is a constant to add',1),\n\t\t//                             1=>array('MYMODULE_MYNEWCONST2','chaine','myvalue','This is another constant to add',0, 'current', 1)\n\t\t// );\n\t\t$this->const = array(\n\t\t    0=>array('QSPBESTPRICE','chaine',1,'search for lower price',1, 'current', 1)\n\t\t);\n\n\t\t// Array to add new pages in new tabs\n\t\t// Example: $this->tabs = array('objecttype:+tabname1:Title1:mylangfile@quicksupplierprice:$user->rights->quicksupplierprice->read:/quicksupplierprice/mynewtab1.php?id=__ID__',  \t// To add a new tab identified by code tabname1\n        //                              'objecttype:+tabname2:Title2:mylangfile@quicksupplierprice:$user->rights->othermodule->read:/quicksupplierprice/mynewtab2.php?id=__ID__',  \t// To add another new tab identified by code tabname2\n        //                              'objecttype:-tabname:NU:conditiontoremove');                                                     \t\t\t\t\t\t// To remove an existing tab identified by code tabname\n\t\t// where objecttype can be\n\t\t// 'categories_x'\t  to add a tab in category view (replace 'x' by type of category (0=product, 1=supplier, 2=customer, 3=member)\n\t\t// 'contact'          to add a tab in contact view\n\t\t// 'contract'         to add a tab in contract view\n\t\t// 'group'            to add a tab in group view\n\t\t// 'intervention'     to add a tab in intervention view\n\t\t// 'invoice'          to add a tab in customer invoice view\n\t\t// 'invoice_supplier' to add a tab in supplier invoice view\n\t\t// 'member'           to add a tab in fundation member view\n\t\t// 'opensurveypoll'\t  to add a tab in opensurvey poll view\n\t\t// 'order'            to add a tab in customer order view\n\t\t// 'order_supplier'   to add a tab in supplier order view\n\t\t// 'payment'\t\t  to add a tab in payment view\n\t\t// 'payment_supplier' to add a tab in supplier payment view\n\t\t// 'product'          to add a tab in product view\n\t\t// 'propal'           to add a tab in propal view\n\t\t// 'project'          to add a tab in project view\n\t\t// 'stock'            to add a tab in stock view\n\t\t// 'thirdparty'       to add a tab in third party view\n\t\t// 'user'             to add a tab in user view\n        $this->tabs = array();\n\n        // Dictionaries\n\t    if (! isset($conf->quicksupplierprice->enabled))\n        {\n        \t$conf->quicksupplierprice=new stdClass();\n        \t$conf->quicksupplierprice->enabled=0;\n        }\n\t\t$this->dictionaries=array();\n        /* Example:\n        if (! isset($conf->quicksupplierprice->enabled)) $conf->quicksupplierprice->enabled=0;\t// This is to avoid warnings\n        $this->dictionaries=array(\n            'langs'=>'mylangfile@quicksupplierprice',\n            'tabname'=>array(MAIN_DB_PREFIX.\"table1\",MAIN_DB_PREFIX.\"table2\",MAIN_DB_PREFIX.\"table3\"),\t\t// List of tables we want to see into dictonnary editor\n            'tablib'=>array(\"Table1\",\"Table2\",\"Table3\"),\t\t\t\t\t\t\t\t\t\t\t\t\t// Label of tables\n            'tabsql'=>array('SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table1 as f','SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table2 as f','SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table3 as f'),\t// Request to select fields\n            'tabsqlsort'=>array(\"label ASC\",\"label ASC\",\"label ASC\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Sort order\n            'tabfield'=>array(\"code,label\",\"code,label\",\"code,label\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// List of fields (result of select to show dictionary)\n            'tabfieldvalue'=>array(\"code,label\",\"code,label\",\"code,label\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// List of fields (list of fields to edit a record)\n            'tabfieldinsert'=>array(\"code,label\",\"code,label\",\"code,label\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// List of fields (list of fields for insert)\n            'tabrowid'=>array(\"rowid\",\"rowid\",\"rowid\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Name of columns with primary key (try to always name it 'rowid')\n            'tabcond'=>array($conf->quicksupplierprice->enabled,$conf->quicksupplierprice->enabled,$conf->quicksupplierprice->enabled)\t\t\t\t\t\t\t\t\t\t\t\t// Condition to show each dictionary\n        );\n        */\n\n        // Boxes\n\t\t// Add here list of php file(s) stored in core/boxes that contains class to show a box.\n        $this->boxes = array();\t\t\t// List of boxes\n\t\t// Example:\n\t\t//$this->boxes=array(array(0=>array('file'=>'myboxa.php','note'=>'','enabledbydefaulton'=>'Home'),1=>array('file'=>'myboxb.php','note'=>''),2=>array('file'=>'myboxc.php','note'=>'')););\n\n\t\t// Permissions\n\t\t$this->rights = array();\t\t// Permission array used by this module\n\t\t$r=0;\n\n\t\t// Add here list of permission defined by an id, a label, a boolean and two constant strings.\n\t\t// Example:\n\t\t// $this->rights[$r][0] = $this->numero + $r;\t// Permission id (must not be already used)\n\t\t// $this->rights[$r][1] = 'Permision label';\t// Permission label\n\t\t// $this->rights[$r][3] = 1; \t\t\t\t\t// Permission by default for new user (0/1)\n\t\t// $this->rights[$r][4] = 'level1';\t\t\t\t// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)\n\t\t// $this->rights[$r][5] = 'level2';\t\t\t\t// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)\n\t\t// $r++;\n\n\n\t\t// Main menu entries\n\t\t$this->menu = array();\t\t\t// List of menus to add\n\t\t$r=0;\n\n\t\t// Add here entries to declare new menus\n\t\t//\n\t\t// Example to declare a new Top Menu entry and its Left menu entry:\n\t\t// $this->menu[$r]=array(\t'fk_menu'=>0,\t\t\t                // Put 0 if this is a top menu\n\t\t//\t\t\t\t\t\t\t'type'=>'top',\t\t\t                // This is a Top menu entry\n\t\t//\t\t\t\t\t\t\t'titre'=>'quicksupplierprice top menu',\n\t\t//\t\t\t\t\t\t\t'mainmenu'=>'quicksupplierprice',\n\t\t//\t\t\t\t\t\t\t'leftmenu'=>'quicksupplierprice',\n\t\t//\t\t\t\t\t\t\t'url'=>'/quicksupplierprice/pagetop.php',\n\t\t//\t\t\t\t\t\t\t'langs'=>'mylangfile@quicksupplierprice',\t        // Lang file to use (without .lang) by module. File must be in langs/code_CODE/ directory.\n\t\t//\t\t\t\t\t\t\t'position'=>100,\n\t\t//\t\t\t\t\t\t\t'enabled'=>'$conf->quicksupplierprice->enabled',\t// Define condition to show or hide menu entry. Use '$conf->quicksupplierprice->enabled' if entry must be visible if module is enabled.\n\t\t//\t\t\t\t\t\t\t'perms'=>'1',\t\t\t                // Use 'perms'=>'$user->rights->quicksupplierprice->level1->level2' if you want your menu with a permission rules\n\t\t//\t\t\t\t\t\t\t'target'=>'',\n\t\t//\t\t\t\t\t\t\t'user'=>2);\t\t\t\t                // 0=Menu for internal users, 1=external users, 2=both\n\t\t// $r++;\n\t\t//\n\t\t// Example to declare a Left Menu entry into an existing Top menu entry:\n\t\t// $this->menu[$r]=array(\t'fk_menu'=>'fk_mainmenu=xxx',\t\t    // Use 'fk_mainmenu=xxx' or 'fk_mainmenu=xxx,fk_leftmenu=yyy' where xxx is mainmenucode and yyy is a leftmenucode\n\t\t//\t\t\t\t\t\t\t'type'=>'left',\t\t\t                // This is a Left menu entry\n\t\t//\t\t\t\t\t\t\t'titre'=>'quicksupplierprice left menu',\n\t\t//\t\t\t\t\t\t\t'mainmenu'=>'xxx',\n\t\t//\t\t\t\t\t\t\t'leftmenu'=>'quicksupplierprice',\n\t\t//\t\t\t\t\t\t\t'url'=>'/quicksupplierprice/pagelevel2.php',\n\t\t//\t\t\t\t\t\t\t'langs'=>'mylangfile@quicksupplierprice',\t        // Lang file to use (without .lang) by module. File must be in langs/code_CODE/ directory.\n\t\t//\t\t\t\t\t\t\t'position'=>100,\n\t\t//\t\t\t\t\t\t\t'enabled'=>'$conf->quicksupplierprice->enabled',  // Define condition to show or hide menu entry. Use '$conf->quicksupplierprice->enabled' if entry must be visible if module is enabled. Use '$leftmenu==\\'system\\'' to show if leftmenu system is selected.\n\t\t//\t\t\t\t\t\t\t'perms'=>'1',\t\t\t                // Use 'perms'=>'$user->rights->quicksupplierprice->level1->level2' if you want your menu with a permission rules\n\t\t//\t\t\t\t\t\t\t'target'=>'',\n\t\t//\t\t\t\t\t\t\t'user'=>2);\t\t\t\t                // 0=Menu for internal users, 1=external users, 2=both\n\t\t// $r++;\n\n\n\t\t// Exports\n\t\t$r=1;\n\n\t\t// Example:\n\t\t// $this->export_code[$r]=$this->rights_class.'_'.$r;\n\t\t// $this->export_label[$r]='CustomersInvoicesAndInvoiceLines';\t// Translation key (used only if key ExportDataset_xxx_z not found)\n        // $this->export_enabled[$r]='1';                               // Condition to show export in list (ie: '$user->id==3'). Set to 1 to always show when module is enabled.\n\t\t// $this->export_permission[$r]=array(array(\"facture\",\"facture\",\"export\"));\n\t\t// $this->export_fields_array[$r]=array('s.rowid'=>\"IdCompany\",'s.nom'=>'CompanyName','s.address'=>'Address','s.zip'=>'Zip','s.town'=>'Town','s.fk_pays'=>'Country','s.phone'=>'Phone','s.siren'=>'ProfId1','s.siret'=>'ProfId2','s.ape'=>'ProfId3','s.idprof4'=>'ProfId4','s.code_compta'=>'CustomerAccountancyCode','s.code_compta_fournisseur'=>'SupplierAccountancyCode','f.rowid'=>\"InvoiceId\",'f.facnumber'=>\"InvoiceRef\",'f.datec'=>\"InvoiceDateCreation\",'f.datef'=>\"DateInvoice\",'f.total'=>\"TotalHT\",'f.total_ttc'=>\"TotalTTC\",'f.tva'=>\"TotalVAT\",'f.paye'=>\"InvoicePaid\",'f.fk_statut'=>'InvoiceStatus','f.note'=>\"InvoiceNote\",'fd.rowid'=>'LineId','fd.description'=>\"LineDescription\",'fd.price'=>\"LineUnitPrice\",'fd.tva_tx'=>\"LineVATRate\",'fd.qty'=>\"LineQty\",'fd.total_ht'=>\"LineTotalHT\",'fd.total_tva'=>\"LineTotalTVA\",'fd.total_ttc'=>\"LineTotalTTC\",'fd.date_start'=>\"DateStart\",'fd.date_end'=>\"DateEnd\",'fd.fk_product'=>'ProductId','p.ref'=>'ProductRef');\n\t\t// $this->export_entities_array[$r]=array('s.rowid'=>\"company\",'s.nom'=>'company','s.address'=>'company','s.zip'=>'company','s.town'=>'company','s.fk_pays'=>'company','s.phone'=>'company','s.siren'=>'company','s.siret'=>'company','s.ape'=>'company','s.idprof4'=>'company','s.code_compta'=>'company','s.code_compta_fournisseur'=>'company','f.rowid'=>\"invoice\",'f.facnumber'=>\"invoice\",'f.datec'=>\"invoice\",'f.datef'=>\"invoice\",'f.total'=>\"invoice\",'f.total_ttc'=>\"invoice\",'f.tva'=>\"invoice\",'f.paye'=>\"invoice\",'f.fk_statut'=>'invoice','f.note'=>\"invoice\",'fd.rowid'=>'invoice_line','fd.description'=>\"invoice_line\",'fd.price'=>\"invoice_line\",'fd.total_ht'=>\"invoice_line\",'fd.total_tva'=>\"invoice_line\",'fd.total_ttc'=>\"invoice_line\",'fd.tva_tx'=>\"invoice_line\",'fd.qty'=>\"invoice_line\",'fd.date_start'=>\"invoice_line\",'fd.date_end'=>\"invoice_line\",'fd.fk_product'=>'product','p.ref'=>'product');\n\t\t// $this->export_sql_start[$r]='SELECT DISTINCT ';\n\t\t// $this->export_sql_end[$r]  =' FROM ('.MAIN_DB_PREFIX.'facture as f, '.MAIN_DB_PREFIX.'facturedet as fd, '.MAIN_DB_PREFIX.'societe as s)';\n\t\t// $this->export_sql_end[$r] .=' LEFT JOIN '.MAIN_DB_PREFIX.'product as p on (fd.fk_product = p.rowid)';\n\t\t// $this->export_sql_end[$r] .=' WHERE f.fk_soc = s.rowid AND f.rowid = fd.fk_facture';\n\t\t// $this->export_sql_order[$r] .=' ORDER BY s.nom';\n\t\t// $r++;\n\t}\n\n\t/**\n\t *\t\tFunction called when module is enabled.\n\t *\t\tThe init function add constants, boxes, permissions and menus (defined in constructor) into Dolibarr database.\n\t *\t\tIt also creates data directories\n\t *\n     *      @param      string\t$options    Options when enabling module ('', 'noboxes')\n\t *      @return     int             \t1 if OK, 0 if KO\n\t */\n\tfunction init($options='')\n\t{\n\t\t$sql = array();\n\n\t\tdefine('INC_FROM_DOLIBARR',true);\n\n\t\tdol_include_once('/quicksupplierprice/config.php');\n\t\tdol_include_once('/quicksupplierprice/script/create-maj-base.php');\n\n\t\t$result=$this->_load_tables('/quicksupplierprice/sql/');\n\n\t\treturn $this->_init($sql, $options);\n\t}\n\n\t/**\n\t *\t\tFunction called when module is disabled.\n\t *      Remove from database constants, boxes and permissions from Dolibarr database.\n\t *\t\tData directories are not deleted\n\t *\n     *      @param      string\t$options    Options when enabling module ('', 'noboxes')\n\t *      @return     int             \t1 if OK, 0 if KO\n\t */\n\tfunction remove($options='')\n\t{\n\t\t$sql = array();\n\n\t\treturn $this->_remove($sql, $options);\n\t}\n\n}\n", "<?php\n\n\tif (! defined('NOTOKENRENEWAL')) define('NOTOKENRENEWAL','1'); // Disables token renewal\n\n    require(\"../config.php\");\n    dol_include_once('/product/class/product.class.php');\n    dol_include_once('/fourn/class/fournisseur.product.class.php');\n\n    $get = GETPOST('get');\n    $put = GETPOST('put');\n\n    $id_prod = (int)GETPOST('idprod','int');                  // id du produit demand\u00e9\n    $ref_search= GETPOST('ref_search', 'alpha');        // ref du produit demand\u00e9\n    $ref = GETPOST('ref', 'alpha');                     // ref entr\u00e9e par l'utilisateur\n    $fk_soc = GETPOST('fk_supplier', 'int');            // id du fournisseur\n    $price = price2num(GETPOST('price','int') );                   // prix entr\u00e9 par l'utilisateur\n    $qte = (int)GETPOST('qty','int');                         // quantit\u00e9 demand\u00e9e\n    $unitprice = ($qte > 1) ? $price/$qte : $price;     // prix unitaire\n    $tvatx = GETPOST('tvatx', 'alpha');                     \t\t// taux de tva saisi\n    $fk_order = (int)GETPOST('fk_order','int');               // id de la commande en cours de modification\n\n    // si la ref est laiss\u00e9e vide je rempli la ref (ne pas utiliser pour l'instant)\n    // if($ref == '') $ref = 'FP-'.$fk_soc.'-'.$id_prod.'-'.$price;\n\n    switch($put){\n        case 'updateprice': // renvoie l'id d'une ligne produit\n        \tupatePrice($id_prod, $fk_soc, $unitprice, $qte, $ref_search, $price, $ref, $tvatx);\n            break;\n\n        case 'checkprice': // v\u00e9rifie s'il y a des prix unitaire strictement inf\u00e9rieurs et on en renvoie le nombre\n        \tcheckprice($id_prod, $unitprice, $fk_order, $qte, $price, $fk_soc, $tvatx);\n            break;\n\n        Default:\n            break;\n\n    }\n\n    /**\n     * V\u00e9rifie s'il existe des prix plus bas que celui saisi et en renvoie le nombre et la liste\n     *\n     * @param $id_prod        id du produit\n     * @param $unitprice      prix unitaire\n     * @param $fk_order       id de la commande en cours\n     * @param $qte            quantit\u00e9 command\u00e9e\n     * @param $price          total HT\n     * @param $fk_soc         id du fournisseur courant\n     * @param $tvatx          tva tx supplier\n     *\n     */\n    function checkprice($id_prod, $unitprice, $fk_order, $qte, $price, $fk_soc, $tvatx){\n        global $db, $langs;\n        $langs->load('quicksupplierprice@quicksupplierprice');\n\n        ob_start();\n        $sql = 'SELECT pfp.rowid as product_fourn_price_id, pfp.unitprice as fourn_unitprice, pfp.quantity as fourn_qty, pfp.price as fourn_price, s.nom as fourn_name, s.rowid as fourn_id';\n        $sql .= ' FROM ' . MAIN_DB_PREFIX .'product_fournisseur_price as pfp , ' . MAIN_DB_PREFIX .'societe as s';\n        $sql .= ' WHERE pfp.entity = 1';\n        $sql .= ' AND pfp.fk_soc = s.rowid';\n        $sql .= ' AND s.status=1';\n        $sql .= ' AND pfp.fk_product = '.$id_prod.' AND pfp.unitprice < '.$unitprice;\n\n        $res = $db->query($sql);\n        $nb = $db->num_rows($res);\n\n        $liste = '';\n        if($nb > 0){ // s'il existe des prix plus bas\n            // on g\u00e9n\u00e8re la liste des prix inf\u00e9rieurs au prix demand\u00e9\n            $liste = '<form action=\"'.dol_buildpath('/fourn/commande/card.php', 1).'?id='. $fk_order .'\" method=\"POST\">'.\"\\n\";\n            $liste .= '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n            $liste .= '<input type=\"hidden\" name=\"action\" value=\"selectpriceQSP\">';\n            $liste .= '<input type=\"hidden\" name=\"qty\" value=\"'.$qte.'\">';\n            $liste .= '<input type=\"hidden\" name=\"tvatx\" value=\"'.$tvatx.'\">';\n            $liste .= '<div><p>Plusieurs prix sont disponibles pour ce produit veuillez valider le prix saisie ou choisir le produit dans la liste</p></div>';\n            $liste .= '<div class=\"div-table-responsive\"><table class=\"noborder noshadow\" width=\"100%\"><thead>';\n            $liste .= '<tr class=\"liste_titre\"><td>Fournisseur</td><td align=\"right\">P.U. HT</td><td align=\"right\">Quantit\u00e9 minimum</td><td align=\"right\">Total HT</td><td width=\"20%\" align=\"right\" style=\"padding-right: 20px;\">Choix</td></tr>';\n            $liste .= '</thead><tbody>';\n\n            $liste .= '<tr><td><label for=\"saisie\">'.$langs->trans('validPrice').' '.$langs->trans('AddedToThis').'</label></td>';\n            $liste .= '<td align=\"right\"><label for=\"saisie\">' . number_format($unitprice, 2) . '</label></td>';\n            $liste .= '<td align=\"right\"><label for=\"saisie\">' . $qte . '</label></td>';\n            $liste .= '<td align=\"right\"><label for=\"saisie\">' . number_format($price, 2) . '</label></td>';\n            $liste .= '<td align=\"right\" style=\"padding-right: 20px;\"><input id=\"saisie\" type=\"radio\" name=\"prix\" value=\"saisie\" checked></td></tr>';\n\n            while($obj = $db->fetch_object($res)){\n                $tooltip = ($fk_soc == $obj->fourn_id) ? $langs->trans('AddedToThis') : $langs->trans('NewCommand');\n                $liste .= '<tr><td><label for=\"sel_'.$obj->product_fourn_price_id.'\">'. $obj->fourn_name .' '.$tooltip.'</label></td>';\n                $liste .= '<td align=\"right\"><label for=\"sel_'.$obj->product_fourn_price_id.'\">' . number_format($obj->fourn_unitprice, 2) . '</label></td>';\n                $liste .= '<td align=\"right\"><label for=\"sel_'.$obj->product_fourn_price_id.'\">' . $obj->fourn_qty . '</label></td>';\n                $liste .= '<td align=\"right\"><label for=\"sel_'.$obj->product_fourn_price_id.'\">' . number_format($obj->fourn_price, 2) . '</label></td>';\n                $liste .= '<td align=\"right\" style=\"padding-right: 20px;\"><input id=\"sel_'.$obj->product_fourn_price_id.'\" type=\"radio\" name=\"prix\" value=\"'.$obj->product_fourn_price_id.'\"></td></tr>';\n            }\n\n            $liste .= '</tbody></table></div>';\n\n            $liste .= '<div class=\"center\">';\n            $liste .= '<input type=\"submit\" class=\"button\" value=\"'.$langs->trans(\"Validate\").'\">';\n            $liste .= '</div>';\n            $liste .= '</form>';\n        }\n\n        ob_clean();\n        print json_encode( array('nb' => $nb, 'liste' => $liste));\n\n    }\n\n    /**\n     *\n     * @param unknown $id_prod\n     * @param unknown $fk_soc\n     * @param unknown $unitprice\n     * @param unknown $qte\n     * @param unknown $ref_search\n     * @param unknown $price\n     * @param unknown $ref\n     * @param unknown $tvatx\n     */\n    function upatePrice($id_prod, $fk_soc, $unitprice, $qte, $ref_search, $price, $ref, $tvatx){\n        global $db, $user;\n\n        ob_start();\n\n        // Clean vat code\n        $vat_src_code = '';\n        if (preg_match('/\\((.*)\\)/', $tvatx, $reg)) {\n        \t$vat_src_code = $reg[1];\n        \t$tvatx = preg_replace('/\\s*\\(.*\\)/', '', $tvatx); // Remove code into vatrate.\n        }\n\n        // On v\u00e9rifie si la ligne de tarif n'existe pas d\u00e9j\u00e0 pour ce fournisseur\n        $sql = \"SELECT rowid FROM \".MAIN_DB_PREFIX.\"product_fournisseur_price WHERE fk_product=\" . $id_prod;\n        $sql .= \" AND fk_soc=\" . $fk_soc;\n        $sql .= \" AND unitprice=\" . $unitprice;\n        $sql .= \" AND quantity=\" . $qte;\n        if (!empty($vat_src_code)) {\n        \t$sql .= \" AND default_vat_code='\" . $vat_src_code.\"'\";\n        }\n\n\n        $resq = $db->query($sql);\n\n        if($resq->num_rows !== 0){ // s'il existe, on renvoie l'id de cet ligne prix\n            $obj = $db->fetch_object($resq);\n            $ret = $obj->rowid;\n        } else { // si on ne trouve rien, cr\u00e9ation du prix fournisseur\n            $product = new ProductFournisseur($db);\n            $product->fetch($id_prod, $ref_search);\n\n            $fourn = new Fournisseur($db);\n            $fourn->fetch($fk_soc);\n\n             $product->product_fourn_id = $fourn->id;\n\n            // La methode update_buyprice() renvoie -1 ou -2 en cas d'erreur ou l'id de l'objet modifi\u00e9 ou cr\u00e9\u00e9 en cas de r\u00e9ussite\n             $ret=$product->update_buyprice($qte , $price, $user, 'HT', $fourn, 1, $ref, $tvatx, 0, 0, 0, 0, 0, '', array(), $vat_src_code, $price);\n        }\n\n        ob_clean();\n\n        if($ret<0) print json_encode( array('retour'=>$ret,'error'=> $product->error) );\n        else {\n            print json_encode(  array('retour'=> $ret, 'error'=>'', 'dp_desc'=>$product->description ) );\n        }\n    }\n\n"], "fixing_code": ["# Change Log\nAll notable changes to this project will be documented in this file.\n\n## Version 1.0\n\n### Changed\n\n- FIX : `Interface.php` has fatal errors (invisible to user) due to SQL\n  injection of empty input values - *29/06/2022* - 1.1.7\n- FIX : Can't create more product prices if multidevise is enable - *01/06/2022* - 1.1.6\n- FIX : UX Changes between DOL 13.0 and 14.0 so we pull the qsp form under addline tpl - *02/05/2022* - 1.1.5\n- FIX : tvatx must not be converted to int, because it can have decimals and specific tva code - *30/03/2022* - 1.1.4\n- FIX : Fill the unit price to be used by the addline action of fourn/commande/card.php which has changed between V12 and V13 - *22/12/2021* - 1.1.3\n- FIX : Compatibility V13 - Add token renewal - *18/05/2021* - 1.1.2\n- FIX [2020-12-10] Fetch and display the OF select value when link an OF on CF (OF select on Dolibarr form AND OF select on Quicksupplier form)\n", "<?php\n/* Copyright (C) 2003      Rodolphe Quiedeville <rodolphe@quiedeville.org>\n * Copyright (C) 2004-2012 Laurent Destailleur  <eldy@users.sourceforge.net>\n * Copyright (C) 2005-2012 Regis Houssin        <regis.houssin@capnetworks.com>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * \t\\defgroup   quicksupplierprice     Module quicksupplierprice\n *  \\brief      Example of a module descriptor.\n *\t\t\t\tSuch a file must be copied into htdocs/quicksupplierprice/core/modules directory.\n *  \\file       htdocs/quicksupplierprice/core/modules/modquicksupplierprice.class.php\n *  \\ingroup    quicksupplierprice\n *  \\brief      Description and activation file for module quicksupplierprice\n */\ninclude_once DOL_DOCUMENT_ROOT .'/core/modules/DolibarrModules.class.php';\n\n\n/**\n *  Description and activation class for module quicksupplierprice\n */\nclass modquicksupplierprice extends DolibarrModules\n{\n\t/**\n\t *   Constructor. Define names, constants, directories, boxes, permissions\n\t *\n\t *   @param      DoliDB\t\t$db      Database handler\n\t */\n\tfunction __construct($db)\n\t{\n        global $langs,$conf;\n\n        $this->db = $db;\n\n\t\t// Id for module (must be unique).\n\t\t// Use here a free id (See in Home -> System information -> Dolibarr for list of used modules id).\n\t\t$this->numero = 104750; // 104000 to 104999 for ATM CONSULTING\n\t\t// Key text used to identify module (for permissions, menus, etc...)\n\t\t$this->rights_class = 'quicksupplierprice';\n\n\t\t// Family can be 'crm','financial','hr','projects','products','ecm','technic','other'\n\t\t// It is used to group modules in module setup page\n\t\t$this->family = \"crm\";\n\t\t// Module label (no space allowed), used if translation string 'ModuleXXXName' not found (where XXX is value of numeric property 'numero' of module)\n\t\t$this->name = preg_replace('/^mod/i','',get_class($this));\n\t\t// Module description, used if translation string 'ModuleXXXDesc' not found (where XXX is value of numeric property 'numero' of module)\n\t\t$this->description = \"Description of module quicksupplierprice\";\n\t\t// Possible values for version are: 'development', 'experimental', 'dolibarr' or version\n\t\t$this->version = '1.1.7';\n\t\t// Key used in llx_const table to save module status enabled/disabled (where MYMODULE is value of property name of module in uppercase)\n\t\t$this->const_name = 'MAIN_MODULE_'.strtoupper($this->name);\n\t\t// Where to store the module in setup page (0=common,1=interface,2=others,3=very specific)\n\t\t$this->special = 0;\n\t\t// Name of image file used for this module.\n\t\t// If file is in theme/yourtheme/img directory under name object_pictovalue.png, use this->picto='pictovalue'\n\t\t// If file is in module/img directory under name object_pictovalue.png, use this->picto='pictovalue@module'\n\t\t$this->picto='quicksupplierprice@quicksupplierprice';\n\n\t\t// Defined all module parts (triggers, login, substitutions, menus, css, etc...)\n\t\t// for default path (eg: /quicksupplierprice/core/xxxxx) (0=disable, 1=enable)\n\t\t// for specific path of parts (eg: /quicksupplierprice/core/modules/barcode)\n\t\t// for specific css file (eg: /quicksupplierprice/css/quicksupplierprice.css.php)\n\t\t//$this->module_parts = array(\n\t\t//                        \t'triggers' => 0,                                 \t// Set this to 1 if module has its own trigger directory (core/triggers)\n\t\t//\t\t\t\t\t\t\t'login' => 0,                                    \t// Set this to 1 if module has its own login method directory (core/login)\n\t\t//\t\t\t\t\t\t\t'substitutions' => 0,                            \t// Set this to 1 if module has its own substitution function file (core/substitutions)\n\t\t//\t\t\t\t\t\t\t'menus' => 0,                                    \t// Set this to 1 if module has its own menus handler directory (core/menus)\n\t\t//\t\t\t\t\t\t\t'theme' => 0,                                    \t// Set this to 1 if module has its own theme directory (theme)\n\t\t//                        \t'tpl' => 0,                                      \t// Set this to 1 if module overwrite template dir (core/tpl)\n\t\t//\t\t\t\t\t\t\t'barcode' => 0,                                  \t// Set this to 1 if module has its own barcode directory (core/modules/barcode)\n\t\t//\t\t\t\t\t\t\t'models' => 0,                                   \t// Set this to 1 if module has its own models directory (core/modules/xxx)\n\t\t//\t\t\t\t\t\t\t'css' => array('/quicksupplierprice/css/quicksupplierprice.css.php'),\t// Set this to relative path of css file if module has its own css file\n\t \t//\t\t\t\t\t\t\t'js' => array('/quicksupplierprice/js/quicksupplierprice.js'),          // Set this to relative path of js file if module must load a js on all pages\n\t\t//\t\t\t\t\t\t\t'hooks' => array('hookcontext1','hookcontext2')  \t// Set here all hooks context managed by module\n\t\t//\t\t\t\t\t\t\t'dir' => array('output' => 'othermodulename'),      // To force the default directories names\n\t\t//\t\t\t\t\t\t\t'workflow' => array('WORKFLOW_MODULE1_YOURACTIONTYPE_MODULE2'=>array('enabled'=>'! empty($conf->module1->enabled) && ! empty($conf->module2->enabled)', 'picto'=>'yourpicto@quicksupplierprice')) // Set here all workflow context managed by module\n\t\t//                        );\n\t\t$this->module_parts = array(\n            'hooks'=>array('ordersuppliercard','invoicesuppliercard')\n        );\n\n\t\t// Data directories to create when module is enabled.\n\t\t// Example: this->dirs = array(\"/quicksupplierprice/temp\");\n\t\t$this->dirs = array();\n\n\t\t// Config pages. Put here list of php page, stored into quicksupplierprice/admin directory, to use to setup module.\n\t\t$this->config_page_url = array(\"quicksupplierprice_setup.php@quicksupplierprice\");\n\n\t\t// Dependencies\n\t\t$this->hidden = false;\t\t\t// A condition to hide module\n\t\t$this->depends = array();\t\t// List of modules id that must be enabled if this module is enabled\n\t\t$this->requiredby = array();\t// List of modules id to disable if this one is disabled\n\t\t$this->conflictwith = array();\t// List of modules id this module is in conflict with\n\t\t$this->phpmin = array(5,0);\t\t\t\t\t// Minimum version of PHP required by module\n\t\t$this->need_dolibarr_version = array(3,0);\t// Minimum version of Dolibarr required by module\n\t\t$this->langfiles = array(\"quicksupplierprice@quicksupplierprice\");\n\n\t\t// Constants\n\t\t// List of particular constants to add when module is enabled (key, 'chaine', value, desc, visible, 'current' or 'allentities', deleteonunactive)\n\t\t// Example: $this->const=array(0=>array('MYMODULE_MYNEWCONST1','chaine','myvalue','This is a constant to add',1),\n\t\t//                             1=>array('MYMODULE_MYNEWCONST2','chaine','myvalue','This is another constant to add',0, 'current', 1)\n\t\t// );\n\t\t$this->const = array(\n\t\t    0=>array('QSPBESTPRICE','chaine',1,'search for lower price',1, 'current', 1)\n\t\t);\n\n\t\t// Array to add new pages in new tabs\n\t\t// Example: $this->tabs = array('objecttype:+tabname1:Title1:mylangfile@quicksupplierprice:$user->rights->quicksupplierprice->read:/quicksupplierprice/mynewtab1.php?id=__ID__',  \t// To add a new tab identified by code tabname1\n        //                              'objecttype:+tabname2:Title2:mylangfile@quicksupplierprice:$user->rights->othermodule->read:/quicksupplierprice/mynewtab2.php?id=__ID__',  \t// To add another new tab identified by code tabname2\n        //                              'objecttype:-tabname:NU:conditiontoremove');                                                     \t\t\t\t\t\t// To remove an existing tab identified by code tabname\n\t\t// where objecttype can be\n\t\t// 'categories_x'\t  to add a tab in category view (replace 'x' by type of category (0=product, 1=supplier, 2=customer, 3=member)\n\t\t// 'contact'          to add a tab in contact view\n\t\t// 'contract'         to add a tab in contract view\n\t\t// 'group'            to add a tab in group view\n\t\t// 'intervention'     to add a tab in intervention view\n\t\t// 'invoice'          to add a tab in customer invoice view\n\t\t// 'invoice_supplier' to add a tab in supplier invoice view\n\t\t// 'member'           to add a tab in fundation member view\n\t\t// 'opensurveypoll'\t  to add a tab in opensurvey poll view\n\t\t// 'order'            to add a tab in customer order view\n\t\t// 'order_supplier'   to add a tab in supplier order view\n\t\t// 'payment'\t\t  to add a tab in payment view\n\t\t// 'payment_supplier' to add a tab in supplier payment view\n\t\t// 'product'          to add a tab in product view\n\t\t// 'propal'           to add a tab in propal view\n\t\t// 'project'          to add a tab in project view\n\t\t// 'stock'            to add a tab in stock view\n\t\t// 'thirdparty'       to add a tab in third party view\n\t\t// 'user'             to add a tab in user view\n        $this->tabs = array();\n\n        // Dictionaries\n\t    if (! isset($conf->quicksupplierprice->enabled))\n        {\n        \t$conf->quicksupplierprice=new stdClass();\n        \t$conf->quicksupplierprice->enabled=0;\n        }\n\t\t$this->dictionaries=array();\n        /* Example:\n        if (! isset($conf->quicksupplierprice->enabled)) $conf->quicksupplierprice->enabled=0;\t// This is to avoid warnings\n        $this->dictionaries=array(\n            'langs'=>'mylangfile@quicksupplierprice',\n            'tabname'=>array(MAIN_DB_PREFIX.\"table1\",MAIN_DB_PREFIX.\"table2\",MAIN_DB_PREFIX.\"table3\"),\t\t// List of tables we want to see into dictonnary editor\n            'tablib'=>array(\"Table1\",\"Table2\",\"Table3\"),\t\t\t\t\t\t\t\t\t\t\t\t\t// Label of tables\n            'tabsql'=>array('SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table1 as f','SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table2 as f','SELECT f.rowid as rowid, f.code, f.label, f.active FROM '.MAIN_DB_PREFIX.'table3 as f'),\t// Request to select fields\n            'tabsqlsort'=>array(\"label ASC\",\"label ASC\",\"label ASC\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Sort order\n            'tabfield'=>array(\"code,label\",\"code,label\",\"code,label\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// List of fields (result of select to show dictionary)\n            'tabfieldvalue'=>array(\"code,label\",\"code,label\",\"code,label\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// List of fields (list of fields to edit a record)\n            'tabfieldinsert'=>array(\"code,label\",\"code,label\",\"code,label\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// List of fields (list of fields for insert)\n            'tabrowid'=>array(\"rowid\",\"rowid\",\"rowid\"),\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Name of columns with primary key (try to always name it 'rowid')\n            'tabcond'=>array($conf->quicksupplierprice->enabled,$conf->quicksupplierprice->enabled,$conf->quicksupplierprice->enabled)\t\t\t\t\t\t\t\t\t\t\t\t// Condition to show each dictionary\n        );\n        */\n\n        // Boxes\n\t\t// Add here list of php file(s) stored in core/boxes that contains class to show a box.\n        $this->boxes = array();\t\t\t// List of boxes\n\t\t// Example:\n\t\t//$this->boxes=array(array(0=>array('file'=>'myboxa.php','note'=>'','enabledbydefaulton'=>'Home'),1=>array('file'=>'myboxb.php','note'=>''),2=>array('file'=>'myboxc.php','note'=>'')););\n\n\t\t// Permissions\n\t\t$this->rights = array();\t\t// Permission array used by this module\n\t\t$r=0;\n\n\t\t// Add here list of permission defined by an id, a label, a boolean and two constant strings.\n\t\t// Example:\n\t\t// $this->rights[$r][0] = $this->numero + $r;\t// Permission id (must not be already used)\n\t\t// $this->rights[$r][1] = 'Permision label';\t// Permission label\n\t\t// $this->rights[$r][3] = 1; \t\t\t\t\t// Permission by default for new user (0/1)\n\t\t// $this->rights[$r][4] = 'level1';\t\t\t\t// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)\n\t\t// $this->rights[$r][5] = 'level2';\t\t\t\t// In php code, permission will be checked by test if ($user->rights->permkey->level1->level2)\n\t\t// $r++;\n\n\n\t\t// Main menu entries\n\t\t$this->menu = array();\t\t\t// List of menus to add\n\t\t$r=0;\n\n\t\t// Add here entries to declare new menus\n\t\t//\n\t\t// Example to declare a new Top Menu entry and its Left menu entry:\n\t\t// $this->menu[$r]=array(\t'fk_menu'=>0,\t\t\t                // Put 0 if this is a top menu\n\t\t//\t\t\t\t\t\t\t'type'=>'top',\t\t\t                // This is a Top menu entry\n\t\t//\t\t\t\t\t\t\t'titre'=>'quicksupplierprice top menu',\n\t\t//\t\t\t\t\t\t\t'mainmenu'=>'quicksupplierprice',\n\t\t//\t\t\t\t\t\t\t'leftmenu'=>'quicksupplierprice',\n\t\t//\t\t\t\t\t\t\t'url'=>'/quicksupplierprice/pagetop.php',\n\t\t//\t\t\t\t\t\t\t'langs'=>'mylangfile@quicksupplierprice',\t        // Lang file to use (without .lang) by module. File must be in langs/code_CODE/ directory.\n\t\t//\t\t\t\t\t\t\t'position'=>100,\n\t\t//\t\t\t\t\t\t\t'enabled'=>'$conf->quicksupplierprice->enabled',\t// Define condition to show or hide menu entry. Use '$conf->quicksupplierprice->enabled' if entry must be visible if module is enabled.\n\t\t//\t\t\t\t\t\t\t'perms'=>'1',\t\t\t                // Use 'perms'=>'$user->rights->quicksupplierprice->level1->level2' if you want your menu with a permission rules\n\t\t//\t\t\t\t\t\t\t'target'=>'',\n\t\t//\t\t\t\t\t\t\t'user'=>2);\t\t\t\t                // 0=Menu for internal users, 1=external users, 2=both\n\t\t// $r++;\n\t\t//\n\t\t// Example to declare a Left Menu entry into an existing Top menu entry:\n\t\t// $this->menu[$r]=array(\t'fk_menu'=>'fk_mainmenu=xxx',\t\t    // Use 'fk_mainmenu=xxx' or 'fk_mainmenu=xxx,fk_leftmenu=yyy' where xxx is mainmenucode and yyy is a leftmenucode\n\t\t//\t\t\t\t\t\t\t'type'=>'left',\t\t\t                // This is a Left menu entry\n\t\t//\t\t\t\t\t\t\t'titre'=>'quicksupplierprice left menu',\n\t\t//\t\t\t\t\t\t\t'mainmenu'=>'xxx',\n\t\t//\t\t\t\t\t\t\t'leftmenu'=>'quicksupplierprice',\n\t\t//\t\t\t\t\t\t\t'url'=>'/quicksupplierprice/pagelevel2.php',\n\t\t//\t\t\t\t\t\t\t'langs'=>'mylangfile@quicksupplierprice',\t        // Lang file to use (without .lang) by module. File must be in langs/code_CODE/ directory.\n\t\t//\t\t\t\t\t\t\t'position'=>100,\n\t\t//\t\t\t\t\t\t\t'enabled'=>'$conf->quicksupplierprice->enabled',  // Define condition to show or hide menu entry. Use '$conf->quicksupplierprice->enabled' if entry must be visible if module is enabled. Use '$leftmenu==\\'system\\'' to show if leftmenu system is selected.\n\t\t//\t\t\t\t\t\t\t'perms'=>'1',\t\t\t                // Use 'perms'=>'$user->rights->quicksupplierprice->level1->level2' if you want your menu with a permission rules\n\t\t//\t\t\t\t\t\t\t'target'=>'',\n\t\t//\t\t\t\t\t\t\t'user'=>2);\t\t\t\t                // 0=Menu for internal users, 1=external users, 2=both\n\t\t// $r++;\n\n\n\t\t// Exports\n\t\t$r=1;\n\n\t\t// Example:\n\t\t// $this->export_code[$r]=$this->rights_class.'_'.$r;\n\t\t// $this->export_label[$r]='CustomersInvoicesAndInvoiceLines';\t// Translation key (used only if key ExportDataset_xxx_z not found)\n        // $this->export_enabled[$r]='1';                               // Condition to show export in list (ie: '$user->id==3'). Set to 1 to always show when module is enabled.\n\t\t// $this->export_permission[$r]=array(array(\"facture\",\"facture\",\"export\"));\n\t\t// $this->export_fields_array[$r]=array('s.rowid'=>\"IdCompany\",'s.nom'=>'CompanyName','s.address'=>'Address','s.zip'=>'Zip','s.town'=>'Town','s.fk_pays'=>'Country','s.phone'=>'Phone','s.siren'=>'ProfId1','s.siret'=>'ProfId2','s.ape'=>'ProfId3','s.idprof4'=>'ProfId4','s.code_compta'=>'CustomerAccountancyCode','s.code_compta_fournisseur'=>'SupplierAccountancyCode','f.rowid'=>\"InvoiceId\",'f.facnumber'=>\"InvoiceRef\",'f.datec'=>\"InvoiceDateCreation\",'f.datef'=>\"DateInvoice\",'f.total'=>\"TotalHT\",'f.total_ttc'=>\"TotalTTC\",'f.tva'=>\"TotalVAT\",'f.paye'=>\"InvoicePaid\",'f.fk_statut'=>'InvoiceStatus','f.note'=>\"InvoiceNote\",'fd.rowid'=>'LineId','fd.description'=>\"LineDescription\",'fd.price'=>\"LineUnitPrice\",'fd.tva_tx'=>\"LineVATRate\",'fd.qty'=>\"LineQty\",'fd.total_ht'=>\"LineTotalHT\",'fd.total_tva'=>\"LineTotalTVA\",'fd.total_ttc'=>\"LineTotalTTC\",'fd.date_start'=>\"DateStart\",'fd.date_end'=>\"DateEnd\",'fd.fk_product'=>'ProductId','p.ref'=>'ProductRef');\n\t\t// $this->export_entities_array[$r]=array('s.rowid'=>\"company\",'s.nom'=>'company','s.address'=>'company','s.zip'=>'company','s.town'=>'company','s.fk_pays'=>'company','s.phone'=>'company','s.siren'=>'company','s.siret'=>'company','s.ape'=>'company','s.idprof4'=>'company','s.code_compta'=>'company','s.code_compta_fournisseur'=>'company','f.rowid'=>\"invoice\",'f.facnumber'=>\"invoice\",'f.datec'=>\"invoice\",'f.datef'=>\"invoice\",'f.total'=>\"invoice\",'f.total_ttc'=>\"invoice\",'f.tva'=>\"invoice\",'f.paye'=>\"invoice\",'f.fk_statut'=>'invoice','f.note'=>\"invoice\",'fd.rowid'=>'invoice_line','fd.description'=>\"invoice_line\",'fd.price'=>\"invoice_line\",'fd.total_ht'=>\"invoice_line\",'fd.total_tva'=>\"invoice_line\",'fd.total_ttc'=>\"invoice_line\",'fd.tva_tx'=>\"invoice_line\",'fd.qty'=>\"invoice_line\",'fd.date_start'=>\"invoice_line\",'fd.date_end'=>\"invoice_line\",'fd.fk_product'=>'product','p.ref'=>'product');\n\t\t// $this->export_sql_start[$r]='SELECT DISTINCT ';\n\t\t// $this->export_sql_end[$r]  =' FROM ('.MAIN_DB_PREFIX.'facture as f, '.MAIN_DB_PREFIX.'facturedet as fd, '.MAIN_DB_PREFIX.'societe as s)';\n\t\t// $this->export_sql_end[$r] .=' LEFT JOIN '.MAIN_DB_PREFIX.'product as p on (fd.fk_product = p.rowid)';\n\t\t// $this->export_sql_end[$r] .=' WHERE f.fk_soc = s.rowid AND f.rowid = fd.fk_facture';\n\t\t// $this->export_sql_order[$r] .=' ORDER BY s.nom';\n\t\t// $r++;\n\t}\n\n\t/**\n\t *\t\tFunction called when module is enabled.\n\t *\t\tThe init function add constants, boxes, permissions and menus (defined in constructor) into Dolibarr database.\n\t *\t\tIt also creates data directories\n\t *\n     *      @param      string\t$options    Options when enabling module ('', 'noboxes')\n\t *      @return     int             \t1 if OK, 0 if KO\n\t */\n\tfunction init($options='')\n\t{\n\t\t$sql = array();\n\n\t\tdefine('INC_FROM_DOLIBARR',true);\n\n\t\tdol_include_once('/quicksupplierprice/config.php');\n\t\tdol_include_once('/quicksupplierprice/script/create-maj-base.php');\n\n\t\t$result=$this->_load_tables('/quicksupplierprice/sql/');\n\n\t\treturn $this->_init($sql, $options);\n\t}\n\n\t/**\n\t *\t\tFunction called when module is disabled.\n\t *      Remove from database constants, boxes and permissions from Dolibarr database.\n\t *\t\tData directories are not deleted\n\t *\n     *      @param      string\t$options    Options when enabling module ('', 'noboxes')\n\t *      @return     int             \t1 if OK, 0 if KO\n\t */\n\tfunction remove($options='')\n\t{\n\t\t$sql = array();\n\n\t\treturn $this->_remove($sql, $options);\n\t}\n\n}\n", "<?php\n\n\tif (! defined('NOTOKENRENEWAL')) define('NOTOKENRENEWAL','1'); // Disables token renewal\n\n    require(\"../config.php\");\n    dol_include_once('/product/class/product.class.php');\n    dol_include_once('/fourn/class/fournisseur.product.class.php');\n\n    $get = GETPOST('get');\n    $put = GETPOST('put');\n\n    $id_prod = (int)GETPOST('idprod','int');                  // id du produit demand\u00e9\n    $ref_search= GETPOST('ref_search', 'alpha');        // ref du produit demand\u00e9\n    $ref = GETPOST('ref', 'alpha');                     // ref entr\u00e9e par l'utilisateur\n    $fk_soc = GETPOST('fk_supplier', 'int');            // id du fournisseur\n    $price = price2num(GETPOST('price','int') );                   // prix entr\u00e9 par l'utilisateur\n    $qte = (int)GETPOST('qty','int');                         // quantit\u00e9 demand\u00e9e\n    $unitprice = ($qte > 1) ? $price/$qte : $price;     // prix unitaire\n    $tvatx = GETPOST('tvatx', 'alpha');                     \t\t// taux de tva saisi\n    $fk_order = (int)GETPOST('fk_order','int');               // id de la commande en cours de modification\n\n    // si la ref est laiss\u00e9e vide je rempli la ref (ne pas utiliser pour l'instant)\n    // if($ref == '') $ref = 'FP-'.$fk_soc.'-'.$id_prod.'-'.$price;\n\n    switch($put){\n        case 'updateprice': // renvoie l'id d'une ligne produit\n        \tupatePrice($id_prod, $fk_soc, $unitprice, $qte, $ref_search, $price, $ref, $tvatx);\n            break;\n\n        case 'checkprice': // v\u00e9rifie s'il y a des prix unitaire strictement inf\u00e9rieurs et on en renvoie le nombre\n        \tcheckprice($id_prod, $unitprice, $fk_order, $qte, $price, $fk_soc, $tvatx);\n            break;\n\n        Default:\n            break;\n\n    }\n\n    /**\n     * V\u00e9rifie s'il existe des prix plus bas que celui saisi et en renvoie le nombre et la liste\n     *\n     * @param $id_prod        id du produit\n     * @param $unitprice      prix unitaire\n     * @param $fk_order       id de la commande en cours\n     * @param $qte            quantit\u00e9 command\u00e9e\n     * @param $price          total HT\n     * @param $fk_soc         id du fournisseur courant\n     * @param $tvatx          tva tx supplier\n     *\n     */\n    function checkprice($id_prod, $unitprice, $fk_order, $qte, $price, $fk_soc, $tvatx){\n        global $db, $langs;\n        $langs->load('quicksupplierprice@quicksupplierprice');\n\n        ob_start();\n        $sql = 'SELECT pfp.rowid as product_fourn_price_id, pfp.unitprice as fourn_unitprice, pfp.quantity as fourn_qty, pfp.price as fourn_price, s.nom as fourn_name, s.rowid as fourn_id';\n        $sql .= ' FROM ' . MAIN_DB_PREFIX .'product_fournisseur_price as pfp , ' . MAIN_DB_PREFIX .'societe as s';\n        $sql .= ' WHERE pfp.entity = 1';\n        $sql .= ' AND pfp.fk_soc = s.rowid';\n        $sql .= ' AND s.status=1';\n        $sql .= ' AND pfp.fk_product = '.$id_prod.' AND pfp.unitprice < '.$unitprice;\n\n        $res = $db->query($sql);\n        $nb = $db->num_rows($res);\n\n        $liste = '';\n        if($nb > 0){ // s'il existe des prix plus bas\n            // on g\u00e9n\u00e8re la liste des prix inf\u00e9rieurs au prix demand\u00e9\n            $liste = '<form action=\"'.dol_buildpath('/fourn/commande/card.php', 1).'?id='. $fk_order .'\" method=\"POST\">'.\"\\n\";\n            $liste .= '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n            $liste .= '<input type=\"hidden\" name=\"action\" value=\"selectpriceQSP\">';\n            $liste .= '<input type=\"hidden\" name=\"qty\" value=\"'.$qte.'\">';\n            $liste .= '<input type=\"hidden\" name=\"tvatx\" value=\"'.$tvatx.'\">';\n            $liste .= '<div><p>Plusieurs prix sont disponibles pour ce produit veuillez valider le prix saisie ou choisir le produit dans la liste</p></div>';\n            $liste .= '<div class=\"div-table-responsive\"><table class=\"noborder noshadow\" width=\"100%\"><thead>';\n            $liste .= '<tr class=\"liste_titre\"><td>Fournisseur</td><td align=\"right\">P.U. HT</td><td align=\"right\">Quantit\u00e9 minimum</td><td align=\"right\">Total HT</td><td width=\"20%\" align=\"right\" style=\"padding-right: 20px;\">Choix</td></tr>';\n            $liste .= '</thead><tbody>';\n\n            $liste .= '<tr><td><label for=\"saisie\">'.$langs->trans('validPrice').' '.$langs->trans('AddedToThis').'</label></td>';\n            $liste .= '<td align=\"right\"><label for=\"saisie\">' . number_format($unitprice, 2) . '</label></td>';\n            $liste .= '<td align=\"right\"><label for=\"saisie\">' . $qte . '</label></td>';\n            $liste .= '<td align=\"right\"><label for=\"saisie\">' . number_format($price, 2) . '</label></td>';\n            $liste .= '<td align=\"right\" style=\"padding-right: 20px;\"><input id=\"saisie\" type=\"radio\" name=\"prix\" value=\"saisie\" checked></td></tr>';\n\n            while($obj = $db->fetch_object($res)){\n                $tooltip = ($fk_soc == $obj->fourn_id) ? $langs->trans('AddedToThis') : $langs->trans('NewCommand');\n                $liste .= '<tr><td><label for=\"sel_'.$obj->product_fourn_price_id.'\">'. $obj->fourn_name .' '.$tooltip.'</label></td>';\n                $liste .= '<td align=\"right\"><label for=\"sel_'.$obj->product_fourn_price_id.'\">' . number_format($obj->fourn_unitprice, 2) . '</label></td>';\n                $liste .= '<td align=\"right\"><label for=\"sel_'.$obj->product_fourn_price_id.'\">' . $obj->fourn_qty . '</label></td>';\n                $liste .= '<td align=\"right\"><label for=\"sel_'.$obj->product_fourn_price_id.'\">' . number_format($obj->fourn_price, 2) . '</label></td>';\n                $liste .= '<td align=\"right\" style=\"padding-right: 20px;\"><input id=\"sel_'.$obj->product_fourn_price_id.'\" type=\"radio\" name=\"prix\" value=\"'.$obj->product_fourn_price_id.'\"></td></tr>';\n            }\n\n            $liste .= '</tbody></table></div>';\n\n            $liste .= '<div class=\"center\">';\n            $liste .= '<input type=\"submit\" class=\"button\" value=\"'.$langs->trans(\"Validate\").'\">';\n            $liste .= '</div>';\n            $liste .= '</form>';\n        }\n\n        ob_clean();\n        print json_encode( array('nb' => $nb, 'liste' => $liste));\n\n    }\n\n    /**\n     *\n     * @param unknown $id_prod\n     * @param unknown $fk_soc\n     * @param unknown $unitprice\n     * @param unknown $qte\n     * @param unknown $ref_search\n     * @param unknown $price\n     * @param unknown $ref\n     * @param unknown $tvatx\n     */\n    function upatePrice($id_prod, $fk_soc, $unitprice, $qte, $ref_search, $price, $ref, $tvatx){\n        global $db, $user;\n\n\t\tif ($price === '' || $unitprice === '') {\n\t\t\tprint json_encode(array('retour' => 0, 'error' => 'prix non renseign\u00e9'));\n\t\t\treturn;\n\t\t}\n\n        ob_start();\n\n        // Clean vat code\n        $vat_src_code = '';\n        if (preg_match('/\\((.*)\\)/', $tvatx, $reg)) {\n        \t$vat_src_code = $reg[1];\n        \t$tvatx = preg_replace('/\\s*\\(.*\\)/', '', $tvatx); // Remove code into vatrate.\n        }\n\n        // On v\u00e9rifie si la ligne de tarif n'existe pas d\u00e9j\u00e0 pour ce fournisseur\n\t\t$sql = 'SELECT rowid FROM ' . MAIN_DB_PREFIX . 'product_fournisseur_price'\n\t\t\t. ' WHERE fk_product=' . intval($id_prod)\n\t\t\t. ' AND fk_soc=' . intval($fk_soc)\n\t\t\t. ' AND unitprice=' . floatval($unitprice)\n\t\t\t. ' AND quantity=' . intval($qte);\n        if (!empty($vat_src_code)) {\n        \t$sql .= ' AND default_vat_code=\"' . $db->escape($vat_src_code).'\"';\n        }\n\n\n        $resq = $db->query($sql);\n\t\tif (!$resq) {\n\t\t\tprint json_encode(array('retour' => 0, 'error' => $db->lasterror()));\n\t\t\treturn;\n\t\t}\n\n        if($resq->num_rows !== 0){ // s'il existe, on renvoie l'id de cet ligne prix\n            $obj = $db->fetch_object($resq);\n            $ret = $obj->rowid;\n        } else { // si on ne trouve rien, cr\u00e9ation du prix fournisseur\n            $product = new ProductFournisseur($db);\n            $product->fetch($id_prod, $ref_search);\n\n            $fourn = new Fournisseur($db);\n            $fourn->fetch($fk_soc);\n\n             $product->product_fourn_id = $fourn->id;\n\n            // La methode update_buyprice() renvoie -1 ou -2 en cas d'erreur ou l'id de l'objet modifi\u00e9 ou cr\u00e9\u00e9 en cas de r\u00e9ussite\n             $ret=$product->update_buyprice($qte , $price, $user, 'HT', $fourn, 1, $ref, $tvatx, 0, 0, 0, 0, 0, '', array(), $vat_src_code, $price);\n        }\n\n        ob_clean();\n\n        if($ret<0) print json_encode( array('retour'=>$ret,'error'=> $product->error) );\n        else {\n            print json_encode(  array('retour'=> $ret, 'error'=>'', 'dp_desc'=>$product->description ) );\n        }\n    }\n\n"], "filenames": ["ChangeLog.md", "core/modules/modquicksupplierprice.class.php", "script/interface.php"], "buggy_code_start_loc": [7, 61, 120], "buggy_code_end_loc": [7, 62, 140], "fixing_code_start_loc": [8, 61, 121], "fixing_code_end_loc": [10, 62, 151], "type": "CWE-89", "message": "A vulnerability, which was classified as critical, has been found in ATM Consulting dolibarr_module_quicksupplierprice up to 1.1.6. Affected by this issue is the function upatePrice of the file script/interface.php. The manipulation leads to sql injection. The attack may be launched remotely. Upgrading to version 1.1.7 is able to address this issue. The name of the patch is ccad1e4282b0e393a32fcc852e82ec0e0af5446f. It is recommended to upgrade the affected component. VDB-223382 is the identifier assigned to this vulnerability.", "other": {"cve": {"id": "CVE-2022-4933", "sourceIdentifier": "cna@vuldb.com", "published": "2023-03-20T05:15:12.050", "lastModified": "2023-03-24T19:05:48.167", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A vulnerability, which was classified as critical, has been found in ATM Consulting dolibarr_module_quicksupplierprice up to 1.1.6. Affected by this issue is the function upatePrice of the file script/interface.php. The manipulation leads to sql injection. The attack may be launched remotely. Upgrading to version 1.1.7 is able to address this issue. The name of the patch is ccad1e4282b0e393a32fcc852e82ec0e0af5446f. It is recommended to upgrade the affected component. VDB-223382 is the identifier assigned to this vulnerability."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV30": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "LOW", "baseScore": 6.3, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 3.4}], "cvssMetricV2": [{"source": "cna@vuldb.com", "type": "Secondary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "cna@vuldb.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:atm-consulting:dolibarr_module_quicksupplierprice:*:*:*:*:*:*:*:*", "versionEndExcluding": "1.1.7", "matchCriteriaId": "F4E7A9B7-47FB-4D41-AB7E-B25F06AA5A11"}]}]}], "references": [{"url": "https://github.com/ATM-Consulting/dolibarr_module_quicksupplierprice/commit/ccad1e4282b0e393a32fcc852e82ec0e0af5446f", "source": "cna@vuldb.com", "tags": ["Patch"]}, {"url": "https://github.com/ATM-Consulting/dolibarr_module_quicksupplierprice/pull/21", "source": "cna@vuldb.com", "tags": ["Issue Tracking", "Patch"]}, {"url": "https://vuldb.com/?ctiid.223382", "source": "cna@vuldb.com", "tags": ["Permissions Required", "Third Party Advisory"]}, {"url": "https://vuldb.com/?id.223382", "source": "cna@vuldb.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ATM-Consulting/dolibarr_module_quicksupplierprice/commit/ccad1e4282b0e393a32fcc852e82ec0e0af5446f"}}