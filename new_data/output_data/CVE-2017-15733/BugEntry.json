{"buggy_code": ["<?php\n\n/**\n * AJAX: handles an attachment with the given id.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n *\n * @author    Anatoliy Belsky <anatoliy.belsky@mayflower.de>\n * @copyright 2010-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2010-12-20\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$ajaxAction = PMF_Filter::filterInput(INPUT_GET, 'ajaxaction', FILTER_SANITIZE_STRING);\n$attId = PMF_Filter::filterInput(INPUT_GET, 'attId', FILTER_VALIDATE_INT);\n\n$att = PMF_Attachment_Factory::create($attId);\n\nif ($att) {\n    switch ($ajaxAction) {\n        case 'delete':\n            if ($att->delete()) {\n                print $PMF_LANG['msgAttachmentsDeleted'];\n            } else {\n                print $PMF_LANG['ad_att_delfail'];\n            }\n            break;\n    }\n}\n", "<?php\n/**\n * Ajax interface for attachments.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @author    Anatoliy Belsky <ab@php.net>\n * @copyright 2010-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2010-12-13\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$page = PMF_Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT);\n$page = 1 > $page ? 1 : $page;\n\n$fa = new PMF_Attachment_Collection($faqConfig);\n$itemsPerPage = 32;\n$allCrumbs = $fa->getBreadcrumbs();\n\n$crumbs = array_slice($allCrumbs, ($page - 1) * $itemsPerPage, $itemsPerPage);\n\n$pagination = new PMF_Pagination(\n    $faqConfig,\n    array(\n        'baseUrl' => PMF_Link::getSystemRelativeUri().'?'.str_replace('&', '&amp;', $_SERVER['QUERY_STRING']),\n        'total' => count($allCrumbs),\n        'perPage' => $itemsPerPage,\n    )\n);\n?>\n        <header class=\"row\">\n            <div class=\"col-lg-12\">\n                <h2 class=\"page-header\">\n                    <i aria-hidden=\"true\" class=\"fa fa-file\"></i> <?php echo $PMF_LANG['ad_menu_attachment_admin'] ?>\n                </h2>\n            </div>\n        </header>\n\n        <div class=\"row\">\n            <div class=\"col-lg-12\">\n                <table class=\"table table-striped\">\n                    <thead>\n                    <tr>\n                        <th><?php echo $PMF_LANG['msgAttachmentsFilename'] ?></th>\n                        <th><?php echo $PMF_LANG['msgTransToolLanguage'] ?></th>\n                        <th><?php echo $PMF_LANG['msgAttachmentsFilesize'] ?></th>\n                        <th colspan=\"2\"><?php echo $PMF_LANG['msgAttachmentsMimeType'] ?></th>\n                    </tr>\n                    </thead>\n                    <tbody>\n                    <?php foreach ($crumbs as $item): ?>\n                        <tr class=\"att_<?php echo $item->id ?>\" title=\"<?php echo $item->thema ?>\">\n                            <td><?php echo $item->filename ?></td>\n                            <td><?php echo $item->record_lang ?></td>\n                            <td><?php echo $item->filesize ?></td>\n                            <td><?php echo $item->mime_type ?></td>\n                            <td>\n                                <a href=\"javascript:deleteAttachment(<?php echo $item->id ?>); void(0);\"\n                                   class=\"btn btn-danger\" title=\"<?php echo $PMF_LANG['ad_gen_delete'] ?>\">\n                                    <i aria-hidden=\"true\" class=\"fa fa-trash-o\"></i>\n                                </a>\n                            </td>\n                        </tr>\n                    <?php endforeach; ?>\n                    </tbody>\n                    <tfoot>\n                    <tr>\n                        <td colspan=\"5\"><?php echo $pagination->render(); ?></td>\n                    </tr>\n                    </tfoot>\n                </table>\n            </div>\n        </div>\n        \n        <script type=\"text/javascript\">\n        /**\n         * Ajax call for deleting attachments\n         *\n         * @param att_id Attachment id\n         */\n        function deleteAttachment(att_id)\n        {\n            if (confirm('<?php echo $PMF_LANG['msgAttachmentsWannaDelete'] ?>')) {\n                $('#saving_data_indicator').html('<i aria-hidden=\"true\" class=\"fa fa-spinner fa-spin\"></i> Deleting ...');\n                $.ajax({\n                    type:    \"GET\",\n                    url:     \"index.php?action=ajax&ajax=att&ajaxaction=delete\",\n                    data:    {attId: att_id},\n                    success: function(msg) {\n                        $('.att_' + att_id).fadeOut('slow');\n                        $('#saving_data_indicator').html('<p class=\"alert alert-success\">' + msg + '</p>');\n                    }\n                });\n            }\n        }\n        </script>"], "fixing_code": ["<?php\n\n/**\n * AJAX: handles an attachment with the given id.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @author    Anatoliy Belsky <anatoliy.belsky@mayflower.de>\n * @copyright 2010-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      http://www.phpmyfaq.de\n * @since     2010-12-20\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$ajaxAction = PMF_Filter::filterInput(INPUT_GET, 'ajaxaction', FILTER_SANITIZE_STRING);\n$attId = PMF_Filter::filterInput(INPUT_GET, 'attId', FILTER_VALIDATE_INT);\n$csrfToken = PMF_Filter::filterInput(INPUT_GET, 'csrf', FILTER_SANITIZE_STRING);\n\n$att = PMF_Attachment_Factory::create($attId);\n\nif ($att) {\n    switch ($ajaxAction) {\n        case 'delete':\n\n            if (!isset($_SESSION['phpmyfaq_csrf_token']) || $_SESSION['phpmyfaq_csrf_token'] !== $csrfToken) {\n                echo $PMF_LANG['err_NotAuth'];\n                exit(1);\n            }\n\n            if ($att->delete()) {\n                echo $PMF_LANG['msgAttachmentsDeleted'];\n            } else {\n                echo $PMF_LANG['ad_att_delfail'];\n            }\n            break;\n    }\n}\n", "<?php\n/**\n * Ajax interface for attachments.\n *\n * PHP Version 5.5\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @category  phpMyFAQ\n * @author    Anatoliy Belsky <ab@php.net>\n * @copyright 2010-2017 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n *\n * @link      http://www.phpmyfaq.de\n * @since     2010-12-13\n */\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    $protocol = 'http';\n    if (isset($_SERVER['HTTPS']) && strtoupper($_SERVER['HTTPS']) === 'ON') {\n        $protocol = 'https';\n    }\n    header('Location: '.$protocol.'://'.$_SERVER['HTTP_HOST'].dirname($_SERVER['SCRIPT_NAME']));\n    exit();\n}\n\n$page = PMF_Filter::filterInput(INPUT_GET, 'page', FILTER_VALIDATE_INT);\n$page = 1 > $page ? 1 : $page;\n\n$fa = new PMF_Attachment_Collection($faqConfig);\n$itemsPerPage = 32;\n$allCrumbs = $fa->getBreadcrumbs();\n\n$crumbs = array_slice($allCrumbs, ($page - 1) * $itemsPerPage, $itemsPerPage);\n\n$pagination = new PMF_Pagination(\n    $faqConfig,\n    array(\n        'baseUrl' => PMF_Link::getSystemRelativeUri().'?'.str_replace('&', '&amp;', $_SERVER['QUERY_STRING']),\n        'total' => count($allCrumbs),\n        'perPage' => $itemsPerPage,\n    )\n);\n?>\n        <header class=\"row\">\n            <div class=\"col-lg-12\">\n                <h2 class=\"page-header\">\n                    <i aria-hidden=\"true\" class=\"fa fa-file\"></i> <?php echo $PMF_LANG['ad_menu_attachment_admin'] ?>\n                </h2>\n            </div>\n        </header>\n\n        <div class=\"row\">\n            <div class=\"col-lg-12\">\n                <table class=\"table table-striped\">\n                    <thead>\n                    <tr>\n                        <th><?php echo $PMF_LANG['msgAttachmentsFilename'] ?></th>\n                        <th><?php echo $PMF_LANG['msgTransToolLanguage'] ?></th>\n                        <th><?php echo $PMF_LANG['msgAttachmentsFilesize'] ?></th>\n                        <th colspan=\"2\"><?php echo $PMF_LANG['msgAttachmentsMimeType'] ?></th>\n                    </tr>\n                    </thead>\n                    <tbody>\n                    <?php foreach ($crumbs as $item): ?>\n                        <tr class=\"att_<?php echo $item->id ?>\" title=\"<?php echo $item->thema ?>\">\n                            <td><?php echo $item->filename ?></td>\n                            <td><?php echo $item->record_lang ?></td>\n                            <td><?php echo $item->filesize ?></td>\n                            <td><?php echo $item->mime_type ?></td>\n                            <td>\n                                <a href=\"javascript:deleteAttachment(<?php echo $item->id ?>, '<?php echo $user->getCsrfTokenFromSession() ?>'); void(0);\"\n                                   class=\"btn btn-danger\" title=\"<?php echo $PMF_LANG['ad_gen_delete'] ?>\">\n                                    <i aria-hidden=\"true\" class=\"fa fa-trash-o\"></i>\n                                </a>\n                            </td>\n                        </tr>\n                    <?php endforeach; ?>\n                    </tbody>\n                    <tfoot>\n                    <tr>\n                        <td colspan=\"5\"><?php echo $pagination->render(); ?></td>\n                    </tr>\n                    </tfoot>\n                </table>\n            </div>\n        </div>\n        \n        <script type=\"text/javascript\">\n        /**\n         * Ajax call for deleting attachments\n         *\n         * @param att_id Attachment id\n         * @apram csrf CSRF token\n         */\n        function deleteAttachment(att_id, csrf)\n        {\n            if (confirm('<?php echo $PMF_LANG['msgAttachmentsWannaDelete'] ?>')) {\n                $('#saving_data_indicator').html('<i aria-hidden=\"true\" class=\"fa fa-spinner fa-spin\"></i> Deleting ...');\n                $.ajax({\n                    type:    \"GET\",\n                    url:     \"index.php?action=ajax&ajax=att&ajaxaction=delete\",\n                    data:    { attId: att_id, csrf: csrf},\n                    success: function(msg) {\n                        $('.att_' + att_id).fadeOut('slow');\n                        $('#saving_data_indicator').html('<p class=\"alert alert-success\">' + msg + '</p>');\n                    }\n                });\n            }\n        }\n        </script>"], "filenames": ["phpmyfaq/admin/ajax.attachment.php", "phpmyfaq/admin/att.main.php"], "buggy_code_start_loc": [13, 73], "buggy_code_end_loc": [42, 104], "fixing_code_start_loc": [12, 73], "fixing_code_end_loc": [47, 105], "type": "CWE-352", "message": "In phpMyFAQ before 2.9.9, there is Cross-Site Request Forgery (CSRF) in admin/ajax.attachment.php and admin/att.main.php.", "other": {"cve": {"id": "CVE-2017-15733", "sourceIdentifier": "cve@mitre.org", "published": "2017-10-22T18:29:00.527", "lastModified": "2017-10-24T15:09:29.957", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In phpMyFAQ before 2.9.9, there is Cross-Site Request Forgery (CSRF) in admin/ajax.attachment.php and admin/att.main.php."}, {"lang": "es", "value": "En phpMyFAQ en versiones anteriores a la 2.9.9 hay Cross-Site Request Forgery (CSRF) en admin/ajax.attachment.php y admin/att.main.php."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.8}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndIncluding": "2.9.8", "matchCriteriaId": "1D0B1C07-83F7-4DB0-976C-51483D7DF516"}]}]}], "references": [{"url": "https://github.com/thorsten/phpMyFAQ/commit/ef5a66df4bcfacc7573322af33ce10c30e0bb896", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpMyFAQ/commit/ef5a66df4bcfacc7573322af33ce10c30e0bb896"}}