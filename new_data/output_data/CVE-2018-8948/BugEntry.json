{"buggy_code": ["<div class=\"index\">\n\t<h2><?php echo h($title); ?></h2>\n\t<?php $scope = !empty($proposals) ? 'proposals' : 'attributes'; ?>\n\t<p><?php echo __('Below you can see the %s that are to be created. Make sure that the categories and the types are correct, often several options will be offered based on an inconclusive automatic resolution.', $scope);?></p>\n\t<?php\n\t\t$instanceDefault = 5;\n\t\tif (!empty(Configure::read('MISP.default_attribute_distribution'))) {\n\t\t\tif (Configure::read('MISP.default_attribute_distribution') == 'event') {\n\t\t\t\t$instanceDefault = 5;\n\t\t\t} else {\n\t\t\t\t$instanceDefault = Configure::read('MISP.default_attribute_distribution');\n\t\t\t}\n\t\t}\n\t\techo $this->Form->create('Attribute', array('url' => '/events/saveFreeText/' . $event['Event']['id'], 'class' => 'mainForm'));\n\t\tif ($isSiteAdmin) {\n\t\t\techo $this->Form->input('force', array(\n\t\t\t\t\t'checked' => false,\n\t\t\t\t\t'label' => __('Proposals instead of attributes'),\n\t\t\t));\n\t\t}\n\t\techo $this->Form->input('JsonObject', array(\n\t\t\t\t'label' => false,\n\t\t\t\t'type' => 'text',\n\t\t\t\t'style' => 'display:none;',\n\t\t\t\t'value' => '',\n\t\t));\n\t\techo $this->Form->input('default_comment', array(\n\t\t\t\t'label' => false,\n\t\t\t\t'type' => 'text',\n\t\t\t\t'style' => 'display:none;',\n\t\t\t\t'value' => $importComment,\n\t\t));\n\t\techo $this->Form->end();\n\t?>\n\t<table class=\"table table-striped table-hover table-condensed\">\n\t\t<tr>\n\t\t\t\t<th><?php echo __('Value');?></th>\n\t\t\t\t<th><?php echo __('Similar Attributes');?></th>\n\t\t\t\t<th><?php echo __('Category');?></th>\n\t\t\t\t<th><?php echo __('Type');?></th>\n\t\t\t\t<th><?php echo __('IDS');?><input type=\"checkbox\" id=\"checkAll\" style=\"margin:0px;margin-left:3px;\"/></th>\n\t\t\t\t<th><?php echo __('Distribution');?></th>\n\t\t\t\t<th><?php echo __('Comment');?></th>\n\t\t\t\t<th><?php echo __('Tags');?></th>\n\t\t\t\t<th><?php echo __('Actions');?></th>\n\t\t</tr>\n\t\t<?php\n\t\t\t$options = array();\n\t\t\tforeach ($resultArray as $k => $item):\n\t\t?>\n\t\t<tr id=\"row_<?php echo $k; ?>\" class=\"freetext_row\">\n\t\t\t<?php\n\t\t\t\techo $this->Form->input('Attribute' . $k . 'Save', array(\n\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t'style' => 'display:none;',\n\t\t\t\t\t\t'value' => 1,\n\t\t\t\t));\n\t\t\t\techo $this->Form->input('Attribute' . $k . 'Data', array(\n\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t'type' => 'hidden',\n\t\t\t\t\t\t'value' => isset($item['data']) ? $item['data'] : false,\n\t\t\t\t));\n\t\t\t\techo $this->Form->input('Attribute' . $k . 'DataIsHandled', array(\n\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t'type' => 'hidden',\n\t\t\t\t\t\t'value' => isset($item['data_is_handled']) ? h($item['data_is_handled']) : false,\n\t\t\t\t));\n\t\t\t?>\n\t\t\t<td>\n\t\t\t\t<?php\n\t\t\t\t\techo $this->Form->input('Attribute' . $k . 'Value', array(\n\t\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t\t'value' => $item['value'],\n\t\t\t\t\t\t\t'style' => 'padding:0px;height:20px;margin-bottom:0px;width:90%;min-width:400px;',\n\t\t\t\t\t\t\t'div' => false\n\t\t\t\t\t));\n\t\t\t\t?>\n\t\t\t\t<input type=\"hidden\" id=\"<?php echo 'Attribute' . $k . 'Save'; ?>\" value=1 >\n\t\t\t</td>\n\t\t\t<td class=\"shortish\">\n\t\t\t\t<?php\n\t\t\t\t\tforeach ($item['related'] as $relation):\n\t\t\t\t\t\t$popover = array(\n\t\t\t\t\t\t\t'Event ID' => $relation['Event']['id'],\n\t\t\t\t\t\t\t'Event Info' => $relation['Event']['info'],\n\t\t\t\t\t\t\t'Category' => $relation['Attribute']['category'],\n\t\t\t\t\t\t\t'Type' => $relation['Attribute']['type'],\n\t\t\t\t\t\t\t'Value' => $relation['Attribute']['value'],\n\t\t\t\t\t\t\t'Comment' => $relation['Attribute']['comment'],\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$popoverHTML = '';\n\t\t\t\t\t\tforeach ($popover as $key => $popoverElement) {\n\t\t\t\t\t\t\t$popoverHTML .= '<span class=\\'bold\\'>' . $key . '</span>: <span class=\\'blue bold\\'>' . $popoverElement . '</span><br />';\n\t\t\t\t\t\t}\n\t\t\t\t?>\n\t\t\t\t\t\t<a href=\"<?php echo $baseurl; ?>/events/view/<?php echo h($relation['Event']['id']);?>\" data-toggle=\"popover\" title=\"Attribute details\" data-content=\"<?php echo h($popoverHTML); ?>\" data-trigger=\"hover\"><?php echo h($relation['Event']['id']);?></a>\n\t\t\t\t<?php\n\t\t\t\t\tendforeach;\n\t\t\t\t\t$correlationPopover = array('<span>', );\n\t\t\t\t?>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<?php\n\t\t\t\t\tif (!isset($item['categories'])) {\n\t\t\t\t\t\tif (isset($defaultCategories[$item['default_type']])) {\n\t\t\t\t\t\t\t$default = array_search($defaultCategories[$item['default_type']], $typeCategoryMapping[$item['default_type']]);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treset($typeCategoryMapping[$item['default_type']]);\n\t\t\t\t\t\t\t$default = key($typeCategoryMapping[$item['default_type']]);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (isset($item['category_default'])) $default = $item['category_default'];\n\t\t\t\t\t\telse $default = array_search($item['categories'][0], $typeCategoryMapping[$item['default_type']]);\n\n\t\t\t\t\t}\n\t\t\t\t?>\n\t\t\t\t<select id=\"<?php echo 'Attribute' . $k . 'Category'; ?>\" style='padding:0px;height:20px;margin-bottom:0px;' class=\"categoryToggle\">\n\t\t\t\t\t<?php\n\t\t\t\t\t\tforeach ($typeCategoryMapping[$item['default_type']] as $category) {\n\t\t\t\t\t\t\tif (isset($item['categories']) && !in_array($category, $item['categories'])) {\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\techo '<option value=\"' . $category . '\" ';\n\t\t\t\t\t\t\tif ($category == $default) echo 'selected=\"selected\"';\n\t\t\t\t\t\t\techo '>' . $category . '</option>';\n\t\t\t\t\t\t}\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<?php\n\t\t\t\t\t$divVisibility = '';\n\t\t\t\t\t$selectVisibility = '';\n\t\t\t\t\tif (count($item['types']) == 1) {\n\t\t\t\t\t\t$selectVisibility = 'display:none;';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$divVisibility = 'style=\"display:none;\"';\n\t\t\t\t\t\tif (!in_array(array_keys($item['types']), $options)) $options[] = array_values($item['types']);\n\t\t\t\t\t}\n\t\t\t\t?>\n\t\t\t\t<div id = \"<?php echo 'Attribute' . $k . 'TypeStatic'; ?>\" <?php echo $divVisibility; ?> ><?php echo h($item['default_type']); ?></div>\n\t\t\t\t<select id = \"<?php echo 'Attribute' . $k . 'Type'; ?>\" class='typeToggle' style='padding:0px;height:20px;margin-bottom:0px;<?php echo $selectVisibility; ?>'>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tif (!empty($item['types'])) {\n\t\t\t\t\t\t\tforeach ($item['types'] as $type) {\n\t\t\t\t\t\t\t\techo '<option value=\"' . $type . '\" ';\n\t\t\t\t\t\t\t\techo ($type == $item['default_type'] ? 'selected=\"selected\"' : '') . '>' . $type . '</option>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t</td>\n\t\t\t<td class=\"short\" style=\"width:40px;text-align:center;\">\n\t\t\t\t<input type=\"checkbox\" id=\"<?php echo 'Attribute' . $k . 'To_ids'; ?>\" <?php if ($item['to_ids']) echo 'checked'; ?> class=\"idsCheckbox\" />\n\t\t\t</td>\n\t\t\t<td class=\"short\" style=\"width:40px;text-align:center;\">\n\t\t\t\t<select id = \"<?php echo 'Attribute' . $k . 'Distribution'; ?>\" class='distributionToggle' style='padding:0px;height:20px;margin-bottom:0px;'>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tforeach ($distributions as $distKey => $distValue) {\n\t\t\t\t\t\t\t$default = isset($item['distribution']) ? $item['distribution'] : $instanceDefault;\n\t\t\t\t\t\t\techo '<option value=\"' . $distKey . '\" ';\n\t\t\t\t\t\t\techo ($distKey == $default ? 'selected=\"selected\"' : '') . '>' . $distValue . '</option>';\n\t\t\t\t\t\t}\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t\t<div style=\"display:none;\">\n\t\t\t\t\t<select id = \"<?php echo 'Attribute' . $k . 'SharingGroupId'; ?>\" class='sgToggle' style='padding:0px;height:20px;margin-top:3px;margin-bottom:0px;'>\n\t\t\t\t\t\t<?php\n\t\t\t\t\t\t\tforeach ($sgs as $sgKey => $sgValue) {\n\t\t\t\t\t\t\t\techo '<option value=\"' . $sgKey . '\">' . $sgValue . '</option>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t?>\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<input type=\"text\" class=\"freetextCommentField\" id=\"<?php echo 'Attribute' . $k . 'Comment'; ?>\" style=\"padding:0px;height:20px;margin-bottom:0px;\" placeholder=\"<?php echo h($importComment); ?>\" <?php if (isset($item['comment']) && $item['comment'] !== false) echo 'value=\"' . $item['comment'] . '\"'?>/>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<input type=\"text\" class=\"freetextTagField\" id=\"<?php echo 'Attribute' . $k . 'Tags'; ?>\" style=\"padding:0px;height:20px;margin-bottom:0px;\"<?php if (isset($item['tags']) && $item['tags'] !== false) echo 'value=\"' . htmlspecialchars(implode(\",\",$item['tags'])) . '\"'?>/>\n\t\t\t</td>\n\t\t\t<td class=\"action short\">\n\t\t\t\t<span class=\"icon-remove pointer\" title=\"<?php echo __('Remove resolved attribute');?>\" role=\"button\" tabindex=\"0\" aria-label=\"<?php echo __('Remove resolved attribute');?>\" onClick=\"freetextRemoveRow('<?php echo $k; ?>', '<?php echo $event['Event']['id']; ?>');\"></span>\n\t\t\t</td>\n\t\t</tr>\n\t<?php\n\t\tendforeach;\n\t\t$optionsRearranged = array();\n\t\tforeach ($options as $group) {\n\t\t\tforeach ($group as $k => $element) {\n\t\t\t\t$temp = $group;\n\t\t\t\tunset($temp[$k]);\n\t\t\t\tif (!isset($optionsRearranged[$element])) $optionsRearranged[$element] = array();\n\t\t\t\t$optionsRearranged[$element] = array_merge($optionsRearranged[$element], $temp);\n\t\t\t}\n\t\t}\n\t?>\n\t</table>\n\t<span>\n\t\t<button class=\"btn btn-primary\" style=\"float:left;\" onClick=\"freetextImportResultsSubmit('<?php echo h($event['Event']['id']); ?>', '<?php echo count($resultArray); ?>');\"><?php echo __('Submit %s', $scope);?></button>\n\t\t<span style=\"float:right\">\n\t\t\t<?php\n\t\t\t\tif (!empty($optionsRearranged)):\n\t\t\t?>\n\t\t\t\t<select id=\"changeFrom\" style=\"margin-left:50px;margin-top:10px;\">\n\t\t\t\t\t<?php\n\t\t\t\t\t\tforeach (array_keys($optionsRearranged) as $fromElement):\n\t\t\t\t\t?>\n\t\t\t\t\t\t\t<option><?php echo $fromElement; ?></option>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tendforeach;\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t\t<span class=\"icon-arrow-right\"></span>\n\t\t\t\t<select id=\"changeTo\" style=\"margin-top:10px;\">\n\t\t\t\t\t<?php\n\t\t\t\t\t\t$keys = array_keys($optionsRearranged);\n\t\t\t\t\t\tforeach ($optionsRearranged[$keys[0]] as $toElement):\n\t\t\t\t\t?>\n\t\t\t\t\t\t\t<option value=\"<?php echo $toElement; ?>\"><?php echo $toElement; ?></option>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tendforeach;\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t\t<span role=\"button\" tabindex=\"0\" aria-label=\"<?php echo __('Apply changes to all applicable resolved attributes');?>\" title=\"<?php echo __('Apply changes to all applicable resolved attributes');?>\" class=\"btn btn-inverse\" onClick=\"changeFreetextImportExecute();\"><?php echo __('Change all');?></span><br />\n\t\t\t<?php endif; ?>\n\t\t\t<input type=\"text\" id=\"changeComments\" style=\"margin-left:50px;margin-top:10px;width:446px;\" placeholder=\"<?php echo __('Update all comment fields');?>\">\n\t\t\t<span role=\"button\" tabindex=\"0\" aria-label=\"<?php echo __('Change all');?>\" title=\"<?php echo __('Change all');?>\" class=\"btn btn-inverse\" onClick=\"changeFreetextImportCommentExecute();\"><?php echo __('Change all');?></span>\n\t\t</span>\n\t</span>\n</div>\n\t<script>\n\t\tvar options = <?php echo json_encode($optionsRearranged);?>;\n\t\tvar typeCategoryMapping = <?php echo json_encode($typeCategoryMapping); ?>;\n\t\t$(document).ready(function() {\n\t\t\tpopoverStartup();\n\t\t\t$('.typeToggle').on('change', function() {\n\t\t\t\tvar currentId = $(this).attr('id');\n\t\t\t\tvar selected = $(this).val();\n\t\t\t\tcurrentId = currentId.replace('Type', 'Category');\n\t\t\t\tvar currentOptions = typeCategoryMapping[selected];\n\t\t\t\t/*\n\t\t\t\t// Coming soon - restrict further if a list of categories is passed by the modules / freetext import tool\n\t\t\t\tif ($('#' + currentId)).data('category-restrictions') {\n\t\t\t\t\tvar category_restrictions = $('#' + currentId)).data('category-restrictions');\n\t\t\t\t\tcurrentOptions.forEach(function(category) {\n\t\t\t\t\t\tvar found = False;\n\t\t\t\t\t\tcategory_restrictions.forEach(function(restricted_category) {\n\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tcurrentOptions.forEach() {\n\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t*/\n\t\t\t\t$('#' + currentId).empty();\n\t\t\t\tfor (var category in currentOptions) {\n\t\t\t\t\t$('#' + currentId).append($(\"<option></option>\").attr(\"value\", category).text(category));\n\t\t\t\t}\n\t\t\t});\n\t\t<?php\n\t\t\tif (!empty($optionsRearranged)):\n\t\t?>\n\t\t\t\t$('#changeFrom').change(function(){\n\t\t\t\t\tchangeFreetextImportFrom();\n\t\t\t\t});\n\t\t\t\t$('#changeFrom').trigger('change');\n\t\t<?php\n\t\t\tendif;\n\t\t?>\n\t\t\t$('#checkAll').change(function() {\n\t\t\t\t$('.idsCheckbox').prop('checked', $('#checkAll').is(':checked'));\n\t\t\t});\n\t\t\t$('.distributionToggle').change(function() {\n\t\t\t\tif ($(this).val() == 4) {\n\t\t\t\t\t$(this).next().show();\n\t\t\t\t} else {\n\t\t\t\t\t$(this).next().hide();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t</script>\n<?php\n\techo $this->element('side_menu', array('menuList' => 'event', 'menuItem' => 'freetextResults'));\n?>\n"], "fixing_code": ["<div class=\"index\">\n\t<h2><?php echo h($title); ?></h2>\n\t<?php $scope = !empty($proposals) ? 'proposals' : 'attributes'; ?>\n\t<p><?php echo __('Below you can see the %s that are to be created. Make sure that the categories and the types are correct, often several options will be offered based on an inconclusive automatic resolution.', $scope);?></p>\n\t<?php\n\t\t$instanceDefault = 5;\n\t\tif (!empty(Configure::read('MISP.default_attribute_distribution'))) {\n\t\t\tif (Configure::read('MISP.default_attribute_distribution') == 'event') {\n\t\t\t\t$instanceDefault = 5;\n\t\t\t} else {\n\t\t\t\t$instanceDefault = Configure::read('MISP.default_attribute_distribution');\n\t\t\t}\n\t\t}\n\t\techo $this->Form->create('Attribute', array('url' => '/events/saveFreeText/' . $event['Event']['id'], 'class' => 'mainForm'));\n\t\tif ($isSiteAdmin) {\n\t\t\techo $this->Form->input('force', array(\n\t\t\t\t\t'checked' => false,\n\t\t\t\t\t'label' => __('Proposals instead of attributes'),\n\t\t\t));\n\t\t}\n\t\techo $this->Form->input('JsonObject', array(\n\t\t\t\t'label' => false,\n\t\t\t\t'type' => 'text',\n\t\t\t\t'style' => 'display:none;',\n\t\t\t\t'value' => '',\n\t\t));\n\t\techo $this->Form->input('default_comment', array(\n\t\t\t\t'label' => false,\n\t\t\t\t'type' => 'text',\n\t\t\t\t'style' => 'display:none;',\n\t\t\t\t'value' => $importComment,\n\t\t));\n\t\techo $this->Form->end();\n\t?>\n\t<table class=\"table table-striped table-hover table-condensed\">\n\t\t<tr>\n\t\t\t\t<th><?php echo __('Value');?></th>\n\t\t\t\t<th><?php echo __('Similar Attributes');?></th>\n\t\t\t\t<th><?php echo __('Category');?></th>\n\t\t\t\t<th><?php echo __('Type');?></th>\n\t\t\t\t<th><?php echo __('IDS');?><input type=\"checkbox\" id=\"checkAll\" style=\"margin:0px;margin-left:3px;\"/></th>\n\t\t\t\t<th><?php echo __('Distribution');?></th>\n\t\t\t\t<th><?php echo __('Comment');?></th>\n\t\t\t\t<th><?php echo __('Tags');?></th>\n\t\t\t\t<th><?php echo __('Actions');?></th>\n\t\t</tr>\n\t\t<?php\n\t\t\t$options = array();\n\t\t\tforeach ($resultArray as $k => $item):\n\t\t?>\n\t\t<tr id=\"row_<?php echo $k; ?>\" class=\"freetext_row\">\n\t\t\t<?php\n\t\t\t\techo $this->Form->input('Attribute' . $k . 'Save', array(\n\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t'style' => 'display:none;',\n\t\t\t\t\t\t'value' => 1,\n\t\t\t\t));\n\t\t\t\techo $this->Form->input('Attribute' . $k . 'Data', array(\n\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t'type' => 'hidden',\n\t\t\t\t\t\t'value' => isset($item['data']) ? $item['data'] : false,\n\t\t\t\t));\n\t\t\t\techo $this->Form->input('Attribute' . $k . 'DataIsHandled', array(\n\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t'type' => 'hidden',\n\t\t\t\t\t\t'value' => isset($item['data_is_handled']) ? h($item['data_is_handled']) : false,\n\t\t\t\t));\n\t\t\t?>\n\t\t\t<td>\n\t\t\t\t<?php\n\t\t\t\t\techo $this->Form->input('Attribute' . $k . 'Value', array(\n\t\t\t\t\t\t\t'label' => false,\n\t\t\t\t\t\t\t'value' => $item['value'],\n\t\t\t\t\t\t\t'style' => 'padding:0px;height:20px;margin-bottom:0px;width:90%;min-width:400px;',\n\t\t\t\t\t\t\t'div' => false\n\t\t\t\t\t));\n\t\t\t\t?>\n\t\t\t\t<input type=\"hidden\" id=\"<?php echo 'Attribute' . $k . 'Save'; ?>\" value=1 >\n\t\t\t</td>\n\t\t\t<td class=\"shortish\">\n\t\t\t\t<?php\n\t\t\t\t\tforeach ($item['related'] as $relation):\n\t\t\t\t\t\t$popover = array(\n\t\t\t\t\t\t\t'Event ID' => $relation['Event']['id'],\n\t\t\t\t\t\t\t'Event Info' => $relation['Event']['info'],\n\t\t\t\t\t\t\t'Category' => $relation['Attribute']['category'],\n\t\t\t\t\t\t\t'Type' => $relation['Attribute']['type'],\n\t\t\t\t\t\t\t'Value' => $relation['Attribute']['value'],\n\t\t\t\t\t\t\t'Comment' => $relation['Attribute']['comment'],\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$popoverHTML = '';\n\t\t\t\t\t\tforeach ($popover as $key => $popoverElement) {\n\t\t\t\t\t\t\t$popoverHTML .= '<span class=\\'bold\\'>' . $key . '</span>: <span class=\\'blue bold\\'>' . $popoverElement . '</span><br />';\n\t\t\t\t\t\t}\n\t\t\t\t?>\n\t\t\t\t\t\t<a href=\"<?php echo $baseurl; ?>/events/view/<?php echo h($relation['Event']['id']);?>\" data-toggle=\"popover\" title=\"Attribute details\" data-content=\"<?php echo h($popoverHTML); ?>\" data-trigger=\"hover\"><?php echo h($relation['Event']['id']);?></a>\n\t\t\t\t<?php\n\t\t\t\t\tendforeach;\n\t\t\t\t\t$correlationPopover = array('<span>', );\n\t\t\t\t?>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<?php\n\t\t\t\t\tif (!isset($item['categories'])) {\n\t\t\t\t\t\tif (isset($defaultCategories[$item['default_type']])) {\n\t\t\t\t\t\t\t$default = array_search($defaultCategories[$item['default_type']], $typeCategoryMapping[$item['default_type']]);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treset($typeCategoryMapping[$item['default_type']]);\n\t\t\t\t\t\t\t$default = key($typeCategoryMapping[$item['default_type']]);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (isset($item['category_default'])) $default = $item['category_default'];\n\t\t\t\t\t\telse $default = array_search($item['categories'][0], $typeCategoryMapping[$item['default_type']]);\n\n\t\t\t\t\t}\n\t\t\t\t?>\n\t\t\t\t<select id=\"<?php echo 'Attribute' . $k . 'Category'; ?>\" style='padding:0px;height:20px;margin-bottom:0px;' class=\"categoryToggle\">\n\t\t\t\t\t<?php\n\t\t\t\t\t\tforeach ($typeCategoryMapping[$item['default_type']] as $category) {\n\t\t\t\t\t\t\tif (isset($item['categories']) && !in_array($category, $item['categories'])) {\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\techo '<option value=\"' . $category . '\" ';\n\t\t\t\t\t\t\tif ($category == $default) echo 'selected=\"selected\"';\n\t\t\t\t\t\t\techo '>' . $category . '</option>';\n\t\t\t\t\t\t}\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<?php\n\t\t\t\t\t$divVisibility = '';\n\t\t\t\t\t$selectVisibility = '';\n\t\t\t\t\tif (count($item['types']) == 1) {\n\t\t\t\t\t\t$selectVisibility = 'display:none;';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$divVisibility = 'style=\"display:none;\"';\n\t\t\t\t\t\tif (!in_array(array_keys($item['types']), $options)) $options[] = array_values($item['types']);\n\t\t\t\t\t}\n\t\t\t\t?>\n\t\t\t\t<div id = \"<?php echo 'Attribute' . $k . 'TypeStatic'; ?>\" <?php echo $divVisibility; ?> ><?php echo h($item['default_type']); ?></div>\n\t\t\t\t<select id = \"<?php echo 'Attribute' . $k . 'Type'; ?>\" class='typeToggle' style='padding:0px;height:20px;margin-bottom:0px;<?php echo $selectVisibility; ?>'>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tif (!empty($item['types'])) {\n\t\t\t\t\t\t\tforeach ($item['types'] as $type) {\n\t\t\t\t\t\t\t\techo '<option value=\"' . h($type) . '\" ';\n\t\t\t\t\t\t\t\techo ($type == $item['default_type'] ? 'selected=\"selected\"' : '') . '>' . h($type) . '</option>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t</td>\n\t\t\t<td class=\"short\" style=\"width:40px;text-align:center;\">\n\t\t\t\t<input type=\"checkbox\" id=\"<?php echo 'Attribute' . $k . 'To_ids'; ?>\" <?php if ($item['to_ids']) echo 'checked'; ?> class=\"idsCheckbox\" />\n\t\t\t</td>\n\t\t\t<td class=\"short\" style=\"width:40px;text-align:center;\">\n\t\t\t\t<select id = \"<?php echo 'Attribute' . $k . 'Distribution'; ?>\" class='distributionToggle' style='padding:0px;height:20px;margin-bottom:0px;'>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tforeach ($distributions as $distKey => $distValue) {\n\t\t\t\t\t\t\t$default = isset($item['distribution']) ? $item['distribution'] : $instanceDefault;\n\t\t\t\t\t\t\techo '<option value=\"' . $distKey . '\" ';\n\t\t\t\t\t\t\techo ($distKey == $default ? 'selected=\"selected\"' : '') . '>' . $distValue . '</option>';\n\t\t\t\t\t\t}\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t\t<div style=\"display:none;\">\n\t\t\t\t\t<select id = \"<?php echo 'Attribute' . $k . 'SharingGroupId'; ?>\" class='sgToggle' style='padding:0px;height:20px;margin-top:3px;margin-bottom:0px;'>\n\t\t\t\t\t\t<?php\n\t\t\t\t\t\t\tforeach ($sgs as $sgKey => $sgValue) {\n\t\t\t\t\t\t\t\techo '<option value=\"' . h($sgKey) . '\">' . h($sgValue) . '</option>';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t?>\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<input type=\"text\" class=\"freetextCommentField\" id=\"<?php echo 'Attribute' . $k . 'Comment'; ?>\" style=\"padding:0px;height:20px;margin-bottom:0px;\" placeholder=\"<?php echo h($importComment); ?>\" <?php if (isset($item['comment']) && $item['comment'] !== false) echo 'value=\"' . h($item['comment']) . '\"'?>/>\n\t\t\t</td>\n\t\t\t<td class=\"short\">\n\t\t\t\t<input type=\"text\" class=\"freetextTagField\" id=\"<?php echo 'Attribute' . $k . 'Tags'; ?>\" style=\"padding:0px;height:20px;margin-bottom:0px;\"<?php if (isset($item['tags']) && $item['tags'] !== false) echo 'value=\"' . h(implode(\",\",$item['tags'])) . '\"'?>/>\n\t\t\t</td>\n\t\t\t<td class=\"action short\">\n\t\t\t\t<span class=\"icon-remove pointer\" title=\"<?php echo __('Remove resolved attribute');?>\" role=\"button\" tabindex=\"0\" aria-label=\"<?php echo __('Remove resolved attribute');?>\" onClick=\"freetextRemoveRow('<?php echo $k; ?>', '<?php echo $event['Event']['id']; ?>');\"></span>\n\t\t\t</td>\n\t\t</tr>\n\t<?php\n\t\tendforeach;\n\t\t$optionsRearranged = array();\n\t\tforeach ($options as $group) {\n\t\t\tforeach ($group as $k => $element) {\n\t\t\t\t$temp = $group;\n\t\t\t\tunset($temp[$k]);\n\t\t\t\tif (!isset($optionsRearranged[$element])) $optionsRearranged[$element] = array();\n\t\t\t\t$optionsRearranged[$element] = array_merge($optionsRearranged[$element], $temp);\n\t\t\t}\n\t\t}\n\t?>\n\t</table>\n\t<span>\n\t\t<button class=\"btn btn-primary\" style=\"float:left;\" onClick=\"freetextImportResultsSubmit('<?php echo h($event['Event']['id']); ?>', '<?php echo count($resultArray); ?>');\"><?php echo __('Submit %s', $scope);?></button>\n\t\t<span style=\"float:right\">\n\t\t\t<?php\n\t\t\t\tif (!empty($optionsRearranged)):\n\t\t\t?>\n\t\t\t\t<select id=\"changeFrom\" style=\"margin-left:50px;margin-top:10px;\">\n\t\t\t\t\t<?php\n\t\t\t\t\t\tforeach (array_keys($optionsRearranged) as $fromElement):\n\t\t\t\t\t?>\n\t\t\t\t\t\t\t<option><?php echo h($fromElement); ?></option>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tendforeach;\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t\t<span class=\"icon-arrow-right\"></span>\n\t\t\t\t<select id=\"changeTo\" style=\"margin-top:10px;\">\n\t\t\t\t\t<?php\n\t\t\t\t\t\t$keys = array_keys($optionsRearranged);\n\t\t\t\t\t\tforeach ($optionsRearranged[$keys[0]] as $toElement):\n\t\t\t\t\t?>\n\t\t\t\t\t\t\t<option value=\"<?php echo $toElement; ?>\"><?php echo $toElement; ?></option>\n\t\t\t\t\t<?php\n\t\t\t\t\t\tendforeach;\n\t\t\t\t\t?>\n\t\t\t\t</select>\n\t\t\t\t<span role=\"button\" tabindex=\"0\" aria-label=\"<?php echo __('Apply changes to all applicable resolved attributes');?>\" title=\"<?php echo __('Apply changes to all applicable resolved attributes');?>\" class=\"btn btn-inverse\" onClick=\"changeFreetextImportExecute();\"><?php echo __('Change all');?></span><br />\n\t\t\t<?php endif; ?>\n\t\t\t<input type=\"text\" id=\"changeComments\" style=\"margin-left:50px;margin-top:10px;width:446px;\" placeholder=\"<?php echo __('Update all comment fields');?>\">\n\t\t\t<span role=\"button\" tabindex=\"0\" aria-label=\"<?php echo __('Change all');?>\" title=\"<?php echo __('Change all');?>\" class=\"btn btn-inverse\" onClick=\"changeFreetextImportCommentExecute();\"><?php echo __('Change all');?></span>\n\t\t</span>\n\t</span>\n</div>\n\t<script>\n\t\tvar options = <?php echo json_encode($optionsRearranged);?>;\n\t\tvar typeCategoryMapping = <?php echo json_encode($typeCategoryMapping); ?>;\n\t\t$(document).ready(function() {\n\t\t\tpopoverStartup();\n\t\t\t$('.typeToggle').on('change', function() {\n\t\t\t\tvar currentId = $(this).attr('id');\n\t\t\t\tvar selected = $(this).val();\n\t\t\t\tcurrentId = currentId.replace('Type', 'Category');\n\t\t\t\tvar currentOptions = typeCategoryMapping[selected];\n\t\t\t\t/*\n\t\t\t\t// Coming soon - restrict further if a list of categories is passed by the modules / freetext import tool\n\t\t\t\tif ($('#' + currentId)).data('category-restrictions') {\n\t\t\t\t\tvar category_restrictions = $('#' + currentId)).data('category-restrictions');\n\t\t\t\t\tcurrentOptions.forEach(function(category) {\n\t\t\t\t\t\tvar found = False;\n\t\t\t\t\t\tcategory_restrictions.forEach(function(restricted_category) {\n\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tcurrentOptions.forEach() {\n\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t*/\n\t\t\t\t$('#' + currentId).empty();\n\t\t\t\tfor (var category in currentOptions) {\n\t\t\t\t\t$('#' + currentId).append($(\"<option></option>\").attr(\"value\", category).text(category));\n\t\t\t\t}\n\t\t\t});\n\t\t<?php\n\t\t\tif (!empty($optionsRearranged)):\n\t\t?>\n\t\t\t\t$('#changeFrom').change(function(){\n\t\t\t\t\tchangeFreetextImportFrom();\n\t\t\t\t});\n\t\t\t\t$('#changeFrom').trigger('change');\n\t\t<?php\n\t\t\tendif;\n\t\t?>\n\t\t\t$('#checkAll').change(function() {\n\t\t\t\t$('.idsCheckbox').prop('checked', $('#checkAll').is(':checked'));\n\t\t\t});\n\t\t\t$('.distributionToggle').change(function() {\n\t\t\t\tif ($(this).val() == 4) {\n\t\t\t\t\t$(this).next().show();\n\t\t\t\t} else {\n\t\t\t\t\t$(this).next().hide();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t</script>\n<?php\n\techo $this->element('side_menu', array('menuList' => 'event', 'menuItem' => 'freetextResults'));\n?>\n"], "filenames": ["app/View/Events/resolved_attributes.ctp"], "buggy_code_start_loc": [146], "buggy_code_end_loc": [210], "fixing_code_start_loc": [146], "fixing_code_end_loc": [210], "type": "CWE-79", "message": "In MISP before 2.4.89, app/View/Events/resolved_attributes.ctp has multiple XSS issues via a malicious MISP module.", "other": {"cve": {"id": "CVE-2018-8948", "sourceIdentifier": "cve@mitre.org", "published": "2018-03-23T17:29:00.273", "lastModified": "2018-04-13T18:43:02.127", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "In MISP before 2.4.89, app/View/Events/resolved_attributes.ctp has multiple XSS issues via a malicious MISP module."}, {"lang": "es", "value": "En versiones anteriores a la 2.4.89 de MISP, app/View/Events/resolved_attributes.ctp presenta m\u00faltiples problemas de Cross-Site Scripting (XSS) debido a un m\u00f3dulo MISP malicioso."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:misp-project:misp:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.4.89", "matchCriteriaId": "AE728CC9-A690-4960-B9D6-B3AD09424F7B"}]}]}], "references": [{"url": "https://github.com/MISP/MISP/commit/01924cd948dbceb8391be671dab672e9f4a0ffe8", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/MISP/MISP/commit/01924cd948dbceb8391be671dab672e9f4a0ffe8"}}