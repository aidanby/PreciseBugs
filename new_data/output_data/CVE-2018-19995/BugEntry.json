{"buggy_code": ["<?php\n/* Copyright (C) 2002-2006 Rodolphe Quiedeville <rodolphe@quiedeville.org>\n * Copyright (C) 2002-2003 Jean-Louis Bergamo   <jlb@j1b.org>\n * Copyright (C) 2004-2015 Laurent Destailleur  <eldy@users.sourceforge.net>\n * Copyright (C) 2004      Eric Seigne          <eric.seigne@ryxeo.com>\n * Copyright (C) 2005-2018 Regis Houssin        <regis.houssin@capnetworks.com>\n * Copyright (C) 2005      Lionel Cousteix      <etm_ltd@tiscali.co.uk>\n * Copyright (C) 2011      Herve Prot           <herve.prot@symeos.com>\n * Copyright (C) 2012-2018 Juanjo Menent        <jmenent@2byte.es>\n * Copyright (C) 2013      Florian Henry        <florian.henry@open-concept.pro>\n * Copyright (C) 2013-2016 Alexandre Spangaro   <aspangaro.dolibarr@gmail.com>\n * Copyright (C) 2015-2017 Jean-Fran\u00e7ois Ferry  <jfefe@aternatik.fr>\n * Copyright (C) 2015      Ari Elbaz (elarifr)  <github@accedinfo.com>\n * Copyright (C) 2015      Charlie Benke        <charlie@patas-monkey.com>\n * Copyright (C) 2016      Rapha\u00ebl Doursenaud   <rdoursenaud@gpcsolutions.fr>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n *       \\file       htdocs/user/card.php\n *       \\brief      Tab of user card\n */\n\nrequire '../main.inc.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/usergroup.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/contact/class/contact.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/images.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/usergroups.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/extrafields.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formother.class.php';\nif (! empty($conf->ldap->enabled)) require_once DOL_DOCUMENT_ROOT.'/core/class/ldap.class.php';\nif (! empty($conf->adherent->enabled)) require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';\nif (! empty($conf->categorie->enabled)) require_once DOL_DOCUMENT_ROOT.'/categories/class/categorie.class.php';\n\n$id\t\t\t= GETPOST('id','int');\n$action\t\t= GETPOST('action','aZ09');\n$mode\t\t= GETPOST('mode','alpha');\n$confirm\t= GETPOST('confirm','alpha');\n$subaction\t= GETPOST('subaction','alpha');\n$group\t\t= GETPOST(\"group\",\"int\",3);\n$cancel\t\t= GETPOST('cancel','alpha');\n$contextpage= GETPOST('contextpage','aZ')?GETPOST('contextpage','aZ'):'useracard';   // To manage different context of search\n\n// Define value to know what current user can do on users\n$canadduser=(! empty($user->admin) || $user->rights->user->user->creer);\n$canreaduser=(! empty($user->admin) || $user->rights->user->user->lire);\n$canedituser=(! empty($user->admin) || $user->rights->user->user->creer);\n$candisableuser=(! empty($user->admin) || $user->rights->user->user->supprimer);\n$canreadgroup=$canreaduser;\n$caneditgroup=$canedituser;\nif (! empty($conf->global->MAIN_USE_ADVANCED_PERMS))\n{\n\t$canreadgroup=(! empty($user->admin) || $user->rights->user->group_advance->read);\n\t$caneditgroup=(! empty($user->admin) || $user->rights->user->group_advance->write);\n}\n\n// Define value to know what current user can do on properties of edited user\nif ($id)\n{\n\t// $user est le user qui edite, $id est l'id de l'utilisateur edite\n\t$caneditfield=((($user->id == $id) && $user->rights->user->self->creer)\n\t|| (($user->id != $id) && $user->rights->user->user->creer));\n\t$caneditpassword=((($user->id == $id) && $user->rights->user->self->password)\n\t|| (($user->id != $id) && $user->rights->user->user->password));\n}\n\n// Security check\n$socid=0;\nif ($user->societe_id > 0) $socid = $user->societe_id;\n$feature2='user';\nif ($user->id == $id) { $feature2=''; $canreaduser=1; } // A user can always read its own card\nif (!$canreaduser) {\n\t$result = restrictedArea($user, 'user', $id, 'user&user', $feature2);\n}\nif ($user->id <> $id && ! $canreaduser) accessforbidden();\n\n// Load translation files required by page\n$langs->loadLangs(array('users', 'companies', 'ldap', 'admin', 'hrm'));\n\n$object = new User($db);\n$extrafields = new ExtraFields($db);\n\n// fetch optionals attributes and labels\n$extralabels=$extrafields->fetch_name_optionals_label($object->table_element);\n\n// Initialize technical object to manage hooks. Note that conf->hooks_modules contains array\n$hookmanager->initHooks(array('usercard','globalcard'));\n\n\n\n/**\n * Actions\n */\n\n$parameters=array('id' => $id, 'socid' => $socid, 'group' => $group, 'caneditgroup' => $caneditgroup);\n$reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks\nif ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');\n\nif (empty($reshook)) {\n\n\tif ($action == 'confirm_disable' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id <> $user->id) {\n\t\t\t$object->fetch($id);\n\t\t\t$object->setstatus(0);\n\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\texit;\n\t\t}\n\t}\n\tif ($action == 'confirm_enable' && $confirm == \"yes\" && $candisableuser) {\n\t\t$error = 0;\n\n\t\tif ($id <> $user->id) {\n\t\t\t$object->fetch($id);\n\n\t\t\tif (!empty($conf->file->main_limit_users)) {\n\t\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t\t$error ++;\n\t\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$error) {\n\t\t\t\t$object->setstatus(1);\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'confirm_delete' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id <> $user->id) {\n\t\t\t$object = new User($db);\n\t\t\t$object->fetch($id);\n\t\t\t$result = $object->delete();\n\t\t\tif ($result < 0) {\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\tsetEventMessages($langs->trans(\"ErrorUserCannotBeDelete\"), null, 'errors');\n\t\t\t} else {\n\t\t\t\theader(\"Location: \".DOL_URL_ROOT.\"/user/list.php?restore_lastsearch_values=1\");\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action Add user\n\tif ($action == 'add' && $canadduser) {\n\t\t$error = 0;\n\n\t\tif (!$_POST[\"lastname\"]) {\n\t\t\t$error ++;\n\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\";       // Go back to create page\n\t\t}\n\t\tif (!$_POST[\"login\"]) {\n\t\t\t$error ++;\n\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\";       // Go back to create page\n\t\t}\n\n\t\tif (!empty($conf->file->main_limit_users)) { // If option to limit users is set\n\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t$error ++;\n\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t$action = \"create\";       // Go back to create page\n\t\t\t}\n\t\t}\n\n\t\tif (!$error) {\n\t\t\t$object->lastname = GETPOST(\"lastname\", 'alpha');\n\t\t\t$object->firstname = GETPOST(\"firstname\", 'alpha');\n\t\t\t$object->login = GETPOST(\"login\", 'alpha');\n\t\t\t$object->api_key = GETPOST(\"api_key\", 'alpha');\n\t\t\t$object->gender = GETPOST(\"gender\", 'alpha');\n\t\t\t$birth = dol_mktime(0, 0, 0, GETPOST('birthmonth'), GETPOST('birthday'), GETPOST('birthyear'));\n\t\t\t$object->birth = $birth;\n\t\t\t$object->admin = GETPOST(\"admin\", 'alpha');\n\t\t\t$object->address = GETPOST('address', 'alpha');\n\t\t\t$object->zip = GETPOST('zipcode', 'alpha');\n\t\t\t$object->town = GETPOST('town', 'alpha');\n\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alpha');\n\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alpha');\n\t\t\t$object->user_mobile = GETPOST(\"user_mobile\");\n\t\t\t$object->skype = GETPOST(\"skype\", 'alpha');\n\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alpha'));\n\t\t\t$object->job = GETPOST(\"job\", 'alpha');\n\t\t\t$object->signature = GETPOST(\"signature\");\n\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\");\n\t\t\t$object->note = GETPOST(\"note\");\n\t\t\t$object->ldap_sid = GETPOST(\"ldap_sid\");\n\t\t\t$object->fk_user = GETPOST(\"fk_user\") > 0 ? GETPOST(\"fk_user\") : 0;\n\t\t\t$object->employee = GETPOST('employee');\n\n\t\t\t$object->thm = GETPOST(\"thm\") != '' ? GETPOST(\"thm\") : '';\n\t\t\t$object->tjm = GETPOST(\"tjm\") != '' ? GETPOST(\"tjm\") : '';\n\t\t\t$object->salary = GETPOST(\"salary\") != '' ? GETPOST(\"salary\") : '';\n\t\t\t$object->salaryextra = GETPOST(\"salaryextra\") != '' ? GETPOST(\"salaryextra\") : '';\n\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\") != '' ? GETPOST(\"weeklyhours\") : '';\n\n\t\t\t$object->color = GETPOST(\"color\") != '' ? GETPOST(\"color\") : '';\n\t\t\t$dateemployment = dol_mktime(0, 0, 0, GETPOST('dateemploymentmonth'), GETPOST('dateemploymentday'), GETPOST('dateemploymentyear'));\n\t\t\t$object->dateemployment = $dateemployment;\n\n\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t$ret = $extrafields->setOptionalsFromPost($extralabels, $object);\n\t\t\tif ($ret < 0) {\n\t\t\t\t$error ++;\n\t\t\t}\n\n\t\t\t// Set entity property\n\t\t\t$entity = GETPOST('entity', 'int');\n\t\t\tif (! empty($conf->multicompany->enabled)) {\n\t\t\t\tif (GETPOST('superadmin', 'int')) {\n\t\t\t\t\t$object->entity = 0;\n\t\t\t\t} else {\n\t\t\t\t\tif (! empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t\t\t\t$object->entity = 1; // all users are forced into master entity\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t/*if ($user->admin && $user->entity == 0 && GETPOST(\"admin\",'alpha'))\n\t\t\t\t{\n\t\t\t\t}*/\n\t\t\t}\n\n\t\t\t$db->begin();\n\n\t\t\t$id = $object->create($user);\n\t\t\tif ($id > 0) {\n\t\t\t\tif (GETPOST('password')) {\n\t\t\t\t\t$object->setPassword($user, GETPOST('password'));\n\t\t\t\t}\n\t\t\t\t\t\tif (! empty($conf->categorie->enabled)) {\n\t\t\t\t\t// Categories association\n\t\t\t\t\t$usercats = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($usercats);\n\t\t\t\t}\n\t\t\t\t$db->commit();\n\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t$db->rollback();\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t$action = \"create\";       // Go back to create page\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action add usergroup\n\tif (($action == 'addgroup' || $action == 'removegroup') && $caneditgroup)\n\t{\n\t\tif ($group)\n\t\t{\n\t\t\t$editgroup = new UserGroup($db);\n\t\t\t$editgroup->fetch($group);\n\t\t\t$editgroup->oldcopy=clone $editgroup;\n\n\t\t\t$object->fetch($id);\n\t\t\tif ($action == 'addgroup') {\n\t\t\t\t$result = $object->SetInGroup($group, $editgroup->entity);\n\t\t\t}\n\t\t\tif ($action == 'removegroup') {\n\t\t\t\t$result = $object->RemoveFromGroup($group, $editgroup->entity);\n\t\t\t}\n\n\t\t\tif ($result > 0) {\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'update' && ! $cancel)\n\t{\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';\n\n\t\tif ($caneditfield)    // Case we can edit all field\n\t\t{\n\t\t\t$error = 0;\n\n\t\t\tif (!$_POST[\"lastname\"]) {\n\t\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\";       // Go back to create page\n\t\t\t\t$error ++;\n\t\t\t}\n\t\t\tif (!$_POST[\"login\"]) {\n\t\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\";       // Go back to create page\n\t\t\t\t$error ++;\n\t\t\t}\n\n\t\t\tif (!$error)\n\t\t\t{\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t$db->begin();\n\n\t\t\t\t$object->lastname = GETPOST(\"lastname\", 'alpha');\n\t\t\t\t$object->firstname = GETPOST(\"firstname\", 'alpha');\n\t\t\t\t$object->login = GETPOST(\"login\", 'alpha');\n\t\t\t\t$object->gender = GETPOST(\"gender\", 'alpha');\n\t\t\t\t$birth = dol_mktime(0, 0, 0, GETPOST('birthmonth'), GETPOST('birthday'), GETPOST('birthyear'));\n\t\t\t\t$object->birth = $birth;\n\t\t\t\t$object->pass = GETPOST(\"password\",'none');\n\t\t\t\t$object->api_key = (GETPOST(\"api_key\", 'alpha')) ? GETPOST(\"api_key\", 'alpha') : $object->api_key;\n\t\t\t\tif (! empty($user->admin)) $object->admin = GETPOST(\"admin\"); \t// admin flag can only be set/unset by an admin user. A test is also done later when forging sql request\n\t\t\t\t$object->address = GETPOST('address', 'alpha');\n\t\t\t\t$object->zip = GETPOST('zipcode', 'alpha');\n\t\t\t\t$object->town = GETPOST('town', 'alpha');\n\t\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alpha');\n\t\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alpha');\n\t\t\t\t$object->user_mobile = GETPOST(\"user_mobile\");\n\t\t\t\t$object->skype = GETPOST(\"skype\", 'alpha');\n\t\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alpha'));\n\t\t\t\t$object->job = GETPOST(\"job\", 'alpha');\n\t\t\t\t$object->signature = GETPOST(\"signature\",'none');\n\t\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\",'alpha');\n\t\t\t\t$object->openid = GETPOST(\"openid\",'alpha');\n\t\t\t\t$object->fk_user = GETPOST(\"fk_user\",'int') > 0 ? GETPOST(\"fk_user\",'int') : 0;\n\t\t\t\t$object->employee = GETPOST('employee');\n\n\t\t\t\t$object->thm = GETPOST(\"thm\",'alphanohtml') != '' ? GETPOST(\"thm\",'alphanohtml') : '';\n\t\t\t\t$object->tjm = GETPOST(\"tjm\",'alphanohtml') != '' ? GETPOST(\"tjm\",'alphanohtml') : '';\n\t\t\t\t$object->salary = GETPOST(\"salary\",'alphanohtml') != '' ? GETPOST(\"salary\",'alphanohtml') : '';\n\t\t\t\t$object->salaryextra = GETPOST(\"salaryextra\",'alphanohtml') != '' ? GETPOST(\"salaryextra\",'alphanohtml') : '';\n\t\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\",'alphanohtml') != '' ? GETPOST(\"weeklyhours\",'alphanohtml') : '';\n\n\t\t\t\t$object->color = GETPOST(\"color\",'alpha') != '' ? GETPOST(\"color\",'alpha') : '';\n\t\t\t\t$dateemployment = dol_mktime(0, 0, 0, GETPOST('dateemploymentmonth','int'), GETPOST('dateemploymentday','int'), GETPOST('dateemploymentyear','int'));\n\t\t\t\t$object->dateemployment = $dateemployment;\n\n\t\t\t\tif (! empty($conf->multicompany->enabled))\n\t\t\t\t{\n\t\t\t\t\tif (! empty($_POST[\"superadmin\"]))\n\t\t\t\t\t{\n\t\t\t\t\t\t$object->entity = 0;\n\t\t\t\t\t}\n\t\t\t\t\telse if (! empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE))\n\t\t\t\t\t{\n\t\t\t\t\t\t$object->entity = 1; // all users in master entity\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$object->entity = (! GETPOST('entity', 'int') ? 0 : GETPOST('entity', 'int'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$object->entity = (! GETPOST('entity', 'int') ? 0 : GETPOST('entity', 'int'));\n\t\t\t\t}\n\n\t\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t\t$ret = $extrafields->setOptionalsFromPost($extralabels, $object);\n\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t$error ++;\n\t\t\t\t}\n\n\t\t\t\tif (GETPOST('deletephoto')) {\n\t\t\t\t\t$object->photo = '';\n\t\t\t\t}\n\t\t\t\tif (!empty($_FILES['photo']['name'])) {\n\t\t\t\t\t$object->photo = dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t}\n\n\t\t\t\tif (!$error) {\n\t\t\t\t\t$ret = $object->update($user);\n\t\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\tif ($db->errno() == 'DB_ERROR_RECORD_ALREADY_EXISTS') {\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorLoginAlreadyExists\", $object->login), null, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && GETPOSTISSET('contactid')) {\n\t\t\t\t\t$contactid = GETPOST('contactid', 'int');\n\n\t\t\t\t\tif ($contactid > 0) {\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($contactid);\n\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=\".$db->escape($contactid);\n\t\t\t\t\t\tif (!empty($contact->socid)) {\n\t\t\t\t\t\t\t$sql .= \", fk_soc=\".$db->escape($contact->socid);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$sql .= \" WHERE rowid=\".$object->id;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=NULL, fk_soc=NULL\";\n\t\t\t\t\t\t$sql .= \" WHERE rowid=\".$object->id;\n\t\t\t\t\t}\n\t\t\t\t\tdol_syslog(\"usercard::update\", LOG_DEBUG);\n\t\t\t\t\t$resql = $db->query($sql);\n\t\t\t\t\tif (!$resql) {\n\t\t\t\t\t\t$error ++;\n\t\t\t\t\t\tsetEventMessages($db->lasterror(), null, 'errors');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tif (GETPOST('deletephoto') && $object->photo) {\n\t\t\t\t\t\t$fileimg = $conf->user->dir_output.'/'.get_exdir($object->id, 2, 0, 1, $object, 'user').'/logos/'.$object->photo;\n\t\t\t\t\t\t$dirthumbs = $conf->user->dir_output.'/'.get_exdir($object->id, 2, 0, 1, $object, 'user').'/logos/thumbs';\n\t\t\t\t\t\tdol_delete_file($fileimg);\n\t\t\t\t\t\tdol_delete_dir_recursive($dirthumbs);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isset($_FILES['photo']['tmp_name']) && trim($_FILES['photo']['tmp_name'])) {\n\t\t\t\t\t\t$dir = $conf->user->dir_output.'/'.get_exdir($object->id, 2, 0, 1, $object, 'user');\n\n\t\t\t\t\t\tdol_mkdir($dir);\n\n\t\t\t\t\t\tif (@is_dir($dir)) {\n\t\t\t\t\t\t\t$newfile = $dir.'/'.dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t\t\t\t$result = dol_move_uploaded_file($_FILES['photo']['tmp_name'], $newfile, 1, 0, $_FILES['photo']['error']);\n\n\t\t\t\t\t\t\tif (!$result > 0) {\n\t\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSaveFile\"), null, 'errors');\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// Create thumbs\n\t\t\t\t\t\t\t\t$object->addThumbs($newfile);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$error ++;\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToCreateDir\", $dir), $mesgs, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (! $error && ! count($object->errors))\n\t\t\t\t{\n\t\t\t\t\t// Then we add the associated categories\n\t\t\t\t\t$categories = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($categories);\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tsetEventMessages($langs->trans(\"UserModified\"), null, 'mesgs');\n\t\t\t\t\t$db->commit();\n\n\t\t\t\t\t$login = $_SESSION[\"dol_login\"];\n\t\t\t\t\tif ($login && $login == $object->oldcopy->login && $object->oldcopy->login != $object->login)    // Current user has changed its login\n\t\t\t\t\t{\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\tsetEventMessages($langs->transnoentitiesnoconv(\"WarningYourLoginWasModifiedPleaseLogin\"), null, 'warnings');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$db->rollback();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif ($caneditpassword)    // Case we can edit only password\n\t\t\t{\n\t\t\t\tdol_syslog(\"Not allowed to change fields, only password\");\n\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t$ret = $object->setPassword($user, GETPOST(\"password\"));\n\t\t\t\tif ($ret < 0)\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Change password with a new generated one\n\tif ((($action == 'confirm_password' && $confirm == 'yes')\n\t\t\t|| ($action == 'confirm_passwordsend' && $confirm == 'yes')) && $caneditpassword\n\t) {\n\t\t$object->fetch($id);\n\n\t\t$newpassword = $object->setPassword($user, '');\n\t\tif ($newpassword < 0) {\n\t\t\t// Echec\n\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSetNewPassword\"), null, 'errors');\n\t\t} else {\n\t\t\t// Succes\n\t\t\tif ($action == 'confirm_passwordsend' && $confirm == 'yes') {\n\t\t\t\tif ($object->send_password($user, $newpassword) > 0)\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedAndSentTo\", $object->email), null, 'mesgs');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedTo\", $newpassword), null, 'warnings');\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action initialisation donnees depuis record LDAP\n\tif ($action == 'adduserldap') {\n\t\t$selecteduser = $_POST['users'];\n\n\t\t$required_fields = array(\n\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t);\n\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0) {\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields = array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t$ldapusers = $ldap->getRecords($selecteduser, $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields);\n\t\t\t//print_r($ldapusers);\n\n\t\t\tif (is_array($ldapusers)) {\n\t\t\t\tforeach ($ldapusers as $key => $attribute) {\n\t\t\t\t\t$ldap_lastname = $attribute[$conf->global->LDAP_FIELD_NAME];\n\t\t\t\t\t$ldap_firstname = $attribute[$conf->global->LDAP_FIELD_FIRSTNAME];\n\t\t\t\t\t$ldap_login = $attribute[$conf->global->LDAP_FIELD_LOGIN];\n\t\t\t\t\t$ldap_loginsmb = $attribute[$conf->global->LDAP_FIELD_LOGIN_SAMBA];\n\t\t\t\t\t$ldap_pass = $attribute[$conf->global->LDAP_FIELD_PASSWORD];\n\t\t\t\t\t$ldap_pass_crypted = $attribute[$conf->global->LDAP_FIELD_PASSWORD_CRYPTED];\n\t\t\t\t\t$ldap_phone = $attribute[$conf->global->LDAP_FIELD_PHONE];\n\t\t\t\t\t$ldap_fax = $attribute[$conf->global->LDAP_FIELD_FAX];\n\t\t\t\t\t$ldap_mobile = $attribute[$conf->global->LDAP_FIELD_MOBILE];\n\t\t\t\t\t$ldap_skype = $attribute[$conf->global->LDAP_FIELD_SKYPE];\n\t\t\t\t\t$ldap_mail = $attribute[$conf->global->LDAP_FIELD_MAIL];\n\t\t\t\t\t$ldap_sid = $attribute[$conf->global->LDAP_FIELD_SID];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\t}\n\n\t// Actions to send emails\n\t$trigger_name='USER_SENTBYMAIL';\n\t$paramname='id';    // Name of param key to open the card\n\t$mode='emailfromuser';\n\t$trackid='use'.$id;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_sendmails.inc.php';\n\n\t// Actions to build doc\n\t$upload_dir = $conf->user->dir_output;\n\t$permissioncreate=$user->rights->user->user->creer;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_builddoc.inc.php';\n}\n\n\n/*\n * View\n */\n\n$form = new Form($db);\n$formother=new FormOther($db);\n$formcompany = new FormCompany($db);\n$formfile = new FormFile($db);\n\nllxHeader('',$langs->trans(\"UserCard\"));\n\nif ($action == 'create' || $action == 'adduserldap')\n{\n\t/* ************************************************************************** */\n\t/*                                                                            */\n\t/* Affichage fiche en mode creation                                           */\n\t/*                                                                            */\n\t/* ************************************************************************** */\n\n\tprint load_fiche_titre($langs->trans(\"NewUser\"));\n\n\tprint $langs->trans(\"CreateInternalUserDesc\").\"<br>\\n\";\n\tprint \"<br>\";\n\n\n\tif (! empty($conf->ldap->enabled) && (isset($conf->global->LDAP_SYNCHRO_ACTIVE) && $conf->global->LDAP_SYNCHRO_ACTIVE == 'ldap2dolibarr'))\n\t{\n\t\t/*\n         * Affiche formulaire d'ajout d'un compte depuis LDAP\n         * si on est en synchro LDAP vers Dolibarr\n         */\n\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0)\n\t\t{\n\t\t\t$required_fields=array(\n\t\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t\t$conf->global->LDAP_FIELD_FULLNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t\t);\n\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields=array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t// Get from LDAP database an array of results\n\t\t\t$ldapusers = $ldap->getRecords('*', $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields, 1);\n\n\t\t\tif (is_array($ldapusers))\n\t\t\t{\n\t\t\t\t$liste=array();\n\t\t\t\tforeach ($ldapusers as $key => $ldapuser)\n\t\t\t\t{\n\t\t\t\t\t// Define the label string for this user\n\t\t\t\t\t$label='';\n\t\t\t\t\tforeach ($required_fields as $value)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($value)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$label.=$value.\"=\".$ldapuser[$value].\" \";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$liste[$key] = $label;\n\t\t\t\t}\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\n\t\t// If user list is full, we show drop-down list\n\t   \tprint \"\\n\\n<!-- Form liste LDAP debut -->\\n\";\n\n\t   \tprint '<form name=\"add_user_ldap\" action=\"'.$_SERVER[\"PHP_SELF\"].'\" method=\"post\">';\n\t   \tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n\t   \tprint '<table width=\"100%\" class=\"border\"><tr>';\n\t   \tprint '<td width=\"160\">';\n\t   \tprint $langs->trans(\"LDAPUsers\");\n\t   \tprint '</td>';\n\t   \tprint '<td>';\n\t   \tprint '<input type=\"hidden\" name=\"action\" value=\"adduserldap\">';\n\t\tif (is_array($liste) && count($liste))\n\t\t{\n\t\t\tprint $form->selectarray('users', $liste, '', 1);\n\t\t\tprint ajax_combobox('users');\n\t\t}\n\t   \tprint '</td><td align=\"center\">';\n\t   \tprint '<input type=\"submit\" class=\"button\" value=\"'.dol_escape_htmltag($langs->trans('Get')).'\"'.(count($liste)?'':' disabled').'>';\n\t   \tprint '</td></tr></table>';\n\t   \tprint '</form>';\n\n\t   \tprint \"\\n<!-- Form liste LDAP fin -->\\n\\n\";\n\t   \tprint '<br>';\n\t}\n\n\n\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'\" method=\"POST\" name=\"createuser\">';\n\tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n\tprint '<input type=\"hidden\" name=\"action\" value=\"add\">';\n\tif (! empty($ldap_sid)) print '<input type=\"hidden\" name=\"ldap_sid\" value=\"'.dol_escape_htmltag($ldap_sid).'\">';\n\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\">';\n\n\tdol_fiche_head('', '', '', 0, '');\n\n\tprint dol_set_focus('#lastname');\n\n\tprint '<table class=\"border centpercent\">';\n\n\t// Lastname\n\tprint '<tr>';\n\tprint '<td class=\"titlefieldcreate\"><span class=\"fieldrequired\">'.$langs->trans(\"Lastname\").'</span></td>';\n\tprint '<td>';\n\tif (! empty($ldap_lastname))\n\t{\n\t\tprint '<input type=\"hidden\" id=\"lastname\" name=\"lastname\" value=\"'.$ldap_lastname.'\">';\n\t\tprint $ldap_lastname;\n\t}\n\telse\n\t{\n\t\tprint '<input class=\"minwidth100\" type=\"text\" id=\"lastname\" name=\"lastname\" value=\"'.GETPOST('lastname').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Firstname\n\tprint '<tr><td>'.$langs->trans(\"Firstname\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_firstname))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.$ldap_firstname.'\">';\n\t\tprint $ldap_firstname;\n\t}\n\telse\n\t{\n\t\tprint '<input class=\"minwidth100\" type=\"text\" name=\"firstname\" value=\"'.GETPOST('firstname').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Login\n\tprint '<tr><td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\tprint '<td>';\n\tif (! empty($ldap_login))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$ldap_login.'\">';\n\t\tprint $ldap_login;\n\t}\n\telseif (! empty($ldap_loginsmb))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$ldap_loginsmb.'\">';\n\t\tprint $ldap_loginsmb;\n\t}\n\telse\n\t{\n\t\tprint '<input class=\"maxwidth200\" maxsize=\"24\" type=\"text\" name=\"login\" value=\"'.dol_escape_htmltag(GETPOST('login','alpha')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t$generated_password='';\n\tif (empty($ldap_sid))    // ldap_sid is for activedirectory\n\t{\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\n\t\t$generated_password=getRandomPassword(false);\n\t}\n\t$password=$generated_password;\n\n\t// Password\n\tprint '<tr><td class=\"fieldrequired\">'.$langs->trans(\"Password\").'</td>';\n\tprint '<td>';\n\t$valuetoshow='';\n\tif (preg_match('/ldap/',$dolibarr_main_authentication))\n\t{\n\t\t$valuetoshow.=($valuetoshow?', ':'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t}\n\tif (preg_match('/http/',$dolibarr_main_authentication))\n\t{\n\t\t$valuetoshow.=($valuetoshow?', ':'').$langs->trans(\"HTTPBasicPassword\");\n\t}\n\tif (preg_match('/dolibarr/',$dolibarr_main_authentication))\n\t{\n\t\tif (! empty($ldap_pass))\t// For very old system comaptibilty. Now clear password can't be viewed from LDAP read\n\t\t{\n\t\t\t$valuetoshow.= ($valuetoshow?', ':'').'<input type=\"hidden\" name=\"password\" value=\"'.$ldap_pass.'\">';\t// Dolibarr password is preffiled with LDAP known password\n\t\t\t$valuetoshow.= preg_replace('/./i','*',$ldap_pass);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// We do not use a field password but a field text to show new password to use.\n\t\t\t$valuetoshow.= ($valuetoshow?', ':'').'<input size=\"30\" maxsize=\"32\" type=\"text\" name=\"password\" value=\"'.$password.'\" autocomplete=\"new-password\">';\n\t\t}\n\t}\n\n\t// Other form for user password\n\t$parameters=array('valuetoshow' => $valuetoshow, 'password' => $password);\n\t$reshook=$hookmanager->executeHooks('printUserPasswordField',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\tif ($reshook > 0) $valuetoshow=$hookmanager->resPrint;\t// to replace\n\telse $valuetoshow.=$hookmanager->resPrint;\t\t\t\t// to add\n\n\tprint $valuetoshow;\n\tprint '</td></tr>';\n\n\tif (! empty($conf->api->enabled))\n\t{\n\t\t// API key\n\t\t$generated_api_key = '';\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\n\t\t\t$generated_password=getRandomPassword(false);\n\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"30\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.$api_key.'\" autocomplete=\"off\">';\n\t\tif (! empty($conf->use_javascript_ajax))\n\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\tprint '</td></tr>';\n\t}\n\telse\n\t{\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\n\t\t// PARTIAL WORKAROUND\n\t\t$generated_fake_api_key=getRandomPassword(false);\n\t\tprint '<input type=\"hidden\" name=\"api_key\" value=\"'.$generated_fake_api_key.'\">';\n\t}\n\n\t// Administrator\n\tif (! empty($user->admin))\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\tprint '<td>';\n\t\tprint $form->selectyesno('admin',GETPOST('admin'),1);\n\n\t\tif (! empty($conf->multicompany->enabled) && ! $user->entity && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE))\n\t\t{\n\t\t\tif (! empty($conf->use_javascript_ajax))\n\t\t\t{\n\t\t\t\tprint '<script type=\"text/javascript\">\n                            $(function() {\n                                $(\"select[name=admin]\").change(function() {\n                                     if ( $(this).val() == 0 ) {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", true)\n                                            .prop(\"checked\", false);\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                     } else {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", false);\n                                     }\n                                });\n                                $(\"input[name=superadmin]\").change(function() {\n                                    if ( $(this).is(\":checked\") ) {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", true);\n                                    } else {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                    }\n                                });\n                            });\n                    </script>';\n\t\t\t}\n\t\t\t$checked=(GETPOST('superadmin', 'int')?' checked':'');\n\t\t\t$disabled=(GETPOST('superadmin', 'int')?'':' disabled');\n\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" value=\"1\"'.$checked.$disabled.' /> '.$langs->trans(\"SuperAdministrator\");\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t}\n\n\t// Type\n\tprint '<tr><td>'.$langs->trans(\"Type\").'</td>';\n\tprint '<td>';\n\tprint $form->textwithpicto($langs->trans(\"Internal\"),$langs->trans(\"InternalExternalDesc\"), 1, 'help', '', 0, 2);\n\tprint '</td></tr>';\n\n\t// Gender\n\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\tprint '<td>';\n\t$arraygender=array('man'=>$langs->trans(\"Genderman\"),'woman'=>$langs->trans(\"Genderwoman\"));\n\tprint $form->selectarray('gender', $arraygender, GETPOST('gender'), 1);\n\tprint '</td></tr>';\n\n\t// Employee\n\t$defaultemployee=1;\n\tprint '<tr>';\n\tprint '<td>'.$langs->trans('Employee').'</td><td>';\n\tprint $form->selectyesno(\"employee\",(GETPOST('employee')!=''?GETPOST('employee'):$defaultemployee),1);\n\tprint '</td></tr>';\n\n\t// Hierarchy\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\tprint '<td>';\n\tprint $form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300');\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// Address\n\tprint '<tr><td class=\"tdtop titlefieldcreate\">'.fieldLabel('Address','address').'</td>';\n\tprint '<td><textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\tprint $object->address;\n\tprint '</textarea></td></tr>';\n\n\t// Zip\n\tprint '<tr><td>'.fieldLabel('Zip','zipcode').'</td><td>';\n\tprint $formcompany->select_ziptown($object->zip,'zipcode',array('town','selectcountry_id','state_id'),6);\n\tprint '</td></tr>';\n\n\t// Town\n\tprint '<tr><td>'.fieldLabel('Town','town').'</td><td>';\n\tprint $formcompany->select_ziptown($object->town,'town',array('zipcode','selectcountry_id','state_id'));\n\tprint '</td></tr>';\n\n\t// Country\n\tprint '<tr><td>'.fieldLabel('Country','selectcountry_id').'</td><td class=\"maxwidthonsmartphone\">';\n\tprint $form->select_country((GETPOST('country_id')!=''?GETPOST('country_id'):$object->country_id));\n\tif ($user->admin) print info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"),1);\n\tprint '</td></tr>';\n\n\t// State\n\tif (empty($conf->global->USER_DISABLE_STATE))\n\t{\n\t\tprint '<tr><td>'.fieldLabel('State','state_id').'</td><td class=\"maxwidthonsmartphone\">';\n\t\tprint $formcompany->select_state($object->state_id,$object->country_code, 'state_id');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Tel\n\tprint '<tr><td>'.$langs->trans(\"PhonePro\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_phone))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.$ldap_phone.'\">';\n\t\tprint $ldap_phone;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"20\" type=\"text\" name=\"office_phone\" value=\"'.GETPOST('office_phone').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Tel portable\n\tprint '<tr><td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_mobile))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.$ldap_mobile.'\">';\n\t\tprint $ldap_mobile;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"20\" type=\"text\" name=\"user_mobile\" value=\"'.GETPOST('user_mobile').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Fax\n\tprint '<tr><td>'.$langs->trans(\"Fax\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_fax))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.$ldap_fax.'\">';\n\t\tprint $ldap_fax;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"20\" type=\"text\" name=\"office_fax\" value=\"'.GETPOST('office_fax').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Skype\n\tif (! empty($conf->skype->enabled))\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"Skype\").'</td>';\n\t\tprint '<td>';\n\t\tif (! empty($ldap_skype))\n\t\t{\n\t\t\tprint '<input type=\"hidden\" name=\"skype\" value=\"'.$ldap_skype.'\">';\n\t\t\tprint $ldap_skype;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tprint '<input class=\"maxwidth200\" type=\"text\" name=\"skype\" value=\"'.GETPOST('skype').'\">';\n\t\t}\n\t\tprint '</td></tr>';\n\t}\n\n\t// EMail\n\tprint '<tr><td'.(! empty($conf->global->USER_MAIL_REQUIRED)?' class=\"fieldrequired\"':'').'>'.$langs->trans(\"EMail\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_mail))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.$ldap_mail.'\">';\n\t\tprint $ldap_mail;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"40\" type=\"text\" name=\"email\" value=\"'.GETPOST('email').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Accountancy code\n\tif ($conf->accounting->enabled)\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"30\" type=\"text\" name=\"accountancy_code\" value=\"'.GETPOST('accountancy_code').'\">';\n\t\tprint '</td></tr>';\n\t}\n\n\t// User color\n\tif (! empty($conf->agenda->enabled))\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\tprint '<td>';\n\t\tprint $formother->selectColor(GETPOST('color')?GETPOST('color'):$object->color, 'color', null, 1, '', 'hideifnotset');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Categories\n\tif (! empty($conf->categorie->enabled)  && ! empty($user->rights->categorie->lire))\n\t{\n\t\tprint '<tr><td>' . fieldLabel('Categories', 'usercats') . '</td><td colspan=\"3\">';\n\t\t$cate_arbo = $form->select_all_categories('user', null, 'parent', null, null, 1);\n\t\tprint $form->multiselectarray('usercats', $cate_arbo, GETPOST('usercats', 'array'), null, null, null,\n\t\t\tnull, '90%' );\n\t\tprint \"</td></tr>\";\n\t}\n\n\t// Multicompany\n\tif (! empty($conf->multicompany->enabled) && is_object($mc))\n\t{\n\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\tif (! method_exists($mc, 'formObjectOptions'))\n\t\t{\n\t\t\tif (empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && ! $user->entity)\t// condition must be same for create and edit mode\n\t\t\t{\n\t\t\t\t print \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t\t\t\t print \"<td>\".$mc->select_entities($conf->entity);\n\t\t\t\t print \"</td></tr>\\n\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t print '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t}\n\t\t }\n\t}\n\n\t// Other attributes\n\t$parameters=array('objectsrc' => $objectsrc, 'colspan' => ' colspan=\"3\"');\n\t$reshook=$hookmanager->executeHooks('formObjectOptions',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\tprint $hookmanager->resPrint;\n\tif (empty($reshook))\n\t{\n\t\tprint $object->showOptionals($extrafields,'edit');\n\t}\n\n\t// Note\n\tprint '<tr><td class=\"tdtop\">';\n\tprint $langs->trans(\"Note\");\n\tprint '</td><td>';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor=new DolEditor('note','','',120,'dolibarr_notes','',false,true,$conf->global->FCKEDITOR_ENABLE_SOCIETE,ROWS_3,'90%');\n\t$doleditor->Create();\n\tprint \"</td></tr>\\n\";\n\n\t// Signature\n\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\tprint '<td>';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor=new DolEditor('signature',GETPOST('signature'),'',138,'dolibarr_notes','In',true,true,empty($conf->global->FCKEDITOR_ENABLE_USERSIGN)?0:1,ROWS_4,'90%');\n\tprint $doleditor->Create(1);\n\tprint '</td></tr>';\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t// Position/Job\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\tprint '<td>';\n\tprint '<input class=\"maxwidth200\" type=\"text\" name=\"job\" value=\"'.GETPOST('job').'\">';\n\tprint '</td></tr>';\n\n\n\tif ((! empty($conf->salaries->enabled) && ! empty($user->rights->salaries->read))\n\t\t|| (! empty($conf->hrm->enabled) && ! empty($user->rights->hrm->employee->read)))\n\t{\n\t\t$langs->load(\"salaries\");\n\n\t\t// THM\n\t\tprint '<tr><td>';\n\t\t$text=$langs->trans(\"THM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.GETPOST('thm').'\">';\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// TJM\n\t\tprint '<tr><td>';\n\t\t$text=$langs->trans(\"TJM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.GETPOST('tjm').'\">';\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// Salary\n\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.GETPOST('salary').'\">';\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// Weeklyhours\n\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\tprint '<td>';\n\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.GETPOST('weeklyhours').'\">';\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date employment\n\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\tprint '<td>';\n\techo $form->select_date(GETPOST('dateemployment'),'dateemployment',0,0,1,'form'.'dateemployment',1,0,1);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date birth\n\tprint '<tr><td>'.$langs->trans(\"DateToBirth\").'</td>';\n\tprint '<td>';\n\techo $form->select_date(GETPOST('birth'),'birth',0,0,1,'createuser',1,0,1);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\tprint \"</table>\\n\";\n\n \tdol_fiche_end();\n\n\tprint '<div align=\"center\">';\n\tprint '<input class=\"button\" value=\"'.$langs->trans(\"CreateUser\").'\" name=\"create\" type=\"submit\">';\n\t//print '&nbsp; &nbsp; &nbsp;';\n\t//print '<input value=\"'.$langs->trans(\"Cancel\").'\" class=\"button\" type=\"submit\" name=\"cancel\">';\n\tprint '</div>';\n\n\tprint \"</form>\";\n}\nelse\n{\n\t/* ************************************************************************** */\n\t/*                                                                            */\n\t/* View and edition                                                            */\n\t/*                                                                            */\n\t/* ************************************************************************** */\n\n\tif ($id > 0)\n\t{\n\t\t$object->fetch($id, '', '', 1);\n\t\tif ($res < 0) { dol_print_error($db,$object->error); exit; }\n\t\t$res=$object->fetch_optionals();\n\n\t\t// Check if user has rights\n\t\t$object->getrights();\n\t\tif (empty($object->nb_rights) && $object->statut != 0 && empty($object->admin)) setEventMessages($langs->trans('UserHasNoPermissions'), null, 'warnings');\n\n\t\t// Connexion ldap\n\t\t// pour recuperer passDoNotExpire et userChangePassNextLogon\n\t\tif (! empty($conf->ldap->enabled) && ! empty($object->ldap_sid))\n\t\t{\n\t\t\t$ldap = new Ldap();\n\t\t\t$result=$ldap->connect_bind();\n\t\t\tif ($result > 0)\n\t\t\t{\n\t\t\t\t$userSearchFilter = '('.$conf->global->LDAP_FILTER_CONNECTION.'('.$ldap->getUserIdentifier().'='.$object->login.'))';\n\t\t\t\t$entries = $ldap->fetch($object->login,$userSearchFilter);\n\t\t\t\tif (! $entries)\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t\t}\n\n\t\t\t\t$passDoNotExpire = 0;\n\t\t\t\t$userChangePassNextLogon = 0;\n\t\t\t\t$userDisabled = 0;\n\t\t\t\t$statutUACF = '';\n\n\t\t\t\t// Check options of user account\n\t\t\t\tif (count($ldap->uacf) > 0)\n\t\t\t\t{\n\t\t\t\t\tforeach ($ldap->uacf as $key => $statut)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($key == 65536)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$passDoNotExpire = 1;\n\t\t\t\t\t\t\t$statutUACF = $statut;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$userDisabled = 1;\n\t\t\t\t\t$statutUACF = \"ACCOUNTDISABLE\";\n\t\t\t\t}\n\n\t\t\t\tif ($ldap->pwdlastset == 0)\n\t\t\t\t{\n\t\t\t\t\t$userChangePassNextLogon = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Show tabs\n\t\tif ($mode == 'employee') // For HRM module development\n\t\t{\n\t\t\t$title = $langs->trans(\"Employee\");\n\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/hrm/employee/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$title = $langs->trans(\"User\");\n\t\t\t$linkback = '';\n\n\t\t\tif ($user->rights->user->user->lire || $user->admin) {\n\t\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/user/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t\t}\n\t\t}\n\n\t\t$head = user_prepare_head($object);\n\n\t\t/*\n         * Confirmation reinitialisation mot de passe\n         */\n\t\tif ($action == 'password')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"ReinitPassword\"),$langs->trans(\"ConfirmReinitPassword\",$object->login),\"confirm_password\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirmation envoi mot de passe\n         */\n\t\tif ($action == 'passwordsend')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"SendNewPassword\"),$langs->trans(\"ConfirmSendNewPassword\",$object->login),\"confirm_passwordsend\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirm deactivation\n         */\n\t\tif ($action == 'disable')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"DisableAUser\"),$langs->trans(\"ConfirmDisableUser\",$object->login),\"confirm_disable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirm activation\n         */\n\t\tif ($action == 'enable')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"EnableAUser\"),$langs->trans(\"ConfirmEnableUser\",$object->login),\"confirm_enable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirmation suppression\n         */\n\t\tif ($action == 'delete')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"DeleteAUser\"),$langs->trans(\"ConfirmDeleteUser\",$object->login),\"confirm_delete\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Fiche en mode visu\n         */\n\t\tif ($action != 'edit')\n\t\t{\n\t\t\tdol_fiche_head($head, 'user', $title, -1, 'user');\n\n\t\t\tdol_banner_tab($object,'id',$linkback,$user->rights->user->user->lire || $user->admin);\n\n\t\t\tprint '<div class=\"fichecenter\">';\n\t\t\tprint '<div class=\"fichehalfleft\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\t\t\tprint '<table class=\"border tableforfield\" width=\"100%\">';\n\n\t\t\t// Login\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Login\").'</td>';\n\t\t\tif (! empty($object->ldap_sid) && $object->statut==0)\n\t\t\t{\n\t\t\t\tprint '<td class=\"error\">'.$langs->trans(\"LoginAccountDisableInDolibarr\").'</td>';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<td>'.$object->login.'</td>';\n\t\t\t}\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// Password\n\t\t\tprint '<tr><td>'.$langs->trans(\"Password\").'</td>';\n\n\t\t\tprint '<td>';\n\t\t\t$valuetoshow='';\n\t\t\tif (preg_match('/ldap/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\tif (! empty($object->ldap_sid))\n\t\t\t\t{\n\t\t\t\t\tif ($passDoNotExpire)\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"LdapUacf_\".$statutUACF);\n\t\t\t\t\t}\n\t\t\t\t\telse if($userChangePassNextLogon)\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').'<span class=\"warning\">'.$langs->trans(\"UserMustChangePassNextLogon\",$ldap->domainFQDN).'</span>';\n\t\t\t\t\t}\n\t\t\t\t\telse if($userDisabled)\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').'<span class=\"warning\">'.$langs->trans(\"LdapUacf_\".$statutUACF,$ldap->domainFQDN).'</span>';\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (preg_match('/http/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"HTTPBasicPassword\");\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\tif ($object->pass) $valuetoshow.= preg_replace('/./i','*',$object->pass);\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif ($user->admin) $valuetoshow.= ($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"Crypted\").': '.$object->pass_indatabase_crypted;\n\t\t\t\t\telse $valuetoshow.= ($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"Hidden\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters=array('valuetoshow' => $valuetoshow);\n\t\t\t$reshook=$hookmanager->executeHooks('printUserPasswordField',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) $valuetoshow=$hookmanager->resPrint;\t// to replace\n\t\t\telse $valuetoshow.=$hookmanager->resPrint;\t\t\t\t// to add\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td>\";\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// API key\n\t\t\tif (! empty($conf->api->enabled) && $user->admin) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (! empty($object->api_key)) print preg_replace('/./','*',$object->api_key);\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Administrator\n\t\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td><td>';\n\t\t\tif (! empty($conf->multicompany->enabled) && $object->admin && ! $object->entity)\n\t\t\t{\n\t\t\t\tprint $form->textwithpicto(yn($object->admin),$langs->trans(\"SuperAdministratorDesc\"),1,\"superadmin\");\n\t\t\t}\n\t\t\telse if ($object->admin)\n\t\t\t{\n\t\t\t\tprint $form->textwithpicto(yn($object->admin),$langs->trans(\"AdministratorDesc\"),1,\"admin\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint yn($object->admin);\n\t\t\t}\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// Type\n\t\t\tprint '<tr><td>';\n\t\t\t$text=$langs->trans(\"Type\");\n\t\t\tprint $form->textwithpicto($text, $langs->trans(\"InternalExternalDesc\"));\n\t\t\tprint '</td><td>';\n\t\t\t$type=$langs->trans(\"Internal\");\n\t\t\tif ($object->societe_id > 0) $type=$langs->trans(\"External\");\n\t\t\tprint $type;\n\t\t\tif ($object->ldap_sid) print ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// Ldap sid\n\t\t\tif ($object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Type\").'</td><td>';\n\t\t\t\tprint $langs->trans(\"DomainUser\",$ldap->domainFQDN);\n\t\t\t\tprint '</td></tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Gender\n\t\t\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->gender) print $langs->trans(\"Gender\".$object->gender);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Employee\n\t\t\tprint '<tr><td>'.$langs->trans(\"Employee\").'</td><td colspan=\"2\">';\n\t\t\tprint yn($object->employee);\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// TODO Move this into tab RH, visible when salarie or RH is visible (HierarchicalResponsible must be on both tab)\n\n\t\t\t// Hierarchy\n\t\t\tprint '<tr><td>'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif (empty($object->fk_user)) print $langs->trans(\"None\");\n\t\t\telse {\n\t\t\t\t$huser=new User($db);\n\t\t\t\t$huser->fetch($object->fk_user);\n\t\t\t\tprint $huser->getNomUrl(1);\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td>'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>'.$object->job.'</td>';\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t//$childids = $user->getAllChildIds(1);\n\n\t\t\tif ((! empty($conf->salaries->enabled) && ! empty($user->rights->salaries->read))\n\t\t\t\t|| (! empty($conf->hrm->enabled) && ! empty($user->rights->hrm->employee->read)))\n\t\t\t{\n            \t// Even a superior can't see this info of its subordinates wihtout $user->rights->salaries->read and $user->rights->hrm->employee->read (setting/viewing is reserverd to HR people).\n            \t// However, he can see the valuation of timesheet of its subordinates even without these permissions.\n\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->thm!=''?price($object->thm,'',$langs,1,-1,-1,$conf->currency):'');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->tjm!=''?price($object->tjm,'',$langs,1,-1,-1,$conf->currency):'');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->salary!=''?price($object->salary,'',$langs,1,-1,-1,$conf->currency):'');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint price2num($object->weeklyhours);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint dol_print_date($object->dateemployment, 'day');\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date of birth\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateToBirth\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint dol_print_date($object->birth, 'day');\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Accountancy code\n\t\t\tif ($conf->accounting->enabled)\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>'.$object->accountancy_code.'</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table>';\n\n\t\t\tprint '</div>';\n\t\t\tprint '<div class=\"fichehalfright\"><div class=\"ficheaddleft\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\t\t\tprint '<table class=\"border tableforfield\" width=\"100%\">';\n\n\t\t\t// Color user\n\t\t\tif (! empty($conf->agenda->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $formother->showColor($object->color, '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Categories\n\t\t\tif (! empty($conf->categorie->enabled)  && ! empty($user->rights->categorie->lire))\n\t\t\t{\n\t\t\t\tprint '<tr><td>' . $langs->trans( \"Categories\" ) . '</td>';\n\t\t\t\tprint '<td colspan=\"3\">';\n\t\t\t\tprint $form->showCategories( $object->id, 'user', 1 );\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/',$conf->file->main_authentication) && ! empty($conf->global->MAIN_OPENIDURL_PERUSER))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>'.$object->openid.'</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"LastConnexion\").'</td>';\n\t\t\tprint '<td>'.dol_print_date($object->datelastlogin,\"dayhour\").'</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '<tr><td>'.$langs->trans(\"PreviousConnexion\").'</td>';\n\t\t\tprint '<td>'.dol_print_date($object->datepreviouslogin,\"dayhour\").'</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t    // Multicompany\n\t\t\tif (! empty($conf->multicompany->enabled) && is_object($mc))\n\t\t\t{\n\t\t\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\t\t\tif (! method_exists($mc, 'formObjectOptions'))\n\t\t\t\t{\n\t\t\t\t     if (! empty($conf->multicompany->enabled) && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && ! $user->entity)\n\t\t\t\t     {\n\t\t\t\t     \tprint '<tr><td>' . $langs->trans(\"Entity\") . '</td><td>';\n\t\t\t\t     \tif (empty($object->entity)) {\n\t\t\t\t     \t\tprint $langs->trans(\"AllEntities\");\n\t\t\t\t     \t} else {\n\t\t\t\t     \t\t$mc->getInfo($object->entity);\n\t\t\t\t     \t\tprint $mc->label;\n\t\t\t\t     \t}\n\t\t\t\t     \tprint \"</td></tr>\\n\";\n\t\t\t\t     }\n\t\t\t     }\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\tinclude DOL_DOCUMENT_ROOT . '/core/tpl/extrafields_view.tpl.php';\n\n\t\t\t// Company / Contact\n\t\t\tif (! empty($conf->societe->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (isset($object->socid) && $object->socid > 0)\n\t\t\t\t{\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tprint $societe->getNomUrl(1,'');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"ThisUserIsNot\");\n\t\t\t\t}\n\t\t\t\tif (! empty($object->contactid))\n\t\t\t\t{\n\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t$contact->fetch($object->contactid);\n\t\t\t\t\tif ($object->socid > 0) print ' / ';\n\t\t\t\t\telse print '<br>';\n\t\t\t\t\tprint '<a href=\"'.DOL_URL_ROOT.'/contact/card.php?id='.$object->contactid.'\">'.img_object($langs->trans(\"ShowContact\"),'contact').' '.dol_trunc($contact->getFullName($langs),32).'</a>';\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (! empty($conf->adherent->enabled))\n\t\t\t{\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member)\n\t\t\t\t{\n\t\t\t\t\t$adh=new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref=$adh->getFullname($langs);\t// Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"UserNotLinkedToMember\");\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans('Signature').'</td><td>';\n\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\tprint \"</table>\\n\";\n\t\t\tprint '</div>';\n\n\t\t\tprint '</div></div>';\n\t\t\tprint '<div style=\"clear:both\"></div>';\n\n\n\t\t\tdol_fiche_end();\n\n\n\t\t\t/*\n             * Buttons actions\n             */\n\n\t\t\tprint '<div class=\"tabsAction\">';\n\n\t\t\t$parameters=array();\n\t\t\t$reshook=$hookmanager->executeHooks('addMoreActionsButtons',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tif (empty($reshook))\n\t\t\t{\n\t\t\t\tif (! empty($object->email))\n\t\t\t\t{\n\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=presend&amp;mode=init#presend\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t}\n\n\t\t\t\tif ($caneditfield && (empty($conf->multicompany->enabled) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tif (! empty($conf->global->MAIN_ONLY_LOGIN_ALLOWED))\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"DisabledInMonoUserMode\")).'\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=edit\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telseif ($caneditpassword && ! $object->ldap_sid &&\n\t\t\t\t(empty($conf->multicompany->enabled) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=edit\">'.$langs->trans(\"EditPassword\").'</a></div>';\n\t\t\t\t}\n\n\t\t\t\t// Si on a un gestionnaire de generation de mot de passe actif\n\t\t\t\tif ($conf->global->USER_PASSWORD_GENERATED != 'none')\n\t\t\t\t{\n\t\t\t\t\tif ($object->statut == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telseif (($user->id != $id && $caneditpassword) && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=password\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($object->statut == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telse if (($user->id != $id && $caneditpassword) && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($object->email) print '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=passwordsend\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t\telse print '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Activer\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 0 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=enable\">'.$langs->trans(\"Reactivate\").'</a></div>';\n\t\t\t\t}\n\t\t\t\t// Desactiver\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 1 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?action=disable&amp;id='.$object->id.'\">'.$langs->trans(\"DisableUser\").'</a></div>';\n\t\t\t\t}\n\t\t\t\t// Delete\n\t\t\t\tif ($user->id <> $id && $candisableuser &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tif ($user->admin || ! $object->admin) // If user edited is admin, delete is possible on for an admin\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?action=delete&amp;id='.$object->id.'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"MustBeAdminToDeleteOtherAdmin\")).'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tprint \"</div>\\n\";\n\n\n\n\t\t\t//Select mail models is same action as presend\n\t\t\tif (GETPOST('modelselected')) $action = 'presend';\n\n\t\t\t// Presend form\n\t\t\t$modelmail='user';\n\t\t\t$defaulttopic='Information';\n\t\t\t$diroutput = $conf->user->dir_output;\n\t\t\t$trackid = 'use'.$object->id;\n\n\t\t\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/card_presend.tpl.php';\n\n\t\t\tif ($action != 'presend' && $action != 'send')\n\t\t\t{\n\t\t\t\t/*\n                 * List of groups of user\n                 */\n\n\t\t\t\tif ($canreadgroup)\n\t\t\t\t{\n\t\t\t\t\tprint load_fiche_titre($langs->trans(\"ListOfGroupsForUser\"),'','');\n\n\t\t\t\t\t// On selectionne les groupes auquel fait parti le user\n\t\t\t\t\t$exclude = array();\n\n\t\t\t\t\t$usergroup=new UserGroup($db);\n\t\t\t\t\t$groupslist = $usergroup->listGroupsForUser($object->id);\n\n\t\t\t\t\tif (! empty($groupslist))\n\t\t\t\t\t{\n\t\t\t\t\t\tforeach($groupslist as $groupforuser)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$exclude[]=$groupforuser->id;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$id.'\" method=\"POST\">'.\"\\n\";\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\" />';\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"addgroup\" />';\n\t\t\t\t\t}\n\n\t\t\t\t\tprint '<table class=\"noborder\" width=\"100%\">'.\"\\n\";\n\n\t\t\t\t\t// Other form for add user to group\n\t\t\t\t\t$parameters=array('caneditgroup' => $caneditgroup, 'groupslist' => $groupslist, 'exclude' => $exclude);\n\t\t\t\t\t$reshook=$hookmanager->executeHooks('formAddUserToGroup',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\t\t\tprint $hookmanager->resPrint;\n\n\t\t\t\t\tif (empty($reshook))\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<tr class=\"liste_titre\"><th class=\"liste_titre\">'.$langs->trans(\"Groups\").'</th>'.\"\\n\";\n\t\t\t\t\t\tprint '<th class=\"liste_titre\" align=\"right\">';\n\t\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprint $form->select_dolgroups('', 'group', 1, $exclude, 0, '', '', $object->entity);\n\t\t\t\t\t\t\tprint ' &nbsp; ';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t\t\t\t\tprint '<input type=\"submit\" class=\"button\" value=\"'.$langs->trans(\"Add\").'\" />';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint '</th></tr>'.\"\\n\";\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t * Groups assigned to user\n\t\t\t\t\t\t */\n\t\t\t\t\t\tif (! empty($groupslist))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tforeach($groupslist as $group)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tprint '<tr class=\"oddeven\">';\n\t\t\t\t\t\t\t\tprint '<td>';\n\t\t\t\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint '<a href=\"'.DOL_URL_ROOT.'/user/group/card.php?id='.$group->id.'\">'.img_object($langs->trans(\"ShowGroup\"),\"group\").' '.$group->name.'</a>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint img_object($langs->trans(\"ShowGroup\"),\"group\").' '.$group->name;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint '</td>';\n\t\t\t\t\t\t\t\tprint '<td align=\"right\">';\n\t\t\t\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint '<a href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=removegroup&amp;group='.$group->id.'\">';\n\t\t\t\t\t\t\t\t\tprint img_picto($langs->trans(\"RemoveFromGroup\"), 'unlink');\n\t\t\t\t\t\t\t\t\tprint '</a>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint \"&nbsp;\";\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprint '<tr class=\"oddeven\"><td colspan=\"3\" class=\"opacitymedium\">'.$langs->trans(\"None\").'</td></tr>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tprint \"</table>\";\n\n\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '</form>';\n\t\t\t\t\t}\n\t\t\t\t\tprint \"<br>\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t/*\n         * Fiche en mode edition\n         */\n\t\tif ($action == 'edit' && ($canedituser || $caneditfield || $caneditpassword || ($user->id == $object->id)))\n\t\t{\n\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'\" method=\"POST\" name=\"updateuser\" enctype=\"multipart/form-data\">';\n\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"update\">';\n\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$object->entity.'\">';\n\n\t\t\tdol_fiche_head($head, 'user', $title, 0, 'user');\n\n\t\t\tprint '<table width=\"100%\" class=\"border\">';\n\n\t\t\t// Ref/ID\n\t\t\tif (! empty($conf->global->MAIN_SHOW_TECHNICAL_ID))\n\t\t\t{\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Ref\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $object->id;\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>';\n\t\t\t}\n\n\t\t\t// Lastname\n\t\t\tprint \"<tr>\";\n\t\t\tprint '<td class=\"titlefield fieldrequired\">'.$langs->trans(\"Lastname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t\tprint $object->lastname;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Firstname\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Firstname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t\tprint $object->firstname;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Login\n\t\t\tprint \"<tr>\".'<td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\t\t\tprint '<td>';\n\t\t\tif ($user->admin  && !$object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<input size=\"12\" maxlength=\"24\" type=\"text\" class=\"flat\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t\tprint $object->login;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Pass\n\t\t\tprint '<tr><td>'.$langs->trans(\"Password\").'</td>';\n\t\t\tprint '<td>';\n\t\t\t$valuetoshow='';\n\t\t\tif (preg_match('/ldap/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t}\n\t\t\tif (preg_match('/http/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$form->textwithpicto($text,$langs->trans(\"DolibarrInHttpAuthenticationSoPasswordUseless\",$dolibarr_main_authentication),1,'warning');\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\tif ($caneditpassword)\n\t\t\t\t{\n\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').'<input size=\"12\" maxlength=\"32\" type=\"password\" class=\"flat\" name=\"password\" value=\"'.$object->pass.'\" autocomplete=\"new-password\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').preg_replace('/./i','*',$object->pass);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters=array('valuetoshow' => $valuetoshow, 'caneditpassword' => $caneditpassword);\n\t\t\t$reshook=$hookmanager->executeHooks('printUserPasswordField',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) $valuetoshow=$hookmanager->resPrint;\t// to replace\n\t\t\telse $valuetoshow.=$hookmanager->resPrint;\t\t\t\t// to add\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\t// API key\n\t\t\tif(! empty($conf->api->enabled) && $user->admin)\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input class=\"minwidth300\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.$object->api_key.'\" autocomplete=\"off\">';\n\t\t\t\tif (! empty($conf->use_javascript_ajax))\n\t\t\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Administrator\n\t\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\t\tif ($object->socid > 0)\n\t\t\t{\n\t\t\t\t$langs->load(\"admin\");\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">'.yn($object->admin);\n\t\t\t\tprint ' ('.$langs->trans(\"ExternalUser\").')';\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<td>';\n\t\t\t\t$nbAdmin = $user->getNbOfUsers('active','',1);\n\t\t\t\t$nbSuperAdmin = $user->getNbOfUsers('active','superadmin',1);\n\t\t\t\t//var_dump($nbAdmin);\n\t\t\t\t//var_dump($nbSuperAdmin);\n\t\t\t\tif ($user->admin\t\t\t\t\t\t\t\t// Need to be admin to allow downgrade of an admin\n\t\t\t\t&& ($user->id != $object->id)                   // Don't downgrade ourself\n\t\t\t\t&& (\n\t\t\t\t\t(empty($conf->multicompany->enabled) && $nbAdmin >= 1)\n\t\t\t\t\t|| (! empty($conf->multicompany->enabled) && ($object->entity > 0 || $nbSuperAdmin > 1))    // Don't downgrade a superadmin if alone\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tprint $form->selectyesno('admin',$object->admin,1);\n\n\t\t\t\t\tif (! empty($conf->multicompany->enabled) && ! $user->entity && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE))\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($conf->use_javascript_ajax)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprint '<script type=\"text/javascript\">\n\t\t\t\t\t\t\t\t\t$(function() {\n\t\t\t\t\t\t\t\t\t\tvar admin = $(\"select[name=admin]\").val();\n\t\t\t\t\t\t\t\t\t\tif (admin == 0) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tif ($(\"input[name=superadmin]\").is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$(\"select[name=admin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\t if ( $(this).val() == 0 ) {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t } else {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t }\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\tif ( $(this).is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t</script>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$checked=(($object->admin && ! $object->entity) ? ' checked' : '');\n\t\t\t\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" value=\"1\"'.$checked.' /> '.$langs->trans(\"SuperAdministrator\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$yn = yn($object->admin);\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">';\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"superadmin\" value=\"'.(empty($object->entity) ? 1 : 0).'\">';\n\t\t\t\t\tif (! empty($conf->multicompany->enabled) && empty($object->entity)) print $form->textwithpicto($yn,$langs->trans(\"DontDowngradeSuperAdmin\"),1,'warning');\n\t\t\t\t\telse print $yn;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t   \t// Type\n\t\t   \tprint '<tr><td>'.$langs->trans(\"Type\").'</td>';\n\t\t   \tprint '<td>';\n\t\t   \tif ($user->id == $object->id || ! $user->admin)\n\t\t   \t{\n\t\t\t   \t$type=$langs->trans(\"Internal\");\n\t\t\t   \tif ($object->socid) $type=$langs->trans(\"External\");\n\t\t\t   \tprint $form->textwithpicto($type,$langs->trans(\"InternalExternalDesc\"));\n\t\t\t   \tif ($object->ldap_sid) print ' ('.$langs->trans(\"DomainUser\").')';\n\t\t   \t}\n\t\t   \telse\n\t\t\t{\n\t\t\t\t$type=0;\n\t\t\t\tif ($object->contactid) $type=$object->contactid;\n\t\t\t\tprint $form->selectcontacts(0,$type,'contactid',2,'','',1,'',false,1);\n\t\t\t   \tif ($object->ldap_sid) print ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t}\n\t\t   \tprint '</td></tr>';\n\n\t\t   \t// Gender\n\t\t   \tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\t\t   \tprint '<td>';\n\t\t   \t$arraygender=array('man'=>$langs->trans(\"Genderman\"),'woman'=>$langs->trans(\"Genderwoman\"));\n\t\t   \tprint $form->selectarray('gender', $arraygender, GETPOST('gender')?GETPOST('gender'):$object->gender, 1);\n\t\t   \tprint '</td></tr>';\n\n\t\t   \t// Employee\n\t\t   \tprint '<tr>';\n\t\t   \tprint '<td>'.fieldLabel('Employee','employee',0).'</td><td>';\n\t\t   \tprint $form->selectyesno(\"employee\",$object->employee,1);\n\t\t   \tprint '</td></tr>';\n\n\t\t   \t// Hierarchy\n\t\t   \tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t   \tprint '<td>';\n\t\t   \tif ($caneditfield)\n\t\t   \t{\n\t\t   \t\tprint $form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'maxwidth300');\n\t\t   \t}\n\t\t   \telse\n\t\t   \t{\n\t\t   \t\tprint '<input type=\"hidden\" name=\"fk_user\" value=\"'.$object->fk_user.'\">';\n\t\t   \t\t$huser=new User($db);\n\t\t   \t\t$huser->fetch($object->fk_user);\n\t\t   \t\tprint $huser->getNomUrl(1);\n\t\t   \t}\n\t\t   \tprint '</td>';\n\t\t   \tprint \"</tr>\\n\";\n\n\n\t\t   \tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// Address\n\t\t\tprint '<tr><td class=\"tdtop titlefield\">'.fieldLabel('Address','address').'</td>';\n\t\t\tprint '<td><textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\t\t\tprint $object->address;\n\t\t\tprint '</textarea></td></tr>';\n\n\t\t\t// Zip\n\t\t\tprint '<tr><td>'.fieldLabel('Zip','zipcode').'</td><td>';\n\t\t\tprint $formcompany->select_ziptown($object->zip, 'zipcode', array('town', 'selectcountry_id', 'state_id'), 6);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Town\n\t\t\tprint '<tr><td>'.fieldLabel('Town','town').'</td><td>';\n\t\t\tprint $formcompany->select_ziptown($object->town, 'town', array('zipcode', 'selectcountry_id', 'state_id'));\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Country\n\t\t\tprint '<tr><td>'.fieldLabel('Country','selectcounty_id').'</td><td>';\n\t\t\tprint $form->select_country((GETPOST('country_id')!=''?GETPOST('country_id'):$object->country_id),'country_id');\n\t\t\tif ($user->admin) print info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"),1);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// State\n\t\t\tif (empty($conf->global->USER_DISABLE_STATE))\n\t\t\t{\n\t\t\t\tprint '<tr><td class=\"tdoverflow\">'.fieldLabel('State','state_id').'</td><td>';\n\t\t\t\tprint $formcompany->select_state($object->state_id,$object->country_code, 'state_id');\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Tel pro\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhonePro\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input size=\"20\" type=\"text\" name=\"office_phone\" class=\"flat\" value=\"'.$object->office_phone.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.$object->office_phone.'\">';\n\t\t\t\tprint $object->office_phone;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Tel mobile\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input size=\"20\" type=\"text\" name=\"user_mobile\" class=\"flat\" value=\"'.$object->user_mobile.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.$object->user_mobile.'\">';\n\t\t\t\tprint $object->user_mobile;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Fax\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Fax\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input size=\"20\" type=\"text\" name=\"office_fax\" class=\"flat\" value=\"'.$object->office_fax.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.$object->office_fax.'\">';\n\t\t\t\tprint $object->office_fax;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Skype\n\t\t\tif (! empty($conf->skype->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Skype\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t\t{\n\t\t\t\t\tprint '<input size=\"40\" type=\"text\" name=\"skype\" class=\"flat\" value=\"'.$object->skype.'\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"skype\" value=\"'.$object->skype.'\">';\n\t\t\t\t\tprint $object->skype;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// EMail\n\t\t\tprint \"<tr>\".'<td'.(! empty($conf->global->USER_MAIL_REQUIRED)?' class=\"fieldrequired\"':'').'>'.$langs->trans(\"EMail\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" name=\"email\" class=\"flat\" value=\"'.$object->email.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.$object->email.'\">';\n\t\t\t\tprint $object->email;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// OpenID url\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/',$conf->file->main_authentication) && ! empty($conf->global->MAIN_OPENIDURL_PERUSER))\n\t\t\t{\n\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield)\n\t\t\t\t{\n\t\t\t\t\tprint '<input class=\"minwidth100\" type=\"url\" name=\"openid\" class=\"flat\" value=\"'.$object->openid.'\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"openid\" value=\"'.$object->openid.'\">';\n\t\t\t\t\tprint $object->openid;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\t\t\t// Accountancy code\n\t\t\tif ($conf->accounting->enabled)\n\t\t\t{\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint '<td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield)\n\t\t\t\t{\n\t\t\t\t\tprint '<input size=\"30\" type=\"text\" class=\"flat\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t\tprint $object->accountancy_code;\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\";\n\t\t\t}\n\n\t\t\t// User color\n\t\t\tif (! empty($conf->agenda->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $formother->selectColor(GETPOST('color')?GETPOST('color'):$object->color, 'color', null, 1, '', 'hideifnotset');\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Photo\n\t\t\tprint '<tr>';\n\t\t\tprint '<td>'.$langs->trans(\"Photo\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $form->showphoto('userphoto',$object,60,0,$caneditfield,'photowithmargin','small');\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Categories\n\t\t\tif (!empty( $conf->categorie->enabled ) && !empty( $user->rights->categorie->lire ))\n\t\t\t{\n\t\t\t\tprint '<tr><td>' . fieldLabel( 'Categories', 'usercats' ) . '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\t$cate_arbo = $form->select_all_categories( Categorie::TYPE_USER, null, null, null, null, 1 );\n\t\t\t\t$c = new Categorie( $db );\n\t\t\t\t$cats = $c->containing($object->id, Categorie::TYPE_USER);\n\t\t\t\tforeach ($cats as $cat) {\n\t\t\t\t\t$arrayselected[] = $cat->id;\n\t\t\t\t}\n\t\t\t\tprint $form->multiselectarray( 'usercats', $cate_arbo, $arrayselected, '', 0, '', 0, '90%' );\n\t\t\t\tprint \"</td></tr>\";\n\t\t\t}\n\n\t\t\t// Status\n\t\t\tprint '<tr><td>'.$langs->trans(\"Status\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $object->getLibStatut(4);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Company / Contact\n\t\t\tif (! empty($conf->societe->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td width=\"25%\">'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->socid > 0)\n\t\t\t\t{\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tprint $societe->getNomUrl(1,'');\n\t\t\t\t\tif ($object->contactid)\n\t\t\t\t\t{\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($object->contactid);\n\t\t\t\t\t\tprint ' / <a href=\"'.DOL_URL_ROOT.'/contact/card.php?id='.$object->contactid.'\">'.img_object($langs->trans(\"ShowContact\"),'contact').' '.dol_trunc($contact->getFullName($langs),32).'</a>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"ThisUserIsNot\");\n\t\t\t\t}\n\t\t\t\tprint ' ('.$langs->trans(\"UseTypeFieldToChange\").')';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (! empty($conf->adherent->enabled))\n\t\t\t{\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td width=\"25%\">'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member)\n\t\t\t\t{\n\t\t\t\t\t$adh=new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref=$adh->login;\t// Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"UserNotLinkedToMember\");\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n            // Multicompany\n            // TODO check if user not linked with the current entity before change entity (thirdparty, invoice, etc.) !!\n            if (! empty($conf->multicompany->enabled) && is_object($mc))\n            {\n            \t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n            \tif (! method_exists($mc, 'formObjectOptions'))\n            \t{\n            \t\tif (empty($conf->multicompany->transverse_mode) && $conf->entity == 1 && $user->admin && ! $user->entity)\n\t            \t{\n\t            \t\tprint \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t            \t\tprint \"<td>\".$mc->select_entities($object->entity, 'entity', '', 0, 1);\t\t// last parameter 1 means, show also a choice 0=>'all entities'\n\t            \t\tprint \"</td></tr>\\n\";\n\t            \t}\n\t            \telse\n\t            \t{\n\t            \t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t            \t}\n\t            }\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\t$parameters=array('colspan' => ' colspan=\"2\"');\n\t\t\t$reshook=$hookmanager->executeHooks('formObjectOptions',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tprint $hookmanager->resPrint;\n\t\t\tif (empty($reshook))\n\t\t\t{\n\t\t\t\tprint $object->showOptionals($extrafields,'edit');\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint \"<tr>\".'<td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield)\n\t\t\t{\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t\t\t\t$doleditor=new DolEditor('signature',$object->signature,'',138,'dolibarr_notes','In',false,true,empty($conf->global->FCKEDITOR_ENABLE_USERSIGN)?0:1,ROWS_4,'90%');\n\t\t\t\tprint $doleditor->Create(1);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield)\n\t\t\t{\n\t\t\t\tprint '<input size=\"30\" type=\"text\" name=\"job\" value=\"'.$object->job.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"job\" value=\"'.$object->job.'\">';\n\t\t\t\tprint $object->job;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\tif ((! empty($conf->salaries->enabled) && ! empty($user->rights->salaries->read))\n\t\t\t\t|| (! empty($conf->hrm->enabled) && ! empty($user->rights->hrm->employee->read)))\n\t\t\t{\n\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.price2num(GETPOST('thm')?GETPOST('thm'):$object->thm).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.price2num(GETPOST('tjm')?GETPOST('tjm'):$object->tjm).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.price2num(GETPOST('salary')?GETPOST('salary'):$object->salary).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.price2num(GETPOST('weeklyhours')?GETPOST('weeklyhours'):$object->weeklyhours).'\">';\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\techo $form->select_date(GETPOST('dateemployment')?GETPOST('dateemployment'):$object->dateemployment,'dateemployment',0,0,1,'form'.'dateemployment',1,0,1);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date birth\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateToBirth\").'</td>';\n\t\t\tprint '<td>';\n\t\t\techo $form->select_date(GETPOST('birth')?GETPOST('birth'):$object->birth,'birth',0,0,1,'updateuser',1,0,1);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '</table>';\n\n\t\t\tdol_fiche_end();\n\n\t\t\tprint '<div align=\"center\">';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Save\").'\" class=\"button\" type=\"submit\" name=\"save\">';\n\t\t\tprint '&nbsp; &nbsp; &nbsp;';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Cancel\").'\" class=\"button\" type=\"submit\" name=\"cancel\">';\n\t\t\tprint '</div>';\n\n\t\t\tprint '</form>';\n\t\t}\n\n\t\tif ($action != 'edit' && $action != 'presend')\n\t\t{\n\t\t\tprint '<div class=\"fichecenter\"><div class=\"fichehalfleft\">';\n\t\t\t/*\n             * Documents generes\n             */\n\t\t\t$filename = dol_sanitizeFileName($object->ref);\n\t\t\t$filedir = $conf->user->dir_output . \"/\" . dol_sanitizeFileName($object->ref);\n\t\t\t$urlsource = $_SERVER[\"PHP_SELF\"] . \"?id=\" . $object->id;\n\t\t\t$genallowed = $user->rights->user->user->lire;\n\t\t\t$delallowed = $user->rights->user->user->creer;\n\n\t\t\tprint $formfile->showdocuments('user', $filename, $filedir, $urlsource, $genallowed, $delallowed, $object->modelpdf, 1, 0, 0, 28, 0, '', 0, '', $soc->default_lang);\n\t\t\t$somethingshown = $formfile->numoffiles;\n\n\t\t\t// Show links to link elements\n\t\t\t$linktoelem = $form->showLinkToObjectBlock($object, null, null);\n\t\t\t$somethingshown = $form->showLinkedObjectBlock($object, $linktoelem);\n\n\t\t\tprint '</div><div class=\"fichehalfright\"><div class=\"ficheaddleft\">';\n\n\t\t\t// List of actions on element\n\t\t\tinclude_once DOL_DOCUMENT_ROOT . '/core/class/html.formactions.class.php';\n\t\t\t$formactions = new FormActions($db);\n\t\t\t$somethingshown = $formactions->showactions($object, 'user', $socid, 1);\n\n\n\t\t\tprint '</div></div></div>';\n\t\t}\n\n\t\tif (! empty($conf->ldap->enabled) && ! empty($object->ldap_sid)) $ldap->close();\n\t}\n\n}\n\nif (! empty($conf->api->enabled) && ! empty($conf->use_javascript_ajax))\n{\n\tprint \"\\n\".'<script type=\"text/javascript\">';\n\tprint '$(document).ready(function () {\n            $(\"#generate_api_key\").click(function() {\n                $.get( \"'.DOL_URL_ROOT.'/core/ajax/security.php\", {\n                    action: \\'getrandompassword\\',\n                    generic: true\n                },\n                function(token) {\n                    $(\"#api_key\").val(token);\n                });\n            });\n    });';\n\tprint '</script>';\n}\n\nllxFooter();\n$db->close();\n"], "fixing_code": ["<?php\n/* Copyright (C) 2002-2006 Rodolphe Quiedeville <rodolphe@quiedeville.org>\n * Copyright (C) 2002-2003 Jean-Louis Bergamo   <jlb@j1b.org>\n * Copyright (C) 2004-2015 Laurent Destailleur  <eldy@users.sourceforge.net>\n * Copyright (C) 2004      Eric Seigne          <eric.seigne@ryxeo.com>\n * Copyright (C) 2005-2018 Regis Houssin        <regis.houssin@capnetworks.com>\n * Copyright (C) 2005      Lionel Cousteix      <etm_ltd@tiscali.co.uk>\n * Copyright (C) 2011      Herve Prot           <herve.prot@symeos.com>\n * Copyright (C) 2012-2018 Juanjo Menent        <jmenent@2byte.es>\n * Copyright (C) 2013      Florian Henry        <florian.henry@open-concept.pro>\n * Copyright (C) 2013-2016 Alexandre Spangaro   <aspangaro.dolibarr@gmail.com>\n * Copyright (C) 2015-2017 Jean-Fran\u00e7ois Ferry  <jfefe@aternatik.fr>\n * Copyright (C) 2015      Ari Elbaz (elarifr)  <github@accedinfo.com>\n * Copyright (C) 2015      Charlie Benke        <charlie@patas-monkey.com>\n * Copyright (C) 2016      Rapha\u00ebl Doursenaud   <rdoursenaud@gpcsolutions.fr>\n *\n * This program is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n *       \\file       htdocs/user/card.php\n *       \\brief      Tab of user card\n */\n\nrequire '../main.inc.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/user/class/usergroup.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/contact/class/contact.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/images.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/lib/usergroups.lib.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/extrafields.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formcompany.class.php';\nrequire_once DOL_DOCUMENT_ROOT.'/core/class/html.formother.class.php';\nif (! empty($conf->ldap->enabled)) require_once DOL_DOCUMENT_ROOT.'/core/class/ldap.class.php';\nif (! empty($conf->adherent->enabled)) require_once DOL_DOCUMENT_ROOT.'/adherents/class/adherent.class.php';\nif (! empty($conf->categorie->enabled)) require_once DOL_DOCUMENT_ROOT.'/categories/class/categorie.class.php';\n\n$id\t\t\t= GETPOST('id','int');\n$action\t\t= GETPOST('action','aZ09');\n$mode\t\t= GETPOST('mode','alpha');\n$confirm\t= GETPOST('confirm','alpha');\n$subaction\t= GETPOST('subaction','alpha');\n$group\t\t= GETPOST(\"group\",\"int\",3);\n$cancel\t\t= GETPOST('cancel','alpha');\n$contextpage= GETPOST('contextpage','aZ')?GETPOST('contextpage','aZ'):'useracard';   // To manage different context of search\n\n// Define value to know what current user can do on users\n$canadduser=(! empty($user->admin) || $user->rights->user->user->creer);\n$canreaduser=(! empty($user->admin) || $user->rights->user->user->lire);\n$canedituser=(! empty($user->admin) || $user->rights->user->user->creer);\n$candisableuser=(! empty($user->admin) || $user->rights->user->user->supprimer);\n$canreadgroup=$canreaduser;\n$caneditgroup=$canedituser;\nif (! empty($conf->global->MAIN_USE_ADVANCED_PERMS))\n{\n\t$canreadgroup=(! empty($user->admin) || $user->rights->user->group_advance->read);\n\t$caneditgroup=(! empty($user->admin) || $user->rights->user->group_advance->write);\n}\n\n// Define value to know what current user can do on properties of edited user\nif ($id)\n{\n\t// $user est le user qui edite, $id est l'id de l'utilisateur edite\n\t$caneditfield=((($user->id == $id) && $user->rights->user->self->creer)\n\t|| (($user->id != $id) && $user->rights->user->user->creer));\n\t$caneditpassword=((($user->id == $id) && $user->rights->user->self->password)\n\t|| (($user->id != $id) && $user->rights->user->user->password));\n}\n\n// Security check\n$socid=0;\nif ($user->societe_id > 0) $socid = $user->societe_id;\n$feature2='user';\nif ($user->id == $id) { $feature2=''; $canreaduser=1; } // A user can always read its own card\nif (!$canreaduser) {\n\t$result = restrictedArea($user, 'user', $id, 'user&user', $feature2);\n}\nif ($user->id <> $id && ! $canreaduser) accessforbidden();\n\n// Load translation files required by page\n$langs->loadLangs(array('users', 'companies', 'ldap', 'admin', 'hrm'));\n\n$object = new User($db);\n$extrafields = new ExtraFields($db);\n\n// fetch optionals attributes and labels\n$extralabels=$extrafields->fetch_name_optionals_label($object->table_element);\n\n// Initialize technical object to manage hooks. Note that conf->hooks_modules contains array\n$hookmanager->initHooks(array('usercard','globalcard'));\n\n\n\n/**\n * Actions\n */\n\n$parameters=array('id' => $id, 'socid' => $socid, 'group' => $group, 'caneditgroup' => $caneditgroup);\n$reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);    // Note that $action and $object may have been modified by some hooks\nif ($reshook < 0) setEventMessages($hookmanager->error, $hookmanager->errors, 'errors');\n\nif (empty($reshook)) {\n\n\tif ($action == 'confirm_disable' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id <> $user->id) {\n\t\t\t$object->fetch($id);\n\t\t\t$object->setstatus(0);\n\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\texit;\n\t\t}\n\t}\n\tif ($action == 'confirm_enable' && $confirm == \"yes\" && $candisableuser) {\n\t\t$error = 0;\n\n\t\tif ($id <> $user->id) {\n\t\t\t$object->fetch($id);\n\n\t\t\tif (!empty($conf->file->main_limit_users)) {\n\t\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t\t$error ++;\n\t\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$error) {\n\t\t\t\t$object->setstatus(1);\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'confirm_delete' && $confirm == \"yes\" && $candisableuser) {\n\t\tif ($id <> $user->id) {\n\t\t\t$object = new User($db);\n\t\t\t$object->fetch($id);\n\t\t\t$result = $object->delete();\n\t\t\tif ($result < 0) {\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\tsetEventMessages($langs->trans(\"ErrorUserCannotBeDelete\"), null, 'errors');\n\t\t\t} else {\n\t\t\t\theader(\"Location: \".DOL_URL_ROOT.\"/user/list.php?restore_lastsearch_values=1\");\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action Add user\n\tif ($action == 'add' && $canadduser) {\n\t\t$error = 0;\n\n\t\tif (!$_POST[\"lastname\"]) {\n\t\t\t$error ++;\n\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\";       // Go back to create page\n\t\t}\n\t\tif (!$_POST[\"login\"]) {\n\t\t\t$error ++;\n\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t$action = \"create\";       // Go back to create page\n\t\t}\n\n\t\tif (!empty($conf->file->main_limit_users)) { // If option to limit users is set\n\t\t\t$nb = $object->getNbOfUsers(\"active\");\n\t\t\tif ($nb >= $conf->file->main_limit_users) {\n\t\t\t\t$error ++;\n\t\t\t\tsetEventMessages($langs->trans(\"YourQuotaOfUsersIsReached\"), null, 'errors');\n\t\t\t\t$action = \"create\";       // Go back to create page\n\t\t\t}\n\t\t}\n\n\t\tif (!$error) {\n\t\t\t$object->lastname = GETPOST(\"lastname\", 'alpha');\n\t\t\t$object->firstname = GETPOST(\"firstname\", 'alpha');\n\t\t\t$object->login = GETPOST(\"login\", 'alpha');\n\t\t\t$object->api_key = GETPOST(\"api_key\", 'alpha');\n\t\t\t$object->gender = GETPOST(\"gender\", 'alpha');\n\t\t\t$birth = dol_mktime(0, 0, 0, GETPOST('birthmonth'), GETPOST('birthday'), GETPOST('birthyear'));\n\t\t\t$object->birth = $birth;\n\t\t\t$object->admin = GETPOST(\"admin\", 'alpha');\n\t\t\t$object->address = GETPOST('address', 'alphanohtml');\n\t\t\t$object->zip = GETPOST('zipcode', 'alphanohtml');\n\t\t\t$object->town = GETPOST('town', 'alphanohtml');\n\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alphanohtml');\n\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alphanohtml');\n\t\t\t$object->user_mobile = GETPOST(\"user_mobile\", 'alphanohtml');\n\t\t\t$object->skype = GETPOST(\"skype\", 'alphanohtml');\n\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alpha'));\n\t\t\t$object->job = GETPOST(\"job\", 'alpha');\n\t\t\t$object->signature = GETPOST(\"signature\", 'none');\n\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\", 'alphanohtml');\n\t\t\t$object->note = GETPOST(\"note\", 'none');\n\t\t\t$object->ldap_sid = GETPOST(\"ldap_sid\", 'alphanohtml');\n\t\t\t$object->fk_user = GETPOST(\"fk_user\", 'int') > 0 ? GETPOST(\"fk_user\", 'int') : 0;\n\t\t\t$object->employee = GETPOST('employee', 'alphanohtml');\n\n\t\t\t$object->thm = GETPOST(\"thm\", 'alphanohtml') != '' ? GETPOST(\"thm\", 'alphanohtml') : '';\n\t\t\t$object->tjm = GETPOST(\"tjm\", 'alphanohtml') != '' ? GETPOST(\"tjm\", 'alphanohtml') : '';\n\t\t\t$object->salary = GETPOST(\"salary\", 'alphanohtml') != '' ? GETPOST(\"salary\", 'alphanohtml') : '';\n\t\t\t$object->salaryextra = GETPOST(\"salaryextra\", 'alphanohtml') != '' ? GETPOST(\"salaryextra\", 'alphanohtml') : '';\n\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\", 'alphanohtml') != '' ? GETPOST(\"weeklyhours\", 'alphanohtml') : '';\n\n\t\t\t$object->color = GETPOST(\"color\", 'alphanohtml') != '' ? GETPOST(\"color\", 'alphanohtml') : '';\n\t\t\t$dateemployment = dol_mktime(0, 0, 0, GETPOST('dateemploymentmonth'), GETPOST('dateemploymentday'), GETPOST('dateemploymentyear'));\n\t\t\t$object->dateemployment = $dateemployment;\n\n\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t$ret = $extrafields->setOptionalsFromPost($extralabels, $object);\n\t\t\tif ($ret < 0) {\n\t\t\t\t$error ++;\n\t\t\t}\n\n\t\t\t// Set entity property\n\t\t\t$entity = GETPOST('entity', 'int');\n\t\t\tif (! empty($conf->multicompany->enabled)) {\n\t\t\t\tif (GETPOST('superadmin', 'int')) {\n\t\t\t\t\t$object->entity = 0;\n\t\t\t\t} else {\n\t\t\t\t\tif (! empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE)) {\n\t\t\t\t\t\t$object->entity = 1; // all users are forced into master entity\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t$object->entity = ($entity == '' ? 1 : $entity);\n\t\t\t\t/*if ($user->admin && $user->entity == 0 && GETPOST(\"admin\",'alpha'))\n\t\t\t\t{\n\t\t\t\t}*/\n\t\t\t}\n\n\t\t\t$db->begin();\n\n\t\t\t$id = $object->create($user);\n\t\t\tif ($id > 0) {\n\t\t\t\tif (GETPOST('password')) {\n\t\t\t\t\t$object->setPassword($user, GETPOST('password'));\n\t\t\t\t}\n\t\t\t\t\t\tif (! empty($conf->categorie->enabled)) {\n\t\t\t\t\t// Categories association\n\t\t\t\t\t$usercats = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($usercats);\n\t\t\t\t}\n\t\t\t\t$db->commit();\n\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t$db->rollback();\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t$action = \"create\";       // Go back to create page\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action add usergroup\n\tif (($action == 'addgroup' || $action == 'removegroup') && $caneditgroup)\n\t{\n\t\tif ($group)\n\t\t{\n\t\t\t$editgroup = new UserGroup($db);\n\t\t\t$editgroup->fetch($group);\n\t\t\t$editgroup->oldcopy=clone $editgroup;\n\n\t\t\t$object->fetch($id);\n\t\t\tif ($action == 'addgroup') {\n\t\t\t\t$result = $object->SetInGroup($group, $editgroup->entity);\n\t\t\t}\n\t\t\tif ($action == 'removegroup') {\n\t\t\t\t$result = $object->RemoveFromGroup($group, $editgroup->entity);\n\t\t\t}\n\n\t\t\tif ($result > 0) {\n\t\t\t\theader(\"Location: \".$_SERVER['PHP_SELF'].'?id='.$id);\n\t\t\t\texit;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($action == 'update' && ! $cancel)\n\t{\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php';\n\n\t\tif ($caneditfield)    // Case we can edit all field\n\t\t{\n\t\t\t$error = 0;\n\n\t\t\tif (!$_POST[\"lastname\"]) {\n\t\t\t\tsetEventMessages($langs->trans(\"NameNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\";       // Go back to create page\n\t\t\t\t$error ++;\n\t\t\t}\n\t\t\tif (!$_POST[\"login\"]) {\n\t\t\t\tsetEventMessages($langs->trans(\"LoginNotDefined\"), null, 'errors');\n\t\t\t\t$action = \"edit\";       // Go back to create page\n\t\t\t\t$error ++;\n\t\t\t}\n\n\t\t\tif (!$error)\n\t\t\t{\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t$db->begin();\n\n\t\t\t\t$object->lastname = GETPOST(\"lastname\", 'alpha');\n\t\t\t\t$object->firstname = GETPOST(\"firstname\", 'alpha');\n\t\t\t\t$object->login = GETPOST(\"login\", 'alpha');\n\t\t\t\t$object->gender = GETPOST(\"gender\", 'alpha');\n\t\t\t\t$birth = dol_mktime(0, 0, 0, GETPOST('birthmonth'), GETPOST('birthday'), GETPOST('birthyear'));\n\t\t\t\t$object->birth = $birth;\n\t\t\t\t$object->pass = GETPOST(\"password\",'none');\n\t\t\t\t$object->api_key = (GETPOST(\"api_key\", 'alpha')) ? GETPOST(\"api_key\", 'alpha') : $object->api_key;\n\t\t\t\tif (! empty($user->admin)) $object->admin = GETPOST(\"admin\"); \t// admin flag can only be set/unset by an admin user. A test is also done later when forging sql request\n\t\t\t\t$object->address = GETPOST('address', 'alphanohtml');\n\t\t\t\t$object->zip = GETPOST('zipcode', 'alphanohtml');\n\t\t\t\t$object->town = GETPOST('town', 'alphanohtml');\n\t\t\t\t$object->country_id = GETPOST('country_id', 'int');\n\t\t\t\t$object->state_id = GETPOST('state_id', 'int');\n\t\t\t\t$object->office_phone = GETPOST(\"office_phone\", 'alphanohtml');\n\t\t\t\t$object->office_fax = GETPOST(\"office_fax\", 'alphanohtml');\n\t\t\t\t$object->user_mobile = GETPOST(\"user_mobile\", 'alphanohtml');\n\t\t\t\t$object->skype = GETPOST(\"skype\", 'alpha');\n\t\t\t\t$object->email = preg_replace('/\\s+/', '', GETPOST(\"email\", 'alpha'));\n\t\t\t\t$object->job = GETPOST(\"job\", 'alpha');\n\t\t\t\t$object->signature = GETPOST(\"signature\",'none');\n\t\t\t\t$object->accountancy_code = GETPOST(\"accountancy_code\",'alpha');\n\t\t\t\t$object->openid = GETPOST(\"openid\",'alpha');\n\t\t\t\t$object->fk_user = GETPOST(\"fk_user\",'int') > 0 ? GETPOST(\"fk_user\",'int') : 0;\n\t\t\t\t$object->employee = GETPOST('employee','alphanothtml');\n\n\t\t\t\t$object->thm = GETPOST(\"thm\",'alphanohtml') != '' ? GETPOST(\"thm\",'alphanohtml') : '';\n\t\t\t\t$object->tjm = GETPOST(\"tjm\",'alphanohtml') != '' ? GETPOST(\"tjm\",'alphanohtml') : '';\n\t\t\t\t$object->salary = GETPOST(\"salary\",'alphanohtml') != '' ? GETPOST(\"salary\",'alphanohtml') : '';\n\t\t\t\t$object->salaryextra = GETPOST(\"salaryextra\",'alphanohtml') != '' ? GETPOST(\"salaryextra\",'alphanohtml') : '';\n\t\t\t\t$object->weeklyhours = GETPOST(\"weeklyhours\",'alphanohtml') != '' ? GETPOST(\"weeklyhours\",'alphanohtml') : '';\n\n\t\t\t\t$object->color = GETPOST(\"color\",'alpha') != '' ? GETPOST(\"color\",'alpha') : '';\n\t\t\t\t$dateemployment = dol_mktime(0, 0, 0, GETPOST('dateemploymentmonth','int'), GETPOST('dateemploymentday','int'), GETPOST('dateemploymentyear','int'));\n\t\t\t\t$object->dateemployment = $dateemployment;\n\n\t\t\t\tif (! empty($conf->multicompany->enabled))\n\t\t\t\t{\n\t\t\t\t\tif (! empty($_POST[\"superadmin\"]))\n\t\t\t\t\t{\n\t\t\t\t\t\t$object->entity = 0;\n\t\t\t\t\t}\n\t\t\t\t\telse if (! empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE))\n\t\t\t\t\t{\n\t\t\t\t\t\t$object->entity = 1; // all users in master entity\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$object->entity = (! GETPOST('entity', 'int') ? 0 : GETPOST('entity', 'int'));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$object->entity = (! GETPOST('entity', 'int') ? 0 : GETPOST('entity', 'int'));\n\t\t\t\t}\n\n\t\t\t\t// Fill array 'array_options' with data from add form\n\t\t\t\t$ret = $extrafields->setOptionalsFromPost($extralabels, $object);\n\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t$error ++;\n\t\t\t\t}\n\n\t\t\t\tif (GETPOST('deletephoto')) {\n\t\t\t\t\t$object->photo = '';\n\t\t\t\t}\n\t\t\t\tif (!empty($_FILES['photo']['name'])) {\n\t\t\t\t\t$object->photo = dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t}\n\n\t\t\t\tif (!$error) {\n\t\t\t\t\t$ret = $object->update($user);\n\t\t\t\t\tif ($ret < 0) {\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\tif ($db->errno() == 'DB_ERROR_RECORD_ALREADY_EXISTS') {\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorLoginAlreadyExists\", $object->login), null, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && GETPOSTISSET('contactid')) {\n\t\t\t\t\t$contactid = GETPOST('contactid', 'int');\n\n\t\t\t\t\tif ($contactid > 0) {\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($contactid);\n\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=\".$db->escape($contactid);\n\t\t\t\t\t\tif (!empty($contact->socid)) {\n\t\t\t\t\t\t\t$sql .= \", fk_soc=\".$db->escape($contact->socid);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$sql .= \" WHERE rowid=\".$object->id;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$sql = \"UPDATE \".MAIN_DB_PREFIX.\"user\";\n\t\t\t\t\t\t$sql .= \" SET fk_socpeople=NULL, fk_soc=NULL\";\n\t\t\t\t\t\t$sql .= \" WHERE rowid=\".$object->id;\n\t\t\t\t\t}\n\t\t\t\t\tdol_syslog(\"usercard::update\", LOG_DEBUG);\n\t\t\t\t\t$resql = $db->query($sql);\n\t\t\t\t\tif (!$resql) {\n\t\t\t\t\t\t$error ++;\n\t\t\t\t\t\tsetEventMessages($db->lasterror(), null, 'errors');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tif (GETPOST('deletephoto') && $object->photo) {\n\t\t\t\t\t\t$fileimg = $conf->user->dir_output.'/'.get_exdir($object->id, 2, 0, 1, $object, 'user').'/logos/'.$object->photo;\n\t\t\t\t\t\t$dirthumbs = $conf->user->dir_output.'/'.get_exdir($object->id, 2, 0, 1, $object, 'user').'/logos/thumbs';\n\t\t\t\t\t\tdol_delete_file($fileimg);\n\t\t\t\t\t\tdol_delete_dir_recursive($dirthumbs);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isset($_FILES['photo']['tmp_name']) && trim($_FILES['photo']['tmp_name'])) {\n\t\t\t\t\t\t$dir = $conf->user->dir_output.'/'.get_exdir($object->id, 2, 0, 1, $object, 'user');\n\n\t\t\t\t\t\tdol_mkdir($dir);\n\n\t\t\t\t\t\tif (@is_dir($dir)) {\n\t\t\t\t\t\t\t$newfile = $dir.'/'.dol_sanitizeFileName($_FILES['photo']['name']);\n\t\t\t\t\t\t\t$result = dol_move_uploaded_file($_FILES['photo']['tmp_name'], $newfile, 1, 0, $_FILES['photo']['error']);\n\n\t\t\t\t\t\t\tif (!$result > 0) {\n\t\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSaveFile\"), null, 'errors');\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// Create thumbs\n\t\t\t\t\t\t\t\t$object->addThumbs($newfile);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t$error ++;\n\t\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToCreateDir\", $dir), $mesgs, 'errors');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (! $error && ! count($object->errors))\n\t\t\t\t{\n\t\t\t\t\t// Then we add the associated categories\n\t\t\t\t\t$categories = GETPOST('usercats', 'array');\n\t\t\t\t\t$object->setCategories($categories);\n\t\t\t\t}\n\n\t\t\t\tif (!$error && !count($object->errors)) {\n\t\t\t\t\tsetEventMessages($langs->trans(\"UserModified\"), null, 'mesgs');\n\t\t\t\t\t$db->commit();\n\n\t\t\t\t\t$login = $_SESSION[\"dol_login\"];\n\t\t\t\t\tif ($login && $login == $object->oldcopy->login && $object->oldcopy->login != $object->login)    // Current user has changed its login\n\t\t\t\t\t{\n\t\t\t\t\t\t$error++;\n\t\t\t\t\t\t$langs->load(\"errors\");\n\t\t\t\t\t\tsetEventMessages($langs->transnoentitiesnoconv(\"WarningYourLoginWasModifiedPleaseLogin\"), null, 'warnings');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$db->rollback();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif ($caneditpassword)    // Case we can edit only password\n\t\t\t{\n\t\t\t\tdol_syslog(\"Not allowed to change fields, only password\");\n\n\t\t\t\t$object->fetch($id);\n\n\t\t\t\t$object->oldcopy = clone $object;\n\n\t\t\t\t$ret = $object->setPassword($user, GETPOST(\"password\"));\n\t\t\t\tif ($ret < 0)\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Change password with a new generated one\n\tif ((($action == 'confirm_password' && $confirm == 'yes')\n\t\t\t|| ($action == 'confirm_passwordsend' && $confirm == 'yes')) && $caneditpassword\n\t) {\n\t\t$object->fetch($id);\n\n\t\t$newpassword = $object->setPassword($user, '');\n\t\tif ($newpassword < 0) {\n\t\t\t// Echec\n\t\t\tsetEventMessages($langs->trans(\"ErrorFailedToSetNewPassword\"), null, 'errors');\n\t\t} else {\n\t\t\t// Succes\n\t\t\tif ($action == 'confirm_passwordsend' && $confirm == 'yes') {\n\t\t\t\tif ($object->send_password($user, $newpassword) > 0)\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedAndSentTo\", $object->email), null, 'mesgs');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($object->error, $object->errors, 'errors');\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsetEventMessages($langs->trans(\"PasswordChangedTo\", $newpassword), null, 'warnings');\n\t\t\t}\n\t\t}\n\t}\n\n\t// Action initialisation donnees depuis record LDAP\n\tif ($action == 'adduserldap') {\n\t\t$selecteduser = $_POST['users'];\n\n\t\t$required_fields = array(\n\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t);\n\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0) {\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields = array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t$ldapusers = $ldap->getRecords($selecteduser, $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields);\n\t\t\t//print_r($ldapusers);\n\n\t\t\tif (is_array($ldapusers)) {\n\t\t\t\tforeach ($ldapusers as $key => $attribute) {\n\t\t\t\t\t$ldap_lastname = $attribute[$conf->global->LDAP_FIELD_NAME];\n\t\t\t\t\t$ldap_firstname = $attribute[$conf->global->LDAP_FIELD_FIRSTNAME];\n\t\t\t\t\t$ldap_login = $attribute[$conf->global->LDAP_FIELD_LOGIN];\n\t\t\t\t\t$ldap_loginsmb = $attribute[$conf->global->LDAP_FIELD_LOGIN_SAMBA];\n\t\t\t\t\t$ldap_pass = $attribute[$conf->global->LDAP_FIELD_PASSWORD];\n\t\t\t\t\t$ldap_pass_crypted = $attribute[$conf->global->LDAP_FIELD_PASSWORD_CRYPTED];\n\t\t\t\t\t$ldap_phone = $attribute[$conf->global->LDAP_FIELD_PHONE];\n\t\t\t\t\t$ldap_fax = $attribute[$conf->global->LDAP_FIELD_FAX];\n\t\t\t\t\t$ldap_mobile = $attribute[$conf->global->LDAP_FIELD_MOBILE];\n\t\t\t\t\t$ldap_skype = $attribute[$conf->global->LDAP_FIELD_SKYPE];\n\t\t\t\t\t$ldap_mail = $attribute[$conf->global->LDAP_FIELD_MAIL];\n\t\t\t\t\t$ldap_sid = $attribute[$conf->global->LDAP_FIELD_SID];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\t}\n\n\t// Actions to send emails\n\t$trigger_name='USER_SENTBYMAIL';\n\t$paramname='id';    // Name of param key to open the card\n\t$mode='emailfromuser';\n\t$trackid='use'.$id;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_sendmails.inc.php';\n\n\t// Actions to build doc\n\t$upload_dir = $conf->user->dir_output;\n\t$permissioncreate=$user->rights->user->user->creer;\n\tinclude DOL_DOCUMENT_ROOT.'/core/actions_builddoc.inc.php';\n}\n\n\n/*\n * View\n */\n\n$form = new Form($db);\n$formother=new FormOther($db);\n$formcompany = new FormCompany($db);\n$formfile = new FormFile($db);\n\nllxHeader('',$langs->trans(\"UserCard\"));\n\nif ($action == 'create' || $action == 'adduserldap')\n{\n\t/* ************************************************************************** */\n\t/*                                                                            */\n\t/* Affichage fiche en mode creation                                           */\n\t/*                                                                            */\n\t/* ************************************************************************** */\n\n\tprint load_fiche_titre($langs->trans(\"NewUser\"));\n\n\tprint $langs->trans(\"CreateInternalUserDesc\").\"<br>\\n\";\n\tprint \"<br>\";\n\n\n\tif (! empty($conf->ldap->enabled) && (isset($conf->global->LDAP_SYNCHRO_ACTIVE) && $conf->global->LDAP_SYNCHRO_ACTIVE == 'ldap2dolibarr'))\n\t{\n\t\t/*\n         * Affiche formulaire d'ajout d'un compte depuis LDAP\n         * si on est en synchro LDAP vers Dolibarr\n         */\n\n\t\t$ldap = new Ldap();\n\t\t$result = $ldap->connect_bind();\n\t\tif ($result >= 0)\n\t\t{\n\t\t\t$required_fields=array(\n\t\t\t\t$conf->global->LDAP_KEY_USERS,\n\t\t\t\t$conf->global->LDAP_FIELD_FULLNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_NAME,\n\t\t\t\t$conf->global->LDAP_FIELD_FIRSTNAME,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN,\n\t\t\t\t$conf->global->LDAP_FIELD_LOGIN_SAMBA,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD,\n\t\t\t\t$conf->global->LDAP_FIELD_PASSWORD_CRYPTED,\n\t\t\t\t$conf->global->LDAP_FIELD_PHONE,\n\t\t\t\t$conf->global->LDAP_FIELD_FAX,\n\t\t\t\t$conf->global->LDAP_FIELD_MOBILE,\n\t\t\t\t$conf->global->LDAP_FIELD_SKYPE,\n\t\t\t\t$conf->global->LDAP_FIELD_MAIL,\n\t\t\t\t$conf->global->LDAP_FIELD_TITLE,\n\t\t\t\t$conf->global->LDAP_FIELD_DESCRIPTION,\n\t\t\t\t$conf->global->LDAP_FIELD_SID\n\t\t\t);\n\n\t\t\t// Remove from required_fields all entries not configured in LDAP (empty) and duplicated\n\t\t\t$required_fields=array_unique(array_values(array_filter($required_fields, \"dol_validElement\")));\n\n\t\t\t// Get from LDAP database an array of results\n\t\t\t$ldapusers = $ldap->getRecords('*', $conf->global->LDAP_USER_DN, $conf->global->LDAP_KEY_USERS, $required_fields, 1);\n\n\t\t\tif (is_array($ldapusers))\n\t\t\t{\n\t\t\t\t$liste=array();\n\t\t\t\tforeach ($ldapusers as $key => $ldapuser)\n\t\t\t\t{\n\t\t\t\t\t// Define the label string for this user\n\t\t\t\t\t$label='';\n\t\t\t\t\tforeach ($required_fields as $value)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($value)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$label.=$value.\"=\".$ldapuser[$value].\" \";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$liste[$key] = $label;\n\t\t\t\t}\n\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t}\n\n\t\t// If user list is full, we show drop-down list\n\t   \tprint \"\\n\\n<!-- Form liste LDAP debut -->\\n\";\n\n\t   \tprint '<form name=\"add_user_ldap\" action=\"'.$_SERVER[\"PHP_SELF\"].'\" method=\"post\">';\n\t   \tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n\t   \tprint '<table width=\"100%\" class=\"border\"><tr>';\n\t   \tprint '<td width=\"160\">';\n\t   \tprint $langs->trans(\"LDAPUsers\");\n\t   \tprint '</td>';\n\t   \tprint '<td>';\n\t   \tprint '<input type=\"hidden\" name=\"action\" value=\"adduserldap\">';\n\t\tif (is_array($liste) && count($liste))\n\t\t{\n\t\t\tprint $form->selectarray('users', $liste, '', 1);\n\t\t\tprint ajax_combobox('users');\n\t\t}\n\t   \tprint '</td><td align=\"center\">';\n\t   \tprint '<input type=\"submit\" class=\"button\" value=\"'.dol_escape_htmltag($langs->trans('Get')).'\"'.(count($liste)?'':' disabled').'>';\n\t   \tprint '</td></tr></table>';\n\t   \tprint '</form>';\n\n\t   \tprint \"\\n<!-- Form liste LDAP fin -->\\n\\n\";\n\t   \tprint '<br>';\n\t}\n\n\n\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'\" method=\"POST\" name=\"createuser\">';\n\tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n\tprint '<input type=\"hidden\" name=\"action\" value=\"add\">';\n\tif (! empty($ldap_sid)) print '<input type=\"hidden\" name=\"ldap_sid\" value=\"'.dol_escape_htmltag($ldap_sid).'\">';\n\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\">';\n\n\tdol_fiche_head('', '', '', 0, '');\n\n\tprint dol_set_focus('#lastname');\n\n\tprint '<table class=\"border centpercent\">';\n\n\t// Lastname\n\tprint '<tr>';\n\tprint '<td class=\"titlefieldcreate\"><span class=\"fieldrequired\">'.$langs->trans(\"Lastname\").'</span></td>';\n\tprint '<td>';\n\tif (! empty($ldap_lastname))\n\t{\n\t\tprint '<input type=\"hidden\" id=\"lastname\" name=\"lastname\" value=\"'.$ldap_lastname.'\">';\n\t\tprint $ldap_lastname;\n\t}\n\telse\n\t{\n\t\tprint '<input class=\"minwidth100\" type=\"text\" id=\"lastname\" name=\"lastname\" value=\"'.GETPOST('lastname').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Firstname\n\tprint '<tr><td>'.$langs->trans(\"Firstname\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_firstname))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.$ldap_firstname.'\">';\n\t\tprint $ldap_firstname;\n\t}\n\telse\n\t{\n\t\tprint '<input class=\"minwidth100\" type=\"text\" name=\"firstname\" value=\"'.GETPOST('firstname').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Login\n\tprint '<tr><td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\tprint '<td>';\n\tif (! empty($ldap_login))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$ldap_login.'\">';\n\t\tprint $ldap_login;\n\t}\n\telseif (! empty($ldap_loginsmb))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$ldap_loginsmb.'\">';\n\t\tprint $ldap_loginsmb;\n\t}\n\telse\n\t{\n\t\tprint '<input class=\"maxwidth200\" maxsize=\"24\" type=\"text\" name=\"login\" value=\"'.dol_escape_htmltag(GETPOST('login','alpha')).'\">';\n\t}\n\tprint '</td></tr>';\n\n\t$generated_password='';\n\tif (empty($ldap_sid))    // ldap_sid is for activedirectory\n\t{\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\n\t\t$generated_password=getRandomPassword(false);\n\t}\n\t$password=$generated_password;\n\n\t// Password\n\tprint '<tr><td class=\"fieldrequired\">'.$langs->trans(\"Password\").'</td>';\n\tprint '<td>';\n\t$valuetoshow='';\n\tif (preg_match('/ldap/',$dolibarr_main_authentication))\n\t{\n\t\t$valuetoshow.=($valuetoshow?', ':'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t}\n\tif (preg_match('/http/',$dolibarr_main_authentication))\n\t{\n\t\t$valuetoshow.=($valuetoshow?', ':'').$langs->trans(\"HTTPBasicPassword\");\n\t}\n\tif (preg_match('/dolibarr/',$dolibarr_main_authentication))\n\t{\n\t\tif (! empty($ldap_pass))\t// For very old system comaptibilty. Now clear password can't be viewed from LDAP read\n\t\t{\n\t\t\t$valuetoshow.= ($valuetoshow?', ':'').'<input type=\"hidden\" name=\"password\" value=\"'.$ldap_pass.'\">';\t// Dolibarr password is preffiled with LDAP known password\n\t\t\t$valuetoshow.= preg_replace('/./i','*',$ldap_pass);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t// We do not use a field password but a field text to show new password to use.\n\t\t\t$valuetoshow.= ($valuetoshow?', ':'').'<input size=\"30\" maxsize=\"32\" type=\"text\" name=\"password\" value=\"'.$password.'\" autocomplete=\"new-password\">';\n\t\t}\n\t}\n\n\t// Other form for user password\n\t$parameters=array('valuetoshow' => $valuetoshow, 'password' => $password);\n\t$reshook=$hookmanager->executeHooks('printUserPasswordField',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\tif ($reshook > 0) $valuetoshow=$hookmanager->resPrint;\t// to replace\n\telse $valuetoshow.=$hookmanager->resPrint;\t\t\t\t// to add\n\n\tprint $valuetoshow;\n\tprint '</td></tr>';\n\n\tif (! empty($conf->api->enabled))\n\t{\n\t\t// API key\n\t\t$generated_api_key = '';\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\n\t\t\t$generated_password=getRandomPassword(false);\n\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"30\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.$api_key.'\" autocomplete=\"off\">';\n\t\tif (! empty($conf->use_javascript_ajax))\n\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\tprint '</td></tr>';\n\t}\n\telse\n\t{\n\t\trequire_once DOL_DOCUMENT_ROOT.'/core/lib/security2.lib.php';\n\t\t// PARTIAL WORKAROUND\n\t\t$generated_fake_api_key=getRandomPassword(false);\n\t\tprint '<input type=\"hidden\" name=\"api_key\" value=\"'.$generated_fake_api_key.'\">';\n\t}\n\n\t// Administrator\n\tif (! empty($user->admin))\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\tprint '<td>';\n\t\tprint $form->selectyesno('admin',GETPOST('admin'),1);\n\n\t\tif (! empty($conf->multicompany->enabled) && ! $user->entity && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE))\n\t\t{\n\t\t\tif (! empty($conf->use_javascript_ajax))\n\t\t\t{\n\t\t\t\tprint '<script type=\"text/javascript\">\n                            $(function() {\n                                $(\"select[name=admin]\").change(function() {\n                                     if ( $(this).val() == 0 ) {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", true)\n                                            .prop(\"checked\", false);\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                     } else {\n                                        $(\"input[name=superadmin]\")\n                                            .prop(\"disabled\", false);\n                                     }\n                                });\n                                $(\"input[name=superadmin]\").change(function() {\n                                    if ( $(this).is(\":checked\") ) {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", true);\n                                    } else {\n                                        $(\"select[name=entity]\")\n                                            .prop(\"disabled\", false);\n                                    }\n                                });\n                            });\n                    </script>';\n\t\t\t}\n\t\t\t$checked=(GETPOST('superadmin', 'int')?' checked':'');\n\t\t\t$disabled=(GETPOST('superadmin', 'int')?'':' disabled');\n\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" value=\"1\"'.$checked.$disabled.' /> '.$langs->trans(\"SuperAdministrator\");\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t}\n\n\t// Type\n\tprint '<tr><td>'.$langs->trans(\"Type\").'</td>';\n\tprint '<td>';\n\tprint $form->textwithpicto($langs->trans(\"Internal\"),$langs->trans(\"InternalExternalDesc\"), 1, 'help', '', 0, 2);\n\tprint '</td></tr>';\n\n\t// Gender\n\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\tprint '<td>';\n\t$arraygender=array('man'=>$langs->trans(\"Genderman\"),'woman'=>$langs->trans(\"Genderwoman\"));\n\tprint $form->selectarray('gender', $arraygender, GETPOST('gender'), 1);\n\tprint '</td></tr>';\n\n\t// Employee\n\t$defaultemployee=1;\n\tprint '<tr>';\n\tprint '<td>'.$langs->trans('Employee').'</td><td>';\n\tprint $form->selectyesno(\"employee\",(GETPOST('employee')!=''?GETPOST('employee'):$defaultemployee),1);\n\tprint '</td></tr>';\n\n\t// Hierarchy\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\tprint '<td>';\n\tprint $form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $conf->entity, 0, 0, '', 0, '', 'maxwidth300');\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// Address\n\tprint '<tr><td class=\"tdtop titlefieldcreate\">'.fieldLabel('Address','address').'</td>';\n\tprint '<td><textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\tprint $object->address;\n\tprint '</textarea></td></tr>';\n\n\t// Zip\n\tprint '<tr><td>'.fieldLabel('Zip','zipcode').'</td><td>';\n\tprint $formcompany->select_ziptown($object->zip,'zipcode',array('town','selectcountry_id','state_id'),6);\n\tprint '</td></tr>';\n\n\t// Town\n\tprint '<tr><td>'.fieldLabel('Town','town').'</td><td>';\n\tprint $formcompany->select_ziptown($object->town,'town',array('zipcode','selectcountry_id','state_id'));\n\tprint '</td></tr>';\n\n\t// Country\n\tprint '<tr><td>'.fieldLabel('Country','selectcountry_id').'</td><td class=\"maxwidthonsmartphone\">';\n\tprint $form->select_country((GETPOST('country_id')!=''?GETPOST('country_id'):$object->country_id));\n\tif ($user->admin) print info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"),1);\n\tprint '</td></tr>';\n\n\t// State\n\tif (empty($conf->global->USER_DISABLE_STATE))\n\t{\n\t\tprint '<tr><td>'.fieldLabel('State','state_id').'</td><td class=\"maxwidthonsmartphone\">';\n\t\tprint $formcompany->select_state($object->state_id,$object->country_code, 'state_id');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Tel\n\tprint '<tr><td>'.$langs->trans(\"PhonePro\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_phone))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.$ldap_phone.'\">';\n\t\tprint $ldap_phone;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"20\" type=\"text\" name=\"office_phone\" value=\"'.GETPOST('office_phone').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Tel portable\n\tprint '<tr><td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_mobile))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.$ldap_mobile.'\">';\n\t\tprint $ldap_mobile;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"20\" type=\"text\" name=\"user_mobile\" value=\"'.GETPOST('user_mobile').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Fax\n\tprint '<tr><td>'.$langs->trans(\"Fax\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_fax))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.$ldap_fax.'\">';\n\t\tprint $ldap_fax;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"20\" type=\"text\" name=\"office_fax\" value=\"'.GETPOST('office_fax').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Skype\n\tif (! empty($conf->skype->enabled))\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"Skype\").'</td>';\n\t\tprint '<td>';\n\t\tif (! empty($ldap_skype))\n\t\t{\n\t\t\tprint '<input type=\"hidden\" name=\"skype\" value=\"'.$ldap_skype.'\">';\n\t\t\tprint $ldap_skype;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tprint '<input class=\"maxwidth200\" type=\"text\" name=\"skype\" value=\"'.GETPOST('skype').'\">';\n\t\t}\n\t\tprint '</td></tr>';\n\t}\n\n\t// EMail\n\tprint '<tr><td'.(! empty($conf->global->USER_MAIL_REQUIRED)?' class=\"fieldrequired\"':'').'>'.$langs->trans(\"EMail\").'</td>';\n\tprint '<td>';\n\tif (! empty($ldap_mail))\n\t{\n\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.$ldap_mail.'\">';\n\t\tprint $ldap_mail;\n\t}\n\telse\n\t{\n\t\tprint '<input size=\"40\" type=\"text\" name=\"email\" value=\"'.GETPOST('email').'\">';\n\t}\n\tprint '</td></tr>';\n\n\t// Accountancy code\n\tif ($conf->accounting->enabled)\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"30\" type=\"text\" name=\"accountancy_code\" value=\"'.GETPOST('accountancy_code').'\">';\n\t\tprint '</td></tr>';\n\t}\n\n\t// User color\n\tif (! empty($conf->agenda->enabled))\n\t{\n\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\tprint '<td>';\n\t\tprint $formother->selectColor(GETPOST('color')?GETPOST('color'):$object->color, 'color', null, 1, '', 'hideifnotset');\n\t\tprint '</td></tr>';\n\t}\n\n\t// Categories\n\tif (! empty($conf->categorie->enabled)  && ! empty($user->rights->categorie->lire))\n\t{\n\t\tprint '<tr><td>' . fieldLabel('Categories', 'usercats') . '</td><td colspan=\"3\">';\n\t\t$cate_arbo = $form->select_all_categories('user', null, 'parent', null, null, 1);\n\t\tprint $form->multiselectarray('usercats', $cate_arbo, GETPOST('usercats', 'array'), null, null, null,\n\t\t\tnull, '90%' );\n\t\tprint \"</td></tr>\";\n\t}\n\n\t// Multicompany\n\tif (! empty($conf->multicompany->enabled) && is_object($mc))\n\t{\n\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\tif (! method_exists($mc, 'formObjectOptions'))\n\t\t{\n\t\t\tif (empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && ! $user->entity)\t// condition must be same for create and edit mode\n\t\t\t{\n\t\t\t\t print \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t\t\t\t print \"<td>\".$mc->select_entities($conf->entity);\n\t\t\t\t print \"</td></tr>\\n\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t print '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t}\n\t\t }\n\t}\n\n\t// Other attributes\n\t$parameters=array('objectsrc' => $objectsrc, 'colspan' => ' colspan=\"3\"');\n\t$reshook=$hookmanager->executeHooks('formObjectOptions',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\tprint $hookmanager->resPrint;\n\tif (empty($reshook))\n\t{\n\t\tprint $object->showOptionals($extrafields,'edit');\n\t}\n\n\t// Note\n\tprint '<tr><td class=\"tdtop\">';\n\tprint $langs->trans(\"Note\");\n\tprint '</td><td>';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor=new DolEditor('note','','',120,'dolibarr_notes','',false,true,$conf->global->FCKEDITOR_ENABLE_SOCIETE,ROWS_3,'90%');\n\t$doleditor->Create();\n\tprint \"</td></tr>\\n\";\n\n\t// Signature\n\tprint '<tr><td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\tprint '<td>';\n\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t$doleditor=new DolEditor('signature',GETPOST('signature'),'',138,'dolibarr_notes','In',true,true,empty($conf->global->FCKEDITOR_ENABLE_USERSIGN)?0:1,ROWS_4,'90%');\n\tprint $doleditor->Create(1);\n\tprint '</td></tr>';\n\n\n\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t// Position/Job\n\tprint '<tr><td class=\"titlefieldcreate\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\tprint '<td>';\n\tprint '<input class=\"maxwidth200\" type=\"text\" name=\"job\" value=\"'.GETPOST('job').'\">';\n\tprint '</td></tr>';\n\n\n\tif ((! empty($conf->salaries->enabled) && ! empty($user->rights->salaries->read))\n\t\t|| (! empty($conf->hrm->enabled) && ! empty($user->rights->hrm->employee->read)))\n\t{\n\t\t$langs->load(\"salaries\");\n\n\t\t// THM\n\t\tprint '<tr><td>';\n\t\t$text=$langs->trans(\"THM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.GETPOST('thm').'\">';\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// TJM\n\t\tprint '<tr><td>';\n\t\t$text=$langs->trans(\"TJM\");\n\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\tprint '</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.GETPOST('tjm').'\">';\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\n\t\t// Salary\n\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\tprint '<td>';\n\t\tprint '<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.GETPOST('salary').'\">';\n\t\tprint '</td>';\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t// Weeklyhours\n\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\tprint '<td>';\n\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.GETPOST('weeklyhours').'\">';\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date employment\n\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\tprint '<td>';\n\techo $form->select_date(GETPOST('dateemployment'),'dateemployment',0,0,1,'form'.'dateemployment',1,0,1);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\t// Date birth\n\tprint '<tr><td>'.$langs->trans(\"DateToBirth\").'</td>';\n\tprint '<td>';\n\techo $form->select_date(GETPOST('birth'),'birth',0,0,1,'createuser',1,0,1);\n\tprint '</td>';\n\tprint \"</tr>\\n\";\n\n\tprint \"</table>\\n\";\n\n \tdol_fiche_end();\n\n\tprint '<div align=\"center\">';\n\tprint '<input class=\"button\" value=\"'.$langs->trans(\"CreateUser\").'\" name=\"create\" type=\"submit\">';\n\t//print '&nbsp; &nbsp; &nbsp;';\n\t//print '<input value=\"'.$langs->trans(\"Cancel\").'\" class=\"button\" type=\"submit\" name=\"cancel\">';\n\tprint '</div>';\n\n\tprint \"</form>\";\n}\nelse\n{\n\t/* ************************************************************************** */\n\t/*                                                                            */\n\t/* View and edition                                                            */\n\t/*                                                                            */\n\t/* ************************************************************************** */\n\n\tif ($id > 0)\n\t{\n\t\t$object->fetch($id, '', '', 1);\n\t\tif ($res < 0) { dol_print_error($db,$object->error); exit; }\n\t\t$res=$object->fetch_optionals();\n\n\t\t// Check if user has rights\n\t\t$object->getrights();\n\t\tif (empty($object->nb_rights) && $object->statut != 0 && empty($object->admin)) setEventMessages($langs->trans('UserHasNoPermissions'), null, 'warnings');\n\n\t\t// Connexion ldap\n\t\t// pour recuperer passDoNotExpire et userChangePassNextLogon\n\t\tif (! empty($conf->ldap->enabled) && ! empty($object->ldap_sid))\n\t\t{\n\t\t\t$ldap = new Ldap();\n\t\t\t$result=$ldap->connect_bind();\n\t\t\tif ($result > 0)\n\t\t\t{\n\t\t\t\t$userSearchFilter = '('.$conf->global->LDAP_FILTER_CONNECTION.'('.$ldap->getUserIdentifier().'='.$object->login.'))';\n\t\t\t\t$entries = $ldap->fetch($object->login,$userSearchFilter);\n\t\t\t\tif (! $entries)\n\t\t\t\t{\n\t\t\t\t\tsetEventMessages($ldap->error, $ldap->errors, 'errors');\n\t\t\t\t}\n\n\t\t\t\t$passDoNotExpire = 0;\n\t\t\t\t$userChangePassNextLogon = 0;\n\t\t\t\t$userDisabled = 0;\n\t\t\t\t$statutUACF = '';\n\n\t\t\t\t// Check options of user account\n\t\t\t\tif (count($ldap->uacf) > 0)\n\t\t\t\t{\n\t\t\t\t\tforeach ($ldap->uacf as $key => $statut)\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($key == 65536)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$passDoNotExpire = 1;\n\t\t\t\t\t\t\t$statutUACF = $statut;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$userDisabled = 1;\n\t\t\t\t\t$statutUACF = \"ACCOUNTDISABLE\";\n\t\t\t\t}\n\n\t\t\t\tif ($ldap->pwdlastset == 0)\n\t\t\t\t{\n\t\t\t\t\t$userChangePassNextLogon = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Show tabs\n\t\tif ($mode == 'employee') // For HRM module development\n\t\t{\n\t\t\t$title = $langs->trans(\"Employee\");\n\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/hrm/employee/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$title = $langs->trans(\"User\");\n\t\t\t$linkback = '';\n\n\t\t\tif ($user->rights->user->user->lire || $user->admin) {\n\t\t\t\t$linkback = '<a href=\"'.DOL_URL_ROOT.'/user/list.php?restore_lastsearch_values=1\">'.$langs->trans(\"BackToList\").'</a>';\n\t\t\t}\n\t\t}\n\n\t\t$head = user_prepare_head($object);\n\n\t\t/*\n         * Confirmation reinitialisation mot de passe\n         */\n\t\tif ($action == 'password')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"ReinitPassword\"),$langs->trans(\"ConfirmReinitPassword\",$object->login),\"confirm_password\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirmation envoi mot de passe\n         */\n\t\tif ($action == 'passwordsend')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"SendNewPassword\"),$langs->trans(\"ConfirmSendNewPassword\",$object->login),\"confirm_passwordsend\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirm deactivation\n         */\n\t\tif ($action == 'disable')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"DisableAUser\"),$langs->trans(\"ConfirmDisableUser\",$object->login),\"confirm_disable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirm activation\n         */\n\t\tif ($action == 'enable')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"EnableAUser\"),$langs->trans(\"ConfirmEnableUser\",$object->login),\"confirm_enable\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Confirmation suppression\n         */\n\t\tif ($action == 'delete')\n\t\t{\n\t\t\tprint $form->formconfirm($_SERVER['PHP_SELF'].\"?id=$object->id\",$langs->trans(\"DeleteAUser\"),$langs->trans(\"ConfirmDeleteUser\",$object->login),\"confirm_delete\", '', 0, 1);\n\t\t}\n\n\t\t/*\n         * Fiche en mode visu\n         */\n\t\tif ($action != 'edit')\n\t\t{\n\t\t\tdol_fiche_head($head, 'user', $title, -1, 'user');\n\n\t\t\tdol_banner_tab($object,'id',$linkback,$user->rights->user->user->lire || $user->admin);\n\n\t\t\tprint '<div class=\"fichecenter\">';\n\t\t\tprint '<div class=\"fichehalfleft\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\t\t\tprint '<table class=\"border tableforfield\" width=\"100%\">';\n\n\t\t\t// Login\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Login\").'</td>';\n\t\t\tif (! empty($object->ldap_sid) && $object->statut==0)\n\t\t\t{\n\t\t\t\tprint '<td class=\"error\">'.$langs->trans(\"LoginAccountDisableInDolibarr\").'</td>';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<td>'.$object->login.'</td>';\n\t\t\t}\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// Password\n\t\t\tprint '<tr><td>'.$langs->trans(\"Password\").'</td>';\n\n\t\t\tprint '<td>';\n\t\t\t$valuetoshow='';\n\t\t\tif (preg_match('/ldap/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\tif (! empty($object->ldap_sid))\n\t\t\t\t{\n\t\t\t\t\tif ($passDoNotExpire)\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"LdapUacf_\".$statutUACF);\n\t\t\t\t\t}\n\t\t\t\t\telse if($userChangePassNextLogon)\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').'<span class=\"warning\">'.$langs->trans(\"UserMustChangePassNextLogon\",$ldap->domainFQDN).'</span>';\n\t\t\t\t\t}\n\t\t\t\t\telse if($userDisabled)\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').'<span class=\"warning\">'.$langs->trans(\"LdapUacf_\".$statutUACF,$ldap->domainFQDN).'</span>';\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (preg_match('/http/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"HTTPBasicPassword\");\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\tif ($object->pass) $valuetoshow.= preg_replace('/./i','*',$object->pass);\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif ($user->admin) $valuetoshow.= ($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"Crypted\").': '.$object->pass_indatabase_crypted;\n\t\t\t\t\telse $valuetoshow.= ($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"Hidden\");\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters=array('valuetoshow' => $valuetoshow);\n\t\t\t$reshook=$hookmanager->executeHooks('printUserPasswordField',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) $valuetoshow=$hookmanager->resPrint;\t// to replace\n\t\t\telse $valuetoshow.=$hookmanager->resPrint;\t\t\t\t// to add\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td>\";\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t// API key\n\t\t\tif (! empty($conf->api->enabled) && $user->admin) {\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (! empty($object->api_key)) print preg_replace('/./','*',$object->api_key);\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Administrator\n\t\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td><td>';\n\t\t\tif (! empty($conf->multicompany->enabled) && $object->admin && ! $object->entity)\n\t\t\t{\n\t\t\t\tprint $form->textwithpicto(yn($object->admin),$langs->trans(\"SuperAdministratorDesc\"),1,\"superadmin\");\n\t\t\t}\n\t\t\telse if ($object->admin)\n\t\t\t{\n\t\t\t\tprint $form->textwithpicto(yn($object->admin),$langs->trans(\"AdministratorDesc\"),1,\"admin\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint yn($object->admin);\n\t\t\t}\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// Type\n\t\t\tprint '<tr><td>';\n\t\t\t$text=$langs->trans(\"Type\");\n\t\t\tprint $form->textwithpicto($text, $langs->trans(\"InternalExternalDesc\"));\n\t\t\tprint '</td><td>';\n\t\t\t$type=$langs->trans(\"Internal\");\n\t\t\tif ($object->societe_id > 0) $type=$langs->trans(\"External\");\n\t\t\tprint $type;\n\t\t\tif ($object->ldap_sid) print ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// Ldap sid\n\t\t\tif ($object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Type\").'</td><td>';\n\t\t\t\tprint $langs->trans(\"DomainUser\",$ldap->domainFQDN);\n\t\t\t\tprint '</td></tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Gender\n\t\t\tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($object->gender) print $langs->trans(\"Gender\".$object->gender);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Employee\n\t\t\tprint '<tr><td>'.$langs->trans(\"Employee\").'</td><td colspan=\"2\">';\n\t\t\tprint yn($object->employee);\n\t\t\tprint '</td></tr>'.\"\\n\";\n\n\t\t\t// TODO Move this into tab RH, visible when salarie or RH is visible (HierarchicalResponsible must be on both tab)\n\n\t\t\t// Hierarchy\n\t\t\tprint '<tr><td>'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif (empty($object->fk_user)) print $langs->trans(\"None\");\n\t\t\telse {\n\t\t\t\t$huser=new User($db);\n\t\t\t\t$huser->fetch($object->fk_user);\n\t\t\t\tprint $huser->getNomUrl(1);\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td>'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>'.$object->job.'</td>';\n\t\t\tprint '</tr>'.\"\\n\";\n\n\t\t\t//$childids = $user->getAllChildIds(1);\n\n\t\t\tif ((! empty($conf->salaries->enabled) && ! empty($user->rights->salaries->read))\n\t\t\t\t|| (! empty($conf->hrm->enabled) && ! empty($user->rights->hrm->employee->read)))\n\t\t\t{\n            \t// Even a superior can't see this info of its subordinates wihtout $user->rights->salaries->read and $user->rights->hrm->employee->read (setting/viewing is reserverd to HR people).\n            \t// However, he can see the valuation of timesheet of its subordinates even without these permissions.\n\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->thm!=''?price($object->thm,'',$langs,1,-1,-1,$conf->currency):'');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classtjm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->tjm!=''?price($object->tjm,'',$langs,1,-1,-1,$conf->currency):'');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint ($object->salary!=''?price($object->salary,'',$langs,1,-1,-1,$conf->currency):'');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint price2num($object->weeklyhours);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint dol_print_date($object->dateemployment, 'day');\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date of birth\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateToBirth\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint dol_print_date($object->birth, 'day');\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Accountancy code\n\t\t\tif ($conf->accounting->enabled)\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>'.$object->accountancy_code.'</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table>';\n\n\t\t\tprint '</div>';\n\t\t\tprint '<div class=\"fichehalfright\"><div class=\"ficheaddleft\">';\n\n\t\t\tprint '<div class=\"underbanner clearboth\"></div>';\n\t\t\tprint '<table class=\"border tableforfield\" width=\"100%\">';\n\n\t\t\t// Color user\n\t\t\tif (! empty($conf->agenda->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $formother->showColor($object->color, '');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Categories\n\t\t\tif (! empty($conf->categorie->enabled)  && ! empty($user->rights->categorie->lire))\n\t\t\t{\n\t\t\t\tprint '<tr><td>' . $langs->trans( \"Categories\" ) . '</td>';\n\t\t\t\tprint '<td colspan=\"3\">';\n\t\t\t\tprint $form->showCategories( $object->id, 'user', 1 );\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/',$conf->file->main_authentication) && ! empty($conf->global->MAIN_OPENIDURL_PERUSER))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>'.$object->openid.'</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"LastConnexion\").'</td>';\n\t\t\tprint '<td>'.dol_print_date($object->datelastlogin,\"dayhour\").'</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '<tr><td>'.$langs->trans(\"PreviousConnexion\").'</td>';\n\t\t\tprint '<td>'.dol_print_date($object->datepreviouslogin,\"dayhour\").'</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t    // Multicompany\n\t\t\tif (! empty($conf->multicompany->enabled) && is_object($mc))\n\t\t\t{\n\t\t\t\t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n\t\t\t\tif (! method_exists($mc, 'formObjectOptions'))\n\t\t\t\t{\n\t\t\t\t     if (! empty($conf->multicompany->enabled) && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE) && $conf->entity == 1 && $user->admin && ! $user->entity)\n\t\t\t\t     {\n\t\t\t\t     \tprint '<tr><td>' . $langs->trans(\"Entity\") . '</td><td>';\n\t\t\t\t     \tif (empty($object->entity)) {\n\t\t\t\t     \t\tprint $langs->trans(\"AllEntities\");\n\t\t\t\t     \t} else {\n\t\t\t\t     \t\t$mc->getInfo($object->entity);\n\t\t\t\t     \t\tprint $mc->label;\n\t\t\t\t     \t}\n\t\t\t\t     \tprint \"</td></tr>\\n\";\n\t\t\t\t     }\n\t\t\t     }\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\tinclude DOL_DOCUMENT_ROOT . '/core/tpl/extrafields_view.tpl.php';\n\n\t\t\t// Company / Contact\n\t\t\tif (! empty($conf->societe->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif (isset($object->socid) && $object->socid > 0)\n\t\t\t\t{\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tprint $societe->getNomUrl(1,'');\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"ThisUserIsNot\");\n\t\t\t\t}\n\t\t\t\tif (! empty($object->contactid))\n\t\t\t\t{\n\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t$contact->fetch($object->contactid);\n\t\t\t\t\tif ($object->socid > 0) print ' / ';\n\t\t\t\t\telse print '<br>';\n\t\t\t\t\tprint '<a href=\"'.DOL_URL_ROOT.'/contact/card.php?id='.$object->contactid.'\">'.img_object($langs->trans(\"ShowContact\"),'contact').' '.dol_trunc($contact->getFullName($langs),32).'</a>';\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (! empty($conf->adherent->enabled))\n\t\t\t{\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member)\n\t\t\t\t{\n\t\t\t\t\t$adh=new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref=$adh->getFullname($langs);\t// Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"UserNotLinkedToMember\");\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>'.\"\\n\";\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint '<tr><td class=\"tdtop\">'.$langs->trans('Signature').'</td><td>';\n\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\tprint \"</table>\\n\";\n\t\t\tprint '</div>';\n\n\t\t\tprint '</div></div>';\n\t\t\tprint '<div style=\"clear:both\"></div>';\n\n\n\t\t\tdol_fiche_end();\n\n\n\t\t\t/*\n             * Buttons actions\n             */\n\n\t\t\tprint '<div class=\"tabsAction\">';\n\n\t\t\t$parameters=array();\n\t\t\t$reshook=$hookmanager->executeHooks('addMoreActionsButtons',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tif (empty($reshook))\n\t\t\t{\n\t\t\t\tif (! empty($object->email))\n\t\t\t\t{\n\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=presend&amp;mode=init#presend\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$langs->load(\"mails\");\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans('SendMail').'</a></div>';\n\t\t\t\t}\n\n\t\t\t\tif ($caneditfield && (empty($conf->multicompany->enabled) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tif (! empty($conf->global->MAIN_ONLY_LOGIN_ALLOWED))\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"DisabledInMonoUserMode\")).'\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=edit\">'.$langs->trans(\"Modify\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telseif ($caneditpassword && ! $object->ldap_sid &&\n\t\t\t\t(empty($conf->multicompany->enabled) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=edit\">'.$langs->trans(\"EditPassword\").'</a></div>';\n\t\t\t\t}\n\n\t\t\t\t// Si on a un gestionnaire de generation de mot de passe actif\n\t\t\t\tif ($conf->global->USER_PASSWORD_GENERATED != 'none')\n\t\t\t\t{\n\t\t\t\t\tif ($object->statut == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telseif (($user->id != $id && $caneditpassword) && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=password\">'.$langs->trans(\"ReinitPassword\").'</a></div>';\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($object->statut == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"UserDisabled\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telse if (($user->id != $id && $caneditpassword) && $object->login && !$object->ldap_sid &&\n\t\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($object->email) print '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=passwordsend\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t\telse print '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"NoEMail\")).'\">'.$langs->trans(\"SendNewPassword\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Activer\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 0 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butAction\" href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=enable\">'.$langs->trans(\"Reactivate\").'</a></div>';\n\t\t\t\t}\n\t\t\t\t// Desactiver\n\t\t\t\tif ($user->id <> $id && $candisableuser && $object->statut == 1 &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?action=disable&amp;id='.$object->id.'\">'.$langs->trans(\"DisableUser\").'</a></div>';\n\t\t\t\t}\n\t\t\t\t// Delete\n\t\t\t\tif ($user->id <> $id && $candisableuser &&\n\t\t\t\t((empty($conf->multicompany->enabled) && $object->entity == $user->entity) || ! $user->entity || ($object->entity == $conf->entity) || ($conf->global->MULTICOMPANY_TRANSVERSE_MODE && $conf->entity == 1)))\n\t\t\t\t{\n\t\t\t\t\tif ($user->admin || ! $object->admin) // If user edited is admin, delete is possible on for an admin\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionDelete\" href=\"'.$_SERVER['PHP_SELF'].'?action=delete&amp;id='.$object->id.'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<div class=\"inline-block divButAction\"><a class=\"butActionRefused\" href=\"#\" title=\"'.dol_escape_htmltag($langs->trans(\"MustBeAdminToDeleteOtherAdmin\")).'\">'.$langs->trans(\"DeleteUser\").'</a></div>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tprint \"</div>\\n\";\n\n\n\n\t\t\t//Select mail models is same action as presend\n\t\t\tif (GETPOST('modelselected')) $action = 'presend';\n\n\t\t\t// Presend form\n\t\t\t$modelmail='user';\n\t\t\t$defaulttopic='Information';\n\t\t\t$diroutput = $conf->user->dir_output;\n\t\t\t$trackid = 'use'.$object->id;\n\n\t\t\tinclude DOL_DOCUMENT_ROOT.'/core/tpl/card_presend.tpl.php';\n\n\t\t\tif ($action != 'presend' && $action != 'send')\n\t\t\t{\n\t\t\t\t/*\n                 * List of groups of user\n                 */\n\n\t\t\t\tif ($canreadgroup)\n\t\t\t\t{\n\t\t\t\t\tprint load_fiche_titre($langs->trans(\"ListOfGroupsForUser\"),'','');\n\n\t\t\t\t\t// On selectionne les groupes auquel fait parti le user\n\t\t\t\t\t$exclude = array();\n\n\t\t\t\t\t$usergroup=new UserGroup($db);\n\t\t\t\t\t$groupslist = $usergroup->listGroupsForUser($object->id);\n\n\t\t\t\t\tif (! empty($groupslist))\n\t\t\t\t\t{\n\t\t\t\t\t\tforeach($groupslist as $groupforuser)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$exclude[]=$groupforuser->id;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$id.'\" method=\"POST\">'.\"\\n\";\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\" />';\n\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"addgroup\" />';\n\t\t\t\t\t}\n\n\t\t\t\t\tprint '<table class=\"noborder\" width=\"100%\">'.\"\\n\";\n\n\t\t\t\t\t// Other form for add user to group\n\t\t\t\t\t$parameters=array('caneditgroup' => $caneditgroup, 'groupslist' => $groupslist, 'exclude' => $exclude);\n\t\t\t\t\t$reshook=$hookmanager->executeHooks('formAddUserToGroup',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\t\t\tprint $hookmanager->resPrint;\n\n\t\t\t\t\tif (empty($reshook))\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '<tr class=\"liste_titre\"><th class=\"liste_titre\">'.$langs->trans(\"Groups\").'</th>'.\"\\n\";\n\t\t\t\t\t\tprint '<th class=\"liste_titre\" align=\"right\">';\n\t\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprint $form->select_dolgroups('', 'group', 1, $exclude, 0, '', '', $object->entity);\n\t\t\t\t\t\t\tprint ' &nbsp; ';\n\t\t\t\t\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t\t\t\t\t\t\tprint '<input type=\"submit\" class=\"button\" value=\"'.$langs->trans(\"Add\").'\" />';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tprint '</th></tr>'.\"\\n\";\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t * Groups assigned to user\n\t\t\t\t\t\t */\n\t\t\t\t\t\tif (! empty($groupslist))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tforeach($groupslist as $group)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tprint '<tr class=\"oddeven\">';\n\t\t\t\t\t\t\t\tprint '<td>';\n\t\t\t\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint '<a href=\"'.DOL_URL_ROOT.'/user/group/card.php?id='.$group->id.'\">'.img_object($langs->trans(\"ShowGroup\"),\"group\").' '.$group->name.'</a>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint img_object($langs->trans(\"ShowGroup\"),\"group\").' '.$group->name;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint '</td>';\n\t\t\t\t\t\t\t\tprint '<td align=\"right\">';\n\t\t\t\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint '<a href=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'&amp;action=removegroup&amp;group='.$group->id.'\">';\n\t\t\t\t\t\t\t\t\tprint img_picto($langs->trans(\"RemoveFromGroup\"), 'unlink');\n\t\t\t\t\t\t\t\t\tprint '</a>';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tprint \"&nbsp;\";\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tprint \"</td></tr>\\n\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprint '<tr class=\"oddeven\"><td colspan=\"3\" class=\"opacitymedium\">'.$langs->trans(\"None\").'</td></tr>';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tprint \"</table>\";\n\n\t\t\t\t\tif ($caneditgroup)\n\t\t\t\t\t{\n\t\t\t\t\t\tprint '</form>';\n\t\t\t\t\t}\n\t\t\t\t\tprint \"<br>\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t/*\n         * Fiche en mode edition\n         */\n\t\tif ($action == 'edit' && ($canedituser || $caneditfield || $caneditpassword || ($user->id == $object->id)))\n\t\t{\n\t\t\tprint '<form action=\"'.$_SERVER['PHP_SELF'].'?id='.$object->id.'\" method=\"POST\" name=\"updateuser\" enctype=\"multipart/form-data\">';\n\t\t\tprint '<input type=\"hidden\" name=\"token\" value=\"'.$_SESSION['newtoken'].'\">';\n\t\t\tprint '<input type=\"hidden\" name=\"action\" value=\"update\">';\n\t\t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$object->entity.'\">';\n\n\t\t\tdol_fiche_head($head, 'user', $title, 0, 'user');\n\n\t\t\tprint '<table width=\"100%\" class=\"border\">';\n\n\t\t\t// Ref/ID\n\t\t\tif (! empty($conf->global->MAIN_SHOW_TECHNICAL_ID))\n\t\t\t{\n\t\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"Ref\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $object->id;\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '</tr>';\n\t\t\t}\n\n\t\t\t// Lastname\n\t\t\tprint \"<tr>\";\n\t\t\tprint '<td class=\"titlefield fieldrequired\">'.$langs->trans(\"Lastname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"lastname\" value=\"'.$object->lastname.'\">';\n\t\t\t\tprint $object->lastname;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Firstname\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Firstname\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && !$object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" class=\"flat\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"firstname\" value=\"'.$object->firstname.'\">';\n\t\t\t\tprint $object->firstname;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Login\n\t\t\tprint \"<tr>\".'<td><span class=\"fieldrequired\">'.$langs->trans(\"Login\").'</span></td>';\n\t\t\tprint '<td>';\n\t\t\tif ($user->admin  && !$object->ldap_sid)\n\t\t\t{\n\t\t\t\tprint '<input size=\"12\" maxlength=\"24\" type=\"text\" class=\"flat\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"login\" value=\"'.$object->login.'\">';\n\t\t\t\tprint $object->login;\n\t\t\t}\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Pass\n\t\t\tprint '<tr><td>'.$langs->trans(\"Password\").'</td>';\n\t\t\tprint '<td>';\n\t\t\t$valuetoshow='';\n\t\t\tif (preg_match('/ldap/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$langs->trans(\"PasswordOfUserInLDAP\");\n\t\t\t}\n\t\t\tif (preg_match('/http/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').$form->textwithpicto($text,$langs->trans(\"DolibarrInHttpAuthenticationSoPasswordUseless\",$dolibarr_main_authentication),1,'warning');\n\t\t\t}\n\t\t\tif (preg_match('/dolibarr/',$dolibarr_main_authentication))\n\t\t\t{\n\t\t\t\tif ($caneditpassword)\n\t\t\t\t{\n\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').'<input size=\"12\" maxlength=\"32\" type=\"password\" class=\"flat\" name=\"password\" value=\"'.$object->pass.'\" autocomplete=\"new-password\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$valuetoshow.=($valuetoshow?(' '.$langs->trans(\"or\").' '):'').preg_replace('/./i','*',$object->pass);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Other form for user password\n\t\t\t$parameters=array('valuetoshow' => $valuetoshow, 'caneditpassword' => $caneditpassword);\n\t\t\t$reshook=$hookmanager->executeHooks('printUserPasswordField',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tif ($reshook > 0) $valuetoshow=$hookmanager->resPrint;\t// to replace\n\t\t\telse $valuetoshow.=$hookmanager->resPrint;\t\t\t\t// to add\n\n\t\t\tprint $valuetoshow;\n\t\t\tprint \"</td></tr>\\n\";\n\n\t\t\t// API key\n\t\t\tif(! empty($conf->api->enabled) && $user->admin)\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ApiKey\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input class=\"minwidth300\" maxsize=\"32\" type=\"text\" id=\"api_key\" name=\"api_key\" value=\"'.$object->api_key.'\" autocomplete=\"off\">';\n\t\t\t\tif (! empty($conf->use_javascript_ajax))\n\t\t\t\t\tprint '&nbsp;'.img_picto($langs->trans('Generate'), 'refresh', 'id=\"generate_api_key\" class=\"linkobject\"');\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Administrator\n\t\t\tprint '<tr><td>'.$langs->trans(\"Administrator\").'</td>';\n\t\t\tif ($object->socid > 0)\n\t\t\t{\n\t\t\t\t$langs->load(\"admin\");\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">'.yn($object->admin);\n\t\t\t\tprint ' ('.$langs->trans(\"ExternalUser\").')';\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<td>';\n\t\t\t\t$nbAdmin = $user->getNbOfUsers('active','',1);\n\t\t\t\t$nbSuperAdmin = $user->getNbOfUsers('active','superadmin',1);\n\t\t\t\t//var_dump($nbAdmin);\n\t\t\t\t//var_dump($nbSuperAdmin);\n\t\t\t\tif ($user->admin\t\t\t\t\t\t\t\t// Need to be admin to allow downgrade of an admin\n\t\t\t\t&& ($user->id != $object->id)                   // Don't downgrade ourself\n\t\t\t\t&& (\n\t\t\t\t\t(empty($conf->multicompany->enabled) && $nbAdmin >= 1)\n\t\t\t\t\t|| (! empty($conf->multicompany->enabled) && ($object->entity > 0 || $nbSuperAdmin > 1))    // Don't downgrade a superadmin if alone\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tprint $form->selectyesno('admin',$object->admin,1);\n\n\t\t\t\t\tif (! empty($conf->multicompany->enabled) && ! $user->entity && empty($conf->global->MULTICOMPANY_TRANSVERSE_MODE))\n\t\t\t\t\t{\n\t\t\t\t\t\tif ($conf->use_javascript_ajax)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tprint '<script type=\"text/javascript\">\n\t\t\t\t\t\t\t\t\t$(function() {\n\t\t\t\t\t\t\t\t\t\tvar admin = $(\"select[name=admin]\").val();\n\t\t\t\t\t\t\t\t\t\tif (admin == 0) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tif ($(\"input[name=superadmin]\").is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$(\"select[name=admin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\t if ( $(this).val() == 0 ) {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"checked\", false);\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t } else {\n\t\t\t\t\t\t\t\t\t\t\t \t$(\"input[name=superadmin]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t }\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t$(\"input[name=superadmin]\").change(function() {\n\t\t\t\t\t\t\t\t\t\t\tif ( $(this).is(\":checked\")) {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", true);\n\t\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\t$(\"select[name=entity]\")\n\t\t\t\t\t\t\t\t\t\t\t\t\t.prop(\"disabled\", false);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t</script>';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t$checked=(($object->admin && ! $object->entity) ? ' checked' : '');\n\t\t\t\t\t\tprint '<input type=\"checkbox\" name=\"superadmin\" value=\"1\"'.$checked.' /> '.$langs->trans(\"SuperAdministrator\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$yn = yn($object->admin);\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"admin\" value=\"'.$object->admin.'\">';\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"superadmin\" value=\"'.(empty($object->entity) ? 1 : 0).'\">';\n\t\t\t\t\tif (! empty($conf->multicompany->enabled) && empty($object->entity)) print $form->textwithpicto($yn,$langs->trans(\"DontDowngradeSuperAdmin\"),1,'warning');\n\t\t\t\t\telse print $yn;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t   \t// Type\n\t\t   \tprint '<tr><td>'.$langs->trans(\"Type\").'</td>';\n\t\t   \tprint '<td>';\n\t\t   \tif ($user->id == $object->id || ! $user->admin)\n\t\t   \t{\n\t\t\t   \t$type=$langs->trans(\"Internal\");\n\t\t\t   \tif ($object->socid) $type=$langs->trans(\"External\");\n\t\t\t   \tprint $form->textwithpicto($type,$langs->trans(\"InternalExternalDesc\"));\n\t\t\t   \tif ($object->ldap_sid) print ' ('.$langs->trans(\"DomainUser\").')';\n\t\t   \t}\n\t\t   \telse\n\t\t\t{\n\t\t\t\t$type=0;\n\t\t\t\tif ($object->contactid) $type=$object->contactid;\n\t\t\t\tprint $form->selectcontacts(0,$type,'contactid',2,'','',1,'',false,1);\n\t\t\t   \tif ($object->ldap_sid) print ' ('.$langs->trans(\"DomainUser\").')';\n\t\t\t}\n\t\t   \tprint '</td></tr>';\n\n\t\t   \t// Gender\n\t\t   \tprint '<tr><td>'.$langs->trans(\"Gender\").'</td>';\n\t\t   \tprint '<td>';\n\t\t   \t$arraygender=array('man'=>$langs->trans(\"Genderman\"),'woman'=>$langs->trans(\"Genderwoman\"));\n\t\t   \tprint $form->selectarray('gender', $arraygender, GETPOST('gender')?GETPOST('gender'):$object->gender, 1);\n\t\t   \tprint '</td></tr>';\n\n\t\t   \t// Employee\n\t\t   \tprint '<tr>';\n\t\t   \tprint '<td>'.fieldLabel('Employee','employee',0).'</td><td>';\n\t\t   \tprint $form->selectyesno(\"employee\",$object->employee,1);\n\t\t   \tprint '</td></tr>';\n\n\t\t   \t// Hierarchy\n\t\t   \tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"HierarchicalResponsible\").'</td>';\n\t\t   \tprint '<td>';\n\t\t   \tif ($caneditfield)\n\t\t   \t{\n\t\t   \t\tprint $form->select_dolusers($object->fk_user, 'fk_user', 1, array($object->id), 0, '', 0, $object->entity, 0, 0, '', 0, '', 'maxwidth300');\n\t\t   \t}\n\t\t   \telse\n\t\t   \t{\n\t\t   \t\tprint '<input type=\"hidden\" name=\"fk_user\" value=\"'.$object->fk_user.'\">';\n\t\t   \t\t$huser=new User($db);\n\t\t   \t\t$huser->fetch($object->fk_user);\n\t\t   \t\tprint $huser->getNomUrl(1);\n\t\t   \t}\n\t\t   \tprint '</td>';\n\t\t   \tprint \"</tr>\\n\";\n\n\n\t\t   \tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// Address\n\t\t\tprint '<tr><td class=\"tdtop titlefield\">'.fieldLabel('Address','address').'</td>';\n\t\t\tprint '<td><textarea name=\"address\" id=\"address\" class=\"quatrevingtpercent\" rows=\"3\" wrap=\"soft\">';\n\t\t\tprint $object->address;\n\t\t\tprint '</textarea></td></tr>';\n\n\t\t\t// Zip\n\t\t\tprint '<tr><td>'.fieldLabel('Zip','zipcode').'</td><td>';\n\t\t\tprint $formcompany->select_ziptown($object->zip, 'zipcode', array('town', 'selectcountry_id', 'state_id'), 6);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Town\n\t\t\tprint '<tr><td>'.fieldLabel('Town','town').'</td><td>';\n\t\t\tprint $formcompany->select_ziptown($object->town, 'town', array('zipcode', 'selectcountry_id', 'state_id'));\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Country\n\t\t\tprint '<tr><td>'.fieldLabel('Country','selectcounty_id').'</td><td>';\n\t\t\tprint $form->select_country((GETPOST('country_id')!=''?GETPOST('country_id'):$object->country_id),'country_id');\n\t\t\tif ($user->admin) print info_admin($langs->trans(\"YouCanChangeValuesForThisListFromDictionarySetup\"),1);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// State\n\t\t\tif (empty($conf->global->USER_DISABLE_STATE))\n\t\t\t{\n\t\t\t\tprint '<tr><td class=\"tdoverflow\">'.fieldLabel('State','state_id').'</td><td>';\n\t\t\t\tprint $formcompany->select_state($object->state_id,$object->country_code, 'state_id');\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Tel pro\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhonePro\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input size=\"20\" type=\"text\" name=\"office_phone\" class=\"flat\" value=\"'.$object->office_phone.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_phone\" value=\"'.$object->office_phone.'\">';\n\t\t\t\tprint $object->office_phone;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Tel mobile\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"PhoneMobile\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input size=\"20\" type=\"text\" name=\"user_mobile\" class=\"flat\" value=\"'.$object->user_mobile.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"user_mobile\" value=\"'.$object->user_mobile.'\">';\n\t\t\t\tprint $object->user_mobile;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Fax\n\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"Fax\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input size=\"20\" type=\"text\" name=\"office_fax\" class=\"flat\" value=\"'.$object->office_fax.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"office_fax\" value=\"'.$object->office_fax.'\">';\n\t\t\t\tprint $object->office_fax;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Skype\n\t\t\tif (! empty($conf->skype->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Skype\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t\t{\n\t\t\t\t\tprint '<input size=\"40\" type=\"text\" name=\"skype\" class=\"flat\" value=\"'.$object->skype.'\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"skype\" value=\"'.$object->skype.'\">';\n\t\t\t\t\tprint $object->skype;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// EMail\n\t\t\tprint \"<tr>\".'<td'.(! empty($conf->global->USER_MAIL_REQUIRED)?' class=\"fieldrequired\"':'').'>'.$langs->trans(\"EMail\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield  && empty($object->ldap_sid))\n\t\t\t{\n\t\t\t\tprint '<input class=\"minwidth100\" type=\"text\" name=\"email\" class=\"flat\" value=\"'.$object->email.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"email\" value=\"'.$object->email.'\">';\n\t\t\t\tprint $object->email;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\t// OpenID url\n\t\t\tif (isset($conf->file->main_authentication) && preg_match('/openid/',$conf->file->main_authentication) && ! empty($conf->global->MAIN_OPENIDURL_PERUSER))\n\t\t\t{\n\t\t\t\tprint \"<tr>\".'<td>'.$langs->trans(\"OpenIDURL\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield)\n\t\t\t\t{\n\t\t\t\t\tprint '<input class=\"minwidth100\" type=\"url\" name=\"openid\" class=\"flat\" value=\"'.$object->openid.'\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"openid\" value=\"'.$object->openid.'\">';\n\t\t\t\t\tprint $object->openid;\n\t\t\t\t}\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\t\t\t// Accountancy code\n\t\t\tif ($conf->accounting->enabled)\n\t\t\t{\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint '<td>'.$langs->trans(\"AccountancyCode\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($caneditfield)\n\t\t\t\t{\n\t\t\t\t\tprint '<input size=\"30\" type=\"text\" class=\"flat\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint '<input type=\"hidden\" name=\"accountancy_code\" value=\"'.$object->accountancy_code.'\">';\n\t\t\t\t\tprint $object->accountancy_code;\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\";\n\t\t\t}\n\n\t\t\t// User color\n\t\t\tif (! empty($conf->agenda->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"ColorUser\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint $formother->selectColor(GETPOST('color')?GETPOST('color'):$object->color, 'color', null, 1, '', 'hideifnotset');\n\t\t\t\tprint '</td></tr>';\n\t\t\t}\n\n\t\t\t// Photo\n\t\t\tprint '<tr>';\n\t\t\tprint '<td>'.$langs->trans(\"Photo\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $form->showphoto('userphoto',$object,60,0,$caneditfield,'photowithmargin','small');\n\t\t\tprint '</td>';\n\t\t\tprint '</tr>';\n\n\t\t\t// Categories\n\t\t\tif (!empty( $conf->categorie->enabled ) && !empty( $user->rights->categorie->lire ))\n\t\t\t{\n\t\t\t\tprint '<tr><td>' . fieldLabel( 'Categories', 'usercats' ) . '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\t$cate_arbo = $form->select_all_categories( Categorie::TYPE_USER, null, null, null, null, 1 );\n\t\t\t\t$c = new Categorie( $db );\n\t\t\t\t$cats = $c->containing($object->id, Categorie::TYPE_USER);\n\t\t\t\tforeach ($cats as $cat) {\n\t\t\t\t\t$arrayselected[] = $cat->id;\n\t\t\t\t}\n\t\t\t\tprint $form->multiselectarray( 'usercats', $cate_arbo, $arrayselected, '', 0, '', 0, '90%' );\n\t\t\t\tprint \"</td></tr>\";\n\t\t\t}\n\n\t\t\t// Status\n\t\t\tprint '<tr><td>'.$langs->trans(\"Status\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint $object->getLibStatut(4);\n\t\t\tprint '</td></tr>';\n\n\t\t\t// Company / Contact\n\t\t\tif (! empty($conf->societe->enabled))\n\t\t\t{\n\t\t\t\tprint '<tr><td width=\"25%\">'.$langs->trans(\"LinkToCompanyContact\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->socid > 0)\n\t\t\t\t{\n\t\t\t\t\t$societe = new Societe($db);\n\t\t\t\t\t$societe->fetch($object->socid);\n\t\t\t\t\tprint $societe->getNomUrl(1,'');\n\t\t\t\t\tif ($object->contactid)\n\t\t\t\t\t{\n\t\t\t\t\t\t$contact = new Contact($db);\n\t\t\t\t\t\t$contact->fetch($object->contactid);\n\t\t\t\t\t\tprint ' / <a href=\"'.DOL_URL_ROOT.'/contact/card.php?id='.$object->contactid.'\">'.img_object($langs->trans(\"ShowContact\"),'contact').' '.dol_trunc($contact->getFullName($langs),32).'</a>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"ThisUserIsNot\");\n\t\t\t\t}\n\t\t\t\tprint ' ('.$langs->trans(\"UseTypeFieldToChange\").')';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Module Adherent\n\t\t\tif (! empty($conf->adherent->enabled))\n\t\t\t{\n\t\t\t\t$langs->load(\"members\");\n\t\t\t\tprint '<tr><td width=\"25%\">'.$langs->trans(\"LinkedToDolibarrMember\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tif ($object->fk_member)\n\t\t\t\t{\n\t\t\t\t\t$adh=new Adherent($db);\n\t\t\t\t\t$adh->fetch($object->fk_member);\n\t\t\t\t\t$adh->ref=$adh->login;\t// Force to show login instead of id\n\t\t\t\t\tprint $adh->getNomUrl(1);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tprint $langs->trans(\"UserNotLinkedToMember\");\n\t\t\t\t}\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n            // Multicompany\n            // TODO check if user not linked with the current entity before change entity (thirdparty, invoice, etc.) !!\n            if (! empty($conf->multicompany->enabled) && is_object($mc))\n            {\n            \t// This is now done with hook formObjectOptions. Keep this code for backward compatibility with old multicompany module\n            \tif (! method_exists($mc, 'formObjectOptions'))\n            \t{\n            \t\tif (empty($conf->multicompany->transverse_mode) && $conf->entity == 1 && $user->admin && ! $user->entity)\n\t            \t{\n\t            \t\tprint \"<tr>\".'<td>'.$langs->trans(\"Entity\").'</td>';\n\t            \t\tprint \"<td>\".$mc->select_entities($object->entity, 'entity', '', 0, 1);\t\t// last parameter 1 means, show also a choice 0=>'all entities'\n\t            \t\tprint \"</td></tr>\\n\";\n\t            \t}\n\t            \telse\n\t            \t{\n\t            \t\tprint '<input type=\"hidden\" name=\"entity\" value=\"'.$conf->entity.'\" />';\n\t            \t}\n\t            }\n\t\t\t}\n\n\t\t\t// Other attributes\n\t\t\t$parameters=array('colspan' => ' colspan=\"2\"');\n\t\t\t$reshook=$hookmanager->executeHooks('formObjectOptions',$parameters,$object,$action);    // Note that $action and $object may have been modified by hook\n\t\t\tprint $hookmanager->resPrint;\n\t\t\tif (empty($reshook))\n\t\t\t{\n\t\t\t\tprint $object->showOptionals($extrafields,'edit');\n\t\t\t}\n\n\t\t\t// Signature\n\t\t\tprint \"<tr>\".'<td class=\"tdtop\">'.$langs->trans(\"Signature\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield)\n\t\t\t{\n\t\t\t\trequire_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';\n\t\t\t\t$doleditor=new DolEditor('signature',$object->signature,'',138,'dolibarr_notes','In',false,true,empty($conf->global->FCKEDITOR_ENABLE_USERSIGN)?0:1,ROWS_4,'90%');\n\t\t\t\tprint $doleditor->Create(1);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint dol_htmlentitiesbr($object->signature);\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\n\t\t\tprint '</table><hr><table class=\"border centpercent\">';\n\n\n\t\t\t// TODO Move this into tab RH (HierarchicalResponsible must be on both tab)\n\n\t\t\t// Position/Job\n\t\t\tprint '<tr><td class=\"titlefield\">'.$langs->trans(\"PostOrFunction\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tif ($caneditfield)\n\t\t\t{\n\t\t\t\tprint '<input size=\"30\" type=\"text\" name=\"job\" value=\"'.$object->job.'\">';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tprint '<input type=\"hidden\" name=\"job\" value=\"'.$object->job.'\">';\n\t\t\t\tprint $object->job;\n\t\t\t}\n\t\t\tprint '</td></tr>';\n\n\t\t\tif ((! empty($conf->salaries->enabled) && ! empty($user->rights->salaries->read))\n\t\t\t\t|| (! empty($conf->hrm->enabled) && ! empty($user->rights->hrm->employee->read)))\n\t\t\t{\n\t\t\t\t$langs->load(\"salaries\");\n\n\t\t\t\t// THM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"THM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"THMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"thm\" value=\"'.price2num(GETPOST('thm')?GETPOST('thm'):$object->thm).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// TJM\n\t\t\t\tprint '<tr><td>';\n\t\t\t\t$text=$langs->trans(\"TJM\");\n\t\t\t\tprint $form->textwithpicto($text, $langs->trans(\"TJMDescription\"), 1, 'help', 'classthm');\n\t\t\t\tprint '</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"tjm\" value=\"'.price2num(GETPOST('tjm')?GETPOST('tjm'):$object->tjm).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\n\t\t\t\t// Salary\n\t\t\t\tprint '<tr><td>'.$langs->trans(\"Salary\").'</td>';\n\t\t\t\tprint '<td>';\n\t\t\t\tprint '<input size=\"8\" type=\"text\" name=\"salary\" value=\"'.price2num(GETPOST('salary')?GETPOST('salary'):$object->salary).'\">';\n\t\t\t\tprint '</td>';\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t// Weeklyhours\n\t\t\tprint '<tr><td>'.$langs->trans(\"WeeklyHours\").'</td>';\n\t\t\tprint '<td>';\n\t\t\tprint '<input size=\"8\" type=\"text\" name=\"weeklyhours\" value=\"'.price2num(GETPOST('weeklyhours')?GETPOST('weeklyhours'):$object->weeklyhours).'\">';\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date employment\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateEmployment\").'</td>';\n\t\t\tprint '<td>';\n\t\t\techo $form->select_date(GETPOST('dateemployment')?GETPOST('dateemployment'):$object->dateemployment,'dateemployment',0,0,1,'form'.'dateemployment',1,0,1);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\t// Date birth\n\t\t\tprint '<tr><td>'.$langs->trans(\"DateToBirth\").'</td>';\n\t\t\tprint '<td>';\n\t\t\techo $form->select_date(GETPOST('birth')?GETPOST('birth'):$object->birth,'birth',0,0,1,'updateuser',1,0,1);\n\t\t\tprint '</td>';\n\t\t\tprint \"</tr>\\n\";\n\n\t\t\tprint '</table>';\n\n\t\t\tdol_fiche_end();\n\n\t\t\tprint '<div align=\"center\">';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Save\").'\" class=\"button\" type=\"submit\" name=\"save\">';\n\t\t\tprint '&nbsp; &nbsp; &nbsp;';\n\t\t\tprint '<input value=\"'.$langs->trans(\"Cancel\").'\" class=\"button\" type=\"submit\" name=\"cancel\">';\n\t\t\tprint '</div>';\n\n\t\t\tprint '</form>';\n\t\t}\n\n\t\tif ($action != 'edit' && $action != 'presend')\n\t\t{\n\t\t\tprint '<div class=\"fichecenter\"><div class=\"fichehalfleft\">';\n\t\t\t/*\n             * Documents generes\n             */\n\t\t\t$filename = dol_sanitizeFileName($object->ref);\n\t\t\t$filedir = $conf->user->dir_output . \"/\" . dol_sanitizeFileName($object->ref);\n\t\t\t$urlsource = $_SERVER[\"PHP_SELF\"] . \"?id=\" . $object->id;\n\t\t\t$genallowed = $user->rights->user->user->lire;\n\t\t\t$delallowed = $user->rights->user->user->creer;\n\n\t\t\tprint $formfile->showdocuments('user', $filename, $filedir, $urlsource, $genallowed, $delallowed, $object->modelpdf, 1, 0, 0, 28, 0, '', 0, '', $soc->default_lang);\n\t\t\t$somethingshown = $formfile->numoffiles;\n\n\t\t\t// Show links to link elements\n\t\t\t$linktoelem = $form->showLinkToObjectBlock($object, null, null);\n\t\t\t$somethingshown = $form->showLinkedObjectBlock($object, $linktoelem);\n\n\t\t\tprint '</div><div class=\"fichehalfright\"><div class=\"ficheaddleft\">';\n\n\t\t\t// List of actions on element\n\t\t\tinclude_once DOL_DOCUMENT_ROOT . '/core/class/html.formactions.class.php';\n\t\t\t$formactions = new FormActions($db);\n\t\t\t$somethingshown = $formactions->showactions($object, 'user', $socid, 1);\n\n\n\t\t\tprint '</div></div></div>';\n\t\t}\n\n\t\tif (! empty($conf->ldap->enabled) && ! empty($object->ldap_sid)) $ldap->close();\n\t}\n\n}\n\nif (! empty($conf->api->enabled) && ! empty($conf->use_javascript_ajax))\n{\n\tprint \"\\n\".'<script type=\"text/javascript\">';\n\tprint '$(document).ready(function () {\n            $(\"#generate_api_key\").click(function() {\n                $.get( \"'.DOL_URL_ROOT.'/core/ajax/security.php\", {\n                    action: \\'getrandompassword\\',\n                    generic: true\n                },\n                function(token) {\n                    $(\"#api_key\").val(token);\n                });\n            });\n    });';\n\tprint '</script>';\n}\n\nllxFooter();\n$db->close();\n"], "filenames": ["htdocs/user/card.php"], "buggy_code_start_loc": [194], "buggy_code_end_loc": [354], "fixing_code_start_loc": [194], "fixing_code_end_loc": [354], "type": "CWE-79", "message": "A stored cross-site scripting (XSS) vulnerability in Dolibarr 8.0.2 allows remote authenticated users to inject arbitrary web script or HTML via the \"address\" (POST) or \"town\" (POST) parameter to user/card.php.", "other": {"cve": {"id": "CVE-2018-19995", "sourceIdentifier": "cve@mitre.org", "published": "2019-01-03T19:29:01.087", "lastModified": "2022-11-17T17:21:59.260", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A stored cross-site scripting (XSS) vulnerability in Dolibarr 8.0.2 allows remote authenticated users to inject arbitrary web script or HTML via the \"address\" (POST) or \"town\" (POST) parameter to user/card.php."}, {"lang": "es", "value": "Una vulnerabilidad de Cross-Site Scripting (XSS) persistente en la versi\u00f3n 8.0.2 de Dolibarr permite que los atacantes remotos autenticados inyecten scripts web o HTML arbitrarios mediante el par\u00e1metro \"address\" (POST) o \"town\" (POST) en auser/card.php."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:dolibarr:dolibarr_erp\\/crm:8.0.2:*:*:*:*:*:*:*", "matchCriteriaId": "30608213-F99C-4D9E-B848-794532E85267"}]}]}], "references": [{"url": "https://github.com/Dolibarr/dolibarr/commit/4b8be6ed64763327018ac1c076f81ddffa87855e", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/Dolibarr/dolibarr/commit/bacd5110fbdc81a35030fdc322775fa15ea85924", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/Dolibarr/dolibarr/commit/4b8be6ed64763327018ac1c076f81ddffa87855e"}}