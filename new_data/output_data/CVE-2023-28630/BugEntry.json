{"buggy_code": ["/*\n * Copyright 2022 Thoughtworks, Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.thoughtworks.go.server.database;\n\nimport javax.sql.DataSource;\nimport java.io.File;\n\npublic interface BackupProcessor {\n    void backup(File targetDir, DataSource dataSource, DbProperties dbProperties) throws Exception;\n\n    boolean accepts(String url);\n}\n", "/*\n * Copyright 2022 Thoughtworks, Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.thoughtworks.go.server.database.mysql;\n\nimport com.mysql.cj.conf.ConnectionUrl;\nimport com.mysql.cj.conf.HostInfo;\nimport com.thoughtworks.go.server.database.BackupProcessor;\nimport com.thoughtworks.go.server.database.DbProperties;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.tools.ant.types.Commandline;\nimport org.zeroturnaround.exec.ProcessExecutor;\nimport org.zeroturnaround.exec.ProcessResult;\nimport org.zeroturnaround.exec.stream.slf4j.Slf4jStream;\n\nimport javax.sql.DataSource;\nimport java.io.File;\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.concurrent.TimeoutException;\n\nimport static org.apache.commons.lang3.StringUtils.isNotBlank;\n\n@Slf4j\npublic class MySQLBackupProcessor implements BackupProcessor {\n\n    @Override\n    public void backup(File targetDir, DataSource dataSource, DbProperties dbProperties) throws InterruptedException, TimeoutException, IOException {\n        ProcessResult processResult = createProcessExecutor(targetDir, dbProperties).execute();\n\n        if (processResult.getExitValue() == 0) {\n            log.info(\"MySQL backup finished successfully.\");\n        } else {\n            log.warn(\"There was an error backing up the database using `mysqldump`. The `mysqldump` process exited with status code {}.\", processResult.getExitValue());\n            throw new RuntimeException(\"There was an error backing up the database using `mysqldump`. The `mysqldump` process exited with status code \" + processResult.getExitValue() +\n                    \". Please see the server logs for more errors\");\n        }\n    }\n\n    @Override\n    public boolean accepts(String url) {\n        return isNotBlank(url) && url.startsWith(\"jdbc:mysql:\");\n    }\n\n    private ProcessExecutor createProcessExecutor(File targetDir, DbProperties dbProperties) {\n        ConnectionUrl connectionUrlInstance = ConnectionUrl.getConnectionUrlInstance(dbProperties.url(), dbProperties.connectionProperties());\n\n        LinkedHashMap<String, String> env = new LinkedHashMap<>();\n        if (isNotBlank(dbProperties.password())) {\n            env.put(\"MYSQL_PWD\", dbProperties.password());\n        }\n        // override with any user specified environment\n        env.putAll(dbProperties.extraBackupEnv());\n\n        ArrayList<String> argv = new ArrayList<>();\n        argv.add(\"mysqldump\");\n\n\n        String dbName = connectionUrlInstance.getDatabase();\n        HostInfo mainHost = connectionUrlInstance.getMainHost();\n\n        if (mainHost != null) {\n            argv.add(\"--host=\" + mainHost.getHost());\n            argv.add(\"--port=\" + mainHost.getPort());\n        }\n        if (isNotBlank(dbProperties.user())) {\n            argv.add(\"--user=\" + dbProperties.user());\n        }\n\n        // append any user specified args for mysqldump\n        if (isNotBlank(dbProperties.extraBackupCommandArgs())) {\n            Collections.addAll(argv, Commandline.translateCommandline(dbProperties.extraBackupCommandArgs()));\n        }\n\n        argv.add(\"--result-file=\" + new File(targetDir, \"db.\" + dbName).toString());\n        argv.add(connectionUrlInstance.getDatabase());\n\n        ProcessExecutor processExecutor = new ProcessExecutor();\n        processExecutor.redirectOutputAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.redirectErrorAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.environment(env);\n        processExecutor.command(argv);\n        return processExecutor;\n    }\n}\n", "/*\n * Copyright 2022 Thoughtworks, Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.thoughtworks.go.server.database.pg;\n\nimport com.thoughtworks.go.server.database.BackupProcessor;\nimport com.thoughtworks.go.server.database.DbProperties;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.tools.ant.types.Commandline;\nimport org.postgresql.Driver;\nimport org.zeroturnaround.exec.ProcessExecutor;\nimport org.zeroturnaround.exec.ProcessResult;\nimport org.zeroturnaround.exec.stream.slf4j.Slf4jStream;\n\nimport javax.sql.DataSource;\nimport java.io.File;\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.LinkedHashMap;\nimport java.util.Properties;\n\nimport static org.apache.commons.lang3.StringUtils.isNotBlank;\n\n@Slf4j\npublic class PostgresqlBackupProcessor implements BackupProcessor {\n\n    @Override\n    public void backup(File targetDir, DataSource dataSource, DbProperties dbProperties) throws Exception {\n        ProcessResult processResult = createProcessExecutor(targetDir, dbProperties).execute();\n\n        if (processResult.getExitValue() == 0) {\n            log.info(\"PostgreSQL backup finished successfully.\");\n        } else {\n            log.warn(\"There was an error backing up the database using `pg_dump`. The `pg_dump` process exited with status code {}.\", processResult.getExitValue());\n            throw new RuntimeException(\"There was an error backing up the database using `pg_dump`. The `pg_dump` process exited with status code \" + processResult.getExitValue() +\n                    \". Please see the server logs for more errors.\");\n\n        }\n    }\n\n    @Override\n    public boolean accepts(String url) {\n        return isNotBlank(url) && url.startsWith(\"jdbc:postgresql:\");\n    }\n\n    ProcessExecutor createProcessExecutor(File targetDir, DbProperties dbProperties) {\n        Properties connectionProperties = dbProperties.connectionProperties();\n        Properties pgProperties = Driver.parseURL(dbProperties.url(), connectionProperties);\n\n        ArrayList<String> argv = new ArrayList<>();\n        LinkedHashMap<String, String> env = new LinkedHashMap<>();\n        if (isNotBlank(dbProperties.password())) {\n            env.put(\"PGPASSWORD\", dbProperties.password());\n        }\n\n        // override with any user specified environment\n        env.putAll(dbProperties.extraBackupEnv());\n\n        String dbName = pgProperties.getProperty(\"PGDBNAME\");\n        argv.add(\"pg_dump\");\n        argv.add(\"--host=\" + pgProperties.getProperty(\"PGHOST\"));\n        argv.add(\"--port=\" + pgProperties.getProperty(\"PGPORT\"));\n        argv.add(\"--dbname=\" + dbName);\n        if (isNotBlank(dbProperties.user())) {\n            argv.add(\"--username=\" + dbProperties.user());\n        }\n        argv.add(\"--no-password\");\n        // append any user specified args for pg_dump\n        if (isNotBlank(dbProperties.extraBackupCommandArgs())) {\n            Collections.addAll(argv, Commandline.translateCommandline(dbProperties.extraBackupCommandArgs()));\n        }\n        argv.add(\"--file=\" + new File(targetDir, \"db.\" + dbName));\n        ProcessExecutor processExecutor = new ProcessExecutor();\n        processExecutor.redirectOutputAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.redirectErrorAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.environment(env);\n        processExecutor.command(argv);\n        return processExecutor;\n    }\n}\n"], "fixing_code": ["/*\n * Copyright 2022 Thoughtworks, Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.thoughtworks.go.server.database;\n\nimport javax.sql.DataSource;\nimport java.io.File;\n\npublic interface BackupProcessor {\n    void backup(File targetDir, DataSource dataSource, DbProperties dbProperties) throws Exception;\n\n    boolean accepts(String url);\n\n    default void throwBackupError(String command, int errorCode) {\n        throwBackupError(command, errorCode, null);\n    }\n\n    default void throwBackupError(String command, int errorCode, Throwable cause) {\n        throw new RuntimeException(String.format(\"There was an error backing up the database using `%s`. The `%s` process failed with code %s. Please see the server logs for more detail.\", command, command, errorCode), cause);\n    }\n}\n", "/*\n * Copyright 2022 Thoughtworks, Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.thoughtworks.go.server.database.mysql;\n\nimport com.mysql.cj.conf.ConnectionUrl;\nimport com.mysql.cj.conf.HostInfo;\nimport com.thoughtworks.go.server.database.BackupProcessor;\nimport com.thoughtworks.go.server.database.DbProperties;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.tools.ant.types.Commandline;\nimport org.zeroturnaround.exec.ProcessExecutor;\nimport org.zeroturnaround.exec.ProcessInitException;\nimport org.zeroturnaround.exec.ProcessResult;\nimport org.zeroturnaround.exec.stream.slf4j.Slf4jStream;\n\nimport javax.sql.DataSource;\nimport java.io.File;\nimport java.io.IOException;\nimport java.util.*;\nimport java.util.concurrent.TimeoutException;\n\nimport static org.apache.commons.lang3.StringUtils.isNotBlank;\n\n@Slf4j\npublic class MySQLBackupProcessor implements BackupProcessor {\n\n    private static final String COMMAND = \"mysqldump\";\n\n    @Override\n    public void backup(File targetDir, DataSource dataSource, DbProperties dbProperties) throws InterruptedException, TimeoutException, IOException {\n        try {\n            ProcessResult processResult = createProcessExecutor(targetDir, dbProperties).execute();\n\n            if (processResult.getExitValue() == 0) {\n                log.info(\"MySQL backup finished successfully.\");\n            } else {\n                throwBackupError(COMMAND, processResult.getExitValue());\n            }\n        } catch (ProcessInitException e) {\n            throwBackupError(COMMAND, e.getErrorCode(), e.getCause());\n        }\n    }\n\n    @Override\n    public boolean accepts(String url) {\n        return isNotBlank(url) && url.startsWith(\"jdbc:mysql:\");\n    }\n\n    private ProcessExecutor createProcessExecutor(File targetDir, DbProperties dbProperties) {\n        ConnectionUrl connectionUrlInstance = ConnectionUrl.getConnectionUrlInstance(dbProperties.url(), dbProperties.connectionProperties());\n\n        Map<String, String> env = new LinkedHashMap<>();\n        if (isNotBlank(dbProperties.password())) {\n            env.put(\"MYSQL_PWD\", dbProperties.password());\n        }\n        // override with any user specified environment\n        env.putAll(dbProperties.extraBackupEnv());\n\n        List<String> argv = new ArrayList<>();\n        argv.add(COMMAND);\n\n        String dbName = connectionUrlInstance.getDatabase();\n        HostInfo mainHost = connectionUrlInstance.getMainHost();\n\n        if (mainHost != null) {\n            argv.add(\"--host=\" + mainHost.getHost());\n            argv.add(\"--port=\" + mainHost.getPort());\n        }\n        if (isNotBlank(dbProperties.user())) {\n            argv.add(\"--user=\" + dbProperties.user());\n        }\n\n        // append any user specified args for mysqldump\n        if (isNotBlank(dbProperties.extraBackupCommandArgs())) {\n            Collections.addAll(argv, Commandline.translateCommandline(dbProperties.extraBackupCommandArgs()));\n        }\n\n        argv.add(\"--result-file=\" + new File(targetDir, \"db.\" + dbName));\n        argv.add(connectionUrlInstance.getDatabase());\n\n        ProcessExecutor processExecutor = new ProcessExecutor();\n        processExecutor.redirectOutputAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.redirectErrorAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.environment(env);\n        processExecutor.command(argv);\n        return processExecutor;\n    }\n}\n", "/*\n * Copyright 2022 Thoughtworks, Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage com.thoughtworks.go.server.database.pg;\n\nimport com.thoughtworks.go.server.database.BackupProcessor;\nimport com.thoughtworks.go.server.database.DbProperties;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.tools.ant.types.Commandline;\nimport org.postgresql.Driver;\nimport org.zeroturnaround.exec.ProcessExecutor;\nimport org.zeroturnaround.exec.ProcessInitException;\nimport org.zeroturnaround.exec.ProcessResult;\nimport org.zeroturnaround.exec.stream.slf4j.Slf4jStream;\n\nimport javax.sql.DataSource;\nimport java.io.File;\nimport java.util.*;\n\nimport static org.apache.commons.lang3.StringUtils.isNotBlank;\n\n@Slf4j\npublic class PostgresqlBackupProcessor implements BackupProcessor {\n\n    private static final String COMMAND = \"pg_dump\";\n\n    @Override\n    public void backup(File targetDir, DataSource dataSource, DbProperties dbProperties) throws Exception {\n        try {\n            ProcessResult processResult = createProcessExecutor(targetDir, dbProperties).execute();\n\n            if (processResult.getExitValue() == 0) {\n                log.info(\"PostgreSQL backup finished successfully.\");\n            } else {\n                throwBackupError(COMMAND, processResult.getExitValue());\n            }\n        } catch (ProcessInitException e) {\n            throwBackupError(COMMAND, e.getErrorCode(), e.getCause());\n        }\n    }\n\n    @Override\n    public boolean accepts(String url) {\n        return isNotBlank(url) && url.startsWith(\"jdbc:postgresql:\");\n    }\n\n    ProcessExecutor createProcessExecutor(File targetDir, DbProperties dbProperties) {\n        Properties connectionProperties = dbProperties.connectionProperties();\n        Properties pgProperties = Driver.parseURL(dbProperties.url(), connectionProperties);\n\n        Map<String, String> env = new LinkedHashMap<>();\n        if (isNotBlank(dbProperties.password())) {\n            env.put(\"PGPASSWORD\", dbProperties.password());\n        }\n\n        // override with any user specified environment\n        env.putAll(dbProperties.extraBackupEnv());\n\n        List<String> argv = new ArrayList<>();\n        argv.add(COMMAND);\n\n        String dbName = pgProperties.getProperty(\"PGDBNAME\");\n        argv.add(\"--host=\" + pgProperties.getProperty(\"PGHOST\"));\n        argv.add(\"--port=\" + pgProperties.getProperty(\"PGPORT\"));\n        argv.add(\"--dbname=\" + dbName);\n        if (isNotBlank(dbProperties.user())) {\n            argv.add(\"--username=\" + dbProperties.user());\n        }\n        argv.add(\"--no-password\");\n        // append any user specified args for pg_dump\n        if (isNotBlank(dbProperties.extraBackupCommandArgs())) {\n            Collections.addAll(argv, Commandline.translateCommandline(dbProperties.extraBackupCommandArgs()));\n        }\n        argv.add(\"--file=\" + new File(targetDir, \"db.\" + dbName));\n        ProcessExecutor processExecutor = new ProcessExecutor();\n        processExecutor.redirectOutputAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.redirectErrorAlsoTo(Slf4jStream.of(getClass()).asDebug());\n        processExecutor.environment(env);\n        processExecutor.command(argv);\n        return processExecutor;\n    }\n}\n"], "filenames": ["db-support/db-support-base/src/main/java/com/thoughtworks/go/server/database/BackupProcessor.java", "db-support/db-support-mysql/src/main/java/com/thoughtworks/go/server/database/mysql/MySQLBackupProcessor.java", "db-support/db-support-postgresql/src/main/java/com/thoughtworks/go/server/database/pg/PostgresqlBackupProcessor.java"], "buggy_code_start_loc": [25, 25, 24], "buggy_code_end_loc": [25, 91, 74], "fixing_code_start_loc": [26, 26, 25], "fixing_code_end_loc": [34, 93, 75], "type": "CWE-532", "message": "GoCD is an open source continuous delivery server. In GoCD versions from 20.5.0 and below 23.1.0, if the server environment is not correctly configured by administrators to provide access to the relevant PostgreSQL or MySQL backup tools, the credentials for database access may be unintentionally leaked to admin alerts on the GoCD user interface. The vulnerability is triggered only if the GoCD server host is misconfigured to have backups enabled, but does not have access to the `pg_dump` or `mysqldump` utility tools to backup the configured database type (PostgreSQL or MySQL respectively). In such cases, failure to launch the expected backup utility reports the shell environment used to attempt to launch in the server admin alert, which includes the plaintext database password supplied to the configured tool. This vulnerability does not affect backups of the default on-disk H2 database that GoCD is configured to use. This issue has been addressed and fixed in GoCD 23.1.0. Users are advised to upgrade. Users unable to upgrade may disable backups, or administrators should ensure that the required `pg_dump` (PostgreSQL) or `mysqldump` (MySQL) binaries are available on the GoCD server when backups are triggered.", "other": {"cve": {"id": "CVE-2023-28630", "sourceIdentifier": "security-advisories@github.com", "published": "2023-03-27T21:15:12.543", "lastModified": "2023-04-03T13:19:01.053", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "GoCD is an open source continuous delivery server. In GoCD versions from 20.5.0 and below 23.1.0, if the server environment is not correctly configured by administrators to provide access to the relevant PostgreSQL or MySQL backup tools, the credentials for database access may be unintentionally leaked to admin alerts on the GoCD user interface. The vulnerability is triggered only if the GoCD server host is misconfigured to have backups enabled, but does not have access to the `pg_dump` or `mysqldump` utility tools to backup the configured database type (PostgreSQL or MySQL respectively). In such cases, failure to launch the expected backup utility reports the shell environment used to attempt to launch in the server admin alert, which includes the plaintext database password supplied to the configured tool. This vulnerability does not affect backups of the default on-disk H2 database that GoCD is configured to use. This issue has been addressed and fixed in GoCD 23.1.0. Users are advised to upgrade. Users unable to upgrade may disable backups, or administrators should ensure that the required `pg_dump` (PostgreSQL) or `mysqldump` (MySQL) binaries are available on the GoCD server when backups are triggered."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:N/A:N", "attackVector": "LOCAL", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 4.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 0.8, "impactScore": 3.6}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:L/AC:L/PR:H/UI:R/S:U/C:H/I:N/A:N", "attackVector": "LOCAL", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 4.2, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 0.6, "impactScore": 3.6}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-532"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:thoughtworks:gocd:*:*:*:*:*:*:*:*", "versionStartIncluding": "20.5.0", "versionEndExcluding": "23.1.0", "matchCriteriaId": "29DC9E78-250A-4C59-966F-95C32E409D3E"}]}]}], "references": [{"url": "https://github.com/gocd/gocd/commit/6545481e7b36817dd6033bf614585a8db242070d", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/gocd/gocd/releases/tag/23.1.0", "source": "security-advisories@github.com", "tags": ["Release Notes"]}, {"url": "https://github.com/gocd/gocd/security/advisories/GHSA-p95w-gh78-qjmv", "source": "security-advisories@github.com", "tags": ["Patch", "Vendor Advisory"]}, {"url": "https://www.gocd.org/releases/#23-1-0", "source": "security-advisories@github.com", "tags": ["Release Notes"]}]}, "github_commit_url": "https://github.com/gocd/gocd/commit/6545481e7b36817dd6033bf614585a8db242070d"}}