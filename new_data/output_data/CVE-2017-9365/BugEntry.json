{"buggy_code": ["<?\n\t$view_data = isset($_GET[\"view_data\"]) ? \"&view_data=\".htmlspecialchars($_GET[\"view_data\"]) : \"\";\n?>\n<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>LOCKED</h3>\n\t\t</div>\n\t\t<p>\n\t\t\t<strong><?=$locked_by[\"name\"]?></strong> currently has this entry locked for editing.  It was last accessed by <strong><?=$locked_by[\"name\"]?></strong> on <strong><?=date(\"F j, Y @ g:ia\",strtotime($last_accessed))?></strong>.<br />\n\t\tIf you would like to edit it anyway, please click \"Unlock\" below.  Otherwise, click \"Cancel\".\n\t\t</p>\n\t</section>\n\t<footer>\n\t\t<a href=\"?force=true<?=$view_data?>\" class=\"button blue\">Unlock</a>\n\t\t&nbsp;\n\t\t<a href=\"javascript:history.go(-1);\" class=\"button white\">Cancel</a>\n\t</footer>\n</div>", "<?\n\t// Check for a page lock\n\t$force = isset($_GET[\"force\"]) ? true : false;\n\t$admin->lockCheck($bigtree[\"form\"][\"table\"],$bigtree[\"edit_id\"],\"admin/auto-modules/forms/_locked.php\",$force);\n\t\n\t$pending_entry = BigTreeAutoModule::getPendingItem($bigtree[\"form\"][\"table\"],$bigtree[\"edit_id\"]);\n\t$original_item = BigTreeAutoModule::getItem($bigtree[\"form\"][\"table\"],$bigtree[\"edit_id\"]);\n\t\t\n\tif (!$pending_entry) {\n?>\n<div class=\"container\">\n\t<section>\n\t\t<h3>Error</h3>\n\t\t<p>The item you are trying to edit no longer exists.</p>\n\t</section>\n</div>\n<?\n\t} else {\n\t\t$bigtree[\"related_view\"] = BigTreeAutoModule::getRelatedViewForForm($bigtree[\"form\"]);\n\t\t$bigtree[\"entry\"] = $item = $pending_entry[\"item\"];\n\t\t\n\t\t// See if we have an editing hook\n\t\tif (!empty($bigtree[\"form\"][\"hooks\"][\"edit\"])) {\n\t\t\t$bigtree[\"entry\"] = call_user_func($bigtree[\"form\"][\"hooks\"][\"edit\"], $bigtree[\"entry\"], $bigtree[\"form\"]);\n\t\t}\n\n\t\t// Check access levels\n\t\t$bigtree[\"access_level\"] = $admin->getAccessLevel($bigtree[\"module\"],$item,$bigtree[\"form\"][\"table\"]);\n\t\tif ($bigtree[\"access_level\"] != \"n\") {\n\t\t\t$original_permission_level = $admin->getAccessLevel($bigtree[\"module\"],$original_item[\"item\"],$bigtree[\"form\"][\"table\"]);\n\t\t\tif ($original_permission_level != \"p\") {\n\t\t\t\t$bigtree[\"access_level\"] = $original_permission_level;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (!$bigtree[\"access_level\"] || $bigtree[\"access_level\"] == \"n\") {\n\t\t\tinclude BigTree::path(\"admin/auto-modules/forms/_denied.php\");\n\t\t} else {\n\t\t\t$bigtree[\"many-to-many\"] = $many_to_many = $pending_entry[\"mtm\"];\n\t\t\t$bigtree[\"tags\"] = $pending_entry[\"tags\"];\n\t\t\t\t\n\t\t\tinclude BigTree::path(\"admin/auto-modules/forms/_form.php\");\n\t\t}\n\t}\n?>\n<script>\n\tBigTree.localLockTimer = setInterval(\"$.secureAjax('<?=ADMIN_ROOT?>ajax/refresh-lock/', { type: 'POST', data: { table: '<?=$bigtree[\"form\"][\"table\"]?>', id: '<?=$bigtree[\"edit_id\"]?>' } });\",60000);\n</script>", "<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>LOCKED</h3>\n\t\t</div>\n\t\t<p>\n\t\t\t<strong><?=$locked_by[\"name\"]?></strong> currently has this page locked for editing.  It was last accessed by <strong><?=$locked_by[\"name\"]?></strong> on <strong><?=date(\"F j, Y @ g:ia\",strtotime($last_accessed))?></strong>.<br />\n\t\tIf you would like to edit this page anyway, please click \"Unlock\" below.  Otherwise, click \"Cancel\".\n\t\t</p>\n\t</section>\n\t<footer>\n\t\t<a href=\"javascript:history.go(-1);\" class=\"button white\">Cancel</a>\n\t\t&nbsp;\n\t\t<a href=\"?force=true\" class=\"button blue\">Unlock</a>\n\t</footer>\n</div>", "<?\n\t$bigtree[\"current_page\"] = $page;\n\t$bigtree[\"resources\"] = $page[\"resources\"];\n\t\n\t// Show the properties section\n\tinclude BigTree::path(\"admin/modules/pages/_properties.php\");\n\t\n\t// Check for a page lock\n\t$force = isset($_GET[\"force\"]) ? $_GET[\"force\"] : false;\n\t$admin->lockCheck(\"bigtree_pages\",$page[\"id\"],\"admin/modules/pages/_locked.php\",$force);\n\t\n\t// Grab template information\n\t$template_data = $cms->getTemplate($page[\"template\"]);\n\n\t// Audit Trail link\n\t$bigtree[\"subnav_extras\"][] = array(\"link\" => ADMIN_ROOT.\"developer/audit/search/?table=bigtree_pages&entry=\".$page[\"id\"],\"icon\" => \"trail\",\"title\" => \"View Audit Trail\");\t\t\n\n\t// Provide developers a nice handy link for edit/return of this form\n\tif ($admin->Level > 1) {\n\t\t$bigtree[\"subnav_extras\"][] = array(\"link\" => ADMIN_ROOT.\"developer/templates/edit/\".$page[\"template\"].\"/?return=\".$page[\"id\"],\"icon\" => \"setup\",\"title\" => \"Edit Current Template in Developer\");\n\t}\n\t\n\t$bigtree[\"form_action\"] = \"update\";\n\tinclude BigTree::path(\"admin/modules/pages/_form.php\");\n?>", "<?\n\t// Make sure this is a live page.\n\tif (!is_numeric($page[\"id\"])) {\n?>\n<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>Error</h3>\n\t\t</div>\n\t\t<p>Revisions do not function on unpublished pages.</p>\n\t</section>\n</div>\n<?\n\t\t$admin->stop();\n\t}\n\n\t// Make sure the user is a publisher.\n\tif ($bigtree[\"access_level\"] != \"p\") {\n?>\n<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>Error</h3>\n\t\t</div>\n\t\t<p>You must be a publisher to manage revisions.</p>\n\t</section>\n</div>\n<?\n\t\t$admin->stop();\n\t}\n\t\n\t// Check for a page lock\n\t$force = isset($_GET[\"force\"]) ? $_GET[\"force\"] : false;\n\t$lock_id = $admin->lockCheck(\"bigtree_pages\",$page[\"id\"],\"admin/modules/pages/_locked.php\",$force);\n\t\n\t// See if there's a draft copy.\n\t$draft = $admin->getPageChanges($page[\"id\"]);\n\t\n\t// Get the current published copy.  We're going to just pull a few columns or I'd use getPage here.\n\t$current_author = $admin->getUser($page[\"last_edited_by\"]);\n\t\n\t// Get all revisions\n\t$revisions = $admin->getPageRevisions($page[\"id\"]);\n\n\tinclude BigTree::path(\"admin/modules/pages/_properties.php\");\n\n\n\tif ($draft) {\n\t\t$draft_author = $admin->getUser($draft[\"user\"]);\n?>\n<div class=\"table\">\n\t<summary><h2><span class=\"pages\"></span>Current Draft</h2></summary>\n\t<header>\n\t\t<span class=\"pages_last_edited\">Last Edited</span>\n\t\t<span class=\"pages_draft_author\">Draft Author</span>\n\t\t<span class=\"pages_publish\">Publish</span>\n\t\t<span class=\"pages_edit\">Edit</span>\n\t\t<span class=\"pages_delete\">Delete</span>\n\t</header>\n\t<ul>\n\t\t<li>\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($draft[\"date\"]))?></section>\n\t\t\t<section class=\"pages_draft_author\"><span class=\"gravatar\"><img src=\"<?=BigTree::gravatar($draft_author[\"email\"], 36)?>\" alt=\"\" /></span><?=$draft_author[\"name\"]?></section>\n\t\t\t<section class=\"pages_publish\"><a class=\"icon_publish\" href=\"<?=ADMIN_ROOT?>pages/publish-draft/<?=$page[\"id\"]?>/?draft=<?=$draft[\"id\"]?><? $admin->drawCSRFTokenGET() ?>\"></a></section>\n\t\t\t<section class=\"pages_edit\"><a class=\"icon_edit\" href=\"<?=ADMIN_ROOT?>pages/edit/<?=$page[\"id\"]?>/\"></a></section>\n\t\t\t<section class=\"pages_delete\"><a class=\"icon_delete\" href=\"<?=ADMIN_ROOT?>ajax/pages/delete-draft/?id=<?=$page[\"id\"]?><? $admin->drawCSRFTokenGET() ?>\"></a></section>\n\t\t</li>\n\n\t</ul>\n</div>\n<?\n\t}\n?>\n<div class=\"table\">\n\t<summary><h2><span class=\"published\"></span>Published Revisions</h2></summary>\n\t<header>\n\t\t<span class=\"pages_last_edited\">Published</span>\n\t\t<span class=\"pages_draft_author\">Author</span>\n\t\t<span class=\"pages_delete\">Save</span>\n\t\t<span class=\"pages_publish\">New Draft</span>\n\t\t<span class=\"pages_edit\">Delete</span>\n\t</header>\n\t<ul>\n\t\t<li class=\"active\">\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($page[\"updated_at\"]))?></section>\n\t\t\t<section class=\"pages_draft_author\"><span class=\"gravatar\"><img src=\"<?=BigTree::gravatar($current_author[\"email\"], 36)?>\" alt=\"\" /></span><?=$current_author[\"name\"]?><span class=\"active_draft\">Active</span></section>\n\t\t\t<section class=\"pages_delete\"><a href=\"#\" class=\"icon_save\"></a></section>\n\t\t\t<section class=\"pages_publish\"></section>\n\t\t\t<section class=\"pages_edit\"></section>\n\t\t</li>\n\t\t<? foreach ($revisions[\"unsaved\"] as $r) { ?>\n\t\t<li>\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($r[\"updated_at\"]))?></section>\n\t\t\t<section class=\"pages_draft_author\"><span class=\"gravatar\"><img src=\"<?=BigTree::gravatar($r[\"email\"], 36)?>\" alt=\"\" /></span><?=$r[\"name\"]?></section>\n\t\t\t<section class=\"pages_delete\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_save\"></a></section>\n\t\t\t<section class=\"pages_publish\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_draft\"></a></section>\n\t\t\t<section class=\"pages_edit\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_delete\"></a></section>\n\t\t</li>\n\t\t<? } ?>\n\t</ul>\n</div>\n<div class=\"table\">\n\t<summary><h2><span class=\"saved\"></span>Saved Revisions</h2></summary>\n\t<header>\n\t\t<span class=\"pages_last_edited\">Saved</span>\n\t\t<span class=\"pages_draft_description\">Description</span>\n\t\t<span class=\"pages_publish\">New Draft</span>\n\t\t<span class=\"pages_edit\">Delete</span>\n\t</header>\n\t<ul>\n\t\t<? foreach ($revisions[\"saved\"] as $r) { ?>\n\t\t<li>\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($r[\"updated_at\"]))?></section>\n\t\t\t<section class=\"pages_draft_description\"><?=$r[\"saved_description\"]?></section>\n\t\t\t<section class=\"pages_publish\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_draft\"></a></section>\n\t\t\t<section class=\"pages_edit\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_delete\"></a></section>\n\t\t</li>\n\t\t<? } ?>\n\t</ul>\n</div>\n<script>\n\tBigTree.localActiveDraft = <? if ($draft) { ?>true<? } else { ?>false<? } ?>;\n\tBigTree.localLockTimer = setInterval(\"$.secureAjax('<?=ADMIN_ROOT?>ajax/refresh-lock/', { type: 'POST', data: { table: 'bigtree_pages', id: '<?=$lock_id?>' } });\",60000);\n\t\n\t$(\".icon_save\").click(function() {\n\t\tBigTreeDialog({\n\t\t\ttitle: \"Save Revision\",\n\t\t\tcontent: '<fieldset class=\"last\"><label>Short Description <small>(quick reminder of what\\'s special about this revision)</small></label><input type=\"text\" name=\"description\" /></fieldset>',\n\t\t\tcallback: $.proxy(function(d) {\n\t\t\t\t// If there's no href it's because it's the currently published copy we're saving.\n\t\t\t\tif (BigTree.cleanHref($(this).attr(\"href\"))) {\n\t\t\t\t\tvar id = BigTree.cleanHref($(this).attr(\"href\"));\n\t\t\t\t} else {\n\t\t\t\t\tvar id = \"c<?=$page[\"id\"]?>\";\n\t\t\t\t}\n\n\t\t\t\t$.secureAjax(\"<?=ADMIN_ROOT?>ajax/pages/save-revision/\", { type: \"POST\", data: { id: id, description: d.description }});\n\t\t\t},this)\n\t\t});\n\t\t\n\t\treturn false;\n\t});\n\t\n\t$(\".icon_delete\").click(function() {\n\t\tvar href = $(this).attr(\"href\");\n\t\tif (href.substr(0,1) == \"#\") {\n\t\t\tBigTreeDialog({\n\t\t\t\ttitle: \"Delete Revision\",\n\t\t\t\tcontent: '<p class=\"confirm\">Are you sure you want to delete this revision?</p>',\n\t\t\t\ticon: \"delete\",\n\t\t\t\talternateSaveText: \"OK\",\n\t\t\t\tcallback: $.proxy(function() {\n\t\t\t\t\t$.secureAjax(\"<?=ADMIN_ROOT?>ajax/pages/delete-revision/?id=\" + BigTree.cleanHref($(this).attr(\"href\")));\n\t\t\t\t\t$(this).parents(\"li\").remove();\n\t\t\t\t\tBigTree.growl(\"Pages\",\"Deleted Revision\");\n\t\t\t\t},this)\n\t\t\t});\n\t\t} else {\n\t\t\tBigTreeDialog({\n\t\t\t\ttitle: \"Delete Draft\",\n\t\t\t\tcontent: '<p class=\"confirm\">Are you sure you want to delete this draft?</p>',\n\t\t\t\ticon: \"delete\",\n\t\t\t\talternateSaveText: \"OK\",\n\t\t\t\tcallback: $.proxy(function() {\n\t\t\t\t\t$.secureAjax($(this).attr(\"href\"));\n\t\t\t\t\t$(this).parents(\"li\").remove();\n\t\t\t\t\tBigTree.growl(\"Pages\",\"Deleted Draft\");\n\t\t\t\t},this)\n\t\t\t});\n\t\t}\n\t\t\n\t\treturn false;\n\t});\n\t\n\t$(\".icon_draft\").click(function() {\n\t\tif (BigTree.localActiveDraft) {\n\t\t\tBigTreeDialog({\n\t\t\t\ttitle: \"Use Revision\",\n\t\t\t\tcontent: '<p class=\"confirm\">Are you sure you want to overwrite your existing draft with this revision?</p>',\n\t\t\t\talternateSaveText: \"Overwrite\",\n\t\t\t\tcallback: $.proxy(function() {\n\t\t\t\t\tdocument.location.href = \"<?=ADMIN_ROOT?>ajax/pages/use-draft/?id=\" + BigTree.cleanHref($(this).attr(\"href\") + \"<? $admin->drawCSRFTokenGET() ?>\");\n\t\t\t\t},this)\n\t\t\t});\n\t\t} else {\n\t\t\tdocument.location.href = \"<?=ADMIN_ROOT?>ajax/pages/use-draft/?id=\" + BigTree.cleanHref($(this).attr(\"href\") + \"<? $admin->drawCSRFTokenGET() ?>\");\n\t\t}\n\n\t\treturn false;\n\t});\n</script>"], "fixing_code": ["<?\n\t$view_data = isset($_GET[\"view_data\"]) ? \"&view_data=\".htmlspecialchars($_GET[\"view_data\"]) : \"\";\n?>\n<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>LOCKED</h3>\n\t\t</div>\n\t\t<p>\n\t\t\t<strong><?=$locked_by[\"name\"]?></strong> currently has this entry locked for editing.  It was last accessed by <strong><?=$locked_by[\"name\"]?></strong> on <strong><?=date(\"F j, Y @ g:ia\",strtotime($last_accessed))?></strong>.<br />\n\t\tIf you would like to edit it anyway, please click \"Unlock\" below.  Otherwise, click \"Cancel\".\n\t\t</p>\n\t</section>\n\t<footer>\n\t\t<a href=\"?force=true<?=$view_data?><? $admin->drawCSRFTokenGET(); ?>\" class=\"button blue\">Unlock</a>\n\t\t&nbsp;\n\t\t<a href=\"javascript:history.go(-1);\" class=\"button white\">Cancel</a>\n\t</footer>\n</div>", "<?\n\t// Check for a page lock\n\tif (!empty($_GET[\"force\"])) {\n\t\t$admin->verifyCSRFToken();\n\t\t$force = true;\n\t} else {\n\t\t$force = false;\n\t}\n\t\n\t$admin->lockCheck($bigtree[\"form\"][\"table\"],$bigtree[\"edit_id\"],\"admin/auto-modules/forms/_locked.php\",$force);\n\t\n\t$pending_entry = BigTreeAutoModule::getPendingItem($bigtree[\"form\"][\"table\"],$bigtree[\"edit_id\"]);\n\t$original_item = BigTreeAutoModule::getItem($bigtree[\"form\"][\"table\"],$bigtree[\"edit_id\"]);\n\t\t\n\tif (!$pending_entry) {\n?>\n<div class=\"container\">\n\t<section>\n\t\t<h3>Error</h3>\n\t\t<p>The item you are trying to edit no longer exists.</p>\n\t</section>\n</div>\n<?\n\t} else {\n\t\t$bigtree[\"related_view\"] = BigTreeAutoModule::getRelatedViewForForm($bigtree[\"form\"]);\n\t\t$bigtree[\"entry\"] = $item = $pending_entry[\"item\"];\n\t\t\n\t\t// See if we have an editing hook\n\t\tif (!empty($bigtree[\"form\"][\"hooks\"][\"edit\"])) {\n\t\t\t$bigtree[\"entry\"] = call_user_func($bigtree[\"form\"][\"hooks\"][\"edit\"], $bigtree[\"entry\"], $bigtree[\"form\"]);\n\t\t}\n\n\t\t// Check access levels\n\t\t$bigtree[\"access_level\"] = $admin->getAccessLevel($bigtree[\"module\"],$item,$bigtree[\"form\"][\"table\"]);\n\t\tif ($bigtree[\"access_level\"] != \"n\") {\n\t\t\t$original_permission_level = $admin->getAccessLevel($bigtree[\"module\"],$original_item[\"item\"],$bigtree[\"form\"][\"table\"]);\n\t\t\tif ($original_permission_level != \"p\") {\n\t\t\t\t$bigtree[\"access_level\"] = $original_permission_level;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (!$bigtree[\"access_level\"] || $bigtree[\"access_level\"] == \"n\") {\n\t\t\tinclude BigTree::path(\"admin/auto-modules/forms/_denied.php\");\n\t\t} else {\n\t\t\t$bigtree[\"many-to-many\"] = $many_to_many = $pending_entry[\"mtm\"];\n\t\t\t$bigtree[\"tags\"] = $pending_entry[\"tags\"];\n\t\t\t\t\n\t\t\tinclude BigTree::path(\"admin/auto-modules/forms/_form.php\");\n\t\t}\n\t}\n?>\n<script>\n\tBigTree.localLockTimer = setInterval(\"$.secureAjax('<?=ADMIN_ROOT?>ajax/refresh-lock/', { type: 'POST', data: { table: '<?=$bigtree[\"form\"][\"table\"]?>', id: '<?=$bigtree[\"edit_id\"]?>' } });\",60000);\n</script>", "<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>LOCKED</h3>\n\t\t</div>\n\t\t<p>\n\t\t\t<strong><?=$locked_by[\"name\"]?></strong> currently has this page locked for editing.  It was last accessed by <strong><?=$locked_by[\"name\"]?></strong> on <strong><?=date(\"F j, Y @ g:ia\",strtotime($last_accessed))?></strong>.<br />\n\t\tIf you would like to edit this page anyway, please click \"Unlock\" below.  Otherwise, click \"Cancel\".\n\t\t</p>\n\t</section>\n\t<footer>\n\t\t<a href=\"javascript:history.go(-1);\" class=\"button white\">Cancel</a>\n\t\t&nbsp;\n\t\t<a href=\"?force=true<? $admin->drawCSRFTokenGET() ?>\" class=\"button blue\">Unlock</a>\n\t</footer>\n</div>", "<?\n\t$bigtree[\"current_page\"] = $page;\n\t$bigtree[\"resources\"] = $page[\"resources\"];\n\t\n\t// Show the properties section\n\tinclude BigTree::path(\"admin/modules/pages/_properties.php\");\n\t\n\t// Check for a page lock\n\tif (!empty($_GET[\"force\"])) {\n\t\t$admin->verifyCSRFToken();\n\t\t$force = true;\n\t} else {\n\t\t$force = false;\n\t}\n\t\n\t$admin->lockCheck(\"bigtree_pages\",$page[\"id\"],\"admin/modules/pages/_locked.php\",$force);\n\t\n\t// Grab template information\n\t$template_data = $cms->getTemplate($page[\"template\"]);\n\n\t// Audit Trail link\n\t$bigtree[\"subnav_extras\"][] = array(\"link\" => ADMIN_ROOT.\"developer/audit/search/?table=bigtree_pages&entry=\".$page[\"id\"],\"icon\" => \"trail\",\"title\" => \"View Audit Trail\");\t\t\n\n\t// Provide developers a nice handy link for edit/return of this form\n\tif ($admin->Level > 1) {\n\t\t$bigtree[\"subnav_extras\"][] = array(\"link\" => ADMIN_ROOT.\"developer/templates/edit/\".$page[\"template\"].\"/?return=\".$page[\"id\"],\"icon\" => \"setup\",\"title\" => \"Edit Current Template in Developer\");\n\t}\n\t\n\t$bigtree[\"form_action\"] = \"update\";\n\tinclude BigTree::path(\"admin/modules/pages/_form.php\");\n?>", "<?\n\t// Make sure this is a live page.\n\tif (!is_numeric($page[\"id\"])) {\n?>\n<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>Error</h3>\n\t\t</div>\n\t\t<p>Revisions do not function on unpublished pages.</p>\n\t</section>\n</div>\n<?\n\t\t$admin->stop();\n\t}\n\n\t// Make sure the user is a publisher.\n\tif ($bigtree[\"access_level\"] != \"p\") {\n?>\n<div class=\"container\">\n\t<section>\n\t\t<div class=\"alert\">\n\t\t\t<span></span>\n\t\t\t<h3>Error</h3>\n\t\t</div>\n\t\t<p>You must be a publisher to manage revisions.</p>\n\t</section>\n</div>\n<?\n\t\t$admin->stop();\n\t}\n\t\n\t// Check for a page lock\n\tif (!empty($_GET[\"force\"])) {\n\t\t$admin->verifyCSRFToken();\n\t\t$force = true;\n\t} else {\n\t\t$force = false;\n\t}\n\n\t$lock_id = $admin->lockCheck(\"bigtree_pages\",$page[\"id\"],\"admin/modules/pages/_locked.php\",$force);\n\t\n\t// See if there's a draft copy.\n\t$draft = $admin->getPageChanges($page[\"id\"]);\n\t\n\t// Get the current published copy.  We're going to just pull a few columns or I'd use getPage here.\n\t$current_author = $admin->getUser($page[\"last_edited_by\"]);\n\t\n\t// Get all revisions\n\t$revisions = $admin->getPageRevisions($page[\"id\"]);\n\n\tinclude BigTree::path(\"admin/modules/pages/_properties.php\");\n\n\n\tif ($draft) {\n\t\t$draft_author = $admin->getUser($draft[\"user\"]);\n?>\n<div class=\"table\">\n\t<summary><h2><span class=\"pages\"></span>Current Draft</h2></summary>\n\t<header>\n\t\t<span class=\"pages_last_edited\">Last Edited</span>\n\t\t<span class=\"pages_draft_author\">Draft Author</span>\n\t\t<span class=\"pages_publish\">Publish</span>\n\t\t<span class=\"pages_edit\">Edit</span>\n\t\t<span class=\"pages_delete\">Delete</span>\n\t</header>\n\t<ul>\n\t\t<li>\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($draft[\"date\"]))?></section>\n\t\t\t<section class=\"pages_draft_author\"><span class=\"gravatar\"><img src=\"<?=BigTree::gravatar($draft_author[\"email\"], 36)?>\" alt=\"\" /></span><?=$draft_author[\"name\"]?></section>\n\t\t\t<section class=\"pages_publish\"><a class=\"icon_publish\" href=\"<?=ADMIN_ROOT?>pages/publish-draft/<?=$page[\"id\"]?>/?draft=<?=$draft[\"id\"]?><? $admin->drawCSRFTokenGET() ?>\"></a></section>\n\t\t\t<section class=\"pages_edit\"><a class=\"icon_edit\" href=\"<?=ADMIN_ROOT?>pages/edit/<?=$page[\"id\"]?>/\"></a></section>\n\t\t\t<section class=\"pages_delete\"><a class=\"icon_delete\" href=\"<?=ADMIN_ROOT?>ajax/pages/delete-draft/?id=<?=$page[\"id\"]?><? $admin->drawCSRFTokenGET() ?>\"></a></section>\n\t\t</li>\n\n\t</ul>\n</div>\n<?\n\t}\n?>\n<div class=\"table\">\n\t<summary><h2><span class=\"published\"></span>Published Revisions</h2></summary>\n\t<header>\n\t\t<span class=\"pages_last_edited\">Published</span>\n\t\t<span class=\"pages_draft_author\">Author</span>\n\t\t<span class=\"pages_delete\">Save</span>\n\t\t<span class=\"pages_publish\">New Draft</span>\n\t\t<span class=\"pages_edit\">Delete</span>\n\t</header>\n\t<ul>\n\t\t<li class=\"active\">\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($page[\"updated_at\"]))?></section>\n\t\t\t<section class=\"pages_draft_author\"><span class=\"gravatar\"><img src=\"<?=BigTree::gravatar($current_author[\"email\"], 36)?>\" alt=\"\" /></span><?=$current_author[\"name\"]?><span class=\"active_draft\">Active</span></section>\n\t\t\t<section class=\"pages_delete\"><a href=\"#\" class=\"icon_save\"></a></section>\n\t\t\t<section class=\"pages_publish\"></section>\n\t\t\t<section class=\"pages_edit\"></section>\n\t\t</li>\n\t\t<? foreach ($revisions[\"unsaved\"] as $r) { ?>\n\t\t<li>\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($r[\"updated_at\"]))?></section>\n\t\t\t<section class=\"pages_draft_author\"><span class=\"gravatar\"><img src=\"<?=BigTree::gravatar($r[\"email\"], 36)?>\" alt=\"\" /></span><?=$r[\"name\"]?></section>\n\t\t\t<section class=\"pages_delete\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_save\"></a></section>\n\t\t\t<section class=\"pages_publish\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_draft\"></a></section>\n\t\t\t<section class=\"pages_edit\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_delete\"></a></section>\n\t\t</li>\n\t\t<? } ?>\n\t</ul>\n</div>\n<div class=\"table\">\n\t<summary><h2><span class=\"saved\"></span>Saved Revisions</h2></summary>\n\t<header>\n\t\t<span class=\"pages_last_edited\">Saved</span>\n\t\t<span class=\"pages_draft_description\">Description</span>\n\t\t<span class=\"pages_publish\">New Draft</span>\n\t\t<span class=\"pages_edit\">Delete</span>\n\t</header>\n\t<ul>\n\t\t<? foreach ($revisions[\"saved\"] as $r) { ?>\n\t\t<li>\n\t\t\t<section class=\"pages_last_edited\"><?=date(\"F j, Y @ g:ia\",strtotime($r[\"updated_at\"]))?></section>\n\t\t\t<section class=\"pages_draft_description\"><?=$r[\"saved_description\"]?></section>\n\t\t\t<section class=\"pages_publish\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_draft\"></a></section>\n\t\t\t<section class=\"pages_edit\"><a href=\"#<?=$r[\"id\"]?>\" class=\"icon_delete\"></a></section>\n\t\t</li>\n\t\t<? } ?>\n\t</ul>\n</div>\n<script>\n\tBigTree.localActiveDraft = <? if ($draft) { ?>true<? } else { ?>false<? } ?>;\n\tBigTree.localLockTimer = setInterval(\"$.secureAjax('<?=ADMIN_ROOT?>ajax/refresh-lock/', { type: 'POST', data: { table: 'bigtree_pages', id: '<?=$lock_id?>' } });\",60000);\n\t\n\t$(\".icon_save\").click(function() {\n\t\tBigTreeDialog({\n\t\t\ttitle: \"Save Revision\",\n\t\t\tcontent: '<fieldset class=\"last\"><label>Short Description <small>(quick reminder of what\\'s special about this revision)</small></label><input type=\"text\" name=\"description\" /></fieldset>',\n\t\t\tcallback: $.proxy(function(d) {\n\t\t\t\t// If there's no href it's because it's the currently published copy we're saving.\n\t\t\t\tif (BigTree.cleanHref($(this).attr(\"href\"))) {\n\t\t\t\t\tvar id = BigTree.cleanHref($(this).attr(\"href\"));\n\t\t\t\t} else {\n\t\t\t\t\tvar id = \"c<?=$page[\"id\"]?>\";\n\t\t\t\t}\n\n\t\t\t\t$.secureAjax(\"<?=ADMIN_ROOT?>ajax/pages/save-revision/\", { type: \"POST\", data: { id: id, description: d.description }});\n\t\t\t},this)\n\t\t});\n\t\t\n\t\treturn false;\n\t});\n\t\n\t$(\".icon_delete\").click(function() {\n\t\tvar href = $(this).attr(\"href\");\n\t\tif (href.substr(0,1) == \"#\") {\n\t\t\tBigTreeDialog({\n\t\t\t\ttitle: \"Delete Revision\",\n\t\t\t\tcontent: '<p class=\"confirm\">Are you sure you want to delete this revision?</p>',\n\t\t\t\ticon: \"delete\",\n\t\t\t\talternateSaveText: \"OK\",\n\t\t\t\tcallback: $.proxy(function() {\n\t\t\t\t\t$.secureAjax(\"<?=ADMIN_ROOT?>ajax/pages/delete-revision/?id=\" + BigTree.cleanHref($(this).attr(\"href\")));\n\t\t\t\t\t$(this).parents(\"li\").remove();\n\t\t\t\t\tBigTree.growl(\"Pages\",\"Deleted Revision\");\n\t\t\t\t},this)\n\t\t\t});\n\t\t} else {\n\t\t\tBigTreeDialog({\n\t\t\t\ttitle: \"Delete Draft\",\n\t\t\t\tcontent: '<p class=\"confirm\">Are you sure you want to delete this draft?</p>',\n\t\t\t\ticon: \"delete\",\n\t\t\t\talternateSaveText: \"OK\",\n\t\t\t\tcallback: $.proxy(function() {\n\t\t\t\t\t$.secureAjax($(this).attr(\"href\"));\n\t\t\t\t\t$(this).parents(\"li\").remove();\n\t\t\t\t\tBigTree.growl(\"Pages\",\"Deleted Draft\");\n\t\t\t\t},this)\n\t\t\t});\n\t\t}\n\t\t\n\t\treturn false;\n\t});\n\t\n\t$(\".icon_draft\").click(function() {\n\t\tif (BigTree.localActiveDraft) {\n\t\t\tBigTreeDialog({\n\t\t\t\ttitle: \"Use Revision\",\n\t\t\t\tcontent: '<p class=\"confirm\">Are you sure you want to overwrite your existing draft with this revision?</p>',\n\t\t\t\talternateSaveText: \"Overwrite\",\n\t\t\t\tcallback: $.proxy(function() {\n\t\t\t\t\tdocument.location.href = \"<?=ADMIN_ROOT?>ajax/pages/use-draft/?id=\" + BigTree.cleanHref($(this).attr(\"href\") + \"<? $admin->drawCSRFTokenGET() ?>\");\n\t\t\t\t},this)\n\t\t\t});\n\t\t} else {\n\t\t\tdocument.location.href = \"<?=ADMIN_ROOT?>ajax/pages/use-draft/?id=\" + BigTree.cleanHref($(this).attr(\"href\") + \"<? $admin->drawCSRFTokenGET() ?>\");\n\t\t}\n\n\t\treturn false;\n\t});\n</script>"], "filenames": ["core/admin/auto-modules/forms/_locked.php", "core/admin/auto-modules/forms/edit.php", "core/admin/modules/pages/_locked.php", "core/admin/modules/pages/edit.php", "core/admin/modules/pages/revisions.php"], "buggy_code_start_loc": [16, 3, 15, 9, 35], "buggy_code_end_loc": [17, 4, 16, 10, 36], "fixing_code_start_loc": [16, 3, 15, 9, 35], "fixing_code_end_loc": [17, 10, 16, 16, 42], "type": "CWE-352", "message": "CSRF exists in BigTree CMS through 4.2.18 with the force parameter to /admin/pages/revisions.php - for example: /admin/pages/revisions/1/?force=false. A page with id=1 can be unlocked.", "other": {"cve": {"id": "CVE-2017-9365", "sourceIdentifier": "cve@mitre.org", "published": "2017-06-02T05:29:00.903", "lastModified": "2017-06-06T20:23:50.203", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "CSRF exists in BigTree CMS through 4.2.18 with the force parameter to /admin/pages/revisions.php - for example: /admin/pages/revisions/1/?force=false. A page with id=1 can be unlocked."}, {"lang": "es", "value": "Existe CSRF en BigTree CMS hasta la versi\u00f3n 4.2.18 con el par\u00e1metro force en /admin/pages/revisions.php. Por ejemplo, /admin/pages/revisions/1/?force=false. Una p\u00e1gina con id=1 se puede desbloquear."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.8}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-352"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:bigtreecms:bigtree_cms:*:*:*:*:*:*:*:*", "versionEndIncluding": "4.2.18", "matchCriteriaId": "DF5ED7B4-C5CC-475B-8349-3F7979D7CE22"}]}]}], "references": [{"url": "https://github.com/bigtreecms/BigTree-CMS/commit/c17d09b05d9c20c214ee2f4fbb52f7307a7b4b6f", "source": "cve@mitre.org", "tags": ["Patch"]}, {"url": "https://github.com/bigtreecms/BigTree-CMS/issues/281", "source": "cve@mitre.org", "tags": ["Exploit", "Issue Tracking", "Patch"]}]}, "github_commit_url": "https://github.com/bigtreecms/BigTree-CMS/commit/c17d09b05d9c20c214ee2f4fbb52f7307a7b4b6f"}}