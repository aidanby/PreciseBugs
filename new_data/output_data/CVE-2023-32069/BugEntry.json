{"buggy_code": ["<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n\n<!--\n * See the NOTICE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n-->\n\n<xwikidoc version=\"1.5\" reference=\"XWiki.ClassSheet\" locale=\"\">\n  <web>XWiki</web>\n  <name>ClassSheet</name>\n  <language/>\n  <defaultLanguage/>\n  <translation>0</translation>\n  <creator>xwiki:XWiki.Admin</creator>\n  <parent>XWiki.XWikiClasses</parent>\n  <author>xwiki:XWiki.Admin</author>\n  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>\n  <version>1.1</version>\n  <title>#sheetTitle('platform.xclass.defaultClassSheet.title')</title>\n  <comment/>\n  <minorEdit>false</minorEdit>\n  <syntaxId>xwiki/2.0</syntaxId>\n  <hidden>true</hidden>\n  <content>{{template name=\"locationPicker_macros.vm\" /}}\n\n{{velocity}}\n## This document can be copied in order to be customized so we cannot rely on its name to determine if the currently\n## displayed document is a class or the class sheet itself. We look for the sheet descriptor instead.\n#set ($isSheet = $doc.getObject('XWiki.SheetDescriptorClass'))\n#if ($isSheet)\n  ## Viewing the sheet document itself.\n  {{translation key=\"platform.xclass.defaultClassSheet.description\"/}}\n#elseif (\"$!request.bindSheet\" != '' &amp;&amp; $hasEdit)\n  #if ($services.csrf.isTokenValid($request.getParameter('form_token')))\n    ## Bind the sheet to the class.\n    #set ($classSheetReference = $services.model.resolveDocument($request.bindSheet))\n    #if ($services.sheet.bindClassSheet($doc, $classSheetReference))\n      $doc.save($services.localization.render('platform.xclass.defaultClassSheet.sheets.bind'))\n    #end\n    $response.sendRedirect($request.xredirect)\n  #else\n    $response.sendRedirect($services.csrf.getResubmissionURL())\n  #end\n  ## Stop processing, since we already sent a redirect.\n  #stop\n#elseif(\"$!request.docName\" != '')\n  ## Request for creating a new instance.\n  ## We don't actually create a new instance here, we just redirect to the edit mode.\n  #set ($targetSpaceRef = $services.model.resolveSpace($request.spaceName))\n  #set ($targetDocRef = $services.model.createDocumentReference($request.docName, $targetSpaceRef))\n  #if (!$xwiki.exists($targetDocRef) &amp;&amp; $services.security.authorization.hasAccess('edit', $targetDocRef))\n    ## Compute the default edit mode to ensure backward compatibility with documents that are still using the deprecated\n    ## inline action.\n    #set ($editAction = $xwiki.getDocument($request.template).getDefaultEditMode())\n    $response.sendRedirect($xwiki.getURL($targetDocRef, $editAction, $escapetool.url({\n      'template': $request.template,\n      'parent': $request.parent,\n      'title': $request.docName\n    })))\n    ## Stop processing, since we already sent a redirect.\n    #stop\n  #end\n#end\n{{/velocity}}\n\n{{velocity}}\n## If this sheet is explicitly bound to the displayed class then print the class document content before the\n## sheet output. Class authors can put the description of the class in the class document content.\n#set($classSheetReference = $services.model.createDocumentReference($doc.wiki, 'XWiki', 'ClassSheet'))\n#if($services.sheet.getDocumentSheets($doc).contains($classSheetReference))\n  {{include reference=\"\" /}}\n#end\n{{/velocity}}\n\n{{velocity}}\n#if (!$isSheet)\n  #set ($className = $doc.pageReference.name)\n  #set ($className = $stringtool.removeEnd($className, 'Class'))\n  ## Determine the class sheets.\n  #set ($classSheetReferences = $services.sheet.getClassSheets($doc))\n  #if ($classSheetReferences.isEmpty())\n    ## There is no class sheet explicitly bound to this class. Fall-back on naming convention.\n    ## Before XWiki 2.0, the default class sheet was suffixed with \"ClassSheet\". Since 2.0, the suffix is just \"Sheet\".\n    #set ($defaultClassSheetReference = $services.model.createDocumentReference(\"${className}ClassSheet\",\n      $doc.documentReference.parent))\n    #if (!$xwiki.exists($defaultClassSheetReference))\n      #set ($defaultClassSheetReference = $services.model.createDocumentReference(\"${className}Sheet\",\n        $doc.documentReference.parent))\n    #end\n  #end\n  ## Determine the template using naming convention.\n  ## Before XWiki 2.0, the default class template was suffixed with \"ClassTemplate\".\n  ## Since 2.0, the suffix is just \"Template\".\n  #set ($classTemplateReference = $services.model.createDocumentReference(\"${className}ClassTemplate\",\n    $doc.documentReference.parent))\n  #if (!$xwiki.exists($classTemplateReference))\n    #set ($classTemplateReference = $services.model.createDocumentReference(\"${className}Template\",\n      $doc.documentReference.parent))\n  #end\n  ## Determine the template provider using naming convention.\n  #set ($classTemplateProviderReference = $services.model.createDocumentReference(\"${className}TemplateProvider\",\n    $doc.documentReference.parent))\n  #set ($classTemplateProviderDoc = $xwiki.getDocument($classTemplateProviderReference))\n  #set ($hasClassTemplateProvider = !$classTemplateProviderDoc.isNew())\n  #set($classTemplateDoc = $xwiki.getDocument($classTemplateReference))\n  #set($hasClassSheets = !$classSheetReferences.isEmpty() || $xwiki.exists($defaultClassSheetReference))\n  #set($hasClassTemplate = !$classTemplateDoc.isNew())\n  #if(!$defaultSpace)\n    #set($defaultSpace = $doc.space)\n  #end\n  #if(!$defaultParent)\n    #set($defaultParent = ${doc.fullName})\n  #end\n\n  #set ($classEditorURL = $doc.getURL('edit', 'editor=class'))\n  #if($doc.getxWikiClass().properties.size() == 0)\n    #set ($openLink = \"&lt;a href='$escapetool.xml($classEditorURL)'&gt;\")\n    #set ($closeLink = '&lt;/a&gt;')\n    {{warning}}\n      {{html}}\n      ## First escape the content of the translation, then replace the placeholders with content that would otherwise be\n      ## escaped during the first escaping.\n      #set ($warningMessage = $services.localization.render('platform.xclass.defaultClassSheet.properties.empty', \n        ['__OPEN_LINK__', '__CLOSE_LINK__']))\n      $escapetool.xml($warningMessage).replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', $closeLink)\n      {{/html}}\n    {{/warning}}\n  #else\n    (% id=\"HClassProperties\" %)\n    = {{translation key=\"platform.xclass.defaultClassSheet.properties.heading\"/}} =\n    #foreach($property in $doc.getxWikiClass().properties)\n      * $services.rendering.escape(\"$property.prettyName ($property.name: $xwiki.metaclass.get($property.classType).prettyName)\", $xwiki.currentContentSyntaxId)\n    #end\n    #set ($openLink = \"&lt;a href='$escapetool.xml($classEditorURL)'&gt;\")\n    #set ($closeLink = '&lt;/a&gt;')\n    #set ($warningMessage = $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.properties.edit', ['__OPEN_LINK__', '__CLOSE_LINK__'])))\n    ## First escape the content of the translation, then replace the placeholders with content that would otherwise be\n    ## escaped during the first escaping.\n    * //{{html}}$warningMessage.replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', $closeLink){{/html}}//\n\n  #end\n  #if ($hasClassSheets &amp;&amp; $hasClassTemplate)\n    (% id=\"HCreatePage\" %)\n    = {{translation key=\"platform.xclass.defaultClassSheet.createPage.heading\"/}} =\n    #if(\"$!targetDocRef\" != '' &amp;&amp; $xwiki.exists($targetDocRef))\n      {{warning}}\n        {{html}}\n          #set ($targetDocLink = $xwiki.getURL($targetDocRef))\n          #set ($openLink = \"&lt;a href='$escapetool.xml($targetDocLink)'&gt;\")\n          #set ($message = $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.createPage.pageAlreadyExists', ['__OPEN_LINK__', '__CLOSE_LINK__'])))\n          ## First escape the content of the translation, then replace the placeholders with content that would\n          ## otherwise be escaped during the first escaping.\n          $message.replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', '&lt;/a&gt;')\n        {{/html}}\n      {{/warning}}\n    #elseif(\"$!targetDocRef\" != '')\n\n      {{warning}}{{translation key=\"platform.xclass.defaultClassSheet.createPage.denied\"/}}{{/warning}}\n    #end\n\n    {{html}}\n    &lt;form action=\"$doc.getURL()\" id=\"newdoc\" method=\"post\" class=\"xform half\"&gt;\n      &lt;fieldset&gt;\n      &lt;div class=\"hidden\"&gt;\n        &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n        &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${defaultParent})\"/&gt;\n        &lt;input type=\"hidden\" name=\"template\" value=\"$escapetool.xml(${classTemplateDoc})\"/&gt;\n        &lt;input type=\"hidden\" name=\"sheet\" value=\"1\"/&gt;\n      &lt;/div&gt;\n      #locationPicker({\n        'id': 'target',\n        'title': {\n          'label': 'core.create.title',\n          'hint': 'core.create.title.hint',\n          'name': 'docTitle',\n          'placeholder': 'core.create.name.placeholder'\n        },\n        'preview': {\n          'label': 'core.create.locationPreview.label',\n          'hint': 'core.create.locationPreview.hint'\n        },\n        'parent': {\n          'label': 'core.create.spaceReference.label',\n          'hint': 'core.create.spaceReference.hint',\n          'name': 'spaceName',\n          'reference': $services.model.resolveSpace($defaultSpace),\n          'placeholder': 'core.create.spaceReference.placeholder'\n        },\n        'name': {\n          'label': 'core.create.name.label',\n          'hint': 'core.create.name.hint',\n          'name': 'docName',\n          'placeholder': 'core.create.name.placeholder'\n        }\n      })\n      &lt;p&gt;\n        &lt;span class=\"buttonwrapper\"&gt;\n          &lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml($services.localization.render(\n            'platform.xclass.defaultClassSheet.createPage.label'))\"/&gt;\n        &lt;/span&gt;\n      &lt;/p&gt;\n      &lt;/fieldset&gt;\n    &lt;/form&gt;\n    {{/html}}\n\n  #end## has class sheet and class template\n  (% id=\"HExistingPages\" %)\n  = {{translation key=\"platform.xclass.defaultClassSheet.pages.heading\"/}} =\n\n  {{translation key=\"platform.xclass.defaultClassSheet.pages.description\"/}}\n\n  #set ($options = {\n    'className': $doc.fullName,\n    'translationPrefix' : 'platform.index.',\n    'queryFilters': ['unique']\n  })\n  {{liveData\n    id=\"classEntries\"\n    properties=\"doc.title,doc.location,doc.date,doc.author,doc.objectCount,_actions\"\n    source=\"liveTable\"\n    className=\"$services.rendering.escape(${doc.fullName}, 'xwiki/2.1')\"\n    sourceParameters=\"$services.rendering.escape($escapetool.url($options), 'xwiki/2.1')\"\n  }}\n  {\n    \"meta\": {\n      \"propertyDescriptors\": [\n        {\n          \"id\": \"doc.title\",\n          \"editable\": false\n        },\n        {\n          \"id\": \"doc.objectCount\",\n          \"editable\": false,\n          \"filterable\": false,\n          \"sortable\": false\n        }\n      ]\n    }\n  }\n  {{/liveData}}\n\n  (% id=\"HClassSheets\" %)\n  = {{translation key=\"platform.xclass.defaultClassSheet.sheets.heading\"/}} =\n  #if (!$hasClassSheets || !$hasClassTemplate)\n\n    {{translation key=\"platform.xclass.defaultClassSheet.sheets.missing\"/}}\n  #end\n\n  {{info}}\n    #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.sheets.description', ['__START_EM__', '__END_EM__']))\n    #set ($message = $escapetool.xml($message))\n    ## First escape the content of the translation, then replace the placeholders with content that would\n    ## otherwise be escaped during the first escaping.\n    {{html}}$message.replace('__START_EM__', '&lt;em&gt;').replace('__END_EM__', '&lt;/em&gt;'){{/html}}\n  {{/info}}\n\n  #if(!$hasClassSheets)\n    {{html}}\n      &lt;form action=\"$xwiki.getURL($defaultClassSheetReference, 'save', 'editor=wiki')\" method=\"post\"&gt;\n        &lt;div&gt;\n          &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n          &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n          &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml(${doc.URL})\"/&gt;\n          #set ($sheetContent = $xwiki.getDocument('XWiki.ObjectSheet').getContent().replace('XWiki.MyClass',\n            $doc.fullName))\n          ## We have to encode the new line characters in order to preserve them, otherwise they are replace with a\n          ## space when the HTML is cleaned.\n          ## FIXME: Use a dedicated escape tool method when XCOMMONS-405 is implemented.\n          #set ($sheetContent = $escapetool.xml($sheetContent).replaceAll(\"\\n\", '&amp;#10;'))\n          &lt;input type=\"hidden\" name=\"content\" value=\"$sheetContent\"/&gt;\n          &lt;input type=\"hidden\" name=\"title\" value=\"${escapetool.h}if(${escapetool.d}doc.documentReference.name == '$escapetool.xml($defaultClassSheetReference.name)')$escapetool.xml($className) Sheet${escapetool.h}{else}${escapetool.d}services.display.title(${escapetool.d}doc, {'displayerHint': 'default', 'outputSyntaxId': 'plain/1.0'})${escapetool.h}end\"/&gt;\n          &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n            $services.localization.render('platform.xclass.defaultClassSheet.sheets.create'))\"/&gt;&lt;/span&gt;\n        &lt;/div&gt;\n      &lt;/form&gt;\n    {{/html}}\n  #else\n    #set($defaultClassSheetDoc = $xwiki.getDocument($defaultClassSheetReference))\n    #if($classSheetReferences.isEmpty() &amp;&amp; !$defaultClassSheetDoc.getObject('XWiki.SheetClass'))\n      ## The sheet is not bound to the class.\n      #set($xredirect = $xwiki.relativeRequestURL)\n      #set($defaultClassSheetStringReference = $services.model.serialize($defaultClassSheetReference, \"default\"))\n      #set($bindURL = $doc.getURL('view', \"bindSheet=${escapetool.url($defaultClassSheetStringReference)}&amp;xredirect=${escapetool.url($xredirect)}&amp;form_token=$!{services.csrf.getToken()}\"))\n      {{warning}}\n        {{translation key=\"platform.xclass.defaultClassSheet.sheets.notBound\"/}} ##\n        #if ($hasEdit)\n          {{html}}\n          &lt;a href=\"$escapetool.xml($bindURL)\"&gt;##\n            $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.sheets.bind')) \u00bb##\n          &lt;/a&gt;.\n          {{/html}}\n        #end\n      {{/warning}}\n\n    #end\n    #if ($classSheetReferences.size() &lt; 2)\n      #set($classSheetDoc = $defaultClassSheetDoc)\n      #if(!$classSheetReferences.isEmpty())\n        #set($classSheetDoc = $xwiki.getDocument($classSheetReferences.get(0)))\n      #end\n      #set ($sheetPath = \"#hierarchy($classSheetDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n      #set ($classSheetLink = \"$services.localization.render('platform.xclass.defaultClassSheet.sheets.view', [$sheetPath.trim()]) \u00bb\")\n      #set ($classSheetLink = $services.rendering.escape($classSheetLink, 'xwiki/2.1'))\n      #set ($classSheetLink = $services.rendering.escape($classSheetLink, 'xwiki/2.1'))\n      #set ($classSheetText = ${classSheetDoc.fullName})\n      #set ($classSheetText = $services.rendering.escape($classSheetText, 'xwiki/2.1'))\n      [[$classSheetLink&gt;&gt;$classSheetText]]\n    #else\n      {{translation key=\"platform.xclass.defaultClassSheet.sheets.list\"/}}\n\n      #foreach($classSheetReference in $classSheetReferences)\n        * [[$services.model.serialize($classSheetReference, \"default\")]]\n      #end\n    #end\n  #end\n\n  (% id=\"HClassTemplate\" %)\n  = {{translation key=\"platform.xclass.defaultClassSheet.template.heading\"/}} =\n\n    {{info}}\n      #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.template.description', ['__START_EM__', '__END_EM__']))\n      #set ($message = $escapetool.xml($message))\n      ## First escape the content of the translation, then replace the placeholders with content that would\n      ## otherwise be escaped during the first escaping.\n      {{html}}$message.replace('__START_EM__', '&lt;em&gt;').replace('__END_EM__', '&lt;/em&gt;'){{/html}}\n    {{/info}}\n\n  #if (!$hasClassTemplate)\n    {{html}}\n      &lt;form action=\"$escapetool.xml($classTemplateDoc.getURL('save', 'editor=wiki'))\" method=\"post\"&gt;\n        &lt;div&gt;\n          &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n          &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n          &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml(${doc.URL})\"/&gt;\n          &lt;input type=\"hidden\" name=\"title\" value=\"$escapetool.xml($className) Template\"/&gt;\n          &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n            $services.localization.render('platform.xclass.defaultClassSheet.template.create'))\"/&gt;&lt;/span&gt;\n        &lt;/div&gt;\n      &lt;/form&gt;\n    {{/html}}\n  #else\n    #if(!$classTemplateDoc.getObject(${doc.fullName}))\n      #set($xredirect = $xwiki.relativeRequestURL)\n      #set($createUrl = $classTemplateDoc.getURL('objectadd', \"classname=${escapetool.url($doc.fullName)}&amp;xredirect=${escapetool.url($xredirect)}&amp;form_token=$!{services.csrf.getToken()}\"))\n      {{warning}}\n        #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.template.missingObject', ['__CLASS_NAME__']))\n        #set ($message = $escapetool.xml($message))\n        {{html}}\n          ## First escape the content of the translation, then replace the placeholders with content that would\n          ## otherwise be escaped during the first escaping.\n          $message.replace('__CLASS_NAME__', \"&lt;em&gt;$escapetool.xml($className)&lt;/em&gt;\")\n          &lt;a href=\"$escapetool.xml($createUrl)\"&gt;##\n            $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.template.addObject', [$className])) \u00bb##\n          &lt;/a&gt;.\n        {{/html}}\n      {{/warning}}\n\n    #end\n    #set ($templatePath = \"#hierarchy($classTemplateDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n    #set ($templateDocLink = \"$services.localization.render('platform.xclass.defaultClassSheet.template.view', [$templatePath.trim()]) \u00bb\")\n    #set ($templateDocLink = $services.rendering.escape($templateDocLink, 'xwiki/2.1'))\n    #set ($templateDocLink = $services.rendering.escape($templateDocLink, 'xwiki/2.1'))\n    #set ($templateDocText = \"${classTemplateDoc.fullName}\")\n    ## First escape the xwiki/2.1 syntax of the translation, then replace the placeholders with content that would\n    ## otherwise be escaped during the first escaping.\n    #set ($templateDocText = $services.rendering.escape($templateDocText, 'xwiki/2.1'))\n    [[$templateDocLink&gt;&gt;$templateDocText]]\n  #end\n  ## Create a template provider only if a template for the current class exists.\n  #if ($classTemplateDoc.getObject(${doc.fullName}))\n    (% id=\"HClassTemplateProvider\" %)\n    = {{translation key=\"platform.xclass.defaultClassSheet.templateProvider.heading\"/}} =\n\n      {{info}}\n        #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.templateProvider.description', ['__EM__']))\n        #set ($message = $services.rendering.escape($message, 'xwiki/2.1'))\n        ## First escape the xwiki/2.1 syntax of the translation, then replace the placeholders with content that would\n        ## otherwise be escaped during the first escaping.\n        ## The replacement key is itself escaped, and it's escaped form needs to be used for the replacement.\n        $message.replace('~_~_~E~M~_~_', '//')\n      {{/info}}\n\n    #if (!$hasClassTemplateProvider)\n      #set ($templateProviderClassName = 'XWiki.TemplateProviderClass')\n      ## Do the page creation and object addition in one step, providing some default values.\n      ## In order to get the root space of the class and use it as restrictionSpace, we need to be sure that we have\n      ## the expected result for multiple level hierarchies, like MyApplication.Code.MyApplicationClass. In this case,\n      ## the template provider in enabled in MyApplication space.\n      #set ($restrictionSpace = $doc.documentReference.spaceReferences.get(0).name)\n      #set ($createUrlQueryString = $escapetool.url({\n        'classname': $templateProviderClassName,\n        'xredirect': $xwiki.relativeRequestURL,\n        'form_token': $services.csrf.token,\n        \"${templateProviderClassName}_name\": $className,\n        \"${templateProviderClassName}_description\":\n          $services.localization.render('platform.xclass.templateProvider.defaultDescription', [$className]),\n        \"${templateProviderClassName}_template\": $classTemplateDoc,\n        \"${templateProviderClassName}_visibilityRestrictions\": $restrictionSpace}))\n      #set ($createUrl = $classTemplateProviderDoc.getURL('objectadd', $createUrlQueryString))\n      {{html}}\n        &lt;form action=\"$escapetool.xml($classTemplateProviderDoc.getURL('save', 'editor=wiki'))\" method=\"post\"&gt;\n          &lt;div&gt;\n            &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n            &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n            &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml($createUrl)\"/&gt;\n            &lt;input type=\"hidden\" name=\"title\" value=\"$escapetool.xml($className) Template Provider\"/&gt;\n            &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n              $services.localization.render('platform.xclass.defaultClassSheet.templateProvider.create'))\"/&gt;&lt;/span&gt;\n          &lt;/div&gt;\n        &lt;/form&gt;\n      {{/html}}\n    #else\n      #set ($templateProviderPath = \"#hierarchy($classTemplateProviderDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n      #set ($linkTarget = \"$services.localization.render('platform.xclass.defaultClassSheet.templateProvider.view', [$templateProviderPath.trim()]) \u00bb\")\n      #set ($linkTarget = $services.rendering.escape($linkTarget, 'xwiki/2.1'))\n      #set ($linkTarget = $services.rendering.escape($linkTarget, 'xwiki/2.1'))\n      #set ($linkLabel = $services.rendering.escape(${classTemplateProviderDoc.fullName}, 'xwiki/2.1'))\n      [[$linkTarget&gt;&gt;$linkLabel]]\n    #end\n  #end\n\n#end## !$isSheet\n{{/velocity}}</content>\n  <object>\n    <name>XWiki.ClassSheet</name>\n    <number>0</number>\n    <className>XWiki.SheetDescriptorClass</className>\n    <guid>4d854769-efce-441c-8594-349c458b880e</guid>\n    <class>\n      <name>XWiki.SheetDescriptorClass</name>\n      <customClass/>\n      <customMapping/>\n      <defaultViewSheet/>\n      <defaultEditSheet/>\n      <defaultWeb/>\n      <nameField/>\n      <validationScript/>\n      <action>\n        <customDisplay/>\n        <disabled>0</disabled>\n        <name>action</name>\n        <number>1</number>\n        <picker>0</picker>\n        <prettyName>Action</prettyName>\n        <size>30</size>\n        <unmodifiable>0</unmodifiable>\n        <validationMessage/>\n        <validationRegExp/>\n        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>\n      </action>\n    </class>\n    <property>\n      <action>view</action>\n    </property>\n  </object>\n</xwikidoc>\n"], "fixing_code": ["<?xml version=\"1.1\" encoding=\"UTF-8\"?>\n\n<!--\n * See the NOTICE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n-->\n\n<xwikidoc version=\"1.5\" reference=\"XWiki.ClassSheet\" locale=\"\">\n  <web>XWiki</web>\n  <name>ClassSheet</name>\n  <language/>\n  <defaultLanguage/>\n  <translation>0</translation>\n  <creator>xwiki:XWiki.Admin</creator>\n  <parent>XWiki.XWikiClasses</parent>\n  <author>xwiki:XWiki.Admin</author>\n  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>\n  <version>1.1</version>\n  <title>#sheetTitle('platform.xclass.defaultClassSheet.title')</title>\n  <comment/>\n  <minorEdit>false</minorEdit>\n  <syntaxId>xwiki/2.0</syntaxId>\n  <hidden>true</hidden>\n  <content>{{template name=\"locationPicker_macros.vm\" /}}\n\n{{velocity}}\n## This document can be copied in order to be customized so we cannot rely on its name to determine if the currently\n## displayed document is a class or the class sheet itself. We look for the sheet descriptor instead.\n#set ($isSheet = $doc.getObject('XWiki.SheetDescriptorClass'))\n#if ($isSheet)\n  ## Viewing the sheet document itself.\n  {{translation key=\"platform.xclass.defaultClassSheet.description\"/}}\n#elseif (\"$!request.bindSheet\" != '' &amp;&amp; $hasEdit)\n  #if ($services.csrf.isTokenValid($request.getParameter('form_token')))\n    ## Bind the sheet to the class.\n    #set ($classSheetReference = $services.model.resolveDocument($request.bindSheet))\n    #if ($services.sheet.bindClassSheet($doc, $classSheetReference))\n      $doc.save($services.localization.render('platform.xclass.defaultClassSheet.sheets.bind'))\n    #end\n    $response.sendRedirect($request.xredirect)\n  #else\n    $response.sendRedirect($services.csrf.getResubmissionURL())\n  #end\n  ## Stop processing, since we already sent a redirect.\n  #stop\n#elseif(\"$!request.docName\" != '')\n  ## Request for creating a new instance.\n  ## We don't actually create a new instance here, we just redirect to the edit mode.\n  #set ($targetSpaceRef = $services.model.resolveSpace($request.spaceName))\n  #set ($targetDocRef = $services.model.createDocumentReference($request.docName, $targetSpaceRef))\n  #if (!$xwiki.exists($targetDocRef) &amp;&amp; $services.security.authorization.hasAccess('edit', $targetDocRef))\n    ## Compute the default edit mode to ensure backward compatibility with documents that are still using the deprecated\n    ## inline action.\n    #set ($editAction = $xwiki.getDocument($request.template).getDefaultEditMode())\n    $response.sendRedirect($xwiki.getURL($targetDocRef, $editAction, $escapetool.url({\n      'template': $request.template,\n      'parent': $request.parent,\n      'title': $request.docName\n    })))\n    ## Stop processing, since we already sent a redirect.\n    #stop\n  #end\n#end\n{{/velocity}}\n\n{{velocity}}\n## If this sheet is explicitly bound to the displayed class then print the class document content before the\n## sheet output. Class authors can put the description of the class in the class document content.\n#set($classSheetReference = $services.model.createDocumentReference($doc.wiki, 'XWiki', 'ClassSheet'))\n#if($services.sheet.getDocumentSheets($doc).contains($classSheetReference))\n  {{include reference=\"\" author=\"target\"/}}\n#end\n{{/velocity}}\n\n{{velocity}}\n#if (!$isSheet)\n  #set ($className = $doc.pageReference.name)\n  #set ($className = $stringtool.removeEnd($className, 'Class'))\n  ## Determine the class sheets.\n  #set ($classSheetReferences = $services.sheet.getClassSheets($doc))\n  #if ($classSheetReferences.isEmpty())\n    ## There is no class sheet explicitly bound to this class. Fall-back on naming convention.\n    ## Before XWiki 2.0, the default class sheet was suffixed with \"ClassSheet\". Since 2.0, the suffix is just \"Sheet\".\n    #set ($defaultClassSheetReference = $services.model.createDocumentReference(\"${className}ClassSheet\",\n      $doc.documentReference.parent))\n    #if (!$xwiki.exists($defaultClassSheetReference))\n      #set ($defaultClassSheetReference = $services.model.createDocumentReference(\"${className}Sheet\",\n        $doc.documentReference.parent))\n    #end\n  #end\n  ## Determine the template using naming convention.\n  ## Before XWiki 2.0, the default class template was suffixed with \"ClassTemplate\".\n  ## Since 2.0, the suffix is just \"Template\".\n  #set ($classTemplateReference = $services.model.createDocumentReference(\"${className}ClassTemplate\",\n    $doc.documentReference.parent))\n  #if (!$xwiki.exists($classTemplateReference))\n    #set ($classTemplateReference = $services.model.createDocumentReference(\"${className}Template\",\n      $doc.documentReference.parent))\n  #end\n  ## Determine the template provider using naming convention.\n  #set ($classTemplateProviderReference = $services.model.createDocumentReference(\"${className}TemplateProvider\",\n    $doc.documentReference.parent))\n  #set ($classTemplateProviderDoc = $xwiki.getDocument($classTemplateProviderReference))\n  #set ($hasClassTemplateProvider = !$classTemplateProviderDoc.isNew())\n  #set($classTemplateDoc = $xwiki.getDocument($classTemplateReference))\n  #set($hasClassSheets = !$classSheetReferences.isEmpty() || $xwiki.exists($defaultClassSheetReference))\n  #set($hasClassTemplate = !$classTemplateDoc.isNew())\n  #if(!$defaultSpace)\n    #set($defaultSpace = $doc.space)\n  #end\n  #if(!$defaultParent)\n    #set($defaultParent = ${doc.fullName})\n  #end\n\n  #set ($classEditorURL = $doc.getURL('edit', 'editor=class'))\n  #if($doc.getxWikiClass().properties.size() == 0)\n    #set ($openLink = \"&lt;a href='$escapetool.xml($classEditorURL)'&gt;\")\n    #set ($closeLink = '&lt;/a&gt;')\n    {{warning}}\n      {{html}}\n      ## First escape the content of the translation, then replace the placeholders with content that would otherwise be\n      ## escaped during the first escaping.\n      #set ($warningMessage = $services.localization.render('platform.xclass.defaultClassSheet.properties.empty', \n        ['__OPEN_LINK__', '__CLOSE_LINK__']))\n      $escapetool.xml($warningMessage).replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', $closeLink)\n      {{/html}}\n    {{/warning}}\n  #else\n    (% id=\"HClassProperties\" %)\n    = {{translation key=\"platform.xclass.defaultClassSheet.properties.heading\"/}} =\n    #foreach($property in $doc.getxWikiClass().properties)\n      * $services.rendering.escape(\"$property.prettyName ($property.name: $xwiki.metaclass.get($property.classType).prettyName)\", $xwiki.currentContentSyntaxId)\n    #end\n    #set ($openLink = \"&lt;a href='$escapetool.xml($classEditorURL)'&gt;\")\n    #set ($closeLink = '&lt;/a&gt;')\n    #set ($warningMessage = $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.properties.edit', ['__OPEN_LINK__', '__CLOSE_LINK__'])))\n    ## First escape the content of the translation, then replace the placeholders with content that would otherwise be\n    ## escaped during the first escaping.\n    * //{{html}}$warningMessage.replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', $closeLink){{/html}}//\n\n  #end\n  #if ($hasClassSheets &amp;&amp; $hasClassTemplate)\n    (% id=\"HCreatePage\" %)\n    = {{translation key=\"platform.xclass.defaultClassSheet.createPage.heading\"/}} =\n    #if(\"$!targetDocRef\" != '' &amp;&amp; $xwiki.exists($targetDocRef))\n      {{warning}}\n        {{html}}\n          #set ($targetDocLink = $xwiki.getURL($targetDocRef))\n          #set ($openLink = \"&lt;a href='$escapetool.xml($targetDocLink)'&gt;\")\n          #set ($message = $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.createPage.pageAlreadyExists', ['__OPEN_LINK__', '__CLOSE_LINK__'])))\n          ## First escape the content of the translation, then replace the placeholders with content that would\n          ## otherwise be escaped during the first escaping.\n          $message.replace('__OPEN_LINK__', $openLink).replace('__CLOSE_LINK__', '&lt;/a&gt;')\n        {{/html}}\n      {{/warning}}\n    #elseif(\"$!targetDocRef\" != '')\n\n      {{warning}}{{translation key=\"platform.xclass.defaultClassSheet.createPage.denied\"/}}{{/warning}}\n    #end\n\n    {{html}}\n    &lt;form action=\"$doc.getURL()\" id=\"newdoc\" method=\"post\" class=\"xform half\"&gt;\n      &lt;fieldset&gt;\n      &lt;div class=\"hidden\"&gt;\n        &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n        &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${defaultParent})\"/&gt;\n        &lt;input type=\"hidden\" name=\"template\" value=\"$escapetool.xml(${classTemplateDoc})\"/&gt;\n        &lt;input type=\"hidden\" name=\"sheet\" value=\"1\"/&gt;\n      &lt;/div&gt;\n      #locationPicker({\n        'id': 'target',\n        'title': {\n          'label': 'core.create.title',\n          'hint': 'core.create.title.hint',\n          'name': 'docTitle',\n          'placeholder': 'core.create.name.placeholder'\n        },\n        'preview': {\n          'label': 'core.create.locationPreview.label',\n          'hint': 'core.create.locationPreview.hint'\n        },\n        'parent': {\n          'label': 'core.create.spaceReference.label',\n          'hint': 'core.create.spaceReference.hint',\n          'name': 'spaceName',\n          'reference': $services.model.resolveSpace($defaultSpace),\n          'placeholder': 'core.create.spaceReference.placeholder'\n        },\n        'name': {\n          'label': 'core.create.name.label',\n          'hint': 'core.create.name.hint',\n          'name': 'docName',\n          'placeholder': 'core.create.name.placeholder'\n        }\n      })\n      &lt;p&gt;\n        &lt;span class=\"buttonwrapper\"&gt;\n          &lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml($services.localization.render(\n            'platform.xclass.defaultClassSheet.createPage.label'))\"/&gt;\n        &lt;/span&gt;\n      &lt;/p&gt;\n      &lt;/fieldset&gt;\n    &lt;/form&gt;\n    {{/html}}\n\n  #end## has class sheet and class template\n  (% id=\"HExistingPages\" %)\n  = {{translation key=\"platform.xclass.defaultClassSheet.pages.heading\"/}} =\n\n  {{translation key=\"platform.xclass.defaultClassSheet.pages.description\"/}}\n\n  #set ($options = {\n    'className': $doc.fullName,\n    'translationPrefix' : 'platform.index.',\n    'queryFilters': ['unique']\n  })\n  {{liveData\n    id=\"classEntries\"\n    properties=\"doc.title,doc.location,doc.date,doc.author,doc.objectCount,_actions\"\n    source=\"liveTable\"\n    className=\"$services.rendering.escape(${doc.fullName}, 'xwiki/2.1')\"\n    sourceParameters=\"$services.rendering.escape($escapetool.url($options), 'xwiki/2.1')\"\n  }}\n  {\n    \"meta\": {\n      \"propertyDescriptors\": [\n        {\n          \"id\": \"doc.title\",\n          \"editable\": false\n        },\n        {\n          \"id\": \"doc.objectCount\",\n          \"editable\": false,\n          \"filterable\": false,\n          \"sortable\": false\n        }\n      ]\n    }\n  }\n  {{/liveData}}\n\n  (% id=\"HClassSheets\" %)\n  = {{translation key=\"platform.xclass.defaultClassSheet.sheets.heading\"/}} =\n  #if (!$hasClassSheets || !$hasClassTemplate)\n\n    {{translation key=\"platform.xclass.defaultClassSheet.sheets.missing\"/}}\n  #end\n\n  {{info}}\n    #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.sheets.description', ['__START_EM__', '__END_EM__']))\n    #set ($message = $escapetool.xml($message))\n    ## First escape the content of the translation, then replace the placeholders with content that would\n    ## otherwise be escaped during the first escaping.\n    {{html}}$message.replace('__START_EM__', '&lt;em&gt;').replace('__END_EM__', '&lt;/em&gt;'){{/html}}\n  {{/info}}\n\n  #if(!$hasClassSheets)\n    {{html}}\n      &lt;form action=\"$xwiki.getURL($defaultClassSheetReference, 'save', 'editor=wiki')\" method=\"post\"&gt;\n        &lt;div&gt;\n          &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n          &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n          &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml(${doc.URL})\"/&gt;\n          #set ($sheetContent = $xwiki.getDocument('XWiki.ObjectSheet').getContent().replace('XWiki.MyClass',\n            $doc.fullName))\n          ## We have to encode the new line characters in order to preserve them, otherwise they are replace with a\n          ## space when the HTML is cleaned.\n          ## FIXME: Use a dedicated escape tool method when XCOMMONS-405 is implemented.\n          #set ($sheetContent = $escapetool.xml($sheetContent).replaceAll(\"\\n\", '&amp;#10;'))\n          &lt;input type=\"hidden\" name=\"content\" value=\"$sheetContent\"/&gt;\n          &lt;input type=\"hidden\" name=\"title\" value=\"${escapetool.h}if(${escapetool.d}doc.documentReference.name == '$escapetool.xml($defaultClassSheetReference.name)')$escapetool.xml($className) Sheet${escapetool.h}{else}${escapetool.d}services.display.title(${escapetool.d}doc, {'displayerHint': 'default', 'outputSyntaxId': 'plain/1.0'})${escapetool.h}end\"/&gt;\n          &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n            $services.localization.render('platform.xclass.defaultClassSheet.sheets.create'))\"/&gt;&lt;/span&gt;\n        &lt;/div&gt;\n      &lt;/form&gt;\n    {{/html}}\n  #else\n    #set($defaultClassSheetDoc = $xwiki.getDocument($defaultClassSheetReference))\n    #if($classSheetReferences.isEmpty() &amp;&amp; !$defaultClassSheetDoc.getObject('XWiki.SheetClass'))\n      ## The sheet is not bound to the class.\n      #set($xredirect = $xwiki.relativeRequestURL)\n      #set($defaultClassSheetStringReference = $services.model.serialize($defaultClassSheetReference, \"default\"))\n      #set($bindURL = $doc.getURL('view', \"bindSheet=${escapetool.url($defaultClassSheetStringReference)}&amp;xredirect=${escapetool.url($xredirect)}&amp;form_token=$!{services.csrf.getToken()}\"))\n      {{warning}}\n        {{translation key=\"platform.xclass.defaultClassSheet.sheets.notBound\"/}} ##\n        #if ($hasEdit)\n          {{html}}\n          &lt;a href=\"$escapetool.xml($bindURL)\"&gt;##\n            $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.sheets.bind')) \u00bb##\n          &lt;/a&gt;.\n          {{/html}}\n        #end\n      {{/warning}}\n\n    #end\n    #if ($classSheetReferences.size() &lt; 2)\n      #set($classSheetDoc = $defaultClassSheetDoc)\n      #if(!$classSheetReferences.isEmpty())\n        #set($classSheetDoc = $xwiki.getDocument($classSheetReferences.get(0)))\n      #end\n      #set ($sheetPath = \"#hierarchy($classSheetDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n      #set ($classSheetLink = \"$services.localization.render('platform.xclass.defaultClassSheet.sheets.view', [$sheetPath.trim()]) \u00bb\")\n      #set ($classSheetLink = $services.rendering.escape($classSheetLink, 'xwiki/2.1'))\n      #set ($classSheetLink = $services.rendering.escape($classSheetLink, 'xwiki/2.1'))\n      #set ($classSheetText = ${classSheetDoc.fullName})\n      #set ($classSheetText = $services.rendering.escape($classSheetText, 'xwiki/2.1'))\n      [[$classSheetLink&gt;&gt;$classSheetText]]\n    #else\n      {{translation key=\"platform.xclass.defaultClassSheet.sheets.list\"/}}\n\n      #foreach($classSheetReference in $classSheetReferences)\n        * [[$services.model.serialize($classSheetReference, \"default\")]]\n      #end\n    #end\n  #end\n\n  (% id=\"HClassTemplate\" %)\n  = {{translation key=\"platform.xclass.defaultClassSheet.template.heading\"/}} =\n\n    {{info}}\n      #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.template.description', ['__START_EM__', '__END_EM__']))\n      #set ($message = $escapetool.xml($message))\n      ## First escape the content of the translation, then replace the placeholders with content that would\n      ## otherwise be escaped during the first escaping.\n      {{html}}$message.replace('__START_EM__', '&lt;em&gt;').replace('__END_EM__', '&lt;/em&gt;'){{/html}}\n    {{/info}}\n\n  #if (!$hasClassTemplate)\n    {{html}}\n      &lt;form action=\"$escapetool.xml($classTemplateDoc.getURL('save', 'editor=wiki'))\" method=\"post\"&gt;\n        &lt;div&gt;\n          &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n          &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n          &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml(${doc.URL})\"/&gt;\n          &lt;input type=\"hidden\" name=\"title\" value=\"$escapetool.xml($className) Template\"/&gt;\n          &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n            $services.localization.render('platform.xclass.defaultClassSheet.template.create'))\"/&gt;&lt;/span&gt;\n        &lt;/div&gt;\n      &lt;/form&gt;\n    {{/html}}\n  #else\n    #if(!$classTemplateDoc.getObject(${doc.fullName}))\n      #set($xredirect = $xwiki.relativeRequestURL)\n      #set($createUrl = $classTemplateDoc.getURL('objectadd', \"classname=${escapetool.url($doc.fullName)}&amp;xredirect=${escapetool.url($xredirect)}&amp;form_token=$!{services.csrf.getToken()}\"))\n      {{warning}}\n        #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.template.missingObject', ['__CLASS_NAME__']))\n        #set ($message = $escapetool.xml($message))\n        {{html}}\n          ## First escape the content of the translation, then replace the placeholders with content that would\n          ## otherwise be escaped during the first escaping.\n          $message.replace('__CLASS_NAME__', \"&lt;em&gt;$escapetool.xml($className)&lt;/em&gt;\")\n          &lt;a href=\"$escapetool.xml($createUrl)\"&gt;##\n            $escapetool.xml($services.localization.render('platform.xclass.defaultClassSheet.template.addObject', [$className])) \u00bb##\n          &lt;/a&gt;.\n        {{/html}}\n      {{/warning}}\n\n    #end\n    #set ($templatePath = \"#hierarchy($classTemplateDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n    #set ($templateDocLink = \"$services.localization.render('platform.xclass.defaultClassSheet.template.view', [$templatePath.trim()]) \u00bb\")\n    #set ($templateDocLink = $services.rendering.escape($templateDocLink, 'xwiki/2.1'))\n    #set ($templateDocLink = $services.rendering.escape($templateDocLink, 'xwiki/2.1'))\n    #set ($templateDocText = \"${classTemplateDoc.fullName}\")\n    ## First escape the xwiki/2.1 syntax of the translation, then replace the placeholders with content that would\n    ## otherwise be escaped during the first escaping.\n    #set ($templateDocText = $services.rendering.escape($templateDocText, 'xwiki/2.1'))\n    [[$templateDocLink&gt;&gt;$templateDocText]]\n  #end\n  ## Create a template provider only if a template for the current class exists.\n  #if ($classTemplateDoc.getObject(${doc.fullName}))\n    (% id=\"HClassTemplateProvider\" %)\n    = {{translation key=\"platform.xclass.defaultClassSheet.templateProvider.heading\"/}} =\n\n      {{info}}\n        #set ($message = $services.localization.render('platform.xclass.defaultClassSheet.templateProvider.description', ['__EM__']))\n        #set ($message = $services.rendering.escape($message, 'xwiki/2.1'))\n        ## First escape the xwiki/2.1 syntax of the translation, then replace the placeholders with content that would\n        ## otherwise be escaped during the first escaping.\n        ## The replacement key is itself escaped, and it's escaped form needs to be used for the replacement.\n        $message.replace('~_~_~E~M~_~_', '//')\n      {{/info}}\n\n    #if (!$hasClassTemplateProvider)\n      #set ($templateProviderClassName = 'XWiki.TemplateProviderClass')\n      ## Do the page creation and object addition in one step, providing some default values.\n      ## In order to get the root space of the class and use it as restrictionSpace, we need to be sure that we have\n      ## the expected result for multiple level hierarchies, like MyApplication.Code.MyApplicationClass. In this case,\n      ## the template provider in enabled in MyApplication space.\n      #set ($restrictionSpace = $doc.documentReference.spaceReferences.get(0).name)\n      #set ($createUrlQueryString = $escapetool.url({\n        'classname': $templateProviderClassName,\n        'xredirect': $xwiki.relativeRequestURL,\n        'form_token': $services.csrf.token,\n        \"${templateProviderClassName}_name\": $className,\n        \"${templateProviderClassName}_description\":\n          $services.localization.render('platform.xclass.templateProvider.defaultDescription', [$className]),\n        \"${templateProviderClassName}_template\": $classTemplateDoc,\n        \"${templateProviderClassName}_visibilityRestrictions\": $restrictionSpace}))\n      #set ($createUrl = $classTemplateProviderDoc.getURL('objectadd', $createUrlQueryString))\n      {{html}}\n        &lt;form action=\"$escapetool.xml($classTemplateProviderDoc.getURL('save', 'editor=wiki'))\" method=\"post\"&gt;\n          &lt;div&gt;\n            &lt;input type=\"hidden\" name=\"form_token\" value=\"$!{services.csrf.getToken()}\" /&gt;\n            &lt;input type=\"hidden\" name=\"parent\" value=\"$escapetool.xml(${doc.fullName})\"/&gt;\n            &lt;input type=\"hidden\" name=\"xredirect\" value=\"$escapetool.xml($createUrl)\"/&gt;\n            &lt;input type=\"hidden\" name=\"title\" value=\"$escapetool.xml($className) Template Provider\"/&gt;\n            &lt;span class=\"buttonwrapper\"&gt;&lt;input type=\"submit\" class=\"button\" value=\"$escapetool.xml(\n              $services.localization.render('platform.xclass.defaultClassSheet.templateProvider.create'))\"/&gt;&lt;/span&gt;\n          &lt;/div&gt;\n        &lt;/form&gt;\n      {{/html}}\n    #else\n      #set ($templateProviderPath = \"#hierarchy($classTemplateProviderDoc.documentReference, {'plain': true, 'local': true, 'limit': 4})\")\n      #set ($linkTarget = \"$services.localization.render('platform.xclass.defaultClassSheet.templateProvider.view', [$templateProviderPath.trim()]) \u00bb\")\n      #set ($linkTarget = $services.rendering.escape($linkTarget, 'xwiki/2.1'))\n      #set ($linkTarget = $services.rendering.escape($linkTarget, 'xwiki/2.1'))\n      #set ($linkLabel = $services.rendering.escape(${classTemplateProviderDoc.fullName}, 'xwiki/2.1'))\n      [[$linkTarget&gt;&gt;$linkLabel]]\n    #end\n  #end\n\n#end## !$isSheet\n{{/velocity}}</content>\n  <object>\n    <name>XWiki.ClassSheet</name>\n    <number>0</number>\n    <className>XWiki.SheetDescriptorClass</className>\n    <guid>4d854769-efce-441c-8594-349c458b880e</guid>\n    <class>\n      <name>XWiki.SheetDescriptorClass</name>\n      <customClass/>\n      <customMapping/>\n      <defaultViewSheet/>\n      <defaultEditSheet/>\n      <defaultWeb/>\n      <nameField/>\n      <validationScript/>\n      <action>\n        <customDisplay/>\n        <disabled>0</disabled>\n        <name>action</name>\n        <number>1</number>\n        <picker>0</picker>\n        <prettyName>Action</prettyName>\n        <size>30</size>\n        <unmodifiable>0</unmodifiable>\n        <validationMessage/>\n        <validationRegExp/>\n        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>\n      </action>\n    </class>\n    <property>\n      <action>view</action>\n    </property>\n  </object>\n</xwikidoc>\n"], "filenames": ["xwiki-platform-core/xwiki-platform-xclass/xwiki-platform-xclass-ui/src/main/resources/XWiki/ClassSheet.xml"], "buggy_code_start_loc": [86], "buggy_code_end_loc": [87], "fixing_code_start_loc": [86], "fixing_code_end_loc": [87], "type": "CWE-863", "message": "XWiki Platform is a generic wiki platform. Starting in version 3.3-milestone-2 and prior to versions 14.10.4 and 15.0-rc-1, it's possible for a user to execute anything with the right of the author of the XWiki.ClassSheet document. This has been patched in XWiki 15.0-rc-1 and 14.10.4. There are no known workarounds.", "other": {"cve": {"id": "CVE-2023-32069", "sourceIdentifier": "security-advisories@github.com", "published": "2023-05-09T16:15:15.230", "lastModified": "2023-05-16T17:34:32.947", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "XWiki Platform is a generic wiki platform. Starting in version 3.3-milestone-2 and prior to versions 14.10.4 and 15.0-rc-1, it's possible for a user to execute anything with the right of the author of the XWiki.ClassSheet document. This has been patched in XWiki 15.0-rc-1 and 14.10.4. There are no known workarounds."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.9, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.1, "impactScore": 6.0}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-863"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:*:*:*:*:*:*:*:*", "versionStartIncluding": "3.4", "versionEndExcluding": "14.10.4", "matchCriteriaId": "BA7FCE38-8843-4EDE-AC01-DA70DC141AAB"}, {"vulnerable": true, "criteria": "cpe:2.3:a:xwiki:xwiki:3.3:milestone2:*:*:*:*:*:*", "matchCriteriaId": "ED1AD3A5-E286-47E6-9DD5-023F165A8263"}]}]}], "references": [{"url": "https://github.com/xwiki/xwiki-platform/commit/de72760d4a3e1e9be64a10660a0c19e9534e2ec4", "source": "security-advisories@github.com", "tags": ["Patch"]}, {"url": "https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-36fm-j33w-c25f", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}, {"url": "https://jira.xwiki.org/browse/XWIKI-20566", "source": "security-advisories@github.com", "tags": ["Vendor Advisory"]}]}, "github_commit_url": "https://github.com/xwiki/xwiki-platform/commit/de72760d4a3e1e9be64a10660a0c19e9534e2ec4"}}