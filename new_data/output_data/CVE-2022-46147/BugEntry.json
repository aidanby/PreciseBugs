{"buggy_code": ["Drag and Drop XBlock changelog\n==============================\n\nVersion 2.7.0 (2022-11-15)\n---------------------------\n\n* Add option to drop decoy items from scores\n\nVersion 2.6.0 (2022-10-24)\n---------------------------\n\n* Add package publishing workflow.\n\nVersion 2.5.0 (2022-10-13)\n---------------------------\n\n* Make the \"Show Answer\" condition customizable (like in the Problem XBlock). \n\nVersion 2.4.2 (2022-10-13)\n---------------------------\n\n* Support HTML in explanations.\n\nVersion 2.4.1 (2022-10-06)\n---------------------------\n* Remove dots on feedback and moves final feedback to end and set bold text on assessment mode.\n* Improve CSS styles for popup feedback.\n* Remove special popup feedback styles for mobile.\n* Improve feedback message when you reach the limit of elements on a zone.\n* Fix the issue while dragging an image item on Safari mobile.\n* Fix width issue for zone container on Safari mobile\n* Update translations.\n\nVersion 2.4.0 (2022-09-23)\n---------------------------\n\n* Drop the support for Python 3.5 and Ubuntu 18.04.\n\nVersion 2.3.11 (2022-07-22)\n---------------------------\n\n* Use global (platform-wide) translations as a fallback when XBlock translations are missing. \\\n  This change also has an intended side effect - it allows overriding English text with comprehensive themes (by patching the default translation catalog).\n\nVersion 2.3.10 (2022-07-22)\n---------------------------\n\n* Add an optional \"Explanation\" field.\n* Hide feedback div when there is no feedback content to display.\n* Update translations.\n\nVersion 2.3.9 (2022-06-15)\n---------------------------\n\n* Fix draggable item width inconsistency while dragging.\n* Do not move correctly placed items when showing the answer.\n* Distribute items with multiple correct zones among these zones when showing the answer.\n\nVersion 2.3.8 (2022-04-12)\n---------------------------\n\n* Add item option to remove padding from images dropped on a zone.\n* Add option to show zone border when dragging an item.\n* Hides text when a draggable item is placed in a target zone and frontend wait for LMS response, this is done since the size of the item increases when the spinner is visible.\n* Change containers and css classes to match those from edx-platform. The problem div now contains the drag container, buttons and feedback, css classes from submit button; submit answer and action buttons were also changed.\n* Improve feedback styles, now only icons shows color related with feedback and text color remains the same also each feedback line doesn't show borders.\n* Replaced `Travis` with `GitHub CI`.\n\nVersion 2.3.7 (2022-02-20)\n---------------------------\n\n* Reduce drag delay on mobile devices.\n\nVersion 2.3.6 (2021-08-11)\n---------------------------\n\n* Add Portuguese translations.\n\nVersion 2.3.5 (2021-03-09)\n---------------------------\n\n* Updates supported language translations.\n\nVersion 2.3.4 (2021-03-09)\n---------------------------\n\n* Enable adding weighted problems and overriding the scores for learners. The score can be overridden in LMS using either staff debug information or Student Admin in instructor Tab.\n\nVersion 2.3.3 (2021-03-09)\n---------------------------\n\n* Fixed drag and drop editor not loading in the studio due to translation issue.\n\nVersion 2.3.2 (2021-02-12)\n---------------------------\n\n* Fix instance of `DeprecatedEdxPlatformImportWarning`.\n\nVersion 2.3.1 (2020-08-04)\n---------------------------\n\n* Better JS i18n language mapping.\n* i18n source file updated in Transifex.\n* i18n updated (not complete) support for languages: ar, de, es_419, fr, he, hi, it, ja, ko, nl, pl, pt_BR, ru, tr and zh_CN\n\nVersion 2.3 (2020-08-04)\n---------------------------\n\n* Make Drag and Drop Indexable.\n* Drop Python 2 support.\n\nVersion 2.2.10 (2020-04-14)\n---------------------------\n\n* Fix bug where 'edx.drag_and_drop_v2.feedback.opened' event was sent to publish_event endpoint excessively on mouse move.  (PR #238)\n\nVersion 2.2.9 (2020-04-03)\n--------------------------\n\n* Updated fragment import to remove deprecation warning which was causing extra logs in Splunk etc.\n\nVersion 2.2.8 (2020-01-13)\n--------------------------\n\n* Updated code to render custom zone title as HTML\n\nVersion 2.2.7 (????-??-??)\n-------------------\n\n* NOTE: This version was skipped / is not documented.\n\nVersion 2.2.6 (2019-10-08)\n--------------------------\n\n* Python3 compatible.\n\nVersion 2.2.5 (2019-10-04)\n--------------------------\n\n* This repository is now python3 compatible.\n* Update the xblock-sdk hash which is python3 compatible also.\n\nVersion 2.2.4 (2019-07-30)\n---------------------------\n\n* Use InheritanceMixin for submission deadline checks (PR #219)\n* Submit button behavior will change in Assessment Mode and will now be impacted by subsection due date, grace period and course pacing\n\nVersion 2.2.3 (2019-04-05)\n---------------------------\n\n* Fix dragging bug in mobile (PR #204)\n\nVersion 2.2.2 (2019-03-22)\n---------------------------\n\n* Add translation for Reset and Feedback strings (PR #196)\n* Fix Loading message translation for Chinese & Spanish (PR #199)\n\nVersion 2.2.1 (2018-11-16)\n---------------------------\n\n* Fix JavaScript error when the XBlock is in an IFrame (PR #192)\n* Revert change to travis.yml so it doesn't need to be updated with every version bump.\n\nVersion 2.2.0 (2018-11-15)\n---------------------------\n\n* Extend existing APIs to support native mobile (PR #158)\n\nVersion 2.1.8 (2018-11-02)\n---------------------------\n\n* Implement XBlock JavaScript i18n using i18n_tool and django-statici18n (PR #156)\n\nVersion 2.1.7 (2018-10-10)\n---------------------------\n\n* Expand static URLs in FeedbackMessage (PR #190)\n\nVersion 2.1.6 (2018-05-15)\n---------------------------\n\n* Use i18n runtime service to provide translations for HTML templates (PR #154)\n* Ensures URLs are utf-8 encoded (PR #150)\n* Correct load listener setup (PR #153)\n* Improve image handling on mobile (PR #152)\n* When dragging, scroll target image as needed.\n\nVersion 2.1.5 (2017-11-06)\n---------------------------\n\n* Making the code more robust to handle an edge case when a dict does not contain an key (PR #149)\n\nVersion 2.1.4 (2017-11-06)\n---------------------------\n\n* Make XBlock always emit `progress` event explicitly when it is marked as complete.\n\nVersion 2.1.3 (2017-10-05)\n---------------------------\n\n* Prevent target image from shrinking in mobile, and make it scrollable (PR #135)\n\nVersion 2.1.2 (2017-10-02)\n---------------------------\n\n* Ability to generate zones and background image automatically (PR #136)\n\nVersion 2.1.1 (2017-09-26)\n---------------------------\n\n* Enforce XBlock variable types (PR #104)\n* Improvements for mobile (PRs #132, #133, #134)\n\nVersion 2.0.14 (2017-01-17)\n---------------------------\n\n* Various accessibility improvements (PRs #110, #111, #112)\n\nVersion 2.0.13 (2017-01-02)\n---------------------------\n\n* i18n improvements (PR #113)\n\nVersion 2.0.12 (2016-11-08)\n---------------------------\n\n* ([#108](https://github.com/openedx/xblock-drag-and-drop-v2/pull/108)) Grading updates:\n    * [SOL-2030][sol-2030] Grade information is now displayed beneath the display name of the problem (similar to CAPA)\n    * [SOL-2094][sol-2094] Fixed problem preventing DnDv2 blocks from being scored or graded.\n    * Highest grade achieved is now displayed in feedback area\n    * Renamed \"Maximum score\" field to \"Problem Weight\" to be in line with CAPA problems and avoid confusion.\n\n[sol-2030]: https://openedx.atlassian.net/browse/SOL-2030\n[sol-2094]: https://openedx.atlassian.net/browse/SOL-2094\n\nVersion 2.0.11 (2016-10-03)\n---------------------------\n\n* ([#106](https://github.com/openedx/xblock-drag-and-drop-v2/pull/106)) Don't delete misplaced items on final attempt\n\nVersion 2.0.10 (2016-09-22)\n---------------------------\n\n* ([#97](https://github.com/openedx/xblock-drag-and-drop-v2/pull/97)) Added \"item\" field to item.dropped event\n* ([#101](https://github.com/openedx/xblock-drag-and-drop-v2/pull/101)) Implement \"show answer\" button\n* ([#103](https://github.com/openedx/xblock-drag-and-drop-v2/pull/103)) Miscellaneous UI fixes\n* ([#105](https://github.com/openedx/xblock-drag-and-drop-v2/pull/105)) Correct an issue with background image selection\n\nVersion 2.0.9 (2016-09-01)\n--------------------------\n\n* ([#88](https://github.com/openedx/xblock-drag-and-drop-v2/pull/88)) Cleaned up studio editor template: styling, help texts, accessibility attributes, classes instead of IDs, etc.\n* ([#95](https://github.com/openedx/xblock-drag-and-drop-v2/pull/95)) Fixed flaky selenium tests\n* ([#85](https://github.com/openedx/xblock-drag-and-drop-v2/pull/85)) Accessibility improvements for item feedback popup\n* ([#73](https://github.com/openedx/xblock-drag-and-drop-v2/pull/73)) Accessibility improvements for item, zone and background image when using keyboard mode\n* ([#96](https://github.com/openedx/xblock-drag-and-drop-v2/pull/96)) Decoy items are properly accounted for in grade calculation and problem completion condition\n* ([#98](https://github.com/openedx/xblock-drag-and-drop-v2/pull/98)) Support for legacy item state\n* ([#92](https://github.com/openedx/xblock-drag-and-drop-v2/pull/92)) Prevented overlapping item placement: option to keep dropped item where learner dropped it was removed; items always use automatic layouts (left/center/right)\n* ([#93](https://github.com/openedx/xblock-drag-and-drop-v2/pull/93)) Per-item error feedback is shown in assessment mode when an attempt is submitted\n\nVersion 2.0.8 (2016-08-15)\n--------------------------\n\n* Numerical input feature removed\n* Multiple drop zones per item\n* Assessment mode - first version\n\n\nVersion 2.0.7 (2016-06-10)\n--------------------------\n\n* Translation fix: removed duplicate entries in translation files\n\nVersion 2.0.6 (2016-05-20)\n--------------------------\n\n* Accessibility fix: Removes role=\"application\"\n\nVersion 2.0.5 (2016-03-30)\n--------------------------\n\n* Marked strings for translations (PR #66)\n* Added the ability to specify automatic alignment of dropped items. (PR #57)\n\nVersion 2.0.4 (2016-03-10)\n--------------------------\n\n* Add a placeholder text to the input field to set the item image. (PR #65)\n\nVersion 2.0.3 (2016-03-07)\n--------------------------\n\n* Bugfix: When omitting the background image description in Studio, the red halo\n  indicating the field with the error did not show in Safari. (PR #62)\n* Bugfix: Make short URLs of the form /static/... to uploaded images work\n  correctly for item background images. (PR #63)\n\nVersion 2.0.2 (2016-02-18)\n--------------------------\n\n* Bugfix: \"Background description\" was required, but if you filled it out and pressed \"Continue\", \"Save\", it would accept the new description but would not actually save it. (PR #55)\n* Bugfix: When configuring the draggable items, the \"Image Description\" was always required, even if the \"Image URL\" was blank. (PR #55)\n* Bugfix: When clicking certain action links in the dndv2 editor (e.g. \"Add a Zone\"), the browser would scroll to the top of the page (since the href=\"#\" event was not prevented). (PR #55)\n* Bugfix: When changing tabs in the dndv2 editor, the next tab would often be scrolled down halfway. (PR #55)\n* Bugfix: In Studio, Newly added drag and drop components did not load properly, due to [a Studio bug](https://github.com/openedx/edx-platform/pull/11433) that affects Cypress and Dogwood. (Fixed in Studio post-Dogwood.) (PR #55)\n* Fixed some flaky tests\n\nVersion 2.0.1 (2016-02-15)\n--------------------------\n* Bugfix: If zone labels are numbers, like \"1\", \"2\", etc., then the draggables would not match with that zone (you cannot drop the draggables onto that zone) (PR #54)\n* Bugfix: If two zones had the same name/label, the block would not work properly. (PR #54)\n* Bugfix: If the platform's locale is set to a language like \"de\" or \"eo\" that formats numbers like \"3,14\", then the \"Maximum Score\" field appears blank when editing a dndv2 exercise in Studio. Attempting to save the exercise with that field blank causes a 500. (PR #54)\n\nVersion 2.0.0 (2016-01-29)\n------------------------\n\nA brand new release of the Drag and Drop XBlock, featuring major UX improvements, new features, and accessibility enhancements.\n", "# -*- coding: utf-8 -*- # pylint: disable=too-many-lines\n#\n\"\"\" Drag and Drop v2 XBlock \"\"\"\n\n# Imports ###########################################################\n\nfrom __future__ import absolute_import\nfrom collections import Counter\n\nimport copy\nimport json\nimport logging\n\nimport six.moves.urllib.error  # pylint: disable=import-error\nimport six.moves.urllib.parse  # pylint: disable=import-error\nimport six.moves.urllib.request  # pylint: disable=import-error\nimport six\nimport pkg_resources\nimport webob\n\nfrom django.utils import translation\nfrom xblock.core import XBlock\nfrom xblock.exceptions import JsonHandlerError\nfrom xblock.fields import Boolean, Dict, Float, Integer, Scope, String\nfrom xblock.scorable import ScorableXBlockMixin, Score\nfrom web_fragments.fragment import Fragment\nfrom xblockutils.resources import ResourceLoader\nfrom xblockutils.settings import ThemableXBlockMixin, XBlockWithSettingsMixin\n\nfrom .compat import get_grading_ignore_decoys_waffle_flag\nfrom .default_data import DEFAULT_DATA\nfrom .utils import (\n    Constants, SHOWANSWER, DummyTranslationService, FeedbackMessage,\n    FeedbackMessages, ItemStats, StateMigration, _clean_data, _\n)\n\n# Globals ###########################################################\n\nloader = ResourceLoader(__name__)\nlogger = logging.getLogger(__name__)\n\n\n# Classes ###########################################################\n\n\n# pylint: disable=bad-continuation\n@XBlock.wants('settings')\n@XBlock.wants('replace_urls')\n@XBlock.wants('user')  # Using `needs` breaks the Course Outline page in Maple.\n@XBlock.needs('i18n')\nclass DragAndDropBlock(\n    ScorableXBlockMixin,\n    XBlock,\n    XBlockWithSettingsMixin,\n    ThemableXBlockMixin\n):\n    \"\"\"\n    XBlock that implements a friendly Drag-and-Drop problem\n    \"\"\"\n\n    CATEGORY = \"drag-and-drop-v2\"\n\n    SOLUTION_CORRECT = \"correct\"\n    SOLUTION_PARTIAL = \"partial\"\n    SOLUTION_INCORRECT = \"incorrect\"\n\n    GRADE_FEEDBACK_CLASSES = {\n        SOLUTION_CORRECT: FeedbackMessages.MessageClasses.CORRECT_SOLUTION,\n        SOLUTION_PARTIAL: FeedbackMessages.MessageClasses.PARTIAL_SOLUTION,\n        SOLUTION_INCORRECT: FeedbackMessages.MessageClasses.INCORRECT_SOLUTION,\n    }\n\n    PROBLEM_FEEDBACK_CLASSES = {\n        SOLUTION_CORRECT: FeedbackMessages.MessageClasses.CORRECT_SOLUTION,\n        SOLUTION_PARTIAL: None,\n        SOLUTION_INCORRECT: None\n    }\n\n    display_name = String(\n        display_name=_(\"Title\"),\n        help=_(\"The title of the drag and drop problem. The title is displayed to learners.\"),\n        scope=Scope.settings,\n        default=_(\"Drag and Drop\"),\n        enforce_type=True,\n    )\n\n    mode = String(\n        display_name=_(\"Mode\"),\n        help=_(\n            \"Standard mode: the problem provides immediate feedback each time \"\n            \"a learner drops an item on a target zone. \"\n            \"Assessment mode: the problem provides feedback only after \"\n            \"a learner drops all available items on target zones.\"\n        ),\n        scope=Scope.settings,\n        values=[\n            {\"display_name\": _(\"Standard\"), \"value\": Constants.STANDARD_MODE},\n            {\"display_name\": _(\"Assessment\"), \"value\": Constants.ASSESSMENT_MODE},\n        ],\n        default=Constants.STANDARD_MODE,\n        enforce_type=True,\n    )\n\n    max_attempts = Integer(\n        display_name=_(\"Maximum attempts\"),\n        help=_(\n            \"Defines the number of times a student can try to answer this problem. \"\n            \"If the value is not set, infinite attempts are allowed.\"\n        ),\n        scope=Scope.settings,\n        default=None,\n        enforce_type=True,\n    )\n\n    show_title = Boolean(\n        display_name=_(\"Show title\"),\n        help=_(\"Display the title to the learner?\"),\n        scope=Scope.settings,\n        default=True,\n        enforce_type=True,\n    )\n\n    question_text = String(\n        display_name=_(\"Problem text\"),\n        help=_(\"The description of the problem or instructions shown to the learner.\"),\n        scope=Scope.settings,\n        default=\"\",\n        enforce_type=True,\n    )\n\n    show_question_header = Boolean(\n        display_name=_('Show \"Problem\" heading'),\n        help=_('Display the heading \"Problem\" above the problem text?'),\n        scope=Scope.settings,\n        default=True,\n        enforce_type=True,\n    )\n    showanswer = String(\n        display_name=_(\"Show answer\"),\n        help=_(\"Defines when to show the answer to the problem. \"\n               \"A default value can be set in Advanced Settings. \"\n               \"To revert setting a custom value, choose the 'Default' option.\"),\n        scope=Scope.settings,\n        default=SHOWANSWER.FINISHED,\n        values=[\n            {\"display_name\": _(\"Default\"), \"value\": SHOWANSWER.DEFAULT},\n            {\"display_name\": _(\"Always\"), \"value\": SHOWANSWER.ALWAYS},\n            {\"display_name\": _(\"Answered\"), \"value\": SHOWANSWER.ANSWERED},\n            {\"display_name\": _(\"Attempted or Past Due\"), \"value\": SHOWANSWER.ATTEMPTED},\n            {\"display_name\": _(\"Closed\"), \"value\": SHOWANSWER.CLOSED},\n            {\"display_name\": _(\"Finished\"), \"value\": SHOWANSWER.FINISHED},\n            {\"display_name\": _(\"Correct or Past Due\"), \"value\": SHOWANSWER.CORRECT_OR_PAST_DUE},\n            {\"display_name\": _(\"Past Due\"), \"value\": SHOWANSWER.PAST_DUE},\n            {\"display_name\": _(\"Never\"), \"value\": SHOWANSWER.NEVER},\n            {\"display_name\": _(\"After All Attempts\"), \"value\": SHOWANSWER.AFTER_ALL_ATTEMPTS},\n            {\"display_name\": _(\"After All Attempts or Correct\"), \"value\": SHOWANSWER.AFTER_ALL_ATTEMPTS_OR_CORRECT},\n            {\"display_name\": _(\"Attempted\"), \"value\": SHOWANSWER.ATTEMPTED_NO_PAST_DUE},\n        ],\n        enforce_type=True,\n    )\n\n    weight = Float(\n        display_name=_(\"Problem Weight\"),\n        help=_(\"Defines the number of points the problem is worth.\"),\n        scope=Scope.settings,\n        default=1,\n        enforce_type=True,\n    )\n\n    item_background_color = String(\n        display_name=_(\"Item background color\"),\n        help=_(\"The background color of draggable items in the problem (example: 'blue' or '#0000ff').\"),\n        scope=Scope.settings,\n        default=\"\",\n        enforce_type=True,\n    )\n\n    item_text_color = String(\n        display_name=_(\"Item text color\"),\n        help=_(\"Text color to use for draggable items (example: 'white' or '#ffffff').\"),\n        scope=Scope.settings,\n        default=\"\",\n        enforce_type=True,\n    )\n\n    max_items_per_zone = Integer(\n        display_name=_(\"Maximum items per zone\"),\n        help=_(\"This setting limits the number of items that can be dropped into a single zone.\"),\n        scope=Scope.settings,\n        default=None,\n        enforce_type=True,\n    )\n\n    data = Dict(\n        display_name=_(\"Problem data\"),\n        help=_(\n            \"Information about zones, items, feedback, explanation and background image for this problem. \"\n            \"This information is derived from the input that a course author provides via the interactive editor \"\n            \"when configuring the problem.\"\n        ),\n        scope=Scope.content,\n        default=DEFAULT_DATA,\n        enforce_type=True,\n    )\n\n    item_state = Dict(\n        help=_(\"Information about current positions of items that a learner has dropped on the target image.\"),\n        scope=Scope.user_state,\n        default={},\n        enforce_type=True,\n    )\n\n    attempts = Integer(\n        help=_(\"Number of attempts learner used\"),\n        scope=Scope.user_state,\n        default=0,\n        enforce_type=True,\n    )\n\n    completed = Boolean(\n        help=_(\"Indicates whether a learner has completed the problem at least once\"),\n        scope=Scope.user_state,\n        default=False,\n        enforce_type=True,\n    )\n\n    grade = Float(\n        help=_(\"DEPRECATED. Keeps maximum score achieved by student as a weighted value.\"),\n        scope=Scope.user_state,\n        default=0\n    )\n\n    raw_earned = Float(\n        help=_(\"Keeps maximum score achieved by student as a raw value between 0 and 1.\"),\n        scope=Scope.user_state,\n        default=0,\n        enforce_type=True,\n    )\n\n    raw_possible = Float(\n        help=_(\"Maximum score available of the problem as a raw value between 0 and 1.\"),\n        scope=Scope.user_state,\n        default=1,\n        enforce_type=True,\n    )\n\n    block_settings_key = 'drag-and-drop-v2'\n\n    @property\n    def score(self):\n        \"\"\"\n        Returns learners saved score.\n        \"\"\"\n        return Score(self.raw_earned, self.raw_possible)\n\n    def max_score(self):  # pylint: disable=no-self-use\n        \"\"\"\n        Return the problem's max score, which for DnDv2 always equals 1.\n        Required by the grading system in the LMS.\n        \"\"\"\n        return 1\n\n    def get_score(self):\n        \"\"\"\n        Returns user's current (saved) score for the problem as raw values.\n        \"\"\"\n        if self._get_raw_earned_if_set() is None:\n            self.raw_earned = self._learner_raw_score()\n        return Score(self.raw_earned, self.raw_possible)\n\n    def set_score(self, score):\n        \"\"\"\n        Sets the score on this block.\n        Takes a Score namedtuple containing a raw\n        score and possible max (for this block, we expect that this will\n        always be 1).\n        \"\"\"\n        self.raw_earned = score.raw_earned\n        self.raw_possible = score.raw_possible\n\n    def calculate_score(self):\n        \"\"\"\n        Returns a newly-calculated raw score on the problem for the learner\n        based on the learner's current state.\n        \"\"\"\n        return Score(self._learner_raw_score(), self.max_score())\n\n    def has_submitted_answer(self):\n        \"\"\"\n        Returns True if the user has made a submission.\n        \"\"\"\n        return self.fields['raw_earned'].is_set_on(self) or self.fields['grade'].is_set_on(self)\n\n    def weighted_grade(self):\n        \"\"\"\n        Returns the block's current saved grade multiplied by the block's\n        weight- the number of points earned by the learner.\n        \"\"\"\n        if self.raw_possible <= 0:\n            return None\n\n        if self.weight is None:\n            return self.raw_earned\n\n        weighted_earned = self.raw_earned * self.weight / self.raw_possible\n        return weighted_earned\n\n    def _learner_raw_score(self):\n        \"\"\"\n        Calculate raw score for learner submission.\n\n        As it is calculated as ratio of correctly placed (or left in bank in case of decoys) items to\n        total number of items, it lays in interval [0..1]\n        \"\"\"\n        correct_count, total_count = self._get_item_stats()\n        return correct_count / float(total_count)\n\n    @staticmethod\n    def _get_statici18n_js_url():\n        \"\"\"\n        Returns the Javascript translation file for the currently selected language, if any found by\n        `pkg_resources`\n        \"\"\"\n        lang_code = translation.get_language()\n        if not lang_code:\n            return None\n        text_js = 'public/js/translations/{lang_code}/text.js'\n        country_code = lang_code.split('-')[0]\n        for code in (translation.to_locale(lang_code), lang_code, country_code):\n            if pkg_resources.resource_exists(loader.module_name, text_js.format(lang_code=code)):\n                return text_js.format(lang_code=code)\n        return None\n\n    @XBlock.supports(\"multi_device\")  # Enable this block for use in the mobile app via webview\n    def student_view(self, context):\n        \"\"\"\n        Player view, displayed to the student\n        \"\"\"\n\n        fragment = Fragment()\n        fragment.add_content(loader.render_django_template('/templates/html/drag_and_drop.html',\n                                                           i18n_service=self.i18n_service))\n        css_urls = (\n            'public/css/drag_and_drop.css',\n        )\n        js_urls = [\n            'public/js/vendor/virtual-dom-1.3.0.min.js',\n            'public/js/drag_and_drop.js',\n        ]\n\n        statici18n_js_url = self._get_statici18n_js_url()\n        if statici18n_js_url:\n            js_urls.append(statici18n_js_url)\n\n        for css_url in css_urls:\n            fragment.add_css_url(self.runtime.local_resource_url(self, css_url))\n        for js_url in js_urls:\n            fragment.add_javascript_url(self.runtime.local_resource_url(self, js_url))\n\n        self.include_theme_files(fragment)\n\n        fragment.initialize_js('DragAndDropBlock', self.student_view_data())\n\n        return fragment\n\n    def student_view_data(self, context=None):\n        \"\"\"\n        Get the configuration data for the student_view.\n        The configuration is all the settings defined by the author, except for correct answers\n        and feedback.\n        \"\"\"\n\n        def items_without_answers():\n            \"\"\"\n            Removes feedback and answer from items\n            \"\"\"\n            items = copy.deepcopy(self.data.get('items', ''))\n            for item in items:\n                del item['feedback']\n                # Use item.pop to remove both `item['zone']` and `item['zones']`; we don't have\n                # a guarantee that either will be present, so we can't use `del`. Legacy instances\n                # will have `item['zone']`, while current versions will have `item['zones']`.\n                item.pop('zone', None)\n                item.pop('zones', None)\n                # Fall back on \"backgroundImage\" to be backward-compatible.\n                image_url = item.get('imageURL') or item.get('backgroundImage')\n                if image_url:\n                    item['expandedImageURL'] = self._expand_static_url(image_url)\n                else:\n                    item['expandedImageURL'] = ''\n            return items\n\n        return {\n            \"block_id\": six.text_type(self.scope_ids.usage_id),\n            \"display_name\": self.display_name,\n            \"type\": self.CATEGORY,\n            \"weight\": self.weight,\n            \"mode\": self.mode,\n            \"zones\": self.zones,\n            \"max_attempts\": self.max_attempts,\n            \"graded\": getattr(self, 'graded', False),\n            \"weighted_max_score\": self.max_score() * self.weight,\n            \"max_items_per_zone\": self.max_items_per_zone,\n            # SDK doesn't supply url_name.\n            \"url_name\": getattr(self, 'url_name', ''),\n            \"display_zone_labels\": self.data.get('displayLabels', False),\n            \"display_zone_borders\": self.data.get('displayBorders', False),\n            \"display_zone_borders_dragging\": self.data.get('displayBordersDragging', False),\n            \"items\": items_without_answers(),\n            \"title\": self.display_name,\n            \"show_title\": self.show_title,\n            \"problem_text\": self.question_text,\n            \"show_problem_header\": self.show_question_header,\n            \"target_img_expanded_url\": self.target_img_expanded_url,\n            \"target_img_description\": self.target_img_description,\n            \"item_background_color\": self.item_background_color or None,\n            \"item_text_color\": self.item_text_color or None,\n            \"has_deadline_passed\": self.has_submission_deadline_passed,\n            \"answer_available\": self.is_answer_available,\n            # final feedback (data.feedback.finish) is not included - it may give away answers.\n        }\n\n    def studio_view(self, context):\n        \"\"\"\n        Editing view in Studio\n        \"\"\"\n        js_templates = loader.load_unicode('/templates/html/js_templates.html')\n        # Get an 'id_suffix' string that is unique for this block.\n        # We append it to HTML element ID attributes to ensure multiple instances of the DnDv2 block\n        # on the same page don't share the same ID value.\n        # We avoid using ID attributes in preference to classes, but sometimes we still need IDs to\n        # connect 'for' and 'aria-describedby' attributes to the associated elements.\n        id_suffix = self._get_block_id()\n        js_templates = js_templates.replace('{{id_suffix}}', id_suffix)\n        context = {\n            'js_templates': js_templates,\n            'id_suffix': id_suffix,\n            'fields': self.fields,\n            'showanswer_set': self._field_data.has(self, 'showanswer'),  # If false, we're using an inherited value.\n            'self': self,\n            'data': six.moves.urllib.parse.quote(json.dumps(self.data)),\n        }\n\n        fragment = Fragment()\n        fragment.add_content(loader.render_django_template('/templates/html/drag_and_drop_edit.html',\n                                                           context=context,\n                                                           i18n_service=self.i18n_service))\n        css_urls = (\n            'public/css/drag_and_drop_edit.css',\n        )\n        js_urls = [\n            'public/js/vendor/handlebars-v1.1.2.js',\n            'public/js/drag_and_drop_edit.js',\n        ]\n\n        statici18n_js_url = self._get_statici18n_js_url()\n        if statici18n_js_url:\n            js_urls.append(statici18n_js_url)\n\n        for css_url in css_urls:\n            fragment.add_css_url(self.runtime.local_resource_url(self, css_url))\n        for js_url in js_urls:\n            fragment.add_javascript_url(self.runtime.local_resource_url(self, js_url))\n\n        # Do a bit of manipulation so we get the appearance of a list of zone options on\n        # items that still have just a single zone stored\n\n        items = self.data.get('items', [])\n\n        for item in items:\n            zones = self.get_item_zones(item['id'])\n            # Note that we appear to be mutating the state of the XBlock here, but because\n            # the change won't be committed, we're actually just affecting the data that\n            # we're going to send to the client, not what's saved in the backing store.\n            item['zones'] = zones\n            item.pop('zone', None)\n\n        fragment.initialize_js('DragAndDropEditBlock', {\n            'data': self.data,\n            'target_img_expanded_url': self.target_img_expanded_url,\n            'default_background_image_url': self.default_background_image_url,\n        })\n\n        return fragment\n\n    @XBlock.json_handler\n    def studio_submit(self, submissions, suffix=''):\n        \"\"\"\n        Handles studio save.\n        \"\"\"\n        self.display_name = submissions['display_name']\n        self.mode = submissions['mode']\n        self.max_attempts = submissions['max_attempts']\n        if (showanswer := submissions['showanswer']) != self.showanswer:\n            self.showanswer = showanswer\n        if showanswer == SHOWANSWER.DEFAULT:\n            del self.showanswer\n        self.show_title = submissions['show_title']\n        self.question_text = submissions['problem_text']\n        self.show_question_header = submissions['show_problem_header']\n        self.weight = float(submissions['weight'])\n        self.item_background_color = submissions['item_background_color']\n        self.item_text_color = submissions['item_text_color']\n        self.max_items_per_zone = self._get_max_items_per_zone(submissions)\n        self.data = submissions['data']\n\n        return {\n            'result': 'success',\n        }\n\n    def _get_block_id(self):\n        \"\"\"\n        Return unique ID of this block. Useful for HTML ID attributes.\n        Works both in LMS/Studio and workbench runtimes:\n        - In LMS/Studio, use the location.html_id method.\n        - In the workbench, use the usage_id.\n        \"\"\"\n        if hasattr(self, 'location'):\n            return self.location.html_id()  # pylint: disable=no-member\n        else:\n            return six.text_type(self.scope_ids.usage_id)\n\n    @staticmethod\n    def _get_max_items_per_zone(submissions):\n        \"\"\"\n        Parses Max items per zone value coming from editor.\n\n        Returns:\n            * None if invalid value is passed (i.e. not an integer)\n            * None if value is parsed into zero or negative integer\n            * Positive integer otherwise.\n\n        Examples:\n            * _get_max_items_per_zone(None) -> None\n            * _get_max_items_per_zone('string') -> None\n            * _get_max_items_per_zone('-1') -> None\n            * _get_max_items_per_zone(-1) -> None\n            * _get_max_items_per_zone('0') -> None\n            * _get_max_items_per_zone('') -> None\n            * _get_max_items_per_zone('42') -> 42\n            * _get_max_items_per_zone(42) -> 42\n        \"\"\"\n        raw_max_items_per_zone = submissions.get('max_items_per_zone', None)\n\n        # Entries that aren't numbers should be treated as null. We assume that if we can\n        # turn it into an int, a number was submitted.\n        try:\n            max_attempts = int(raw_max_items_per_zone)\n            if max_attempts > 0:\n                return max_attempts\n            else:\n                return None\n        except (ValueError, TypeError):\n            return None\n\n    @XBlock.json_handler\n    def drop_item(self, item_attempt, suffix=''):\n        \"\"\"\n        Handles dropping item into a zone.\n        \"\"\"\n        self._validate_drop_item(item_attempt)\n\n        if self.mode == Constants.ASSESSMENT_MODE:\n            return self._drop_item_assessment(item_attempt)\n        elif self.mode == Constants.STANDARD_MODE:\n            return self._drop_item_standard(item_attempt)\n        else:\n            raise JsonHandlerError(\n                500,\n                self.i18n_service.gettext(\"Unknown DnDv2 mode {mode} - course is misconfigured\").format(self.mode)\n            )\n\n    @XBlock.json_handler\n    def do_attempt(self, data, suffix=''):\n        \"\"\"\n        Checks submitted solution and returns feedback.\n\n        Raises:\n             * JsonHandlerError with 400 error code in standard mode.\n             * JsonHandlerError with 409 error code if no more attempts left\n        \"\"\"\n        self._validate_do_attempt()\n\n        self.attempts += 1\n        # pylint: disable=fixme\n        # TODO: Refactor this method to \"freeze\" item_state and pass it to methods that need access to it.\n        # These implicit dependencies between methods exist because most of them use `item_state` or other\n        # fields, either as an \"input\" (i.e. read value) or as output (i.e. set value) or both. As a result,\n        # incorrect order of invocation causes issues:\n        self._mark_complete_and_publish_grade()  # must happen before _get_feedback - sets grade\n        correct = self.is_correct  # must happen before manipulating item_state - reads item_state\n\n        overall_feedback_msgs, misplaced_ids = self._get_feedback(include_item_feedback=True)\n\n        misplaced_items = []\n        for item_id in misplaced_ids:\n            # Don't delete misplaced item states on the final attempt.\n            if self.attempts_remain:\n                del self.item_state[item_id]\n            misplaced_items.append(self._get_item_definition(int(item_id)))\n\n        feedback_msgs = [FeedbackMessage(item['feedback']['incorrect'], None) for item in misplaced_items]\n        return {\n            'correct': correct,\n            'attempts': self.attempts,\n            'grade': self._get_weighted_earned_if_set(),\n            'misplaced_items': list(misplaced_ids),\n            'feedback': self._present_feedback(feedback_msgs),\n            'overall_feedback': self._present_feedback(overall_feedback_msgs),\n            \"answer_available\": self.is_answer_available,\n        }\n\n    @XBlock.json_handler\n    def publish_event(self, data, suffix=''):\n        \"\"\"\n        Handler to publish XBlock event from frontend\n        \"\"\"\n        try:\n            event_type = data.pop('event_type')\n        except KeyError:\n            return {'result': 'error', 'message': 'Missing event_type in JSON data'}\n\n        self.runtime.publish(self, event_type, data)\n        return {'result': 'success'}\n\n    @XBlock.json_handler\n    def reset(self, data, suffix=''):\n        \"\"\"\n        Resets problem to initial state\n        \"\"\"\n        self.item_state = {}\n        return self._get_user_state()\n\n    @XBlock.json_handler\n    def show_answer(self, data, suffix=''):\n        \"\"\"\n        Returns correct answer in assessment mode.\n\n        Raises:\n             * JsonHandlerError with 400 error code in standard mode.\n             * JsonHandlerError with 409 error code if the answer is unavailable.\n        \"\"\"\n        if self.mode != Constants.ASSESSMENT_MODE:\n            raise JsonHandlerError(\n                400,\n                self.i18n_service.gettext(\"show_answer handler should only be called for assessment mode\")\n            )\n        if not self.is_answer_available:\n            raise JsonHandlerError(\n                409,\n                self.i18n_service.gettext(\"The answer is unavailable\")\n            )\n\n        answer = self._get_correct_state()\n\n        if explanation := self.data.get('explanation', '').strip():\n            if replace_urls_service := self.runtime.service(self, 'replace_urls'):\n                explanation = replace_urls_service.replace_urls(explanation)\n\n            # pylint: disable=fixme\n            # TODO: No longer needed after Maple.\n            else:\n                try:\n                    explanation = self.runtime.replace_urls(explanation)\n                    explanation = self.runtime.replace_course_urls(explanation)\n                    explanation = self.runtime.replace_jump_to_id_urls(explanation)\n                except (TypeError, AttributeError):\n                    logger.debug('Unable to perform URL substitution on the explanation: %s', explanation)\n\n            answer['explanation'] = explanation\n        return answer\n\n    @XBlock.json_handler\n    def expand_static_url(self, url, suffix=''):\n        \"\"\" AJAX-accessible handler for expanding URLs to static [image] files \"\"\"\n        return {'url': self._expand_static_url(url)}\n\n    @property\n    def i18n_service(self):\n        \"\"\" Obtains translation service \"\"\"\n        i18n_service = self.runtime.service(self, \"i18n\")\n        if i18n_service:\n            return i18n_service\n        else:\n            return DummyTranslationService()\n\n    @property\n    def target_img_expanded_url(self):\n        \"\"\" Get the expanded URL to the target image (the image items are dragged onto). \"\"\"\n        if self.data.get(\"targetImg\"):\n            return self._expand_static_url(self.data[\"targetImg\"])\n        else:\n            return self.default_background_image_url\n\n    @property\n    def target_img_description(self):\n        \"\"\" Get the description for the target image (the image items are dragged onto). \"\"\"\n        return self.data.get(\"targetImgDescription\", \"\")\n\n    @property\n    def default_background_image_url(self):\n        \"\"\" The URL to the default background image, shown when no custom background is used \"\"\"\n        return self.runtime.local_resource_url(self, \"public/img/triangle.png\")\n\n    @property\n    def attempts_remain(self):\n        \"\"\"\n        Checks if current student still have more attempts.\n        \"\"\"\n        return self.max_attempts is None or self.max_attempts == 0 or self.attempts < self.max_attempts\n\n    @property\n    def has_submission_deadline_passed(self):\n        \"\"\"\n        Returns a boolean indicating if the submission is past its deadline.\n\n        Using the `has_deadline_passed` method from InheritanceMixin which gets\n        added on the LMS/Studio, return if the submission is past its due date.\n        If the method not found, which happens for pure DragAndDropXblock,\n        return False which makes sure submission checks don't affect other\n        functionality.\n        \"\"\"\n        if hasattr(self, \"has_deadline_passed\"):\n            return self.has_deadline_passed()  # pylint: disable=no-member\n        else:\n            return False\n\n    @property\n    def closed(self):\n        \"\"\"\n        Is the student still allowed to submit answers?\n        \"\"\"\n        if not self.attempts_remain:\n            return True\n        if self.has_submission_deadline_passed:\n            return True\n\n        return False\n\n    @property\n    def is_attempted(self):\n        \"\"\"\n        Has the problem been attempted?\n        \"\"\"\n        return self.attempts > 0\n\n    @property\n    def is_finished(self):\n        \"\"\"\n        Returns True if answer is closed or answer is correct.\n        \"\"\"\n        return self.closed or self.is_correct\n\n    @property\n    def is_answer_available(self):\n        \"\"\"\n        Is student allowed to see an answer?\n        \"\"\"\n        permission_functions = {\n            SHOWANSWER.NEVER: lambda: False,\n            SHOWANSWER.ATTEMPTED: lambda: self.is_attempted or self.has_submission_deadline_passed,\n            SHOWANSWER.ANSWERED: lambda: self.is_correct,\n            SHOWANSWER.CLOSED: lambda: self.closed,\n            SHOWANSWER.FINISHED: lambda: self.is_finished,\n            SHOWANSWER.CORRECT_OR_PAST_DUE: lambda: self.is_correct or self.has_submission_deadline_passed,\n            SHOWANSWER.PAST_DUE: lambda: self.has_submission_deadline_passed,\n            SHOWANSWER.ALWAYS: lambda: True,\n            SHOWANSWER.AFTER_ALL_ATTEMPTS: lambda: not self.attempts_remain,\n            SHOWANSWER.AFTER_ALL_ATTEMPTS_OR_CORRECT: lambda: not self.attempts_remain or self.is_correct,\n            SHOWANSWER.ATTEMPTED_NO_PAST_DUE: lambda: self.is_attempted,\n        }\n\n        if self.mode != Constants.ASSESSMENT_MODE:\n            return False\n\n        user_is_staff = False\n        if user_service := self.runtime.service(self, 'user'):\n            user_is_staff = user_service.get_current_user().opt_attrs.get(Constants.ATTR_KEY_USER_IS_STAFF)\n\n        if self.showanswer not in [SHOWANSWER.NEVER, ''] and user_is_staff:\n            # Staff users can see the answer unless the problem explicitly prevents it.\n            return True\n\n        check_permissions_function = permission_functions.get(self.showanswer, lambda: False)\n        return check_permissions_function()\n\n    @XBlock.handler\n    def student_view_user_state(self, request, suffix=''):\n        \"\"\" GET all user-specific data, and any applicable feedback \"\"\"\n        data = self._get_user_state()\n        return webob.Response(body=json.dumps(data).encode('utf-8'), content_type='application/json')\n\n    def _validate_do_attempt(self):\n        \"\"\"\n        Validates if `do_attempt` handler should be executed\n        \"\"\"\n        if self.mode != Constants.ASSESSMENT_MODE:\n            raise JsonHandlerError(\n                400,\n                self.i18n_service.gettext(\"do_attempt handler should only be called for assessment mode\")\n            )\n        if not self.attempts_remain:\n            raise JsonHandlerError(\n                409,\n                self.i18n_service.gettext(\"Max number of attempts reached\")\n            )\n        if self.has_submission_deadline_passed:\n            raise JsonHandlerError(\n                409,\n                self.i18n_service.gettext(\"Submission deadline has passed.\")\n            )\n\n    def _get_feedback(self, include_item_feedback=False):\n        \"\"\"\n        Builds overall feedback for both standard and assessment modes\n        \"\"\"\n        answer_correctness = self._answer_correctness()\n\n        if self.mode == Constants.STANDARD_MODE or not self.attempts:\n            if answer_correctness == self.SOLUTION_CORRECT:\n                feedback_key = 'finish'\n                message_class = FeedbackMessages.MessageClasses.FINAL_FEEDBACK\n            else:\n                feedback_key = 'start'\n                message_class = FeedbackMessages.MessageClasses.INITIAL_FEEDBACK\n            return [FeedbackMessage(self.data['feedback'][feedback_key], message_class)], set()\n\n        items = self._get_item_raw_stats()\n        missing_ids = items.required - items.placed\n        misplaced_ids = items.placed - items.correctly_placed\n\n        feedback_msgs = []\n\n        def _add_msg_if_exists(ids_list, message_template, message_class):\n            \"\"\" Adds message to feedback messages if corresponding items list is not empty \"\"\"\n            if ids_list:\n                message = message_template(len(ids_list), self.i18n_service.ngettext)\n                feedback_msgs.append(FeedbackMessage(message, message_class))\n\n        if self.item_state or include_item_feedback:\n            _add_msg_if_exists(\n                items.correctly_placed,\n                FeedbackMessages.correctly_placed,\n                FeedbackMessages.MessageClasses.CORRECTLY_PLACED\n            )\n\n            # Misplaced items are not returned to the bank on the final attempt.\n            if self.attempts_remain:\n                misplaced_template = FeedbackMessages.misplaced_returned\n            else:\n                misplaced_template = FeedbackMessages.misplaced\n\n            _add_msg_if_exists(misplaced_ids, misplaced_template, FeedbackMessages.MessageClasses.MISPLACED)\n            _add_msg_if_exists(missing_ids, FeedbackMessages.not_placed, FeedbackMessages.MessageClasses.NOT_PLACED)\n\n        grade_feedback_class = self.GRADE_FEEDBACK_CLASSES.get(answer_correctness, None)\n\n        if self.weight > 0:\n            if self.attempts_remain:\n                grade_feedback_template = FeedbackMessages.GRADE_FEEDBACK_TPL\n            else:\n                grade_feedback_template = FeedbackMessages.FINAL_ATTEMPT_TPL\n\n            feedback_msgs.append(FeedbackMessage(\n                self.i18n_service.gettext(grade_feedback_template).format(score=self.weighted_grade()),\n                grade_feedback_class)\n            )\n\n        problem_feedback_class = None\n\n        if self.attempts_remain and (misplaced_ids or missing_ids):\n            problem_feedback_message = self.data['feedback']['start']\n            problem_feedback_class = FeedbackMessages.MessageClasses.INITIAL_FEEDBACK\n        else:\n            problem_feedback_message = self.data['feedback']['finish']\n            problem_feedback_class = FeedbackMessages.MessageClasses.FINAL_FEEDBACK\n\n        feedback_msgs.append(FeedbackMessage(problem_feedback_message, problem_feedback_class))\n\n        return feedback_msgs, misplaced_ids\n\n    @staticmethod\n    def _present_feedback(feedback_messages):\n        \"\"\"\n        Transforms feedback messages into format expected by frontend code\n        \"\"\"\n        return [\n            {\"message\": msg.message, \"message_class\": msg.message_class}\n            for msg in feedback_messages\n            if msg.message\n        ]\n\n    def _drop_item_standard(self, item_attempt):\n        \"\"\"\n        Handles dropping item to a zone in standard mode.\n        \"\"\"\n        item = self._get_item_definition(item_attempt['val'])\n\n        is_correct = self._is_attempt_correct(item_attempt)  # Student placed item in a correct zone\n        if is_correct:  # In standard mode state is only updated when attempt is correct\n            self.item_state[str(item['id'])] = self._make_state_from_attempt(item_attempt, is_correct)\n\n        self._mark_complete_and_publish_grade()  # must happen before _get_feedback\n        self._publish_item_dropped_event(item_attempt, is_correct)\n\n        item_feedback_key = 'correct' if is_correct else 'incorrect'\n        item_feedback = FeedbackMessage(self._expand_static_url(item['feedback'][item_feedback_key]), None)\n        overall_feedback, __ = self._get_feedback()\n\n        return {\n            'correct': is_correct,\n            'grade': self._get_weighted_earned_if_set(),\n            'finished': self.is_correct,\n            'overall_feedback': self._present_feedback(overall_feedback),\n            'feedback': self._present_feedback([item_feedback])\n        }\n\n    def _drop_item_assessment(self, item_attempt):\n        \"\"\"\n        Handles dropping item into a zone in assessment mode\n        \"\"\"\n        if not self.attempts_remain:\n            raise JsonHandlerError(409, self.i18n_service.gettext(\"Max number of attempts reached\"))\n\n        item = self._get_item_definition(item_attempt['val'])\n        is_correct = self._is_attempt_correct(item_attempt)\n        if item_attempt['zone'] is None:\n            self.item_state.pop(str(item['id']), None)\n            self._publish_item_to_bank_event(item['id'], is_correct)\n        else:\n            # State is always updated in assessment mode to store intermediate item positions\n            self.item_state[str(item['id'])] = self._make_state_from_attempt(item_attempt, is_correct)\n            self._publish_item_dropped_event(item_attempt, is_correct)\n\n        return {}\n\n    def _validate_drop_item(self, item):\n        \"\"\"\n        Validates `drop_item` parameters. Assessment mode allows returning\n        items to the bank, so validation is unnecessary.\n        \"\"\"\n        if self.mode != Constants.ASSESSMENT_MODE:\n            zone = self._get_zone_by_uid(item['zone'])\n            if not zone:\n                raise JsonHandlerError(400, \"Item zone data invalid.\")\n\n    @staticmethod\n    def _make_state_from_attempt(attempt, correct):\n        \"\"\"\n        Converts \"attempt\" data coming from browser into \"state\" entry stored in item_state\n        \"\"\"\n        return {\n            'zone': attempt['zone'],\n            'correct': correct\n        }\n\n    def _mark_complete_and_publish_grade(self):\n        \"\"\"\n        Helper method to update `self.completed` and submit grade event if appropriate conditions met.\n        \"\"\"\n        # pylint: disable=fixme\n        # TODO: (arguable) split this method into \"clean\" functions (with no side effects and implicit state)\n        # This method implicitly depends on self.item_state (via is_correct and _learner_raw_score)\n        # and also updates self.raw_earned if some conditions are met. As a result this method implies some order of\n        # invocation:\n        # * it should be called after learner-caused updates to self.item_state is applied\n        # * it should be called before self.item_state cleanup is applied (i.e. returning misplaced items to item bank)\n        # * it should be called before any method that depends on self.raw_earned (i.e. self._get_feedback)\n\n        # Splitting it into a \"clean\" functions will allow to capture this implicit invocation order in caller method\n        # and help avoid bugs caused by invocation order violation in future.\n\n        # There's no going back from \"completed\" status to \"incomplete\"\n        self.completed = self.completed or self.is_correct or not self.attempts_remain\n\n        current_raw_earned = self._learner_raw_score()\n        # ... and from higher grade to lower\n        # if we have an old-style (i.e. unreliable) grade, override no matter what\n        saved_raw_earned = self._get_raw_earned_if_set()\n\n        current_raw_earned_is_greater = False\n        if current_raw_earned is None or saved_raw_earned is None:\n            current_raw_earned_is_greater = True\n\n        if current_raw_earned is not None and saved_raw_earned is not None and current_raw_earned > saved_raw_earned:\n            current_raw_earned_is_greater = True\n\n        if current_raw_earned is None or current_raw_earned_is_greater:\n            self.set_score(Score(current_raw_earned, self.max_score()))\n            self.publish_grade(self.score)\n\n        # and no matter what - emit progress event for current user\n        self.runtime.publish(self, \"progress\", {})\n\n    def _publish_item_dropped_event(self, attempt, is_correct):\n        \"\"\"\n        Publishes item dropped event.\n        \"\"\"\n        item = self._get_item_definition(attempt['val'])\n        # attempt should already be validated here - not doing the check for existing zone again\n        zone = self._get_zone_by_uid(attempt['zone'])\n\n        item_label = item.get(\"displayName\")\n        if not item_label:\n            item_label = item.get(\"imageURL\")\n\n        self.runtime.publish(self, 'edx.drag_and_drop_v2.item.dropped', {\n            'item': item_label,\n            'item_id': item['id'],\n            'location': zone.get(\"title\"),\n            'location_id': zone.get(\"uid\"),\n            'is_correct': is_correct,\n        })\n\n    def _publish_item_to_bank_event(self, item_id, is_correct):\n        \"\"\"\n        Publishes event when item moved back to the bank in assessment mode.\n        \"\"\"\n        item = self._get_item_definition(item_id)\n\n        item_label = item.get(\"displayName\")\n        if not item_label:\n            item_label = item.get(\"imageURL\")\n\n        self.runtime.publish(self, 'edx.drag_and_drop_v2.item.dropped', {\n            'item': item_label,\n            'item_id': item['id'],\n            'location': 'item bank',\n            'location_id': -1,\n            'is_correct': is_correct,\n        })\n\n    def publish_grade(self, score=None, only_if_higher=None):\n        \"\"\"\n        Publishes the student's current grade to the system as an event\n        \"\"\"\n        if not score:\n            score = self.score\n        self._publish_grade(score, only_if_higher)\n        return {'grade': self.score.raw_earned, 'max_grade': self.score.raw_possible}\n\n    def _is_attempt_correct(self, attempt):\n        \"\"\"\n        Check if the item was placed correctly.\n        \"\"\"\n        correct_zones = self.get_item_zones(attempt['val'])\n        if correct_zones == [] and attempt['zone'] is None and self.mode == Constants.ASSESSMENT_MODE:\n            return True\n        return attempt['zone'] in correct_zones\n\n    def _expand_static_url(self, url):\n        \"\"\"\n        This is required to make URLs like '/static/dnd-test-image.png' work (note: that is the\n        only portable URL format for static files that works across export/import and reruns).\n        This method is unfortunately a bit hackish since XBlock does not provide a low-level API\n        for this.\n        \"\"\"\n        if hasattr(self.runtime, 'replace_urls'):\n            url = self.runtime.replace_urls(u'\"{}\"'.format(url))[1:-1]\n        elif hasattr(self.runtime, 'course_id'):\n            # edX Studio uses a different runtime for 'studio_view' than 'student_view',\n            # and the 'studio_view' runtime doesn't provide the replace_urls API.\n            try:\n                from common.djangoapps.static_replace import replace_static_urls  # pylint: disable=import-error\n                url = replace_static_urls(u'\"{}\"'.format(url), None, course_id=self.runtime.course_id)[1:-1]\n            except ImportError:\n                pass\n        return url\n\n    def _get_user_state(self):\n        \"\"\" Get all user-specific data, and any applicable feedback \"\"\"\n        item_state = self._get_item_state()\n        # In assessment mode, we do not want to leak the correctness info for individual items to the frontend,\n        # so we remove \"correct\" from all items when in assessment mode.\n        if self.mode == Constants.ASSESSMENT_MODE:\n            for item in item_state.values():\n                del item[\"correct\"]\n\n        overall_feedback_msgs, __ = self._get_feedback()\n        if self.mode == Constants.STANDARD_MODE:\n            is_finished = self.is_correct\n        else:\n            is_finished = not self.attempts_remain\n\n        return {\n            'items': item_state,\n            'finished': is_finished,\n            'attempts': self.attempts,\n            'grade': self._get_weighted_earned_if_set(),\n            'overall_feedback': self._present_feedback(overall_feedback_msgs)\n        }\n\n    def _get_correct_state(self):\n        \"\"\"\n        Returns one of the possible correct states for the configured data.\n\n        Items dropped by user in the correct zones are retained in those zones.\n        Incorrect items are equally distributed among their correct zones (if more than one zone is correct).\n        \"\"\"\n        state = {}\n        items = copy.deepcopy(self.data.get('items', []))\n\n        zone_count = Counter()\n        correct_items = set()\n\n        def _get_preferred_zone(zone_count, zones):\n            \"\"\"\n            Returns the zone with the least number of items.\n            \"\"\"\n            preferred_zone = None\n            for zone in zones:\n                # Check if the current zone has the least number of items till now\n                if not preferred_zone or zone_count[preferred_zone] > zone_count[zone]:\n                    preferred_zone = zone\n\n            zone_count[preferred_zone] += 1\n            return preferred_zone\n\n        # Set states of all items dropped in correct zones\n        for item_id in self.item_state:\n            if self.item_state[item_id]['correct']:\n                state[item_id] = self.item_state[item_id]\n                correct_items.add(item_id)\n\n                zone = self.item_state[item_id]['zone']\n                zone_count[zone] += 1\n\n        # Set states of rest of the items\n        for item in items:\n            item_id = str(item['id'])\n            if item_id not in correct_items:\n                zones = item.get('zones')\n\n                # For backwards compatibility\n                if zones is None:\n                    zones = []\n                    zone = item.get('zone')\n                    if zone is not None and zone != 'none':\n                        zones.append(zone)\n\n                if zones:\n                    zone = _get_preferred_zone(zone_count, zones)\n                    state[item_id] = {\n                        'zone': zone,\n                        'correct': True,\n                    }\n\n        return {'items': state}\n\n    def _get_item_state(self):\n        \"\"\"\n        Returns a copy of the user item state.\n        Converts to a dict if data is stored in legacy tuple form.\n        \"\"\"\n\n        # IMPORTANT: this method should always return a COPY of self.item_state - it is called from\n        # student_view_user_state handler and the data it returns is manipulated there to hide\n        # correctness of items placed.\n        state = {}\n        migrator = StateMigration(self)\n\n        for item_id, item in six.iteritems(self.item_state):\n            state[item_id] = migrator.apply_item_state_migrations(item_id, item)\n\n        return state\n\n    def _get_item_definition(self, item_id):\n        \"\"\"\n        Returns definition (settings) for item identified by `item_id`.\n        \"\"\"\n        return next(i for i in self.data['items'] if i['id'] == item_id)\n\n    def get_item_zones(self, item_id):\n        \"\"\"\n        Returns a list of the zones that are valid options for the item.\n\n        If the item is configured with a list of zones, return that list. If\n        the item is configured with a single zone, encapsulate that zone's\n        ID in a list and return the list. If the item is not configured with\n        any zones, or if it's configured explicitly with no zones, return an\n        empty list.\n        \"\"\"\n        item = self._get_item_definition(item_id)\n        if item.get('zones') is not None:\n            return item.get('zones')\n        elif item.get('zone') is not None and item.get('zone') != 'none':\n            return [item.get('zone')]\n        else:\n            return []\n\n    @property\n    def zones(self):\n        \"\"\"\n        Get drop zone data, defined by the author.\n        \"\"\"\n        # Convert zone data from old to new format if necessary\n        migrator = StateMigration(self)\n        return [migrator.apply_zone_migrations(zone) for zone in self.data.get('zones', [])]\n\n    def _get_zone_by_uid(self, uid):\n        \"\"\"\n        Given a zone UID, return that zone, or None.\n        \"\"\"\n        for zone in self.zones:\n            if zone[\"uid\"] == uid:\n                return zone\n        return None\n\n    def _get_item_stats(self):\n        \"\"\"\n        Returns a tuple representing the number of correctly placed items,\n        and the total number of items required (including decoy items).\n        \"\"\"\n        items = self._get_item_raw_stats()\n\n        correct_count = len(items.correctly_placed)\n        total_count = len(items.required)\n\n        if hasattr(self.runtime, 'course_id') and \\\n                get_grading_ignore_decoys_waffle_flag().is_enabled(self.runtime.course_id):\n            return correct_count, total_count\n\n        correct_count += len(items.decoy_in_bank)\n        total_count += len(items.decoy)\n\n        return correct_count, total_count\n\n    def _get_item_raw_stats(self):\n        \"\"\"\n        Returns a named tuple containing required, decoy, placed, correctly\n        placed, and correctly unplaced decoy items.\n\n        Returns:\n            namedtuple: (required, placed, correctly_placed, decoy, decoy_in_bank)\n                * required - IDs of items that must be placed on the board\n                * placed - IDs of items actually placed on the board\n                * correctly_placed - IDs of items that were placed correctly\n                * decoy - IDs of decoy items\n                * decoy_in_bank - IDs of decoy items that were unplaced\n        \"\"\"\n        item_state = self._get_item_state()\n\n        all_items = set(str(item['id']) for item in self.data['items'])\n        required = set(item_id for item_id in all_items if self.get_item_zones(int(item_id)) != [])\n        placed = set(item_id for item_id in all_items if item_id in item_state)\n        correctly_placed = set(item_id for item_id in placed if item_state[item_id]['correct'])\n        decoy = all_items - required\n        decoy_in_bank = set(item_id for item_id in decoy if item_id not in item_state)\n\n        return ItemStats(required, placed, correctly_placed, decoy, decoy_in_bank)\n\n    def _get_raw_earned_if_set(self):\n        \"\"\"\n        Returns student's grade if already explicitly set, otherwise returns None.\n        This is different from self.raw_earned which returns 0 by default.\n        \"\"\"\n        if self.fields['raw_earned'].is_set_on(self):\n            return self.raw_earned\n        else:\n            return None\n\n    def _get_weighted_earned_if_set(self):\n        \"\"\"\n        Returns student's grade with the problem weight applied if set, otherwise\n        None.\n        \"\"\"\n        if self.fields['raw_earned'].is_set_on(self):\n            return self.weighted_grade()\n        else:\n            return None\n\n    def _answer_correctness(self):\n        \"\"\"\n        Checks answer correctness:\n\n        Returns:\n            string: Correct/Incorrect/Partial\n                * Correct: All items are at their correct place.\n                * Partial: Some items are at their correct place.\n                * Incorrect: None items are at their correct place.\n        \"\"\"\n        correct_count, total_count = self._get_item_stats()\n        if correct_count == total_count:\n            return self.SOLUTION_CORRECT\n        elif correct_count == 0:\n            return self.SOLUTION_INCORRECT\n        else:\n            return self.SOLUTION_PARTIAL\n\n    @property\n    def is_correct(self):\n        \"\"\"\n        Helper - checks if answer is correct\n\n        Returns:\n            bool: True if current answer is correct\n        \"\"\"\n        return self._answer_correctness() == self.SOLUTION_CORRECT\n\n    @staticmethod\n    def workbench_scenarios():\n        \"\"\"\n        A canned scenario for display in the workbench.\n        \"\"\"\n        return [\n            (\n                \"Drag-and-drop-v2 standard\",\n                \"<vertical_demo><drag-and-drop-v2/></vertical_demo>\"\n            ),\n            (\n                \"Drag-and-drop-v2 assessment\",\n                \"<vertical_demo><drag-and-drop-v2 mode='assessment' max_attempts='3'/></vertical_demo>\"\n            ),\n        ]\n\n    def index_dictionary(self):\n        \"\"\"\n        Return dictionary prepared with module content and type for indexing.\n        \"\"\"\n        # return key/value fields in a Python dict object\n        # values may be numeric / string or dict\n        # default implementation is an empty dict\n\n        xblock_body = super(DragAndDropBlock, self).index_dictionary()\n\n        zones_display_names = {\n            \"zone_{}_display_name\".format(zone_i):\n                _clean_data(zone.get(\"title\", \"\"))\n            for zone_i, zone in enumerate(self.data.get(\"zones\", []))\n        }\n\n        zones_description = {\n            \"zone_{}_description\".format(zone_i):\n                _clean_data(zone.get(\"description\", \"\"))\n            for zone_i, zone in enumerate(self.data.get(\"zones\", []))\n        }\n\n        items_display_names = {\n            \"item_{}_display_name\".format(item_i):\n                _clean_data(item.get(\"displayName\", \"\"))\n            for item_i, item in enumerate(self.data.get(\"items\", []))\n        }\n\n        items_image_description = {\n            \"item_{}_image_description\".format(item_i):\n                _clean_data(item.get(\"imageDescription\", \"\"))\n            for item_i, item in enumerate(self.data.get(\"items\", []))\n        }\n\n        index_body = {\n            \"display_name\": self.display_name,\n            \"question_text\": _clean_data(self.question_text),\n            \"background_image_description\": self.data.get(\"targetImgDescription\", \"\"),\n        }\n        index_body.update(items_display_names)\n        index_body.update(items_image_description)\n        index_body.update(zones_display_names)\n        index_body.update(zones_description)\n\n        if \"content\" in xblock_body:\n            xblock_body[\"content\"].update(index_body)\n        else:\n            xblock_body[\"content\"] = index_body\n\n        xblock_body[\"content_type\"] = \"Drag and Drop\"\n\n        return xblock_body\n", "function DragAndDropEditBlock(runtime, element, params) {\n\n    var gettext;\n    var ngettext;\n    if ('DragAndDropI18N' in window) {\n        // Use DnDv2's local translations\n        gettext = function(string) {\n            var translated = window.DragAndDropI18N.gettext(string);\n            // if DnDv2's translation is the same as the input, check if global has a different value\n            // This is useful for overriding the XBlock's string by themes (only for English)\n            if (string === translated && 'gettext' in window) {\n                translated = window.gettext(string);\n            }\n            return translated;\n        };\n        ngettext = function(strA, strB, n) {\n            var translated = window.DragAndDropI18N.ngettext(strA, strB, n);\n            var string = n === 1 ? strA : strB;\n            if (string === translated && 'ngettext' in window) {\n                translated = window.ngettext(strA, strB, n);\n            }\n            return translated;\n        };\n    } else if ('gettext' in window) {\n        // Use edxapp's global translations\n        gettext = window.gettext;\n    }\n    if (typeof gettext == \"undefined\") {\n        // No translations -- used by test environment\n        gettext = function(string) { return string; };\n    }\n\n    if (typeof ngettext == \"undefined\") {\n        // No translations -- used by test environment\n        ngettext = function(string, plural, num) { return num == 1 ? string : plural; };\n    }\n\n    // Make gettext available in Handlebars templates\n    Handlebars.registerHelper('i18n', gettext);\n    // Numeric rounding in Handlebars templates\n    Handlebars.registerHelper('singleDecimalFloat', function(value) {\n        if (value === \"\" || isNaN(Number(value))) {\n            return \"\";\n        }\n        return Number(value).toFixed(Number(value) == parseInt(value) ? 0 : 1);\n    });\n    Handlebars.registerHelper('ifeq', function(v1, v2, options) {\n      if (v1 === v2) {\n        return options.fn(this);\n      }\n      return options.inverse(this);\n    });\n\n    var $element = $(element);\n\n    var dragAndDrop = (function($) {\n        var _fn = {\n            // Templates\n            tpl: {\n                init: function() {\n                    _fn.tpl = {\n                        zoneInput: Handlebars.compile($(\".zone-input-tpl\", element).html()),\n                        zoneElement: Handlebars.compile($(\".zone-element-tpl\", element).html()),\n                        zoneCheckbox: Handlebars.compile($(\".zone-checkbox-tpl\", element).html()),\n                        itemInput: Handlebars.compile($(\".item-input-tpl\", element).html()),\n                        autozoneSvg: Handlebars.compile($(\".autozone-tpl\", element).html())\n                    };\n                }\n            },\n\n            build: {\n                $el: {\n                    feedback: {\n                        form: $('.drag-builder .feedback-form', element),\n                        tab: $('.drag-builder .feedback-tab', element)\n                    },\n                    zones: {\n                        form: $('.drag-builder .zones-form', element),\n                        tab: $('.drag-builder .zones-tab', element)\n                    },\n                    items: {\n                        form: $('.drag-builder .items-form', element),\n                        tab: $('.drag-builder .items-tab', element)\n                    },\n                    targetImage: $('.drag-builder .target .target-img', element),\n                    zonesPreview: $('.drag-builder .target .zones-preview', element),\n                },\n                init: function() {\n                    _fn.data = params.data;\n\n                    // Compile templates\n                    _fn.tpl.init();\n\n                    // Display target image\n                    _fn.build.$el.targetImage.show();\n\n                    _fn.build.clickHandlers();\n\n                    // Hide settings that are specific to assessment mode\n                    _fn.build.$el.feedback.form.find('.problem-mode').trigger('change');\n\n                    // Check whether we're using an autogenerated image and fill related input values accordingly.\n                    _fn.build.initAutozoneInputs();\n\n                    // Set focus on first input field.\n                    $element.find('input:first').select();\n                },\n\n                validate: function() {\n                    var fields = $element.find('.tab').not('.hidden').find('input, textarea');\n                    var success = true;\n                    fields.each(function(index, field) {\n                        field = $(field);\n                        // Right now our only check is if a field is set or not.\n                        field.removeClass('field-error');\n                        if (! field[0].checkValidity()) {\n                            field.addClass('field-error');\n                            success = false;\n                        }\n                    });\n                    if (! success) {\n                        runtime.notify('error', {\n                            'title': gettext(\"There was an error with your form.\"),\n                            'message': gettext(\"Please check over your submission.\")\n                        });\n                    }\n                    return success\n                },\n\n                initAutozoneInputs: function() {\n                    var image_params = _fn.build.parseDataUriParams(params.target_img_expanded_url);\n                    var image_type = image_params.producer === 'dndv2' ? 'auto' : 'manual';\n                    var zone_tab = _fn.build.$el.zones.tab;\n                    var radio_selector = '.background-image-type input[value=' + image_type + ']';\n                    zone_tab.find(radio_selector).prop('checked', true).trigger('change');\n                    zone_tab.find('.autozone-layout-cols').val(image_params.cols || 3);\n                    zone_tab.find('.autozone-layout-rows').val(image_params.rows || 1);\n                    zone_tab.find('.autozone-size-width').val(image_params.zone_width || 200);\n                    zone_tab.find('.autozone-size-height').val(image_params.zone_height || 200);\n                },\n\n                // Examine the image src to determine whether the background image has been auto generated.\n                isAutogeneratedImage: function(src) {\n                    if (src && src.match(/^data:image\\/svg\\+xml/)) {\n                        if (_fn.build.parseDataUriParams(src).producer === 'dndv2') {\n                            return true;\n                        }\n                    }\n                    return false;\n                },\n\n                // When we auto generate a background image, we embed some parameters such as zone size and position\n                // into the generated data URI.\n                encodeDataUriParams: function(params) {\n                    var encoded = [];\n                    Object.keys(params).forEach(function(key) {\n                        var json = JSON.stringify(params[key]);\n                        encoded.push(encodeURIComponent(key) + '=' + encodeURIComponent(json));\n                    });\n                    return encoded.join(';');\n                },\n\n                parseDataUriParams: function(data_uri) {\n                    var params = {};\n                    var match = data_uri.match(/^data:image\\/svg\\+xml;([^,]+),/);\n                    if (match) {\n                        match[1].split(';').forEach(function(str) {\n                            var pair = str.split('=');\n                            if (pair.length === 2) {\n                                params[decodeURIComponent(pair[0])] = JSON.parse(decodeURIComponent(pair[1]));\n                            }\n                        });\n                    }\n                    return params;\n                },\n\n                scrollToTop: function() {\n                    $('.drag-builder', element).scrollTop(0);\n                },\n\n                clickHandlers: function() {\n                    var $fbkTab = _fn.build.$el.feedback.tab,\n                        $zoneTab = _fn.build.$el.zones.tab,\n                        $itemTab = _fn.build.$el.items.tab;\n\n                    var self = this;\n\n                    $element.one('click', '.continue-button', function loadSecondTab(e) {\n                        // $fbkTab -> $zoneTab\n\n                        e.preventDefault();\n\n                        if (!self.validate()) {\n                            $(e.target).one('click', loadSecondTab);\n                            return\n                        }\n\n                        _fn.build.form.feedback(_fn.build.$el.feedback.form);\n                        for (var i = 0; i < _fn.data.zones.length; i++) {\n                            _fn.build.form.zone.add(_fn.data.zones[i]);\n                        }\n                        if (_fn.data.zones.length === 0) {\n                            _fn.build.form.zone.add();\n                        }\n\n                        // Set the target image and bind its event handler:\n                        if (!_fn.build.isAutogeneratedImage(_fn.data.targetImg)) {\n                            $('.target-image-form .background-url', element).val(_fn.data.targetImg);\n                        }\n                        $('.target-image-form .background-description', element).val(_fn.data.targetImgDescription);\n                        _fn.build.$el.targetImage.load(_fn.build.form.zone.imageLoaded);\n                        _fn.build.$el.targetImage.attr('src', params.target_img_expanded_url);\n                        _fn.build.$el.targetImage.attr('alt', _fn.data.targetImgDescription);\n\n                        if (_fn.data.displayLabels) {\n                            $('.display-labels-form input', element).prop('checked', true);\n                        }\n\n                        if (_fn.data.displayBorders) {\n                            $('.display-borders-form input', element).prop('checked', true);\n                        }\n\n                        if (_fn.data.displayBordersDragging) {\n                            $('.display-borders-dragging-form input', element).prop('checked', true);\n                        }\n\n                        $fbkTab.addClass('hidden');\n                        $zoneTab.removeClass('hidden');\n                        self.scrollToTop();\n                        $zoneTab.find('input:first').select();\n\n                        $(this).one('click', function loadThirdTab(e) {\n                            // $zoneTab -> $itemTab\n                            e.preventDefault();\n\n                            if (!self.validate()) {\n                                $(e.target).one('click', loadThirdTab);\n                                return\n                            }\n\n                            for (var i = 0; i < _fn.data.items.length; i++) {\n                                _fn.build.form.item.add(_fn.data.items[i]);\n                            }\n                            if (_fn.data.items.length === 0) {\n                                _fn.build.form.item.add();\n                            }\n\n                            $zoneTab.addClass('hidden');\n                            $itemTab.removeClass('hidden');\n                            self.scrollToTop();\n                            $itemTab.find('input:first').select();\n\n                            $(this).addClass('hidden');\n                            $('.save-button', element).parent()\n                                .removeClass('hidden')\n                                .on('click', function submitForm(e) {\n                                    // $itemTab -> submit\n\n                                    e.preventDefault();\n                                    _fn.build.form.submit();\n                                });\n                        });\n                    });\n\n                    $fbkTab\n                        .on('change', '.problem-mode', _fn.build.form.problem.toggleAssessmentSettings);\n\n                    $fbkTab.on('change', '.showanswer', function () {\n                        _fn.build.$el.feedback.form.find('.showanswer-inherited').hide();\n                    });\n\n                    $zoneTab\n                        .on('change', '.background-image-type input', _fn.build.form.zone.toggleAutozoneSettings)\n                        .on('click', '.add-zone', function(e) {\n                            _fn.build.form.zone.add();\n                            // Set focus to first field of the new zone.\n                            $('.zones-form .zone-row:last input[type=text]:first', element).select();\n                        })\n                        .on('click', '.remove-zone', _fn.build.form.zone.remove)\n                        .on('input', '.zone-row input', _fn.build.form.zone.changedInputHandler)\n                        .on('change', '.zone-align-select', _fn.build.form.zone.changedInputHandler)\n                        .on('click', '.target-image-form .background-manual button', function(e) {\n                            var new_img_url = $.trim($('.target-image-form .background-url', element).val());\n                            if (new_img_url) {\n                                // We may need to 'expand' the URL before it will be valid.\n                                // e.g. '/static/blah.png' becomes '/asset-v1:course+id/blah.png'\n                                var handlerUrl = runtime.handlerUrl(element, 'expand_static_url');\n                                $.post(handlerUrl, JSON.stringify(new_img_url), function(result) {\n                                    _fn.build.$el.targetImage.attr('src', result.url);\n                                });\n                            } else {\n                                new_img_url = params.default_background_image_url;\n                                _fn.build.$el.targetImage.attr('src', new_img_url);\n                            }\n                            _fn.data.targetImg = new_img_url;\n                        })\n                        .on(\n                            'click',\n                            '.target-image-form .background-auto button',\n                            _fn.build.form.zone.generateBackgroundAndZones\n                        )\n                        .on('input', '.target-image-form .background-description', function(e) {\n                            var new_description = $.trim(\n                                $('.target-image-form .background-description', element).val()\n                            );\n                            _fn.build.$el.targetImage.attr('alt', new_description);\n                            _fn.data.targetImgDescription = new_description;\n                        })\n                        .on('click', '.display-labels-form input', function(e) {\n                            _fn.data.displayLabels = $('.display-labels-form input', element).is(':checked');\n                        })\n                        .on('click', '.display-borders-form input', function(e) {\n                            _fn.data.displayBorders = $('.display-borders-form input', element).is(':checked');\n                        })\n                        .on('click', '.display-borders-dragging-form input', function(e) {\n                            _fn.data.displayBordersDragging = $('.display-borders-dragging-form input', element).is(':checked');\n                        });\n\n                    $itemTab\n                        .on('click', '.add-item', function(e) {\n                            _fn.build.form.item.add();\n                            // Set focus to first field of the new item.\n                            $('.items-form .item:last input[type=text]:first', element).select();\n                        })\n                        .on('click', '.remove-item', _fn.build.form.item.remove)\n                        .on('click', '.advanced-link button', _fn.build.form.item.showAdvancedSettings)\n                        .on('input', '.item-image-url', _fn.build.form.item.imageURLChanged);\n                },\n                form: {\n                    problem: {\n                        toggleAssessmentSettings: function(e) {\n                            e.preventDefault();\n                            var $modeSetting = $(e.currentTarget),\n                                $problemForm = $modeSetting.closest('form'),\n                                $assessmentSettings = $problemForm.find('.assessment-setting');\n                            if ($modeSetting.val() === 'assessment') {\n                                $assessmentSettings.show();\n                            } else {\n                                $assessmentSettings.hide();\n                            }\n                        }\n                    },\n                    zone: {\n                        totalZonesCreated: 0, // This counter is used for HTML IDs. Never decremented.\n                        zoneObjects: [],\n                        toggleAutozoneSettings: function(e) {\n                            var element = _fn.build.$el.zones.tab;\n                            var value = element.find('.background-image-type input:checked').val();\n                            if (value === 'manual') {\n                                element.find('.background-manual').show();\n                                element.find('.background-auto').hide();\n                            } else {\n                                element.find('.background-auto').show();\n                                element.find('.background-manual').hide();\n                            }\n                        },\n                        getZoneObjByUID: function(uid) {\n                            for (var i = 0; i < _fn.build.form.zone.zoneObjects.length; i++) {\n                                if (_fn.build.form.zone.zoneObjects[i].uid == uid) {\n                                    return _fn.build.form.zone.zoneObjects[i];\n                                }\n                            }\n                        },\n                        add: function(oldZone) {\n                            if (!oldZone) oldZone = {};\n                            var num = _fn.build.form.zone.zoneObjects.length + 1;\n\n                            // Update zone obj\n                            var zoneObj = {\n                                title: gettext(oldZone.title) || ngettext('Zone {num}', 'Zone {num}', num).replace('{num}', num),\n                                description: gettext(oldZone.description),\n                                // uid: unique ID for this zone. For backwards compatibility,\n                                // this field cannot be called \"id\" and must inherit the \"title\"\n                                // property if no 'uid' value is present, since old versions of\n                                // this block used the title as the primary identifier.\n                                uid: oldZone.uid || oldZone.title || _fn.build.form.zone.generateUID(),\n                                width: oldZone.width || 200,\n                                height: oldZone.height || 100,\n                                x: oldZone.x || 0,\n                                y: oldZone.y || 0,\n                                align: oldZone.align || ''\n                            };\n\n                            _fn.build.form.zone.zoneObjects.push(zoneObj);\n\n                            // Add fields to zone form\n                            $zoneNode = $(_fn.tpl.zoneInput({\n                                zone: zoneObj,\n                                index: _fn.build.form.zone.totalZonesCreated++,\n                            }));\n                            _fn.build.$el.zones.form.append($zoneNode);\n                            _fn.build.form.zone.enableDelete();\n\n                            // Add zone div to target\n                            _fn.build.form.zone.renderZonesPreview();\n\n                        },\n                        generateUID: function() {\n                            // Generate a unique ID for a new zone.\n                            for (var i = 1; true; i++) {\n                                var uid = \"zone-\" + i;\n                                if (!_fn.build.form.zone.getZoneObjByUID(uid)) {\n                                    return uid;\n                                }\n                            }\n                        },\n                        remove: function(e) {\n                            var $el = $(e.currentTarget).closest('.zone-row'),\n                                classes = $el.attr('class'),\n                                id = classes.slice(classes.indexOf('zone-row') + 9),\n                                uid = String($el.data('uid')),  // cast to string since UID must be string but .data() converts data-uid=\"5\" to 5\n                                array_index;\n\n                            $el.detach();\n\n                            // Find the uid of the zone in the array and remove it.\n                            for (array_index = 0; array_index < _fn.build.form.zone.zoneObjects.length;\n                                 array_index++) {\n                                if (_fn.build.form.zone.zoneObjects[array_index].uid == uid) break;\n                            }\n                            _fn.build.form.zone.zoneObjects.splice(array_index, 1);\n                            _fn.build.form.zone.renderZonesPreview();\n\n                            _fn.build.form.zone.disableDelete();\n\n                        },\n                        enableDelete: function() {\n                            if (_fn.build.form.zone.zoneObjects.length > 1) {\n                                _fn.build.$el.zones.form.find('.remove-zone').removeClass('hidden');\n                            }\n                        },\n                        disableDelete: function() {\n                            if (_fn.build.form.zone.zoneObjects.length === 1) {\n                                _fn.build.$el.zones.form.find('.remove-zone').addClass('hidden');\n                            }\n                        },\n                        renderZonesPreview: function() {\n                            // Refresh the div which shows a preview of the zones over top of\n                            // the background image.\n                            _fn.build.$el.zonesPreview.html('');\n                            var imgWidth = _fn.build.$el.targetImage[0].naturalWidth;\n                            var imgHeight = _fn.build.$el.targetImage[0].naturalHeight;\n                            if (imgWidth == 0 || imgHeight == 0) {\n                                // Set a non-zero value to avoid divide-by-zero:\n                                imgWidth = imgHeight = 400;\n                            }\n                            this.zoneObjects.forEach(function(zoneObj) {\n                                _fn.build.$el.zonesPreview.append(\n                                    _fn.tpl.zoneElement({\n                                        uid: zoneObj.uid,\n                                        title: gettext(zoneObj.title),\n                                        description: gettext(zoneObj.description),\n                                        x_percent: (+zoneObj.x) / imgWidth * 100,\n                                        y_percent: (+zoneObj.y) / imgHeight * 100,\n                                        width_percent: (+zoneObj.width) / imgWidth * 100,\n                                        height_percent: (+zoneObj.height) / imgHeight * 100,\n                                        align: zoneObj.align\n                                    })\n                                );\n                            });\n                        },\n                        changedInputHandler: function(ev) {\n                            // Called when any of the inputs have changed.\n                            var $changedInput = $(ev.currentTarget);\n                            var $row = $changedInput.closest('.zone-row');\n                            var record = _fn.build.form.zone.getZoneObjByUID(String($row.data('uid')));\n                            if ($changedInput.hasClass('zone-title')) {\n                                record.title = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-width')) {\n                                record.width = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-description')) {\n                                record.description = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-height')) {\n                                record.height = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-x')) {\n                                record.x = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-y')) {\n                                record.y = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-align-select')) {\n                                record.align = $changedInput.val();\n                            }\n                            _fn.build.form.zone.renderZonesPreview();\n                        },\n                        imageLoaded: function() {\n                            // The target background image has loaded (or reloaded, if changed).\n                            _fn.build.form.zone.renderZonesPreview();\n                        },\n                        getAutozoneParams: function() {\n                            var element = _fn.build.$el.zones.tab.find('.background-auto');\n                            return {\n                                rows: parseInt(element.find('.autozone-layout-rows').val(), 10),\n                                cols: parseInt(element.find('.autozone-layout-cols').val(), 10),\n                                zone_width: parseInt(element.find('.autozone-size-width').val(), 10),\n                                zone_height: parseInt(element.find('.autozone-size-height').val(), 10),\n                                padding: 20\n                            };\n                        },\n                        validateAutozoneParams: function(params) {\n                            var fields = [\n                                '.autozone-layout-cols',\n                                '.autozone-layout-rows',\n                                '.autozone-size-width',\n                                '.autozone-size-height'\n                            ];\n                            var success = true;\n                            fields.forEach(function(field) {\n                                var element = _fn.build.$el.zones.tab.find(field);\n                                var val = element.val();\n                                var number = parseInt(element.val(), 10);\n                                // Make sure the user entered a positive integer number.\n                                if (number && number > 0 && String(number) === val) {\n                                    element.removeClass('field-error');\n                                } else {\n                                    element.addClass('field-error');\n                                    success = false;\n                                }\n                            });\n                            if (!success) {\n                                runtime.notify('error', {\n                                    'title': gettext(\"There was an error with your form.\"),\n                                    'message': gettext(\"Please check the values you entered.\")\n                                });\n                            }\n                            return success;\n                        },\n                        calculateAutozoneData: function(params) {\n                            var rows = params.rows;\n                            var cols = params.cols;\n                            var zone_width = params.zone_width;\n                            var zone_height = params.zone_height;\n                            var padding = params.padding;\n\n                            var width = (zone_width * cols) + (padding * (cols + 1));\n                            var height = (zone_height * rows) + (padding * (rows + 1));\n\n                            var zones = [];\n                            for (var row = 0; row < rows; row++) {\n                                for (var col = 0; col < cols; col++) {\n                                    zones.push({\n                                        width: zone_width,\n                                        height: zone_height,\n                                        x: (padding * (col + 1) + (col * zone_width)),\n                                        y: (padding * (row + 1) + (row * zone_height))\n                                    });\n                                }\n                            }\n\n                            return {\n                                width: width,\n                                height: height,\n                                zones: zones\n                            };\n                        },\n                        generateBackgroundDataUri: function(autozone_data, params) {\n                            var autozone_data = _fn.build.form.zone.calculateAutozoneData(params);\n                            var svg = _fn.tpl.autozoneSvg(autozone_data).trim();\n                            var data_uri_params = _fn.build.encodeDataUriParams({\n                                producer: 'dndv2',\n                                cols: params.cols,\n                                rows: params.rows,\n                                zone_width: params.zone_width,\n                                zone_height: params.zone_height\n                            });\n                            return 'data:image/svg+xml;' + data_uri_params + ',' + encodeURIComponent(svg);\n                        },\n                        generateZones: function(zones) {\n                            // First remove all existing zones.\n                            _fn.build.$el.zones.form.find('.zone-row').remove();\n                            _fn.build.form.zone.zoneObjects = [];\n                            // Now generate new zones.\n                            zones.forEach(function(zone) {\n                                _fn.build.form.zone.add({\n                                    width: zone.width,\n                                    height: zone.height,\n                                    x: zone.x,\n                                    y: zone.y,\n                                    align: 'center'\n                                });\n                            });\n                        },\n                        generateBackgroundAndZones: function() {\n                            var params = _fn.build.form.zone.getAutozoneParams();\n                            if (!_fn.build.form.zone.validateAutozoneParams(params)) {\n                                return;\n                            }\n                            var autozone_data = _fn.build.form.zone.calculateAutozoneData(params);\n                            // Generate zones.\n                            _fn.build.form.zone.generateZones(autozone_data.zones);\n                            // Set background img src.\n                            var data_uri = _fn.build.form.zone.generateBackgroundDataUri(autozone_data, params);\n                            _fn.data.targetImg = data_uri;\n                            _fn.build.$el.targetImage.attr('src', data_uri);\n                            // Make sure \"Display label names on the image\" is checked.\n                            _fn.data.displayLabels = true;\n                            $('.display-labels-form input', element).prop('checked', true);\n                        }\n                    },\n                    createCheckboxes: function(selectedZones) {\n                        var template = _fn.tpl.zoneCheckbox;\n                        var checkboxes = [];\n                        var zoneObjects = _fn.build.form.zone.zoneObjects;\n\n                        zoneObjects.forEach(function(zoneObj) {\n                            checkboxes.push(template({\n                                zoneUid: zoneObj.uid,\n                                title: gettext(zoneObj.title),\n                                checked: $.inArray(zoneObj.uid, selectedZones) !== -1 ? 'checked' : '',\n                            }));\n                        });\n\n                        var html = checkboxes.join('');\n                        return new Handlebars.SafeString(html);\n                    },\n                    feedback: function($form) {\n                        _fn.data.feedback = {\n                            start: $form.find('.intro-feedback').val(),\n                            finish: $form.find('.final-feedback').val()\n                        };\n                        _fn.data.explanation = $form.find('.explanation').val();\n                    },\n                    item: {\n                        count: 0,\n                        add: function(itemData) {\n                            var $form = _fn.build.$el.items.form,\n                                tpl = _fn.tpl.itemInput,\n                                ctx = {};\n\n                            if (itemData) {\n                                ctx = itemData;\n                                if (itemData.backgroundImage && !ctx.imageURL) {\n                                    ctx.imageURL = itemData.backgroundImage; // This field was renamed.\n                                }\n                                if (itemData.size && parseInt(itemData.size.width) > 0) {\n                                    // Convert old fixed pixel width setting values (hard to\n                                    // make mobile friendly) to new percentage format.\n                                    // Note itemData.size.width is a string like \"380px\" (it can\n                                    // also be \"auto\" but that's excluded by the if condition above)\n                                    var bgImgWidth = _fn.build.$el.targetImage[0].naturalWidth;\n                                    if (bgImgWidth > 0 && typeof ctx.widthPercent === \"undefined\") {\n                                        ctx.widthPercent = parseInt(itemData.size.width) / bgImgWidth * 100;\n                                    }\n                                    // Preserve the old-style data in case we need it again:\n                                    ctx.pixelWidth = itemData.size.width.substr(0, itemData.size.width.length - 2); // Remove 'px'\n                                }\n                                if (itemData.size && parseInt(itemData.size.height) > 0) {\n                                    // Item fixed pixel height is ignored in new versions of the\n                                    // block, but preserve the data in case we need it again:\n                                    ctx.pixelHeight = itemData.size.height.substr(0, itemData.size.height.length - 2); // Remove 'px'\n                                }\n                                ctx.noPadding = (ctx.noPadding) ? 'checked' : '';\n                            }\n                            ctx.checkboxes = _fn.build.form.createCheckboxes(ctx.zones);\n\n                            ctx.index = _fn.build.form.item.count++;\n                            $form.append(tpl(ctx));\n                            _fn.build.form.item.enableDelete();\n\n                        },\n                        remove: function(e) {\n                            var $el = $(e.currentTarget).closest('.item');\n\n                            $el.detach();\n\n                            _fn.build.form.item.count--;\n                            _fn.build.form.item.disableDelete();\n\n                        },\n                        imageURLChanged: function(e) {\n                            // Mark the image description field as required if (and only if) an image is specified.\n                            var $imageUrlField = $(e.currentTarget);\n                            var $descriptionField = $imageUrlField.closest('.item').find('.item-image-description');\n                            $descriptionField.prop(\"required\", $imageUrlField.val() != \"\");\n                        },\n                        enableDelete: function() {\n                            if (_fn.build.form.item.count > 1) {\n                                _fn.build.$el.items.form.find('.remove-item').removeClass('hidden');\n                            }\n                        },\n                        disableDelete: function() {\n                            if (_fn.build.form.item.count === 1) {\n                                _fn.build.$el.items.form.find('.remove-item').addClass('hidden');\n                            }\n                        },\n                        showAdvancedSettings: function(e) {\n                            var $el = $(e.currentTarget).closest('.item');\n                            $el.find('.row.advanced').show();\n                            $el.find('.row.advanced-link').hide();\n                        },\n                    },\n                    submit: function() {\n                        var items = [],\n                            $form = _fn.build.$el.items.form.find('.item');\n\n                        $form.each(function(i, el) {\n                            var $el = $(el),\n                                name = $el.find('.item-text').val(),\n                                imageURL = $el.find('.item-image-url').val(),\n                                imageDescription = $el.find('.item-image-description').val(),\n                                selectedZones = $el.find('.zone-checkbox:checked'),\n                                noPadding = $el.find('.img-checkbox').is(':checked');\n\n                            if (name.length > 0 || imageURL.length > 0) {\n                                var data = {\n                                    displayName: name,\n                                    zones: $.map(selectedZones, function(checkbox){\n                                        return checkbox.value;\n                                    }),\n                                    id: i,\n                                    feedback: {\n                                        correct: $el.find('.success-feedback').val(),\n                                        incorrect: $el.find('.error-feedback').val()\n                                    },\n                                    imageURL: imageURL,\n                                    imageDescription: imageDescription,\n                                    noPadding: (imageURL ? noPadding : false),\n                                };\n                                // Optional preferred width as a percentage of the bg image's width:\n                                var widthPercent = $el.find('.item-width').val();\n                                if (widthPercent && +widthPercent > 0) { data.widthPercent = widthPercent; }\n\n                                items.push(data);\n                            }\n                        });\n\n                        _fn.data.items = items;\n                        _fn.data.zones = _fn.build.form.zone.zoneObjects;\n\n                        var data = {\n                            'display_name': $element.find('.display-name').val(),\n                            'mode': $element.find(\".problem-mode\").val(),\n                            'max_attempts': $element.find(\".max-attempts\").val(),\n                            'showanswer': $element.find(\".showanswer\").val(),\n                            'show_title': $element.find('.show-title').is(':checked'),\n                            'weight': $element.find('.weight').val(),\n                            'problem_text': $element.find('.problem-text').val(),\n                            'show_problem_header': $element.find('.show-problem-header').is(':checked'),\n                            'item_background_color': $element.find('.item-background-color').val(),\n                            'item_text_color': $element.find('.item-text-color').val(),\n                            'max_items_per_zone': $element.find('.max-items-per-zone').val(),\n                            'data': _fn.data,\n                        };\n\n                        var handlerUrl = runtime.handlerUrl(element, 'studio_submit');\n                        runtime.notify('save', {state: 'start', message: gettext(\"Saving\")});\n                        $.post(handlerUrl, JSON.stringify(data), 'json').done(function(response) {\n                            if (response.result === 'success') {\n                                runtime.notify('save', {state: 'end'});\n                            } else {\n                                var message = response.messages.join(\", \");\n                                runtime.notify('error', {\n                                    'title': gettext(\"There was an error with your form.\"),\n                                    'message': message\n                                });\n                            }\n                        });\n                    }\n                }\n            },\n\n            data: null\n        };\n\n        return {\n            init: _fn.build.init\n        };\n    })(jQuery);\n\n    $element.find('.cancel-button').bind('click', function() {\n        runtime.notify('cancel', {});\n    });\n\n    dragAndDrop.init();\n}\n", "# -*- coding: utf-8 -*-\n\"\"\" Drag and Drop v2 XBlock - Utils \"\"\"\nfrom __future__ import absolute_import\n\nimport copy\nimport re\nfrom collections import namedtuple\n\nfrom bleach.sanitizer import Cleaner\n\n\ndef _(text):\n    \"\"\" Dummy `gettext` replacement to make string extraction tools scrape strings marked for translation \"\"\"\n    return text\n\n\ndef ngettext_fallback(text_singular, text_plural, number):\n    \"\"\" Dummy `ngettext` replacement to make string extraction tools scrape strings marked for translation \"\"\"\n    if number == 1:\n        return text_singular\n    else:\n        return text_plural\n\n\ndef _clean_data(data):\n    \"\"\" Remove html tags and extra white spaces e.g newline, tabs etc from provided data \"\"\"\n    cleaner = Cleaner(tags=[], strip=True)\n    cleaned_text = \" \".join(re.split(r\"\\s+\", cleaner.clean(data), flags=re.UNICODE)).strip()\n    return cleaned_text\n\n\nclass DummyTranslationService:\n    \"\"\"\n    Dummy drop-in replacement for i18n XBlock service\n    \"\"\"\n    gettext = _\n    ngettext = ngettext_fallback\n\n\nclass FeedbackMessages:\n    \"\"\"\n    Feedback messages collection\n    \"\"\"\n    class MessageClasses:\n        \"\"\"\n        Namespace for message classes\n        \"\"\"\n        CORRECT_SOLUTION = \"correct\"\n        PARTIAL_SOLUTION = \"partial\"\n        INCORRECT_SOLUTION = \"incorrect\"\n\n        CORRECTLY_PLACED = CORRECT_SOLUTION\n        MISPLACED = INCORRECT_SOLUTION\n        NOT_PLACED = INCORRECT_SOLUTION\n\n        INITIAL_FEEDBACK = \"initial\"\n        FINAL_FEEDBACK = \"final\"\n\n    GRADE_FEEDBACK_TPL = _('Your highest score is {score}')\n    FINAL_ATTEMPT_TPL = _('Final attempt was used, highest score is {score}')\n\n    @staticmethod\n    def correctly_placed(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"correctly placed items\" message\n        \"\"\"\n        return ngettext(\n            'Correctly placed {correct_count} item',\n            'Correctly placed {correct_count} items',\n            number\n        ).format(correct_count=number)\n\n    @staticmethod\n    def misplaced(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"misplaced items\" message\n        \"\"\"\n        return ngettext(\n            'Misplaced {misplaced_count} item',\n            'Misplaced {misplaced_count} items',\n            number\n        ).format(misplaced_count=number)\n\n    @staticmethod\n    def misplaced_returned(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"misplaced items returned to bank\" message\n        \"\"\"\n        return ngettext(\n            'Misplaced {misplaced_count} item (misplaced item was returned to the item bank)',\n            'Misplaced {misplaced_count} items (misplaced items were returned to the item bank)',\n            number\n        ).format(misplaced_count=number)\n\n    @staticmethod\n    def not_placed(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"did not place required items\" message\n        \"\"\"\n        return ngettext(\n            'Did not place {missing_count} required item',\n            'Did not place {missing_count} required items',\n            number\n        ).format(missing_count=number)\n\n\nFeedbackMessage = namedtuple(\"FeedbackMessage\", [\"message\", \"message_class\"])  # pylint: disable=invalid-name\nItemStats = namedtuple(  # pylint: disable=invalid-name\n    'ItemStats',\n    [\"required\", \"placed\", \"correctly_placed\", \"decoy\", \"decoy_in_bank\"]\n)\n\n\nclass Constants:\n    \"\"\"\n    Namespace class for various constants\n    \"\"\"\n    ALLOWED_ZONE_ALIGNMENTS = ['left', 'right', 'center']\n    DEFAULT_ZONE_ALIGNMENT = 'center'\n\n    STANDARD_MODE = \"standard\"\n    ASSESSMENT_MODE = \"assessment\"\n    ATTR_KEY_USER_IS_STAFF = \"edx-platform.user_is_staff\"\n\n\nclass SHOWANSWER:\n    \"\"\"\n    Constants for when to show answer\n    \"\"\"\n    AFTER_ALL_ATTEMPTS = \"after_all_attempts\"\n    AFTER_ALL_ATTEMPTS_OR_CORRECT = \"after_all_attempts_or_correct\"\n    ALWAYS = \"always\"\n    ANSWERED = \"answered\"\n    ATTEMPTED = \"attempted\"\n    ATTEMPTED_NO_PAST_DUE = \"attempted_no_past_due\"\n    CLOSED = \"closed\"\n    CORRECT_OR_PAST_DUE = \"correct_or_past_due\"\n    DEFAULT = \"default\"\n    FINISHED = \"finished\"\n    NEVER = \"never\"\n    PAST_DUE = \"past_due\"\n\n\nclass StateMigration:\n    \"\"\"\n    Helper class to apply zone data and item state migrations\n    \"\"\"\n    def __init__(self, block):\n        self._block = block\n\n    @staticmethod\n    def _apply_migration(obj_id, obj, migrations):\n        \"\"\"\n        Applies migrations sequentially to a copy of an `obj`, to avoid updating actual data\n        \"\"\"\n        tmp = copy.deepcopy(obj)\n        for method in migrations:\n            tmp = method(obj_id, tmp)\n\n        return tmp\n\n    def apply_zone_migrations(self, zone):\n        \"\"\"\n        Applies zone migrations\n        \"\"\"\n        migrations = (self._zone_v1_to_v2, self._zone_v2_to_v2p1)\n        zone_id = zone.get('uid', zone.get('id'))\n\n        return self._apply_migration(zone_id, zone, migrations)\n\n    def apply_item_state_migrations(self, item_id, item_state):\n        \"\"\"\n        Applies item_state migrations\n        \"\"\"\n        migrations = (self._item_state_v1_to_v1p5, self._item_state_v1p5_to_v2, self._item_state_v2_to_v2p1)\n\n        return self._apply_migration(item_id, item_state, migrations)\n\n    @classmethod\n    def _zone_v1_to_v2(cls, unused_zone_id, zone):\n        \"\"\"\n        Migrates zone data from v1.0 format to v2.0 format.\n\n        Changes:\n        * v1 used zone \"title\" as UID, while v2 zone has dedicated \"uid\" property\n        * \"id\" and \"index\" properties are no longer used\n\n        In: {'id': 1, 'index': 2, 'title': \"Zone\", ...}\n        Out: {'uid': \"Zone\", ...}\n        \"\"\"\n        if \"uid\" not in zone:\n            zone[\"uid\"] = zone.get(\"title\")\n        zone.pop(\"id\", None)\n        zone.pop(\"index\", None)\n\n        return zone\n\n    @classmethod\n    def _zone_v2_to_v2p1(cls, unused_zone_id, zone):\n        \"\"\"\n        Migrates zone data from v2.0 to v2.1\n\n        Changes:\n        * Removed \"none\" zone alignment; default align is \"center\"\n\n        In: {\n            'uid': \"Zone\", \"align\": \"none\",\n            \"x_percent\": \"10%\", \"y_percent\": \"10%\", \"width_percent\": \"10%\", \"height_percent\": \"10%\"\n        }\n        Out: {\n            'uid': \"Zone\", \"align\": \"center\",\n            \"x_percent\": \"10%\", \"y_percent\": \"10%\", \"width_percent\": \"10%\", \"height_percent\": \"10%\"\n        }\n        \"\"\"\n        if zone.get('align', None) not in Constants.ALLOWED_ZONE_ALIGNMENTS:\n            zone['align'] = Constants.DEFAULT_ZONE_ALIGNMENT\n\n        return zone\n\n    @classmethod\n    def _item_state_v1_to_v1p5(cls, unused_item_id, item):\n        \"\"\"\n        Migrates item_state from v1.0 to v1.5\n\n        Changes:\n        * Item state is now a dict instead of tuple\n\n        In: ('100px', '120px')\n        Out: {'top': '100px', 'left': '120px'}\n        \"\"\"\n        if isinstance(item, dict):\n            return item\n        else:\n            return {'top': item[0], 'left': item[1]}\n\n    @classmethod\n    def _item_state_v1p5_to_v2(cls, unused_item_id, item):\n        \"\"\"\n        Migrates item_state from v1.5 to v2.0\n\n        Changes:\n        * Item placement attributes switched from absolute (left-top) to relative (x_percent-y_percent) units\n\n        In: {'zone': 'Zone\", 'correct': True, 'top': '100px', 'left': '120px'}\n        Out: {'zone': 'Zone\", 'correct': True, 'top': '100px', 'left': '120px'}\n        \"\"\"\n        # Conversion can't be made as parent dimensions are unknown to python - converted in JS\n        # Since 2.1 JS this conversion became unnecesary, so it was removed from JS code\n        return item\n\n    def _item_state_v2_to_v2p1(self, item_id, item):\n        \"\"\"\n        Migrates item_state from v2.0 to v2.1\n\n        * Single item can correspond to multiple zones - \"zone\" key is added to each item\n        * Assessment mode - \"correct\" key is added to each item\n        * Removed \"no zone align\" option; only automatic alignment is now allowed - removes attributes related to\n          \"absolute\" placement of an item (relative to background image, as opposed to the zone)\n        \"\"\"\n        self._multiple_zones_migration(item_id, item)\n        self._assessment_mode_migration(item)\n        self._automatic_alignment_migration(item)\n\n        return item\n\n    def _multiple_zones_migration(self, item_id, item):\n        \"\"\"\n        Changes:\n        * Adds \"zone\" attribute\n\n        In: {'item_id': 0}\n        Out: {'zone': 'Zone\", 'item_id\": 0}\n\n        In: {'item_id': 1}\n        Out: {'zone': 'unknown\", 'item_id\": 1}\n        \"\"\"\n        if item.get('zone') is None:\n            valid_zones = self._block.get_item_zones(int(item_id))\n            if valid_zones:\n                # If we get to this point, then the item was placed prior to support for\n                # multiple correct zones being added. As a result, it can only be correct\n                # on a single zone, and so we can trust that the item was placed on the\n                # zone with index 0.\n                item['zone'] = valid_zones[0]\n            else:\n                item['zone'] = 'unknown'\n\n    @classmethod\n    def _assessment_mode_migration(cls, item):\n        \"\"\"\n        Changes:\n        * Adds \"correct\" attribute if missing\n\n        In: {'item_id': 0}\n        Out: {'item_id': 'correct': True}\n\n        In: {'item_id': 0, 'correct': True}\n        Out: {'item_id': 'correct': True}\n\n        In: {'item_id': 0, 'correct': False}\n        Out: {'item_id': 'correct': False}\n        \"\"\"\n        # If correctness information is missing\n        # (because problem was completed before assessment mode was implemented),\n        # assume the item is in correct zone (in standard mode, only items placed\n        # into correct zone are stored in item state).\n        if item.get('correct') is None:\n            item['correct'] = True\n\n    @classmethod\n    def _automatic_alignment_migration(cls, item):\n        \"\"\"\n        Changes:\n        * Removed old \"absolute\" placement attributes\n        * Removed \"none\" zone alignment, making \"x_percent\" and \"y_percent\" attributes obsolete\n\n        In: {'zone': 'Zone\", 'correct': True, 'top': '100px', 'left': '120px', 'absolute': true}\n        Out: {'zone': 'Zone\", 'correct': True}\n\n        In: {'zone': 'Zone\", 'correct': True, 'x_percent': '90%', 'y_percent': '20%'}\n        Out: {'zone': 'Zone\", 'correct': True}\n        \"\"\"\n        attributes_to_remove = ['x_percent', 'y_percent', 'left', 'top', 'absolute']\n        for attribute in attributes_to_remove:\n            item.pop(attribute, None)\n\n        return item\n", "# -*- coding: utf-8 -*-\n\n# Imports ###########################################################\n\nimport os\nfrom setuptools import setup\n\n\n# Functions #########################################################\n\ndef package_data(pkg, root_list):\n    \"\"\"Generic function to find package_data for `pkg` under `root`.\"\"\"\n    data = []\n    for root in root_list:\n        for dirname, _, files in os.walk(os.path.join(pkg, root)):\n            for fname in files:\n                data.append(os.path.relpath(os.path.join(dirname, fname), pkg))\n\n    return {pkg: data}\n\n\n# Main ##############################################################\n\nsetup(\n    name='xblock-drag-and-drop-v2',\n    version='2.7.0',\n    description='XBlock - Drag-and-Drop v2',\n    packages=['drag_and_drop_v2'],\n    install_requires=[\n        'XBlock',\n        'xblock-utils',\n        'bleach',\n    ],\n    entry_points={\n        'xblock.v1': 'drag-and-drop-v2 = drag_and_drop_v2:DragAndDropBlock',\n    },\n    package_data=package_data(\"drag_and_drop_v2\", [\"static\", \"templates\", \"public\", \"translations\", \"locale\"]),\n)\n", "from .test_base import BaseIntegrationTest\n\n\nclass TestCustomDataDragAndDropRendering(BaseIntegrationTest):\n    PAGE_TITLE = 'Drag and Drop v2'\n    PAGE_ID = 'drag_and_drop_v2'\n\n    def setUp(self):\n        super(TestCustomDataDragAndDropRendering, self).setUp()\n\n        scenario_xml = self._get_custom_scenario_xml(\"data/test_html_data.json\")\n        self._add_scenario(self.PAGE_ID, self.PAGE_TITLE, scenario_xml)\n\n        self._page = self.go_to_page(self.PAGE_TITLE)\n\n        header1 = self.browser.find_element_by_css_selector('h1')\n        self.assertEqual(header1.text, 'XBlock: ' + self.PAGE_TITLE)\n\n    def test_items_rendering(self):\n        items = self._get_items()\n\n        self.assertEqual(len(items), 3)\n        self.assertIn('<b>1</b>', self.get_element_html(items[0]))\n        self.assertIn('<i>2</i>', self.get_element_html(items[1]))\n        self.assertIn('<span style=\"color:red\">X</span>', self.get_element_html(items[2]))\n\n    def test_html_title_renders_properly(self):\n        \"\"\"\n        Tests HTML titles are rendered properly\n        \"\"\"\n        zones = self._get_zones()\n        self.assertEqual(u'Zone\\ndroppable\\nNo items placed here', zones[0].text)\n        self.assertNotEqual(u'Zone <sup>-1</sup>\\ndroppable\\nNo items placed here', zones[0].text)\n\n    def test_background_image(self):\n        bg_image = self.browser.find_element_by_css_selector(\".xblock--drag-and-drop .target-img\")\n        custom_image_url = (\n            \"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciI\"\n            \"HdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiBzdHlsZT0iYmFja2dyb3VuZDogI2VlZjsiPjwvc3ZnPg==\"\n        )\n        custom_image_description = \"This describes the target image\"\n        self.assertEqual(bg_image.get_attribute(\"src\"), custom_image_url)\n        self.assertEqual(bg_image.get_attribute(\"alt\"), custom_image_description)\n\n\nclass TestZoneTitleAsHTML(BaseIntegrationTest):\n    PAGE_TITLE = 'Drag and Drop v2'\n    PAGE_ID = 'drag_and_drop_v2'\n\n    def setUp(self):\n        super(TestZoneTitleAsHTML, self).setUp()\n\n        scenario_xml = self._get_custom_scenario_xml(\"data/test_html_titles_data.json\")\n        self._add_scenario(self.PAGE_ID, self.PAGE_TITLE, scenario_xml)\n\n        self._page = self.go_to_page(self.PAGE_TITLE)\n\n        header1 = self.browser.find_element_by_css_selector('h1')\n        self.assertEqual(header1.text, 'XBlock: ' + self.PAGE_TITLE)\n\n    def test_html_title_renders_properly(self):\n        \"\"\"\n        Tests HTML titles are rendered properly\n        \"\"\"\n        zones = self._get_zones()\n        self.assertEqual('Zone\\ndroppable\\nNo items placed here', zones[0].text)\n        self.assertNotEqual('Zone <sup>-1</sup>\\ndroppable\\nNo items placed here', zones[0].text)\n", "from __future__ import absolute_import\n\nfrom ddt import data, ddt, unpack\nfrom selenium.common.exceptions import NoSuchElementException\nfrom workbench import scenarios\n\nfrom .test_base import BaseIntegrationTest\n\n\n@ddt\nclass TestDragAndDropTitleAndProblem(BaseIntegrationTest):\n    @unpack\n    @data(\n        ('Plain text problem 1, header visible.', True),\n        ('Plain text problem 2, header hidden.', False),\n        ('Problem/instructions with <i>HTML</i> and header.', True),\n        ('<span style=\"color: red;\">Span problem, no header</span>', False),\n    )\n    def test_problem_parameters(self, problem_text, show_problem_header):\n        const_page_name = 'Test title and problem parameters'\n        const_page_id = 'test_block_title_and_problem'\n        scenario_xml = self._make_scenario_xml(\n            display_name=\"Title\",\n            show_title=True,\n            problem_text=problem_text,\n            show_problem_header=show_problem_header,\n        )\n        scenarios.add_xml_scenario(const_page_id, const_page_name, scenario_xml)\n        self.addCleanup(scenarios.remove_scenario, const_page_id)\n\n        page = self.go_to_page(const_page_name)\n        is_problem_header_visible = len(page.find_elements_by_css_selector('.problem > h4')) > 0\n        self.assertEqual(is_problem_header_visible, show_problem_header)\n\n        problem = page.find_element_by_css_selector('.problem > p')\n        self.assertEqual(self.get_element_html(problem), problem_text)\n\n    @unpack\n    @data(\n        ('plain shown', 'title1', True),\n        ('plain hidden', 'title2', False),\n        ('html shown', 'title with <i>HTML</i>', True),\n        ('html hidden', '<span style=\"color:red\">Title: HTML?</span>', False)\n    )\n    def test_title_parameters(self, _, display_name, show_title):\n        const_page_name = 'Test show title parameter'\n        const_page_id = 'test_block_show_title'\n        scenario_xml = self._make_scenario_xml(\n            display_name=display_name,\n            show_title=show_title,\n            problem_text='Generic problem',\n        )\n        scenarios.add_xml_scenario(const_page_id, const_page_name, scenario_xml)\n        self.addCleanup(scenarios.remove_scenario, const_page_id)\n\n        page = self.go_to_page(const_page_name)\n        if show_title:\n            problem_header = page.find_element_by_css_selector('h3.hd.hd-3.problem-header')\n            self.assertEqual(self.get_element_html(problem_header), display_name)\n        else:\n            with self.assertRaises(NoSuchElementException):\n                page.find_element_by_css_selector('h3.hd.hd-3.problem-header')\n"], "fixing_code": ["Drag and Drop XBlock changelog\n==============================\n\nVersion 3.0.0 (2022-11-18)\n---------------------------\n\n* Sanitize HTML tags to prevent XSS vulnerabilities.  \n  BREAKING CHANGE: Disallowed HTML tags (e.g. `<script>`) will no longer be rendered in LMS and Studio. \n\nVersion 2.7.0 (2022-11-15)\n---------------------------\n\n* Add option to drop decoy items from scores\n\nVersion 2.6.0 (2022-10-24)\n---------------------------\n\n* Add package publishing workflow.\n\nVersion 2.5.0 (2022-10-13)\n---------------------------\n\n* Make the \"Show Answer\" condition customizable (like in the Problem XBlock). \n\nVersion 2.4.2 (2022-10-13)\n---------------------------\n\n* Support HTML in explanations.\n\nVersion 2.4.1 (2022-10-06)\n---------------------------\n* Remove dots on feedback and moves final feedback to end and set bold text on assessment mode.\n* Improve CSS styles for popup feedback.\n* Remove special popup feedback styles for mobile.\n* Improve feedback message when you reach the limit of elements on a zone.\n* Fix the issue while dragging an image item on Safari mobile.\n* Fix width issue for zone container on Safari mobile\n* Update translations.\n\nVersion 2.4.0 (2022-09-23)\n---------------------------\n\n* Drop the support for Python 3.5 and Ubuntu 18.04.\n\nVersion 2.3.11 (2022-07-22)\n---------------------------\n\n* Use global (platform-wide) translations as a fallback when XBlock translations are missing. \\\n  This change also has an intended side effect - it allows overriding English text with comprehensive themes (by patching the default translation catalog).\n\nVersion 2.3.10 (2022-07-22)\n---------------------------\n\n* Add an optional \"Explanation\" field.\n* Hide feedback div when there is no feedback content to display.\n* Update translations.\n\nVersion 2.3.9 (2022-06-15)\n---------------------------\n\n* Fix draggable item width inconsistency while dragging.\n* Do not move correctly placed items when showing the answer.\n* Distribute items with multiple correct zones among these zones when showing the answer.\n\nVersion 2.3.8 (2022-04-12)\n---------------------------\n\n* Add item option to remove padding from images dropped on a zone.\n* Add option to show zone border when dragging an item.\n* Hides text when a draggable item is placed in a target zone and frontend wait for LMS response, this is done since the size of the item increases when the spinner is visible.\n* Change containers and css classes to match those from edx-platform. The problem div now contains the drag container, buttons and feedback, css classes from submit button; submit answer and action buttons were also changed.\n* Improve feedback styles, now only icons shows color related with feedback and text color remains the same also each feedback line doesn't show borders.\n* Replaced `Travis` with `GitHub CI`.\n\nVersion 2.3.7 (2022-02-20)\n---------------------------\n\n* Reduce drag delay on mobile devices.\n\nVersion 2.3.6 (2021-08-11)\n---------------------------\n\n* Add Portuguese translations.\n\nVersion 2.3.5 (2021-03-09)\n---------------------------\n\n* Updates supported language translations.\n\nVersion 2.3.4 (2021-03-09)\n---------------------------\n\n* Enable adding weighted problems and overriding the scores for learners. The score can be overridden in LMS using either staff debug information or Student Admin in instructor Tab.\n\nVersion 2.3.3 (2021-03-09)\n---------------------------\n\n* Fixed drag and drop editor not loading in the studio due to translation issue.\n\nVersion 2.3.2 (2021-02-12)\n---------------------------\n\n* Fix instance of `DeprecatedEdxPlatformImportWarning`.\n\nVersion 2.3.1 (2020-08-04)\n---------------------------\n\n* Better JS i18n language mapping.\n* i18n source file updated in Transifex.\n* i18n updated (not complete) support for languages: ar, de, es_419, fr, he, hi, it, ja, ko, nl, pl, pt_BR, ru, tr and zh_CN\n\nVersion 2.3 (2020-08-04)\n---------------------------\n\n* Make Drag and Drop Indexable.\n* Drop Python 2 support.\n\nVersion 2.2.10 (2020-04-14)\n---------------------------\n\n* Fix bug where 'edx.drag_and_drop_v2.feedback.opened' event was sent to publish_event endpoint excessively on mouse move.  (PR #238)\n\nVersion 2.2.9 (2020-04-03)\n--------------------------\n\n* Updated fragment import to remove deprecation warning which was causing extra logs in Splunk etc.\n\nVersion 2.2.8 (2020-01-13)\n--------------------------\n\n* Updated code to render custom zone title as HTML\n\nVersion 2.2.7 (????-??-??)\n-------------------\n\n* NOTE: This version was skipped / is not documented.\n\nVersion 2.2.6 (2019-10-08)\n--------------------------\n\n* Python3 compatible.\n\nVersion 2.2.5 (2019-10-04)\n--------------------------\n\n* This repository is now python3 compatible.\n* Update the xblock-sdk hash which is python3 compatible also.\n\nVersion 2.2.4 (2019-07-30)\n---------------------------\n\n* Use InheritanceMixin for submission deadline checks (PR #219)\n* Submit button behavior will change in Assessment Mode and will now be impacted by subsection due date, grace period and course pacing\n\nVersion 2.2.3 (2019-04-05)\n---------------------------\n\n* Fix dragging bug in mobile (PR #204)\n\nVersion 2.2.2 (2019-03-22)\n---------------------------\n\n* Add translation for Reset and Feedback strings (PR #196)\n* Fix Loading message translation for Chinese & Spanish (PR #199)\n\nVersion 2.2.1 (2018-11-16)\n---------------------------\n\n* Fix JavaScript error when the XBlock is in an IFrame (PR #192)\n* Revert change to travis.yml so it doesn't need to be updated with every version bump.\n\nVersion 2.2.0 (2018-11-15)\n---------------------------\n\n* Extend existing APIs to support native mobile (PR #158)\n\nVersion 2.1.8 (2018-11-02)\n---------------------------\n\n* Implement XBlock JavaScript i18n using i18n_tool and django-statici18n (PR #156)\n\nVersion 2.1.7 (2018-10-10)\n---------------------------\n\n* Expand static URLs in FeedbackMessage (PR #190)\n\nVersion 2.1.6 (2018-05-15)\n---------------------------\n\n* Use i18n runtime service to provide translations for HTML templates (PR #154)\n* Ensures URLs are utf-8 encoded (PR #150)\n* Correct load listener setup (PR #153)\n* Improve image handling on mobile (PR #152)\n* When dragging, scroll target image as needed.\n\nVersion 2.1.5 (2017-11-06)\n---------------------------\n\n* Making the code more robust to handle an edge case when a dict does not contain an key (PR #149)\n\nVersion 2.1.4 (2017-11-06)\n---------------------------\n\n* Make XBlock always emit `progress` event explicitly when it is marked as complete.\n\nVersion 2.1.3 (2017-10-05)\n---------------------------\n\n* Prevent target image from shrinking in mobile, and make it scrollable (PR #135)\n\nVersion 2.1.2 (2017-10-02)\n---------------------------\n\n* Ability to generate zones and background image automatically (PR #136)\n\nVersion 2.1.1 (2017-09-26)\n---------------------------\n\n* Enforce XBlock variable types (PR #104)\n* Improvements for mobile (PRs #132, #133, #134)\n\nVersion 2.0.14 (2017-01-17)\n---------------------------\n\n* Various accessibility improvements (PRs #110, #111, #112)\n\nVersion 2.0.13 (2017-01-02)\n---------------------------\n\n* i18n improvements (PR #113)\n\nVersion 2.0.12 (2016-11-08)\n---------------------------\n\n* ([#108](https://github.com/openedx/xblock-drag-and-drop-v2/pull/108)) Grading updates:\n    * [SOL-2030][sol-2030] Grade information is now displayed beneath the display name of the problem (similar to CAPA)\n    * [SOL-2094][sol-2094] Fixed problem preventing DnDv2 blocks from being scored or graded.\n    * Highest grade achieved is now displayed in feedback area\n    * Renamed \"Maximum score\" field to \"Problem Weight\" to be in line with CAPA problems and avoid confusion.\n\n[sol-2030]: https://openedx.atlassian.net/browse/SOL-2030\n[sol-2094]: https://openedx.atlassian.net/browse/SOL-2094\n\nVersion 2.0.11 (2016-10-03)\n---------------------------\n\n* ([#106](https://github.com/openedx/xblock-drag-and-drop-v2/pull/106)) Don't delete misplaced items on final attempt\n\nVersion 2.0.10 (2016-09-22)\n---------------------------\n\n* ([#97](https://github.com/openedx/xblock-drag-and-drop-v2/pull/97)) Added \"item\" field to item.dropped event\n* ([#101](https://github.com/openedx/xblock-drag-and-drop-v2/pull/101)) Implement \"show answer\" button\n* ([#103](https://github.com/openedx/xblock-drag-and-drop-v2/pull/103)) Miscellaneous UI fixes\n* ([#105](https://github.com/openedx/xblock-drag-and-drop-v2/pull/105)) Correct an issue with background image selection\n\nVersion 2.0.9 (2016-09-01)\n--------------------------\n\n* ([#88](https://github.com/openedx/xblock-drag-and-drop-v2/pull/88)) Cleaned up studio editor template: styling, help texts, accessibility attributes, classes instead of IDs, etc.\n* ([#95](https://github.com/openedx/xblock-drag-and-drop-v2/pull/95)) Fixed flaky selenium tests\n* ([#85](https://github.com/openedx/xblock-drag-and-drop-v2/pull/85)) Accessibility improvements for item feedback popup\n* ([#73](https://github.com/openedx/xblock-drag-and-drop-v2/pull/73)) Accessibility improvements for item, zone and background image when using keyboard mode\n* ([#96](https://github.com/openedx/xblock-drag-and-drop-v2/pull/96)) Decoy items are properly accounted for in grade calculation and problem completion condition\n* ([#98](https://github.com/openedx/xblock-drag-and-drop-v2/pull/98)) Support for legacy item state\n* ([#92](https://github.com/openedx/xblock-drag-and-drop-v2/pull/92)) Prevented overlapping item placement: option to keep dropped item where learner dropped it was removed; items always use automatic layouts (left/center/right)\n* ([#93](https://github.com/openedx/xblock-drag-and-drop-v2/pull/93)) Per-item error feedback is shown in assessment mode when an attempt is submitted\n\nVersion 2.0.8 (2016-08-15)\n--------------------------\n\n* Numerical input feature removed\n* Multiple drop zones per item\n* Assessment mode - first version\n\n\nVersion 2.0.7 (2016-06-10)\n--------------------------\n\n* Translation fix: removed duplicate entries in translation files\n\nVersion 2.0.6 (2016-05-20)\n--------------------------\n\n* Accessibility fix: Removes role=\"application\"\n\nVersion 2.0.5 (2016-03-30)\n--------------------------\n\n* Marked strings for translations (PR #66)\n* Added the ability to specify automatic alignment of dropped items. (PR #57)\n\nVersion 2.0.4 (2016-03-10)\n--------------------------\n\n* Add a placeholder text to the input field to set the item image. (PR #65)\n\nVersion 2.0.3 (2016-03-07)\n--------------------------\n\n* Bugfix: When omitting the background image description in Studio, the red halo\n  indicating the field with the error did not show in Safari. (PR #62)\n* Bugfix: Make short URLs of the form /static/... to uploaded images work\n  correctly for item background images. (PR #63)\n\nVersion 2.0.2 (2016-02-18)\n--------------------------\n\n* Bugfix: \"Background description\" was required, but if you filled it out and pressed \"Continue\", \"Save\", it would accept the new description but would not actually save it. (PR #55)\n* Bugfix: When configuring the draggable items, the \"Image Description\" was always required, even if the \"Image URL\" was blank. (PR #55)\n* Bugfix: When clicking certain action links in the dndv2 editor (e.g. \"Add a Zone\"), the browser would scroll to the top of the page (since the href=\"#\" event was not prevented). (PR #55)\n* Bugfix: When changing tabs in the dndv2 editor, the next tab would often be scrolled down halfway. (PR #55)\n* Bugfix: In Studio, Newly added drag and drop components did not load properly, due to [a Studio bug](https://github.com/openedx/edx-platform/pull/11433) that affects Cypress and Dogwood. (Fixed in Studio post-Dogwood.) (PR #55)\n* Fixed some flaky tests\n\nVersion 2.0.1 (2016-02-15)\n--------------------------\n* Bugfix: If zone labels are numbers, like \"1\", \"2\", etc., then the draggables would not match with that zone (you cannot drop the draggables onto that zone) (PR #54)\n* Bugfix: If two zones had the same name/label, the block would not work properly. (PR #54)\n* Bugfix: If the platform's locale is set to a language like \"de\" or \"eo\" that formats numbers like \"3,14\", then the \"Maximum Score\" field appears blank when editing a dndv2 exercise in Studio. Attempting to save the exercise with that field blank causes a 500. (PR #54)\n\nVersion 2.0.0 (2016-01-29)\n------------------------\n\nA brand new release of the Drag and Drop XBlock, featuring major UX improvements, new features, and accessibility enhancements.\n", "# -*- coding: utf-8 -*- # pylint: disable=too-many-lines\n#\n\"\"\" Drag and Drop v2 XBlock \"\"\"\n\n# Imports ###########################################################\n\nfrom __future__ import absolute_import\nfrom collections import Counter\n\nimport copy\nimport json\nimport logging\n\nimport six.moves.urllib.error  # pylint: disable=import-error\nimport six.moves.urllib.parse  # pylint: disable=import-error\nimport six.moves.urllib.request  # pylint: disable=import-error\nimport six\nimport pkg_resources\nimport webob\n\nfrom django.utils import translation\nfrom xblock.core import XBlock\nfrom xblock.exceptions import JsonHandlerError\nfrom xblock.fields import Boolean, Dict, Float, Integer, Scope, String\nfrom xblock.scorable import ScorableXBlockMixin, Score\nfrom web_fragments.fragment import Fragment\nfrom xblockutils.resources import ResourceLoader\nfrom xblockutils.settings import ThemableXBlockMixin, XBlockWithSettingsMixin\n\nfrom .compat import get_grading_ignore_decoys_waffle_flag\nfrom .default_data import DEFAULT_DATA\nfrom .utils import (\n    Constants, SHOWANSWER, DummyTranslationService, FeedbackMessage,\n    FeedbackMessages, ItemStats, StateMigration, _clean_data, _, sanitize_html\n)\n\n# Globals ###########################################################\n\nloader = ResourceLoader(__name__)\nlogger = logging.getLogger(__name__)\n\n\n# Classes ###########################################################\n\n\n# pylint: disable=bad-continuation\n@XBlock.wants('settings')\n@XBlock.wants('replace_urls')\n@XBlock.wants('user')  # Using `needs` breaks the Course Outline page in Maple.\n@XBlock.needs('i18n')\nclass DragAndDropBlock(\n    ScorableXBlockMixin,\n    XBlock,\n    XBlockWithSettingsMixin,\n    ThemableXBlockMixin\n):\n    \"\"\"\n    XBlock that implements a friendly Drag-and-Drop problem\n    \"\"\"\n\n    CATEGORY = \"drag-and-drop-v2\"\n\n    SOLUTION_CORRECT = \"correct\"\n    SOLUTION_PARTIAL = \"partial\"\n    SOLUTION_INCORRECT = \"incorrect\"\n\n    GRADE_FEEDBACK_CLASSES = {\n        SOLUTION_CORRECT: FeedbackMessages.MessageClasses.CORRECT_SOLUTION,\n        SOLUTION_PARTIAL: FeedbackMessages.MessageClasses.PARTIAL_SOLUTION,\n        SOLUTION_INCORRECT: FeedbackMessages.MessageClasses.INCORRECT_SOLUTION,\n    }\n\n    PROBLEM_FEEDBACK_CLASSES = {\n        SOLUTION_CORRECT: FeedbackMessages.MessageClasses.CORRECT_SOLUTION,\n        SOLUTION_PARTIAL: None,\n        SOLUTION_INCORRECT: None\n    }\n\n    display_name = String(\n        display_name=_(\"Title\"),\n        help=_(\"The title of the drag and drop problem. The title is displayed to learners.\"),\n        scope=Scope.settings,\n        default=_(\"Drag and Drop\"),\n        enforce_type=True,\n    )\n\n    mode = String(\n        display_name=_(\"Mode\"),\n        help=_(\n            \"Standard mode: the problem provides immediate feedback each time \"\n            \"a learner drops an item on a target zone. \"\n            \"Assessment mode: the problem provides feedback only after \"\n            \"a learner drops all available items on target zones.\"\n        ),\n        scope=Scope.settings,\n        values=[\n            {\"display_name\": _(\"Standard\"), \"value\": Constants.STANDARD_MODE},\n            {\"display_name\": _(\"Assessment\"), \"value\": Constants.ASSESSMENT_MODE},\n        ],\n        default=Constants.STANDARD_MODE,\n        enforce_type=True,\n    )\n\n    max_attempts = Integer(\n        display_name=_(\"Maximum attempts\"),\n        help=_(\n            \"Defines the number of times a student can try to answer this problem. \"\n            \"If the value is not set, infinite attempts are allowed.\"\n        ),\n        scope=Scope.settings,\n        default=None,\n        enforce_type=True,\n    )\n\n    show_title = Boolean(\n        display_name=_(\"Show title\"),\n        help=_(\"Display the title to the learner?\"),\n        scope=Scope.settings,\n        default=True,\n        enforce_type=True,\n    )\n\n    question_text = String(\n        display_name=_(\"Problem text\"),\n        help=_(\"The description of the problem or instructions shown to the learner.\"),\n        scope=Scope.settings,\n        default=\"\",\n        enforce_type=True,\n    )\n\n    show_question_header = Boolean(\n        display_name=_('Show \"Problem\" heading'),\n        help=_('Display the heading \"Problem\" above the problem text?'),\n        scope=Scope.settings,\n        default=True,\n        enforce_type=True,\n    )\n    showanswer = String(\n        display_name=_(\"Show answer\"),\n        help=_(\"Defines when to show the answer to the problem. \"\n               \"A default value can be set in Advanced Settings. \"\n               \"To revert setting a custom value, choose the 'Default' option.\"),\n        scope=Scope.settings,\n        default=SHOWANSWER.FINISHED,\n        values=[\n            {\"display_name\": _(\"Default\"), \"value\": SHOWANSWER.DEFAULT},\n            {\"display_name\": _(\"Always\"), \"value\": SHOWANSWER.ALWAYS},\n            {\"display_name\": _(\"Answered\"), \"value\": SHOWANSWER.ANSWERED},\n            {\"display_name\": _(\"Attempted or Past Due\"), \"value\": SHOWANSWER.ATTEMPTED},\n            {\"display_name\": _(\"Closed\"), \"value\": SHOWANSWER.CLOSED},\n            {\"display_name\": _(\"Finished\"), \"value\": SHOWANSWER.FINISHED},\n            {\"display_name\": _(\"Correct or Past Due\"), \"value\": SHOWANSWER.CORRECT_OR_PAST_DUE},\n            {\"display_name\": _(\"Past Due\"), \"value\": SHOWANSWER.PAST_DUE},\n            {\"display_name\": _(\"Never\"), \"value\": SHOWANSWER.NEVER},\n            {\"display_name\": _(\"After All Attempts\"), \"value\": SHOWANSWER.AFTER_ALL_ATTEMPTS},\n            {\"display_name\": _(\"After All Attempts or Correct\"), \"value\": SHOWANSWER.AFTER_ALL_ATTEMPTS_OR_CORRECT},\n            {\"display_name\": _(\"Attempted\"), \"value\": SHOWANSWER.ATTEMPTED_NO_PAST_DUE},\n        ],\n        enforce_type=True,\n    )\n\n    weight = Float(\n        display_name=_(\"Problem Weight\"),\n        help=_(\"Defines the number of points the problem is worth.\"),\n        scope=Scope.settings,\n        default=1,\n        enforce_type=True,\n    )\n\n    item_background_color = String(\n        display_name=_(\"Item background color\"),\n        help=_(\"The background color of draggable items in the problem (example: 'blue' or '#0000ff').\"),\n        scope=Scope.settings,\n        default=\"\",\n        enforce_type=True,\n    )\n\n    item_text_color = String(\n        display_name=_(\"Item text color\"),\n        help=_(\"Text color to use for draggable items (example: 'white' or '#ffffff').\"),\n        scope=Scope.settings,\n        default=\"\",\n        enforce_type=True,\n    )\n\n    max_items_per_zone = Integer(\n        display_name=_(\"Maximum items per zone\"),\n        help=_(\"This setting limits the number of items that can be dropped into a single zone.\"),\n        scope=Scope.settings,\n        default=None,\n        enforce_type=True,\n    )\n\n    data = Dict(\n        display_name=_(\"Problem data\"),\n        help=_(\n            \"Information about zones, items, feedback, explanation and background image for this problem. \"\n            \"This information is derived from the input that a course author provides via the interactive editor \"\n            \"when configuring the problem.\"\n        ),\n        scope=Scope.content,\n        default=DEFAULT_DATA,\n        enforce_type=True,\n    )\n\n    item_state = Dict(\n        help=_(\"Information about current positions of items that a learner has dropped on the target image.\"),\n        scope=Scope.user_state,\n        default={},\n        enforce_type=True,\n    )\n\n    attempts = Integer(\n        help=_(\"Number of attempts learner used\"),\n        scope=Scope.user_state,\n        default=0,\n        enforce_type=True,\n    )\n\n    completed = Boolean(\n        help=_(\"Indicates whether a learner has completed the problem at least once\"),\n        scope=Scope.user_state,\n        default=False,\n        enforce_type=True,\n    )\n\n    grade = Float(\n        help=_(\"DEPRECATED. Keeps maximum score achieved by student as a weighted value.\"),\n        scope=Scope.user_state,\n        default=0\n    )\n\n    raw_earned = Float(\n        help=_(\"Keeps maximum score achieved by student as a raw value between 0 and 1.\"),\n        scope=Scope.user_state,\n        default=0,\n        enforce_type=True,\n    )\n\n    raw_possible = Float(\n        help=_(\"Maximum score available of the problem as a raw value between 0 and 1.\"),\n        scope=Scope.user_state,\n        default=1,\n        enforce_type=True,\n    )\n\n    block_settings_key = 'drag-and-drop-v2'\n\n    @property\n    def score(self):\n        \"\"\"\n        Returns learners saved score.\n        \"\"\"\n        return Score(self.raw_earned, self.raw_possible)\n\n    def max_score(self):  # pylint: disable=no-self-use\n        \"\"\"\n        Return the problem's max score, which for DnDv2 always equals 1.\n        Required by the grading system in the LMS.\n        \"\"\"\n        return 1\n\n    def get_score(self):\n        \"\"\"\n        Returns user's current (saved) score for the problem as raw values.\n        \"\"\"\n        if self._get_raw_earned_if_set() is None:\n            self.raw_earned = self._learner_raw_score()\n        return Score(self.raw_earned, self.raw_possible)\n\n    def set_score(self, score):\n        \"\"\"\n        Sets the score on this block.\n        Takes a Score namedtuple containing a raw\n        score and possible max (for this block, we expect that this will\n        always be 1).\n        \"\"\"\n        self.raw_earned = score.raw_earned\n        self.raw_possible = score.raw_possible\n\n    def calculate_score(self):\n        \"\"\"\n        Returns a newly-calculated raw score on the problem for the learner\n        based on the learner's current state.\n        \"\"\"\n        return Score(self._learner_raw_score(), self.max_score())\n\n    def has_submitted_answer(self):\n        \"\"\"\n        Returns True if the user has made a submission.\n        \"\"\"\n        return self.fields['raw_earned'].is_set_on(self) or self.fields['grade'].is_set_on(self)\n\n    def weighted_grade(self):\n        \"\"\"\n        Returns the block's current saved grade multiplied by the block's\n        weight- the number of points earned by the learner.\n        \"\"\"\n        if self.raw_possible <= 0:\n            return None\n\n        if self.weight is None:\n            return self.raw_earned\n\n        weighted_earned = self.raw_earned * self.weight / self.raw_possible\n        return weighted_earned\n\n    def _learner_raw_score(self):\n        \"\"\"\n        Calculate raw score for learner submission.\n\n        As it is calculated as ratio of correctly placed (or left in bank in case of decoys) items to\n        total number of items, it lays in interval [0..1]\n        \"\"\"\n        correct_count, total_count = self._get_item_stats()\n        return correct_count / float(total_count)\n\n    @staticmethod\n    def _get_statici18n_js_url():\n        \"\"\"\n        Returns the Javascript translation file for the currently selected language, if any found by\n        `pkg_resources`\n        \"\"\"\n        lang_code = translation.get_language()\n        if not lang_code:\n            return None\n        text_js = 'public/js/translations/{lang_code}/text.js'\n        country_code = lang_code.split('-')[0]\n        for code in (translation.to_locale(lang_code), lang_code, country_code):\n            if pkg_resources.resource_exists(loader.module_name, text_js.format(lang_code=code)):\n                return text_js.format(lang_code=code)\n        return None\n\n    @XBlock.supports(\"multi_device\")  # Enable this block for use in the mobile app via webview\n    def student_view(self, context):\n        \"\"\"\n        Player view, displayed to the student\n        \"\"\"\n\n        fragment = Fragment()\n        fragment.add_content(loader.render_django_template('/templates/html/drag_and_drop.html',\n                                                           i18n_service=self.i18n_service))\n        css_urls = (\n            'public/css/drag_and_drop.css',\n        )\n        js_urls = [\n            'public/js/vendor/virtual-dom-1.3.0.min.js',\n            'public/js/drag_and_drop.js',\n        ]\n\n        statici18n_js_url = self._get_statici18n_js_url()\n        if statici18n_js_url:\n            js_urls.append(statici18n_js_url)\n\n        for css_url in css_urls:\n            fragment.add_css_url(self.runtime.local_resource_url(self, css_url))\n        for js_url in js_urls:\n            fragment.add_javascript_url(self.runtime.local_resource_url(self, js_url))\n\n        self.include_theme_files(fragment)\n\n        fragment.initialize_js('DragAndDropBlock', self.student_view_data())\n\n        return fragment\n\n    def student_view_data(self, context=None):\n        \"\"\"\n        Get the configuration data for the student_view.\n        The configuration is all the settings defined by the author, except for correct answers\n        and feedback.\n        \"\"\"\n\n        def items_without_answers():\n            \"\"\"\n            Removes feedback and answer from items\n            \"\"\"\n            items = copy.deepcopy(self.data.get('items', ''))\n            for item in items:\n                del item['feedback']\n                # Use item.pop to remove both `item['zone']` and `item['zones']`; we don't have\n                # a guarantee that either will be present, so we can't use `del`. Legacy instances\n                # will have `item['zone']`, while current versions will have `item['zones']`.\n                item.pop('zone', None)\n                item.pop('zones', None)\n                # Fall back on \"backgroundImage\" to be backward-compatible.\n                image_url = item.get('imageURL') or item.get('backgroundImage')\n                if image_url:\n                    item['expandedImageURL'] = self._expand_static_url(image_url)\n                else:\n                    item['expandedImageURL'] = ''\n                item['displayName'] = sanitize_html(item.get('displayName', ''))\n            return items\n\n        return {\n            \"block_id\": six.text_type(self.scope_ids.usage_id),\n            \"display_name\": sanitize_html(self.display_name),\n            \"type\": self.CATEGORY,\n            \"weight\": self.weight,\n            \"mode\": self.mode,\n            \"zones\": self.zones,\n            \"max_attempts\": self.max_attempts,\n            \"graded\": getattr(self, 'graded', False),\n            \"weighted_max_score\": self.max_score() * self.weight,\n            \"max_items_per_zone\": self.max_items_per_zone,\n            # SDK doesn't supply url_name.\n            \"url_name\": getattr(self, 'url_name', ''),\n            \"display_zone_labels\": self.data.get('displayLabels', False),\n            \"display_zone_borders\": self.data.get('displayBorders', False),\n            \"display_zone_borders_dragging\": self.data.get('displayBordersDragging', False),\n            \"items\": items_without_answers(),\n            \"title\": sanitize_html(self.display_name),\n            \"show_title\": self.show_title,\n            \"problem_text\": sanitize_html(self.question_text),\n            \"show_problem_header\": self.show_question_header,\n            \"target_img_expanded_url\": self.target_img_expanded_url,\n            \"target_img_description\": self.target_img_description,\n            \"item_background_color\": self.item_background_color or None,\n            \"item_text_color\": self.item_text_color or None,\n            \"has_deadline_passed\": self.has_submission_deadline_passed,\n            \"answer_available\": self.is_answer_available,\n            # final feedback (data.feedback.finish) is not included - it may give away answers.\n        }\n\n    def studio_view(self, context):\n        \"\"\"\n        Editing view in Studio\n        \"\"\"\n        js_templates = loader.load_unicode('/templates/html/js_templates.html')\n        # Get an 'id_suffix' string that is unique for this block.\n        # We append it to HTML element ID attributes to ensure multiple instances of the DnDv2 block\n        # on the same page don't share the same ID value.\n        # We avoid using ID attributes in preference to classes, but sometimes we still need IDs to\n        # connect 'for' and 'aria-describedby' attributes to the associated elements.\n        id_suffix = self._get_block_id()\n        js_templates = js_templates.replace('{{id_suffix}}', id_suffix)\n        context = {\n            'js_templates': js_templates,\n            'id_suffix': id_suffix,\n            'fields': self.fields,\n            'showanswer_set': self._field_data.has(self, 'showanswer'),  # If false, we're using an inherited value.\n            'self': self,\n            'data': six.moves.urllib.parse.quote(json.dumps(self.data)),\n        }\n\n        fragment = Fragment()\n        fragment.add_content(loader.render_django_template('/templates/html/drag_and_drop_edit.html',\n                                                           context=context,\n                                                           i18n_service=self.i18n_service))\n        css_urls = (\n            'public/css/drag_and_drop_edit.css',\n        )\n        js_urls = [\n            'public/js/vendor/handlebars-v1.1.2.js',\n            'public/js/drag_and_drop_edit.js',\n        ]\n\n        statici18n_js_url = self._get_statici18n_js_url()\n        if statici18n_js_url:\n            js_urls.append(statici18n_js_url)\n\n        for css_url in css_urls:\n            fragment.add_css_url(self.runtime.local_resource_url(self, css_url))\n        for js_url in js_urls:\n            fragment.add_javascript_url(self.runtime.local_resource_url(self, js_url))\n\n        # Do a bit of manipulation so we get the appearance of a list of zone options on\n        # items that still have just a single zone stored\n\n        items = self.data.get('items', [])\n\n        for item in items:\n            zones = self.get_item_zones(item['id'])\n            # Note that we appear to be mutating the state of the XBlock here, but because\n            # the change won't be committed, we're actually just affecting the data that\n            # we're going to send to the client, not what's saved in the backing store.\n            item['zones'] = zones\n            item.pop('zone', None)\n\n        fragment.initialize_js('DragAndDropEditBlock', {\n            'data': self.data,\n            'target_img_expanded_url': self.target_img_expanded_url,\n            'default_background_image_url': self.default_background_image_url,\n        })\n\n        return fragment\n\n    @XBlock.json_handler\n    def studio_submit(self, submissions, suffix=''):\n        \"\"\"\n        Handles studio save.\n        \"\"\"\n        self.display_name = submissions['display_name']\n        self.mode = submissions['mode']\n        self.max_attempts = submissions['max_attempts']\n        if (showanswer := submissions['showanswer']) != self.showanswer:\n            self.showanswer = showanswer\n        if showanswer == SHOWANSWER.DEFAULT:\n            del self.showanswer\n        self.show_title = submissions['show_title']\n        self.question_text = submissions['problem_text']\n        self.show_question_header = submissions['show_problem_header']\n        self.weight = float(submissions['weight'])\n        self.item_background_color = submissions['item_background_color']\n        self.item_text_color = submissions['item_text_color']\n        self.max_items_per_zone = self._get_max_items_per_zone(submissions)\n        self.data = submissions['data']\n\n        return {\n            'result': 'success',\n        }\n\n    def _get_block_id(self):\n        \"\"\"\n        Return unique ID of this block. Useful for HTML ID attributes.\n        Works both in LMS/Studio and workbench runtimes:\n        - In LMS/Studio, use the location.html_id method.\n        - In the workbench, use the usage_id.\n        \"\"\"\n        if hasattr(self, 'location'):\n            return self.location.html_id()  # pylint: disable=no-member\n        else:\n            return six.text_type(self.scope_ids.usage_id)\n\n    @staticmethod\n    def _get_max_items_per_zone(submissions):\n        \"\"\"\n        Parses Max items per zone value coming from editor.\n\n        Returns:\n            * None if invalid value is passed (i.e. not an integer)\n            * None if value is parsed into zero or negative integer\n            * Positive integer otherwise.\n\n        Examples:\n            * _get_max_items_per_zone(None) -> None\n            * _get_max_items_per_zone('string') -> None\n            * _get_max_items_per_zone('-1') -> None\n            * _get_max_items_per_zone(-1) -> None\n            * _get_max_items_per_zone('0') -> None\n            * _get_max_items_per_zone('') -> None\n            * _get_max_items_per_zone('42') -> 42\n            * _get_max_items_per_zone(42) -> 42\n        \"\"\"\n        raw_max_items_per_zone = submissions.get('max_items_per_zone', None)\n\n        # Entries that aren't numbers should be treated as null. We assume that if we can\n        # turn it into an int, a number was submitted.\n        try:\n            max_attempts = int(raw_max_items_per_zone)\n            if max_attempts > 0:\n                return max_attempts\n            else:\n                return None\n        except (ValueError, TypeError):\n            return None\n\n    @XBlock.json_handler\n    def drop_item(self, item_attempt, suffix=''):\n        \"\"\"\n        Handles dropping item into a zone.\n        \"\"\"\n        self._validate_drop_item(item_attempt)\n\n        if self.mode == Constants.ASSESSMENT_MODE:\n            return self._drop_item_assessment(item_attempt)\n        elif self.mode == Constants.STANDARD_MODE:\n            return self._drop_item_standard(item_attempt)\n        else:\n            raise JsonHandlerError(\n                500,\n                self.i18n_service.gettext(\"Unknown DnDv2 mode {mode} - course is misconfigured\").format(self.mode)\n            )\n\n    @XBlock.json_handler\n    def do_attempt(self, data, suffix=''):\n        \"\"\"\n        Checks submitted solution and returns feedback.\n\n        Raises:\n             * JsonHandlerError with 400 error code in standard mode.\n             * JsonHandlerError with 409 error code if no more attempts left\n        \"\"\"\n        self._validate_do_attempt()\n\n        self.attempts += 1\n        # pylint: disable=fixme\n        # TODO: Refactor this method to \"freeze\" item_state and pass it to methods that need access to it.\n        # These implicit dependencies between methods exist because most of them use `item_state` or other\n        # fields, either as an \"input\" (i.e. read value) or as output (i.e. set value) or both. As a result,\n        # incorrect order of invocation causes issues:\n        self._mark_complete_and_publish_grade()  # must happen before _get_feedback - sets grade\n        correct = self.is_correct  # must happen before manipulating item_state - reads item_state\n\n        overall_feedback_msgs, misplaced_ids = self._get_feedback(include_item_feedback=True)\n\n        misplaced_items = []\n        for item_id in misplaced_ids:\n            # Don't delete misplaced item states on the final attempt.\n            if self.attempts_remain:\n                del self.item_state[item_id]\n            misplaced_items.append(self._get_item_definition(int(item_id)))\n\n        feedback_msgs = [FeedbackMessage(item['feedback']['incorrect'], None) for item in misplaced_items]\n        return {\n            'correct': correct,\n            'attempts': self.attempts,\n            'grade': self._get_weighted_earned_if_set(),\n            'misplaced_items': list(misplaced_ids),\n            'feedback': self._present_feedback(feedback_msgs),\n            'overall_feedback': self._present_feedback(overall_feedback_msgs),\n            \"answer_available\": self.is_answer_available,\n        }\n\n    @XBlock.json_handler\n    def publish_event(self, data, suffix=''):\n        \"\"\"\n        Handler to publish XBlock event from frontend\n        \"\"\"\n        try:\n            event_type = data.pop('event_type')\n        except KeyError:\n            return {'result': 'error', 'message': 'Missing event_type in JSON data'}\n\n        self.runtime.publish(self, event_type, data)\n        return {'result': 'success'}\n\n    @XBlock.json_handler\n    def reset(self, data, suffix=''):\n        \"\"\"\n        Resets problem to initial state\n        \"\"\"\n        self.item_state = {}\n        return self._get_user_state()\n\n    @XBlock.json_handler\n    def show_answer(self, data, suffix=''):\n        \"\"\"\n        Returns correct answer in assessment mode.\n\n        Raises:\n             * JsonHandlerError with 400 error code in standard mode.\n             * JsonHandlerError with 409 error code if the answer is unavailable.\n        \"\"\"\n        if self.mode != Constants.ASSESSMENT_MODE:\n            raise JsonHandlerError(\n                400,\n                self.i18n_service.gettext(\"show_answer handler should only be called for assessment mode\")\n            )\n        if not self.is_answer_available:\n            raise JsonHandlerError(\n                409,\n                self.i18n_service.gettext(\"The answer is unavailable\")\n            )\n\n        answer = self._get_correct_state()\n\n        if explanation := self.data.get('explanation', '').strip():\n            if replace_urls_service := self.runtime.service(self, 'replace_urls'):\n                explanation = replace_urls_service.replace_urls(explanation)\n\n            # pylint: disable=fixme\n            # TODO: No longer needed after Maple.\n            else:\n                try:\n                    explanation = self.runtime.replace_urls(explanation)\n                    explanation = self.runtime.replace_course_urls(explanation)\n                    explanation = self.runtime.replace_jump_to_id_urls(explanation)\n                except (TypeError, AttributeError):\n                    logger.debug('Unable to perform URL substitution on the explanation: %s', explanation)\n\n            answer['explanation'] = sanitize_html(explanation)\n        return answer\n\n    @XBlock.json_handler\n    def expand_static_url(self, url, suffix=''):\n        \"\"\" AJAX-accessible handler for expanding URLs to static [image] files \"\"\"\n        return {'url': self._expand_static_url(url)}\n\n    @property\n    def i18n_service(self):\n        \"\"\" Obtains translation service \"\"\"\n        i18n_service = self.runtime.service(self, \"i18n\")\n        if i18n_service:\n            return i18n_service\n        else:\n            return DummyTranslationService()\n\n    @property\n    def target_img_expanded_url(self):\n        \"\"\" Get the expanded URL to the target image (the image items are dragged onto). \"\"\"\n        if self.data.get(\"targetImg\"):\n            return self._expand_static_url(self.data[\"targetImg\"])\n        else:\n            return self.default_background_image_url\n\n    @property\n    def target_img_description(self):\n        \"\"\" Get the description for the target image (the image items are dragged onto). \"\"\"\n        return self.data.get(\"targetImgDescription\", \"\")\n\n    @property\n    def default_background_image_url(self):\n        \"\"\" The URL to the default background image, shown when no custom background is used \"\"\"\n        return self.runtime.local_resource_url(self, \"public/img/triangle.png\")\n\n    @property\n    def attempts_remain(self):\n        \"\"\"\n        Checks if current student still have more attempts.\n        \"\"\"\n        return self.max_attempts is None or self.max_attempts == 0 or self.attempts < self.max_attempts\n\n    @property\n    def has_submission_deadline_passed(self):\n        \"\"\"\n        Returns a boolean indicating if the submission is past its deadline.\n\n        Using the `has_deadline_passed` method from InheritanceMixin which gets\n        added on the LMS/Studio, return if the submission is past its due date.\n        If the method not found, which happens for pure DragAndDropXblock,\n        return False which makes sure submission checks don't affect other\n        functionality.\n        \"\"\"\n        if hasattr(self, \"has_deadline_passed\"):\n            return self.has_deadline_passed()  # pylint: disable=no-member\n        else:\n            return False\n\n    @property\n    def closed(self):\n        \"\"\"\n        Is the student still allowed to submit answers?\n        \"\"\"\n        if not self.attempts_remain:\n            return True\n        if self.has_submission_deadline_passed:\n            return True\n\n        return False\n\n    @property\n    def is_attempted(self):\n        \"\"\"\n        Has the problem been attempted?\n        \"\"\"\n        return self.attempts > 0\n\n    @property\n    def is_finished(self):\n        \"\"\"\n        Returns True if answer is closed or answer is correct.\n        \"\"\"\n        return self.closed or self.is_correct\n\n    @property\n    def is_answer_available(self):\n        \"\"\"\n        Is student allowed to see an answer?\n        \"\"\"\n        permission_functions = {\n            SHOWANSWER.NEVER: lambda: False,\n            SHOWANSWER.ATTEMPTED: lambda: self.is_attempted or self.has_submission_deadline_passed,\n            SHOWANSWER.ANSWERED: lambda: self.is_correct,\n            SHOWANSWER.CLOSED: lambda: self.closed,\n            SHOWANSWER.FINISHED: lambda: self.is_finished,\n            SHOWANSWER.CORRECT_OR_PAST_DUE: lambda: self.is_correct or self.has_submission_deadline_passed,\n            SHOWANSWER.PAST_DUE: lambda: self.has_submission_deadline_passed,\n            SHOWANSWER.ALWAYS: lambda: True,\n            SHOWANSWER.AFTER_ALL_ATTEMPTS: lambda: not self.attempts_remain,\n            SHOWANSWER.AFTER_ALL_ATTEMPTS_OR_CORRECT: lambda: not self.attempts_remain or self.is_correct,\n            SHOWANSWER.ATTEMPTED_NO_PAST_DUE: lambda: self.is_attempted,\n        }\n\n        if self.mode != Constants.ASSESSMENT_MODE:\n            return False\n\n        user_is_staff = False\n        if user_service := self.runtime.service(self, 'user'):\n            user_is_staff = user_service.get_current_user().opt_attrs.get(Constants.ATTR_KEY_USER_IS_STAFF)\n\n        if self.showanswer not in [SHOWANSWER.NEVER, ''] and user_is_staff:\n            # Staff users can see the answer unless the problem explicitly prevents it.\n            return True\n\n        check_permissions_function = permission_functions.get(self.showanswer, lambda: False)\n        return check_permissions_function()\n\n    @XBlock.handler\n    def student_view_user_state(self, request, suffix=''):\n        \"\"\" GET all user-specific data, and any applicable feedback \"\"\"\n        data = self._get_user_state()\n        return webob.Response(body=json.dumps(data).encode('utf-8'), content_type='application/json')\n\n    def _validate_do_attempt(self):\n        \"\"\"\n        Validates if `do_attempt` handler should be executed\n        \"\"\"\n        if self.mode != Constants.ASSESSMENT_MODE:\n            raise JsonHandlerError(\n                400,\n                self.i18n_service.gettext(\"do_attempt handler should only be called for assessment mode\")\n            )\n        if not self.attempts_remain:\n            raise JsonHandlerError(\n                409,\n                self.i18n_service.gettext(\"Max number of attempts reached\")\n            )\n        if self.has_submission_deadline_passed:\n            raise JsonHandlerError(\n                409,\n                self.i18n_service.gettext(\"Submission deadline has passed.\")\n            )\n\n    def _get_feedback(self, include_item_feedback=False):\n        \"\"\"\n        Builds overall feedback for both standard and assessment modes\n        \"\"\"\n        answer_correctness = self._answer_correctness()\n\n        if self.mode == Constants.STANDARD_MODE or not self.attempts:\n            if answer_correctness == self.SOLUTION_CORRECT:\n                feedback_key = 'finish'\n                message_class = FeedbackMessages.MessageClasses.FINAL_FEEDBACK\n            else:\n                feedback_key = 'start'\n                message_class = FeedbackMessages.MessageClasses.INITIAL_FEEDBACK\n            return [FeedbackMessage(self.data['feedback'][feedback_key], message_class)], set()\n\n        items = self._get_item_raw_stats()\n        missing_ids = items.required - items.placed\n        misplaced_ids = items.placed - items.correctly_placed\n\n        feedback_msgs = []\n\n        def _add_msg_if_exists(ids_list, message_template, message_class):\n            \"\"\" Adds message to feedback messages if corresponding items list is not empty \"\"\"\n            if ids_list:\n                message = message_template(len(ids_list), self.i18n_service.ngettext)\n                feedback_msgs.append(FeedbackMessage(message, message_class))\n\n        if self.item_state or include_item_feedback:\n            _add_msg_if_exists(\n                items.correctly_placed,\n                FeedbackMessages.correctly_placed,\n                FeedbackMessages.MessageClasses.CORRECTLY_PLACED\n            )\n\n            # Misplaced items are not returned to the bank on the final attempt.\n            if self.attempts_remain:\n                misplaced_template = FeedbackMessages.misplaced_returned\n            else:\n                misplaced_template = FeedbackMessages.misplaced\n\n            _add_msg_if_exists(misplaced_ids, misplaced_template, FeedbackMessages.MessageClasses.MISPLACED)\n            _add_msg_if_exists(missing_ids, FeedbackMessages.not_placed, FeedbackMessages.MessageClasses.NOT_PLACED)\n\n        grade_feedback_class = self.GRADE_FEEDBACK_CLASSES.get(answer_correctness, None)\n\n        if self.weight > 0:\n            if self.attempts_remain:\n                grade_feedback_template = FeedbackMessages.GRADE_FEEDBACK_TPL\n            else:\n                grade_feedback_template = FeedbackMessages.FINAL_ATTEMPT_TPL\n\n            feedback_msgs.append(FeedbackMessage(\n                self.i18n_service.gettext(grade_feedback_template).format(score=self.weighted_grade()),\n                grade_feedback_class)\n            )\n\n        problem_feedback_class = None\n\n        if self.attempts_remain and (misplaced_ids or missing_ids):\n            problem_feedback_message = self.data['feedback']['start']\n            problem_feedback_class = FeedbackMessages.MessageClasses.INITIAL_FEEDBACK\n        else:\n            problem_feedback_message = self.data['feedback']['finish']\n            problem_feedback_class = FeedbackMessages.MessageClasses.FINAL_FEEDBACK\n\n        feedback_msgs.append(FeedbackMessage(problem_feedback_message, problem_feedback_class))\n\n        return feedback_msgs, misplaced_ids\n\n    @staticmethod\n    def _present_feedback(feedback_messages):\n        \"\"\"\n        Transforms feedback messages into format expected by frontend code\n        \"\"\"\n        return [\n            {\"message\": sanitize_html(msg.message), \"message_class\": msg.message_class}\n            for msg in feedback_messages\n            if msg.message\n        ]\n\n    def _drop_item_standard(self, item_attempt):\n        \"\"\"\n        Handles dropping item to a zone in standard mode.\n        \"\"\"\n        item = self._get_item_definition(item_attempt['val'])\n\n        is_correct = self._is_attempt_correct(item_attempt)  # Student placed item in a correct zone\n        if is_correct:  # In standard mode state is only updated when attempt is correct\n            self.item_state[str(item['id'])] = self._make_state_from_attempt(item_attempt, is_correct)\n\n        self._mark_complete_and_publish_grade()  # must happen before _get_feedback\n        self._publish_item_dropped_event(item_attempt, is_correct)\n\n        item_feedback_key = 'correct' if is_correct else 'incorrect'\n        item_feedback = FeedbackMessage(self._expand_static_url(item['feedback'][item_feedback_key]), None)\n        overall_feedback, __ = self._get_feedback()\n\n        return {\n            'correct': is_correct,\n            'grade': self._get_weighted_earned_if_set(),\n            'finished': self.is_correct,\n            'overall_feedback': self._present_feedback(overall_feedback),\n            'feedback': self._present_feedback([item_feedback])\n        }\n\n    def _drop_item_assessment(self, item_attempt):\n        \"\"\"\n        Handles dropping item into a zone in assessment mode\n        \"\"\"\n        if not self.attempts_remain:\n            raise JsonHandlerError(409, self.i18n_service.gettext(\"Max number of attempts reached\"))\n\n        item = self._get_item_definition(item_attempt['val'])\n        is_correct = self._is_attempt_correct(item_attempt)\n        if item_attempt['zone'] is None:\n            self.item_state.pop(str(item['id']), None)\n            self._publish_item_to_bank_event(item['id'], is_correct)\n        else:\n            # State is always updated in assessment mode to store intermediate item positions\n            self.item_state[str(item['id'])] = self._make_state_from_attempt(item_attempt, is_correct)\n            self._publish_item_dropped_event(item_attempt, is_correct)\n\n        return {}\n\n    def _validate_drop_item(self, item):\n        \"\"\"\n        Validates `drop_item` parameters. Assessment mode allows returning\n        items to the bank, so validation is unnecessary.\n        \"\"\"\n        if self.mode != Constants.ASSESSMENT_MODE:\n            zone = self._get_zone_by_uid(item['zone'])\n            if not zone:\n                raise JsonHandlerError(400, \"Item zone data invalid.\")\n\n    @staticmethod\n    def _make_state_from_attempt(attempt, correct):\n        \"\"\"\n        Converts \"attempt\" data coming from browser into \"state\" entry stored in item_state\n        \"\"\"\n        return {\n            'zone': attempt['zone'],\n            'correct': correct\n        }\n\n    def _mark_complete_and_publish_grade(self):\n        \"\"\"\n        Helper method to update `self.completed` and submit grade event if appropriate conditions met.\n        \"\"\"\n        # pylint: disable=fixme\n        # TODO: (arguable) split this method into \"clean\" functions (with no side effects and implicit state)\n        # This method implicitly depends on self.item_state (via is_correct and _learner_raw_score)\n        # and also updates self.raw_earned if some conditions are met. As a result this method implies some order of\n        # invocation:\n        # * it should be called after learner-caused updates to self.item_state is applied\n        # * it should be called before self.item_state cleanup is applied (i.e. returning misplaced items to item bank)\n        # * it should be called before any method that depends on self.raw_earned (i.e. self._get_feedback)\n\n        # Splitting it into a \"clean\" functions will allow to capture this implicit invocation order in caller method\n        # and help avoid bugs caused by invocation order violation in future.\n\n        # There's no going back from \"completed\" status to \"incomplete\"\n        self.completed = self.completed or self.is_correct or not self.attempts_remain\n\n        current_raw_earned = self._learner_raw_score()\n        # ... and from higher grade to lower\n        # if we have an old-style (i.e. unreliable) grade, override no matter what\n        saved_raw_earned = self._get_raw_earned_if_set()\n\n        current_raw_earned_is_greater = False\n        if current_raw_earned is None or saved_raw_earned is None:\n            current_raw_earned_is_greater = True\n\n        if current_raw_earned is not None and saved_raw_earned is not None and current_raw_earned > saved_raw_earned:\n            current_raw_earned_is_greater = True\n\n        if current_raw_earned is None or current_raw_earned_is_greater:\n            self.set_score(Score(current_raw_earned, self.max_score()))\n            self.publish_grade(self.score)\n\n        # and no matter what - emit progress event for current user\n        self.runtime.publish(self, \"progress\", {})\n\n    def _publish_item_dropped_event(self, attempt, is_correct):\n        \"\"\"\n        Publishes item dropped event.\n        \"\"\"\n        item = self._get_item_definition(attempt['val'])\n        # attempt should already be validated here - not doing the check for existing zone again\n        zone = self._get_zone_by_uid(attempt['zone'])\n\n        item_label = item.get(\"displayName\")\n        if not item_label:\n            item_label = item.get(\"imageURL\")\n\n        self.runtime.publish(self, 'edx.drag_and_drop_v2.item.dropped', {\n            'item': item_label,\n            'item_id': item['id'],\n            'location': zone.get(\"title\"),\n            'location_id': zone.get(\"uid\"),\n            'is_correct': is_correct,\n        })\n\n    def _publish_item_to_bank_event(self, item_id, is_correct):\n        \"\"\"\n        Publishes event when item moved back to the bank in assessment mode.\n        \"\"\"\n        item = self._get_item_definition(item_id)\n\n        item_label = item.get(\"displayName\")\n        if not item_label:\n            item_label = item.get(\"imageURL\")\n\n        self.runtime.publish(self, 'edx.drag_and_drop_v2.item.dropped', {\n            'item': item_label,\n            'item_id': item['id'],\n            'location': 'item bank',\n            'location_id': -1,\n            'is_correct': is_correct,\n        })\n\n    def publish_grade(self, score=None, only_if_higher=None):\n        \"\"\"\n        Publishes the student's current grade to the system as an event\n        \"\"\"\n        if not score:\n            score = self.score\n        self._publish_grade(score, only_if_higher)\n        return {'grade': self.score.raw_earned, 'max_grade': self.score.raw_possible}\n\n    def _is_attempt_correct(self, attempt):\n        \"\"\"\n        Check if the item was placed correctly.\n        \"\"\"\n        correct_zones = self.get_item_zones(attempt['val'])\n        if correct_zones == [] and attempt['zone'] is None and self.mode == Constants.ASSESSMENT_MODE:\n            return True\n        return attempt['zone'] in correct_zones\n\n    def _expand_static_url(self, url):\n        \"\"\"\n        This is required to make URLs like '/static/dnd-test-image.png' work (note: that is the\n        only portable URL format for static files that works across export/import and reruns).\n        This method is unfortunately a bit hackish since XBlock does not provide a low-level API\n        for this.\n        \"\"\"\n        if hasattr(self.runtime, 'replace_urls'):\n            url = self.runtime.replace_urls(u'\"{}\"'.format(url))[1:-1]\n        elif hasattr(self.runtime, 'course_id'):\n            # edX Studio uses a different runtime for 'studio_view' than 'student_view',\n            # and the 'studio_view' runtime doesn't provide the replace_urls API.\n            try:\n                from common.djangoapps.static_replace import replace_static_urls  # pylint: disable=import-error\n                url = replace_static_urls(u'\"{}\"'.format(url), None, course_id=self.runtime.course_id)[1:-1]\n            except ImportError:\n                pass\n        return url\n\n    def _get_user_state(self):\n        \"\"\" Get all user-specific data, and any applicable feedback \"\"\"\n        item_state = self._get_item_state()\n        # In assessment mode, we do not want to leak the correctness info for individual items to the frontend,\n        # so we remove \"correct\" from all items when in assessment mode.\n        if self.mode == Constants.ASSESSMENT_MODE:\n            for item in item_state.values():\n                del item[\"correct\"]\n\n        overall_feedback_msgs, __ = self._get_feedback()\n        if self.mode == Constants.STANDARD_MODE:\n            is_finished = self.is_correct\n        else:\n            is_finished = not self.attempts_remain\n\n        return {\n            'items': item_state,\n            'finished': is_finished,\n            'attempts': self.attempts,\n            'grade': self._get_weighted_earned_if_set(),\n            'overall_feedback': self._present_feedback(overall_feedback_msgs)\n        }\n\n    def _get_correct_state(self):\n        \"\"\"\n        Returns one of the possible correct states for the configured data.\n\n        Items dropped by user in the correct zones are retained in those zones.\n        Incorrect items are equally distributed among their correct zones (if more than one zone is correct).\n        \"\"\"\n        state = {}\n        items = copy.deepcopy(self.data.get('items', []))\n\n        zone_count = Counter()\n        correct_items = set()\n\n        def _get_preferred_zone(zone_count, zones):\n            \"\"\"\n            Returns the zone with the least number of items.\n            \"\"\"\n            preferred_zone = None\n            for zone in zones:\n                # Check if the current zone has the least number of items till now\n                if not preferred_zone or zone_count[preferred_zone] > zone_count[zone]:\n                    preferred_zone = zone\n\n            zone_count[preferred_zone] += 1\n            return preferred_zone\n\n        # Set states of all items dropped in correct zones\n        for item_id in self.item_state:\n            if self.item_state[item_id]['correct']:\n                state[item_id] = self.item_state[item_id]\n                correct_items.add(item_id)\n\n                zone = self.item_state[item_id]['zone']\n                zone_count[zone] += 1\n\n        # Set states of rest of the items\n        for item in items:\n            item_id = str(item['id'])\n            if item_id not in correct_items:\n                zones = item.get('zones')\n\n                # For backwards compatibility\n                if zones is None:\n                    zones = []\n                    zone = item.get('zone')\n                    if zone is not None and zone != 'none':\n                        zones.append(zone)\n\n                if zones:\n                    zone = _get_preferred_zone(zone_count, zones)\n                    state[item_id] = {\n                        'zone': zone,\n                        'correct': True,\n                    }\n\n        return {'items': state}\n\n    def _get_item_state(self):\n        \"\"\"\n        Returns a copy of the user item state.\n        Converts to a dict if data is stored in legacy tuple form.\n        \"\"\"\n\n        # IMPORTANT: this method should always return a COPY of self.item_state - it is called from\n        # student_view_user_state handler and the data it returns is manipulated there to hide\n        # correctness of items placed.\n        state = {}\n        migrator = StateMigration(self)\n\n        for item_id, item in six.iteritems(self.item_state):\n            state[item_id] = migrator.apply_item_state_migrations(item_id, item)\n\n        return state\n\n    def _get_item_definition(self, item_id):\n        \"\"\"\n        Returns definition (settings) for item identified by `item_id`.\n        \"\"\"\n        return next(i for i in self.data['items'] if i['id'] == item_id)\n\n    def get_item_zones(self, item_id):\n        \"\"\"\n        Returns a list of the zones that are valid options for the item.\n\n        If the item is configured with a list of zones, return that list. If\n        the item is configured with a single zone, encapsulate that zone's\n        ID in a list and return the list. If the item is not configured with\n        any zones, or if it's configured explicitly with no zones, return an\n        empty list.\n        \"\"\"\n        item = self._get_item_definition(item_id)\n        if item.get('zones') is not None:\n            return item.get('zones')\n        elif item.get('zone') is not None and item.get('zone') != 'none':\n            return [item.get('zone')]\n        else:\n            return []\n\n    @property\n    def zones(self):\n        \"\"\"\n        Get drop zone data, defined by the author.\n        \"\"\"\n        # Convert zone data from old to new format if necessary\n        migrator = StateMigration(self)\n        migrated_zones = []\n\n        for zone in self.data.get('zones', []):\n            result = migrator.apply_zone_migrations(zone)\n            result['title'] = sanitize_html(result.get('title', ''))\n            migrated_zones.append(result)\n\n        return migrated_zones\n\n    def _get_zone_by_uid(self, uid):\n        \"\"\"\n        Given a zone UID, return that zone, or None.\n        \"\"\"\n        for zone in self.zones:\n            if zone[\"uid\"] == uid:\n                return zone\n        return None\n\n    def _get_item_stats(self):\n        \"\"\"\n        Returns a tuple representing the number of correctly placed items,\n        and the total number of items required (including decoy items).\n        \"\"\"\n        items = self._get_item_raw_stats()\n\n        correct_count = len(items.correctly_placed)\n        total_count = len(items.required)\n\n        if hasattr(self.runtime, 'course_id') and \\\n                get_grading_ignore_decoys_waffle_flag().is_enabled(self.runtime.course_id):\n            return correct_count, total_count\n\n        correct_count += len(items.decoy_in_bank)\n        total_count += len(items.decoy)\n\n        return correct_count, total_count\n\n    def _get_item_raw_stats(self):\n        \"\"\"\n        Returns a named tuple containing required, decoy, placed, correctly\n        placed, and correctly unplaced decoy items.\n\n        Returns:\n            namedtuple: (required, placed, correctly_placed, decoy, decoy_in_bank)\n                * required - IDs of items that must be placed on the board\n                * placed - IDs of items actually placed on the board\n                * correctly_placed - IDs of items that were placed correctly\n                * decoy - IDs of decoy items\n                * decoy_in_bank - IDs of decoy items that were unplaced\n        \"\"\"\n        item_state = self._get_item_state()\n\n        all_items = set(str(item['id']) for item in self.data['items'])\n        required = set(item_id for item_id in all_items if self.get_item_zones(int(item_id)) != [])\n        placed = set(item_id for item_id in all_items if item_id in item_state)\n        correctly_placed = set(item_id for item_id in placed if item_state[item_id]['correct'])\n        decoy = all_items - required\n        decoy_in_bank = set(item_id for item_id in decoy if item_id not in item_state)\n\n        return ItemStats(required, placed, correctly_placed, decoy, decoy_in_bank)\n\n    def _get_raw_earned_if_set(self):\n        \"\"\"\n        Returns student's grade if already explicitly set, otherwise returns None.\n        This is different from self.raw_earned which returns 0 by default.\n        \"\"\"\n        if self.fields['raw_earned'].is_set_on(self):\n            return self.raw_earned\n        else:\n            return None\n\n    def _get_weighted_earned_if_set(self):\n        \"\"\"\n        Returns student's grade with the problem weight applied if set, otherwise\n        None.\n        \"\"\"\n        if self.fields['raw_earned'].is_set_on(self):\n            return self.weighted_grade()\n        else:\n            return None\n\n    def _answer_correctness(self):\n        \"\"\"\n        Checks answer correctness:\n\n        Returns:\n            string: Correct/Incorrect/Partial\n                * Correct: All items are at their correct place.\n                * Partial: Some items are at their correct place.\n                * Incorrect: None items are at their correct place.\n        \"\"\"\n        correct_count, total_count = self._get_item_stats()\n        if correct_count == total_count:\n            return self.SOLUTION_CORRECT\n        elif correct_count == 0:\n            return self.SOLUTION_INCORRECT\n        else:\n            return self.SOLUTION_PARTIAL\n\n    @property\n    def is_correct(self):\n        \"\"\"\n        Helper - checks if answer is correct\n\n        Returns:\n            bool: True if current answer is correct\n        \"\"\"\n        return self._answer_correctness() == self.SOLUTION_CORRECT\n\n    @staticmethod\n    def workbench_scenarios():\n        \"\"\"\n        A canned scenario for display in the workbench.\n        \"\"\"\n        return [\n            (\n                \"Drag-and-drop-v2 standard\",\n                \"<vertical_demo><drag-and-drop-v2/></vertical_demo>\"\n            ),\n            (\n                \"Drag-and-drop-v2 assessment\",\n                \"<vertical_demo><drag-and-drop-v2 mode='assessment' max_attempts='3'/></vertical_demo>\"\n            ),\n        ]\n\n    def index_dictionary(self):\n        \"\"\"\n        Return dictionary prepared with module content and type for indexing.\n        \"\"\"\n        # return key/value fields in a Python dict object\n        # values may be numeric / string or dict\n        # default implementation is an empty dict\n\n        xblock_body = super(DragAndDropBlock, self).index_dictionary()\n\n        zones_display_names = {\n            \"zone_{}_display_name\".format(zone_i):\n                _clean_data(zone.get(\"title\", \"\"))\n            for zone_i, zone in enumerate(self.data.get(\"zones\", []))\n        }\n\n        zones_description = {\n            \"zone_{}_description\".format(zone_i):\n                _clean_data(zone.get(\"description\", \"\"))\n            for zone_i, zone in enumerate(self.data.get(\"zones\", []))\n        }\n\n        items_display_names = {\n            \"item_{}_display_name\".format(item_i):\n                _clean_data(item.get(\"displayName\", \"\"))\n            for item_i, item in enumerate(self.data.get(\"items\", []))\n        }\n\n        items_image_description = {\n            \"item_{}_image_description\".format(item_i):\n                _clean_data(item.get(\"imageDescription\", \"\"))\n            for item_i, item in enumerate(self.data.get(\"items\", []))\n        }\n\n        index_body = {\n            \"display_name\": self.display_name,\n            \"question_text\": _clean_data(self.question_text),\n            \"background_image_description\": self.data.get(\"targetImgDescription\", \"\"),\n        }\n        index_body.update(items_display_names)\n        index_body.update(items_image_description)\n        index_body.update(zones_display_names)\n        index_body.update(zones_description)\n\n        if \"content\" in xblock_body:\n            xblock_body[\"content\"].update(index_body)\n        else:\n            xblock_body[\"content\"] = index_body\n\n        xblock_body[\"content_type\"] = \"Drag and Drop\"\n\n        return xblock_body\n", "function DragAndDropEditBlock(runtime, element, params) {\n\n    var gettext;\n    var ngettext;\n    if ('DragAndDropI18N' in window) {\n        // Use DnDv2's local translations\n        gettext = function(string) {\n            var translated = window.DragAndDropI18N.gettext(string);\n            // if DnDv2's translation is the same as the input, check if global has a different value\n            // This is useful for overriding the XBlock's string by themes (only for English)\n            if (string === translated && 'gettext' in window) {\n                translated = window.gettext(string);\n            }\n            return translated;\n        };\n        ngettext = function(strA, strB, n) {\n            var translated = window.DragAndDropI18N.ngettext(strA, strB, n);\n            var string = n === 1 ? strA : strB;\n            if (string === translated && 'ngettext' in window) {\n                translated = window.ngettext(strA, strB, n);\n            }\n            return translated;\n        };\n    } else if ('gettext' in window) {\n        // Use edxapp's global translations\n        gettext = window.gettext;\n    }\n    if (typeof gettext == \"undefined\") {\n        // No translations -- used by test environment\n        gettext = function(string) { return string; };\n    }\n\n    if (typeof ngettext == \"undefined\") {\n        // No translations -- used by test environment\n        ngettext = function(string, plural, num) { return num == 1 ? string : plural; };\n    }\n\n    // Make gettext available in Handlebars templates\n    Handlebars.registerHelper('i18n', gettext);\n    // Numeric rounding in Handlebars templates\n    Handlebars.registerHelper('singleDecimalFloat', function(value) {\n        if (value === \"\" || isNaN(Number(value))) {\n            return \"\";\n        }\n        return Number(value).toFixed(Number(value) == parseInt(value) ? 0 : 1);\n    });\n    Handlebars.registerHelper('ifeq', function(v1, v2, options) {\n      if (v1 === v2) {\n        return options.fn(this);\n      }\n      return options.inverse(this);\n    });\n\n    var $element = $(element);\n\n    var dragAndDrop = (function($) {\n        var _fn = {\n            // Templates\n            tpl: {\n                init: function() {\n                    _fn.tpl = {\n                        zoneInput: Handlebars.compile($(\".zone-input-tpl\", element).html()),\n                        zoneElement: Handlebars.compile($(\".zone-element-tpl\", element).html()),\n                        zoneCheckbox: Handlebars.compile($(\".zone-checkbox-tpl\", element).html()),\n                        itemInput: Handlebars.compile($(\".item-input-tpl\", element).html()),\n                        autozoneSvg: Handlebars.compile($(\".autozone-tpl\", element).html())\n                    };\n                }\n            },\n\n            build: {\n                $el: {\n                    feedback: {\n                        form: $('.drag-builder .feedback-form', element),\n                        tab: $('.drag-builder .feedback-tab', element)\n                    },\n                    zones: {\n                        form: $('.drag-builder .zones-form', element),\n                        tab: $('.drag-builder .zones-tab', element)\n                    },\n                    items: {\n                        form: $('.drag-builder .items-form', element),\n                        tab: $('.drag-builder .items-tab', element)\n                    },\n                    targetImage: $('.drag-builder .target .target-img', element),\n                    zonesPreview: $('.drag-builder .target .zones-preview', element),\n                },\n                init: function() {\n                    _fn.data = params.data;\n\n                    // Compile templates\n                    _fn.tpl.init();\n\n                    // Display target image\n                    _fn.build.$el.targetImage.show();\n\n                    _fn.build.clickHandlers();\n\n                    // Hide settings that are specific to assessment mode\n                    _fn.build.$el.feedback.form.find('.problem-mode').trigger('change');\n\n                    // Check whether we're using an autogenerated image and fill related input values accordingly.\n                    _fn.build.initAutozoneInputs();\n\n                    // Set focus on first input field.\n                    $element.find('input:first').select();\n                },\n\n                validate: function() {\n                    var fields = $element.find('.tab').not('.hidden').find('input, textarea');\n                    var success = true;\n                    fields.each(function(index, field) {\n                        field = $(field);\n                        // Right now our only check is if a field is set or not.\n                        field.removeClass('field-error');\n                        if (! field[0].checkValidity()) {\n                            field.addClass('field-error');\n                            success = false;\n                        }\n                    });\n                    if (! success) {\n                        runtime.notify('error', {\n                            'title': gettext(\"There was an error with your form.\"),\n                            'message': gettext(\"Please check over your submission.\")\n                        });\n                    }\n                    return success\n                },\n\n                initAutozoneInputs: function() {\n                    var image_params = _fn.build.parseDataUriParams(params.target_img_expanded_url);\n                    var image_type = image_params.producer === 'dndv2' ? 'auto' : 'manual';\n                    var zone_tab = _fn.build.$el.zones.tab;\n                    var radio_selector = '.background-image-type input[value=' + image_type + ']';\n                    zone_tab.find(radio_selector).prop('checked', true).trigger('change');\n                    zone_tab.find('.autozone-layout-cols').val(image_params.cols || 3);\n                    zone_tab.find('.autozone-layout-rows').val(image_params.rows || 1);\n                    zone_tab.find('.autozone-size-width').val(image_params.zone_width || 200);\n                    zone_tab.find('.autozone-size-height').val(image_params.zone_height || 200);\n                },\n\n                // Examine the image src to determine whether the background image has been auto generated.\n                isAutogeneratedImage: function(src) {\n                    if (src && src.match(/^data:image\\/svg\\+xml/)) {\n                        if (_fn.build.parseDataUriParams(src).producer === 'dndv2') {\n                            return true;\n                        }\n                    }\n                    return false;\n                },\n\n                // When we auto generate a background image, we embed some parameters such as zone size and position\n                // into the generated data URI.\n                encodeDataUriParams: function(params) {\n                    var encoded = [];\n                    Object.keys(params).forEach(function(key) {\n                        var json = JSON.stringify(params[key]);\n                        encoded.push(encodeURIComponent(key) + '=' + encodeURIComponent(json));\n                    });\n                    return encoded.join(';');\n                },\n\n                parseDataUriParams: function(data_uri) {\n                    var params = {};\n                    var match = data_uri.match(/^data:image\\/svg\\+xml;([^,]+),/);\n                    if (match) {\n                        match[1].split(';').forEach(function(str) {\n                            var pair = str.split('=');\n                            if (pair.length === 2) {\n                                params[decodeURIComponent(pair[0])] = JSON.parse(decodeURIComponent(pair[1]));\n                            }\n                        });\n                    }\n                    return params;\n                },\n\n                scrollToTop: function() {\n                    $('.drag-builder', element).scrollTop(0);\n                },\n\n                clickHandlers: function() {\n                    var $fbkTab = _fn.build.$el.feedback.tab,\n                        $zoneTab = _fn.build.$el.zones.tab,\n                        $itemTab = _fn.build.$el.items.tab;\n\n                    var self = this;\n\n                    $element.one('click', '.continue-button', function loadSecondTab(e) {\n                        // $fbkTab -> $zoneTab\n\n                        e.preventDefault();\n\n                        if (!self.validate()) {\n                            $(e.target).one('click', loadSecondTab);\n                            return\n                        }\n\n                        _fn.build.form.feedback(_fn.build.$el.feedback.form);\n                        for (var i = 0; i < _fn.data.zones.length; i++) {\n                            _fn.build.form.zone.add(_fn.data.zones[i]);\n                        }\n                        if (_fn.data.zones.length === 0) {\n                            _fn.build.form.zone.add();\n                        }\n\n                        // Set the target image and bind its event handler:\n                        if (!_fn.build.isAutogeneratedImage(_fn.data.targetImg)) {\n                            $('.target-image-form .background-url', element).val(_fn.data.targetImg);\n                        }\n                        $('.target-image-form .background-description', element).val(_fn.data.targetImgDescription);\n                        _fn.build.$el.targetImage.load(_fn.build.form.zone.imageLoaded);\n                        _fn.build.$el.targetImage.attr('src', params.target_img_expanded_url);\n                        _fn.build.$el.targetImage.attr('alt', _fn.data.targetImgDescription);\n\n                        if (_fn.data.displayLabels) {\n                            $('.display-labels-form input', element).prop('checked', true);\n                        }\n\n                        if (_fn.data.displayBorders) {\n                            $('.display-borders-form input', element).prop('checked', true);\n                        }\n\n                        if (_fn.data.displayBordersDragging) {\n                            $('.display-borders-dragging-form input', element).prop('checked', true);\n                        }\n\n                        $fbkTab.addClass('hidden');\n                        $zoneTab.removeClass('hidden');\n                        self.scrollToTop();\n                        $zoneTab.find('input:first').select();\n\n                        $(this).one('click', function loadThirdTab(e) {\n                            // $zoneTab -> $itemTab\n                            e.preventDefault();\n\n                            if (!self.validate()) {\n                                $(e.target).one('click', loadThirdTab);\n                                return\n                            }\n\n                            for (var i = 0; i < _fn.data.items.length; i++) {\n                                _fn.build.form.item.add(_fn.data.items[i]);\n                            }\n                            if (_fn.data.items.length === 0) {\n                                _fn.build.form.item.add();\n                            }\n\n                            $zoneTab.addClass('hidden');\n                            $itemTab.removeClass('hidden');\n                            self.scrollToTop();\n                            $itemTab.find('input:first').select();\n\n                            $(this).addClass('hidden');\n                            $('.save-button', element).parent()\n                                .removeClass('hidden')\n                                .on('click', function submitForm(e) {\n                                    // $itemTab -> submit\n\n                                    e.preventDefault();\n                                    _fn.build.form.submit();\n                                });\n                        });\n                    });\n\n                    $fbkTab\n                        .on('change', '.problem-mode', _fn.build.form.problem.toggleAssessmentSettings);\n\n                    $fbkTab.on('change', '.showanswer', function () {\n                        _fn.build.$el.feedback.form.find('.showanswer-inherited').hide();\n                    });\n\n                    $zoneTab\n                        .on('change', '.background-image-type input', _fn.build.form.zone.toggleAutozoneSettings)\n                        .on('click', '.add-zone', function(e) {\n                            _fn.build.form.zone.add();\n                            // Set focus to first field of the new zone.\n                            $('.zones-form .zone-row:last input[type=text]:first', element).select();\n                        })\n                        .on('click', '.remove-zone', _fn.build.form.zone.remove)\n                        .on('input', '.zone-row input', _fn.build.form.zone.changedInputHandler)\n                        .on('change', '.zone-align-select', _fn.build.form.zone.changedInputHandler)\n                        .on('click', '.target-image-form .background-manual button', function(e) {\n                            var new_img_url = $.trim($('.target-image-form .background-url', element).val());\n                            if (new_img_url) {\n                                // We may need to 'expand' the URL before it will be valid.\n                                // e.g. '/static/blah.png' becomes '/asset-v1:course+id/blah.png'\n                                var handlerUrl = runtime.handlerUrl(element, 'expand_static_url');\n                                $.post(handlerUrl, JSON.stringify(new_img_url), function(result) {\n                                    _fn.build.$el.targetImage.attr('src', result.url);\n                                });\n                            } else {\n                                new_img_url = params.default_background_image_url;\n                                _fn.build.$el.targetImage.attr('src', new_img_url);\n                            }\n                            _fn.data.targetImg = new_img_url;\n                        })\n                        .on(\n                            'click',\n                            '.target-image-form .background-auto button',\n                            _fn.build.form.zone.generateBackgroundAndZones\n                        )\n                        .on('input', '.target-image-form .background-description', function(e) {\n                            var new_description = $.trim(\n                                $('.target-image-form .background-description', element).val()\n                            );\n                            _fn.build.$el.targetImage.attr('alt', new_description);\n                            _fn.data.targetImgDescription = new_description;\n                        })\n                        .on('click', '.display-labels-form input', function(e) {\n                            _fn.data.displayLabels = $('.display-labels-form input', element).is(':checked');\n                        })\n                        .on('click', '.display-borders-form input', function(e) {\n                            _fn.data.displayBorders = $('.display-borders-form input', element).is(':checked');\n                        })\n                        .on('click', '.display-borders-dragging-form input', function(e) {\n                            _fn.data.displayBordersDragging = $('.display-borders-dragging-form input', element).is(':checked');\n                        });\n\n                    $itemTab\n                        .on('click', '.add-item', function(e) {\n                            _fn.build.form.item.add();\n                            // Set focus to first field of the new item.\n                            $('.items-form .item:last input[type=text]:first', element).select();\n                        })\n                        .on('click', '.remove-item', _fn.build.form.item.remove)\n                        .on('click', '.advanced-link button', _fn.build.form.item.showAdvancedSettings)\n                        .on('input', '.item-image-url', _fn.build.form.item.imageURLChanged);\n                },\n                form: {\n                    problem: {\n                        toggleAssessmentSettings: function(e) {\n                            e.preventDefault();\n                            var $modeSetting = $(e.currentTarget),\n                                $problemForm = $modeSetting.closest('form'),\n                                $assessmentSettings = $problemForm.find('.assessment-setting');\n                            if ($modeSetting.val() === 'assessment') {\n                                $assessmentSettings.show();\n                            } else {\n                                $assessmentSettings.hide();\n                            }\n                        }\n                    },\n                    zone: {\n                        totalZonesCreated: 0, // This counter is used for HTML IDs. Never decremented.\n                        zoneObjects: [],\n                        toggleAutozoneSettings: function(e) {\n                            var element = _fn.build.$el.zones.tab;\n                            var value = element.find('.background-image-type input:checked').val();\n                            if (value === 'manual') {\n                                element.find('.background-manual').show();\n                                element.find('.background-auto').hide();\n                            } else {\n                                element.find('.background-auto').show();\n                                element.find('.background-manual').hide();\n                            }\n                        },\n                        getZoneObjByUID: function(uid) {\n                            for (var i = 0; i < _fn.build.form.zone.zoneObjects.length; i++) {\n                                if (_fn.build.form.zone.zoneObjects[i].uid == uid) {\n                                    return _fn.build.form.zone.zoneObjects[i];\n                                }\n                            }\n                        },\n                        add: function(oldZone) {\n                            if (!oldZone) oldZone = {};\n                            var num = _fn.build.form.zone.zoneObjects.length + 1;\n\n                            // Update zone obj\n                            var zoneObj = {\n                                title: gettext(oldZone.title) || ngettext('Zone {num}', 'Zone {num}', num).replace('{num}', num),\n                                description: gettext(oldZone.description),\n                                // uid: unique ID for this zone. For backwards compatibility,\n                                // this field cannot be called \"id\" and must inherit the \"title\"\n                                // property if no 'uid' value is present, since old versions of\n                                // this block used the title as the primary identifier.\n                                uid: oldZone.uid || oldZone.title || _fn.build.form.zone.generateUID(),\n                                width: oldZone.width || 200,\n                                height: oldZone.height || 100,\n                                x: oldZone.x || 0,\n                                y: oldZone.y || 0,\n                                align: oldZone.align || ''\n                            };\n\n                            _fn.build.form.zone.zoneObjects.push(zoneObj);\n\n                            // Add fields to zone form\n                            $zoneNode = $(_fn.tpl.zoneInput({\n                                zone: zoneObj,\n                                index: _fn.build.form.zone.totalZonesCreated++,\n                            }));\n                            _fn.build.$el.zones.form.append($zoneNode);\n                            _fn.build.form.zone.enableDelete();\n\n                            // Add zone div to target\n                            _fn.build.form.zone.renderZonesPreview();\n\n                        },\n                        generateUID: function() {\n                            // Generate a unique ID for a new zone.\n                            for (var i = 1; true; i++) {\n                                var uid = \"zone-\" + i;\n                                if (!_fn.build.form.zone.getZoneObjByUID(uid)) {\n                                    return uid;\n                                }\n                            }\n                        },\n                        remove: function(e) {\n                            var $el = $(e.currentTarget).closest('.zone-row'),\n                                classes = $el.attr('class'),\n                                id = classes.slice(classes.indexOf('zone-row') + 9),\n                                uid = String($el.data('uid')),  // cast to string since UID must be string but .data() converts data-uid=\"5\" to 5\n                                array_index;\n\n                            $el.detach();\n\n                            // Find the uid of the zone in the array and remove it.\n                            for (array_index = 0; array_index < _fn.build.form.zone.zoneObjects.length;\n                                 array_index++) {\n                                if (_fn.build.form.zone.zoneObjects[array_index].uid == uid) break;\n                            }\n                            _fn.build.form.zone.zoneObjects.splice(array_index, 1);\n                            _fn.build.form.zone.renderZonesPreview();\n\n                            _fn.build.form.zone.disableDelete();\n\n                        },\n                        enableDelete: function() {\n                            if (_fn.build.form.zone.zoneObjects.length > 1) {\n                                _fn.build.$el.zones.form.find('.remove-zone').removeClass('hidden');\n                            }\n                        },\n                        disableDelete: function() {\n                            if (_fn.build.form.zone.zoneObjects.length === 1) {\n                                _fn.build.$el.zones.form.find('.remove-zone').addClass('hidden');\n                            }\n                        },\n                        renderZonesPreview: function() {\n                            // Refresh the div which shows a preview of the zones over top of\n                            // the background image.\n                            _fn.build.$el.zonesPreview.html('');\n                            var imgWidth = _fn.build.$el.targetImage[0].naturalWidth;\n                            var imgHeight = _fn.build.$el.targetImage[0].naturalHeight;\n                            if (imgWidth == 0 || imgHeight == 0) {\n                                // Set a non-zero value to avoid divide-by-zero:\n                                imgWidth = imgHeight = 400;\n                            }\n                            this.zoneObjects.forEach(function(zoneObj) {\n                                _fn.build.$el.zonesPreview.append(\n                                    _fn.tpl.zoneElement({\n                                        uid: zoneObj.uid,\n                                        title: Handlebars.Utils.escapeExpression(gettext(zoneObj.title)),\n                                        description: Handlebars.Utils.escapeExpression(gettext(zoneObj.description)),\n                                        x_percent: (+zoneObj.x) / imgWidth * 100,\n                                        y_percent: (+zoneObj.y) / imgHeight * 100,\n                                        width_percent: (+zoneObj.width) / imgWidth * 100,\n                                        height_percent: (+zoneObj.height) / imgHeight * 100,\n                                        align: zoneObj.align\n                                    })\n                                );\n                            });\n                        },\n                        changedInputHandler: function(ev) {\n                            // Called when any of the inputs have changed.\n                            var $changedInput = $(ev.currentTarget);\n                            var $row = $changedInput.closest('.zone-row');\n                            var record = _fn.build.form.zone.getZoneObjByUID(String($row.data('uid')));\n                            if ($changedInput.hasClass('zone-title')) {\n                                record.title = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-width')) {\n                                record.width = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-description')) {\n                                record.description = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-height')) {\n                                record.height = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-x')) {\n                                record.x = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-y')) {\n                                record.y = $changedInput.val();\n                            } else if ($changedInput.hasClass('zone-align-select')) {\n                                record.align = $changedInput.val();\n                            }\n                            _fn.build.form.zone.renderZonesPreview();\n                        },\n                        imageLoaded: function() {\n                            // The target background image has loaded (or reloaded, if changed).\n                            _fn.build.form.zone.renderZonesPreview();\n                        },\n                        getAutozoneParams: function() {\n                            var element = _fn.build.$el.zones.tab.find('.background-auto');\n                            return {\n                                rows: parseInt(element.find('.autozone-layout-rows').val(), 10),\n                                cols: parseInt(element.find('.autozone-layout-cols').val(), 10),\n                                zone_width: parseInt(element.find('.autozone-size-width').val(), 10),\n                                zone_height: parseInt(element.find('.autozone-size-height').val(), 10),\n                                padding: 20\n                            };\n                        },\n                        validateAutozoneParams: function(params) {\n                            var fields = [\n                                '.autozone-layout-cols',\n                                '.autozone-layout-rows',\n                                '.autozone-size-width',\n                                '.autozone-size-height'\n                            ];\n                            var success = true;\n                            fields.forEach(function(field) {\n                                var element = _fn.build.$el.zones.tab.find(field);\n                                var val = element.val();\n                                var number = parseInt(element.val(), 10);\n                                // Make sure the user entered a positive integer number.\n                                if (number && number > 0 && String(number) === val) {\n                                    element.removeClass('field-error');\n                                } else {\n                                    element.addClass('field-error');\n                                    success = false;\n                                }\n                            });\n                            if (!success) {\n                                runtime.notify('error', {\n                                    'title': gettext(\"There was an error with your form.\"),\n                                    'message': gettext(\"Please check the values you entered.\")\n                                });\n                            }\n                            return success;\n                        },\n                        calculateAutozoneData: function(params) {\n                            var rows = params.rows;\n                            var cols = params.cols;\n                            var zone_width = params.zone_width;\n                            var zone_height = params.zone_height;\n                            var padding = params.padding;\n\n                            var width = (zone_width * cols) + (padding * (cols + 1));\n                            var height = (zone_height * rows) + (padding * (rows + 1));\n\n                            var zones = [];\n                            for (var row = 0; row < rows; row++) {\n                                for (var col = 0; col < cols; col++) {\n                                    zones.push({\n                                        width: zone_width,\n                                        height: zone_height,\n                                        x: (padding * (col + 1) + (col * zone_width)),\n                                        y: (padding * (row + 1) + (row * zone_height))\n                                    });\n                                }\n                            }\n\n                            return {\n                                width: width,\n                                height: height,\n                                zones: zones\n                            };\n                        },\n                        generateBackgroundDataUri: function(autozone_data, params) {\n                            var autozone_data = _fn.build.form.zone.calculateAutozoneData(params);\n                            var svg = _fn.tpl.autozoneSvg(autozone_data).trim();\n                            var data_uri_params = _fn.build.encodeDataUriParams({\n                                producer: 'dndv2',\n                                cols: params.cols,\n                                rows: params.rows,\n                                zone_width: params.zone_width,\n                                zone_height: params.zone_height\n                            });\n                            return 'data:image/svg+xml;' + data_uri_params + ',' + encodeURIComponent(svg);\n                        },\n                        generateZones: function(zones) {\n                            // First remove all existing zones.\n                            _fn.build.$el.zones.form.find('.zone-row').remove();\n                            _fn.build.form.zone.zoneObjects = [];\n                            // Now generate new zones.\n                            zones.forEach(function(zone) {\n                                _fn.build.form.zone.add({\n                                    width: zone.width,\n                                    height: zone.height,\n                                    x: zone.x,\n                                    y: zone.y,\n                                    align: 'center'\n                                });\n                            });\n                        },\n                        generateBackgroundAndZones: function() {\n                            var params = _fn.build.form.zone.getAutozoneParams();\n                            if (!_fn.build.form.zone.validateAutozoneParams(params)) {\n                                return;\n                            }\n                            var autozone_data = _fn.build.form.zone.calculateAutozoneData(params);\n                            // Generate zones.\n                            _fn.build.form.zone.generateZones(autozone_data.zones);\n                            // Set background img src.\n                            var data_uri = _fn.build.form.zone.generateBackgroundDataUri(autozone_data, params);\n                            _fn.data.targetImg = data_uri;\n                            _fn.build.$el.targetImage.attr('src', data_uri);\n                            // Make sure \"Display label names on the image\" is checked.\n                            _fn.data.displayLabels = true;\n                            $('.display-labels-form input', element).prop('checked', true);\n                        }\n                    },\n                    createCheckboxes: function(selectedZones) {\n                        var template = _fn.tpl.zoneCheckbox;\n                        var checkboxes = [];\n                        var zoneObjects = _fn.build.form.zone.zoneObjects;\n\n                        zoneObjects.forEach(function(zoneObj) {\n                            checkboxes.push(template({\n                                zoneUid: zoneObj.uid,\n                                title: gettext(zoneObj.title),\n                                checked: $.inArray(zoneObj.uid, selectedZones) !== -1 ? 'checked' : '',\n                            }));\n                        });\n\n                        var html = checkboxes.join('');\n                        return new Handlebars.SafeString(html);\n                    },\n                    feedback: function($form) {\n                        _fn.data.feedback = {\n                            start: $form.find('.intro-feedback').val(),\n                            finish: $form.find('.final-feedback').val()\n                        };\n                        _fn.data.explanation = $form.find('.explanation').val();\n                    },\n                    item: {\n                        count: 0,\n                        add: function(itemData) {\n                            var $form = _fn.build.$el.items.form,\n                                tpl = _fn.tpl.itemInput,\n                                ctx = {};\n\n                            if (itemData) {\n                                ctx = itemData;\n                                if (itemData.backgroundImage && !ctx.imageURL) {\n                                    ctx.imageURL = itemData.backgroundImage; // This field was renamed.\n                                }\n                                if (itemData.size && parseInt(itemData.size.width) > 0) {\n                                    // Convert old fixed pixel width setting values (hard to\n                                    // make mobile friendly) to new percentage format.\n                                    // Note itemData.size.width is a string like \"380px\" (it can\n                                    // also be \"auto\" but that's excluded by the if condition above)\n                                    var bgImgWidth = _fn.build.$el.targetImage[0].naturalWidth;\n                                    if (bgImgWidth > 0 && typeof ctx.widthPercent === \"undefined\") {\n                                        ctx.widthPercent = parseInt(itemData.size.width) / bgImgWidth * 100;\n                                    }\n                                    // Preserve the old-style data in case we need it again:\n                                    ctx.pixelWidth = itemData.size.width.substr(0, itemData.size.width.length - 2); // Remove 'px'\n                                }\n                                if (itemData.size && parseInt(itemData.size.height) > 0) {\n                                    // Item fixed pixel height is ignored in new versions of the\n                                    // block, but preserve the data in case we need it again:\n                                    ctx.pixelHeight = itemData.size.height.substr(0, itemData.size.height.length - 2); // Remove 'px'\n                                }\n                                ctx.noPadding = (ctx.noPadding) ? 'checked' : '';\n                            }\n                            ctx.checkboxes = _fn.build.form.createCheckboxes(ctx.zones);\n\n                            ctx.index = _fn.build.form.item.count++;\n                            $form.append(tpl(ctx));\n                            _fn.build.form.item.enableDelete();\n\n                        },\n                        remove: function(e) {\n                            var $el = $(e.currentTarget).closest('.item');\n\n                            $el.detach();\n\n                            _fn.build.form.item.count--;\n                            _fn.build.form.item.disableDelete();\n\n                        },\n                        imageURLChanged: function(e) {\n                            // Mark the image description field as required if (and only if) an image is specified.\n                            var $imageUrlField = $(e.currentTarget);\n                            var $descriptionField = $imageUrlField.closest('.item').find('.item-image-description');\n                            $descriptionField.prop(\"required\", $imageUrlField.val() != \"\");\n                        },\n                        enableDelete: function() {\n                            if (_fn.build.form.item.count > 1) {\n                                _fn.build.$el.items.form.find('.remove-item').removeClass('hidden');\n                            }\n                        },\n                        disableDelete: function() {\n                            if (_fn.build.form.item.count === 1) {\n                                _fn.build.$el.items.form.find('.remove-item').addClass('hidden');\n                            }\n                        },\n                        showAdvancedSettings: function(e) {\n                            var $el = $(e.currentTarget).closest('.item');\n                            $el.find('.row.advanced').show();\n                            $el.find('.row.advanced-link').hide();\n                        },\n                    },\n                    submit: function() {\n                        var items = [],\n                            $form = _fn.build.$el.items.form.find('.item');\n\n                        $form.each(function(i, el) {\n                            var $el = $(el),\n                                name = $el.find('.item-text').val(),\n                                imageURL = $el.find('.item-image-url').val(),\n                                imageDescription = $el.find('.item-image-description').val(),\n                                selectedZones = $el.find('.zone-checkbox:checked'),\n                                noPadding = $el.find('.img-checkbox').is(':checked');\n\n                            if (name.length > 0 || imageURL.length > 0) {\n                                var data = {\n                                    displayName: name,\n                                    zones: $.map(selectedZones, function(checkbox){\n                                        return checkbox.value;\n                                    }),\n                                    id: i,\n                                    feedback: {\n                                        correct: $el.find('.success-feedback').val(),\n                                        incorrect: $el.find('.error-feedback').val()\n                                    },\n                                    imageURL: imageURL,\n                                    imageDescription: imageDescription,\n                                    noPadding: (imageURL ? noPadding : false),\n                                };\n                                // Optional preferred width as a percentage of the bg image's width:\n                                var widthPercent = $el.find('.item-width').val();\n                                if (widthPercent && +widthPercent > 0) { data.widthPercent = widthPercent; }\n\n                                items.push(data);\n                            }\n                        });\n\n                        _fn.data.items = items;\n                        _fn.data.zones = _fn.build.form.zone.zoneObjects;\n\n                        var data = {\n                            'display_name': $element.find('.display-name').val(),\n                            'mode': $element.find(\".problem-mode\").val(),\n                            'max_attempts': $element.find(\".max-attempts\").val(),\n                            'showanswer': $element.find(\".showanswer\").val(),\n                            'show_title': $element.find('.show-title').is(':checked'),\n                            'weight': $element.find('.weight').val(),\n                            'problem_text': $element.find('.problem-text').val(),\n                            'show_problem_header': $element.find('.show-problem-header').is(':checked'),\n                            'item_background_color': $element.find('.item-background-color').val(),\n                            'item_text_color': $element.find('.item-text-color').val(),\n                            'max_items_per_zone': $element.find('.max-items-per-zone').val(),\n                            'data': _fn.data,\n                        };\n\n                        var handlerUrl = runtime.handlerUrl(element, 'studio_submit');\n                        runtime.notify('save', {state: 'start', message: gettext(\"Saving\")});\n                        $.post(handlerUrl, JSON.stringify(data), 'json').done(function(response) {\n                            if (response.result === 'success') {\n                                runtime.notify('save', {state: 'end'});\n                            } else {\n                                var message = response.messages.join(\", \");\n                                runtime.notify('error', {\n                                    'title': gettext(\"There was an error with your form.\"),\n                                    'message': message\n                                });\n                            }\n                        });\n                    }\n                }\n            },\n\n            data: null\n        };\n\n        return {\n            init: _fn.build.init\n        };\n    })(jQuery);\n\n    $element.find('.cancel-button').bind('click', function() {\n        runtime.notify('cancel', {});\n    });\n\n    dragAndDrop.init();\n}\n", "# -*- coding: utf-8 -*-\n\"\"\" Drag and Drop v2 XBlock - Utils \"\"\"\nfrom __future__ import absolute_import\n\nimport copy\nimport re\nfrom collections import namedtuple\n\nimport bleach\n\ntry:\n    from bleach.css_sanitizer import CSSSanitizer\nexcept (ImportError, ModuleNotFoundError):\n    # pylint: disable=fixme\n    # TODO: The bleach library changes the way CSS Styles are cleaned in version 5.0.0. The edx-platform uses version\n    #  4.1.0 in Maple, so this import is handled within a try block. This can be removed for the Nutmeg release.\n    CSSSanitizer = None\n\n\ndef _(text):\n    \"\"\" Dummy `gettext` replacement to make string extraction tools scrape strings marked for translation \"\"\"\n    return text\n\n\ndef ngettext_fallback(text_singular, text_plural, number):\n    \"\"\" Dummy `ngettext` replacement to make string extraction tools scrape strings marked for translation \"\"\"\n    if number == 1:\n        return text_singular\n    else:\n        return text_plural\n\n\ndef _clean_data(data):\n    \"\"\" Remove html tags and extra white spaces e.g newline, tabs etc from provided data \"\"\"\n    cleaner = bleach.Cleaner(tags=[], strip=True)\n    cleaned_text = \" \".join(re.split(r\"\\s+\", cleaner.clean(data), flags=re.UNICODE)).strip()\n    return cleaned_text\n\n\nALLOWED_TAGS = bleach.ALLOWED_TAGS + [\n    'br',\n    'caption',\n    'dd',\n    'del',\n    'div',\n    'dl',\n    'dt',\n    'h1',\n    'h2',\n    'h3',\n    'h4',\n    'h5',\n    'h6',\n    'hr',\n    'img',\n    'p',\n    'pre',\n    's',\n    'strike',\n    'span',\n    'sub',\n    'sup',\n    'table',\n    'tbody',\n    'td',\n    'tfoot',\n    'th',\n    'thead',\n    'tr',\n    'u',\n]\nALLOWED_ATTRIBUTES = {\n    '*': ['class', 'style', 'id'],\n    'a': ['href', 'title', 'target', 'rel'],\n    'abbr': ['title'],\n    'acronym': ['title'],\n    'audio': ['controls', 'autobuffer', 'autoplay', 'src'],\n    'img': ['src', 'alt', 'title', 'width', 'height'],\n    'table': ['border', 'cellspacing', 'cellpadding'],\n    'td': ['style', 'scope'],\n}\nALLOWED_STYLES = [\n    \"azimuth\",\n    \"background-color\",\n    \"border-bottom-color\",\n    \"border-collapse\",\n    \"border-color\",\n    \"border-left-color\",\n    \"border-right-color\",\n    \"border-top-color\",\n    \"clear\",\n    \"color\",\n    \"cursor\",\n    \"direction\",\n    \"display\",\n    \"elevation\",\n    \"float\",\n    \"font\",\n    \"font-family\",\n    \"font-size\",\n    \"font-style\",\n    \"font-variant\",\n    \"font-weight\",\n    \"height\",\n    \"letter-spacing\",\n    \"line-height\",\n    \"overflow\",\n    \"pause\",\n    \"pause-after\",\n    \"pause-before\",\n    \"pitch\",\n    \"pitch-range\",\n    \"richness\",\n    \"speak\",\n    \"speak-header\",\n    \"speak-numeral\",\n    \"speak-punctuation\",\n    \"speech-rate\",\n    \"stress\",\n    \"text-align\",\n    \"text-decoration\",\n    \"text-indent\",\n    \"unicode-bidi\",\n    \"vertical-align\",\n    \"voice-family\",\n    \"volume\",\n    \"white-space\",\n    \"width\",\n]\n\n\ndef sanitize_html(raw_body: str) -> str:\n    \"\"\"\n    Remove not allowed HTML tags to mitigate XSS vulnerabilities.\n    \"\"\"\n    bleach_options = dict(\n        tags=ALLOWED_TAGS,\n        protocols=bleach.ALLOWED_PROTOCOLS,\n        strip=True,\n        attributes=ALLOWED_ATTRIBUTES,\n    )\n    if CSSSanitizer:\n        bleach_options['css_sanitizer'] = CSSSanitizer()\n    else:\n        # pylint: disable=fixme\n        # TODO: This is maintaining backward compatibility with bleach 4.1.0 used in Maple release of edx-platform.\n        #  This can be removed for the Nutmeg release which uses bleach 5.0.0\n        bleach_options['styles'] = ALLOWED_STYLES\n\n    return bleach.clean(raw_body, **bleach_options)\n\n\nclass DummyTranslationService:\n    \"\"\"\n    Dummy drop-in replacement for i18n XBlock service\n    \"\"\"\n    gettext = _\n    ngettext = ngettext_fallback\n\n\nclass FeedbackMessages:\n    \"\"\"\n    Feedback messages collection\n    \"\"\"\n    class MessageClasses:\n        \"\"\"\n        Namespace for message classes\n        \"\"\"\n        CORRECT_SOLUTION = \"correct\"\n        PARTIAL_SOLUTION = \"partial\"\n        INCORRECT_SOLUTION = \"incorrect\"\n\n        CORRECTLY_PLACED = CORRECT_SOLUTION\n        MISPLACED = INCORRECT_SOLUTION\n        NOT_PLACED = INCORRECT_SOLUTION\n\n        INITIAL_FEEDBACK = \"initial\"\n        FINAL_FEEDBACK = \"final\"\n\n    GRADE_FEEDBACK_TPL = _('Your highest score is {score}')\n    FINAL_ATTEMPT_TPL = _('Final attempt was used, highest score is {score}')\n\n    @staticmethod\n    def correctly_placed(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"correctly placed items\" message\n        \"\"\"\n        return ngettext(\n            'Correctly placed {correct_count} item',\n            'Correctly placed {correct_count} items',\n            number\n        ).format(correct_count=number)\n\n    @staticmethod\n    def misplaced(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"misplaced items\" message\n        \"\"\"\n        return ngettext(\n            'Misplaced {misplaced_count} item',\n            'Misplaced {misplaced_count} items',\n            number\n        ).format(misplaced_count=number)\n\n    @staticmethod\n    def misplaced_returned(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"misplaced items returned to bank\" message\n        \"\"\"\n        return ngettext(\n            'Misplaced {misplaced_count} item (misplaced item was returned to the item bank)',\n            'Misplaced {misplaced_count} items (misplaced items were returned to the item bank)',\n            number\n        ).format(misplaced_count=number)\n\n    @staticmethod\n    def not_placed(number, ngettext=ngettext_fallback):\n        \"\"\"\n        Formats \"did not place required items\" message\n        \"\"\"\n        return ngettext(\n            'Did not place {missing_count} required item',\n            'Did not place {missing_count} required items',\n            number\n        ).format(missing_count=number)\n\n\nFeedbackMessage = namedtuple(\"FeedbackMessage\", [\"message\", \"message_class\"])  # pylint: disable=invalid-name\nItemStats = namedtuple(  # pylint: disable=invalid-name\n    'ItemStats',\n    [\"required\", \"placed\", \"correctly_placed\", \"decoy\", \"decoy_in_bank\"]\n)\n\n\nclass Constants:\n    \"\"\"\n    Namespace class for various constants\n    \"\"\"\n    ALLOWED_ZONE_ALIGNMENTS = ['left', 'right', 'center']\n    DEFAULT_ZONE_ALIGNMENT = 'center'\n\n    STANDARD_MODE = \"standard\"\n    ASSESSMENT_MODE = \"assessment\"\n    ATTR_KEY_USER_IS_STAFF = \"edx-platform.user_is_staff\"\n\n\nclass SHOWANSWER:\n    \"\"\"\n    Constants for when to show answer\n    \"\"\"\n    AFTER_ALL_ATTEMPTS = \"after_all_attempts\"\n    AFTER_ALL_ATTEMPTS_OR_CORRECT = \"after_all_attempts_or_correct\"\n    ALWAYS = \"always\"\n    ANSWERED = \"answered\"\n    ATTEMPTED = \"attempted\"\n    ATTEMPTED_NO_PAST_DUE = \"attempted_no_past_due\"\n    CLOSED = \"closed\"\n    CORRECT_OR_PAST_DUE = \"correct_or_past_due\"\n    DEFAULT = \"default\"\n    FINISHED = \"finished\"\n    NEVER = \"never\"\n    PAST_DUE = \"past_due\"\n\n\nclass StateMigration:\n    \"\"\"\n    Helper class to apply zone data and item state migrations\n    \"\"\"\n    def __init__(self, block):\n        self._block = block\n\n    @staticmethod\n    def _apply_migration(obj_id, obj, migrations):\n        \"\"\"\n        Applies migrations sequentially to a copy of an `obj`, to avoid updating actual data\n        \"\"\"\n        tmp = copy.deepcopy(obj)\n        for method in migrations:\n            tmp = method(obj_id, tmp)\n\n        return tmp\n\n    def apply_zone_migrations(self, zone):\n        \"\"\"\n        Applies zone migrations\n        \"\"\"\n        migrations = (self._zone_v1_to_v2, self._zone_v2_to_v2p1)\n        zone_id = zone.get('uid', zone.get('id'))\n\n        return self._apply_migration(zone_id, zone, migrations)\n\n    def apply_item_state_migrations(self, item_id, item_state):\n        \"\"\"\n        Applies item_state migrations\n        \"\"\"\n        migrations = (self._item_state_v1_to_v1p5, self._item_state_v1p5_to_v2, self._item_state_v2_to_v2p1)\n\n        return self._apply_migration(item_id, item_state, migrations)\n\n    @classmethod\n    def _zone_v1_to_v2(cls, unused_zone_id, zone):\n        \"\"\"\n        Migrates zone data from v1.0 format to v2.0 format.\n\n        Changes:\n        * v1 used zone \"title\" as UID, while v2 zone has dedicated \"uid\" property\n        * \"id\" and \"index\" properties are no longer used\n\n        In: {'id': 1, 'index': 2, 'title': \"Zone\", ...}\n        Out: {'uid': \"Zone\", ...}\n        \"\"\"\n        if \"uid\" not in zone:\n            zone[\"uid\"] = zone.get(\"title\")\n        zone.pop(\"id\", None)\n        zone.pop(\"index\", None)\n\n        return zone\n\n    @classmethod\n    def _zone_v2_to_v2p1(cls, unused_zone_id, zone):\n        \"\"\"\n        Migrates zone data from v2.0 to v2.1\n\n        Changes:\n        * Removed \"none\" zone alignment; default align is \"center\"\n\n        In: {\n            'uid': \"Zone\", \"align\": \"none\",\n            \"x_percent\": \"10%\", \"y_percent\": \"10%\", \"width_percent\": \"10%\", \"height_percent\": \"10%\"\n        }\n        Out: {\n            'uid': \"Zone\", \"align\": \"center\",\n            \"x_percent\": \"10%\", \"y_percent\": \"10%\", \"width_percent\": \"10%\", \"height_percent\": \"10%\"\n        }\n        \"\"\"\n        if zone.get('align', None) not in Constants.ALLOWED_ZONE_ALIGNMENTS:\n            zone['align'] = Constants.DEFAULT_ZONE_ALIGNMENT\n\n        return zone\n\n    @classmethod\n    def _item_state_v1_to_v1p5(cls, unused_item_id, item):\n        \"\"\"\n        Migrates item_state from v1.0 to v1.5\n\n        Changes:\n        * Item state is now a dict instead of tuple\n\n        In: ('100px', '120px')\n        Out: {'top': '100px', 'left': '120px'}\n        \"\"\"\n        if isinstance(item, dict):\n            return item\n        else:\n            return {'top': item[0], 'left': item[1]}\n\n    @classmethod\n    def _item_state_v1p5_to_v2(cls, unused_item_id, item):\n        \"\"\"\n        Migrates item_state from v1.5 to v2.0\n\n        Changes:\n        * Item placement attributes switched from absolute (left-top) to relative (x_percent-y_percent) units\n\n        In: {'zone': 'Zone\", 'correct': True, 'top': '100px', 'left': '120px'}\n        Out: {'zone': 'Zone\", 'correct': True, 'top': '100px', 'left': '120px'}\n        \"\"\"\n        # Conversion can't be made as parent dimensions are unknown to python - converted in JS\n        # Since 2.1 JS this conversion became unnecesary, so it was removed from JS code\n        return item\n\n    def _item_state_v2_to_v2p1(self, item_id, item):\n        \"\"\"\n        Migrates item_state from v2.0 to v2.1\n\n        * Single item can correspond to multiple zones - \"zone\" key is added to each item\n        * Assessment mode - \"correct\" key is added to each item\n        * Removed \"no zone align\" option; only automatic alignment is now allowed - removes attributes related to\n          \"absolute\" placement of an item (relative to background image, as opposed to the zone)\n        \"\"\"\n        self._multiple_zones_migration(item_id, item)\n        self._assessment_mode_migration(item)\n        self._automatic_alignment_migration(item)\n\n        return item\n\n    def _multiple_zones_migration(self, item_id, item):\n        \"\"\"\n        Changes:\n        * Adds \"zone\" attribute\n\n        In: {'item_id': 0}\n        Out: {'zone': 'Zone\", 'item_id\": 0}\n\n        In: {'item_id': 1}\n        Out: {'zone': 'unknown\", 'item_id\": 1}\n        \"\"\"\n        if item.get('zone') is None:\n            valid_zones = self._block.get_item_zones(int(item_id))\n            if valid_zones:\n                # If we get to this point, then the item was placed prior to support for\n                # multiple correct zones being added. As a result, it can only be correct\n                # on a single zone, and so we can trust that the item was placed on the\n                # zone with index 0.\n                item['zone'] = valid_zones[0]\n            else:\n                item['zone'] = 'unknown'\n\n    @classmethod\n    def _assessment_mode_migration(cls, item):\n        \"\"\"\n        Changes:\n        * Adds \"correct\" attribute if missing\n\n        In: {'item_id': 0}\n        Out: {'item_id': 'correct': True}\n\n        In: {'item_id': 0, 'correct': True}\n        Out: {'item_id': 'correct': True}\n\n        In: {'item_id': 0, 'correct': False}\n        Out: {'item_id': 'correct': False}\n        \"\"\"\n        # If correctness information is missing\n        # (because problem was completed before assessment mode was implemented),\n        # assume the item is in correct zone (in standard mode, only items placed\n        # into correct zone are stored in item state).\n        if item.get('correct') is None:\n            item['correct'] = True\n\n    @classmethod\n    def _automatic_alignment_migration(cls, item):\n        \"\"\"\n        Changes:\n        * Removed old \"absolute\" placement attributes\n        * Removed \"none\" zone alignment, making \"x_percent\" and \"y_percent\" attributes obsolete\n\n        In: {'zone': 'Zone\", 'correct': True, 'top': '100px', 'left': '120px', 'absolute': true}\n        Out: {'zone': 'Zone\", 'correct': True}\n\n        In: {'zone': 'Zone\", 'correct': True, 'x_percent': '90%', 'y_percent': '20%'}\n        Out: {'zone': 'Zone\", 'correct': True}\n        \"\"\"\n        attributes_to_remove = ['x_percent', 'y_percent', 'left', 'top', 'absolute']\n        for attribute in attributes_to_remove:\n            item.pop(attribute, None)\n\n        return item\n", "# -*- coding: utf-8 -*-\n\n# Imports ###########################################################\n\nimport os\nfrom setuptools import setup\n\n\n# Functions #########################################################\n\ndef package_data(pkg, root_list):\n    \"\"\"Generic function to find package_data for `pkg` under `root`.\"\"\"\n    data = []\n    for root in root_list:\n        for dirname, _, files in os.walk(os.path.join(pkg, root)):\n            for fname in files:\n                data.append(os.path.relpath(os.path.join(dirname, fname), pkg))\n\n    return {pkg: data}\n\n\n# Main ##############################################################\n\nsetup(\n    name='xblock-drag-and-drop-v2',\n    version='3.0.0',\n    description='XBlock - Drag-and-Drop v2',\n    packages=['drag_and_drop_v2'],\n    install_requires=[\n        'XBlock',\n        'xblock-utils',\n        'bleach',\n    ],\n    entry_points={\n        'xblock.v1': 'drag-and-drop-v2 = drag_and_drop_v2:DragAndDropBlock',\n    },\n    package_data=package_data(\"drag_and_drop_v2\", [\"static\", \"templates\", \"public\", \"translations\", \"locale\"]),\n)\n", "from .test_base import BaseIntegrationTest\n\n\nclass TestCustomDataDragAndDropRendering(BaseIntegrationTest):\n    PAGE_TITLE = 'Drag and Drop v2'\n    PAGE_ID = 'drag_and_drop_v2'\n\n    def setUp(self):\n        super(TestCustomDataDragAndDropRendering, self).setUp()\n\n        scenario_xml = self._get_custom_scenario_xml(\"data/test_html_data.json\")\n        self._add_scenario(self.PAGE_ID, self.PAGE_TITLE, scenario_xml)\n\n        self._page = self.go_to_page(self.PAGE_TITLE)\n\n        header1 = self.browser.find_element_by_css_selector('h1')\n        self.assertEqual(header1.text, 'XBlock: ' + self.PAGE_TITLE)\n\n    def test_items_rendering(self):\n        items = self._get_items()\n\n        self.assertEqual(len(items), 3)\n        self.assertIn('<b>1</b>', self.get_element_html(items[0]))\n        self.assertIn('<i>2</i>', self.get_element_html(items[1]))\n        self.assertIn('<span style=\"color: red;\">X</span>', self.get_element_html(items[2]))\n\n    def test_html_title_renders_properly(self):\n        \"\"\"\n        Tests HTML titles are rendered properly\n        \"\"\"\n        zones = self._get_zones()\n        self.assertEqual(u'Zone\\ndroppable\\nNo items placed here', zones[0].text)\n        self.assertNotEqual(u'Zone <sup>-1</sup>\\ndroppable\\nNo items placed here', zones[0].text)\n\n    def test_background_image(self):\n        bg_image = self.browser.find_element_by_css_selector(\".xblock--drag-and-drop .target-img\")\n        custom_image_url = (\n            \"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciI\"\n            \"HdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiBzdHlsZT0iYmFja2dyb3VuZDogI2VlZjsiPjwvc3ZnPg==\"\n        )\n        custom_image_description = \"This describes the target image\"\n        self.assertEqual(bg_image.get_attribute(\"src\"), custom_image_url)\n        self.assertEqual(bg_image.get_attribute(\"alt\"), custom_image_description)\n\n\nclass TestZoneTitleAsHTML(BaseIntegrationTest):\n    PAGE_TITLE = 'Drag and Drop v2'\n    PAGE_ID = 'drag_and_drop_v2'\n\n    def setUp(self):\n        super(TestZoneTitleAsHTML, self).setUp()\n\n        scenario_xml = self._get_custom_scenario_xml(\"data/test_html_titles_data.json\")\n        self._add_scenario(self.PAGE_ID, self.PAGE_TITLE, scenario_xml)\n\n        self._page = self.go_to_page(self.PAGE_TITLE)\n\n        header1 = self.browser.find_element_by_css_selector('h1')\n        self.assertEqual(header1.text, 'XBlock: ' + self.PAGE_TITLE)\n\n    def test_html_title_renders_properly(self):\n        \"\"\"\n        Tests HTML titles are rendered properly\n        \"\"\"\n        zones = self._get_zones()\n        self.assertEqual('Zone\\ndroppable\\nNo items placed here', zones[0].text)\n        self.assertNotEqual('Zone <sup>-1</sup>\\ndroppable\\nNo items placed here', zones[0].text)\n", "from __future__ import absolute_import\n\nfrom ddt import data, ddt, unpack\nfrom selenium.common.exceptions import NoSuchElementException\nfrom workbench import scenarios\n\nfrom .test_base import BaseIntegrationTest\n\n\n@ddt\nclass TestDragAndDropTitleAndProblem(BaseIntegrationTest):\n    @unpack\n    @data(\n        ('Plain text problem 1, header visible.', True),\n        ('Plain text problem 2, header hidden.', False),\n        ('Problem/instructions with <i>HTML</i> and header.', True),\n        ('<span style=\"color: red;\">Span problem, no header</span>', False),\n    )\n    def test_problem_parameters(self, problem_text, show_problem_header):\n        const_page_name = 'Test title and problem parameters'\n        const_page_id = 'test_block_title_and_problem'\n        scenario_xml = self._make_scenario_xml(\n            display_name=\"Title\",\n            show_title=True,\n            problem_text=problem_text,\n            show_problem_header=show_problem_header,\n        )\n        scenarios.add_xml_scenario(const_page_id, const_page_name, scenario_xml)\n        self.addCleanup(scenarios.remove_scenario, const_page_id)\n\n        page = self.go_to_page(const_page_name)\n        is_problem_header_visible = len(page.find_elements_by_css_selector('.problem > h4')) > 0\n        self.assertEqual(is_problem_header_visible, show_problem_header)\n\n        problem = page.find_element_by_css_selector('.problem > p')\n        self.assertEqual(self.get_element_html(problem), problem_text)\n\n    @unpack\n    @data(\n        ('plain shown', 'title1', True),\n        ('plain hidden', 'title2', False),\n        ('html shown', 'title with <i>HTML</i>', True),\n        ('html hidden', '<span style=\"color: red;\">Title: HTML?</span>', False)\n    )\n    def test_title_parameters(self, _, display_name, show_title):\n        const_page_name = 'Test show title parameter'\n        const_page_id = 'test_block_show_title'\n        scenario_xml = self._make_scenario_xml(\n            display_name=display_name,\n            show_title=show_title,\n            problem_text='Generic problem',\n        )\n        scenarios.add_xml_scenario(const_page_id, const_page_name, scenario_xml)\n        self.addCleanup(scenarios.remove_scenario, const_page_id)\n\n        page = self.go_to_page(const_page_name)\n        if show_title:\n            problem_header = page.find_element_by_css_selector('h3.hd.hd-3.problem-header')\n            self.assertEqual(self.get_element_html(problem_header), display_name)\n        else:\n            with self.assertRaises(NoSuchElementException):\n                page.find_element_by_css_selector('h3.hd.hd-3.problem-header')\n"], "filenames": ["Changelog.md", "drag_and_drop_v2/drag_and_drop_v2.py", "drag_and_drop_v2/public/js/drag_and_drop_edit.js", "drag_and_drop_v2/utils.py", "setup.py", "tests/integration/test_custom_data_render.py", "tests/integration/test_title_and_question.py"], "buggy_code_start_loc": [2, 34, 451, 9, 26, 25, 43], "buggy_code_end_loc": [2, 1199, 453, 29, 27, 26, 44], "fixing_code_start_loc": [3, 34, 451, 9, 26, 25, 43], "fixing_code_end_loc": [9, 1207, 453, 151, 27, 26, 44], "type": "CWE-79", "message": "Drag and Drop XBlock v2 implements a drag-and-drop style problem, where a learner has to drag items to zones on a target image. Versions prior to 3.0.0 are vulnerable to cross-site scripting in multiple XBlock Fields. Any platform that has deployed the XBlock may be impacted. Version 3.0.0 contains a patch for this issue. There are no known workarounds.", "other": {"cve": {"id": "CVE-2022-46147", "sourceIdentifier": "security-advisories@github.com", "published": "2022-11-28T21:15:10.797", "lastModified": "2022-12-01T23:07:20.930", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Drag and Drop XBlock v2 implements a drag-and-drop style problem, where a learner has to drag items to zones on a target image. Versions prior to 3.0.0 are vulnerable to cross-site scripting in multiple XBlock Fields. Any platform that has deployed the XBlock may be impacted. Version 3.0.0 contains a patch for this issue. There are no known workarounds."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.4, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.7, "impactScore": 6.0}]}, "weaknesses": [{"source": "security-advisories@github.com", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:openedx:xblock-drag-and-drop-v2:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.0.0", "matchCriteriaId": "C2A4EE44-EE74-4216-B863-E6F1DFA3F52D"}]}]}], "references": [{"url": "https://github.com/openedx/xblock-drag-and-drop-v2/commit/68887d1b4a44325d2de7573d450e41129ba98b1a", "source": "security-advisories@github.com", "tags": ["Patch", "Release Notes", "Third Party Advisory"]}, {"url": "https://github.com/openedx/xblock-drag-and-drop-v2/pull/295#issuecomment-1277693864", "source": "security-advisories@github.com", "tags": ["Exploit", "Patch", "Third Party Advisory"]}, {"url": "https://github.com/openedx/xblock-drag-and-drop-v2/releases/tag/v3.0.0", "source": "security-advisories@github.com", "tags": ["Patch", "Release Notes", "Third Party Advisory"]}, {"url": "https://github.com/openedx/xblock-drag-and-drop-v2/security/advisories/GHSA-qv6c-367r-3w6q", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/openedx/xblock-drag-and-drop-v2/commit/68887d1b4a44325d2de7573d450e41129ba98b1a"}}