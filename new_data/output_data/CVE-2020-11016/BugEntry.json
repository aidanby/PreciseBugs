{"buggy_code": ["CHANGELOG\n=========\n\n\n2.1.1 (unreleased)\n------------------\n\n\n### Backend\n- Fix mispelling of the environmental variable `INTELMQ_MANGER_CONTROLLER_CMD` to `INTELMQ_MANAGER_CONTROLLER_CMD` (an 'a' was missing).\n\n### Pages\n\n#### Landing page\n\n#### Configuration\n\n#### Management\n\n#### Monitor\n- Fix running commands with the \"inspect\" widget by fixing the definition of the `CONTROLLER_CMD` in the template (PR #194).\n\n#### Check\n\n### Documentation\n- Update supported operating systems in Installation documentation (i.a. PR #191).\n\n### Third-party libraries\n\n### Packaging\n\n### Known issues\n\n2.1.0 (2019-10-15)\n------------------\n\n### Backend\n- Fix mispelling of the environmental variable `INTELMQ_MANGER_CONTROLER_CMD` to `INTELMQ_MANGER_CONTROLLER_CMD` (you might be required to add the double 'l' to your nginx/apache server configuration)\n- When displaying a command to be replicated by debugging user, the string \"sudo -u {webserver user}\" string is prepended so that linux user do not have to bother with sudoing himself on the commonly used user \"www-data\" \u2013 which often can't be sudoed to (no bash provided due to good security measures). (Used in monitor and error reporting.) \n\n### Frontend\n- Error reporting\n  - Click will enlarge the dialog that contains much more useful info, notably the very command that failed so that it can be easily reproduced.\n  - Error messages are shuffled only when minimized, not when maximized. That would disturb the user trying to read the details. \n  - Invalid Syntax Error message removed. Till now, all error messages generated the string that JSON received is invalid \u2013 that wasn't needed, we knew it's invalid because it contained string message.\n  - Double click does not close log window anymore since it would interfere with the user trying to select whole text by mouse.\n  - Escape minimizes the reporting.\n  - For common seen errors, a tip is displayed (preferable with a link to the Github manual).\n \n### Pages\n \n#### Configuration\n - Node group Collector now may connect to Expert and Expert can connect to Parser, however you receive a warning that it is not very common.\n\n2.0.0 (2019-05-22)\n------------------\n\n### Backend\n- Some AJAX requests are marked as to-be-cached for a little amount of time so that server load decreases when you need many tabs open.\n\n### Pages\n\n#### Configuration\n- \"Save Configuration\" button reloads the bots whose destination queues changed (#175).\n- Allow standard vis.js arrow and +/- navigation when network chart is focused (#176).\n- Underscored letters denote shortcuts - you can now edit the network without wandering the mouse all around the screen (#176).\n- Correctly load JSON parameters when editing a bot: content instead of '[object Object]' string.\n- Handle not explicitly given internal queues.\n- Physics / Live button are now rememberable in the positions.conf file on the server.\n- When changing state or being disabled or erroneous, bot receives dashed border.\n- You are allowed to create multiple edges between the same nodes - correctly displayed. If the edges should have the same paths, rename dialog appears.\n\n#### Management\n- Auto-reloading\n- Clicking an action on a bot will make group panel correspond immediately\n- Clicking an action on a panel will make group in the table correspond immediately\n\n#### Monitor\n- Correctly display JSON parameters: content instead of '[object Object]' string.\n- Reloading logs fixed\n- Reloading logs every 3 sec instead of 300 sec\n- Auto-reloading logs after bot started/stopped\n\n### Documentation\n- Add SECURITY.md file.\n\n### Known issues\n* Missing CSRF protection (#111).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* wrong error message for new bots with existing ID (#152).\n\n\n1.1.0 (2018-11-12)\n------------------\n- Add generic MIT license text to make `reuse` license checker happy (#140).\n\n### Backend\n* Using LESS for writing CSS (so CSS is now readonly)\n* Fix on several places: intervals won't flood server if there is a lag, they'll wait till previous request has finished. Auto-delay/boost depending on server lag.\n\n### Frontend\n* Error reporting in a less-disturbing text box rather than an tab-wide javascript alert. Click to enlarge, double click to hide.\n* Much more detailed Error reporting. What was earlier just mere 'SyntaxError: JSON.parse ...' has now included 'Failed to execute intelmqctl:~/.local/bin/intelmqctl --type json list queues' - see? That's a full command that'll help the developer so much in debugging. (Long error reports got automatically truncated to 200 characters.)\n* If an error appears again and again (redis down?) it blinks instead of spamming you, updates its time and show number of times it has been thrown.\n* Current tab marked in menu\n\n### Pages\n\n#### Configuration\n* New menu item linking selected bot with the monitor (just an icon to preserve space on precious menu bar). Supports ctrl+click to new tab on the whole button area.\n* New menu item to duplicate current bot, its queues included (and focus the new one); the new bot is selected and focused so that the user finds it on a big plan. It is inserted instead of the add button when a bot is selected.\n* You may now see live data, each bot has its queue length in the label\n* Button labels (Add bot, Add queue instead of Add node, Add edge) now makes more sense and won't shock a newcomer\n* Clearly visible bot statuses; if bot is not running, its colour is dimmed.\n- Manager now supports named queue paths. They are displayed along the edges and editable.\n- Double click edits the bot or the queue\n- Code cleanup: New modal window for performing multiple dialog actions. Intercepting visjs internals without using external Hammer library.\n- Enter key submits the edit bot dialog.\n- Clicking on the side-menu bot name cycles amongst bot instances in the canvas.\n- Got rid of the dumb \"#load\" and \"#new\" parameter \u2192 \"#new\" converted into a standard URL parameter \"configuration=new\".\n- Button to turn on/off physics\n- Detection for bots not configured in runtime but in pipeline configuration (#166).\n- Runtime parameters with the names 'group', 'name' or 'module' were not editable (they are read-only for the 'generic' section) (#172).\n- Message counter for removed queues is correctly reset (#158).\n\n#### Management\n* Control buttons (start/stop...) now are not only part of the management tab but are common even for configuration tab and inspection panel in monitor tab. They need less configuration (thanks to $(document).on global configuration feature) and works better with less code used (single method instead of four of them). There is also a new red state 'error' for non-standard problems or invalid output from intelmqctl.\n* Clicking bot name support ctrl+click to new tab\n* Table doesn't redraw all the time (so that a highlighting of a browser search is preserved while clicking on a button)\n* It is now possible to start/stop a group of bots easily. Additional panels are linked, so that if you eg. start all the experts, but let other bots stopped, Experts panel shows that all bots are running and Botnet panel shows that only some bots are running.\n\n#### Monitor\n* Fixed bot crawling in Monitor section (F5 will take you on the same page, not on the main monitoring page, permanent links, history browsing)\n* Prefer updating the destination queues overview table over redrawing it all the time (so that you can select some text)\n* Reloading a page sometimes caused a disturbing 'Error loading' alert in Firefox if an AJAX request had not yet been completed\n* Fixed bug: when clicking on bot destination queue in bot detail, we won't end in an undefined bot\n* Inspect panel allows you to communicate via debug functions of `intelmqctl` (see and inject messages, process single message and see output). Ctrl+Enter hits the Process button (hint included in textarea placeholder). Checkbox 'Inject message from above' marked on first text ever written to message textarea.\n* The new parameters panel that displays the bot's parameters on the bot's monitor page. For parameters which are filenames, the content of these files will be shown as text if they reside in the allowed paths (set in config.php).\n* When needed, Path column appears, resizing the Queues panel accordingly.\n* Connected with the configuration panel \u2192 a link appears next to the bot title that takes you directly to the bot\n\n### Known issues\n* Missing CSRF protection (#111).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* wrong error message for new bots with existing ID (#152).\n\n1.0.2 (2018-09-24)\n------------------\n\n### Backend\n- Emit a more specific error message for cases like #160.\n- The timeout for calls to `intelmqctl` has been raised to 20s (#164).\n\n### Pages\n\n#### Configuration\n- Underscore is now allowed for new parameter names (#153).\n\n#### Monitor\n* Fix link to monitor page (#157).\n\n### Documentation\n- Add a FAQ and add a section about the docker issue (#160).\n- Add instructions for Debian 9, Ubuntu 18.04, and openSUSE Leap 42.3, 15.0 (#168).\n\n### Packaging\n- Include a positions file matching the default configuration of intelmq (#171).\n\n### Known issues\n* Missing CSRF protection (#111).\n* Missing copyright notices (#140).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* wrong error message for new bots with existing ID (#152).\n* Queue size for deleted queue remains displayed (#158).\n\n1.0.1 (2018-04-23)\n------------------\nThe version is compatible with intelmq >= 1.0.3\n\n### Backend\n* Fix version number.\n\n### Known issues\n* Missing CSRF protection (#111).\n* Missing copyright notices (#140).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* new runtime parameters with _ not possible (#153).\n* wrong error message for new bots with existing ID (#152).\n\n1.0.0 (2018-04-23)\n------------------\nThe version is compatible with intelmq >= 1.0.3\n\n### Backend\n* Set content type correctly for JSON data in configuration loading (#112)\n\n### Pages\n* All pages are now deliverd by php, reducing the amount of duplicate code drastically.\n\n#### Landing page\n* Added a new block for the new check page, changed the formatting a bit.\n\n#### Configuration\n* Fixed handling of special parameter `run_mode` (#150)\n* Intelmqctl controller may be set via an env variable `INTELMQ_MANGER_CONTROLLER_CMD`\n\n#### Check\n* Added, showing the output of `intelmqctl check` (#118).\n\n### Documentation\n* Note on header Content-Security-Policy (#113)\n* Note on security considerations in Readme to avoid misunderstandings\n* Remove compatibility warning from README\n\n### Third-party libraries\n* reverted update jQuery to 3.2.1\n* reverted update metisMenu to 2.7.0\n\n### Licenses\n* Licenses of used and included software is now inventarized and properly declared in LICENSES/ (#134)\n\n### Packaging\n* fix packaging of positions.conf file for deb-packages (#133).\n\n### Known issues\n* Missing CSRF protection (#111).\n* Missing copyright notices (#140).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* new runtime parameters with _ not possible (#153).\n* wrong error message for new bots with existing ID (#152).\n\n0.3.1 (2017-09-26)\n------------------\n### Configuration\n* Fixed validation on files before saving them, this has rejected valid data\n\n0.3 (2017-09-25)\n----------------\n* Partly support for CentOS/RHEL 7 (#55, #103)\n* Note on security considerations in Readme to avoid misunderstandings\n* Show versions of intelmq and intelmq manager on about page\n* Update vis.js to current version\n* update jQuery to 3.2.1\n* update metisMenu to 2.7.0\n\n### Configuration\n* interface for defaults.conf (#45)\n* drag&drop (#105, #41)\n* fix #96\n* save buttons starts blinking after changes (#41)\n* Allow redrawing of botnet on demand\n* Save/load position of bots in/from /opt/intelmq/etc/manager/positions.conf\n  File needs to be writeable\n* parameters from defaults are shown for new bots (#107)\n* parameters are grouped by type: generic, runtime, defaults\n* better feedback on errors with backend (#69, #99)\n* pressing ESC in forms equals to pressing the cancel button\n* Edit node window is now much bigger\n* pressing enter in 'add key' window equals to pressing ok button\n\n### Management\n* Reload and restart have been added as actions on bots and the whole botnet (#114)\n* A click on the bot name opens the monitor page of the bot\n\n### Monitor\n* clearing queues is possible in general and specific view for all queues (#54)\n\n### Backend\n* Fix regex checks on bot ids and log line number in controller, they have not been effective\n* fix overflow in extended message box (#49)\n\n0.2.1 (2017-06-20)\n------------------\n* Fix syntax error in pipeline.js preventing loading of configuration page\n\n0.2.0 (2017-06-20)\n------------------\n* first release\n", "NEWS\n====\n\nSee the changelog for a full list of changes.\n\n2.1.1 (unreleased)\n------------------\nThe environment variable name was corrected from `INTELMQ_MANGER_CONTROLLER_CMD` to `INTELMQ_MANGAER_CONTROLLER_CMD` you might need to adapt your configuration.\nThe old name will be available until version 3.0.\n\nUse IntelMQ Manager only from a browser that can only access internal, trusted sites. (Because CSRF development is under way, see [#111](github.com/certtools/intelmq/issues/111)).\n\n2.1.0 (2019-10-15)\n------------------\nThe environment variable name was corrected from `INTELMQ_MANGER_CONTROLER_CMD` to `INTELMQ_MANGER_CONTROLLER_CMD` you might need to adapt your configuration.\n\n2.0.0 (2019-05-22)\n------------------\n\nNo changes are required by administrators.\n\n\n1.1.0 (2018-11-12)\n------------------\n\nNo changes are required by administrators.\n\n1.0.1 (2018-09-24)\n------------------\n\nNo changes are required by administrators.\n\n\n1.0.0 (2018-04-23)\n------------------\n\nNo changes are required by administrators.\n\n\n0.3.1\n-----\n\nNo changes are required by administrators.\n\n\n0.3\n---\n* The IntelMQ Manager is now capable of saving the positions of bots.\n  You need to create the file `/opt/intelmq/etc/manager/positions.conf` and\n  allow the webserver process to write to it, e.g.:\n  ```bash\n  mkdir /opt/intelmq/etc/manager/\n  touch /opt/intelmq/etc/manager/positions.conf\n  chgrp www-data /opt/intelmq/etc/manager/positions.conf\n  chmod g+w /opt/intelmq/etc/manager/positions.conf\n  ```\n", "<?php\nrequire 'config.php';\nrequire 'util.php';\n\n/**\n * Build an intelmqctl command\n */\n$scope = '';\n$id = '';\n$json_wanted = true;\n$cache = false;\n\nif (array_key_exists('scope', $_GET)) {\n    $scope = $_GET['scope'];\n}\n\nif (array_key_exists('id', $_GET)) {\n    $id = $_GET['id'];\n}\n\n$id_regex = '/^[0-9a-zA-Z-]+$/';\n$lines_regex = '/^[0-9]+$/';\n\n$arguments = '';\n\nif (array_key_exists('action', $_GET) && ($_GET['action'] == 'start' ||\n        $_GET['action'] == 'stop' ||\n        $_GET['action'] == 'restart' ||\n        $_GET['action'] == 'reload' ||\n        $_GET['action'] == 'status')) {\n    $action = $_GET['action'];\n} else {\n    $action = \"\";\n}\n\nif ($scope == 'botnet') {\n    // only listed values of flag group allowed\n    $g = filter_input(INPUT_GET, \"group\");\n    if(in_array($g, [\"collectors\", \"parsers\", \"experts\", \"outputs\"])) {\n        $g = \" --group $g\";\n    } else {// \"botnet\" or non-listed value\n        $g = null;\n    }\n    $arguments = $action . $g;\n} else if ($scope == 'bot') {\n    if (!array_key_exists('id', $_GET)) {\n        die(\"Missing 'id' argument on request.\");\n    } else if (!preg_match($id_regex, $id)) {\n        die('Invalid id');\n    }\n\n    $arguments = $action . ' ' . escapeshellcmd($id);\n} else if ($scope == 'log') {\n    if (!array_key_exists('lines', $_GET)) {\n        die(\"Missing 'lines' argument on request.\" || !preg_match($lines_regex, $_GET['lines']));\n    } else if (!array_key_exists('level', $_GET)) {\n        die(\"Missing 'level' argument on request.\");\n    } else if (!array_key_exists('id', $_GET)) {\n        die(\"Missing 'id' argument on request.\");\n    } else if (!preg_match($id_regex, $id)) {\n        die('Invalid id');\n    }\n\n    $lines = $_GET['lines'];\n\n    if ($_GET['level'] == 'DEBUG' ||\n            $_GET['level'] == 'INFO' ||\n            $_GET['level'] == 'WARNING' ||\n            $_GET['level'] == 'ERROR' ||\n            $_GET['level'] == 'CRITICAL') {\n        $level = $_GET['level'];\n    } else {\n        $level = 'DEBUG';\n    }\n\n    $cache = true;\n    $arguments = 'log ' . escapeshellcmd($id) . ' ' . escapeshellcmd((int) ($lines)) . ' ' . escapeshellcmd($level);\n} else if ($scope == 'queues') {\n    $cache = true;\n    $arguments = 'list queues';\n} else if ($scope == 'queues-and-status') {\n    $cache = true;\n    $arguments = 'list queues-and-status';\n} else if ($scope == 'version') {\n    $arguments = '--version';\n} else if ($scope == 'check') {\n    $arguments = 'check';\n} else if ($scope == 'clear') {\n    if (!array_key_exists('id', $_GET)) {\n        die(\"Missing 'id' argument on request.\");\n    } else if (!preg_match($id_regex, $id)) {\n        $id = '';\n    }\n    $arguments = 'clear ' . escapeshellcmd($id);\n} else if ($scope == 'run') {\n    $json_wanted = false;\n\n    $arguments = \"run \" . escapeshellarg(filter_input(INPUT_GET, \"bot\")) . \" \";\n    switch (filter_input(INPUT_GET, \"cmd\")) {\n        case \"get\":\n            $arguments .= \"message get\";\n            break;\n        case \"pop\":\n            $arguments .= \"message pop\";\n            break;\n        case \"send\":\n            $arguments .= \"message send '\" . escapeshellarg(filter_input(INPUT_POST, \"msg\")) . \"'\";\n            break;\n        case \"process\":\n            $arguments .= \"process\";\n            if(filter_input(INPUT_GET, \"show\", FILTER_VALIDATE_BOOLEAN)) {\n                $arguments .= \" --show-sent\";\n            }\n            if(filter_input(INPUT_GET, \"dry\", FILTER_VALIDATE_BOOLEAN)) {\n                $arguments .= \" --dry\";\n            }\n            if(filter_input(INPUT_POST, \"msg\")) {\n                $arguments .= \" --msg \" . escapeshellarg(filter_input(INPUT_POST, \"msg\")) . \"\";\n            }\n            break;\n        default:\n            break;\n    }\n} else {\n    die('Invalid scope');\n}\n\n/**\n * Final command here\n */\nif($cache) {\n    $seconds_to_cache = 3;\n    $ts = gmdate(\"D, d M Y H:i:s\", time() + $seconds_to_cache) . \" GMT\";\n    header(\"Expires: $ts\");\n    header(\"Pragma: cache\");\n    header(\"Cache-Control: max-age=$seconds_to_cache\");\n}\n\nif($json_wanted) {\n    $c = $CONTROLLER_JSON;\n    header('Content-Type: application/json');\n} else {\n    $c = $CONTROLLER;\n}\n$command = sprintf($c, $arguments);\n//echo $command; exit;\n\n// appending magic string that'll kill the command if run for too long\n$sec = 20;\nset_time_limit($sec + 1); // we prefer to timeout in the command ($sec), if that does not work, kill it by PHP timeout\n\n$cmd = $command . \" & ii=0 && while [ \\\"2\\\" -eq \\\"`ps -p $! | wc -l`\\\" ];do ii=$((ii+1)); if [ \\$ii -gt \".($sec).\"0 ]; then echo '***Intelmqctl timeout!***';kill $!; break;fi; sleep 0.1; done\";\n$proc = proc_open($cmd,[\n    1 => ['pipe','w'],\n    2 => ['pipe','w'],\n],$pipes);\n$stdout = stream_get_contents($pipes[1]);\nfclose($pipes[1]);\n$stderr = stream_get_contents($pipes[2]);\nfclose($pipes[2]);\n$status = proc_close($proc);\n\n//$return = shell_exec($command . \" 2>&1 & ii=0 && while [ \\\"2\\\" -eq \\\"`ps -p $! | wc -l`\\\" ];do ii=$((ii+1)); if [ \\$ii -gt \".($sec).\"0 ]; then echo 'Intelmqctl timeout!';kill $!; break;fi; sleep 0.1; done\");\n\n\nif (!$stdout or $stderr or $status!==0) {\n    http_response_code(500);\n    if(!$stdout and !$stderr) {\n        $stderr = 'Failed to execute intelmqctl.';\n    }\n\n    // tips for common errors\n    $tip = \"\";\n    if(strpos($stderr, \"sudo: no tty present and no askpass program specified\") !== FALSE) {\n        $tip = \"Is sudoers file or the environmental variable `INTELMQ_MANGER_CONTROLLER_CMD` <a href='https://github.com/certtools/intelmq-manager/blob/master/docs/INSTALL.md#allow-access-to-intelmqctl'>set up correctly</a>?\";\n    }\n    else if(strpos($stderr, \"Permission denied: '/opt/intelmq\") !== FALSE) {\n        $tip = \"Has the user accessing intelmq folder the read/write permissions? This might be user intelmq or www-data, depending on your configuration, ex: <code>sudo chown intelmq.intelmq /opt/intelmq -R && sudo chmod u+rw /opt/intelmq -R</code>\";\n    }\n\n    echo json_encode(array(\n            \"command\" => $CONTROLLER_REPLICABLE . $command,\n            \"message\" => $stderr,\n            \"tip\" => $tip\n        ));\n} else {\n    if ($scope != 'version') {\n        echo $stdout;\n    } else {\n        echo json_encode(array(\n            \"intelmq\" => rtrim($stdout),\n            \"intelmq-manager\" => $VERSION,\n        ));\n    }\n}\n"], "fixing_code": ["CHANGELOG\n=========\n\n\n2.1.1 (unreleased)\n------------------\nBernhard Herzog (Intevation) discovered that the backend incorrectly handled messages given by user-input in the \"send\" functionality of the Inspect-tool of the Monitor component. An attacker with access to the IntelMQ Manager could possibly use this issue to execute arbitrary code with the privileges of the webserver.\n\n### Backend\n- Fix mispelling of the environmental variable `INTELMQ_MANGER_CONTROLLER_CMD` to `INTELMQ_MANAGER_CONTROLLER_CMD` (an 'a' was missing).\n- Fix handling of POST variable `msg` of the message-sending functionality available in the Inspect-tool.\n\n### Pages\n\n#### Landing page\n\n#### Configuration\n\n#### Management\n\n#### Monitor\n- Fix running commands with the \"inspect\" widget by fixing the definition of the `CONTROLLER_CMD` in the template (PR #194).\n\n#### Check\n\n### Documentation\n- Update supported operating systems in Installation documentation (i.a. PR #191).\n\n### Third-party libraries\n\n### Packaging\n\n### Known issues\n\n2.1.0 (2019-10-15)\n------------------\n\n### Backend\n- Fix mispelling of the environmental variable `INTELMQ_MANGER_CONTROLER_CMD` to `INTELMQ_MANGER_CONTROLLER_CMD` (you might be required to add the double 'l' to your nginx/apache server configuration)\n- When displaying a command to be replicated by debugging user, the string \"sudo -u {webserver user}\" string is prepended so that linux user do not have to bother with sudoing himself on the commonly used user \"www-data\" \u2013 which often can't be sudoed to (no bash provided due to good security measures). (Used in monitor and error reporting.) \n\n### Frontend\n- Error reporting\n  - Click will enlarge the dialog that contains much more useful info, notably the very command that failed so that it can be easily reproduced.\n  - Error messages are shuffled only when minimized, not when maximized. That would disturb the user trying to read the details. \n  - Invalid Syntax Error message removed. Till now, all error messages generated the string that JSON received is invalid \u2013 that wasn't needed, we knew it's invalid because it contained string message.\n  - Double click does not close log window anymore since it would interfere with the user trying to select whole text by mouse.\n  - Escape minimizes the reporting.\n  - For common seen errors, a tip is displayed (preferable with a link to the Github manual).\n \n### Pages\n \n#### Configuration\n - Node group Collector now may connect to Expert and Expert can connect to Parser, however you receive a warning that it is not very common.\n\n2.0.0 (2019-05-22)\n------------------\n\n### Backend\n- Some AJAX requests are marked as to-be-cached for a little amount of time so that server load decreases when you need many tabs open.\n\n### Pages\n\n#### Configuration\n- \"Save Configuration\" button reloads the bots whose destination queues changed (#175).\n- Allow standard vis.js arrow and +/- navigation when network chart is focused (#176).\n- Underscored letters denote shortcuts - you can now edit the network without wandering the mouse all around the screen (#176).\n- Correctly load JSON parameters when editing a bot: content instead of '[object Object]' string.\n- Handle not explicitly given internal queues.\n- Physics / Live button are now rememberable in the positions.conf file on the server.\n- When changing state or being disabled or erroneous, bot receives dashed border.\n- You are allowed to create multiple edges between the same nodes - correctly displayed. If the edges should have the same paths, rename dialog appears.\n\n#### Management\n- Auto-reloading\n- Clicking an action on a bot will make group panel correspond immediately\n- Clicking an action on a panel will make group in the table correspond immediately\n\n#### Monitor\n- Correctly display JSON parameters: content instead of '[object Object]' string.\n- Reloading logs fixed\n- Reloading logs every 3 sec instead of 300 sec\n- Auto-reloading logs after bot started/stopped\n\n### Documentation\n- Add SECURITY.md file.\n\n### Known issues\n* Missing CSRF protection (#111).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* wrong error message for new bots with existing ID (#152).\n\n\n1.1.0 (2018-11-12)\n------------------\n- Add generic MIT license text to make `reuse` license checker happy (#140).\n\n### Backend\n* Using LESS for writing CSS (so CSS is now readonly)\n* Fix on several places: intervals won't flood server if there is a lag, they'll wait till previous request has finished. Auto-delay/boost depending on server lag.\n\n### Frontend\n* Error reporting in a less-disturbing text box rather than an tab-wide javascript alert. Click to enlarge, double click to hide.\n* Much more detailed Error reporting. What was earlier just mere 'SyntaxError: JSON.parse ...' has now included 'Failed to execute intelmqctl:~/.local/bin/intelmqctl --type json list queues' - see? That's a full command that'll help the developer so much in debugging. (Long error reports got automatically truncated to 200 characters.)\n* If an error appears again and again (redis down?) it blinks instead of spamming you, updates its time and show number of times it has been thrown.\n* Current tab marked in menu\n\n### Pages\n\n#### Configuration\n* New menu item linking selected bot with the monitor (just an icon to preserve space on precious menu bar). Supports ctrl+click to new tab on the whole button area.\n* New menu item to duplicate current bot, its queues included (and focus the new one); the new bot is selected and focused so that the user finds it on a big plan. It is inserted instead of the add button when a bot is selected.\n* You may now see live data, each bot has its queue length in the label\n* Button labels (Add bot, Add queue instead of Add node, Add edge) now makes more sense and won't shock a newcomer\n* Clearly visible bot statuses; if bot is not running, its colour is dimmed.\n- Manager now supports named queue paths. They are displayed along the edges and editable.\n- Double click edits the bot or the queue\n- Code cleanup: New modal window for performing multiple dialog actions. Intercepting visjs internals without using external Hammer library.\n- Enter key submits the edit bot dialog.\n- Clicking on the side-menu bot name cycles amongst bot instances in the canvas.\n- Got rid of the dumb \"#load\" and \"#new\" parameter \u2192 \"#new\" converted into a standard URL parameter \"configuration=new\".\n- Button to turn on/off physics\n- Detection for bots not configured in runtime but in pipeline configuration (#166).\n- Runtime parameters with the names 'group', 'name' or 'module' were not editable (they are read-only for the 'generic' section) (#172).\n- Message counter for removed queues is correctly reset (#158).\n\n#### Management\n* Control buttons (start/stop...) now are not only part of the management tab but are common even for configuration tab and inspection panel in monitor tab. They need less configuration (thanks to $(document).on global configuration feature) and works better with less code used (single method instead of four of them). There is also a new red state 'error' for non-standard problems or invalid output from intelmqctl.\n* Clicking bot name support ctrl+click to new tab\n* Table doesn't redraw all the time (so that a highlighting of a browser search is preserved while clicking on a button)\n* It is now possible to start/stop a group of bots easily. Additional panels are linked, so that if you eg. start all the experts, but let other bots stopped, Experts panel shows that all bots are running and Botnet panel shows that only some bots are running.\n\n#### Monitor\n* Fixed bot crawling in Monitor section (F5 will take you on the same page, not on the main monitoring page, permanent links, history browsing)\n* Prefer updating the destination queues overview table over redrawing it all the time (so that you can select some text)\n* Reloading a page sometimes caused a disturbing 'Error loading' alert in Firefox if an AJAX request had not yet been completed\n* Fixed bug: when clicking on bot destination queue in bot detail, we won't end in an undefined bot\n* Inspect panel allows you to communicate via debug functions of `intelmqctl` (see and inject messages, process single message and see output). Ctrl+Enter hits the Process button (hint included in textarea placeholder). Checkbox 'Inject message from above' marked on first text ever written to message textarea.\n* The new parameters panel that displays the bot's parameters on the bot's monitor page. For parameters which are filenames, the content of these files will be shown as text if they reside in the allowed paths (set in config.php).\n* When needed, Path column appears, resizing the Queues panel accordingly.\n* Connected with the configuration panel \u2192 a link appears next to the bot title that takes you directly to the bot\n\n### Known issues\n* Missing CSRF protection (#111).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* wrong error message for new bots with existing ID (#152).\n\n1.0.2 (2018-09-24)\n------------------\n\n### Backend\n- Emit a more specific error message for cases like #160.\n- The timeout for calls to `intelmqctl` has been raised to 20s (#164).\n\n### Pages\n\n#### Configuration\n- Underscore is now allowed for new parameter names (#153).\n\n#### Monitor\n* Fix link to monitor page (#157).\n\n### Documentation\n- Add a FAQ and add a section about the docker issue (#160).\n- Add instructions for Debian 9, Ubuntu 18.04, and openSUSE Leap 42.3, 15.0 (#168).\n\n### Packaging\n- Include a positions file matching the default configuration of intelmq (#171).\n\n### Known issues\n* Missing CSRF protection (#111).\n* Missing copyright notices (#140).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* wrong error message for new bots with existing ID (#152).\n* Queue size for deleted queue remains displayed (#158).\n\n1.0.1 (2018-04-23)\n------------------\nThe version is compatible with intelmq >= 1.0.3\n\n### Backend\n* Fix version number.\n\n### Known issues\n* Missing CSRF protection (#111).\n* Missing copyright notices (#140).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* new runtime parameters with _ not possible (#153).\n* wrong error message for new bots with existing ID (#152).\n\n1.0.0 (2018-04-23)\n------------------\nThe version is compatible with intelmq >= 1.0.3\n\n### Backend\n* Set content type correctly for JSON data in configuration loading (#112)\n\n### Pages\n* All pages are now deliverd by php, reducing the amount of duplicate code drastically.\n\n#### Landing page\n* Added a new block for the new check page, changed the formatting a bit.\n\n#### Configuration\n* Fixed handling of special parameter `run_mode` (#150)\n* Intelmqctl controller may be set via an env variable `INTELMQ_MANGER_CONTROLLER_CMD`\n\n#### Check\n* Added, showing the output of `intelmqctl check` (#118).\n\n### Documentation\n* Note on header Content-Security-Policy (#113)\n* Note on security considerations in Readme to avoid misunderstandings\n* Remove compatibility warning from README\n\n### Third-party libraries\n* reverted update jQuery to 3.2.1\n* reverted update metisMenu to 2.7.0\n\n### Licenses\n* Licenses of used and included software is now inventarized and properly declared in LICENSES/ (#134)\n\n### Packaging\n* fix packaging of positions.conf file for deb-packages (#133).\n\n### Known issues\n* Missing CSRF protection (#111).\n* Missing copyright notices (#140).\n* Graph jumps around on \"Add edge\" bug component (#148).\n* new runtime parameters with _ not possible (#153).\n* wrong error message for new bots with existing ID (#152).\n\n0.3.1 (2017-09-26)\n------------------\n### Configuration\n* Fixed validation on files before saving them, this has rejected valid data\n\n0.3 (2017-09-25)\n----------------\n* Partly support for CentOS/RHEL 7 (#55, #103)\n* Note on security considerations in Readme to avoid misunderstandings\n* Show versions of intelmq and intelmq manager on about page\n* Update vis.js to current version\n* update jQuery to 3.2.1\n* update metisMenu to 2.7.0\n\n### Configuration\n* interface for defaults.conf (#45)\n* drag&drop (#105, #41)\n* fix #96\n* save buttons starts blinking after changes (#41)\n* Allow redrawing of botnet on demand\n* Save/load position of bots in/from /opt/intelmq/etc/manager/positions.conf\n  File needs to be writeable\n* parameters from defaults are shown for new bots (#107)\n* parameters are grouped by type: generic, runtime, defaults\n* better feedback on errors with backend (#69, #99)\n* pressing ESC in forms equals to pressing the cancel button\n* Edit node window is now much bigger\n* pressing enter in 'add key' window equals to pressing ok button\n\n### Management\n* Reload and restart have been added as actions on bots and the whole botnet (#114)\n* A click on the bot name opens the monitor page of the bot\n\n### Monitor\n* clearing queues is possible in general and specific view for all queues (#54)\n\n### Backend\n* Fix regex checks on bot ids and log line number in controller, they have not been effective\n* fix overflow in extended message box (#49)\n\n0.2.1 (2017-06-20)\n------------------\n* Fix syntax error in pipeline.js preventing loading of configuration page\n\n0.2.0 (2017-06-20)\n------------------\n* first release\n", "NEWS\n====\n\nSee the changelog for a full list of changes.\n\n2.1.1 (unreleased)\n------------------\n**Never ever run intelmq-manager on a public webserver without SSL and proper authentication**.\n\nBernhard Herzog (Intevation) discovered that the backend incorrectly handled messages given by user-input in the \"send\" functionality of the Inspect-tool of the Monitor component. An attacker with access to the IntelMQ Manager could possibly use this issue to execute arbitrary code with the privileges of the webserver.\n\nThe environment variable name was corrected from `INTELMQ_MANGER_CONTROLLER_CMD` to `INTELMQ_MANGAER_CONTROLLER_CMD` you might need to adapt your configuration.\nThe old name will be available until version 3.0.\n\nUse IntelMQ Manager only from a browser that can only access internal, trusted sites. (Because CSRF development is under way, see [#111](github.com/certtools/intelmq/issues/111)).\n\n2.1.0 (2019-10-15)\n------------------\nThe environment variable name was corrected from `INTELMQ_MANGER_CONTROLER_CMD` to `INTELMQ_MANGER_CONTROLLER_CMD` you might need to adapt your configuration.\n\n2.0.0 (2019-05-22)\n------------------\n\nNo changes are required by administrators.\n\n\n1.1.0 (2018-11-12)\n------------------\n\nNo changes are required by administrators.\n\n1.0.1 (2018-09-24)\n------------------\n\nNo changes are required by administrators.\n\n\n1.0.0 (2018-04-23)\n------------------\n\nNo changes are required by administrators.\n\n\n0.3.1\n-----\n\nNo changes are required by administrators.\n\n\n0.3\n---\n* The IntelMQ Manager is now capable of saving the positions of bots.\n  You need to create the file `/opt/intelmq/etc/manager/positions.conf` and\n  allow the webserver process to write to it, e.g.:\n  ```bash\n  mkdir /opt/intelmq/etc/manager/\n  touch /opt/intelmq/etc/manager/positions.conf\n  chgrp www-data /opt/intelmq/etc/manager/positions.conf\n  chmod g+w /opt/intelmq/etc/manager/positions.conf\n  ```\n", "<?php\nrequire 'config.php';\nrequire 'util.php';\n\n/**\n * Build an intelmqctl command\n */\n$scope = '';\n$id = '';\n$json_wanted = true;\n$cache = false;\n\nif (array_key_exists('scope', $_GET)) {\n    $scope = $_GET['scope'];\n}\n\nif (array_key_exists('id', $_GET)) {\n    $id = $_GET['id'];\n}\n\n$id_regex = '/^[0-9a-zA-Z-]+$/';\n$lines_regex = '/^[0-9]+$/';\n\n$arguments = '';\n\nif (array_key_exists('action', $_GET) && ($_GET['action'] == 'start' ||\n        $_GET['action'] == 'stop' ||\n        $_GET['action'] == 'restart' ||\n        $_GET['action'] == 'reload' ||\n        $_GET['action'] == 'status')) {\n    $action = $_GET['action'];\n} else {\n    $action = \"\";\n}\n\nif ($scope == 'botnet') {\n    // only listed values of flag group allowed\n    $g = filter_input(INPUT_GET, \"group\");\n    if(in_array($g, [\"collectors\", \"parsers\", \"experts\", \"outputs\"])) {\n        $g = \" --group $g\";\n    } else {// \"botnet\" or non-listed value\n        $g = null;\n    }\n    $arguments = $action . $g;\n} else if ($scope == 'bot') {\n    if (!array_key_exists('id', $_GET)) {\n        die(\"Missing 'id' argument on request.\");\n    } else if (!preg_match($id_regex, $id)) {\n        die('Invalid id');\n    }\n\n    $arguments = $action . ' ' . escapeshellcmd($id);\n} else if ($scope == 'log') {\n    if (!array_key_exists('lines', $_GET)) {\n        die(\"Missing 'lines' argument on request.\" || !preg_match($lines_regex, $_GET['lines']));\n    } else if (!array_key_exists('level', $_GET)) {\n        die(\"Missing 'level' argument on request.\");\n    } else if (!array_key_exists('id', $_GET)) {\n        die(\"Missing 'id' argument on request.\");\n    } else if (!preg_match($id_regex, $id)) {\n        die('Invalid id');\n    }\n\n    $lines = $_GET['lines'];\n\n    if ($_GET['level'] == 'DEBUG' ||\n            $_GET['level'] == 'INFO' ||\n            $_GET['level'] == 'WARNING' ||\n            $_GET['level'] == 'ERROR' ||\n            $_GET['level'] == 'CRITICAL') {\n        $level = $_GET['level'];\n    } else {\n        $level = 'DEBUG';\n    }\n\n    $cache = true;\n    $arguments = 'log ' . escapeshellcmd($id) . ' ' . escapeshellcmd((int) ($lines)) . ' ' . escapeshellcmd($level);\n} else if ($scope == 'queues') {\n    $cache = true;\n    $arguments = 'list queues';\n} else if ($scope == 'queues-and-status') {\n    $cache = true;\n    $arguments = 'list queues-and-status';\n} else if ($scope == 'version') {\n    $arguments = '--version';\n} else if ($scope == 'check') {\n    $arguments = 'check';\n} else if ($scope == 'clear') {\n    if (!array_key_exists('id', $_GET)) {\n        die(\"Missing 'id' argument on request.\");\n    } else if (!preg_match($id_regex, $id)) {\n        $id = '';\n    }\n    $arguments = 'clear ' . escapeshellcmd($id);\n} else if ($scope == 'run') {\n    $json_wanted = false;\n\n    $arguments = \"run \" . escapeshellarg(filter_input(INPUT_GET, \"bot\")) . \" \";\n    switch (filter_input(INPUT_GET, \"cmd\")) {\n        case \"get\":\n            $arguments .= \"message get\";\n            break;\n        case \"pop\":\n            $arguments .= \"message pop\";\n            break;\n        case \"send\":\n            $arguments .= \"message send \" . escapeshellarg(filter_input(INPUT_POST, \"msg\"));\n            break;\n        case \"process\":\n            $arguments .= \"process\";\n            if(filter_input(INPUT_GET, \"show\", FILTER_VALIDATE_BOOLEAN)) {\n                $arguments .= \" --show-sent\";\n            }\n            if(filter_input(INPUT_GET, \"dry\", FILTER_VALIDATE_BOOLEAN)) {\n                $arguments .= \" --dry\";\n            }\n            if(filter_input(INPUT_POST, \"msg\")) {\n                $arguments .= \" --msg \" . escapeshellarg(filter_input(INPUT_POST, \"msg\")) . \"\";\n            }\n            break;\n        default:\n            break;\n    }\n} else {\n    die('Invalid scope');\n}\n\n/**\n * Final command here\n */\nif($cache) {\n    $seconds_to_cache = 3;\n    $ts = gmdate(\"D, d M Y H:i:s\", time() + $seconds_to_cache) . \" GMT\";\n    header(\"Expires: $ts\");\n    header(\"Pragma: cache\");\n    header(\"Cache-Control: max-age=$seconds_to_cache\");\n}\n\nif($json_wanted) {\n    $c = $CONTROLLER_JSON;\n    header('Content-Type: application/json');\n} else {\n    $c = $CONTROLLER;\n}\n$command = sprintf($c, $arguments);\n//echo $command; exit;\n\n// appending magic string that'll kill the command if run for too long\n$sec = 20;\nset_time_limit($sec + 1); // we prefer to timeout in the command ($sec), if that does not work, kill it by PHP timeout\n\n$cmd = $command . \" & ii=0 && while [ \\\"2\\\" -eq \\\"`ps -p $! | wc -l`\\\" ];do ii=$((ii+1)); if [ \\$ii -gt \".($sec).\"0 ]; then echo '***Intelmqctl timeout!***';kill $!; break;fi; sleep 0.1; done\";\n$proc = proc_open($cmd,[\n    1 => ['pipe','w'],\n    2 => ['pipe','w'],\n],$pipes);\n$stdout = stream_get_contents($pipes[1]);\nfclose($pipes[1]);\n$stderr = stream_get_contents($pipes[2]);\nfclose($pipes[2]);\n$status = proc_close($proc);\n\n//$return = shell_exec($command . \" 2>&1 & ii=0 && while [ \\\"2\\\" -eq \\\"`ps -p $! | wc -l`\\\" ];do ii=$((ii+1)); if [ \\$ii -gt \".($sec).\"0 ]; then echo 'Intelmqctl timeout!';kill $!; break;fi; sleep 0.1; done\");\n\n\nif (!$stdout or $stderr or $status!==0) {\n    http_response_code(500);\n    if(!$stdout and !$stderr) {\n        $stderr = 'Failed to execute intelmqctl.';\n    }\n\n    // tips for common errors\n    $tip = \"\";\n    if(strpos($stderr, \"sudo: no tty present and no askpass program specified\") !== FALSE) {\n        $tip = \"Is sudoers file or the environmental variable `INTELMQ_MANGER_CONTROLLER_CMD` <a href='https://github.com/certtools/intelmq-manager/blob/master/docs/INSTALL.md#allow-access-to-intelmqctl'>set up correctly</a>?\";\n    }\n    else if(strpos($stderr, \"Permission denied: '/opt/intelmq\") !== FALSE) {\n        $tip = \"Has the user accessing intelmq folder the read/write permissions? This might be user intelmq or www-data, depending on your configuration, ex: <code>sudo chown intelmq.intelmq /opt/intelmq -R && sudo chmod u+rw /opt/intelmq -R</code>\";\n    }\n\n    echo json_encode(array(\n            \"command\" => $CONTROLLER_REPLICABLE . $command,\n            \"message\" => $stderr,\n            \"tip\" => $tip\n        ));\n} else {\n    if ($scope != 'version') {\n        echo $stdout;\n    } else {\n        echo json_encode(array(\n            \"intelmq\" => rtrim($stdout),\n            \"intelmq-manager\" => $VERSION,\n        ));\n    }\n}\n"], "filenames": ["CHANGELOG.md", "NEWS.md", "intelmq-manager/php/controller.php"], "buggy_code_start_loc": [7, 7, 107], "buggy_code_end_loc": [10, 7, 108], "fixing_code_start_loc": [7, 8, 107], "fixing_code_end_loc": [12, 12, 108], "type": "CWE-78", "message": "IntelMQ Manager from version 1.1.0 and before version 2.1.1 has a vulnerability where the backend incorrectly handled messages given by user-input in the \"send\" functionality of the Inspect-tool of the Monitor component. An attacker with access to the IntelMQ Manager could possibly use this issue to execute arbitrary code with the privileges of the webserver. Version 2.1.1 fixes the vulnerability.", "other": {"cve": {"id": "CVE-2020-11016", "sourceIdentifier": "security-advisories@github.com", "published": "2020-04-30T23:15:11.403", "lastModified": "2020-05-06T19:51:33.343", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "IntelMQ Manager from version 1.1.0 and before version 2.1.1 has a vulnerability where the backend incorrectly handled messages given by user-input in the \"send\" functionality of the Inspect-tool of the Monitor component. An attacker with access to the IntelMQ Manager could possibly use this issue to execute arbitrary code with the privileges of the webserver. Version 2.1.1 fixes the vulnerability."}, {"lang": "es", "value": "IntelMQ Manager desde la versi\u00f3n 1.1.0 y anteriores a la versi\u00f3n 2.1.1, presenta una vulnerabilidad en la que el backend maneja incorrectamente los mensajes proporcionados por la entrada del usuario en la funcionalidad \"send\" de la herramienta de inspecci\u00f3n del componente Monitor. Un atacante con acceso a IntelMQ Manager, podr\u00eda posiblemente usar este problema para ejecutar c\u00f3digo arbitrario con los privilegios del webserver. La versi\u00f3n 2.1.1 corrige la vulnerabilidad."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}, {"source": "security-advisories@github.com", "type": "Secondary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:H/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "HIGH", "availabilityImpact": "LOW", "baseScore": 9.1, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.1, "impactScore": 5.3}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-78"}]}, {"source": "security-advisories@github.com", "type": "Secondary", "description": [{"lang": "en", "value": "CWE-78"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:intelmq_manager_project:intelmq_manager:*:*:*:*:*:*:*:*", "versionStartIncluding": "1.1.0", "versionEndExcluding": "2.1.1", "matchCriteriaId": "86C918B9-EE1D-4FDB-8FEE-F45DC024650B"}]}]}], "references": [{"url": "https://github.com/certtools/intelmq-manager/commit/b9a2ac43a4f99d764b827108f6a99dc4a9faa013", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/certtools/intelmq-manager/releases/tag/2.1.1", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}, {"url": "https://github.com/certtools/intelmq-manager/security/advisories/GHSA-rrhh-rcgp-q2m2", "source": "security-advisories@github.com", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://lists.cert.at/pipermail/intelmq-users/2020-April/000161.html", "source": "security-advisories@github.com", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/certtools/intelmq-manager/commit/b9a2ac43a4f99d764b827108f6a99dc4a9faa013"}}