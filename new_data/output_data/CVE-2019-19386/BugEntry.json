{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2018\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (permission_exists('voicemail_greeting_edit')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//get greeting id\n\tif (is_uuid($_REQUEST[\"id\"])) {\n\t\t$voicemail_greeting_uuid = $_REQUEST[\"id\"];\n\t}\n\n//get the form value and set to php variables\n\t$voicemail_id = $_REQUEST[\"voicemail_id\"];\n\tif (count($_POST) > 0) {\n\t\t$greeting_name = $_POST[\"greeting_name\"];\n\t\t$greeting_description = $_POST[\"greeting_description\"];\n\n\t\t//clean the name\n\t\t$greeting_name = str_replace(\"'\", \"\", $greeting_name);\n\t}\n\nif (count($_POST) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\t//get greeting uuid to edit\n\t\t$voicemail_greeting_uuid = $_POST[\"voicemail_greeting_uuid\"];\n\n\t//validate the token\n\t\t$token = new token;\n\t\tif (!$token->validate($_SERVER['PHP_SELF'])) {\n\t\t\tmessage::add($text['message-invalid_token'],'negative');\n\t\t\theader('Location: ../voicemails/voicemails.php');\n\t\t\texit;\n\t\t}\n\n\t//check for all required data\n\t\t$msg = '';\n\t\tif (strlen($greeting_name) == 0) { $msg .= \"\".$text['confirm-name'].\"<br>\\n\"; }\n\t\tif (strlen($msg) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\t\t\trequire_once \"resources/header.php\";\n\t\t\trequire_once \"resources/persist_form_var.php\";\n\t\t\techo \"<div align='center'>\\n\";\n\t\t\techo \"<table><tr><td>\\n\";\n\t\t\techo $msg.\"<br />\";\n\t\t\techo \"</td></tr></table>\\n\";\n\t\t\tpersistformvar($_POST);\n\t\t\techo \"</div>\\n\";\n\t\t\trequire_once \"resources/footer.php\";\n\t\t\treturn;\n\t\t}\n\n\t//update the database\n\tif ($_POST[\"persistformvar\"] != \"true\" && permission_exists('voicemail_greeting_edit')) {\n\t\t//build update array\n\t\t\t$array['voicemail_greetings'][0]['voicemail_greeting_uuid'] = $voicemail_greeting_uuid;\n\t\t\t$array['voicemail_greetings'][0]['greeting_name'] = $greeting_name;\n\t\t\t$array['voicemail_greetings'][0]['greeting_description'] = $greeting_description;\n\t\t//execute update\n\t\t\t$database = new database;\n\t\t\t$database->app_name = 'voicemail_greetings';\n\t\t\t$database->app_uuid = 'e4b4fbee-9e4d-8e46-3810-91ba663db0c2';\n\t\t\t$database->save($array);\n\t\t\tunset($array);\n\t\t//set message\n\t\t\tmessage::add($text['message-update']);\n\t\t//redirect\n\t\t\theader(\"Location: voicemail_greetings.php?id=\".$voicemail_id);\n\t\t\texit;\n\t}\n}\n\n//pre-populate the form\n\tif (count($_GET) > 0 && $_POST[\"persistformvar\"] != \"true\") {\n\t\t$voicemail_greeting_uuid = $_GET[\"id\"];\n\t\t$sql = \"select * from v_voicemail_greetings \";\n\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and voicemail_greeting_uuid = :voicemail_greeting_uuid \";\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t$parameters['voicemail_greeting_uuid'] = $voicemail_greeting_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t$greeting_name = $row[\"greeting_name\"];\n\t\t\t$greeting_description = $row[\"greeting_description\"];\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t}\n\n//create token\n\t$object = new token;\n\t$token = $object->create($_SERVER['PHP_SELF']);\n\n//show the header\n\t$document['title'] = $text['label-edit'];\n\trequire_once \"resources/header.php\";\n\n//show the content\n\techo \"<form method='post' name='frm' action=''>\\n\";\n\n\techo \"<table cellpadding='0' cellspacing='0' border='0' align='right'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td nowrap='nowrap'>\\n\";\n\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='voicemail_greetings.php?id=\".$voicemail_id.\"'\\\" value='\".$text['button-back'].\"'>\";\n\techo \"\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\techo \"<b>\".$text['label-edit'].\"</b>\\n\";\n\techo \"<br><br>\\n\";\n\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td width='30%' class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-name'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td width='70%' class='vtable' align='left'>\\n\";\n\techo \"    <input class='formfld' type='text' name='greeting_name' maxlength='255' value=\\\"\".escape($greeting_name).\"\\\">\\n\";\n\techo \"<br />\\n\";\n\techo \"\".$text['description-name'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-description'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"    <input class='formfld' type='text' name='greeting_description' maxlength='255' value=\\\"\".escape($greeting_description).\"\\\">\\n\";\n\techo \"<br />\\n\";\n\techo \"\".$text['description-info'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td colspan='2' align='right'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='voicemail_greeting_uuid' value='\".$voicemail_greeting_uuid.\"'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='voicemail_id' value='\".$voicemail_id.\"'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\techo \"\t\t\t<br>\";\n\techo \"\t\t\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\";\n\techo \"</table>\";\n\techo \"<br><br>\";\n\n\techo \"</form>\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2019\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n*/\n\n//includes\n\tinclude \"root.php\";\n\trequire_once \"resources/require.php\";\n\trequire_once \"resources/check_auth.php\";\n\n//check permissions\n\tif (permission_exists('voicemail_greeting_edit')) {\n\t\t//access granted\n\t}\n\telse {\n\t\techo \"access denied\";\n\t\texit;\n\t}\n\n//add multi-lingual support\n\t$language = new text;\n\t$text = $language->get();\n\n//validate the uuids\n\tif (is_uuid($_REQUEST[\"id\"])) {\n\t\t$voicemail_greeting_uuid = $_REQUEST[\"id\"];\n\t}\n\tif (is_uuid($_REQUEST[\"voicemail_id\"])) {\n\t\t$voicemail_id = $_REQUEST[\"voicemail_id\"];\n\t}\n\n//get the form value and set to php variables\n\tif (count($_POST) > 0) {\n\t\t$greeting_name = $_POST[\"greeting_name\"];\n\t\t$greeting_description = $_POST[\"greeting_description\"];\n\n\t\t//clean the name\n\t\t$greeting_name = str_replace(\"'\", \"\", $greeting_name);\n\t}\n\nif (count($_POST) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\n\t//validate the token\n\t\t$token = new token;\n\t\tif (!$token->validate($_SERVER['PHP_SELF'])) {\n\t\t\tmessage::add($text['message-invalid_token'],'negative');\n\t\t\theader('Location: ../voicemails/voicemails.php');\n\t\t\texit;\n\t\t}\n\n\t//check for all required data\n\t\t$msg = '';\n\t\tif (strlen($greeting_name) == 0) { $msg .= \"\".$text['confirm-name'].\"<br>\\n\"; }\n\t\tif (strlen($msg) > 0 && strlen($_POST[\"persistformvar\"]) == 0) {\n\t\t\trequire_once \"resources/header.php\";\n\t\t\trequire_once \"resources/persist_form_var.php\";\n\t\t\techo \"<div align='center'>\\n\";\n\t\t\techo \"<table><tr><td>\\n\";\n\t\t\techo $msg.\"<br />\";\n\t\t\techo \"</td></tr></table>\\n\";\n\t\t\tpersistformvar($_POST);\n\t\t\techo \"</div>\\n\";\n\t\t\trequire_once \"resources/footer.php\";\n\t\t\treturn;\n\t\t}\n\n\t//update the database\n\tif ($_POST[\"persistformvar\"] != \"true\" && permission_exists('voicemail_greeting_edit')) {\n\t\t//build update array\n\t\t\t$array['voicemail_greetings'][0]['voicemail_greeting_uuid'] = $voicemail_greeting_uuid;\n\t\t\t$array['voicemail_greetings'][0]['greeting_name'] = $greeting_name;\n\t\t\t$array['voicemail_greetings'][0]['greeting_description'] = $greeting_description;\n\t\t//execute update\n\t\t\t$database = new database;\n\t\t\t$database->app_name = 'voicemail_greetings';\n\t\t\t$database->app_uuid = 'e4b4fbee-9e4d-8e46-3810-91ba663db0c2';\n\t\t\t$database->save($array);\n\t\t\tunset($array);\n\t\t//set message\n\t\t\tmessage::add($text['message-update']);\n\t\t//redirect\n\t\t\theader(\"Location: voicemail_greetings.php?id=\".$voicemail_id);\n\t\t\texit;\n\t}\n}\n\n//pre-populate the form\n\tif (count($_GET) > 0 && $_POST[\"persistformvar\"] != \"true\") {\n\t\t$sql = \"select * from v_voicemail_greetings \";\n\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and voicemail_greeting_uuid = :voicemail_greeting_uuid \";\n\t\t$parameters['domain_uuid'] = $domain_uuid;\n\t\t$parameters['voicemail_greeting_uuid'] = $voicemail_greeting_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t$greeting_name = $row[\"greeting_name\"];\n\t\t\t$greeting_description = $row[\"greeting_description\"];\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t}\n\n//create token\n\t$object = new token;\n\t$token = $object->create($_SERVER['PHP_SELF']);\n\n//show the header\n\t$document['title'] = $text['label-edit'];\n\trequire_once \"resources/header.php\";\n\n//show the content\n\techo \"<form method='post' name='frm' action=''>\\n\";\n\n\techo \"<table cellpadding='0' cellspacing='0' border='0' align='right'>\\n\";\n\techo \"<tr>\\n\";\n\techo \"<td nowrap='nowrap'>\\n\";\n\techo \"\t<input type='button' class='btn' name='' alt='\".$text['button-back'].\"' onclick=\\\"window.location='voicemail_greetings.php?id=\".urlencode($voicemail_id).\"'\\\" value='\".$text['button-back'].\"'>\";\n\techo \"\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"</table>\\n\";\n\techo \"<b>\".$text['label-edit'].\"</b>\\n\";\n\techo \"<br><br>\\n\";\n\n\techo \"<table width='100%' border='0' cellpadding='0' cellspacing='0'>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td width='30%' class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-name'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td width='70%' class='vtable' align='left'>\\n\";\n\techo \"    <input class='formfld' type='text' name='greeting_name' maxlength='255' value=\\\"\".escape($greeting_name).\"\\\">\\n\";\n\techo \"<br />\\n\";\n\techo \"\".$text['description-name'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\n\techo \"<tr>\\n\";\n\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\techo \"    \".$text['label-description'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"<td class='vtable' align='left'>\\n\";\n\techo \"    <input class='formfld' type='text' name='greeting_description' maxlength='255' value=\\\"\".escape($greeting_description).\"\\\">\\n\";\n\techo \"<br />\\n\";\n\techo \"\".$text['description-info'].\"\\n\";\n\techo \"</td>\\n\";\n\techo \"</tr>\\n\";\n\techo \"\t<tr>\\n\";\n\techo \"\t\t<td colspan='2' align='right'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='voicemail_greeting_uuid' value='\".$voicemail_greeting_uuid.\"'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='voicemail_id' value='\".$voicemail_id.\"'>\\n\";\n\techo \"\t\t\t<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\techo \"\t\t\t<br>\";\n\techo \"\t\t\t<input type='submit' name='submit' class='btn' value='\".$text['button-save'].\"'>\\n\";\n\techo \"\t\t</td>\\n\";\n\techo \"\t</tr>\";\n\techo \"</table>\";\n\techo \"<br><br>\";\n\n\techo \"</form>\";\n\n//include the footer\n\trequire_once \"resources/footer.php\";\n\n?>\n"], "filenames": ["app/voicemail_greetings/voicemail_greeting_edit.php"], "buggy_code_start_loc": [20], "buggy_code_end_loc": [188], "fixing_code_start_loc": [20], "fixing_code_end_loc": [187], "type": "CWE-79", "message": "A cross-site scripting (XSS) vulnerability in app/voicemail_greetings/voicemail_greeting_edit.php in FusionPBX 4.4.1 allows remote attackers to inject arbitrary web script or HTML via the id and/or voicemail_id parameter.", "other": {"cve": {"id": "CVE-2019-19386", "sourceIdentifier": "cve@mitre.org", "published": "2019-11-29T00:15:11.543", "lastModified": "2019-12-02T19:56:39.937", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "A cross-site scripting (XSS) vulnerability in app/voicemail_greetings/voicemail_greeting_edit.php in FusionPBX 4.4.1 allows remote attackers to inject arbitrary web script or HTML via the id and/or voicemail_id parameter."}, {"lang": "es", "value": "Una vulnerabilidad de tipo cross-site scripting (XSS) en el archivo app/voicemail_greetings/voicemail_greeting_edit.php en FusionPBX versi\u00f3n 4.4.1, permite a atacantes remotos inyectar script web o HTML arbitrario por medio del par\u00e1metro id y/o voicemail_id."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:4.4.1:*:*:*:*:*:*:*", "matchCriteriaId": "954E2072-AC03-4E55-8A7F-640534279042"}]}]}], "references": [{"url": "https://gist.github.com/xax007/28e7326acfae677be0b351216888e522", "source": "cve@mitre.org", "tags": ["Exploit", "Patch", "Third Party Advisory"]}, {"url": "https://github.com/fusionpbx/fusionpbx/commit/9e837fadecdd5199819a949b5b1bd84b19f716f2", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/9e837fadecdd5199819a949b5b1bd84b19f716f2"}}