{"buggy_code": ["<?php\n##################################################\n#\n# Copyright (c) 2004-2016 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * This is the class expPaginator\n * Exponent Pagination Subsystem\n *\n * The expPaginator class is used to retrieve objects from the database\n * and paginate them and optionally group the by category.\n * It automagically handles the calls to other pages\n * and has built-in sorting using the defined column headers.\n *\n * Usage Example:\n *\n * <code>\n *\n * $page = new expPaginator(array(\n *      'model'=>'faq',\n *      'where'=>1,\n *      'limit'=>25,\n *      'order'=>'rank',\n *      'controller'=>$this->baseclassname,\n *      'action'=>$this->params['action'],\n *      'columns'=>array('In FAQ'=>'include_in_faq', 'Submitted'=>'created_at', 'Submitted By'=>'submitter_name'),\n *  ));\n * </code>\n *\n * @package Subsystems\n * @subpackage Subsystems\n */\n\nclass expPaginator {\n    /**#@+\n     * @access public\n     * @var string\n     */\n\tpublic $model = null;\n    public $search_string = '';\n\tpublic $sql = '';\n    public $count_sql = '';\n\tpublic $where = '';\n\tpublic $controller = '';\n\tpublic $action = '';\n\tpublic $order = '';\n\tpublic $order_direction = '';\n\tpublic $firstpage = '';\n\tpublic $lastpage = '';\n\tpublic $previous_page = '';\n\tpublic $next_page = '';\n\tpublic $previous_shift = '';\n\tpublic $next_shift = '';\n\tpublic $pagelink = '';\n\tpublic $header_columns = '';\n\tpublic $default = '';\n\tpublic $view = null;\n    public $uncat ='';\n//    public $content_type = '';\n//    public $author = '';\n//    public $tag = '';\n//    public $tags = '';\n\t/**#@+\n     * @access public\n     * @var integer\n     */\n\tpublic $page  = 1;\n//\tpublic $limit = 10;\n    public $limit = 0;\n\tpublic $start = 0;\n\tpublic $last = 0;\n\tpublic $pages_to_show = 10;\n\tpublic $total_records = 0;\n\tpublic $total_pages = 0;\n\tpublic $page_offset = 0;\n    public $categorize = false;\n//    public $version = 0;\n//    public $content_id = 0;\n\t/**#@+\n     * @access public\n     * @var array\n     */\n\tpublic $pages = array();\n\tpublic $records = array();\n    public $cats = array();\n    public $sort_dropdown = array();\n\n\t/**\n\t * expPaginator Constructor\n\t *\n\t * This is the main entry point for using the expPaginator.  See example above.\n\t *\n\t * @param array $params Use this to set any of the class variables. Ones not passed will be set to a default.\n\t * @return \\expPaginator\n\t */\n\tpublic function __construct($params=array()) {\n\t\tglobal $router, $db;\n\n        $this->pages_to_show = expTheme::is_mobile() ? 6 : 10; // fewer paging links for small devices\n\t\t$this->where = empty($params['where']) ? null : $params['where'];\n\t\t$this->records = empty($params['records']) ? array() : $params['records'];\n//\t\t$this->limit = empty($params['limit']) ? 10 : $params['limit'];\n        $this->limit = empty($params['limit']) ? 0 : intval($params['limit']);\n        $this->page = empty($params['page']) ? 1 : intval($params['page']);\n\t\t$this->action = empty($params['action']) ? '' : $params['action'];\n\t\t$this->controller = empty($params['controller']) ? '' : $params['controller'];\n\t\t$this->sql = empty($params['sql']) ? '' : $params['sql'];\n        $this->count_sql = empty($params['count_sql']) ? '' : $params['count_sql'];\n\t\t$this->order = empty($params['order']) ? 'id' : expString::escape($params['order']);\n\t\t$this->dir = empty($params['dir']) || !in_array($params['dir'], array('ASC', 'DESC')) ? 'ASC' : $params['dir'];\n\t\t$this->src = empty($params['src']) ? null : expString::escape($params['src']);\n        $this->categorize = empty($params['categorize']) ? false : $params['categorize'];\n        $this->uncat = !empty($params['uncat']) ? $params['uncat'] : gt('Not Categorized');\n        $this->groups = !empty($params['groups']) ? $params['groups'] : array();\n        $this->grouplimit = !empty($params['grouplimit']) ? $params['grouplimit'] : null;\n        $this->dontsortwithincat = !empty($params['dontsortwithincat']) ? $params['dontsortwithincat'] : null;\n        $this->dontsort = !empty($params['dontsort']) ? $params['dontsort'] : null;\n\n\t\t// if a view was passed we'll use it.\n\t\tif (isset($params['view']))\n            $this->view = $params['view'];\n\n        // setup the model if one was passed.\n        if (isset($params['model'])) {\n            $this->model = $params['model'];\n            $class = new $this->model(null, false, false);\n        }\n\n\t    // auto-include the CSS for pagination links\n\t    expCSS::pushToHead(array(\n//\t\t    \"unique\"=>\"pagination\",\n//\t\t    \"link\"=>PATH_RELATIVE.\"framework/core/assets/css/pagination.css\",\n            'corecss'=>'pagination'\n\t\t    )\n\t\t);\n\n\t\tif ($this->limit)\n            $this->start = (($this->page * $this->limit) - $this->limit);\n        if ($this->start < 0)\n            $this->start = 0;\n\n\t\t//setup the columns\n        $this->columns = array();\n\t\tif (isset($params['columns'])) {\n\t\t    foreach($params['columns'] as $key=>$col){\n\t\t        $colparse[$key] = explode('|',$col);\n\t\t        $column = array($key=>$colparse[$key][0]);\n\t\t        $this->columns = array_merge($this->columns,$column);\n\t\t        if (!empty($colparse[$key][1])) {\n\t\t            $params = explode(',',$colparse[$key][1]);\n\t\t            foreach ($params as $paramval) {\n\t\t                $prm = explode('=',$paramval);\n\t\t                $this->linkables[$key][$prm[0]] = $prm[1];\n\t\t            }\n\t\t        }\n\t\t    }\n\t\t}\n\n\t\t//setup the default ordering of records\n\t\t// if we are in an action, see if the action is for this controller/action..if so pull the order\n\t\t// and order direction from the request params...this is how the params are passed via the column\n\t\t// headers.\n\t\t$this->order_direction = $this->dir;\n\n        // allow passing of a single order/dir as stored in config\n        if (strstr($this->order,\" \")) {\n            $orderby = explode(\" \",$this->order);\n            $this->order = $orderby[0];\n            $this->order_direction = $orderby[1];\n        }\n        if(!preg_match('/[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*/', $this->order))\n            $this->order = 'id';\n        if (!in_array($this->order_direction, array('ASC', 'DESC')))\n            $this->order_direction = 'ASC';\n        if ($this->dontsort)\n            $sort = null;\n        else\n            $sort = $this->order.' '.$this->order_direction;\n\n\t\t// figure out how many records we're dealing with & grab the records\n\t\t//if (!empty($this->records)) { //from Merge <~~ this doesn't work. Could be empty, but still need to hit.\n        if (!empty($this->categorize))\n            $limit = null;\n        else\n            $limit = $this->limit;\n\n\t\tif (isset($params['records'])) { // if we pass $params['records'], we WANT to hit this\n\t\t    // sort the records that were passed in to us\n            if (!empty($sort))\n                usort($this->records,array('expPaginator', strtolower($this->order_direction)));\n//\t\t    $this->total_records = count($this->records);\n\t\t} elseif (!empty($class)) { //where clause     //FJD: was $this->class, but wasn't working...\n\t\t\t$this->total_records = $class->find('count', $this->where);\n            $this->records = $class->find('all', $this->where, $sort, $limit, $this->start);\n\t\t} elseif (!empty($this->where)) { //from Merge....where clause\n\t\t\t$this->total_records = $class->find('count', $this->where);\n            $this->records = $class->find('all', $this->where, $sort, $limit, $this->start);\n\t\t} else { //sql clause  //FIXME we don't get attachments in this approach\n\t\t\t//$records = $db->selectObjectsBySql($this->sql);\n\t\t\t//$this->total_records = count($records);\n            //this is MUCH faster if you supply a proper count_sql param using a COUNT() function; if not,\n            //we'll run the standard sql and do a queryRows with it\n\t\t\t//$this->total_records = $this->count_sql == '' ? $db->queryRows($this->sql) : $db->selectValueBySql($this->count_sql); //From Merge\n\n//\t\t\t$this->total_records =  $db->countObjectsBySql($this->count_sql); //$db->queryRows($this->sql); //From most current Trunk\n\n            if (!empty($sort)) $this->sql .= ' ORDER BY '.$sort;\n            if (!empty($this->count_sql)) $this->total_records = $db->countObjectsBySql($this->count_sql);\n\t\t\tif (!empty($this->limit)) $this->sql .= ' LIMIT '.$this->start.','.$this->limit;\n\n\t\t\t$this->records = array();\n\t\t\tif (isset($this->model) || isset($params['model_field'])) {\n\t\t\t    foreach($db->selectObjectsBySql($this->sql) as $record) {\n                    $type = $params['model_field'];\n\t\t\t        $classname = isset($params['model_field']) ? $record->$type : $this->model;\n\t\t\t        //$this->records[] = new $classname($record->id, true, true); //From current trunk // added false, true, as we shouldn't need associated items here, but do need attached. FJD.\n\t\t\t\t\t$this->records[] = new $classname($record->id, false, true); //From Merge //added false, true, as we shouldn't need associated items here, but do need attached. FJD.\n\t\t\t    }\n\t\t\t} else {\n\t\t\t    $this->records = $db->selectObjectsBySql($this->sql);\n\t\t\t}\n\t\t}\n\n        // next we'll sort them based on categories if needed\n        if (!empty($this->categorize) && $this->categorize && empty($this->dontsort))\n            expCatController::addCats($this->records,$sort,$this->uncat,$this->groups,$this->dontsortwithincat);\n\n        // let's see how many total records there are\n        if (empty($this->total_records))\n            $this->total_records = count($this->records);\n        if ($this->limit && $this->start >= $this->total_records)\n            $this->start = $this->total_records - $this->limit;\n\n        // at this point we generally have all our records, now we'll trim the records to the number requested\n        //FIXME we may want some more intelligent selection here based on cats/groups, e.g., don't break groups across pages, number of picture rows, etc...\n        if (empty($this->grouplimit) && ($this->limit) && count($this->records) > $this->limit)\n            $this->records = array_slice($this->records, $this->start, $this->limit);\n        // finally, we'll create another multi-dimensional array of categories populated with assoc items\n        if (empty($this->dontsort)) {\n            if (!empty($this->categorize) && $this->categorize) {\n                expCatController::sortedByCats($this->records,$this->cats,$this->groups,$this->grouplimit);\n            } elseif (empty($this->dontsortwithincat)) {  // categorized is off, so let's categorize by alpha instead for 'rolodex' type use\n                $order = $this->order;\n                if (in_array($order,array('created_at','edited_at','publish'))) {\n                    if ($this->total_records && (abs($this->records[0]->$order - $this->records[count($this->records)-1]->$order)  >= (60 * 60 * 24 *365 *2))) {\n                        $datetype = 'Y';  // more than 2 years of records, so break down by year\n                    } else {\n                        $datetype = 'M Y';  // less than 2 years of records, so break down by month/year\n                    }\n                    foreach ($this->records as $record) {\n                        if (is_numeric($record->$order)) {\n                            $title = date($datetype,$record->$order);\n                            $title = empty($title)?gt('Undated'):$title;\n                        } else {\n                            $title = gt('Undated');\n                        }\n                        if (empty($this->cats[$title])) {\n                            $this->cats[$title] = new stdClass();\n                            $this->cats[$title]->count = 1;\n                            $this->cats[$title]->name = $title;\n                        } else {\n                            $this->cats[$title]->count++;\n                        }\n                        $this->cats[$title]->records[] = $record;\n                    }\n                } else {\n                    foreach ($this->records as $record) {\n                        if (!empty($record->$order) && is_string($record->$order) && !is_numeric($record->$order)) {\n                            $title = ucfirst($record->$order);\n                            $title = empty($title[0])?'':$title[0];\n                        } else {\n                            $title = '';\n                        }\n                        if (empty($this->cats[$title])) {\n                            $this->cats[$title] = new stdClass();\n                            $this->cats[$title]->count = 1;\n                            $this->cats[$title]->name = $title;\n                        } else {\n                            $this->cats[$title]->count++;\n                        }\n                        $this->cats[$title]->records[] = $record;\n                    }\n                }\n            }\n            if (!empty($this->grouplimit)) {\n                if ($this->limit)\n                    $this->records = array_slice($this->records, $this->start, $this->limit);\n            } else {\n                if ($this->limit)\n                    $this->cats = array_slice($this->cats, $this->start, $this->limit);\n            }\n        }\n\n        if (isset($params['records']))\n            $this->runCallback(); // isset($params['records']) added to correct search for products.\n\n        //eDebug($this->records);\n\t\t// get the number of the last record we are showing...this is used in the page links.\n\t\t// i.e.  \"showing 10-19 of 57\"...$this->last would be the 19 in that string\n\t\tif ($this->total_records > 0) {\n\t\t\t$this->firstrecord = $this->start + 1;\n\t\t\t$this->lastrecord = ($this->total_records < $this->limit) ? ($this->start + $this->total_records) : ($this->start + $this->limit);\n\t\t\tif ($this->lastrecord > $this->total_records || $this->lastrecord == 0)\n                $this->lastrecord = $this->total_records;\n\t\t} else {\n\t\t\t$this->firstrecord = 0;\n\t\t\t$this->lastrecord = 0;\n\t\t}\n\n\t\t// get the page parameters from the router to build the links\n        $page_params = $router->params;\n//\t\t$page_params = $this->cleanParams($router->params);\n        foreach (array(\"__utma\", \"__utmz\", \"route_sanitized\") as $key) {\n            if (isset($page_params[$key]))\n                unset($page_params[$key]);\n        }\n        if (!empty($page_params['search_string']))\n            $page_params['search_string'] = urlencode($page_params['search_string']);\n\n\t\t//if (empty($page_params['module'])) $page_params['module'] = $this->controller;\n\t\t//if (empty($page_params['action'])) $page_params['action'] = $this->action;\n\t\t//if (empty($page_params['src']) && isset($params['src'])) $page_params['src'] = $params['src'];\n\t\tif (!empty($this->controller)) {\n\t\t    unset($page_params['module']);\n\t\t    $page_params['controller'] = expModules::getModuleName($this->controller);\n\t\t} else {\n            if (expTheme::inAction() && empty($params)) {\n                //FIXME: module/controller glue code\n    //\t\t    $mod = !empty($_REQUEST['controller']) ? expString::sanitize($_REQUEST['controller']) : expString::sanitize($_REQUEST['module']);\n    //\t\t    if ($this->controller == $mod && $this->action == $_REQUEST['action']) {\n    //\t\t\t    $this->order = isset($_REQUEST['order']) ? $_REQUEST['order'] : $this->order;\n    //\t\t\t    $this->order_direction = isset($_REQUEST['dir']) ? $_REQUEST['dir'] : $this->dir;\n    //\t\t\t}\n                $mod = !empty($router->params['controller']) ? $router->params['controller'] : $router->params['module'];\n                if ($this->controller == $mod && $this->action == $router->params['action']) {\n                    $this->order = isset($router->params['order']) ? $router->params['order'] : $this->order;\n                    $this->order_direction = isset($router->params['dir']) ? $router->params['dir'] : $this->dir;\n                    if(!preg_match('/[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*/', $this->order))\n                        $this->order = 'id';\n                    if (!in_array($this->order_direction, array('ASC', 'DESC')))\n                        $this->order_direction = 'ASC';\n                }\n            } else {\n                if (isset($params->controller)) {\n                    $mod = $params->controller;\n                } else {\n                    $mod = '';\n                }\n            }\n            $page_params['controller'] = $mod;  // we can't be passing an empty controller or module to the router\n        }\n\n\t\tif (!empty($this->action))\n            $page_params['action'] =  $this->action;\n\t\tif (!empty($this->src))\n            $page_params['src'] =  $this->src;\n\n\t\tif (isset($page_params['section']))\n            unset($page_params['section']);\n\n\t\t//build a 'more' link we can use in the headlines views.\n\t\t$this->morelink = $router->makeLink($page_params, false, false, true);\n\n\t\tif (!empty($this->view))\n            $page_params['view'] = $this->view;\n\n\t\t//build a couple more links we can use in the views.\n\t\t$this->pagelink = $router->makeLink($page_params, false, false, true);\n\n\t\t// if don't have enough records for more than one page then we're done.\n\t\t//if ($this->total_records <= $this->limit) return true;\n\n\t\t$this->total_pages = ($this->limit > 0) ? ceil($this->total_records/$this->limit) : 0;\n\n        // correct current page # to be within limits of number of pages\n\t\tif ($this->page > $this->total_pages) {\n\t\t\t$this->page = $this->total_pages;\n            //FIXME return 404 error for infinite page scroll plugin\n            if (!empty($this->total_pages)) header(':', true, 404);\n\t\t}\n\n        // setup the previous link\n        if ($this->page > 1) {\n            $page_params['page'] = $this->page - 1;\n            $this->previous_pagenum = $this->page - 1;\n            $this->previous_page = $router->makeLink($page_params, false, false, true);\n            if (expTheme::is_mobile())\n                $this->pages_to_show--;\n        }\n\n        // setup the next link\n        if ($this->page < $this->total_pages) {\n            $page_params['page'] = $this->page + 1;\n            $this->next_pagenum = $this->page + 1;\n            $this->next_page = $router->makeLink($page_params, false, false, true);\n            if (expTheme::is_mobile())\n                $this->pages_to_show--;\n        }\n\n\t\t//setup the pages for the links\n\t\tif ($this->total_pages > $this->pages_to_show) {\n\t\t\t$this->first_pagelink = max(1, floor(($this->page) - ($this->pages_to_show) / 2));\n\t\t    $this->last_pagelink = $this->first_pagelink + $this->pages_to_show - 1;\n\t\t    if ($this->last_pagelink > $this->total_pages) {\n\t\t        $this->first_pagelink = max(1, $this->total_pages - $this->pages_to_show) + 1;\n\t\t        $this->last_pagelink = $this->total_pages;\n\t\t    }\n\t\t} else {\n\t\t\t$this->first_pagelink = 1;\n\t\t\t$this->last_pagelink = $this->total_pages;\n\t\t}\n\n\t\t// setup the previous 10 'group jump' link\n\t\tif ($this->page > $this->pages_to_show) {\n\t\t\t$page_params['page'] = $this->first_pagelink - 1;\n            $this->previous_shiftnum = $this->first_pagelink - 1;\n        \t$this->previous_shift = $router->makeLink($page_params, false, false, true);\n\t\t\t$page_params['page'] = 1;\n\t\t\t$this->firstpage = $router->makeLink($page_params, false, false, true);\n\t\t}\n\n\t\t// setup the next 10 'group jump' link\n\t\tif ($this->page < ($this->total_pages - $this->pages_to_show)) {\n            $page_params['page'] = $this->last_pagelink + 1;\n            $this->next_shiftnum = $this->last_pagelink + 1;\n            $this->next_shift = $router->makeLink($page_params, false, false, true);\n\t\t\t$page_params['page'] = $this->total_pages;\n\t\t\t$this->lastpage = $router->makeLink($page_params, false, false, true);\n        }\n\n\t\t// setup the links to the remaining pages being displayed.\n\t\tfor($i=$this->first_pagelink; $i<=$this->last_pagelink; $i++) {\n\t\t\t$page_params['page'] = $i;\n\t\t\t$this->pages[$i] = $router->makeLink($page_params, false, false, true);\n\t\t}\n\n\t\t$links_template = expTemplate::get_common_template('pagination_links', null, 'common');\n\t\t$links_template->assign('page', $this);\n\t\t$this->links = $links_template->render();\n\n\t\t$this->makeHeaderCols($page_params);  // headers for table view\n\n        $sortparams = array_merge($page_params, $router->params);\n\n\t\t//From Merge ****\n        if (isset($router->params['page']))\n            $sortparams['page'] = $router->params['page'];\n        else\n            unset($sortparams['page']);\n        //End From Merge ****\n\n\t\t$this->makeSortDropdown($sortparams);  // used on non-table views\n\n        $table_template = expTemplate::get_common_template('pagination_table', null, 'common');\n        $table_template->assign('page', $this);\n        $this->table = $table_template->render();  // table view\n\n\t}\n\n\t//From Merge\n    private function cleanParams($params) {\n        $defaultParams = array('title'=>'','module'=>'','controller'=>'','src'=>'','id'=>'','dir'=>'','_common'=>'');\n        $newParams = array();\n        $func = new ReflectionClass($this);\n        foreach ($params as $pKey=>$pVal) {\n            $propname = $pKey;\n            if (array_key_exists($propname,$defaultParams)) {\n                $newParams[$propname] = $params[$propname];\n            }\n        }\n        foreach ($func->getProperties() as $p) {\n            $propname = $p->name;\n            if (array_key_exists($propname,$params)) {\n                $newParams[$propname] = $params[$propname];\n            }\n        }\n\n        return $newParams;\n    }\n\n    public function makeHeaderCols($params) {\n        global $router;\n\n        if (!empty($this->columns) && is_array($this->columns)) {\n            $this->header_columns = '';\n\n            // get the parameters used to make this page.\n            if (!expTheme::inAction()) {\n                unset($params['section']);\n                if (empty($params['controller'])) $params['controller'] = $this->controller;\n                if (empty($params['action'])) $params['action'] = $this->action;\n            }\n\n//            $current = '';\n            if (isset($params['order'])) {\n                $current = $params['order'];\n                unset($params['order']);\n            } else {\n                $current = $this->order;\n            }\n\n            //loop over the columns and build out a list of <th>'s to be used in the page table\n            foreach ($this->columns as $colname=>$col) {\n                // if this is the column we are sorting on right now we need to setup some class info\n                $class = isset($this->class) ? $this->class : 'page';\n                $params['dir'] = 'ASC';\n\n                if ($col == $current) {\n                    $class  = 'current '.strtolower($this->order_direction);\n                    $params['dir'] = $this->order_direction == 'ASC' ? 'DESC' : 'ASC';\n                }\n\n                $params['order'] = $col;\n\n                $this->header_columns .= '<th class=\"'.$class.'\">';\n                // if this column is empty then it's not supposed to be a sortable column\n\n                if (empty($col)) {\n                    $this->header_columns .= '<span>'.$colname.'</span>';\n                    $this->columns[$colname] = ' ';\n                } else if($colname==\"actupon\") {\n                    $this->header_columns .= '<input type=checkbox name=selall id=selall value=1 class=\"select-all\"/>';\n\n//                    $js = \"\n//                    YUI(EXPONENT.YUI3_CONFIG).use('node', function(Y) {\n//                        Y.all('input[type=checkbox]').on('click',function(e){\n//                            if (e.target.test('.select-all')) {\n//                                if (!e.target.get('checked')) {\n//                                    this.each(function(n){\n//                                        n.set('checked',false);\n//                                    });\n//                                } else {\n//                                    this.each(function(n){\n//                                        n.set('checked',true);\n//                                    });\n//                                };\n//                            };\n//                        });\n//                    });\n//                    \";\n\n                    $js = \"\n                    $('#selall').change(function () {\n                        $('input[name=\\\"act-upon[]\\\"]').prop('checked', this.checked);\n                    });\n                    \";\n\n                    expJavascript::pushToFoot(array(\n                        \"unique\"=>'select-all',\n//                        \"yui3mods\"=>1,\n                        \"jquery\"=>1,\n                        \"content\"=>$js,\n//                        \"src\"=>\"\"\n                     ));\n\n                } else {\n\t\t\t\t\tunset($params['page']);  // we want to go back to the first page on a re-sort\n                    if ($col == 'no-sort') {\n                        $this->header_columns .= $colname;\n                    } else {\n                        $this->header_columns .= '<a href=\"'.$router->makeLink($params, false, false, true).'\" alt=\"sort by '.$colname.'\" rel=\"nofollow\">'.$colname.'</a>';\n                    }\n                }\n\n                $this->header_columns .= '</th>';\n            }\n        }\n    }\n\n    //here if we want to modify the record for some reason. e.g. Using in search results w/ products\n    private function runCallback() {\n        foreach ($this->records as &$record) {\n            if (isset($record->ref_type)) {\n                $refType = $record->ref_type;\n                if (class_exists($record->ref_type)) {\n                    $type = new $refType();\n                    $classinfo = new ReflectionClass($type);\n                    if ($classinfo->hasMethod('paginationCallback')) {\n                        $item = new $type($record->original_id);\n                        $item->paginationCallback($record);\n                    }\n                }\n            }\n        }\n    }\n\n\tpublic function makeSortDropdown($params) {\n\t\tglobal $router;\n\n\t\tif (!empty($this->columns) && is_array($this->columns)) {\n\t\t\t$this->sort_dropdown = array();\n\n\t\t\t// get the parameters used to make this page.\n\t\t\tif (!expTheme::inAction()) {\n\t\t\t\tunset($params['section']);\n\t\t\t\tif (empty($params['controller'])) $params['controller'] = $this->controller;\n\t\t\t\tif (empty($params['action'])) $params['action'] = $this->action;\n\t\t\t}\n\n\t\t\t/*$current = '';\n\t\t\tif (isset($params['order'])) {\n\t\t\t\t$current = $params['order'];\n\t\t\t\tunset($params['order']);\n\t\t\t} else {\n\t\t\t\t$current = $this->order;\n\t\t\t}  */\n\n\t\t\t//loop over the columns and build out a list of <th>'s to be used in the page table\n           // eDebug($router);\n            $defaultParams['controller'] = $params['controller'];\n            $defaultParams['action'] = $params['action'];\n            if (isset($params['title']))\n                $defaultParams['title'] = $params['title'];\n            if (isset($params['page']))\n                $defaultParams['page'] = $params['page'];\n\n            $this->sort_dropdown[$router->makeLink($defaultParams, false, false, true)] = \"Default\";\n\t\t\tforeach ($this->columns as $colname=>$col) {\n\t\t\t\t// if this is the column we are sorting on right now we need to setup some class info\n\t\t\t\t/*$class = isset($this->class) ? $this->class : 'page';\n\t\t\t\t$params['dir'] = 'ASC';*/\n\n\t\t\t\t/*if ($col == $current) {\n\t\t\t\t\t$class  = 'current';\n\t\t\t\t\t$class .= ' '.$this->order_direction;\n\t\t\t\t\tif (isset($params['dir'])) {\n\t\t\t\t\t\t$params['dir'] = $params['dir'] == 'ASC' ? 'DESC' : 'ASC';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$params['dir'] = $this->order_direction == 'ASC' ? 'DESC' : 'ASC';\n\t\t\t\t\t}\n\t\t\t\t}\n                */\n\t\t\t\t$params['order'] = $col;\n\n\t\t\t\tif (!empty($col)) {\n                    if ($colname == 'Price') {\n                        $params['dir'] = 'ASC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - Lowest to Highest\";\n                        $params['dir'] = 'DESC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - Highest to Lowest\";\n                    } else {\n                        $params['dir'] = 'ASC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - A-Z\";\n                        $params['dir'] = 'DESC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - Z-A\";\n                    }\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n    /** exdoc\n     * Object/Array sorting comparison function -- sorts by a specified column in ascending order.\n     * @node Subsystems:expPaginator\n     */\n    public function asc($a,$b) {\n        $col = $this->order;\n        if (is_object($a)) {\n            return ($a->$col < $b->$col ? -1 : 1);\n        } elseif (is_array($a)) {\n            return ($a[$col] < $b[$col] ? -1 : 1);\n        } else {\n            return ($a < $b ? -1 : 1);\n        }\n    }\n\n    /** exdoc\n     * Object/Array sorting comparison function -- sorts by a specified column in descending order.\n     * @node Subsystems:expPaginator\n     */\n    public function desc($a,$b) {\n        $col = $this->order;\n        if (is_object($a)) {\n            return ($a->$col > $b->$col ? -1 : 1);\n        } elseif (is_array($a)) {\n            return ($a[$col] > $b[$col] ? -1 : 1);\n        } else {\n            return ($a > $b ? -1 : 1);\n        }\n    }\n}\n\n?>", "<?php\n\n##################################################\n#\n# Copyright (c) 2004-2016 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * @subpackage Controllers\n * @package Modules\n */\n\nclass helpController extends expController {\n\tpublic $useractions = array(\n        'showall'=>'Show all',\n        'select_version'=>'Select Help Version'\n    );\n    public $remove_configs = array(\n        'categories',\n        'comments',\n        'ealerts',\n        'facebook',\n        'files',\n        'pagination',\n        'rss',\n        'tags',\n        'twitter',\n    );  // all options: ('aggregation','categories','comments','ealerts','facebook','files','pagination','rss','tags','twitter',)\n\n    static function displayname() { return gt(\"Help\"); }\n    static function description() { return gt(\"Manage Exponent CMS help files.\"); }\n    static function isSearchable() { return true; }\n\n    function __construct($src=null, $params=array()) {\n        parent::__construct($src,$params);\n        // only set the system help version if it's not already set as a session variable\n        if (!expSession::is_set('help-version')) {\n            $version = help_version::getCurrentHelpVersion();\n            if (empty($version)) {\n                // there is no help version set to 'is_current'\n                $hv = new help_version();\n           \t    $newversion = $hv->find('first','1');\n                if (!empty($newversion)) {\n                    $this->params['is_current'] = 1;\n             \t    $newversion->update($this->params);\n                    $version = $newversion->version;\n                }\n            }\n            if(!empty($params['version'])) {\n                $version = isset($params['version']) ? (($params['version'] == 'current') ? $version : $params['version']) : $version;\n            }\n            expSession::set('help-version',$version);\n        }\n        $this->help_version = expSession::get('help-version');\n\t}\n\n    /**\n     * Display list of help documents\n     */\n\tpublic function showall() {\n\t    expHistory::set('viewable', $this->params);\n\t    $hv = new help_version();\n\t    //$current_version = $hv->find('first', 'is_current=1');\n\t    $ref_version = $hv->find('first', 'version=\\''.$this->help_version.'\\'');\n\n        // pagination parameter..hard coded for now.\n\t\t$where = $this->aggregateWhereClause();\n\t    $where .= 'AND help_version_id='.(empty($ref_version->id)?'0':$ref_version->id);\n        if (empty($this->params['parent'])) {\n            $where .= ' AND (parent=0 OR parent IS NULL)';\n        } else {\n            $where .= ' AND parent=' . intval($this->params['parent']);\n        }\n//\t    $limit = 999;\n\t    $order = isset($this->config['order']) ? $this->config['order'] : 'rank';\n\n\t    // grab the pagination object\n\t\t$page = new expPaginator(array(\n            'model'=>'help',\n            'where'=> $where,\n//\t                'limit'=>$limit,\n            'order'=>$order,\n            'dir'=>'ASC',\n            'page'=>(isset($this->params['page']) ? $this->params['page'] : 1),\n            'controller'=>$this->baseclassname,\n            'action'=>$this->params['action'],\n            'src'=>$this->loc->src,\n            'columns'=>array(\n                gt('Title')=>'title',\n                gt('Details')=>'body',\n                gt('Version')=>'help_version_id'\n            ),\n        ));\n        $help = new help();\n\t    foreach ($page->records as $key=>$doc) {\n            $page->records[$key]->children = $help->find('count','parent='.$doc->id);\n        }\n\t    assign_to_template(array(\n            'current_version'=>$ref_version,\n            'page'=>$page,\n            'rank'=>($order==='rank')?1:0\n        ));\n\t}\n\n    /**\n     * Display a help document\n     */\n\tpublic function show() {\n\t    expHistory::set('viewable', $this->params);\n\t    $help = new help();\n        if (empty($this->params['version']) || $this->params['version'] == 'current') {\n            $version_id = help_version::getCurrentHelpVersionId();\n\t    } else {\n            $version_id = help_version::getHelpVersionId($this->params['version']);\n            if (empty($version_id)) {\n                $version_id = help_version::getCurrentHelpVersionId();\n            }\n\t    }\n\t    $this->params['title'] = expString::escape($this->params['title']);  // escape title to prevent sql injection\n\t    $doc = $help->find('first', 'help_version_id='.$version_id.' AND sef_url=\"'.$this->params['title'].'\"');\n        $children = $help->find('count','parent='.$doc->id);\n        if (empty($doc)) {\n            redirect_to(array('controller'=>'notfound','action'=>'page_not_found','title'=>$this->params['title']));\n        }\n        $config = expConfig::getConfig($doc->location_data);\n\n\t    assign_to_template(array(\n            'doc'=>$doc,\n            'children'=>$children,\n            \"hv\"=>$this->help_version,\n            'config'=>$config\n        ));\n\t}\n\n    /**\n     * Create or Edit a help document\n     */\n\tpublic function edit() {\n        global $db;\n\n\t    expHistory::set('editable', $this->params);\n\t    $id = empty($this->params['id']) ? null : $this->params['id'];\n\t    $help = new help($id);\n        if (!empty($this->params['copy'])) $help->id = null;\n\n\t    // get the id of the current version and use it if we need to.\n        if (expSession::is_set('help-version')) {\n            $version_id = help_version::getHelpVersionId(expSession::get('help-version'));  // version the site is currently using\n        } else {\n            $version_id = help_version::getCurrentHelpVersionId();\n        }\n\t    if (empty($help->help_version_id)) $help->help_version_id = $version_id;\n\n        $parentlist = array('0'=>'-- '.gt('Top Level Help Doc').' --');\n        $order = isset($this->config['order']) ? $this->config['order'] : 'rank';\n        $helpdocs = $help->find('all',\"help_version_id=\".$help->help_version_id.\" AND location_data='\".serialize($help->loc).\"'\",$order);\n        foreach ($helpdocs as $helpdoc) {\n            $parentlist[$helpdoc->id] = $helpdoc->title;\n        }\n\n\t\t$sectionlist = array();\n//        $helpsections = $help->find('all',\"help_version_id=\".$help->help_version_id);\n//\t\tforeach ($helpsections as $helpsection) {\n//\t\t\tif (!empty($helpsection->location_data)) {\n//\t\t\t\t$helpsrc = expUnserialize($helpsection->location_data);\n//\t\t\t\tif (!array_key_exists($helpsrc->src, $sectionlist)) {\n//                    $sectionlist[$helpsrc->src] = $db->selectValue('section', 'name', 'id=\"' . $db->selectValue('sectionref', 'section', 'module = \"help\" AND source=\"' . $helpsrc->src .'\"').'\"');\n//\t\t\t\t}\n//\t\t\t}\n//\t\t}\n        $helplocs = $help->findValue('all', 'location_data', \"help_version_id=\" . $version_id, null, true);\n        foreach ($helplocs as $helploc) {\n            if (!empty($helploc)) {\n                $helpsrc = expUnserialize($helploc);\n                $sectionlist[$helpsrc->src] = $db->selectValue('sectionref', 'section', 'module = \"help\" AND source=\"' . $helpsrc->src . '\"');\n            }\n        }\n        $sectionlist[$this->loc->src] .= ' '.gt(\"(current section)\");\n\n\t    assign_to_template(array(\n            'record'=>$help,\n            'parents'=>$parentlist,\n            \"current_section\"=>$this->loc->src,\n            \"sections\"=>$sectionlist\n        ));\n\t}\n\n    /**\n     * Manage help documents\n     */\n\tpublic function manage() {\n\t    expHistory::set('manageable', $this->params);\n\t    global $db;\n\n\t    $hv = new help_version();\n\t    $current_version = $hv->find('first', 'is_current=1');\n\n\t    if (empty($current_version)) {\n\t        flash('error', gt(\"You don't have any software versions created yet.  Please do so now.\"));\n\t        redirect_to(array('controller'=>'help', 'action'=>'edit_version'));\n//            $this->edit_version();\n\t    }\n\n        $sections = array();\n        foreach ($db->selectObjects('sectionref','module=\"help\"') as $sectionref) {\n            if (!empty($sectionref->source) && empty($sections[$sectionref->source])) {\n                $sections[$sectionref->source] = $db->selectValue('section', 'name', 'id=\"' . $sectionref->section .'\"');\n            }\n        }\n\n\t    $where = empty($this->params['version']) ? 1 : 'help_version_id='.intval($this->params['version']);\n\t    $page = new expPaginator(array(\n            'model'=>'help',\n            'where'=>$where,\n            'limit'=>30,\n            'order'      => (isset($this->params['order']) ? $this->params['order'] : 'help_version_id'),\n            'dir'        => (isset($this->params['dir']) ? $this->params['dir'] : 'DESC'),\n            'page'=>(isset($this->params['page']) ? $this->params['page'] : 1),\n            'controller'=>$this->baseclassname,\n            'action'=>$this->params['action'],\n            'src'=>$this->loc->src,\n            'columns'=>array(\n                gt('Title')=>'title',\n                gt('Version')=>'help_version_id',\n                gt('Section')=>'section',\n//                gt('Location')=>'location_data'\n            ),\n        ));\n\n\t    assign_to_template(array(\n            'current_version'=>$current_version,\n            'page'=>$page,\n            'sections'=>$sections\n        ));\n\t}\n\n    /**\n     * Routine to copy all existing help docs from a version to the new version\n     * @static\n     * @param $from\n     * @param $to\n     * @return bool\n     */\n\tprivate static function copydocs($from, $to) {\n\t    $help = new help();\n        $order = 'rank DESC';\n        $old_parents = $help->getHelpParents($from);\n        $new_parents = array();\n\n        // copy parent help docs\n\t    $current_docs = $help->find('all', 'help_version_id='.$from.' AND parent=0',$order);\n\t    foreach ($current_docs as $doc) {\n            $origid = $doc->id;\n\t        unset($doc->id);\n\t        $doc->help_version_id = $to;\n\n//\t        $tmpsef = $doc->sef_url;\n//\t        $doc->sef_url = \"\";\n//\t        $doc->save();\n//\t        $doc->sef_url = $tmpsef;\n//\t        $doc->do_not_validate = array('sef_url');\n\t        $doc->save();\n            if (in_array($origid, $old_parents)) {\n                $new_parents[$origid] = $doc->id;\n            }\n\n//\t        $doc->sef_url = $doc->makeSefUrl();\n//\t        $doc->save();\n\n\t        foreach($doc->expFile as $subtype=>$files) {\n\t            foreach($files as $file) {\n\t                $doc->attachItem($file, $subtype);\n\t            }\n\t        }\n\t    }\n\n        // copy child help docs\n        $current_docs = $help->find('all', 'help_version_id='.$from.' AND parent!=0',$order);\n   \t    foreach ($current_docs as $key=>$doc) {\n   \t        unset($doc->id);\n            $doc->parent = $new_parents[$doc->parent];\n   \t        $doc->help_version_id = $to;\n   \t        $doc->save();\n   \t        foreach($doc->expFile as $subtype=>$files) {\n   \t            foreach($files as $file) {\n   \t                $doc->attachItem($file, $subtype);\n   \t            }\n\n   \t        }\n   \t    }\n\n\t    // get version #'s for the two versions\n        $oldvers = help_version::getHelpVersion($from);\n        $newvers = help_version::getHelpVersion($to);\n\n\t    // send a message saying what we've done\n\t    flash('message', gt('Copied all docs from version').' '.$oldvers.' '.gt('to new version').' '.$newvers);\n\t    return true;\n\t}\n\n    /**\n     * Manage help versions\n     */\n\tpublic function manage_versions() {\n\t    expHistory::set('manageable', $this->params);\n\n\t    $hv = new help_version();\n\t    $current_version = $hv->find('first', 'is_current=1');\n\n\t    $sql  = 'SELECT hv.*, COUNT(h.title) AS num_docs FROM '.DB_TABLE_PREFIX.'_help h ';\n\t    $sql .= 'RIGHT JOIN '.DB_TABLE_PREFIX.'_help_version hv ON h.help_version_id=hv.id GROUP BY hv.version';\n\n\t    $page = new expPaginator(array(\n            'sql'=>$sql,\n            'limit'=>30,\n            'order'      => (isset($this->params['order']) ? $this->params['order'] : 'version'),\n            'dir'        => (isset($this->params['dir']) ? $this->params['dir'] : 'DESC'),\n            'page'=>(isset($this->params['page']) ? $this->params['page'] : 1),\n            'controller'=>$this->baseclassname,\n            'action'=>$this->params['action'],\n            'src'=>$this->loc->src,\n            'columns'=>array(\n                gt('Version')=>'version',\n                gt('Title')=>'title',\n                gt('Current')=>'is_current',\n                gt('# of Docs')=>'num_docs'\n            ),\n        ));\n\n\t    assign_to_template(array(\n            'current_version'=>$current_version,\n            'page'=>$page\n        ));\n\t}\n\n    /**\n     * Create or Edit details about a help version\n     */\n\tpublic function edit_version() {\n\t    expHistory::set('editable', $this->params);\n\t    $id = empty($this->params['id']) ? null : $this->params['id'];\n\t    $version = new help_version($id);\n\t    assign_to_template(array(\n            'record'=>$version\n        ));\n\t}\n\n    /**\n     * Delete a help version and all assoc docs\n     */\n\tpublic function delete_version() {\n\t    if (empty($this->params['id'])) {\n\t        flash('error', gt('The version you are trying to delete could not be found'));\n\t    }\n\n\t    // get the version\n\t    $version = new help_version($this->params['id']);\n\t    if (empty($version->id)) {\n\t        flash('error', gt('The version you are trying to delete could not be found'));\n\t    }\n\n\t    // if we have errors than lets get outta here!\n\t    if (!expQueue::isQueueEmpty('error')) expHistory::back();\n\n\t    // delete the version\n\t    $version->delete();\n\n\t    expSession::un_set('help-version');\n\n\t    flash('message', gt('Deleted version').' '.$version->version.' '.gt('and all documents in that version.'));\n\t    expHistory::back();\n\t}\n\n    /**\n     * Creates a new help version, possibly based on existing help version\n     */\n\tpublic function update_version() {\n\t    // get the current version\n\t    $hv = new help_version();\n\t    $current_version = $hv->find('first', 'is_current=1');\n\n\t    // check to see if the we have a new current version and unset the old current version.\n\t    if (!empty($this->params['is_current'])) {\n//\t        $db->sql('UPDATE '.DB_TABLE_PREFIX.'_help_version set is_current=0');\n            help_version::clearHelpVersion();\n\t    }\n\t    expSession::un_set('help-version');\n\n\t    // save the version\n\t    $id = empty($this->params['id']) ? null : $this->params['id'];\n\t    $version = new help_version();\n\t    // if we don't have a current version yet so we will force this one to be it\n\t    if (empty($current_version->id)) $this->params['is_current'] = 1;\n\t    $version->update($this->params);\n\n\t    // if this is a new version we need to copy over docs\n\t    if (empty($id)) {\n\t        self::copydocs($current_version->id, $version->id);\n\t    }\n        // let's update the search index to reflect the current help version\n        searchController::spider();\n\n\t    flash('message', gt('Saved help version').' '.$version->version);\n\t    expHistory::back();\n\t}\n\n    /**\n     * Switches current help version globally\n     */\n\tpublic function activate_version() {\n\t    // unset the old current version.\n        help_version::clearHelpVersion();\n\t    expSession::un_set('help-version');\n\n\t\t$id = $this->params['id'];\n\t    $version = new help_version($id);\n\t    $this->params['is_current'] = 1;\n\t    $version->update($this->params);\n        // let's update the search index to reflect the current help version\n        searchController::spider();\n\n\t    flash('message', gt('Changed active help version to').' '.$version->version);\n\t    expHistory::back();\n\t}\n\n    /**\n     * Displays available help versions\n     */\n\tpublic function select_version() {\n  \t    $hv = expSession::get('help-version');\n        $selected = help_version::getHelpVersionId($hv);\n        $versions = help_version::getHelpVersionsDropdown();\n   \t    assign_to_template(array(\n               'current_version'=>$hv,\n               'selected'=>$selected,\n               'versions'=>$versions\n           ));\n\t}\n\n    /**\n     * Switches current help version temporarily\n     */\n\tpublic function switch_version() {\n\t    // unset the current version.\n\t    expSession::un_set('help-version');\n        // set the requested version.\n        $version = help_version::getHelpVersion($this->params['version']);\n        expSession::set('help-version',$version);\n\t    flash('message', gt('Now displaying Help version').' '.$version);\n        expHistory::back();\n\t}\n\n    /**\n   \t * add only current version of docs to search index\n   \t * @return int\n   \t */\n   \tfunction addContentToSearch() {\n        global $db;\n\n       $count = 0;\n       $help = new help();\n       $where = 'help_version_id=\"'.help_version::getCurrentHelpVersionId().'\"';\n       $where .= (!empty($this->params['id'])) ? ' AND id='.$this->params['id'] : null;\n       $content = $db->selectArrays($help->tablename,$where);\n       foreach ($content as $cnt) {\n           $origid = $cnt['id'];\n           unset($cnt['id']);\n\n           // get the location data for this content\n//           if (isset($cnt['location_data'])) $loc = expUnserialize($cnt['location_data']);\n//           $src = isset($loc->src) ? $loc->src : null;\n//           $search_record = new search($cnt, false, false);\n           //build the search record and save it.\n           $sql = \"original_id=\" . $origid . \" AND ref_module='\" . $this->baseclassname . \"'\";\n           $oldindex = $db->selectObject('search', $sql);\n           if (!empty($oldindex)) {\n               $search_record = new search($oldindex->id, false, false);\n               $search_record->update($cnt);\n           } else {\n               $search_record = new search($cnt, false, false);\n           }\n\n           $search_record->original_id = $origid;\n           $search_record->posted = empty($cnt['created_at']) ? null : $cnt['created_at'];\n//           $link = str_replace(URL_FULL,'', makeLink(array('controller'=>$this->baseclassname, 'action'=>'show', 'title'=>$cnt['sef_url'])));\n           $link = str_replace(URL_FULL,'', makeLink(array('controller'=>$this->baseclassname, 'action'=>'show', 'title'=>$cnt['sef_url'])));\n//\t        if (empty($search_record->title)) $search_record->title = 'Untitled';\n           $search_record->view_link = $link;\n//           $search_record->ref_module = $this->classname;\n           $search_record->ref_module = $this->baseclassname;\n           $search_record->category = $this->searchName();\n           $search_record->ref_type = $this->searchCategory();\n           $search_record->save();\n           $count++;\n        }\n\n        return $count;\n   }\n\n    /**\n     * Hack to try and determine page which help doc is assoc with\n     * @static\n     * @param $params\n     * @return null|void\n     */\n\tpublic static function getSection($params) {\n\t    global $db;\n\n        $help = new help();\n        if (empty($params['version']) || $params['version']=='current') {\n            $version_id = help_version::getCurrentHelpVersionId();\n        } else {\n            $version_id = help_version::getHelpVersionId($params['version']);\n            if (empty($version_id)) {\n                $version_id = help_version::getCurrentHelpVersionId();\n            }\n        }\n        $doc = $help->find('first','help_version_id='.$version_id.' and sef_url=\"'.$params['title'].'\"');\n\t    $session_section = expSession::get('last_section') ? expSession::get('last_section') : 1 ;\n        $help_sectionref = $db->selectObject('sectionref','module=\"help\" AND source=\"'. expUnserialize($doc->location_data)->src.'\"');\n        $sid = !empty($help_sectionref) ? $help_sectionref->section : (($doc->section!=0) ? $doc->section : $session_section);\n        if (!expSession::get('last_section')) {\n            expSession::set('last_section',$sid);\n        }\n//\t    $section = $db->selectObject('section','id='. intval($sid));\n        $section = new section(intval($sid));\n\t    return $section;\n\t}\n\n}\n\n?>"], "fixing_code": ["<?php\n##################################################\n#\n# Copyright (c) 2004-2016 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * This is the class expPaginator\n * Exponent Pagination Subsystem\n *\n * The expPaginator class is used to retrieve objects from the database\n * and paginate them and optionally group the by category.\n * It automagically handles the calls to other pages\n * and has built-in sorting using the defined column headers.\n *\n * Usage Example:\n *\n * <code>\n *\n * $page = new expPaginator(array(\n *      'model'=>'faq',\n *      'where'=>1,\n *      'limit'=>25,\n *      'order'=>'rank',\n *      'controller'=>$this->baseclassname,\n *      'action'=>$this->params['action'],\n *      'columns'=>array('In FAQ'=>'include_in_faq', 'Submitted'=>'created_at', 'Submitted By'=>'submitter_name'),\n *  ));\n * </code>\n *\n * @package Subsystems\n * @subpackage Subsystems\n */\n\nclass expPaginator {\n    /**#@+\n     * @access public\n     * @var string\n     */\n\tpublic $model = null;\n    public $search_string = '';\n\tpublic $sql = '';\n    public $count_sql = '';\n\tpublic $where = '';\n\tpublic $controller = '';\n\tpublic $action = '';\n\tpublic $order = '';\n\tpublic $order_direction = '';\n\tpublic $firstpage = '';\n\tpublic $lastpage = '';\n\tpublic $previous_page = '';\n\tpublic $next_page = '';\n\tpublic $previous_shift = '';\n\tpublic $next_shift = '';\n\tpublic $pagelink = '';\n\tpublic $header_columns = '';\n\tpublic $default = '';\n\tpublic $view = null;\n    public $uncat ='';\n//    public $content_type = '';\n//    public $author = '';\n//    public $tag = '';\n//    public $tags = '';\n\t/**#@+\n     * @access public\n     * @var integer\n     */\n\tpublic $page  = 1;\n//\tpublic $limit = 10;\n    public $limit = 0;\n\tpublic $start = 0;\n\tpublic $last = 0;\n\tpublic $pages_to_show = 10;\n\tpublic $total_records = 0;\n\tpublic $total_pages = 0;\n\tpublic $page_offset = 0;\n    public $categorize = false;\n//    public $version = 0;\n//    public $content_id = 0;\n\t/**#@+\n     * @access public\n     * @var array\n     */\n\tpublic $pages = array();\n\tpublic $records = array();\n    public $cats = array();\n    public $sort_dropdown = array();\n\n\t/**\n\t * expPaginator Constructor\n\t *\n\t * This is the main entry point for using the expPaginator.  See example above.\n\t *\n\t * @param array $params Use this to set any of the class variables. Ones not passed will be set to a default.\n\t * @return \\expPaginator\n\t */\n\tpublic function __construct($params=array()) {\n\t\tglobal $router, $db;\n\n        $this->pages_to_show = expTheme::is_mobile() ? 6 : 10; // fewer paging links for small devices\n\t\t$this->where = empty($params['where']) ? null : $params['where'];\n\t\t$this->records = empty($params['records']) ? array() : $params['records'];\n//\t\t$this->limit = empty($params['limit']) ? 10 : $params['limit'];\n        $this->limit = empty($params['limit']) ? 0 : intval($params['limit']);\n        $this->page = empty($params['page']) ? 1 : intval($params['page']);\n\t\t$this->action = empty($params['action']) ? '' : $params['action'];\n\t\t$this->controller = empty($params['controller']) ? '' : $params['controller'];\n\t\t$this->sql = empty($params['sql']) ? '' : $params['sql'];\n        $this->count_sql = empty($params['count_sql']) ? '' : $params['count_sql'];\n        $this->order = empty($params['order']) ? 'id' : preg_replace('/[^a-z\\_]/i','',$params['order']);\n\t\t$this->dir = empty($params['dir']) || !in_array($params['dir'], array('ASC', 'DESC')) ? 'ASC' : $params['dir'];\n\t\t$this->src = empty($params['src']) ? null : expString::escape($params['src']);\n        $this->categorize = empty($params['categorize']) ? false : $params['categorize'];\n        $this->uncat = !empty($params['uncat']) ? $params['uncat'] : gt('Not Categorized');\n        $this->groups = !empty($params['groups']) ? $params['groups'] : array();\n        $this->grouplimit = !empty($params['grouplimit']) ? $params['grouplimit'] : null;\n        $this->dontsortwithincat = !empty($params['dontsortwithincat']) ? $params['dontsortwithincat'] : null;\n        $this->dontsort = !empty($params['dontsort']) ? $params['dontsort'] : null;\n\n\t\t// if a view was passed we'll use it.\n\t\tif (isset($params['view']))\n            $this->view = $params['view'];\n\n        // setup the model if one was passed.\n        if (isset($params['model'])) {\n            $this->model = $params['model'];\n            $class = new $this->model(null, false, false);\n        }\n\n\t    // auto-include the CSS for pagination links\n\t    expCSS::pushToHead(array(\n//\t\t    \"unique\"=>\"pagination\",\n//\t\t    \"link\"=>PATH_RELATIVE.\"framework/core/assets/css/pagination.css\",\n            'corecss'=>'pagination'\n\t\t    )\n\t\t);\n\n\t\tif ($this->limit)\n            $this->start = (($this->page * $this->limit) - $this->limit);\n        if ($this->start < 0)\n            $this->start = 0;\n\n\t\t//setup the columns\n        $this->columns = array();\n\t\tif (isset($params['columns'])) {\n\t\t    foreach($params['columns'] as $key=>$col){\n\t\t        $colparse[$key] = explode('|',$col);\n\t\t        $column = array($key=>$colparse[$key][0]);\n\t\t        $this->columns = array_merge($this->columns,$column);\n\t\t        if (!empty($colparse[$key][1])) {\n\t\t            $params = explode(',',$colparse[$key][1]);\n\t\t            foreach ($params as $paramval) {\n\t\t                $prm = explode('=',$paramval);\n\t\t                $this->linkables[$key][$prm[0]] = $prm[1];\n\t\t            }\n\t\t        }\n\t\t    }\n\t\t}\n\n\t\t//setup the default ordering of records\n\t\t// if we are in an action, see if the action is for this controller/action..if so pull the order\n\t\t// and order direction from the request params...this is how the params are passed via the column\n\t\t// headers.\n\t\t$this->order_direction = $this->dir;\n\n        // allow passing of a single order/dir as stored in config\n        if (strstr($this->order,\" \")) {\n            $orderby = explode(\" \",$this->order);\n            $this->order = $orderby[0];\n            $this->order_direction = $orderby[1];\n        }\n        if(!preg_match('/[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*/', $this->order))\n            $this->order = 'id';\n        if (!in_array($this->order_direction, array('ASC', 'DESC')))\n            $this->order_direction = 'ASC';\n        if ($this->dontsort)\n            $sort = null;\n        else\n            $sort = $this->order.' '.$this->order_direction;\n\n\t\t// figure out how many records we're dealing with & grab the records\n\t\t//if (!empty($this->records)) { //from Merge <~~ this doesn't work. Could be empty, but still need to hit.\n        if (!empty($this->categorize))\n            $limit = null;\n        else\n            $limit = $this->limit;\n\n\t\tif (isset($params['records'])) { // if we pass $params['records'], we WANT to hit this\n\t\t    // sort the records that were passed in to us\n            if (!empty($sort))\n                usort($this->records,array('expPaginator', strtolower($this->order_direction)));\n//\t\t    $this->total_records = count($this->records);\n\t\t} elseif (!empty($class)) { //where clause     //FJD: was $this->class, but wasn't working...\n\t\t\t$this->total_records = $class->find('count', $this->where);\n            $this->records = $class->find('all', $this->where, $sort, $limit, $this->start);\n\t\t} elseif (!empty($this->where)) { //from Merge....where clause\n\t\t\t$this->total_records = $class->find('count', $this->where);\n            $this->records = $class->find('all', $this->where, $sort, $limit, $this->start);\n\t\t} else { //sql clause  //FIXME we don't get attachments in this approach\n\t\t\t//$records = $db->selectObjectsBySql($this->sql);\n\t\t\t//$this->total_records = count($records);\n            //this is MUCH faster if you supply a proper count_sql param using a COUNT() function; if not,\n            //we'll run the standard sql and do a queryRows with it\n\t\t\t//$this->total_records = $this->count_sql == '' ? $db->queryRows($this->sql) : $db->selectValueBySql($this->count_sql); //From Merge\n\n//\t\t\t$this->total_records =  $db->countObjectsBySql($this->count_sql); //$db->queryRows($this->sql); //From most current Trunk\n\n            if (!empty($sort)) $this->sql .= ' ORDER BY '.$sort;\n            if (!empty($this->count_sql)) $this->total_records = $db->countObjectsBySql($this->count_sql);\n\t\t\tif (!empty($this->limit)) $this->sql .= ' LIMIT '.$this->start.','.$this->limit;\n\n\t\t\t$this->records = array();\n\t\t\tif (isset($this->model) || isset($params['model_field'])) {\n\t\t\t    foreach($db->selectObjectsBySql($this->sql) as $record) {\n                    $type = $params['model_field'];\n\t\t\t        $classname = isset($params['model_field']) ? $record->$type : $this->model;\n\t\t\t        //$this->records[] = new $classname($record->id, true, true); //From current trunk // added false, true, as we shouldn't need associated items here, but do need attached. FJD.\n\t\t\t\t\t$this->records[] = new $classname($record->id, false, true); //From Merge //added false, true, as we shouldn't need associated items here, but do need attached. FJD.\n\t\t\t    }\n\t\t\t} else {\n\t\t\t    $this->records = $db->selectObjectsBySql($this->sql);\n\t\t\t}\n\t\t}\n\n        // next we'll sort them based on categories if needed\n        if (!empty($this->categorize) && $this->categorize && empty($this->dontsort))\n            expCatController::addCats($this->records,$sort,$this->uncat,$this->groups,$this->dontsortwithincat);\n\n        // let's see how many total records there are\n        if (empty($this->total_records))\n            $this->total_records = count($this->records);\n        if ($this->limit && $this->start >= $this->total_records)\n            $this->start = $this->total_records - $this->limit;\n\n        // at this point we generally have all our records, now we'll trim the records to the number requested\n        //FIXME we may want some more intelligent selection here based on cats/groups, e.g., don't break groups across pages, number of picture rows, etc...\n        if (empty($this->grouplimit) && ($this->limit) && count($this->records) > $this->limit)\n            $this->records = array_slice($this->records, $this->start, $this->limit);\n        // finally, we'll create another multi-dimensional array of categories populated with assoc items\n        if (empty($this->dontsort)) {\n            if (!empty($this->categorize) && $this->categorize) {\n                expCatController::sortedByCats($this->records,$this->cats,$this->groups,$this->grouplimit);\n            } elseif (empty($this->dontsortwithincat)) {  // categorized is off, so let's categorize by alpha instead for 'rolodex' type use\n                $order = $this->order;\n                if (in_array($order,array('created_at','edited_at','publish'))) {\n                    if ($this->total_records && (abs($this->records[0]->$order - $this->records[count($this->records)-1]->$order)  >= (60 * 60 * 24 *365 *2))) {\n                        $datetype = 'Y';  // more than 2 years of records, so break down by year\n                    } else {\n                        $datetype = 'M Y';  // less than 2 years of records, so break down by month/year\n                    }\n                    foreach ($this->records as $record) {\n                        if (is_numeric($record->$order)) {\n                            $title = date($datetype,$record->$order);\n                            $title = empty($title)?gt('Undated'):$title;\n                        } else {\n                            $title = gt('Undated');\n                        }\n                        if (empty($this->cats[$title])) {\n                            $this->cats[$title] = new stdClass();\n                            $this->cats[$title]->count = 1;\n                            $this->cats[$title]->name = $title;\n                        } else {\n                            $this->cats[$title]->count++;\n                        }\n                        $this->cats[$title]->records[] = $record;\n                    }\n                } else {\n                    foreach ($this->records as $record) {\n                        if (!empty($record->$order) && is_string($record->$order) && !is_numeric($record->$order)) {\n                            $title = ucfirst($record->$order);\n                            $title = empty($title[0])?'':$title[0];\n                        } else {\n                            $title = '';\n                        }\n                        if (empty($this->cats[$title])) {\n                            $this->cats[$title] = new stdClass();\n                            $this->cats[$title]->count = 1;\n                            $this->cats[$title]->name = $title;\n                        } else {\n                            $this->cats[$title]->count++;\n                        }\n                        $this->cats[$title]->records[] = $record;\n                    }\n                }\n            }\n            if (!empty($this->grouplimit)) {\n                if ($this->limit)\n                    $this->records = array_slice($this->records, $this->start, $this->limit);\n            } else {\n                if ($this->limit)\n                    $this->cats = array_slice($this->cats, $this->start, $this->limit);\n            }\n        }\n\n        if (isset($params['records']))\n            $this->runCallback(); // isset($params['records']) added to correct search for products.\n\n        //eDebug($this->records);\n\t\t// get the number of the last record we are showing...this is used in the page links.\n\t\t// i.e.  \"showing 10-19 of 57\"...$this->last would be the 19 in that string\n\t\tif ($this->total_records > 0) {\n\t\t\t$this->firstrecord = $this->start + 1;\n\t\t\t$this->lastrecord = ($this->total_records < $this->limit) ? ($this->start + $this->total_records) : ($this->start + $this->limit);\n\t\t\tif ($this->lastrecord > $this->total_records || $this->lastrecord == 0)\n                $this->lastrecord = $this->total_records;\n\t\t} else {\n\t\t\t$this->firstrecord = 0;\n\t\t\t$this->lastrecord = 0;\n\t\t}\n\n\t\t// get the page parameters from the router to build the links\n        $page_params = $router->params;\n//\t\t$page_params = $this->cleanParams($router->params);\n        foreach (array(\"__utma\", \"__utmz\", \"route_sanitized\") as $key) {\n            if (isset($page_params[$key]))\n                unset($page_params[$key]);\n        }\n        if (!empty($page_params['search_string']))\n            $page_params['search_string'] = urlencode($page_params['search_string']);\n\n\t\t//if (empty($page_params['module'])) $page_params['module'] = $this->controller;\n\t\t//if (empty($page_params['action'])) $page_params['action'] = $this->action;\n\t\t//if (empty($page_params['src']) && isset($params['src'])) $page_params['src'] = $params['src'];\n\t\tif (!empty($this->controller)) {\n\t\t    unset($page_params['module']);\n\t\t    $page_params['controller'] = expModules::getModuleName($this->controller);\n\t\t} else {\n            if (expTheme::inAction() && empty($params)) {\n                //FIXME: module/controller glue code\n    //\t\t    $mod = !empty($_REQUEST['controller']) ? expString::sanitize($_REQUEST['controller']) : expString::sanitize($_REQUEST['module']);\n    //\t\t    if ($this->controller == $mod && $this->action == $_REQUEST['action']) {\n    //\t\t\t    $this->order = isset($_REQUEST['order']) ? $_REQUEST['order'] : $this->order;\n    //\t\t\t    $this->order_direction = isset($_REQUEST['dir']) ? $_REQUEST['dir'] : $this->dir;\n    //\t\t\t}\n                $mod = !empty($router->params['controller']) ? $router->params['controller'] : $router->params['module'];\n                if ($this->controller == $mod && $this->action == $router->params['action']) {\n                    $this->order = isset($router->params['order']) ? $router->params['order'] : $this->order;\n                    $this->order_direction = isset($router->params['dir']) ? $router->params['dir'] : $this->dir;\n                    if(!preg_match('/[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*/', $this->order))\n                        $this->order = 'id';\n                    if (!in_array($this->order_direction, array('ASC', 'DESC')))\n                        $this->order_direction = 'ASC';\n                }\n            } else {\n                if (isset($params->controller)) {\n                    $mod = $params->controller;\n                } else {\n                    $mod = '';\n                }\n            }\n            $page_params['controller'] = $mod;  // we can't be passing an empty controller or module to the router\n        }\n\n\t\tif (!empty($this->action))\n            $page_params['action'] =  $this->action;\n\t\tif (!empty($this->src))\n            $page_params['src'] =  $this->src;\n\n\t\tif (isset($page_params['section']))\n            unset($page_params['section']);\n\n\t\t//build a 'more' link we can use in the headlines views.\n\t\t$this->morelink = $router->makeLink($page_params, false, false, true);\n\n\t\tif (!empty($this->view))\n            $page_params['view'] = $this->view;\n\n\t\t//build a couple more links we can use in the views.\n\t\t$this->pagelink = $router->makeLink($page_params, false, false, true);\n\n\t\t// if don't have enough records for more than one page then we're done.\n\t\t//if ($this->total_records <= $this->limit) return true;\n\n\t\t$this->total_pages = ($this->limit > 0) ? ceil($this->total_records/$this->limit) : 0;\n\n        // correct current page # to be within limits of number of pages\n\t\tif ($this->page > $this->total_pages) {\n\t\t\t$this->page = $this->total_pages;\n            //FIXME return 404 error for infinite page scroll plugin\n            if (!empty($this->total_pages)) header(':', true, 404);\n\t\t}\n\n        // setup the previous link\n        if ($this->page > 1) {\n            $page_params['page'] = $this->page - 1;\n            $this->previous_pagenum = $this->page - 1;\n            $this->previous_page = $router->makeLink($page_params, false, false, true);\n            if (expTheme::is_mobile())\n                $this->pages_to_show--;\n        }\n\n        // setup the next link\n        if ($this->page < $this->total_pages) {\n            $page_params['page'] = $this->page + 1;\n            $this->next_pagenum = $this->page + 1;\n            $this->next_page = $router->makeLink($page_params, false, false, true);\n            if (expTheme::is_mobile())\n                $this->pages_to_show--;\n        }\n\n\t\t//setup the pages for the links\n\t\tif ($this->total_pages > $this->pages_to_show) {\n\t\t\t$this->first_pagelink = max(1, floor(($this->page) - ($this->pages_to_show) / 2));\n\t\t    $this->last_pagelink = $this->first_pagelink + $this->pages_to_show - 1;\n\t\t    if ($this->last_pagelink > $this->total_pages) {\n\t\t        $this->first_pagelink = max(1, $this->total_pages - $this->pages_to_show) + 1;\n\t\t        $this->last_pagelink = $this->total_pages;\n\t\t    }\n\t\t} else {\n\t\t\t$this->first_pagelink = 1;\n\t\t\t$this->last_pagelink = $this->total_pages;\n\t\t}\n\n\t\t// setup the previous 10 'group jump' link\n\t\tif ($this->page > $this->pages_to_show) {\n\t\t\t$page_params['page'] = $this->first_pagelink - 1;\n            $this->previous_shiftnum = $this->first_pagelink - 1;\n        \t$this->previous_shift = $router->makeLink($page_params, false, false, true);\n\t\t\t$page_params['page'] = 1;\n\t\t\t$this->firstpage = $router->makeLink($page_params, false, false, true);\n\t\t}\n\n\t\t// setup the next 10 'group jump' link\n\t\tif ($this->page < ($this->total_pages - $this->pages_to_show)) {\n            $page_params['page'] = $this->last_pagelink + 1;\n            $this->next_shiftnum = $this->last_pagelink + 1;\n            $this->next_shift = $router->makeLink($page_params, false, false, true);\n\t\t\t$page_params['page'] = $this->total_pages;\n\t\t\t$this->lastpage = $router->makeLink($page_params, false, false, true);\n        }\n\n\t\t// setup the links to the remaining pages being displayed.\n\t\tfor($i=$this->first_pagelink; $i<=$this->last_pagelink; $i++) {\n\t\t\t$page_params['page'] = $i;\n\t\t\t$this->pages[$i] = $router->makeLink($page_params, false, false, true);\n\t\t}\n\n\t\t$links_template = expTemplate::get_common_template('pagination_links', null, 'common');\n\t\t$links_template->assign('page', $this);\n\t\t$this->links = $links_template->render();\n\n\t\t$this->makeHeaderCols($page_params);  // headers for table view\n\n        $sortparams = array_merge($page_params, $router->params);\n\n\t\t//From Merge ****\n        if (isset($router->params['page']))\n            $sortparams['page'] = $router->params['page'];\n        else\n            unset($sortparams['page']);\n        //End From Merge ****\n\n\t\t$this->makeSortDropdown($sortparams);  // used on non-table views\n\n        $table_template = expTemplate::get_common_template('pagination_table', null, 'common');\n        $table_template->assign('page', $this);\n        $this->table = $table_template->render();  // table view\n\n\t}\n\n\t//From Merge\n    private function cleanParams($params) {\n        $defaultParams = array('title'=>'','module'=>'','controller'=>'','src'=>'','id'=>'','dir'=>'','_common'=>'');\n        $newParams = array();\n        $func = new ReflectionClass($this);\n        foreach ($params as $pKey=>$pVal) {\n            $propname = $pKey;\n            if (array_key_exists($propname,$defaultParams)) {\n                $newParams[$propname] = $params[$propname];\n            }\n        }\n        foreach ($func->getProperties() as $p) {\n            $propname = $p->name;\n            if (array_key_exists($propname,$params)) {\n                $newParams[$propname] = $params[$propname];\n            }\n        }\n\n        return $newParams;\n    }\n\n    public function makeHeaderCols($params) {\n        global $router;\n\n        if (!empty($this->columns) && is_array($this->columns)) {\n            $this->header_columns = '';\n\n            // get the parameters used to make this page.\n            if (!expTheme::inAction()) {\n                unset($params['section']);\n                if (empty($params['controller'])) $params['controller'] = $this->controller;\n                if (empty($params['action'])) $params['action'] = $this->action;\n            }\n\n//            $current = '';\n            if (isset($params['order'])) {\n                $current = $params['order'];\n                unset($params['order']);\n            } else {\n                $current = $this->order;\n            }\n\n            //loop over the columns and build out a list of <th>'s to be used in the page table\n            foreach ($this->columns as $colname=>$col) {\n                // if this is the column we are sorting on right now we need to setup some class info\n                $class = isset($this->class) ? $this->class : 'page';\n                $params['dir'] = 'ASC';\n\n                if ($col == $current) {\n                    $class  = 'current '.strtolower($this->order_direction);\n                    $params['dir'] = $this->order_direction == 'ASC' ? 'DESC' : 'ASC';\n                }\n\n                $params['order'] = $col;\n\n                $this->header_columns .= '<th class=\"'.$class.'\">';\n                // if this column is empty then it's not supposed to be a sortable column\n\n                if (empty($col)) {\n                    $this->header_columns .= '<span>'.$colname.'</span>';\n                    $this->columns[$colname] = ' ';\n                } else if($colname==\"actupon\") {\n                    $this->header_columns .= '<input type=checkbox name=selall id=selall value=1 class=\"select-all\"/>';\n\n//                    $js = \"\n//                    YUI(EXPONENT.YUI3_CONFIG).use('node', function(Y) {\n//                        Y.all('input[type=checkbox]').on('click',function(e){\n//                            if (e.target.test('.select-all')) {\n//                                if (!e.target.get('checked')) {\n//                                    this.each(function(n){\n//                                        n.set('checked',false);\n//                                    });\n//                                } else {\n//                                    this.each(function(n){\n//                                        n.set('checked',true);\n//                                    });\n//                                };\n//                            };\n//                        });\n//                    });\n//                    \";\n\n                    $js = \"\n                    $('#selall').change(function () {\n                        $('input[name=\\\"act-upon[]\\\"]').prop('checked', this.checked);\n                    });\n                    \";\n\n                    expJavascript::pushToFoot(array(\n                        \"unique\"=>'select-all',\n//                        \"yui3mods\"=>1,\n                        \"jquery\"=>1,\n                        \"content\"=>$js,\n//                        \"src\"=>\"\"\n                     ));\n\n                } else {\n\t\t\t\t\tunset($params['page']);  // we want to go back to the first page on a re-sort\n                    if ($col == 'no-sort') {\n                        $this->header_columns .= $colname;\n                    } else {\n                        $this->header_columns .= '<a href=\"'.$router->makeLink($params, false, false, true).'\" alt=\"sort by '.$colname.'\" rel=\"nofollow\">'.$colname.'</a>';\n                    }\n                }\n\n                $this->header_columns .= '</th>';\n            }\n        }\n    }\n\n    //here if we want to modify the record for some reason. e.g. Using in search results w/ products\n    private function runCallback() {\n        foreach ($this->records as &$record) {\n            if (isset($record->ref_type)) {\n                $refType = $record->ref_type;\n                if (class_exists($record->ref_type)) {\n                    $type = new $refType();\n                    $classinfo = new ReflectionClass($type);\n                    if ($classinfo->hasMethod('paginationCallback')) {\n                        $item = new $type($record->original_id);\n                        $item->paginationCallback($record);\n                    }\n                }\n            }\n        }\n    }\n\n\tpublic function makeSortDropdown($params) {\n\t\tglobal $router;\n\n\t\tif (!empty($this->columns) && is_array($this->columns)) {\n\t\t\t$this->sort_dropdown = array();\n\n\t\t\t// get the parameters used to make this page.\n\t\t\tif (!expTheme::inAction()) {\n\t\t\t\tunset($params['section']);\n\t\t\t\tif (empty($params['controller'])) $params['controller'] = $this->controller;\n\t\t\t\tif (empty($params['action'])) $params['action'] = $this->action;\n\t\t\t}\n\n\t\t\t/*$current = '';\n\t\t\tif (isset($params['order'])) {\n\t\t\t\t$current = $params['order'];\n\t\t\t\tunset($params['order']);\n\t\t\t} else {\n\t\t\t\t$current = $this->order;\n\t\t\t}  */\n\n\t\t\t//loop over the columns and build out a list of <th>'s to be used in the page table\n           // eDebug($router);\n            $defaultParams['controller'] = $params['controller'];\n            $defaultParams['action'] = $params['action'];\n            if (isset($params['title']))\n                $defaultParams['title'] = $params['title'];\n            if (isset($params['page']))\n                $defaultParams['page'] = $params['page'];\n\n            $this->sort_dropdown[$router->makeLink($defaultParams, false, false, true)] = \"Default\";\n\t\t\tforeach ($this->columns as $colname=>$col) {\n\t\t\t\t// if this is the column we are sorting on right now we need to setup some class info\n\t\t\t\t/*$class = isset($this->class) ? $this->class : 'page';\n\t\t\t\t$params['dir'] = 'ASC';*/\n\n\t\t\t\t/*if ($col == $current) {\n\t\t\t\t\t$class  = 'current';\n\t\t\t\t\t$class .= ' '.$this->order_direction;\n\t\t\t\t\tif (isset($params['dir'])) {\n\t\t\t\t\t\t$params['dir'] = $params['dir'] == 'ASC' ? 'DESC' : 'ASC';\n\t\t\t\t\t} else {\n\t\t\t\t\t\t$params['dir'] = $this->order_direction == 'ASC' ? 'DESC' : 'ASC';\n\t\t\t\t\t}\n\t\t\t\t}\n                */\n\t\t\t\t$params['order'] = $col;\n\n\t\t\t\tif (!empty($col)) {\n                    if ($colname == 'Price') {\n                        $params['dir'] = 'ASC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - Lowest to Highest\";\n                        $params['dir'] = 'DESC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - Highest to Lowest\";\n                    } else {\n                        $params['dir'] = 'ASC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - A-Z\";\n                        $params['dir'] = 'DESC';\n                        $this->sort_dropdown[$router->makeLink($params, false, false, true)] = $colname . \" - Z-A\";\n                    }\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n    /** exdoc\n     * Object/Array sorting comparison function -- sorts by a specified column in ascending order.\n     * @node Subsystems:expPaginator\n     */\n    public function asc($a,$b) {\n        $col = $this->order;\n        if (is_object($a)) {\n            return ($a->$col < $b->$col ? -1 : 1);\n        } elseif (is_array($a)) {\n            return ($a[$col] < $b[$col] ? -1 : 1);\n        } else {\n            return ($a < $b ? -1 : 1);\n        }\n    }\n\n    /** exdoc\n     * Object/Array sorting comparison function -- sorts by a specified column in descending order.\n     * @node Subsystems:expPaginator\n     */\n    public function desc($a,$b) {\n        $col = $this->order;\n        if (is_object($a)) {\n            return ($a->$col > $b->$col ? -1 : 1);\n        } elseif (is_array($a)) {\n            return ($a[$col] > $b[$col] ? -1 : 1);\n        } else {\n            return ($a > $b ? -1 : 1);\n        }\n    }\n}\n\n?>", "<?php\n\n##################################################\n#\n# Copyright (c) 2004-2016 OIC Group, Inc.\n#\n# This file is part of Exponent\n#\n# Exponent is free software; you can redistribute\n# it and/or modify it under the terms of the GNU\n# General Public License as published by the Free\n# Software Foundation; either version 2 of the\n# License, or (at your option) any later version.\n#\n# GPL: http://www.gnu.org/licenses/gpl.txt\n#\n##################################################\n\n/**\n * @subpackage Controllers\n * @package Modules\n */\n\nclass helpController extends expController {\n\tpublic $useractions = array(\n        'showall'=>'Show all',\n        'select_version'=>'Select Help Version'\n    );\n    public $remove_configs = array(\n        'categories',\n        'comments',\n        'ealerts',\n        'facebook',\n        'files',\n        'pagination',\n        'rss',\n        'tags',\n        'twitter',\n    );  // all options: ('aggregation','categories','comments','ealerts','facebook','files','pagination','rss','tags','twitter',)\n\n    static function displayname() { return gt(\"Help\"); }\n    static function description() { return gt(\"Manage Exponent CMS help files.\"); }\n    static function isSearchable() { return true; }\n\n    function __construct($src=null, $params=array()) {\n        parent::__construct($src,$params);\n        // only set the system help version if it's not already set as a session variable\n        if (!expSession::is_set('help-version')) {\n            $version = help_version::getCurrentHelpVersion();\n            if (empty($version)) {\n                // there is no help version set to 'is_current'\n                $hv = new help_version();\n           \t    $newversion = $hv->find('first','1');\n                if (!empty($newversion)) {\n                    $this->params['is_current'] = 1;\n             \t    $newversion->update($this->params);\n                    $version = $newversion->version;\n                }\n            }\n            if(!empty($params['version'])) {\n                $params['version'] = expString::escape($params['version']);\n                $version = isset($params['version']) ? (($params['version'] == 'current') ? $version : $params['version']) : $version;\n            }\n            expSession::set('help-version',$version);\n        }\n        $this->help_version = expSession::get('help-version');\n\t}\n\n    /**\n     * Display list of help documents\n     */\n\tpublic function showall() {\n\t    expHistory::set('viewable', $this->params);\n\t    $hv = new help_version();\n\t    //$current_version = $hv->find('first', 'is_current=1');\n\t    $ref_version = $hv->find('first', 'version=\\''.$this->help_version.'\\'');\n\n        // pagination parameter..hard coded for now.\n\t\t$where = $this->aggregateWhereClause();\n\t    $where .= 'AND help_version_id='.(empty($ref_version->id)?'0':$ref_version->id);\n        if (empty($this->params['parent'])) {\n            $where .= ' AND (parent=0 OR parent IS NULL)';\n        } else {\n            $where .= ' AND parent=' . intval($this->params['parent']);\n        }\n//\t    $limit = 999;\n\t    $order = isset($this->config['order']) ? $this->config['order'] : 'rank';\n\n\t    // grab the pagination object\n\t\t$page = new expPaginator(array(\n            'model'=>'help',\n            'where'=> $where,\n//\t                'limit'=>$limit,\n            'order'=>$order,\n            'dir'=>'ASC',\n            'page'=>(isset($this->params['page']) ? $this->params['page'] : 1),\n            'controller'=>$this->baseclassname,\n            'action'=>$this->params['action'],\n            'src'=>$this->loc->src,\n            'columns'=>array(\n                gt('Title')=>'title',\n                gt('Details')=>'body',\n                gt('Version')=>'help_version_id'\n            ),\n        ));\n        $help = new help();\n\t    foreach ($page->records as $key=>$doc) {\n            $page->records[$key]->children = $help->find('count','parent='.$doc->id);\n        }\n\t    assign_to_template(array(\n            'current_version'=>$ref_version,\n            'page'=>$page,\n            'rank'=>($order==='rank')?1:0\n        ));\n\t}\n\n    /**\n     * Display a help document\n     */\n\tpublic function show() {\n\t    expHistory::set('viewable', $this->params);\n\t    $help = new help();\n        if (empty($this->params['version']) || $this->params['version'] == 'current') {\n            $version_id = help_version::getCurrentHelpVersionId();\n\t    } else {\n            $version_id = help_version::getHelpVersionId($this->params['version']);\n            if (empty($version_id)) {\n                $version_id = help_version::getCurrentHelpVersionId();\n            }\n\t    }\n\t    $this->params['title'] = expString::escape($this->params['title']);  // escape title to prevent sql injection\n\t    $doc = $help->find('first', 'help_version_id='.$version_id.' AND sef_url=\"'.$this->params['title'].'\"');\n        $children = $help->find('count','parent='.$doc->id);\n        if (empty($doc)) {\n            redirect_to(array('controller'=>'notfound','action'=>'page_not_found','title'=>$this->params['title']));\n        }\n        $config = expConfig::getConfig($doc->location_data);\n\n\t    assign_to_template(array(\n            'doc'=>$doc,\n            'children'=>$children,\n            \"hv\"=>$this->help_version,\n            'config'=>$config\n        ));\n\t}\n\n    /**\n     * Create or Edit a help document\n     */\n\tpublic function edit() {\n        global $db;\n\n\t    expHistory::set('editable', $this->params);\n\t    $id = empty($this->params['id']) ? null : $this->params['id'];\n\t    $help = new help($id);\n        if (!empty($this->params['copy'])) $help->id = null;\n\n\t    // get the id of the current version and use it if we need to.\n        if (expSession::is_set('help-version')) {\n            $version_id = help_version::getHelpVersionId(expSession::get('help-version'));  // version the site is currently using\n        } else {\n            $version_id = help_version::getCurrentHelpVersionId();\n        }\n\t    if (empty($help->help_version_id)) $help->help_version_id = $version_id;\n\n        $parentlist = array('0'=>'-- '.gt('Top Level Help Doc').' --');\n        $order = isset($this->config['order']) ? $this->config['order'] : 'rank';\n        $helpdocs = $help->find('all',\"help_version_id=\".$help->help_version_id.\" AND location_data='\".serialize($help->loc).\"'\",$order);\n        foreach ($helpdocs as $helpdoc) {\n            $parentlist[$helpdoc->id] = $helpdoc->title;\n        }\n\n\t\t$sectionlist = array();\n//        $helpsections = $help->find('all',\"help_version_id=\".$help->help_version_id);\n//\t\tforeach ($helpsections as $helpsection) {\n//\t\t\tif (!empty($helpsection->location_data)) {\n//\t\t\t\t$helpsrc = expUnserialize($helpsection->location_data);\n//\t\t\t\tif (!array_key_exists($helpsrc->src, $sectionlist)) {\n//                    $sectionlist[$helpsrc->src] = $db->selectValue('section', 'name', 'id=\"' . $db->selectValue('sectionref', 'section', 'module = \"help\" AND source=\"' . $helpsrc->src .'\"').'\"');\n//\t\t\t\t}\n//\t\t\t}\n//\t\t}\n        $helplocs = $help->findValue('all', 'location_data', \"help_version_id=\" . $version_id, null, true);\n        foreach ($helplocs as $helploc) {\n            if (!empty($helploc)) {\n                $helpsrc = expUnserialize($helploc);\n                $sectionlist[$helpsrc->src] = $db->selectValue('sectionref', 'section', 'module = \"help\" AND source=\"' . $helpsrc->src . '\"');\n            }\n        }\n        $sectionlist[$this->loc->src] .= ' '.gt(\"(current section)\");\n\n\t    assign_to_template(array(\n            'record'=>$help,\n            'parents'=>$parentlist,\n            \"current_section\"=>$this->loc->src,\n            \"sections\"=>$sectionlist\n        ));\n\t}\n\n    /**\n     * Manage help documents\n     */\n\tpublic function manage() {\n\t    expHistory::set('manageable', $this->params);\n\t    global $db;\n\n\t    $hv = new help_version();\n\t    $current_version = $hv->find('first', 'is_current=1');\n\n\t    if (empty($current_version)) {\n\t        flash('error', gt(\"You don't have any software versions created yet.  Please do so now.\"));\n\t        redirect_to(array('controller'=>'help', 'action'=>'edit_version'));\n//            $this->edit_version();\n\t    }\n\n        $sections = array();\n        foreach ($db->selectObjects('sectionref','module=\"help\"') as $sectionref) {\n            if (!empty($sectionref->source) && empty($sections[$sectionref->source])) {\n                $sections[$sectionref->source] = $db->selectValue('section', 'name', 'id=\"' . $sectionref->section .'\"');\n            }\n        }\n\n\t    $where = empty($this->params['version']) ? 1 : 'help_version_id='.intval($this->params['version']);\n\t    $page = new expPaginator(array(\n            'model'=>'help',\n            'where'=>$where,\n            'limit'=>30,\n            'order'      => (isset($this->params['order']) ? $this->params['order'] : 'help_version_id'),\n            'dir'        => (isset($this->params['dir']) ? $this->params['dir'] : 'DESC'),\n            'page'=>(isset($this->params['page']) ? $this->params['page'] : 1),\n            'controller'=>$this->baseclassname,\n            'action'=>$this->params['action'],\n            'src'=>$this->loc->src,\n            'columns'=>array(\n                gt('Title')=>'title',\n                gt('Version')=>'help_version_id',\n                gt('Section')=>'section',\n//                gt('Location')=>'location_data'\n            ),\n        ));\n\n\t    assign_to_template(array(\n            'current_version'=>$current_version,\n            'page'=>$page,\n            'sections'=>$sections\n        ));\n\t}\n\n    /**\n     * Routine to copy all existing help docs from a version to the new version\n     * @static\n     * @param $from\n     * @param $to\n     * @return bool\n     */\n\tprivate static function copydocs($from, $to) {\n\t    $help = new help();\n        $order = 'rank DESC';\n        $old_parents = $help->getHelpParents($from);\n        $new_parents = array();\n\n        // copy parent help docs\n\t    $current_docs = $help->find('all', 'help_version_id='.$from.' AND parent=0',$order);\n\t    foreach ($current_docs as $doc) {\n            $origid = $doc->id;\n\t        unset($doc->id);\n\t        $doc->help_version_id = $to;\n\n//\t        $tmpsef = $doc->sef_url;\n//\t        $doc->sef_url = \"\";\n//\t        $doc->save();\n//\t        $doc->sef_url = $tmpsef;\n//\t        $doc->do_not_validate = array('sef_url');\n\t        $doc->save();\n            if (in_array($origid, $old_parents)) {\n                $new_parents[$origid] = $doc->id;\n            }\n\n//\t        $doc->sef_url = $doc->makeSefUrl();\n//\t        $doc->save();\n\n\t        foreach($doc->expFile as $subtype=>$files) {\n\t            foreach($files as $file) {\n\t                $doc->attachItem($file, $subtype);\n\t            }\n\t        }\n\t    }\n\n        // copy child help docs\n        $current_docs = $help->find('all', 'help_version_id='.$from.' AND parent!=0',$order);\n   \t    foreach ($current_docs as $key=>$doc) {\n   \t        unset($doc->id);\n            $doc->parent = $new_parents[$doc->parent];\n   \t        $doc->help_version_id = $to;\n   \t        $doc->save();\n   \t        foreach($doc->expFile as $subtype=>$files) {\n   \t            foreach($files as $file) {\n   \t                $doc->attachItem($file, $subtype);\n   \t            }\n\n   \t        }\n   \t    }\n\n\t    // get version #'s for the two versions\n        $oldvers = help_version::getHelpVersion($from);\n        $newvers = help_version::getHelpVersion($to);\n\n\t    // send a message saying what we've done\n\t    flash('message', gt('Copied all docs from version').' '.$oldvers.' '.gt('to new version').' '.$newvers);\n\t    return true;\n\t}\n\n    /**\n     * Manage help versions\n     */\n\tpublic function manage_versions() {\n\t    expHistory::set('manageable', $this->params);\n\n\t    $hv = new help_version();\n\t    $current_version = $hv->find('first', 'is_current=1');\n\n\t    $sql  = 'SELECT hv.*, COUNT(h.title) AS num_docs FROM '.DB_TABLE_PREFIX.'_help h ';\n\t    $sql .= 'RIGHT JOIN '.DB_TABLE_PREFIX.'_help_version hv ON h.help_version_id=hv.id GROUP BY hv.version';\n\n\t    $page = new expPaginator(array(\n            'sql'=>$sql,\n            'limit'=>30,\n            'order'      => (isset($this->params['order']) ? $this->params['order'] : 'version'),\n            'dir'        => (isset($this->params['dir']) ? $this->params['dir'] : 'DESC'),\n            'page'=>(isset($this->params['page']) ? $this->params['page'] : 1),\n            'controller'=>$this->baseclassname,\n            'action'=>$this->params['action'],\n            'src'=>$this->loc->src,\n            'columns'=>array(\n                gt('Version')=>'version',\n                gt('Title')=>'title',\n                gt('Current')=>'is_current',\n                gt('# of Docs')=>'num_docs'\n            ),\n        ));\n\n\t    assign_to_template(array(\n            'current_version'=>$current_version,\n            'page'=>$page\n        ));\n\t}\n\n    /**\n     * Create or Edit details about a help version\n     */\n\tpublic function edit_version() {\n\t    expHistory::set('editable', $this->params);\n\t    $id = empty($this->params['id']) ? null : $this->params['id'];\n\t    $version = new help_version($id);\n\t    assign_to_template(array(\n            'record'=>$version\n        ));\n\t}\n\n    /**\n     * Delete a help version and all assoc docs\n     */\n\tpublic function delete_version() {\n\t    if (empty($this->params['id'])) {\n\t        flash('error', gt('The version you are trying to delete could not be found'));\n\t    }\n\n\t    // get the version\n\t    $version = new help_version($this->params['id']);\n\t    if (empty($version->id)) {\n\t        flash('error', gt('The version you are trying to delete could not be found'));\n\t    }\n\n\t    // if we have errors than lets get outta here!\n\t    if (!expQueue::isQueueEmpty('error')) expHistory::back();\n\n\t    // delete the version\n\t    $version->delete();\n\n\t    expSession::un_set('help-version');\n\n\t    flash('message', gt('Deleted version').' '.$version->version.' '.gt('and all documents in that version.'));\n\t    expHistory::back();\n\t}\n\n    /**\n     * Creates a new help version, possibly based on existing help version\n     */\n\tpublic function update_version() {\n\t    // get the current version\n\t    $hv = new help_version();\n\t    $current_version = $hv->find('first', 'is_current=1');\n\n\t    // check to see if the we have a new current version and unset the old current version.\n\t    if (!empty($this->params['is_current'])) {\n//\t        $db->sql('UPDATE '.DB_TABLE_PREFIX.'_help_version set is_current=0');\n            help_version::clearHelpVersion();\n\t    }\n\t    expSession::un_set('help-version');\n\n\t    // save the version\n\t    $id = empty($this->params['id']) ? null : $this->params['id'];\n\t    $version = new help_version();\n\t    // if we don't have a current version yet so we will force this one to be it\n\t    if (empty($current_version->id)) $this->params['is_current'] = 1;\n\t    $version->update($this->params);\n\n\t    // if this is a new version we need to copy over docs\n\t    if (empty($id)) {\n\t        self::copydocs($current_version->id, $version->id);\n\t    }\n        // let's update the search index to reflect the current help version\n        searchController::spider();\n\n\t    flash('message', gt('Saved help version').' '.$version->version);\n\t    expHistory::back();\n\t}\n\n    /**\n     * Switches current help version globally\n     */\n\tpublic function activate_version() {\n\t    // unset the old current version.\n        help_version::clearHelpVersion();\n\t    expSession::un_set('help-version');\n\n\t\t$id = $this->params['id'];\n\t    $version = new help_version($id);\n\t    $this->params['is_current'] = 1;\n\t    $version->update($this->params);\n        // let's update the search index to reflect the current help version\n        searchController::spider();\n\n\t    flash('message', gt('Changed active help version to').' '.$version->version);\n\t    expHistory::back();\n\t}\n\n    /**\n     * Displays available help versions\n     */\n\tpublic function select_version() {\n  \t    $hv = expSession::get('help-version');\n        $selected = help_version::getHelpVersionId($hv);\n        $versions = help_version::getHelpVersionsDropdown();\n   \t    assign_to_template(array(\n               'current_version'=>$hv,\n               'selected'=>$selected,\n               'versions'=>$versions\n           ));\n\t}\n\n    /**\n     * Switches current help version temporarily\n     */\n\tpublic function switch_version() {\n\t    // unset the current version.\n\t    expSession::un_set('help-version');\n        // set the requested version.\n        $version = help_version::getHelpVersion($this->params['version']);\n        expSession::set('help-version',$version);\n\t    flash('message', gt('Now displaying Help version').' '.$version);\n        expHistory::back();\n\t}\n\n    /**\n   \t * add only current version of docs to search index\n   \t * @return int\n   \t */\n   \tfunction addContentToSearch() {\n        global $db;\n\n       $count = 0;\n       $help = new help();\n       $where = 'help_version_id=\"'.help_version::getCurrentHelpVersionId().'\"';\n       $where .= (!empty($this->params['id'])) ? ' AND id='.$this->params['id'] : null;\n       $content = $db->selectArrays($help->tablename,$where);\n       foreach ($content as $cnt) {\n           $origid = $cnt['id'];\n           unset($cnt['id']);\n\n           // get the location data for this content\n//           if (isset($cnt['location_data'])) $loc = expUnserialize($cnt['location_data']);\n//           $src = isset($loc->src) ? $loc->src : null;\n//           $search_record = new search($cnt, false, false);\n           //build the search record and save it.\n           $sql = \"original_id=\" . $origid . \" AND ref_module='\" . $this->baseclassname . \"'\";\n           $oldindex = $db->selectObject('search', $sql);\n           if (!empty($oldindex)) {\n               $search_record = new search($oldindex->id, false, false);\n               $search_record->update($cnt);\n           } else {\n               $search_record = new search($cnt, false, false);\n           }\n\n           $search_record->original_id = $origid;\n           $search_record->posted = empty($cnt['created_at']) ? null : $cnt['created_at'];\n//           $link = str_replace(URL_FULL,'', makeLink(array('controller'=>$this->baseclassname, 'action'=>'show', 'title'=>$cnt['sef_url'])));\n           $link = str_replace(URL_FULL,'', makeLink(array('controller'=>$this->baseclassname, 'action'=>'show', 'title'=>$cnt['sef_url'])));\n//\t        if (empty($search_record->title)) $search_record->title = 'Untitled';\n           $search_record->view_link = $link;\n//           $search_record->ref_module = $this->classname;\n           $search_record->ref_module = $this->baseclassname;\n           $search_record->category = $this->searchName();\n           $search_record->ref_type = $this->searchCategory();\n           $search_record->save();\n           $count++;\n        }\n\n        return $count;\n   }\n\n    /**\n     * Hack to try and determine page which help doc is assoc with\n     * @static\n     * @param $params\n     * @return null|void\n     */\n\tpublic static function getSection($params) {\n\t    global $db;\n\n        $help = new help();\n        if (empty($params['version']) || $params['version']=='current') {\n            $version_id = help_version::getCurrentHelpVersionId();\n        } else {\n            $version_id = help_version::getHelpVersionId($params['version']);\n            if (empty($version_id)) {\n                $version_id = help_version::getCurrentHelpVersionId();\n            }\n        }\n        $doc = $help->find('first','help_version_id='.$version_id.' and sef_url=\"'.$params['title'].'\"');\n\t    $session_section = expSession::get('last_section') ? expSession::get('last_section') : 1 ;\n        $help_sectionref = $db->selectObject('sectionref','module=\"help\" AND source=\"'. expUnserialize($doc->location_data)->src.'\"');\n        $sid = !empty($help_sectionref) ? $help_sectionref->section : (($doc->section!=0) ? $doc->section : $session_section);\n        if (!expSession::get('last_section')) {\n            expSession::set('last_section',$sid);\n        }\n//\t    $section = $db->selectObject('section','id='. intval($sid));\n        $section = new section(intval($sid));\n\t    return $section;\n\t}\n\n}\n\n?>"], "filenames": ["framework/core/subsystems/expPaginator.php", "framework/modules/help/controllers/helpController.php"], "buggy_code_start_loc": [121, 60], "buggy_code_end_loc": [122, 60], "fixing_code_start_loc": [121, 61], "fixing_code_end_loc": [122, 62], "type": "CWE-200", "message": "Exponent CMS 2.3.9 suffers from a SQL injection vulnerability in \"/framework/modules/help/controllers/helpController.php\" affecting the version parameter. Impact is Information Disclosure.", "other": {"cve": {"id": "CVE-2016-9135", "sourceIdentifier": "cve@mitre.org", "published": "2016-11-03T10:59:12.230", "lastModified": "2016-11-29T19:08:20.510", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Exponent CMS 2.3.9 suffers from a SQL injection vulnerability in \"/framework/modules/help/controllers/helpController.php\" affecting the version parameter. Impact is Information Disclosure."}, {"lang": "es", "value": "Exponent CMS 2.3.9 sufre de una vulnerabilidad de inyecci\u00f3n SQL en \"/framework/modules/help/controllers/helpController.php\" afectando el par\u00e1metro de versi\u00f3n. El impacto es Information Disclosure."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:N/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "NONE", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-200"}, {"lang": "en", "value": "CWE-89"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:exponentcms:exponent_cms:2.3.9:*:*:*:*:*:*:*", "matchCriteriaId": "12FDDF33-2B21-4F8A-AB9A-01857197E810"}]}]}], "references": [{"url": "http://www.securityfocus.com/bid/94127", "source": "cve@mitre.org", "tags": ["Third Party Advisory", "VDB Entry"]}, {"url": "https://github.com/exponentcms/exponent-cms/commit/d5c3c175b60bd26b2b74ec85b8f0d2544db2c8db", "source": "cve@mitre.org", "tags": ["Issue Tracking", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/exponentcms/exponent-cms/commit/d5c3c175b60bd26b2b74ec85b8f0d2544db2c8db"}}