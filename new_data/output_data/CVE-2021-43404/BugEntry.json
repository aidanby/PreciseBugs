{"buggy_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2021\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tJames Rose <james.o.rose@gmail.com>\n\tLuis Daniel Lucio Quiroz <dlucio@okay.com.mx>\n\tErrol Samuels <voiptology@gmail.com>\n\tCorey Moullas <cmoullas@emak.tech>\n*/\n\nif (!isset($included)) { $included = false; }\n\nif (stristr(PHP_OS, 'WIN')) { $IS_WINDOWS = true; } else { $IS_WINDOWS = false; }\n\nif (!$included) {\n\n\t//includes\n\t\tinclude \"root.php\";\n\t\trequire_once \"resources/require.php\";\n\t\trequire_once \"resources/check_auth.php\";\n\n\t//check permissions\n\t\tif (permission_exists('fax_send')) {\n\t\t\t//access granted\n\t\t}\n\t\telse {\n\t\t\techo \"access denied\";\n\t\t\texit;\n\t\t}\n\n\t//add multi-lingual support\n\t\t$language = new text;\n\t\t$text = $language->get();\n\n\t//get the fax_extension and save it as a variable\n\t\tif (isset($_REQUEST[\"fax_extension\"]) && is_numeric($_REQUEST[\"fax_extension\"])) {\n\t\t\t$fax_extension = $_REQUEST[\"fax_extension\"];\n\t\t}\n\n\t//pre-populate the form\n\t\tif (is_uuid($_REQUEST['id']) && $_POST[\"persistformvar\"] != \"true\") {\n\t\t\t$fax_uuid = $_REQUEST[\"id\"];\n\t\t\tif (permission_exists('fax_extension_view_domain')) {\n\t\t\t\t//show all fax extensions\n\t\t\t\t$sql = \"select fax_uuid, fax_extension, fax_caller_id_name, fax_caller_id_number, \";\n\t\t\t\t$sql .= \"fax_toll_allow, accountcode, fax_send_greeting \";\n\t\t\t\t$sql .= \"from v_fax \";\n\t\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t\t\t$sql .= \"and fax_uuid = :fax_uuid \";\n\t\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t$parameters['fax_uuid'] = $fax_uuid;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//show only assigned fax extensions\n\t\t\t\t$sql = \"select f.fax_uuid, f.fax_extension, f.fax_caller_id_name, f.fax_caller_id_number, \";\n\t\t\t\t$sql .= \"f.fax_toll_allow, f.accountcode, f.fax_send_greeting \";\n\t\t\t\t$sql .= \"from v_fax as f, v_fax_users as u \";\n\t\t\t\t$sql .= \"where f.fax_uuid = u.fax_uuid \";\n\t\t\t\t$sql .= \"and f.domain_uuid = :domain_uuid \";\n\t\t\t\t$sql .= \"and f.fax_uuid = :fax_uuid \";\n\t\t\t\t$sql .= \"and u.user_uuid = :user_uuid \";\n\t\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t$parameters['fax_uuid'] = $fax_uuid;\n\t\t\t\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t\t\t}\n\t\t\t$database = new database;\n\t\t\t$row = $database->select($sql, $parameters, 'row');\n\t\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t\t//set database fields as variables\n\t\t\t\t\t$fax_uuid = $row[\"fax_uuid\"];\n\t\t\t\t\t$fax_extension = $row[\"fax_extension\"];\n\t\t\t\t\t$fax_caller_id_name = $row[\"fax_caller_id_name\"];\n\t\t\t\t\t$fax_caller_id_number = $row[\"fax_caller_id_number\"];\n\t\t\t\t\t$fax_toll_allow = $row[\"fax_toll_allow\"];\n\t\t\t\t\t$fax_accountcode = $row[\"accountcode\"];\n\t\t\t\t\t$fax_send_greeting = $row[\"fax_send_greeting\"];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (!permission_exists('fax_extension_view_domain')) {\n\t\t\t\t\techo \"access denied\";\n\t\t\t\t\texit;\n\t\t\t\t}\n\t\t\t}\n\t\t\tunset($sql, $parameters, $row);\n\n\t\t\t$fax_send_mode = $_SESSION['fax']['send_mode']['text'];\n\t\t\tif(strlen($fax_send_mode) == 0){\n\t\t\t\t$fax_send_mode = 'direct';\n\t\t\t}\n\t\t}\n\n\t//set the fax directory\n\t\t$fax_dir = $_SESSION['switch']['storage']['dir'].'/fax/'.$_SESSION['domain_name'];\n\n\t// set fax cover font to generate pdf\n\t\t$fax_cover_font = $_SESSION['fax']['cover_font']['text'];\n}\nelse {\n\trequire_once \"resources/classes/event_socket.php\";\n}\n\nif (!function_exists('correct_path')) {\n\tfunction correct_path($p) {\n\t\tglobal $IS_WINDOWS;\n\t\tif ($IS_WINDOWS) {\n\t\t\treturn str_replace('/', '\\\\', $p);\n\t\t}\n\t\treturn $p;\n\t}\n}\n\nif (!function_exists('gs_cmd')) {\n\tfunction gs_cmd($args) {\n\t\tglobal $IS_WINDOWS;\n\t\tif ($IS_WINDOWS) {\n\t\t\treturn 'gswin32c '.$args;\n\t\t}\n\t\treturn 'gs '.$args;\n\t}\n}\n\nif (!function_exists('fax_enqueue')) {\n\tfunction fax_enqueue($fax_uuid, $fax_file, $wav_file, $reply_address, $fax_uri, $fax_dtmf, $dial_string){\n\t\tglobal $db_type;\n\n\t\t$fax_task_uuid = uuid();\n\t\t$dial_string .= \"fax_task_uuid='\" . $fax_task_uuid . \"',\";\n\t\t$description = ''; //! @todo add description\n\t\tif ($db_type == \"pgsql\") {\n\t\t\t$date_utc_now_sql  = \"NOW() at time zone 'utc'\";\n\t\t}\n\t\tif ($db_type == \"mysql\") {\n\t\t\t$date_utc_now_sql  = \"UTC_TIMESTAMP()\";\n\t\t}\n\t\tif ($db_type == \"sqlite\") {\n\t\t\t$date_utc_now_sql  = \"datetime('now')\";\n\t\t}\n\n\t\t$array['fax_tasks'][0]['fax_task_uuid'] = $fax_task_uuid;\n\t\t$array['fax_tasks'][0]['fax_uuid'] = $fax_uuid;\n\t\t$array['fax_tasks'][0]['task_next_time'] = $date_utc_now_sql;\n\t\t$array['fax_tasks'][0]['task_lock_time'] = null;\n\t\t$array['fax_tasks'][0]['task_fax_file'] = $fax_file;\n\t\t$array['fax_tasks'][0]['task_wav_file'] = $wav_file;\n\t\t$array['fax_tasks'][0]['task_uri'] = $fax_uri;\n\t\t$array['fax_tasks'][0]['task_dial_string'] = $dial_string;\n\t\t$array['fax_tasks'][0]['task_dtmf'] = $fax_dtmf;\n\t\t$array['fax_tasks'][0]['task_interrupted'] = 'false';\n\t\t$array['fax_tasks'][0]['task_status'] = 0;\n\t\t$array['fax_tasks'][0]['task_no_answer_counter'] = 0;\n\t\t$array['fax_tasks'][0]['task_no_answer_retry_counter'] = 0;\n\t\t$array['fax_tasks'][0]['task_retry_counter'] = 0;\n\t\t$array['fax_tasks'][0]['task_reply_address'] = $reply_address;\n\t\t$array['fax_tasks'][0]['task_description'] = $description;\n\n\t\t$p = new permissions;\n\t\t$p->add('fax_task_add', 'temp');\n\n\t\t$database = new database;\n\t\t$database->app_name = 'fax';\n\t\t$database->app_uuid = '24108154-4ac3-1db6-1551-4731703a4440';\n\t\t$database->save($array);\n\t\t$message = $database->message;\n\t\tunset($array);\n\n\t\t$p->delete('fax_task_add', 'temp');\n\n\t\tif ($message['message'] == 'OK' && $message['code'] == 200) {\n\t\t\t$response = 'Enqueued';\n\t\t}\n\t\telse {\n\t\t\t$response = 'Fail Enqueue';\n\n\t\t\techo $message['message'].' ['.$message['code'].\"]<br />\\n\";\n\t\t\tif (is_array($message['error']) && @sizeof($message['error']) != 0) {\n\t\t\t\tforeach ($message['error'] as $error) {\n\t\t\t\t\techo \"<pre>\".$error.\"</pre><br /><br />\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn $response;\n\t}\n}\n\nif (!function_exists('fax_split_dtmf')) {\n\tfunction fax_split_dtmf(&$fax_number, &$fax_dtmf){\n\t\t$tmp = array();\n\t\t$fax_dtmf = '';\n\t\tif (preg_match('/^\\s*(.*?)\\s*\\((.*)\\)\\s*$/', $fax_number, $tmp)){\n\t\t\t$fax_number = $tmp[1];\n\t\t\t$fax_dtmf = $tmp[2];\n\t\t}\n\t}\n}\n\n//get the fax extension\n\tif (isset($fax_extension) && is_numeric($fax_extension)) {\n\t\t//set the fax directories. example /usr/local/freeswitch/storage/fax/329/inbox\n\t\t\t$dir_fax_inbox = $fax_dir.'/'.$fax_extension.'/inbox';\n\t\t\t$dir_fax_sent = $fax_dir.'/'.$fax_extension.'/sent';\n\t\t\t$dir_fax_temp = $fax_dir.'/'.$fax_extension.'/temp';\n\n\t\t//make sure the directories exist\n\t\t\tif (!is_dir($_SESSION['switch']['storage']['dir'])) {\n\t\t\t\tmkdir($_SESSION['switch']['storage']['dir'], 0770);\n\t\t\t}\n\t\t\tif (!is_dir($_SESSION['switch']['storage']['dir'].'/fax')) {\n\t\t\t\tmkdir($_SESSION['switch']['storage']['dir'].'/fax', 0770);\n\t\t\t}\n\t\t\tif (!is_dir($_SESSION['switch']['storage']['dir'].'/fax/'.$_SESSION['domain_name'])) {\n\t\t\t\tmkdir($_SESSION['switch']['storage']['dir'].'/fax/'.$_SESSION['domain_name'], 0770);\n\t\t\t}\n\t\t\tif (!is_dir($fax_dir.'/'.$fax_extension)) {\n\t\t\t\tmkdir($fax_dir.'/'.$fax_extension, 0770);\n\t\t\t}\n\t\t\tif (!is_dir($dir_fax_inbox)) {\n\t\t\t\tmkdir($dir_fax_inbox, 0770);\n\t\t\t}\n\t\t\tif (!is_dir($dir_fax_sent)) {\n\t\t\t\tmkdir($dir_fax_sent, 0770);\n\t\t\t}\n\t\t\tif (!is_dir($dir_fax_temp)) {\n\t\t\t\tmkdir($dir_fax_temp, 0770);\n\t\t\t}\n\t}\n\n//clear file status cache\n\tclearstatcache();\n\n//send the fax\n\t$continue = false;\n\tif (!$included) {\n\t\tif (($_POST['action'] == \"send\")) {\n\t\t\t$fax_numbers = $_POST['fax_numbers'];\n\t\t\t$fax_uuid = $_POST[\"id\"];\n\t\t\t$fax_caller_id_name = $_POST['fax_caller_id_name'];\n\t\t\t$fax_caller_id_number = $_POST['fax_caller_id_number'];\n\t\t\t$fax_header = $_POST['fax_header'];\n\t\t\t$fax_sender = $_POST['fax_sender'];\n\t\t\t$fax_recipient = $_POST['fax_recipient'];\n\t\t\t$fax_subject = $_POST['fax_subject'];\n\t\t\t$fax_message = $_POST['fax_message'];\n\t\t\t$fax_resolution = $_POST['fax_resolution'];\n\t\t\t$fax_page_size = $_POST['fax_page_size'];\n\t\t\t$fax_footer = $_POST['fax_footer'];\n\n\t\t\t//validate the token\n\t\t\t\t$token = new token;\n\t\t\t\tif (!$token->validate($_SERVER['PHP_SELF'])) {\n\t\t\t\t\tmessage::add($text['message-invalid_token'],'negative');\n\t\t\t\t\theader('Location: fax_send.php'.(is_uuid($fax_uuid) ? '?id='.$fax_uuid : null));\n\t\t\t\t\texit;\n\t\t\t\t}\n\n\t\t\t$continue = true;\n\t\t}\n\t}\n\telse {\n\t\t//all necessary local and session variables should\n\t\t//be already set by now by file including this one\n\t\t$continue = true;\n\t}\n\n//cleanup numbers\n\tif (isset($fax_numbers)) {\n\t\tforeach ($fax_numbers as $index => $fax_number) {\n\t\t\tfax_split_dtmf($fax_number, $fax_dtmf);\n\t\t\t$fax_number = preg_replace(\"~[^0-9]~\", \"\", $fax_number);\n\t\t\t$fax_dtmf   = preg_replace(\"~[^0-9Pp*#]~\", \"\", $fax_dtmf);\n\t\t\tif ($fax_number != ''){\n\t\t\t\tif ($fax_dtmf != '') {$fax_number .= \" (\" . $fax_dtmf . \")\";}\n\t\t\t\t$fax_numbers[$index] = $fax_number;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tunset($fax_numbers[$index]);\n\t\t\t}\n\t\t}\n\t\tsort($fax_numbers);\n\t}\n\n\tif ($continue) {\n\t\t//determine page size\n\t\tswitch ($fax_page_size) {\n\t\t\tcase 'a4' :\n\t\t\t\t$page_width = 8.3; //in\n\t\t\t\t$page_height = 11.7; //in\n\t\t\t\tbreak;\n\t\t\tcase 'legal' :\n\t\t\t\t$page_width = 8.5; //in\n\t\t\t\t$page_height = 14; //in\n\t\t\t\tbreak;\n\t\t\tcase 'letter' :\n\t\t\t\t$page_width = 8.5; //in\n\t\t\t\t$page_height = 11; //in\n\t\t\t\tbreak;\n\t\t\tdefault\t:\n\t\t\t\t$page_width = 8.5; //in\n\t\t\t\t$page_height = 11; //in\n\t\t\t\t$fax_page_size = 'letter';\n\t\t}\n\n\t\t//set resolution\n\t\tswitch ($fax_resolution) {\n\t\t\tcase 'fine':\n\t\t\t\t$gs_r = '204x196';\n\t\t\t\t$gs_g = ((int) ($page_width * 204)).'x'.((int) ($page_height * 196));\n\t\t\t\tbreak;\n\t\t\tcase 'superfine':\n\t\t\t\t$gs_r = '204x392';\n\t\t\t\t$gs_g = ((int) ($page_width * 204)).'x'.((int) ($page_height * 392));\n\t\t\t\tbreak;\n\t\t\tcase 'normal':\n\t\t\tdefault:\n\t\t\t\t$gs_r = '204x98';\n\t\t\t\t$gs_g = ((int) ($page_width * 204)).'x'.((int) ($page_height * 98));\n\t\t\t\tbreak;\n\t\t}\n\n\t\t//process uploaded or emailed files (if any)\n\t\t$fax_page_count = 0;\n\t\t$_files = (!$included) ? $_FILES['fax_files'] : $emailed_files;\n\t\tunset($tif_files);\n\t\tforeach ($_files['tmp_name'] as $index => $fax_tmp_name) {\n\t\t\t$uploaded_file = (!$included) ? is_uploaded_file($fax_tmp_name) : true;\n\t\t\tif ( $uploaded_file && $_files['error'][$index] == 0 && $_files['size'][$index] > 0 ) {\n\t\t\t\t//get the file extension\n\t\t\t\t$fax_file_extension = strtolower(pathinfo($_files['name'][$index], PATHINFO_EXTENSION));\n\t\t\t\tif ($fax_file_extension == \"tiff\") { $fax_file_extension = \"tif\"; }\n\n\t\t\t\t//block unauthorized files\n\t\t\t\t$disallowed_file_extensions = explode(',','sh,ssh,so,dll,exe,bat,vbs,zip,rar,z,tar,tbz,tgz,gz');\n\t\t\t\tif (in_array($fax_file_extension, $disallowed_file_extensions) || $fax_file_extension == '') { continue; }\n\n\t\t\t\t$fax_name = $_files['name'][$index];\n\t\t\t\t$fax_name = preg_replace('/\\\\.[^.\\\\s]{3,4}$/', '', $fax_name);\n\t\t\t\t$fax_name = str_replace(\" \", \"_\", $fax_name);\n\n\t\t\t\t//lua doesn't seem to like special chars with env:GetHeader\n\t\t\t\t$fax_name = str_replace(\";\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\",\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"'\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"!\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"@\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"#\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"$\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"%\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"^\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"`\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"~\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"&\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"(\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\")\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"+\", \"_\", $fax_name);\n\t\t\t\t$fax_name = str_replace(\"=\", \"_\", $fax_name);\n\n\t\t\t\t$attachment_file_name = $_files['name'][$index];\n\t\t\t\tif ($attachment_file_name != $fax_name.'.'.$fax_file_extension) {\n\t\t\t\t\trename($dir_fax_temp.'/'.$attachment_file_name, $dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension);\n\t\t\t\t}\n\t\t\t\tunset($attachment_file_name);\n\n\t\t\t\tif (!$included) {\n\t\t\t\t\t//check if directory exists\n\t\t\t\t\tif (!is_dir($dir_fax_temp)) {\n\t\t\t\t\t\tevent_socket_mkdir($dir_fax_temp);\n\t\t\t\t\t}\n\t\t\t\t\t//move uploaded file\n\t\t\t\t\tmove_uploaded_file($_files['tmp_name'][$index], $dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension);\n\t\t\t\t}\n\n\t\t\t\t//convert uploaded file to pdf, if necessary\n\t\t\t\tif ($fax_file_extension != \"pdf\" && $fax_file_extension != \"tif\") {\n\t\t\t\t\tchdir($dir_fax_temp);\n\t\t\t\t\t$command = $IS_WINDOWS ? '' : 'export HOME=/tmp && ';\n\t\t\t\t\t$command .= 'libreoffice --headless --convert-to pdf --outdir '.$dir_fax_temp.' '.$dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension;\n\t\t\t\t\texec($command);\n\t\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension);\n\t\t\t\t}\n\n\t\t\t\t//convert uploaded pdf to tif\n\t\t\t\tif (file_exists($dir_fax_temp.'/'.$fax_name.'.pdf')) {\n\t\t\t\t\tchdir($dir_fax_temp);\n\n\t\t\t\t\t//convert pdf to tif\n\t\t\t\t\t$cmd = gs_cmd(\"-q -r\".$gs_r.\" -g\".$gs_g.\" -dBATCH -dPDFFitPage -dNOSAFER -dNOPAUSE -dBATCH -sOutputFile=\".correct_path($fax_name).\".tif -sDEVICE=tiffg4 -Ilib stocht.ps -c \\\"{ .75 gt { 1 } { 0 } ifelse} settransfer\\\" -- \".correct_path($fax_name).\".pdf -c quit\");\n\t\t\t\t\t// echo($cmd . \"<br/>\\n\");\n\t\t\t\t\texec($cmd);\n\t\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_name.'.pdf');\n\t\t\t\t}\n\n\t\t\t\t$cmd = \"tiffinfo \".correct_path($dir_fax_temp.'/'.$fax_name).\".tif | grep \\\"Page Number\\\" | grep -c \\\"P\\\"\";\n\t\t\t\t// echo($cmd . \"<br/>\\n\");\n\t\t\t\t$tif_page_count = exec($cmd);\n\t\t\t\tif ($tif_page_count != '') {\n\t\t\t\t\t$fax_page_count += $tif_page_count;\n\t\t\t\t}\n\n\t\t\t\t//add file to array\n\t\t\t\t$tif_files[] = $dir_fax_temp.'/'.$fax_name.'.tif';\n\t\t\t} //if\n\t\t} //foreach\n\n\t\t// unique id for this fax\n\t\t$fax_instance_uuid = uuid();\n\n\t\t//generate cover page, merge with pdf\n\t\tif ($fax_subject != '' || $fax_message != '') {\n\n\t\t\t//load pdf libraries\n\t\t\trequire_once(\"resources/tcpdf/tcpdf.php\");\n\t\t\trequire_once(\"resources/fpdi/fpdi.php\");\n\n\t\t\t// initialize pdf\n\t\t\t$pdf = new FPDI('P', 'in');\n\t\t\t$pdf->SetAutoPageBreak(false);\n\t\t\t$pdf->setPrintHeader(false);\n\t\t\t$pdf->setPrintFooter(false);\n\t\t\t$pdf->SetMargins(0, 0, 0, true);\n\n\t\t\tif (strlen($fax_cover_font) > 0) {\n\t\t\t\tif (substr($fax_cover_font, -4) == '.ttf') {\n\t\t\t\t\t$pdf_font = TCPDF_FONTS::addTTFfont($fax_cover_font);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$pdf_font = $fax_cover_font;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$pdf_font) {\n\t\t\t\t$pdf_font = 'times';\n\t\t\t}\n\n\t\t\t//add blank page\n\t\t\t$pdf->AddPage('P', array($page_width, $page_height));\n\n\t\t\t// content offset, if necessary\n\t\t\t$x = 0;\n\t\t\t$y = 0;\n\n\t\t\t//logo\n\t\t\t$display_logo = false;\n\t\t\tif (!is_array($_SESSION['fax']['cover_logo'])) {\n\t\t\t\t$logo = $_SERVER['DOCUMENT_ROOT'].PROJECT_PATH.\"/app/fax/resources/images/logo.jpg\";\n\t\t\t\t$display_logo = true;\n\t\t\t}\n\t\t\telse if (is_null($_SESSION['fax']['cover_logo']['text'])) {\n\t\t\t\t$logo = ''; //explicitly empty\n\t\t\t}\n\t\t\telse if ($_SESSION['fax']['cover_logo']['text'] != '') {\n\t\t\t\tif (substr($_SESSION['fax']['cover_logo']['text'], 0, 4) == 'http') {\n\t\t\t\t\t$logo = $_SESSION['fax']['cover_logo']['text'];\n\t\t\t\t}\n\t\t\t\telse if (substr($_SESSION['fax']['cover_logo']['text'], 0, 1) == '/') {\n\t\t\t\t\tif (substr($_SESSION['fax']['cover_logo']['text'], 0, strlen($_SERVER['DOCUMENT_ROOT'])) != $_SERVER['DOCUMENT_ROOT']) {\n\t\t\t\t\t\t$logo = $_SERVER['DOCUMENT_ROOT'].$_SESSION['fax']['cover_logo']['text'];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$logo = $_SESSION['fax']['cover_logo']['text'];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (isset($logo) && $logo) {\n\t\t\t\t$logo_dirname = strtolower(pathinfo($logo, PATHINFO_DIRNAME));\n\t\t\t\t$logo_filename = strtolower(pathinfo($logo, PATHINFO_BASENAME));\n\t\t\t\t$logo_fileext = pathinfo($logo_filename, PATHINFO_EXTENSION);\n\t\t\t\tif (in_array($logo_fileext, ['gif','jpg','jpeg','png','bmp'])) {\n\t\t\t\t\tif (file_exists($logo_dirname.'/'.$logo_filename)) {\n\t\t\t\t\t\t$logo = $logo_dirname.'/'.$logo_filename;\n\t\t\t\t\t\t$display_logo = true;\t\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$raw = file_get_contents($logo);\n\t\t\t\t\t\tif (file_put_contents($dir_fax_temp.'/'.$logo_filename, $raw)) {\n\t\t\t\t\t\t\t$logo = $dir_fax_temp.'/'.$logo_filename;\n\t\t\t\t\t\t\t$display_logo = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tunset($logo);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tunset($logo);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ($display_logo) {\n\t\t\t\t$pdf->Image($logo, 0.5, 0.4, 2.5, 0.9, null, null, 'N', true, 300, null, false, false, 0, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//set position for header text, if enabled\n\t\t\t\t$pdf->SetXY($x + 0.5, $y + 0.4);\n\t\t\t}\n\n\t\t\t//header\n\t\t\tif ($fax_header != '') {\n\t\t\t\t$pdf->SetLeftMargin(0.5);\n\t\t\t\t$pdf->SetFont($pdf_font, \"\", 10);\n\t\t\t\t$pdf->Write(0.3, $fax_header);\n\t\t\t}\n\n\t\t\t//fax, cover sheet\n\t\t\t$pdf->SetTextColor(0,0,0);\n\t\t\t$pdf->SetFont($pdf_font, \"B\", 55);\n\t\t\t$pdf->SetXY($x + 4.55, $y + 0.25);\n\t\t\t$pdf->Cell($x + 3.50, $y + 0.4, $text['label-fax-fax'], 0, 0, 'R', false, null, 0, false, 'T', 'T');\n\t\t\t$pdf->SetFont($pdf_font, \"\", 12);\n\t\t\t$pdf->SetFontSpacing(0.0425);\n\t\t\t$pdf->SetXY($x + 4.55, $y + 1.0);\n\t\t\t$pdf->Cell($x + 3.50, $y + 0.4, $text['label-fax-cover-sheet'], 0, 0, 'R', false, null, 0, false, 'T', 'T');\n\t\t\t$pdf->SetFontSpacing(0);\n\n\t\t\t//field labels\n\t\t\t$pdf->SetFont($pdf_font, \"B\", 12);\n\t\t\tif ($fax_recipient != '' || sizeof($fax_numbers) > 0) {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.0, strtoupper($text['label-fax-recipient']).\":\");\n\t\t\t}\n\t\t\tif ($fax_sender != '' || $fax_caller_id_number != '') {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.3, strtoupper($text['label-fax-sender']).\":\");\n\t\t\t}\n\t\t\tif ($fax_page_count > 0) {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.6, strtoupper($text['label-fax-attached']).\":\");\n\t\t\t}\n\t\t\tif ($fax_subject != '') {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.9, strtoupper($text['label-fax-subject']).\":\");\n\t\t\t}\n\n\t\t\t//field values\n\t\t\t$pdf->SetFont($pdf_font, \"\", 12);\n\t\t\t$pdf->SetXY($x + 2.0, $y + 1.95);\n\t\t\tif ($fax_recipient != '') {\n\t\t\t\t$pdf->Write(0.3, $fax_recipient);\n\t\t\t}\n\t\t\tif (sizeof($fax_numbers) > 0) {\n\t\t\t\t$fax_number_string = ($fax_recipient != '') ? ' (' : null;\n\t\t\t\t$fax_number_string .= format_phone($fax_numbers[0]);\n\t\t\t\tif (sizeof($fax_numbers) > 1) {\n\t\t\t\t\tfor ($n = 1; $n <= sizeof($fax_numbers); $n++) {\n\t\t\t\t\t\tif ($n == 4) { break; }\n\t\t\t\t\t\t$fax_number_string .= ', '.format_phone($fax_numbers[$n]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$fax_number_string .= (sizeof($fax_numbers) > 4) ? ', +'.(sizeof($fax_numbers) - 4) : null;\n\t\t\t\t$fax_number_string .= ($fax_recipient != '') ? ')' : null;\n\t\t\t\t$pdf->Write(0.3, $fax_number_string);\n\t\t\t}\n\t\t\t$pdf->SetXY($x + 2.0, $y + 2.25);\n\t\t\tif ($fax_sender != '') {\n\t\t\t\t$pdf->Write(0.3, $fax_sender);\n\t\t\t\tif ($fax_caller_id_number != '') {\n\t\t\t\t\t$pdf->Write(0.3, '  ('.format_phone($fax_caller_id_number).')');\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ($fax_caller_id_number != '') {\n\t\t\t\t\t$pdf->Write(0.3, format_phone($fax_caller_id_number));\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($fax_page_count > 0) {\n\t\t\t\t$pdf->Text($x + 2.0, $y + 2.6, $fax_page_count.' '.$text['label-fax-page'.(($fax_page_count > 1) ? 's' : null)]);\n\t\t\t}\n\t\t\tif ($fax_subject != '') {\n\t\t\t\t$pdf->Text($x + 2.0, $y + 2.9, $fax_subject);\n\t\t\t}\n\n\t\t\t//message\n\t\t\tif ($fax_message != '') {\n\t\t\t\t$pdf->SetAutoPageBreak(true, 0.6);\n\t\t\t\t$pdf->SetTopMargin(0.6);\n\t\t\t\t$pdf->SetFont($pdf_font, \"\", 12);\n\t\t\t\t$pdf->SetXY($x + 0.75, $y + 3.65);\n\t\t\t\t$pdf->MultiCell(7, 5.40, $fax_message, 0, 'L', false);\n\t\t\t}\n\n\t\t\t$pages = $pdf->getNumPages();\n\n\t\t\tif ($pages > 1) {\n\t\t\t\t# save ynew for last page\n\t\t\t\t$yn = $pdf->GetY();\n\n\t\t\t\t# First page\n\t\t\t\t$pdf->setPage(1, 0);\n\t\t\t\t$pdf->Rect($x + 0.5, $y + 3.4, 7.5, $page_height - 3.9, 'D');\n\n\t\t\t\t# 2nd to N-th page\n\t\t\t\tfor ($n = 2; $n < $pages; $n++) {\n\t\t\t\t\t$pdf->setPage($n, 0);\n\t\t\t\t\t$pdf->Rect($x + 0.5, $y + 0.5, 7.5, $page_height - 1, 'D');\n\t\t\t\t}\n\n\t\t\t\t#Last page\n\t\t\t\t$pdf->setPage($pages, 0);\n\t\t\t\t$pdf->Rect($x + 0.5, 0.5, 7.5, $yn, 'D');\n\t\t\t\t$y = $yn;\n\t\t\t\tunset($yn);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$pdf->Rect($x + 0.5, $y + 3.4, 7.5, 6.25, 'D');\n\t\t\t\t$y = $pdf->GetY();\n\t\t\t}\n\n\t\t\t//footer\n\t\t\tif ($fax_footer != '') {\n\t\t\t\t$pdf->SetAutoPageBreak(true, 0.6);\n\t\t\t\t$pdf->SetTopMargin(0.6);\n\t\t\t\t$pdf->SetFont(\"helvetica\", \"\", 8);\n\t\t\t\t$pdf->SetXY($x + 0.5, $y + 0.6);\n\t\t\t\t$pdf->MultiCell(7.5, 0.75, $fax_footer, 0, 'C', false);\n\t\t\t}\n\t\t\t$pdf->SetAutoPageBreak(false);\n\t\t\t$pdf->SetTopMargin(0);\n\n\t\t\t// save cover pdf\n\t\t\t$pdf->Output($dir_fax_temp.'/'.$fax_instance_uuid.'_cover.pdf', \"F\");\t// Display [I]nline, Save to [F]ile, [D]ownload\n\n\t\t\t//convert pdf to tif, add to array of pages, delete pdf\n\t\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.'_cover.pdf')) {\n\t\t\t\tchdir($dir_fax_temp);\n\n\t\t\t\t$cmd = gs_cmd(\"-q -sDEVICE=tiffg32d -r\".$gs_r.\" -g\".$gs_g.\" -dBATCH -dPDFFitPage -dNOSAFER -dNOPAUSE -sOutputFile=\".correct_path($fax_instance_uuid).\"_cover.tif -- \".correct_path($fax_instance_uuid).\"_cover.pdf -c quit\");\n\t\t\t\t// echo($cmd . \"<br/>\\n\");\n\t\t\t\texec($cmd);\n\t\t\t\tif (is_array($tif_files) && sizeof($tif_files) > 0) {\n\t\t\t\t\tarray_unshift($tif_files, $dir_fax_temp.'/'.$fax_instance_uuid.'_cover.tif');\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$tif_files[] = $dir_fax_temp.'/'.$fax_instance_uuid.'_cover.tif';\n\t\t\t\t}\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.'_cover.pdf');\n\t\t\t}\n\t\t}\n\n\t\t//combine tif files into single multi-page tif\n\t\tif (is_array($tif_files) && sizeof($tif_files) > 0) {\n\t\t\t$cmd = \"tiffcp -c none \";\n\t\t\tforeach ($tif_files as $tif_file) {\n\t\t\t\t$cmd .= correct_path($tif_file) . ' ';\n\t\t\t}\n\t\t\t$cmd .= correct_path($dir_fax_temp.'/'.$fax_instance_uuid.'.tif');\n\t\t\t//echo($cmd . \"<br/>\\n\");\n\t\t\texec($cmd);\n\n\t\t\tforeach ($tif_files as $tif_file) {\n\t\t\t\t@unlink($tif_file);\n\t\t\t}\n\n\t\t\t//generate pdf from tif\n\t\t\t$cmd = 'tiff2pdf -u i -p '.$fax_page_size.\n\t\t\t\t' -w '.$page_width.\n\t\t\t\t' -l '.$page_height.\n\t\t\t\t' -f -o '.\n\t\t\t\tcorrect_path($dir_fax_temp.'/'.$fax_instance_uuid.'.pdf').' '.\n\t\t\t\tcorrect_path($dir_fax_temp.'/'.$fax_instance_uuid.'.tif');\n\t\t\texec($cmd);\n\t\t}\n\t\telse {\n\t\t\tif (!$included) {\n\t\t\t\t//nothing to send, redirect the browser\n\t\t\t\tmessage::add($text['message-invalid-fax'], 'negative', 4000);\n\t\t\t\theader(\"Location: fax_send.php?id=\".$fax_uuid);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\n\t\t//preview, if requested\n\t\tif (($_REQUEST['submit'] != '') && ($_REQUEST['submit'] == 'preview')) {\n\t\t\tunset($file_type);\n\t\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.'.pdf')) {\n\t\t\t\t$file_type = 'pdf';\n\t\t\t\t$content_type = 'application/pdf';\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.\".tif\");\n\t\t\t}\n\t\t\telse if (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.'.tif')) {\n\t\t\t\t$file_type = 'tif';\n\t\t\t\t$content_type = 'image/tiff';\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.\".pdf\");\n\t\t\t}\n\t\t\tif ($file_type != '') {\n\t\t\t\t//push download\n\t\t\t\t$fd = fopen($dir_fax_temp.'/'.$fax_instance_uuid.'.'.$file_type, \"rb\");\n\t\t\t\theader(\"Content-Type: application/force-download\");\n\t\t\t\theader(\"Content-Type: application/octet-stream\");\n\t\t\t\theader(\"Content-Type: application/download\");\n\t\t\t\theader(\"Content-Description: File Transfer\");\n\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$fax_instance_uuid.'.'.$file_type.'\"');\n\t\t\t\theader(\"Content-Type: \".$content_type);\n\t\t\t\theader('Accept-Ranges: bytes');\n\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\n\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // date in the past\n\t\t\t\theader(\"Content-Length: \".filesize($dir_fax_temp.'/'.$fax_instance_uuid.'.'.$file_type));\n\t\t\t\tfpassthru($fd);\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.\".\".$file_type);\n\t\t\t}\n\t\t\texit;\n\t\t}\n\n\t\t//get some more info to send the fax\n\t\t$mailfrom_address = (isset($_SESSION['fax']['smtp_from']['text'])) ? $_SESSION['fax']['smtp_from']['text'] : $_SESSION['email']['smtp_from']['text'];\n\n\t\t$sql = \"select * from v_fax where fax_uuid = :fax_uuid \";\n\t\t$parameters['fax_uuid'] = $fax_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\t$mailto_address_fax = $row[\"fax_email\"];\n\t\t$fax_prefix = $row[\"fax_prefix\"];\n\t\tunset($sql, $parameters, $row);\n\n\t\tif (!$included) {\n\t\t\t$sql = \"select user_email from v_users where user_uuid = :user_uuid \";\n\t\t\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t\t\t$database = new database;\n\t\t\t$mailto_address_user = $database->select($sql, $parameters, 'column');\n\t\t\tunset($sql, $parameters);\n\t\t}\n\t\telse {\n\t\t\t//use email-to-fax from address\n\t\t}\n\n\t\tif ($mailto_address_fax != '' && $mailto_address_user != $mailto_address_fax) {\n\t\t\t$mailto_address = $mailto_address_fax.\",\".$mailto_address_user;\n\t\t}\n\t\telse {\n\t\t\t$mailto_address = $mailto_address_user;\n\t\t}\n\n\t\t//send the fax\n\t\t$fax_file = $dir_fax_temp.\"/\".$fax_instance_uuid.\".tif\";\n\t\t$tmp_dial_string  = \"for_fax=1,\";\n\t\t$tmp_dial_string .= \"accountcode='\"                  . $fax_accountcode         . \"',\";\n\t\t$tmp_dial_string .= \"sip_h_X-accountcode='\"          . $fax_accountcode         . \"',\";\n\t\t$tmp_dial_string .= \"domain_uuid=\"                   . $_SESSION[\"domain_uuid\"] . \",\";\n\t\t$tmp_dial_string .= \"domain_name=\"                   . $_SESSION[\"domain_name\"] . \",\";\n\t\t$tmp_dial_string .= \"origination_caller_id_name='\"   . $fax_caller_id_name      . \"',\";\n\t\t$tmp_dial_string .= \"origination_caller_id_number='\" . $fax_caller_id_number    . \"',\";\n\t\t$tmp_dial_string .= \"fax_ident='\"                    . $fax_caller_id_number    . \"',\";\n\t\t$tmp_dial_string .= \"fax_header='\"                   . $fax_caller_id_name      . \"',\";\n\t\t$tmp_dial_string .= \"fax_file='\"                     . $fax_file                . \"',\";\n\t\tforeach ($fax_numbers as $fax_number) {\n\n\t\t\t$fax_number = trim($fax_number);\n\t\t\tfax_split_dtmf($fax_number, $fax_dtmf);\n\n\t\t\t//prepare the fax command\n\t\t\tif (strlen($fax_toll_allow) > 0) {\n\t\t\t\t$channel_variables[\"toll_allow\"] = $fax_toll_allow;\n\t\t\t}\n\t\t\t$route_array = outbound_route_to_bridge($_SESSION['domain_uuid'], $fax_prefix . $fax_number, $channel_variables);\n\t\t\tif (count($route_array) == 0) {\n\t\t\t\t//send the internal call to the registered extension\n\t\t\t\t$fax_uri = \"user/\".$fax_number.\"@\".$_SESSION['domain_name'];\n\t\t\t\t$fax_variables = \"\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//send the external call\n\t\t\t\t$fax_uri = $route_array[0];\n\t\t\t\t$fax_variables = \"\";\n\t\t\t\tforeach($_SESSION['fax']['variable'] as $variable) {\n\t\t\t\t\t$fax_variables .= $variable.\",\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ($fax_send_mode != 'queue') {\n\t\t\t\t$dial_string = $tmp_dial_string;\n\t\t\t\t$dial_string .= $fax_variables;\n\t\t\t\t$dial_string .= \"mailto_address='\"     . $mailto_address   . \"',\";\n\t\t\t\t$dial_string .= \"mailfrom_address='\"   . $mailfrom_address . \"',\";\n\t\t\t\t$dial_string .= \"fax_uri=\" . $fax_uri  . \",\";\n\t\t\t\t$dial_string .= \"fax_retry_attempts=1\" . \",\";\n\t\t\t\t$dial_string .= \"fax_retry_limit=20\"   . \",\";\n\t\t\t\t$dial_string .= \"fax_retry_sleep=180\"  . \",\";\n\t\t\t\t$dial_string .= \"fax_verbose=true\"     . \",\";\n\t\t\t\t$dial_string .= \"fax_use_ecm=off\"      . \",\";\n\t\t\t\t$dial_string .= \"api_hangup_hook='lua fax_retry.lua'\";\n\t\t\t\t$dial_string  = \"{\" . $dial_string . \"}\" . $fax_uri.\" &txfax('\".$fax_file.\"')\";\n\n\t\t\t\t$fp = event_socket_create($_SESSION['event_socket_ip_address'], $_SESSION['event_socket_port'], $_SESSION['event_socket_password']);\n\t\t\t\tif ($fp) {\n\t\t\t\t\t$cmd = \"api originate \" . $dial_string;\n\t\t\t\t\t//send the command to event socket\n\t\t\t\t\t$response = event_socket_request($fp, $cmd);\n\t\t\t\t\t$response = str_replace(\"\\n\", \"\", $response);\n\t\t\t\t\t$uuid = str_replace(\"+OK \", \"\", $response);\n\t\t\t\t}\n\t\t\t\tfclose($fp);\n\t\t\t}\n\t\t\telse { // enqueue\n\t\t\t\t$wav_file = ''; //! @todo add custom message\n\t\t\t\t$dial_string = $tmp_dial_string;\n\t\t\t\t$response = fax_enqueue($fax_uuid, $fax_file, $wav_file, $mailto_address, $fax_uri, $fax_dtmf, $dial_string);\n\t\t\t}\n\t\t}\n\n\t\t//wait for a few seconds\n\t\tsleep(5);\n\n\t\t//move the generated tif (and pdf) files to the sent directory\n\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.\".tif\")) {\n\t\t\tcopy($dir_fax_temp.'/'.$fax_instance_uuid.\".tif\", $dir_fax_sent.'/'.$fax_instance_uuid.\".tif\");\n\t\t}\n\n\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.\".pdf\")) {\n\t\t\tcopy($dir_fax_temp.'/'.$fax_instance_uuid.\".pdf \", $dir_fax_sent.'/'.$fax_instance_uuid.\".pdf\");\n\t\t}\n\n\t\tif (!$included && is_uuid($fax_uuid)) {\n\t\t\t//redirect the browser\n\t\t\tmessage::add($response, 'default');\n\t\t\tif (isset($_SESSION['fax']['send_mode']['text']) && $_SESSION['fax']['send_mode']['text'] == 'queue') {\n\t\t\t\theader(\"Location: fax_active.php?id=\".$fax_uuid);\n\t\t\t}\n\t\t\telse {\n\t\t\t\theader(\"Location: fax_files.php?id=\".$fax_uuid.\"&box=sent\");\n\t\t\t}\n\t\t\texit;\n\t\t}\n\n\t} //end upload and send fax\n\n\nif (!$included) {\n\n\t//create token\n\t\t$object = new token;\n\t\t$token = $object->create($_SERVER['PHP_SELF']);\n\n\t//show the header\n\t\t$document['title'] = $text['title-new_fax'];\n\t\trequire_once \"resources/header.php\";\n\n\t//javascript to toggle input/select boxes, add fax numbers\n\t\techo \"<script language='JavaScript' type='text/javascript' src='\".PROJECT_PATH.\"/resources/javascript/reset_file_input.js'></script>\\n\";\n\t\techo \"<script language='JavaScript' type='text/javascript'>\";\n\n\t\techo \"\tfunction toggle(field) {\";\n\t\techo \"\t\tif (field == 'fax_recipient') {\";\n\t\techo \"\t\t\tdocument.getElementById('fax_recipient_select').selectedIndex = 0;\";\n\t\techo \"\t\t\t$('#fax_recipient_select').toggle();\";\n\t\techo \"\t\t\t$('#fax_recipient').toggle();\";\n\t\techo \"\t\t\tif ($('#fax_recipient').is(':visible')) { $('#fax_recipient').trigger('focus'); } else { $('#fax_recipient_select').trigger('focus'); }\";\n\t\techo \"\t\t}\";\n\t\techo \"\t}\";\n\n\t\techo \"\tfunction contact_load(obj_sel) {\";\n\t\techo \"\t\tobj_sel.style.display='none';\";\n\t\techo \"\t\tdocument.getElementById('fax_recipient').style.display='';\";\n\t\techo \"\t\tvar selected_option_value = obj_sel.options[obj_sel.selectedIndex].value;\";\n\t\techo \"\t\tvar selected_option_values = selected_option_value.split('|', 2);\";\n\t\techo \"\t\tdocument.getElementById('fax_recipient').value = selected_option_values[1];\";\n\t\techo \"\t\tdocument.getElementById('fax_number').value = selected_option_values[0];\";\n\t\techo \"\t\t$('#fax_recipient').css({width: '50%'});\";\n\t\techo \"\t\t$('#fax_number').css({width: '120px'});\";\n\t\techo \"\t}\";\n\n\t\techo \"\tfunction list_selected_files(file_input_number) {\";\n\t\techo \"\t\tvar inp = document.getElementById('fax_files_'+file_input_number);\";\n\t\techo \"\t\tvar files_selected = [];\";\n\t\techo \"\t\tfor (var i = 0; i < inp.files.length; ++i) {\";\n\t\techo \"\t\t\tvar file_name = inp.files.item(i).name;\";\n\t\techo \"\t\t\tfiles_selected.push(file_name);\";\n\t\techo \"\t\t}\";\n\t\techo \"\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML = '';\";\n\t\techo \"\t\tif (files_selected.length > 1) {\";\n\t\techo \"\t\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML = '<strong>\".$text['label-selected'].\"</strong>: ';\";\n\t\techo \"\t\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML += files_selected.join(', ');\";\n\t\techo \"\t\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML += '<br />';\";\n\t\techo \"\t\t}\";\n\t\techo \"\t}\";\n\n\t\techo \"\tfunction add_fax_number() {\\n\";\n\t\techo \"\t\tvar newdiv = document.createElement('div');\\n\";\n\t\techo \"\t\tnewdiv.innerHTML = \\\"<input type='text' name='fax_numbers[]' class='formfld' style='width: 150px; min-width: 150px; max-width: 150px; margin-top: 3px;' maxlength='25'>\\\";\";\n\t\techo \"\t\tdocument.getElementById('fax_numbers').appendChild(newdiv);\";\n\t\techo \"\t}\\n\";\n\n\t\techo \"</script>\";\n\n\t//show the content\n\t\techo \"<form method='post' name='frm' id='frm' enctype='multipart/form-data'>\\n\";\n\n\t\techo \"<div class='action_bar' id='action_bar'>\\n\";\n\t\techo \"\t<div class='heading'><b>\".$text['header-new_fax'].\"</b></div>\\n\";\n\t\techo \"\t<div class='actions'>\\n\";\n\t\techo button::create(['type'=>'button','label'=>$text['button-back'],'icon'=>$_SESSION['theme']['button_icon_back'],'id'=>'btn_back','style'=>'margin-right: 15px;','link'=>'fax.php']);\n\t\techo button::create(['type'=>'submit','label'=>$text['button-preview'],'icon'=>'eye','name'=>'submit','value'=>'preview']);\n\t\techo button::create(['type'=>'submit','label'=>$text['button-send'],'icon'=>'paper-plane','id'=>'btn_save','name'=>'submit','value'=>'send','style'=>'margin-left: 15px;']);\n\t\techo \"\t</div>\\n\";\n\t\techo \"\t<div style='clear: both;'></div>\\n\";\n\t\techo \"</div>\\n\";\n\t\techo $text['description-2'].\" \".(permission_exists('fax_extension_view_domain') ? $text['description-3'] : null).\"\\n\";\n\t\techo \"<br /><br />\\n\";\n\n\t\techo \"<table width='100%' border='0' cellspacing='0' cellpadding='0'>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax-header'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input type='text' name='fax_header' class='formfld' style='' value='\".$_SESSION['fax']['cover_header']['text'].\"'>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-header'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax-sender'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input type='text' name='fax_sender' class='formfld' style='' value='\".escape($fax_caller_id_name).\"'>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-sender'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax-recipient'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t//retrieve current user's assigned groups (uuids)\n\t\tforeach ($_SESSION['groups'] as $group_data) {\n\t\t\t$user_group_uuids[] = $group_data['group_uuid'];\n\t\t}\n\t\t//add user's uuid to group uuid list to include private (non-shared) contacts\n\t\t$user_group_uuids[] = $_SESSION[\"user_uuid\"];\n\t\t$sql = \"select \";\n\t\t$sql .= \"c.contact_organization, \";\n\t\t$sql .= \"c.contact_name_given, \";\n\t\t$sql .= \"c.contact_name_family, \";\n\t\t$sql .= \"c.contact_nickname, \";\n\t\t$sql .= \"cp.phone_number \";\n\t\t$sql .= \"from \";\n\t\t$sql .= \"v_contacts as c, \";\n\t\t$sql .= \"v_contact_phones as cp \";\n\t\t$sql .= \"where \";\n\t\t$sql .= \"c.contact_uuid = cp.contact_uuid \";\n\t\t$sql .= \"and c.domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and cp.domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and cp.phone_type_fax = 1 \";\n\t\t$sql .= \"and cp.phone_number is not null \";\n\t\t$sql .= \"and cp.phone_number <> '' \";\n\t\tif (is_array($user_group_uuids) && @sizeof($user_group_uuids) != 0) {\n\t\t\t//only show contacts assigned to current user's group(s) and those not assigned to any group\n\t\t\t$sql .= \"and (\";\n\t\t\t$sql .= \"\tc.contact_uuid in ( \";\n\t\t\t$sql .= \"\t\tselect contact_uuid from v_contact_groups \";\n\t\t\t$sql .= \"\t\twhere (\";\n\t\t\tforeach ($user_group_uuids as $index => $user_group_uuid) {\n\t\t\t\t$sql .= $or;\n\t\t\t\t$sql .= \"\t\tgroup_uuid = :group_uuid_\".$index.\" \";\n\t\t\t\t$parameters['group_uuid_'.$index] = $user_group_uuid;\n\t\t\t\t$or = \" or \";\n\t\t\t}\n\t\t\tunset($user_group_uuids, $index, $user_group_uuid, $or);\n\t\t\t$sql .= \"\t\t) \";\n\t\t\t$sql .= \"\t\tand domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"\t) \";\n\t\t\t$sql .= \"\tor \";\n\t\t\t$sql .= \"\tc.contact_uuid not in ( \";\n\t\t\t$sql .= \"\t\tselect contact_uuid from v_contact_groups \";\n\t\t\t$sql .= \"\t\twhere domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"\t) \";\n\t\t\t$sql .= \") \";\n\t\t}\n\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t$database = new database;\n\t\t$contacts = $database->select($sql, $parameters, 'all');\n\t\tif (is_array($contacts) && @sizeof($contacts) != 0) {\n\t\t\tforeach ($contacts as &$row) {\n\t\t\t\tif ($row['contact_organization'] != '') {\n\t\t\t\t\t$contact_option_label = $row['contact_organization'];\n\t\t\t\t}\n\t\t\t\tif ($row['contact_name_given'] != '' || $row['contact_name_family'] != '' || $row['contact_nickname'] != '') {\n\t\t\t\t\t$contact_option_label .= ($row['contact_organization'] != '') ? \",\" : null;\n\t\t\t\t\t$contact_option_label .= ($row['contact_name_given'] != '') ? (($row['contact_organization'] != '') ? \" \" : null).$row['contact_name_given'] : null;\n\t\t\t\t\t$contact_option_label .= ($row['contact_name_family'] != '') ? (($row['contact_organization'] != '' || $row['contact_name_given'] != '') ? \" \" : null).$row['contact_name_family'] : null;\n\t\t\t\t\t$contact_option_label .= ($row['contact_nickname'] != '') ? (($row['contact_organization'] != '' || $row['contact_name_given'] != '' || $row['contact_name_family'] != '') ? \" (\".$row['contact_nickname'].\")\" : $row['contact_nickname']) : null;\n\t\t\t\t}\n\t\t\t\t$contact_option_value_recipient = $contact_option_label;\n\t\t\t\t$contact_option_value_faxnumber = $row['phone_number'];\n\t\t\t\t$contact_option_label .= \":&nbsp;&nbsp;\".escape(format_phone($row['phone_number']));\n\t\t\t\t$contact_labels[] = $contact_option_label;\n\t\t\t\t$contact_values[] = $contact_option_value_faxnumber.\"|\".$contact_option_value_recipient;\n\t\t\t\tunset($contact_option_label);\n\t\t\t}\n\t\t\tif (is_array($contact_labels)) {\n\t\t\t\tasort($contact_labels, SORT_NATURAL); // sort by name(s)\n\t\t\t}\n\t\t\techo \"\t<select class='formfld' style='display: none;' id='fax_recipient_select' onchange='contact_load(this);'>\\n\";\n\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\tforeach ($contact_labels as $index => $contact_label) {\n\t\t\t\techo \"\t<option value=\\\"\".escape($contact_values[$index]).\"\\\">\".$contact_label.\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t\techo \"\t<input type='text' name='fax_recipient' id='fax_recipient' class='formfld' style='max-width: 250px;' value=''>\\n\";\n\t\tif (is_array($contacts)) {\n\t\t\techo \"\t<input type='button' id='btn_toggle_recipient' class='btn' name='' alt='\".$text['button-back'].\"' value='&#9665;' onclick=\\\"toggle('fax_recipient');\\\">\\n\";\n\t\t}\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-recipient'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\t\".$text['label-fax-number'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<table cellpadding='0' cellspacing='0' border='0'>\";\n\t\techo \"\t\t<tr>\";\n\t\techo \"\t\t\t<td id='fax_numbers'>\";\n\t\techo \"\t\t\t\t<input type='text' name='fax_numbers[]' id='fax_number' class='formfld' style='width: 150px; min-width: 150px; max-width: 150px;' maxlength='25'>\\n\";\n\t\techo \"\t\t\t</td>\";\n\t\techo \"\t\t\t<td style='vertical-align: bottom;'>\";\n\t\techo \"\t\t\t\t<a href='javascript:void(0);' onclick='add_fax_number();'>$v_link_label_add</a>\";\n\t\techo \"\t\t\t</td>\";\n\t\techo \"\t\t</tr>\";\n\t\techo \"\t</table>\";\n\t\techo \"\t\".$text['description-fax-number'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax_files'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tfor ($f = 1; $f <= 3; $f++) {\n\t\t\techo \"\t<span id='fax_file_\".$f.\"' \".(($f > 1) ? \"style='display: none;'\" : null).\">\";\n\t\t\techo \"\t<input name='fax_files[]' id='fax_files_\".$f.\"' type='file' class='formfld fileinput' style='margin-right: 3px; \".(($f > 1) ? \"margin-top: 3px;\" : null).\"' onchange=\\\"\".(($f < 3) ? \"document.getElementById('fax_file_\".($f+1).\"').style.display='';\" : null).\" list_selected_files(\".$f.\");\\\" multiple='multiple'>\";\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-clear'],'icon'=>$_SESSION['theme']['button_icon_reset'],'onclick'=>\"reset_file_input('fax_files_\".$f.\"'); document.getElementById('file_list_\".$f.\"').innerHTML='';\"]);\n\t\t\techo \t\"<br />\";\n\t\t\techo \"\t<span id='file_list_\".$f.\"'></span>\";\n\t\t\techo \"\t</span>\\n\";\n\t\t}\n\t\techo \"\t\".$text['description-fax_files'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\t\".$text['label-fax-resolution'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<select name='fax_resolution' class='formfld'>\\n\";\n\t\techo \"\t\t<option value='normal' \".(($_SESSION['fax']['resolution']['text'] == 'normal') ? 'selected' : null).\">\".$text['option-fax-resolution-normal'].\"</option>\\n\";\n\t\techo \"\t\t<option value='fine' \".(($_SESSION['fax']['resolution']['text'] == 'fine') ? 'selected' : null).\">\".$text['option-fax-resolution-fine'].\"</option>\\n\";\n\t\techo \"\t\t<option value='superfine' \".(($_SESSION['fax']['resolution']['text'] == 'superfine') ? 'selected' : null).\">\".$text['option-fax-resolution-superfine'].\"</option>\\n\";\n\t\techo \"\t</select>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-resolution'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\t\".$text['label-fax-page-size'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<select name='fax_page_size' class='formfld'>\\n\";\n\t\techo \"\t\t<option value='letter' \".(($_SESSION['fax']['page_size']['text'] == 'letter') ? 'selected' : null).\">Letter</option>\\n\";\n\t\techo \"\t\t<option value='legal' \".(($_SESSION['fax']['page_size']['text'] == 'legal') ? 'selected' : null).\">Legal</option>\\n\";\n\t\techo \"\t\t<option value='a4' \".(($_SESSION['fax']['page_size']['text'] == 'a4') ? 'selected' : null).\">A4</option>\\n\";\n\t\techo \"\t</select>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-page-size'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\tif (permission_exists('fax_subject')) {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"\t\".$text['label-fax-subject'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"\t<input type='text' name='fax_subject' class='formfld' style='' value=''>\\n\";\n\t\t\techo \"\t<br />\\n\";\n\t\t\techo \"\t\".$text['description-fax-subject'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\tif (permission_exists('fax_message')) {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"\t\t\".$text['label-fax-message'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"\t<textarea type='text' name='fax_message' class='formfld' style='width: 65%; height: 175px;'></textarea>\\n\";\n\t\t\techo \"<br />\\n\";\n\t\t\techo \"\t\".$text['description-fax-message'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\tif (permission_exists('fax_footer')) {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"\t\".$text['label-fax-footer'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"\t<textarea type='text' name='fax_footer' class='formfld' style='width: 65%; height: 100px;'>\".$_SESSION['fax']['cover_footer']['text'].\"</textarea>\\n\";\n\t\t\techo \"\t<br />\\n\";\n\t\t\techo \"\t\".$text['description-fax-footer'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\techo \"</table>\";\n\t\techo \"<br /><br />\\n\";\n\n\t\techo \"<input type='hidden' name='fax_caller_id_name' value='\".escape($fax_caller_id_name).\"'>\\n\";\n\t\techo \"<input type='hidden' name='fax_caller_id_number' value='\".escape($fax_caller_id_number).\"'>\\n\";\n\t\techo \"<input type='hidden' name='fax_extension' value='\".escape($fax_extension).\"'>\\n\";\n\t\techo \"<input type='hidden' name='id' value='\".escape($fax_uuid).\"'>\\n\";\n\t\techo \"<input type='hidden' name='action' value='send'>\\n\";\n\t\techo \"<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\n\t\techo \"</form>\\n\";\n\n\t//show the footer\n\t\trequire_once \"resources/footer.php\";\n\n}\n\n// used for initial element alignment during pdf generation\n/*\nfunction showgrid($pdf) {\n\t// generate a grid for placement\n\tfor ($x=0; $x<=8.5; $x+=0.1) {\n\t\tfor ($y=0; $y<=11; $y+=0.1) {\n\t\t\t$pdf->SetTextColor(0,0,0);\n\t\t\t$pdf->SetFont(\"courier\", \"\", 3);\n\t\t\t$pdf->Text($x-0.01,$y-0.01,\".\");\n\t\t}\n\t}\n\tfor ($x=0; $x<=9; $x+=1) {\n\t\tfor ($y=0; $y<=11; $y+=1) {\n\t\t\t$pdf->SetTextColor(255,0,0);\n\t\t\t$pdf->SetFont(\"times\", \"\", 10);\n\t\t\t$pdf->Text($x-.02,$y-.01,\".\");\n\t\t\t$pdf->SetFont(\"courier\", \"\", 4);\n\t\t\t$pdf->Text($x+0.01,$y+0.035,$x.\",\".$y);\n\t\t}\n\t}\n}\n*/\n\n?>\n"], "fixing_code": ["<?php\n/*\n\tFusionPBX\n\tVersion: MPL 1.1\n\n\tThe contents of this file are subject to the Mozilla Public License Version\n\t1.1 (the \"License\"); you may not use this file except in compliance with\n\tthe License. You may obtain a copy of the License at\n\thttp://www.mozilla.org/MPL/\n\n\tSoftware distributed under the License is distributed on an \"AS IS\" basis,\n\tWITHOUT WARRANTY OF ANY KIND, either express or implied. See the License\n\tfor the specific language governing rights and limitations under the\n\tLicense.\n\n\tThe Original Code is FusionPBX\n\n\tThe Initial Developer of the Original Code is\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tPortions created by the Initial Developer are Copyright (C) 2008-2021\n\tthe Initial Developer. All Rights Reserved.\n\n\tContributor(s):\n\tMark J Crane <markjcrane@fusionpbx.com>\n\tJames Rose <james.o.rose@gmail.com>\n\tLuis Daniel Lucio Quiroz <dlucio@okay.com.mx>\n\tErrol Samuels <voiptology@gmail.com>\n\tCorey Moullas <cmoullas@emak.tech>\n*/\n\nif (!isset($included)) { $included = false; }\n\nif (stristr(PHP_OS, 'WIN')) { $IS_WINDOWS = true; } else { $IS_WINDOWS = false; }\n\nif (!$included) {\n\n\t//includes\n\t\tinclude \"root.php\";\n\t\trequire_once \"resources/require.php\";\n\t\trequire_once \"resources/check_auth.php\";\n\n\t//check permissions\n\t\tif (permission_exists('fax_send')) {\n\t\t\t//access granted\n\t\t}\n\t\telse {\n\t\t\techo \"access denied\";\n\t\t\texit;\n\t\t}\n\n\t//add multi-lingual support\n\t\t$language = new text;\n\t\t$text = $language->get();\n\n\t//get the fax_extension and save it as a variable\n\t\tif (isset($_REQUEST[\"fax_extension\"]) && is_numeric($_REQUEST[\"fax_extension\"])) {\n\t\t\t$fax_extension = $_REQUEST[\"fax_extension\"];\n\t\t}\n\n\t//pre-populate the form\n\t\tif (is_uuid($_REQUEST['id']) && $_POST[\"persistformvar\"] != \"true\") {\n\t\t\t$fax_uuid = $_REQUEST[\"id\"];\n\t\t\tif (permission_exists('fax_extension_view_domain')) {\n\t\t\t\t//show all fax extensions\n\t\t\t\t$sql = \"select fax_uuid, fax_extension, fax_caller_id_name, fax_caller_id_number, \";\n\t\t\t\t$sql .= \"fax_toll_allow, accountcode, fax_send_greeting \";\n\t\t\t\t$sql .= \"from v_fax \";\n\t\t\t\t$sql .= \"where domain_uuid = :domain_uuid \";\n\t\t\t\t$sql .= \"and fax_uuid = :fax_uuid \";\n\t\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t$parameters['fax_uuid'] = $fax_uuid;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//show only assigned fax extensions\n\t\t\t\t$sql = \"select f.fax_uuid, f.fax_extension, f.fax_caller_id_name, f.fax_caller_id_number, \";\n\t\t\t\t$sql .= \"f.fax_toll_allow, f.accountcode, f.fax_send_greeting \";\n\t\t\t\t$sql .= \"from v_fax as f, v_fax_users as u \";\n\t\t\t\t$sql .= \"where f.fax_uuid = u.fax_uuid \";\n\t\t\t\t$sql .= \"and f.domain_uuid = :domain_uuid \";\n\t\t\t\t$sql .= \"and f.fax_uuid = :fax_uuid \";\n\t\t\t\t$sql .= \"and u.user_uuid = :user_uuid \";\n\t\t\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t\t\t$parameters['fax_uuid'] = $fax_uuid;\n\t\t\t\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t\t\t}\n\t\t\t$database = new database;\n\t\t\t$row = $database->select($sql, $parameters, 'row');\n\t\t\tif (is_array($row) && @sizeof($row) != 0) {\n\t\t\t\t//set database fields as variables\n\t\t\t\t\t$fax_uuid = $row[\"fax_uuid\"];\n\t\t\t\t\t$fax_extension = $row[\"fax_extension\"];\n\t\t\t\t\t$fax_caller_id_name = $row[\"fax_caller_id_name\"];\n\t\t\t\t\t$fax_caller_id_number = $row[\"fax_caller_id_number\"];\n\t\t\t\t\t$fax_toll_allow = $row[\"fax_toll_allow\"];\n\t\t\t\t\t$fax_accountcode = $row[\"accountcode\"];\n\t\t\t\t\t$fax_send_greeting = $row[\"fax_send_greeting\"];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (!permission_exists('fax_extension_view_domain')) {\n\t\t\t\t\techo \"access denied\";\n\t\t\t\t\texit;\n\t\t\t\t}\n\t\t\t}\n\t\t\tunset($sql, $parameters, $row);\n\n\t\t\t$fax_send_mode = $_SESSION['fax']['send_mode']['text'];\n\t\t\tif(strlen($fax_send_mode) == 0){\n\t\t\t\t$fax_send_mode = 'direct';\n\t\t\t}\n\t\t}\n\n\t//set the fax directory\n\t\t$fax_dir = $_SESSION['switch']['storage']['dir'].'/fax/'.$_SESSION['domain_name'];\n\n\t// set fax cover font to generate pdf\n\t\t$fax_cover_font = $_SESSION['fax']['cover_font']['text'];\n}\nelse {\n\trequire_once \"resources/classes/event_socket.php\";\n}\n\nif (!function_exists('correct_path')) {\n\tfunction correct_path($p) {\n\t\tglobal $IS_WINDOWS;\n\t\tif ($IS_WINDOWS) {\n\t\t\treturn str_replace('/', '\\\\', $p);\n\t\t}\n\t\treturn $p;\n\t}\n}\n\nif (!function_exists('gs_cmd')) {\n\tfunction gs_cmd($args) {\n\t\tglobal $IS_WINDOWS;\n\t\tif ($IS_WINDOWS) {\n\t\t\treturn 'gswin32c '.$args;\n\t\t}\n\t\treturn 'gs '.$args;\n\t}\n}\n\nif (!function_exists('fax_enqueue')) {\n\tfunction fax_enqueue($fax_uuid, $fax_file, $wav_file, $reply_address, $fax_uri, $fax_dtmf, $dial_string){\n\t\tglobal $db_type;\n\n\t\t$fax_task_uuid = uuid();\n\t\t$dial_string .= \"fax_task_uuid='\" . $fax_task_uuid . \"',\";\n\t\t$description = ''; //! @todo add description\n\t\tif ($db_type == \"pgsql\") {\n\t\t\t$date_utc_now_sql  = \"NOW() at time zone 'utc'\";\n\t\t}\n\t\tif ($db_type == \"mysql\") {\n\t\t\t$date_utc_now_sql  = \"UTC_TIMESTAMP()\";\n\t\t}\n\t\tif ($db_type == \"sqlite\") {\n\t\t\t$date_utc_now_sql  = \"datetime('now')\";\n\t\t}\n\n\t\t$array['fax_tasks'][0]['fax_task_uuid'] = $fax_task_uuid;\n\t\t$array['fax_tasks'][0]['fax_uuid'] = $fax_uuid;\n\t\t$array['fax_tasks'][0]['task_next_time'] = $date_utc_now_sql;\n\t\t$array['fax_tasks'][0]['task_lock_time'] = null;\n\t\t$array['fax_tasks'][0]['task_fax_file'] = $fax_file;\n\t\t$array['fax_tasks'][0]['task_wav_file'] = $wav_file;\n\t\t$array['fax_tasks'][0]['task_uri'] = $fax_uri;\n\t\t$array['fax_tasks'][0]['task_dial_string'] = $dial_string;\n\t\t$array['fax_tasks'][0]['task_dtmf'] = $fax_dtmf;\n\t\t$array['fax_tasks'][0]['task_interrupted'] = 'false';\n\t\t$array['fax_tasks'][0]['task_status'] = 0;\n\t\t$array['fax_tasks'][0]['task_no_answer_counter'] = 0;\n\t\t$array['fax_tasks'][0]['task_no_answer_retry_counter'] = 0;\n\t\t$array['fax_tasks'][0]['task_retry_counter'] = 0;\n\t\t$array['fax_tasks'][0]['task_reply_address'] = $reply_address;\n\t\t$array['fax_tasks'][0]['task_description'] = $description;\n\n\t\t$p = new permissions;\n\t\t$p->add('fax_task_add', 'temp');\n\n\t\t$database = new database;\n\t\t$database->app_name = 'fax';\n\t\t$database->app_uuid = '24108154-4ac3-1db6-1551-4731703a4440';\n\t\t$database->save($array);\n\t\t$message = $database->message;\n\t\tunset($array);\n\n\t\t$p->delete('fax_task_add', 'temp');\n\n\t\tif ($message['message'] == 'OK' && $message['code'] == 200) {\n\t\t\t$response = 'Enqueued';\n\t\t}\n\t\telse {\n\t\t\t$response = 'Fail Enqueue';\n\n\t\t\techo $message['message'].' ['.$message['code'].\"]<br />\\n\";\n\t\t\tif (is_array($message['error']) && @sizeof($message['error']) != 0) {\n\t\t\t\tforeach ($message['error'] as $error) {\n\t\t\t\t\techo \"<pre>\".$error.\"</pre><br /><br />\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn $response;\n\t}\n}\n\nif (!function_exists('fax_split_dtmf')) {\n\tfunction fax_split_dtmf(&$fax_number, &$fax_dtmf){\n\t\t$tmp = array();\n\t\t$fax_dtmf = '';\n\t\tif (preg_match('/^\\s*(.*?)\\s*\\((.*)\\)\\s*$/', $fax_number, $tmp)){\n\t\t\t$fax_number = $tmp[1];\n\t\t\t$fax_dtmf = $tmp[2];\n\t\t}\n\t}\n}\n\n//get the fax extension\n\tif (isset($fax_extension) && is_numeric($fax_extension)) {\n\t\t//set the fax directories. example /usr/local/freeswitch/storage/fax/329/inbox\n\t\t\t$dir_fax_inbox = $fax_dir.'/'.$fax_extension.'/inbox';\n\t\t\t$dir_fax_sent = $fax_dir.'/'.$fax_extension.'/sent';\n\t\t\t$dir_fax_temp = $fax_dir.'/'.$fax_extension.'/temp';\n\n\t\t//make sure the directories exist\n\t\t\tif (!is_dir($_SESSION['switch']['storage']['dir'])) {\n\t\t\t\tmkdir($_SESSION['switch']['storage']['dir'], 0770);\n\t\t\t}\n\t\t\tif (!is_dir($_SESSION['switch']['storage']['dir'].'/fax')) {\n\t\t\t\tmkdir($_SESSION['switch']['storage']['dir'].'/fax', 0770);\n\t\t\t}\n\t\t\tif (!is_dir($_SESSION['switch']['storage']['dir'].'/fax/'.$_SESSION['domain_name'])) {\n\t\t\t\tmkdir($_SESSION['switch']['storage']['dir'].'/fax/'.$_SESSION['domain_name'], 0770);\n\t\t\t}\n\t\t\tif (!is_dir($fax_dir.'/'.$fax_extension)) {\n\t\t\t\tmkdir($fax_dir.'/'.$fax_extension, 0770);\n\t\t\t}\n\t\t\tif (!is_dir($dir_fax_inbox)) {\n\t\t\t\tmkdir($dir_fax_inbox, 0770);\n\t\t\t}\n\t\t\tif (!is_dir($dir_fax_sent)) {\n\t\t\t\tmkdir($dir_fax_sent, 0770);\n\t\t\t}\n\t\t\tif (!is_dir($dir_fax_temp)) {\n\t\t\t\tmkdir($dir_fax_temp, 0770);\n\t\t\t}\n\t}\n\n//clear file status cache\n\tclearstatcache();\n\n//send the fax\n\t$continue = false;\n\tif (!$included) {\n\t\tif (($_POST['action'] == \"send\")) {\n\t\t\t$fax_numbers = $_POST['fax_numbers'];\n\t\t\t$fax_uuid = $_POST[\"id\"];\n\t\t\t$fax_caller_id_name = $_POST['fax_caller_id_name'];\n\t\t\t$fax_caller_id_number = $_POST['fax_caller_id_number'];\n\t\t\t$fax_header = $_POST['fax_header'];\n\t\t\t$fax_sender = $_POST['fax_sender'];\n\t\t\t$fax_recipient = $_POST['fax_recipient'];\n\t\t\t$fax_subject = $_POST['fax_subject'];\n\t\t\t$fax_message = $_POST['fax_message'];\n\t\t\t$fax_resolution = $_POST['fax_resolution'];\n\t\t\t$fax_page_size = $_POST['fax_page_size'];\n\t\t\t$fax_footer = $_POST['fax_footer'];\n\n\t\t\t//validate the token\n\t\t\t\t$token = new token;\n\t\t\t\tif (!$token->validate($_SERVER['PHP_SELF'])) {\n\t\t\t\t\tmessage::add($text['message-invalid_token'],'negative');\n\t\t\t\t\theader('Location: fax_send.php'.(is_uuid($fax_uuid) ? '?id='.$fax_uuid : null));\n\t\t\t\t\texit;\n\t\t\t\t}\n\n\t\t\t$continue = true;\n\t\t}\n\t}\n\telse {\n\t\t//all necessary local and session variables should\n\t\t//be already set by now by file including this one\n\t\t$continue = true;\n\t}\n\n//cleanup numbers\n\tif (isset($fax_numbers)) {\n\t\tforeach ($fax_numbers as $index => $fax_number) {\n\t\t\tfax_split_dtmf($fax_number, $fax_dtmf);\n\t\t\t$fax_number = preg_replace(\"~[^0-9]~\", \"\", $fax_number);\n\t\t\t$fax_dtmf   = preg_replace(\"~[^0-9Pp*#]~\", \"\", $fax_dtmf);\n\t\t\tif ($fax_number != ''){\n\t\t\t\tif ($fax_dtmf != '') {$fax_number .= \" (\" . $fax_dtmf . \")\";}\n\t\t\t\t$fax_numbers[$index] = $fax_number;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tunset($fax_numbers[$index]);\n\t\t\t}\n\t\t}\n\t\tsort($fax_numbers);\n\t}\n\n\tif ($continue) {\n\t\t//determine page size\n\t\tswitch ($fax_page_size) {\n\t\t\tcase 'a4' :\n\t\t\t\t$page_width = 8.3; //in\n\t\t\t\t$page_height = 11.7; //in\n\t\t\t\tbreak;\n\t\t\tcase 'legal' :\n\t\t\t\t$page_width = 8.5; //in\n\t\t\t\t$page_height = 14; //in\n\t\t\t\tbreak;\n\t\t\tcase 'letter' :\n\t\t\t\t$page_width = 8.5; //in\n\t\t\t\t$page_height = 11; //in\n\t\t\t\tbreak;\n\t\t\tdefault\t:\n\t\t\t\t$page_width = 8.5; //in\n\t\t\t\t$page_height = 11; //in\n\t\t\t\t$fax_page_size = 'letter';\n\t\t}\n\n\t\t//set resolution\n\t\tswitch ($fax_resolution) {\n\t\t\tcase 'fine':\n\t\t\t\t$gs_r = '204x196';\n\t\t\t\t$gs_g = ((int) ($page_width * 204)).'x'.((int) ($page_height * 196));\n\t\t\t\tbreak;\n\t\t\tcase 'superfine':\n\t\t\t\t$gs_r = '204x392';\n\t\t\t\t$gs_g = ((int) ($page_width * 204)).'x'.((int) ($page_height * 392));\n\t\t\t\tbreak;\n\t\t\tcase 'normal':\n\t\t\tdefault:\n\t\t\t\t$gs_r = '204x98';\n\t\t\t\t$gs_g = ((int) ($page_width * 204)).'x'.((int) ($page_height * 98));\n\t\t\t\tbreak;\n\t\t}\n\n\t\t//process uploaded or emailed files (if any)\n\t\t$fax_page_count = 0;\n\t\t$_files = (!$included) ? $_FILES['fax_files'] : $emailed_files;\n\t\tunset($tif_files);\n\t\tforeach ($_files['tmp_name'] as $index => $fax_tmp_name) {\n\t\t\t$uploaded_file = (!$included) ? is_uploaded_file($fax_tmp_name) : true;\n\t\t\tif ( $uploaded_file && $_files['error'][$index] == 0 && $_files['size'][$index] > 0 ) {\n\t\t\t\t//get the file extension\n\t\t\t\t$fax_file_extension = strtolower(pathinfo($_files['name'][$index], PATHINFO_EXTENSION));\n\t\t\t\tif ($fax_file_extension == \"tiff\") { $fax_file_extension = \"tif\"; }\n\n\t\t\t\t//block unauthorized files\n\t\t\t\t$disallowed_file_extensions = explode(',','sh,ssh,so,dll,exe,bat,vbs,zip,rar,z,tar,tbz,tgz,gz');\n\t\t\t\tif (in_array($fax_file_extension, $disallowed_file_extensions) || $fax_file_extension == '') { continue; }\n\n\t\t\t\t//use a safe file name\n\t\t\t\t$fax_name = md5($_files['name'][$index]);\n\n\t\t\t\t//rename the file\n\t\t\t\t$attachment_file_name = $_files['name'][$index];\n\t\t\t\tif ($attachment_file_name != $fax_name.'.'.$fax_file_extension) {\n\t\t\t\t\trename($dir_fax_temp.'/'.$attachment_file_name, $dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension);\n\t\t\t\t}\n\t\t\t\tunset($attachment_file_name);\n\n\t\t\t\tif (!$included) {\n\t\t\t\t\t//check if directory exists\n\t\t\t\t\tif (!is_dir($dir_fax_temp)) {\n\t\t\t\t\t\tmkdir($dir_fax_temp, 0770);\n\t\t\t\t\t}\n\t\t\t\t\t//move uploaded file\n\t\t\t\t\tmove_uploaded_file($_files['tmp_name'][$index], $dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension);\n\t\t\t\t}\n\n\t\t\t\t//convert uploaded file to pdf, if necessary\n\t\t\t\tif ($fax_file_extension != \"pdf\" && $fax_file_extension != \"tif\") {\n\t\t\t\t\tchdir($dir_fax_temp);\n\t\t\t\t\t$command = $IS_WINDOWS ? '' : 'export HOME=/tmp && ';\n\t\t\t\t\t$command .= 'libreoffice --headless --convert-to pdf --outdir '.$dir_fax_temp.' '.$dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension;\n\t\t\t\t\texec($command);\n\t\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_name.'.'.$fax_file_extension);\n\t\t\t\t}\n\n\t\t\t\t//convert uploaded pdf to tif\n\t\t\t\tif (file_exists($dir_fax_temp.'/'.$fax_name.'.pdf')) {\n\t\t\t\t\tchdir($dir_fax_temp);\n\n\t\t\t\t\t//convert pdf to tif\n\t\t\t\t\t$cmd = gs_cmd(\"-q -r\".$gs_r.\" -g\".$gs_g.\" -dBATCH -dPDFFitPage -dNOSAFER -dNOPAUSE -dBATCH -sOutputFile=\".correct_path($fax_name).\".tif -sDEVICE=tiffg4 -Ilib stocht.ps -c \\\"{ .75 gt { 1 } { 0 } ifelse} settransfer\\\" -- \".correct_path($fax_name).\".pdf -c quit\");\n\t\t\t\t\t// echo($cmd . \"<br/>\\n\");\n\t\t\t\t\texec($cmd);\n\t\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_name.'.pdf');\n\t\t\t\t}\n\n\t\t\t\t$cmd = \"tiffinfo \".correct_path($dir_fax_temp.'/'.$fax_name).\".tif | grep \\\"Page Number\\\" | grep -c \\\"P\\\"\";\n\t\t\t\t// echo($cmd . \"<br/>\\n\");\n\t\t\t\t$tif_page_count = exec($cmd);\n\t\t\t\tif ($tif_page_count != '') {\n\t\t\t\t\t$fax_page_count += $tif_page_count;\n\t\t\t\t}\n\n\t\t\t\t//add file to array\n\t\t\t\t$tif_files[] = $dir_fax_temp.'/'.$fax_name.'.tif';\n\t\t\t} //if\n\t\t} //foreach\n\n\t\t// unique id for this fax\n\t\t$fax_instance_uuid = uuid();\n\n\t\t//generate cover page, merge with pdf\n\t\tif ($fax_subject != '' || $fax_message != '') {\n\n\t\t\t//load pdf libraries\n\t\t\trequire_once(\"resources/tcpdf/tcpdf.php\");\n\t\t\trequire_once(\"resources/fpdi/fpdi.php\");\n\n\t\t\t// initialize pdf\n\t\t\t$pdf = new FPDI('P', 'in');\n\t\t\t$pdf->SetAutoPageBreak(false);\n\t\t\t$pdf->setPrintHeader(false);\n\t\t\t$pdf->setPrintFooter(false);\n\t\t\t$pdf->SetMargins(0, 0, 0, true);\n\n\t\t\tif (strlen($fax_cover_font) > 0) {\n\t\t\t\tif (substr($fax_cover_font, -4) == '.ttf') {\n\t\t\t\t\t$pdf_font = TCPDF_FONTS::addTTFfont($fax_cover_font);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$pdf_font = $fax_cover_font;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!$pdf_font) {\n\t\t\t\t$pdf_font = 'times';\n\t\t\t}\n\n\t\t\t//add blank page\n\t\t\t$pdf->AddPage('P', array($page_width, $page_height));\n\n\t\t\t// content offset, if necessary\n\t\t\t$x = 0;\n\t\t\t$y = 0;\n\n\t\t\t//logo\n\t\t\t$display_logo = false;\n\t\t\tif (!is_array($_SESSION['fax']['cover_logo'])) {\n\t\t\t\t$logo = $_SERVER['DOCUMENT_ROOT'].PROJECT_PATH.\"/app/fax/resources/images/logo.jpg\";\n\t\t\t\t$display_logo = true;\n\t\t\t}\n\t\t\telse if (is_null($_SESSION['fax']['cover_logo']['text'])) {\n\t\t\t\t$logo = ''; //explicitly empty\n\t\t\t}\n\t\t\telse if ($_SESSION['fax']['cover_logo']['text'] != '') {\n\t\t\t\tif (substr($_SESSION['fax']['cover_logo']['text'], 0, 4) == 'http') {\n\t\t\t\t\t$logo = $_SESSION['fax']['cover_logo']['text'];\n\t\t\t\t}\n\t\t\t\telse if (substr($_SESSION['fax']['cover_logo']['text'], 0, 1) == '/') {\n\t\t\t\t\tif (substr($_SESSION['fax']['cover_logo']['text'], 0, strlen($_SERVER['DOCUMENT_ROOT'])) != $_SERVER['DOCUMENT_ROOT']) {\n\t\t\t\t\t\t$logo = $_SERVER['DOCUMENT_ROOT'].$_SESSION['fax']['cover_logo']['text'];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$logo = $_SESSION['fax']['cover_logo']['text'];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (isset($logo) && $logo) {\n\t\t\t\t$logo_dirname = strtolower(pathinfo($logo, PATHINFO_DIRNAME));\n\t\t\t\t$logo_filename = strtolower(pathinfo($logo, PATHINFO_BASENAME));\n\t\t\t\t$logo_fileext = pathinfo($logo_filename, PATHINFO_EXTENSION);\n\t\t\t\tif (in_array($logo_fileext, ['gif','jpg','jpeg','png','bmp'])) {\n\t\t\t\t\tif (file_exists($logo_dirname.'/'.$logo_filename)) {\n\t\t\t\t\t\t$logo = $logo_dirname.'/'.$logo_filename;\n\t\t\t\t\t\t$display_logo = true;\t\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$raw = file_get_contents($logo);\n\t\t\t\t\t\tif (file_put_contents($dir_fax_temp.'/'.$logo_filename, $raw)) {\n\t\t\t\t\t\t\t$logo = $dir_fax_temp.'/'.$logo_filename;\n\t\t\t\t\t\t\t$display_logo = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tunset($logo);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tunset($logo);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ($display_logo) {\n\t\t\t\t$pdf->Image($logo, 0.5, 0.4, 2.5, 0.9, null, null, 'N', true, 300, null, false, false, 0, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//set position for header text, if enabled\n\t\t\t\t$pdf->SetXY($x + 0.5, $y + 0.4);\n\t\t\t}\n\n\t\t\t//header\n\t\t\tif ($fax_header != '') {\n\t\t\t\t$pdf->SetLeftMargin(0.5);\n\t\t\t\t$pdf->SetFont($pdf_font, \"\", 10);\n\t\t\t\t$pdf->Write(0.3, $fax_header);\n\t\t\t}\n\n\t\t\t//fax, cover sheet\n\t\t\t$pdf->SetTextColor(0,0,0);\n\t\t\t$pdf->SetFont($pdf_font, \"B\", 55);\n\t\t\t$pdf->SetXY($x + 4.55, $y + 0.25);\n\t\t\t$pdf->Cell($x + 3.50, $y + 0.4, $text['label-fax-fax'], 0, 0, 'R', false, null, 0, false, 'T', 'T');\n\t\t\t$pdf->SetFont($pdf_font, \"\", 12);\n\t\t\t$pdf->SetFontSpacing(0.0425);\n\t\t\t$pdf->SetXY($x + 4.55, $y + 1.0);\n\t\t\t$pdf->Cell($x + 3.50, $y + 0.4, $text['label-fax-cover-sheet'], 0, 0, 'R', false, null, 0, false, 'T', 'T');\n\t\t\t$pdf->SetFontSpacing(0);\n\n\t\t\t//field labels\n\t\t\t$pdf->SetFont($pdf_font, \"B\", 12);\n\t\t\tif ($fax_recipient != '' || sizeof($fax_numbers) > 0) {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.0, strtoupper($text['label-fax-recipient']).\":\");\n\t\t\t}\n\t\t\tif ($fax_sender != '' || $fax_caller_id_number != '') {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.3, strtoupper($text['label-fax-sender']).\":\");\n\t\t\t}\n\t\t\tif ($fax_page_count > 0) {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.6, strtoupper($text['label-fax-attached']).\":\");\n\t\t\t}\n\t\t\tif ($fax_subject != '') {\n\t\t\t\t$pdf->Text($x + 0.5, $y + 2.9, strtoupper($text['label-fax-subject']).\":\");\n\t\t\t}\n\n\t\t\t//field values\n\t\t\t$pdf->SetFont($pdf_font, \"\", 12);\n\t\t\t$pdf->SetXY($x + 2.0, $y + 1.95);\n\t\t\tif ($fax_recipient != '') {\n\t\t\t\t$pdf->Write(0.3, $fax_recipient);\n\t\t\t}\n\t\t\tif (sizeof($fax_numbers) > 0) {\n\t\t\t\t$fax_number_string = ($fax_recipient != '') ? ' (' : null;\n\t\t\t\t$fax_number_string .= format_phone($fax_numbers[0]);\n\t\t\t\tif (sizeof($fax_numbers) > 1) {\n\t\t\t\t\tfor ($n = 1; $n <= sizeof($fax_numbers); $n++) {\n\t\t\t\t\t\tif ($n == 4) { break; }\n\t\t\t\t\t\t$fax_number_string .= ', '.format_phone($fax_numbers[$n]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t$fax_number_string .= (sizeof($fax_numbers) > 4) ? ', +'.(sizeof($fax_numbers) - 4) : null;\n\t\t\t\t$fax_number_string .= ($fax_recipient != '') ? ')' : null;\n\t\t\t\t$pdf->Write(0.3, $fax_number_string);\n\t\t\t}\n\t\t\t$pdf->SetXY($x + 2.0, $y + 2.25);\n\t\t\tif ($fax_sender != '') {\n\t\t\t\t$pdf->Write(0.3, $fax_sender);\n\t\t\t\tif ($fax_caller_id_number != '') {\n\t\t\t\t\t$pdf->Write(0.3, '  ('.format_phone($fax_caller_id_number).')');\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ($fax_caller_id_number != '') {\n\t\t\t\t\t$pdf->Write(0.3, format_phone($fax_caller_id_number));\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($fax_page_count > 0) {\n\t\t\t\t$pdf->Text($x + 2.0, $y + 2.6, $fax_page_count.' '.$text['label-fax-page'.(($fax_page_count > 1) ? 's' : null)]);\n\t\t\t}\n\t\t\tif ($fax_subject != '') {\n\t\t\t\t$pdf->Text($x + 2.0, $y + 2.9, $fax_subject);\n\t\t\t}\n\n\t\t\t//message\n\t\t\tif ($fax_message != '') {\n\t\t\t\t$pdf->SetAutoPageBreak(true, 0.6);\n\t\t\t\t$pdf->SetTopMargin(0.6);\n\t\t\t\t$pdf->SetFont($pdf_font, \"\", 12);\n\t\t\t\t$pdf->SetXY($x + 0.75, $y + 3.65);\n\t\t\t\t$pdf->MultiCell(7, 5.40, $fax_message, 0, 'L', false);\n\t\t\t}\n\n\t\t\t$pages = $pdf->getNumPages();\n\n\t\t\tif ($pages > 1) {\n\t\t\t\t# save ynew for last page\n\t\t\t\t$yn = $pdf->GetY();\n\n\t\t\t\t# First page\n\t\t\t\t$pdf->setPage(1, 0);\n\t\t\t\t$pdf->Rect($x + 0.5, $y + 3.4, 7.5, $page_height - 3.9, 'D');\n\n\t\t\t\t# 2nd to N-th page\n\t\t\t\tfor ($n = 2; $n < $pages; $n++) {\n\t\t\t\t\t$pdf->setPage($n, 0);\n\t\t\t\t\t$pdf->Rect($x + 0.5, $y + 0.5, 7.5, $page_height - 1, 'D');\n\t\t\t\t}\n\n\t\t\t\t#Last page\n\t\t\t\t$pdf->setPage($pages, 0);\n\t\t\t\t$pdf->Rect($x + 0.5, 0.5, 7.5, $yn, 'D');\n\t\t\t\t$y = $yn;\n\t\t\t\tunset($yn);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$pdf->Rect($x + 0.5, $y + 3.4, 7.5, 6.25, 'D');\n\t\t\t\t$y = $pdf->GetY();\n\t\t\t}\n\n\t\t\t//footer\n\t\t\tif ($fax_footer != '') {\n\t\t\t\t$pdf->SetAutoPageBreak(true, 0.6);\n\t\t\t\t$pdf->SetTopMargin(0.6);\n\t\t\t\t$pdf->SetFont(\"helvetica\", \"\", 8);\n\t\t\t\t$pdf->SetXY($x + 0.5, $y + 0.6);\n\t\t\t\t$pdf->MultiCell(7.5, 0.75, $fax_footer, 0, 'C', false);\n\t\t\t}\n\t\t\t$pdf->SetAutoPageBreak(false);\n\t\t\t$pdf->SetTopMargin(0);\n\n\t\t\t// save cover pdf\n\t\t\t$pdf->Output($dir_fax_temp.'/'.$fax_instance_uuid.'_cover.pdf', \"F\");\t// Display [I]nline, Save to [F]ile, [D]ownload\n\n\t\t\t//convert pdf to tif, add to array of pages, delete pdf\n\t\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.'_cover.pdf')) {\n\t\t\t\tchdir($dir_fax_temp);\n\n\t\t\t\t$cmd = gs_cmd(\"-q -sDEVICE=tiffg32d -r\".$gs_r.\" -g\".$gs_g.\" -dBATCH -dPDFFitPage -dNOSAFER -dNOPAUSE -sOutputFile=\".correct_path($fax_instance_uuid).\"_cover.tif -- \".correct_path($fax_instance_uuid).\"_cover.pdf -c quit\");\n\t\t\t\t// echo($cmd . \"<br/>\\n\");\n\t\t\t\texec($cmd);\n\t\t\t\tif (is_array($tif_files) && sizeof($tif_files) > 0) {\n\t\t\t\t\tarray_unshift($tif_files, $dir_fax_temp.'/'.$fax_instance_uuid.'_cover.tif');\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$tif_files[] = $dir_fax_temp.'/'.$fax_instance_uuid.'_cover.tif';\n\t\t\t\t}\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.'_cover.pdf');\n\t\t\t}\n\t\t}\n\n\t\t//combine tif files into single multi-page tif\n\t\tif (is_array($tif_files) && sizeof($tif_files) > 0) {\n\t\t\t$cmd = \"tiffcp -c none \";\n\t\t\tforeach ($tif_files as $tif_file) {\n\t\t\t\t$cmd .= correct_path($tif_file) . ' ';\n\t\t\t}\n\t\t\t$cmd .= correct_path($dir_fax_temp.'/'.$fax_instance_uuid.'.tif');\n\t\t\t//echo($cmd . \"<br/>\\n\");\n\t\t\texec($cmd);\n\n\t\t\tforeach ($tif_files as $tif_file) {\n\t\t\t\t@unlink($tif_file);\n\t\t\t}\n\n\t\t\t//generate pdf from tif\n\t\t\t$cmd = 'tiff2pdf -u i -p '.$fax_page_size.\n\t\t\t\t' -w '.$page_width.\n\t\t\t\t' -l '.$page_height.\n\t\t\t\t' -f -o '.\n\t\t\t\tcorrect_path($dir_fax_temp.'/'.$fax_instance_uuid.'.pdf').' '.\n\t\t\t\tcorrect_path($dir_fax_temp.'/'.$fax_instance_uuid.'.tif');\n\t\t\texec($cmd);\n\t\t}\n\t\telse {\n\t\t\tif (!$included) {\n\t\t\t\t//nothing to send, redirect the browser\n\t\t\t\tmessage::add($text['message-invalid-fax'], 'negative', 4000);\n\t\t\t\theader(\"Location: fax_send.php?id=\".$fax_uuid);\n\t\t\t\texit;\n\t\t\t}\n\t\t}\n\n\t\t//preview, if requested\n\t\tif (($_REQUEST['submit'] != '') && ($_REQUEST['submit'] == 'preview')) {\n\t\t\tunset($file_type);\n\t\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.'.pdf')) {\n\t\t\t\t$file_type = 'pdf';\n\t\t\t\t$content_type = 'application/pdf';\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.\".tif\");\n\t\t\t}\n\t\t\telse if (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.'.tif')) {\n\t\t\t\t$file_type = 'tif';\n\t\t\t\t$content_type = 'image/tiff';\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.\".pdf\");\n\t\t\t}\n\t\t\tif ($file_type != '') {\n\t\t\t\t//push download\n\t\t\t\t$fd = fopen($dir_fax_temp.'/'.$fax_instance_uuid.'.'.$file_type, \"rb\");\n\t\t\t\theader(\"Content-Type: application/force-download\");\n\t\t\t\theader(\"Content-Type: application/octet-stream\");\n\t\t\t\theader(\"Content-Type: application/download\");\n\t\t\t\theader(\"Content-Description: File Transfer\");\n\t\t\t\theader('Content-Disposition: attachment; filename=\"'.$fax_instance_uuid.'.'.$file_type.'\"');\n\t\t\t\theader(\"Content-Type: \".$content_type);\n\t\t\t\theader('Accept-Ranges: bytes');\n\t\t\t\theader(\"Cache-Control: no-cache, must-revalidate\"); // HTTP/1.1\n\t\t\t\theader(\"Expires: Sat, 26 Jul 1997 05:00:00 GMT\"); // date in the past\n\t\t\t\theader(\"Content-Length: \".filesize($dir_fax_temp.'/'.$fax_instance_uuid.'.'.$file_type));\n\t\t\t\tfpassthru($fd);\n\t\t\t\t@unlink($dir_fax_temp.'/'.$fax_instance_uuid.\".\".$file_type);\n\t\t\t}\n\t\t\texit;\n\t\t}\n\n\t\t//get some more info to send the fax\n\t\t$mailfrom_address = (isset($_SESSION['fax']['smtp_from']['text'])) ? $_SESSION['fax']['smtp_from']['text'] : $_SESSION['email']['smtp_from']['text'];\n\n\t\t$sql = \"select * from v_fax where fax_uuid = :fax_uuid \";\n\t\t$parameters['fax_uuid'] = $fax_uuid;\n\t\t$database = new database;\n\t\t$row = $database->select($sql, $parameters, 'row');\n\t\t$mailto_address_fax = $row[\"fax_email\"];\n\t\t$fax_prefix = $row[\"fax_prefix\"];\n\t\tunset($sql, $parameters, $row);\n\n\t\tif (!$included) {\n\t\t\t$sql = \"select user_email from v_users where user_uuid = :user_uuid \";\n\t\t\t$parameters['user_uuid'] = $_SESSION['user_uuid'];\n\t\t\t$database = new database;\n\t\t\t$mailto_address_user = $database->select($sql, $parameters, 'column');\n\t\t\tunset($sql, $parameters);\n\t\t}\n\t\telse {\n\t\t\t//use email-to-fax from address\n\t\t}\n\n\t\tif ($mailto_address_fax != '' && $mailto_address_user != $mailto_address_fax) {\n\t\t\t$mailto_address = $mailto_address_fax.\",\".$mailto_address_user;\n\t\t}\n\t\telse {\n\t\t\t$mailto_address = $mailto_address_user;\n\t\t}\n\n\t\t//send the fax\n\t\t$fax_file = $dir_fax_temp.\"/\".$fax_instance_uuid.\".tif\";\n\t\t$tmp_dial_string  = \"for_fax=1,\";\n\t\t$tmp_dial_string .= \"accountcode='\"                  . $fax_accountcode         . \"',\";\n\t\t$tmp_dial_string .= \"sip_h_X-accountcode='\"          . $fax_accountcode         . \"',\";\n\t\t$tmp_dial_string .= \"domain_uuid=\"                   . $_SESSION[\"domain_uuid\"] . \",\";\n\t\t$tmp_dial_string .= \"domain_name=\"                   . $_SESSION[\"domain_name\"] . \",\";\n\t\t$tmp_dial_string .= \"origination_caller_id_name='\"   . $fax_caller_id_name      . \"',\";\n\t\t$tmp_dial_string .= \"origination_caller_id_number='\" . $fax_caller_id_number    . \"',\";\n\t\t$tmp_dial_string .= \"fax_ident='\"                    . $fax_caller_id_number    . \"',\";\n\t\t$tmp_dial_string .= \"fax_header='\"                   . $fax_caller_id_name      . \"',\";\n\t\t$tmp_dial_string .= \"fax_file='\"                     . $fax_file                . \"',\";\n\t\tforeach ($fax_numbers as $fax_number) {\n\n\t\t\t$fax_number = trim($fax_number);\n\t\t\tfax_split_dtmf($fax_number, $fax_dtmf);\n\n\t\t\t//prepare the fax command\n\t\t\tif (strlen($fax_toll_allow) > 0) {\n\t\t\t\t$channel_variables[\"toll_allow\"] = $fax_toll_allow;\n\t\t\t}\n\t\t\t$route_array = outbound_route_to_bridge($_SESSION['domain_uuid'], $fax_prefix . $fax_number, $channel_variables);\n\t\t\tif (count($route_array) == 0) {\n\t\t\t\t//send the internal call to the registered extension\n\t\t\t\t$fax_uri = \"user/\".$fax_number.\"@\".$_SESSION['domain_name'];\n\t\t\t\t$fax_variables = \"\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\t//send the external call\n\t\t\t\t$fax_uri = $route_array[0];\n\t\t\t\t$fax_variables = \"\";\n\t\t\t\tforeach($_SESSION['fax']['variable'] as $variable) {\n\t\t\t\t\t$fax_variables .= $variable.\",\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ($fax_send_mode != 'queue') {\n\t\t\t\t$dial_string = $tmp_dial_string;\n\t\t\t\t$dial_string .= $fax_variables;\n\t\t\t\t$dial_string .= \"mailto_address='\"     . $mailto_address   . \"',\";\n\t\t\t\t$dial_string .= \"mailfrom_address='\"   . $mailfrom_address . \"',\";\n\t\t\t\t$dial_string .= \"fax_uri=\" . $fax_uri  . \",\";\n\t\t\t\t$dial_string .= \"fax_retry_attempts=1\" . \",\";\n\t\t\t\t$dial_string .= \"fax_retry_limit=20\"   . \",\";\n\t\t\t\t$dial_string .= \"fax_retry_sleep=180\"  . \",\";\n\t\t\t\t$dial_string .= \"fax_verbose=true\"     . \",\";\n\t\t\t\t$dial_string .= \"fax_use_ecm=off\"      . \",\";\n\t\t\t\t$dial_string .= \"api_hangup_hook='lua fax_retry.lua'\";\n\t\t\t\t$dial_string  = \"{\" . $dial_string . \"}\" . $fax_uri.\" &txfax('\".$fax_file.\"')\";\n\n\t\t\t\t$fp = event_socket_create($_SESSION['event_socket_ip_address'], $_SESSION['event_socket_port'], $_SESSION['event_socket_password']);\n\t\t\t\tif ($fp) {\n\t\t\t\t\t$cmd = \"api originate \" . $dial_string;\n\t\t\t\t\t//send the command to event socket\n\t\t\t\t\t$response = event_socket_request($fp, $cmd);\n\t\t\t\t\t$response = str_replace(\"\\n\", \"\", $response);\n\t\t\t\t\t$uuid = str_replace(\"+OK \", \"\", $response);\n\t\t\t\t}\n\t\t\t\tfclose($fp);\n\t\t\t}\n\t\t\telse { // enqueue\n\t\t\t\t$wav_file = ''; //! @todo add custom message\n\t\t\t\t$dial_string = $tmp_dial_string;\n\t\t\t\t$response = fax_enqueue($fax_uuid, $fax_file, $wav_file, $mailto_address, $fax_uri, $fax_dtmf, $dial_string);\n\t\t\t}\n\t\t}\n\n\t\t//wait for a few seconds\n\t\tsleep(5);\n\n\t\t//move the generated tif (and pdf) files to the sent directory\n\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.\".tif\")) {\n\t\t\tcopy($dir_fax_temp.'/'.$fax_instance_uuid.\".tif\", $dir_fax_sent.'/'.$fax_instance_uuid.\".tif\");\n\t\t}\n\n\t\tif (file_exists($dir_fax_temp.'/'.$fax_instance_uuid.\".pdf\")) {\n\t\t\tcopy($dir_fax_temp.'/'.$fax_instance_uuid.\".pdf \", $dir_fax_sent.'/'.$fax_instance_uuid.\".pdf\");\n\t\t}\n\n\t\tif (!$included && is_uuid($fax_uuid)) {\n\t\t\t//redirect the browser\n\t\t\tmessage::add($response, 'default');\n\t\t\tif (isset($_SESSION['fax']['send_mode']['text']) && $_SESSION['fax']['send_mode']['text'] == 'queue') {\n\t\t\t\theader(\"Location: fax_active.php?id=\".$fax_uuid);\n\t\t\t}\n\t\t\telse {\n\t\t\t\theader(\"Location: fax_files.php?id=\".$fax_uuid.\"&box=sent\");\n\t\t\t}\n\t\t\texit;\n\t\t}\n\n\t} //end upload and send fax\n\n\nif (!$included) {\n\n\t//create token\n\t\t$object = new token;\n\t\t$token = $object->create($_SERVER['PHP_SELF']);\n\n\t//show the header\n\t\t$document['title'] = $text['title-new_fax'];\n\t\trequire_once \"resources/header.php\";\n\n\t//javascript to toggle input/select boxes, add fax numbers\n\t\techo \"<script language='JavaScript' type='text/javascript' src='\".PROJECT_PATH.\"/resources/javascript/reset_file_input.js'></script>\\n\";\n\t\techo \"<script language='JavaScript' type='text/javascript'>\";\n\n\t\techo \"\tfunction toggle(field) {\";\n\t\techo \"\t\tif (field == 'fax_recipient') {\";\n\t\techo \"\t\t\tdocument.getElementById('fax_recipient_select').selectedIndex = 0;\";\n\t\techo \"\t\t\t$('#fax_recipient_select').toggle();\";\n\t\techo \"\t\t\t$('#fax_recipient').toggle();\";\n\t\techo \"\t\t\tif ($('#fax_recipient').is(':visible')) { $('#fax_recipient').trigger('focus'); } else { $('#fax_recipient_select').trigger('focus'); }\";\n\t\techo \"\t\t}\";\n\t\techo \"\t}\";\n\n\t\techo \"\tfunction contact_load(obj_sel) {\";\n\t\techo \"\t\tobj_sel.style.display='none';\";\n\t\techo \"\t\tdocument.getElementById('fax_recipient').style.display='';\";\n\t\techo \"\t\tvar selected_option_value = obj_sel.options[obj_sel.selectedIndex].value;\";\n\t\techo \"\t\tvar selected_option_values = selected_option_value.split('|', 2);\";\n\t\techo \"\t\tdocument.getElementById('fax_recipient').value = selected_option_values[1];\";\n\t\techo \"\t\tdocument.getElementById('fax_number').value = selected_option_values[0];\";\n\t\techo \"\t\t$('#fax_recipient').css({width: '50%'});\";\n\t\techo \"\t\t$('#fax_number').css({width: '120px'});\";\n\t\techo \"\t}\";\n\n\t\techo \"\tfunction list_selected_files(file_input_number) {\";\n\t\techo \"\t\tvar inp = document.getElementById('fax_files_'+file_input_number);\";\n\t\techo \"\t\tvar files_selected = [];\";\n\t\techo \"\t\tfor (var i = 0; i < inp.files.length; ++i) {\";\n\t\techo \"\t\t\tvar file_name = inp.files.item(i).name;\";\n\t\techo \"\t\t\tfiles_selected.push(file_name);\";\n\t\techo \"\t\t}\";\n\t\techo \"\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML = '';\";\n\t\techo \"\t\tif (files_selected.length > 1) {\";\n\t\techo \"\t\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML = '<strong>\".$text['label-selected'].\"</strong>: ';\";\n\t\techo \"\t\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML += files_selected.join(', ');\";\n\t\techo \"\t\t\tdocument.getElementById('file_list_'+file_input_number).innerHTML += '<br />';\";\n\t\techo \"\t\t}\";\n\t\techo \"\t}\";\n\n\t\techo \"\tfunction add_fax_number() {\\n\";\n\t\techo \"\t\tvar newdiv = document.createElement('div');\\n\";\n\t\techo \"\t\tnewdiv.innerHTML = \\\"<input type='text' name='fax_numbers[]' class='formfld' style='width: 150px; min-width: 150px; max-width: 150px; margin-top: 3px;' maxlength='25'>\\\";\";\n\t\techo \"\t\tdocument.getElementById('fax_numbers').appendChild(newdiv);\";\n\t\techo \"\t}\\n\";\n\n\t\techo \"</script>\";\n\n\t//show the content\n\t\techo \"<form method='post' name='frm' id='frm' enctype='multipart/form-data'>\\n\";\n\n\t\techo \"<div class='action_bar' id='action_bar'>\\n\";\n\t\techo \"\t<div class='heading'><b>\".$text['header-new_fax'].\"</b></div>\\n\";\n\t\techo \"\t<div class='actions'>\\n\";\n\t\techo button::create(['type'=>'button','label'=>$text['button-back'],'icon'=>$_SESSION['theme']['button_icon_back'],'id'=>'btn_back','style'=>'margin-right: 15px;','link'=>'fax.php']);\n\t\techo button::create(['type'=>'submit','label'=>$text['button-preview'],'icon'=>'eye','name'=>'submit','value'=>'preview']);\n\t\techo button::create(['type'=>'submit','label'=>$text['button-send'],'icon'=>'paper-plane','id'=>'btn_save','name'=>'submit','value'=>'send','style'=>'margin-left: 15px;']);\n\t\techo \"\t</div>\\n\";\n\t\techo \"\t<div style='clear: both;'></div>\\n\";\n\t\techo \"</div>\\n\";\n\t\techo $text['description-2'].\" \".(permission_exists('fax_extension_view_domain') ? $text['description-3'] : null).\"\\n\";\n\t\techo \"<br /><br />\\n\";\n\n\t\techo \"<table width='100%' border='0' cellspacing='0' cellpadding='0'>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax-header'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input type='text' name='fax_header' class='formfld' style='' value='\".$_SESSION['fax']['cover_header']['text'].\"'>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-header'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax-sender'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<input type='text' name='fax_sender' class='formfld' style='' value='\".escape($fax_caller_id_name).\"'>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-sender'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax-recipient'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t//retrieve current user's assigned groups (uuids)\n\t\tforeach ($_SESSION['groups'] as $group_data) {\n\t\t\t$user_group_uuids[] = $group_data['group_uuid'];\n\t\t}\n\t\t//add user's uuid to group uuid list to include private (non-shared) contacts\n\t\t$user_group_uuids[] = $_SESSION[\"user_uuid\"];\n\t\t$sql = \"select \";\n\t\t$sql .= \"c.contact_organization, \";\n\t\t$sql .= \"c.contact_name_given, \";\n\t\t$sql .= \"c.contact_name_family, \";\n\t\t$sql .= \"c.contact_nickname, \";\n\t\t$sql .= \"cp.phone_number \";\n\t\t$sql .= \"from \";\n\t\t$sql .= \"v_contacts as c, \";\n\t\t$sql .= \"v_contact_phones as cp \";\n\t\t$sql .= \"where \";\n\t\t$sql .= \"c.contact_uuid = cp.contact_uuid \";\n\t\t$sql .= \"and c.domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and cp.domain_uuid = :domain_uuid \";\n\t\t$sql .= \"and cp.phone_type_fax = 1 \";\n\t\t$sql .= \"and cp.phone_number is not null \";\n\t\t$sql .= \"and cp.phone_number <> '' \";\n\t\tif (is_array($user_group_uuids) && @sizeof($user_group_uuids) != 0) {\n\t\t\t//only show contacts assigned to current user's group(s) and those not assigned to any group\n\t\t\t$sql .= \"and (\";\n\t\t\t$sql .= \"\tc.contact_uuid in ( \";\n\t\t\t$sql .= \"\t\tselect contact_uuid from v_contact_groups \";\n\t\t\t$sql .= \"\t\twhere (\";\n\t\t\tforeach ($user_group_uuids as $index => $user_group_uuid) {\n\t\t\t\t$sql .= $or;\n\t\t\t\t$sql .= \"\t\tgroup_uuid = :group_uuid_\".$index.\" \";\n\t\t\t\t$parameters['group_uuid_'.$index] = $user_group_uuid;\n\t\t\t\t$or = \" or \";\n\t\t\t}\n\t\t\tunset($user_group_uuids, $index, $user_group_uuid, $or);\n\t\t\t$sql .= \"\t\t) \";\n\t\t\t$sql .= \"\t\tand domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"\t) \";\n\t\t\t$sql .= \"\tor \";\n\t\t\t$sql .= \"\tc.contact_uuid not in ( \";\n\t\t\t$sql .= \"\t\tselect contact_uuid from v_contact_groups \";\n\t\t\t$sql .= \"\t\twhere domain_uuid = :domain_uuid \";\n\t\t\t$sql .= \"\t) \";\n\t\t\t$sql .= \") \";\n\t\t}\n\t\t$parameters['domain_uuid'] = $_SESSION['domain_uuid'];\n\t\t$database = new database;\n\t\t$contacts = $database->select($sql, $parameters, 'all');\n\t\tif (is_array($contacts) && @sizeof($contacts) != 0) {\n\t\t\tforeach ($contacts as &$row) {\n\t\t\t\tif ($row['contact_organization'] != '') {\n\t\t\t\t\t$contact_option_label = $row['contact_organization'];\n\t\t\t\t}\n\t\t\t\tif ($row['contact_name_given'] != '' || $row['contact_name_family'] != '' || $row['contact_nickname'] != '') {\n\t\t\t\t\t$contact_option_label .= ($row['contact_organization'] != '') ? \",\" : null;\n\t\t\t\t\t$contact_option_label .= ($row['contact_name_given'] != '') ? (($row['contact_organization'] != '') ? \" \" : null).$row['contact_name_given'] : null;\n\t\t\t\t\t$contact_option_label .= ($row['contact_name_family'] != '') ? (($row['contact_organization'] != '' || $row['contact_name_given'] != '') ? \" \" : null).$row['contact_name_family'] : null;\n\t\t\t\t\t$contact_option_label .= ($row['contact_nickname'] != '') ? (($row['contact_organization'] != '' || $row['contact_name_given'] != '' || $row['contact_name_family'] != '') ? \" (\".$row['contact_nickname'].\")\" : $row['contact_nickname']) : null;\n\t\t\t\t}\n\t\t\t\t$contact_option_value_recipient = $contact_option_label;\n\t\t\t\t$contact_option_value_faxnumber = $row['phone_number'];\n\t\t\t\t$contact_option_label .= \":&nbsp;&nbsp;\".escape(format_phone($row['phone_number']));\n\t\t\t\t$contact_labels[] = $contact_option_label;\n\t\t\t\t$contact_values[] = $contact_option_value_faxnumber.\"|\".$contact_option_value_recipient;\n\t\t\t\tunset($contact_option_label);\n\t\t\t}\n\t\t\tif (is_array($contact_labels)) {\n\t\t\t\tasort($contact_labels, SORT_NATURAL); // sort by name(s)\n\t\t\t}\n\t\t\techo \"\t<select class='formfld' style='display: none;' id='fax_recipient_select' onchange='contact_load(this);'>\\n\";\n\t\t\techo \"\t\t<option value=''></option>\\n\";\n\t\t\tforeach ($contact_labels as $index => $contact_label) {\n\t\t\t\techo \"\t<option value=\\\"\".escape($contact_values[$index]).\"\\\">\".$contact_label.\"</option>\\n\";\n\t\t\t}\n\t\t\techo \"\t</select>\\n\";\n\t\t}\n\t\tunset($sql, $parameters, $row);\n\t\techo \"\t<input type='text' name='fax_recipient' id='fax_recipient' class='formfld' style='max-width: 250px;' value=''>\\n\";\n\t\tif (is_array($contacts)) {\n\t\t\techo \"\t<input type='button' id='btn_toggle_recipient' class='btn' name='' alt='\".$text['button-back'].\"' value='&#9665;' onclick=\\\"toggle('fax_recipient');\\\">\\n\";\n\t\t}\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-recipient'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncellreq' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\t\".$text['label-fax-number'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<table cellpadding='0' cellspacing='0' border='0'>\";\n\t\techo \"\t\t<tr>\";\n\t\techo \"\t\t\t<td id='fax_numbers'>\";\n\t\techo \"\t\t\t\t<input type='text' name='fax_numbers[]' id='fax_number' class='formfld' style='width: 150px; min-width: 150px; max-width: 150px;' maxlength='25'>\\n\";\n\t\techo \"\t\t\t</td>\";\n\t\techo \"\t\t\t<td style='vertical-align: bottom;'>\";\n\t\techo \"\t\t\t\t<a href='javascript:void(0);' onclick='add_fax_number();'>$v_link_label_add</a>\";\n\t\techo \"\t\t\t</td>\";\n\t\techo \"\t\t</tr>\";\n\t\techo \"\t</table>\";\n\t\techo \"\t\".$text['description-fax-number'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\".$text['label-fax_files'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\tfor ($f = 1; $f <= 3; $f++) {\n\t\t\techo \"\t<span id='fax_file_\".$f.\"' \".(($f > 1) ? \"style='display: none;'\" : null).\">\";\n\t\t\techo \"\t<input name='fax_files[]' id='fax_files_\".$f.\"' type='file' class='formfld fileinput' style='margin-right: 3px; \".(($f > 1) ? \"margin-top: 3px;\" : null).\"' onchange=\\\"\".(($f < 3) ? \"document.getElementById('fax_file_\".($f+1).\"').style.display='';\" : null).\" list_selected_files(\".$f.\");\\\" multiple='multiple'>\";\n\t\t\techo button::create(['type'=>'button','label'=>$text['button-clear'],'icon'=>$_SESSION['theme']['button_icon_reset'],'onclick'=>\"reset_file_input('fax_files_\".$f.\"'); document.getElementById('file_list_\".$f.\"').innerHTML='';\"]);\n\t\t\techo \t\"<br />\";\n\t\t\techo \"\t<span id='file_list_\".$f.\"'></span>\";\n\t\t\techo \"\t</span>\\n\";\n\t\t}\n\t\techo \"\t\".$text['description-fax_files'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\t\".$text['label-fax-resolution'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<select name='fax_resolution' class='formfld'>\\n\";\n\t\techo \"\t\t<option value='normal' \".(($_SESSION['fax']['resolution']['text'] == 'normal') ? 'selected' : null).\">\".$text['option-fax-resolution-normal'].\"</option>\\n\";\n\t\techo \"\t\t<option value='fine' \".(($_SESSION['fax']['resolution']['text'] == 'fine') ? 'selected' : null).\">\".$text['option-fax-resolution-fine'].\"</option>\\n\";\n\t\techo \"\t\t<option value='superfine' \".(($_SESSION['fax']['resolution']['text'] == 'superfine') ? 'selected' : null).\">\".$text['option-fax-resolution-superfine'].\"</option>\\n\";\n\t\techo \"\t</select>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-resolution'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\techo \"<tr>\\n\";\n\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\techo \"\t\t\".$text['label-fax-page-size'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\techo \"\t<select name='fax_page_size' class='formfld'>\\n\";\n\t\techo \"\t\t<option value='letter' \".(($_SESSION['fax']['page_size']['text'] == 'letter') ? 'selected' : null).\">Letter</option>\\n\";\n\t\techo \"\t\t<option value='legal' \".(($_SESSION['fax']['page_size']['text'] == 'legal') ? 'selected' : null).\">Legal</option>\\n\";\n\t\techo \"\t\t<option value='a4' \".(($_SESSION['fax']['page_size']['text'] == 'a4') ? 'selected' : null).\">A4</option>\\n\";\n\t\techo \"\t</select>\\n\";\n\t\techo \"\t<br />\\n\";\n\t\techo \"\t\".$text['description-fax-page-size'].\"\\n\";\n\t\techo \"</td>\\n\";\n\t\techo \"</tr>\\n\";\n\n\t\tif (permission_exists('fax_subject')) {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"\t\".$text['label-fax-subject'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"\t<input type='text' name='fax_subject' class='formfld' style='' value=''>\\n\";\n\t\t\techo \"\t<br />\\n\";\n\t\t\techo \"\t\".$text['description-fax-subject'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\tif (permission_exists('fax_message')) {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"\t\t\".$text['label-fax-message'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"\t<textarea type='text' name='fax_message' class='formfld' style='width: 65%; height: 175px;'></textarea>\\n\";\n\t\t\techo \"<br />\\n\";\n\t\t\techo \"\t\".$text['description-fax-message'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\tif (permission_exists('fax_footer')) {\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td class='vncell' valign='top' align='left' nowrap>\\n\";\n\t\t\techo \"\t\".$text['label-fax-footer'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"<td class='vtable' align='left'>\\n\";\n\t\t\techo \"\t<textarea type='text' name='fax_footer' class='formfld' style='width: 65%; height: 100px;'>\".$_SESSION['fax']['cover_footer']['text'].\"</textarea>\\n\";\n\t\t\techo \"\t<br />\\n\";\n\t\t\techo \"\t\".$text['description-fax-footer'].\"\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\n\t\techo \"</table>\";\n\t\techo \"<br /><br />\\n\";\n\n\t\techo \"<input type='hidden' name='fax_caller_id_name' value='\".escape($fax_caller_id_name).\"'>\\n\";\n\t\techo \"<input type='hidden' name='fax_caller_id_number' value='\".escape($fax_caller_id_number).\"'>\\n\";\n\t\techo \"<input type='hidden' name='fax_extension' value='\".escape($fax_extension).\"'>\\n\";\n\t\techo \"<input type='hidden' name='id' value='\".escape($fax_uuid).\"'>\\n\";\n\t\techo \"<input type='hidden' name='action' value='send'>\\n\";\n\t\techo \"<input type='hidden' name='\".$token['name'].\"' value='\".$token['hash'].\"'>\\n\";\n\n\t\techo \"</form>\\n\";\n\n\t//show the footer\n\t\trequire_once \"resources/footer.php\";\n\n}\n\n// used for initial element alignment during pdf generation\n/*\nfunction showgrid($pdf) {\n\t// generate a grid for placement\n\tfor ($x=0; $x<=8.5; $x+=0.1) {\n\t\tfor ($y=0; $y<=11; $y+=0.1) {\n\t\t\t$pdf->SetTextColor(0,0,0);\n\t\t\t$pdf->SetFont(\"courier\", \"\", 3);\n\t\t\t$pdf->Text($x-0.01,$y-0.01,\".\");\n\t\t}\n\t}\n\tfor ($x=0; $x<=9; $x+=1) {\n\t\tfor ($y=0; $y<=11; $y+=1) {\n\t\t\t$pdf->SetTextColor(255,0,0);\n\t\t\t$pdf->SetFont(\"times\", \"\", 10);\n\t\t\t$pdf->Text($x-.02,$y-.01,\".\");\n\t\t\t$pdf->SetFont(\"courier\", \"\", 4);\n\t\t\t$pdf->Text($x+0.01,$y+0.035,$x.\",\".$y);\n\t\t}\n\t}\n}\n*/\n\n?>\n"], "filenames": ["app/fax/fax_send.php"], "buggy_code_start_loc": [354], "buggy_code_end_loc": [386], "fixing_code_start_loc": [354], "fixing_code_end_loc": [368], "type": "CWE-20", "message": "An issue was discovered in FusionPBX before 4.5.30. The FAX file name may have risky characters.", "other": {"cve": {"id": "CVE-2021-43404", "sourceIdentifier": "cve@mitre.org", "published": "2021-11-05T18:15:09.503", "lastModified": "2021-11-09T18:47:29.147", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "An issue was discovered in FusionPBX before 4.5.30. The FAX file name may have risky characters."}, {"lang": "es", "value": "Se ha detectado un problema en FusionPBX versiones anteriores a 4.5.30. El nombre del archivo FAX puede tener caracteres de riesgo"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 8.8, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.8, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-20"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:fusionpbx:fusionpbx:*:*:*:*:*:*:*:*", "versionEndExcluding": "4.5.30", "matchCriteriaId": "9CEEA006-B747-44B0-9032-5F3CBE23C699"}]}]}], "references": [{"url": "https://github.com/fusionpbx/fusionpbx/commit/487afc371e5c0dfbbc07cd002333c5bcd949d0f4", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/fusionpbx/fusionpbx/commit/487afc371e5c0dfbbc07cd002333c5bcd949d0f4"}}