{"buggy_code": ["<div style=\"width:100%;\">\n    <?php\n        echo $this->Session->flash('auth');\n    ?>\n<table style=\"margin-left:auto;margin-right:auto;\">\n    <tr>\n    <td style=\"text-align:right;width:250px;padding-right:50px\">\n        <?php if (Configure::read('MISP.welcome_logo')) echo $this->Html->image('custom/' . h(Configure::read('MISP.welcome_logo')), array('alt' => __('Logo'), 'onerror' => \"this.style.display='none';\")); ?>\n    </td>\n    <td style=\"width:460px\">\n        <span style=\"font-size:18px;\">\n            <?php\n                if (Configure::read('MISP.welcome_text_top')) {\n                    echo h(Configure::read('MISP.welcome_text_top'));\n                }\n            ?>\n        </span><br /><br />\n        <div>\n        <?php if (Configure::read('MISP.main_logo') && file_exists(APP . '/webroot/img/custom/' . Configure::read('MISP.main_logo'))): ?>\n            <img src=\"<?php echo $baseurl?>/img/custom/<?php echo h(Configure::read('MISP.main_logo'));?>\" style=\" display:block; margin-left: auto; margin-right: auto;\" />\n        <?php else: ?>\n            <img src=\"<?php echo $baseurl?>/img/misp-logo-s-u.png\" style=\"display:block; margin-left: auto; margin-right: auto;\"/>\n        <?php endif;?>\n        </div>\n        <?php\n            if (true == Configure::read('MISP.welcome_text_bottom')):\n        ?>\n                <div style=\"text-align:right;font-size:18px;\">\n                <?php\n                    echo h(Configure::read('MISP.welcome_text_bottom'));\n                ?>\n                </div>\n        <?php\n            endif;\n            if ($formLoginEnabled):\n            echo $this->Form->create('User');\n        ?>\n        <legend><?php echo __('Login');?></legend>\n        <?php\n            echo $this->Form->input('email', array('autocomplete' => 'off', 'autofocus'));\n            echo $this->Form->input('password', array('autocomplete' => 'off'));\n            if (!empty(Configure::read('LinOTPAuth')) && Configure::read('LinOTPAuth.enabled')!== FALSE) {\n                echo $this->Form->input('otp', array('autocomplete' => 'off', 'type' => 'password', 'label' => 'OTP'));\n                echo \"<div class=\\\"clear\\\">\";\n                echo sprintf(\n                    '%s <a href=\"%s/selfservice\" title=\"LinOTP Selfservice\">LinOTP Selfservice</a> %s',\n                    __('Visit'),\n                    Configure::read('LinOTPAuth.baseUrl'),\n                    __('for the One-Time-Password selfservice.')\n                );\n            }\n        ?>\n            <div class=\"clear\">\n            <?php\n                echo empty(Configure::read('Security.allow_self_registration')) ? '' : sprintf(\n                    '<a href=\"%s/users/register\" title=\"%s\">%s</a>',\n                    $baseurl,\n                    __('Registration will be sent to the administrators of the instance for consideration.'),\n                    __('No account yet? Register now!')\n                );\n            ?>\n            </div>\n            <?= $this->Form->button(__('Login'), array('class' => 'btn btn-primary')); ?>\n        <?php\n            echo $this->Form->end();\n            endif;\n            if (Configure::read('ApacheShibbAuth') == true) {\n                echo '<div class=\"clear\"></div><a class=\"btn btn-info\" href=\"/Shibboleth.sso/Login\">Login with SAML</a>';\n            }\n            if (Configure::read('AadAuth') == true) {\n                echo '<div class=\"clear\"></div><a class=\"btn btn-info\" href=\"/users/login?AzureAD=enable\">Login with AzureAD</a>';\n            }\n        ?>\n    </td>\n    <td style=\"width:250px;padding-left:50px\">\n        <?php if (Configure::read('MISP.welcome_logo2')) echo $this->Html->image('custom/' . h(Configure::read('MISP.welcome_logo2')), array('alt' => 'Logo2', 'onerror' => \"this.style.display='none';\")); ?>\n    </td>\n    </tr>\n    </table>\n</div>\n\n<script>\n$(function() {\n    $('#UserLoginForm').submit(function(event) {\n        event.preventDefault()\n        submitLoginForm()\n    });\n})\n\nfunction submitLoginForm() {\n    var $form = $('#UserLoginForm')\n    var url = $form.attr('action')\n    var email = $form.find('#UserEmail').val()\n    var password = $form.find('#UserPassword').val()\n    if (!empty(Configure::read('LinOTPAuth')) && Configure::read('LinOTPAuth.enabled')) {\n        var otp = $form.find('#UserOtp').val()\n    }\n    if (!$form[0].checkValidity()) {\n        $form[0].reportValidity()\n    } else {\n        fetchFormDataAjax(url, function(html) {\n            var formHTML = $(html).find('form#UserLoginForm')\n            if (!formHTML.length) {\n                window.location = baseurl + '/users/login'\n            }\n            $('body').append($('<div id=\"temp\" style=\"display: none\"/>').append(formHTML))\n            var $tmpForm = $('#temp form#UserLoginForm')\n            $tmpForm.find('#UserEmail').val(email)\n            $tmpForm.find('#UserPassword').val(password)\n            if (!empty(Configure::read('LinOTPAuth')) && Configure::read('LinOTPAuth.enabled')) {\n                $tmpForm.find('#UserOtp').val(otp)\n            }\n            $tmpForm.submit()\n        })\n    }\n}\n</script>\n"], "fixing_code": ["<div style=\"width:100%;\">\n    <?php\n        echo $this->Session->flash('auth');\n    ?>\n<table style=\"margin-left:auto;margin-right:auto;\">\n    <tr>\n    <td style=\"text-align:right;width:250px;padding-right:50px\">\n        <?php if (Configure::read('MISP.welcome_logo')) echo $this->Html->image('custom/' . h(Configure::read('MISP.welcome_logo')), array('alt' => __('Logo'), 'onerror' => \"this.style.display='none';\")); ?>\n    </td>\n    <td style=\"width:460px\">\n        <span style=\"font-size:18px;\">\n            <?php\n                if (Configure::read('MISP.welcome_text_top')) {\n                    echo h(Configure::read('MISP.welcome_text_top'));\n                }\n            ?>\n        </span><br /><br />\n        <div>\n        <?php if (Configure::read('MISP.main_logo') && file_exists(APP . '/webroot/img/custom/' . Configure::read('MISP.main_logo'))): ?>\n            <img src=\"<?php echo $baseurl?>/img/custom/<?php echo h(Configure::read('MISP.main_logo'));?>\" style=\" display:block; margin-left: auto; margin-right: auto;\" />\n        <?php else: ?>\n            <img src=\"<?php echo $baseurl?>/img/misp-logo-s-u.png\" style=\"display:block; margin-left: auto; margin-right: auto;\"/>\n        <?php endif;?>\n        </div>\n        <?php\n            if (true == Configure::read('MISP.welcome_text_bottom')):\n        ?>\n                <div style=\"text-align:right;font-size:18px;\">\n                <?php\n                    echo h(Configure::read('MISP.welcome_text_bottom'));\n                ?>\n                </div>\n        <?php\n            endif;\n            if ($formLoginEnabled):\n            echo $this->Form->create('User');\n        ?>\n        <legend><?php echo __('Login');?></legend>\n        <?php\n            echo $this->Form->input('email', array('autocomplete' => 'off', 'autofocus'));\n            echo $this->Form->input('password', array('autocomplete' => 'off'));\n            if (!empty(Configure::read('LinOTPAuth')) && Configure::read('LinOTPAuth.enabled')!== FALSE) {\n                echo $this->Form->input('otp', array('autocomplete' => 'off', 'type' => 'password', 'label' => 'OTP'));\n                echo \"<div class=\\\"clear\\\">\";\n                echo sprintf(\n                    '%s <a href=\"%s/selfservice\" title=\"LinOTP Selfservice\">LinOTP Selfservice</a> %s',\n                    __('Visit'),\n                    h(Configure::read('LinOTPAuth.baseUrl')),\n                    __('for the One-Time-Password selfservice.')\n                );\n            }\n        ?>\n            <div class=\"clear\">\n            <?php\n                echo empty(Configure::read('Security.allow_self_registration')) ? '' : sprintf(\n                    '<a href=\"%s/users/register\" title=\"%s\">%s</a>',\n                    $baseurl,\n                    __('Registration will be sent to the administrators of the instance for consideration.'),\n                    __('No account yet? Register now!')\n                );\n            ?>\n            </div>\n            <?= $this->Form->button(__('Login'), array('class' => 'btn btn-primary')); ?>\n        <?php\n            echo $this->Form->end();\n            endif;\n            if (Configure::read('ApacheShibbAuth') == true) {\n                echo '<div class=\"clear\"></div><a class=\"btn btn-info\" href=\"/Shibboleth.sso/Login\">Login with SAML</a>';\n            }\n            if (Configure::read('AadAuth') == true) {\n                echo '<div class=\"clear\"></div><a class=\"btn btn-info\" href=\"/users/login?AzureAD=enable\">Login with AzureAD</a>';\n            }\n        ?>\n    </td>\n    <td style=\"width:250px;padding-left:50px\">\n        <?php if (Configure::read('MISP.welcome_logo2')) echo $this->Html->image('custom/' . h(Configure::read('MISP.welcome_logo2')), array('alt' => 'Logo2', 'onerror' => \"this.style.display='none';\")); ?>\n    </td>\n    </tr>\n    </table>\n</div>\n\n<script>\n$(function() {\n    $('#UserLoginForm').submit(function(event) {\n        event.preventDefault()\n        submitLoginForm()\n    });\n})\n\nfunction submitLoginForm() {\n    var $form = $('#UserLoginForm')\n    var url = $form.attr('action')\n    var email = $form.find('#UserEmail').val()\n    var password = $form.find('#UserPassword').val()\n    var LinOTPAuth = <?= empty(Configure::read('LinOTPAuth')) ? 'False' : 'True' ?>;\n    var LinOTPAuthEnabled = <?= empty(Configure::read('LinOTPAuth.enabled')) ? 'False' : 'True' ?>;\n\n    if (LinOTPAuth && LinOTPAuthEnabled) {\n        var otp = $form.find('#UserOtp').val()\n    }\n    if (!$form[0].checkValidity()) {\n        $form[0].reportValidity()\n    } else {\n        fetchFormDataAjax(url, function(html) {\n            var formHTML = $(html).find('form#UserLoginForm')\n            if (!formHTML.length) {\n                window.location = baseurl + '/users/login'\n            }\n            $('body').append($('<div id=\"temp\" style=\"display: none\"/>').append(formHTML))\n            var $tmpForm = $('#temp form#UserLoginForm')\n            $tmpForm.find('#UserEmail').val(email)\n            $tmpForm.find('#UserPassword').val(password)\n            if (LinOTPAuth && LinOTPAuthEnabled) {\n                $tmpForm.find('#UserOtp').val(otp)\n            }\n            $tmpForm.submit()\n        })\n    }\n}\n</script>\n"], "filenames": ["app/View/Users/login.ctp"], "buggy_code_start_loc": [48], "buggy_code_end_loc": [111], "fixing_code_start_loc": [48], "fixing_code_end_loc": [114], "type": "CWE-79", "message": "An issue was discovered in MISP before 2.4.158. There is stored XSS via the LinOTP login field.", "other": {"cve": {"id": "CVE-2022-29529", "sourceIdentifier": "cve@mitre.org", "published": "2022-04-20T23:15:08.467", "lastModified": "2022-04-27T03:57:43.477", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "An issue was discovered in MISP before 2.4.158. There is stored XSS via the LinOTP login field."}, {"lang": "es", "value": "Se ha detectado un problema en MISP versiones anteriores a 2.4.158. Se presenta una vulnerabilidad de tipo XSS almacenado por medio del campo de inicio de sesi\u00f3n de LinOTP"}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:S/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "SINGLE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 3.5}, "baseSeverity": "LOW", "exploitabilityScore": 6.8, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:misp:misp:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.4.158", "matchCriteriaId": "C6216C19-9CB8-451D-AC18-0D849429EE09"}]}]}], "references": [{"url": "https://github.com/MISP/MISP/commit/9623de2f5cca011afc581d55cfa5ce87682894fd", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/MISP/MISP/compare/v2.4.157...v2.4.158", "source": "cve@mitre.org", "tags": ["Release Notes", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/MISP/MISP/commit/9623de2f5cca011afc581d55cfa5ce87682894fd"}}