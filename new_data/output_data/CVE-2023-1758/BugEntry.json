{"buggy_code": ["<?php\n\n/**\n * Shows all comments in the categories and provides a link to delete comments.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2007-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2007-03-04\n */\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Comments;\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Entity\\CommentType;\nuse phpMyFAQ\\Faq;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n?>\n  <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n    <h1 class=\"h2\">\n      <i aria-hidden=\"true\" class=\"fa fa-comments-o\"></i>\n        <?= $PMF_LANG['ad_comment_administration'] ?>\n    </h1>\n  </div>\n<?php\n\necho '<div id=\"returnMessage\"></div>';\n\nif ($user->perm->hasPermission($user->getUserId(), 'delcomment')) {\n    $comment = new Comments($faqConfig);\n    $category = new Category($faqConfig, [], false);\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n    $faq = new Faq($faqConfig);\n    $date = new Date($faqConfig);\n\n    $category->buildCategoryTree();\n    $faqComments = $comment->getAllComments(CommentType::FAQ);\n\n    printf(\"<header><h3>%s</h3></header>\\n\", $PMF_LANG['ad_comment_faqs']);\n    if (count($faqComments)) {\n        ?>\n      <form id=\"faqCommentSelection\" name=\"faqCommentSelection\" method=\"post\" accept-charset=\"utf-8\">\n        <input type=\"hidden\" name=\"ajax\" value=\"comment\"/>\n        <input type=\"hidden\" name=\"ajaxaction\" value=\"delete\"/>\n        <table class=\"table table-striped\">\n            <?php\n            $lastCommentId = 0;\n            foreach ($faqComments as $faqComment) {\n                if ($faqComment->getId() == $lastCommentId) {\n                    continue;\n                }\n                ?>\n              <tr id=\"comments_<?= $faqComment->getId() ?>\">\n                <td>\n                  <label>\n                    <input id=\"faq_comments[<?= $faqComment->getId() ?>]\"\n                           name=\"faq_comments[<?= $faqComment->getId() ?>]\"\n                           value=\"<?= $faqComment->getRecordId() ?>\" type=\"checkbox\">\n                  </label>\n                </td>\n                <td>\n                <span style=\"font-weight: bold;\">\n                    <a href=\"mailto:<?= $faqComment->getEmail() ?>\">\n                        <?= Strings::htmlentities($faqComment->getUsername()) ?>\n                    </a> |\n                    <?= $date->format(date('Y-m-d H:i', $faqComment->getDate())) ?> |\n                    <a href=\"<?php printf(\n                        '../?action=faq&cat=%d&id=%d&artlang=%s',\n                        $faqComment->getCategoryId(),\n                        $faqComment->getRecordId(),\n                        $faqLangCode\n                             ) ?>\">\n                        <?= $faq->getRecordTitle($faqComment->getRecordId()) ?>\n                    </a>\n                </span><br>\n                    <?= Strings::htmlentities($faqComment->getComment()) ?>\n                </td>\n              </tr>\n                <?php\n                $lastCommentId = $faqComment->getId();\n            }\n            ?>\n        </table>\n        <div class=\"text-right\">\n          <button class=\"btn btn-danger\" id=\"submitFaqComments\" type=\"submit\" name=\"submit\">\n              <?= $PMF_LANG['ad_entry_delete'] ?>\n          </button>\n        </div>\n      </form>\n        <?php\n    } else {\n        echo '<p><strong>n/a</strong></p>';\n    }\n\n    $newsComments = $comment->getAllComments(CommentType::NEWS);\n\n    printf(\"<header><h3>%s</h3></header>\\n\", $PMF_LANG['ad_comment_news']);\n    if (count($newsComments)) {\n        ?>\n      <form id=\"newsCommentSelection\" name=\"newsCommentSelection\" method=\"post\" accept-charset=\"utf-8\">\n        <input type=\"hidden\" name=\"ajax\" value=\"comment\"/>\n        <input type=\"hidden\" name=\"ajaxaction\" value=\"delete\"/>\n        <table class=\"table table-striped\">\n            <?php\n            foreach ($newsComments as $newsComment) { ?>\n              <tr id=\"comments_<?= $newsComment->getId() ?>\">\n                <td>\n                  <label>\n                    <input id=\"news_comments[<?= $newsComment->getId() ?>]\"\n                           name=\"news_comments[<?= $newsComment->getId() ?>]\"\n                           value=\"<?= $newsComment->getRecordId() ?>\" type=\"checkbox\">\n                  </label>\n                </td>\n                <td>\n                <span style=\"font-weight: bold;\">\n                    <a href=\"mailto:<?= $newsComment->getEmail() ?>\">\n                        <?= $newsComment->getUsername() ?>\n                    </a> |\n                    <?= $date->format(date('Y-m-d H:i', $faqComment->getDate())) ?> |\n                    <a href=\"<?php printf('../?action=news&id=%d&artlang=%s', $faqComment->getRecordId(), $faqLangCode) ?>\">\n                        <i class=\"fa fa-newspaper-o\" aria-hidden=\"true\"></i>\n                    </a>\n                </span><br/>\n                    <?= $newsComment->getComment() ?>\n                </td>\n              </tr>\n                <?php\n            }\n            ?>\n        </table>\n        <div class=\"text-right\">\n          <button class=\"btn btn-danger\" id=\"submitNewsComments\" type=\"submit\" name=\"submit\">\n              <?= $PMF_LANG['ad_entry_delete'] ?>\n          </button>\n        </div>\n      </form>\n        <?php\n    } else {\n        echo '<p><strong>n/a</strong></p>';\n    }\n    ?>\n\n  <script>\n    (() => {\n      $('#submitFaqComments').on('click', () => {\n        deleteComments('faq');\n        return false;\n      });\n      $('#submitNewsComments').on('click', () => {\n        deleteComments('news');\n        return false;\n      });\n    })();\n\n    function deleteComments(type) {\n      const savingIndicator = $('#pmf-admin-saving-data-indicator'),\n        returnMessage = $('#returnMessage'),\n        comments = $('#' + type + 'CommentSelection').serialize();\n\n      returnMessage.empty();\n      $.ajax({\n        type: 'POST',\n        url: 'index.php?action=ajax&ajax=comment',\n        data: comments,\n        success: function (msg) {\n          if (msg === 1) {\n            savingIndicator.html('<i class=\"fa fa-cog fa-spin fa-fw\"></i><span class=\"sr-only\">Deleting ...</span>');\n            $('tr td input:checked').parent().parent().parent().fadeOut('slow');\n            savingIndicator.fadeOut('slow');\n            returnMessage.html('<p class=\"alert alert-success\"><?= $PMF_LANG['ad_entry_commentdelsuc'] ?></p>');\n          } else {\n            returnMessage.html('<p class=\"alert alert-danger\"><?= addslashes($PMF_LANG['ad_entry_commentdelfail']) ?></p>');\n          }\n        }\n      });\n      return false;\n    }\n\n  </script>\n    <?php\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "fixing_code": ["<?php\n\n/**\n * Shows all comments in the categories and provides a link to delete comments.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at http://mozilla.org/MPL/2.0/.\n *\n * @package phpMyFAQ\n * @author Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2007-2022 phpMyFAQ Team\n * @license http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link https://www.phpmyfaq.de\n * @since 2007-03-04\n */\n\nuse phpMyFAQ\\Category;\nuse phpMyFAQ\\Comments;\nuse phpMyFAQ\\Date;\nuse phpMyFAQ\\Entity\\CommentType;\nuse phpMyFAQ\\Faq;\nuse phpMyFAQ\\Strings;\n\nif (!defined('IS_VALID_PHPMYFAQ')) {\n    http_response_code(400);\n    exit();\n}\n\n?>\n  <div class=\"d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom\">\n    <h1 class=\"h2\">\n      <i aria-hidden=\"true\" class=\"fa fa-comments-o\"></i>\n        <?= $PMF_LANG['ad_comment_administration'] ?>\n    </h1>\n  </div>\n<?php\n\necho '<div id=\"returnMessage\"></div>';\n\nif ($user->perm->hasPermission($user->getUserId(), 'delcomment')) {\n    $comment = new Comments($faqConfig);\n    $category = new Category($faqConfig, [], false);\n    $category->setUser($currentAdminUser);\n    $category->setGroups($currentAdminGroups);\n    $faq = new Faq($faqConfig);\n    $date = new Date($faqConfig);\n\n    $category->buildCategoryTree();\n    $faqComments = $comment->getAllComments(CommentType::FAQ);\n\n    printf(\"<header><h3>%s</h3></header>\\n\", $PMF_LANG['ad_comment_faqs']);\n    if (count($faqComments)) {\n        ?>\n      <form id=\"faqCommentSelection\" name=\"faqCommentSelection\" method=\"post\" accept-charset=\"utf-8\">\n        <input type=\"hidden\" name=\"ajax\" value=\"comment\"/>\n        <input type=\"hidden\" name=\"ajaxaction\" value=\"delete\"/>\n        <table class=\"table table-striped\">\n            <?php\n            $lastCommentId = 0;\n            foreach ($faqComments as $faqComment) {\n                if ($faqComment->getId() == $lastCommentId) {\n                    continue;\n                }\n                ?>\n              <tr id=\"comments_<?= $faqComment->getId() ?>\">\n                <td>\n                  <label>\n                    <input id=\"faq_comments[<?= $faqComment->getId() ?>]\"\n                           name=\"faq_comments[<?= $faqComment->getId() ?>]\"\n                           value=\"<?= $faqComment->getRecordId() ?>\" type=\"checkbox\">\n                  </label>\n                </td>\n                <td>\n                <span style=\"font-weight: bold;\">\n                    <a href=\"mailto:<?= $faqComment->getEmail() ?>\">\n                        <?= Strings::htmlentities($faqComment->getUsername()) ?>\n                    </a> |\n                    <?= $date->format(date('Y-m-d H:i', $faqComment->getDate())) ?> |\n                    <a href=\"<?php printf(\n                        '../?action=faq&cat=%d&id=%d&artlang=%s',\n                        $faqComment->getCategoryId(),\n                        $faqComment->getRecordId(),\n                        $faqLangCode\n                             ) ?>\">\n                        <?= $faq->getRecordTitle($faqComment->getRecordId()) ?>\n                    </a>\n                </span><br>\n                    <?= Strings::htmlentities($faqComment->getComment()) ?>\n                </td>\n              </tr>\n                <?php\n                $lastCommentId = $faqComment->getId();\n            }\n            ?>\n        </table>\n        <div class=\"text-right\">\n          <button class=\"btn btn-danger\" id=\"submitFaqComments\" type=\"submit\" name=\"submit\">\n              <?= $PMF_LANG['ad_entry_delete'] ?>\n          </button>\n        </div>\n      </form>\n        <?php\n    } else {\n        echo '<p><strong>n/a</strong></p>';\n    }\n\n    $newsComments = $comment->getAllComments(CommentType::NEWS);\n\n    printf(\"<header><h3>%s</h3></header>\\n\", $PMF_LANG['ad_comment_news']);\n    if (count($newsComments)) {\n        ?>\n      <form id=\"newsCommentSelection\" name=\"newsCommentSelection\" method=\"post\" accept-charset=\"utf-8\">\n        <input type=\"hidden\" name=\"ajax\" value=\"comment\"/>\n        <input type=\"hidden\" name=\"ajaxaction\" value=\"delete\"/>\n        <table class=\"table table-striped\">\n            <?php\n            foreach ($newsComments as $newsComment) { ?>\n              <tr id=\"comments_<?= $newsComment->getId() ?>\">\n                <td>\n                  <label>\n                    <input id=\"news_comments[<?= $newsComment->getId() ?>]\"\n                           name=\"news_comments[<?= $newsComment->getId() ?>]\"\n                           value=\"<?= $newsComment->getRecordId() ?>\" type=\"checkbox\">\n                  </label>\n                </td>\n                <td>\n                <span style=\"font-weight: bold;\">\n                    <a href=\"mailto:<?= $newsComment->getEmail() ?>\">\n                        <?= Strings::htmlentities($newsComment->getUsername()) ?>\n                    </a> |\n                    <?= $date->format(date('Y-m-d H:i', $newsComment->getDate())) ?> |\n                    <a href=\"<?php printf('../?action=news&id=%d&artlang=%s', $newsComment->getRecordId(), $faqLangCode) ?>\">\n                        <i class=\"fa fa-newspaper-o\" aria-hidden=\"true\"></i>\n                    </a>\n                </span><br/>\n                    <?= $newsComment->getComment() ?>\n                </td>\n              </tr>\n                <?php\n            }\n            ?>\n        </table>\n        <div class=\"text-right\">\n          <button class=\"btn btn-danger\" id=\"submitNewsComments\" type=\"submit\" name=\"submit\">\n              <?= $PMF_LANG['ad_entry_delete'] ?>\n          </button>\n        </div>\n      </form>\n        <?php\n    } else {\n        echo '<p><strong>n/a</strong></p>';\n    }\n    ?>\n\n  <script>\n    (() => {\n      $('#submitFaqComments').on('click', () => {\n        deleteComments('faq');\n        return false;\n      });\n      $('#submitNewsComments').on('click', () => {\n        deleteComments('news');\n        return false;\n      });\n    })();\n\n    function deleteComments(type) {\n      const savingIndicator = $('#pmf-admin-saving-data-indicator'),\n        returnMessage = $('#returnMessage'),\n        comments = $('#' + type + 'CommentSelection').serialize();\n\n      returnMessage.empty();\n      $.ajax({\n        type: 'POST',\n        url: 'index.php?action=ajax&ajax=comment',\n        data: comments,\n        success: function (msg) {\n          if (msg === 1) {\n            savingIndicator.html('<i class=\"fa fa-cog fa-spin fa-fw\"></i><span class=\"sr-only\">Deleting ...</span>');\n            $('tr td input:checked').parent().parent().parent().fadeOut('slow');\n            savingIndicator.fadeOut('slow');\n            returnMessage.html('<p class=\"alert alert-success\"><?= $PMF_LANG['ad_entry_commentdelsuc'] ?></p>');\n          } else {\n            returnMessage.html('<p class=\"alert alert-danger\"><?= addslashes($PMF_LANG['ad_entry_commentdelfail']) ?></p>');\n          }\n        }\n      });\n      return false;\n    }\n\n  </script>\n    <?php\n} else {\n    echo $PMF_LANG['err_NotAuth'];\n}\n"], "filenames": ["phpmyfaq/admin/record.comments.php"], "buggy_code_start_loc": [130], "buggy_code_end_loc": [134], "fixing_code_start_loc": [130], "fixing_code_end_loc": [134], "type": "CWE-75", "message": "Failure to Sanitize Special Elements into a Different Plane (Special Element Injection) in GitHub repository thorsten/phpmyfaq prior to 3.1.12.", "other": {"cve": {"id": "CVE-2023-1758", "sourceIdentifier": "security@huntr.dev", "published": "2023-04-05T16:15:07.367", "lastModified": "2023-04-11T19:09:50.800", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Failure to Sanitize Special Elements into a Different Plane (Special Element Injection) in GitHub repository thorsten/phpmyfaq prior to 3.1.12."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 5.4, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.3, "impactScore": 2.7}], "cvssMetricV30": [{"source": "security@huntr.dev", "type": "Secondary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:L", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "LOW", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "LOW", "baseScore": 8.9, "baseSeverity": "HIGH"}, "exploitabilityScore": 2.3, "impactScore": 6.0}]}, "weaknesses": [{"source": "security@huntr.dev", "type": "Primary", "description": [{"lang": "en", "value": "CWE-75"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:phpmyfaq:phpmyfaq:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.1.12", "matchCriteriaId": "653EC167-06FC-4D30-AAF8-B75F596519AE"}]}]}], "references": [{"url": "https://github.com/thorsten/phpmyfaq/commit/f3380f46c464d1bc6f3ded29213c79be0de8fc57", "source": "security@huntr.dev", "tags": ["Patch"]}, {"url": "https://huntr.dev/bounties/0854328e-eb00-41a3-9573-8da8f00e369c", "source": "security@huntr.dev", "tags": ["Exploit", "Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/thorsten/phpmyfaq/commit/f3380f46c464d1bc6f3ded29213c79be0de8fc57"}}