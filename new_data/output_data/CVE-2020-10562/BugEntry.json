{"buggy_code": ["Bugs connus sur la version de GitHub :\n - affichage d\u00e9fectueux du menu en position haute dans la page month_all2 \n - des probl\u00e8mes se produisent lorsqu'on veut faire une modification/copie de r\u00e9servation  avec un changement de domaine\n - l'entr\u00e9e du code hexad\u00e9cimal des couleurs des types n'est pas r\u00e9percut\u00e9e sur la zone test\n\nT\u00e2ches pr\u00e9vues :\n - gestion des acc\u00e8s au niveau de la ressource (et pas seulement au niveau des domaines)\n - authentification li\u00e9e \u00e0 Joomla!\n-----\n--\n-----\n\nVersion 3.4.1\n    [ajout] Echange de deux r\u00e9servations\n    [ajout] Page year_all affichant les r\u00e9servations sur plusieurs mois et plusieurs domaines (\u00e0 utiliser avec prudence s'il y a beaucoup de r\u00e9servations ou de ressources)\n    [ajout] Contenu des champs additionnels dans les exports csv\n    [ajout] Gestion des couleurs du texte des types de r\u00e9servation (meilleure lisibilit\u00e9 dans les plannings)\n    [ajout] Page d'interface de personnalisation des couleurs\n    [amelioration] Reprise du code des pages plannings pour g\u00e9rer les menus escamotables (haut et gauche) \n    [modification] Utilisation de jscolor pour d\u00e9finir les couleurs des types\n    [modification] Page d'accueil de la section administration\n    [modification] Gestion de l'affichage des champs additionnels\n    [correction] meilleure prise en compte des r\u00e9glages par d\u00e9faut\nSous-version 3.4.1a (version de maintenance)\n\t[correction] divers bugs, compatibilit\u00e9 php7, erreurs de syntaxe ou orthographiques\nSous-version 3.4.1b \n\t[ajout] possibilit\u00e9 de d\u00e9finir un type et affecter ce type \u00e0 la fonction \"cacher sur les plannings week_all, month et month_all\"\n\t[am\u00e9lioration] configuration LDAP acceptant le protocole LDAPS\n\t[am\u00e9lioration] gestion des champs additionnels dans edit_entry\n\t[correction] divers bugs, erreurs de syntaxe ou orthographiques\n\t[modification] limitation de la taille des donn\u00e9es conform\u00e9ment \u00e0 la base\n\t[modification] calcul et aspect de la page de contact externe\n-----\n--\n-----\n\nVersion 3.4.0\n\t[ajout] Personnalisation des couleurs pour les types de r\u00e9servation depuis l'administration, soit un passage de 28 couleurs \u00e0 16 777 216 couleurs\n\t[ajout] Possibilit\u00e9 d'afficher le formulaire de demande de r\u00e9servation aux non connect\u00e9s et aux visiteurs ou simplement aux visiteurs \n\t[ajout] Interdire les diff\u00e9rentes configurations d'authentification externe via le fichier de config\n\t[ajout] Menu administration : Couleur bleu sur le lien o\u00f9 l'on se situe\n\t[ajout] Menu administration : Possiblit\u00e9 d'acc\u00e9der au lien o\u00f9 l'on se situe\n\t[ajout] Moteur de page\n\t[ajout] Conditions G\u00e9n\u00e9rales d'Utilisation personnalisables\n\t[ajout] Lors de l'envoi mail, notifier le changement de ressources s'il y a lieu\n\t[ajout] Gestion de modules externes\n    [ajout] message dans l'ent\u00eate s'il existe une r\u00e9servation \u00e0 mod\u00e9rer\n    [am\u00e9lioration] filtrage par plage IP au format CIDR\n    [am\u00e9lioration] retour \u00e0 la page d'appel apr\u00e8s mod\u00e9ration\n    [am\u00e9lioration] pr\u00e9sentation des r\u00e9servations mod\u00e9r\u00e9es\n    [am\u00e9lioration] possibilit\u00e9 d'utiliser les couleurs du texte et du fond\n    [am\u00e9lioration] int\u00e9gration au portail EnvOLE\n    [am\u00e9lioration] filtrage des adresses mail\n    [am\u00e9lioration] affichage et liens pour cr\u00e9er une r\u00e9servation en page month_all2\n    [am\u00e9lioration] affichage des menus, changement de param\u00e9trage de make_room_list_html\n    [am\u00e9lioration] affichage des r\u00e9servations successives dans une journ\u00e9e en page week_all\n    [correctif] param\u00e8tre manquant dans mysqli_connect\n    [correctif] divers correctifs syntaxiques\n    [correctif] donner une valeur num\u00e9rique \u00e0 $dbPort\n    [correctif] prise en compte des pr\u00e9f\u00e9rences de l'utilisateur dans le calcul de la page d'accueil\n    [correctif] la couleur jaune est illisible sur fond blanc\n    [correctif] affichage ou non de l'imprimante\n    [correctif] gestion du menu gauche escamotable\n\t[mise \u00e0 jour] CKEditor 4.8.0 \n\t[modification] G\u00e9n\u00e9ration des PDF, on parle de ressource et non de salle, r\u00e9organisation du format PDF (compatible en enveloppe fen\u00eatre)\n\t[modification] Date de d\u00e9but et fin des r\u00e9servations par d\u00e9faut lors d'une premi\u00e8re installation\n\t[modification] Longueur minimum du mot de passe, passage de 6 \u00e0 8 caract\u00e8res lors d'une premi\u00e8re installation\n\t[modification] Conformit\u00e9 avec le RGPD\n    [modification] boutons mois pr\u00e9c\u00e9dent/suivant\n\n\t\n-----\n--\n-----\n\nVersion 3.3.1\n    [ajout] Visualisation des utilisateurs avec un mot de passe trop simple (A titre indicatif, certains mots de passe simples ne sont pas list\u00e9s)\n    [ajout] Configuration du calendrier des vacances depuis l'administration\n    [ajout] Nouveau calendrier pour indiquer les f\u00e9ri\u00e9s depuis l'administration\n    [ajout] Ajout de fichiers redirection pour emp\u00eacher la lecture de certains r\u00e9pertoires\n    [ajout] Champs additionnels dans l'affichage d'une r\u00e9servation\n    [ajout] Page permettant la suppression de toutes les r\u00e9servations post\u00e9rieures \u00e0 une date\n    [ajout] Page permettant la suppression de toutes les r\u00e9servations ant\u00e9rieures \u00e0 une date\n    [ajout] Page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv\n    [ajout] Page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv issu du logiciel UnDeuxTemps\n    [ajout] biblioth\u00e8ques phpCAS dans le dossier /include\n    [ajout] Lien vers la page year.php depuis le num\u00e9ro de l'ann\u00e9e dans les pages month*.php\n\t[ajout] Variable dans config permettant de d\u00e9sactiver la recherche de mise \u00e0 jour\n    [correction] Affichage des champs additionnel, m\u00eame dans le cas de caract\u00e8re non utf8\n    [correction] Bordure de s\u00e9paration pour les r\u00e9servations entre les r\u00e9servations dans la vue mois d'une ressources\n    [correction] Bordure de s\u00e9paration pour les r\u00e9servations entre les r\u00e9servations dans la vue mois d'un domaine\n    [correction] Correction de la connexion LDAP lorsqu'un utilisateur externe existant se connecte ( merci \u00e0 pboissonneault )\n    [correction] Affichage de la colonne gauche de l'admin dans la page admin_import_users_csv.php\n\t[correction] Vue semaine d'une ressource sur plusieurs jour (horaire et cr\u00e9naux)\n    [modification] La configuration d'un cas SSO ce fait depuis l'administration\n    [modification] D\u00e9placement images dans le dossier appropri\u00e9\n    [modification] de la page admin_calend.php pour en faire une page de choix entre:\n        -- l'ancienne page admin_calend.php renomm\u00e9e admin_calend2.php\n        -- une page permettant de supprimer toutes les r\u00e9servations avant une date donn\u00e9e\n        -- une page permettant de supprimer toutes les r\u00e9servations apr\u00e8s une date donn\u00e9e\n        -- une page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv\n        -- une page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv issu du logiciel UnDeuxTemps\n    [modification] reprise des patches utilis\u00e9s dans GEPI pour utilisation derri\u00e8re un reverse-proxy\n\t[modification] Am\u00e9lioration du bandeau du haut : Supression texte \"Accueil\", r\u00e9duction de la hauteur, optimisation du contenu\n\t[modification] Passage d'image en CSS (Glyphicon)\n    [Suppression] Fichiers inutiles\n    [mise \u00e0 jour] fichier des vacances scolaires (source index-education)\n    [mise \u00e0 jour] documentation\n\n\nVersion 3.3.0 et inf\u00e9rieur\n- Voir sur le site grr.devome.com\n", "<?php\n/**\n * admin_edit_room.php\n * Interface de creation/modification des sites, domaines et des ressources de l'application GRR\n * Ce script fait partie de l'application GRR\n * Derni\u00e8re modification : $Date: 2020-01-28 11:10$\n * @author    Laurent Delineau & JeromeB & Marc-Henri PAMISEU & Yan Naessens & Daniel Antelme\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n$grr_script_name = \"admin_edit_room.php\";\n\ninclude \"../include/admin.inc.php\";\n\n$ok = NULL;\nif (Settings::get(\"module_multisite\") == \"Oui\")\n\t$id_site = isset($_POST[\"id_site\"]) ? $_POST[\"id_site\"] : (isset($_GET[\"id_site\"]) ? $_GET[\"id_site\"] : -1);\n$action = isset($_POST[\"action\"]) ? $_POST[\"action\"] : (isset($_GET[\"action\"]) ? $_GET[\"action\"] : NULL);\n$add_area = isset($_POST[\"add_area\"]) ? $_POST[\"add_area\"] : (isset($_GET[\"add_area\"]) ? $_GET[\"add_area\"] : NULL);\n$area_id = isset($_POST[\"area_id\"]) ? $_POST[\"area_id\"] : (isset($_GET[\"area_id\"]) ? $_GET[\"area_id\"] : NULL);\n$retour_page = isset($_POST[\"retour_page\"]) ? $_POST[\"retour_page\"] : (isset($_GET[\"retour_page\"]) ? $_GET[\"retour_page\"] : NULL);\n$room = isset($_POST[\"room\"]) ? $_POST[\"room\"] : (isset($_GET[\"room\"]) ? $_GET[\"room\"] : NULL);\n$id_area = isset($_POST[\"id_area\"]) ? $_POST[\"id_area\"] : (isset($_GET[\"id_area\"]) ? $_GET[\"id_area\"] : NULL);\n$change_area = isset($_POST[\"change_area\"]) ? $_POST[\"change_area\"] : NULL;\n$area_name = isset($_POST[\"area_name\"]) ? $_POST[\"area_name\"] : NULL;\n$access = isset($_POST[\"access\"]) ? $_POST[\"access\"] : NULL;\n$ip_adr = isset($_POST[\"ip_adr\"]) ? $_POST[\"ip_adr\"] : NULL;\n$room_name = isset($_POST[\"room_name\"]) ? $_POST[\"room_name\"] : NULL;\n$description = isset($_POST[\"description\"]) ? $_POST[\"description\"] : NULL;\n$capacity = isset($_POST[\"capacity\"]) ? $_POST[\"capacity\"] : NULL;\n$duree_max_resa_area1  = isset($_POST[\"duree_max_resa_area1\"]) ? $_POST[\"duree_max_resa_area1\"] : NULL;\n$duree_max_resa_area2  = isset($_POST[\"duree_max_resa_area2\"]) ? $_POST[\"duree_max_resa_area2\"] : NULL;\n$delais_max_resa_room  = isset($_POST[\"delais_max_resa_room\"]) ? $_POST[\"delais_max_resa_room\"] : NULL;\n$delais_min_resa_room  = isset($_POST[\"delais_min_resa_room\"]) ? $_POST[\"delais_min_resa_room\"] : NULL;\n$delais_option_reservation  = isset($_POST[\"delais_option_reservation\"]) ? $_POST[\"delais_option_reservation\"] : NULL;\n$allow_action_in_past  = isset($_POST[\"allow_action_in_past\"]) ? $_POST[\"allow_action_in_past\"] : NULL;\n$dont_allow_modify  = isset($_POST[\"dont_allow_modify\"]) ? $_POST[\"dont_allow_modify\"] : NULL;\n$qui_peut_reserver_pour  = isset($_POST[\"qui_peut_reserver_pour\"]) ? $_POST[\"qui_peut_reserver_pour\"] : NULL;\n$who_can_see  = isset($_POST[\"who_can_see\"]) ? $_POST[\"who_can_see\"] : NULL;\n$max_booking = isset($_POST[\"max_booking\"]) ? $_POST[\"max_booking\"] : NULL;\nsettype($max_booking, \"integer\");\nif ($max_booking<-1)\n\t$max_booking = -1;\n$statut_room = isset($_POST[\"statut_room\"]) ? \"0\" : \"1\";\n$show_fic_room = isset($_POST[\"show_fic_room\"]) ? \"y\" : \"n\";\nif (isset($_POST[\"active_ressource_empruntee\"]))\n\t$active_ressource_empruntee = 'y';\nelse\n{\n\t$active_ressource_empruntee = 'n';\n\t// toutes les reservations sont considerees comme restituee\n\tgrr_sql_query(\"update \".TABLE_PREFIX.\"_entry set statut_entry = '-' where room_id = '\".$room.\"'\");\n}\nif (isset($_POST[\"active_cle\"]))\n\t$active_cle = 'y';\nelse\n{\n\t$active_cle = 'n';\n\t// toutes les reservations sont considerees comme restituee\n\tgrr_sql_query(\"update \".TABLE_PREFIX.\"_entry set statut_entry = '-' where room_id = '\".$room.\"'\");\n}\n$picture_room = isset($_POST[\"picture_room\"]) ? $_POST[\"picture_room\"] : NULL;\n$comment_room = isset($_POST[\"comment_room\"]) ? $_POST[\"comment_room\"] : NULL;\n$show_comment = isset($_POST[\"show_comment\"]) ? \"y\" : \"n\";\n$change_done = isset($_POST[\"change_done\"]) ? $_POST[\"change_done\"] : NULL;\nif(!isset($_POST[\"area_order\"]) || empty($_POST[\"area_order\"])){\n\t$area_order = 0;\n} else{\n\t$area_order = $_POST[\"area_order\"];\n}\n\n$room_order = isset($_POST[\"room_order\"]) ? $_POST[\"room_order\"] : NULL;\n$change_room = isset($_POST[\"change_room\"]) ? $_POST[\"change_room\"] : NULL;\n$number_periodes = isset($_POST[\"number_periodes\"]) ? $_POST[\"number_periodes\"] : NULL;\n$type_affichage_reser = isset($_POST[\"type_affichage_reser\"]) ? $_POST[\"type_affichage_reser\"] : NULL;\n$retour_resa_obli = isset($_POST[\"retour_resa_obli\"]) ? $_POST[\"retour_resa_obli\"] : NULL;\n$moderate = isset($_POST['moderate']) ? $_POST[\"moderate\"] : NULL;\nif ($moderate == 'on')\n\t$moderate = 1;\nelse\n\t$moderate = 0;\nsettype($type_affichage_reser, \"integer\");\n\n$back = '';\nif (isset($_SERVER['HTTP_REFERER']))\n\t$back = htmlspecialchars($_SERVER['HTTP_REFERER']);\n\nif (isset($_POST[\"change_room_and_back\"]))\n{\n\t$change_room = \"yes\";\n\t$change_done = \"yes\";\n}\n\nif (isset($_POST[\"change_area_and_back\"]))\n{\n\t$change_area = \"yes\";\n\t$change_done = \"yes\";\n}\n// memorisation du chemin de retour\nif (!isset($retour_page))\n{\n\t$retour_page = $back;\n\t// on nettoie la chaine :\n\t$long_chaine_a_supprimer = strlen(strstr($retour_page, \"&amp;msg=\")); // longueur de la chaine e partir de la premiere occurence de &amp;msg=\n\tif ($long_chaine_a_supprimer == 0)\n\t\t$long_chaine_a_supprimer = strlen(strstr($retour_page, \"?msg=\"));\n\t$long = strlen($retour_page) - $long_chaine_a_supprimer;\n\t$retour_page = substr($retour_page, 0, $long);\n}\n// modification d'une resource : admin ou gestionnaire\nif (authGetUserLevel(getUserName(),-1) < 6)\n{\n\tif (isset($room))\n\t{\n\t\t// Il s'agit d'une modif de ressource\n\t\tif (((authGetUserLevel(getUserName(),$room) < 3)) || (!verif_acces_ressource(getUserName(), $room)))\n\t\t{\n\t\t\tshowAccessDenied($back);\n\t\t\texit();\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (isset($area_id))\n\t\t{\n\t\t\t// On verifie que le domaine $area_id existe\n\t\t\t$test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE id='\".$area_id.\"'\");\n\t\t\tif ($test == -1)\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t\t// Il s'agit de l'ajout d'une ressource\n\t\t\t// On verifie que l'utilisateur a le droit d'ajouter des ressources\n\t\t\tif ((authGetUserLevel(getUserName(), $area_id, 'area') < 4))\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t}\n\t\telse if (isset($id_area))\n\t\t{\n\t\t\t// On verifie que le domaine $area existe\n\t\t\t$test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n\t\t\tif ($test == -1)\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t\t// Il s'agit de la modif d'un domaine\n\t\t\tif ((authGetUserLevel(getUserName(), $id_area, 'area') < 4))\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t}\n\t}\n}\n$msg ='';\n// Gestion des ressources\nif ((!empty($room)) || (isset($area_id)))\n{\n\t// Enregistrement d'une ressource\n\tif (isset($change_room))\n\t{\n\t\tif (isset($_POST['sup_img']))\n\t\t{\n\t\t\t$dest = '../images/';\n\t\t\t$ok1 = false;\n\t\t\tif ($f = @fopen(\"$dest/.test\", \"w\"))\n\t\t\t{\n\t\t\t\t@fputs($f, '<'.'?php $ok1 = true; ?'.'>');\n\t\t\t\t@fclose($f);\n\t\t\t\tinclude(\"$dest/.test\");\n\t\t\t}\n\t\t\tif (!$ok1)\n\t\t\t{\n\t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre supprimee : probleme d\\'\u00e9criture sur le repertoire. Veuillez signaler ce probl\u00e8me \u00e0 l\\'administrateur du serveur.\\\\n\";\n\t\t\t\t$ok = 'no';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".jpg\"))\n\t\t\t\t\tunlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".jpg\");\n\t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".png\"))\n\t\t\t\t\tunlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".png\");\n\t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".gif\"))\n\t\t\t\t\tunlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".gif\");\n\t\t\t\t$picture_room = \"\";\n\t\t\t}\n\t\t}\n\t\tif (empty($capacity))\n\t\t\t$capacity = 0;\n\t\tif ($capacity < 0)\n\t\t\t$capacity = 0;\n\t\tsettype($delais_max_resa_room,\"integer\");\n\t\tif ($delais_max_resa_room < 0)\n\t\t\t$delais_max_resa_room = -1;\n\t\tsettype($delais_min_resa_room,\"integer\");\n\t\tif ($delais_min_resa_room < 0)\n\t\t\t$delais_min_resa_room = 0;\n\t\tsettype($delais_option_reservation,\"integer\");\n\t\tif ($delais_option_reservation < 0)\n\t\t\t$delais_option_reservation = 0;\n\t\tif ($allow_action_in_past == '')\n\t\t\t$allow_action_in_past = 'n';\n\t\tif ($dont_allow_modify == '')\n\t\t\t$dont_allow_modify = 'n';\n\t\tif ((isset($room)) && !((isset($action) && ($action == \"duplique_room\"))))\n\t\t{\n\t\t\t$sql = \"UPDATE \".TABLE_PREFIX.\"_room SET\n\t\t\troom_name='\".protect_data_sql($room_name).\"',\n\t\t\tdescription='\".protect_data_sql($description).\"', \";\n\t\t\tif ($picture_room != '')\n\t\t\t\t$sql .= \"picture_room='\".protect_data_sql($picture_room).\"', \";\n\t\t\t$sql .= \"comment_room='\".protect_data_sql(corriger_caracteres($comment_room)).\"',\n\t\t\tshow_comment='\".$show_comment.\"',\n\t\t\tarea_id='\".$area_id.\"',\n\t\t\tshow_fic_room='\".$show_fic_room.\"',\n\t\t\tactive_ressource_empruntee = '\".$active_ressource_empruntee.\"',\n\t\t\tactive_cle = '\".$active_cle.\"',\n\t\t\tcapacity='\".$capacity.\"',\n\t\t\tdelais_max_resa_room='\".$delais_max_resa_room.\"',\n\t\t\tdelais_min_resa_room='\".$delais_min_resa_room.\"',\n\t\t\tdelais_option_reservation='\".$delais_option_reservation.\"',\n\t\t\tallow_action_in_past='\".$allow_action_in_past.\"',\n\t\t\tdont_allow_modify='\".$dont_allow_modify.\"',\n\t\t\tqui_peut_reserver_pour = '\".$qui_peut_reserver_pour.\"',\n\t\t\twho_can_see = '\".$who_can_see.\"',\n\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\ttype_affichage_reser='\".$type_affichage_reser.\"',\n\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\tmoderate='\".$moderate.\"',\n\t\t\tstatut_room='\".$statut_room.\"'\n\t\t\tWHERE id=$room\";\n\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t{\n\t\t\t\tfatal_error(0, get_vocab('update_room_failed') . grr_sql_error());\n\t\t\t\t$ok = 'no';\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$sql = \"insert into \".TABLE_PREFIX.\"_room\n\t\t\tSET room_name='\".protect_data_sql($room_name).\"',\n\t\t\tarea_id='\".$area_id.\"',\n\t\t\tdescription='\".protect_data_sql($description).\"',\n\t\t\tpicture_room='\".protect_data_sql($picture_room).\"',\n\t\t\tcomment_room='\".protect_data_sql(corriger_caracteres($comment_room)).\"',\n\t\t\tshow_fic_room='\".$show_fic_room.\"',\n\t\t\tactive_ressource_empruntee = '\".$active_ressource_empruntee.\"',\n\t\t\tactive_cle = '\".$active_cle.\"',\n\t\t\tcapacity='\".$capacity.\"',\n\t\t\tdelais_max_resa_room='\".$delais_max_resa_room.\"',\n\t\t\tdelais_min_resa_room='\".$delais_min_resa_room.\"',\n\t\t\tdelais_option_reservation='\".$delais_option_reservation.\"',\n\t\t\tallow_action_in_past='\".$allow_action_in_past.\"',\n\t\t\tdont_allow_modify='\".$dont_allow_modify.\"',\n\t\t\tqui_peut_reserver_pour = '\".$qui_peut_reserver_pour.\"',\n\t\t\twho_can_see = '\".$who_can_see.\"',\n\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\ttype_affichage_reser='\".$type_affichage_reser.\"',\n\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\tmoderate='\".$moderate.\"',\n\t\t\tstatut_room='\".$statut_room.\"'\";\n\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t\t$room = mysqli_insert_id($GLOBALS['db_c']);\n\t\t}\n\t\t#Si room_name est vide on le change maintenant que l'on a l'id room\n\t\tif ($room_name == '')\n\t\t{\n\t\t\t$room_name = get_vocab(\"room\").\" \".$room;\n\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_room SET room_name='\".protect_data_sql($room_name).\"' WHERE id=$room\");\n\t\t}\n\t\t$doc_file = isset($_FILES[\"doc_file\"]) ? $_FILES[\"doc_file\"] : NULL;\n\t\tif (preg_match(\"`\\.([^.]+)$`\", $doc_file['name'], $match))\n\t\t{\n\t\t\t$ext = strtolower($match[1]);\n\t\t\tif ($ext != 'jpg' && $ext != 'png'&& $ext != 'gif')\n\t\t\t{\n\t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : les seules extentions autorisees sont gif, png et jpg.\\\\n\";\n\t\t\t\t$ok = 'no';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$dest = '../images/';\n\t\t\t\t$ok1 = false;\n\t\t\t\tif ($f = @fopen(\"$dest/.test\", \"w\"))\n\t\t\t\t{\n\t\t\t\t\t@fputs($f, '<'.'?php $ok1 = true; ?'.'>');\n\t\t\t\t\t@fclose($f);\n\t\t\t\t\tinclude(\"$dest/.test\");\n\t\t\t\t}\n\t\t\t\tif (!$ok1)\n\t\t\t\t{\n\t\t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : probleme d\\'ecriture sur le repertoire IMAGES. Veuillez signaler ce probleme e l\\'administrateur du serveur.\\\\n\";\n\t\t\t\t\t$ok = 'no';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$ok1 = @copy($doc_file['tmp_name'], $dest.$doc_file['name']);\n\t\t\t\t\tif (!$ok1)\n\t\t\t\t\t\t$ok1 = @move_uploaded_file($doc_file['tmp_name'], $dest.$doc_file['name']);\n\t\t\t\t\tif (!$ok1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : probleme de transfert. Le fichier n\\'a pas pu etre transfere sur le repertoire IMAGES. Veuillez signaler ce probleme e l\\'administrateur du serveur.\\\\n\";\n\t\t\t\t\t\t$ok = 'no';\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$tab = explode(\".\", $doc_file['name']);\n\t\t\t\t\t\t$ext = strtolower($tab[1]);\n\t\t\t\t\t\tif (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext))\n\t\t\t\t\t\t\t@unlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext);\n\t\t\t\t\t\trename($dest.$doc_file['name'],$dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext);\n\t\t\t\t\t\t@chmod($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext, 0666);\n\t\t\t\t\t\t$picture_room = \"img_\".TABLE_PREFIX.\"\".$room.\".\".$ext;\n\t\t\t\t\t\t$sql_picture = \"UPDATE \".TABLE_PREFIX.\"_room SET picture_room='\".protect_data_sql($picture_room).\"' WHERE id=\".$room;\n\t\t\t\t\t\tif (grr_sql_command($sql_picture) < 0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfatal_error(0, get_vocab('update_room_failed') . grr_sql_error());\n\t\t\t\t\t\t\t$ok = 'no';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse if ($doc_file['name'] != '')\n\t\t{\n\t\t\t$msg .= \"L\\'image n\\'a pas pu etre enregistree : le fichier image selectionne n'est pas valide !\\\\n\";\n\t\t\t$ok = 'no';\n\t\t}\n\t\t$msg .= get_vocab(\"message_records\");\n\t}\n\t// Si pas de probleme, retour \u00e0 la page d'accueil apres enregistrement\n\tif ((isset($change_done)) && (!isset($ok)))\n\t{\n\t\tif ($msg != '')\n\t\t{\n\t\t\t$_SESSION['displ_msg'] = 'yes';\n\t\t\tif (strpos($retour_page, \".php?\") == \"\")\n\t\t\t\t$param = \"?msg=\".$msg;\n\t\t\telse\n\t\t\t\t$param = \"&msg=\".$msg;\n\t\t}\n\t\telse\n\t\t\t$param = '';\n\t\tHeader(\"Location: \".$retour_page.$param);\n\t\texit();\n\t}\n\t# print the page header\n\tstart_page_w_header(\"\", \"\", \"\", $type=\"with_session\");\n\taffiche_pop_up($msg,\"admin\");\n\tinclude \"admin_col_gauche2.php\";\n\techo \"<div class=\\\"col-md-9 col-sm-8 col-xs-12\\\">\";\n\t// affichage du formulaire\n\tif (isset($room))\n\t{\n\t\t// Il s'agit d'une modification d'une ressource\n\t\t$res = grr_sql_query(\"SELECT * FROM \".TABLE_PREFIX.\"_room WHERE id=$room\");\n\t\tif (! $res)\n\t\t\tfatal_error(0, get_vocab('error_room') . $room . get_vocab('not_found'));\n\t\t$row = grr_sql_row_keyed($res, 0);\n\t\tgrr_sql_free($res);\n\t\t$area_id = grr_sql_query1(\"select area_id from \".TABLE_PREFIX.\"_room where id='\".$room.\"'\");\n\t\t$area_name = grr_sql_query1(\"select area_name from \".TABLE_PREFIX.\"_area where id='\".$area_id.\"'\");\n\t\tif ($action == \"duplique_room\")\n\t\t\techo \"<h2>\".get_vocab(\"match_area\").get_vocab('deux_points').\" \".$area_name.\"<br />\".get_vocab(\"duplique_ressource\").\"</h2>\\n\";\n\t\telse\n\t\t\techo \"<h2>\".get_vocab(\"match_area\").get_vocab('deux_points').\" \".$area_name.\"<br />\".get_vocab(\"editroom\").\"</h2>\\n\";\n\t}\n\telse\n\t{\n\t\t// Il s'agit de l'enregistrement d'une nouvelle ressource\n\t\t$row['picture_room'] = '';\n\t\t$row[\"id\"] = '';\n\t\t$row[\"room_name\"]= '';\n\t\t$row[\"description\"] = '';\n\t\t$row['comment_room'] = '';\n\t\t$row['show_comment'] = 'n';\n\t\t$row[\"capacity\"]   = '';\n\t\t$row[\"delais_max_resa_room\"] = -1;\n\t\t$row[\"delais_min_resa_room\"] = 0;\n\t\t$row[\"delais_option_reservation\"] = 0;\n\t\t$row[\"allow_action_in_past\"] = 'n';\n\t\t$row[\"dont_allow_modify\"] = 'n';\n\t\t$row[\"qui_peut_reserver_pour\"] = 6;\n\t\t$row[\"who_can_see\"] = 0;\n\t\t$row[\"order_display\"]  = 0;\n\t\t$row[\"type_affichage_reser\"]  = 0;\n\t\t$row[\"max_booking\"] = -1;\n\t\t$row['statut_room'] = '';\n\t\t$row['moderate'] = '';\n\t\t$row['show_fic_room'] = '';\n\t\t$row['active_ressource_empruntee'] = 'n';\n\t\t$row['active_cle'] = 'n';\n\t\t$area_name = grr_sql_query1(\"select area_name from \".TABLE_PREFIX.\"_area where id='\".$area_id.\"'\");\n\t\techo \"<h2>\".get_vocab(\"match_area\").get_vocab('deux_points').\" \".$area_name.\"<br />\".get_vocab(\"addroom\").\"</h2>\\n\";\n\t}\n    echo '<form enctype=\"multipart/form-data\" action=\"admin_edit_room.php\" method=\"post\">';\n\techo \"<div>\";\n\t\tif (isset($action))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"duplique_room\\\" />\\n\";\n\t\tif ($row[\"id\"] != '')\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"room\\\" value=\\\"\".$row[\"id\"].\"\\\" />\\n\";\n\t\tif (isset($retour_page))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"retour_page\\\" value=\\\"\".$retour_page.\"\\\" />\\n\";\n\techo \"</div>\";\n    $nom_picture = '';\n    if ($row['picture_room'] != '') $nom_picture = \"../images/\".$row['picture_room'];\n    if (Settings::get(\"use_fckeditor\") == 1)\n        echo \"<script type=\\\"text/javascript\\\" src=\\\"../js/ckeditor/ckeditor.js\\\"></script>\\n\";\n    echo \"<table class='table table-bordered'>\\n\";\n\techo \"<tr><td>\".get_vocab(\"name\").get_vocab(\"deux_points\").\"</td><td>\\n\";\n    // seul l'administrateur peut modifier le nom de la ressource\n    if ((authGetUserLevel(getUserName(),$area_id,\"area\") >= 4) || (authGetUserLevel(getUserName(),$room) >= 4))\n        echo \"<input type=\\\"text\\\" name=\\\"room_name\\\" maxlength=\\\"60\\\" size=\\\"40\\\" value=\\\"\".htmlspecialchars($row[\"room_name\"]).\"\\\" />\\n\";\n    else\n    {\n        echo \"<input type=\\\"hidden\\\" name=\\\"room_name\\\" value=\\\"\".htmlspecialchars($row[\"room_name\"]).\"\\\" />\\n\";\n        echo \"<b>\".htmlspecialchars($row[\"room_name\"]).\"</b>\\n\";\n    }\n    echo \"</td></tr>\\n\";\n    // Description\n    echo \"<tr><td>\".get_vocab(\"description\").\"</td><td><input type=\\\"text\\\" name=\\\"description\\\"  maxlength=\\\"60\\\" size=\\\"40\\\" value=\\\"\".htmlspecialchars($row[\"description\"]).\"\\\" /></td></tr>\\n\";\n    // Domaine\n    $enable_periods = grr_sql_query1(\"select enable_periods from \".TABLE_PREFIX.\"_area where id='\".$area_id.\"'\");\n    if (((authGetUserLevel(getUserName(),$area_id,\"area\") >=4 ) || (authGetUserLevel(getUserName(),$room) >= 4)) && ($enable_periods == 'n'))\n    {    // les creneaux sont bases sur le temps : on ne peut pas changer une ressource de domaine\n        if(authGetUserLevel(getUserName(),-1,'area') >= 6)\n            $sql = \"SELECT id,area_name\n        FROM \".TABLE_PREFIX.\"_area where enable_periods='n'\n        ORDER BY area_name ASC\";\n        else if (authGetUserLevel(getUserName(),$area_id,'area') == 5)\n            $sql = \"SELECT distinct a.id, a.area_name\n        FROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j, \".TABLE_PREFIX.\"_site s,  \".TABLE_PREFIX.\"_j_useradmin_site u\n        WHERE a.id=j.id_area and u.id_site=j.id_site  and s.id=u.id_site and u.login='\".getUserName().\"'  and  enable_periods='n'\n        ORDER BY a.area_name ASC\";\n        else\n            $sql = \"SELECT id,area_name\n        FROM \".TABLE_PREFIX.\"_area a,  \".TABLE_PREFIX.\"_j_useradmin_area u\n        WHERE a.id=u.id_area and u.login='\".getUserName().\"' and  a.enable_periods='n'\n        ORDER BY a.area_name ASC\";\n        $res = grr_sql_query($sql);\n        $nb_area = grr_sql_count($res);\n        if ($nb_area > 1)\n        {\n            echo \"<tr><td>\".get_vocab('match_area').get_vocab('deux_points').\"</td>\\n\";\n            echo \"<td><select class=\\\"form-control\\\" name=\\\"area_id\\\" >\\n\n            <option value=\\\"-1\\\">\".get_vocab('choose_an_area').\"</option>\\n\";\n            for ($enr = 0; ($row1 = grr_sql_row($res, $enr)); $enr++)\n            {\n                echo \"<option value=\\\"\".$row1[0].\"\\\"\";\n                if ($area_id == $row1[0])\n                    echo ' selected=\"selected\"';\n                echo '>'.htmlspecialchars($row1[1]);\n                echo '</option>'.\"\\n\";\n            }\n        grr_sql_free($res);\n        echo \"</select></td></tr>\";\n        }\n        else\n        {\n            if (isset($area_id))\n                echo \"<input type=\\\"hidden\\\" name=\\\"area_id\\\" value=\\\"\".$area_id.\"\\\" />\\n\";\n        }\n    }\n    else\n    {  \t// les creneaux sont bases sur les intitules : on ne peut pas changer une ressource de domaine\n        if (isset($area_id))\n            echo \"<input type=\\\"hidden\\\" name=\\\"area_id\\\" value=\\\"\".$area_id.\"\\\" />\\n\";\n    }\n    // Ordre d'affichage du domaine\n    echo \"<tr><td>\".get_vocab(\"order_display\").get_vocab(\"deux_points\").\"</td>\\n\";\n    echo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"area_order\\\" size=\\\"1\\\" value=\\\"\".htmlspecialchars($row[\"order_display\"]).\"\\\" /></td>\\n\";\n    echo \"</tr>\\n\";\n    // Qui peut voir cette ressource\n    echo \"<tr><td colspan=\\\"2\\\">\".get_vocab(\"qui_peut_voir_ressource\").\"<br />\\n\";\n    echo \"<select class=\\\"form-control\\\" name=\\\"who_can_see\\\" size=\\\"1\\\">\\n\n    <option value=\\\"0\\\" \";\n    if ($row[\"who_can_see\"] == 0)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description0\").\"</option>\\n<option value=\\\"1\\\" \";\n    if ($row[\"who_can_see\"] == 1)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description1\").\"</option>\\n<option value=\\\"2\\\" \";\n    if ($row[\"who_can_see\"] == 2)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description2\").\"</option>\\n<option value=\\\"3\\\" \";\n    if ($row[\"who_can_see\"] == 3)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description3\").\"</option>\\n<option value=\\\"4\\\" \";\n    if ($row[\"who_can_see\"] == 4)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description4\").\"</option>\\n\";\n    if (Settings::get(\"module_multisite\") != \"Oui\")\n    {\n        echo \"<option value=\\\"5\\\" \";\n        if ($row[\"who_can_see\"] == 5)\n            echo \" selected=\\\"selected\\\" \";\n        echo \">\".get_vocab(\"visu_fiche_description5\").\"</option>\\n\";\n    };\n    echo \"<option value=\\\"6\\\" \";\n    if ($row[\"who_can_see\"] == 6)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description6\").\"</option>\\n</select></td></tr>\\n\";\n    // Declarer ressource indisponible\n    echo \"<tr><td>\".get_vocab(\"declarer_ressource_indisponible\").\"<br /><i>\".get_vocab(\"explain_max_booking\").\"</i></td><td><input type=\\\"checkbox\\\" name=\\\"statut_room\\\" \";\n    if ($row['statut_room'] == \"0\")\n        echo \" checked=\\\"checked\\\" \";\n    echo \"/></td></tr>\\n\";\n    // Afficher la fiche de presentation de la ressource\n    echo \"<tr><td>\".get_vocab(\"montrer_fiche_presentation_ressource\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"show_fic_room\\\" \";\n    if ($row['show_fic_room'] == \"y\")\n        echo \" checked=\\\"checked\\\" \";\n    echo \"/><a href='javascript:centrerpopup(\\\"../view_room.php?id_room=$room\\\",600,480,\\\"scrollbars=yes,statusbar=no,resizable=yes\\\")' title=\\\"\".get_vocab(\"fiche_ressource\").\"\\\"><span class=\\\"glyphicon glyphicon-search\\\"></span></a></td></tr>\\n\";\n    // Choix de l'image de la ressource\n    echo \"<tr><td>\".get_vocab(\"choisir_image_ressource\").\"</td><td><input type=\\\"file\\\" name=\\\"doc_file\\\" size=\\\"30\\\" /></td></tr>\\n\";\n    echo \"<tr><td>\".get_vocab(\"supprimer_image_ressource\").get_vocab(\"deux_points\");\n    if (@file_exists($nom_picture))\n    {\n        echo \"<b>$nom_picture</b></td><td><input type=\\\"checkbox\\\" name=\\\"sup_img\\\" /></td></tr>\";}\n    else\n        echo \"<b>\".get_vocab(\"nobody\").\"</b></td><td><input type=\\\"checkbox\\\" disabled=\\\"disabled\\\" name=\\\"sup_img\\\" /></td></tr>\";\n    echo \"<tr><td>\".get_vocab(\"Afficher_description_complete_dans_titre_plannings\").\"</td>\\n<td><input type=\\\"checkbox\\\" name=\\\"show_comment\\\" \";\n    if ($row['show_comment'] == \"y\")\n        echo \" checked \";\n    echo \"/></td></tr>\\n\";\n    // Description complete\n    echo \"<tr><td colspan=\\\"2\\\">\".get_vocab(\"description complete\");\n    if (Settings::get(\"use_fckeditor\") != 1)\n        echo \" \".get_vocab(\"description complete2\");\n    echo get_vocab(\"deux_points\").\"<br />\";\n    if (Settings::get(\"use_fckeditor\") == 1)\n    {\n        echo \"<textarea class=\\\"ckeditor\\\" id=\\\"editor1\\\" name=\\\"comment_room\\\" rows=\\\"8\\\" cols=\\\"120\\\">\\n\";\n        echo htmlspecialchars($row['comment_room']);\n        echo \"</textarea>\\n\";\n            ?>\n            <script type=\"text/javascript\">\n                CKEDITOR.replace( 'editor1',\n                {\n                    toolbar :\n                    [\n                    ['Source'],\n                    ['Cut','Copy','Paste','PasteText','PasteFromWord', 'SpellChecker', 'Scayt'],\n                    ['Undo','Redo','-','Find','Replace','-','SelectAll','RemoveFormat'],\n                    ['Bold','Italic','Underline','Strike','-','Subscript','Superscript'],\n                    ['NumberedList','BulletedList','-','Outdent','Indent','Blockquote'],\n                    ['JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'],\n                    ['Link','Unlink','Anchor'],\n                    ['Image','Table','HorizontalRule','SpecialChar','PageBreak'],\n                    ]\n                });\n            </script>\n            <?php\n        }\n        else\n            echo \"<textarea class=\\\"form-control\\\" name=\\\"comment_room\\\" rows=\\\"8\\\" cols=\\\"120\\\" >\".$row['comment_room'].\"</textarea>\";\n        echo \"</td></tr></table>\\n\";\n        echo \"<h3>\".get_vocab(\"configuration_ressource\").\"</h3>\\n\";\n// Type d'affichage : duree ou heure/date de fin de reservation\n        echo \"<table class='table table-bordered'>\\n\";\n\t\t\techo \"<tr><td>\".get_vocab(\"type_affichage_reservation\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td>\";\n\t\t\techo \"<label><input type=\\\"radio\\\" name=\\\"type_affichage_reser\\\" value=\\\"0\\\" \";\n\t\t\tif (($row[\"type_affichage_reser\"]) == 0)\n\t\t\t\techo \" checked=\\\"checked\\\" \";\n\t\t\techo \"/>\";\n\t\t\techo get_vocab(\"affichage_reservation_duree\");\n\t\t\techo \"</label><br /><label><input type=\\\"radio\\\" name=\\\"type_affichage_reser\\\" value=\\\"1\\\" \";\n\t\t\tif (($row[\"type_affichage_reser\"]) == 1)\n\t\t\t\techo \" checked=\\\"checked\\\" \";\n\t\t\techo \"/>\";\n\t\t\techo get_vocab(\"affichage_reservation_date_heure\");\n\t\t\techo \"</label></td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\n\t// Capacite\n\t\t\techo \"<tr><td>\".get_vocab(\"capacity\").\": </td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"capacity\\\" size=\\\"1\\\" value=\\\"\".$row[\"capacity\"].\"\\\" /></td></tr>\\n\";\n\t// seuls les administrateurs de la ressource peuvent modifier le nombre max de reservation par utilisateur\n\t\t\tif ((authGetUserLevel(getUserName(),$area_id,\"area\") >= 4) || (authGetUserLevel(getUserName(),$room) >= 4))\n\t\t\t{\n\t\t\t\techo \"<tr><td>\".get_vocab(\"max_booking\").\" \";\n\t\t\t\techo \"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"max_booking\\\" size=\\\"1\\\" value=\\\"\".$row[\"max_booking\"].\"\\\" /></td></tr>\";\n\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tif ($row[\"max_booking\"] != \"-1\")\n\t\t\t\t\techo \"<tr><td>\".get_vocab(\"msg_max_booking\").get_vocab(\"deux_points\").\"</td><td><b>\".htmlspecialchars($row[\"max_booking\"]).\"</b></td></tr>\";\n\t\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"max_booking\\\" value=\\\"\".$row[\"max_booking\"].\"\\\" />\";\n\t\t\t}\n// L'utilisateur ne peut pas reserver au-del\u00e0 d'un certain temps\n\t\t\techo \"<tr><td>\".get_vocab(\"delais_max_resa_room\").\": </td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"delais_max_resa_room\\\" size=\\\"1\\\" value=\\\"\".$row[\"delais_max_resa_room\"].\"\\\" /></td></tr>\\n\";\n// L'utilisateur ne peut pas reserver en-dessous d'un certain temps\n\t\t\techo \"<tr><td>\".get_vocab(\"delais_min_resa_room\").\": \";\n\t\t\techo \"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"delais_min_resa_room\\\" size=\\\"5\\\" value=\\\"\".$row[\"delais_min_resa_room\"].\"\\\" /></td></tr>\\n\";\n// L'utilisateur peut poser poser une option de reservation\n\t\t\techo \"<tr><td>\".get_vocab(\"msg_option_de_reservation\").\"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"delais_option_reservation\\\" size=\\\"5\\\" value=\\\"\".$row[\"delais_option_reservation\"].\"\\\" /></td></tr>\\n\";\n// Les demandes de reservations sont moder\u00e9es\n\t\t\techo \"<tr><td>\".get_vocab(\"msg_moderation_reservation\").get_vocab(\"deux_points\");\n\t\t\techo \"</td>\" .\"<td><input type='checkbox' name='moderate' \";\n\t\t\tif ($row['moderate'])\n\t\t\t\techo 'checked=\"checked\"';\n\t\t\techo \" /></td></tr>\\n\";\n// L'utilisateur peut reserver dans le passe\n\t\t\techo \"<tr><td>\".get_vocab(\"allow_action_in_past\").\"<br /><i>\".get_vocab(\"allow_action_in_past_explain\").\"</i></td><td><input type=\\\"checkbox\\\" name=\\\"allow_action_in_past\\\" value=\\\"y\\\" \";\n\t\t\tif ($row[\"allow_action_in_past\"] == 'y')\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" /></td></tr>\\n\";\n\t// L'utilisateur ne peut pas modifier ou supprimer ses propres reservations\n\t\t\techo \"<tr><td>\".get_vocab(\"dont_allow_modify\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"dont_allow_modify\\\" value=\\\"y\\\" \";\n\t\t\tif ($row[\"dont_allow_modify\"] == 'y')\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" /></td></tr>\\n\";\n\t// Quels utilisateurs ont le droit de reserver cette ressource au nom d'un autre utilisateur ?\n\t\t\techo \"<tr><td>\".get_vocab(\"qui peut reserver pour autre utilisateur\").\"</td><td><select class=\\\"form-control\\\" name=\\\"qui_peut_reserver_pour\\\" size=\\\"1\\\">\\n<option value=\\\"5\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==6)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"personne\").\"</option>\\n\n\t\t\t<option value=\\\"4\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==4)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"les administrateurs restreints\").\"</option>\\n\n\t\t\t<option value=\\\"3\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==3)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"les gestionnaires de la ressource\").\"</option>\\n\n\t\t\t<option value=\\\"2\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==2)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"tous les utilisateurs\").\"</option>\\n\n\t\t</select></td></tr>\\n\";\n// Activer la fonctionalite \"ressource empruntee/restituee\"\n\t\techo \"<tr><td>\".get_vocab(\"activer_fonctionalite_ressource_empruntee_restituee\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"active_ressource_empruntee\\\" \";\n\t\tif ($row['active_ressource_empruntee'] == \"y\")\n\t\t\techo \" checked=\\\"checked\\\" \";\n\t\techo \"/></td></tr>\\n\";\n// Activer la gestion des cl\u00e9s\n\t\techo \"<tr><td>\".get_vocab(\"activer_fonctionalite_gestion_cle\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"active_cle\\\" \";\n\t\tif ($row['active_cle'] == \"y\")\n\t\t\techo \" checked=\\\"checked\\\" \";\n\t\techo \"/></td></tr>\\n\";\n\t//\n\t\techo \"</table>\\n\";\n\t\tHook::Appel(\"hookEditRoom1\");\n\t\techo \"<div style=\\\"text-align:center;\\\"><br />\\n\";\n\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_room\\\"  value=\\\"\".get_vocab(\"save\").\"\\\" />\\n\";\n\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_done\\\" value=\\\"\".get_vocab(\"back\").\"\\\" />\\n\";\n\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_room_and_back\\\" value=\\\"\".get_vocab(\"save_and_back\").\"\\\" />\";\n\t\tif (@file_exists($nom_picture) && $nom_picture)\n\t\t\techo \"<br /><br /><b>\".get_vocab(\"Image de la ressource\").get_vocab(\"deux_points\").\"</b><br /><img src=\\\"\".$nom_picture.\"\\\" alt=\\\"logo\\\" />\";\n\t\telse\n\t\t\techo \"<br /><br /><b>\".get_vocab(\"Pas image disponible\").\"</b>\";\n\techo \"</div>\";\n    echo \"</form>\";\n    echo \"</div>\";\n}\n// Ajout ou modification d'un domaine\nif ((!empty($id_area)) || (isset($add_area)))\n{\n\tif (isset($change_area))\n\t{\n\t// Affectation e un site : si aucun site n'a ete affecte\n\t\tif ((Settings::get(\"module_multisite\") == \"Oui\") && ($id_site == -1))\n\t\t{\n\t  \t\t// On affiche un message d'avertissement\n\t\t\t?>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\talert(\"<?php echo get_vocab('choose_a_site'); ?>\");\n\t\t\t</script>\n\t\t\t<?php\n\t  \t\t// On empeche le retour e la page admin_room\n\t\t\tunset($change_done);\n\t\t}\n\t\telse\n\t\t{\n\t  \t\t// Un site a ete affecte, on peut continuer\n\t \t\t// la valeur par defaut ne peut etre inferiure au plus petit bloc reservable\n\t\t\tif ($_POST['duree_par_defaut_reservation_area'] < $_POST['resolution_area'])\n\t\t\t\t$_POST['duree_par_defaut_reservation_area'] = $_POST['resolution_area'];\n\t\t\t// la valeur par defaut doit etre un multiple du plus petit bloc reservable\n\t\t\t$_POST['duree_par_defaut_reservation_area'] = intval($_POST['duree_par_defaut_reservation_area'] / $_POST['resolution_area']) * $_POST['resolution_area'];\n\t  \t\t// Duree maximale de reservation\n\t\t\tif (isset($_POST['enable_periods']))\n\t\t\t{\n\t\t\t\tif ($_POST['enable_periods'] == 'y')\n\t\t\t\t\t$duree_max_resa_area = $duree_max_resa_area2 * 1440;\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$duree_max_resa_area = $duree_max_resa_area1;\n\t\t\t\t\tif ($duree_max_resa_area >= 0)\n\t\t\t\t\t\t$duree_max_resa_area = max ($duree_max_resa_area, $_POST['resolution_area'] / 60, $_POST['duree_par_defaut_reservation_area'] / 60);\n\t\t\t\t}\n\t\t\t\tsettype($duree_max_resa_area, \"integer\");\n\t\t\t\tif ($duree_max_resa_area < 0)\n\t\t\t\t\t$duree_max_resa_area = -1;\n\t\t\t}\n\n\t\t\t$display_days = \"\";\n\t\t\tfor ($i = 0; $i < 7; $i++)\n\t\t\t{\n\t\t\t\tif (isset($_POST['display_day'][$i]))\n\t\t\t\t\t$display_days .= \"y\";\n\t\t\t\telse\n\t\t\t\t\t$display_days .= \"n\";\n\t\t\t}\n\t\t\tif ($display_days != \"nnnnnnn\")\n\t\t\t{\n\t\t\t\twhile (!isset($_POST['display_day'][$_POST['weekstarts_area']]))\n\t\t\t\t\t$_POST['weekstarts_area']++;\n\t\t\t}\n\t\t\tif ($_POST['morningstarts_area'] > $_POST['eveningends_area'])\n\t\t\t\t$_POST['eveningends_area'] = $_POST['morningstarts_area'];\n\t\t\tif ($access)\n\t\t\t\t$access='r';\n\t\t\telse\n\t\t\t\t$access='a';\n\t\t\tif ((isset($id_area)) && !((isset($action) && ($action == \"duplique_area\"))))\n\t\t\t{\n\t\t\t\t// s'il y a changement de type de creneaux, on efface les reservations du domaines\n\t\t\t\t$old_enable_periods = grr_sql_query1(\"select enable_periods from \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n\t\t\t\tif ($old_enable_periods != $_POST['enable_periods'])\n\t\t\t\t{\n\t\t\t\t\t$del = grr_sql_query(\"DELETE \".TABLE_PREFIX.\"_entry FROM \".TABLE_PREFIX.\"_entry, \".TABLE_PREFIX.\"_room, \".TABLE_PREFIX.\"_area WHERE\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_entry.room_id = \".TABLE_PREFIX.\"_room.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_room.area_id = \".TABLE_PREFIX.\"_area.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_area.id = '\".$id_area.\"'\");\n\t\t\t\t\t$del = grr_sql_query(\"DELETE \".TABLE_PREFIX.\"_repeat FROM \".TABLE_PREFIX.\"_repeat, \".TABLE_PREFIX.\"_room, \".TABLE_PREFIX.\"_area WHERE\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_repeat.room_id = \".TABLE_PREFIX.\"_room.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_room.area_id = \".TABLE_PREFIX.\"_area.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_area.id = '\".$id_area.\"'\");\n\t\t\t\t}\n\t\t\t\t$sql = \"UPDATE \".TABLE_PREFIX.\"_area SET\n\t\t\t\tarea_name='\".protect_data_sql($area_name).\"',\n\t\t\t\taccess='\".protect_data_sql($access).\"',\n\t\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\t\tip_adr='\".protect_data_sql($ip_adr).\"',\n\t\t\t\tcalendar_default_values = 'n',\n\t\t\t\tduree_max_resa_area = '\".protect_data_sql($duree_max_resa_area).\"',\n\t\t\t\tmorningstarts_area = '\".protect_data_sql($_POST['morningstarts_area']).\"',\n\t\t\t\teveningends_area = '\".protect_data_sql($_POST['eveningends_area']).\"',\n\t\t\t\tresolution_area = '\".protect_data_sql($_POST['resolution_area']).\"',\n\t\t\t\tduree_par_defaut_reservation_area = '\".protect_data_sql($_POST['duree_par_defaut_reservation_area']).\"',\n\t\t\t\teveningends_minutes_area = '\".protect_data_sql($_POST['eveningends_minutes_area']).\"',\n\t\t\t\tweekstarts_area = '\".protect_data_sql($_POST['weekstarts_area']).\"',\n\t\t\t\tenable_periods = '\".protect_data_sql($_POST['enable_periods']).\"',\n\t\t\t\ttwentyfourhour_format_area = '\".protect_data_sql($_POST['twentyfourhour_format_area']).\"',\n\t\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\t\tdisplay_days = '\".$display_days.\"'\n\t\t\t\tWHERE id=$id_area\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t{\n\t\t\t\t\tfatal_error(0, get_vocab('update_area_failed') . grr_sql_error());\n\t\t\t\t\t$ok = 'no';\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_area SET\n\t\t\t\tarea_name='\".protect_data_sql($area_name).\"',\n\t\t\t\taccess='\".protect_data_sql($access).\"',\n\t\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\t\tip_adr='\".protect_data_sql($ip_adr).\"',\n\t\t\t\tcalendar_default_values = 'n',\n\t\t\t\tduree_max_resa_area = '\".protect_data_sql($duree_max_resa_area).\"',\n\t\t\t\tmorningstarts_area = '\".protect_data_sql($_POST['morningstarts_area']).\"',\n\t\t\t\teveningends_area = '\".protect_data_sql($_POST['eveningends_area']).\"',\n\t\t\t\tresolution_area = '\".protect_data_sql($_POST['resolution_area']).\"',\n\t\t\t\tduree_par_defaut_reservation_area = '\".protect_data_sql($_POST['duree_par_defaut_reservation_area']).\"',\n\t\t\t\teveningends_minutes_area = '\".protect_data_sql($_POST['eveningends_minutes_area']).\"',\n\t\t\t\tweekstarts_area = '\".protect_data_sql($_POST['weekstarts_area']).\"',\n\t\t\t\tenable_periods = '\".protect_data_sql($_POST['enable_periods']).\"',\n\t\t\t\ttwentyfourhour_format_area = '\".protect_data_sql($_POST['twentyfourhour_format_area']).\"',\n\t\t\t\tdisplay_days = '\".$display_days.\"',\n\t\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\t\tid_type_par_defaut = '-1'\n\t\t\t\t\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t\t\t$id_area = grr_sql_insert_id();\n\t\t\t}\n\t  \t\t// Affectation e un site\n\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t{\n\t\t\t\t$sql = \"delete from \".TABLE_PREFIX.\"_j_site_area where id_area='\".$id_area.\"'\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t\tfatal_error(0, \"<p>\".grr_sql_error().\"</p>\");\n\t\t\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_j_site_area SET id_site='\".$id_site.\"', id_area='\".$id_area.\"'\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t\tfatal_error(0, \"<p>\".grr_sql_error().\"</p>\");\n\t\t\t}\n\t\t\t#Si area_name est vide on le change maintenant que l'on a l'id area\n\t\t\tif ($area_name == '')\n\t\t\t{\n\t\t\t\t$area_name = get_vocab(\"match_area\").\" \".$id_area;\n\t\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_area SET area_name='\".protect_data_sql($area_name).\"' WHERE id=$id_area\");\n\t\t\t}\n\t\t  \t#on cree ou recree \".TABLE_PREFIX.\"_area_periodes pour le domaine\n\t\t\tif (protect_data_sql($_POST['enable_periods']) == 'y')\n\t\t\t{\n\t\t\t\tif (isset($number_periodes))\n\t\t\t\t{\n\t\t\t\t\tsettype($number_periodes, \"integer\");\n\t\t\t\t\tif ($number_periodes < 1)\n\t\t\t\t\t\t$number_periodes = 1;\n\t\t\t\t\t$del_periode = grr_sql_query(\"delete from \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"'\");\n\t\t  \t\t\t#on efface le modele par defaut avec area=0\n\t\t\t\t\t$del_periode = grr_sql_query(\"delete from \".TABLE_PREFIX.\"_area_periodes where id_area='0'\");\n\t\t\t\t\t$i = 0;\n\t\t\t\t\t$num = 0;\n\t\t\t\t\twhile ($i < $number_periodes)\n\t\t\t\t\t{\n\t\t\t\t\t\t$temp = \"periode_\".$i;\n\t\t\t\t\t\tif (isset($_POST[$temp]))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$nom_periode = corriger_caracteres($_POST[$temp]);\n\t\t\t\t\t\t\t$reg_periode = grr_sql_query(\"insert into \".TABLE_PREFIX.\"_area_periodes set\n\t\t\t\t\t\t\t\tid_area='\".$id_area.\"',\n\t\t\t\t\t\t\t\tnum_periode='\".$num.\"',\n\t\t\t\t\t\t\t\tnom_periode='\".protect_data_sql($nom_periode).\"'\n\t\t\t\t\t\t\t\t\");\n\t\t\t  \t\t\t\t#on cree un modele par defaut avec area=0\n\t\t\t\t\t\t\t$reg_periode = grr_sql_query(\"insert into \".TABLE_PREFIX.\"_area_periodes set\n\t\t\t\t\t\t\t\tid_area='0',\n\t\t\t\t\t\t\t\tnum_periode='\".$num.\"',\n\t\t\t\t\t\t\t\tnom_periode='\".protect_data_sql($nom_periode).\"'\");\n\t\t\t\t\t\t\t$num++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$msg = get_vocab(\"message_records\");\n\t\t}\n\t}\n\tif ($access=='a')\n\t{\n\t\t$sql = \"DELETE FROM \".TABLE_PREFIX.\"_j_user_area WHERE id_area='$id_area'\";\n\t\tif (grr_sql_command($sql) < 0)\n\t\t\tfatal_error(0, get_vocab('update_area_failed') . grr_sql_error());\n\t}\n\tif ((isset($change_done)) && (!isset($ok)))\n\t{\n\t\tif ($msg != '') {\n\t\t\t$_SESSION['displ_msg'] = 'yes';\n\t\t\tif (strpos($retour_page, \".php?\") == \"\")\n\t\t\t\t$param = \"?msg=\".$msg;\n\t\t\telse\n\t\t\t\t$param = \"&msg=\".$msg;\n\t\t} else\n\t\t$param = '';\n\t\tHeader(\"Location: \".$retour_page.$param);\n\t\texit();\n\t}\n  \t# print the page header\n\tstart_page_w_header(\"\", \"\", \"\", $type=\"with_session\");\n\taffiche_pop_up($msg,\"admin\");\n\t$avertissement = get_vocab(\"avertissement_change_type\");\n\tinclude \"admin_col_gauche2.php\";\n\t?>\n\t<script type=\"text/javascript\">\n\t\tfunction bascule()\n\t\t{\n\t\t\tmenu_1 = document.getElementById('menu1');\n\t\t\tmenu_2 = document.getElementById('menu2');\n\t\t\tif (document.getElementById('main').enable_periods[0].checked)\n\t\t\t{\n\t\t\t\tmenu_1.style.display = \"\";\n\t\t\t\tmenu_2.style.display = \"none\";\n\t\t\t}\n\t\t\tif (document.getElementById('main').enable_periods[1].checked)\n\t\t\t{\n\t\t\t\tmenu_1.style.display = \"none\";\n\t\t\t\tmenu_2.style.display = \"\";\n\t\t\t}\n\t\t\talert(\"<?php echo $avertissement; ?>\");\n\t\t}\n\n\t\tfunction aff_creneaux()\n\t\t{\n\t\t\tnb_cr = document.getElementById('nb_per');\n\t\t\tif (isNaN(Number(nb_cr.value)))\n\t\t\t\tnb_cr.value = 1;\n\t\t\tif (nb_cr.value > 50)\n\t\t\t\tnb_cr.value = 50;\n\t\t\tif (nb_cr.value < 1)\n\t\t\t\tnb_cr.value = 1;\n\t\t\tfor (var i = 1; i <= nb_cr.value; i++)\n\t\t\t{\n\t\t\t\tdocument.getElementById('c' + i).style.display = '';\n\t\t\t}\n\t\t\tfor (var i; i <= 50; i++)\n\t\t\t{\n\t\t\t\tdocument.getElementById('c' + i).style.display = 'none';\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t</script>\n\t<?php\n\techo \"<div class=\\\"col-md-9 col-sm-8 col-xs-12\\\">\";\n\tif (isset($id_area))\n\t{\n\t\t$res = grr_sql_query(\"SELECT * FROM \".TABLE_PREFIX.\"_area WHERE id=$id_area\");\n\t\tif (! $res)\n\t\t\tfatal_error(0, get_vocab('error_area') . $id_area . get_vocab('not_found'));\n\t\t$row = grr_sql_row_keyed($res, 0);\n\t\tgrr_sql_free($res);\n\t\tif ($action==\"duplique_area\")\n\t\t\techo \"<h2>\".get_vocab(\"duplique_domaine\").\"</h2>\";\n\t\telse\n\t\t\techo \"<h2>\".get_vocab(\"editarea\").\"</h2>\";\n\t\tif ($row[\"calendar_default_values\"] == 'y')\n\t\t{\n\t\t\t$row[\"morningstarts_area\"] = $morningstarts;\n\t\t\t$row[\"eveningends_area\"] = $eveningends;\n\t\t\t$row[\"resolution_area\"] = $resolution;\n\t\t\t$row[\"duree_par_defaut_reservation_area\"] = $duree_par_defaut_reservation_area;\n\t\t\t$row[\"duree_max_resa_area\"] = $duree_max_resa;\n\t\t\t$row[\"eveningends_minutes_area\"] = $eveningends_minutes;\n\t\t\t$row[\"weekstarts_area\"] = $weekstarts;\n\t\t\t$row[\"twentyfourhour_format_area\"] = $twentyfourhour_format;\n\t\t\t$row[\"display_days\"] = $display_days;\n\t\t}\n\t\tif ($row[\"enable_periods\"] != 'y')\n\t\t\t$row[\"enable_periods\"] = 'n';\n\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t$id_site=grr_sql_query1(\"select id_site from \".TABLE_PREFIX.\"_j_site_area where id_area='\".$id_area.\"'\");\n\t}\n\telse\n\t{\n\t\t$row[\"id\"] = '';\n\t\t$row[\"area_name\"] = '';\n\t\t$row[\"order_display\"]  = '';\n\t\t$row[\"access\"] = '';\n\t\t$row[\"ip_adr\"] = '';\n\t\t$row[\"morningstarts_area\"] = $morningstarts;\n\t\t$row[\"eveningends_area\"] = $eveningends;\n\t\t$row[\"resolution_area\"] = $resolution;\n\t\t$row[\"duree_par_defaut_reservation_area\"] = $resolution;\n\t\t$row[\"duree_max_resa_area\"] = $duree_max_resa;\n\t\t$row[\"eveningends_minutes_area\"] = $eveningends_minutes;\n\t\t$row[\"weekstarts_area\"] = $weekstarts;\n\t\t$row[\"twentyfourhour_format_area\"] = $twentyfourhour_format;\n\t\t$row[\"enable_periods\"] = 'n';\n\t\t$row[\"display_days\"] = \"yyyyyyy\";\n\t\t$row['max_booking'] = '-1';\n\t\techo \"<h2>\".get_vocab('addarea').\"</h2>\";\n\t}\n\techo '<form action=\"admin_edit_room.php\" method=\"post\" id=\"main\">';\n\techo \"<div>\";\n\t\tif (isset($action))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"duplique_area\\\" />\\n\";\n\t\tif (isset($retour_page))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"retour_page\\\" value=\\\"\".$retour_page.\"\\\" />\";\n\t\tif ($row['id'] != '')\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"id_area\\\" value=\\\"\".$row[\"id\"].\"\\\" />\";\n\t\tif (isset($add_area))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"add_area\\\" value=\\\"\".$add_area.\"\\\" />\\n\";\n\t\techo \"</div>\";\n\t\techo \"<table class='table table-bordered'><tr>\";\n\t\t// Nom du domaine\n\t\techo \"<td>\".get_vocab(\"name\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td style=\\\"width:30%;\\\"><input type=\\\"text\\\" name=\\\"area_name\\\" maxlength=\\\"30\\\" size=\\\"40\\\" value=\\\"\".htmlspecialchars($row[\"area_name\"]).\"\\\" /></td>\\n\";\n\t\techo \"</tr><tr>\\n\";\n\t\t// Ordre d'affichage du domaine\n\t\techo \"<td>\".get_vocab(\"order_display\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td><input type=\\\"text\\\" name=\\\"area_order\\\" size=\\\"1\\\" value=\\\"\".htmlspecialchars($row[\"order_display\"]).\"\\\" /></td>\\n\";\n\t\techo \"</tr><tr>\\n\";\n\t\t// Acces restreint ou non ?\n\t\techo \"<td>\".get_vocab(\"access\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td><input type=\\\"checkbox\\\" name=\\\"access\\\"\";\n\t\tif ($row[\"access\"] == 'r')\n\t\t\techo \"checked=\\\"checked\\\"\";\n\t\techo \" /></td>\\n\";\n\t\techo \"</tr>\";\n\t\t// Site\n\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t{\n\t  \t// Affiche une liste deroulante des sites;\n\t\t\tif (authGetUserLevel(getUserName(), -1, 'area') >= 6)\n\t\t\t\t$sql = \"SELECT id,sitecode,sitename\n\t\t\tFROM \".TABLE_PREFIX.\"_site\n\t\t\tORDER BY sitename ASC\";\n\t\t\telse\n\t\t\t\t$sql = \"SELECT id,sitecode,sitename\n\t\t\tFROM \".TABLE_PREFIX.\"_site s,  \".TABLE_PREFIX.\"_j_useradmin_site u\n\t\t\tWHERE s.id=u.id_site and u.login='\".getUserName().\"'\n\t\t\tORDER BY s.sitename ASC\";\n\t\t\t$res = grr_sql_query($sql);\n\t\t\t$nb_site = grr_sql_count($res);\n\t\t\techo \"<tr><td>\".get_vocab('site').get_vocab('deux_points').\"</td>\\n\";\n\t\t\tif ($nb_site > 1)\n\t\t\t{\n\t\t\t\techo \"<td><select class=\\\"form-control\\\" name=\\\"id_site\\\" >\\n\n\t\t\t\t<option value=\\\"-1\\\">\".get_vocab('choose_a_site').\"</option>\\n\";\n\t\t\t\tfor ($enr = 0; ($row1 = grr_sql_row($res, $enr)); $enr++)\n\t\t\t\t{\n\t\t\t\t\techo \"<option value=\\\"\".$row1[0].\"\\\"\";\n\t\t\t\t\tif ($id_site == $row1[0])\n\t\t\t\t\t\techo ' selected=\"selected\"';\n\t\t\t\t\techo '>'.htmlspecialchars($row1[2]);\n\t\t\t\t\techo '</option>'.\"\\n\";\n\t\t\t\t}\n\t\t\t\tgrr_sql_free($res);\n\t\t\t\techo \"</select></td></tr>\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// un seul site\n\t\t\t\t$row1 = grr_sql_row($res, 0);\n\t\t\t\techo \"<td>\".$row1[2].\"<input type=\\\"hidden\\\" name=\\\"id_site\\\" value=\\\"\".$id_site.\"\\\" /></td></tr>\\n\";\n\t\t\t}\n\t\t}\n\t\t// Adresse IP client :\n\t\tif (OPTION_IP_ADR == 1)\n\t\t{\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"ip_adr\").get_vocab(\"deux_points\").\"</td>\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"ip_adr\\\" value=\\\"\".htmlspecialchars($row[\"ip_adr\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td colspan=\\\"2\\\">\".get_vocab(\"ip_adr_explain\").\"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\t\techo \"</table>\";\n\t\t// Configuration des plages horaires ...\n\t\techo \"<h3>\".get_vocab(\"configuration_plages_horaires\").\"</h3>\";\n\t\t// Debut de la semaine: 0 pour dimanche, 1 pou lundi, etc.\n\t\techo \"<table class='table table-bordered'>\";\n\t\techo \"<tr>\\n\";\n\t\techo \"<td>\".get_vocab(\"weekstarts_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td style=\\\"width:30%;\\\"><select class=\\\"form-control\\\" name=\\\"weekstarts_area\\\" size=\\\"1\\\">\\n\";\n\t\t$k = 0;\n\t\twhile ($k < 7)\n\t\t{\n\t\t\t$tmp=mktime(0, 0, 0, 10, 2 + $k, 2005);\n\t\t\techo \"<option value=\\\"\".$k.\"\\\" \";\n\t\t\tif ($k == $row['weekstarts_area'])\n\t\t\t\techo \" selected=\\\"selected\\\"\";\n\t\t\techo \">\".utf8_strftime(\"%A\", $tmp).\"</option>\\n\";\n\t\t\t$k++;\n\t\t}\n\t\techo \"</select></td>\\n\";\n\t\techo \"</tr>\";\n\t\t// Definition des jours de la semaine e afficher sur les plannings et calendriers\n\t\techo \"<tr>\\n\";\n\t\techo \"<td>\".get_vocab(\"cocher_jours_a_afficher\").\"</td>\\n\";\n\t\techo \"<td>\\n\";\n\t\tfor ($i = 0; $i < 7; $i++)\n\t\t{\n\t\t\techo \"<label><input name=\\\"display_day[\".$i.\"]\\\" type=\\\"checkbox\\\"\";\n\t\t\tif (substr($row[\"display_days\"], $i, 1) == 'y')\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" />\" . day_name($i) . \"</label><br />\\n\";\n\t\t}\n\t\techo \"</td>\\n\";\n\t\techo \"</tr></table>\";\n\t\techo \"<h3>\".get_vocab(\"type_de_creneaux\").\"</h3>\";\n\t\techo \"<div class='left'>\";\n\t\t//echo \"<p style=\\\"text-align:left;\\\"><b>ATTENTION :</b> Les deux types de configuration des creneaux sont incompatibles entre eux : un changement du type de creneaux entraene donc, apres validation, un <b>effacement de toutes les reservations  de ce domaine</b></p>.\";\n\t\techo \"<label><input type=\\\"radio\\\" name=\\\"enable_periods\\\" value=\\\"n\\\" onclick=\\\"bascule()\\\" \";\n\t\tif ($row[\"enable_periods\"] == 'n')\n\t\t\techo \"checked=\\\"checked\\\"\";\n\t\techo \" />\".get_vocab(\"creneaux_de_reservation_temps\").\"</label><br />\";\n\t\techo \"<label><input type=\\\"radio\\\" name=\\\"enable_periods\\\" value=\\\"y\\\" onclick=\\\"bascule()\\\" \";\n\t\tif ($row[\"enable_periods\"] == 'y')\n\t\t\techo \"checked=\\\"checked\\\"\";\n\t\techo \" />\".get_vocab(\"creneaux_de_reservation_pre_definis\").\"</label></div>\";\n\t\t//Les creneaux de reservation sont bases sur des intitules pre-definis.\n\t\t$sql_periode = grr_sql_query(\"SELECT num_periode, nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"' order by num_periode\");\n\t\t$num_periodes = grr_sql_count($sql_periode);\n\t\tif (!isset($number_periodes))\n\t\t\tif ($num_periodes == 0)\n\t\t\t\t$number_periodes = 10;\n\t\t\telse\n\t\t\t\t$number_periodes = $num_periodes;\n\n\t\t\tif ($row[\"enable_periods\"] == 'y')\n\t\t\t\techo \"<table id=\\\"menu2\\\" class=\\\"table table-bordered\\\">\";\n\t\t\telse\n\t\t\t\techo \"<table style=\\\"display:none\\\" id=\\\"menu2\\\" class='table table-bordered'>\";\n\t\t\techo \"<tr><td>\".get_vocab(\"nombre_de_creneaux\").get_vocab(\"deux_points\").\"</td>\";\n\t\t\techo \"<td style=\\\"width:30%;\\\"><input type=\\\"text\\\" id=\\\"nb_per\\\" name=\\\"number_periodes\\\" size=\\\"1\\\" onkeypress=\\\"if (event.keyCode==13) return aff_creneaux()\\\" value=\\\"$number_periodes\\\" />\n\t\t\t<a href=\\\"#Per\\\" onclick=\\\"javascript:return(aff_creneaux())\\\">\".get_vocab(\"goto\").\"</a>\\n\";\n\t\t\techo \"</td></tr>\\n<tr><td colspan=\\\"2\\\">\";\n\t\t\t$i = 0;\n\t\t\twhile ($i < 50)\n\t\t\t{\n\t\t\t\t$nom_periode = grr_sql_query1(\"select nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"' and num_periode= '\".$i.\"'\");\n\t\t\t\tif ($nom_periode == -1)\n\t\t\t\t\t$nom_periode = \"\";\n\t\t\t\techo \"<table style=\\\"display:none\\\" id=\\\"c\".($i+1).\"\\\"><tr><td>\".get_vocab(\"intitule_creneau\").($i+1).get_vocab(\"deux_points\").\"</td>\";\n\t\t\t\techo \"<td style=\\\"width:30%;\\\"><input type=\\\"text\\\" name=\\\"periode_\".$i.\"\\\" value=\\\"\".htmlentities($nom_periode).\"\\\" size=\\\"20\\\" /></td></tr></table>\\n\";\n\t\t\t\t$i++;\n\t\t\t}\n\t\t\t// L'utilisateur ne peut reserver qu'une duree limitee (-1 desactivee), exprimee en jours\n\t\t\tif ($row[\"duree_max_resa_area\"] > 0)\n\t\t\t\t$nb_jour = max(round($row[\"duree_max_resa_area\"]/1440,0),1);\n\t\t\telse\n\t\t\t\t$nb_jour = -1;\n\t\t\techo \"</td></tr>\\n<tr><td>\".get_vocab(\"duree_max_resa_area2\").get_vocab(\"deux_points\");\n\t\t\techo \"\\n</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"duree_max_resa_area2\\\" size=\\\"5\\\" value=\\\"\".$nb_jour.\"\\\" /></td></tr>\\n\";\n\t\t\techo \"</table>\";\n\t\t\t// Cas ou les creneaux de reservations sont bases sur le temps\n\t\t\tif ($row[\"enable_periods\"] == 'n')\n\t\t\t\techo \"<table id=\\\"menu1\\\" class='table table-bordered'>\";\n\t\t\telse\n\t\t\t\techo \"<table style=\\\"display:none\\\" id=\\\"menu1\\\" class='table table-bordered'>\";\n\t\t\t// Heure de debut de reservation\n\t\t\techo \"<tr>\";\n\t\t\techo \"<td>\".get_vocab(\"morningstarts_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td style=\\\"width:30%;\\\"><select class=\\\"form-control\\\" name=\\\"morningstarts_area\\\" size=\\\"1\\\">\\n\";\n\t\t\t$k = 0;\n\t\t\twhile ($k < 24)\n\t\t\t{\n\t\t\t\techo \"<option value=\\\"\".$k.\"\\\" \";\n\t\t\t\tif ($k == $row['morningstarts_area']) echo \" selected=\\\"selected\\\"\";\n\t\t\t\techo \">\".$k.\"</option>\\n\";\n\t\t\t\t$k++;\n\t\t\t}\n\t\t\techo \"</select></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Heure de fin de reservation\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"eveningends_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><select class=\\\"form-control\\\" name=\\\"eveningends_area\\\" size=\\\"1\\\">\\n\";\n\t\t\t$k = 0;\n\t\t\twhile ($k < 24)\n\t\t\t{\n\t\t\t\techo \"<option value=\\\"\".$k.\"\\\" \";\n\t\t\t\tif ($k == $row['eveningends_area']) echo \" selected=\\\"selected\\\"\";\n\t\t\t\techo \">\".$k.\"</option>\\n\";\n\t\t\t\t$k++;\n\t\t\t}\n\t\t\techo \"</select></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Minutes e ajouter e l'heure $eveningends pour avoir la fin reelle d'une journee.\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"eveningends_minutes_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"eveningends_minutes_area\\\" size=\\\"5\\\" value=\\\"\".htmlspecialchars($row[\"eveningends_minutes_area\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Resolution - quel bloc peut etre reserve, en secondes\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"resolution_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"resolution_area\\\" size=\\\"5\\\" value=\\\"\".htmlspecialchars($row[\"resolution_area\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Valeur par defaut de la duree d'une reservation\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"duree_par_defaut_reservation_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"duree_par_defaut_reservation_area\\\" size=\\\"5\\\" value=\\\"\".htmlspecialchars($row[\"duree_par_defaut_reservation_area\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Format d'affichage du temps : valeur 0 pour un affichage ee12 heuresee et valeur 1 pour un affichage  ee24 heureee.\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"twentyfourhour_format_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td>\\n\";\n\t\t\techo \"<label><input type=\\\"radio\\\" name=\\\"twentyfourhour_format_area\\\" value=\\\"0\\\" \";\n\t\t\tif ($row['twentyfourhour_format_area'] == 0)\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" />\".get_vocab(\"twentyfourhour_format_12\").\"</label>\\n<br />\";\n\t\t\techo \"<label><input type=\\\"radio\\\" name=\\\"twentyfourhour_format_area\\\" value=\\\"1\\\" \";\n\t\t\tif ($row['twentyfourhour_format_area'] == 1)\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" />\".get_vocab(\"twentyfourhour_format_24\").\"</label>\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\t// L'utilisateur ne peut reserver qu'une duree limitee (-1 desactivee), exprimee en minutes\n\t\t\techo \"<tr>\\n<td>\".get_vocab(\"duree_max_resa_area\").get_vocab(\"deux_points\");\n\t\t\techo \"</td>\\n<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"duree_max_resa_area1\\\" size=\\\"5\\\" value=\\\"\".$row[\"duree_max_resa_area\"].\"\\\" /></td></tr>\\n\";\n\t\t\t// Nombre max de reservation par domaine\n\t\t\techo \"<tr><td>\".get_vocab(\"max_booking\").\" -  \".get_vocab(\"all_rooms_of_area\").get_vocab(\"deux_points\");\n\t\t\techo \"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"max_booking\\\" value=\\\"\".$row['max_booking'].\"\\\" /></td>\\n\";\n\t\t\techo \"</tr></table>\";\n\t\t\tHook::Appel(\"hookEditArea1\");\n\t\t\techo \"<div class=\\\"center\\\">\\n\";\n\t\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_area\\\" value=\\\"\".get_vocab(\"save\").\"\\\" />\\n\";\n\t\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_done\\\" value=\\\"\".get_vocab(\"back\").\"\\\" />\\n\";\n\t\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_area_and_back\\\" value=\\\"\".get_vocab(\"save_and_back\").\"\\\" />\";\n\t\t\techo \"</div></form>\";\n\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\techo \"aff_creneaux();\";\n\t\t\techo \"</script>\";\n\t\t\techo \"</div>\";\n\t\t}\nend_page();\n?>", "<?php\n/**\n * frmcontactlist.php\n * calcule la liste des ressources visibles dans un domaine\n * Ce script fait partie de l'application GRR\n * Derni\u00e8re modification : $Date: 2018-07-31 16:00$\n * @author    JeromeB & Yan Naessens\n * @copyright Copyright 2003-2018 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n\ninclude \"include/connect.inc.php\";\ninclude \"include/mysql.inc.php\";\ninclude \"include/misc.inc.php\";\ninclude \"include/functions.inc.php\";\n\n$id = $_GET['id'];\n// echo \"<optgroup label=\\\"Salles\\\">\"; je supprime optgroup car les ressources ne sont pas toujours des salles ! YN\n$res = grr_sql_query(\"SELECT room_name,id FROM \".TABLE_PREFIX.\"_room WHERE area_id = '\".$id.\"' ORDER BY room_name\");\n$nbresult = mysqli_num_rows($res);\n$user_name = getUserName();\nif ($nbresult != 0)\n{\n    $a = \"\";\n\tfor ($t = 0; ($row_roomName = grr_sql_row($res, $t)); $t++)\n\t{\n        $id_room = $row_roomName[1];\n        if (verif_acces_ressource($user_name,$id_room)){\n            $room_name = $row_roomName[0];\n            $a .= \" <option value =\\\"$room_name\\\">$room_name</option>\";\n        }\n\t}\n    if ($a != \"\")\n        echo $a;\n    else \n        echo \" <option value =\\\"1\\\">Aucune ressource accessible dans ce domaine</option>\";\n}\nelse\n\techo \" <option value =\\\"1\\\">Aucune ressource li\u00e9e \u00e0 ce domaine</option>\";\n?>\n", "<?php\n/*\n * frmcontactrange.php\n * calcule le code html de la partie intervalle du formulaire de contact\n * Ce script fait partie de l'application GRR\n * Derni\u00e8re modification : $Date: 2020-01-17 14:30$\n * @author    JeromeB & Yan Naessens\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n \ninclude \"include/connect.inc.php\";\ninclude \"include/mysql.inc.php\";\ninclude \"include/misc.inc.php\";\ninclude \"include/functions.inc.php\";\n\n$id = $_GET['id'];\n$query = \"SELECT access,morningstarts_area,eveningends_area,eveningends_minutes_area,enable_periods,resolution_area FROM \".TABLE_PREFIX.\"_area\n    WHERE id = '\".$id.\"' \";\n// echo $query.\"<br />\";\n$res = grr_sql_query($query);\n$val= grr_sql_row($res,0);\n// print_r($val);\n$enable_periods = $val[4]=='y';\nif ($enable_periods)\n{\n    // echo 'mode cr\u00e9neaux';\n    // d\u00e9terminer la liste des cr\u00e9neaux\n    $sql_periode = grr_sql_query(\"SELECT num_periode, nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id.\"' order by num_periode\");\n    $num_periodes = grr_sql_count($sql_periode);\n    echo '<div class=\"form-group\">';\n    // s\u00e9lectionner parmi les cr\u00e9neaux\n    echo '<label for=\"start\" >Cr\u00e9neau initial : &nbsp;</label>';\n    echo '<select name=\"start\">';\n        for ($i = 0; $i < $num_periodes; $i++)\n        {\n            $val = grr_sql_row($sql_periode,$i);\n            echo '<option value=\"'.$val[0].'\">'.$val[1].'</option>';\n        }\n    echo '</select>';\n    // choisir le nombre de cr\u00e9neaux\n    echo '  <label for=\"duree\" >Nombre de cr\u00e9neaux : &nbsp;</label>';\n    echo '  <input type=\"number\" id=\"duree\" size=\"2\" name=\"duree\" value=\"1\" min=\"1\" required />';\n    echo '</div>';\n}\nelse \n{\t// mode temps\n    $res_min = $val[5]/60;\n    $nbiteration = 60/$res_min; // nb iterations sur une heure\n    echo '<div class=\"form-group\">';\n    echo '    <div class=\"input-group\">';\n    echo '        <label for=\"heure\">Heure d\u00e9but :</label>';\n    echo \"        <select name=\\\"heure\\\" id=\\\"heure\\\"> \";\n    for ($h = $val[1] ; $h < $val[2]+$val[3]/60-$val[5]/3600 ; $h++)\n    {\n        echo \"<option value =\\\"$h\\\"> \".sprintf(\"%02d\",$h).\"h </option>\".PHP_EOL;\n    }\n    echo \"        </select>\";\n    echo \" <select id='debdureemin' name=\\\"minutes\\\">\";\n    $valeur = 0;\n    for ($i=0;$i<$nbiteration;$i++)\n    {\n        echo \"<option value='$valeur'>\";\n        if ($i == 0)\n        { $valeur ='00';}\n        else {$valeur += $res_min;}\n        echo $valeur.\" min.\";\n        echo \"</option>\";\n    }\n    echo \" </select>\";\n    echo '    </div>';\n    echo '<div class=\"input-group\">';\n    echo '  <label for=\"duree\" >Dur\u00e9e en heure :</label>';\n    echo '  <input type=\"number\" id=\"duree\" size=\"2\" name=\"duree\" value=\"1\" min=\"0\" required />';\n    echo '  <label for=\"dureemin\"> et </label>';\n    echo '  <select id=\"dureemin\" name=\"dureemin\">';\n    $valeur = 0;\n    for ($i=0;$i<$nbiteration;$i++)\n    {\n        echo \"<option value='$valeur'>\".$valeur.\" min</option>\";\n        $valeur += $res_min;\n    }\n    echo '  </select>';\n    echo ' </div>';\n    echo '</div>';\n    \n}\necho \"<br /> \";\necho \"<div>\";\necho '<input class=\"btn btn-primary\" type=\"submit\" name=\"submit\" value=\"Envoyer la demande de r\u00e9servation\">';\necho '<input class=\"btn btn-danger\" type=\"button\" name=\"retouraccueil\" value=\"Retour\" onClick=\"javascript:location.href=\\'javascript:history.go(-1)\\'\">';\necho '</div>';\n?>", "<?php\n/**\n * include/functions.inc.php\n * fichier Biblioth\uff83\uff68que de fonctions de GRR\n * Derni\uff83\uff68re modification : $Date: 2020-02-20 16:30$\n * @author    JeromeB & Laurent Delineau & Marc-Henri PAMISEUX & Yan Naessens\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n\nfunction returnmsg($type,$test, $status, $msg = '')\n{\n\techo encode_message_utf8('<div class=\"alert alert-'.$type.'\" role=\"alert\"><h3>'.$test);\n\techo encode_message_utf8($status).\"</h3>\";\n\tif ($msg != '')\n\t\techo encode_message_utf8(\"($msg)\"),PHP_EOL;\n\techo '</div>',PHP_EOL;\n}\n\nfunction getDaysInMonth($month, $year)\n{\n\treturn date('t', mktime(0, 0, 0, $month, 1, $year));\n}\n\nfunction getWeekNumber($date)\n{\n\treturn date('W', $date);\n}\n// fonction de d\uff83\uff69termination des jours de vacances scolaires par lecture dans la base\nfunction isSchoolHoliday($now)\n{\n\t$test = grr_sql_query1(\"SELECT DAY FROM \".TABLE_PREFIX.\"_calendrier_vacances where DAY = '\".$now.\"'\");\n\t$val = ($test != -1);\n\treturn $val;\n} \n/* function getSchoolHolidays($now, $year)\n{\n\t$zone = 'A';\n\tif (Settings::get(\"holidays_zone\") != NULL)\n\t\t$zone = Settings::get(\"holidays_zone\");\n\t$sh = array(false, \"\");\n\t$vacances = simplexml_load_file('vacances.xml');\n\t$libelle = $vacances->libelles->children();\n\t$node = $vacances->calendrier->children();\n\tforeach ($node as $key => $value)\n\t{\n\t\tif ($value['libelle'] == $zone)\n\t\t{\n\t\t\tforeach ($value->vacances as $key => $value)\n\t\t\t{\n\t\t\t\t$y = date('Y', strtotime($value['debut']));\n\t\t\t\tif ($y == $year)\n\t\t\t\t{\n\t\t\t\t\tif (strtotime($value['debut']) <= $now && $now < strtotime($value['fin']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$nom = (int)$value['libelle'];\n\t\t\t\t\t\t$nom = $libelle->libelle[$nom - 1];\n\t\t\t\t\t\t$sh = array(true, $nom);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn $sh;\n}\n*/\n// fonction de calcul des jours f\uff83\uff69ri\uff83\uff69s (France)\nfunction setHolidays($year = null)\n{\n\tif ($year === null)\n\t\t$year = intval(date('Y'));\n\t$easterDate  = easter_date($year);\n\t$easterDay   = date('j', $easterDate);\n\t$easterMonth = date('n', $easterDate);\n\t$easterYear  = date('Y', $easterDate);\n\t$holidays = array(\n\t// Dates fixes\n\tmktime(0, 0, 0, 1,  1,  $year),  // 1er janvier\n\tmktime(0, 0, 0, 5,  1,  $year),  // F\uff83\uff6ate du travail\n\tmktime(0, 0, 0, 5,  8,  $year),  // Victoire des alli\uff83\uff69s\n\tmktime(0, 0, 0, 7,  14, $year),  // F\uff83\uff6ate nationale\n\tmktime(0, 0, 0, 8,  15, $year),  // Assomption\n\tmktime(0, 0, 0, 11, 1,  $year),  // Toussaint\n\tmktime(0, 0, 0, 11, 11, $year),  // Armistice\n\tmktime(0, 0, 0, 12, 25, $year),  // Noel\n\t// Dates variables\n\tmktime(0, 0, 0, $easterMonth, $easterDay + 1,  $easterYear),\n\tmktime(0, 0, 0, $easterMonth, $easterDay + 39, $easterYear),\n\tmktime(0, 0, 0, $easterMonth, $easterDay + 50, $easterYear),\n\t);\n\tsort($holidays);\n\treturn $holidays;\n}\n// fonction de d\uff83\uff69termination si un jour est f\uff83\uff69ri\uff83\uff69\nfunction isHoliday($now){\n\t$test = grr_sql_query1(\"SELECT DAY FROM \".TABLE_PREFIX.\"_calendrier_feries where DAY = '\".$now.\"'\");\n\t$val = ($test != -1);\n\treturn $val;\n}\n\n// $type = 1: Fonction Calendrier hors r\uff83\uff69servation ; 2; Fonction Calendrier feries ; 3 : calendrier vacances (scolaires par d\uff83\uff69faut)\nfunction cal($month, $year, $type)\n{\n\tglobal $weekstarts;\n\n\tif (!isset($weekstarts))\n\t\t$weekstarts = 0;\n\t$s = \"\";\n\t$daysInMonth = getDaysInMonth($month, $year);\n\t$date = mktime(12, 0, 0, $month, 1, $year);\n\t$first = (strftime(\"%w\",$date) + 7 - $weekstarts) % 7;\n\t$monthName = ucfirst(utf8_strftime(\"%B\", $date));\n\n\t$s .= '<table class=\"table calendar2\">'.PHP_EOL;\n\t$s .= '<tr>'.PHP_EOL;\n\t$s .= '<td class=\"calendarHeader2\" colspan=\"8\">'.$monthName.' '.$year.'</td>'.PHP_EOL;\n\t$s .= '</tr>'.PHP_EOL;\n\t$d = 1 - $first;\n\t$is_ligne1 = 'y';\n\twhile ($d <= $daysInMonth)\n\t{\n\t\t$s .= '<tr>'.PHP_EOL;\n\t\tfor ($i = 0; $i < 7; $i++)\n\t\t{\n\t\t\t$basetime = mktime(12, 0, 0, 6, 11 + $weekstarts, 2000);\n\t\t\t$show = $basetime + ($i * 24 * 60 * 60);\n\t\t\t$nameday = utf8_strftime('%A',$show);\n\t\t\t$temp = mktime(0, 0, 0, $month, $d, $year);\n\t\t\tif ($i == 0)\n\t\t\t\t$s .= '<td class=\"calendar2\" style=\"vertical-align:bottom;\"><b>S'.getWeekNumber($temp).'</b></td>'.PHP_EOL;\n\t\t\t$s .= '<td class=\"calendar2\" valign=\"top\">'.PHP_EOL;\n\t\t\tif ($is_ligne1 == 'y')\n\t\t\t\t$s .=  '<b>'.ucfirst(substr($nameday,0,1)).'</b><br />';\n\t\t\tif ($d > 0 && $d <= $daysInMonth)\n\t\t\t{\n\t\t\t\t$s .= $d;\n\t\t\t\tif($type == 1)\n\t\t\t\t\t$day = grr_sql_query1(\"SELECT day FROM \".TABLE_PREFIX.\"_calendar WHERE day='$temp'\");\n\t\t\t\telseif ($type == 2)\n                    $day = grr_sql_query1(\"SELECT day FROM \".TABLE_PREFIX.\"_calendrier_feries WHERE day='$temp'\");\n                else\n\t\t\t\t\t$day = grr_sql_query1(\"SELECT day FROM \".TABLE_PREFIX.\"_calendrier_vacances WHERE day='$temp'\");\n\t\t\t\t$s .= '<br><input type=\"checkbox\" name=\"'.$temp.'\" value=\"'.$nameday.'\" ';\n\t\t\t\tif (!($day < 0))\n\t\t\t\t\t$s .= 'checked=\"checked\" ';\n\t\t\t\t$s .= '/>';\n\t\t\t}\n\t\t\telse\n\t\t\t\t$s .= \" \";\n\t\t\t$s .= '</td>'.PHP_EOL;;\n\t\t\t$d++;\n\t\t}\n\t\t$s .= '</tr>'.PHP_EOL;;\n\t\t$is_ligne1 = 'n';\n\t}\n\t$s .= '</table>'.PHP_EOL;\n\treturn $s;\n}\n\n/**\n * Fonction de verification d'access\n * @param int $level\n */\nfunction check_access($level, $back)\n{\n\tif (authGetUserLevel(getUserName(), -1, 'area') < $level)\n\t{\n\t\tshowAccessDenied($back);\n\t\texit();\n\t}\n}\n\n/**\n * Fonction qui compare 2 valeurs\n * @param string $a\n * @param integer $b\n * @return string\n */\nfunction cmp3($a, $b)\n{\n\tif ($a < $b)\n\t\treturn \"< \";\n\tif ($a == $b)\n\t\treturn \"= \";\n\treturn \"> \";\n}\n\nfunction get_request_uri()\n{\n\tglobal $grr_script_name;\n\t$RequestUri = \"\";\n\tif (isset($_SERVER['REQUEST_URI']))\n\t\t$RequestUri = $_SERVER['REQUEST_URI'];\n\telse if (isset($_ENV['REQUEST_URI']))\n\t\t$RequestUri = $_ENV['REQUEST_URI'];\n\telse if (isset($_SERVER['HTTP_X_REWRITE_URL']))\n\t\t$RequestUri = $_SERVER['HTTP_X_REWRITE_URL'];\n\telse\n\t{\n\t\tif (!isset($_SERVER['QUERY_STRING']))\n\t\t\t$_SERVER['QUERY_STRING'] = \"\";\n\t\tif ((Settings::get(\"use_grr_url\") == \"y\") && (Settings::get(\"grr_url\") != \"\"))\n\t\t{\n\t\t\tif (substr(Settings::get(\"grr_url\"), -1) != \"/\")\n\t\t\t\t$ad_signe = \"/\";\n\t\t\telse\n\t\t\t\t$ad_signe = \"\";\n\t\t\t$RequestUri = Settings::get(\"grr_url\").$ad_signe.$grr_script_name.$_SERVER['QUERY_STRING'];\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (isset($_SERVER['PHP_SELF']))\n\t\t\t\t$RequestUri = $_SERVER['PHP_SELF'].$_SERVER['QUERY_STRING'];\n\t\t}\n\t}\n\treturn $RequestUri;\n}\n\n/**\n * Affiche un lien email\n * @param string $_cible\n * @param string $_type_cible\n * @param string $option_affichage\n * @return string\n */\nfunction affiche_lien_contact($_cible, $_type_cible, $option_affichage)\n{\n\n\tif ($_type_cible == \"identifiant:non\")\n\t{\n\t\tif ($_cible == \"contact_administrateur\")\n\t\t{\n\t\t\t$_email = Settings::get(\"webmaster_email\");\n\t\t\t$_identite = get_vocab('administrator_contact');\n\t\t}\n\t\telse if ($_cible == \"contact_support\")\n\t\t{\n\t\t\t$_email = Settings::get(\"technical_support_email\");\n\t\t\t$_identite = get_vocab('technical_contact');\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$_email = \"\";\n\t\t\t$_identite = \"\";\n\t\t}\n\t}\n\telse\n\t{\n\t\t$sql_cible = \"SELECT prenom, nom, email FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".$_cible.\"'\";\n\t\t$res_cible = grr_sql_query($sql_cible);\n\t\tif ($res_cible)\n\t\t{\n\t\t\t$row_cible = grr_sql_row($res_cible, 0);\n\t\t\t$_email = $row_cible[2];\n\t\t\t$_identite = $row_cible[0].\" \".$row_cible[1];\n\t\t\tgrr_sql_free($res_cible);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$_email = \"\";\n\t\t\t$_identite = \"\";\n\t\t}\n\t}\n\n\tif (Settings::get(\"envoyer_email_avec_formulaire\") == \"yes\")\n\t{\n\t\tif ($_email == \"\")\n\t\t{\n\t\t\tif ($option_affichage == \"afficher_toujours\")\n\t\t\t\t$affichage = $_identite;\n\t\t\telse\n\t\t\t\t$affichage = \"\";\n\t\t}\n\t\telse\n\t\t\t//$affichage = '<a href=\"javascript:centrerpopup(\\'contact.php?cible='.$_cible.'&amp;type_cible='.$_type_cible.'\\',600,480,\\'scrollbars=yes,statusbar=no,resizable=yes\\')\" title=\"'.$_identite.'\\\">'.$_identite.'</a>'.PHP_EOL;\n            $affichage = '<a href=\"javascript:centrerpopup(\\'contact.php?cible='.$_cible.'&amp;type_cible='.$_type_cible.'\\',600,480,\\'scrollbars=yes,statusbar=no,resizable=yes\\')\" title=\"'.$_identite.'\\\">'.$_identite.'</a>'.PHP_EOL;\n\t}\n\telse\n\t{   // si j'ai bien compris, il s'agit de calculer une balise mailto, et ce qui suit parait trop compliqu\uff83\uff69 YN 2018-01-26\n\n\t/*\t?>\n\t\t<script type=\"text/javascript\">\n\t\t\tfunction encode_adresse(user,domain,debut)\n\t\t\t{\n\t\t\t\tvar address = user+'@'+domain;\n\t\t\t\tvar toWrite = '';\n\t\t\t\tif (debut > 0)\n\t\t\t\t\ttoWrite += '<'+'a href=\"mailto:';\n\t\t\t\telse\n\t\t\t\t\ttoWrite +=';';\n\t\t\t\ttoWrite +=address\n\t\t\t\tdocument.write(toWrite);\n\t\t\t}\n\t\t\tfunction encode_fin_adresse(label)\n\t\t\t{\n\t\t\t\tvar toWrite = '';\n\t\t\t\ttoWrite +='\">'+label+'</'+'a>';\n\t\t\t\tdocument.write(toWrite);\n\t\t\t}\n\t\t</script>\n\t\t<?php */\n\t\t$affichage = \"\";\n\t\tif ($_email == \"\")\n\t\t{\n\t\t\tif ($option_affichage == \"afficher_toujours\")\n\t\t\t\t$affichage = $_identite;\n\t\t}\n\t\telse\n\t\t{\n            if (filter_var($_email,FILTER_VALIDATE_EMAIL))\n            {\n                $affichage = '<a href=\"mailto:'.$_email.'\">'.$_identite.'</a>';\n            }\n            else \n                if ($option_affichage == \"afficher_toujours\")\n                    $affichage = $_identite;\n            /* \n\t\t\t$tab_email = explode(';', trim($_email));\n\t\t\t$i = 0;\n\t\t\t$affichage .= '<script>'.PHP_EOL;\n\t\t\tforeach ($tab_email as $item_email)\n\t\t\t{\n\t\t\t\t$item_email_explode = explode('@',$item_email);\n\t\t\t\t$person = $item_email_explode[0];\n\t\t\t\tif (isset($item_email_explode[1]))\n\t\t\t\t{\n\t\t\t\t\t$i++;\n\t\t\t\t\t$domain = $item_email_explode[1];\n\t\t\t\t\tif ($i == 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$affichage .=  'encode_adresse(\"'.$person.'\", \"'.$domain.'\", 1);'.PHP_EOL;\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t$affichage .=  'encode_adresse(\"'.$person.'\", \"'.$domain.'\", 0);'.PHP_EOL;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$affichage .=  'encode_fin_adresse(\"'.addslashes($_identite).'\");'.PHP_EOL;\n\t\t\t$affichage .=  '</script>'.PHP_EOL;\n\t\t\t$affichage .= $_identite; */\n\t\t}\n\t}\n\treturn $affichage;\n}\n/**\n *Fonction qui calcule $room, $area et $id_site \uff83\uf8f0 partir de $_GET['room'], $_GET['area'], $_GET['id_site']\n */\nfunction Definition_ressource_domaine_site()\n{\n\tglobal $room, $area, $id_site;\n\tif (isset($_GET['room']))\n\t{\n\t\t//$room = $_GET['room'];\n\t\t$room = mysqli_real_escape_string($GLOBALS['db_c'], $_GET['room']);\n\t\tsettype($room, \"integer\");\n\t\t$area = mrbsGetRoomArea($room);\n\t\t$id_site = mrbsGetAreaSite($area);\n\t}\n\telse\n\t{\n\t\t$room = NULL;\n\t\tif (isset($_GET['area']))\n\t\t{\n\t\t\t//$area = $_GET['area'];\n\t\t\t$area = mysqli_real_escape_string($GLOBALS['db_c'], $_GET['area']);\n\t\t\tsettype($area, \"integer\");\n\t\t\t$id_site = mrbsGetAreaSite($area);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$area = NULL;\n\t\t\tif (isset($_GET[\"id_site\"]))\n\t\t\t{\n\t\t\t\t//$id_site = $_GET[\"id_site\"];\n\t\t\t\t$id_site = mysqli_real_escape_string($GLOBALS['db_c'], $_GET[\"id_site\"]);\n\t\t\t\tsettype($id_site, \"integer\");\n\t\t\t\t$area = get_default_area($id_site);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$id_site = get_default_site();\n\t\t\t\t$area = get_default_area($id_site);\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction bouton_retour_haut()\n{\n\techo '<script type=\"text/javascript\">',PHP_EOL,'$(function()',PHP_EOL,'{',PHP_EOL,'$(window).scroll(function()',PHP_EOL,'{',PHP_EOL,\n\t\t'if ($(this).scrollTop() != 0)',PHP_EOL,'$(\"#toTop\").fadeIn();',PHP_EOL,'else',PHP_EOL,'$(\"#toTop\").fadeOut();',PHP_EOL,\n\t\t'});',PHP_EOL,'$(\"#toTop\").click(function()',PHP_EOL,'{',PHP_EOL,'$(\"body,html\").animate({scrollTop:0},800);',PHP_EOL,\n\t\t'});',PHP_EOL,'});',PHP_EOL,'</script>',PHP_EOL;\n}\n\nfunction bouton_aller_bas()\n{\n\techo '<script type=\"text/javascript\">',PHP_EOL,'$(function()',PHP_EOL,'{',PHP_EOL,'$(window).scroll(function()',PHP_EOL,'{',PHP_EOL,\n\t\t'if ($(this).scrollTop() != 800)',PHP_EOL,'$(\"#toBot\").fadeIn();',PHP_EOL,'else',PHP_EOL,'$(\"#toBot\").fadeOut();',PHP_EOL,\n\t\t'});',PHP_EOL,'$(\"#toBot\").click(function()',PHP_EOL,'{',PHP_EOL,'$(\"body,html\").animate({scrollTop:800},0);',PHP_EOL,\n\t\t'});',PHP_EOL,'});',PHP_EOL,'</script>',PHP_EOL;\n}\n/**\n *function affiche_ressource_empruntee\n *- $id_room : identifiant de la ressource\n *- Si la ressource est emprunt\uff83\uff69e, affiche une ic\uff83\uff74ne avec un lien vers la r\uff83\uff69servation pour laquelle la ressource est emprunt\uff83\uff69e.\n * @param string $id_room\n * @return string\n */\nfunction affiche_ressource_empruntee($id_room, $type = \"logo\")\n{\n\t$active_ressource_empruntee = grr_sql_query1(\"SELECT active_ressource_empruntee FROM \".TABLE_PREFIX.\"_room WHERE id = '\".$id_room.\"'\");\n\tif ($active_ressource_empruntee == 'y')\n\t{\n\t\t$id_resa = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_entry WHERE room_id = '\".$id_room.\"' AND statut_entry='y'\");\n\t\tif ($id_resa != -1)\n\t\t{\n\t\t\tif ($type == \"logo\")\n\t\t\t\techo '<a href=\"view_entry.php?id='.$id_resa.'\"><img src=\"img_grr/buzy_big.png\" alt=\"'.get_vocab(\"ressource actuellement empruntee\").'\" title=\"'.get_vocab(\"reservation_en_cours\").'\" width=\"30\" height=\"30\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\telse if ($type == \"texte\")\n\t\t\t{\n\t\t\t\t$beneficiaire = grr_sql_query1(\"SELECT beneficiaire FROM \".TABLE_PREFIX.\"_entry WHERE room_id = '\".$id_room.\"' AND statut_entry='y'\");\n\t\t\t\t$beneficiaire_ext = grr_sql_query1(\"SELECT beneficiaire_ext FROM \".TABLE_PREFIX.\"_entry WHERE room_id = '\".$id_room.\"' AND statut_entry='y'\");\n\t\t\t\techo '<br /><b><span class=\"avertissement\">'.PHP_EOL;\n\t\t\t\techo '<img src=\"img_grr/buzy_big.png\" alt=\"'.get_vocab(\"ressource actuellement empruntee\").'\" title=\"'.get_vocab(\"ressource actuellement empruntee\").'\" width=\"30\" height=\"30\" class=\"image\" />'.PHP_EOL;\n\t\t\t\techo get_vocab(\"ressource actuellement empruntee\").' '.get_vocab(\"nom emprunteur\").get_vocab(\"deux_points\").affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"withmail\");\n\t\t\t\techo '<a href=\"view_entry.php?id='.$id_resa.'&amp;mode=page\">'.get_vocab(\"entryid\").$id_resa.'</a>'.PHP_EOL.'</span></b>'.PHP_EOL;\n\t\t\t}\n\t\t\telse\n\t\t\t\treturn \"yes\";\n\t\t}\n\t}\n}\n\n/**\n * @param string $type\n * @param string $t\n * @return string\n */\nfunction bbCode($t,$type)\n{\n\tif ($type == \"nobbcode\")\n\t{\n\t\t$t = str_replace(\"[/]\", \"\", $t);\n\t\t$t = str_replace(\"[hr]\", \"\", $t);\n\t\t$t = str_replace(\"[center]\", \"\", $t);\n\t\t$t = str_replace(\"[/center]\", \"\", $t);\n\t\t$t = str_replace(\"[right]\", \"\", $t);\n\t\t$t = str_replace(\"[/right]\", \"\", $t);\n\t\t$t = str_replace(\"[justify]\", \"\", $t);\n\t\t$t = str_replace(\"[/justify]\", \"\", $t);\n\t\t$regLienSimple = \"`\\[url\\] ?([^\\[]*) ?\\[/url\\]`\";\n\t\t$regLienEtendu = \"`\\[url ?=([^\\[]*) ?] ?([^]]*) ?\\[/url\\]`\";\n\t\tif (preg_match($regLienSimple, $t))\n\t\t\t$t = preg_replace($regLienSimple, \"\\\\1\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regLienEtendu, \"\\\\1\", $t);\n\t\t$regMailSimple = \"`\\[email\\] ?([^\\[]*) ?\\[/email\\]`\";\n\t\t$regMailEtendu = \"`\\[email ?=([^\\[]*) ?] ?([^]]*) ?\\[/email\\]`\";\n\t\tif (preg_match($regMailSimple, $t))\n\t\t\t$t = preg_replace($regMailSimple, \"\\\\1\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regMailEtendu, \"\\\\1\", $t);\n\t\t$regImage = \"`\\[img\\] ?([^\\[]*) ?\\[/img\\]`\";\n\t\t$regImageAlternatif = \"`\\[img ?= ?([^\\[]*) ?\\]`\";\n\t\tif (preg_match($regImage, $t))\n\t\t\t$t = preg_replace($regImage, \"\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regImageAlternatif, \"\", $t);\n\t\t$t = str_replace(\"[b]\", \"\", $t);\n\t\t$t = str_replace(\"[/b]\", \"\", $t);\n\t\t$t = str_replace(\"[i]\", \"\", $t);\n\t\t$t = str_replace(\"[/i]\", \"\", $t);\n\t\t$t = str_replace(\"[u]\", \"\", $t);\n\t\t$t = str_replace(\"[/u]\", \"\", $t);\n\t\t$t = str_replace(\"[/color]\", \"</span>\", $t);\n\t\t$regCouleur = \"`\\[color= ?(([[:alpha:]]+)|(#[[:digit:][:alpha:]]{6})) ?\\]`\";\n\t\t$t = preg_replace($regCouleur, \"\", $t);\n\t\t$t = str_replace(\"[/size]\", \"</span>\", $t);\n\t\t$regCouleur = \"`\\[size= ?([[:digit:]]+) ?\\]`\";\n\t\t$t = preg_replace($regCouleur, \"\", $t);\n\t}\n\tif ($type != \"titre\")\n\t{\n\t\t$t = str_replace(\"[/]\", \"<hr width=\\\"100%\\\" size=\\\"1\\\" />\", $t);\n\t\t$t = str_replace(\"[hr]\", \"<hr width=\\\"100%\\\" size=\\\"1\\\" />\", $t);\n\t\t$t = str_replace(\"[center]\", \"<div style=\\\"text-align: center\\\">\", $t);\n\t\t$t = str_replace(\"[/center]\", \"</div>\", $t);\n\t\t$t = str_replace(\"[right]\", \"<div style=\\\"text-align: right\\\">\", $t);\n\t\t$t = str_replace(\"[/right]\", \"</div>\", $t);\n\t\t$t = str_replace(\"[justify]\", \"<div style=\\\"text-align: justify\\\">\", $t);\n\t\t$t = str_replace(\"[/justify]\", \"</div>\", $t);\n\t\t$regLienSimple = \"`\\[url\\] ?([^\\[]*) ?\\[/url\\]`\";\n\t\t$regLienEtendu = \"`\\[url ?=([^\\[]*) ?] ?([^]]*) ?\\[/url\\]`\";\n\t\tif (preg_match($regLienSimple, $t))\n\t\t\t$t = preg_replace($regLienSimple, \"<a href=\\\"\\\\1\\\">\\\\1</a>\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regLienEtendu, \"<a href=\\\"\\\\1\\\" target=\\\"_blank\\\">\\\\2</a>\", $t);\n\t}\n\t$regMailSimple = \"`\\[email\\] ?([^\\[]*) ?\\[/email\\]\\`\";\n\t$regMailEtendu = \"`\\[email ?=([^\\[]*) ?] ?([^]]*) ?\\[/email\\]`\";\n\tif (preg_match(\"'\".$regMailSimple.\"'\", $t))\n\t\t$t = preg_replace($regMailSimple, \"<a href=\\\"mailto:\\\\1\\\">\\\\1</a>\", $t);\n\telse\n\t\t$t = preg_replace($regMailEtendu, \"<a href=\\\"mailto:\\\\1\\\">\\\\2</a>\", $t);\n\t$regImage = \"`\\[img\\] ?([^\\[]*) ?\\[/img\\]`\";\n\t$regImageAlternatif = \"`\\[img ?= ?([^\\[]*) ?\\]`\";\n\tif (preg_match($regImage, $t))\n\t\t$t = preg_replace($regImage, \"<img src=\\\"\\\\1\\\" alt=\\\"\\\" class=\\\"image\\\" />\", $t);\n\telse\n\t\t$t = preg_replace($regImageAlternatif, \"<img src=\\\"\\\\1\\\" alt=\\\"\\\" class=\\\"image\\\" />\", $t);\n\t$t = str_replace(\"[b]\", \"<strong>\", $t);\n\t$t = str_replace(\"[/b]\", \"</strong>\", $t);\n\t$t = str_replace(\"[i]\", \"<em>\", $t);\n\t$t = str_replace(\"[/i]\", \"</em>\", $t);\n\t$t = str_replace(\"[u]\", \"<u>\", $t);\n\t$t = str_replace(\"[/u]\", \"</u>\", $t);\n\t$t = str_replace(\"[/color]\", \"</span>\", $t);\n\t$regCouleur = \"/\\[color= ?(([[:alpha:]]+)|(#[[:digit:][:alpha:]]{6})) ?\\]/\";\n\t$t = preg_replace($regCouleur, \"<span style=\\\"color: \\\\1\\\">\", $t);\n\t$t = str_replace(\"[/size]\", \"</span>\", $t);\n\t$regCouleur = \"`\\[size= ?([[:digit:]]+) ?\\]`\";\n\t$t = preg_replace($regCouleur, \"<span style=\\\"font-size: \\\\1px\\\">\", $t);\n\treturn $t;\n}\n\n/**\n * FUNCTION: how_many_connected()\n * DESCRIPTION: Si c'est un admin qui est connect\uff83\uff69, affiche le nombre de personnes actuellement connect\uff83\uff69es.\n */\nfunction how_many_connected()\n{\n\tif (authGetUserLevel(getUserName(), -1) >= 6)\n\t{\n\t\t$sql = \"SELECT login FROM \".TABLE_PREFIX.\"_log WHERE end > now()\";\n\t\t$res = grr_sql_query($sql);\n\t\t$nb_connect = grr_sql_count($res);\n\t\tgrr_sql_free($res);\n\n\t\tif (@file_exists('./admin_access_area.php')){\n\t\t\t$racineAd = \"./\";\n\t\t}else{\n\t\t\t$racineAd = \"./admin/\";\n\t\t}\n\n\t\tif ($nb_connect == 1)\n\t\t\techo \"<a href='{$racineAd}admin_view_connexions.php'>\".$nb_connect.get_vocab(\"one_connected\").\"</a>\".PHP_EOL;\n\t\telse\n\t\t\techo \"<a href='{$racineAd}admin_view_connexions.php'>\".$nb_connect.get_vocab(\"several_connected\").\"</a>\".PHP_EOL;\n\t\tif (verif_version())\n\t\t\taffiche_pop_up(get_vocab(\"maj_bdd_not_update\").get_vocab(\"please_go_to_admin_maj.php\"),\"force\");\n\t}\n}\n/**\n * Fonction : resaToModerate($user) \n * Description : si c'est un admin ou un gestionnaire de ressource qui est connect\uff83\uff69, retourne un tableau contenant, pour chaque r\uff83\uff69servation \uff83\uf8f0 mod\uff83\uff69rer, [id,room_id,start_time]\n*/\nfunction resaToModerate($user)\n{   \n    $resas = array();\n    $res = false;\n    if (authGetUserLevel($user,-1) > 5) // admin g\uff83\uff69n\uff83\uff69ral\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e JOIN \".TABLE_PREFIX.\"_room r ON e.room_id = r.id WHERE e.moderate = 1\";\n        $res = grr_sql_query($sql);\n    }\n    elseif (isset($_GET['id_site']) && (authGetUserLevel($user,$_GET['id_site'],'site') > 4)) // admin du site\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e JOIN \".TABLE_PREFIX.\"_room r ON e.room_id = r.id JOIN \".TABLE_PREFIX.\"_j_site_area j ON r.area_id = j.id_area WHERE (j.id_site = \".$_GET['id_site'].\" AND e.moderate = 1)\";\n        $res = grr_sql_query($sql);\n    }\n    elseif (isset($_GET['area']) && (authGetUserLevel($user,$_GET['area'],'area') > 3)) // admin du domaine\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e JOIN \".TABLE_PREFIX.\"_room r ON e.room_id = r.id JOIN \".TABLE_PREFIX.\"_area a ON r.area_id = a.id WHERE (a.id = \".$_GET['area'].\" AND e.moderate = 1)\";\n        $res = grr_sql_query($sql);\n    }\n    elseif (isset($_GET['room']) && (authGetUserLevel($user,$_GET['room'],'room') > 2)) // gestionnaire de la ressource\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e WHERE (e.moderate = 1 AND e.room_id = \".$_GET['room'].\") \";\n        $res = grr_sql_query($sql);\n    }\n    if ($res)\n    {\n        $i = 0; \n        while (($a = grr_sql_row($res, $i++))) \n        {\n            $resas[$i] = array('id' => $a[0],'room' => $a[1],'start_time' => $a[2]);\n        }\n    }\n    return $resas;\n}\n/*\nTeste s'il reste ou non des plages libres sur une journ\uff83\uff69e donn\uff83\uff69e pour un domaine donn\uff83\uff69.\nArguments :\n$id_room : identifiant de la ressource\n$month_week : mois\n$day_week : jour\n$year_week : ann\uff83\uff69e\nRenvoie vrai s'il reste des plages non r\uff83\uff69serv\uff83\uff69es sur la journ\uff83\uff69e\nRenvoie faux dans le cas contraire\n*/\n/**\n * @param integer $id_room\n * @param integer $month_week\n * @param integer $day_week\n * @param integer $year_week\n * @return boolean\n */\nfunction plages_libre_semaine_ressource($id_room, $month_week, $day_week, $year_week)\n{\n\tglobal $morningstarts, $eveningends, $eveningends_minutes, $resolution, $enable_periods;\n\t$date_end = mktime($eveningends, $eveningends_minutes, 0, $month_week, $day_week, $year_week);\n\t$date_start = mktime($morningstarts, 0, 0, $month_week, $day_week, $year_week);\n\t$t = $date_start ; \n\tif ($enable_periods == \"y\") \n\t\t$date_end += $resolution;\n\t$plage_libre = false;\n\twhile ($t < $date_end)\n\t{\n\t\t$t_end = $t + $resolution;\n\t\t$query = \"SELECT id FROM \".TABLE_PREFIX.\"_entry WHERE room_id='\".$id_room.\"' AND start_time <= \".$t.\" AND end_time >= \".$t_end.\" \";\n\t\t$test = grr_sql_query1($query);\n\t\tif ($test == -1)\n\t\t{\n\t\t\t$plage_libre = true;\n\t\t\tbreak;\n\t\t}\n\t\t$t += $resolution;\n\t}\n\treturn $plage_libre ;\n}\n\n/* Fonction sp\uff83\uff69ciale SE3\n $grp : le nom du groupe\n $uid : l'uid de l'utilisateur\n Cette fonction retourne \"oui\" ou \"non\" selon que $uid appartient au groupe $grp, ou bien \"faux\" si l'interrogation du LDAP \uff83\uff69choue\n Seuls les groupes de type \"posixGroup\" sont support\uff83\uff69s (les groupes de type \"groupOfNames\" ne sont pas support\uff83\uff69s).\n*/\n function se3_grp_members ($grp, $uid)\n {\n \tinclude \"config_ldap.inc.php\";\n \t$est_membre=\"non\";\n\t// LDAP attributs\n \t$members_attr = array (\n\t\t$ldap_group_member_attr\n\t\t// Recherche des Membres du groupe\n \t\t);\n\t\t// Avec des GroupOfNames, ce ne serait pas \uff83\uff67a.\n \t$ds = @ldap_connect($ldap_adresse, $ldap_port);\n \tif ($ds)\n \t{\n \t\t$r = @ldap_bind ($ds, $ldap_login, $ldap_pwd);\n\t\t// Bind anonyme\n \t\tif ($r)\n \t\t{\n\t\t\t// La requ\uff83\uff6ate est adapt\uff83\uff69e \uff83\uf8f0 un serveur SE3...\n\t\t\t//$result = @ldap_search($ds, \"cn={$grp},{$ldap_group_base}\",$ldap_group_filter, $members_attr);\n            $result = @ldap_search($ds, \"{$ldap_group_base}\",\"(& (cn={$grp}) $ldap_group_filter )\", $members_attr);\n            // sur la proposition de marylenepaillassa (Forum #255)\n\t\t\t// Peut-\uff83\uff6atre faudrait-il dans le $tab_grp_autorise mettre des chaines 'cn=$grp,ou=Groups'\n \t\t\tif ($result)\n \t\t\t{\n \t\t\t\t$info = @ldap_get_entries($ds, $result);\n \t\t\t\tif ($info[\"count\"] == 1)\n \t\t\t\t{\n \t\t\t\t\tfor ($loop = 0; $loop < $info[0][$ldap_group_member_attr][\"count\"]; $loop++)\n \t\t\t\t\t{\n \t\t\t\t\t\tif ($info[0][$ldap_group_member_attr][$loop] == $uid)\n \t\t\t\t\t\t\t$est_membre=\"oui\";\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\t@ldap_free_result($result);\n \t\t\t}\n \t\t}\n \t\telse\n \t\t\treturn false;\n \t\t@ldap_close($ds);\n \t}\n \telse\n \t\treturn false;\n \treturn $est_membre;\n }\n\n/*\nArguments :\n$id_entry : identifiant de la r\uff83\uff69servation\n$login_moderateur : identifiant du mod\uff83\uff69rateur\n$motivation_moderation : texte facultatif\nIns\uff83\uff68re dans la table \".TABLE_PREFIX.\"_entry_moderate les valeurs de \".TABLE_PREFIX.\"_entry dont l'identifiant est $id_entry\n*/\n/**\n * @param string $motivation_moderation\n */\nfunction  grr_backup($id_entry, $login_moderateur, $motivation_moderation)\n{\n\t$sql = \"SELECT * FROM \".TABLE_PREFIX.\"_entry WHERE id='\".$id_entry.\"'\";\n\t$res = grr_sql_query($sql);\n\tif (!$res)\n\t\treturn false;\n\t$row = grr_sql_row_keyed($res, 0);\n\tgrr_sql_free($res);\n\t$req = \"INSERT INTO \".TABLE_PREFIX.\"_entry_moderate SET\n\tid = '\".$row['id'].\"',\n\tstart_time = '\".$row['start_time'].\"',\n\tend_time  = '\".$row['end_time'].\"',\n\tentry_type  = '\".$row['entry_type'].\"',\n\trepeat_id  = '\".$row['repeat_id'].\"',\n\troom_id = '\".$row['room_id'].\"',\n\ttimestamp = '\".$row['timestamp'].\"',\n\tcreate_by = '\".$row['create_by'].\"',\n\tbeneficiaire = '\".$row['beneficiaire'].\"',\n\tname = '\".protect_data_sql($row['name']).\"',\n\ttype = '\".$row['type'].\"',\n\tdescription = '\".protect_data_sql($row['description']).\"',\n\tstatut_entry = '\".$row['statut_entry'].\"',\n\toption_reservation = '\".$row['option_reservation'].\"',\n\toverload_desc  = '\".protect_data_sql($row['overload_desc']).\"',\n\tmoderate = '\".$row['moderate'].\"',\n\tmotivation_moderation = '\".protect_data_sql(strip_tags($motivation_moderation)).\"',\n\tlogin_moderateur = '\".protect_data_sql($login_moderateur).\"'\";\n\t$res = grr_sql_query($req);\n\tif (!$res)\n\t\treturn false;\n\telse\n\t{\n\t\tgrr_sql_free($res);\n\t\treturn true;\n\t}\n}\n\nfunction verif_version()\n{\n\tglobal $version_grr, $version_grr_RC;\n\t$_version_grr = $version_grr;\n\t$_version_grr_RC = $version_grr_RC;\n\t$version_old = Settings::get(\"version\");\n\t$versionRC_old = Settings::get(\"versionRC\");\n\tif ($versionRC_old == \"\")\n\t\t$versionRC_old = 9;\n\tif ($_version_grr_RC == \"\")\n\t\t$_version_grr_RC = 9;\n\tif (($version_old == '') || ($_version_grr > $version_old) || (($_version_grr == $version_old) && ($_version_grr_RC > $versionRC_old)))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nfunction affiche_version()\n{\n\tglobal $version_grr, $version_grr_RC, $sous_version_grr;\n\treturn \"GRR \".Settings::get(\"version\");\n}\n\nfunction affiche_date($x)\n{\n\t$j = date(\"d\", $x);\n\t$m = date(\"m\", $x);\n\t$a = date(\"Y\", $x);\n\t$result = $j.\"/\".$m.\"/\".$a;\n\treturn $result;\n}\n\n//L'heure d'\uff83\uff69t\uff83\uff69 commence le dernier dimanche de mars * et se termine le dernier dimanche d'octobre\n//Passage \uff83\uf8f0 l'heure d'hiver : -1h, le changement s'effectue \uff83\uf8f0 3h\n//Passage \uff83\uf8f0 l'heure d'\uff83\uff69t\uff83\uff69 : +1h, le changement s'effectue \uff83\uf8f0 2h\n//Si type = hiver => La fonction retourne la date du jour de passage \uff83\uf8f0 l'heure d'hiver\n//Si type = ete =>  La fonction retourne la date du jour de passage \uff83\uf8f0 l'heure d'\uff83\uff69t\uff83\uff69\nfunction heure_ete_hiver($type, $annee, $heure)\n{\n\tif ($type == \"ete\")\n\t\t$debut = mktime($heure, 0, 0, 03, 31, $annee);\n\t// 31-03-$annee\n\telse\n\t\t$debut = mktime($heure,0, 0, 10, 31, $annee);\n\t// 31-10-$annee\n\twhile (date(\"D\", $debut ) != 'Sun')\n\t\t$debut = mktime($heure, 0, 0, date(\"m\", $debut), date(\"d\", $debut) - 1, date(\"Y\", $debut));\n\t//On retire 1 jour par rapport \uff83\uf8f0 la date examin\uff83\uff69e\n\treturn $debut;\n}\n\n# Remove backslash-escape quoting if PHP is configured to do it with\n# magic_quotes_gpc. Use this whenever you need the actual value of a GET/POST\n# form parameter (which might have special characters) regardless of PHP's\n# magic_quotes_gpc setting.\nfunction unslashes($s)\n{\n\tif (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc())\n\t\treturn stripslashes($s);\n\telse\n\t\treturn $s;\n}\n\n// Corrige les caracteres degoutants utilises par les Windozeries\nfunction corriger_caracteres($texte)\n{\n\t// 145,146,180 = simple quote ; 147,148 = double quote ; 150,151 = tiret long\n\t$texte = strtr($texte, chr(145).chr(146).chr(180).chr(147).chr(148).chr(150).chr(151), \"'''\".'\"\"--');\n\treturn $texte;\n}\n\n// Traite les donn\uff83\uff69es avant insertion dans une requ\uff83\uff6ate SQL\nfunction protect_data_sql($_value)\n{\n\tglobal $use_function_mysql_real_escape_string;\n\t//if (get_magic_quotes_gpc())\n\tif (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc())\n\t\t$_value = stripslashes($_value);\n\tif (!is_numeric($_value))\n\t{\n\t\t/*if (isset($use_function_mysql_real_escape_string) && ($use_function_mysql_real_escape_string==0))\n\t\t\t$_value = mysqli_real_escape_string($GLOBALS['db_c'], $_value);\n\t\telse */\n        // pourquoi un test, puisque l'action est la m\uff83\uff6ame ? YN le 30/03/2018\n\t\t\t$_value = mysqli_real_escape_string($GLOBALS['db_c'], $_value);\n\t}\n\treturn $_value;\n}\n\n// Traite les donn\uff83\uff69es envoy\uff83\uff69es par la methode GET de la variable $_GET[\"page\"], renvoie \"day\" si la page n'est pas d\uff83\uff69finie\nfunction verif_page()\n{\n\t$page = array(\"day\", \"week\", \"month\", \"week_all\", \"month_all\", \"month_all2\", \"year\", \"year_all\");\n\tif (isset($_GET[\"page\"]))\n\t{\n\t\tif (in_array($_GET[\"page\"], $page))\n\t\t\treturn $_GET[\"page\"];\n\t\telse\n\t\t\treturn \"day\";\n\t}\n\telse\n\t\treturn \"day\";\n}\n\nfunction page_accueil($param='no') {\n   // Definition de $defaultroom\n   if ((isset($_SESSION['default_room']))&& ($_SESSION['default_room'] > -5)) {\n      $defaultroom = $_SESSION['default_room'];\n   } else {\n      $defaultroom = Settings::get(\"default_room\");\n   }\n   // Definition de $defaultsite\n   if (isset($_SESSION['default_site']) and ($_SESSION['default_site'] >0)) {\n      $defaultsite = $_SESSION['default_site'];\n   } else if (Settings::get(\"default_site\") > 0) {\n      $defaultsite = Settings::get(\"default_site\");\n   } else\n      $defaultsite = get_default_site();\n   // Definition de $defaultarea\n   if (isset($_SESSION['default_area']) and ($_SESSION['default_area'] >0)) {\n      $defaultarea = $_SESSION['default_area'];\n   } else if (Settings::get(\"default_area\") > 0) {\n      $defaultarea = Settings::get(\"default_area\");\n   } else\n      $defaultarea = get_default_area($defaultsite);\n   // Calcul de $page_accueil\n   if ($defaultarea == -1) {\n      $page_accueil=\"day.php?noarea=\"; // le param\uff83\uff68tre noarea ne sert \uff83\uf8f0 rien, il est juste l\uff83\uf8f0 pour \uff83\uff69viter un cas particulier \uff83\uf8f0 traiter avec &amp;id_site= et $param\n   } else if ($defaultroom == -1) {\n      $page_accueil=\"day.php?area=$defaultarea\";\n   } else if ($defaultroom == -2) {\n      $page_accueil=\"week_all.php?area=$defaultarea\";\n   } else if ($defaultroom == -3) {\n      $page_accueil=\"month_all.php?area=$defaultarea\";\n   } else if ($defaultroom == -4) {\n      $page_accueil=\"month_all2.php?area=$defaultarea\";\n   } else {\n      $page_accueil=\"week.php?area=$defaultarea&amp;room=$defaultroom\";\n   }\n   if ((Settings::get(\"module_multisite\") == \"Oui\") and ($defaultsite>0))\n       $page_accueil .= \"&amp;id_site=\".$defaultsite;\n   if ($param=='yes') $page_accueil .= \"&amp;\";\n   return $page_accueil ;\n}\n\nfunction begin_page($title, $page = \"with_session\")\n{\n\tif ($page == \"with_session\")\n\t{\n\t\tif (isset($_SESSION['default_style']))\n\t\t\t$sheetcss = 'themes/'.$_SESSION['default_style'].'/css';\n\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css'; // utilise le th\uff83\uff68me par d\uff83\uff69faut s'il n'a pas \uff83\uff69t\uff83\uff69 d\uff83\uff69fini... \uff83\uf8f0 voir YN le 11/04/2018\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (Settings::get(\"default_css\"))\n\t\t\t$sheetcss = 'themes/'.Settings::get(\"default_css\").'/css';\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css';\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\tglobal $vocab, $charset_html, $unicode_encoding, $clock_file, $use_select2, $use_admin;\n\theader('Content-Type: text/html; charset=utf-8');\n\tif (!isset($_COOKIE['open']))\n\t{\n\t\tsetcookie(\"open\", \"true\", time()+3600);\n\t}\n\t$a = '<!DOCTYPE html>'.PHP_EOL;\n\t$a .= '<html lang=\"fr\">'.PHP_EOL;\n\t$a .= '<head>'.PHP_EOL;\n\t$a .= '<meta charset=\"utf-8\">'.PHP_EOL;\n\t$a .= '<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">'.PHP_EOL;\n\t$a .= '<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">'.PHP_EOL;\n\t$a .= '<meta name=\"Robots\" content=\"noindex\" />'.PHP_EOL;\n\t$a .= '<title>'.$title.'</title>'.PHP_EOL;\n\n\tif (@file_exists('admin_accueil.php') || @file_exists('install_mysql.php')){ // Si on est dans l'administration\n\n        $a .= '<link rel=\"shortcut icon\" href=\"../favicon.ico\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../include/admin_grr.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/default/css/style.css\" />'.PHP_EOL; // le style par d\uff83\uff69faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\uff83\uff69\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/html2canvas.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/menu.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/functions.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui-i18n.min.js\"></script>'.PHP_EOL;\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"../js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/'.$clock_file.'\"></script>'.PHP_EOL;\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n   \t} \n    else\n    {\t\n        $a .= '<link rel=\"shortcut icon\" href=\"./favicon.ico\" />'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t    if (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n\t\t}\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/default/css/style.css\" />'.PHP_EOL; // le style par d\uff83\uff69faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\uff83\uff69\n\t\tif (isset($use_admin))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"include/admin_grr.css\" />'.PHP_EOL;\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui-i18n.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/html2canvas.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/menu.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/functions.js\" ></script>'.PHP_EOL;\n\t\tif (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\t}\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"./js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/'.$clock_file.'\"></script>'.PHP_EOL;\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n\t}\n\n\t$a .= '</head>'.PHP_EOL;\n\t$a .= '<body>'.PHP_EOL;\n\treturn $a;\n}\n\n/*\n** Fonction qui affiche le header\n*/\nfunction print_header($day = '', $month = '', $year = '', $type_session = 'with_session')\n{\n\tglobal $vocab, $search_str, $grrSettings, $clock_file, $desactive_VerifNomPrenomUser, $grr_script_name;\n\tglobal $use_prototype, $use_admin, $use_tooltip_js, $desactive_bandeau_sup, $id_site, $use_select2;\n\n\tif (@file_exists('./admin_access_area.php')){\n\t\t$adm = 1;\n\t\t$racine = \"../\";\n\t\t$racineAd = \"./\";\n\t}else{\n\t\t$adm = 0;\n\t\t$racine = \"./\";\n\t\t$racineAd = \"./admin/\";\n\t}\n\n\tinclude $racine.\"/include/hook.class.php\";\n\n\tif (!($desactive_VerifNomPrenomUser))\n\t\t$desactive_VerifNomPrenomUser = 'n';\n\t// On v\uff83\uff69rifie que les noms et pr\uff83\uff69noms ne sont pas vides\n\tVerifNomPrenomUser($type_session);\n\tif ($type_session == \"with_session\")\n\t\techo begin_page(Settings::get(\"company\"),\"with_session\");\n\telse\n\t\techo begin_page(Settings::get(\"company\"),\"no_session\");\n\n\tHook::Appel(\"hookHeader2\");\n\t// Si nous ne sommes pas dans un format imprimable\n\tif ((!isset($_GET['pview'])) || ($_GET['pview'] != 1))\n\t{\n\t\t// If we dont know the right date then make it up\n\t\tif (!isset($day) || !isset($month) || !isset($year) || ($day == '') || ($month == '') || ($year == ''))\n\t\t{\n\t\t\t$date_now = time();\n\t\t\tif ($date_now < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_now > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\telse\n\t\t\t\t$date_ = $date_now;\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t}\n\t\tif (!(isset($search_str)))\n\t\t\t$search_str = get_vocab(\"search_for\");\n\t\tif (empty($search_str))\n\t\t\t$search_str = \"\";\n\t\tif (!(isset($desactive_bandeau_sup) && ($desactive_bandeau_sup == 1) && ($type_session != 'with_session')))\n\t\t{\n\n\t\t\t// HOOK\n\t\t\tHook::Appel(\"hookHeader1\");\n\n\t\t\t// G\uff83\uff69n\uff83\uff69ration XML\n\t\t\t$generationXML = 1;\n\t\t\tif ((Settings::get(\"export_xml_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude \"{$racine}/include/generationxml.php\";\n\t\t\t}\n\t\t\tif ((Settings::get(\"export_xml_plus_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude \"{$racine}/include/generationxmlplus.php\";\n\t\t\t}\n\n\t\t\t// On fabrique une date valide pour la r\uff83\uff69servation si ce n'est pas le cas\n\t\t\t$date_ = mktime(0, 0, 0, $month, $day, $year);\n\t\t\tif ($date_ < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_ > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t\techo '<div id=\"toppanel\">'.PHP_EOL;\n\t\t\techo '<div id=\"panel\">'.PHP_EOL;\n\t\t\techo '<table id=\"header\">'.PHP_EOL;\n\t\t\techo '<tr>'.PHP_EOL;\n\t\t\t//Logo\n\t\t\t$nom_picture = $racine.\"images/\".Settings::get(\"logo\");\n\t\t\tif ((Settings::get(\"logo\") != '') && (@file_exists($nom_picture)))\n\t\t\t\techo '<td class=\"logo\" height=\"100\">'.PHP_EOL.'<a href=\"'.$racine.page_accueil('yes').'day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\"><img src=\"'.$nom_picture.'\" alt=\"logo\"/></a>'.PHP_EOL.'</td>'.PHP_EOL;\n\t\t\t//Accueil\n\t\t\techo '<td class=\"accueil \">',PHP_EOL,'<h2>',PHP_EOL,'<a href=\"'.$racine.page_accueil('yes'),'day=',$day,'&amp;year=',$year,'&amp;month=',$month,'\">',Settings::get(\"company\"),'</a>',PHP_EOL,'</h2>',PHP_EOL, Settings::get('message_accueil'),'</td>',PHP_EOL;\n\t\t\t//Mail r\uff83\uff69servation\n\t\t\t$sql = \"SELECT value FROM \".TABLE_PREFIX.\"_setting WHERE name='mail_etat_destinataire'\";\n\t\t\t$res = grr_sql_query1($sql);\n\t\t\tgrr_sql_free($res);\n\n\t\t\tif ( ( $res == 1 && $type_session == \"no_session\" ) || ( ( $res == 1 || $res == 2) && $type_session == \"with_session\" && (authGetUserLevel(getUserName(), -1, 'area')) == 1  ) )\n\t\t\t{\n\t\t\t\techo '<td class=\"contactformulaire\">',PHP_EOL,'<input class=\"btn btn-default\" type=\"submit\" rel=\"popup_name\" value=\"R\uff83\uff69server\" onClick=\"javascript:location.href=\\'contactFormulaire.php?day=',$day,'&amp;month=',$month,'&amp;year=',$year,'\\'\" >',PHP_EOL,'</td>',PHP_EOL;\n\t\t\t}\n\t\t\t// Administration\n\t\t\tif ($type_session == \"with_session\")\n\t\t\t{\n                $user_name = getUserName();\n                $mess_resa = resaToModerate($user_name);\n\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1) || ($mess_resa != ''))\n\t\t\t\t{\n\t\t\t\t\techo '<td class=\"administration\">'.PHP_EOL;\n\t\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1))\n                        echo \"<br><a href='{$racineAd}admin_accueil.php?day={$day}&amp;month={$month}&amp;year={$year}'>\".get_vocab('admin').\"</a>\".PHP_EOL;\n\t\t\t\t\tif (authGetUserLevel(getUserName(), -1, 'area') >= 6)\n\t\t\t\t\t{\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\t\thow_many_connected();\n                        echo \"<br />\";\n\t\t\t\t\t}\n                    echo \"<p class='avertissement'>\".$mess_resa.\"</p>\";\n                    \n\t\t\t\t\techo '</td>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($type_session != \"with_session\")\n\t\t\t\techo '<script>selection()</script>'.PHP_EOL;\n\t\t\techo '<td class=\"configuration\" >'.PHP_EOL;\n\t\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t{\n\t\t\t\techo '<div class=\"clock\">'.PHP_EOL;\n\t\t\t\techo '<div id=\"Date\">'.PHP_EOL;\n\t\t\t\techo '&nbsp;<span id=\"hours\"></span>'.PHP_EOL;\n\t\t\t\techo 'h'.PHP_EOL;\n\t\t\t\techo '<span id=\"min\"></span>'.PHP_EOL;\n\t\t\t\techo '</div></div>'.PHP_EOL;\n\t\t\t}\n\t\t\t$_SESSION['chemin_retour'] = '';\n\t\t\tif (isset($_SERVER['QUERY_STRING']) && ($_SERVER['QUERY_STRING'] != ''))\n\t\t\t{\n\t\t\t\t$parametres_url = htmlspecialchars($_SERVER['QUERY_STRING']).\"&amp;\";\n\t\t\t\t$_SESSION['chemin_retour'] = traite_grr_url($grr_script_name).\"?\". $_SERVER['QUERY_STRING'];\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=fr\"><img src=\"'.$racine.'img_grr/fr_dp.png\" alt=\"France\" title=\"france\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=de\"><img src=\"'.$racine.'img_grr/de_dp.png\" alt=\"Deutch\" title=\"deutch\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=en\"><img src=\"'.$racine.'img_grr/en_dp.png\" alt=\"English\" title=\"English\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=it\"><img src=\"'.$racine.'img_grr/it_dp.png\" alt=\"Italiano\" title=\"Italiano\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=es\"><img src=\"'.$racine.'img_grr/es_dp.png\" alt=\"Spanish\" title=\"Spanish\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t}\n\t\t\tif ($type_session == 'no_session')\n\t\t\t{\n\t\t\t\tif ((Settings::get('sso_statut') == 'cas_visiteur') || (Settings::get('sso_statut') == 'cas_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br /> <a href=\"index.php?force_authentification=y\">'.get_vocab(\"authentification\").'</a>'.PHP_EOL;\n\t\t\t\t\techo '<br /> <small><i><a href=\"login.php\">'.get_vocab(\"connect_local\").'</a></i></small>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo '<br /> <a href=\"login.php\">'.get_vocab(\"connect\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif( strlen(htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom'])) > 40 )\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['nom']);\n\t\t\t\telse\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom']);\n\t\t\t\n\t\t\t\techo '<br /><a href=\"'.$racine.'my_account.php?day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\">'. $nomAffichage .' - '.get_vocab(\"manage_my_account\").'</a>'.PHP_EOL;\n\t\t\t\tif (verif_access_search(getUserName()))\n\t\t\t\t\techo '<br/><a href=\"'.$racine.'report.php\">'.get_vocab(\"report\").'</a>'.PHP_EOL;\n\t\t\t\t$disconnect_link = false;\n\t\t\t\tif (!((Settings::get(\"cacher_lien_deconnecter\") == 'y') && (isset($_SESSION['est_authentifie_sso']))))\n\t\t\t\t{\n\t\t\t\t\t$disconnect_link = true;\n\t\t\t\t\tif (Settings::get(\"authentification_obli\") == 1)\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0&amp;redirect_page_accueil=yes\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get(\"Url_portail_sso\") != '') && (isset($_SESSION['est_authentifie_sso'])))\n\t\t\t\t{\n\t\t\t\t\tif ($disconnect_link)\n\t\t\t\t\t\techo ' - '.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\techo '<a href=\"'.Settings::get(\"Url_portail_sso\").'\">'.get_vocab(\"Portail_accueil\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get('sso_statut') == 'lasso_visiteur') || (Settings::get('sso_statut') == 'lasso_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br />';\n\t\t\t\t\tif ($_SESSION['lasso_nameid'] == NULL)\n\t\t\t\t\t\techo '<a href=\"lasso/federate.php\">'.get_vocab('lasso_federate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<a href=\"lasso/defederate.php\">'.get_vocab('lasso_defederate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\techo '</td>'.PHP_EOL;\n\t\t\techo '</tr>'.PHP_EOL;\n\t\t\techo '</table>'.PHP_EOL;\n\t\t\techo '</div>'.PHP_EOL;\n\t\t\techo '<a id=\"open\" class=\"open\" href=\"#\"><span class=\"glyphicon glyphicon-arrow-up\"><span class=\"glyphicon glyphicon-arrow-down\"></span></span></a>'.PHP_EOL;\n\t\t\techo '</div>'.PHP_EOL;\n\t\t}\n\t}\n}\n\n/**\n * @param string $type\n */\nfunction VerifNomPrenomUser($type)\n{\n\t// ne pas prendre en compte la page my_account.php\n\tglobal $desactive_VerifNomPrenomUser;\n\tif (($type == \"with_session\") && ($desactive_VerifNomPrenomUser != 'y') && (IsAllowedToModifyProfil()))\n\t{\n\t\t$test = grr_sql_query1(\"SELECT login FROM \".TABLE_PREFIX.\"_utilisateurs WHERE (login = '\".getUserName().\"' AND (nom='' or prenom = ''))\");\n\t\tif ($test != -1)\n\t\t{\n\t\t\theader(\"Location:my_account.php\");\n\t\t\tdie();\n\t\t}\n\t}\n}\n//V\uff83\uff69rifie si utilisateur autoris\uff83\uff69 \uff83\uf8f0 changer ses noms et pr\uff83\uff69noms et mail\n//Renvoie true (peut changer ses noms et pr\uff83\uff69noms et email) ou false (ne peut pas)\nfunction sso_IsAllowedModify()\n{\n\tif (Settings::get(\"sso_IsNotAllowedModify\")==\"y\")\n\t{\n\t\t$source = grr_sql_query1(\"SELECT source FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".getUserName().\"'\");\n\t\tif ($source == \"ext\")\n\t\t\treturn false;\n\t\telse\n\t\t\treturn true;\n\t}\n\telse\n\t\treturn true;\n}\n//V\uff83\uff69rifie que l'utilisateur est autoris\uff83\uff69 \uff83\uf8f0 changer ses noms et pr\uff83\uff69noms\n//Renvoie true (peut changer ses noms et pr\uff83\uff69noms) ou false (ne peut pas)\nfunction IsAllowedToModifyProfil()\n{\n\tif (!(sso_IsAllowedModify()))\n\t\treturn false;\n\t\t// l'utilisateur connect\uff83\uff69 n'a pas le niveau suffisant pour modifier son compte\n\tif (authGetUserLevel(getUserName(),-1) < Settings::get(\"allow_users_modify_profil\"))\n\t\treturn false;\n\telse\n\t\treturn true;\n}\n//V\uff83\uff69rifie que l'utilisateur est autoris\uff83\uff69 \uff83\uf8f0 changer son emai\n//Renvoie true (peut changer son email) ou false (ne peut pas)\nfunction IsAllowedToModifyEmail()\n{\n\tif (!(sso_IsAllowedModify()))\n\t\treturn false;\n\t\t// l'utilisateur connect\uff83\uff69 n'a pas le niveau suffisant pour modifier son compte\n\tif (authGetUserLevel(getUserName(),-1) < Settings::get(\"allow_users_modify_email\"))\n\t\treturn false;\n\telse\n\t\treturn true;\n}\n//V\uff83\uff69rifie que l'utilisateur est autoris\uff83\uff69 \uff83\uf8f0 changer son mot de passe\n//Renvoie true (peut changer) ou false (ne peut pas)\nfunction IsAllowedToModifyMdp() {\n\t\t// l'utilisateur connect\uff83\uff69 n'a pas le niveau suffisant pour modifier son compte\n\tif (authGetUserLevel(getUserName(), -1) < Settings::get(\"allow_users_modify_mdp\"))\n\t\treturn false;\n\telse if ((Settings::get(\"sso_statut\") != \"\") or (Settings::get(\"ldap_statut\") != '') or (Settings::get(\"imap_statut\") != ''))\n\t{\n\t\t\t// ou bien on est dans un environnement SSO ou ldap et l'utilisateur n'est pas un utilisateur local\n\t\t$source = grr_sql_query1(\"SELECT source FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".getUserName().\"'\");\n\t\tif ($source == \"ext\")\n\t\t\treturn false;\n\t\telse\n\t\t\treturn true;\n\t}\n\telse\n\t\treturn true;\n}\n// Transforme $dur en une dur\uff83\uff69e exprim\uff83\uff69e en ann\uff83\uff69es, semaines, jours, heures, minutes et secondes\n// OU en dur\uff83\uff69e num\uff83\uff69rique exprim\uff83\uff69e dans l'une des unit\uff83\uff69s de fa\uff83\uff67on fixe, pour l'\uff83\uff69dition des\n// r\uff83\uff69servations par dur\uff83\uff69e.\n// $dur : dur\uff83\uff69e sous forme d'une chaine de caract\uff83\uff68re quandd $edition=false, sinon, dur\uff83\uff69e en valeur num\uff83\uff69rique.\n// $units : variable conserv\uff83\uff69e uniquement pour compatibilit\uff83\uff69 avec la fonction toTimeString originale\n//          si $edition=false, sinon, contient l'unit\uff83\uff69 utilis\uff83\uff69e pour $dur\n// $edition : Valeur par d\uff83\uff69faut : false. Indique si le retour est pour affichage ou pour modifier la dur\uff83\uff69e.\n// Version \uff83\uff69crite par David M - E-Concept Applications\nfunction toTimeString(&$dur, &$units, $edition = false)\n{\n\tglobal $vocab;\n\tif ($edition)\n\t{\n\t\tif ($dur >= 60)\n\t\t{\n\t\t\t$dur = $dur / 60;\n\t\t\tif ($dur >= 60)\n\t\t\t{\n\t\t\t\t$dur /= 60;\n\t\t\t\tif (($dur >= 24) && ($dur % 24 == 0))\n\t\t\t\t{\n\t\t\t\t\t$dur /= 24;\n\t\t\t\t\tif (($dur >= 7) && ($dur % 7 == 0))\n\t\t\t\t\t{\n\t\t\t\t\t\t$dur /= 7;\n\t\t\t\t\t\tif (($dur >= 52) && ($dur % 52 == 0))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$dur  /= 52;\n\t\t\t\t\t\t\t$units = get_vocab(\"years\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t$units = get_vocab(\"weeks\");\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t\t$units = get_vocab(\"days\");\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\t$units = get_vocab(\"hours\");\n\t\t\t}\n\t\t\telse\n\t\t\t\t$units = get_vocab(\"minutes\");\n\t\t}\n\t\telse\n\t\t\t$units = get_vocab(\"seconds\");\n\t}\n\telse\n\t{\n\t\t$duree_formatee = \"\";\n\t\t$not_first_unit = false;\n\t\t// On d\uff83\uff69finit la dur\uff83\uff69e en secondes de chaque type d'unit\uff83\uff69\n\t\t$annee   = 60 * 60 * 24 * 365;\n\t\t$semaine = 60 * 60 * 24 * 7;\n\t\t$jour    = 60 * 60 * 24;\n\t\t$heure   = 60 * 60;\n\t\t$minute  = 60;\n\t\t// On calcule le nombre d'ann\uff83\uff69es.\n\t\t$nb_annees = floor($dur / $annee);\n\t\tif ($nb_annees > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_annees . \" \" . get_vocab(\"years\");\n\t\t\t// On soustrait le nombre d'ann\uff83\uff69es d\uff83\uff69j\uff83\uf8f0 d\uff83\uff69termin\uff83\uff69es \uff83\uf8f0 la dur\uff83\uff69e initiale.\n\t\t\t$dur = $dur - $nb_annees * $annee;\n\t\t}\n\t\t// On calcule le nombre de semaines.\n\t\t$nb_semaines = floor($dur / $semaine);\n\t\tif ($nb_semaines > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_semaines . \" \" . get_vocab(\"weeks\");\n\t\t\t// On soustrait le nombre de semaines d\uff83\uff69j\uff83\uf8f0 d\uff83\uff69termin\uff83\uff69es \uff83\uf8f0 la dur\uff83\uff69e initiale.\n\t\t\t$dur = $dur - $nb_semaines * $semaine;\n\t\t}\n\t\t// On calcule le nombre de jours.\n\t\t$nb_jours = floor($dur / $jour);\n\t\tif ($nb_jours > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_jours . \" \" . get_vocab(\"days\");\n\t\t\t// On soustrait le nombre de jours d\uff83\uff69j\uff83\uf8f0 d\uff83\uff69termin\uff83\uff69s \uff83\uf8f0 la dur\uff83\uff69e initiale.\n\t\t\t$dur = $dur - $nb_jours * $jour;\n\t\t}\n\t\t// On calcule le nombre d'heures.\n\t\t$nb_heures = floor($dur / $heure);\n\t\tif ($nb_heures > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_heures . \" \" . get_vocab(\"hours\");\n\t\t\t// On soustrait le nombre d'heures d\uff83\uff69j\uff83\uf8f0 d\uff83\uff69termin\uff83\uff69es \uff83\uf8f0 la dur\uff83\uff69e initiale.\n\t\t\t$dur = $dur - $nb_heures * $heure;\n\t\t}\n\t\t// On calcule le nombre de minutes.\n\t\t$nb_minutes = floor($dur / $minute);\n\t\tif ($nb_minutes > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_minutes . \" \" . get_vocab(\"minutes\");\n\t\t\t\t\t\t// On soustrait le nombre de minutes d\uff83\uff69j\uff83\uf8f0 d\uff83\uff69termin\uff83\uff69es \uff83\uf8f0 la dur\uff83\uff69e initiale.\n\t\t\t$dur = $dur - $nb_minutes * $minute;\n\t\t}\n\t\t\t\t// On calcule le nombre de secondes.\n\t\tif ($dur > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\t$duree_formatee .= $dur . \" \" . get_vocab(\"seconds\");\n\t\t}\n\t\t// On s\uff83\uff69pare les diff\uff83\uff69rentes unit\uff83\uff69s de la chaine.\n\t\t$tmp = explode(\", \", $duree_formatee);\n\t\t// Si on a plus d'une unit\uff83\uff69e...\n\t\tif (count($tmp) > 1)\n\t\t{\n\t\t\t// ... on d\uff83\uff69pile le tableau par la fin...\n\t\t\t$tmp_fin = array_pop($tmp);\n\t\t\t// ... on reconstiture la chaine avec les premiers \uff83\uff69l\uff83\uff69ments...\n\t\t\t$duree_formatee = implode(\", \", $tmp);\n\t\t\t// ... et on ajoute le dernier \uff83\uff69l\uff83\uff69ment\n\t\t\t$duree_formatee .= \" et \" . $tmp_fin;\n\t\t}\n\t\t// Sinon, on ne change rien.\n\t\t$dur = $duree_formatee;\n\t\t$units = \"\";\n\t}\n}\n// Transforme $dur en un nombre entier\n// $dur : dur\uff83\uff69e\n// $units : unit\uff83\uff69\n/**\n * @param integer $start_period\n */\nfunction toPeriodString($start_period, &$dur, &$units)\n{\n\t// la dur\uff83\uff69e est donn\uff83\uff69e en secondes\n\tglobal $enable_periods, $periods_name, $vocab;\n\t$max_periods = count($periods_name);\n\t$dur /= 60; // on transforme la dur\uff83\uff69e en minutes\n\t// Chaque minute correspond \uff83\uf8f0 un cr\uff83\uff69neau\n\tif ( $dur >= $max_periods || $start_period == 0 )\n\t{\n\t\tif ( $start_period == 0 && $dur == $max_periods )\n\t\t{\n\t\t\t$units = get_vocab(\"periods\");\n\t\t\t$dur = $max_periods;\n\t\t\treturn;\n\t\t}\n\t\t$dur /= 60;\n\t\tif (($dur >= 24) && is_int($dur))\n\t\t{\n\t\t\t$dur /= 24;\n\t\t\t$units = get_vocab(\"days\");\n\t\t\treturn;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$dur *= 60;\n\t\t\t$dur = ($dur % $max_periods) + floor( $dur/(24*60) ) * $max_periods;\n\t\t\t$units = get_vocab(\"periods\");\n\t\t\treturn;\n\t\t}\n\t}\n\telse\n\t\t$units = get_vocab(\"periods\");\n}\n\n/**\n* @param string $prefix\n* @param string $option\n*/\nfunction genDateSelectorForm($prefix, $day, $month, $year, $option)\n{\n\tglobal $nb_year_calendar;\n\t$selector_data = \"\";\n\tif (!isset($nb_year_calendar))\n\t\t$nb_year_calendar = 5;\n\tif (($day == 0) && ( $day != \"\"))\n\t\t$day = date(\"d\");\n\tif ($month == 0)\n\t\t$month = date(\"m\");\n\tif ($year == 0)\n\t\t$year = date(\"y\");\n\tif ($day != \"\")\n\t{\n\t\t$selector_data .= \"<select class='test' name=\\\"${prefix}day\\\" id=\\\"${prefix}day\\\">\\n\";\n\t\tfor ($i = 1; $i <= 31; $i++)\n\t\t{\n\t\t\tif ($i < 10)\n\t\t\t\t$selector_data .= \"<option\" . ($i == $day ? \" selected=\\\"selected\\\"\" : \"\") . \">0$i</option>\\n\";\n\t\t\telse\n\t\t\t\t$selector_data .= \"<option\" . ($i == $day ? \" selected=\\\"selected\\\"\" : \"\") . \">$i</option>\\n\";\n\t\t}\n\t\t$selector_data .= \"</select>\";\n\t}\n\t$selector_data .= \"<select class='test' name=\\\"${prefix}month\\\" id=\\\"${prefix}month\\\">\\n\";\n\tfor ($i = 1; $i <= 12; $i++)\n\t{\n\t\t$m = utf8_strftime(\"%b\", mktime(0, 0, 0, $i, 1, $year));\n\t\tif ($i < 10)\n\t\t{\n\t\t\t$selector_data .=  \"<option value=\\\"0$i\\\"\" . ($i == $month ? \" selected=\\\"selected\\\"\" : \"\") . \">$m</option>\\n\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$selector_data .=  \"<option value=\\\"$i\\\"\" . ($i == $month ? \" selected=\\\"selected\\\"\" : \"\") . \">$m</option>\\n\";\n\t\t}\n\t}\n\t$selector_data .=  \"</select>\";\n\t$selector_data .=  \"<select class='test' name=\\\"${prefix}year\\\" id=\\\"${prefix}year\\\">\\n\";\n\t$min = strftime(\"%Y\", Settings::get(\"begin_bookings\"));\n\tif ($option == \"more_years\")\n\t\t$min = date(\"Y\") - $nb_year_calendar;\n\t$max = strftime(\"%Y\", Settings::get(\"end_bookings\"));\n\tif ($option == \"more_years\")\n\t\t$max = date(\"Y\") + $nb_year_calendar;\n\tfor($i = $min; $i <= $max; $i++)\n\t\t$selector_data .= \"<option value=\\\"$i\\\" \" . ($i == $year ? \" selected=\\\"selected\\\"\" : \"\") . \">$i</option>\\n\";\n\t$selector_data .= \"</select> \\n\\n\";\n\treturn $selector_data;\n}\n\n/**\n * @param string $prefix\n * @param string $option\n */\nfunction genDateSelector($prefix, $day, $month, $year, $option)\n{\n\techo genDateSelectorForm($prefix, $day, $month, $year, $option);\n}\n\n/**\n * @param integer $need_header\n */\nfunction fatal_error($need_header, $message, $show_form_data = true)\n{\n\tglobal $vocab;\n\tif ($need_header)\n\t\tstart_page_w_header(0, 0, 0, 0);\n\terror_log(\"GRR: \".$message);\n\tif ($show_form_data)\n\t{\n\t\tif (!empty($_GET))\n\t\t{\n\t\t\terror_log(\"GRR GET: \".print_r($_GET, true));\n\t\t}\n\t\tif (!empty($_POST))\n\t\t{\n\t\t\terror_log(\"GRR POST: \".print_r($_POST, true));\n\t\t}\n\t}\n\tif (!empty($_SESSION))\n\t{\n\t\terror_log(\"GRR SESSION: \".print_r($_SESSION, true));\n\t}\n\techo '<p>',$message,'</p>'.PHP_EOL;\n\tend_page();\n\texit;\n}\n\n/**\n * Compare une ip \uff83\uf8f0 d'autres iP - CIDR\n */\nfunction compare_ip_adr($ip1, $ips2)\n{\n\n\t$ipCorrespondante = false;\n    $ip2 = explode(';', $ips2);\n\t\n    $resultIP = in_array($ip1,$ip2,true);\n\tif($resultIP == false){ // cherche si l'adresse est dans une plage CIDR p.ex. 192.168.1.0/24 --> 192.168.1.0 \uff83\uf8f0 192.168.1.255\n        foreach ($ip2 as $ip){\n            $slash = strpos($ip,'/');\n            if ($slash !== false){\n                list($net,$mask) = preg_split(\"~/~\",$ip);\n                $lnet=ip2long($net);\n                $lip=ip2long($ip1);\n                $binnet=str_pad( decbin($lnet),32,\"0\",STR_PAD_LEFT );\n                $firstpart=substr($binnet,0,$mask);\n                $binip=str_pad( decbin($lip),32,\"0\",STR_PAD_LEFT );\n                $firstip=substr($binip,0,$mask);\n                $resultIP = (strcmp($firstpart,$firstip)==0);\n            }\n            if ($resultIP){\n\t\t\t\t$ipCorrespondante = true;\n\t\t\t\tbreak;\n\t\t\t}\n        }\n\t} else {\n\t\t$ipCorrespondante = true;\n\t}\n\n\treturn $ipCorrespondante;\n\n}\n\n//Retourne le domaine par d\uff83\uff69faut; Utilis\uff83\uff69 si aucun domaine n'a \uff83\uff69t\uff83\uff69 d\uff83\uff69fini.\nfunction get_default_area($id_site = -1)\n{\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multisite = true;\n\telse\n\t\t$use_multisite = false;\n\tif (OPTION_IP_ADR==1)\n\t{\n\t\t$sql = \"SELECT ip_adr, id FROM \".TABLE_PREFIX.\"_area WHERE ip_adr!='' ORDER BY access, order_display, area_name\";\n\t\t$res = grr_sql_query($sql);\n\t\tif ($res)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (compare_ip_adr($_SERVER['REMOTE_ADDR'],$row[0]))\n\t\t\t\t{\n\t\t\t\t\treturn $row[1];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tif (authGetUserLevel(getUserName(),-1) >= 6)\n\t{\n\t\tif (($id_site != -1) and ($use_multisite))\n\t\t\t$res = grr_sql_query(\"SELECT a.id\n\t\t\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\t\t\tWHERE a.id=j.id_area and j.id_site=$id_site\n\t\t\t\tORDER BY a.order_display, a.area_name\");\n\t\telse\n\t\t\t$res = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_area ORDER BY access, order_display, area_name\");\n\t}\n\telse\n\t{\n\t\tif (($id_site != -1) and ($use_multisite))\n\t\t\t$res = grr_sql_query(\"SELECT a.id\n\t\t\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\t\t\tWHERE a.id=j.id_area and j.id_site=$id_site and a.access!='r'\n\t\t\t\tORDER BY a.order_display, a.area_name\");\n\t\telse\n\t\t\t$res = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE access!='r' ORDER BY access, order_display, area_name\");\n\t}\n\tif ($res && grr_sql_count($res)>0 )\n\t{\n\t\t$row = grr_sql_row($res, 0);\n\t\tgrr_sql_free($res);\n\t\treturn $row[0];\n\t}\n\telse\n\t{\n\t\tif (($id_site != -1) and ($use_multisite))\n\t\t\t$res = grr_sql_query(\"SELECT a.id\n\t\t\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j, \".TABLE_PREFIX.\"_j_user_area u\n\t\t\t\tWHERE a.id=j.id_area and j.id_site=$id_site and a.id=u.id_area and u.login='\" . getUserName() . \"'\n\t\t\t\tORDER BY a.order_display, a.area_name\");\n\t\telse\n\t\t\t$res = grr_sql_query(\"select id from \".TABLE_PREFIX.\"_area, \".TABLE_PREFIX.\"_j_user_area WHERE\n\t\t\t\t\".TABLE_PREFIX.\"_area.id=\".TABLE_PREFIX.\"_j_user_area.id_area and\n\t\t\t\tlogin='\" . getUserName() . \"'\n\t\t\t\tORDER BY order_display, area_name\");\n\t\tif ($res && grr_sql_count($res)>0 )\n\t\t{\n\t\t\t$row = grr_sql_row($res, 0);\n\t\t\tgrr_sql_free($res);\n\t\t\treturn $row[0];\n\t\t}\n\t\telse\n\t\t\treturn -1;\n\t}\n}\n/* fonction get_default_site\n    renvoie id_site du site par d\uff83\uff69faut de l'utilisateur, sinon celui de la table setting, sinon celui de plus petit id dans la table site\n*/\n\nfunction get_default_site()\n{\n    $user = getUserName();\n    if ($user != ''){\n        $id_site = grr_sql_query1(\"SELECT default_site FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login =\".$user);\n        if ($id_site > 0){return $id_site;}\n    }\n    // ici l'utilisateur n'est pas reconnu ou il n'a pas de site par d\uff83\uff69faut : on passe aux informations de la table settings\n    $id_site = grr_sql_query1(\"SELECT VALUE FROM \".TABLE_PREFIX.\"_setting WHERE NAME ='default_site' \");\n    $test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_site WHERE id = \".$id_site);\n    if ($test >0){return $id_site;}\n    else { // il n'y a pas de site par d\uff83\uff69faut dans la table setting, on prend le premier site\n        $id_site = grr_sql_query1(\"SELECT min(id) FROM \".TABLE_PREFIX.\"_site \");\n        return($id_site);\n    }\n}\n// fonction get_default_room\n/*  renvoie id_room de la ressource par d\uff83\uff69faut de l'utilisateur, sinon celle de la table setting, sinon celle de plus petit indice dans la table room \n*/\nfunction get_default_room(){\n    $user = getUserName();\n    if ($user != ''){\n        $id_room = grr_sql_query1(\"SELECT default_room FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login =\".$user);\n        if ($id_room > 0){return $id_room;}\n    }\n    // ici l'utilisateur n'est pas reconnu ou il n'a pas de ressource par d\uff83\uff69faut : on passe aux informations de la table settings\n    $id_room = grr_sql_query1(\"SELECT VALUE FROM \".TABLE_PREFIX.\"_setting WHERE NAME ='default_room' \");\n    $test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_room WHERE id = \".$id_room);\n    if ($test >0){return $id;}\n    else { // il n'y a pas de ressource par d\uff83\uff69faut dans la table setting, on prend la premi\uff83\uff68re ressource\n        $id_room = grr_sql_query1(\"SELECT min(id) FROM \".TABLE_PREFIX.\"_room \");\n        return($id_room);\n    }\n}\n# Get the local day name based on language. Note 2000-01-02 is a Sunday.\n/**\n * @param integer $daynumber\n */\nfunction day_name($daynumber)\n{\n\treturn utf8_encode(strftime(\"%A\", mktime(0, 0, 0, 1, 2 + $daynumber, 2000)));\n}\n\nfunction affiche_heure_creneau($t,$resolution)\n{\n\tglobal $twentyfourhour_format;\n\tif ($twentyfourhour_format)\n\t\t$hour_min_format = \"H:i\";\n\telse\n\t\t$hour_min_format = \"h:ia\";\n    $heure_debut = date($hour_min_format,$t);\n    $heure_fin = date($hour_min_format, $t + $resolution);\n    if ($heure_fin == \"00:00\") $heure_fin = \"24:00\";\n\treturn  $heure_debut.\" - \".$heure_fin;\n}\n\nfunction hour_min_format()\n{\n\tglobal $twentyfourhour_format;\n\tif ($twentyfourhour_format)\n\t{\n\t\treturn \"H:i\";\n\t}\n\telse\n\t{\n\t\treturn \"h:ia\";\n\t}\n}\n\n/*\nFonction utilis\uff83\uff69e dans le cas o\uff83\uff79 les cr\uff83\uff69neaux de r\uff83\uff69servation sont bas\uff83\uff69s sur des intitul\uff83\uff69s pr\uff83\uff69-d\uff83\uff69finis :\nFormatage de la date de d\uff83\uff69but ou de fin de r\uff83\uff69servation.\nDans le cas du d\uff83\uff69but de r\uff83\uff69servation on a $mod_time=0\nDans le cas de la fin de r\uff83\uff69servation on a $mod_time=-1\n*/\nfunction period_date_string($t, $mod_time = 0)\n{\n\tglobal $periods_name, $dformat;\n\t$time = getdate($t);\n\t$p_num = $time[\"minutes\"] + $mod_time;\n\tif ( $p_num < 0 )\n\t{\n\t\t// fin de r\uff83\uff69servation : cas $time[\"minutes\"] = 0. il faut afficher le dernier cr\uff83\uff69neau de la journ\uff83\uff69e pr\uff83\uff69c\uff83\uff69dente\n\t\t$t = $t - 60 * 60 * 24;\n\t\t$p_num = count($periods_name) - $p_num;\n\t}\n\tif ( $p_num >= count($periods_name) - 1 )\n\t\t$p_num = count($periods_name) - 1;\n\treturn array($p_num, $periods_name[$p_num] . utf8_strftime(\", \".$dformat, $t));\n}\n// la m\uff83\uff6ame, avec un r\uff83\uff69sultat diff\uff83\uff69rent, pour les rapports csv\nfunction period_date_string_rapport($t, $mod_time = 0)\n{\n\tglobal $periods_name, $dformat;\n\t$time = getdate($t);\n\t$p_num = $time[\"minutes\"] + $mod_time;\n\tif ( $p_num < 0 )\n\t{\n\t\t// fin de r\uff83\uff69servation : cas $time[\"minutes\"] = 0. il faut afficher le dernier cr\uff83\uff69neau de la journ\uff83\uff69e pr\uff83\uff69c\uff83\uff69dente\n\t\t$t = $t - 60 * 60 * 24;\n\t\t$p_num = count($periods_name) - $p_num;\n\t}\n\tif ( $p_num >= count($periods_name) - 1 )\n\t\t$p_num = count($periods_name) - 1;\n\treturn array($periods_name[$p_num],utf8_strftime($dformat, $t));\n}\n/*\nFonction utilis\uff83\uff69e dans le cas o\uff83\uff79 les cr\uff83\uff69neaux de r\uff83\uff69servation sont bas\uff83\uff69s sur des intitul\uff83\uff69s pr\uff83\uff69-d\uff83\uff69finis :\nFormatage des p\uff83\uff69riodes de d\uff83\uff69but ou de fin de r\uff83\uff69servation.\nDans le cas du d\uff83\uff69but de r\uff83\uff69servation on a $mod_time=0\nDans le cas de la fin de r\uff83\uff69servation on a $mod_time=-1\n*/\nfunction period_time_string($t, $mod_time = 0)\n{\n\tglobal $periods_name;\n\t$time = getdate($t);\n\t$p_num = $time[\"minutes\"] + $mod_time;\n\tif ( $p_num < 0 )\n\t\t$p_num = 0;\n\tif ( $p_num >= count($periods_name) - 1 )\n\t\t$p_num = count($periods_name) - 1;\n\treturn $periods_name[$p_num];\n}\n/* donne, pour un format fran\uff83\uff67ais, un r\uff83\uff69sultat de la forme lundi 30 sept. - 19:17\n*/\nfunction time_date_string($t, $dformat)\n{\n\tglobal $twentyfourhour_format;\n\t// This bit's necessary, because it seems %p in strftime format\n\t// strings doesn't work\n\tif ($twentyfourhour_format)\n\t\treturn utf8_strftime($dformat.\" - %H:%M\",$t);\n\telse\n\t\treturn utf8_strftime(\"%I:%M\".date(\"a\", $t).\" - \".$dformat,$t);\n}\n\nfunction time_date_string_jma($t,$dformat)\n{\n\treturn utf8_strftime($dformat, $t);\n}\n/*\nancien code. Je ne vois pas l'int\uff83\uff69r\uff83\uff6at du test YN le 25/09/19\n{\n\tglobal $twentyfourhour_format;\n\t//his bit's necessary, because it seems %p in strftime format\n\t//strings doesn't work\n\tif ($twentyfourhour_format)\n\t\treturn utf8_strftime($dformat, $t);\n\telse\n\t\treturn utf8_strftime($dformat, $t);\n}*/\n\n// Renvoie une balise span avec un style background-color correspondant au type de  la r\uff83\uff69servation\nfunction span_bgground($colclass)\n{\n\tglobal $tab_couleur;\n\tstatic $ecolors;\n\t$couleurhexa = grr_sql_query1(\"SELECT couleurhexa FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n\techo '<span style=\"background-color: '.$couleurhexa.'; background-image: none; background-repeat: repeat; background-attachment: scroll;\">'.PHP_EOL;\n}\n\n//Output a start table cell tag <td> with color class and fallback color.\nfunction tdcell($colclass, $width = '')\n{\n\tif ($width != \"\")\n\t\t$temp = ' style=\"width:'.$width.'%;\" ';\n\telse\n\t\t$temp = \"\";\n\tglobal $tab_couleur;\n\tstatic $ecolors;\n\tif (($colclass >= \"A\") && ($colclass <= \"Z\"))\n\t{\n\t\t/*$couleurhexa = grr_sql_query1(\"SELECT couleurhexa FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n        $couleur_texte = grr_sql_query1(\"SELECT couleur_texte FROM\".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n\t\techo '<td style=\"background-color:'.$couleurhexa.'; color:'.$couleur_texte.';\" '.$temp.'>'.PHP_EOL;*/\n        echo '<td class=\"type'.$colclass.'\"'.$temp.'>';\n\t}\n\telse\n\t\techo '<td class=\"'.$colclass.'\" '.$temp.'>'.PHP_EOL;\n}\n\nfunction tdcell_rowspan($colclass, $step)\n{\n\tglobal $tab_couleur;\n\tstatic $ecolors;\n\tif ($step < 1)\n\t\t$step = 1;\n\tif (($colclass >= \"A\") && ($colclass <= \"Z\"))\n\t{\n\t\t/*$couleurhexa = grr_sql_query1(\"SELECT couleurhexa FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n\t\techo '<td rowspan=\"'.$step.'\" style=\"background-color:'.$couleurhexa.';\">'.PHP_EOL;*/\n        echo '<td class=\"type'.$colclass.'\" rowspan=\"'.$step.'\">';\n\t}\n\telse\n\t\techo '<td rowspan=\"'.$step.'\" class=\"'.$colclass.'\">'.PHP_EOL;\n}\n\n//Display the entry-type color key. This has up to 2 rows, up to 10 columns.\nfunction show_colour_key($area_id)\n{\n    $sql = \"SELECT DISTINCT t.id, t.type_name, t.type_letter, t.order_display FROM `\".TABLE_PREFIX.\"_type_area` t\n    LEFT JOIN `\".TABLE_PREFIX.\"_j_type_area` j on j.id_type=t.id\n    WHERE (j.id_area IS NULL or j.id_area != '\".$area_id.\"')\n    AND NOT EXISTS (SELECT y.id_type FROM `\".TABLE_PREFIX.\"_j_type_area` y WHERE y.id_type = j.id_type and id_area='\".$area_id.\"')\n    ORDER BY t.order_display\";\n    $res = grr_sql_query($sql);\n    echo '<table class=\"legende\">';\n    echo '<caption>'.get_vocab(\"show_color_key\").'</caption>'.PHP_EOL;\n    if ($res)\n    {\n        $nct = -1;\n        for ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n        {\n            $type_name = $row[1];\n            $type_letter = $row[2];\n            if ($nct == -1)\n                echo '<tr>'.PHP_EOL;\n            if (++$nct == 2)\n            {\n                $nct = 0;\n                echo '</tr>'.PHP_EOL, '<tr>'.PHP_EOL;\n            }\n            tdcell($type_letter);\n            echo $type_name, '</td>'.PHP_EOL;\n        }\n        if ($i % 2 == 1)\n\t\t\techo '<td></td>',PHP_EOL;\n\t\techo '</tr>'.PHP_EOL;\n    }\n    echo '</table>'.PHP_EOL;\n}\n\n//Display the entry-type color keys. This has up to 2 rows, up to 10 columns.\nfunction show_colour_keys()\n{\n\techo '<table class=\"legende\">';\n    echo '<caption>'.get_vocab(\"show_color_key\").'</caption>'.PHP_EOL;\n\t$sql = \"SELECT DISTINCT id, type_name, type_letter, order_display FROM `\".TABLE_PREFIX.\"_type_area` \";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\t$nct = -1;\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n            $type_name   = $row[1];\n            $type_letter = $row[2];\n            if ($nct == -1)\n                echo '<tr>'.PHP_EOL;\n            if (++$nct == 2)\n            {\n                $nct = 0;\n                echo '</tr>'.PHP_EOL, '<tr>'.PHP_EOL;\n            }\n            tdcell($type_letter);\n            echo $type_name, '</td>'.PHP_EOL;\n\t\t}\n\t\tif ($i % 2 == 1)\n\t\t\techo '<td></td>',PHP_EOL;\n\t\techo '</tr>'.PHP_EOL;\n\t}\n\techo '</table>'.PHP_EOL;\n}\n// transforme une chaine de caract\uff83\uff68res en couleur hexad\uff83\uff69cimale valide\nfunction valid_color($entry)\n{\n\t$out = preg_replace('/[^a-fA-F0-9]/','',$entry);\n\tif (strlen($out)<4)\n\t{\n\t\t$out = '#'.substr($out.'000',0,3);\n\t}\n\telse //if (strlen($out)<7)\n\t{\n\t\t$out = '#'.substr($out.'000',0,6);\n\t}\n\treturn($out);\n}\n//Round time down to the nearest resolution\nfunction round_t_down($t, $resolution, $am7)\n{\n\treturn (int)$t - (int)abs(((int)$t-(int)$am7) % $resolution);\n}\n\n//Round time up to the nearest resolution\nfunction round_t_up($t, $resolution, $am7)\n{\n\tif (($t - $am7) % $resolution != 0)\n\t{\n\t\treturn $t + $resolution - abs(((int)$t - (int)$am7) % $resolution);\n\t}\n\telse\n\t{\n\t\treturn $t;\n\t}\n}\n\n/**\n * Menu gauche affichage des sites via select\n *\n * @param string $link\n * @param string $current_site\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_site_select_html($link, $current_site, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\t$nb_sites_a_afficher = 0;\n\t$out_html = '<b><i>'.get_vocab('sites').get_vocab('deux_points').'</i></b><form id=\"site_001\" action=\"'.$_SERVER['PHP_SELF'].'\"><div>';\n\t$out_html .= '<select class=\"form-control\" name=\"site\" onchange=\"site_go()\">';\n\tif (strncmp(\"4.1\", grr_sql_version(), 3) < 0)\n\t{\n\t\t$sql = \"SELECT id,sitename\n\t\tFROM \".TABLE_PREFIX.\"_site\n\t\tWHERE \".TABLE_PREFIX.\"_site.id IN (SELECT id_site FROM \".TABLE_PREFIX.\"_j_site_area GROUP BY id_site)\n\t\tORDER BY id ASC\";\n\t}\n\telse\n\t{\n\t\t$sql = \"SELECT id, sitename\n\t\tFROM \".TABLE_PREFIX.\"_site\n\t\tleft join \".TABLE_PREFIX.\"_j_site_area on \".TABLE_PREFIX.\"_site.id = \".TABLE_PREFIX.\"_j_site_area.id_site\n\t\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site is not null\n\t\tGROUP BY id_site\n\t\tORDER BY id ASC\n\t\t\";\n\t}\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t// Pour chaque site, on d\uff83\uff69termine le premier domaine disponible\n\t\t\t$sql = \"SELECT id_area\n\t\t\tFROM \".TABLE_PREFIX.\"_j_site_area\n\t\t\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site='\".$row[0].\"'\";\n\t\t\t$res2 = grr_sql_query($sql);\n\t\t\t\t\t\t\t// A on un r\uff83\uff69sultat ?\n\t\t\t$default_area = -1;\n\t\t\tif ($res2 && grr_sql_count($res2) > 0)\n\t\t\t{\n\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t{\n\t\t\t\t\tif (authUserAccesArea($user,$row2[0]) == 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t// on a trouv\uff83\uff69 un domaine autoris\uff83\uff69\n\t\t\t\t\t\t$default_area = $row2[0];\n\t\t\t\t\t\t$j = grr_sql_count($res2) + 1;\n\t\t\t\t\t\t// On arr\uff83\uff6ate la boucle\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// On lib\uff83\uff68re la ressource2\n\t\t\tgrr_sql_free($res2);\n\t\t\tif ($default_area != -1)\n\t\t\t{\n\t\t\t\t// on affiche le site uniquement si au moins un domaine est visible par l'utilisateur\n\t\t\t\t$nb_sites_a_afficher++;\n\t\t\t\t$selected = ($row[0] == $current_site) ? 'selected=\"selected\"' : '';\n\t\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$default_area;\n\t\t\t\t$out_html .= '<option '.$selected.' value=\"'.$link2.'\">'.htmlspecialchars($row[1]).'</option>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\tif ($nb_sites_a_afficher > 1)\n\t{\n\t\t$out_html .= \"</select>\".PHP_EOL;\n\t\t$out_html .= \"</div>\".PHP_EOL;\n\t\t$out_html .= \"<script type=\\\"text/javascript\\\">\".PHP_EOL;\n\t\t$out_html .= \"function site_go()\".PHP_EOL;\n\t\t$out_html .= \"{\".PHP_EOL;\n\t\t$out_html .= \"box = document.getElementById(\\\"site_001\\\").site;\".PHP_EOL;\n\t\t$out_html .= \"destination = box.options[box.selectedIndex].value;\".PHP_EOL;\n\t\t$out_html .= \"if (destination) location.href = destination;\".PHP_EOL;\n\t\t$out_html .= \"}\".PHP_EOL;\n\t\t$out_html .= \"</script>\".PHP_EOL;\n\t\t$out_html .= \"<noscript>\".PHP_EOL;\n\t\t$out_html .= \"<div>\".PHP_EOL;\n\t\t$out_html .= \"<input type=\\\"submit\\\" value=\\\"Change\\\" />\".PHP_EOL;\n\t\t$out_html .= \"</div>\".PHP_EOL;\n\t\t$out_html .= \"</noscript>\".PHP_EOL;\n\t\t$out_html .= \"</form>\".PHP_EOL;\n\t\treturn $out_html;\n\t}\n}\n\n/**\n * Menu gauche affichage des area via select\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_area_select_html( $link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\uff83\uff69 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access FROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j WHERE a.id=j.id_area and j.id_site=$current_site ORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t\t$sql = \"SELECT id, area_name,access FROM \".TABLE_PREFIX.\"_area ORDER BY order_display, area_name\";\n\t$out_html = '<b><i>'.get_vocab(\"areas\").'</i></b>'.PHP_EOL;\n\t$out_html .= '<form id=\"area_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$out_html .= '<div><select class=\"form-control\" name=\"area\" ';\n\t$out_html .= ' onchange=\"area_go()\" ';\n\t$out_html .= '>'.PHP_EOL;\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$selected = ($row[0] == $current_area) ? 'selected=\"selected\"' : \"\";\n\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$row[0];\n\t\t\tif (authUserAccesArea($user,$row[0]) == 1)\n\t\t\t{\n\t\t\t\t$out_html .= '<option '.$selected.' value=\"'.$link2.'\">'.htmlspecialchars($row[1]).'</option>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</select>'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '<script type=\"text/javascript\">'.PHP_EOL;\n\t$out_html .= 'function area_go()'.PHP_EOL;\n\t$out_html .= '{'.PHP_EOL;\n\t$out_html .= 'box = document.getElementById(\"area_001\").area;'.PHP_EOL;\n\t$out_html .= 'destination = box.options[box.selectedIndex].value;'.PHP_EOL;\n\t$out_html .= 'if (destination) location.href = destination;'.PHP_EOL;\n\t$out_html .= '}'.PHP_EOL;\n\t$out_html .= '</script>'.PHP_EOL;\n\t$out_html .= '<noscript>'.PHP_EOL;\n\t$out_html .= '<div>'.PHP_EOL;\n\t$out_html .= '<input type=\"submit\" value=\"Change\" />'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '</noscript>'.PHP_EOL;\n\t$out_html .= '</form>'.PHP_EOL;\n\treturn $out_html;\n}\n/**\n * s\uff83\uff69lecteur de domaines, y compris tous les domaines d'un site\n * area selector, including any area in a site\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_area_select_all_html( $link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\uff83\uff69 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access FROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j WHERE a.id=j.id_area and j.id_site=$current_site ORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t\t$sql = \"SELECT id, area_name,access FROM \".TABLE_PREFIX.\"_area ORDER BY order_display, area_name\";\n\t$out_html = '<b><i>'.get_vocab(\"areas\").'</i></b>'.PHP_EOL;\n\t$out_html .= '<form id=\"area_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$out_html .= '<div><select class=\"form-control\" name=\"area\" ';\n\t$out_html .= ' onchange=\"area_go()\" ';\n\t$out_html .= '>'.PHP_EOL;\n    $out_html .= \"<option value=\\\"\".$link.\"_all.php?year=$year&amp;site=$current_site\\\">\".get_vocab(\"any_area\").\"</option>\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$selected = ($row[0] == $current_area) ? 'selected=\"selected\"' : \"\";\n\t\t\t$link2 = $link.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$row[0];\n\t\t\tif (authUserAccesArea($user,$row[0]) == 1)\n\t\t\t{\n\t\t\t\t$out_html .= '<option '.$selected.' value=\"'.$link2.'\">'.htmlspecialchars($row[1]).'</option>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</select>'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '<script type=\"text/javascript\">'.PHP_EOL;\n\t$out_html .= 'function area_go()'.PHP_EOL;\n\t$out_html .= '{'.PHP_EOL;\n\t$out_html .= 'box = document.getElementById(\"area_001\").area;'.PHP_EOL;\n\t$out_html .= 'destination = box.options[box.selectedIndex].value;'.PHP_EOL;\n\t$out_html .= 'if (destination) location.href = destination;'.PHP_EOL;\n\t$out_html .= '}'.PHP_EOL;\n\t$out_html .= '</script>'.PHP_EOL;\n\t$out_html .= '<noscript>'.PHP_EOL;\n\t$out_html .= '<div>'.PHP_EOL;\n\t$out_html .= '<input type=\"submit\" value=\"Change\" />'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '</noscript>'.PHP_EOL;\n\t$out_html .= '</form>'.PHP_EOL;\n\treturn $out_html;\n}\n/**\n * Menu gauche affichage des room via select\n *\n * @param string $link\n * @param string $current_area\n * @param string $current_room\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_room_select_html($link, $current_area, $current_room, $year, $month, $day)\n{\n\tglobal $vocab;\n\t$out_html = \"<b><i>\".get_vocab('rooms').get_vocab(\"deux_points\").\"</i></b><br /><form id=\\\"room_001\\\" action=\\\"\".$_SERVER['PHP_SELF'].\"\\\"><div><select class=\\\"form-control\\\" name=\\\"room\\\" onchange=\\\"room_go()\\\">\";\n\t$out_html .= \"<option value=\\\"\".$link;\n    if ($link != \"day\"){$out_html .= \"_all\";}\n    $out_html .= \".php?year=$year&amp;month=$month&amp;day=$day&amp;area=$current_area\\\">\".get_vocab(\"all_rooms\").\"</option>\";\n\t$sql = \"select id, room_name, description from \".TABLE_PREFIX.\"_room WHERE area_id='\".protect_data_sql($current_area).\"' order by order_display,room_name\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (verif_acces_ressource(getUserName(),$row[0]))\n\t\t\t{\n\t\t\t\tif ($row[2])\n\t\t\t\t\t$temp = \" (\".htmlspecialchars($row[2]).\")\";\n\t\t\t\telse\n\t\t\t\t\t$temp = \"\";\n\t\t\t\t$selected = ($row[0] == $current_room) ? \"selected=\\\"selected\\\"\" : \"\";\n\t\t\t\t$link2 = $link.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;room='.$row[0];\n\t\t\t\t$out_html .= \"<option $selected value=\\\"$link2\\\">\" . htmlspecialchars($row[1].$temp).\"</option>\".PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= \"</select>\".PHP_EOL;\n\t$out_html .= \"</div>\".PHP_EOL;\n\t$out_html .= \"<script type=\\\"text/javascript\\\">\".PHP_EOL;\n\t$out_html .= \"function room_go()\".PHP_EOL;\n\t$out_html .= \" {\".PHP_EOL;\n\t$out_html .= \"box = document.getElementById(\\\"room_001\\\").room;\".PHP_EOL;\n\t$out_html .= \"destination = box.options[box.selectedIndex].value;\".PHP_EOL;\n\t$out_html .= \"if (destination) location.href = destination;\".PHP_EOL;\n\t$out_html .= \"}\".PHP_EOL;\n\t$out_html .= \"</script>\".PHP_EOL;\n\t$out_html .= \"<noscript>\".PHP_EOL;\n\t$out_html .= \"<div>\".PHP_EOL;\n\t$out_html .= \"<input type=\\\"submit\\\" value=\\\"Change\\\" />\".PHP_EOL;\n\t$out_html .= \"</div>\".PHP_EOL;\n\t$out_html .= \"</noscript>\".PHP_EOL;\n\t$out_html .= \"</form>\".PHP_EOL;\n\treturn $out_html;\n}\n/**\n * Affichage des domaines sous la forme d'une liste\n *\n * @param string $link\n * @param string $current_site\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_site_list_html($link, $current_site, $year, $month, $day,$user)\n{\n\tglobal $vocab;\n\t// On affiche le site\n\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\n\t\t$out_html = '\n\t\t<b><i><span class=\"bground\">'.get_vocab('sites').get_vocab('deux_points').'</span></i></b>\n\t\t<br />';\n\t\t$sql = \"SELECT id,sitename\n\t\tFROM \".TABLE_PREFIX.\"_site\n\t\tORDER BY sitename\";\n\t\t$nb_sites_a_afficher = 0;\n\t\t$res = grr_sql_query($sql);\n\t\tif ($res)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\t// Pour chaque site, on d\uff83\uff69termine s'il y a des domaines visibles par l'utilisateur\n\t\t\t\t$sql = \"SELECT id_area\n\t\t\t\tFROM \".TABLE_PREFIX.\"_j_site_area\n\t\t\t\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site='\".$row[0].\"'\";\n\t\t\t\t$res2 = grr_sql_query($sql);\n\t\t\t\t$au_moins_un_domaine = false;\n\t\t\t\tif ($res2 && grr_sql_count($res2) > 0)\n\t\t\t\t{\n\t\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (authUserAccesArea($user,$row2[0]) == 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// on a trouv\uff83\uff69 un domaine autoris\uff83\uff69\n\t\t\t\t\t\t\t$au_moins_un_domaine = true;\n\t\t\t\t\t\t\t$j = grr_sql_count($res2) + 1;\n\t\t\t\t\t\t\t// On arr\uff83\uff6ate la boucle\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// On lib\uff83\uff68re la ressource2\n\t\t\t\tgrr_sql_free($res2);\n\t\t\t\tif ($au_moins_un_domaine)\n\t\t\t\t{\n\t\t\t\t\t// on affiche le site uniquement si au moins un domaine est visible par l'utilisateur\n\t\t\t\t\t$nb_sites_a_afficher++;\n\t\t\t\t\tif ($row[0] == $current_site)\n\t\t\t\t\t{\n\t\t\t\t\t\t$out_html .= '\n\t\t\t\t\t\t<b><a id=\"liste_select\"   href=\"'.$link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;id_site='.$row[0].'\" title=\"'.$row[1].'\">&gt; '.htmlspecialchars($row[1]).'</a></b>\n\t\t\t\t\t\t<br />'.\"\\n\";\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$out_html .= '\n\t\t\t\t\t\t<a id=\"liste\"  href=\"'.$link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;id_site='.$row[0].'\" title=\"'.$row[1].'\">'.htmlspecialchars($row[1]).'</a>\n\t\t\t\t\t\t<br />'.\"\\n\";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($nb_sites_a_afficher > 1)\n\t\t\treturn $out_html;\n\t\telse\n\t\t\treturn '';\n\t}\n}\n/**\n * Affichage des area sous la forme d'une liste\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_area_list_html($link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\techo \"<b><i><span class=\\\"bground\\\">\".get_vocab(\"areas\").\"</span></i></b><br />\";\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\uff83\uff69 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access\n\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\tWHERE a.id=j.id_area and j.id_site=$current_site\n\t\tORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t{\n\t\t$sql = \"SELECT id, area_name,access\n\t\tFROM \".TABLE_PREFIX.\"_area\n\t\tORDER BY order_display, area_name\";\n\t}\n\t$res = 0;\n\tif (($current_site != -1) || ($use_multi_site == 'n'))\n\t\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (authUserAccesArea($user,$row[0]) == 1)\n\t\t\t{\n\t\t\t\tif ($row[0] == $current_area)\n\t\t\t\t{\n\t\t\t\t\techo \"<a id=\\\"liste_select\\\" onclick=\\\"charger();\\\" href=\\\"\".$link.\"?year=$year&amp;month=$month&amp;day=$day&amp;area=$row[0]\\\">&gt; \".htmlspecialchars($row[1]).\"</a></b><br />\\n\";\n\t\t\t\t} else {\n\t\t\t\t\techo \"<a id=\\\"liste\\\" onclick=\\\"charger();\\\" href=\\\"\".$link.\"?year=$year&amp;month=$month&amp;day=$day&amp;area=$row[0]\\\"> \".htmlspecialchars($row[1]).\"</a><br />\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tgrr_sql_free($res);\n}\n/**\n * Affichage des room sous la forme d'une liste\n *\n * @param string $link\n * @param string $current_area\n * @param string $current_room\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_room_list_html($link,$current_area, $current_room, $year, $month, $day)\n{\n\tglobal $vocab;\n\techo \"<b><i><span class=\\\"bground\\\">\".get_vocab(\"rooms\").get_vocab(\"deux_points\").\"</span></i></b><br />\";\n\t$sql = \"select id, room_name, description from \".TABLE_PREFIX.\"_room WHERE area_id='\".protect_data_sql($current_area).\"' order by order_display,room_name\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t// On affiche uniquement les ressources autoris\uff83\uff69es\n\t\t\tif (verif_acces_ressource(getUserName(), $row[0]))\n\t\t\t{\n\t\t\t\tif ($row[0] == $current_room)\n\t\t\t\t\techo \"<span id=\\\"liste_select\\\">&gt; \".htmlspecialchars($row[1]).\"</span><br />\\n\";\n\t\t\t\telse\n\t\t\t\t\techo \"<a id=\\\"liste\\\" onclick=\\\"charger();\\\" href=\\\"\".$link.\".php?year=$year&amp;month=$month&amp;day=$day&amp;&amp;room=$row[0]\\\">\".htmlspecialchars($row[1]). \"</a><br />\\n\";\n\t\t\t}\n\t\t}\n\t}\n}\n/*\n * Affichage des sites sous la forme d'une liste de boutons\n *\n * @param string $link\n * @param string $current_site\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_site_item_html($link, $current_site, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\t$nb_sites_a_afficher = 0;\n//\t$out_html = '<ul class=\"list-group\"><li class=\"list-group-item\">'.get_vocab('sites').get_vocab('deux_points').'</li></ul><form class=\"ressource\" id=\"site_001\" action=\"'.$_SERVER['PHP_SELF'].'\"><div>';\n\t$sql = \"SELECT id, sitename\n\tFROM \".TABLE_PREFIX.\"_site\n\tleft join \".TABLE_PREFIX.\"_j_site_area on \".TABLE_PREFIX.\"_site.id = \".TABLE_PREFIX.\"_j_site_area.id_site\n\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site is not null\n\tGROUP BY id_site\n\tORDER BY id ASC\n\t\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{     \n        $out_html = '<br />'.PHP_EOL.'<div class=\"panel panel-default\">'.PHP_EOL.'<div class=\"panel-heading\">'.get_vocab('sites').get_vocab('deux_points').'</div>'.PHP_EOL.'<div class=\"panel-body\">'.PHP_EOL.'<form class=\"ressource\" id=\"site_001\" action=\"'.$_SERVER['PHP_SELF'].'\">';\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$sql = \"SELECT id_area FROM \".TABLE_PREFIX.\"_j_site_area WHERE \".TABLE_PREFIX.\"_j_site_area.id_site='\".$row[0].\"'\";\n\t\t\t$res2 = grr_sql_query($sql);\n\t\t\t$default_area = -1;\n\t\t\tif ($res2 && grr_sql_count($res2) > 0)\n\t\t\t{\n\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t{\n\t\t\t\t\tif (authUserAccesArea($user,$row2[0]) == 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$default_area = $row2[0];\n\t\t\t\t\t\t$j = grr_sql_count($res2) + 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tgrr_sql_free($res2);\n\t\t\tif ($default_area != -1)\n\t\t\t{\n\t\t\t\t$nb_sites_a_afficher++;\n\t\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$default_area;\n\t\t\t\t//$out_html .=\"\\n\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day;\n\t\t\tif ($current_site != null)\n\t\t\t{\n\t\t\t\tif ($current_site == $row[0])\n\t\t\t\t\t$out_html .= \"<input id=\\\"item_select\\\" type=\\\"button\\\" class=\\\"btn btn-primary btn-lg btn-block item_select\\\" name=\\\"$row[0]\\\" value=\\\"\".htmlspecialchars($row[1]).\"\\\" onclick=\\\"location.href='$link2';charger();\\\" />\".PHP_EOL;\n\t\t\t\telse\n\t\t\t\t\t$out_html .= \"<input type=\\\"button\\\" class=\\\"btn btn-default btn-lg btn-block item\\\" name=\\\"$row[0]\\\" value=\\\"\".htmlspecialchars($row[1]).\" \\\" onclick=\\\"location.href='$link2';charger();\\\" />\".PHP_EOL;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$out_html .= \"<input type=\\\"button\\\" class=\\\"btn btn-default btn-lg btn-block item\\\" name=\\\"$row[0]\\\" value=\\\"\".htmlspecialchars($row[1]).\" \\\" onclick=\\\"location.href='$link2';charger();\\\" /><br />\".PHP_EOL;\n\t\t}\n\t}\n\tif ($nb_sites_a_afficher > 1)// s'il y a au moins deux sites \uff83\uf8f0 afficher, on affiche une liste de boutons, sinon rien.\n\t{\n\t\t$out_html .= '</form>'.PHP_EOL;\n\t\t$out_html .= '</div></div>'.PHP_EOL;\n\t\t$out_html .= '<script type=\"text/javascript\">'.PHP_EOL;\n\t\t$out_html .= 'function site_go()'.PHP_EOL;\n\t\t$out_html .= '{'.PHP_EOL;\n\t\t$out_html .= 'box = document.getElementById(\"site_001\").site;'.PHP_EOL;\n\t\t$out_html .= 'destination = box.options[box.selectedIndex].value;'.PHP_EOL;\n\t\t$out_html .= 'if (destination) location.href = destination;'.PHP_EOL;\n\t\t$out_html .= '}'.PHP_EOL;\n\t\t$out_html .= '</script>'.PHP_EOL;\n\t\t$out_html .= '<noscript>'.PHP_EOL;\n\t\t$out_html .= '<div>'.PHP_EOL;\n\t\t$out_html .= '<input type=\"submit\" value=\"change\" />'.PHP_EOL;\n\t\t$out_html .= '</div>'.PHP_EOL;\n\t\t$out_html .= '</noscript>'.PHP_EOL;\n\t\t//$out_html .= '</form>'.PHP_EOL;\n\t\treturn $out_html;\n\t}\n    else return \"\";\n}\n/**\n * Affichage des area sous la forme d'un input\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_area_item_html( $link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\uff83\uff69 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access\n\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\tWHERE a.id=j.id_area and j.id_site=$current_site\n\t\tORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t{\n\t\t$sql = \"SELECT id, area_name,access\n\t\tFROM \".TABLE_PREFIX.\"_area\n\t\tORDER BY order_display, area_name\";\n\t}\n\t$out_html = '<br />'.PHP_EOL.'<div class=\"panel panel-default\">'.PHP_EOL.'<div class=\"panel-heading\">'.get_vocab(\"areas\").'</div>'.PHP_EOL.'<div class=\"panel-body\">'.PHP_EOL;\n\t$out_html .= '<form class=\"ressource\" id=\"area_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$row[0];\n\t\t\tif (authUserAccesArea($user, $row[0]) == 1)\n\t\t\t{\n\t\t\t\t/* Couleur du domaine selectionn\uff83\uff69*/\n\t\t\t\tif ($current_area != null)\n\t\t\t\t{\n\t\t\t\t\tif ($current_area == $row[0])\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-primary btn-lg btn-block item_select\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item \" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</form>'.PHP_EOL.'</div>'.PHP_EOL.'</div>'.PHP_EOL;\n\treturn $out_html;\n}\n//end make_area_item_html\n/**\n * Affichage des rooms sous la forme d'une liste de boutons\n *\n * @param string $link\n * @param string $current_area\n * @param string $current_room\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_room_item_html($link, $current_area, $current_room, $year, $month, $day)\n{\n\tglobal $vocab;\n\t$out_html = '<br />'.PHP_EOL.'<div class=\"panel panel-default\">'.PHP_EOL.'<div class=\"panel-heading\">'.get_vocab(\"rooms\").get_vocab(\"deux_points\").'</div>'.PHP_EOL.'<div class=\"panel-body\">'.PHP_EOL.'<form class=\"ressource\" id=\"room_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$sql = \"SELECT id, room_name, description FROM \".TABLE_PREFIX.\"_room WHERE area_id='\".protect_data_sql($current_area).\"' ORDER BY order_display,room_name\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n        $all_ressource = 0; // permet l'affichage de toutes les ressources\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (verif_acces_ressource(getUserName(),$row[0]))\n\t\t\t{\n\t\t\t\t$link2 = $link.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;room='.$row[0];\n                $link_a = $link;\n                if (($link != 'day')&&(!strpos($link,'all'))) {$link_a .= '_all';}\n\t\t\t\t$link_all_room = $link_a.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$current_area;\n\t\t\t\tif (!isset($_GET['room']))\n\t\t\t\t{\n\t\t\t\t\tif (isset($all_ressource) && $all_ressource == 0)\n\t\t\t\t\t\t$out_html .= /*'<div class=\"panel-body\">'.PHP_EOL.*/'<input id=\"item_select\" class=\"btn btn-primary btn-lg btn-block item_select\" name=\"all_room\" value=\"Toutes les ressources\" onclick=\"location.href=\\''.$link_all_room.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" type=\"button\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\t$all_ressource = 1;\n\t\t\t\t}\n\t\t\t\telse //changed (Ajout de type = \" button pr gerer saut de ligne \" \n\t\t\t\t{\n\t\t\t\t\tif (isset($all_ressource) && $all_ressource == 0)\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" type=\"button\" name=\"all_room\" value=\"Toutes les ressources\" onclick=\"location.href=\\''.$link_all_room.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\t$all_ressource = 1;\n\t\t\t\t\tif ($current_room == $row[0])\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-primary btn-lg btn-block item_select\" type=\"button\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\';charger();\"/>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" type=\"button\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</form>'.PHP_EOL.'</div>'.PHP_EOL.'</div>'.PHP_EOL;\n\treturn $out_html;\n}\n// end make_room_item_html\n/**\n * @param integer $action\n * $action = 1 -> Cr\uff83\uff69ation\n * $action = 2 -> Modification\n * $action = 3 -> Suppression\n * $action = 4 -> Suppression automatique\n * $action = 5 -> R\uff83\uff69servation en attente de mod\uff83\uff69ration\n * $action = 6 -> R\uff83\uff69sultat d'une d\uff83\uff69cision de mod\uff83\uff69ration\n * $action = 7 -> Notification d'un retard dans la restitution d'une ressource.\n*/\nfunction send_mail($id_entry, $action, $dformat, $tab_id_moderes = array(), $oldRessource = '')\n{\n\tglobal $vocab, $grrSettings, $locale, $weekstarts, $enable_periods, $periods_name;\n\n\t$message_erreur = '';\n\n\tif (@file_exists('include/mail.class.php')){\n\t\trequire_once 'phpmailer/PHPMailerAutoload.php';\n\t\trequire_once 'include/mail.class.php';\n\t}else{\n\t\trequire_once '../phpmailer/PHPMailerAutoload.php';\n\t\trequire_once '../include/mail.class.php';\n\t}\n\n\t$sql = \"SELECT \".TABLE_PREFIX.\"_entry.name,\n\t\".TABLE_PREFIX.\"_entry.description,\n\t\".TABLE_PREFIX.\"_entry.beneficiaire,\n\t\".TABLE_PREFIX.\"_room.room_name,\n\t\".TABLE_PREFIX.\"_area.area_name,\n\t\".TABLE_PREFIX.\"_entry.type,\n\t\".TABLE_PREFIX.\"_entry.room_id,\n\t\".TABLE_PREFIX.\"_entry.repeat_id,\n\t\" . grr_sql_syntax_timestamp_to_unix(\"\".TABLE_PREFIX.\"_entry.timestamp\") . \",\n\t(\".TABLE_PREFIX.\"_entry.end_time - \".TABLE_PREFIX.\"_entry.start_time),\n\t\".TABLE_PREFIX.\"_entry.start_time,\n\t\".TABLE_PREFIX.\"_entry.end_time,\n\t\".TABLE_PREFIX.\"_room.area_id,\n\t\".TABLE_PREFIX.\"_room.delais_option_reservation,\n\t\".TABLE_PREFIX.\"_entry.option_reservation,\n\t\".TABLE_PREFIX.\"_entry.moderate,\n\t\".TABLE_PREFIX.\"_entry.beneficiaire_ext,\n\t\".TABLE_PREFIX.\"_entry.jours,\n\t\".TABLE_PREFIX.\"_entry.clef,\n\t\".TABLE_PREFIX.\"_entry.courrier\n\tFROM \".TABLE_PREFIX.\"_entry, \".TABLE_PREFIX.\"_room, \".TABLE_PREFIX.\"_area\n\tWHERE \".TABLE_PREFIX.\"_entry.room_id = \".TABLE_PREFIX.\"_room.id\n\tAND \".TABLE_PREFIX.\"_room.area_id = \".TABLE_PREFIX.\"_area.id\n\tAND \".TABLE_PREFIX.\"_entry.id='\".protect_data_sql($id_entry).\"'\n\t\";\n\t$res = grr_sql_query($sql);\n\tif (!$res)\n\t\tfatal_error(0, grr_sql_error());\n\tif (grr_sql_count($res) < 1)\n\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t$row = grr_sql_row($res, 0);\n\tgrr_sql_free($res);\n\n\tget_planning_area_values($row[12]);\n\t$breve_description \t\t\t= bbcode(removeMailUnicode(htmlspecialchars($row[0])), 'nobbcode');\n\t$description  \t\t\t\t= bbcode(removeMailUnicode(htmlspecialchars($row[1])), 'nobbcode');\n\t$beneficiaire \t\t\t\t= htmlspecialchars($row[2]);\n\t$room_name    \t\t\t\t= removeMailUnicode(htmlspecialchars($row[3]));\n\t$area_name    \t\t\t\t= removeMailUnicode(htmlspecialchars($row[4]));\n\t$room_id      \t\t\t\t= $row[6];\n\t$repeat_id    \t\t\t\t= $row[7];\n\t$date_avis    \t\t\t\t= strftime(\"%Y/%m/%d\", $row[10]);\n\t$delais_option_reservation \t= $row[13];\n\t$option_reservation \t\t= $row[14];\n\t$moderate \t\t\t\t\t= $row[15];\n\t$beneficiaire_ext\t\t\t= htmlspecialchars($row[16]);\n\t$jours_cycle \t\t\t\t= htmlspecialchars($row[17]);\n\t$duration     \t\t\t\t= $row[9];\n\tif ($enable_periods == 'y')\n\t\tlist($start_period, $start_date) = period_date_string($row[10]);\n\telse\n\t\t$start_date = time_date_string($row[10],$dformat);\n\t$rep_type = 0;\n\n\t// Recherche du nom de l'ancienne ressource si besoin\n\tif($oldRessource != '' && $oldRessource != $room_id)\n\t{\n\t\t$sql = \"SELECT room_name FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($oldRessource).\"'\";\n\t\t$oldRess = grr_sql_query($sql);\n\t\tif (!$oldRess)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\t$rowOld = grr_sql_row($oldRess, 0);\n\t\tgrr_sql_free($oldRess);\n\t\t$nomAncienneSalle = $rowOld[0];\n\t}\n\telse\n\t\t$nomAncienneSalle = \"\";\n\t//\n\n\tif ($repeat_id != 0)\n\t{\n\t\t$res = grr_sql_query(\"SELECT rep_type, end_date, rep_opt, rep_num_weeks FROM \".TABLE_PREFIX.\"_repeat WHERE id='\".protect_data_sql($repeat_id).\"'\");\n\t\tif (!$res)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\t$test = grr_sql_count($res);\n\t\tif ($test != 1)\n\t\t\tfatal_error(0, \"Deux reservations ont le m\uff83\uff6ame ID.\");\n\t\telse\n\t\t{\n\t\t\t$row2 = grr_sql_row($res, 0);\n\t\t\t$rep_type     = $row2[0];\n\t\t\t$rep_end_date = strftime($dformat,$row2[1]);\n\t\t\t$rep_opt      = $row2[2];\n\t\t\t$rep_num_weeks = $row2[3];\n\t\t}\n\t\tgrr_sql_free($res);\n\t}\n\tif ($enable_periods == 'y')\n\t\ttoPeriodString($start_period, $duration, $dur_units);\n\telse\n\t\ttoTimeString($duration, $dur_units);\n\t$weeklist = array(\"unused\", \"every week\", \"week 1/2\", \"week 1/3\", \"week 1/4\", \"week 1/5\");\n\tif ($rep_type == 2)\n\t\t$affiche_period = $vocab[$weeklist[$rep_num_weeks]];\n\telse\n\t\t$affiche_period = $vocab['rep_type_'.$rep_type];\n\n\t// Le b\uff83\uff69n\uff83\uff69ficiaire\n\t$beneficiaire_email = affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"onlymail\");\n\tif ($beneficiaire != \"\")\n\t{\n\t\t$beneficiaire_actif = grr_sql_query1(\"SELECT etat FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='$beneficiaire'\");\n\t\tif ($beneficiaire_actif == -1)\n\t\t\t$beneficiaire_actif = 'actif'; // Cas des admins\n\t}\n\telse if (($beneficiaire_ext != \"\") && ($beneficiaire_email != \"\"))\n\t\t$beneficiaire_actif = \"actif\";\n\telse\n\t\t$beneficiaire_actif = \"inactif\";\n\n\t// Utilisateur ayant agi sur la r\uff83\uff69servation\n\t$user_login = getUserName();\n\t$user_email = grr_sql_query1(\"SELECT email FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='$user_login'\");\n\t//\n\t// Elaboration du message destin\uff83\uff69 aux utilisateurs d\uff83\uff69sign\uff83\uff69s par l'admin dans la partie \"Mails automatiques\"\n\t//\n\t//Nom de l'\uff83\uff69tablissement et mention \"mail automatique\"\n\t$message = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t// Url de GRR\n\t$message .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t$sujet = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\n\tif ($action == 1){ // Cr\uff83\uff69ation\n\t\t$sujet .= $vocab[\"subject_mail_creation\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"creation_booking\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 2){ // Modification\n\t\t$sujet .= $vocab[\"subject_mail_modify\"];\n\t\tif ($moderate == 1)\n\t\t\t$sujet .= \" (\".$vocab[\"en_attente_moderation\"].\")\";\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"modify_booking\"];\n\t\tif ($room_name != $oldRessource)\n\t\t\t$message .= $vocab[\"the_room\"].\" \".$oldRessource.\" => \".$room_name.\" (\".$area_name.\") \";\n\t\telse\n\t\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \";\n\t\t$message .= $vocab[\"reservee au nom de\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 3){ // Suppression\n\t\t$sujet .= $vocab[\"subject_mail_delete\"];\n\t\tif ($moderate == 1)\n\t\t\t$sujet .= \" (\".$vocab[\"en_attente_moderation\"].\")\";\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"delete_booking\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$message .= $vocab[\"reservee au nom de\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 4){ // Suppression automatique\n\t\t$sujet .= $vocab[\"subject_mail_delete\"];\n\t\t$message .= $vocab[\"suppression_automatique\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 5){ // R\uff83\uff69servation en attente de mod\uff83\uff69ration\n\t\t$sujet .= $vocab[\"subject_mail_moderation\"];\n\t\t$message .= $vocab[\"reservation_en_attente_de_moderation\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$repondre = Settings::get(\"webmaster_email\");\n\t}\n\telseif ($action == 6){ // R\uff83\uff69sultat d'une d\uff83\uff69cision de mod\uff83\uff69ration\n\t\t$sujet .= $vocab[\"subject_mail_decision_moderation\"];\n\n\t\t$resmoderate = grr_sql_query(\"SELECT moderate, motivation_moderation FROM \".TABLE_PREFIX.\"_entry_moderate WHERE id ='\".protect_data_sql($id_entry).\"'\");\n\t\tif (!$resmoderate)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\tif (grr_sql_count($resmoderate) < 1)\n\t\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t\t$rowModerate = grr_sql_row($resmoderate, 0);\n\t\tgrr_sql_free($resmoderate);\n\t\t$moderate_decision = $rowModerate[0];\n\t\t$moderate_description = $rowModerate[1];\n\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"traite_moderation\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \";\n\t\t$message .= $vocab[\"reservee au nom de\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\tif ($moderate_decision == 2)\n\t\t\t$message .= \"\\n\".$vocab[\"moderation_acceptee\"];\n\t\telse if ($moderate_decision == 3)\n\t\t\t$message .= \"\\n\".$vocab[\"moderation_refusee\"];\n\t\tif ($moderate_description != \"\")\n\t\t{\n\t\t\t$message .= \"\\n\".$vocab[\"motif\"].$vocab[\"deux_points\"];\n\t\t\t$message .= $moderate_description.\" \\n----\";\n\t\t}\n\t\t$message .= \"\\n\".$vocab[\"voir_details\"].$vocab[\"deux_points\"].\"\\n\";\n\t\tif (count($tab_id_moderes) == 0 )\n\t\t\t$message .= \"\\n\".traite_grr_url(\"\",\"y\").\"view_entry.php?id=\".$id_entry;\n\t\telse\n\t\t{\n\t\t\tforeach ($tab_id_moderes as $id_moderes)\n\t\t\t\t$message .= \"\\n\".traite_grr_url(\"\",\"y\").\"view_entry.php?id=\".$id_moderes;\n\t\t}\n\t\t$message .= \"\\n\\n\".$vocab[\"rappel_de_la_demande\"].$vocab[\"deux_points\"].\"\\n\";\n\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 7){ // Notification d'un retard dans la restitution d'une ressource\n\t\t$sujet .= $vocab[\"subject_mail_retard\"];\n\n\t\t$message .= $vocab[\"message_mail_retard\"].$vocab[\"deux_points\"].\" \\n\";\n\t\t$message .= $room_name.\" (\".$area_name.\") \\n\";\n\t\t$message .= $vocab[\"nom emprunteur\"].$vocab[\"deux_points\"];\n\t\t$message .= affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\tif ($beneficiaire_email != \"\")\n\t\t\t$message .= $vocab[\"un email envoye\"].$beneficiaire_email.\" \\n\";\n\t\t$message .= \"\\n\".$vocab[\"changer statut lorsque ressource restituee\"].$vocab[\"deux_points\"];\n\t\t$message .= \"\\n\".traite_grr_url(\"\",\"y\").\"view_entry.php?id=\".$id_entry.\" \\n\";\n\n\t\t$repondre = Settings::get(\"webmaster_email\");\n\t}\n\t//\n\t// Infos sur la r\uff83\uff69servation\n\t//\t\t\n\t$reservation = '';\n\t$reservation .= $vocab[\"start_of_the_booking\"].\" \".$start_date.\"\\n\";\n\t$reservation .= $vocab[\"duration\"].\" \".$duration.\" \".$dur_units.\"\\n\";\n\tif (trim($breve_description) != \"\")\n\t\t$reservation .= $vocab[\"namebooker\"].preg_replace(\"/ /\", \" \",$vocab[\"deux_points\"]).\" \".$breve_description.\"\\n\";\n\telse\n\t\t$reservation .= $vocab[\"entryid\"].$room_id.\"\\n\";\n\tif ($description !='')\n\t\t$reservation .= $vocab[\"description\"].\" \".$description.\"\\n\";\n\t// Champ additionnel\n\t$reservation .= affichage_champ_add_mails($id_entry);\n\t// Type de r\uff83\uff69servation\n\t$temp = grr_sql_query1(\"SELECT type_name FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$row[5].\"'\");\n\tif ($temp == -1)\n\t\t$temp = \"?\".$row[5].\"?\";\n\telse\n\t\t$temp = removeMailUnicode($temp);\n\n\t$reservation .= $vocab[\"type\"].preg_replace(\"/ /\", \" \",$vocab[\"deux_points\"]).\" \".$temp.\"\\n\";\n\n\tif ($rep_type != 0)\n\t\t$reservation .= $vocab[\"rep_type\"].\" \".$affiche_period.\"\\n\";\n\tif ($rep_type != 0)\n\t{\n\t\tif ($rep_type == 2)\n\t\t{\n\t\t\t$opt = \"\";\n\t\t\tfor ($i = 0; $i < 7; $i++)\n\t\t\t{\n\t\t\t\t$daynum = ($i + $weekstarts) % 7;\n\t\t\t\tif ($rep_opt[$daynum])\n\t\t\t\t\t$opt .= day_name($daynum) . \" \";\n\t\t\t}\n\t\t\tif ($opt)\n\t\t\t\t$reservation .= $vocab[\"rep_rep_day\"].\" \".$opt.\"\\n\";\n\t\t}\n\t\tif ($rep_type == 6)\n\t\t{\n\t\t\tif (Settings::get(\"jours_cycles_actif\") == \"Oui\")\n\t\t\t\t$reservation .= $vocab[\"rep_type_6\"].preg_replace(\"/ /\", \" \",$vocab[\"deux_points\"]).ucfirst(substr($vocab[\"rep_type_6\"],0,1)).$jours_cycle.\"\\n\";\n\t\t}\n\t\t$reservation .= $vocab[\"rep_end_date\"].\" \".$rep_end_date.\"\\n\";\n\t}\n\tif (($delais_option_reservation > 0) && ($option_reservation != -1))\n\t\t$reservation .= \"*** \".$vocab[\"reservation_a_confirmer_au_plus_tard_le\"].\" \".time_date_string_jma($option_reservation,$dformat).\" ***\\n\";\n\n\t$reservation .= \"-----\\n\";\n\n\t$message .= $reservation;\n\t$message .= $vocab[\"msg_no_email\"].Settings::get(\"webmaster_email\");;\n\t$message = html_entity_decode($message);\n\t//\n\t$sql = \"SELECT u.email FROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_mailuser_room j WHERE (j.id_room='\".protect_data_sql($room_id).\"' AND u.login=j.login and u.etat='actif') ORDER BY u.nom, u.prenom\";\n\t$res = grr_sql_query($sql);\n\t$nombre = grr_sql_count($res);\n\tif ($nombre > 0)\n\t{\n\t\t$destinataire = \"\";\n\t\t$tab_destinataire = array();\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif ($row[0] != \"\")\n\t\t\t\t$tab_destinataire[] = $row[0];\n\t\t}\n\t\tforeach ($tab_destinataire as $value){\n\t\t\t$destinataire .= \";\". $value;\n\t\t}\n\n\t\tEmail::Envois($destinataire, $sujet, $message, $repondre, '', '');\n\t}\n\n\tif ($action == 7){\n\t\t$mail_admin = find_user_room ($room_id);\n\t\t$destinataire = \"\";\n\t\tif (count($mail_admin) > 0)\n\t\t{\n\t\t\tforeach ($mail_admin as $value){\n\t\t\t\t$destinataire .= \";\". $value;\n\t\t\t}\n\n\t\t\tEmail::Envois($destinataire, $sujet, $message, $repondre, '', '');\n\t\t}\n\n\t\t$sujet7 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$sujet7 .= $vocab[\"subject_mail_retard\"];\n\t\t$message7 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t$message7 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t$message7 .= $vocab[\"ressource empruntee non restitu\uff83\uff69e\"].\"\\n\";\n\t\t$message7 .= $room_name.\" (\".$area_name.\")\";\n\t\t$message7 .= \"\\n\".$reservation;\n\t\t$message7 = html_entity_decode($message7);\n\t\t$destinataire7 = $beneficiaire_email;\n\t\t$repondre7 = Settings::get(\"webmaster_email\");\n\n\t\tEmail::Envois($destinataire7, $sujet7, $message7, $repondre7, '', '');\n\t}\n\tif ($action == 4)\n\t{\n\t\t$destinataire4 = $beneficiaire_email;\n\t\t$repondre4 = Settings::get(\"webmaster_email\");\n\t\t\n\t\tEmail::Envois($destinataire4, $sujet, $message, $repondre4, '', '');\n\t}\n\tif ($action == 5)\n\t{\n\t\t$mail_admin = find_active_user_room ($room_id);\n\t\t$destinataire = \"\";\n\t\tif (count($mail_admin) > 0){\n\n\t\t\tforeach ($mail_admin as $value){\n\t\t\t\t$destinataire .= \";\". $value;\n\t\t\t}\n\t\t\n\t\t\t$sujet5 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t\t$sujet5 .= $vocab[\"subject_mail_moderation\"];\n\t\t\t$message5 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t\t$message5 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t\t$message5 .= $vocab[\"subject_a_moderer\"];\n\t\t\t$message5 .= \"\\n\".traite_grr_url(\"\",\"y\").\"validation.php?id=\".$id_entry;\n\t\t\t$message5 .= \"\\n\\n\".$vocab['created_by'].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t\t$message5 .= \"\\n\".$vocab['room'].$vocab['deux_points'].$room_name.\" (\".$area_name.\") \\n\";\n\t\t\t$message5 = html_entity_decode($message5);\n\t\t\t$repondre5 = Settings::get(\"webmaster_email\");\n\n\t\t\tEmail::Envois($destinataire, $sujet5, $message5, $repondre5, '', '');\n\t\t}\n\n\t}\n\tif (($action == 5) && ($beneficiaire_email != '') && ($beneficiaire_actif == 'actif'))\n\t{\n\t\t$sujet5 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$sujet5 .= $vocab[\"subject_mail_moderation\"];\n\t\t$message5 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t$message5 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t$message5 .= $vocab[\"texte_en_attente_de_moderation\"];\n\t\t$message5 .= \"\\n\".$vocab[\"rappel_de_la_demande\"].$vocab[\"deux_points\"];\n\t\t$message5 .= \"\\n\".$vocab[\"the_room\"].$room_name.\" (\".$area_name.\")\";\n\t\t$message5 .= \"\\n\".$reservation;\n\t\t$message5 = html_entity_decode($message5);\n\t\t$destinataire5 = $beneficiaire_email;\n\t\t$repondre5 = Settings::get(\"webmaster_email\");\n\n\t\tEmail::Envois($destinataire5, $sujet5, $message5, $repondre5, '', '');\n\t}\n\tif (($action == 6) && ($beneficiaire_email != '') && ($beneficiaire_actif=='actif'))\n\t{\n\t\t$sujet6 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$sujet6 .= $vocab[\"subject_mail_decision_moderation\"];\n\t\t$message6 = $message;\n\t\t$destinataire6 = $beneficiaire_email;\n\t\t$repondre6 = $user_email;\n\n\t\tEmail::Envois($destinataire6, $sujet6, $message6, $repondre6, '', '');\n\t}\n\n\t// Cas d'une cr\uff83\uff69ation, modification ou suppression d'un message par un utilisateur diff\uff83\uff69rent du b\uff83\uff69n\uff83\uff69ficiaire :\n\t// On envoie un message au b\uff83\uff69n\uff83\uff69ficiaire de la r\uff83\uff69servation pour l'avertir d'une modif ou d'une suppression\n\tif ((($action == 1) || ($action == 2) || ($action == 3)) && ((strtolower($user_login) != strtolower($beneficiaire)) || (Settings::get('send_always_mail_to_creator') == '1')) && ($beneficiaire_email != '') && ($beneficiaire_actif == 'actif'))\n\t{\n\t\t$sujet2 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$message2 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t$message2 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t$message2 .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\tif ($action == 1){\n\t\t\t$sujet2 .= $vocab[\"subject_mail_creation\"];\n\t\t\t$message2 .= $vocab[\"creation_booking_for_you\"];\n\t\t\t$message2 .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\").\";\n\t\t}\n\t\telseif ($action == 2){\n\t\t\t$sujet2 .= $vocab[\"subject_mail_modify\"];\n\t\t\t$message2 .= $vocab[\"modify_booking\"];\n\t\t\tif ($room_id != $oldRessource)\n\t\t\t\t$message2 .= $vocab[\"the_room\"].\" \".$nomAncienneSalle.\" => \".$room_name.\" (\".$area_name.\") \";\n\t\t\telse\n\t\t\t\t$message2 .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \";\n\t\t\t$message2 .= $vocab[\"created_by_you\"];\n\t\t}\n\t\telse{\n\t\t\t$sujet2 .= $vocab[\"subject_mail_delete\"];\n\t\t\t$message2 .= $vocab[\"delete_booking\"];\n\t\t\t$message2 .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\")\";\n\t\t\t$message2 .= $vocab[\"created_by_you\"];\n\t\t}\n\t\t$message2 .= \"\\n\".$reservation;\n\t\t$message2 = html_entity_decode($message2);\n\t\t$destinataire2 = $beneficiaire_email;\n\t\t$repondre2 = $user_email;\n\n\t\tEmail::Envois($destinataire2, $sujet2, $message2, $repondre2, '', '');\n\t}\n\n\treturn $message_erreur;\n} // Fin fonction send_mail\n\n/** function getUserName()\n * retourne le login de l'utilisateur connect\uff83\uff69 (et pas son nom), une cha\uff83\uff6ene vide sinon\n*/\nfunction getUserName()\n{\n\tif (isset($_SESSION['login']))\n\t\treturn $_SESSION['login'];\n\telse\n\t\treturn '';\n}\nfunction getWritable($beneficiaire, $user, $id)\n{\n\t$id_room = grr_sql_query1(\"SELECT room_id FROM \".TABLE_PREFIX.\"_entry WHERE id='\".protect_data_sql($id).\"'\");\n\t\t// Modifications permises si l'utilisateur a les droits suffisants\n\tif (Settings::get(\"allow_gestionnaire_modify_del\") == 0)\n\t\t$temp = 3;\n\telse\n\t\t$temp = 2;\n\tif (authGetUserLevel($user,$id_room) > $temp)\n\t\treturn 1;\n\t//if ($beneficiaire == \"\") $beneficiaire = $user;\n\t// Dans le cas d'un b\uff83\uff69n\uff83\uff69ficiaire ext\uff83\uff69rieur, $beneficiaire est vide. On fait comme si $user \uff83\uff69tait le b\uff83\uff69n\uff83\uff69ficiaire\n\t$dont_allow_modify = grr_sql_query1(\"select dont_allow_modify from \".TABLE_PREFIX.\"_room WHERE id = '\".$id_room.\"'\");\n\t$owner = strtolower(grr_sql_query1(\"SELECT create_by FROM \".TABLE_PREFIX.\"_entry WHERE id='\".protect_data_sql($id).\"'\"));\n\t$beneficiaire = strtolower($beneficiaire);\n\t$user = strtolower($user);\n\t//Il reste \uff83\uf8f0 \uff83\uff69tudier le cas d'un utilisateur sans droits particuliers. quatre cas possibles :\n\t//Cas 1 : l'utilisateur (U) n'est ni le cr\uff83\uff69ateur (C) ni le b\uff83\uff69n\uff83\uff69ficiaire (B)\n\t//\tR1 -> on retourne 0\n\t//Cas 2 : U=B et et U<>C  ou ...\n\t//Cas 3 : U=B et et U=C\n\t//\tR2 -> on retourne 0 si personne hormis les gestionnaires et les administrateurs ne peut modifier ou supprimer ses propres r\uff83\uff69servations.\n\t//\tR3 -> on retourne 1 sinon\n\t//Cas 4 : U=C et U<>B\n\t//\tR4 -> on retourne 0 si personne hormis les gestionnaires et les administrateurs ne peut modifier ou supprimer ses propres r\uff83\uff69servations.\n\t//\t-> sinon\n\t//\t\tR5 -> on retourne 1 si l'utilisateur U peut r\uff83\uff69server la ressource pour B\n\t//\t\tR6 -> on retourne 0 sinon (si on permettait \uff83\uf8f0 U d'\uff83\uff69diter la r\uff83\uff69sa, il ne pourrait de toute fa\uff83\uff67on pas la modifier)\n\tif (($user != $beneficiaire) && ($user != $owner))\n\t\treturn 0;\n\telse if ($user == $beneficiaire)\n\t{\n\t\tif ($dont_allow_modify == 'y')\n\t\t\treturn 0;\n\t\telse\n\t\t\treturn 1;\n\t}\n\telse if ($user == $owner)\n\t{\n\t\tif ($dont_allow_modify == 'y')\n\t\t\treturn 0;\n\t\telse\n\t\t{\n\t\t\t$qui_peut_reserver_pour = grr_sql_query1(\"SELECT qui_peut_reserver_pour FROM \".TABLE_PREFIX.\"_room WHERE id='\".$id_room.\"'\");\n\t\t\tif (authGetUserLevel($user, $id_room) >= $qui_peut_reserver_pour)\n\t\t\t\treturn 1;\n\t\t\telse\n\t\t\t\treturn 0;\n\t\t}\n\t}\n\treturn 0;\n}\n//auth_visiteur($user,$id_room)\n//Determine si un visiteur peut r\uff83\uff69server une ressource\n//$user - l'identifiant de l'utilisateur\n//$id_room -   l'identifiant de la ressource\n//Retourne le niveau d'acc\uff83\uff68s de l'utilisateur//\nfunction auth_visiteur($user,$id_room)\n{\n\tglobal $id_room_autorise;\n\tif ((!isset($user)) || (!isset($id_room)))\n\t\treturn 0;\n\t$res = grr_sql_query(\"SELECT statut FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login ='\".protect_data_sql($user).\"'\");\n\tif (!$res || grr_sql_count($res) == 0)\n\t\treturn 0;\n\t$status = mysqli_fetch_row($res);\n\tif (strtolower($status[0]) == 'visiteur')\n\t{\n\t\tif ((in_array($id_room,$id_room_autorise)) && ($id_room_autorise != \"\"))\n\t\t\treturn 1;\n\t\telse\n\t\t\treturn 0;\n\t}\n\treturn 0;\n}\n//authGetUserLevel($user,$id,$type)\n//Determine le niveau d'acc\uff83\uff68s de l'utilisateur\n//$user - l'identifiant de l'utilisateur\n//$id -   l'identifiant de la ressource ou du domaine\n// $type - argument optionnel : 'room' (par d\uff83\uff69faut) si $id d\uff83\uff69signe une ressource et 'area' si $id d\uff83\uff69signe un domaine.\n////Retourne le niveau d'acc\uff83\uff68s de l'utilisateur\n// 0 NC / 1 Visiteur / 2 Utilisateur / 3 gestionnaire de ressource / 4 administrateur de domaine / 5 administrateur de site / 6 Admin g\uff83\uff69n\uff83\uff69ral\nfunction authGetUserLevel($user, $id, $type = 'room')\n{\n\t//user level '0': User not logged in, or User value is NULL (getUserName()='')\n\tif (!isset($user) || ($user == ''))\n\t\treturn 0;\n\t// On vient lire le statut de l'utilisateur courant dans la database\n\t$sql = \"SELECT statut FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='\".protect_data_sql($user).\"' \".\" AND etat='actif'\";\n\t$res = grr_sql_query($sql);\n\t$nbraw = grr_sql_count($res);\n\t//user level '0': User not defined in database\n\tif (!$res || $nbraw == 0)\n\t\treturn 0;\n\t// On vient lire le r\uff83\uff69sultat de la requ\uff83\uff68te\n\t$status = grr_sql_row($res,$nbraw-1);\n\t//user level '0': Same User defined multiple time in database !!!\n\tif ($status === 0)\n\t\treturn 0;\n\t// Teste si le type concerne la gestion des utilisateurs\n\tif ($type === 'user')\n\t{\n\t\tif (strtolower($status[0]) == 'gestionnaire_utilisateur')\n\t\t\treturn 1;\n\t\telse\n\t\t\treturn 0;\n\t}\n\tswitch (strtolower($status[0]))\n\t{\n\t\tcase 'visiteur':\n\t\treturn 1;\n\t\tcase 'administrateur':\n\t\treturn 6;\n\t\tdefault:\n\t\tbreak;\n\t}\n\tif ((strtolower($status[0]) == 'utilisateur') || (strtolower($status[0]) == 'gestionnaire_utilisateur'))\n\t{\n\t\tif ($type == 'room')\n\t\t{\n\t\t\t// On regarde si l'utilisateur est administrateur du site auquel la ressource $id appartient\n\t\t\t// calcul de l'id du domaine\n\t\t\t$id_area = grr_sql_query1(\"SELECT area_id FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id).\"'\");\n\t\t\t// calcul de l'id du site\n\t\t\t$id_site = grr_sql_query1(\"SELECT id_site FROM \".TABLE_PREFIX.\"_j_site_area  WHERE id_area='\".protect_data_sql($id_area).\"'\");\n\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t{\n\t\t\t\t$res3 = grr_sql_query(\"SELECT login FROM \".TABLE_PREFIX.\"_j_useradmin_site j WHERE j.id_site='\".protect_data_sql($id_site).\"' AND j.login='\".protect_data_sql($user).\"'\");\n\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t{\n\t\t\t\t\tgrr_sql_free($res3);\n\t\t\t\t\treturn 5;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// On regarde si l'utilisateur est administrateur du domaine auquel la ressource $id appartient\n\t\t\t$res3 = grr_sql_query(\"SELECT u.login\n\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_area j\n\t\t\t\tWHERE (u.login=j.login AND j.id_area='\".protect_data_sql($id_area).\"' AND u.login='\".protect_data_sql($user).\"')\");\n\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\treturn 4;\n\t\t\t// On regarde si l'utilisateur est gestionnaire des r\uff83\uff69servations pour une ressource\n\t\t\t$str_res2 = \"SELECT *\n\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_user_room j\n\t\t\tWHERE u.login=j.login and u.login='\".protect_data_sql($user).\"' \";\n\t\t\tif ($id!=-1)\n\t\t\t\t$str_res2.=\"AND j.id_room='\".protect_data_sql($id).\"'\";\n\t\t\t$res2 = grr_sql_query($str_res2);\n\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\treturn 3;\n\t\t\t// Sinon il s'agit d'un simple utilisateur\n\t\t\treturn 2;\n\t\t}\n\t\t// On regarde si l'utilisateur est administrateur d'un domaine\n\t\tif ($type == 'area')\n\t\t{\n\t\t\tif ($id == '-1')\n\t\t\t{\n\t\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t\t{\n\t\t\t\t//On regarde si l'utilisateur est administrateur d'un site quelconque\n\t\t\t\t\t$res2 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_site j\n\t\t\t\t\t\tWHERE (u.login=j.login and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\t\t\treturn 5;\n\t\t\t\t}\n\t\t\t\t//On regarde si l'utilisateur est administrateur d'un domaine quelconque\n\t\t\t\t$res2 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_area j\n\t\t\t\t\tWHERE (u.login=j.login and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\t\treturn 4;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t\t{\n\t\t\t\t// On regarde si l'utilisateur est administrateur du site auquel le domaine $id appartient\n\t\t\t\t\t$id_site = grr_sql_query1(\"SELECT id_site FROM \".TABLE_PREFIX.\"_j_site_area  WHERE id_area='\".protect_data_sql($id).\"'\");\n\t\t\t\t\t$res3 = grr_sql_query(\"SELECT login FROM \".TABLE_PREFIX.\"_j_useradmin_site j WHERE j.id_site='\".protect_data_sql($id_site).\"' AND j.login='\".protect_data_sql($user).\"'\");\n\t\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t\t\treturn 5;\n\t\t\t\t}\n\t\t\t\t//On regarde si l'utilisateur est administrateur du domaine dont l'id est $id\n\t\t\t\t$res3 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_area j\n\t\t\t\t\tWHERE (u.login=j.login and j.id_area='\".protect_data_sql($id).\"' and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t\treturn 4;\n\t\t\t}\n\t\t\t// Sinon il s'agit d'un simple utilisateur\n\t\t\treturn 2;\n\t\t}\n\t\t// On regarde si l'utilisateur est administrateur d'un site\n\t\tif (($type == 'site') and (Settings::get(\"module_multisite\") == \"Oui\"))\n\t\t{\n\t\t\tif ($id == '-1')\n\t\t\t{\n\t\t\t\t//On regarde si l'utilisateur est administrateur d'un site quelconque\n\t\t\t\t$res2 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_site j\n\t\t\t\t\tWHERE (u.login=j.login and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\t\treturn 5;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t//On regarde si l'utilisateur est administrateur du site dont l'id est $id\n\t\t\t\t$res3 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_site j\n\t\t\t\t\tWHERE (u.login=j.login and j.id_site='\".protect_data_sql($id).\"' and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t\treturn 5;\n\t\t\t}\n\t\t\t// Sinon il s'agit d'un simple utilisateur\n\t\t\treturn 2;\n\t\t}\n\t}\n}\n/* authUserAccesArea($user,$id)\n *\n * Determines if the user access area\n *\n * $user - The user name\n * $id -   Which area are we checking\n *\n */\nfunction authUserAccesArea($user,$id)\n{\n\tif ($id == '')\n\t\treturn 0;\n\t$sql = \"SELECT login FROM \".TABLE_PREFIX.\"_utilisateurs WHERE (login = '\".protect_data_sql($user).\"' and statut='administrateur')\";\n\t$res = grr_sql_query($sql);\n\tif (grr_sql_count($res) != \"0\")\n\t\treturn 1;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\t\t$id_site = mrbsGetAreaSite($id);\n\t\t$sql = \"SELECT login FROM \".TABLE_PREFIX.\"_j_useradmin_site j WHERE j.id_site='\".$id_site.\"' AND j.login='\".protect_data_sql($user).\"'\";\n\t\t$res = grr_sql_query($sql);\n\t\tif (grr_sql_count($res) != \"0\")\n\t\t\treturn 1;\n\t}\n\t$sql = \"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE (id = '\".protect_data_sql($id).\"' and access='r')\";\n\t$res = grr_sql_query($sql);\n\t$test = grr_sql_count($res);\n\tif ($test == \"0\")\n\t\treturn 1;\n\telse\n\t{\n\t\t$sql2 = \"SELECT login FROM \".TABLE_PREFIX.\"_j_user_area WHERE (login = '\".protect_data_sql($user).\"' and id_area = '\".protect_data_sql($id).\"')\";\n\t\t$res2 = grr_sql_query($sql2);\n\t\t$test2 = grr_sql_count($res2);\n\t\tif ($test2 != \"0\")\n\t\t\treturn 1;\n\t\telse\n\t\t\treturn 0;\n\t}\n}\n// function UserRoomMaxBooking\n// Cette fonction teste si l'utilisateur a la possibilit\uff83\uff69 d'effectuer une r\uff83\uff69servation, compte tenu\n// des limitations \uff83\uff69ventuelles de la ressources et du nombre de r\uff83\uff69servations d\uff83\uff69j\uff83\uf8f0 effectu\uff83\uff69es.\n//\nfunction UserRoomMaxBooking($user, $id_room, $number)\n{\n\tglobal $enable_periods,$id_room_autorise;\n\t$level = authGetUserLevel($user,$id_room);\n\tif ($id_room == '')\n\t\treturn 0;\n\tif ($level >= 3)\n\t\treturn 1;\n\telse if (($level == 1 ) &&  !((in_array($id_room,$id_room_autorise)) && ($id_room_autorise != \"\")))\n\t\treturn 0;\n\telse if ($level  < 1 )\n\t\treturn 0;\n\t// A ce niveau, l'utilisateur est simple utilisateur ou bien simple visiteur sur un domaine autoris\uff83\uff69\n\t// On regarde si le nombre de r\uff83\uff69servation de la ressource est limit\uff83\uff69\n\t$max_booking_per_room = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_room WHERE id = '\".protect_data_sql($id_room).\"'\");\n\t// Calcul de l'id de l'area de la ressource.\n\t$id_area = mrbsGetRoomArea($id_room);\n\t// On regarde si le nombre de r\uff83\uff69servation du domaine est limit\uff83\uff69\n\t$max_booking_per_area = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($id_area).\"'\");\n\t// On regarde si le nombre de r\uff83\uff69servation pour l'ensemble des ressources est limit\uff83\uff69\n\t$max_booking = Settings::get(\"UserAllRoomsMaxBooking\");\n\t// Si aucune limitation\n\tif (($max_booking_per_room < 0) && ($max_booking_per_area < 0) && ($max_booking < 0))\n\t\treturn 1;\n\t// A ce niveau, il s'agit d'un utilisateur et il y a au moins une limitation\n\t$day   = date(\"d\");\n\t$month = date(\"m\");\n\t$year  = date(\"Y\");\n\t$hour  = date(\"H\");\n\t$minute = date(\"i\");\n\tif ($enable_periods == 'y')\n\t\t$now = mktime(0, 0, 0, $month, $day, $year);\n\telse\n\t\t$now = mktime($hour, $minute, 0, $month, $day, $year);\n\t// y-a-t-il d\uff83\uff69passement pour l'ensemble des ressources ?\n\tif ($max_booking > 0)\n\t{\n\t\t$nb_bookings = grr_sql_query1(\"SELECT count(id) FROM \".TABLE_PREFIX.\"_entry r WHERE (beneficiaire = '\".protect_data_sql($user).\"' and end_time > '$now')\");\n\t\t$nb_bookings += $number;\n\t\tif ($nb_bookings > $max_booking)\n\t\t\treturn 0;\n\t}\n\telse if ($max_booking == 0)\n\t\treturn 0;\n\t// y-a-t-il d\uff83\uff69passement pour l'ensemble des ressources du domaine ?\n\tif ($max_booking_per_area > 0)\n\t{\n\t\t$nb_bookings = grr_sql_query1(\"SELECT count(e.id) FROM \".TABLE_PREFIX.\"_entry e, \".TABLE_PREFIX.\"_room r WHERE (e.room_id=r.id and r.area_id='\".$id_area.\"' and e.beneficiaire = '\".protect_data_sql($user).\"' and e.end_time > '$now')\");\n\t\t$nb_bookings += $number;\n\t\tif ($nb_bookings > $max_booking_per_area)\n\t\t\treturn 0;\n\t}\n\telse if ($max_booking_per_area == 0)\n\t\treturn 0;\n\t// y-a-t-il d\uff83\uff69passement pour la ressource\n\tif ($max_booking_per_room > 0)\n\t{\n\t\t$nb_bookings = grr_sql_query1(\"SELECT count(id) FROM \".TABLE_PREFIX.\"_entry WHERE (room_id = '\".protect_data_sql($id_room).\"' and beneficiaire = '\".protect_data_sql($user).\"' and end_time > '$now')\");\n\t\t$nb_bookings += $number;\n\t\tif ($nb_bookings > $max_booking_per_room)\n\t\t\treturn 0;\n\t}\n\telse if ($max_booking_per_room == 0)\n\t\treturn 0;\n\t// A ce stade, il s'agit d'un utilisateu et il n'y a pas eu de d\uff83\uff69passement, ni pour l'ensemble des domaines, ni pour le domaine, ni pour la ressource\n\treturn 1;\n}\n/* function verif_booking_date($user, $id, $date_booking, $date_now)\n $user : le login de l'utilisateur\n $id : l'id de la r\uff83\uff69sa. Si -1, il s'agit d'une nouvelle r\uff83\uff69servation\n $id_room : id de la ressource\n $date_booking : la date de la r\uff83\uff69servation (n'est utile que si $id=-1)\n $date_now : la date actuelle\n*/\n /**\n  * @param string $date_booking\n  * @param integer $date_now\n  */\n function verif_booking_date($user, $id, $id_room, $date_booking, $date_now, $enable_periods, $endtime = '')\n {\n \tglobal $correct_diff_time_local_serveur, $can_delete_or_create;\n \t$can_delete_or_create = \"y\";\n\t// On teste si l'utilisateur est administrateur\n \t$sql = \"SELECT statut FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".protect_data_sql($user).\"'\";\n \t$statut_user = grr_sql_query1($sql);\n \tif ($statut_user == 'administrateur')\n \t\treturn true;\n\t// A-t-on le droit d'agir dans le pass\uff83\uff69 ?\n \t$allow_action_in_past = grr_sql_query1(\"SELECT allow_action_in_past FROM \".TABLE_PREFIX.\"_room WHERE id = '\".protect_data_sql($id_room).\"'\");\n \tif ($allow_action_in_past == 'y')\n \t\treturn true;\n\t// Correction de l'avance en nombre d'heure du serveur sur les postes clients\n \tif ((isset($correct_diff_time_local_serveur)) && ($correct_diff_time_local_serveur!=0))\n \t\t$date_now -= 3600 * $correct_diff_time_local_serveur;\n\t// Cr\uff83\uff69neaux bas\uff83\uff69s sur les intitul\uff83\uff69s\n\t// Dans ce cas, on prend comme temps pr\uff83\uff69sent le jour m\uff83\uff6ame \uff83\uf8f0 minuit.\n\t// Cela signifie qu'il est possible de modifier/r\uff83\uff69server/supprimer tout au long d'une journ\uff83\uff69e\n\t// m\uff83\uff6ame si l'heure est pass\uff83\uff69e.\n\t// Cela demande donc \uff83\uf8f0 \uff83\uff6atre am\uff83\uff69liorer en introduisant pour chaque cr\uff83\uff69neau une heure limite de r\uff83\uff69servation.\n \tif ($enable_periods == \"y\")\n \t{\n \t\t$month = date(\"m\",$date_now);\n \t\t$day = date(\"d\",$date_now);\n \t\t$year = date(\"Y\",$date_now);\n \t\t$date_now = mktime(0, 0, 0, $month, $day, $year);\n \t}\n \tif ($id != -1)\n \t{\n\t\t// il s'agit de l'edition d'une r\uff83\uff69servation existante\n \t\tif (($endtime != '') && ($endtime < $date_now))\n \t\t\treturn false;\n \t\tif ((Settings::get(\"allow_user_delete_after_begin\") == 1) || (Settings::get(\"allow_user_delete_after_begin\") == 2))\n \t\t\t$sql = \"SELECT end_time FROM \".TABLE_PREFIX.\"_entry WHERE id = '\".protect_data_sql($id).\"'\";\n \t\telse\n \t\t\t$sql = \"SELECT start_time FROM \".TABLE_PREFIX.\"_entry WHERE id = '\".protect_data_sql($id).\"'\";\n \t\t$date_booking = grr_sql_query1($sql);\n \t\tif ($date_booking < $date_now)\n \t\t\treturn false;\n \t\telse\n \t\t{\n\t\t\t// dans le cas o\uff83\uff79 le cr\uff83\uff69neau est entam\uff83\uff69, on teste si l'utilisateur a le droit de supprimer la r\uff83\uff69servation\n\t\t\t// Si oui, on transmet la variable $only_modify = true avant que la fonction de retourne true.\n \t\t\tif (Settings::get(\"allow_user_delete_after_begin\") == 2)\n \t\t\t{\n \t\t\t\t$date_debut = grr_sql_query1(\"SELECT start_time FROM \".TABLE_PREFIX.\"_entry WHERE id = '\".protect_data_sql($id).\"'\");\n \t\t\t\tif ($date_debut < $date_now)\n \t\t\t\t\t$can_delete_or_create = \"n\";\n \t\t\t\telse\n \t\t\t\t\t$can_delete_or_create = \"y\";\n \t\t\t}\n \t\t\treturn true;\n \t\t}\n \t}\n \telse\n \t{\n \t\tif (Settings::get(\"allow_user_delete_after_begin\") == 1)\n \t\t{\n \t\t\t$id_area = grr_sql_query1(\"select area_id from \".TABLE_PREFIX.\"_room WHERE id = '\".protect_data_sql($id_room).\"'\");\n \t\t\t$resolution_area = grr_sql_query1(\"select resolution_area from \".TABLE_PREFIX.\"_area WHERE id = '\".$id_area.\"'\");\n \t\t\tif ($date_booking > $date_now - $resolution_area)\n \t\t\t\treturn true;\n \t\t\treturn false;\n \t\t}\n \t\telse\n \t\t{\n \t\t\tif ($date_booking > $date_now)\n \t\t\t\treturn true;\n \t\t\treturn false;\n \t\t}\n \t}\n }\n// function verif_duree_max_resa_area($user, $id_room, $starttime, $endtime)\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource. Si -1, il s'agit d'une nouvelle ressource.\n// $starttime : d\uff83\uff69but de la r\uff83\uff69servation\n// $endtime : fin de la r\uff83\uff69servation\n function verif_duree_max_resa_area($user, $id_room, $starttime, $endtime)\n {\n \tif (authGetUserLevel($user,$id_room) >= 3)\n \t\treturn true;\n \t$id_area = grr_sql_query1(\"SELECT area_id from \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n \t$duree_max_resa_area = grr_sql_query1(\"SELECT duree_max_resa_area from \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n \t$enable_periods =  grr_sql_query1(\"SELECT enable_periods from \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n \tif ($enable_periods == 'y')\n \t\t$duree_max_resa_area = $duree_max_resa_area * 24 * 60;\n \tif ($duree_max_resa_area < 0)\n \t\treturn true;\n \telse if ($endtime - $starttime > $duree_max_resa_area * 60)\n \t\treturn false;\n \treturn true;\n }\n// function verif_delais_max_resa_room($user, $id_room, $date_booking)\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource. Si -1, il s'agit d'une nouvelle ressoure\n// $date_booking : la date de la r\uff83\uff69servation (n'est utile que si $id=-1)\n// $date_now : la date actuelle\n function verif_delais_max_resa_room($user, $id_room, $date_booking)\n {\n \t$day   = date(\"d\");\n \t$month = date(\"m\");\n \t$year  = date(\"Y\");\n \t$datenow = mktime(0, 0, 0, $month, $day, $year);\n \tif (authGetUserLevel($user,$id_room) >= 3)\n \t\treturn true;\n \t$delais_max_resa_room = grr_sql_query1(\"SELECT delais_max_resa_room FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n\tif ($delais_max_resa_room == -1)\n \t\treturn true;\n \telse if ($datenow + $delais_max_resa_room * 24 * 3600 + 1 < $date_booking)\n \t\treturn false;\n \treturn true;\n }\n// function verif_access_search : v\uff83\uff69rifier l'acc\uff83\uff68s \uff83\uf8f0 l'outil de recherche\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource.\n function verif_access_search($user)\n {\n \tif (authGetUserLevel($user,-1) >= Settings::get(\"allow_search_level\"))\n \t\treturn true;\n \treturn false;\n }\n// function verif_display_fiche_ressource : v\uff83\uff69rifier l'acc\uff83\uff68s \uff83\uf8f0 la visualisation de la fiche d'une ressource\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource.\n function verif_display_fiche_ressource($user, $id_room)\n {\n \t$show_fic_room = grr_sql_query1(\"SELECT show_fic_room FROM \".TABLE_PREFIX.\"_room WHERE id='\".$id_room.\"'\");\n \tif ($show_fic_room == \"y\")\n \t{\n \t\tif (authGetUserLevel($user,$id_room) >= Settings::get(\"visu_fiche_description\"))\n \t\t\treturn true;\n \t\treturn false;\n \t}\n \treturn false;\n }\n// function verif_acces_fiche_reservation : v\uff83\uff69rifier l'acc\uff83\uff68s \uff83\uf8f0 la fiche de r\uff83\uff69servation d'une ressource\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource.\n function verif_acces_fiche_reservation($user, $id_room)\n {\n \tif (authGetUserLevel($user,$id_room) >= Settings::get(\"acces_fiche_reservation\"))\n \t\treturn true;\n \treturn false;\n }\n/* function verif_display_email : v\uff83\uff69rifier l'acc\uff83\uff68s \uff83\uf8f0 l'adresse email\n *$user : le login de l'utilisateur\n * $id_room : l'id de la ressource.\n */\nfunction verif_display_email($user, $id_room)\n{\n\tif (authGetUserLevel($user,$id_room) >= Settings::get(\"display_level_email\"))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n/* function verif_acces_ressource : v\uff83\uff69rifier l'acc\uff83\uff68s \uff83\uf8f0 la ressource\n *$user : le login de l'utilisateur\n * $id_room : l'id de la ressource.\n */\nfunction verif_acces_ressource($user, $id_room)\n{\n\tif ($id_room != 'all')\n\t{\n\t\t$who_can_see = grr_sql_query1(\"SELECT who_can_see FROM \".TABLE_PREFIX.\"_room WHERE id='\".$id_room.\"'\");\n\t\tif (authGetUserLevel($user,$id_room) >= $who_can_see)\n\t\t\treturn true;\n\t\telse\n\t\t\treturn false;\n\t}\n\telse\n\t{\n\t\t$tab_rooms_noaccess = array();\n\t\t$sql = \"SELECT id, who_can_see FROM \".TABLE_PREFIX.\"_room\";\n\t\t$res = grr_sql_query($sql);\n\t\tif (!$res)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (authGetUserLevel($user,$row[0]) < $row[1])\n\t\t\t\t$tab_rooms_noaccess[] = $row[0];\n\t\t}\n\t\treturn $tab_rooms_noaccess;\n\t}\n}\n// function verif_delais_min_resa_room($user, $id_room, $date_booking)\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource. Si -1, il s'agit d'une nouvelle ressoure\n// $date_booking : la date de la r\uff83\uff69servation (n'est utile que si $id=-1)\n// $date_now : la date actuelle\n//\nfunction verif_delais_min_resa_room($user, $id_room, $date_booking)\n{\n\tif (authGetUserLevel($user,$id_room) >= 3)\n\t\treturn true;\n\t$delais_min_resa_room = grr_sql_query1(\"SELECT delais_min_resa_room FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n\tif ($delais_min_resa_room == 0)\n\t\treturn true;\n\telse\n\t{\n\t\t$hour = date(\"H\");\n\t\t$minute  = date(\"i\") + $delais_min_resa_room;\n\t\t$day   = date(\"d\");\n\t\t$month = date(\"m\");\n\t\t$year  = date(\"Y\");\n\t\t$date_limite = mktime($hour, $minute, 0, $month, $day, $year);\n\t\tif ($date_limite > $date_booking)\n\t\t\treturn false;\n\t\treturn true;\n\t}\n}\n// V\uff83\uff69rifie que la date de confirmation est inf\uff83\uff69rieur \uff83\uf8f0 la date de d\uff83\uff69but de r\uff83\uff69servation\nfunction verif_date_option_reservation($option_reservation, $starttime)\n{\n\tif ($option_reservation == -1)\n\t\treturn true;\n\telse\n\t{\n\t\t$day   = date(\"d\", $starttime);\n\t\t$month = date(\"m\", $starttime);\n\t\t$year  = date(\"Y\", $starttime);\n\t\t$date_starttime = mktime(0, 0, 0, $month, $day, $year);\n\t\tif ($option_reservation < $date_starttime)\n\t\t\treturn true;\n\t\treturn false;\n\t}\n}\n// V\uff83\uff69rifie que $_create_by peut r\uff83\uff69server la ressource $_room_id pour $_beneficiaire\nfunction verif_qui_peut_reserver_pour($_room_id, $_create_by, $_beneficiaire)\n{\n\tif ($_beneficiaire == \"\")\n\t\treturn true;\n\tif (strtolower($_create_by) == strtolower($_beneficiaire))\n\t\treturn true;\n\t$qui_peut_reserver_pour  = grr_sql_query1(\"SELECT qui_peut_reserver_pour FROM \".TABLE_PREFIX.\"_room WHERE id='\".$_room_id.\"'\");\n\tif (authGetUserLevel($_create_by, $_room_id) >= $qui_peut_reserver_pour)\n\t\treturn true;\n\treturn false;\n}\n/*\nfunction verif_heure_debut_fin($start_time,$end_time,$area)\nV\uff83\uff69rifie si l'heure de d\uff83\uff69but ou l'heure de fin de r\uff83\uff69servation est en dehors des cr\uff83\uff69neaux autoris\uff83\uff69s.\n*/\nfunction verif_heure_debut_fin($start_time,$end_time,$area)\n{\n\tglobal $enable_periods, $resolution, $morningstarts, $eveningends, $eveningends_minutes;\n\t\t// R\uff83\uff69cup\uff83\uff69ration des donn\uff83\uff69es concernant l'affichage du planning du domaine\n\tget_planning_area_values($area);\n\t\t// On ne traite pas le cas des plannings bas\uff83\uff69s sur les intitul\uff83\uff69s pr\uff83\uff69d\uff83\uff69finis\n\tif ($enable_periods != \"y\")\n\t{\n\t\t$day = date(\"d\",$start_time);\n\t\t$month = date(\"m\",$start_time);\n\t\t$year = date(\"Y\",$start_time);\n\t\t$startday = mktime($morningstarts, 0, 0, $month, $day  , $year);\n\t\t$day = date(\"d\",$end_time);\n\t\t$month = date(\"m\",$end_time);\n\t\t$year = date(\"Y\",$end_time);\n\t\t$endday = mktime($eveningends, $eveningends_minutes , $resolution, $month, $day, $year);\n\t\tif ($start_time < $startday)\n\t\t\treturn false;\n\t\telse if ($end_time > $endday)\n\t\t\treturn false;\n\t}\n\treturn true;\n}\n/* VerifyModeDemo()\n *\n * Affiche une page \"op\uff83\uff69ration non autoris\uff83\uff69e\" pour certaines op\uff83\uff69rations dans le cas le mode demo est activ\uff83\uff69.\n *\n * Returns: Nothing\n */\nfunction VerifyModeDemo() {\n\tif (Settings::get(\"ActiveModeDemo\") == 'y')\n\t{\n\t\tprint_header(\"\", \"\", \"\", \"\");\n\t\t?>\n\t\t<h1>Op&eacute;ration non autoris&eacute;e</h1>\n\t\t<p>Vous \uff83\uff6ates dans une <b>version de d\uff83\uff69monstration de GRR</b>.\n\t\t\t<br />Certaines fonctions ont \uff83\uff69t\uff83\uff69 volontairement brid\uff83\uff69es. C'est le cas pour l'op\uff83\uff69ration que vous avez tent\uff83\uff69 d'effectuer.</p>\n\t\t</body></html>\n\t\t<?php\n\t\tdie();\n\t}\n}\n/* MajMysqlModeDemo()\n * dans le cas le mode demo est activ\uff83\uff69 :\n * Met \uff83\uf8f0 jour la base mysql une fois par jour, lors de la premi\uff83\uff68re connexion\n *\n */\nfunction MajMysqlModeDemo() {\n\t\t// Nom du fichier sql \uff83\uf8f0 ex\uff83\uff69cuter\n\t$fic_sql = \"grr_maj_quotidienne.sql\";\n\tif ((Settings::get(\"ActiveModeDemo\") == 'y') && (file_exists($fic_sql)))\n\t{\n\t\t$date_now = mktime(0,0,0,date(\"m\"),date(\"d\"),date(\"Y\"));\n\t\tif ((Settings::get(\"date_verify_demo\") == \"\") || (Settings::get(\"date_verify_demo\") < $date_now))\n\t\t{\n\t\t\t$fd = fopen($fic_sql, \"r\");\n\t\t\twhile (!feof($fd))\n\t\t\t{\n\t\t\t\t$query = fgets($fd, 5000);\n\t\t\t\t$query = trim($query);\n\t\t\t\tif ($query != '')\n\t\t\t\t\tmysqli_query($GLOBALS['db_c'], $query);\n\t\t\t}\n\t\t\tfclose($fd);\n\t\t\tif (!Settings::set(\"date_verify_demo\", $date_now))\n\t\t\t{\n\t\t\t\techo \"Erreur lors de l'enregistrement de date_verify_demo !<br />\";\n\t\t\t\tdie();\n\t\t\t}\n\t\t}\n\t}\n}\n/* showAccessDenied()\n *\n * Displays an appropriate message when access has been denied\n *\n * Returns: Nothing\n */\nfunction showAccessDenied($back)\n{\n\tglobal $vocab;\n\techo '<h1>'.get_vocab(\"accessdenied\").'</h1>';\n\techo '<p>'.get_vocab(\"norights\").'</p>';\n\techo '<p><a href=\"'.$back.'\">'.get_vocab(\"returnprev\").'</a></p>';\n\tend_page();\n}\n/* showNoReservation()\n *\n * Displays an appropriate message when reservation does not exist\n *\n * Returns: Nothing\n */\nfunction showNoReservation($day, $month, $year, $back)\n{\n\tglobal $vocab;\n\tif ((Settings::get(\"authentification_obli\") == 0) && (getUserName() == ''))\n\t\t$type_session = \"no_session\";\n\telse\n\t\t$type_session = \"with_session\";\n\tstart_page_w_header($day, $month, $year, $type_session);\n\techo '<h1>'.get_vocab(\"accessdenied\").'</h1>';\n\techo '<p>'.get_vocab(\"noreservation\").'</p>';\n\techo '<p><a href=\"'.$back.'\">'.get_vocab(\"returnprev\").'</a></p>';\n    end_page();\n}\n/* showAccessDeniedMaxBookings()\n *\n * Displays an appropriate message when access has been denied because of overbooking\n *\n * Returns: Nothing\n */\nfunction showAccessDeniedMaxBookings($day, $month, $year, $id_room, $back)\n{\n\tglobal $vocab;\n\tprint_header($day, $month, $year, $type=\"with_session\");\n\t?>\n\t<h1><?php echo get_vocab(\"accessdenied\")?></h1>\n\t<p>\n\t\t<?php\n\t\t// Limitation par ressource\n\t\t$max_booking_per_room = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n\t\tif ($max_booking_per_room >= 0)\n\t\t\techo get_vocab(\"msg_max_booking\").get_vocab(\"deux_points\").$max_booking_per_room.\"<br />\";\n\t\t// Calcul de l'id de l'area de la ressource.\n\t\t$id_area = mrbsGetRoomArea($id_room);\n\t\t// Limitation par domaine\n\t\t$max_booking_per_area = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($id_area).\"'\");\n\t\tif ($max_booking_per_area >= 0)\n\t\t\techo get_vocab(\"msg_max_booking_area\").get_vocab(\"deux_points\").$max_booking_per_area.\"<br />\";\n\t\t// Limitation sur l'ensemble des ressources\n\t\t$max_booking_all = Settings::get(\"UserAllRoomsMaxBooking\");\n\t\tif ($max_booking_all >= 0)\n\t\t\techo get_vocab(\"msg_max_booking_all\").get_vocab(\"deux_points\").$max_booking_all.\"<br />\";\n\t\techo \"<br />\".get_vocab(\"accessdeniedtoomanybooking\");\n\t\t?>\n\t</p>\n\t<p>\n\t\t<a href=\"<?php echo $back; ?>\"><?php echo get_vocab(\"returnprev\"); ?></a>\n\t</p>\n</body>\n</html>\n<?php\n}\n/* fonction qui rend TRUE lorsque la date propos\uff83\uff69e est en dehors de la p\uff83\uff69riode r\uff83\uff69servable\n*/\nfunction check_begin_end_bookings($day, $month, $year)\n{\n\t$date = mktime(0,0,0,$month,$day,$year);\n\tif (($date < Settings::get(\"begin_bookings\")) || ($date > Settings::get(\"end_bookings\")))\n\t\treturn -1;\n}\nfunction showNoBookings($day, $month, $year, $back)\n{\n\tglobal $vocab;\n\t$date = mktime(0, 0, 0, $month, $day,$year);\n\techo '<h2>'.get_vocab(\"nobookings\").' '.affiche_date($date).'</h2>';\n\techo '<p>'.get_vocab(\"begin_bookings\").'<b>'.affiche_date(Settings::get(\"begin_bookings\")).'</b></p>';\n\techo '<p>'.get_vocab(\"end_bookings\").'<b>'.affiche_date(Settings::get(\"end_bookings\")).'</b></p>';\n    echo \"<p>\";\n        if ($back !=''){\n            echo \"<a href=\".$back.\">\".get_vocab('returnprev').\"</a>\";\n        }\n    echo \"</p>\";\n    echo \"</body>\\n</html>\";\n}\n/* donne, pour un format fran\uff83\uff67ais, un r\uff83\uff69sultat de la forme lundi 30 sept.19:17:32\n*/\nfunction date_time_string($t, $dformat)\n{\n\tglobal $twentyfourhour_format;\n\tif ($twentyfourhour_format)\n\t\t$timeformat = \"%T\";\n\telse\n\t{\n\t\t$ampm = date(\"a\",$t);\n\t\t$timeformat = \"%I:%M$ampm\";\n\t}\n\treturn utf8_strftime($dformat.\" \".$timeformat, $t);\n}\n# Convertit un cr\uff83\uff69neau de d\uff83\uff69but et de fin en un tableau donnant la date de d\uff83\uff69but et la dur\uff83\uff69e\nfunction describe_period_span2($starts, $ends)\n{\n\tglobal $enable_periods, $periods_name, $vocab, $duration;\n\tlist($start_period, $start_date) =  period_date_string($starts);\n\tlist($periodedebut, $datedebut) =  period_date_string_rapport($starts);\n\tlist( , $end_date) =  period_date_string($ends, -1);\n\t$duration = $ends - $starts;\n\ttoPeriodString($start_period, $duration, $dur_units);\n\tif ($duration > 1)\n\t{\n\t\tlist( , $start_date) =  period_date_string($starts);\n\t\tlist( , $end_date) =  period_date_string($ends, -1);\n\t\t//$temp = $start_date . \" ==> \" . $end_date;\n\t}\n\t//else\n\t//{\n\t//\t$temp = $start_date . \" - \" . $duration . \" \" . $dur_units;\n\t//}\n\treturn array($datedebut, $periodedebut, $duration, $dur_units);\n}\n#Convertit l'heure de d\uff83\uff69but et de fin un tableau donnant la date de d\uff83\uff69but et la dur\uff83\uff69e.\nfunction describe_span2($starts, $ends, $dformat)\n{\n\tglobal $vocab, $twentyfourhour_format;\n\t$start_date = utf8_strftime($dformat, $starts);\n\tif ($twentyfourhour_format)\n\t\t$timeformat = \"%T\";\n\telse\n\t{\n\t\t$ampm = date(\"a\",$starts);\n\t\t$timeformat = \"%I:%M$ampm\";\n\t}\n\t$start_time = strftime($timeformat, $starts);\n\t$duration = $ends - $starts;\n\ttoTimeString($duration, $dur_units);\n\treturn array($start_date, $start_time ,$duration, $dur_units);\n}\n# Convert a start period and end period to a plain language description.\n# This is similar but different from the way it is done in view_entry.\nfunction describe_period_span($starts, $ends)\n{\n\tglobal $enable_periods, $periods_name, $vocab, $duration;\n\tlist($start_period, $start_date) =  period_date_string($starts);\n\tlist( , $end_date) =  period_date_string($ends, -1);\n\t$duration = $ends - $starts;\n\ttoPeriodString($start_period, $duration, $dur_units);\n\tif ($duration > 1)\n\t{\n\t\tlist( , $start_date) =  period_date_string($starts);\n\t\tlist( , $end_date) =  period_date_string($ends, -1);\n\t\t$temp = $start_date . \" ==> \" . $end_date;\n\t}\n\telse\n\t{\n\t\t$temp = $start_date . \" - \" . $duration . \" \" . $dur_units;\n\t}\n\treturn $temp;\n}\n#Convertit l'heure de d\uff83\uff69but et de fin en p\uff83\uff69riode.\nfunction describe_span($starts, $ends, $dformat)\n{\n\tglobal $vocab, $twentyfourhour_format;\n\t$start_date = utf8_strftime($dformat, $starts);\n\tif ($twentyfourhour_format)\n\t\t$timeformat = \"%T\";\n\telse\n\t{\n\t\t$ampm = date(\"a\",$starts);\n\t\t$timeformat = \"%I:%M$ampm\";\n\t}\n\t$start_time = strftime($timeformat, $starts);\n\t$duration = $ends - $starts;\n\tif ($start_time == \"00:00:00\" && $duration == 60 * 60 * 24)\n\t\treturn $start_date . \" - \" . get_vocab(\"all_day\");\n\ttoTimeString($duration, $dur_units);\n\treturn $start_date . \" \" . $start_time . \" - \" . $duration . \" \" . $dur_units;\n}\nfunction get_planning_area_values($id_area)\n{\n\tglobal $resolution, $morningstarts, $eveningends, $eveningends_minutes, $weekstarts, $twentyfourhour_format, $enable_periods, $periods_name, $display_day, $nb_display_day;\n\t$sql = \"SELECT calendar_default_values, resolution_area, morningstarts_area, eveningends_area, eveningends_minutes_area, weekstarts_area, twentyfourhour_format_area, enable_periods, display_days\n\tFROM \".TABLE_PREFIX.\"_area\n\tWHERE id = '\".protect_data_sql($id_area).\"'\";\n\t$res = grr_sql_query($sql);\n\tif (!$res)\n\t{\n\t\t//fatal_error(0, grr_sql_error());\n\t\tinclude \"trailer.inc.php\";\n\t\texit;\n\t}\n\t$row_ = grr_sql_row($res, 0);\n\t$nb_display_day = 0;\n\tfor ($i = 0; $i < 7; $i++)\n\t{\n\t\tif (substr($row_[8],$i,1) == 'y')\n\t\t{\n\t\t\t$display_day[$i] = 1;\n\t\t\t$nb_display_day++;\n\t\t}\n\t\telse\n\t\t\t$display_day[$i] = 0;\n\t}\n\tif ($row_[7] == 'y')\t// Cr\uff83\uff69neaux bas\uff83\uff69s sur les intitul\uff83\uff69s\n\t{\n\t\t$resolution = 60;\n\t\t$morningstarts = 12;\n\t\t$eveningends = 12;\n\t\t$sql_periode = grr_sql_query(\"SELECT nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"'\");\n\t\t$eveningends_minutes = grr_sql_count($sql_periode) - 1;\n\t\t$i = 0;\n\t\twhile ($i <= $eveningends_minutes)\n\t\t{\n\t\t\t$periods_name[$i] = grr_sql_query1(\"SELECT nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"' and num_periode= '\".$i.\"'\");\n\t\t\t$i++;\n\t\t}\n\t\t$enable_periods = \"y\";\n\t\t$weekstarts = $row_[5];\n\t\t$twentyfourhour_format = $row_[6];\n\t}\n\telse\t\t// Cr\uff83\uff69neaux bas\uff83\uff69s sur le temps\n\t{\n\t\tif ($row_[0] != 'y')\n\t\t{\n\t\t\t$resolution = $row_[1];\n\t\t\t$morningstarts = $row_[2];\n\t\t\t$eveningends = $row_[3];\n\t\t\t$eveningends_minutes = $row_[4];\n\t\t\t$enable_periods = \"n\";\n\t\t\t$weekstarts = $row_[5];\n\t\t\t$twentyfourhour_format = $row_[6];\n\t\t}\n\t}\n}\n// Dans le cas ou $unicode_encoding = 1 (UTF-8) cette fonction encode les cha\uff83\uff6enes pr\uff83\uff69sentes dans\n// le code \"en dur\", en UTF-8 avant affichage\nfunction encode_message_utf8($tag)\n{\n\tglobal $charset_html, $unicode_encoding;\n\tif ($unicode_encoding)\n\t\treturn iconv($charset_html,\"utf-8\",$tag);\n\telse\n\t\treturn $tag;\n}\n/**\n * @param string $string\n * @return string\n */\nfunction removeMailUnicode($string)\n{\n\tglobal $unicode_encoding, $charset_html;\n\tif ($unicode_encoding)\n\t\treturn @iconv(\"utf-8\", $charset_html, $string);\n\telse\n\t\treturn $string;\n}\n// Cette fonction v\uff83\uff69rifie une fois par jour si le d\uff83\uff69lai de confirmation des r\uff83\uff69servations est d\uff83\uff69pass\uff83\uff69\n// Si oui, les r\uff83\uff69servations concern\uff83\uff69es sont supprim\uff83\uff69es et un mail automatique est envoy\uff83\uff69.\nfunction verify_confirm_reservation()\n{\n\tglobal $dformat;\n\t$day   = date(\"d\");\n\t$month = date(\"m\");\n\t$year  = date(\"Y\");\n\t$date_now = mktime(0,0,0,$month,$day,$year);\n\tif ((Settings::get(\"date_verify_reservation\") == \"\") || (Settings::get(\"date_verify_reservation\") < $date_now ))\n\t{\n\t\t$res = grr_sql_query(\"select id from \".TABLE_PREFIX.\"_room where delais_option_reservation > 0\");\n\t\tif (!$res)\n\t\t{\n\t\t\t//fatal_error(0, grr_sql_error());\n\t\t\tinclude \"trailer.inc.php\";\n\t\t\texit;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\t$res2 = grr_sql_query(\"select id from \".TABLE_PREFIX.\"_entry where option_reservation < '\".$date_now.\"' and option_reservation != '-1' and room_id='\".$row[0].\"'\");\n\t\t\t\tif (!$res2)\n\t\t\t\t{\n\t\t\t\t\t//fatal_error(0, grr_sql_error());\n\t\t\t\t\tinclude \"trailer.inc.php\";\n\t\t\t\t\texit;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (Settings::get(\"automatic_mail\") == 'yes')\n\t\t\t\t\t\t\t$_SESSION['session_message_error'] = send_mail($row2[0],4,$dformat);\n\t\t\t\t\t\t// On efface la r\uff83\uff69servation\n\t\t\t\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_entry WHERE id=\" . $row2[0]);\n\t\t\t\t\t\t// On efface le cas \uff83\uff69cheant \uff83\uff69galement  dans \".TABLE_PREFIX.\"_entry_moderate\n\t\t\t\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_entry_moderate WHERE id=\" . $row2[0]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!Settings::set(\"date_verify_reservation\", $date_now))\n\t\t{\n\t\t\techo \"Erreur lors de l'enregistrement de date_verify_reservation !<br />\";\n\t\t\tdie();\n\t\t}\n\t}\n}\n// Cette fonction v\uff83\uff69rifie une fois par jour si les r\uff83\uff69servations devant \uff83\uff6atre rendus ne sont pas\n// en retard\n// Si oui, les utilisateurs concern\uff83\uff69es recoivent un mail automatique pour leur notifier.\nfunction verify_retard_reservation()\n{\n\tglobal $dformat;\n\t$day   = date(\"d\");\n\t$month = date(\"m\");\n\t$year  = date(\"Y\");\n\t$date_now = mktime(0, 0, 0, $month, $day, $year);\n\tif (((Settings::get(\"date_verify_reservation2\") == \"\") || (Settings::get(\"date_verify_reservation2\") < $date_now )) && (Settings::get(\"automatic_mail\") == 'yes'))\n\t{\n\t\t$res = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_room\");\n\t\tif (! $res)\n\t\t{\n\t\t\tinclude \"trailer.inc.php\";\n\t\t\texit;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\t$res2 = grr_sql_query(\"SELECT id from \".TABLE_PREFIX.\"_entry WHERE statut_entry='e' AND end_time < '\".$date_now.\"' AND room_id='\".$row[0].\"'\");\n\t\t\t\tif (!$res2)\n\t\t\t\t{\n\t\t\t\t\tinclude \"trailer.inc.php\";\n\t\t\t\t\texit;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t\t\t$_SESSION['session_message_error'] = send_mail($row2[0], 7, $dformat);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!Settings::set(\"date_verify_reservation2\", $date_now))\n\t\t{\n\t\t\techo \"Erreur lors de l'enregistrement de date_verify_reservation2 !<br />\";\n\t\t\tdie();\n\t\t}\n\t}\n}\n/*\n* @param integer $delai : nombre de jours de r\uff83\uff69tention des logs de connexion\n* nettoieLogConnexion efface les entr\uff83\uff69es de la table _log ant\uff83\uff69rieures au jour courant moins le d\uff83\uff69lai\n*/\nfunction nettoieLogConnexion($delai){\n    // est-ce un administrateur ?\n    if (authGetUserLevel(getUserName(), -1) >= 6){\n        $dateMax = new DateTime('NOW');\n        $dateMax->sub(new DateInterval('P'.$delai.'D'));\n        $dateMax = $dateMax->format('Y-m-d H:i:s');\n        $sql = \"DELETE FROM \".TABLE_PREFIX.\"_log WHERE START < '\" . $dateMax . \"';\";\n        grr_sql_query($sql);\n    }\n}\n/**\n * @param integer $time\n */\nfunction est_hors_reservation($time,$area=\"-1\")\n{\n\t// Premier test : s'agit-il d'un jour du calendrier \"hors r\uff83\uff69servation\" ?\n\t$test = grr_sql_query1(\"SELECT DAY FROM \".TABLE_PREFIX.\"_calendar where DAY = '\".$time.\"'\");\n\tif ($test != -1)\n\t\treturn true;\n\t// 2\uff83\uff68me test : s'agit-il d'une journ\uff83\uff69e qui n'est pas affich\uff83\uff69e pour le domaine consid\uff83\uff69r\uff83\uff69 ?\n\tif ($area!=-1)\n\t{\n\t\t$sql = \"SELECT display_days FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($area).\"'\";\n\t\t$result = grr_sql_query1($sql);\n\t\t$jour_semaine = date(\"w\",$time);\n\t\tif (substr($result,$jour_semaine,1) == 'n')\n\t\t\treturn true;\n\t}\n\treturn false;\n}\nfunction resa_est_hors_reservation($start_time,$end_time)\n{\n\t// On teste si la r\uff83\uff69servation est dans le calendrier \"hors r\uff83\uff69servations\"\n\t$test = grr_sql_query1(\"select DAY from \".TABLE_PREFIX.\"_calendar where DAY = '\".$start_time.\"' or DAY = '\".$end_time.\"'\");\n\tif ($test != -1)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\nfunction resa_est_hors_reservation2($start_time,$end_time,$area)\n{\n\t// S'agit-il d'une journ\uff83\uff69e qui n'est pas affich\uff83\uff69e pour le domaine consid\uff83\uff69r\uff83\uff69 ?\n\t$sql = \"SELECT display_days FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($area).\"'\";\n\t$result = grr_sql_query1($sql);\n\t$jour_semaine = date(\"w\",$start_time);\n\tif (substr($result, $jour_semaine, 1) == 'n')\n\t\treturn true;\n\t$jour_semaine = date(\"w\",$end_time);\n\tif (substr($result, $jour_semaine, 1) == 'n')\n\t\treturn true;\n\treturn false;\n}\n// trouve les utilisateurs gestionnaires de ressource\nfunction find_user_room ($id_room)\n{\n\t$emails = array ();\n\t$sql = \"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_user_room\n\twhere \".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_user_room.login and id_room='\".$id_room.\"'\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (validate_email($row[0]))\n\t\t\t\t$emails[] = $row[0];\n\t\t}\n\t}\n\t// Si la table des emails des gestionnaires de la ressource est vide, on avertit les administrateurs du domaine\n\tif (count($emails) == 0)\n\t{\n\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_area\n\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_area.login and \".TABLE_PREFIX.\"_j_useradmin_area.id_area='\".$id_area.\"'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs du domaines est vide, on avertit les administrateurs des sites\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\t\tif (count($emails) == 0)\n\t\t{\n\t\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t\t$id_site = mrbsGetAreaSite($id_area);\n\t\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_site\n\t\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_site.login and \".TABLE_PREFIX.\"_j_useradmin_site.id_site='\".$id_site.\"'\");\n\t\t\tif ($sql_admin)\n\t\t\t{\n\t\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t\t{\n\t\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t\t$emails[] = $row[0];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs des sites est vide, on avertit les administrateurs g\uff83\uff69n\uff83\uff69raux\n\tif (count($emails) == 0)\n\t{\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs where statut = 'administrateur'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\treturn $emails;\n}\n// trouve les utilisateurs actifs gestionnaires de ressource\nfunction find_active_user_room ($id_room)\n{\n\t$emails = array ();\n\t$sql = \"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_user_room\n\twhere \".TABLE_PREFIX.\"_utilisateurs.etat = 'actif' AND \n\t\".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_user_room.login and \n\tid_room='\".$id_room.\"'\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (validate_email($row[0]))\n\t\t\t\t$emails[] = $row[0];\n\t\t}\n\t}\n\t// Si la table des emails des gestionnaires de la ressource est vide, on avertit les administrateurs du domaine\n\tif (count($emails) == 0)\n\t{\n\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_area\n\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.etat = 'actif' AND\n\t\t\t\".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_area.login and \".TABLE_PREFIX.\"_j_useradmin_area.id_area='\".$id_area.\"'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs du domaines est vide, on avertit les administrateurs des sites\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\t\tif (count($emails) == 0)\n\t\t{\n\t\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t\t$id_site = mrbsGetAreaSite($id_area);\n\t\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_site\n\t\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.etat = 'actif' AND\n\t\t\t\t\".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_site.login and \".TABLE_PREFIX.\"_j_useradmin_site.id_site='\".$id_site.\"'\");\n\t\t\tif ($sql_admin)\n\t\t\t{\n\t\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t\t{\n\t\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t\t$emails[] = $row[0];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs des sites est vide, on avertit les administrateurs g\uff83\uff69n\uff83\uff69raux\n\tif (count($emails) == 0)\n\t{\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs where etat = 'actif' AND statut = 'administrateur'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\treturn $emails;\n}\n/** validate_email ($email)\n * D\uff83\uff69termine si l'adresse mail en param\uff83\uff68tre est syntaxiquement valable\n * Rend un bool\uff83\uff69en\n*/\nfunction validate_email ($email)\n{\n\t$atom   = '[-a-z0-9!#$%&\\'*+\\\\/=?^_`{|}~]';\n\t\t// caract\uff83\uff68res autoris\uff83\uff69s avant l'arobase\n\t$domain = '([a-z0-9]([-a-z0-9]*[a-z0-9]+)?)';\n\t\t// caract\uff83\uff68res autoris\uff83\uff69s apr\uff83\uff68s l'arobase (nom de domaine)\n\t$regex = '/^' . $atom . '+' . '(\\.' . $atom . '+)*' . '@' . '(' . $domain . '{1,63}\\.)+' . $domain . '{2,63}$/i';\n\tif (preg_match($regex, $email))\n\t\treturn true;\n\telse {\n        $regex2 = '/^' . $atom . '+' . '(\\.' . $atom . '+)*' . '@' . 'localhost/i';\n        return preg_match($regex2, $email);\n    }\n}\n/** grrDelOverloadFromEntries()\n * Supprime les donn\uff83\uff69es du champ $id_field de toutes les r\uff83\uff69servations\n */\nfunction grrDelOverloadFromEntries($id_field)\n{\n\t$begin_string = \"<\".$id_field.\">\";\n\t$end_string = \"</\".$id_field.\">\";\n\t// On cherche \uff83\uf8f0 quel domaine est rattach\uff83\uff69 le champ additionnel\n\t$id_area = grr_sql_query1(\"SELECT id_area FROM \".TABLE_PREFIX.\"_overload WHERE id='\".$id_field.\"'\");\n\tif ($id_area == -1)\n\t\tfatal_error(0, get_vocab('error_area') . $id_field . get_vocab('not_found'));\n\t// On cherche toutes les ressources du domaine\n\t$call_rooms = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_room WHERE area_id = '\".$id_area.\"'\");\n\tif (!$call_rooms)\n\t\tfatal_error(0, get_vocab('error_room') . $id_area . get_vocab('not_found'));\n\tfor ($i = 0; ($row = grr_sql_row($call_rooms, $i)); $i++)\n\t{\n\t\t// On cherche toutes les resas de cette resources\n\t\t$call_resa = grr_sql_query(\"SELECT id, overload_desc FROM \".TABLE_PREFIX.\"_entry WHERE room_id ='\".$row[0].\"'\");\n\t\tif (! $call_resa)\n\t\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t\tfor ($j = 0; ($row2 = grr_sql_row($call_resa, $j)); $j++)\n\t\t{\n\t\t\t$overload_desc = $row2[1];\n\t\t\t$begin_pos = strpos($overload_desc,$begin_string);\n\t\t\t$end_pos = strpos($overload_desc,$end_string);\n\t\t\tif ( $begin_pos !== false && $end_pos !== false )\n\t\t\t{\n\t\t\t\t$endpos = $end_pos + 1 + strlen($begin_string);\n\t\t\t\t$debut_new_chaine = substr($overload_desc,0,$begin_pos);\n\t\t\t\t$fin_new_chaine = substr($overload_desc,$endpos);\n\t\t\t\t$new_chaine = $debut_new_chaine.$fin_new_chaine;\n\t\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_entry SET overload_desc = '\".$new_chaine.\"' WHERE id = '\".$row2[0].\"'\");\n\t\t\t}\n\t\t}\n\t\t// On cherche toutes les resas de cette ressource\n\t\t$call_resa = grr_sql_query(\"SELECT id, overload_desc FROM \".TABLE_PREFIX.\"_repeat WHERE room_id ='\".$row[0].\"'\");\n\t\tif (!$call_resa)\n\t\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t\tfor ($j = 0; ($row2 = grr_sql_row($call_resa, $j)); $j++)\n\t\t{\n\t\t\t$overload_desc = $row2[1];\n\t\t\t$begin_pos = strpos($overload_desc,$begin_string);\n\t\t\t$end_pos = strpos($overload_desc,$end_string);\n\t\t\tif ($begin_pos !== false && $end_pos !== false)\n\t\t\t{\n\t\t\t\t$endpos = $end_pos + 1 + strlen($begin_string);\n\t\t\t\t$debut_new_chaine = substr($overload_desc,0,$begin_pos);\n\t\t\t\t$fin_new_chaine = substr($overload_desc,$endpos);\n\t\t\t\t$new_chaine = $debut_new_chaine.$fin_new_chaine;\n\t\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_repeat SET overload_desc = '\".$new_chaine.\"' WHERE id = '\".$row2[0].\"'\");\n\t\t\t}\n\t\t}\n\t}\n}\nfunction traite_grr_url($grr_script_name = \"\", $force_use_grr_url = \"n\")\n{\n\t// Dans certaines configuration (reverse proxy, ...) les variables $_SERVER[\"SCRIPT_NAME\"] ou $_SERVER['PHP_SELF']\n\t// sont mal interpr\uff83\uff69t\uff83\uff69es entra\uff83\uff6enant des liens erron\uff83\uff69s sur certaines pages.\n\tif (((Settings::get(\"use_grr_url\") == \"y\") && (Settings::get(\"grr_url\") != \"\")) || ($force_use_grr_url == \"y\"))\n\t{\n\t\tif (substr(Settings::get(\"grr_url\"), -1) != \"/\")\n\t\t\t$ad_signe = \"/\";\n\t\telse\n\t\t\t$ad_signe = \"\";\n\t\treturn Settings::get(\"grr_url\").$ad_signe.$grr_script_name;\n\t}\n\telse\n\t\treturn $_SERVER['PHP_SELF'];\n}\n// Pour les Jours/Cycles\n//Cr\uff83\uff69e le calendrier Jours/Cycles\nfunction cree_calendrier_date_valide($n, $i)\n{\n\tif ($i <= Settings::get(\"nombre_jours_Jours/Cycles\"))\n\t{\n\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_calendrier_jours_cycle SET DAY='\".$n.\"', Jours = $i\";\n\t\tif (grr_sql_command($sql) < 0)\n\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t$i++;\n\t}\n\telse\n\t{\n\t\t$i = 1;\n\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_calendrier_jours_cycle set DAY='\".$n.\"', Jours = $i\";\n\t\tif (grr_sql_command($sql) < 0)\n\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t$i++;\n\t}\n\treturn $i;\n}\n/*\nConstruit les informations \uff83\uf8f0 afficher sur les plannings\n*/\nfunction affichage_lien_resa_planning($breve_description, $id_resa)\n{\n\tif ((Settings::get(\"display_short_description\") == 1) && ($breve_description != \"\"))\n\t\t$affichage = $breve_description;\n\telse\n\t\t$affichage = get_vocab(\"entryid\").$id_resa;\n\treturn bbCode(htmlspecialchars($affichage,ENT_NOQUOTES),'titre');\n}\n/*\nConstruit les informations \uff83\uf8f0 afficher sur les plannings\n*/\nfunction affichage_resa_planning($_description, $id_resa)\n{\n\t$affichage = \"\";\n\tif (Settings::get(\"display_full_description\") == 1)\n\t\t$affichage = htmlspecialchars($_description,ENT_NOQUOTES);\n    // la ressource associ\uff83\uff69e \uff83\uf8f0 la r\uff83\uff69servation :\n    $res = mrbsGetEntryInfo($id_resa);\n    $room = (!$res) ? -1 : $res[\"room_id\"]; \n\t// Les champs add :\n\t$overload_data = mrbsEntryGetOverloadDesc($id_resa);\n\tforeach ($overload_data as $fieldname=>$field)\n\t{\n\t\tif (((authGetUserLevel(getUserName(), $room) >= 4) ||($field[\"affichage\"] == 'y')) and ($field[\"valeur\"]!=\"\"))\n\t\t{\n\t\t\tif ($affichage != \"\")\n\t\t\t\t$affichage .= \"<br />\";\n\t\t\t$affichage .= htmlspecialchars($fieldname,ENT_NOQUOTES).get_vocab(\"deux_points\").htmlspecialchars($field[\"valeur\"],ENT_NOQUOTES|ENT_SUBSTITUTE);\n\t\t}\n\t}\n\treturn $affichage;\n}\n/*\nConstruit les informations \uff83\uf8f0 afficher sur les plannings\n*/\nfunction affichage_champ_add_mails($id_resa)\n{\n\t$affichage = \"\";\n\t// Les champs add :\n\t$overload_data = mrbsEntryGetOverloadDesc($id_resa);\n\tforeach ($overload_data as $fieldname=>$field)\n\t{\n\t\tif (($field[\"overload_mail\"] == 'y') && ($field[\"valeur\"] != \"\"))\n\t\t\t$affichage .= bbcode(htmlspecialchars($fieldname).get_vocab(\"deux_points\").htmlspecialchars($field[\"valeur\"]),'nobbcode').\"\\n\";;\n\t}\n\treturn $affichage;\n}\n/*\nAffiche un message pop-up\n$type_affichage = \"user\" -> Affichage des \"pop-up\" de confirmation apr\uff83\uff68s la cr\uff83\uff69ation/modification/suppression d'une r\uff83\uff69servation\nDans ce cas, l'affichage n'a lieu que si $_SESSION['displ_msg']='yes'\n$type_affichage = \"admin\" -> Affichage des \"pop-up\" de confirmation dans les menus d'administration\n$type_affichage = \"force\" -> On force l'affichage du pop-up m\uff83\uff6ame si javascript_info_admin_disabled est true\n*/\nfunction affiche_pop_up($msg = \"\",$type_affichage = \"user\")\n{\n\t// Si $_SESSION[\"msg_a_afficher\"] est d\uff83\uff69fini, on l'affiche, sinon, on affiche $msg pass\uff83\uff69 en variable\n\tif ((isset($_SESSION[\"msg_a_afficher\"])) and ($_SESSION[\"msg_a_afficher\"] != \"\"))\n\t\t$msg = $_SESSION[\"msg_a_afficher\"];\n\tif ($msg != \"\")\n\t{\n\t\tif ($type_affichage == \"user\")\n\t\t{\n\t\t\tif (!(Settings::get(\"javascript_info_disabled\")))\n\t\t\t{\n\t\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\t\tif ((isset($_SESSION['displ_msg'])) && ($_SESSION['displ_msg'] == 'yes'))\n\t\t\t\t\techo \" alert(\\\"\".$msg.\"\\\")\";\n\t\t\t\techo \"</script>\";\n\t\t\t}\n\t\t}\n\t\telse if ($type_affichage == \"admin\")\n\t\t{\n\t\t\tif (!(Settings::get(\"javascript_info_admin_disabled\")))\n\t\t\t{\n\t\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\t\techo \"<!--\\n\";\n\t\t\t\techo \" alert(\\\"\".$msg.\"\\\")\";\n\t\t\t\techo \"//-->\";\n\t\t\t\techo \"</script>\";\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\techo \"<!--\\n\";\n\t\t\techo \" alert(\\\"\".$msg.\"\\\")\";\n\t\t\techo \"//-->\";\n\t\t\techo \"</script>\";\n\t\t}\n\t}\n\t$_SESSION['displ_msg'] = \"\";\n\t$_SESSION[\"msg_a_afficher\"] = \"\";\n}\n/*\nRetourne un tableau contenant les nom et pr\uff83\uff69nom et l'email de $_beneficiaire\n*/\nfunction donne_nom_email($_beneficiaire)\n{\n\t$tab_benef = array();\n\t$tab_benef[\"nom\"] = \"\";\n\t$tab_benef[\"email\"] = \"\";\n\tif ($_beneficiaire == \"\")\n\t\treturn $tab_benef;\n\t$temp = explode(\"|\",$_beneficiaire);\n\tif (isset($temp[0]))\n\t\t$tab_benef[\"nom\"] = $temp[0];\n\tif (isset($temp[1]))\n\t\t$tab_benef[\"email\"] = $temp[1];\n\treturn $tab_benef;\n}\n/*\nRetourne une chaine concat\uff83\uff69n\uff83\uff69e des nom et pr\uff83\uff69nom et l'email\n*/\nfunction concat_nom_email($_nom, $_email)\n{\n\t// On supprime les caract\uff83\uff68res | de $_nom\n\t$_nom = trim(str_replace(\"|\",\"\",$_nom));\n\tif ($_nom == \"\")\n\t\treturn \"-1\";\n\t$_email = trim($_email);\n\tif ($_email != \"\")\n\t{\n\t\tif (strstr($_email,\"|\"))\n\t\t\treturn \"-2\";\n\t}\n\t$chaine = $_nom.\"|\".$_email;\n\treturn $chaine;\n}\n/*\nFormate les noms, pr\uff83\uff69nom et email du b\uff83\uff69n\uff83\uff69ficiaire ou du b\uff83\uff69n\uff83\uff69ficiaire ext\uff83\uff69rieur\n$type = nomail -> on affiche les pr\uff83\uff69nom et nom sans le mail.\n$type = withmail -> on affiche un lien avec le mail sur les pr\uff83\uff69nom et nom.\n$type = formail -> on formate en utf8 pour l'envoi par mail (utilis\uff83\uff69 dans l'envoi de mails automatiques)\n$type = onlymail -> on affiche uniquement le mail (utilis\uff83\uff69 dans l'envoi de mails automatiques)\n*/\n/**\n * @return string\n */\nfunction affiche_nom_prenom_email($_beneficiaire, $_beneficiaire_ext, $type = \"nomail\")\n{\n\tif ($_beneficiaire != \"\")\n\t{\n\t\t$sql_beneficiaire = \"SELECT prenom, nom, email FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".$_beneficiaire.\"'\";\n\t\t$res_beneficiaire = grr_sql_query($sql_beneficiaire);\n\t\tif ($res_beneficiaire)\n\t\t{\n\t\t\t$nb_result = grr_sql_count($res_beneficiaire);\n\t\t\tif ($nb_result == 0){\n\t\t\t\t$chaine = get_vocab(\"utilisateur_inconnu\").$_beneficiaire;\n\t\t\t} else\n\t\t\t{\n\t\t\t\t$row_user = grr_sql_row($res_beneficiaire, 0);\n\t\t\t\tif ($type == \"formail\")\n\t\t\t\t{\n\t\t\t\t\t$chaine = removeMailUnicode($row_user[0]).\" \".removeMailUnicode($row_user[1]);\n\t\t\t\t\tif ($row_user[2] != \"\")\n\t\t\t\t\t\t$chaine .= \" (\".$row_user[2].\")\";\n\t\t\t\t}\n\t\t\t\telse if ($type == \"onlymail\")\n\t\t\t\t{\n\t\t\t\t\t// Cas o\uff83\uff79 en envoie uniquement le mail\n\t\t\t\t\t$chaine = grr_sql_query1(\"select email from \".TABLE_PREFIX.\"_utilisateurs where login='$_beneficiaire'\");\n\t\t\t\t}\n\t\t\t\telse if (($type == \"withmail\") and ($row_user[2] != \"\"))\n\t\t\t\t{\n\t\t\t\t\t// Cas o\uff83\uff79 en envoie les noms, pr\uff83\uff69noms et mail\n\t\t\t\t\t$chaine = affiche_lien_contact($_beneficiaire,\"identifiant:oui\",\"afficher_toujours\");\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// Cas o\uff83\uff79 en envoie les noms, pr\uff83\uff69noms sans le mail\n\t\t\t\t\t$chaine = $row_user[0].\" \".$row_user[1];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn $chaine;\n\t\t}\n\t\telse\n\t\t\treturn \"\";\n\t}\n\telse\n\t{\n\t\t// cas d'un b\uff83\uff69n\uff83\uff69ficiaire ext\uff83\uff69rieur\n\t\t// On r\uff83\uff69cup\uff83\uff68re le tableau des nom et emails\n\t\t$tab_benef = donne_nom_email($_beneficiaire_ext);\n\t\t// Cas o\uff83\uff79 en envoie uniquement le mail\n\t\tif ($type == \"onlymail\")\n\t\t{\n\t\t\t$chaine = $tab_benef[\"email\"];\n\t\t\t// Cas o\uff83\uff79 en envoie les noms, pr\uff83\uff69noms et mail\n\t\t}\n\t\telse if (($type == \"withmail\") && ($tab_benef[\"email\"] != \"\"))\n\t\t{\n\t\t\t$email = explode('@',$tab_benef[\"email\"]);\n\t\t\t$person = $email[0];\n\t\t\tif (isset($email[1]))\n\t\t\t{\n\t\t\t\t$domain = $email[1];\n\t\t\t\t$chaine = \"<script type=\\\"text/javascript\\\">encode_adresse('\".$person.\"','\".$domain.\"','\".AddSlashes($tab_benef[\"nom\"]).\"',1);</script>\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$chaine = $tab_benef[\"nom\"];\n\t\t}\n\t\telse\n\t\t{\n\t\t// Cas o\uff83\uff79 en envoie les noms, pr\uff83\uff69noms sans le mail\n\t\t\t$chaine = $tab_benef[\"nom\"];\n\t\t}\n\t\treturn $chaine;\n\t}\n}\n/*\n Fonction permettant d'effectuer une correspondance entre\n le profil lu sous LDAP et les statuts existants dans GRR\n*/\n function effectuer_correspondance_profil_statut($codefonction, $libellefonction) {\n\t\t# On r\uff83\uff69cup\uff83\uff68re le statut par d\uff83\uff69faut des utilisateurs CAS\n \t$sso = Settings::get(\"sso_statut\");\n \tif ($sso == \"cas_visiteur\")\n \t\t$_statut = \"visiteur\";\n \telse if ($sso == \"cas_utilisateur\")\n \t\t$_statut = \"utilisateur\";\n\t\t# Le code fonction est d\uff83\uff69fini\n \tif ($codefonction != \"\")\n \t{\n \t\t$sql = grr_sql_query1(\"SELECT statut_grr from \".TABLE_PREFIX.\"_correspondance_statut where code_fonction='\".$codefonction.\"'\");\n \t\tif ($sql != -1)\n \t\t{\n\t\t\t// Si la fonction existe dans la table de correspondance, on retourne le statut_grr associ\uff83\uff69\n \t\t\treturn $sql;\n \t\t}\n \t\telse\n \t\t{\n\t\t\t// Le code n'existe pas dans la base, alors on l'ins\uff83\uff68re en lui attribuant le statut par d\uff83\uff69faut.\n \t\t\t$libellefonction = protect_data_sql($libellefonction);\n \t\t\tgrr_sql_command(\"INSERT INTO grr_correspondance_statut(code_fonction,libelle_fonction,statut_grr) VALUES ('$codefonction', '$libellefonction', '$_statut')\");\n \t\t\treturn $_statut;\n \t\t}\n\t\t//Le code fonction n'est pas d\uff83\uff69fini, alors on retourne le statut par d\uff83\uff69faut.\n \t}\n \telse\n \t\treturn $_statut;\n }\n\n\tfunction jQuery_DatePicker($typeDate){\n\n\t\tif (@file_exists('../include/connect.inc.php')){\n\t\t\t$racine = \"../\";\n\t\t} else{\n\t\t\t$racine = \"./\";\n\t\t}\n\n\t\tif ($typeDate == 'rep_end' && isset($_GET['id'])){\n\t\t\t$res = grr_sql_query(\"SELECT repeat_id FROM \".TABLE_PREFIX.\"_entry WHERE id=\".$_GET['id'].\";\");\n\t\t\tif (!$res){\n\t\t\t\tfatal_error(0, grr_sql_error());\n\t\t\t}\n\t\t\t$repeat_id = implode('', grr_sql_row($res, 0));\n\t\t\t$res = grr_sql_query(\"SELECT rep_type, end_date, rep_opt, rep_num_weeks, start_time, end_time FROM \".TABLE_PREFIX.\"_repeat WHERE id=$repeat_id\");\n\t\t\tif (!$res){\n\t\t\t\tfatal_error(0, grr_sql_error());\n\t\t\t}\n\t\t\tif (grr_sql_count($res) == 1){\n\t\t\t\t$row6 = grr_sql_row($res, 0);\n\t\t\t\t$date = date_parse(date(\"Y-m-d H:i:s\",$row6[1]));\n\t\t\t\t$day = $date['day'];\n\t\t\t\t$month = $date['month'];\n\t\t\t\t$year = $date['year'];\n\t\t\t} else{\n\t\t\t\tif (isset ($_GET['day']))\n\t\t\t\t\t$day = $_GET['day'];\n\t\t\t\telse\n\t\t\t\t\t$day = date(\"d\");\n\t\t\t\tif (isset ($_GET['month']))\n\t\t\t\t\t$month = $_GET['month'];\n\t\t\t\telse\n\t\t\t\t\t$month = date(\"m\");\n\t\t\t\tif (isset ($_GET['year']))\n\t\t\t\t\t$year = $_GET['year'];\n\t\t\t\telse\n\t\t\t\t\t$year = date(\"Y\");\n\t\t\t}\n\t\t} else{\n\t\t\tglobal $start_day, $start_month, $start_year, $end_day, $end_month, $end_year;\n\n\t\t\tif (isset ($_GET['day'])){\n\t\t\t\t$day = $_GET['day'];\n\t\t\t} else{\n\t\t\t\t$day = date(\"d\");\n\t\t\t}\n\n\t\t\tif (isset($start_day) && $typeDate=='start'){\n\t\t\t\t$day = $start_day;\n\t\t\t} elseif (isset($end_day) && $typeDate=='end'){\n\t\t\t\t$day = $end_day;\n\t\t\t}\n\n\t\t\tif (isset ($_GET['month'])){\n\t\t\t\t$month = $_GET['month'];\n\t\t\t} else{\n\t\t\t\t$month = date(\"m\");\n\t\t\t}\n\n\t\t\tif (isset($start_month) && $typeDate=='start'){\n\t\t\t\t$month = $start_month;\n\t\t\t} elseif (isset($end_month) && $typeDate=='end'){\n\t\t\t\t$month = $end_month;\n\t\t\t}\n\n\t\t\tif(isset ($_GET['year'])){\n\t\t\t\t$year = $_GET['year'];\n\t\t\t} else{\n\t\t\t\t$year = date(\"Y\");\n\t\t\t}\n\n\t\t\tif (isset($start_year) && $typeDate=='start'){\n\t\t\t\t$year = $start_year;\n\t\t\t} elseif (isset($end_year) && $typeDate=='end'){\n\t\t\t\t$year = $end_year;\n\t\t\t}\n \t}\n \tgenDateSelector(\"\".$typeDate.\"_\", \"$day\", \"$month\", \"$year\",\"\");\n \techo '<input type=\"hidden\" disabled=\"disabled\" id=\"mydate_' .$typeDate. '\">'.PHP_EOL;\n \techo '<script>'.PHP_EOL;\n \techo '\t$(function() {'.PHP_EOL;\n \t\techo '$.datepicker.setDefaults( $.datepicker.regional[\\'fr\\'] );'.PHP_EOL;\n \t\techo '\t$(\\'#mydate_' .$typeDate. '\\').datepicker({'.PHP_EOL;\n \t\t\techo '\t\tbeforeShow: readSelected, onSelect: updateSelected,'.PHP_EOL;\n \t\t\techo '\t\tshowOn: \\'both\\', buttonImageOnly: true, buttonImage: \\'img_grr/calendar.png\\',buttonText: \"Choisir la date\"});'.PHP_EOL;\necho '\t\tfunction readSelected()'.PHP_EOL;\necho '\t\t{'.PHP_EOL;\necho '\t\t\t$(\\'#mydate_' .$typeDate. '\\').val($(\\'#' .$typeDate. '_day\\').val() + \\'/\\' +'.PHP_EOL;\n\techo '\t\t\t$(\\'#' .$typeDate. '_month\\').val() + \\'/\\' + $(\\'#' .$typeDate. '_year\\').val());'.PHP_EOL;\necho '\t\t\treturn {};'.PHP_EOL;\necho '\t\t}'.PHP_EOL;\necho '\t\tfunction updateSelected(date)'.PHP_EOL;\necho '\t\t{'.PHP_EOL;\necho '\t\t\t$(\\'#' .$typeDate. '_day\\').val(date.substring(0, 2));'.PHP_EOL;\necho '\t\t\t$(\\'#' .$typeDate. '_month\\').val(date.substring(3, 5));'.PHP_EOL;\necho '\t\t\t$(\\'#' .$typeDate. '_year\\').val(date.substring(6, 10));'.PHP_EOL;\necho '\t\t}'.PHP_EOL;\necho '\t});'.PHP_EOL;\necho '</script>'.PHP_EOL;\n}\n\nfunction jQuery_TimePicker($typeTime, $start_hour, $start_min,$dureepardefaultsec)\n{\n\tif (isset ($_GET['id']))\n\t{\n\t\tif (isset($start_hour) && isset($start_min))\n\t\t{\n\t\t\t$hour = $start_hour;\n\t\t\t$minute = $start_min;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$hour = date(\"h\");\n\t\t\t$minute = date(\"m\");\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (isset ($_GET['hour']))\n\t\t\t$hour = $_GET['hour'];\n\t\telse\n\t\t\t$hour = date(\"h\");\n\t\tif (isset ($_GET['minute']))\n\t\t\t$minute = $_GET['minute'];\n\t\telse\n\t\t\t$minute = date(\"m\");\n\t\t\t\n\t\tif ($typeTime == 'end_'){\n\t\t$dureepardefautmin = $dureepardefaultsec/60;\n\t\tif ($dureepardefautmin == 60){\n\t\t\t$ajout = 1;\n\t\t\t$hour = $_GET['hour'] + $ajout;\n\t\t\t$minute =\"00\";\n\t\t}\n\t\tif ($dureepardefautmin < 60){\n\t\t\t$hour = $_GET['hour'];\n\t\t\t$minute =$dureepardefautmin;\n\t\t}\n\t\tif ($dureepardefautmin > 60){\n            $dureepardefautheure = $dureepardefautmin/60;\n        //\tif (($dureepardefautheure % 60)!=0){\n\t//\t\t$hour = $_GET['hour']+ $dureepardefautheure;\n            $hour = ($_GET['hour']+ $dureepardefautheure)%24; // Modulo 24\n            $hour = str_pad($hour, 2, 0, STR_PAD_LEFT); // Affichage heure sur 2 digits \n\t\t\tif ($_GET['minute'] == 30){\n\t\t\t\t$minute =30;\n\t\t\t}else{\n\t\t\t\t $minute = \"00\";\n\t\t\t\t};\n\t//\t\t}\n\t\t}\n\t};\n\n\t}\n\tif ($minute == 0)\n\t\t$minute = '00';\n\t// MAJ\n\techo '<div class=\"input-group clockpicker\">\n\t<input name=\"' .$typeTime. '\" type=\"text\" class=\"form-control\" value=\"' .$hour. ':' .$minute. '\">\n\t<span class=\"input-group-addon\">\n\t\t<span class=\"glyphicon glyphicon-time\"></span>\n\t</span>\n</div>';\necho '<script type=\"text/javascript\">\n$(\\'.clockpicker\\').clockpicker({\n\talign: \\'left\\',\n\tplacement: \\'top\\',\n\tdonetext: \\'Valider\\'\n});\n</script>';\n}\nfunction jQuery_TimePicker2($typeTime, $start_hour, $start_min,$dureepardefaultsec)\n{\n\tif (isset ($_GET['id']))\n\t{\n\t\tif (isset($start_hour) && isset($start_min))\n\t\t{\n\t\t\t$hour = $start_hour;\n\t\t\t$minute = $start_min;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$hour = date(\"h\");\n\t\t\t$minute = date(\"m\");\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (isset ($_GET['hour']))\n\t\t\t$hour = $_GET['hour'];\n\t\telse\n\t\t\t$hour = date(\"h\");\n\t\tif (isset ($_GET['minute']))\n\t\t\t$minute = $_GET['minute'];\n\t\telse\n\t\t\t$minute = date(\"m\");\n\t\t\t\n\t\tif ($typeTime == 'end_')\n        {\n            $dureepardefautmin = $dureepardefaultsec/60;\n            if ($dureepardefautmin == 60){\n                $ajout = 1;\n                $hour = $_GET['hour'] + $ajout;\n                $minute =\"00\";\n            }\n            if ($dureepardefautmin < 60){\n                $hour = $_GET['hour'];\n                $minute =$dureepardefautmin;\n            }\n            if ($dureepardefautmin > 60)\n            {\n                $dureepardefautheure = $dureepardefautmin/60;\n                if (($dureepardefautheure % 60)!=0)\n                {\n                    $hour = $_GET['hour']+ $dureepardefautheure;\n                    if ($_GET['minute'] == 30){$minute =30;}\n                    else{$minute = \"00\";}\n                }\n            }\n        }\n\t}\n\tif ($minute == 0)\n\t\t$minute = '00';\n\t// MAJ\n\techo '<div class=\"input-group\">\n\t<input id=\"'.$typeTime.'\" name=\"' .$typeTime. '\" type=\"text\" class=\"time\" >\n\t</div>';\n    echo '<script type=\"text/javascript\">\n        $(\\'#'.$typeTime.'\\').timepicker({\n            \\'step\\': '.($dureepardefaultsec/60).',\n            \\'scrollDefault\\': \\''.$hour.':'.$minute.'\\',\n            \\'timeFormat\\': \"H:i\",\n            \\'forceRoundTime\\': true,\n        });\n        </script>';\n}\n\nfunction spinner ($duration)\n{\n\techo \"<input class=\\\"form-control\\\" name=\\\"duration\\\" value=\\\"\" .$duration. \"\\\" id=\\\"spinner\\\" />\";\n\techo \"<script type=\\\"text/javascript\\\" src=\\\"js/jquery.mousewheel.js\\\"></script>\";\n\techo \"<script>$(function() {\n\t\t$('#spinner').spinner({\n\t\t\tmin: 1,\n\t\t\tpage: 10,\n\t\t});});\n</script>\";\n}\n/** supprimerReservationsUtilisateursEXT()\n *\n * Supprime les r\uff83\uff69servations des membres qui proviennent d'une source \"EXT\"\n *\n *\n * Returns:\n *   0        - An error occured\n *   non-zero - The entries were deleted\n */\nfunction supprimerReservationsUtilisateursEXT($avec_resa,$avec_privileges)\n{\n\t// R\uff83\uff69cup\uff83\uff69ration de tous les utilisateurs de la source EXT\n\t$requete_users_ext = \"SELECT login FROM \".TABLE_PREFIX.\"_utilisateurs WHERE source='ext' and statut<>'administrateur'\";\n\t$res = grr_sql_query($requete_users_ext);\n\t$logins = array();\n\t$logins_liaison  = array();\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$logins[]=$row[0];\n\t\t}\n\t}\n\t// Construction des requ\uff83\uff6ates de suppression \uff83\uf8f0 partir des diff\uff83\uff69rents utilisateurs \uff83\uf8f0 supprimer\n\tif ($avec_resa == 'y')\n\t{\n\t\t// Pour chaque utilisateur, on supprime les r\uff83\uff69servations qu'il a cr\uff83\uff69\uff83\uff69es et celles dont il est b\uff83\uff69n\uff83\uff69ficiaire\n\t\t// Table grr_entry\n\t\t$req_suppr_table_entry = \"DELETE FROM \".TABLE_PREFIX.\"_entry WHERE create_by = \";\n\t\t$first = 1;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif ($first == 1)\n\t\t\t{\n\t\t\t\t$req_suppr_table_entry .= \"'$log' OR beneficiaire='$log'\";\n\t\t\t\t$first = 0;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$req_suppr_table_entry .= \" OR create_by = '$log' OR beneficiaire = '$log' \";\n\t\t}\n\t\t// Pour chaque utilisateur, on supprime les r\uff83\uff69servations p\uff83\uff69riodiques qu'il a cr\uff83\uff69\uff83\uff69es et celles dont il est b\uff83\uff69n\uff83\uff69ficiaire\n\t\t// Table grr_repeat\n\t\t$req_suppr_table_repeat = \"DELETE FROM \".TABLE_PREFIX.\"_repeat WHERE create_by = \";\n\t\t$first = 1;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif ($first == 1)\n\t\t\t{\n\t\t\t\t$req_suppr_table_repeat .= \"'$log' OR beneficiaire='$log'\";\n\t\t\t\t$first = 0;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$req_suppr_table_repeat .= \" OR create_by = '$log' OR beneficiaire = '$log' \";\n\t\t}\n\t\t// Pour chaque utilisateur, on supprime les r\uff83\uff69servations p\uff83\uff69riodiques qu'il a cr\uff83\uff69\uff83\uff69es et celles dont il est b\uff83\uff69n\uff83\uff69ficiaire\n\t\t// Table grr_entry_moderate\n\t\t$req_suppr_table_entry_moderate = \"DELETE FROM \".TABLE_PREFIX.\"_entry_moderate WHERE create_by = \";\n\t\t$first = 1;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif ($first == 1)\n\t\t\t{\n\t\t\t\t$req_suppr_table_entry_moderate .= \"'$log' OR beneficiaire='$log'\";\n\t\t\t\t$first = 0;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$req_suppr_table_entry_moderate .= \" OR create_by = '$log' OR beneficiaire = '$log' \";\n\t\t}\n\t}\n\t$req_j_mailuser_room = \"\";\n\t$req_j_user_area = \"\";\n\t$req_j_user_room = \"\";\n\t$req_j_useradmin_area = \"\";\n\t$req_j_useradmin_site = \"\";\n\tforeach ($logins as $log)\n\t{\n\t\t// Table grr_j_mailuser_room\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_mailuser_room WHERE login='\".$log.\"'\");\n\t\tif ($test >=1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_mailuser_room == \"\")\n\t\t\t\t\t$req_j_mailuser_room = \"DELETE FROM \".TABLE_PREFIX.\"_j_mailuser_room WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_mailuser_room .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_user_area\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_user_area WHERE login='\".$log.\"'\");\n\t\tif ($test >=1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_user_area == \"\")\n\t\t\t\t\t$req_j_user_area = \"DELETE FROM \".TABLE_PREFIX.\"_j_user_area WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_user_area .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_user_room\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_user_room WHERE login='\".$log.\"'\");\n\t\tif ($test >= 1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_user_room == \"\")\n\t\t\t\t\t$req_j_user_room = \"DELETE FROM \".TABLE_PREFIX.\"_j_user_room WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_user_room .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_useradmin_area\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_useradmin_area WHERE login='\".$log.\"'\");\n\t\tif ($test >= 1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_useradmin_area == \"\")\n\t\t\t\t\t$req_j_useradmin_area = \"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_area WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_useradmin_area .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_useradmin_site\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_useradmin_site WHERE login='\".$log.\"'\");\n\t\tif ($test >= 1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_useradmin_site == \"\")\n\t\t\t\t\t$req_j_useradmin_site = \"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_site WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_useradmin_site .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t}\n\t\t// Suppression effective\n\techo \"<hr />\\n\";\n\tif ($avec_resa == 'y')\n\t{\n\t\t$nb = 0;\n\t\t$s = grr_sql_command($req_suppr_table_entry);\n\t\tif ($s != -1)\n\t\t\t$nb += $s;\n\t\t$s = grr_sql_command($req_suppr_table_repeat);\n\t\tif ($s != -1)\n\t\t\t$nb += $s;\n\t\t$s = grr_sql_command($req_suppr_table_entry_moderate);\n\t\tif ($s != -1)\n\t\t\t$nb += $s;\n\t\techo \"<p class='avertissement'>\".get_vocab(\"tables_reservations\").get_vocab(\"deux_points\").$nb.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\t}\n\t$nb = 0;\n\tif ($avec_privileges == \"y\")\n\t{\n\t\tif ($req_j_mailuser_room != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_mailuser_room);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_user_area != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_user_area);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_user_room != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_user_room);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_useradmin_area != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_useradmin_area);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_useradmin_site != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_useradmin_site);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t}\n\techo \"<p class='avertissement'>\".get_vocab(\"tables_liaison\").get_vocab(\"deux_points\").$nb.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\tif ($avec_privileges == \"y\")\n\t{\n\t\t// Enfin, suppression des utilisateurs de la source EXT qui ne sont pas administrateur\n\t\t$requete_suppr_users_ext = \"DELETE FROM \".TABLE_PREFIX.\"_utilisateurs WHERE source='ext' and statut<>'administrateur'\";\n\t\t$s = grr_sql_command($requete_suppr_users_ext);\n\t\tif ($s == -1)\n\t\t\t$s = 0;\n\t\techo \"<p class='avertissement'>\".get_vocab(\"table_utilisateurs\").get_vocab(\"deux_points\").$s.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\t}\n\telse\n\t{\n\t\t$n = 0;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif (!in_array(strtolower($log), $logins_liaison))\n\t\t\t{\n\t\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='\".$log.\"'\");\n\t\t\t\t$n++;\n\t\t\t}\n\t\t}\n\t\techo \"<p class='avertissement'>\".get_vocab(\"table_utilisateurs\").get_vocab(\"deux_points\").$n.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\t}\n}\n/** NettoyerTablesJointure()\n *\n * Supprime les lignes inutiles dans les tables de liaison\n *\n */\nfunction NettoyerTablesJointure()\n{\n\t$nb = 0;\n\t// Table grr_j_mailuser_room\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_mailuser_room j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"delete from \".TABLE_PREFIX.\"_j_mailuser_room where login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_user_area\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_user_area j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"delete from \".TABLE_PREFIX.\"_j_user_area where login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_user_room\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_user_room j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_j_user_room WHERE login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_useradmin_area\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_useradmin_area j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_area WHERE login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_useradmin_site\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_useradmin_site j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_site WHERE login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Suppression effective\n\techo \"<hr />\\n\";\n\techo \"<p class='avertissement'>\".get_vocab(\"tables_liaison\").get_vocab(\"deux_points\").$nb.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n}\nif (!function_exists('htmlspecialchars_decode'))\n{\n\tfunction htmlspecialchars_decode($text)\n\t{\n\t\treturn strtr($text, array_flip(get_html_translation_table(HTML_SPECIALCHARS)));\n\t}\n}\n// suggestions pour reformuler les pages plannings\nfunction pageHead2($title, $page = \"with_session\") \n{\n\tif ($page == \"with_session\")\n\t{\n\t\tif (isset($_SESSION['default_style']))\n\t\t\t$sheetcss = 'themes/'.$_SESSION['default_style'].'/css';\n\n\t\telse {\n            if (Settings::get(\"default_css\"))\n\t\t\t$sheetcss = 'themes/'.Settings::get(\"default_css\").'/css'; // th\uff83\uff68me global par d\uff83\uff69faut\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css'; // utilise le th\uff83\uff68me par d\uff83\uff69faut s'il n'a pas \uff83\uff69t\uff83\uff69 d\uff83\uff69fini\n        }\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (Settings::get(\"default_css\"))\n\t\t\t$sheetcss = 'themes/'.Settings::get(\"default_css\").'/css';\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css';\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\tglobal $vocab, $charset_html, $unicode_encoding, $clock_file, $use_select2, $use_admin;\n\theader('Content-Type: text/html; charset=utf-8');\n\tif (!isset($_COOKIE['open']))\n\t{\n\t\tsetcookie(\"open\", \"true\", time()+3600);\n\t}\n    // code de la partie <head> \n\t$a  = '<head>'.PHP_EOL;\n\t$a .= '<meta charset=\"utf-8\">'.PHP_EOL;\n\t$a .= '<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">'.PHP_EOL;\n\t$a .= '<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">'.PHP_EOL;\n\t$a .= '<meta name=\"Robots\" content=\"noindex\" />'.PHP_EOL;\n\t$a .= '<title>'.$title.'</title>'.PHP_EOL;\n\n\tif (@file_exists('admin_accueil.php') || @file_exists('install_mysql.php')){ // Si on est dans l'administration ou en initialisation\n\n        $a .= '<link rel=\"shortcut icon\" href=\"../favicon.ico\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../include/admin_grr.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/default/css/style.css\" />'.PHP_EOL; // le style par d\uff83\uff69faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\uff83\uff69\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/default/css/types.css\" />'.PHP_EOL; // les couleurs des types de r\uff83\uff69servation\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/html2canvas.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/menu.js\"></script>'.PHP_EOL;        \n        $a .= '<script type=\"text/javascript\" src=\"../js/jquery.floatThead.min.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"../js/planning2Thead.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/functions.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"../js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/'.$clock_file.'\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"../js/jscolor.js\"></script>';\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n\t} \n    else {\n        $a .= '<link rel=\"shortcut icon\" href=\"./favicon.ico\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t    if (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n\t\t}\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/default/css/style.css\" />'.PHP_EOL; // le style par d\uff83\uff69faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\uff83\uff69\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/default/css/types.css\" />'.PHP_EOL; // les couleurs des types de r\uff83\uff69servation        \n\t\tif (isset($use_admin))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"include/admin_grr.css\" />'.PHP_EOL;\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/html2canvas.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"js/jquery.floatThead.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/menu.js\"></script>'.PHP_EOL;     \n        $a .= '<script type=\"text/javascript\" src=\"js/planning2Thead.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/functions.js\" ></script>'.PHP_EOL;\n\t\tif (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\t}\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"./js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/'.$clock_file.'\"></script>'.PHP_EOL;\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n\t}\n\n\t$a .= '</head>'.PHP_EOL;\n\treturn $a;\n}\n\n/*\n** Fonction qui affiche le header\n*/\nfunction pageHeader2($day = '', $month = '', $year = '', $type_session = 'with_session', $adm=0)\n{\n\tglobal $vocab, $search_str, $grrSettings, $clock_file, $desactive_VerifNomPrenomUser, $grr_script_name, $racine, $racineAd;\n\tglobal $use_prototype, $use_admin, $use_tooltip_js, $desactive_bandeau_sup, $id_site, $use_select2;\n        $parametres_url = htmlspecialchars($_SERVER['QUERY_STRING']).\"&amp;\";\n        \n\tHook::Appel(\"hookHeader2\");\n\t// Si nous ne sommes pas dans un format imprimable\n\tif ((!isset($_GET['pview'])) || ($_GET['pview'] != 1))\n\t{\n\t\t// If we dont know the right date then make it up\n\t\tif (!isset($day) || !isset($month) || !isset($year) || ($day == '') || ($month == '') || ($year == ''))\n\t\t{\n\t\t\t$date_now = time();\n\t\t\tif ($date_now < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_now > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\telse\n\t\t\t\t$date_ = $date_now;\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t}\n\t\tif (!(isset($search_str)))\n\t\t\t$search_str = get_vocab(\"search_for\");\n\t\tif (empty($search_str))\n\t\t\t$search_str = \"\";\n\t\tif (!(isset($desactive_bandeau_sup) && ($desactive_bandeau_sup == 1) && ($type_session != 'with_session')))\n\t\t{\n\n\t\t\t// HOOK\n\t\t\tHook::Appel(\"hookHeader1\");\n\n\t\t\t// G\uff83\uff69n\uff83\uff69ration XML\n\t\t\t$generationXML = 1;\n\t\t\tif ((Settings::get(\"export_xml_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude $racine.\"include/generationxml.php\";\n\t\t\t}\n\t\t\tif ((Settings::get(\"export_xml_plus_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude $racine.\"include/generationxmlplus.php\";\n\t\t\t}\n\n\t\t\t// On fabrique une date valide pour la r\uff83\uff69servation si ce n'est pas le cas\n\t\t\t$date_ = mktime(0, 0, 0, $month, $day, $year);\n\t\t\tif ($date_ < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_ > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t\t// echo '<div id=\"toppanel\">'.PHP_EOL;\n\t\t\techo '<div id=\"panel\">'.PHP_EOL;\n\t\t\t// echo '<table id=\"header\">'.PHP_EOL;\n\t\t\t// echo '<tr>'.PHP_EOL;\n\t\t\t//Logo\n\t\t\t$nom_picture = $racine.\"images/\".Settings::get(\"logo\");\n\t\t\tif ((Settings::get(\"logo\") != '') && (@file_exists($nom_picture)))\n\t\t\t\techo '<div class=\"logo\" height=\"100\">'.PHP_EOL.'<a href=\"'.$racine.page_accueil('yes').'day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\"><img src=\"'.$nom_picture.'\" alt=\"logo\"/></a>'.PHP_EOL.'</div>'.PHP_EOL;\n\t\t\t//Accueil\n\t\t\techo '<div class=\"accueil \">',PHP_EOL,'<h2>',PHP_EOL,'<a href=\"'.$racine.page_accueil('yes'),'day=',$day,'&amp;year=',$year,'&amp;month=',$month,'\">',Settings::get(\"company\"),'</a>',PHP_EOL,'</h2>',PHP_EOL, Settings::get('message_accueil'),'</div>',PHP_EOL;\n\t\t\t//Mail r\uff83\uff69servation\n\t\t\t$sql = \"SELECT value FROM \".TABLE_PREFIX.\"_setting WHERE name='mail_etat_destinataire'\";\n\t\t\t$res = grr_sql_query1($sql);\n\t\t\tgrr_sql_free($res);\n\n\t\t\tif ( ( $res == 1 && $type_session == \"no_session\" ) || ( ( $res == 1 || $res == 2) && $type_session == \"with_session\" && (authGetUserLevel(getUserName(), -1, 'area')) == 1  ) )\n\t\t\t{\n\t\t\t\techo '<div class=\"contactformulaire\">',PHP_EOL,'<input class=\"btn btn-default\" type=\"submit\" rel=\"popup_name\" value=\"R\uff83\uff69server\" onClick=\"javascript:location.href=\\'contactFormulaire.php?day=',$day,'&amp;month=',$month,'&amp;year=',$year,'\\'\" >',PHP_EOL,'</div>',PHP_EOL;\n\t\t\t}\n\t\t\t// Administration\n\t\t\tif ($type_session == \"with_session\")\n\t\t\t{\n                $user_name = getUserName();\n                $resaAModerer = resaToModerate($user_name);\n                $nbResaAModerer = count($resaAModerer);\n                $mess_resa = '';\n                if ($nbResaAModerer > 1){$mess_resa = $nbResaAModerer.get_vocab('resasToModerate');}\n                if ($nbResaAModerer == 1){$mess_resa = $nbResaAModerer.get_vocab('resaToModerate');}\n\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1))// || ($mess_resa != '')) trop large ? YN le 06/01/19\n\t\t\t\t{\n\t\t\t\t\techo '<div class=\"administration\">'.PHP_EOL;\n\t\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1))\n                        echo \"<br><a href='{$racineAd}admin_accueil.php?day={$day}&amp;month={$month}&amp;year={$year}'>\".get_vocab('admin').\"</a>\".PHP_EOL;\n\t\t\t\t\tif (authGetUserLevel(getUserName(), -1, 'area') >= 6)\n\t\t\t\t\t{\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\t\thow_many_connected();\n                        echo \"<br />\";\n\t\t\t\t\t}\n                    echo \"<p class='avertissement'><a href='\".$racine.\"admin/admin_accueil.php?\".$parametres_url.\"' class='avertissement' >\".$mess_resa.\"</a></p>\";\n\t\t\t\t\techo '</div>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($type_session != \"with_session\")\n\t\t\t\techo '<script>selection()</script>'.PHP_EOL;\n\t\t\techo '<div class=\"configuration\" >'.PHP_EOL;\n\t\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t{\n\t\t\t\techo '<div class=\"clock\">'.PHP_EOL;\n\t\t\t\techo '<div id=\"Date\">'.PHP_EOL;\n\t\t\t\techo '&nbsp;<span id=\"hours\"></span>'.PHP_EOL;\n\t\t\t\techo 'h'.PHP_EOL;\n\t\t\t\techo '<span id=\"min\"></span>'.PHP_EOL;\n\t\t\t\techo '</div></div>'.PHP_EOL;\n\t\t\t}\n\t\t\t$_SESSION['chemin_retour'] = '';\n\t\t\tif (isset($_SERVER['QUERY_STRING']) && ($_SERVER['QUERY_STRING'] != ''))\n\t\t\t{\n\t\t\t\t//$parametres_url = htmlspecialchars($_SERVER['QUERY_STRING']).\"&amp;\";\n\t\t\t\t$_SESSION['chemin_retour'] = traite_grr_url($grr_script_name).\"?\". $_SERVER['QUERY_STRING'];\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=fr\"><img src=\"'.$racine.'img_grr/fr_dp.png\" alt=\"France\" title=\"france\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=de\"><img src=\"'.$racine.'img_grr/de_dp.png\" alt=\"Deutch\" title=\"deutch\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=en\"><img src=\"'.$racine.'img_grr/en_dp.png\" alt=\"English\" title=\"English\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=it\"><img src=\"'.$racine.'img_grr/it_dp.png\" alt=\"Italiano\" title=\"Italiano\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=es\"><img src=\"'.$racine.'img_grr/es_dp.png\" alt=\"Spanish\" title=\"Spanish\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t}\n\t\t\tif ($type_session == 'no_session')\n\t\t\t{\n\t\t\t\tif ((Settings::get('sso_statut') == 'cas_visiteur') || (Settings::get('sso_statut') == 'cas_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br /> <a href=\"index.php?force_authentification=y\">'.get_vocab(\"authentification\").'</a>'.PHP_EOL;\n\t\t\t\t\techo '<br /> <small><i><a href=\"login.php\">'.get_vocab(\"connect_local\").'</a></i></small>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo '<br /> <a href=\"login.php\">'.get_vocab(\"connect\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif( strlen(htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom'])) > 40 )\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['nom']);\n\t\t\t\telse\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom']);\n\t\t\t\n\t\t\t\techo '<br /><a href=\"'.$racine.'my_account.php?day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\">'. $nomAffichage .' - '.get_vocab(\"manage_my_account\").'</a>'.PHP_EOL;\n\t\t\t\tif (verif_access_search(getUserName()))\n\t\t\t\t\techo '<br/><a href=\"'.$racine.'report.php\">'.get_vocab(\"report\").'</a>'.PHP_EOL;\n\t\t\t\t$disconnect_link = false;\n\t\t\t\tif (!((Settings::get(\"cacher_lien_deconnecter\") == 'y') && (isset($_SESSION['est_authentifie_sso']))))\n\t\t\t\t{\n\t\t\t\t\t$disconnect_link = true;\n\t\t\t\t\tif (Settings::get(\"authentification_obli\") == 1)\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0&amp;redirect_page_accueil=yes\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get(\"Url_portail_sso\") != '') && (isset($_SESSION['est_authentifie_sso'])))\n\t\t\t\t{\n\t\t\t\t\tif ($disconnect_link)\n\t\t\t\t\t\techo ' - '.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\techo '<a href=\"'.Settings::get(\"Url_portail_sso\").'\">'.get_vocab(\"Portail_accueil\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get('sso_statut') == 'lasso_visiteur') || (Settings::get('sso_statut') == 'lasso_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br />';\n\t\t\t\t\tif ($_SESSION['lasso_nameid'] == NULL)\n\t\t\t\t\t\techo '<a href=\"lasso/federate.php\">'.get_vocab('lasso_federate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<a href=\"lasso/defederate.php\">'.get_vocab('lasso_defederate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\techo '</div>'.PHP_EOL;\n\t\t\t// echo '</tr>'.PHP_EOL;\n\t\t\t// echo '</table>'.PHP_EOL;\n\t\t\techo '</div>'.PHP_EOL;\n\t\t\techo '<a id=\"open\" class=\"open\" href=\"#\"><span class=\"glyphicon glyphicon-arrow-up\"><span class=\"glyphicon glyphicon-arrow-down\"></span></span></a>'.PHP_EOL;\n            // echo '<a href=\"#\" onClick=\"menuHaut()\"><span class=\"glyphicon glyphicon-arrow-up\"><span class=\"glyphicon glyphicon-arrow-down\"></span></span></a>'.PHP_EOL;\n\t\t\t// echo '</div>'.PHP_EOL;\n\t\t}\n\t}\n}\n/*\n** Fonction qui affiche le d\uff83\uff69but d'une page avec ent\uff83\uff6ate et balise <section>\n*/\nfunction start_page_w_header($day = '', $month = '', $year = '', $type_session = 'with_session')\n{\n    global $racine,$racineAd;\n    // pour le traitement des modules\n    if (@file_exists('./admin_access_area.php')){\n        $adm = 1;\n        $racine = \"../\";\n        $racineAd = \"./\";\n    }\n    else{\n        $adm = 0;\n        $racine = \"./\";\n        $racineAd = \"./admin/\";\n    }\n    include $racine.\"/include/hook.class.php\";\n    // code HTML\n    echo '<!DOCTYPE html>'.PHP_EOL;\n    echo '<html lang=\"fr\">'.PHP_EOL;\n    // section <head>\n    if ($type_session == \"with_session\")\n        echo pageHead2(Settings::get(\"company\"),\"with_session\");\n    else\n        echo pageHead2(Settings::get(\"company\"),\"no_session\");\n    // section <body>\n    echo \"<body>\";\n    // Menu du haut = section <header>\n    echo \"<header>\";\n    pageHeader2($day, $month, $year, $type_session, $adm);\n    echo \"</header>\";\n    // Debut de la page\n    echo '<section>'.PHP_EOL;\n    // doit \uff83\uff6atre ferm\uff83\uff69 par la fonction end_page\n}   \n/*\n** Fonction qui affiche le d\uff83\uff69but d'une page sans ent\uff83\uff6ate et avec une balise <section>\n*/\nfunction start_page_wo_header($titre, $type_session = 'with_session')\n{\n    // pour le traitement des modules\n    if (@file_exists('./admin_access_area.php')){\n        $adm = 1;\n        $racine = \"../\";\n        $racineAd = \"./\";\n    }\n    else{\n        $adm = 0;\n        $racine = \"./\";\n        $racineAd = \"./admin/\";\n    }\n    include $racine.\"/include/hook.class.php\";\n    // code HTML\n    echo '<!DOCTYPE html>'.PHP_EOL;\n    echo '<html lang=\"fr\">'.PHP_EOL;\n    // section <head>\n    if ($type_session == \"with_session\")\n        echo pageHead2(Settings::get(\"company\"),\"with_session\");\n    else\n        echo pageHead2(Settings::get(\"company\"),\"no_session\");\n    // section <body>\n    echo \"<body>\";\n    // Debut de la page\n    echo '<section>'.PHP_EOL;\n    // doit \uff83\uff6atre ferm\uff83\uff69 par la fonction end_page\n} \n/* Fonction qui ferme les balises rest\uff83\uff69es ouvertes dans les pr\uff83\uff69c\uff83\uff69dentes */\nfunction end_page()\n{\n    echo '</section></body></html>';\n}\n    \n// Les lignes suivantes permettent la compatibilit\uff83\uff69 de GRR avec la variable register_global \uff83\uf8f0 off\nunset($day);\nif (isset($_GET[\"day\"]))\n{\n\t$day = $_GET[\"day\"];\n\tsettype($day,\"integer\");\n\tif ($day < 1)\n\t\t$day = 1;\n\tif ($day > 31)\n\t\t$day = 31;\n}\nunset($month);\nif (isset($_GET[\"month\"]))\n{\n\t$month = $_GET[\"month\"];\n\tsettype($month,\"integer\");\n\tif ($month < 1)\n\t\t$month = 1;\n\tif ($month > 12)\n\t\t$month = 12;\n}\nunset($year);\nif (isset($_GET[\"year\"]))\n{\n\t$year = $_GET[\"year\"];\n\tsettype($year,\"integer\");\n\tif ($year < 1900)\n\t\t$year = 1900;\n\tif ($year > 2100)\n\t\t$year = 2100;\n}\n?>\n", "<?php\n/**\n * misc.inc.php\n * fichier de variables diverses\n * Derni\u00e8re modification : $Date: 2020-01-28 17:15$\n * @author    JeromeB & Laurent Delineau & Yan Naessens\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n\n\n################################\n# Development information\n#################################\n$grr_devel_email = \"support@devome.com\";\n$grr_devel_url = \"http://grr.devome.com/\";\n// Num\u00e9ro de version actuel\n$version_grr = \"3.4.1\";\n// Num\u00e9ro de sous-version actuel (a, b, ...)\n// Utilisez cette variable pour des versions qui corrigent la la version finale sans toucher \u00e0 la base.\n$sous_version_grr = \"b\"; // a, b, c, ...\n// Num\u00e9ro de la release candidate (doit \u00eatre strictement inf\u00e9rieure \u00e0 9). Laisser vide s'il s'agit de la version stable.\n$version_grr_RC = \"\";\n// Version repository (GitHub)\n$versionReposite = \"\";\n\n# Liste des tables\n$liste_tables = array(\n\t\"_area\",\n\t\"_area_periodes\",\n\t\"_calendar\",\n    \"_calendrier_feries\",\n\t\"_calendrier_jours_cycle\",\n\t\"_calendrier_vacances\",\n\t\"_entry\",\n\t\"_entry_moderate\",\n\t\"_type_area\",\n\t\"_j_type_area\",\n\t\"_j_mailuser_room\",\n\t\"_j_user_area\",\n\t\"_j_user_room\",\n\t\"_log\",\n\t\"_repeat\",\n\t\"_room\",\n\t\"_setting\",\n\t\"_utilisateurs\",\n\t\"_j_useradmin_area\",\n\t\"_overload\",\n\t\"_site\",\n\t\"_j_useradmin_site\",\n\t\"_j_site_area\",\n\t\"_correspondance_statut\",\n\t\"_page\",\n\t\"_modulesext\",\n\t);\n\n# Liste des feuilles de style\n$liste_themes = array(\n\t\"default\",\n    \"grand_bleu\",\n\t\"vert\",\n\t\"violet\",\n\t\"orange\",\n\t\"bleu\",\n\t\"rouge\",\n\t\"rose\",\n\t\"fluo\",\n    \"perso\"\n\t);\n\n# Liste des noms des styles\n$liste_name_themes = array(\n    \"Defaut\",\n\t\"Grand bleu\",\n\t\"Verdoyant\",\n\t\"Violeta\",\n\t\"Orange Talmont\",\n\t\"Bleu Talmont\",\n\t\"Rouge Feu\",\n\t\"Roseline\",\n\t\"Jaune Fluo\",\n    \"Perso\"\n\t);\n\n# Liste des langues\n$liste_language = array(\n\t\"fr\",\n\t\"de\",\n\t\"en\",\n\t\"it\",\n\t\"es\"\n\t);\n\n# Liste des noms des langues\n$liste_name_language = array(\n\t\"Fran\u00e7ais\",\n\t\"Deutsch\",\n\t\"English\",\n\t\"Italiano\",\n\t\"Spanish\"\n\t);\n\n# Compatibilit\u00e9 avec les version inf\u00e9rieures \u00e0 1.9.6\nif ((!isset($table_prefix)) or ($table_prefix==''))\n\t$table_prefix=\"grr\";\n# D\u00e9finition de TABLE_PREFIX\ndefine(\"TABLE_PREFIX\",$table_prefix);\n\n\n################################################\n# Configuration du planning : valeurs par d\u00e9faut\n# Une interface en ligne permet une configuration domaine par domaine de ces valeurs\n################################################\n# Resolution - quel bloc peut \u00eatre r\u00e9serv\u00e9, en secondes\n# remarque : 1800 secondes = 1/2 heure.\n$resolution = 1800;\n\n# Dur\u00e9e maximale de r\u00e9servation, en minutes\n# -1 : d\u00e9sactivation de la limite\n$duree_max_resa = -1 ;\n\n# D\u00e9but et fin d'une journ\u00e9e : valeur enti\u00e8res uniquement de 0 \u00e0 23\n# morningstarts doit \u00eatre inf\u00e9rieur \u00e0  < eveningends.\n$morningstarts = 8;\n$eveningends   = 19;\n\n# Minutes \u00e0 ajouter \u00e0 l'heure $eveningends pour avoir la fin r\u00e9elle d'une journ\u00e9e.\n# Examples: pour que le dernier bloc r\u00e9servable de la journ\u00e9e soit 16:30-17:00, mettre :\n# eveningends=16 et eveningends_minutes=30.\n# Pour avoir une journ\u00e9e de 24 heures avec un pas de 15 minutes mettre :\n# morningstarts=0; eveningends=23;\n# eveningends_minutes=45; et resolution=900.\n$eveningends_minutes = 0;\n\n# D\u00e9but de la semaine: 0 pour dimanche, 1 pour lundi, etc.\n$weekstarts = 1;\n\n# Format d'affichage du temps : valeur 0 pour un affichage \u00ab\u00a012 heures\u00a0\u00bb et valeur 1 pour un affichage  \u00ab\u00a024 heures\u00a0\u00bb.\n$twentyfourhour_format = 1;\n\n# Ci-dessous des fonctions non officielles (non document\u00e9es) de GRR\n# En attendant qu'elles soient impl\u00e9ment\u00e9es dans GRR avec une interface en ligne\n\n# Vous pouvez indiquer ci-dessous les identifiant de plusieurs ressources qui seront r\u00e9servables, m\u00eame par un simple visiteur\n# Par exemple la ligne suivante autorise les simples visiteurs \u00e0 r\u00e9server les ressoures 8, 4 et 5 :\n# $id_room_autorise = array(\"8\", \"4\", \"5\");\n$id_room_autorise = array();\n\n# Possibilit\u00e9 de d\u00e9sactiver le bandeau sup\u00e9rieur dans le cas de simples visiteurs\n# Pour se connecter il est alors n\u00e9cessaire de se rendre directement \u00e0 l'adresse du type http://mon-site.fr/grr/login.php\n# Mettre ci-dessous $desactive_bandeau_sup = 1;  pour d\u00e9sactiver le bandeau sup\u00e9rieur pour les simples visiteurs.\n# Mettre ci-dessous $desactive_bandeau_sup = 0;  pour ne pas d\u00e9sactiver le bandeau sup\u00e9rieur pour les simples visiteurs.\n$desactive_bandeau_sup = 0;\n?>\n"], "fixing_code": ["Bugs connus sur la version de GitHub :\n - affichage d\u00e9fectueux du menu en position haute dans la page month_all2 \n - des probl\u00e8mes se produisent lorsqu'on veut faire une modification/copie de r\u00e9servation  avec un changement de domaine\n - l'entr\u00e9e du code hexad\u00e9cimal des couleurs des types n'est pas r\u00e9percut\u00e9e sur la zone test\n\nT\u00e2ches pr\u00e9vues :\n - gestion des acc\u00e8s au niveau de la ressource (et pas seulement au niveau des domaines)\n - authentification li\u00e9e \u00e0 Joomla!\n-----\n--\n-----\n\nVersion 3.4.1\n    [ajout] Echange de deux r\u00e9servations\n    [ajout] Page year_all affichant les r\u00e9servations sur plusieurs mois et plusieurs domaines (\u00e0 utiliser avec prudence s'il y a beaucoup de r\u00e9servations ou de ressources)\n    [ajout] Contenu des champs additionnels dans les exports csv\n    [ajout] Gestion des couleurs du texte des types de r\u00e9servation (meilleure lisibilit\u00e9 dans les plannings)\n    [ajout] Page d'interface de personnalisation des couleurs\n    [amelioration] Reprise du code des pages plannings pour g\u00e9rer les menus escamotables (haut et gauche) \n    [modification] Utilisation de jscolor pour d\u00e9finir les couleurs des types\n    [modification] Page d'accueil de la section administration\n    [modification] Gestion de l'affichage des champs additionnels\n    [correction] meilleure prise en compte des r\u00e9glages par d\u00e9faut\nSous-version 3.4.1a (version de maintenance)\n\t[correction] divers bugs, compatibilit\u00e9 php7, erreurs de syntaxe ou orthographiques\nSous-version 3.4.1b \n\t[ajout] possibilit\u00e9 de d\u00e9finir un type et affecter ce type \u00e0 la fonction \"cacher sur les plannings week_all, month et month_all\"\n\t[am\u00e9lioration] configuration LDAP acceptant le protocole LDAPS\n\t[am\u00e9lioration] gestion des champs additionnels dans edit_entry\n\t[correction] divers bugs, erreurs de syntaxe ou orthographiques\n\t[modification] limitation de la taille des donn\u00e9es conform\u00e9ment \u00e0 la base\n\t[modification] calcul et aspect de la page de contact externe\nSous-version 3.4.1c\n    [correction] failles de s\u00e9curit\u00e9 dans formulaire de contact et gestion des ressources\n    [correction] divers bugs, erreurs de syntaxe ou orthographiques\n-----\n--\n-----\n\nVersion 3.4.0\n\t[ajout] Personnalisation des couleurs pour les types de r\u00e9servation depuis l'administration, soit un passage de 28 couleurs \u00e0 16 777 216 couleurs\n\t[ajout] Possibilit\u00e9 d'afficher le formulaire de demande de r\u00e9servation aux non connect\u00e9s et aux visiteurs ou simplement aux visiteurs \n\t[ajout] Interdire les diff\u00e9rentes configurations d'authentification externe via le fichier de config\n\t[ajout] Menu administration : Couleur bleu sur le lien o\u00f9 l'on se situe\n\t[ajout] Menu administration : Possiblit\u00e9 d'acc\u00e9der au lien o\u00f9 l'on se situe\n\t[ajout] Moteur de page\n\t[ajout] Conditions G\u00e9n\u00e9rales d'Utilisation personnalisables\n\t[ajout] Lors de l'envoi mail, notifier le changement de ressources s'il y a lieu\n\t[ajout] Gestion de modules externes\n    [ajout] message dans l'ent\u00eate s'il existe une r\u00e9servation \u00e0 mod\u00e9rer\n    [am\u00e9lioration] filtrage par plage IP au format CIDR\n    [am\u00e9lioration] retour \u00e0 la page d'appel apr\u00e8s mod\u00e9ration\n    [am\u00e9lioration] pr\u00e9sentation des r\u00e9servations mod\u00e9r\u00e9es\n    [am\u00e9lioration] possibilit\u00e9 d'utiliser les couleurs du texte et du fond\n    [am\u00e9lioration] int\u00e9gration au portail EnvOLE\n    [am\u00e9lioration] filtrage des adresses mail\n    [am\u00e9lioration] affichage et liens pour cr\u00e9er une r\u00e9servation en page month_all2\n    [am\u00e9lioration] affichage des menus, changement de param\u00e9trage de make_room_list_html\n    [am\u00e9lioration] affichage des r\u00e9servations successives dans une journ\u00e9e en page week_all\n    [correctif] param\u00e8tre manquant dans mysqli_connect\n    [correctif] divers correctifs syntaxiques\n    [correctif] donner une valeur num\u00e9rique \u00e0 $dbPort\n    [correctif] prise en compte des pr\u00e9f\u00e9rences de l'utilisateur dans le calcul de la page d'accueil\n    [correctif] la couleur jaune est illisible sur fond blanc\n    [correctif] affichage ou non de l'imprimante\n    [correctif] gestion du menu gauche escamotable\n\t[mise \u00e0 jour] CKEditor 4.8.0 \n\t[modification] G\u00e9n\u00e9ration des PDF, on parle de ressource et non de salle, r\u00e9organisation du format PDF (compatible en enveloppe fen\u00eatre)\n\t[modification] Date de d\u00e9but et fin des r\u00e9servations par d\u00e9faut lors d'une premi\u00e8re installation\n\t[modification] Longueur minimum du mot de passe, passage de 6 \u00e0 8 caract\u00e8res lors d'une premi\u00e8re installation\n\t[modification] Conformit\u00e9 avec le RGPD\n    [modification] boutons mois pr\u00e9c\u00e9dent/suivant\n\n\t\n-----\n--\n-----\n\nVersion 3.3.1\n    [ajout] Visualisation des utilisateurs avec un mot de passe trop simple (A titre indicatif, certains mots de passe simples ne sont pas list\u00e9s)\n    [ajout] Configuration du calendrier des vacances depuis l'administration\n    [ajout] Nouveau calendrier pour indiquer les f\u00e9ri\u00e9s depuis l'administration\n    [ajout] Ajout de fichiers redirection pour emp\u00eacher la lecture de certains r\u00e9pertoires\n    [ajout] Champs additionnels dans l'affichage d'une r\u00e9servation\n    [ajout] Page permettant la suppression de toutes les r\u00e9servations post\u00e9rieures \u00e0 une date\n    [ajout] Page permettant la suppression de toutes les r\u00e9servations ant\u00e9rieures \u00e0 une date\n    [ajout] Page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv\n    [ajout] Page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv issu du logiciel UnDeuxTemps\n    [ajout] biblioth\u00e8ques phpCAS dans le dossier /include\n    [ajout] Lien vers la page year.php depuis le num\u00e9ro de l'ann\u00e9e dans les pages month*.php\n\t[ajout] Variable dans config permettant de d\u00e9sactiver la recherche de mise \u00e0 jour\n    [correction] Affichage des champs additionnel, m\u00eame dans le cas de caract\u00e8re non utf8\n    [correction] Bordure de s\u00e9paration pour les r\u00e9servations entre les r\u00e9servations dans la vue mois d'une ressources\n    [correction] Bordure de s\u00e9paration pour les r\u00e9servations entre les r\u00e9servations dans la vue mois d'un domaine\n    [correction] Correction de la connexion LDAP lorsqu'un utilisateur externe existant se connecte ( merci \u00e0 pboissonneault )\n    [correction] Affichage de la colonne gauche de l'admin dans la page admin_import_users_csv.php\n\t[correction] Vue semaine d'une ressource sur plusieurs jour (horaire et cr\u00e9naux)\n    [modification] La configuration d'un cas SSO ce fait depuis l'administration\n    [modification] D\u00e9placement images dans le dossier appropri\u00e9\n    [modification] de la page admin_calend.php pour en faire une page de choix entre:\n        -- l'ancienne page admin_calend.php renomm\u00e9e admin_calend2.php\n        -- une page permettant de supprimer toutes les r\u00e9servations avant une date donn\u00e9e\n        -- une page permettant de supprimer toutes les r\u00e9servations apr\u00e8s une date donn\u00e9e\n        -- une page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv\n        -- une page permettant de r\u00e9server en masse \u00e0 partir d'un fichier csv issu du logiciel UnDeuxTemps\n    [modification] reprise des patches utilis\u00e9s dans GEPI pour utilisation derri\u00e8re un reverse-proxy\n\t[modification] Am\u00e9lioration du bandeau du haut : Supression texte \"Accueil\", r\u00e9duction de la hauteur, optimisation du contenu\n\t[modification] Passage d'image en CSS (Glyphicon)\n    [Suppression] Fichiers inutiles\n    [mise \u00e0 jour] fichier des vacances scolaires (source index-education)\n    [mise \u00e0 jour] documentation\n\n\nVersion 3.3.0 et inf\u00e9rieur\n- Voir sur le site grr.devome.com\n", "<?php\n/**\n * admin_edit_room.php\n * Interface de creation/modification des sites, domaines et des ressources de l'application GRR\n * Ce script fait partie de l'application GRR\n * Derni\u00e8re modification : $Date: 2020-03-13 12:30$\n * @author    Laurent Delineau & JeromeB & Marc-Henri PAMISEU & Yan Naessens & Daniel Antelme\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n$grr_script_name = \"admin_edit_room.php\";\n\ninclude \"../include/admin.inc.php\";\n\n$ok = NULL;\nif (Settings::get(\"module_multisite\") == \"Oui\")\n\t$id_site = isset($_POST[\"id_site\"]) ? $_POST[\"id_site\"] : (isset($_GET[\"id_site\"]) ? $_GET[\"id_site\"] : -1);\n$action = isset($_POST[\"action\"]) ? $_POST[\"action\"] : (isset($_GET[\"action\"]) ? $_GET[\"action\"] : NULL);\n$add_area = isset($_POST[\"add_area\"]) ? $_POST[\"add_area\"] : (isset($_GET[\"add_area\"]) ? $_GET[\"add_area\"] : NULL);\n$area_id = isset($_POST[\"area_id\"]) ? $_POST[\"area_id\"] : (isset($_GET[\"area_id\"]) ? $_GET[\"area_id\"] : NULL);\n$retour_page = isset($_POST[\"retour_page\"]) ? $_POST[\"retour_page\"] : (isset($_GET[\"retour_page\"]) ? $_GET[\"retour_page\"] : NULL);\n$room = isset($_POST[\"room\"]) ? $_POST[\"room\"] : (isset($_GET[\"room\"]) ? $_GET[\"room\"] : NULL);\n$id_area = isset($_POST[\"id_area\"]) ? $_POST[\"id_area\"] : (isset($_GET[\"id_area\"]) ? $_GET[\"id_area\"] : NULL);\n$change_area = isset($_POST[\"change_area\"]) ? $_POST[\"change_area\"] : NULL;\n$area_name = isset($_POST[\"area_name\"]) ? $_POST[\"area_name\"] : NULL;\n$access = isset($_POST[\"access\"]) ? $_POST[\"access\"] : NULL;\n$ip_adr = isset($_POST[\"ip_adr\"]) ? $_POST[\"ip_adr\"] : NULL;\n$room_name = isset($_POST[\"room_name\"]) ? $_POST[\"room_name\"] : NULL;\n$description = isset($_POST[\"description\"]) ? $_POST[\"description\"] : NULL;\n$capacity = isset($_POST[\"capacity\"]) ? $_POST[\"capacity\"] : NULL;\n$duree_max_resa_area1  = isset($_POST[\"duree_max_resa_area1\"]) ? $_POST[\"duree_max_resa_area1\"] : NULL;\n$duree_max_resa_area2  = isset($_POST[\"duree_max_resa_area2\"]) ? $_POST[\"duree_max_resa_area2\"] : NULL;\n$delais_max_resa_room  = isset($_POST[\"delais_max_resa_room\"]) ? $_POST[\"delais_max_resa_room\"] : NULL;\n$delais_min_resa_room  = isset($_POST[\"delais_min_resa_room\"]) ? $_POST[\"delais_min_resa_room\"] : NULL;\n$delais_option_reservation  = isset($_POST[\"delais_option_reservation\"]) ? $_POST[\"delais_option_reservation\"] : NULL;\n$allow_action_in_past  = isset($_POST[\"allow_action_in_past\"]) ? $_POST[\"allow_action_in_past\"] : NULL;\n$dont_allow_modify  = isset($_POST[\"dont_allow_modify\"]) ? $_POST[\"dont_allow_modify\"] : NULL;\n$qui_peut_reserver_pour  = isset($_POST[\"qui_peut_reserver_pour\"]) ? $_POST[\"qui_peut_reserver_pour\"] : NULL;\n$who_can_see  = isset($_POST[\"who_can_see\"]) ? $_POST[\"who_can_see\"] : NULL;\n$max_booking = isset($_POST[\"max_booking\"]) ? $_POST[\"max_booking\"] : NULL;\nsettype($max_booking, \"integer\");\nif ($max_booking<-1)\n\t$max_booking = -1;\n$statut_room = isset($_POST[\"statut_room\"]) ? \"0\" : \"1\";\n$show_fic_room = isset($_POST[\"show_fic_room\"]) ? \"y\" : \"n\";\nif (isset($_POST[\"active_ressource_empruntee\"]))\n\t$active_ressource_empruntee = 'y';\nelse\n{\n\t$active_ressource_empruntee = 'n';\n\t// toutes les reservations sont considerees comme restituee\n\tgrr_sql_query(\"update \".TABLE_PREFIX.\"_entry set statut_entry = '-' where room_id = '\".$room.\"'\");\n}\nif (isset($_POST[\"active_cle\"]))\n\t$active_cle = 'y';\nelse\n{\n\t$active_cle = 'n';\n\t// toutes les reservations sont considerees comme restituee\n\tgrr_sql_query(\"update \".TABLE_PREFIX.\"_entry set statut_entry = '-' where room_id = '\".$room.\"'\");\n}\n$picture_room = isset($_POST[\"picture_room\"]) ? $_POST[\"picture_room\"] : NULL;\n$comment_room = isset($_POST[\"comment_room\"]) ? $_POST[\"comment_room\"] : NULL;\n$show_comment = isset($_POST[\"show_comment\"]) ? \"y\" : \"n\";\n$change_done = isset($_POST[\"change_done\"]) ? $_POST[\"change_done\"] : NULL;\nif(!isset($_POST[\"area_order\"]) || empty($_POST[\"area_order\"])){\n\t$area_order = 0;\n} else{\n\t$area_order = $_POST[\"area_order\"];\n}\n\n$room_order = isset($_POST[\"room_order\"]) ? $_POST[\"room_order\"] : NULL;\n$change_room = isset($_POST[\"change_room\"]) ? $_POST[\"change_room\"] : NULL;\n$number_periodes = isset($_POST[\"number_periodes\"]) ? $_POST[\"number_periodes\"] : NULL;\n$type_affichage_reser = isset($_POST[\"type_affichage_reser\"]) ? $_POST[\"type_affichage_reser\"] : NULL;\n$retour_resa_obli = isset($_POST[\"retour_resa_obli\"]) ? $_POST[\"retour_resa_obli\"] : NULL;\n$moderate = isset($_POST['moderate']) ? $_POST[\"moderate\"] : NULL;\nif ($moderate == 'on')\n\t$moderate = 1;\nelse\n\t$moderate = 0;\nsettype($type_affichage_reser, \"integer\");\n\n$back = '';\nif (isset($_SERVER['HTTP_REFERER']))\n\t$back = htmlspecialchars($_SERVER['HTTP_REFERER']);\n\nif (isset($_POST[\"change_room_and_back\"]))\n{\n\t$change_room = \"yes\";\n\t$change_done = \"yes\";\n}\n\nif (isset($_POST[\"change_area_and_back\"]))\n{\n\t$change_area = \"yes\";\n\t$change_done = \"yes\";\n}\n// memorisation du chemin de retour\nif (!isset($retour_page))\n{\n\t$retour_page = $back;\n\t// on nettoie la chaine :\n\t$long_chaine_a_supprimer = strlen(strstr($retour_page, \"&amp;msg=\")); // longueur de la chaine e partir de la premiere occurence de &amp;msg=\n\tif ($long_chaine_a_supprimer == 0)\n\t\t$long_chaine_a_supprimer = strlen(strstr($retour_page, \"?msg=\"));\n\t$long = strlen($retour_page) - $long_chaine_a_supprimer;\n\t$retour_page = substr($retour_page, 0, $long);\n}\n// modification d'une resource : admin ou gestionnaire\nif (authGetUserLevel(getUserName(),-1) < 6)\n{\n\tif (isset($room))\n\t{\n\t\t// Il s'agit d'une modif de ressource\n\t\tif (((authGetUserLevel(getUserName(),$room) < 3)) || (!verif_acces_ressource(getUserName(), $room)))\n\t\t{\n\t\t\tshowAccessDenied($back);\n\t\t\texit();\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (isset($area_id))\n\t\t{\n\t\t\t// On verifie que le domaine $area_id existe\n\t\t\t$test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE id='\".$area_id.\"'\");\n\t\t\tif ($test == -1)\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t\t// Il s'agit de l'ajout d'une ressource\n\t\t\t// On verifie que l'utilisateur a le droit d'ajouter des ressources\n\t\t\tif ((authGetUserLevel(getUserName(), $area_id, 'area') < 4))\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t}\n\t\telse if (isset($id_area))\n\t\t{\n\t\t\t// On verifie que le domaine $area existe\n\t\t\t$test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n\t\t\tif ($test == -1)\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t\t// Il s'agit de la modif d'un domaine\n\t\t\tif ((authGetUserLevel(getUserName(), $id_area, 'area') < 4))\n\t\t\t{\n\t\t\t\tshowAccessDenied($back);\n\t\t\t\texit();\n\t\t\t}\n\t\t}\n\t}\n}\n$msg ='';\n// Gestion des ressources\nif ((!empty($room)) || (isset($area_id)))\n{\n\t// Enregistrement d'une ressource\n\tif (isset($change_room))\n\t{\n\t\tif (isset($_POST['sup_img']))\n        {\n            $dest = '../images/';\n            $ok1 = false;\n            if ($f = @fopen(\"$dest/.test\", \"w\"))\n            {\n                @fputs($f, '<'.'?php $ok1 = true; ?'.'>');\n                @fclose($f);\n                include(\"$dest/.test\");\n            }\n            if (!$ok1)\n            {\n                $msg .= \"L\\'image n\\'a pas pu etre supprimee : probleme d\\'\u00e9criture sur le repertoire. Veuillez signaler ce probl\u00e8me \u00e0 l\\'administrateur du serveur.\\\\n\";\n                $ok = 'no';\n            }\n            else\n            {\n                if (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".jpg\"))\n                    unlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".jpg\");\n                if (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".png\"))\n                    unlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".png\");\n                if (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".gif\"))\n                    unlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".gif\");\n                // $picture_room = \"\"; mettre \u00e0 jour la donn\u00e9e room\n                $sql_picture = \"UPDATE \".TABLE_PREFIX.\"_room SET picture_room='' WHERE id=\".protect_data_sql($room);\n                if (grr_sql_command($sql_picture) < 0)\n                {\n                    fatal_error(0, get_vocab('update_room_failed') . grr_sql_error());\n                    $ok = 'no';\n                }\n            }\n        }\n        if (empty($capacity))\n\t\t\t$capacity = 0;\n\t\tif ($capacity < 0)\n\t\t\t$capacity = 0;\n\t\tsettype($delais_max_resa_room,\"integer\");\n\t\tif ($delais_max_resa_room < 0)\n\t\t\t$delais_max_resa_room = -1;\n\t\tsettype($delais_min_resa_room,\"integer\");\n\t\tif ($delais_min_resa_room < 0)\n\t\t\t$delais_min_resa_room = 0;\n\t\tsettype($delais_option_reservation,\"integer\");\n\t\tif ($delais_option_reservation < 0)\n\t\t\t$delais_option_reservation = 0;\n\t\tif ($allow_action_in_past == '')\n\t\t\t$allow_action_in_past = 'n';\n\t\tif ($dont_allow_modify == '')\n\t\t\t$dont_allow_modify = 'n';\n\t\tif ((isset($room)) && !((isset($action) && ($action == \"duplique_room\"))))\n\t\t{\n\t\t\t$sql = \"UPDATE \".TABLE_PREFIX.\"_room SET\n\t\t\troom_name='\".protect_data_sql($room_name).\"',\n\t\t\tdescription='\".protect_data_sql($description).\"', \";\n\t\t\tif ($picture_room != '')\n\t\t\t\t$sql .= \"picture_room='\".protect_data_sql($picture_room).\"', \";\n\t\t\t$sql .= \"comment_room='\".protect_data_sql(corriger_caracteres($comment_room)).\"',\n\t\t\tshow_comment='\".$show_comment.\"',\n\t\t\tarea_id='\".$area_id.\"',\n\t\t\tshow_fic_room='\".$show_fic_room.\"',\n\t\t\tactive_ressource_empruntee = '\".$active_ressource_empruntee.\"',\n\t\t\tactive_cle = '\".$active_cle.\"',\n\t\t\tcapacity='\".$capacity.\"',\n\t\t\tdelais_max_resa_room='\".$delais_max_resa_room.\"',\n\t\t\tdelais_min_resa_room='\".$delais_min_resa_room.\"',\n\t\t\tdelais_option_reservation='\".$delais_option_reservation.\"',\n\t\t\tallow_action_in_past='\".$allow_action_in_past.\"',\n\t\t\tdont_allow_modify='\".$dont_allow_modify.\"',\n\t\t\tqui_peut_reserver_pour = '\".$qui_peut_reserver_pour.\"',\n\t\t\twho_can_see = '\".$who_can_see.\"',\n\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\ttype_affichage_reser='\".$type_affichage_reser.\"',\n\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\tmoderate='\".$moderate.\"',\n\t\t\tstatut_room='\".$statut_room.\"'\n\t\t\tWHERE id=$room\";\n\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t{\n\t\t\t\tfatal_error(0, get_vocab('update_room_failed') . grr_sql_error());\n\t\t\t\t$ok = 'no';\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$sql = \"insert into \".TABLE_PREFIX.\"_room\n\t\t\tSET room_name='\".protect_data_sql($room_name).\"',\n\t\t\tarea_id='\".$area_id.\"',\n\t\t\tdescription='\".protect_data_sql($description).\"',\n\t\t\tpicture_room='\".protect_data_sql($picture_room).\"',\n\t\t\tcomment_room='\".protect_data_sql(corriger_caracteres($comment_room)).\"',\n\t\t\tshow_fic_room='\".$show_fic_room.\"',\n\t\t\tactive_ressource_empruntee = '\".$active_ressource_empruntee.\"',\n\t\t\tactive_cle = '\".$active_cle.\"',\n\t\t\tcapacity='\".$capacity.\"',\n\t\t\tdelais_max_resa_room='\".$delais_max_resa_room.\"',\n\t\t\tdelais_min_resa_room='\".$delais_min_resa_room.\"',\n\t\t\tdelais_option_reservation='\".$delais_option_reservation.\"',\n\t\t\tallow_action_in_past='\".$allow_action_in_past.\"',\n\t\t\tdont_allow_modify='\".$dont_allow_modify.\"',\n\t\t\tqui_peut_reserver_pour = '\".$qui_peut_reserver_pour.\"',\n\t\t\twho_can_see = '\".$who_can_see.\"',\n\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\ttype_affichage_reser='\".$type_affichage_reser.\"',\n\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\tmoderate='\".$moderate.\"',\n\t\t\tstatut_room='\".$statut_room.\"'\";\n\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t\t$room = mysqli_insert_id($GLOBALS['db_c']);\n\t\t}\n\t\t#Si room_name est vide on le change maintenant que l'on a l'id room\n\t\tif ($room_name == '')\n\t\t{\n\t\t\t$room_name = get_vocab(\"room\").\" \".$room;\n\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_room SET room_name='\".protect_data_sql($room_name).\"' WHERE id=$room\");\n\t\t}\n        // image d'illustration\n        $doc_file = isset($_FILES[\"doc_file\"]) ? $_FILES[\"doc_file\"] : NULL;\n        /* Test premier, juste pour bloquer les double extensions */\n        if (count(explode('.', $doc_file['name'])) > 2) {\n            $msg .= \"L\\'image n\\'a pas pu \u00eatre enregistr\u00e9e : les seules extentions autoris\u00e9es sont gif, png et jpg.\\\\n\";\n            $ok = 'no';\n        } \n        elseif  (preg_match(\"`\\.([^.]+)$`\", $doc_file['name'], $match)) {\n            $ext = strtolower($match[1]);\n            if ($ext != 'jpg' && $ext != 'png'&& $ext != 'gif')\n            {\n                $msg .= \"L\\'image n\\'a pas pu etre enregistree : les seules extentions autorisees sont gif, png et jpg.\\\\n\";\n                $ok = 'no';\n            }\n            else {\n                /* deuxi\u00e8me test pass\u00e9, l'extension est autoris\u00e9e */\n                /* 3\u00e8me test avec fileinfo */\n                $finfo = finfo_open(FILEINFO_MIME_TYPE);\n                $fileType = finfo_file($finfo, $doc_file['tmp_name']);\n                /* 4\u00e8me test avec gd pour valider que c'est bien une image malgr\u00e9 tout - n\u00e9cessaire ou parano\u00a0? */\n                switch($fileType) {\n                    case \"image/gif\":\n                        /* recreate l'image, supprime les data exif */\n                        $logoRecreated = @imagecreatefromgif ( $doc_file['tmp_name'] );\n                        /* fix pour la transparence */\n                        imageAlphaBlending($logoRecreated, true);\n                        imageSaveAlpha($logoRecreated, true);\n                        $extSafe = \"gif\";\n                        break;\n                    case \"image/jpeg\":\n                        $logoRecreated = @imagecreatefromjpeg ( $doc_file['tmp_name'] );\n                        $extSafe = \"jpg\";\n                        break;\n                    case \"image/png\":\n                        $logoRecreated = @imagecreatefrompng ( $doc_file['tmp_name'] );\n                        /* fix pour la transparence */\n                        imageAlphaBlending($logoRecreated, true);\n                        imageSaveAlpha($logoRecreated, true);\n                        $extSafe = \"png\";\n                        break;\n                    default:\n                        $msg .= \"L\\'image n\\'a pas pu \u00eatre enregistr\u00e9e : type mime incompatible.\\\\n\";\n                        $ok = 'no';\n                        $extSafe = false;\n                        break;\n                }\n            }\n            if (!$logoRecreated || $extSafe === false) {\n                /* la fonction imagecreate a \u00e9chou\u00e9, donc l'image est corrompue ou craft\u00e9e */\n                $msg .= \"L\\'image n\\'a pas pu \u00eatre enregistr\u00e9e : fichier corrompu.\\\\n\";\n                $ok = 'no';\n            }\n            else\n            {   /* je teste si la destination est writable */\n                $dest = '../images/';\n                $ok1 = is_writable($dest);\n                if (!$ok1)\n                {\n                    $msg .= \"L\\'image n\\'a pas pu etre enregistree : probleme d\\'ecriture sur le repertoire IMAGES. Veuillez signaler ce probleme e l\\'administrateur du serveur.\\\\n\";\n                    $ok = 'no';\n                }\n                else\n                {\n                    $ok1 = @copy($doc_file['tmp_name'], $dest.$doc_file['name']);\n                    if (!$ok1)\n                        $ok1 = @move_uploaded_file($doc_file['tmp_name'], $dest.$doc_file['name']);\n                    if (!$ok1)\n                    {\n                        $msg .= \"L\\'image n\\'a pas pu etre enregistree : probleme de transfert. Le fichier n\\'a pas pu etre transfere sur le repertoire IMAGES. Veuillez signaler ce probleme \u00e0 l\\'administrateur du serveur.\\\\n\";\n                        $ok = 'no';\n                    }\n                    else\n                    {\n                        $tab = explode(\".\", $doc_file['name']);\n                        $ext = strtolower($tab[1]);\n                        if (@file_exists($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$extSafe))\n                            @unlink($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$extSafe);\n                        rename($dest.$doc_file['name'],$dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$extSafe);\n                        @chmod($dest.\"img_\".TABLE_PREFIX.\"\".$room.\".\".$extSafe, 0666);\n                        $picture_room = \"img_\".TABLE_PREFIX.\"\".$room.\".\".$extSafe;\n                        $sql_picture = \"UPDATE \".TABLE_PREFIX.\"_room SET picture_room='\".protect_data_sql($picture_room).\"' WHERE id=\".protect_data_sql($room);\n                        if (grr_sql_command($sql_picture) < 0)\n                        {\n                            fatal_error(0, get_vocab('update_room_failed') . grr_sql_error());\n                            $ok = 'no';\n                        }\n                    }\n                }\n            }\n        }\n        else if ($doc_file['name'] != '')\n        {\n            $msg .= \"L\\'image n\\'a pas pu etre enregistree : le fichier image selectionne n'est pas valide !\\\\n\";\n            $ok = 'no';\n        }\n        $msg .= get_vocab(\"message_records\");\n\t}\n\t// Si pas de probleme, retour \u00e0 la page d'accueil apres enregistrement\n\tif ((isset($change_done)) && (!isset($ok)))\n\t{\n\t\tif ($msg != '')\n\t\t{\n\t\t\t$_SESSION['displ_msg'] = 'yes';\n\t\t\tif (strpos($retour_page, \".php?\") == \"\")\n\t\t\t\t$param = \"?msg=\".$msg;\n\t\t\telse\n\t\t\t\t$param = \"&msg=\".$msg;\n\t\t}\n\t\telse\n\t\t\t$param = '';\n\t\tHeader(\"Location: \".$retour_page.$param);\n\t\texit();\n\t}\n\t# print the page header\n\tstart_page_w_header(\"\", \"\", \"\", $type=\"with_session\");\n\taffiche_pop_up($msg,\"admin\");\n\tinclude \"admin_col_gauche2.php\";\n\techo \"<div class=\\\"col-md-9 col-sm-8 col-xs-12\\\">\";\n\t// affichage du formulaire\n\tif (isset($room))\n\t{\n\t\t// Il s'agit d'une modification d'une ressource\n\t\t$res = grr_sql_query(\"SELECT * FROM \".TABLE_PREFIX.\"_room WHERE id=$room\");\n\t\tif (! $res)\n\t\t\tfatal_error(0, get_vocab('error_room') . $room . get_vocab('not_found'));\n\t\t$row = grr_sql_row_keyed($res, 0);\n\t\tgrr_sql_free($res);\n\t\t$area_id = grr_sql_query1(\"select area_id from \".TABLE_PREFIX.\"_room where id='\".$room.\"'\");\n\t\t$area_name = grr_sql_query1(\"select area_name from \".TABLE_PREFIX.\"_area where id='\".$area_id.\"'\");\n\t\tif ($action == \"duplique_room\")\n\t\t\techo \"<h2>\".get_vocab(\"match_area\").get_vocab('deux_points').\" \".$area_name.\"<br />\".get_vocab(\"duplique_ressource\").\"</h2>\\n\";\n\t\telse\n\t\t\techo \"<h2>\".get_vocab(\"match_area\").get_vocab('deux_points').\" \".$area_name.\"<br />\".get_vocab(\"editroom\").\"</h2>\\n\";\n\t}\n\telse\n\t{\n\t\t// Il s'agit de l'enregistrement d'une nouvelle ressource\n\t\t$row['picture_room'] = '';\n\t\t$row[\"id\"] = '';\n\t\t$row[\"room_name\"]= '';\n\t\t$row[\"description\"] = '';\n\t\t$row['comment_room'] = '';\n\t\t$row['show_comment'] = 'n';\n\t\t$row[\"capacity\"]   = '';\n\t\t$row[\"delais_max_resa_room\"] = -1;\n\t\t$row[\"delais_min_resa_room\"] = 0;\n\t\t$row[\"delais_option_reservation\"] = 0;\n\t\t$row[\"allow_action_in_past\"] = 'n';\n\t\t$row[\"dont_allow_modify\"] = 'n';\n\t\t$row[\"qui_peut_reserver_pour\"] = 6;\n\t\t$row[\"who_can_see\"] = 0;\n\t\t$row[\"order_display\"]  = 0;\n\t\t$row[\"type_affichage_reser\"]  = 0;\n\t\t$row[\"max_booking\"] = -1;\n\t\t$row['statut_room'] = '';\n\t\t$row['moderate'] = '';\n\t\t$row['show_fic_room'] = '';\n\t\t$row['active_ressource_empruntee'] = 'n';\n\t\t$row['active_cle'] = 'n';\n\t\t$area_name = grr_sql_query1(\"select area_name from \".TABLE_PREFIX.\"_area where id='\".$area_id.\"'\");\n\t\techo \"<h2>\".get_vocab(\"match_area\").get_vocab('deux_points').\" \".$area_name.\"<br />\".get_vocab(\"addroom\").\"</h2>\\n\";\n\t}\n    echo '<form enctype=\"multipart/form-data\" action=\"admin_edit_room.php\" method=\"post\">';\n\techo \"<div>\";\n\t\tif (isset($action))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"duplique_room\\\" />\\n\";\n\t\tif ($row[\"id\"] != '')\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"room\\\" value=\\\"\".$row[\"id\"].\"\\\" />\\n\";\n\t\tif (isset($retour_page))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"retour_page\\\" value=\\\"\".$retour_page.\"\\\" />\\n\";\n\techo \"</div>\";\n    $nom_picture = '';\n    if ($row['picture_room'] != '') $nom_picture = \"../images/\".$row['picture_room'];\n    if (Settings::get(\"use_fckeditor\") == 1)\n        echo \"<script type=\\\"text/javascript\\\" src=\\\"../js/ckeditor/ckeditor.js\\\"></script>\\n\";\n    echo \"<table class='table table-bordered'>\\n\";\n\techo \"<tr><td>\".get_vocab(\"name\").get_vocab(\"deux_points\").\"</td><td>\\n\";\n    // seul l'administrateur peut modifier le nom de la ressource\n    if ((authGetUserLevel(getUserName(),$area_id,\"area\") >= 4) || (authGetUserLevel(getUserName(),$room) >= 4))\n        echo \"<input type=\\\"text\\\" name=\\\"room_name\\\" maxlength=\\\"60\\\" size=\\\"40\\\" value=\\\"\".htmlspecialchars($row[\"room_name\"]).\"\\\" />\\n\";\n    else\n    {\n        echo \"<input type=\\\"hidden\\\" name=\\\"room_name\\\" value=\\\"\".htmlspecialchars($row[\"room_name\"]).\"\\\" />\\n\";\n        echo \"<b>\".htmlspecialchars($row[\"room_name\"]).\"</b>\\n\";\n    }\n    echo \"</td></tr>\\n\";\n    // Description\n    echo \"<tr><td>\".get_vocab(\"description\").\"</td><td><input type=\\\"text\\\" name=\\\"description\\\"  maxlength=\\\"60\\\" size=\\\"40\\\" value=\\\"\".htmlspecialchars($row[\"description\"]).\"\\\" /></td></tr>\\n\";\n    // Domaine\n    $enable_periods = grr_sql_query1(\"select enable_periods from \".TABLE_PREFIX.\"_area where id='\".$area_id.\"'\");\n    if (((authGetUserLevel(getUserName(),$area_id,\"area\") >=4 ) || (authGetUserLevel(getUserName(),$room) >= 4)) && ($enable_periods == 'n'))\n    {    // les creneaux sont bases sur le temps : on ne peut pas changer une ressource de domaine\n        if(authGetUserLevel(getUserName(),-1,'area') >= 6)\n            $sql = \"SELECT id,area_name\n        FROM \".TABLE_PREFIX.\"_area where enable_periods='n'\n        ORDER BY area_name ASC\";\n        else if (authGetUserLevel(getUserName(),$area_id,'area') == 5)\n            $sql = \"SELECT distinct a.id, a.area_name\n        FROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j, \".TABLE_PREFIX.\"_site s,  \".TABLE_PREFIX.\"_j_useradmin_site u\n        WHERE a.id=j.id_area and u.id_site=j.id_site  and s.id=u.id_site and u.login='\".getUserName().\"'  and  enable_periods='n'\n        ORDER BY a.area_name ASC\";\n        else\n            $sql = \"SELECT id,area_name\n        FROM \".TABLE_PREFIX.\"_area a,  \".TABLE_PREFIX.\"_j_useradmin_area u\n        WHERE a.id=u.id_area and u.login='\".getUserName().\"' and  a.enable_periods='n'\n        ORDER BY a.area_name ASC\";\n        $res = grr_sql_query($sql);\n        $nb_area = grr_sql_count($res);\n        if ($nb_area > 1)\n        {\n            echo \"<tr><td>\".get_vocab('match_area').get_vocab('deux_points').\"</td>\\n\";\n            echo \"<td><select class=\\\"form-control\\\" name=\\\"area_id\\\" >\\n\n            <option value=\\\"-1\\\">\".get_vocab('choose_an_area').\"</option>\\n\";\n            for ($enr = 0; ($row1 = grr_sql_row($res, $enr)); $enr++)\n            {\n                echo \"<option value=\\\"\".$row1[0].\"\\\"\";\n                if ($area_id == $row1[0])\n                    echo ' selected=\"selected\"';\n                echo '>'.htmlspecialchars($row1[1]);\n                echo '</option>'.\"\\n\";\n            }\n        grr_sql_free($res);\n        echo \"</select></td></tr>\";\n        }\n        else\n        {\n            if (isset($area_id))\n                echo \"<input type=\\\"hidden\\\" name=\\\"area_id\\\" value=\\\"\".$area_id.\"\\\" />\\n\";\n        }\n    }\n    else\n    {  \t// les creneaux sont bases sur les intitules : on ne peut pas changer une ressource de domaine\n        if (isset($area_id))\n            echo \"<input type=\\\"hidden\\\" name=\\\"area_id\\\" value=\\\"\".$area_id.\"\\\" />\\n\";\n    }\n    // Ordre d'affichage du domaine\n    echo \"<tr><td>\".get_vocab(\"order_display\").get_vocab(\"deux_points\").\"</td>\\n\";\n    echo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"area_order\\\" size=\\\"1\\\" value=\\\"\".htmlspecialchars($row[\"order_display\"]).\"\\\" /></td>\\n\";\n    echo \"</tr>\\n\";\n    // Qui peut voir cette ressource\n    echo \"<tr><td colspan=\\\"2\\\">\".get_vocab(\"qui_peut_voir_ressource\").\"<br />\\n\";\n    echo \"<select class=\\\"form-control\\\" name=\\\"who_can_see\\\" size=\\\"1\\\">\\n\n    <option value=\\\"0\\\" \";\n    if ($row[\"who_can_see\"] == 0)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description0\").\"</option>\\n<option value=\\\"1\\\" \";\n    if ($row[\"who_can_see\"] == 1)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description1\").\"</option>\\n<option value=\\\"2\\\" \";\n    if ($row[\"who_can_see\"] == 2)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description2\").\"</option>\\n<option value=\\\"3\\\" \";\n    if ($row[\"who_can_see\"] == 3)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description3\").\"</option>\\n<option value=\\\"4\\\" \";\n    if ($row[\"who_can_see\"] == 4)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description4\").\"</option>\\n\";\n    if (Settings::get(\"module_multisite\") != \"Oui\")\n    {\n        echo \"<option value=\\\"5\\\" \";\n        if ($row[\"who_can_see\"] == 5)\n            echo \" selected=\\\"selected\\\" \";\n        echo \">\".get_vocab(\"visu_fiche_description5\").\"</option>\\n\";\n    };\n    echo \"<option value=\\\"6\\\" \";\n    if ($row[\"who_can_see\"] == 6)\n        echo \" selected=\\\"selected\\\" \";\n    echo \">\".get_vocab(\"visu_fiche_description6\").\"</option>\\n</select></td></tr>\\n\";\n    // Declarer ressource indisponible\n    echo \"<tr><td>\".get_vocab(\"declarer_ressource_indisponible\").\"<br /><i>\".get_vocab(\"explain_max_booking\").\"</i></td><td><input type=\\\"checkbox\\\" name=\\\"statut_room\\\" \";\n    if ($row['statut_room'] == \"0\")\n        echo \" checked=\\\"checked\\\" \";\n    echo \"/></td></tr>\\n\";\n    // Afficher la fiche de presentation de la ressource\n    echo \"<tr><td>\".get_vocab(\"montrer_fiche_presentation_ressource\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"show_fic_room\\\" \";\n    if ($row['show_fic_room'] == \"y\")\n        echo \" checked=\\\"checked\\\" \";\n    echo \"/><a href='javascript:centrerpopup(\\\"../view_room.php?id_room=$room\\\",600,480,\\\"scrollbars=yes,statusbar=no,resizable=yes\\\")' title=\\\"\".get_vocab(\"fiche_ressource\").\"\\\"><span class=\\\"glyphicon glyphicon-search\\\"></span></a></td></tr>\\n\";\n    // Choix de l'image de la ressource\n    echo \"<tr><td>\".get_vocab(\"choisir_image_ressource\").\"</td><td><input type=\\\"file\\\" name=\\\"doc_file\\\" size=\\\"30\\\" /></td></tr>\\n\";\n    echo \"<tr><td>\".get_vocab(\"supprimer_image_ressource\").get_vocab(\"deux_points\");\n    if (@file_exists($nom_picture))\n    {\n        echo \"<b>$nom_picture</b></td><td><input type=\\\"checkbox\\\" name=\\\"sup_img\\\" /></td></tr>\";}\n    else\n        echo \"<b>\".get_vocab(\"nobody\").\"</b></td><td><input type=\\\"checkbox\\\" disabled=\\\"disabled\\\" name=\\\"sup_img\\\" /></td></tr>\";\n    echo \"<tr><td>\".get_vocab(\"Afficher_description_complete_dans_titre_plannings\").\"</td>\\n<td><input type=\\\"checkbox\\\" name=\\\"show_comment\\\" \";\n    if ($row['show_comment'] == \"y\")\n        echo \" checked \";\n    echo \"/></td></tr>\\n\";\n    // Description complete\n    echo \"<tr><td colspan=\\\"2\\\">\".get_vocab(\"description complete\");\n    if (Settings::get(\"use_fckeditor\") != 1)\n        echo \" \".get_vocab(\"description complete2\");\n    echo get_vocab(\"deux_points\").\"<br />\";\n    if (Settings::get(\"use_fckeditor\") == 1)\n    {\n        echo \"<textarea class=\\\"ckeditor\\\" id=\\\"editor1\\\" name=\\\"comment_room\\\" rows=\\\"8\\\" cols=\\\"120\\\">\\n\";\n        echo htmlspecialchars($row['comment_room']);\n        echo \"</textarea>\\n\";\n            ?>\n            <script type=\"text/javascript\">\n                CKEDITOR.replace( 'editor1',\n                {\n                    toolbar :\n                    [\n                    ['Source'],\n                    ['Cut','Copy','Paste','PasteText','PasteFromWord', 'SpellChecker', 'Scayt'],\n                    ['Undo','Redo','-','Find','Replace','-','SelectAll','RemoveFormat'],\n                    ['Bold','Italic','Underline','Strike','-','Subscript','Superscript'],\n                    ['NumberedList','BulletedList','-','Outdent','Indent','Blockquote'],\n                    ['JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'],\n                    ['Link','Unlink','Anchor'],\n                    ['Image','Table','HorizontalRule','SpecialChar','PageBreak'],\n                    ]\n                });\n            </script>\n            <?php\n        }\n        else\n            echo \"<textarea class=\\\"form-control\\\" name=\\\"comment_room\\\" rows=\\\"8\\\" cols=\\\"120\\\" >\".$row['comment_room'].\"</textarea>\";\n        echo \"</td></tr></table>\\n\";\n        echo \"<h3>\".get_vocab(\"configuration_ressource\").\"</h3>\\n\";\n// Type d'affichage : duree ou heure/date de fin de reservation\n        echo \"<table class='table table-bordered'>\\n\";\n\t\t\techo \"<tr><td>\".get_vocab(\"type_affichage_reservation\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td>\";\n\t\t\techo \"<label><input type=\\\"radio\\\" name=\\\"type_affichage_reser\\\" value=\\\"0\\\" \";\n\t\t\tif (($row[\"type_affichage_reser\"]) == 0)\n\t\t\t\techo \" checked=\\\"checked\\\" \";\n\t\t\techo \"/>\";\n\t\t\techo get_vocab(\"affichage_reservation_duree\");\n\t\t\techo \"</label><br /><label><input type=\\\"radio\\\" name=\\\"type_affichage_reser\\\" value=\\\"1\\\" \";\n\t\t\tif (($row[\"type_affichage_reser\"]) == 1)\n\t\t\t\techo \" checked=\\\"checked\\\" \";\n\t\t\techo \"/>\";\n\t\t\techo get_vocab(\"affichage_reservation_date_heure\");\n\t\t\techo \"</label></td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\n\t// Capacite\n\t\t\techo \"<tr><td>\".get_vocab(\"capacity\").\": </td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"capacity\\\" size=\\\"1\\\" value=\\\"\".$row[\"capacity\"].\"\\\" /></td></tr>\\n\";\n\t// seuls les administrateurs de la ressource peuvent modifier le nombre max de reservation par utilisateur\n\t\t\tif ((authGetUserLevel(getUserName(),$area_id,\"area\") >= 4) || (authGetUserLevel(getUserName(),$room) >= 4))\n\t\t\t{\n\t\t\t\techo \"<tr><td>\".get_vocab(\"max_booking\").\" \";\n\t\t\t\techo \"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"max_booking\\\" size=\\\"1\\\" value=\\\"\".$row[\"max_booking\"].\"\\\" /></td></tr>\";\n\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tif ($row[\"max_booking\"] != \"-1\")\n\t\t\t\t\techo \"<tr><td>\".get_vocab(\"msg_max_booking\").get_vocab(\"deux_points\").\"</td><td><b>\".htmlspecialchars($row[\"max_booking\"]).\"</b></td></tr>\";\n\t\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"max_booking\\\" value=\\\"\".$row[\"max_booking\"].\"\\\" />\";\n\t\t\t}\n// L'utilisateur ne peut pas reserver au-del\u00e0 d'un certain temps\n\t\t\techo \"<tr><td>\".get_vocab(\"delais_max_resa_room\").\": </td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"delais_max_resa_room\\\" size=\\\"1\\\" value=\\\"\".$row[\"delais_max_resa_room\"].\"\\\" /></td></tr>\\n\";\n// L'utilisateur ne peut pas reserver en-dessous d'un certain temps\n\t\t\techo \"<tr><td>\".get_vocab(\"delais_min_resa_room\").\": \";\n\t\t\techo \"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"delais_min_resa_room\\\" size=\\\"5\\\" value=\\\"\".$row[\"delais_min_resa_room\"].\"\\\" /></td></tr>\\n\";\n// L'utilisateur peut poser poser une option de reservation\n\t\t\techo \"<tr><td>\".get_vocab(\"msg_option_de_reservation\").\"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"delais_option_reservation\\\" size=\\\"5\\\" value=\\\"\".$row[\"delais_option_reservation\"].\"\\\" /></td></tr>\\n\";\n// Les demandes de reservations sont moder\u00e9es\n\t\t\techo \"<tr><td>\".get_vocab(\"msg_moderation_reservation\").get_vocab(\"deux_points\");\n\t\t\techo \"</td>\" .\"<td><input type='checkbox' name='moderate' \";\n\t\t\tif ($row['moderate'])\n\t\t\t\techo 'checked=\"checked\"';\n\t\t\techo \" /></td></tr>\\n\";\n// L'utilisateur peut reserver dans le passe\n\t\t\techo \"<tr><td>\".get_vocab(\"allow_action_in_past\").\"<br /><i>\".get_vocab(\"allow_action_in_past_explain\").\"</i></td><td><input type=\\\"checkbox\\\" name=\\\"allow_action_in_past\\\" value=\\\"y\\\" \";\n\t\t\tif ($row[\"allow_action_in_past\"] == 'y')\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" /></td></tr>\\n\";\n\t// L'utilisateur ne peut pas modifier ou supprimer ses propres reservations\n\t\t\techo \"<tr><td>\".get_vocab(\"dont_allow_modify\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"dont_allow_modify\\\" value=\\\"y\\\" \";\n\t\t\tif ($row[\"dont_allow_modify\"] == 'y')\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" /></td></tr>\\n\";\n\t// Quels utilisateurs ont le droit de reserver cette ressource au nom d'un autre utilisateur ?\n\t\t\techo \"<tr><td>\".get_vocab(\"qui peut reserver pour autre utilisateur\").\"</td><td><select class=\\\"form-control\\\" name=\\\"qui_peut_reserver_pour\\\" size=\\\"1\\\">\\n<option value=\\\"5\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==6)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"personne\").\"</option>\\n\n\t\t\t<option value=\\\"4\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==4)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"les administrateurs restreints\").\"</option>\\n\n\t\t\t<option value=\\\"3\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==3)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"les gestionnaires de la ressource\").\"</option>\\n\n\t\t\t<option value=\\\"2\\\" \";\n\t\t\tif ($row[\"qui_peut_reserver_pour\"]==2)\n\t\t\t\techo \" selected=\\\"selected\\\" \";\n\t\t\techo \">\".get_vocab(\"tous les utilisateurs\").\"</option>\\n\n\t\t</select></td></tr>\\n\";\n// Activer la fonctionalite \"ressource empruntee/restituee\"\n\t\techo \"<tr><td>\".get_vocab(\"activer_fonctionalite_ressource_empruntee_restituee\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"active_ressource_empruntee\\\" \";\n\t\tif ($row['active_ressource_empruntee'] == \"y\")\n\t\t\techo \" checked=\\\"checked\\\" \";\n\t\techo \"/></td></tr>\\n\";\n// Activer la gestion des cl\u00e9s\n\t\techo \"<tr><td>\".get_vocab(\"activer_fonctionalite_gestion_cle\").\"</td><td><input type=\\\"checkbox\\\" name=\\\"active_cle\\\" \";\n\t\tif ($row['active_cle'] == \"y\")\n\t\t\techo \" checked=\\\"checked\\\" \";\n\t\techo \"/></td></tr>\\n\";\n\t//\n\t\techo \"</table>\\n\";\n\t\tHook::Appel(\"hookEditRoom1\");\n\t\techo \"<div style=\\\"text-align:center;\\\"><br />\\n\";\n\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_room\\\"  value=\\\"\".get_vocab(\"save\").\"\\\" />\\n\";\n\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_done\\\" value=\\\"\".get_vocab(\"back\").\"\\\" />\\n\";\n\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_room_and_back\\\" value=\\\"\".get_vocab(\"save_and_back\").\"\\\" />\";\n\t\tif (@file_exists($nom_picture) && $nom_picture)\n\t\t\techo \"<br /><br /><b>\".get_vocab(\"Image de la ressource\").get_vocab(\"deux_points\").\"</b><br /><img src=\\\"\".$nom_picture.\"\\\" alt=\\\"logo\\\" />\";\n\t\telse\n\t\t\techo \"<br /><br /><b>\".get_vocab(\"Pas image disponible\").\"</b>\";\n\techo \"</div>\";\n    echo \"</form>\";\n    echo \"</div>\";\n}\n// Ajout ou modification d'un domaine\nif ((!empty($id_area)) || (isset($add_area)))\n{\n\tif (isset($change_area))\n\t{\n\t// Affectation e un site : si aucun site n'a ete affecte\n\t\tif ((Settings::get(\"module_multisite\") == \"Oui\") && ($id_site == -1))\n\t\t{\n\t  \t\t// On affiche un message d'avertissement\n\t\t\t?>\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\talert(\"<?php echo get_vocab('choose_a_site'); ?>\");\n\t\t\t</script>\n\t\t\t<?php\n\t  \t\t// On empeche le retour e la page admin_room\n\t\t\tunset($change_done);\n\t\t}\n\t\telse\n\t\t{\n\t  \t\t// Un site a ete affecte, on peut continuer\n\t \t\t// la valeur par defaut ne peut etre inferiure au plus petit bloc reservable\n\t\t\tif ($_POST['duree_par_defaut_reservation_area'] < $_POST['resolution_area'])\n\t\t\t\t$_POST['duree_par_defaut_reservation_area'] = $_POST['resolution_area'];\n\t\t\t// la valeur par defaut doit etre un multiple du plus petit bloc reservable\n\t\t\t$_POST['duree_par_defaut_reservation_area'] = intval($_POST['duree_par_defaut_reservation_area'] / $_POST['resolution_area']) * $_POST['resolution_area'];\n\t  \t\t// Duree maximale de reservation\n\t\t\tif (isset($_POST['enable_periods']))\n\t\t\t{\n\t\t\t\tif ($_POST['enable_periods'] == 'y')\n\t\t\t\t\t$duree_max_resa_area = $duree_max_resa_area2 * 1440;\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$duree_max_resa_area = $duree_max_resa_area1;\n\t\t\t\t\tif ($duree_max_resa_area >= 0)\n\t\t\t\t\t\t$duree_max_resa_area = max ($duree_max_resa_area, $_POST['resolution_area'] / 60, $_POST['duree_par_defaut_reservation_area'] / 60);\n\t\t\t\t}\n\t\t\t\tsettype($duree_max_resa_area, \"integer\");\n\t\t\t\tif ($duree_max_resa_area < 0)\n\t\t\t\t\t$duree_max_resa_area = -1;\n\t\t\t}\n\n\t\t\t$display_days = \"\";\n\t\t\tfor ($i = 0; $i < 7; $i++)\n\t\t\t{\n\t\t\t\tif (isset($_POST['display_day'][$i]))\n\t\t\t\t\t$display_days .= \"y\";\n\t\t\t\telse\n\t\t\t\t\t$display_days .= \"n\";\n\t\t\t}\n\t\t\tif ($display_days != \"nnnnnnn\")\n\t\t\t{\n\t\t\t\twhile (!isset($_POST['display_day'][$_POST['weekstarts_area']]))\n\t\t\t\t\t$_POST['weekstarts_area']++;\n\t\t\t}\n\t\t\tif ($_POST['morningstarts_area'] > $_POST['eveningends_area'])\n\t\t\t\t$_POST['eveningends_area'] = $_POST['morningstarts_area'];\n\t\t\tif ($access)\n\t\t\t\t$access='r';\n\t\t\telse\n\t\t\t\t$access='a';\n\t\t\tif ((isset($id_area)) && !((isset($action) && ($action == \"duplique_area\"))))\n\t\t\t{\n\t\t\t\t// s'il y a changement de type de creneaux, on efface les reservations du domaines\n\t\t\t\t$old_enable_periods = grr_sql_query1(\"select enable_periods from \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n\t\t\t\tif ($old_enable_periods != $_POST['enable_periods'])\n\t\t\t\t{\n\t\t\t\t\t$del = grr_sql_query(\"DELETE \".TABLE_PREFIX.\"_entry FROM \".TABLE_PREFIX.\"_entry, \".TABLE_PREFIX.\"_room, \".TABLE_PREFIX.\"_area WHERE\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_entry.room_id = \".TABLE_PREFIX.\"_room.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_room.area_id = \".TABLE_PREFIX.\"_area.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_area.id = '\".$id_area.\"'\");\n\t\t\t\t\t$del = grr_sql_query(\"DELETE \".TABLE_PREFIX.\"_repeat FROM \".TABLE_PREFIX.\"_repeat, \".TABLE_PREFIX.\"_room, \".TABLE_PREFIX.\"_area WHERE\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_repeat.room_id = \".TABLE_PREFIX.\"_room.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_room.area_id = \".TABLE_PREFIX.\"_area.id and\n\t\t\t\t\t\t\".TABLE_PREFIX.\"_area.id = '\".$id_area.\"'\");\n\t\t\t\t}\n\t\t\t\t$sql = \"UPDATE \".TABLE_PREFIX.\"_area SET\n\t\t\t\tarea_name='\".protect_data_sql($area_name).\"',\n\t\t\t\taccess='\".protect_data_sql($access).\"',\n\t\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\t\tip_adr='\".protect_data_sql($ip_adr).\"',\n\t\t\t\tcalendar_default_values = 'n',\n\t\t\t\tduree_max_resa_area = '\".protect_data_sql($duree_max_resa_area).\"',\n\t\t\t\tmorningstarts_area = '\".protect_data_sql($_POST['morningstarts_area']).\"',\n\t\t\t\teveningends_area = '\".protect_data_sql($_POST['eveningends_area']).\"',\n\t\t\t\tresolution_area = '\".protect_data_sql($_POST['resolution_area']).\"',\n\t\t\t\tduree_par_defaut_reservation_area = '\".protect_data_sql($_POST['duree_par_defaut_reservation_area']).\"',\n\t\t\t\teveningends_minutes_area = '\".protect_data_sql($_POST['eveningends_minutes_area']).\"',\n\t\t\t\tweekstarts_area = '\".protect_data_sql($_POST['weekstarts_area']).\"',\n\t\t\t\tenable_periods = '\".protect_data_sql($_POST['enable_periods']).\"',\n\t\t\t\ttwentyfourhour_format_area = '\".protect_data_sql($_POST['twentyfourhour_format_area']).\"',\n\t\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\t\tdisplay_days = '\".$display_days.\"'\n\t\t\t\tWHERE id=$id_area\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t{\n\t\t\t\t\tfatal_error(0, get_vocab('update_area_failed') . grr_sql_error());\n\t\t\t\t\t$ok = 'no';\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_area SET\n\t\t\t\tarea_name='\".protect_data_sql($area_name).\"',\n\t\t\t\taccess='\".protect_data_sql($access).\"',\n\t\t\t\torder_display='\".protect_data_sql($area_order).\"',\n\t\t\t\tip_adr='\".protect_data_sql($ip_adr).\"',\n\t\t\t\tcalendar_default_values = 'n',\n\t\t\t\tduree_max_resa_area = '\".protect_data_sql($duree_max_resa_area).\"',\n\t\t\t\tmorningstarts_area = '\".protect_data_sql($_POST['morningstarts_area']).\"',\n\t\t\t\teveningends_area = '\".protect_data_sql($_POST['eveningends_area']).\"',\n\t\t\t\tresolution_area = '\".protect_data_sql($_POST['resolution_area']).\"',\n\t\t\t\tduree_par_defaut_reservation_area = '\".protect_data_sql($_POST['duree_par_defaut_reservation_area']).\"',\n\t\t\t\teveningends_minutes_area = '\".protect_data_sql($_POST['eveningends_minutes_area']).\"',\n\t\t\t\tweekstarts_area = '\".protect_data_sql($_POST['weekstarts_area']).\"',\n\t\t\t\tenable_periods = '\".protect_data_sql($_POST['enable_periods']).\"',\n\t\t\t\ttwentyfourhour_format_area = '\".protect_data_sql($_POST['twentyfourhour_format_area']).\"',\n\t\t\t\tdisplay_days = '\".$display_days.\"',\n\t\t\t\tmax_booking='\".$max_booking.\"',\n\t\t\t\tid_type_par_defaut = '-1'\n\t\t\t\t\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t\t\t$id_area = grr_sql_insert_id();\n\t\t\t}\n\t  \t\t// Affectation e un site\n\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t{\n\t\t\t\t$sql = \"delete from \".TABLE_PREFIX.\"_j_site_area where id_area='\".$id_area.\"'\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t\tfatal_error(0, \"<p>\".grr_sql_error().\"</p>\");\n\t\t\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_j_site_area SET id_site='\".$id_site.\"', id_area='\".$id_area.\"'\";\n\t\t\t\tif (grr_sql_command($sql) < 0)\n\t\t\t\t\tfatal_error(0, \"<p>\".grr_sql_error().\"</p>\");\n\t\t\t}\n\t\t\t#Si area_name est vide on le change maintenant que l'on a l'id area\n\t\t\tif ($area_name == '')\n\t\t\t{\n\t\t\t\t$area_name = get_vocab(\"match_area\").\" \".$id_area;\n\t\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_area SET area_name='\".protect_data_sql($area_name).\"' WHERE id=$id_area\");\n\t\t\t}\n\t\t  \t#on cree ou recree \".TABLE_PREFIX.\"_area_periodes pour le domaine\n\t\t\tif (protect_data_sql($_POST['enable_periods']) == 'y')\n\t\t\t{\n\t\t\t\tif (isset($number_periodes))\n\t\t\t\t{\n\t\t\t\t\tsettype($number_periodes, \"integer\");\n\t\t\t\t\tif ($number_periodes < 1)\n\t\t\t\t\t\t$number_periodes = 1;\n\t\t\t\t\t$del_periode = grr_sql_query(\"delete from \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"'\");\n\t\t  \t\t\t#on efface le modele par defaut avec area=0\n\t\t\t\t\t$del_periode = grr_sql_query(\"delete from \".TABLE_PREFIX.\"_area_periodes where id_area='0'\");\n\t\t\t\t\t$i = 0;\n\t\t\t\t\t$num = 0;\n\t\t\t\t\twhile ($i < $number_periodes)\n\t\t\t\t\t{\n\t\t\t\t\t\t$temp = \"periode_\".$i;\n\t\t\t\t\t\tif (isset($_POST[$temp]))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$nom_periode = corriger_caracteres($_POST[$temp]);\n\t\t\t\t\t\t\t$reg_periode = grr_sql_query(\"insert into \".TABLE_PREFIX.\"_area_periodes set\n\t\t\t\t\t\t\t\tid_area='\".$id_area.\"',\n\t\t\t\t\t\t\t\tnum_periode='\".$num.\"',\n\t\t\t\t\t\t\t\tnom_periode='\".protect_data_sql($nom_periode).\"'\n\t\t\t\t\t\t\t\t\");\n\t\t\t  \t\t\t\t#on cree un modele par defaut avec area=0\n\t\t\t\t\t\t\t$reg_periode = grr_sql_query(\"insert into \".TABLE_PREFIX.\"_area_periodes set\n\t\t\t\t\t\t\t\tid_area='0',\n\t\t\t\t\t\t\t\tnum_periode='\".$num.\"',\n\t\t\t\t\t\t\t\tnom_periode='\".protect_data_sql($nom_periode).\"'\");\n\t\t\t\t\t\t\t$num++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$i++;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$msg = get_vocab(\"message_records\");\n\t\t}\n\t}\n\tif ($access=='a')\n\t{\n\t\t$sql = \"DELETE FROM \".TABLE_PREFIX.\"_j_user_area WHERE id_area='$id_area'\";\n\t\tif (grr_sql_command($sql) < 0)\n\t\t\tfatal_error(0, get_vocab('update_area_failed') . grr_sql_error());\n\t}\n\tif ((isset($change_done)) && (!isset($ok)))\n\t{\n\t\tif ($msg != '') {\n\t\t\t$_SESSION['displ_msg'] = 'yes';\n\t\t\tif (strpos($retour_page, \".php?\") == \"\")\n\t\t\t\t$param = \"?msg=\".$msg;\n\t\t\telse\n\t\t\t\t$param = \"&msg=\".$msg;\n\t\t} else\n\t\t$param = '';\n\t\tHeader(\"Location: \".$retour_page.$param);\n\t\texit();\n\t}\n  \t# print the page header\n\tstart_page_w_header(\"\", \"\", \"\", $type=\"with_session\");\n\taffiche_pop_up($msg,\"admin\");\n\t$avertissement = get_vocab(\"avertissement_change_type\");\n\tinclude \"admin_col_gauche2.php\";\n\t?>\n\t<script type=\"text/javascript\">\n\t\tfunction bascule()\n\t\t{\n\t\t\tmenu_1 = document.getElementById('menu1');\n\t\t\tmenu_2 = document.getElementById('menu2');\n\t\t\tif (document.getElementById('main').enable_periods[0].checked)\n\t\t\t{\n\t\t\t\tmenu_1.style.display = \"\";\n\t\t\t\tmenu_2.style.display = \"none\";\n\t\t\t}\n\t\t\tif (document.getElementById('main').enable_periods[1].checked)\n\t\t\t{\n\t\t\t\tmenu_1.style.display = \"none\";\n\t\t\t\tmenu_2.style.display = \"\";\n\t\t\t}\n\t\t\talert(\"<?php echo $avertissement; ?>\");\n\t\t}\n\n\t\tfunction aff_creneaux()\n\t\t{\n\t\t\tnb_cr = document.getElementById('nb_per');\n\t\t\tif (isNaN(Number(nb_cr.value)))\n\t\t\t\tnb_cr.value = 1;\n\t\t\tif (nb_cr.value > 50)\n\t\t\t\tnb_cr.value = 50;\n\t\t\tif (nb_cr.value < 1)\n\t\t\t\tnb_cr.value = 1;\n\t\t\tfor (var i = 1; i <= nb_cr.value; i++)\n\t\t\t{\n\t\t\t\tdocument.getElementById('c' + i).style.display = '';\n\t\t\t}\n\t\t\tfor (var i; i <= 50; i++)\n\t\t\t{\n\t\t\t\tdocument.getElementById('c' + i).style.display = 'none';\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t</script>\n\t<?php\n\techo \"<div class=\\\"col-md-9 col-sm-8 col-xs-12\\\">\";\n\tif (isset($id_area))\n\t{\n\t\t$res = grr_sql_query(\"SELECT * FROM \".TABLE_PREFIX.\"_area WHERE id=$id_area\");\n\t\tif (! $res)\n\t\t\tfatal_error(0, get_vocab('error_area') . $id_area . get_vocab('not_found'));\n\t\t$row = grr_sql_row_keyed($res, 0);\n\t\tgrr_sql_free($res);\n\t\tif ($action==\"duplique_area\")\n\t\t\techo \"<h2>\".get_vocab(\"duplique_domaine\").\"</h2>\";\n\t\telse\n\t\t\techo \"<h2>\".get_vocab(\"editarea\").\"</h2>\";\n\t\tif ($row[\"calendar_default_values\"] == 'y')\n\t\t{\n\t\t\t$row[\"morningstarts_area\"] = $morningstarts;\n\t\t\t$row[\"eveningends_area\"] = $eveningends;\n\t\t\t$row[\"resolution_area\"] = $resolution;\n\t\t\t$row[\"duree_par_defaut_reservation_area\"] = $duree_par_defaut_reservation_area;\n\t\t\t$row[\"duree_max_resa_area\"] = $duree_max_resa;\n\t\t\t$row[\"eveningends_minutes_area\"] = $eveningends_minutes;\n\t\t\t$row[\"weekstarts_area\"] = $weekstarts;\n\t\t\t$row[\"twentyfourhour_format_area\"] = $twentyfourhour_format;\n\t\t\t$row[\"display_days\"] = $display_days;\n\t\t}\n\t\tif ($row[\"enable_periods\"] != 'y')\n\t\t\t$row[\"enable_periods\"] = 'n';\n\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t$id_site=grr_sql_query1(\"select id_site from \".TABLE_PREFIX.\"_j_site_area where id_area='\".$id_area.\"'\");\n\t}\n\telse\n\t{\n\t\t$row[\"id\"] = '';\n\t\t$row[\"area_name\"] = '';\n\t\t$row[\"order_display\"]  = '';\n\t\t$row[\"access\"] = '';\n\t\t$row[\"ip_adr\"] = '';\n\t\t$row[\"morningstarts_area\"] = $morningstarts;\n\t\t$row[\"eveningends_area\"] = $eveningends;\n\t\t$row[\"resolution_area\"] = $resolution;\n\t\t$row[\"duree_par_defaut_reservation_area\"] = $resolution;\n\t\t$row[\"duree_max_resa_area\"] = $duree_max_resa;\n\t\t$row[\"eveningends_minutes_area\"] = $eveningends_minutes;\n\t\t$row[\"weekstarts_area\"] = $weekstarts;\n\t\t$row[\"twentyfourhour_format_area\"] = $twentyfourhour_format;\n\t\t$row[\"enable_periods\"] = 'n';\n\t\t$row[\"display_days\"] = \"yyyyyyy\";\n\t\t$row['max_booking'] = '-1';\n\t\techo \"<h2>\".get_vocab('addarea').\"</h2>\";\n\t}\n\techo '<form action=\"admin_edit_room.php\" method=\"post\" id=\"main\">';\n\techo \"<div>\";\n\t\tif (isset($action))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"action\\\" value=\\\"duplique_area\\\" />\\n\";\n\t\tif (isset($retour_page))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"retour_page\\\" value=\\\"\".$retour_page.\"\\\" />\";\n\t\tif ($row['id'] != '')\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"id_area\\\" value=\\\"\".$row[\"id\"].\"\\\" />\";\n\t\tif (isset($add_area))\n\t\t\techo \"<input type=\\\"hidden\\\" name=\\\"add_area\\\" value=\\\"\".$add_area.\"\\\" />\\n\";\n\t\techo \"</div>\";\n\t\techo \"<table class='table table-bordered'><tr>\";\n\t\t// Nom du domaine\n\t\techo \"<td>\".get_vocab(\"name\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td style=\\\"width:30%;\\\"><input type=\\\"text\\\" name=\\\"area_name\\\" maxlength=\\\"30\\\" size=\\\"40\\\" value=\\\"\".htmlspecialchars($row[\"area_name\"]).\"\\\" /></td>\\n\";\n\t\techo \"</tr><tr>\\n\";\n\t\t// Ordre d'affichage du domaine\n\t\techo \"<td>\".get_vocab(\"order_display\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td><input type=\\\"text\\\" name=\\\"area_order\\\" size=\\\"1\\\" value=\\\"\".htmlspecialchars($row[\"order_display\"]).\"\\\" /></td>\\n\";\n\t\techo \"</tr><tr>\\n\";\n\t\t// Acces restreint ou non ?\n\t\techo \"<td>\".get_vocab(\"access\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td><input type=\\\"checkbox\\\" name=\\\"access\\\"\";\n\t\tif ($row[\"access\"] == 'r')\n\t\t\techo \"checked=\\\"checked\\\"\";\n\t\techo \" /></td>\\n\";\n\t\techo \"</tr>\";\n\t\t// Site\n\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t{\n\t  \t// Affiche une liste deroulante des sites;\n\t\t\tif (authGetUserLevel(getUserName(), -1, 'area') >= 6)\n\t\t\t\t$sql = \"SELECT id,sitecode,sitename\n\t\t\tFROM \".TABLE_PREFIX.\"_site\n\t\t\tORDER BY sitename ASC\";\n\t\t\telse\n\t\t\t\t$sql = \"SELECT id,sitecode,sitename\n\t\t\tFROM \".TABLE_PREFIX.\"_site s,  \".TABLE_PREFIX.\"_j_useradmin_site u\n\t\t\tWHERE s.id=u.id_site and u.login='\".getUserName().\"'\n\t\t\tORDER BY s.sitename ASC\";\n\t\t\t$res = grr_sql_query($sql);\n\t\t\t$nb_site = grr_sql_count($res);\n\t\t\techo \"<tr><td>\".get_vocab('site').get_vocab('deux_points').\"</td>\\n\";\n\t\t\tif ($nb_site > 1)\n\t\t\t{\n\t\t\t\techo \"<td><select class=\\\"form-control\\\" name=\\\"id_site\\\" >\\n\n\t\t\t\t<option value=\\\"-1\\\">\".get_vocab('choose_a_site').\"</option>\\n\";\n\t\t\t\tfor ($enr = 0; ($row1 = grr_sql_row($res, $enr)); $enr++)\n\t\t\t\t{\n\t\t\t\t\techo \"<option value=\\\"\".$row1[0].\"\\\"\";\n\t\t\t\t\tif ($id_site == $row1[0])\n\t\t\t\t\t\techo ' selected=\"selected\"';\n\t\t\t\t\techo '>'.htmlspecialchars($row1[2]);\n\t\t\t\t\techo '</option>'.\"\\n\";\n\t\t\t\t}\n\t\t\t\tgrr_sql_free($res);\n\t\t\t\techo \"</select></td></tr>\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t// un seul site\n\t\t\t\t$row1 = grr_sql_row($res, 0);\n\t\t\t\techo \"<td>\".$row1[2].\"<input type=\\\"hidden\\\" name=\\\"id_site\\\" value=\\\"\".$id_site.\"\\\" /></td></tr>\\n\";\n\t\t\t}\n\t\t}\n\t\t// Adresse IP client :\n\t\tif (OPTION_IP_ADR == 1)\n\t\t{\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"ip_adr\").get_vocab(\"deux_points\").\"</td>\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"ip_adr\\\" value=\\\"\".htmlspecialchars($row[\"ip_adr\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td colspan=\\\"2\\\">\".get_vocab(\"ip_adr_explain\").\"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t}\n\t\techo \"</table>\";\n\t\t// Configuration des plages horaires ...\n\t\techo \"<h3>\".get_vocab(\"configuration_plages_horaires\").\"</h3>\";\n\t\t// Debut de la semaine: 0 pour dimanche, 1 pou lundi, etc.\n\t\techo \"<table class='table table-bordered'>\";\n\t\techo \"<tr>\\n\";\n\t\techo \"<td>\".get_vocab(\"weekstarts_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\techo \"<td style=\\\"width:30%;\\\"><select class=\\\"form-control\\\" name=\\\"weekstarts_area\\\" size=\\\"1\\\">\\n\";\n\t\t$k = 0;\n\t\twhile ($k < 7)\n\t\t{\n\t\t\t$tmp=mktime(0, 0, 0, 10, 2 + $k, 2005);\n\t\t\techo \"<option value=\\\"\".$k.\"\\\" \";\n\t\t\tif ($k == $row['weekstarts_area'])\n\t\t\t\techo \" selected=\\\"selected\\\"\";\n\t\t\techo \">\".utf8_strftime(\"%A\", $tmp).\"</option>\\n\";\n\t\t\t$k++;\n\t\t}\n\t\techo \"</select></td>\\n\";\n\t\techo \"</tr>\";\n\t\t// Definition des jours de la semaine \u00e0 afficher sur les plannings et calendriers\n\t\techo \"<tr>\\n\";\n\t\techo \"<td>\".get_vocab(\"cocher_jours_a_afficher\").\"</td>\\n\";\n\t\techo \"<td>\\n\";\n\t\tfor ($i = 0; $i < 7; $i++)\n\t\t{\n\t\t\techo \"<label><input name=\\\"display_day[\".$i.\"]\\\" type=\\\"checkbox\\\"\";\n\t\t\tif (substr($row[\"display_days\"], $i, 1) == 'y')\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" />\" . day_name($i) . \"</label><br />\\n\";\n\t\t}\n\t\techo \"</td>\\n\";\n\t\techo \"</tr></table>\";\n\t\techo \"<h3>\".get_vocab(\"type_de_creneaux\").\"</h3>\";\n\t\techo \"<div class='left'>\";\n\t\t//echo \"<p style=\\\"text-align:left;\\\"><b>ATTENTION :</b> Les deux types de configuration des creneaux sont incompatibles entre eux : un changement du type de creneaux entraene donc, apres validation, un <b>effacement de toutes les reservations  de ce domaine</b></p>.\";\n\t\techo \"<label><input type=\\\"radio\\\" name=\\\"enable_periods\\\" value=\\\"n\\\" onclick=\\\"bascule()\\\" \";\n\t\tif ($row[\"enable_periods\"] == 'n')\n\t\t\techo \"checked=\\\"checked\\\"\";\n\t\techo \" />\".get_vocab(\"creneaux_de_reservation_temps\").\"</label><br />\";\n\t\techo \"<label><input type=\\\"radio\\\" name=\\\"enable_periods\\\" value=\\\"y\\\" onclick=\\\"bascule()\\\" \";\n\t\tif ($row[\"enable_periods\"] == 'y')\n\t\t\techo \"checked=\\\"checked\\\"\";\n\t\techo \" />\".get_vocab(\"creneaux_de_reservation_pre_definis\").\"</label></div>\";\n\t\t//Les creneaux de reservation sont bases sur des intitules pre-definis.\n\t\t$sql_periode = grr_sql_query(\"SELECT num_periode, nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"' order by num_periode\");\n\t\t$num_periodes = grr_sql_count($sql_periode);\n\t\tif (!isset($number_periodes))\n\t\t\tif ($num_periodes == 0)\n\t\t\t\t$number_periodes = 10;\n\t\t\telse\n\t\t\t\t$number_periodes = $num_periodes;\n\n\t\t\tif ($row[\"enable_periods\"] == 'y')\n\t\t\t\techo \"<table id=\\\"menu2\\\" class=\\\"table table-bordered\\\">\";\n\t\t\telse\n\t\t\t\techo \"<table style=\\\"display:none\\\" id=\\\"menu2\\\" class='table table-bordered'>\";\n\t\t\techo \"<tr><td>\".get_vocab(\"nombre_de_creneaux\").get_vocab(\"deux_points\").\"</td>\";\n\t\t\techo \"<td style=\\\"width:30%;\\\"><input type=\\\"text\\\" id=\\\"nb_per\\\" name=\\\"number_periodes\\\" size=\\\"1\\\" onkeypress=\\\"if (event.keyCode==13) return aff_creneaux()\\\" value=\\\"$number_periodes\\\" />\n\t\t\t<a href=\\\"#Per\\\" onclick=\\\"javascript:return(aff_creneaux())\\\">\".get_vocab(\"goto\").\"</a>\\n\";\n\t\t\techo \"</td></tr>\\n<tr><td colspan=\\\"2\\\">\";\n\t\t\t$i = 0;\n\t\t\twhile ($i < 50)\n\t\t\t{\n\t\t\t\t$nom_periode = grr_sql_query1(\"select nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"' and num_periode= '\".$i.\"'\");\n\t\t\t\tif ($nom_periode == -1)\n\t\t\t\t\t$nom_periode = \"\";\n\t\t\t\techo \"<table style=\\\"display:none\\\" id=\\\"c\".($i+1).\"\\\"><tr><td>\".get_vocab(\"intitule_creneau\").($i+1).get_vocab(\"deux_points\").\"</td>\";\n\t\t\t\techo \"<td style=\\\"width:30%;\\\"><input type=\\\"text\\\" name=\\\"periode_\".$i.\"\\\" value=\\\"\".htmlentities($nom_periode).\"\\\" size=\\\"20\\\" /></td></tr></table>\\n\";\n\t\t\t\t$i++;\n\t\t\t}\n\t\t\t// L'utilisateur ne peut reserver qu'une duree limitee (-1 desactivee), exprimee en jours\n\t\t\tif ($row[\"duree_max_resa_area\"] > 0)\n\t\t\t\t$nb_jour = max(round($row[\"duree_max_resa_area\"]/1440,0),1);\n\t\t\telse\n\t\t\t\t$nb_jour = -1;\n\t\t\techo \"</td></tr>\\n<tr><td>\".get_vocab(\"duree_max_resa_area2\").get_vocab(\"deux_points\");\n\t\t\techo \"\\n</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"duree_max_resa_area2\\\" size=\\\"5\\\" value=\\\"\".$nb_jour.\"\\\" /></td></tr>\\n\";\n\t\t\techo \"</table>\";\n\t\t\t// Cas ou les creneaux de reservations sont bases sur le temps\n\t\t\tif ($row[\"enable_periods\"] == 'n')\n\t\t\t\techo \"<table id=\\\"menu1\\\" class='table table-bordered'>\";\n\t\t\telse\n\t\t\t\techo \"<table style=\\\"display:none\\\" id=\\\"menu1\\\" class='table table-bordered'>\";\n\t\t\t// Heure de debut de reservation\n\t\t\techo \"<tr>\";\n\t\t\techo \"<td>\".get_vocab(\"morningstarts_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td style=\\\"width:30%;\\\"><select class=\\\"form-control\\\" name=\\\"morningstarts_area\\\" size=\\\"1\\\">\\n\";\n\t\t\t$k = 0;\n\t\t\twhile ($k < 24)\n\t\t\t{\n\t\t\t\techo \"<option value=\\\"\".$k.\"\\\" \";\n\t\t\t\tif ($k == $row['morningstarts_area']) echo \" selected=\\\"selected\\\"\";\n\t\t\t\techo \">\".$k.\"</option>\\n\";\n\t\t\t\t$k++;\n\t\t\t}\n\t\t\techo \"</select></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Heure de fin de reservation\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"eveningends_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><select class=\\\"form-control\\\" name=\\\"eveningends_area\\\" size=\\\"1\\\">\\n\";\n\t\t\t$k = 0;\n\t\t\twhile ($k < 24)\n\t\t\t{\n\t\t\t\techo \"<option value=\\\"\".$k.\"\\\" \";\n\t\t\t\tif ($k == $row['eveningends_area']) echo \" selected=\\\"selected\\\"\";\n\t\t\t\techo \">\".$k.\"</option>\\n\";\n\t\t\t\t$k++;\n\t\t\t}\n\t\t\techo \"</select></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Minutes e ajouter e l'heure $eveningends pour avoir la fin reelle d'une journee.\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"eveningends_minutes_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"eveningends_minutes_area\\\" size=\\\"5\\\" value=\\\"\".htmlspecialchars($row[\"eveningends_minutes_area\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Resolution - quel bloc peut etre reserve, en secondes\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"resolution_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"resolution_area\\\" size=\\\"5\\\" value=\\\"\".htmlspecialchars($row[\"resolution_area\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Valeur par defaut de la duree d'une reservation\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"duree_par_defaut_reservation_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"duree_par_defaut_reservation_area\\\" size=\\\"5\\\" value=\\\"\".htmlspecialchars($row[\"duree_par_defaut_reservation_area\"]).\"\\\" /></td>\\n\";\n\t\t\techo \"</tr>\";\n\t\t\t// Format d'affichage du temps : valeur 0 pour un affichage ee12 heuresee et valeur 1 pour un affichage  ee24 heureee.\n\t\t\techo \"<tr>\\n\";\n\t\t\techo \"<td>\".get_vocab(\"twentyfourhour_format_area\").get_vocab(\"deux_points\").\"</td>\\n\";\n\t\t\techo \"<td>\\n\";\n\t\t\techo \"<label><input type=\\\"radio\\\" name=\\\"twentyfourhour_format_area\\\" value=\\\"0\\\" \";\n\t\t\tif ($row['twentyfourhour_format_area'] == 0)\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" />\".get_vocab(\"twentyfourhour_format_12\").\"</label>\\n<br />\";\n\t\t\techo \"<label><input type=\\\"radio\\\" name=\\\"twentyfourhour_format_area\\\" value=\\\"1\\\" \";\n\t\t\tif ($row['twentyfourhour_format_area'] == 1)\n\t\t\t\techo \" checked=\\\"checked\\\"\";\n\t\t\techo \" />\".get_vocab(\"twentyfourhour_format_24\").\"</label>\\n\";\n\t\t\techo \"</td>\\n\";\n\t\t\techo \"</tr>\\n\";\n\t\t\t// L'utilisateur ne peut reserver qu'une duree limitee (-1 desactivee), exprimee en minutes\n\t\t\techo \"<tr>\\n<td>\".get_vocab(\"duree_max_resa_area\").get_vocab(\"deux_points\");\n\t\t\techo \"</td>\\n<td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"duree_max_resa_area1\\\" size=\\\"5\\\" value=\\\"\".$row[\"duree_max_resa_area\"].\"\\\" /></td></tr>\\n\";\n\t\t\t// Nombre max de reservation par domaine\n\t\t\techo \"<tr><td>\".get_vocab(\"max_booking\").\" -  \".get_vocab(\"all_rooms_of_area\").get_vocab(\"deux_points\");\n\t\t\techo \"</td><td><input class=\\\"form-control\\\" type=\\\"text\\\" name=\\\"max_booking\\\" value=\\\"\".$row['max_booking'].\"\\\" /></td>\\n\";\n\t\t\techo \"</tr></table>\";\n\t\t\tHook::Appel(\"hookEditArea1\");\n\t\t\techo \"<div class=\\\"center\\\">\\n\";\n\t\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_area\\\" value=\\\"\".get_vocab(\"save\").\"\\\" />\\n\";\n\t\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_done\\\" value=\\\"\".get_vocab(\"back\").\"\\\" />\\n\";\n\t\t\techo \"<input class=\\\"btn btn-primary\\\" type=\\\"submit\\\" name=\\\"change_area_and_back\\\" value=\\\"\".get_vocab(\"save_and_back\").\"\\\" />\";\n\t\t\techo \"</div></form>\";\n\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\techo \"aff_creneaux();\";\n\t\t\techo \"</script>\";\n\t\t\techo \"</div>\";\n\t\t}\nend_page();\n?>", "<?php\n/**\n * frmcontactlist.php\n * calcule la liste des ressources visibles dans un domaine\n * Ce script fait partie de l'application GRR\n * Derni\u00e8re modification : $Date: 2020-03-13 11:00$\n * @author    JeromeB & Yan Naessens\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n\ninclude \"include/connect.inc.php\";\ninclude \"include/mysql.inc.php\";\ninclude \"include/misc.inc.php\";\ninclude \"include/functions.inc.php\";\n\n$id = $_GET['id'];\nif ($id != protect_data_sql($id))\n    die('Donn\u00e9e incorrecte');\n$res = grr_sql_query(\"SELECT room_name,id FROM \".TABLE_PREFIX.\"_room WHERE area_id = '\".protect_data_sql($id).\"' ORDER BY room_name\");\n$nbresult = mysqli_num_rows($res);\n$user_name = getUserName();\nif ($nbresult != 0)\n{\n    $a = \"\";\n\tfor ($t = 0; ($row_roomName = grr_sql_row($res, $t)); $t++)\n\t{\n        $id_room = $row_roomName[1];\n        if (verif_acces_ressource($user_name,$id_room)){\n            $room_name = $row_roomName[0];\n            $a .= \" <option value =\\\"$room_name\\\">$room_name</option>\";\n        }\n\t}\n    if ($a != \"\")\n        echo $a;\n    else \n        echo \" <option value =\\\"1\\\">Aucune ressource accessible dans ce domaine</option>\";\n}\nelse\n\techo \" <option value =\\\"1\\\">Aucune ressource li\u00e9e \u00e0 ce domaine</option>\";\n?>\n", "<?php\n/*\n * frmcontactrange.php\n * calcule le code html de la partie intervalle du formulaire de contact\n * Ce script fait partie de l'application GRR\n * Derni\u00e8re modification : $Date: 2020-03-13 11:00$\n * @author    JeromeB & Yan Naessens\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n \ninclude \"include/connect.inc.php\";\ninclude \"include/mysql.inc.php\";\ninclude \"include/misc.inc.php\";\ninclude \"include/functions.inc.php\";\n\n$id = $_GET['id'];\nif ($id != protect_data_sql($id))\n    die('Donn\u00e9e incorrecte');\n$query = \"SELECT access,morningstarts_area,eveningends_area,eveningends_minutes_area,enable_periods,resolution_area FROM \".TABLE_PREFIX.\"_area\n    WHERE id = '\".protect_data_sql($id).\"' \";\n// echo $query.\"<br />\";\n$res = grr_sql_query($query);\n$val= grr_sql_row($res,0);\n// print_r($val);\n$enable_periods = $val[4]=='y';\nif ($enable_periods)\n{\n    // echo 'mode cr\u00e9neaux';\n    // d\u00e9terminer la liste des cr\u00e9neaux\n    $sql_periode = grr_sql_query(\"SELECT num_periode, nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id.\"' order by num_periode\");\n    $num_periodes = grr_sql_count($sql_periode);\n    echo '<div class=\"form-group\">';\n    // s\u00e9lectionner parmi les cr\u00e9neaux\n    echo '<label for=\"start\" >Cr\u00e9neau initial : &nbsp;</label>';\n    echo '<select name=\"start\">';\n        for ($i = 0; $i < $num_periodes; $i++)\n        {\n            $val = grr_sql_row($sql_periode,$i);\n            echo '<option value=\"'.$val[0].'\">'.$val[1].'</option>';\n        }\n    echo '</select>';\n    // choisir le nombre de cr\u00e9neaux\n    echo '  <label for=\"duree\" >Nombre de cr\u00e9neaux : &nbsp;</label>';\n    echo '  <input type=\"number\" id=\"duree\" size=\"2\" name=\"duree\" value=\"1\" min=\"1\" required />';\n    echo '</div>';\n}\nelse \n{\t// mode temps\n    $res_min = $val[5]/60;\n    $nbiteration = 60/$res_min; // nb iterations sur une heure\n    echo '<div class=\"form-group\">';\n    echo '    <div class=\"input-group\">';\n    echo '        <label for=\"heure\">Heure d\u00e9but :</label>';\n    echo \"        <select name=\\\"heure\\\" id=\\\"heure\\\"> \";\n    for ($h = $val[1] ; $h < $val[2]+$val[3]/60-$val[5]/3600 ; $h++)\n    {\n        echo \"<option value =\\\"$h\\\"> \".sprintf(\"%02d\",$h).\"h </option>\".PHP_EOL;\n    }\n    echo \"        </select>\";\n    echo \" <select id='debdureemin' name=\\\"minutes\\\">\";\n    $valeur = 0;\n    for ($i=0;$i<$nbiteration;$i++)\n    {\n        echo \"<option value='$valeur'>\";\n        if ($i == 0)\n        { $valeur ='00';}\n        else {$valeur += $res_min;}\n        echo $valeur.\" min.\";\n        echo \"</option>\";\n    }\n    echo \" </select>\";\n    echo '    </div>';\n    echo '<div class=\"input-group\">';\n    echo '  <label for=\"duree\" >Dur\u00e9e en heure :</label>';\n    echo '  <input type=\"number\" id=\"duree\" size=\"2\" name=\"duree\" value=\"1\" min=\"0\" required />';\n    echo '  <label for=\"dureemin\"> et </label>';\n    echo '  <select id=\"dureemin\" name=\"dureemin\">';\n    $valeur = 0;\n    for ($i=0;$i<$nbiteration;$i++)\n    {\n        echo \"<option value='$valeur'>\".$valeur.\" min</option>\";\n        $valeur += $res_min;\n    }\n    echo '  </select>';\n    echo ' </div>';\n    echo '</div>';\n    \n}\necho \"<br /> \";\necho \"<div>\";\necho '<input class=\"btn btn-primary\" type=\"submit\" name=\"submit\" value=\"Envoyer la demande de r\u00e9servation\">';\necho '<input class=\"btn btn-danger\" type=\"button\" name=\"retouraccueil\" value=\"Retour\" onClick=\"javascript:location.href=\\'javascript:history.go(-1)\\'\">';\necho '</div>';\n?>", "<?php\n/**\n * include/functions.inc.php\n * fichier Biblioth\u00c3\u013bque de fonctions de GRR\n * Derni\u00c3\u013bre modification : $Date: 2020-02-20 16:30$\n * @author    JeromeB & Laurent Delineau & Marc-Henri PAMISEUX & Yan Naessens\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n\nfunction returnmsg($type,$test, $status, $msg = '')\n{\n\techo encode_message_utf8('<div class=\"alert alert-'.$type.'\" role=\"alert\"><h3>'.$test);\n\techo encode_message_utf8($status).\"</h3>\";\n\tif ($msg != '')\n\t\techo encode_message_utf8(\"($msg)\"),PHP_EOL;\n\techo '</div>',PHP_EOL;\n}\n\nfunction getDaysInMonth($month, $year)\n{\n\treturn date('t', mktime(0, 0, 0, $month, 1, $year));\n}\n\nfunction getWeekNumber($date)\n{\n\treturn date('W', $date);\n}\n// fonction de d\u00c3\u0110termination des jours de vacances scolaires par lecture dans la base\nfunction isSchoolHoliday($now)\n{\n\t$test = grr_sql_query1(\"SELECT DAY FROM \".TABLE_PREFIX.\"_calendrier_vacances where DAY = '\".$now.\"'\");\n\t$val = ($test != -1);\n\treturn $val;\n} \n/* function getSchoolHolidays($now, $year)\n{\n\t$zone = 'A';\n\tif (Settings::get(\"holidays_zone\") != NULL)\n\t\t$zone = Settings::get(\"holidays_zone\");\n\t$sh = array(false, \"\");\n\t$vacances = simplexml_load_file('vacances.xml');\n\t$libelle = $vacances->libelles->children();\n\t$node = $vacances->calendrier->children();\n\tforeach ($node as $key => $value)\n\t{\n\t\tif ($value['libelle'] == $zone)\n\t\t{\n\t\t\tforeach ($value->vacances as $key => $value)\n\t\t\t{\n\t\t\t\t$y = date('Y', strtotime($value['debut']));\n\t\t\t\tif ($y == $year)\n\t\t\t\t{\n\t\t\t\t\tif (strtotime($value['debut']) <= $now && $now < strtotime($value['fin']))\n\t\t\t\t\t{\n\t\t\t\t\t\t$nom = (int)$value['libelle'];\n\t\t\t\t\t\t$nom = $libelle->libelle[$nom - 1];\n\t\t\t\t\t\t$sh = array(true, $nom);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn $sh;\n}\n*/\n// fonction de calcul des jours f\u00c3\u0110ri\u00c3\u0110s (France)\nfunction setHolidays($year = null)\n{\n\tif ($year === null)\n\t\t$year = intval(date('Y'));\n\t$easterDate  = easter_date($year);\n\t$easterDay   = date('j', $easterDate);\n\t$easterMonth = date('n', $easterDate);\n\t$easterYear  = date('Y', $easterDate);\n\t$holidays = array(\n\t// Dates fixes\n\tmktime(0, 0, 0, 1,  1,  $year),  // 1er janvier\n\tmktime(0, 0, 0, 5,  1,  $year),  // F\u00c3\u0160te du travail\n\tmktime(0, 0, 0, 5,  8,  $year),  // Victoire des alli\u00c3\u0110s\n\tmktime(0, 0, 0, 7,  14, $year),  // F\u00c3\u0160te nationale\n\tmktime(0, 0, 0, 8,  15, $year),  // Assomption\n\tmktime(0, 0, 0, 11, 1,  $year),  // Toussaint\n\tmktime(0, 0, 0, 11, 11, $year),  // Armistice\n\tmktime(0, 0, 0, 12, 25, $year),  // Noel\n\t// Dates variables\n\tmktime(0, 0, 0, $easterMonth, $easterDay + 1,  $easterYear),\n\tmktime(0, 0, 0, $easterMonth, $easterDay + 39, $easterYear),\n\tmktime(0, 0, 0, $easterMonth, $easterDay + 50, $easterYear),\n\t);\n\tsort($holidays);\n\treturn $holidays;\n}\n// fonction de d\u00c3\u0110termination si un jour est f\u00c3\u0110ri\u00c3\u0110\nfunction isHoliday($now){\n\t$test = grr_sql_query1(\"SELECT DAY FROM \".TABLE_PREFIX.\"_calendrier_feries where DAY = '\".$now.\"'\");\n\t$val = ($test != -1);\n\treturn $val;\n}\n\n// $type = 1: Fonction Calendrier hors r\u00c3\u0110servation ; 2; Fonction Calendrier feries ; 3 : calendrier vacances (scolaires par d\u00c3\u0110faut)\nfunction cal($month, $year, $type)\n{\n\tglobal $weekstarts;\n\n\tif (!isset($weekstarts))\n\t\t$weekstarts = 0;\n\t$s = \"\";\n\t$daysInMonth = getDaysInMonth($month, $year);\n\t$date = mktime(12, 0, 0, $month, 1, $year);\n\t$first = (strftime(\"%w\",$date) + 7 - $weekstarts) % 7;\n\t$monthName = ucfirst(utf8_strftime(\"%B\", $date));\n\n\t$s .= '<table class=\"table calendar2\">'.PHP_EOL;\n\t$s .= '<tr>'.PHP_EOL;\n\t$s .= '<td class=\"calendarHeader2\" colspan=\"8\">'.$monthName.' '.$year.'</td>'.PHP_EOL;\n\t$s .= '</tr>'.PHP_EOL;\n\t$d = 1 - $first;\n\t$is_ligne1 = 'y';\n\twhile ($d <= $daysInMonth)\n\t{\n\t\t$s .= '<tr>'.PHP_EOL;\n\t\tfor ($i = 0; $i < 7; $i++)\n\t\t{\n\t\t\t$basetime = mktime(12, 0, 0, 6, 11 + $weekstarts, 2000);\n\t\t\t$show = $basetime + ($i * 24 * 60 * 60);\n\t\t\t$nameday = utf8_strftime('%A',$show);\n\t\t\t$temp = mktime(0, 0, 0, $month, $d, $year);\n\t\t\tif ($i == 0)\n\t\t\t\t$s .= '<td class=\"calendar2\" style=\"vertical-align:bottom;\"><b>S'.getWeekNumber($temp).'</b></td>'.PHP_EOL;\n\t\t\t$s .= '<td class=\"calendar2\" valign=\"top\">'.PHP_EOL;\n\t\t\tif ($is_ligne1 == 'y')\n\t\t\t\t$s .=  '<b>'.ucfirst(substr($nameday,0,1)).'</b><br />';\n\t\t\tif ($d > 0 && $d <= $daysInMonth)\n\t\t\t{\n\t\t\t\t$s .= $d;\n\t\t\t\tif($type == 1)\n\t\t\t\t\t$day = grr_sql_query1(\"SELECT day FROM \".TABLE_PREFIX.\"_calendar WHERE day='$temp'\");\n\t\t\t\telseif ($type == 2)\n                    $day = grr_sql_query1(\"SELECT day FROM \".TABLE_PREFIX.\"_calendrier_feries WHERE day='$temp'\");\n                else\n\t\t\t\t\t$day = grr_sql_query1(\"SELECT day FROM \".TABLE_PREFIX.\"_calendrier_vacances WHERE day='$temp'\");\n\t\t\t\t$s .= '<br><input type=\"checkbox\" name=\"'.$temp.'\" value=\"'.$nameday.'\" ';\n\t\t\t\tif (!($day < 0))\n\t\t\t\t\t$s .= 'checked=\"checked\" ';\n\t\t\t\t$s .= '/>';\n\t\t\t}\n\t\t\telse\n\t\t\t\t$s .= \" \";\n\t\t\t$s .= '</td>'.PHP_EOL;;\n\t\t\t$d++;\n\t\t}\n\t\t$s .= '</tr>'.PHP_EOL;;\n\t\t$is_ligne1 = 'n';\n\t}\n\t$s .= '</table>'.PHP_EOL;\n\treturn $s;\n}\n\n/**\n * Fonction de verification d'access\n * @param int $level\n */\nfunction check_access($level, $back)\n{\n\tif (authGetUserLevel(getUserName(), -1, 'area') < $level)\n\t{\n\t\tshowAccessDenied($back);\n\t\texit();\n\t}\n}\n\n/**\n * Fonction qui compare 2 valeurs\n * @param string $a\n * @param integer $b\n * @return string\n */\nfunction cmp3($a, $b)\n{\n\tif ($a < $b)\n\t\treturn \"< \";\n\tif ($a == $b)\n\t\treturn \"= \";\n\treturn \"> \";\n}\n\nfunction get_request_uri()\n{\n\tglobal $grr_script_name;\n\t$RequestUri = \"\";\n\tif (isset($_SERVER['REQUEST_URI']))\n\t\t$RequestUri = $_SERVER['REQUEST_URI'];\n\telse if (isset($_ENV['REQUEST_URI']))\n\t\t$RequestUri = $_ENV['REQUEST_URI'];\n\telse if (isset($_SERVER['HTTP_X_REWRITE_URL']))\n\t\t$RequestUri = $_SERVER['HTTP_X_REWRITE_URL'];\n\telse\n\t{\n\t\tif (!isset($_SERVER['QUERY_STRING']))\n\t\t\t$_SERVER['QUERY_STRING'] = \"\";\n\t\tif ((Settings::get(\"use_grr_url\") == \"y\") && (Settings::get(\"grr_url\") != \"\"))\n\t\t{\n\t\t\tif (substr(Settings::get(\"grr_url\"), -1) != \"/\")\n\t\t\t\t$ad_signe = \"/\";\n\t\t\telse\n\t\t\t\t$ad_signe = \"\";\n\t\t\t$RequestUri = Settings::get(\"grr_url\").$ad_signe.$grr_script_name.$_SERVER['QUERY_STRING'];\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (isset($_SERVER['PHP_SELF']))\n\t\t\t\t$RequestUri = $_SERVER['PHP_SELF'].$_SERVER['QUERY_STRING'];\n\t\t}\n\t}\n\treturn $RequestUri;\n}\n\n/**\n * Affiche un lien email\n * @param string $_cible\n * @param string $_type_cible\n * @param string $option_affichage\n * @return string\n */\nfunction affiche_lien_contact($_cible, $_type_cible, $option_affichage)\n{\n\n\tif ($_type_cible == \"identifiant:non\")\n\t{\n\t\tif ($_cible == \"contact_administrateur\")\n\t\t{\n\t\t\t$_email = Settings::get(\"webmaster_email\");\n\t\t\t$_identite = get_vocab('administrator_contact');\n\t\t}\n\t\telse if ($_cible == \"contact_support\")\n\t\t{\n\t\t\t$_email = Settings::get(\"technical_support_email\");\n\t\t\t$_identite = get_vocab('technical_contact');\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$_email = \"\";\n\t\t\t$_identite = \"\";\n\t\t}\n\t}\n\telse\n\t{\n\t\t$sql_cible = \"SELECT prenom, nom, email FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".$_cible.\"'\";\n\t\t$res_cible = grr_sql_query($sql_cible);\n\t\tif ($res_cible)\n\t\t{\n\t\t\t$row_cible = grr_sql_row($res_cible, 0);\n\t\t\t$_email = $row_cible[2];\n\t\t\t$_identite = $row_cible[0].\" \".$row_cible[1];\n\t\t\tgrr_sql_free($res_cible);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$_email = \"\";\n\t\t\t$_identite = \"\";\n\t\t}\n\t}\n\n\tif (Settings::get(\"envoyer_email_avec_formulaire\") == \"yes\")\n\t{\n\t\tif ($_email == \"\")\n\t\t{\n\t\t\tif ($option_affichage == \"afficher_toujours\")\n\t\t\t\t$affichage = $_identite;\n\t\t\telse\n\t\t\t\t$affichage = \"\";\n\t\t}\n\t\telse\n\t\t\t//$affichage = '<a href=\"javascript:centrerpopup(\\'contact.php?cible='.$_cible.'&amp;type_cible='.$_type_cible.'\\',600,480,\\'scrollbars=yes,statusbar=no,resizable=yes\\')\" title=\"'.$_identite.'\\\">'.$_identite.'</a>'.PHP_EOL;\n            $affichage = '<a href=\"javascript:centrerpopup(\\'contact.php?cible='.$_cible.'&amp;type_cible='.$_type_cible.'\\',600,480,\\'scrollbars=yes,statusbar=no,resizable=yes\\')\" title=\"'.$_identite.'\\\">'.$_identite.'</a>'.PHP_EOL;\n\t}\n\telse\n\t{   // si j'ai bien compris, il s'agit de calculer une balise mailto, et ce qui suit parait trop compliqu\u00c3\u0110 YN 2018-01-26\n\n\t/*\t?>\n\t\t<script type=\"text/javascript\">\n\t\t\tfunction encode_adresse(user,domain,debut)\n\t\t\t{\n\t\t\t\tvar address = user+'@'+domain;\n\t\t\t\tvar toWrite = '';\n\t\t\t\tif (debut > 0)\n\t\t\t\t\ttoWrite += '<'+'a href=\"mailto:';\n\t\t\t\telse\n\t\t\t\t\ttoWrite +=';';\n\t\t\t\ttoWrite +=address\n\t\t\t\tdocument.write(toWrite);\n\t\t\t}\n\t\t\tfunction encode_fin_adresse(label)\n\t\t\t{\n\t\t\t\tvar toWrite = '';\n\t\t\t\ttoWrite +='\">'+label+'</'+'a>';\n\t\t\t\tdocument.write(toWrite);\n\t\t\t}\n\t\t</script>\n\t\t<?php */\n\t\t$affichage = \"\";\n\t\tif ($_email == \"\")\n\t\t{\n\t\t\tif ($option_affichage == \"afficher_toujours\")\n\t\t\t\t$affichage = $_identite;\n\t\t}\n\t\telse\n\t\t{\n            if (filter_var($_email,FILTER_VALIDATE_EMAIL))\n            {\n                $affichage = '<a href=\"mailto:'.$_email.'\">'.$_identite.'</a>';\n            }\n            else \n                if ($option_affichage == \"afficher_toujours\")\n                    $affichage = $_identite;\n            /* \n\t\t\t$tab_email = explode(';', trim($_email));\n\t\t\t$i = 0;\n\t\t\t$affichage .= '<script>'.PHP_EOL;\n\t\t\tforeach ($tab_email as $item_email)\n\t\t\t{\n\t\t\t\t$item_email_explode = explode('@',$item_email);\n\t\t\t\t$person = $item_email_explode[0];\n\t\t\t\tif (isset($item_email_explode[1]))\n\t\t\t\t{\n\t\t\t\t\t$i++;\n\t\t\t\t\t$domain = $item_email_explode[1];\n\t\t\t\t\tif ($i == 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$affichage .=  'encode_adresse(\"'.$person.'\", \"'.$domain.'\", 1);'.PHP_EOL;\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t$affichage .=  'encode_adresse(\"'.$person.'\", \"'.$domain.'\", 0);'.PHP_EOL;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t$affichage .=  'encode_fin_adresse(\"'.addslashes($_identite).'\");'.PHP_EOL;\n\t\t\t$affichage .=  '</script>'.PHP_EOL;\n\t\t\t$affichage .= $_identite; */\n\t\t}\n\t}\n\treturn $affichage;\n}\n/**\n *Fonction qui calcule $room, $area et $id_site \u00c3\u00a0 partir de $_GET['room'], $_GET['area'], $_GET['id_site']\n */\nfunction Definition_ressource_domaine_site()\n{\n\tglobal $room, $area, $id_site;\n\tif (isset($_GET['room']))\n\t{\n\t\t//$room = $_GET['room'];\n\t\t$room = mysqli_real_escape_string($GLOBALS['db_c'], $_GET['room']);\n\t\tsettype($room, \"integer\");\n\t\t$area = mrbsGetRoomArea($room);\n\t\t$id_site = mrbsGetAreaSite($area);\n\t}\n\telse\n\t{\n\t\t$room = NULL;\n\t\tif (isset($_GET['area']))\n\t\t{\n\t\t\t//$area = $_GET['area'];\n\t\t\t$area = mysqli_real_escape_string($GLOBALS['db_c'], $_GET['area']);\n\t\t\tsettype($area, \"integer\");\n\t\t\t$id_site = mrbsGetAreaSite($area);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$area = NULL;\n\t\t\tif (isset($_GET[\"id_site\"]))\n\t\t\t{\n\t\t\t\t//$id_site = $_GET[\"id_site\"];\n\t\t\t\t$id_site = mysqli_real_escape_string($GLOBALS['db_c'], $_GET[\"id_site\"]);\n\t\t\t\tsettype($id_site, \"integer\");\n\t\t\t\t$area = get_default_area($id_site);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t$id_site = get_default_site();\n\t\t\t\t$area = get_default_area($id_site);\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction bouton_retour_haut()\n{\n\techo '<script type=\"text/javascript\">',PHP_EOL,'$(function()',PHP_EOL,'{',PHP_EOL,'$(window).scroll(function()',PHP_EOL,'{',PHP_EOL,\n\t\t'if ($(this).scrollTop() != 0)',PHP_EOL,'$(\"#toTop\").fadeIn();',PHP_EOL,'else',PHP_EOL,'$(\"#toTop\").fadeOut();',PHP_EOL,\n\t\t'});',PHP_EOL,'$(\"#toTop\").click(function()',PHP_EOL,'{',PHP_EOL,'$(\"body,html\").animate({scrollTop:0},800);',PHP_EOL,\n\t\t'});',PHP_EOL,'});',PHP_EOL,'</script>',PHP_EOL;\n}\n\nfunction bouton_aller_bas()\n{\n\techo '<script type=\"text/javascript\">',PHP_EOL,'$(function()',PHP_EOL,'{',PHP_EOL,'$(window).scroll(function()',PHP_EOL,'{',PHP_EOL,\n\t\t'if ($(this).scrollTop() != 800)',PHP_EOL,'$(\"#toBot\").fadeIn();',PHP_EOL,'else',PHP_EOL,'$(\"#toBot\").fadeOut();',PHP_EOL,\n\t\t'});',PHP_EOL,'$(\"#toBot\").click(function()',PHP_EOL,'{',PHP_EOL,'$(\"body,html\").animate({scrollTop:800},0);',PHP_EOL,\n\t\t'});',PHP_EOL,'});',PHP_EOL,'</script>',PHP_EOL;\n}\n/**\n *function affiche_ressource_empruntee\n *- $id_room : identifiant de la ressource\n *- Si la ressource est emprunt\u00c3\u0110e, affiche une ic\u00c3\u012bne avec un lien vers la r\u00c3\u0110servation pour laquelle la ressource est emprunt\u00c3\u0110e.\n * @param string $id_room\n * @return string\n */\nfunction affiche_ressource_empruntee($id_room, $type = \"logo\")\n{\n\t$active_ressource_empruntee = grr_sql_query1(\"SELECT active_ressource_empruntee FROM \".TABLE_PREFIX.\"_room WHERE id = '\".$id_room.\"'\");\n\tif ($active_ressource_empruntee == 'y')\n\t{\n\t\t$id_resa = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_entry WHERE room_id = '\".$id_room.\"' AND statut_entry='y'\");\n\t\tif ($id_resa != -1)\n\t\t{\n\t\t\tif ($type == \"logo\")\n\t\t\t\techo '<a href=\"view_entry.php?id='.$id_resa.'\"><img src=\"img_grr/buzy_big.png\" alt=\"'.get_vocab(\"ressource actuellement empruntee\").'\" title=\"'.get_vocab(\"reservation_en_cours\").'\" width=\"30\" height=\"30\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\telse if ($type == \"texte\")\n\t\t\t{\n\t\t\t\t$beneficiaire = grr_sql_query1(\"SELECT beneficiaire FROM \".TABLE_PREFIX.\"_entry WHERE room_id = '\".$id_room.\"' AND statut_entry='y'\");\n\t\t\t\t$beneficiaire_ext = grr_sql_query1(\"SELECT beneficiaire_ext FROM \".TABLE_PREFIX.\"_entry WHERE room_id = '\".$id_room.\"' AND statut_entry='y'\");\n\t\t\t\techo '<br /><b><span class=\"avertissement\">'.PHP_EOL;\n\t\t\t\techo '<img src=\"img_grr/buzy_big.png\" alt=\"'.get_vocab(\"ressource actuellement empruntee\").'\" title=\"'.get_vocab(\"ressource actuellement empruntee\").'\" width=\"30\" height=\"30\" class=\"image\" />'.PHP_EOL;\n\t\t\t\techo get_vocab(\"ressource actuellement empruntee\").' '.get_vocab(\"nom emprunteur\").get_vocab(\"deux_points\").affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"withmail\");\n\t\t\t\techo '<a href=\"view_entry.php?id='.$id_resa.'&amp;mode=page\">'.get_vocab(\"entryid\").$id_resa.'</a>'.PHP_EOL.'</span></b>'.PHP_EOL;\n\t\t\t}\n\t\t\telse\n\t\t\t\treturn \"yes\";\n\t\t}\n\t}\n}\n\n/**\n * @param string $type\n * @param string $t\n * @return string\n */\nfunction bbCode($t,$type)\n{\n\tif ($type == \"nobbcode\")\n\t{\n\t\t$t = str_replace(\"[/]\", \"\", $t);\n\t\t$t = str_replace(\"[hr]\", \"\", $t);\n\t\t$t = str_replace(\"[center]\", \"\", $t);\n\t\t$t = str_replace(\"[/center]\", \"\", $t);\n\t\t$t = str_replace(\"[right]\", \"\", $t);\n\t\t$t = str_replace(\"[/right]\", \"\", $t);\n\t\t$t = str_replace(\"[justify]\", \"\", $t);\n\t\t$t = str_replace(\"[/justify]\", \"\", $t);\n\t\t$regLienSimple = \"`\\[url\\] ?([^\\[]*) ?\\[/url\\]`\";\n\t\t$regLienEtendu = \"`\\[url ?=([^\\[]*) ?] ?([^]]*) ?\\[/url\\]`\";\n\t\tif (preg_match($regLienSimple, $t))\n\t\t\t$t = preg_replace($regLienSimple, \"\\\\1\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regLienEtendu, \"\\\\1\", $t);\n\t\t$regMailSimple = \"`\\[email\\] ?([^\\[]*) ?\\[/email\\]`\";\n\t\t$regMailEtendu = \"`\\[email ?=([^\\[]*) ?] ?([^]]*) ?\\[/email\\]`\";\n\t\tif (preg_match($regMailSimple, $t))\n\t\t\t$t = preg_replace($regMailSimple, \"\\\\1\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regMailEtendu, \"\\\\1\", $t);\n\t\t$regImage = \"`\\[img\\] ?([^\\[]*) ?\\[/img\\]`\";\n\t\t$regImageAlternatif = \"`\\[img ?= ?([^\\[]*) ?\\]`\";\n\t\tif (preg_match($regImage, $t))\n\t\t\t$t = preg_replace($regImage, \"\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regImageAlternatif, \"\", $t);\n\t\t$t = str_replace(\"[b]\", \"\", $t);\n\t\t$t = str_replace(\"[/b]\", \"\", $t);\n\t\t$t = str_replace(\"[i]\", \"\", $t);\n\t\t$t = str_replace(\"[/i]\", \"\", $t);\n\t\t$t = str_replace(\"[u]\", \"\", $t);\n\t\t$t = str_replace(\"[/u]\", \"\", $t);\n\t\t$t = str_replace(\"[/color]\", \"</span>\", $t);\n\t\t$regCouleur = \"`\\[color= ?(([[:alpha:]]+)|(#[[:digit:][:alpha:]]{6})) ?\\]`\";\n\t\t$t = preg_replace($regCouleur, \"\", $t);\n\t\t$t = str_replace(\"[/size]\", \"</span>\", $t);\n\t\t$regCouleur = \"`\\[size= ?([[:digit:]]+) ?\\]`\";\n\t\t$t = preg_replace($regCouleur, \"\", $t);\n\t}\n\tif ($type != \"titre\")\n\t{\n\t\t$t = str_replace(\"[/]\", \"<hr width=\\\"100%\\\" size=\\\"1\\\" />\", $t);\n\t\t$t = str_replace(\"[hr]\", \"<hr width=\\\"100%\\\" size=\\\"1\\\" />\", $t);\n\t\t$t = str_replace(\"[center]\", \"<div style=\\\"text-align: center\\\">\", $t);\n\t\t$t = str_replace(\"[/center]\", \"</div>\", $t);\n\t\t$t = str_replace(\"[right]\", \"<div style=\\\"text-align: right\\\">\", $t);\n\t\t$t = str_replace(\"[/right]\", \"</div>\", $t);\n\t\t$t = str_replace(\"[justify]\", \"<div style=\\\"text-align: justify\\\">\", $t);\n\t\t$t = str_replace(\"[/justify]\", \"</div>\", $t);\n\t\t$regLienSimple = \"`\\[url\\] ?([^\\[]*) ?\\[/url\\]`\";\n\t\t$regLienEtendu = \"`\\[url ?=([^\\[]*) ?] ?([^]]*) ?\\[/url\\]`\";\n\t\tif (preg_match($regLienSimple, $t))\n\t\t\t$t = preg_replace($regLienSimple, \"<a href=\\\"\\\\1\\\">\\\\1</a>\", $t);\n\t\telse\n\t\t\t$t = preg_replace($regLienEtendu, \"<a href=\\\"\\\\1\\\" target=\\\"_blank\\\">\\\\2</a>\", $t);\n\t}\n\t$regMailSimple = \"`\\[email\\] ?([^\\[]*) ?\\[/email\\]\\`\";\n\t$regMailEtendu = \"`\\[email ?=([^\\[]*) ?] ?([^]]*) ?\\[/email\\]`\";\n\tif (preg_match(\"'\".$regMailSimple.\"'\", $t))\n\t\t$t = preg_replace($regMailSimple, \"<a href=\\\"mailto:\\\\1\\\">\\\\1</a>\", $t);\n\telse\n\t\t$t = preg_replace($regMailEtendu, \"<a href=\\\"mailto:\\\\1\\\">\\\\2</a>\", $t);\n\t$regImage = \"`\\[img\\] ?([^\\[]*) ?\\[/img\\]`\";\n\t$regImageAlternatif = \"`\\[img ?= ?([^\\[]*) ?\\]`\";\n\tif (preg_match($regImage, $t))\n\t\t$t = preg_replace($regImage, \"<img src=\\\"\\\\1\\\" alt=\\\"\\\" class=\\\"image\\\" />\", $t);\n\telse\n\t\t$t = preg_replace($regImageAlternatif, \"<img src=\\\"\\\\1\\\" alt=\\\"\\\" class=\\\"image\\\" />\", $t);\n\t$t = str_replace(\"[b]\", \"<strong>\", $t);\n\t$t = str_replace(\"[/b]\", \"</strong>\", $t);\n\t$t = str_replace(\"[i]\", \"<em>\", $t);\n\t$t = str_replace(\"[/i]\", \"</em>\", $t);\n\t$t = str_replace(\"[u]\", \"<u>\", $t);\n\t$t = str_replace(\"[/u]\", \"</u>\", $t);\n\t$t = str_replace(\"[/color]\", \"</span>\", $t);\n\t$regCouleur = \"/\\[color= ?(([[:alpha:]]+)|(#[[:digit:][:alpha:]]{6})) ?\\]/\";\n\t$t = preg_replace($regCouleur, \"<span style=\\\"color: \\\\1\\\">\", $t);\n\t$t = str_replace(\"[/size]\", \"</span>\", $t);\n\t$regCouleur = \"`\\[size= ?([[:digit:]]+) ?\\]`\";\n\t$t = preg_replace($regCouleur, \"<span style=\\\"font-size: \\\\1px\\\">\", $t);\n\treturn $t;\n}\n\n/**\n * FUNCTION: how_many_connected()\n * DESCRIPTION: Si c'est un admin qui est connect\u00c3\u0110, affiche le nombre de personnes actuellement connect\u00c3\u0110es.\n */\nfunction how_many_connected()\n{\n\tif (authGetUserLevel(getUserName(), -1) >= 6)\n\t{\n\t\t$sql = \"SELECT login FROM \".TABLE_PREFIX.\"_log WHERE end > now()\";\n\t\t$res = grr_sql_query($sql);\n\t\t$nb_connect = grr_sql_count($res);\n\t\tgrr_sql_free($res);\n\n\t\tif (@file_exists('./admin_access_area.php')){\n\t\t\t$racineAd = \"./\";\n\t\t}else{\n\t\t\t$racineAd = \"./admin/\";\n\t\t}\n\n\t\tif ($nb_connect == 1)\n\t\t\techo \"<a href='{$racineAd}admin_view_connexions.php'>\".$nb_connect.get_vocab(\"one_connected\").\"</a>\".PHP_EOL;\n\t\telse\n\t\t\techo \"<a href='{$racineAd}admin_view_connexions.php'>\".$nb_connect.get_vocab(\"several_connected\").\"</a>\".PHP_EOL;\n\t\tif (verif_version())\n\t\t\taffiche_pop_up(get_vocab(\"maj_bdd_not_update\").get_vocab(\"please_go_to_admin_maj.php\"),\"force\");\n\t}\n}\n/**\n * Fonction : resaToModerate($user) \n * Description : si c'est un admin ou un gestionnaire de ressource qui est connect\u00c3\u0110, retourne un tableau contenant, pour chaque r\u00c3\u0110servation \u00c3\u00a0 mod\u00c3\u0110rer, [id,room_id,start_time]\n*/\nfunction resaToModerate($user)\n{   \n    $resas = array();\n    $res = false;\n    if (authGetUserLevel($user,-1) > 5) // admin g\u00c3\u0110n\u00c3\u0110ral\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e JOIN \".TABLE_PREFIX.\"_room r ON e.room_id = r.id WHERE e.moderate = 1\";\n        $res = grr_sql_query($sql);\n    }\n    elseif (isset($_GET['id_site']) && (authGetUserLevel($user,$_GET['id_site'],'site') > 4)) // admin du site\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e JOIN \".TABLE_PREFIX.\"_room r ON e.room_id = r.id JOIN \".TABLE_PREFIX.\"_j_site_area j ON r.area_id = j.id_area WHERE (j.id_site = \".$_GET['id_site'].\" AND e.moderate = 1)\";\n        $res = grr_sql_query($sql);\n    }\n    elseif (isset($_GET['area']) && (authGetUserLevel($user,$_GET['area'],'area') > 3)) // admin du domaine\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e JOIN \".TABLE_PREFIX.\"_room r ON e.room_id = r.id JOIN \".TABLE_PREFIX.\"_area a ON r.area_id = a.id WHERE (a.id = \".$_GET['area'].\" AND e.moderate = 1)\";\n        $res = grr_sql_query($sql);\n    }\n    elseif (isset($_GET['room']) && (authGetUserLevel($user,$_GET['room'],'room') > 2)) // gestionnaire de la ressource\n    {\n        $sql = \"SELECT e.id,r.room_name,e.start_time FROM \".TABLE_PREFIX.\"_entry e WHERE (e.moderate = 1 AND e.room_id = \".$_GET['room'].\") \";\n        $res = grr_sql_query($sql);\n    }\n    if ($res)\n    {\n        $i = 0; \n        while (($a = grr_sql_row($res, $i++))) \n        {\n            $resas[$i] = array('id' => $a[0],'room' => $a[1],'start_time' => $a[2]);\n        }\n    }\n    return $resas;\n}\n/*\nTeste s'il reste ou non des plages libres sur une journ\u00c3\u0110e donn\u00c3\u0110e pour un domaine donn\u00c3\u0110.\nArguments :\n$id_room : identifiant de la ressource\n$month_week : mois\n$day_week : jour\n$year_week : ann\u00c3\u0110e\nRenvoie vrai s'il reste des plages non r\u00c3\u0110serv\u00c3\u0110es sur la journ\u00c3\u0110e\nRenvoie faux dans le cas contraire\n*/\n/**\n * @param integer $id_room\n * @param integer $month_week\n * @param integer $day_week\n * @param integer $year_week\n * @return boolean\n */\nfunction plages_libre_semaine_ressource($id_room, $month_week, $day_week, $year_week)\n{\n\tglobal $morningstarts, $eveningends, $eveningends_minutes, $resolution, $enable_periods;\n\t$date_end = mktime($eveningends, $eveningends_minutes, 0, $month_week, $day_week, $year_week);\n\t$date_start = mktime($morningstarts, 0, 0, $month_week, $day_week, $year_week);\n\t$t = $date_start ; \n\tif ($enable_periods == \"y\") \n\t\t$date_end += $resolution;\n\t$plage_libre = false;\n\twhile ($t < $date_end)\n\t{\n\t\t$t_end = $t + $resolution;\n\t\t$query = \"SELECT id FROM \".TABLE_PREFIX.\"_entry WHERE room_id='\".$id_room.\"' AND start_time <= \".$t.\" AND end_time >= \".$t_end.\" \";\n\t\t$test = grr_sql_query1($query);\n\t\tif ($test == -1)\n\t\t{\n\t\t\t$plage_libre = true;\n\t\t\tbreak;\n\t\t}\n\t\t$t += $resolution;\n\t}\n\treturn $plage_libre ;\n}\n\n/* Fonction sp\u00c3\u0110ciale SE3\n $grp : le nom du groupe\n $uid : l'uid de l'utilisateur\n Cette fonction retourne \"oui\" ou \"non\" selon que $uid appartient au groupe $grp, ou bien \"faux\" si l'interrogation du LDAP \u00c3\u0110choue\n Seuls les groupes de type \"posixGroup\" sont support\u00c3\u0110s (les groupes de type \"groupOfNames\" ne sont pas support\u00c3\u0110s).\n*/\n function se3_grp_members ($grp, $uid)\n {\n \tinclude \"config_ldap.inc.php\";\n \t$est_membre=\"non\";\n\t// LDAP attributs\n \t$members_attr = array (\n\t\t$ldap_group_member_attr\n\t\t// Recherche des Membres du groupe\n \t\t);\n\t\t// Avec des GroupOfNames, ce ne serait pas \u00c3\u00a7a.\n \t$ds = @ldap_connect($ldap_adresse, $ldap_port);\n \tif ($ds)\n \t{\n \t\t$r = @ldap_bind ($ds, $ldap_login, $ldap_pwd);\n\t\t// Bind anonyme\n \t\tif ($r)\n \t\t{\n\t\t\t// La requ\u00c3\u0160te est adapt\u00c3\u0110e \u00c3\u00a0 un serveur SE3...\n\t\t\t//$result = @ldap_search($ds, \"cn={$grp},{$ldap_group_base}\",$ldap_group_filter, $members_attr);\n            $result = @ldap_search($ds, \"{$ldap_group_base}\",\"(& (cn={$grp}) $ldap_group_filter )\", $members_attr);\n            // sur la proposition de marylenepaillassa (Forum #255)\n\t\t\t// Peut-\u00c3\u0160tre faudrait-il dans le $tab_grp_autorise mettre des chaines 'cn=$grp,ou=Groups'\n \t\t\tif ($result)\n \t\t\t{\n \t\t\t\t$info = @ldap_get_entries($ds, $result);\n \t\t\t\tif ($info[\"count\"] == 1)\n \t\t\t\t{\n \t\t\t\t\tfor ($loop = 0; $loop < $info[0][$ldap_group_member_attr][\"count\"]; $loop++)\n \t\t\t\t\t{\n \t\t\t\t\t\tif ($info[0][$ldap_group_member_attr][$loop] == $uid)\n \t\t\t\t\t\t\t$est_membre=\"oui\";\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\t@ldap_free_result($result);\n \t\t\t}\n \t\t}\n \t\telse\n \t\t\treturn false;\n \t\t@ldap_close($ds);\n \t}\n \telse\n \t\treturn false;\n \treturn $est_membre;\n }\n\n/*\nArguments :\n$id_entry : identifiant de la r\u00c3\u0110servation\n$login_moderateur : identifiant du mod\u00c3\u0110rateur\n$motivation_moderation : texte facultatif\nIns\u00c3\u013bre dans la table \".TABLE_PREFIX.\"_entry_moderate les valeurs de \".TABLE_PREFIX.\"_entry dont l'identifiant est $id_entry\n*/\n/**\n * @param string $motivation_moderation\n */\nfunction  grr_backup($id_entry, $login_moderateur, $motivation_moderation)\n{\n\t$sql = \"SELECT * FROM \".TABLE_PREFIX.\"_entry WHERE id='\".$id_entry.\"'\";\n\t$res = grr_sql_query($sql);\n\tif (!$res)\n\t\treturn false;\n\t$row = grr_sql_row_keyed($res, 0);\n\tgrr_sql_free($res);\n\t$req = \"INSERT INTO \".TABLE_PREFIX.\"_entry_moderate SET\n\tid = '\".$row['id'].\"',\n\tstart_time = '\".$row['start_time'].\"',\n\tend_time  = '\".$row['end_time'].\"',\n\tentry_type  = '\".$row['entry_type'].\"',\n\trepeat_id  = '\".$row['repeat_id'].\"',\n\troom_id = '\".$row['room_id'].\"',\n\ttimestamp = '\".$row['timestamp'].\"',\n\tcreate_by = '\".$row['create_by'].\"',\n\tbeneficiaire = '\".$row['beneficiaire'].\"',\n\tname = '\".protect_data_sql($row['name']).\"',\n\ttype = '\".$row['type'].\"',\n\tdescription = '\".protect_data_sql($row['description']).\"',\n\tstatut_entry = '\".$row['statut_entry'].\"',\n\toption_reservation = '\".$row['option_reservation'].\"',\n\toverload_desc  = '\".protect_data_sql($row['overload_desc']).\"',\n\tmoderate = '\".$row['moderate'].\"',\n\tmotivation_moderation = '\".protect_data_sql(strip_tags($motivation_moderation)).\"',\n\tlogin_moderateur = '\".protect_data_sql($login_moderateur).\"'\";\n\t$res = grr_sql_query($req);\n\tif (!$res)\n\t\treturn false;\n\telse\n\t{\n\t\tgrr_sql_free($res);\n\t\treturn true;\n\t}\n}\n\nfunction verif_version()\n{\n\tglobal $version_grr, $version_grr_RC;\n\t$_version_grr = $version_grr;\n\t$_version_grr_RC = $version_grr_RC;\n\t$version_old = Settings::get(\"version\");\n\t$versionRC_old = Settings::get(\"versionRC\");\n\tif ($versionRC_old == \"\")\n\t\t$versionRC_old = 9;\n\tif ($_version_grr_RC == \"\")\n\t\t$_version_grr_RC = 9;\n\tif (($version_old == '') || ($_version_grr > $version_old) || (($_version_grr == $version_old) && ($_version_grr_RC > $versionRC_old)))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nfunction affiche_version()\n{\n\tglobal $version_grr, $version_grr_RC, $sous_version_grr;\n\treturn \"GRR \".Settings::get(\"version\");\n}\n\nfunction affiche_date($x)\n{\n\t$j = date(\"d\", $x);\n\t$m = date(\"m\", $x);\n\t$a = date(\"Y\", $x);\n\t$result = $j.\"/\".$m.\"/\".$a;\n\treturn $result;\n}\n\n//L'heure d'\u00c3\u0110t\u00c3\u0110 commence le dernier dimanche de mars * et se termine le dernier dimanche d'octobre\n//Passage \u00c3\u00a0 l'heure d'hiver : -1h, le changement s'effectue \u00c3\u00a0 3h\n//Passage \u00c3\u00a0 l'heure d'\u00c3\u0110t\u00c3\u0110 : +1h, le changement s'effectue \u00c3\u00a0 2h\n//Si type = hiver => La fonction retourne la date du jour de passage \u00c3\u00a0 l'heure d'hiver\n//Si type = ete =>  La fonction retourne la date du jour de passage \u00c3\u00a0 l'heure d'\u00c3\u0110t\u00c3\u0110\nfunction heure_ete_hiver($type, $annee, $heure)\n{\n\tif ($type == \"ete\")\n\t\t$debut = mktime($heure, 0, 0, 03, 31, $annee);\n\t// 31-03-$annee\n\telse\n\t\t$debut = mktime($heure,0, 0, 10, 31, $annee);\n\t// 31-10-$annee\n\twhile (date(\"D\", $debut ) != 'Sun')\n\t\t$debut = mktime($heure, 0, 0, date(\"m\", $debut), date(\"d\", $debut) - 1, date(\"Y\", $debut));\n\t//On retire 1 jour par rapport \u00c3\u00a0 la date examin\u00c3\u0110e\n\treturn $debut;\n}\n\n# Remove backslash-escape quoting if PHP is configured to do it with\n# magic_quotes_gpc. Use this whenever you need the actual value of a GET/POST\n# form parameter (which might have special characters) regardless of PHP's\n# magic_quotes_gpc setting.\nfunction unslashes($s)\n{\n\tif (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc())\n\t\treturn stripslashes($s);\n\telse\n\t\treturn $s;\n}\n\n// Corrige les caracteres degoutants utilises par les Windozeries\nfunction corriger_caracteres($texte)\n{\n\t// 145,146,180 = simple quote ; 147,148 = double quote ; 150,151 = tiret long\n\t$texte = strtr($texte, chr(145).chr(146).chr(180).chr(147).chr(148).chr(150).chr(151), \"'''\".'\"\"--');\n\treturn $texte;\n}\n\n// Traite les donn\u00c3\u0110es avant insertion dans une requ\u00c3\u0160te SQL\nfunction protect_data_sql($_value)\n{\n\tglobal $use_function_mysql_real_escape_string;\n\t//if (get_magic_quotes_gpc())\n\tif (function_exists('get_magic_quotes_gpc') && @get_magic_quotes_gpc())\n\t\t$_value = stripslashes($_value);\n\tif (!is_numeric($_value))\n\t{\n\t\t/*if (isset($use_function_mysql_real_escape_string) && ($use_function_mysql_real_escape_string==0))\n\t\t\t$_value = mysqli_real_escape_string($GLOBALS['db_c'], $_value);\n\t\telse */\n        // pourquoi un test, puisque l'action est la m\u00c3\u0160me ? YN le 30/03/2018\n\t\t\t$_value = mysqli_real_escape_string($GLOBALS['db_c'], $_value);\n\t}\n\treturn $_value;\n}\n\n// Traite les donn\u00c3\u0110es envoy\u00c3\u0110es par la methode GET de la variable $_GET[\"page\"], renvoie \"day\" si la page n'est pas d\u00c3\u0110finie\nfunction verif_page()\n{\n\t$page = array(\"day\", \"week\", \"month\", \"week_all\", \"month_all\", \"month_all2\", \"year\", \"year_all\");\n\tif (isset($_GET[\"page\"]))\n\t{\n\t\tif (in_array($_GET[\"page\"], $page))\n\t\t\treturn $_GET[\"page\"];\n\t\telse\n\t\t\treturn \"day\";\n\t}\n\telse\n\t\treturn \"day\";\n}\n\nfunction page_accueil($param='no') {\n   // Definition de $defaultroom\n   if ((isset($_SESSION['default_room']))&& ($_SESSION['default_room'] > -5)) {\n      $defaultroom = $_SESSION['default_room'];\n   } else {\n      $defaultroom = Settings::get(\"default_room\");\n   }\n   // Definition de $defaultsite\n   if (isset($_SESSION['default_site']) and ($_SESSION['default_site'] >0)) {\n      $defaultsite = $_SESSION['default_site'];\n   } else if (Settings::get(\"default_site\") > 0) {\n      $defaultsite = Settings::get(\"default_site\");\n   } else\n      $defaultsite = get_default_site();\n   // Definition de $defaultarea\n   if (isset($_SESSION['default_area']) and ($_SESSION['default_area'] >0)) {\n      $defaultarea = $_SESSION['default_area'];\n   } else if (Settings::get(\"default_area\") > 0) {\n      $defaultarea = Settings::get(\"default_area\");\n   } else\n      $defaultarea = get_default_area($defaultsite);\n   // Calcul de $page_accueil\n   if ($defaultarea == -1) {\n      $page_accueil=\"day.php?noarea=\"; // le param\u00c3\u013btre noarea ne sert \u00c3\u00a0 rien, il est juste l\u00c3\u00a0 pour \u00c3\u0110viter un cas particulier \u00c3\u00a0 traiter avec &amp;id_site= et $param\n   } else if ($defaultroom == -1) {\n      $page_accueil=\"day.php?area=$defaultarea\";\n   } else if ($defaultroom == -2) {\n      $page_accueil=\"week_all.php?area=$defaultarea\";\n   } else if ($defaultroom == -3) {\n      $page_accueil=\"month_all.php?area=$defaultarea\";\n   } else if ($defaultroom == -4) {\n      $page_accueil=\"month_all2.php?area=$defaultarea\";\n   } else {\n      $page_accueil=\"week.php?area=$defaultarea&amp;room=$defaultroom\";\n   }\n   if ((Settings::get(\"module_multisite\") == \"Oui\") and ($defaultsite>0))\n       $page_accueil .= \"&amp;id_site=\".$defaultsite;\n   if ($param=='yes') $page_accueil .= \"&amp;\";\n   return $page_accueil ;\n}\n\nfunction begin_page($title, $page = \"with_session\")\n{\n\tif ($page == \"with_session\")\n\t{\n\t\tif (isset($_SESSION['default_style']))\n\t\t\t$sheetcss = 'themes/'.$_SESSION['default_style'].'/css';\n\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css'; // utilise le th\u00c3\u013bme par d\u00c3\u0110faut s'il n'a pas \u00c3\u0110t\u00c3\u0110 d\u00c3\u0110fini... \u00c3\u00a0 voir YN le 11/04/2018\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (Settings::get(\"default_css\"))\n\t\t\t$sheetcss = 'themes/'.Settings::get(\"default_css\").'/css';\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css';\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\tglobal $vocab, $charset_html, $unicode_encoding, $clock_file, $use_select2, $use_admin;\n\theader('Content-Type: text/html; charset=utf-8');\n\tif (!isset($_COOKIE['open']))\n\t{\n\t\tsetcookie(\"open\", \"true\", time()+3600);\n\t}\n\t$a = '<!DOCTYPE html>'.PHP_EOL;\n\t$a .= '<html lang=\"fr\">'.PHP_EOL;\n\t$a .= '<head>'.PHP_EOL;\n\t$a .= '<meta charset=\"utf-8\">'.PHP_EOL;\n\t$a .= '<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">'.PHP_EOL;\n\t$a .= '<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">'.PHP_EOL;\n\t$a .= '<meta name=\"Robots\" content=\"noindex\" />'.PHP_EOL;\n\t$a .= '<title>'.$title.'</title>'.PHP_EOL;\n\n\tif (@file_exists('admin_accueil.php') || @file_exists('install_mysql.php')){ // Si on est dans l'administration\n\n        $a .= '<link rel=\"shortcut icon\" href=\"../favicon.ico\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../include/admin_grr.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/default/css/style.css\" />'.PHP_EOL; // le style par d\u00c3\u0110faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\u00c3\u0110\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/html2canvas.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/menu.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/functions.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui-i18n.min.js\"></script>'.PHP_EOL;\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"../js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/'.$clock_file.'\"></script>'.PHP_EOL;\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n   \t} \n    else\n    {\t\n        $a .= '<link rel=\"shortcut icon\" href=\"./favicon.ico\" />'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t    if (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n\t\t}\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/default/css/style.css\" />'.PHP_EOL; // le style par d\u00c3\u0110faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\u00c3\u0110\n\t\tif (isset($use_admin))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"include/admin_grr.css\" />'.PHP_EOL;\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui-i18n.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/html2canvas.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/menu.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/functions.js\" ></script>'.PHP_EOL;\n\t\tif (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\t}\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"./js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/'.$clock_file.'\"></script>'.PHP_EOL;\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n\t}\n\n\t$a .= '</head>'.PHP_EOL;\n\t$a .= '<body>'.PHP_EOL;\n\treturn $a;\n}\n\n/*\n** Fonction qui affiche le header\n*/\nfunction print_header($day = '', $month = '', $year = '', $type_session = 'with_session')\n{\n\tglobal $vocab, $search_str, $grrSettings, $clock_file, $desactive_VerifNomPrenomUser, $grr_script_name;\n\tglobal $use_prototype, $use_admin, $use_tooltip_js, $desactive_bandeau_sup, $id_site, $use_select2;\n\n\tif (@file_exists('./admin_access_area.php')){\n\t\t$adm = 1;\n\t\t$racine = \"../\";\n\t\t$racineAd = \"./\";\n\t}else{\n\t\t$adm = 0;\n\t\t$racine = \"./\";\n\t\t$racineAd = \"./admin/\";\n\t}\n\n\tinclude $racine.\"/include/hook.class.php\";\n\n\tif (!($desactive_VerifNomPrenomUser))\n\t\t$desactive_VerifNomPrenomUser = 'n';\n\t// On v\u00c3\u0110rifie que les noms et pr\u00c3\u0110noms ne sont pas vides\n\tVerifNomPrenomUser($type_session);\n\tif ($type_session == \"with_session\")\n\t\techo begin_page(Settings::get(\"company\"),\"with_session\");\n\telse\n\t\techo begin_page(Settings::get(\"company\"),\"no_session\");\n\n\tHook::Appel(\"hookHeader2\");\n\t// Si nous ne sommes pas dans un format imprimable\n\tif ((!isset($_GET['pview'])) || ($_GET['pview'] != 1))\n\t{\n\t\t// If we dont know the right date then make it up\n\t\tif (!isset($day) || !isset($month) || !isset($year) || ($day == '') || ($month == '') || ($year == ''))\n\t\t{\n\t\t\t$date_now = time();\n\t\t\tif ($date_now < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_now > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\telse\n\t\t\t\t$date_ = $date_now;\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t}\n\t\tif (!(isset($search_str)))\n\t\t\t$search_str = get_vocab(\"search_for\");\n\t\tif (empty($search_str))\n\t\t\t$search_str = \"\";\n\t\tif (!(isset($desactive_bandeau_sup) && ($desactive_bandeau_sup == 1) && ($type_session != 'with_session')))\n\t\t{\n\n\t\t\t// HOOK\n\t\t\tHook::Appel(\"hookHeader1\");\n\n\t\t\t// G\u00c3\u0110n\u00c3\u0110ration XML\n\t\t\t$generationXML = 1;\n\t\t\tif ((Settings::get(\"export_xml_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude \"{$racine}/include/generationxml.php\";\n\t\t\t}\n\t\t\tif ((Settings::get(\"export_xml_plus_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude \"{$racine}/include/generationxmlplus.php\";\n\t\t\t}\n\n\t\t\t// On fabrique une date valide pour la r\u00c3\u0110servation si ce n'est pas le cas\n\t\t\t$date_ = mktime(0, 0, 0, $month, $day, $year);\n\t\t\tif ($date_ < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_ > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t\techo '<div id=\"toppanel\">'.PHP_EOL;\n\t\t\techo '<div id=\"panel\">'.PHP_EOL;\n\t\t\techo '<table id=\"header\">'.PHP_EOL;\n\t\t\techo '<tr>'.PHP_EOL;\n\t\t\t//Logo\n\t\t\t$nom_picture = $racine.\"images/\".Settings::get(\"logo\");\n\t\t\tif ((Settings::get(\"logo\") != '') && (@file_exists($nom_picture)))\n\t\t\t\techo '<td class=\"logo\" height=\"100\">'.PHP_EOL.'<a href=\"'.$racine.page_accueil('yes').'day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\"><img src=\"'.$nom_picture.'\" alt=\"logo\"/></a>'.PHP_EOL.'</td>'.PHP_EOL;\n\t\t\t//Accueil\n\t\t\techo '<td class=\"accueil \">',PHP_EOL,'<h2>',PHP_EOL,'<a href=\"'.$racine.page_accueil('yes'),'day=',$day,'&amp;year=',$year,'&amp;month=',$month,'\">',Settings::get(\"company\"),'</a>',PHP_EOL,'</h2>',PHP_EOL, Settings::get('message_accueil'),'</td>',PHP_EOL;\n\t\t\t//Mail r\u00c3\u0110servation\n\t\t\t$sql = \"SELECT value FROM \".TABLE_PREFIX.\"_setting WHERE name='mail_etat_destinataire'\";\n\t\t\t$res = grr_sql_query1($sql);\n\t\t\tgrr_sql_free($res);\n\n\t\t\tif ( ( $res == 1 && $type_session == \"no_session\" ) || ( ( $res == 1 || $res == 2) && $type_session == \"with_session\" && (authGetUserLevel(getUserName(), -1, 'area')) == 1  ) )\n\t\t\t{\n\t\t\t\techo '<td class=\"contactformulaire\">',PHP_EOL,'<input class=\"btn btn-default\" type=\"submit\" rel=\"popup_name\" value=\"R\u00c3\u0110server\" onClick=\"javascript:location.href=\\'contactFormulaire.php?day=',$day,'&amp;month=',$month,'&amp;year=',$year,'\\'\" >',PHP_EOL,'</td>',PHP_EOL;\n\t\t\t}\n\t\t\t// Administration\n\t\t\tif ($type_session == \"with_session\")\n\t\t\t{\n                $user_name = getUserName();\n                $mess_resa = resaToModerate($user_name);\n\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1) || ($mess_resa != ''))\n\t\t\t\t{\n\t\t\t\t\techo '<td class=\"administration\">'.PHP_EOL;\n\t\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1))\n                        echo \"<br><a href='{$racineAd}admin_accueil.php?day={$day}&amp;month={$month}&amp;year={$year}'>\".get_vocab('admin').\"</a>\".PHP_EOL;\n\t\t\t\t\tif (authGetUserLevel(getUserName(), -1, 'area') >= 6)\n\t\t\t\t\t{\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\t\thow_many_connected();\n                        echo \"<br />\";\n\t\t\t\t\t}\n                    echo \"<p class='avertissement'>\".$mess_resa.\"</p>\";\n                    \n\t\t\t\t\techo '</td>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($type_session != \"with_session\")\n\t\t\t\techo '<script>selection()</script>'.PHP_EOL;\n\t\t\techo '<td class=\"configuration\" >'.PHP_EOL;\n\t\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t{\n\t\t\t\techo '<div class=\"clock\">'.PHP_EOL;\n\t\t\t\techo '<div id=\"Date\">'.PHP_EOL;\n\t\t\t\techo '&nbsp;<span id=\"hours\"></span>'.PHP_EOL;\n\t\t\t\techo 'h'.PHP_EOL;\n\t\t\t\techo '<span id=\"min\"></span>'.PHP_EOL;\n\t\t\t\techo '</div></div>'.PHP_EOL;\n\t\t\t}\n\t\t\t$_SESSION['chemin_retour'] = '';\n\t\t\tif (isset($_SERVER['QUERY_STRING']) && ($_SERVER['QUERY_STRING'] != ''))\n\t\t\t{\n\t\t\t\t$parametres_url = htmlspecialchars($_SERVER['QUERY_STRING']).\"&amp;\";\n\t\t\t\t$_SESSION['chemin_retour'] = traite_grr_url($grr_script_name).\"?\". $_SERVER['QUERY_STRING'];\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=fr\"><img src=\"'.$racine.'img_grr/fr_dp.png\" alt=\"France\" title=\"france\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=de\"><img src=\"'.$racine.'img_grr/de_dp.png\" alt=\"Deutch\" title=\"deutch\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=en\"><img src=\"'.$racine.'img_grr/en_dp.png\" alt=\"English\" title=\"English\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=it\"><img src=\"'.$racine.'img_grr/it_dp.png\" alt=\"Italiano\" title=\"Italiano\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=es\"><img src=\"'.$racine.'img_grr/es_dp.png\" alt=\"Spanish\" title=\"Spanish\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t}\n\t\t\tif ($type_session == 'no_session')\n\t\t\t{\n\t\t\t\tif ((Settings::get('sso_statut') == 'cas_visiteur') || (Settings::get('sso_statut') == 'cas_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br /> <a href=\"index.php?force_authentification=y\">'.get_vocab(\"authentification\").'</a>'.PHP_EOL;\n\t\t\t\t\techo '<br /> <small><i><a href=\"login.php\">'.get_vocab(\"connect_local\").'</a></i></small>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo '<br /> <a href=\"login.php\">'.get_vocab(\"connect\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif( strlen(htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom'])) > 40 )\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['nom']);\n\t\t\t\telse\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom']);\n\t\t\t\n\t\t\t\techo '<br /><a href=\"'.$racine.'my_account.php?day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\">'. $nomAffichage .' - '.get_vocab(\"manage_my_account\").'</a>'.PHP_EOL;\n\t\t\t\tif (verif_access_search(getUserName()))\n\t\t\t\t\techo '<br/><a href=\"'.$racine.'report.php\">'.get_vocab(\"report\").'</a>'.PHP_EOL;\n\t\t\t\t$disconnect_link = false;\n\t\t\t\tif (!((Settings::get(\"cacher_lien_deconnecter\") == 'y') && (isset($_SESSION['est_authentifie_sso']))))\n\t\t\t\t{\n\t\t\t\t\t$disconnect_link = true;\n\t\t\t\t\tif (Settings::get(\"authentification_obli\") == 1)\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0&amp;redirect_page_accueil=yes\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get(\"Url_portail_sso\") != '') && (isset($_SESSION['est_authentifie_sso'])))\n\t\t\t\t{\n\t\t\t\t\tif ($disconnect_link)\n\t\t\t\t\t\techo ' - '.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\techo '<a href=\"'.Settings::get(\"Url_portail_sso\").'\">'.get_vocab(\"Portail_accueil\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get('sso_statut') == 'lasso_visiteur') || (Settings::get('sso_statut') == 'lasso_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br />';\n\t\t\t\t\tif ($_SESSION['lasso_nameid'] == NULL)\n\t\t\t\t\t\techo '<a href=\"lasso/federate.php\">'.get_vocab('lasso_federate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<a href=\"lasso/defederate.php\">'.get_vocab('lasso_defederate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\techo '</td>'.PHP_EOL;\n\t\t\techo '</tr>'.PHP_EOL;\n\t\t\techo '</table>'.PHP_EOL;\n\t\t\techo '</div>'.PHP_EOL;\n\t\t\techo '<a id=\"open\" class=\"open\" href=\"#\"><span class=\"glyphicon glyphicon-arrow-up\"><span class=\"glyphicon glyphicon-arrow-down\"></span></span></a>'.PHP_EOL;\n\t\t\techo '</div>'.PHP_EOL;\n\t\t}\n\t}\n}\n\n/**\n * @param string $type\n */\nfunction VerifNomPrenomUser($type)\n{\n\t// ne pas prendre en compte la page my_account.php\n\tglobal $desactive_VerifNomPrenomUser;\n\tif (($type == \"with_session\") && ($desactive_VerifNomPrenomUser != 'y') && (IsAllowedToModifyProfil()))\n\t{\n\t\t$test = grr_sql_query1(\"SELECT login FROM \".TABLE_PREFIX.\"_utilisateurs WHERE (login = '\".getUserName().\"' AND (nom='' or prenom = ''))\");\n\t\tif ($test != -1)\n\t\t{\n\t\t\theader(\"Location:my_account.php\");\n\t\t\tdie();\n\t\t}\n\t}\n}\n//V\u00c3\u0110rifie si utilisateur autoris\u00c3\u0110 \u00c3\u00a0 changer ses noms et pr\u00c3\u0110noms et mail\n//Renvoie true (peut changer ses noms et pr\u00c3\u0110noms et email) ou false (ne peut pas)\nfunction sso_IsAllowedModify()\n{\n\tif (Settings::get(\"sso_IsNotAllowedModify\")==\"y\")\n\t{\n\t\t$source = grr_sql_query1(\"SELECT source FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".getUserName().\"'\");\n\t\tif ($source == \"ext\")\n\t\t\treturn false;\n\t\telse\n\t\t\treturn true;\n\t}\n\telse\n\t\treturn true;\n}\n//V\u00c3\u0110rifie que l'utilisateur est autoris\u00c3\u0110 \u00c3\u00a0 changer ses noms et pr\u00c3\u0110noms\n//Renvoie true (peut changer ses noms et pr\u00c3\u0110noms) ou false (ne peut pas)\nfunction IsAllowedToModifyProfil()\n{\n\tif (!(sso_IsAllowedModify()))\n\t\treturn false;\n\t\t// l'utilisateur connect\u00c3\u0110 n'a pas le niveau suffisant pour modifier son compte\n\tif (authGetUserLevel(getUserName(),-1) < Settings::get(\"allow_users_modify_profil\"))\n\t\treturn false;\n\telse\n\t\treturn true;\n}\n//V\u00c3\u0110rifie que l'utilisateur est autoris\u00c3\u0110 \u00c3\u00a0 changer son emai\n//Renvoie true (peut changer son email) ou false (ne peut pas)\nfunction IsAllowedToModifyEmail()\n{\n\tif (!(sso_IsAllowedModify()))\n\t\treturn false;\n\t\t// l'utilisateur connect\u00c3\u0110 n'a pas le niveau suffisant pour modifier son compte\n\tif (authGetUserLevel(getUserName(),-1) < Settings::get(\"allow_users_modify_email\"))\n\t\treturn false;\n\telse\n\t\treturn true;\n}\n//V\u00c3\u0110rifie que l'utilisateur est autoris\u00c3\u0110 \u00c3\u00a0 changer son mot de passe\n//Renvoie true (peut changer) ou false (ne peut pas)\nfunction IsAllowedToModifyMdp() {\n\t\t// l'utilisateur connect\u00c3\u0110 n'a pas le niveau suffisant pour modifier son compte\n\tif (authGetUserLevel(getUserName(), -1) < Settings::get(\"allow_users_modify_mdp\"))\n\t\treturn false;\n\telse if ((Settings::get(\"sso_statut\") != \"\") or (Settings::get(\"ldap_statut\") != '') or (Settings::get(\"imap_statut\") != ''))\n\t{\n\t\t\t// ou bien on est dans un environnement SSO ou ldap et l'utilisateur n'est pas un utilisateur local\n\t\t$source = grr_sql_query1(\"SELECT source FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".getUserName().\"'\");\n\t\tif ($source == \"ext\")\n\t\t\treturn false;\n\t\telse\n\t\t\treturn true;\n\t}\n\telse\n\t\treturn true;\n}\n// Transforme $dur en une dur\u00c3\u0110e exprim\u00c3\u0110e en ann\u00c3\u0110es, semaines, jours, heures, minutes et secondes\n// OU en dur\u00c3\u0110e num\u00c3\u0110rique exprim\u00c3\u0110e dans l'une des unit\u00c3\u0110s de fa\u00c3\u00a7on fixe, pour l'\u00c3\u0110dition des\n// r\u00c3\u0110servations par dur\u00c3\u0110e.\n// $dur : dur\u00c3\u0110e sous forme d'une chaine de caract\u00c3\u013bre quandd $edition=false, sinon, dur\u00c3\u0110e en valeur num\u00c3\u0110rique.\n// $units : variable conserv\u00c3\u0110e uniquement pour compatibilit\u00c3\u0110 avec la fonction toTimeString originale\n//          si $edition=false, sinon, contient l'unit\u00c3\u0110 utilis\u00c3\u0110e pour $dur\n// $edition : Valeur par d\u00c3\u0110faut : false. Indique si le retour est pour affichage ou pour modifier la dur\u00c3\u0110e.\n// Version \u00c3\u0110crite par David M - E-Concept Applications\nfunction toTimeString(&$dur, &$units, $edition = false)\n{\n\tglobal $vocab;\n\tif ($edition)\n\t{\n\t\tif ($dur >= 60)\n\t\t{\n\t\t\t$dur = $dur / 60;\n\t\t\tif ($dur >= 60)\n\t\t\t{\n\t\t\t\t$dur /= 60;\n\t\t\t\tif (($dur >= 24) && ($dur % 24 == 0))\n\t\t\t\t{\n\t\t\t\t\t$dur /= 24;\n\t\t\t\t\tif (($dur >= 7) && ($dur % 7 == 0))\n\t\t\t\t\t{\n\t\t\t\t\t\t$dur /= 7;\n\t\t\t\t\t\tif (($dur >= 52) && ($dur % 52 == 0))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$dur  /= 52;\n\t\t\t\t\t\t\t$units = get_vocab(\"years\");\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\t$units = get_vocab(\"weeks\");\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t\t$units = get_vocab(\"days\");\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\t$units = get_vocab(\"hours\");\n\t\t\t}\n\t\t\telse\n\t\t\t\t$units = get_vocab(\"minutes\");\n\t\t}\n\t\telse\n\t\t\t$units = get_vocab(\"seconds\");\n\t}\n\telse\n\t{\n\t\t$duree_formatee = \"\";\n\t\t$not_first_unit = false;\n\t\t// On d\u00c3\u0110finit la dur\u00c3\u0110e en secondes de chaque type d'unit\u00c3\u0110\n\t\t$annee   = 60 * 60 * 24 * 365;\n\t\t$semaine = 60 * 60 * 24 * 7;\n\t\t$jour    = 60 * 60 * 24;\n\t\t$heure   = 60 * 60;\n\t\t$minute  = 60;\n\t\t// On calcule le nombre d'ann\u00c3\u0110es.\n\t\t$nb_annees = floor($dur / $annee);\n\t\tif ($nb_annees > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_annees . \" \" . get_vocab(\"years\");\n\t\t\t// On soustrait le nombre d'ann\u00c3\u0110es d\u00c3\u0110j\u00c3\u00a0 d\u00c3\u0110termin\u00c3\u0110es \u00c3\u00a0 la dur\u00c3\u0110e initiale.\n\t\t\t$dur = $dur - $nb_annees * $annee;\n\t\t}\n\t\t// On calcule le nombre de semaines.\n\t\t$nb_semaines = floor($dur / $semaine);\n\t\tif ($nb_semaines > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_semaines . \" \" . get_vocab(\"weeks\");\n\t\t\t// On soustrait le nombre de semaines d\u00c3\u0110j\u00c3\u00a0 d\u00c3\u0110termin\u00c3\u0110es \u00c3\u00a0 la dur\u00c3\u0110e initiale.\n\t\t\t$dur = $dur - $nb_semaines * $semaine;\n\t\t}\n\t\t// On calcule le nombre de jours.\n\t\t$nb_jours = floor($dur / $jour);\n\t\tif ($nb_jours > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_jours . \" \" . get_vocab(\"days\");\n\t\t\t// On soustrait le nombre de jours d\u00c3\u0110j\u00c3\u00a0 d\u00c3\u0110termin\u00c3\u0110s \u00c3\u00a0 la dur\u00c3\u0110e initiale.\n\t\t\t$dur = $dur - $nb_jours * $jour;\n\t\t}\n\t\t// On calcule le nombre d'heures.\n\t\t$nb_heures = floor($dur / $heure);\n\t\tif ($nb_heures > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_heures . \" \" . get_vocab(\"hours\");\n\t\t\t// On soustrait le nombre d'heures d\u00c3\u0110j\u00c3\u00a0 d\u00c3\u0110termin\u00c3\u0110es \u00c3\u00a0 la dur\u00c3\u0110e initiale.\n\t\t\t$dur = $dur - $nb_heures * $heure;\n\t\t}\n\t\t// On calcule le nombre de minutes.\n\t\t$nb_minutes = floor($dur / $minute);\n\t\tif ($nb_minutes > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\telse\n\t\t\t\t$not_first_unit = true;\n\t\t\t$duree_formatee .= $nb_minutes . \" \" . get_vocab(\"minutes\");\n\t\t\t\t\t\t// On soustrait le nombre de minutes d\u00c3\u0110j\u00c3\u00a0 d\u00c3\u0110termin\u00c3\u0110es \u00c3\u00a0 la dur\u00c3\u0110e initiale.\n\t\t\t$dur = $dur - $nb_minutes * $minute;\n\t\t}\n\t\t\t\t// On calcule le nombre de secondes.\n\t\tif ($dur > 0)\n\t\t{\n\t\t\tif ($not_first_unit)\n\t\t\t\t$duree_formatee .= \", \";\n\t\t\t$duree_formatee .= $dur . \" \" . get_vocab(\"seconds\");\n\t\t}\n\t\t// On s\u00c3\u0110pare les diff\u00c3\u0110rentes unit\u00c3\u0110s de la chaine.\n\t\t$tmp = explode(\", \", $duree_formatee);\n\t\t// Si on a plus d'une unit\u00c3\u0110e...\n\t\tif (count($tmp) > 1)\n\t\t{\n\t\t\t// ... on d\u00c3\u0110pile le tableau par la fin...\n\t\t\t$tmp_fin = array_pop($tmp);\n\t\t\t// ... on reconstiture la chaine avec les premiers \u00c3\u0110l\u00c3\u0110ments...\n\t\t\t$duree_formatee = implode(\", \", $tmp);\n\t\t\t// ... et on ajoute le dernier \u00c3\u0110l\u00c3\u0110ment\n\t\t\t$duree_formatee .= \" et \" . $tmp_fin;\n\t\t}\n\t\t// Sinon, on ne change rien.\n\t\t$dur = $duree_formatee;\n\t\t$units = \"\";\n\t}\n}\n// Transforme $dur en un nombre entier\n// $dur : dur\u00c3\u0110e\n// $units : unit\u00c3\u0110\n/**\n * @param integer $start_period\n */\nfunction toPeriodString($start_period, &$dur, &$units)\n{\n\t// la dur\u00c3\u0110e est donn\u00c3\u0110e en secondes\n\tglobal $enable_periods, $periods_name, $vocab;\n\t$max_periods = count($periods_name);\n\t$dur /= 60; // on transforme la dur\u00c3\u0110e en minutes\n\t// Chaque minute correspond \u00c3\u00a0 un cr\u00c3\u0110neau\n\tif ( $dur >= $max_periods || $start_period == 0 )\n\t{\n\t\tif ( $start_period == 0 && $dur == $max_periods )\n\t\t{\n\t\t\t$units = get_vocab(\"periods\");\n\t\t\t$dur = $max_periods;\n\t\t\treturn;\n\t\t}\n\t\t$dur /= 60;\n\t\tif (($dur >= 24) && is_int($dur))\n\t\t{\n\t\t\t$dur /= 24;\n\t\t\t$units = get_vocab(\"days\");\n\t\t\treturn;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$dur *= 60;\n\t\t\t$dur = ($dur % $max_periods) + floor( $dur/(24*60) ) * $max_periods;\n\t\t\t$units = get_vocab(\"periods\");\n\t\t\treturn;\n\t\t}\n\t}\n\telse\n\t\t$units = get_vocab(\"periods\");\n}\n\n/**\n* @param string $prefix\n* @param string $option\n*/\nfunction genDateSelectorForm($prefix, $day, $month, $year, $option)\n{\n\tglobal $nb_year_calendar;\n\t$selector_data = \"\";\n\tif (!isset($nb_year_calendar))\n\t\t$nb_year_calendar = 5;\n\tif (($day == 0) && ( $day != \"\"))\n\t\t$day = date(\"d\");\n\tif ($month == 0)\n\t\t$month = date(\"m\");\n\tif ($year == 0)\n\t\t$year = date(\"y\");\n\tif ($day != \"\")\n\t{\n\t\t$selector_data .= \"<select class='test' name=\\\"${prefix}day\\\" id=\\\"${prefix}day\\\">\\n\";\n\t\tfor ($i = 1; $i <= 31; $i++)\n\t\t{\n\t\t\tif ($i < 10)\n\t\t\t\t$selector_data .= \"<option\" . ($i == $day ? \" selected=\\\"selected\\\"\" : \"\") . \">0$i</option>\\n\";\n\t\t\telse\n\t\t\t\t$selector_data .= \"<option\" . ($i == $day ? \" selected=\\\"selected\\\"\" : \"\") . \">$i</option>\\n\";\n\t\t}\n\t\t$selector_data .= \"</select>\";\n\t}\n\t$selector_data .= \"<select class='test' name=\\\"${prefix}month\\\" id=\\\"${prefix}month\\\">\\n\";\n\tfor ($i = 1; $i <= 12; $i++)\n\t{\n\t\t$m = utf8_strftime(\"%b\", mktime(0, 0, 0, $i, 1, $year));\n\t\tif ($i < 10)\n\t\t{\n\t\t\t$selector_data .=  \"<option value=\\\"0$i\\\"\" . ($i == $month ? \" selected=\\\"selected\\\"\" : \"\") . \">$m</option>\\n\";\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$selector_data .=  \"<option value=\\\"$i\\\"\" . ($i == $month ? \" selected=\\\"selected\\\"\" : \"\") . \">$m</option>\\n\";\n\t\t}\n\t}\n\t$selector_data .=  \"</select>\";\n\t$selector_data .=  \"<select class='test' name=\\\"${prefix}year\\\" id=\\\"${prefix}year\\\">\\n\";\n\t$min = strftime(\"%Y\", Settings::get(\"begin_bookings\"));\n\tif ($option == \"more_years\")\n\t\t$min = date(\"Y\") - $nb_year_calendar;\n\t$max = strftime(\"%Y\", Settings::get(\"end_bookings\"));\n\tif ($option == \"more_years\")\n\t\t$max = date(\"Y\") + $nb_year_calendar;\n\tfor($i = $min; $i <= $max; $i++)\n\t\t$selector_data .= \"<option value=\\\"$i\\\" \" . ($i == $year ? \" selected=\\\"selected\\\"\" : \"\") . \">$i</option>\\n\";\n\t$selector_data .= \"</select> \\n\\n\";\n\treturn $selector_data;\n}\n\n/**\n * @param string $prefix\n * @param string $option\n */\nfunction genDateSelector($prefix, $day, $month, $year, $option)\n{\n\techo genDateSelectorForm($prefix, $day, $month, $year, $option);\n}\n\n/**\n * @param integer $need_header\n */\nfunction fatal_error($need_header, $message, $show_form_data = true)\n{\n\tglobal $vocab;\n\tif ($need_header)\n\t\tstart_page_w_header(0, 0, 0, 0);\n\terror_log(\"GRR: \".$message);\n\tif ($show_form_data)\n\t{\n\t\tif (!empty($_GET))\n\t\t{\n\t\t\terror_log(\"GRR GET: \".print_r($_GET, true));\n\t\t}\n\t\tif (!empty($_POST))\n\t\t{\n\t\t\terror_log(\"GRR POST: \".print_r($_POST, true));\n\t\t}\n\t}\n\tif (!empty($_SESSION))\n\t{\n\t\terror_log(\"GRR SESSION: \".print_r($_SESSION, true));\n\t}\n\techo '<p>',$message,'</p>'.PHP_EOL;\n\tend_page();\n\texit;\n}\n\n/**\n * Compare une ip \u00c3\u00a0 d'autres iP - CIDR\n */\nfunction compare_ip_adr($ip1, $ips2)\n{\n\n\t$ipCorrespondante = false;\n    $ip2 = explode(';', $ips2);\n\t\n    $resultIP = in_array($ip1,$ip2,true);\n\tif($resultIP == false){ // cherche si l'adresse est dans une plage CIDR p.ex. 192.168.1.0/24 --> 192.168.1.0 \u00c3\u00a0 192.168.1.255\n        foreach ($ip2 as $ip){\n            $slash = strpos($ip,'/');\n            if ($slash !== false){\n                list($net,$mask) = preg_split(\"~/~\",$ip);\n                $lnet=ip2long($net);\n                $lip=ip2long($ip1);\n                $binnet=str_pad( decbin($lnet),32,\"0\",STR_PAD_LEFT );\n                $firstpart=substr($binnet,0,$mask);\n                $binip=str_pad( decbin($lip),32,\"0\",STR_PAD_LEFT );\n                $firstip=substr($binip,0,$mask);\n                $resultIP = (strcmp($firstpart,$firstip)==0);\n            }\n            if ($resultIP){\n\t\t\t\t$ipCorrespondante = true;\n\t\t\t\tbreak;\n\t\t\t}\n        }\n\t} else {\n\t\t$ipCorrespondante = true;\n\t}\n\n\treturn $ipCorrespondante;\n\n}\n\n//Retourne le domaine par d\u00c3\u0110faut; Utilis\u00c3\u0110 si aucun domaine n'a \u00c3\u0110t\u00c3\u0110 d\u00c3\u0110fini.\nfunction get_default_area($id_site = -1)\n{\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multisite = true;\n\telse\n\t\t$use_multisite = false;\n\tif (OPTION_IP_ADR==1)\n\t{\n\t\t$sql = \"SELECT ip_adr, id FROM \".TABLE_PREFIX.\"_area WHERE ip_adr!='' ORDER BY access, order_display, area_name\";\n\t\t$res = grr_sql_query($sql);\n\t\tif ($res)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (compare_ip_adr($_SERVER['REMOTE_ADDR'],$row[0]))\n\t\t\t\t{\n\t\t\t\t\treturn $row[1];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tif (authGetUserLevel(getUserName(),-1) >= 6)\n\t{\n\t\tif (($id_site != -1) and ($use_multisite))\n\t\t\t$res = grr_sql_query(\"SELECT a.id\n\t\t\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\t\t\tWHERE a.id=j.id_area and j.id_site=$id_site\n\t\t\t\tORDER BY a.order_display, a.area_name\");\n\t\telse\n\t\t\t$res = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_area ORDER BY access, order_display, area_name\");\n\t}\n\telse\n\t{\n\t\tif (($id_site != -1) and ($use_multisite))\n\t\t\t$res = grr_sql_query(\"SELECT a.id\n\t\t\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\t\t\tWHERE a.id=j.id_area and j.id_site=$id_site and a.access!='r'\n\t\t\t\tORDER BY a.order_display, a.area_name\");\n\t\telse\n\t\t\t$res = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE access!='r' ORDER BY access, order_display, area_name\");\n\t}\n\tif ($res && grr_sql_count($res)>0 )\n\t{\n\t\t$row = grr_sql_row($res, 0);\n\t\tgrr_sql_free($res);\n\t\treturn $row[0];\n\t}\n\telse\n\t{\n\t\tif (($id_site != -1) and ($use_multisite))\n\t\t\t$res = grr_sql_query(\"SELECT a.id\n\t\t\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j, \".TABLE_PREFIX.\"_j_user_area u\n\t\t\t\tWHERE a.id=j.id_area and j.id_site=$id_site and a.id=u.id_area and u.login='\" . getUserName() . \"'\n\t\t\t\tORDER BY a.order_display, a.area_name\");\n\t\telse\n\t\t\t$res = grr_sql_query(\"select id from \".TABLE_PREFIX.\"_area, \".TABLE_PREFIX.\"_j_user_area WHERE\n\t\t\t\t\".TABLE_PREFIX.\"_area.id=\".TABLE_PREFIX.\"_j_user_area.id_area and\n\t\t\t\tlogin='\" . getUserName() . \"'\n\t\t\t\tORDER BY order_display, area_name\");\n\t\tif ($res && grr_sql_count($res)>0 )\n\t\t{\n\t\t\t$row = grr_sql_row($res, 0);\n\t\t\tgrr_sql_free($res);\n\t\t\treturn $row[0];\n\t\t}\n\t\telse\n\t\t\treturn -1;\n\t}\n}\n/* fonction get_default_site\n    renvoie id_site du site par d\u00c3\u0110faut de l'utilisateur, sinon celui de la table setting, sinon celui de plus petit id dans la table site\n*/\n\nfunction get_default_site()\n{\n    $user = getUserName();\n    if ($user != ''){\n        $id_site = grr_sql_query1(\"SELECT default_site FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login =\".$user);\n        if ($id_site > 0){return $id_site;}\n    }\n    // ici l'utilisateur n'est pas reconnu ou il n'a pas de site par d\u00c3\u0110faut : on passe aux informations de la table settings\n    $id_site = grr_sql_query1(\"SELECT VALUE FROM \".TABLE_PREFIX.\"_setting WHERE NAME ='default_site' \");\n    $test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_site WHERE id = \".$id_site);\n    if ($test >0){return $id_site;}\n    else { // il n'y a pas de site par d\u00c3\u0110faut dans la table setting, on prend le premier site\n        $id_site = grr_sql_query1(\"SELECT min(id) FROM \".TABLE_PREFIX.\"_site \");\n        return($id_site);\n    }\n}\n// fonction get_default_room\n/*  renvoie id_room de la ressource par d\u00c3\u0110faut de l'utilisateur, sinon celle de la table setting, sinon celle de plus petit indice dans la table room \n*/\nfunction get_default_room(){\n    $user = getUserName();\n    if ($user != ''){\n        $id_room = grr_sql_query1(\"SELECT default_room FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login =\".$user);\n        if ($id_room > 0){return $id_room;}\n    }\n    // ici l'utilisateur n'est pas reconnu ou il n'a pas de ressource par d\u00c3\u0110faut : on passe aux informations de la table settings\n    $id_room = grr_sql_query1(\"SELECT VALUE FROM \".TABLE_PREFIX.\"_setting WHERE NAME ='default_room' \");\n    $test = grr_sql_query1(\"SELECT id FROM \".TABLE_PREFIX.\"_room WHERE id = \".$id_room);\n    if ($test >0){return $id;}\n    else { // il n'y a pas de ressource par d\u00c3\u0110faut dans la table setting, on prend la premi\u00c3\u013bre ressource\n        $id_room = grr_sql_query1(\"SELECT min(id) FROM \".TABLE_PREFIX.\"_room \");\n        return($id_room);\n    }\n}\n# Get the local day name based on language. Note 2000-01-02 is a Sunday.\n/**\n * @param integer $daynumber\n */\nfunction day_name($daynumber)\n{\n\treturn utf8_encode(strftime(\"%A\", mktime(0, 0, 0, 1, 2 + $daynumber, 2000)));\n}\n\nfunction affiche_heure_creneau($t,$resolution)\n{\n\tglobal $twentyfourhour_format;\n\tif ($twentyfourhour_format)\n\t\t$hour_min_format = \"H:i\";\n\telse\n\t\t$hour_min_format = \"h:ia\";\n    $heure_debut = date($hour_min_format,$t);\n    $heure_fin = date($hour_min_format, $t + $resolution);\n    if ($heure_fin == \"00:00\") $heure_fin = \"24:00\";\n\treturn  $heure_debut.\" - \".$heure_fin;\n}\n\nfunction hour_min_format()\n{\n\tglobal $twentyfourhour_format;\n\tif ($twentyfourhour_format)\n\t{\n\t\treturn \"H:i\";\n\t}\n\telse\n\t{\n\t\treturn \"h:ia\";\n\t}\n}\n\n/*\nFonction utilis\u00c3\u0110e dans le cas o\u00c3\u0111 les cr\u00c3\u0110neaux de r\u00c3\u0110servation sont bas\u00c3\u0110s sur des intitul\u00c3\u0110s pr\u00c3\u0110-d\u00c3\u0110finis :\nFormatage de la date de d\u00c3\u0110but ou de fin de r\u00c3\u0110servation.\nDans le cas du d\u00c3\u0110but de r\u00c3\u0110servation on a $mod_time=0\nDans le cas de la fin de r\u00c3\u0110servation on a $mod_time=-1\n*/\nfunction period_date_string($t, $mod_time = 0)\n{\n\tglobal $periods_name, $dformat;\n\t$time = getdate($t);\n\t$p_num = $time[\"minutes\"] + $mod_time;\n\tif ( $p_num < 0 )\n\t{\n\t\t// fin de r\u00c3\u0110servation : cas $time[\"minutes\"] = 0. il faut afficher le dernier cr\u00c3\u0110neau de la journ\u00c3\u0110e pr\u00c3\u0110c\u00c3\u0110dente\n\t\t$t = $t - 60 * 60 * 24;\n\t\t$p_num = count($periods_name) - $p_num;\n\t}\n\tif ( $p_num >= count($periods_name) - 1 )\n\t\t$p_num = count($periods_name) - 1;\n\treturn array($p_num, $periods_name[$p_num] . utf8_strftime(\", \".$dformat, $t));\n}\n// la m\u00c3\u0160me, avec un r\u00c3\u0110sultat diff\u00c3\u0110rent, pour les rapports csv\nfunction period_date_string_rapport($t, $mod_time = 0)\n{\n\tglobal $periods_name, $dformat;\n\t$time = getdate($t);\n\t$p_num = $time[\"minutes\"] + $mod_time;\n\tif ( $p_num < 0 )\n\t{\n\t\t// fin de r\u00c3\u0110servation : cas $time[\"minutes\"] = 0. il faut afficher le dernier cr\u00c3\u0110neau de la journ\u00c3\u0110e pr\u00c3\u0110c\u00c3\u0110dente\n\t\t$t = $t - 60 * 60 * 24;\n\t\t$p_num = count($periods_name) - $p_num;\n\t}\n\tif ( $p_num >= count($periods_name) - 1 )\n\t\t$p_num = count($periods_name) - 1;\n\treturn array($periods_name[$p_num],utf8_strftime($dformat, $t));\n}\n/*\nFonction utilis\u00c3\u0110e dans le cas o\u00c3\u0111 les cr\u00c3\u0110neaux de r\u00c3\u0110servation sont bas\u00c3\u0110s sur des intitul\u00c3\u0110s pr\u00c3\u0110-d\u00c3\u0110finis :\nFormatage des p\u00c3\u0110riodes de d\u00c3\u0110but ou de fin de r\u00c3\u0110servation.\nDans le cas du d\u00c3\u0110but de r\u00c3\u0110servation on a $mod_time=0\nDans le cas de la fin de r\u00c3\u0110servation on a $mod_time=-1\n*/\nfunction period_time_string($t, $mod_time = 0)\n{\n\tglobal $periods_name;\n\t$time = getdate($t);\n\t$p_num = $time[\"minutes\"] + $mod_time;\n\tif ( $p_num < 0 )\n\t\t$p_num = 0;\n\tif ( $p_num >= count($periods_name) - 1 )\n\t\t$p_num = count($periods_name) - 1;\n\treturn $periods_name[$p_num];\n}\n/* donne, pour un format fran\u00c3\u00a7ais, un r\u00c3\u0110sultat de la forme lundi 30 sept. - 19:17\n*/\nfunction time_date_string($t, $dformat)\n{\n\tglobal $twentyfourhour_format;\n\t// This bit's necessary, because it seems %p in strftime format\n\t// strings doesn't work\n\tif ($twentyfourhour_format)\n\t\treturn utf8_strftime($dformat.\" - %H:%M\",$t);\n\telse\n\t\treturn utf8_strftime(\"%I:%M\".date(\"a\", $t).\" - \".$dformat,$t);\n}\n\nfunction time_date_string_jma($t,$dformat)\n{\n\treturn utf8_strftime($dformat, $t);\n}\n/*\nancien code. Je ne vois pas l'int\u00c3\u0110r\u00c3\u0160t du test YN le 25/09/19\n{\n\tglobal $twentyfourhour_format;\n\t//his bit's necessary, because it seems %p in strftime format\n\t//strings doesn't work\n\tif ($twentyfourhour_format)\n\t\treturn utf8_strftime($dformat, $t);\n\telse\n\t\treturn utf8_strftime($dformat, $t);\n}*/\n\n// Renvoie une balise span avec un style background-color correspondant au type de  la r\u00c3\u0110servation\nfunction span_bgground($colclass)\n{\n\tglobal $tab_couleur;\n\tstatic $ecolors;\n\t$couleurhexa = grr_sql_query1(\"SELECT couleurhexa FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n\techo '<span style=\"background-color: '.$couleurhexa.'; background-image: none; background-repeat: repeat; background-attachment: scroll;\">'.PHP_EOL;\n}\n\n//Output a start table cell tag <td> with color class and fallback color.\nfunction tdcell($colclass, $width = '')\n{\n\tif ($width != \"\")\n\t\t$temp = ' style=\"width:'.$width.'%;\" ';\n\telse\n\t\t$temp = \"\";\n\tglobal $tab_couleur;\n\tstatic $ecolors;\n\tif (($colclass >= \"A\") && ($colclass <= \"Z\"))\n\t{\n\t\t/*$couleurhexa = grr_sql_query1(\"SELECT couleurhexa FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n        $couleur_texte = grr_sql_query1(\"SELECT couleur_texte FROM\".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n\t\techo '<td style=\"background-color:'.$couleurhexa.'; color:'.$couleur_texte.';\" '.$temp.'>'.PHP_EOL;*/\n        echo '<td class=\"type'.$colclass.'\"'.$temp.'>';\n\t}\n\telse\n\t\techo '<td class=\"'.$colclass.'\" '.$temp.'>'.PHP_EOL;\n}\n\nfunction tdcell_rowspan($colclass, $step)\n{\n\tglobal $tab_couleur;\n\tstatic $ecolors;\n\tif ($step < 1)\n\t\t$step = 1;\n\tif (($colclass >= \"A\") && ($colclass <= \"Z\"))\n\t{\n\t\t/*$couleurhexa = grr_sql_query1(\"SELECT couleurhexa FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$colclass.\"'\");\n\t\techo '<td rowspan=\"'.$step.'\" style=\"background-color:'.$couleurhexa.';\">'.PHP_EOL;*/\n        echo '<td class=\"type'.$colclass.'\" rowspan=\"'.$step.'\">';\n\t}\n\telse\n\t\techo '<td rowspan=\"'.$step.'\" class=\"'.$colclass.'\">'.PHP_EOL;\n}\n\n//Display the entry-type color key. This has up to 2 rows, up to 10 columns.\nfunction show_colour_key($area_id)\n{\n    $sql = \"SELECT DISTINCT t.id, t.type_name, t.type_letter, t.order_display FROM `\".TABLE_PREFIX.\"_type_area` t\n    LEFT JOIN `\".TABLE_PREFIX.\"_j_type_area` j on j.id_type=t.id\n    WHERE (j.id_area IS NULL or j.id_area != '\".$area_id.\"')\n    AND NOT EXISTS (SELECT y.id_type FROM `\".TABLE_PREFIX.\"_j_type_area` y WHERE y.id_type = j.id_type and id_area='\".$area_id.\"')\n    ORDER BY t.order_display\";\n    $res = grr_sql_query($sql);\n    echo '<table class=\"legende\">';\n    echo '<caption>'.get_vocab(\"show_color_key\").'</caption>'.PHP_EOL;\n    if ($res)\n    {\n        $nct = -1;\n        for ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n        {\n            $type_name = $row[1];\n            $type_letter = $row[2];\n            if ($nct == -1)\n                echo '<tr>'.PHP_EOL;\n            if (++$nct == 2)\n            {\n                $nct = 0;\n                echo '</tr>'.PHP_EOL, '<tr>'.PHP_EOL;\n            }\n            tdcell($type_letter);\n            echo $type_name, '</td>'.PHP_EOL;\n        }\n        if ($i % 2 == 1)\n\t\t\techo '<td></td>',PHP_EOL;\n\t\techo '</tr>'.PHP_EOL;\n    }\n    echo '</table>'.PHP_EOL;\n}\n\n//Display the entry-type color keys. This has up to 2 rows, up to 10 columns.\nfunction show_colour_keys()\n{\n\techo '<table class=\"legende\">';\n    echo '<caption>'.get_vocab(\"show_color_key\").'</caption>'.PHP_EOL;\n\t$sql = \"SELECT DISTINCT id, type_name, type_letter, order_display FROM `\".TABLE_PREFIX.\"_type_area` \";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\t$nct = -1;\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n            $type_name   = $row[1];\n            $type_letter = $row[2];\n            if ($nct == -1)\n                echo '<tr>'.PHP_EOL;\n            if (++$nct == 2)\n            {\n                $nct = 0;\n                echo '</tr>'.PHP_EOL, '<tr>'.PHP_EOL;\n            }\n            tdcell($type_letter);\n            echo $type_name, '</td>'.PHP_EOL;\n\t\t}\n\t\tif ($i % 2 == 1)\n\t\t\techo '<td></td>',PHP_EOL;\n\t\techo '</tr>'.PHP_EOL;\n\t}\n\techo '</table>'.PHP_EOL;\n}\n// transforme une chaine de caract\u00c3\u013bres en couleur hexad\u00c3\u0110cimale valide\nfunction valid_color($entry)\n{\n\t$out = preg_replace('/[^a-fA-F0-9]/','',$entry);\n\tif (strlen($out)<4)\n\t{\n\t\t$out = '#'.substr($out.'000',0,3);\n\t}\n\telse //if (strlen($out)<7)\n\t{\n\t\t$out = '#'.substr($out.'000',0,6);\n\t}\n\treturn($out);\n}\n//Round time down to the nearest resolution\nfunction round_t_down($t, $resolution, $am7)\n{\n\treturn (int)$t - (int)abs(((int)$t-(int)$am7) % $resolution);\n}\n\n//Round time up to the nearest resolution\nfunction round_t_up($t, $resolution, $am7)\n{\n\tif (($t - $am7) % $resolution != 0)\n\t{\n\t\treturn $t + $resolution - abs(((int)$t - (int)$am7) % $resolution);\n\t}\n\telse\n\t{\n\t\treturn $t;\n\t}\n}\n\n/**\n * Menu gauche affichage des sites via select\n *\n * @param string $link\n * @param string $current_site\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_site_select_html($link, $current_site, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\t$nb_sites_a_afficher = 0;\n\t$out_html = '<b><i>'.get_vocab('sites').get_vocab('deux_points').'</i></b><form id=\"site_001\" action=\"'.$_SERVER['PHP_SELF'].'\"><div>';\n\t$out_html .= '<select class=\"form-control\" name=\"site\" onchange=\"site_go()\">';\n\tif (strncmp(\"4.1\", grr_sql_version(), 3) < 0)\n\t{\n\t\t$sql = \"SELECT id,sitename\n\t\tFROM \".TABLE_PREFIX.\"_site\n\t\tWHERE \".TABLE_PREFIX.\"_site.id IN (SELECT id_site FROM \".TABLE_PREFIX.\"_j_site_area GROUP BY id_site)\n\t\tORDER BY id ASC\";\n\t}\n\telse\n\t{\n\t\t$sql = \"SELECT id, sitename\n\t\tFROM \".TABLE_PREFIX.\"_site\n\t\tleft join \".TABLE_PREFIX.\"_j_site_area on \".TABLE_PREFIX.\"_site.id = \".TABLE_PREFIX.\"_j_site_area.id_site\n\t\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site is not null\n\t\tGROUP BY id_site\n\t\tORDER BY id ASC\n\t\t\";\n\t}\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t// Pour chaque site, on d\u00c3\u0110termine le premier domaine disponible\n\t\t\t$sql = \"SELECT id_area\n\t\t\tFROM \".TABLE_PREFIX.\"_j_site_area\n\t\t\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site='\".$row[0].\"'\";\n\t\t\t$res2 = grr_sql_query($sql);\n\t\t\t\t\t\t\t// A on un r\u00c3\u0110sultat ?\n\t\t\t$default_area = -1;\n\t\t\tif ($res2 && grr_sql_count($res2) > 0)\n\t\t\t{\n\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t{\n\t\t\t\t\tif (authUserAccesArea($user,$row2[0]) == 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t// on a trouv\u00c3\u0110 un domaine autoris\u00c3\u0110\n\t\t\t\t\t\t$default_area = $row2[0];\n\t\t\t\t\t\t$j = grr_sql_count($res2) + 1;\n\t\t\t\t\t\t// On arr\u00c3\u0160te la boucle\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// On lib\u00c3\u013bre la ressource2\n\t\t\tgrr_sql_free($res2);\n\t\t\tif ($default_area != -1)\n\t\t\t{\n\t\t\t\t// on affiche le site uniquement si au moins un domaine est visible par l'utilisateur\n\t\t\t\t$nb_sites_a_afficher++;\n\t\t\t\t$selected = ($row[0] == $current_site) ? 'selected=\"selected\"' : '';\n\t\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$default_area;\n\t\t\t\t$out_html .= '<option '.$selected.' value=\"'.$link2.'\">'.htmlspecialchars($row[1]).'</option>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\tif ($nb_sites_a_afficher > 1)\n\t{\n\t\t$out_html .= \"</select>\".PHP_EOL;\n\t\t$out_html .= \"</div>\".PHP_EOL;\n\t\t$out_html .= \"<script type=\\\"text/javascript\\\">\".PHP_EOL;\n\t\t$out_html .= \"function site_go()\".PHP_EOL;\n\t\t$out_html .= \"{\".PHP_EOL;\n\t\t$out_html .= \"box = document.getElementById(\\\"site_001\\\").site;\".PHP_EOL;\n\t\t$out_html .= \"destination = box.options[box.selectedIndex].value;\".PHP_EOL;\n\t\t$out_html .= \"if (destination) location.href = destination;\".PHP_EOL;\n\t\t$out_html .= \"}\".PHP_EOL;\n\t\t$out_html .= \"</script>\".PHP_EOL;\n\t\t$out_html .= \"<noscript>\".PHP_EOL;\n\t\t$out_html .= \"<div>\".PHP_EOL;\n\t\t$out_html .= \"<input type=\\\"submit\\\" value=\\\"Change\\\" />\".PHP_EOL;\n\t\t$out_html .= \"</div>\".PHP_EOL;\n\t\t$out_html .= \"</noscript>\".PHP_EOL;\n\t\t$out_html .= \"</form>\".PHP_EOL;\n\t\treturn $out_html;\n\t}\n}\n\n/**\n * Menu gauche affichage des area via select\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_area_select_html( $link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\u00c3\u0110 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access FROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j WHERE a.id=j.id_area and j.id_site=$current_site ORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t\t$sql = \"SELECT id, area_name,access FROM \".TABLE_PREFIX.\"_area ORDER BY order_display, area_name\";\n\t$out_html = '<b><i>'.get_vocab(\"areas\").'</i></b>'.PHP_EOL;\n\t$out_html .= '<form id=\"area_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$out_html .= '<div><select class=\"form-control\" name=\"area\" ';\n\t$out_html .= ' onchange=\"area_go()\" ';\n\t$out_html .= '>'.PHP_EOL;\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$selected = ($row[0] == $current_area) ? 'selected=\"selected\"' : \"\";\n\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$row[0];\n\t\t\tif (authUserAccesArea($user,$row[0]) == 1)\n\t\t\t{\n\t\t\t\t$out_html .= '<option '.$selected.' value=\"'.$link2.'\">'.htmlspecialchars($row[1]).'</option>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</select>'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '<script type=\"text/javascript\">'.PHP_EOL;\n\t$out_html .= 'function area_go()'.PHP_EOL;\n\t$out_html .= '{'.PHP_EOL;\n\t$out_html .= 'box = document.getElementById(\"area_001\").area;'.PHP_EOL;\n\t$out_html .= 'destination = box.options[box.selectedIndex].value;'.PHP_EOL;\n\t$out_html .= 'if (destination) location.href = destination;'.PHP_EOL;\n\t$out_html .= '}'.PHP_EOL;\n\t$out_html .= '</script>'.PHP_EOL;\n\t$out_html .= '<noscript>'.PHP_EOL;\n\t$out_html .= '<div>'.PHP_EOL;\n\t$out_html .= '<input type=\"submit\" value=\"Change\" />'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '</noscript>'.PHP_EOL;\n\t$out_html .= '</form>'.PHP_EOL;\n\treturn $out_html;\n}\n/**\n * s\u00c3\u0110lecteur de domaines, y compris tous les domaines d'un site\n * area selector, including any area in a site\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_area_select_all_html( $link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\u00c3\u0110 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access FROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j WHERE a.id=j.id_area and j.id_site=$current_site ORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t\t$sql = \"SELECT id, area_name,access FROM \".TABLE_PREFIX.\"_area ORDER BY order_display, area_name\";\n\t$out_html = '<b><i>'.get_vocab(\"areas\").'</i></b>'.PHP_EOL;\n\t$out_html .= '<form id=\"area_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$out_html .= '<div><select class=\"form-control\" name=\"area\" ';\n\t$out_html .= ' onchange=\"area_go()\" ';\n\t$out_html .= '>'.PHP_EOL;\n    $out_html .= \"<option value=\\\"\".$link.\"_all.php?year=$year&amp;site=$current_site\\\">\".get_vocab(\"any_area\").\"</option>\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$selected = ($row[0] == $current_area) ? 'selected=\"selected\"' : \"\";\n\t\t\t$link2 = $link.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$row[0];\n\t\t\tif (authUserAccesArea($user,$row[0]) == 1)\n\t\t\t{\n\t\t\t\t$out_html .= '<option '.$selected.' value=\"'.$link2.'\">'.htmlspecialchars($row[1]).'</option>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</select>'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '<script type=\"text/javascript\">'.PHP_EOL;\n\t$out_html .= 'function area_go()'.PHP_EOL;\n\t$out_html .= '{'.PHP_EOL;\n\t$out_html .= 'box = document.getElementById(\"area_001\").area;'.PHP_EOL;\n\t$out_html .= 'destination = box.options[box.selectedIndex].value;'.PHP_EOL;\n\t$out_html .= 'if (destination) location.href = destination;'.PHP_EOL;\n\t$out_html .= '}'.PHP_EOL;\n\t$out_html .= '</script>'.PHP_EOL;\n\t$out_html .= '<noscript>'.PHP_EOL;\n\t$out_html .= '<div>'.PHP_EOL;\n\t$out_html .= '<input type=\"submit\" value=\"Change\" />'.PHP_EOL;\n\t$out_html .= '</div>'.PHP_EOL;\n\t$out_html .= '</noscript>'.PHP_EOL;\n\t$out_html .= '</form>'.PHP_EOL;\n\treturn $out_html;\n}\n/**\n * Menu gauche affichage des room via select\n *\n * @param string $link\n * @param string $current_area\n * @param string $current_room\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_room_select_html($link, $current_area, $current_room, $year, $month, $day)\n{\n\tglobal $vocab;\n\t$out_html = \"<b><i>\".get_vocab('rooms').get_vocab(\"deux_points\").\"</i></b><br /><form id=\\\"room_001\\\" action=\\\"\".$_SERVER['PHP_SELF'].\"\\\"><div><select class=\\\"form-control\\\" name=\\\"room\\\" onchange=\\\"room_go()\\\">\";\n\t$out_html .= \"<option value=\\\"\".$link;\n    if ($link != \"day\"){$out_html .= \"_all\";}\n    $out_html .= \".php?year=$year&amp;month=$month&amp;day=$day&amp;area=$current_area\\\">\".get_vocab(\"all_rooms\").\"</option>\";\n\t$sql = \"select id, room_name, description from \".TABLE_PREFIX.\"_room WHERE area_id='\".protect_data_sql($current_area).\"' order by order_display,room_name\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (verif_acces_ressource(getUserName(),$row[0]))\n\t\t\t{\n\t\t\t\tif ($row[2])\n\t\t\t\t\t$temp = \" (\".htmlspecialchars($row[2]).\")\";\n\t\t\t\telse\n\t\t\t\t\t$temp = \"\";\n\t\t\t\t$selected = ($row[0] == $current_room) ? \"selected=\\\"selected\\\"\" : \"\";\n\t\t\t\t$link2 = $link.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;room='.$row[0];\n\t\t\t\t$out_html .= \"<option $selected value=\\\"$link2\\\">\" . htmlspecialchars($row[1].$temp).\"</option>\".PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= \"</select>\".PHP_EOL;\n\t$out_html .= \"</div>\".PHP_EOL;\n\t$out_html .= \"<script type=\\\"text/javascript\\\">\".PHP_EOL;\n\t$out_html .= \"function room_go()\".PHP_EOL;\n\t$out_html .= \" {\".PHP_EOL;\n\t$out_html .= \"box = document.getElementById(\\\"room_001\\\").room;\".PHP_EOL;\n\t$out_html .= \"destination = box.options[box.selectedIndex].value;\".PHP_EOL;\n\t$out_html .= \"if (destination) location.href = destination;\".PHP_EOL;\n\t$out_html .= \"}\".PHP_EOL;\n\t$out_html .= \"</script>\".PHP_EOL;\n\t$out_html .= \"<noscript>\".PHP_EOL;\n\t$out_html .= \"<div>\".PHP_EOL;\n\t$out_html .= \"<input type=\\\"submit\\\" value=\\\"Change\\\" />\".PHP_EOL;\n\t$out_html .= \"</div>\".PHP_EOL;\n\t$out_html .= \"</noscript>\".PHP_EOL;\n\t$out_html .= \"</form>\".PHP_EOL;\n\treturn $out_html;\n}\n/**\n * Affichage des domaines sous la forme d'une liste\n *\n * @param string $link\n * @param string $current_site\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_site_list_html($link, $current_site, $year, $month, $day,$user)\n{\n\tglobal $vocab;\n\t// On affiche le site\n\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\n\t\t$out_html = '\n\t\t<b><i><span class=\"bground\">'.get_vocab('sites').get_vocab('deux_points').'</span></i></b>\n\t\t<br />';\n\t\t$sql = \"SELECT id,sitename\n\t\tFROM \".TABLE_PREFIX.\"_site\n\t\tORDER BY sitename\";\n\t\t$nb_sites_a_afficher = 0;\n\t\t$res = grr_sql_query($sql);\n\t\tif ($res)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\t// Pour chaque site, on d\u00c3\u0110termine s'il y a des domaines visibles par l'utilisateur\n\t\t\t\t$sql = \"SELECT id_area\n\t\t\t\tFROM \".TABLE_PREFIX.\"_j_site_area\n\t\t\t\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site='\".$row[0].\"'\";\n\t\t\t\t$res2 = grr_sql_query($sql);\n\t\t\t\t$au_moins_un_domaine = false;\n\t\t\t\tif ($res2 && grr_sql_count($res2) > 0)\n\t\t\t\t{\n\t\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (authUserAccesArea($user,$row2[0]) == 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// on a trouv\u00c3\u0110 un domaine autoris\u00c3\u0110\n\t\t\t\t\t\t\t$au_moins_un_domaine = true;\n\t\t\t\t\t\t\t$j = grr_sql_count($res2) + 1;\n\t\t\t\t\t\t\t// On arr\u00c3\u0160te la boucle\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// On lib\u00c3\u013bre la ressource2\n\t\t\t\tgrr_sql_free($res2);\n\t\t\t\tif ($au_moins_un_domaine)\n\t\t\t\t{\n\t\t\t\t\t// on affiche le site uniquement si au moins un domaine est visible par l'utilisateur\n\t\t\t\t\t$nb_sites_a_afficher++;\n\t\t\t\t\tif ($row[0] == $current_site)\n\t\t\t\t\t{\n\t\t\t\t\t\t$out_html .= '\n\t\t\t\t\t\t<b><a id=\"liste_select\"   href=\"'.$link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;id_site='.$row[0].'\" title=\"'.$row[1].'\">&gt; '.htmlspecialchars($row[1]).'</a></b>\n\t\t\t\t\t\t<br />'.\"\\n\";\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t$out_html .= '\n\t\t\t\t\t\t<a id=\"liste\"  href=\"'.$link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;id_site='.$row[0].'\" title=\"'.$row[1].'\">'.htmlspecialchars($row[1]).'</a>\n\t\t\t\t\t\t<br />'.\"\\n\";\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ($nb_sites_a_afficher > 1)\n\t\t\treturn $out_html;\n\t\telse\n\t\t\treturn '';\n\t}\n}\n/**\n * Affichage des area sous la forme d'une liste\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @param string $user\n * @return string\n */\nfunction make_area_list_html($link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\techo \"<b><i><span class=\\\"bground\\\">\".get_vocab(\"areas\").\"</span></i></b><br />\";\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\u00c3\u0110 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access\n\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\tWHERE a.id=j.id_area and j.id_site=$current_site\n\t\tORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t{\n\t\t$sql = \"SELECT id, area_name,access\n\t\tFROM \".TABLE_PREFIX.\"_area\n\t\tORDER BY order_display, area_name\";\n\t}\n\t$res = 0;\n\tif (($current_site != -1) || ($use_multi_site == 'n'))\n\t\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (authUserAccesArea($user,$row[0]) == 1)\n\t\t\t{\n\t\t\t\tif ($row[0] == $current_area)\n\t\t\t\t{\n\t\t\t\t\techo \"<a id=\\\"liste_select\\\" onclick=\\\"charger();\\\" href=\\\"\".$link.\"?year=$year&amp;month=$month&amp;day=$day&amp;area=$row[0]\\\">&gt; \".htmlspecialchars($row[1]).\"</a></b><br />\\n\";\n\t\t\t\t} else {\n\t\t\t\t\techo \"<a id=\\\"liste\\\" onclick=\\\"charger();\\\" href=\\\"\".$link.\"?year=$year&amp;month=$month&amp;day=$day&amp;area=$row[0]\\\"> \".htmlspecialchars($row[1]).\"</a><br />\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tgrr_sql_free($res);\n}\n/**\n * Affichage des room sous la forme d'une liste\n *\n * @param string $link\n * @param string $current_area\n * @param string $current_room\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_room_list_html($link,$current_area, $current_room, $year, $month, $day)\n{\n\tglobal $vocab;\n\techo \"<b><i><span class=\\\"bground\\\">\".get_vocab(\"rooms\").get_vocab(\"deux_points\").\"</span></i></b><br />\";\n\t$sql = \"select id, room_name, description from \".TABLE_PREFIX.\"_room WHERE area_id='\".protect_data_sql($current_area).\"' order by order_display,room_name\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t// On affiche uniquement les ressources autoris\u00c3\u0110es\n\t\t\tif (verif_acces_ressource(getUserName(), $row[0]))\n\t\t\t{\n\t\t\t\tif ($row[0] == $current_room)\n\t\t\t\t\techo \"<span id=\\\"liste_select\\\">&gt; \".htmlspecialchars($row[1]).\"</span><br />\\n\";\n\t\t\t\telse\n\t\t\t\t\techo \"<a id=\\\"liste\\\" onclick=\\\"charger();\\\" href=\\\"\".$link.\".php?year=$year&amp;month=$month&amp;day=$day&amp;&amp;room=$row[0]\\\">\".htmlspecialchars($row[1]). \"</a><br />\\n\";\n\t\t\t}\n\t\t}\n\t}\n}\n/*\n * Affichage des sites sous la forme d'une liste de boutons\n *\n * @param string $link\n * @param string $current_site\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_site_item_html($link, $current_site, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\t$nb_sites_a_afficher = 0;\n//\t$out_html = '<ul class=\"list-group\"><li class=\"list-group-item\">'.get_vocab('sites').get_vocab('deux_points').'</li></ul><form class=\"ressource\" id=\"site_001\" action=\"'.$_SERVER['PHP_SELF'].'\"><div>';\n\t$sql = \"SELECT id, sitename\n\tFROM \".TABLE_PREFIX.\"_site\n\tleft join \".TABLE_PREFIX.\"_j_site_area on \".TABLE_PREFIX.\"_site.id = \".TABLE_PREFIX.\"_j_site_area.id_site\n\tWHERE \".TABLE_PREFIX.\"_j_site_area.id_site is not null\n\tGROUP BY id_site\n\tORDER BY id ASC\n\t\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{     \n        $out_html = '<br />'.PHP_EOL.'<div class=\"panel panel-default\">'.PHP_EOL.'<div class=\"panel-heading\">'.get_vocab('sites').get_vocab('deux_points').'</div>'.PHP_EOL.'<div class=\"panel-body\">'.PHP_EOL.'<form class=\"ressource\" id=\"site_001\" action=\"'.$_SERVER['PHP_SELF'].'\">';\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$sql = \"SELECT id_area FROM \".TABLE_PREFIX.\"_j_site_area WHERE \".TABLE_PREFIX.\"_j_site_area.id_site='\".$row[0].\"'\";\n\t\t\t$res2 = grr_sql_query($sql);\n\t\t\t$default_area = -1;\n\t\t\tif ($res2 && grr_sql_count($res2) > 0)\n\t\t\t{\n\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t{\n\t\t\t\t\tif (authUserAccesArea($user,$row2[0]) == 1)\n\t\t\t\t\t{\n\t\t\t\t\t\t$default_area = $row2[0];\n\t\t\t\t\t\t$j = grr_sql_count($res2) + 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tgrr_sql_free($res2);\n\t\t\tif ($default_area != -1)\n\t\t\t{\n\t\t\t\t$nb_sites_a_afficher++;\n\t\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$default_area;\n\t\t\t\t//$out_html .=\"\\n\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day;\n\t\t\tif ($current_site != null)\n\t\t\t{\n\t\t\t\tif ($current_site == $row[0])\n\t\t\t\t\t$out_html .= \"<input id=\\\"item_select\\\" type=\\\"button\\\" class=\\\"btn btn-primary btn-lg btn-block item_select\\\" name=\\\"$row[0]\\\" value=\\\"\".htmlspecialchars($row[1]).\"\\\" onclick=\\\"location.href='$link2';charger();\\\" />\".PHP_EOL;\n\t\t\t\telse\n\t\t\t\t\t$out_html .= \"<input type=\\\"button\\\" class=\\\"btn btn-default btn-lg btn-block item\\\" name=\\\"$row[0]\\\" value=\\\"\".htmlspecialchars($row[1]).\" \\\" onclick=\\\"location.href='$link2';charger();\\\" />\".PHP_EOL;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$out_html .= \"<input type=\\\"button\\\" class=\\\"btn btn-default btn-lg btn-block item\\\" name=\\\"$row[0]\\\" value=\\\"\".htmlspecialchars($row[1]).\" \\\" onclick=\\\"location.href='$link2';charger();\\\" /><br />\".PHP_EOL;\n\t\t}\n\t}\n\tif ($nb_sites_a_afficher > 1)// s'il y a au moins deux sites \u00c3\u00a0 afficher, on affiche une liste de boutons, sinon rien.\n\t{\n\t\t$out_html .= '</form>'.PHP_EOL;\n\t\t$out_html .= '</div></div>'.PHP_EOL;\n\t\t$out_html .= '<script type=\"text/javascript\">'.PHP_EOL;\n\t\t$out_html .= 'function site_go()'.PHP_EOL;\n\t\t$out_html .= '{'.PHP_EOL;\n\t\t$out_html .= 'box = document.getElementById(\"site_001\").site;'.PHP_EOL;\n\t\t$out_html .= 'destination = box.options[box.selectedIndex].value;'.PHP_EOL;\n\t\t$out_html .= 'if (destination) location.href = destination;'.PHP_EOL;\n\t\t$out_html .= '}'.PHP_EOL;\n\t\t$out_html .= '</script>'.PHP_EOL;\n\t\t$out_html .= '<noscript>'.PHP_EOL;\n\t\t$out_html .= '<div>'.PHP_EOL;\n\t\t$out_html .= '<input type=\"submit\" value=\"change\" />'.PHP_EOL;\n\t\t$out_html .= '</div>'.PHP_EOL;\n\t\t$out_html .= '</noscript>'.PHP_EOL;\n\t\t//$out_html .= '</form>'.PHP_EOL;\n\t\treturn $out_html;\n\t}\n    else return \"\";\n}\n/**\n * Affichage des area sous la forme d'un input\n *\n * @param string $link\n * @param string $current_site\n * @param string $current_area\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_area_item_html( $link, $current_site, $current_area, $year, $month, $day, $user)\n{\n\tglobal $vocab;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t$use_multi_site = 'y';\n\telse\n\t\t$use_multi_site = 'n';\n\tif ($use_multi_site == 'y')\n\t{\n\t\t// on a activ\u00c3\u0110 les sites\n\t\tif ($current_site != -1)\n\t\t\t$sql = \"SELECT a.id, a.area_name,a.access\n\t\tFROM \".TABLE_PREFIX.\"_area a, \".TABLE_PREFIX.\"_j_site_area j\n\t\tWHERE a.id=j.id_area and j.id_site=$current_site\n\t\tORDER BY a.order_display, a.area_name\";\n\t\telse\n\t\t\t$sql = \"\";\n\t}\n\telse\n\t{\n\t\t$sql = \"SELECT id, area_name,access\n\t\tFROM \".TABLE_PREFIX.\"_area\n\t\tORDER BY order_display, area_name\";\n\t}\n\t$out_html = '<br />'.PHP_EOL.'<div class=\"panel panel-default\">'.PHP_EOL.'<div class=\"panel-heading\">'.get_vocab(\"areas\").'</div>'.PHP_EOL.'<div class=\"panel-body\">'.PHP_EOL;\n\t$out_html .= '<form class=\"ressource\" id=\"area_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$link2 = $link.'?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$row[0];\n\t\t\tif (authUserAccesArea($user, $row[0]) == 1)\n\t\t\t{\n\t\t\t\t/* Couleur du domaine selectionn\u00c3\u0110*/\n\t\t\t\tif ($current_area != null)\n\t\t\t\t{\n\t\t\t\t\tif ($current_area == $row[0])\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-primary btn-lg btn-block item_select\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item \" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</form>'.PHP_EOL.'</div>'.PHP_EOL.'</div>'.PHP_EOL;\n\treturn $out_html;\n}\n//end make_area_item_html\n/**\n * Affichage des rooms sous la forme d'une liste de boutons\n *\n * @param string $link\n * @param string $current_area\n * @param string $current_room\n * @param string $year\n * @param string $month\n * @param string $day\n * @return string\n */\nfunction make_room_item_html($link, $current_area, $current_room, $year, $month, $day)\n{\n\tglobal $vocab;\n\t$out_html = '<br />'.PHP_EOL.'<div class=\"panel panel-default\">'.PHP_EOL.'<div class=\"panel-heading\">'.get_vocab(\"rooms\").get_vocab(\"deux_points\").'</div>'.PHP_EOL.'<div class=\"panel-body\">'.PHP_EOL.'<form class=\"ressource\" id=\"room_001\" action=\"'.$_SERVER['PHP_SELF'].'\">'.PHP_EOL;\n\t$sql = \"SELECT id, room_name, description FROM \".TABLE_PREFIX.\"_room WHERE area_id='\".protect_data_sql($current_area).\"' ORDER BY order_display,room_name\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n        $all_ressource = 0; // permet l'affichage de toutes les ressources\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (verif_acces_ressource(getUserName(),$row[0]))\n\t\t\t{\n\t\t\t\t$link2 = $link.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;room='.$row[0];\n                $link_a = $link;\n                if (($link != 'day')&&(!strpos($link,'all'))) {$link_a .= '_all';}\n\t\t\t\t$link_all_room = $link_a.'.php?year='.$year.'&amp;month='.$month.'&amp;day='.$day.'&amp;area='.$current_area;\n\t\t\t\tif (!isset($_GET['room']))\n\t\t\t\t{\n\t\t\t\t\tif (isset($all_ressource) && $all_ressource == 0)\n\t\t\t\t\t\t$out_html .= /*'<div class=\"panel-body\">'.PHP_EOL.*/'<input id=\"item_select\" class=\"btn btn-primary btn-lg btn-block item_select\" name=\"all_room\" value=\"Toutes les ressources\" onclick=\"location.href=\\''.$link_all_room.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" type=\"button\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\t$all_ressource = 1;\n\t\t\t\t}\n\t\t\t\telse //changed (Ajout de type = \" button pr gerer saut de ligne \" \n\t\t\t\t{\n\t\t\t\t\tif (isset($all_ressource) && $all_ressource == 0)\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" type=\"button\" name=\"all_room\" value=\"Toutes les ressources\" onclick=\"location.href=\\''.$link_all_room.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t\t$all_ressource = 1;\n\t\t\t\t\tif ($current_room == $row[0])\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-primary btn-lg btn-block item_select\" type=\"button\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\';charger();\"/>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\t$out_html .= '<input class=\"btn btn-default btn-lg btn-block item\" type=\"button\" name=\"'.$row[0].'\" value=\"'.htmlspecialchars($row[1]).'\" onclick=\"location.href=\\''.$link2.'\\' ;charger();\"/>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t$out_html .= '</form>'.PHP_EOL.'</div>'.PHP_EOL.'</div>'.PHP_EOL;\n\treturn $out_html;\n}\n// end make_room_item_html\n/**\n * @param integer $action\n * $action = 1 -> Cr\u00c3\u0110ation\n * $action = 2 -> Modification\n * $action = 3 -> Suppression\n * $action = 4 -> Suppression automatique\n * $action = 5 -> R\u00c3\u0110servation en attente de mod\u00c3\u0110ration\n * $action = 6 -> R\u00c3\u0110sultat d'une d\u00c3\u0110cision de mod\u00c3\u0110ration\n * $action = 7 -> Notification d'un retard dans la restitution d'une ressource.\n*/\nfunction send_mail($id_entry, $action, $dformat, $tab_id_moderes = array(), $oldRessource = '')\n{\n\tglobal $vocab, $grrSettings, $locale, $weekstarts, $enable_periods, $periods_name;\n\n\t$message_erreur = '';\n\n\tif (@file_exists('include/mail.class.php')){\n\t\trequire_once 'phpmailer/PHPMailerAutoload.php';\n\t\trequire_once 'include/mail.class.php';\n\t}else{\n\t\trequire_once '../phpmailer/PHPMailerAutoload.php';\n\t\trequire_once '../include/mail.class.php';\n\t}\n\n\t$sql = \"SELECT \".TABLE_PREFIX.\"_entry.name,\n\t\".TABLE_PREFIX.\"_entry.description,\n\t\".TABLE_PREFIX.\"_entry.beneficiaire,\n\t\".TABLE_PREFIX.\"_room.room_name,\n\t\".TABLE_PREFIX.\"_area.area_name,\n\t\".TABLE_PREFIX.\"_entry.type,\n\t\".TABLE_PREFIX.\"_entry.room_id,\n\t\".TABLE_PREFIX.\"_entry.repeat_id,\n\t\" . grr_sql_syntax_timestamp_to_unix(\"\".TABLE_PREFIX.\"_entry.timestamp\") . \",\n\t(\".TABLE_PREFIX.\"_entry.end_time - \".TABLE_PREFIX.\"_entry.start_time),\n\t\".TABLE_PREFIX.\"_entry.start_time,\n\t\".TABLE_PREFIX.\"_entry.end_time,\n\t\".TABLE_PREFIX.\"_room.area_id,\n\t\".TABLE_PREFIX.\"_room.delais_option_reservation,\n\t\".TABLE_PREFIX.\"_entry.option_reservation,\n\t\".TABLE_PREFIX.\"_entry.moderate,\n\t\".TABLE_PREFIX.\"_entry.beneficiaire_ext,\n\t\".TABLE_PREFIX.\"_entry.jours,\n\t\".TABLE_PREFIX.\"_entry.clef,\n\t\".TABLE_PREFIX.\"_entry.courrier\n\tFROM \".TABLE_PREFIX.\"_entry, \".TABLE_PREFIX.\"_room, \".TABLE_PREFIX.\"_area\n\tWHERE \".TABLE_PREFIX.\"_entry.room_id = \".TABLE_PREFIX.\"_room.id\n\tAND \".TABLE_PREFIX.\"_room.area_id = \".TABLE_PREFIX.\"_area.id\n\tAND \".TABLE_PREFIX.\"_entry.id='\".protect_data_sql($id_entry).\"'\n\t\";\n\t$res = grr_sql_query($sql);\n\tif (!$res)\n\t\tfatal_error(0, grr_sql_error());\n\tif (grr_sql_count($res) < 1)\n\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t$row = grr_sql_row($res, 0);\n\tgrr_sql_free($res);\n\n\tget_planning_area_values($row[12]);\n\t$breve_description \t\t\t= bbcode(removeMailUnicode(htmlspecialchars($row[0])), 'nobbcode');\n\t$description  \t\t\t\t= bbcode(removeMailUnicode(htmlspecialchars($row[1])), 'nobbcode');\n\t$beneficiaire \t\t\t\t= htmlspecialchars($row[2]);\n\t$room_name    \t\t\t\t= removeMailUnicode(htmlspecialchars($row[3]));\n\t$area_name    \t\t\t\t= removeMailUnicode(htmlspecialchars($row[4]));\n\t$room_id      \t\t\t\t= $row[6];\n\t$repeat_id    \t\t\t\t= $row[7];\n\t$date_avis    \t\t\t\t= strftime(\"%Y/%m/%d\", $row[10]);\n\t$delais_option_reservation \t= $row[13];\n\t$option_reservation \t\t= $row[14];\n\t$moderate \t\t\t\t\t= $row[15];\n\t$beneficiaire_ext\t\t\t= htmlspecialchars($row[16]);\n\t$jours_cycle \t\t\t\t= htmlspecialchars($row[17]);\n\t$duration     \t\t\t\t= $row[9];\n\tif ($enable_periods == 'y')\n\t\tlist($start_period, $start_date) = period_date_string($row[10]);\n\telse\n\t\t$start_date = time_date_string($row[10],$dformat);\n\t$rep_type = 0;\n\n\t// Recherche du nom de l'ancienne ressource si besoin\n\tif($oldRessource != '' && $oldRessource != $room_id)\n\t{\n\t\t$sql = \"SELECT room_name FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($oldRessource).\"'\";\n\t\t$oldRess = grr_sql_query($sql);\n\t\tif (!$oldRess)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\t$rowOld = grr_sql_row($oldRess, 0);\n\t\tgrr_sql_free($oldRess);\n\t\t$nomAncienneSalle = $rowOld[0];\n\t}\n\telse\n\t\t$nomAncienneSalle = \"\";\n\t//\n\n\tif ($repeat_id != 0)\n\t{\n\t\t$res = grr_sql_query(\"SELECT rep_type, end_date, rep_opt, rep_num_weeks FROM \".TABLE_PREFIX.\"_repeat WHERE id='\".protect_data_sql($repeat_id).\"'\");\n\t\tif (!$res)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\t$test = grr_sql_count($res);\n\t\tif ($test != 1)\n\t\t\tfatal_error(0, \"Deux reservations ont le m\u00c3\u0160me ID.\");\n\t\telse\n\t\t{\n\t\t\t$row2 = grr_sql_row($res, 0);\n\t\t\t$rep_type     = $row2[0];\n\t\t\t$rep_end_date = strftime($dformat,$row2[1]);\n\t\t\t$rep_opt      = $row2[2];\n\t\t\t$rep_num_weeks = $row2[3];\n\t\t}\n\t\tgrr_sql_free($res);\n\t}\n\tif ($enable_periods == 'y')\n\t\ttoPeriodString($start_period, $duration, $dur_units);\n\telse\n\t\ttoTimeString($duration, $dur_units);\n\t$weeklist = array(\"unused\", \"every week\", \"week 1/2\", \"week 1/3\", \"week 1/4\", \"week 1/5\");\n\tif ($rep_type == 2)\n\t\t$affiche_period = $vocab[$weeklist[$rep_num_weeks]];\n\telse\n\t\t$affiche_period = $vocab['rep_type_'.$rep_type];\n\n\t// Le b\u00c3\u0110n\u00c3\u0110ficiaire\n\t$beneficiaire_email = affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"onlymail\");\n\tif ($beneficiaire != \"\")\n\t{\n\t\t$beneficiaire_actif = grr_sql_query1(\"SELECT etat FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='$beneficiaire'\");\n\t\tif ($beneficiaire_actif == -1)\n\t\t\t$beneficiaire_actif = 'actif'; // Cas des admins\n\t}\n\telse if (($beneficiaire_ext != \"\") && ($beneficiaire_email != \"\"))\n\t\t$beneficiaire_actif = \"actif\";\n\telse\n\t\t$beneficiaire_actif = \"inactif\";\n\n\t// Utilisateur ayant agi sur la r\u00c3\u0110servation\n\t$user_login = getUserName();\n\t$user_email = grr_sql_query1(\"SELECT email FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='$user_login'\");\n\t//\n\t// Elaboration du message destin\u00c3\u0110 aux utilisateurs d\u00c3\u0110sign\u00c3\u0110s par l'admin dans la partie \"Mails automatiques\"\n\t//\n\t//Nom de l'\u00c3\u0110tablissement et mention \"mail automatique\"\n\t$message = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t// Url de GRR\n\t$message .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t$sujet = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\n\tif ($action == 1){ // Cr\u00c3\u0110ation\n\t\t$sujet .= $vocab[\"subject_mail_creation\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"creation_booking\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 2){ // Modification\n\t\t$sujet .= $vocab[\"subject_mail_modify\"];\n\t\tif ($moderate == 1)\n\t\t\t$sujet .= \" (\".$vocab[\"en_attente_moderation\"].\")\";\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"modify_booking\"];\n\t\tif ($room_name != $oldRessource)\n\t\t\t$message .= $vocab[\"the_room\"].\" \".$oldRessource.\" => \".$room_name.\" (\".$area_name.\") \";\n\t\telse\n\t\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \";\n\t\t$message .= $vocab[\"reservee au nom de\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 3){ // Suppression\n\t\t$sujet .= $vocab[\"subject_mail_delete\"];\n\t\tif ($moderate == 1)\n\t\t\t$sujet .= \" (\".$vocab[\"en_attente_moderation\"].\")\";\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"delete_booking\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$message .= $vocab[\"reservee au nom de\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 4){ // Suppression automatique\n\t\t$sujet .= $vocab[\"subject_mail_delete\"];\n\t\t$message .= $vocab[\"suppression_automatique\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 5){ // R\u00c3\u0110servation en attente de mod\u00c3\u0110ration\n\t\t$sujet .= $vocab[\"subject_mail_moderation\"];\n\t\t$message .= $vocab[\"reservation_en_attente_de_moderation\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \\n\";\n\t\t$repondre = Settings::get(\"webmaster_email\");\n\t}\n\telseif ($action == 6){ // R\u00c3\u0110sultat d'une d\u00c3\u0110cision de mod\u00c3\u0110ration\n\t\t$sujet .= $vocab[\"subject_mail_decision_moderation\"];\n\n\t\t$resmoderate = grr_sql_query(\"SELECT moderate, motivation_moderation FROM \".TABLE_PREFIX.\"_entry_moderate WHERE id ='\".protect_data_sql($id_entry).\"'\");\n\t\tif (!$resmoderate)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\tif (grr_sql_count($resmoderate) < 1)\n\t\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t\t$rowModerate = grr_sql_row($resmoderate, 0);\n\t\tgrr_sql_free($resmoderate);\n\t\t$moderate_decision = $rowModerate[0];\n\t\t$moderate_description = $rowModerate[1];\n\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t$message .= $vocab[\"traite_moderation\"];\n\t\t$message .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \";\n\t\t$message .= $vocab[\"reservee au nom de\"];\n\t\t$message .= $vocab[\"the_user\"].affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\tif ($moderate_decision == 2)\n\t\t\t$message .= \"\\n\".$vocab[\"moderation_acceptee\"];\n\t\telse if ($moderate_decision == 3)\n\t\t\t$message .= \"\\n\".$vocab[\"moderation_refusee\"];\n\t\tif ($moderate_description != \"\")\n\t\t{\n\t\t\t$message .= \"\\n\".$vocab[\"motif\"].$vocab[\"deux_points\"];\n\t\t\t$message .= $moderate_description.\" \\n----\";\n\t\t}\n\t\t$message .= \"\\n\".$vocab[\"voir_details\"].$vocab[\"deux_points\"].\"\\n\";\n\t\tif (count($tab_id_moderes) == 0 )\n\t\t\t$message .= \"\\n\".traite_grr_url(\"\",\"y\").\"view_entry.php?id=\".$id_entry;\n\t\telse\n\t\t{\n\t\t\tforeach ($tab_id_moderes as $id_moderes)\n\t\t\t\t$message .= \"\\n\".traite_grr_url(\"\",\"y\").\"view_entry.php?id=\".$id_moderes;\n\t\t}\n\t\t$message .= \"\\n\\n\".$vocab[\"rappel_de_la_demande\"].$vocab[\"deux_points\"].\"\\n\";\n\n\t\t$repondre = $user_email;\n\t}\n\telseif ($action == 7){ // Notification d'un retard dans la restitution d'une ressource\n\t\t$sujet .= $vocab[\"subject_mail_retard\"];\n\n\t\t$message .= $vocab[\"message_mail_retard\"].$vocab[\"deux_points\"].\" \\n\";\n\t\t$message .= $room_name.\" (\".$area_name.\") \\n\";\n\t\t$message .= $vocab[\"nom emprunteur\"].$vocab[\"deux_points\"];\n\t\t$message .= affiche_nom_prenom_email($beneficiaire,$beneficiaire_ext,\"formail\").\" \\n\";\n\t\tif ($beneficiaire_email != \"\")\n\t\t\t$message .= $vocab[\"un email envoye\"].$beneficiaire_email.\" \\n\";\n\t\t$message .= \"\\n\".$vocab[\"changer statut lorsque ressource restituee\"].$vocab[\"deux_points\"];\n\t\t$message .= \"\\n\".traite_grr_url(\"\",\"y\").\"view_entry.php?id=\".$id_entry.\" \\n\";\n\n\t\t$repondre = Settings::get(\"webmaster_email\");\n\t}\n\t//\n\t// Infos sur la r\u00c3\u0110servation\n\t//\t\t\n\t$reservation = '';\n\t$reservation .= $vocab[\"start_of_the_booking\"].\" \".$start_date.\"\\n\";\n\t$reservation .= $vocab[\"duration\"].\" \".$duration.\" \".$dur_units.\"\\n\";\n\tif (trim($breve_description) != \"\")\n\t\t$reservation .= $vocab[\"namebooker\"].preg_replace(\"/ /\", \" \",$vocab[\"deux_points\"]).\" \".$breve_description.\"\\n\";\n\telse\n\t\t$reservation .= $vocab[\"entryid\"].$room_id.\"\\n\";\n\tif ($description !='')\n\t\t$reservation .= $vocab[\"description\"].\" \".$description.\"\\n\";\n\t// Champ additionnel\n\t$reservation .= affichage_champ_add_mails($id_entry);\n\t// Type de r\u00c3\u0110servation\n\t$temp = grr_sql_query1(\"SELECT type_name FROM \".TABLE_PREFIX.\"_type_area WHERE type_letter='\".$row[5].\"'\");\n\tif ($temp == -1)\n\t\t$temp = \"?\".$row[5].\"?\";\n\telse\n\t\t$temp = removeMailUnicode($temp);\n\n\t$reservation .= $vocab[\"type\"].preg_replace(\"/ /\", \" \",$vocab[\"deux_points\"]).\" \".$temp.\"\\n\";\n\n\tif ($rep_type != 0)\n\t\t$reservation .= $vocab[\"rep_type\"].\" \".$affiche_period.\"\\n\";\n\tif ($rep_type != 0)\n\t{\n\t\tif ($rep_type == 2)\n\t\t{\n\t\t\t$opt = \"\";\n\t\t\tfor ($i = 0; $i < 7; $i++)\n\t\t\t{\n\t\t\t\t$daynum = ($i + $weekstarts) % 7;\n\t\t\t\tif ($rep_opt[$daynum])\n\t\t\t\t\t$opt .= day_name($daynum) . \" \";\n\t\t\t}\n\t\t\tif ($opt)\n\t\t\t\t$reservation .= $vocab[\"rep_rep_day\"].\" \".$opt.\"\\n\";\n\t\t}\n\t\tif ($rep_type == 6)\n\t\t{\n\t\t\tif (Settings::get(\"jours_cycles_actif\") == \"Oui\")\n\t\t\t\t$reservation .= $vocab[\"rep_type_6\"].preg_replace(\"/ /\", \" \",$vocab[\"deux_points\"]).ucfirst(substr($vocab[\"rep_type_6\"],0,1)).$jours_cycle.\"\\n\";\n\t\t}\n\t\t$reservation .= $vocab[\"rep_end_date\"].\" \".$rep_end_date.\"\\n\";\n\t}\n\tif (($delais_option_reservation > 0) && ($option_reservation != -1))\n\t\t$reservation .= \"*** \".$vocab[\"reservation_a_confirmer_au_plus_tard_le\"].\" \".time_date_string_jma($option_reservation,$dformat).\" ***\\n\";\n\n\t$reservation .= \"-----\\n\";\n\n\t$message .= $reservation;\n\t$message .= $vocab[\"msg_no_email\"].Settings::get(\"webmaster_email\");;\n\t$message = html_entity_decode($message);\n\t//\n\t$sql = \"SELECT u.email FROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_mailuser_room j WHERE (j.id_room='\".protect_data_sql($room_id).\"' AND u.login=j.login and u.etat='actif') ORDER BY u.nom, u.prenom\";\n\t$res = grr_sql_query($sql);\n\t$nombre = grr_sql_count($res);\n\tif ($nombre > 0)\n\t{\n\t\t$destinataire = \"\";\n\t\t$tab_destinataire = array();\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif ($row[0] != \"\")\n\t\t\t\t$tab_destinataire[] = $row[0];\n\t\t}\n\t\tforeach ($tab_destinataire as $value){\n\t\t\t$destinataire .= \";\". $value;\n\t\t}\n\n\t\tEmail::Envois($destinataire, $sujet, $message, $repondre, '', '');\n\t}\n\n\tif ($action == 7){\n\t\t$mail_admin = find_user_room ($room_id);\n\t\t$destinataire = \"\";\n\t\tif (count($mail_admin) > 0)\n\t\t{\n\t\t\tforeach ($mail_admin as $value){\n\t\t\t\t$destinataire .= \";\". $value;\n\t\t\t}\n\n\t\t//\tEmail::Envois($destinataire, $sujet, $message, $repondre, '', '');  semble incomplet YN le 21/02/2020\n\t\t}\n\n\t\t$sujet7 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$sujet7 .= $vocab[\"subject_mail_retard\"];\n\t\t$message7 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t$message7 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t$message7 .= $vocab[\"ressource empruntee non restitu\u00c3\u0110e\"].\"\\n\";\n\t\t$message7 .= $room_name.\" (\".$area_name.\")\";\n\t\t$message7 .= \"\\n\".$reservation;\n\t\t$message7 = html_entity_decode($message7);\n\t\t$destinataire7 = $beneficiaire_email;\n\t\t$repondre7 = Settings::get(\"webmaster_email\");\n\n\t\tEmail::Envois($destinataire7, $sujet7, $message7, $repondre7, '', '');\n\t}\n\tif ($action == 4)\n\t{\n\t\t$destinataire4 = $beneficiaire_email;\n\t\t$repondre4 = Settings::get(\"webmaster_email\");\n\t\t\n\t\tEmail::Envois($destinataire4, $sujet, $message, $repondre4, '', '');\n\t}\n\tif ($action == 5)\n\t{\n\t\t$mail_admin = find_active_user_room ($room_id);\n\t\t$destinataire = \"\";\n\t\tif (count($mail_admin) > 0){\n\n\t\t\tforeach ($mail_admin as $value){\n\t\t\t\t$destinataire .= \";\". $value;\n\t\t\t}\n\t\t\n\t\t\t$sujet5 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t\t$sujet5 .= $vocab[\"subject_mail_moderation\"];\n\t\t\t$message5 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t\t$message5 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t\t$message5 .= $vocab[\"subject_a_moderer\"];\n\t\t\t$message5 .= \"\\n\".traite_grr_url(\"\",\"y\").\"validation.php?id=\".$id_entry;\n\t\t\t$message5 .= \"\\n\\n\".$vocab['created_by'].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\t\t$message5 .= \"\\n\".$vocab['room'].$vocab['deux_points'].$room_name.\" (\".$area_name.\") \\n\";\n\t\t\t$message5 = html_entity_decode($message5);\n\t\t\t$repondre5 = Settings::get(\"webmaster_email\");\n\n\t\t\tEmail::Envois($destinataire, $sujet5, $message5, $repondre5, '', '');\n\t\t}\n\n\t}\n\tif (($action == 5) && ($beneficiaire_email != '') && ($beneficiaire_actif == 'actif'))\n\t{\n\t\t$sujet5 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$sujet5 .= $vocab[\"subject_mail_moderation\"];\n\t\t$message5 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t$message5 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t$message5 .= $vocab[\"texte_en_attente_de_moderation\"];\n\t\t$message5 .= \"\\n\".$vocab[\"rappel_de_la_demande\"].$vocab[\"deux_points\"];\n\t\t$message5 .= \"\\n\".$vocab[\"the_room\"].$room_name.\" (\".$area_name.\")\";\n\t\t$message5 .= \"\\n\".$reservation;\n\t\t$message5 = html_entity_decode($message5);\n\t\t$destinataire5 = $beneficiaire_email;\n\t\t$repondre5 = Settings::get(\"webmaster_email\");\n\n\t\tEmail::Envois($destinataire5, $sujet5, $message5, $repondre5, '', '');\n\t}\n\tif (($action == 6) && ($beneficiaire_email != '') && ($beneficiaire_actif=='actif'))\n\t{\n\t\t$sujet6 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$sujet6 .= $vocab[\"subject_mail_decision_moderation\"];\n\t\t$message6 = $message;\n\t\t$destinataire6 = $beneficiaire_email;\n\t\t$repondre6 = $user_email;\n\n\t\tEmail::Envois($destinataire6, $sujet6, $message6, $repondre6, '', '');\n\t}\n\n\t// Cas d'une cr\u00c3\u0110ation, modification ou suppression d'un message par un utilisateur diff\u00c3\u0110rent du b\u00c3\u0110n\u00c3\u0110ficiaire :\n\t// On envoie un message au b\u00c3\u0110n\u00c3\u0110ficiaire de la r\u00c3\u0110servation pour l'avertir d'une modif ou d'une suppression\n\tif ((($action == 1) || ($action == 2) || ($action == 3)) && ((strtolower($user_login) != strtolower($beneficiaire)) || (Settings::get('send_always_mail_to_creator') == '1')) && ($beneficiaire_email != '') && ($beneficiaire_actif == 'actif'))\n\t{\n\t\t$sujet2 = $vocab[\"subject_mail1\"].$room_name.\" - \".$date_avis;\n\t\t$message2 = removeMailUnicode(Settings::get(\"company\")).\" - \".$vocab[\"title_mail\"];\n\t\t$message2 .= traite_grr_url(\"\",\"y\").\"\\n\\n\";\n\t\t$message2 .= $vocab[\"the_user\"].affiche_nom_prenom_email($user_login,\"\",\"formail\");\n\t\tif ($action == 1){\n\t\t\t$sujet2 .= $vocab[\"subject_mail_creation\"];\n\t\t\t$message2 .= $vocab[\"creation_booking_for_you\"];\n\t\t\t$message2 .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\").\";\n\t\t}\n\t\telseif ($action == 2){\n\t\t\t$sujet2 .= $vocab[\"subject_mail_modify\"];\n\t\t\t$message2 .= $vocab[\"modify_booking\"];\n\t\t\tif ($room_id != $oldRessource)\n\t\t\t\t$message2 .= $vocab[\"the_room\"].\" \".$nomAncienneSalle.\" => \".$room_name.\" (\".$area_name.\") \";\n\t\t\telse\n\t\t\t\t$message2 .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\") \";\n\t\t\t$message2 .= $vocab[\"created_by_you\"];\n\t\t}\n\t\telse{\n\t\t\t$sujet2 .= $vocab[\"subject_mail_delete\"];\n\t\t\t$message2 .= $vocab[\"delete_booking\"];\n\t\t\t$message2 .= $vocab[\"the_room\"].$room_name.\" (\".$area_name.\")\";\n\t\t\t$message2 .= $vocab[\"created_by_you\"];\n\t\t}\n\t\t$message2 .= \"\\n\".$reservation;\n\t\t$message2 = html_entity_decode($message2);\n\t\t$destinataire2 = $beneficiaire_email;\n\t\t$repondre2 = $user_email;\n\n\t\tEmail::Envois($destinataire2, $sujet2, $message2, $repondre2, '', '');\n\t}\n\n\treturn $message_erreur;\n} // Fin fonction send_mail\n\n/** function getUserName()\n * retourne le login de l'utilisateur connect\u00c3\u0110 (et pas son nom), une cha\u00c3\u016ane vide sinon\n*/\nfunction getUserName()\n{\n\tif (isset($_SESSION['login']))\n\t\treturn $_SESSION['login'];\n\telse\n\t\treturn '';\n}\nfunction getWritable($beneficiaire, $user, $id)\n{\n\t$id_room = grr_sql_query1(\"SELECT room_id FROM \".TABLE_PREFIX.\"_entry WHERE id='\".protect_data_sql($id).\"'\");\n\t\t// Modifications permises si l'utilisateur a les droits suffisants\n\tif (Settings::get(\"allow_gestionnaire_modify_del\") == 0)\n\t\t$temp = 3;\n\telse\n\t\t$temp = 2;\n\tif (authGetUserLevel($user,$id_room) > $temp)\n\t\treturn 1;\n\t//if ($beneficiaire == \"\") $beneficiaire = $user;\n\t// Dans le cas d'un b\u00c3\u0110n\u00c3\u0110ficiaire ext\u00c3\u0110rieur, $beneficiaire est vide. On fait comme si $user \u00c3\u0110tait le b\u00c3\u0110n\u00c3\u0110ficiaire\n\t$dont_allow_modify = grr_sql_query1(\"select dont_allow_modify from \".TABLE_PREFIX.\"_room WHERE id = '\".$id_room.\"'\");\n\t$owner = strtolower(grr_sql_query1(\"SELECT create_by FROM \".TABLE_PREFIX.\"_entry WHERE id='\".protect_data_sql($id).\"'\"));\n\t$beneficiaire = strtolower($beneficiaire);\n\t$user = strtolower($user);\n\t//Il reste \u00c3\u00a0 \u00c3\u0110tudier le cas d'un utilisateur sans droits particuliers. quatre cas possibles :\n\t//Cas 1 : l'utilisateur (U) n'est ni le cr\u00c3\u0110ateur (C) ni le b\u00c3\u0110n\u00c3\u0110ficiaire (B)\n\t//\tR1 -> on retourne 0\n\t//Cas 2 : U=B et et U<>C  ou ...\n\t//Cas 3 : U=B et et U=C\n\t//\tR2 -> on retourne 0 si personne hormis les gestionnaires et les administrateurs ne peut modifier ou supprimer ses propres r\u00c3\u0110servations.\n\t//\tR3 -> on retourne 1 sinon\n\t//Cas 4 : U=C et U<>B\n\t//\tR4 -> on retourne 0 si personne hormis les gestionnaires et les administrateurs ne peut modifier ou supprimer ses propres r\u00c3\u0110servations.\n\t//\t-> sinon\n\t//\t\tR5 -> on retourne 1 si l'utilisateur U peut r\u00c3\u0110server la ressource pour B\n\t//\t\tR6 -> on retourne 0 sinon (si on permettait \u00c3\u00a0 U d'\u00c3\u0110diter la r\u00c3\u0110sa, il ne pourrait de toute fa\u00c3\u00a7on pas la modifier)\n\tif (($user != $beneficiaire) && ($user != $owner))\n\t\treturn 0;\n\telse if ($user == $beneficiaire)\n\t{\n\t\tif ($dont_allow_modify == 'y')\n\t\t\treturn 0;\n\t\telse\n\t\t\treturn 1;\n\t}\n\telse if ($user == $owner)\n\t{\n\t\tif ($dont_allow_modify == 'y')\n\t\t\treturn 0;\n\t\telse\n\t\t{\n\t\t\t$qui_peut_reserver_pour = grr_sql_query1(\"SELECT qui_peut_reserver_pour FROM \".TABLE_PREFIX.\"_room WHERE id='\".$id_room.\"'\");\n\t\t\tif (authGetUserLevel($user, $id_room) >= $qui_peut_reserver_pour)\n\t\t\t\treturn 1;\n\t\t\telse\n\t\t\t\treturn 0;\n\t\t}\n\t}\n\treturn 0;\n}\n//auth_visiteur($user,$id_room)\n//Determine si un visiteur peut r\u00c3\u0110server une ressource\n//$user - l'identifiant de l'utilisateur\n//$id_room -   l'identifiant de la ressource\n//Retourne le niveau d'acc\u00c3\u013bs de l'utilisateur//\nfunction auth_visiteur($user,$id_room)\n{\n\tglobal $id_room_autorise;\n\tif ((!isset($user)) || (!isset($id_room)))\n\t\treturn 0;\n\t$res = grr_sql_query(\"SELECT statut FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login ='\".protect_data_sql($user).\"'\");\n\tif (!$res || grr_sql_count($res) == 0)\n\t\treturn 0;\n\t$status = mysqli_fetch_row($res);\n\tif (strtolower($status[0]) == 'visiteur')\n\t{\n\t\tif ((in_array($id_room,$id_room_autorise)) && ($id_room_autorise != \"\"))\n\t\t\treturn 1;\n\t\telse\n\t\t\treturn 0;\n\t}\n\treturn 0;\n}\n//authGetUserLevel($user,$id,$type)\n//Determine le niveau d'acc\u00c3\u013bs de l'utilisateur\n//$user - l'identifiant de l'utilisateur\n//$id -   l'identifiant de la ressource ou du domaine\n// $type - argument optionnel : 'room' (par d\u00c3\u0110faut) si $id d\u00c3\u0110signe une ressource et 'area' si $id d\u00c3\u0110signe un domaine.\n////Retourne le niveau d'acc\u00c3\u013bs de l'utilisateur\n// 0 NC / 1 Visiteur / 2 Utilisateur / 3 gestionnaire de ressource / 4 administrateur de domaine / 5 administrateur de site / 6 Admin g\u00c3\u0110n\u00c3\u0110ral\nfunction authGetUserLevel($user, $id, $type = 'room')\n{\n\t//user level '0': User not logged in, or User value is NULL (getUserName()='')\n\tif (!isset($user) || ($user == ''))\n\t\treturn 0;\n\t// On vient lire le statut de l'utilisateur courant dans la database\n\t$sql = \"SELECT statut FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='\".protect_data_sql($user).\"' \".\" AND etat='actif'\";\n\t$res = grr_sql_query($sql);\n\t$nbraw = grr_sql_count($res);\n\t//user level '0': User not defined in database\n\tif (!$res || $nbraw == 0)\n\t\treturn 0;\n\t// On vient lire le r\u00c3\u0110sultat de la requ\u00c3\u013bte\n\t$status = grr_sql_row($res,$nbraw-1);\n\t//user level '0': Same User defined multiple time in database !!!\n\tif ($status === 0)\n\t\treturn 0;\n\t// Teste si le type concerne la gestion des utilisateurs\n\tif ($type === 'user')\n\t{\n\t\tif (strtolower($status[0]) == 'gestionnaire_utilisateur')\n\t\t\treturn 1;\n\t\telse\n\t\t\treturn 0;\n\t}\n\tswitch (strtolower($status[0]))\n\t{\n\t\tcase 'visiteur':\n\t\treturn 1;\n\t\tcase 'administrateur':\n\t\treturn 6;\n\t\tdefault:\n\t\tbreak;\n\t}\n\tif ((strtolower($status[0]) == 'utilisateur') || (strtolower($status[0]) == 'gestionnaire_utilisateur'))\n\t{\n\t\tif ($type == 'room')\n\t\t{\n\t\t\t// On regarde si l'utilisateur est administrateur du site auquel la ressource $id appartient\n\t\t\t// calcul de l'id du domaine\n\t\t\t$id_area = grr_sql_query1(\"SELECT area_id FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id).\"'\");\n\t\t\t// calcul de l'id du site\n\t\t\t$id_site = grr_sql_query1(\"SELECT id_site FROM \".TABLE_PREFIX.\"_j_site_area  WHERE id_area='\".protect_data_sql($id_area).\"'\");\n\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t{\n\t\t\t\t$res3 = grr_sql_query(\"SELECT login FROM \".TABLE_PREFIX.\"_j_useradmin_site j WHERE j.id_site='\".protect_data_sql($id_site).\"' AND j.login='\".protect_data_sql($user).\"'\");\n\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t{\n\t\t\t\t\tgrr_sql_free($res3);\n\t\t\t\t\treturn 5;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// On regarde si l'utilisateur est administrateur du domaine auquel la ressource $id appartient\n\t\t\t$res3 = grr_sql_query(\"SELECT u.login\n\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_area j\n\t\t\t\tWHERE (u.login=j.login AND j.id_area='\".protect_data_sql($id_area).\"' AND u.login='\".protect_data_sql($user).\"')\");\n\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\treturn 4;\n\t\t\t// On regarde si l'utilisateur est gestionnaire des r\u00c3\u0110servations pour une ressource\n\t\t\t$str_res2 = \"SELECT *\n\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_user_room j\n\t\t\tWHERE u.login=j.login and u.login='\".protect_data_sql($user).\"' \";\n\t\t\tif ($id!=-1)\n\t\t\t\t$str_res2.=\"AND j.id_room='\".protect_data_sql($id).\"'\";\n\t\t\t$res2 = grr_sql_query($str_res2);\n\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\treturn 3;\n\t\t\t// Sinon il s'agit d'un simple utilisateur\n\t\t\treturn 2;\n\t\t}\n\t\t// On regarde si l'utilisateur est administrateur d'un domaine\n\t\tif ($type == 'area')\n\t\t{\n\t\t\tif ($id == '-1')\n\t\t\t{\n\t\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t\t{\n\t\t\t\t//On regarde si l'utilisateur est administrateur d'un site quelconque\n\t\t\t\t\t$res2 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_site j\n\t\t\t\t\t\tWHERE (u.login=j.login and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\t\t\treturn 5;\n\t\t\t\t}\n\t\t\t\t//On regarde si l'utilisateur est administrateur d'un domaine quelconque\n\t\t\t\t$res2 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_area j\n\t\t\t\t\tWHERE (u.login=j.login and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\t\treturn 4;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t\t\t\t{\n\t\t\t\t// On regarde si l'utilisateur est administrateur du site auquel le domaine $id appartient\n\t\t\t\t\t$id_site = grr_sql_query1(\"SELECT id_site FROM \".TABLE_PREFIX.\"_j_site_area  WHERE id_area='\".protect_data_sql($id).\"'\");\n\t\t\t\t\t$res3 = grr_sql_query(\"SELECT login FROM \".TABLE_PREFIX.\"_j_useradmin_site j WHERE j.id_site='\".protect_data_sql($id_site).\"' AND j.login='\".protect_data_sql($user).\"'\");\n\t\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t\t\treturn 5;\n\t\t\t\t}\n\t\t\t\t//On regarde si l'utilisateur est administrateur du domaine dont l'id est $id\n\t\t\t\t$res3 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_area j\n\t\t\t\t\tWHERE (u.login=j.login and j.id_area='\".protect_data_sql($id).\"' and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t\treturn 4;\n\t\t\t}\n\t\t\t// Sinon il s'agit d'un simple utilisateur\n\t\t\treturn 2;\n\t\t}\n\t\t// On regarde si l'utilisateur est administrateur d'un site\n\t\tif (($type == 'site') and (Settings::get(\"module_multisite\") == \"Oui\"))\n\t\t{\n\t\t\tif ($id == '-1')\n\t\t\t{\n\t\t\t\t//On regarde si l'utilisateur est administrateur d'un site quelconque\n\t\t\t\t$res2 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_site j\n\t\t\t\t\tWHERE (u.login=j.login and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res2) > 0)\n\t\t\t\t\treturn 5;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\t//On regarde si l'utilisateur est administrateur du site dont l'id est $id\n\t\t\t\t$res3 = grr_sql_query(\"SELECT u.login\n\t\t\t\t\tFROM \".TABLE_PREFIX.\"_utilisateurs u, \".TABLE_PREFIX.\"_j_useradmin_site j\n\t\t\t\t\tWHERE (u.login=j.login and j.id_site='\".protect_data_sql($id).\"' and u.login='\".protect_data_sql($user).\"')\");\n\t\t\t\tif (grr_sql_count($res3) > 0)\n\t\t\t\t\treturn 5;\n\t\t\t}\n\t\t\t// Sinon il s'agit d'un simple utilisateur\n\t\t\treturn 2;\n\t\t}\n\t}\n}\n/* authUserAccesArea($user,$id)\n *\n * Determines if the user access area\n *\n * $user - The user name\n * $id -   Which area are we checking\n *\n */\nfunction authUserAccesArea($user,$id)\n{\n\tif ($id == '')\n\t\treturn 0;\n\t$sql = \"SELECT login FROM \".TABLE_PREFIX.\"_utilisateurs WHERE (login = '\".protect_data_sql($user).\"' and statut='administrateur')\";\n\t$res = grr_sql_query($sql);\n\tif (grr_sql_count($res) != \"0\")\n\t\treturn 1;\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\t\t$id_site = mrbsGetAreaSite($id);\n\t\t$sql = \"SELECT login FROM \".TABLE_PREFIX.\"_j_useradmin_site j WHERE j.id_site='\".$id_site.\"' AND j.login='\".protect_data_sql($user).\"'\";\n\t\t$res = grr_sql_query($sql);\n\t\tif (grr_sql_count($res) != \"0\")\n\t\t\treturn 1;\n\t}\n\t$sql = \"SELECT id FROM \".TABLE_PREFIX.\"_area WHERE (id = '\".protect_data_sql($id).\"' and access='r')\";\n\t$res = grr_sql_query($sql);\n\t$test = grr_sql_count($res);\n\tif ($test == \"0\")\n\t\treturn 1;\n\telse\n\t{\n\t\t$sql2 = \"SELECT login FROM \".TABLE_PREFIX.\"_j_user_area WHERE (login = '\".protect_data_sql($user).\"' and id_area = '\".protect_data_sql($id).\"')\";\n\t\t$res2 = grr_sql_query($sql2);\n\t\t$test2 = grr_sql_count($res2);\n\t\tif ($test2 != \"0\")\n\t\t\treturn 1;\n\t\telse\n\t\t\treturn 0;\n\t}\n}\n// function UserRoomMaxBooking\n// Cette fonction teste si l'utilisateur a la possibilit\u00c3\u0110 d'effectuer une r\u00c3\u0110servation, compte tenu\n// des limitations \u00c3\u0110ventuelles de la ressources et du nombre de r\u00c3\u0110servations d\u00c3\u0110j\u00c3\u00a0 effectu\u00c3\u0110es.\n//\nfunction UserRoomMaxBooking($user, $id_room, $number)\n{\n\tglobal $enable_periods,$id_room_autorise;\n\t$level = authGetUserLevel($user,$id_room);\n\tif ($id_room == '')\n\t\treturn 0;\n\tif ($level >= 3)\n\t\treturn 1;\n\telse if (($level == 1 ) &&  !((in_array($id_room,$id_room_autorise)) && ($id_room_autorise != \"\")))\n\t\treturn 0;\n\telse if ($level  < 1 )\n\t\treturn 0;\n\t// A ce niveau, l'utilisateur est simple utilisateur ou bien simple visiteur sur un domaine autoris\u00c3\u0110\n\t// On regarde si le nombre de r\u00c3\u0110servation de la ressource est limit\u00c3\u0110\n\t$max_booking_per_room = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_room WHERE id = '\".protect_data_sql($id_room).\"'\");\n\t// Calcul de l'id de l'area de la ressource.\n\t$id_area = mrbsGetRoomArea($id_room);\n\t// On regarde si le nombre de r\u00c3\u0110servation du domaine est limit\u00c3\u0110\n\t$max_booking_per_area = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($id_area).\"'\");\n\t// On regarde si le nombre de r\u00c3\u0110servation pour l'ensemble des ressources est limit\u00c3\u0110\n\t$max_booking = Settings::get(\"UserAllRoomsMaxBooking\");\n\t// Si aucune limitation\n\tif (($max_booking_per_room < 0) && ($max_booking_per_area < 0) && ($max_booking < 0))\n\t\treturn 1;\n\t// A ce niveau, il s'agit d'un utilisateur et il y a au moins une limitation\n\t$day   = date(\"d\");\n\t$month = date(\"m\");\n\t$year  = date(\"Y\");\n\t$hour  = date(\"H\");\n\t$minute = date(\"i\");\n\tif ($enable_periods == 'y')\n\t\t$now = mktime(0, 0, 0, $month, $day, $year);\n\telse\n\t\t$now = mktime($hour, $minute, 0, $month, $day, $year);\n\t// y-a-t-il d\u00c3\u0110passement pour l'ensemble des ressources ?\n\tif ($max_booking > 0)\n\t{\n\t\t$nb_bookings = grr_sql_query1(\"SELECT count(id) FROM \".TABLE_PREFIX.\"_entry r WHERE (beneficiaire = '\".protect_data_sql($user).\"' and end_time > '$now')\");\n\t\t$nb_bookings += $number;\n\t\tif ($nb_bookings > $max_booking)\n\t\t\treturn 0;\n\t}\n\telse if ($max_booking == 0)\n\t\treturn 0;\n\t// y-a-t-il d\u00c3\u0110passement pour l'ensemble des ressources du domaine ?\n\tif ($max_booking_per_area > 0)\n\t{\n\t\t$nb_bookings = grr_sql_query1(\"SELECT count(e.id) FROM \".TABLE_PREFIX.\"_entry e, \".TABLE_PREFIX.\"_room r WHERE (e.room_id=r.id and r.area_id='\".$id_area.\"' and e.beneficiaire = '\".protect_data_sql($user).\"' and e.end_time > '$now')\");\n\t\t$nb_bookings += $number;\n\t\tif ($nb_bookings > $max_booking_per_area)\n\t\t\treturn 0;\n\t}\n\telse if ($max_booking_per_area == 0)\n\t\treturn 0;\n\t// y-a-t-il d\u00c3\u0110passement pour la ressource\n\tif ($max_booking_per_room > 0)\n\t{\n\t\t$nb_bookings = grr_sql_query1(\"SELECT count(id) FROM \".TABLE_PREFIX.\"_entry WHERE (room_id = '\".protect_data_sql($id_room).\"' and beneficiaire = '\".protect_data_sql($user).\"' and end_time > '$now')\");\n\t\t$nb_bookings += $number;\n\t\tif ($nb_bookings > $max_booking_per_room)\n\t\t\treturn 0;\n\t}\n\telse if ($max_booking_per_room == 0)\n\t\treturn 0;\n\t// A ce stade, il s'agit d'un utilisateu et il n'y a pas eu de d\u00c3\u0110passement, ni pour l'ensemble des domaines, ni pour le domaine, ni pour la ressource\n\treturn 1;\n}\n/* function verif_booking_date($user, $id, $date_booking, $date_now)\n $user : le login de l'utilisateur\n $id : l'id de la r\u00c3\u0110sa. Si -1, il s'agit d'une nouvelle r\u00c3\u0110servation\n $id_room : id de la ressource\n $date_booking : la date de la r\u00c3\u0110servation (n'est utile que si $id=-1)\n $date_now : la date actuelle\n*/\n /**\n  * @param string $date_booking\n  * @param integer $date_now\n  */\n function verif_booking_date($user, $id, $id_room, $date_booking, $date_now, $enable_periods, $endtime = '')\n {\n \tglobal $correct_diff_time_local_serveur, $can_delete_or_create;\n \t$can_delete_or_create = \"y\";\n\t// On teste si l'utilisateur est administrateur\n \t$sql = \"SELECT statut FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".protect_data_sql($user).\"'\";\n \t$statut_user = grr_sql_query1($sql);\n \tif ($statut_user == 'administrateur')\n \t\treturn true;\n\t// A-t-on le droit d'agir dans le pass\u00c3\u0110 ?\n \t$allow_action_in_past = grr_sql_query1(\"SELECT allow_action_in_past FROM \".TABLE_PREFIX.\"_room WHERE id = '\".protect_data_sql($id_room).\"'\");\n \tif ($allow_action_in_past == 'y')\n \t\treturn true;\n\t// Correction de l'avance en nombre d'heure du serveur sur les postes clients\n \tif ((isset($correct_diff_time_local_serveur)) && ($correct_diff_time_local_serveur!=0))\n \t\t$date_now -= 3600 * $correct_diff_time_local_serveur;\n\t// Cr\u00c3\u0110neaux bas\u00c3\u0110s sur les intitul\u00c3\u0110s\n\t// Dans ce cas, on prend comme temps pr\u00c3\u0110sent le jour m\u00c3\u0160me \u00c3\u00a0 minuit.\n\t// Cela signifie qu'il est possible de modifier/r\u00c3\u0110server/supprimer tout au long d'une journ\u00c3\u0110e\n\t// m\u00c3\u0160me si l'heure est pass\u00c3\u0110e.\n\t// Cela demande donc \u00c3\u00a0 \u00c3\u0160tre am\u00c3\u0110liorer en introduisant pour chaque cr\u00c3\u0110neau une heure limite de r\u00c3\u0110servation.\n \tif ($enable_periods == \"y\")\n \t{\n \t\t$month = date(\"m\",$date_now);\n \t\t$day = date(\"d\",$date_now);\n \t\t$year = date(\"Y\",$date_now);\n \t\t$date_now = mktime(0, 0, 0, $month, $day, $year);\n \t}\n \tif ($id != -1)\n \t{\n\t\t// il s'agit de l'edition d'une r\u00c3\u0110servation existante\n \t\tif (($endtime != '') && ($endtime < $date_now))\n \t\t\treturn false;\n \t\tif ((Settings::get(\"allow_user_delete_after_begin\") == 1) || (Settings::get(\"allow_user_delete_after_begin\") == 2))\n \t\t\t$sql = \"SELECT end_time FROM \".TABLE_PREFIX.\"_entry WHERE id = '\".protect_data_sql($id).\"'\";\n \t\telse\n \t\t\t$sql = \"SELECT start_time FROM \".TABLE_PREFIX.\"_entry WHERE id = '\".protect_data_sql($id).\"'\";\n \t\t$date_booking = grr_sql_query1($sql);\n \t\tif ($date_booking < $date_now)\n \t\t\treturn false;\n \t\telse\n \t\t{\n\t\t\t// dans le cas o\u00c3\u0111 le cr\u00c3\u0110neau est entam\u00c3\u0110, on teste si l'utilisateur a le droit de supprimer la r\u00c3\u0110servation\n\t\t\t// Si oui, on transmet la variable $only_modify = true avant que la fonction de retourne true.\n \t\t\tif (Settings::get(\"allow_user_delete_after_begin\") == 2)\n \t\t\t{\n \t\t\t\t$date_debut = grr_sql_query1(\"SELECT start_time FROM \".TABLE_PREFIX.\"_entry WHERE id = '\".protect_data_sql($id).\"'\");\n \t\t\t\tif ($date_debut < $date_now)\n \t\t\t\t\t$can_delete_or_create = \"n\";\n \t\t\t\telse\n \t\t\t\t\t$can_delete_or_create = \"y\";\n \t\t\t}\n \t\t\treturn true;\n \t\t}\n \t}\n \telse\n \t{\n \t\tif (Settings::get(\"allow_user_delete_after_begin\") == 1)\n \t\t{\n \t\t\t$id_area = grr_sql_query1(\"select area_id from \".TABLE_PREFIX.\"_room WHERE id = '\".protect_data_sql($id_room).\"'\");\n \t\t\t$resolution_area = grr_sql_query1(\"select resolution_area from \".TABLE_PREFIX.\"_area WHERE id = '\".$id_area.\"'\");\n \t\t\tif ($date_booking > $date_now - $resolution_area)\n \t\t\t\treturn true;\n \t\t\treturn false;\n \t\t}\n \t\telse\n \t\t{\n \t\t\tif ($date_booking > $date_now)\n \t\t\t\treturn true;\n \t\t\treturn false;\n \t\t}\n \t}\n }\n// function verif_duree_max_resa_area($user, $id_room, $starttime, $endtime)\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource. Si -1, il s'agit d'une nouvelle ressource.\n// $starttime : d\u00c3\u0110but de la r\u00c3\u0110servation\n// $endtime : fin de la r\u00c3\u0110servation\n function verif_duree_max_resa_area($user, $id_room, $starttime, $endtime)\n {\n \tif (authGetUserLevel($user,$id_room) >= 3)\n \t\treturn true;\n \t$id_area = grr_sql_query1(\"SELECT area_id from \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n \t$duree_max_resa_area = grr_sql_query1(\"SELECT duree_max_resa_area from \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n \t$enable_periods =  grr_sql_query1(\"SELECT enable_periods from \".TABLE_PREFIX.\"_area WHERE id='\".$id_area.\"'\");\n \tif ($enable_periods == 'y')\n \t\t$duree_max_resa_area = $duree_max_resa_area * 24 * 60;\n \tif ($duree_max_resa_area < 0)\n \t\treturn true;\n \telse if ($endtime - $starttime > $duree_max_resa_area * 60)\n \t\treturn false;\n \treturn true;\n }\n// function verif_delais_max_resa_room($user, $id_room, $date_booking)\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource. Si -1, il s'agit d'une nouvelle ressoure\n// $date_booking : la date de la r\u00c3\u0110servation (n'est utile que si $id=-1)\n// $date_now : la date actuelle\n function verif_delais_max_resa_room($user, $id_room, $date_booking)\n {\n \t$day   = date(\"d\");\n \t$month = date(\"m\");\n \t$year  = date(\"Y\");\n \t$datenow = mktime(0, 0, 0, $month, $day, $year);\n \tif (authGetUserLevel($user,$id_room) >= 3)\n \t\treturn true;\n \t$delais_max_resa_room = grr_sql_query1(\"SELECT delais_max_resa_room FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n\tif ($delais_max_resa_room == -1)\n \t\treturn true;\n \telse if ($datenow + $delais_max_resa_room * 24 * 3600 + 1 < $date_booking)\n \t\treturn false;\n \treturn true;\n }\n// function verif_access_search : v\u00c3\u0110rifier l'acc\u00c3\u013bs \u00c3\u00a0 l'outil de recherche\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource.\n function verif_access_search($user)\n {\n \tif (authGetUserLevel($user,-1) >= Settings::get(\"allow_search_level\"))\n \t\treturn true;\n \treturn false;\n }\n// function verif_display_fiche_ressource : v\u00c3\u0110rifier l'acc\u00c3\u013bs \u00c3\u00a0 la visualisation de la fiche d'une ressource\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource.\n function verif_display_fiche_ressource($user, $id_room)\n {\n \t$show_fic_room = grr_sql_query1(\"SELECT show_fic_room FROM \".TABLE_PREFIX.\"_room WHERE id='\".$id_room.\"'\");\n \tif ($show_fic_room == \"y\")\n \t{\n \t\tif (authGetUserLevel($user,$id_room) >= Settings::get(\"visu_fiche_description\"))\n \t\t\treturn true;\n \t\treturn false;\n \t}\n \treturn false;\n }\n// function verif_acces_fiche_reservation : v\u00c3\u0110rifier l'acc\u00c3\u013bs \u00c3\u00a0 la fiche de r\u00c3\u0110servation d'une ressource\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource.\n function verif_acces_fiche_reservation($user, $id_room)\n {\n \tif (authGetUserLevel($user,$id_room) >= Settings::get(\"acces_fiche_reservation\"))\n \t\treturn true;\n \treturn false;\n }\n/* function verif_display_email : v\u00c3\u0110rifier l'acc\u00c3\u013bs \u00c3\u00a0 l'adresse email\n *$user : le login de l'utilisateur\n * $id_room : l'id de la ressource.\n */\nfunction verif_display_email($user, $id_room)\n{\n\tif (authGetUserLevel($user,$id_room) >= Settings::get(\"display_level_email\"))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n/* function verif_acces_ressource : v\u00c3\u0110rifier l'acc\u00c3\u013bs \u00c3\u00a0 la ressource\n *$user : le login de l'utilisateur\n * $id_room : l'id de la ressource.\n */\nfunction verif_acces_ressource($user, $id_room)\n{\n\tif ($id_room != 'all')\n\t{\n\t\t$who_can_see = grr_sql_query1(\"SELECT who_can_see FROM \".TABLE_PREFIX.\"_room WHERE id='\".$id_room.\"'\");\n\t\tif (authGetUserLevel($user,$id_room) >= $who_can_see)\n\t\t\treturn true;\n\t\telse\n\t\t\treturn false;\n\t}\n\telse\n\t{\n\t\t$tab_rooms_noaccess = array();\n\t\t$sql = \"SELECT id, who_can_see FROM \".TABLE_PREFIX.\"_room\";\n\t\t$res = grr_sql_query($sql);\n\t\tif (!$res)\n\t\t\tfatal_error(0, grr_sql_error());\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (authGetUserLevel($user,$row[0]) < $row[1])\n\t\t\t\t$tab_rooms_noaccess[] = $row[0];\n\t\t}\n\t\treturn $tab_rooms_noaccess;\n\t}\n}\n// function verif_delais_min_resa_room($user, $id_room, $date_booking)\n// $user : le login de l'utilisateur\n// $id_room : l'id de la ressource. Si -1, il s'agit d'une nouvelle ressoure\n// $date_booking : la date de la r\u00c3\u0110servation (n'est utile que si $id=-1)\n// $date_now : la date actuelle\n//\nfunction verif_delais_min_resa_room($user, $id_room, $date_booking)\n{\n\tif (authGetUserLevel($user,$id_room) >= 3)\n\t\treturn true;\n\t$delais_min_resa_room = grr_sql_query1(\"SELECT delais_min_resa_room FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n\tif ($delais_min_resa_room == 0)\n\t\treturn true;\n\telse\n\t{\n\t\t$hour = date(\"H\");\n\t\t$minute  = date(\"i\") + $delais_min_resa_room;\n\t\t$day   = date(\"d\");\n\t\t$month = date(\"m\");\n\t\t$year  = date(\"Y\");\n\t\t$date_limite = mktime($hour, $minute, 0, $month, $day, $year);\n\t\tif ($date_limite > $date_booking)\n\t\t\treturn false;\n\t\treturn true;\n\t}\n}\n// V\u00c3\u0110rifie que la date de confirmation est inf\u00c3\u0110rieur \u00c3\u00a0 la date de d\u00c3\u0110but de r\u00c3\u0110servation\nfunction verif_date_option_reservation($option_reservation, $starttime)\n{\n\tif ($option_reservation == -1)\n\t\treturn true;\n\telse\n\t{\n\t\t$day   = date(\"d\", $starttime);\n\t\t$month = date(\"m\", $starttime);\n\t\t$year  = date(\"Y\", $starttime);\n\t\t$date_starttime = mktime(0, 0, 0, $month, $day, $year);\n\t\tif ($option_reservation < $date_starttime)\n\t\t\treturn true;\n\t\treturn false;\n\t}\n}\n// V\u00c3\u0110rifie que $_create_by peut r\u00c3\u0110server la ressource $_room_id pour $_beneficiaire\nfunction verif_qui_peut_reserver_pour($_room_id, $_create_by, $_beneficiaire)\n{\n\tif ($_beneficiaire == \"\")\n\t\treturn true;\n\tif (strtolower($_create_by) == strtolower($_beneficiaire))\n\t\treturn true;\n\t$qui_peut_reserver_pour  = grr_sql_query1(\"SELECT qui_peut_reserver_pour FROM \".TABLE_PREFIX.\"_room WHERE id='\".$_room_id.\"'\");\n\tif (authGetUserLevel($_create_by, $_room_id) >= $qui_peut_reserver_pour)\n\t\treturn true;\n\treturn false;\n}\n/*\nfunction verif_heure_debut_fin($start_time,$end_time,$area)\nV\u00c3\u0110rifie si l'heure de d\u00c3\u0110but ou l'heure de fin de r\u00c3\u0110servation est en dehors des cr\u00c3\u0110neaux autoris\u00c3\u0110s.\n*/\nfunction verif_heure_debut_fin($start_time,$end_time,$area)\n{\n\tglobal $enable_periods, $resolution, $morningstarts, $eveningends, $eveningends_minutes;\n\t\t// R\u00c3\u0110cup\u00c3\u0110ration des donn\u00c3\u0110es concernant l'affichage du planning du domaine\n\tget_planning_area_values($area);\n\t\t// On ne traite pas le cas des plannings bas\u00c3\u0110s sur les intitul\u00c3\u0110s pr\u00c3\u0110d\u00c3\u0110finis\n\tif ($enable_periods != \"y\")\n\t{\n\t\t$day = date(\"d\",$start_time);\n\t\t$month = date(\"m\",$start_time);\n\t\t$year = date(\"Y\",$start_time);\n\t\t$startday = mktime($morningstarts, 0, 0, $month, $day  , $year);\n\t\t$day = date(\"d\",$end_time);\n\t\t$month = date(\"m\",$end_time);\n\t\t$year = date(\"Y\",$end_time);\n\t\t$endday = mktime($eveningends, $eveningends_minutes , $resolution, $month, $day, $year);\n\t\tif ($start_time < $startday)\n\t\t\treturn false;\n\t\telse if ($end_time > $endday)\n\t\t\treturn false;\n\t}\n\treturn true;\n}\n/* VerifyModeDemo()\n *\n * Affiche une page \"op\u00c3\u0110ration non autoris\u00c3\u0110e\" pour certaines op\u00c3\u0110rations dans le cas le mode demo est activ\u00c3\u0110.\n *\n * Returns: Nothing\n */\nfunction VerifyModeDemo() {\n\tif (Settings::get(\"ActiveModeDemo\") == 'y')\n\t{\n\t\tprint_header(\"\", \"\", \"\", \"\");\n\t\t?>\n\t\t<h1>Op&eacute;ration non autoris&eacute;e</h1>\n\t\t<p>Vous \u00c3\u0160tes dans une <b>version de d\u00c3\u0110monstration de GRR</b>.\n\t\t\t<br />Certaines fonctions ont \u00c3\u0110t\u00c3\u0110 volontairement brid\u00c3\u0110es. C'est le cas pour l'op\u00c3\u0110ration que vous avez tent\u00c3\u0110 d'effectuer.</p>\n\t\t</body></html>\n\t\t<?php\n\t\tdie();\n\t}\n}\n/* MajMysqlModeDemo()\n * dans le cas le mode demo est activ\u00c3\u0110 :\n * Met \u00c3\u00a0 jour la base mysql une fois par jour, lors de la premi\u00c3\u013bre connexion\n *\n */\nfunction MajMysqlModeDemo() {\n\t\t// Nom du fichier sql \u00c3\u00a0 ex\u00c3\u0110cuter\n\t$fic_sql = \"grr_maj_quotidienne.sql\";\n\tif ((Settings::get(\"ActiveModeDemo\") == 'y') && (file_exists($fic_sql)))\n\t{\n\t\t$date_now = mktime(0,0,0,date(\"m\"),date(\"d\"),date(\"Y\"));\n\t\tif ((Settings::get(\"date_verify_demo\") == \"\") || (Settings::get(\"date_verify_demo\") < $date_now))\n\t\t{\n\t\t\t$fd = fopen($fic_sql, \"r\");\n\t\t\twhile (!feof($fd))\n\t\t\t{\n\t\t\t\t$query = fgets($fd, 5000);\n\t\t\t\t$query = trim($query);\n\t\t\t\tif ($query != '')\n\t\t\t\t\tmysqli_query($GLOBALS['db_c'], $query);\n\t\t\t}\n\t\t\tfclose($fd);\n\t\t\tif (!Settings::set(\"date_verify_demo\", $date_now))\n\t\t\t{\n\t\t\t\techo \"Erreur lors de l'enregistrement de date_verify_demo !<br />\";\n\t\t\t\tdie();\n\t\t\t}\n\t\t}\n\t}\n}\n/* showAccessDenied()\n *\n * Displays an appropriate message when access has been denied\n *\n * Returns: Nothing\n */\nfunction showAccessDenied($back)\n{\n\tglobal $vocab;\n\techo '<h1>'.get_vocab(\"accessdenied\").'</h1>';\n\techo '<p>'.get_vocab(\"norights\").'</p>';\n\techo '<p><a href=\"'.$back.'\">'.get_vocab(\"returnprev\").'</a></p>';\n\tend_page();\n}\n/* showNoReservation()\n *\n * Displays an appropriate message when reservation does not exist\n *\n * Returns: Nothing\n */\nfunction showNoReservation($day, $month, $year, $back)\n{\n\tglobal $vocab;\n\tif ((Settings::get(\"authentification_obli\") == 0) && (getUserName() == ''))\n\t\t$type_session = \"no_session\";\n\telse\n\t\t$type_session = \"with_session\";\n\tstart_page_w_header($day, $month, $year, $type_session);\n\techo '<h1>'.get_vocab(\"accessdenied\").'</h1>';\n\techo '<p>'.get_vocab(\"noreservation\").'</p>';\n\techo '<p><a href=\"'.$back.'\">'.get_vocab(\"returnprev\").'</a></p>';\n    end_page();\n}\n/* showAccessDeniedMaxBookings()\n *\n * Displays an appropriate message when access has been denied because of overbooking\n *\n * Returns: Nothing\n */\nfunction showAccessDeniedMaxBookings($day, $month, $year, $id_room, $back)\n{\n\tglobal $vocab;\n\tprint_header($day, $month, $year, $type=\"with_session\");\n\t?>\n\t<h1><?php echo get_vocab(\"accessdenied\")?></h1>\n\t<p>\n\t\t<?php\n\t\t// Limitation par ressource\n\t\t$max_booking_per_room = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_room WHERE id='\".protect_data_sql($id_room).\"'\");\n\t\tif ($max_booking_per_room >= 0)\n\t\t\techo get_vocab(\"msg_max_booking\").get_vocab(\"deux_points\").$max_booking_per_room.\"<br />\";\n\t\t// Calcul de l'id de l'area de la ressource.\n\t\t$id_area = mrbsGetRoomArea($id_room);\n\t\t// Limitation par domaine\n\t\t$max_booking_per_area = grr_sql_query1(\"SELECT max_booking FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($id_area).\"'\");\n\t\tif ($max_booking_per_area >= 0)\n\t\t\techo get_vocab(\"msg_max_booking_area\").get_vocab(\"deux_points\").$max_booking_per_area.\"<br />\";\n\t\t// Limitation sur l'ensemble des ressources\n\t\t$max_booking_all = Settings::get(\"UserAllRoomsMaxBooking\");\n\t\tif ($max_booking_all >= 0)\n\t\t\techo get_vocab(\"msg_max_booking_all\").get_vocab(\"deux_points\").$max_booking_all.\"<br />\";\n\t\techo \"<br />\".get_vocab(\"accessdeniedtoomanybooking\");\n\t\t?>\n\t</p>\n\t<p>\n\t\t<a href=\"<?php echo $back; ?>\"><?php echo get_vocab(\"returnprev\"); ?></a>\n\t</p>\n</body>\n</html>\n<?php\n}\n/* fonction qui rend TRUE lorsque la date propos\u00c3\u0110e est en dehors de la p\u00c3\u0110riode r\u00c3\u0110servable\n*/\nfunction check_begin_end_bookings($day, $month, $year)\n{\n\t$date = mktime(0,0,0,$month,$day,$year);\n\tif (($date < Settings::get(\"begin_bookings\")) || ($date > Settings::get(\"end_bookings\")))\n\t\treturn -1;\n}\nfunction showNoBookings($day, $month, $year, $back)\n{\n\tglobal $vocab;\n\t$date = mktime(0, 0, 0, $month, $day,$year);\n\techo '<h2>'.get_vocab(\"nobookings\").' '.affiche_date($date).'</h2>';\n\techo '<p>'.get_vocab(\"begin_bookings\").'<b>'.affiche_date(Settings::get(\"begin_bookings\")).'</b></p>';\n\techo '<p>'.get_vocab(\"end_bookings\").'<b>'.affiche_date(Settings::get(\"end_bookings\")).'</b></p>';\n    echo \"<p>\";\n        if ($back !=''){\n            echo \"<a href=\".$back.\">\".get_vocab('returnprev').\"</a>\";\n        }\n    echo \"</p>\";\n    echo \"</body>\\n</html>\";\n}\n/* donne, pour un format fran\u00c3\u00a7ais, un r\u00c3\u0110sultat de la forme lundi 30 sept.19:17:32\n*/\nfunction date_time_string($t, $dformat)\n{\n\tglobal $twentyfourhour_format;\n\tif ($twentyfourhour_format)\n\t\t$timeformat = \"%T\";\n\telse\n\t{\n\t\t$ampm = date(\"a\",$t);\n\t\t$timeformat = \"%I:%M$ampm\";\n\t}\n\treturn utf8_strftime($dformat.\" \".$timeformat, $t);\n}\n# Convertit un cr\u00c3\u0110neau de d\u00c3\u0110but et de fin en un tableau donnant la date de d\u00c3\u0110but et la dur\u00c3\u0110e\nfunction describe_period_span2($starts, $ends)\n{\n\tglobal $enable_periods, $periods_name, $vocab, $duration;\n\tlist($start_period, $start_date) =  period_date_string($starts);\n\tlist($periodedebut, $datedebut) =  period_date_string_rapport($starts);\n\tlist( , $end_date) =  period_date_string($ends, -1);\n\t$duration = $ends - $starts;\n\ttoPeriodString($start_period, $duration, $dur_units);\n\tif ($duration > 1)\n\t{\n\t\tlist( , $start_date) =  period_date_string($starts);\n\t\tlist( , $end_date) =  period_date_string($ends, -1);\n\t\t//$temp = $start_date . \" ==> \" . $end_date;\n\t}\n\t//else\n\t//{\n\t//\t$temp = $start_date . \" - \" . $duration . \" \" . $dur_units;\n\t//}\n\treturn array($datedebut, $periodedebut, $duration, $dur_units);\n}\n#Convertit l'heure de d\u00c3\u0110but et de fin un tableau donnant la date de d\u00c3\u0110but et la dur\u00c3\u0110e.\nfunction describe_span2($starts, $ends, $dformat)\n{\n\tglobal $vocab, $twentyfourhour_format;\n\t$start_date = utf8_strftime($dformat, $starts);\n\tif ($twentyfourhour_format)\n\t\t$timeformat = \"%T\";\n\telse\n\t{\n\t\t$ampm = date(\"a\",$starts);\n\t\t$timeformat = \"%I:%M$ampm\";\n\t}\n\t$start_time = strftime($timeformat, $starts);\n\t$duration = $ends - $starts;\n\ttoTimeString($duration, $dur_units);\n\treturn array($start_date, $start_time ,$duration, $dur_units);\n}\n# Convert a start period and end period to a plain language description.\n# This is similar but different from the way it is done in view_entry.\nfunction describe_period_span($starts, $ends)\n{\n\tglobal $enable_periods, $periods_name, $vocab, $duration;\n\tlist($start_period, $start_date) =  period_date_string($starts);\n\tlist( , $end_date) =  period_date_string($ends, -1);\n\t$duration = $ends - $starts;\n\ttoPeriodString($start_period, $duration, $dur_units);\n\tif ($duration > 1)\n\t{\n\t\tlist( , $start_date) =  period_date_string($starts);\n\t\tlist( , $end_date) =  period_date_string($ends, -1);\n\t\t$temp = $start_date . \" ==> \" . $end_date;\n\t}\n\telse\n\t{\n\t\t$temp = $start_date . \" - \" . $duration . \" \" . $dur_units;\n\t}\n\treturn $temp;\n}\n#Convertit l'heure de d\u00c3\u0110but et de fin en p\u00c3\u0110riode.\nfunction describe_span($starts, $ends, $dformat)\n{\n\tglobal $vocab, $twentyfourhour_format;\n\t$start_date = utf8_strftime($dformat, $starts);\n\tif ($twentyfourhour_format)\n\t\t$timeformat = \"%T\";\n\telse\n\t{\n\t\t$ampm = date(\"a\",$starts);\n\t\t$timeformat = \"%I:%M$ampm\";\n\t}\n\t$start_time = strftime($timeformat, $starts);\n\t$duration = $ends - $starts;\n\tif ($start_time == \"00:00:00\" && $duration == 60 * 60 * 24)\n\t\treturn $start_date . \" - \" . get_vocab(\"all_day\");\n\ttoTimeString($duration, $dur_units);\n\treturn $start_date . \" \" . $start_time . \" - \" . $duration . \" \" . $dur_units;\n}\nfunction get_planning_area_values($id_area)\n{\n\tglobal $resolution, $morningstarts, $eveningends, $eveningends_minutes, $weekstarts, $twentyfourhour_format, $enable_periods, $periods_name, $display_day, $nb_display_day;\n\t$sql = \"SELECT calendar_default_values, resolution_area, morningstarts_area, eveningends_area, eveningends_minutes_area, weekstarts_area, twentyfourhour_format_area, enable_periods, display_days\n\tFROM \".TABLE_PREFIX.\"_area\n\tWHERE id = '\".protect_data_sql($id_area).\"'\";\n\t$res = grr_sql_query($sql);\n\tif (!$res)\n\t{\n\t\t//fatal_error(0, grr_sql_error());\n\t\tinclude \"trailer.inc.php\";\n\t\texit;\n\t}\n\t$row_ = grr_sql_row($res, 0);\n\t$nb_display_day = 0;\n\tfor ($i = 0; $i < 7; $i++)\n\t{\n\t\tif (substr($row_[8],$i,1) == 'y')\n\t\t{\n\t\t\t$display_day[$i] = 1;\n\t\t\t$nb_display_day++;\n\t\t}\n\t\telse\n\t\t\t$display_day[$i] = 0;\n\t}\n\tif ($row_[7] == 'y')\t// Cr\u00c3\u0110neaux bas\u00c3\u0110s sur les intitul\u00c3\u0110s\n\t{\n\t\t$resolution = 60;\n\t\t$morningstarts = 12;\n\t\t$eveningends = 12;\n\t\t$sql_periode = grr_sql_query(\"SELECT nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"'\");\n\t\t$eveningends_minutes = grr_sql_count($sql_periode) - 1;\n\t\t$i = 0;\n\t\twhile ($i <= $eveningends_minutes)\n\t\t{\n\t\t\t$periods_name[$i] = grr_sql_query1(\"SELECT nom_periode FROM \".TABLE_PREFIX.\"_area_periodes where id_area='\".$id_area.\"' and num_periode= '\".$i.\"'\");\n\t\t\t$i++;\n\t\t}\n\t\t$enable_periods = \"y\";\n\t\t$weekstarts = $row_[5];\n\t\t$twentyfourhour_format = $row_[6];\n\t}\n\telse\t\t// Cr\u00c3\u0110neaux bas\u00c3\u0110s sur le temps\n\t{\n\t\tif ($row_[0] != 'y')\n\t\t{\n\t\t\t$resolution = $row_[1];\n\t\t\t$morningstarts = $row_[2];\n\t\t\t$eveningends = $row_[3];\n\t\t\t$eveningends_minutes = $row_[4];\n\t\t\t$enable_periods = \"n\";\n\t\t\t$weekstarts = $row_[5];\n\t\t\t$twentyfourhour_format = $row_[6];\n\t\t}\n\t}\n}\n// Dans le cas ou $unicode_encoding = 1 (UTF-8) cette fonction encode les cha\u00c3\u016anes pr\u00c3\u0110sentes dans\n// le code \"en dur\", en UTF-8 avant affichage\nfunction encode_message_utf8($tag)\n{\n\tglobal $charset_html, $unicode_encoding;\n\tif ($unicode_encoding)\n\t\treturn iconv($charset_html,\"utf-8\",$tag);\n\telse\n\t\treturn $tag;\n}\n/**\n * @param string $string\n * @return string\n */\nfunction removeMailUnicode($string)\n{\n\tglobal $unicode_encoding, $charset_html;\n\tif ($unicode_encoding)\n\t\treturn @iconv(\"utf-8\", $charset_html, $string);\n\telse\n\t\treturn $string;\n}\n// Cette fonction v\u00c3\u0110rifie une fois par jour si le d\u00c3\u0110lai de confirmation des r\u00c3\u0110servations est d\u00c3\u0110pass\u00c3\u0110\n// Si oui, les r\u00c3\u0110servations concern\u00c3\u0110es sont supprim\u00c3\u0110es et un mail automatique est envoy\u00c3\u0110.\nfunction verify_confirm_reservation()\n{\n\tglobal $dformat;\n\t$day   = date(\"d\");\n\t$month = date(\"m\");\n\t$year  = date(\"Y\");\n\t$date_now = mktime(0,0,0,$month,$day,$year);\n\tif ((Settings::get(\"date_verify_reservation\") == \"\") || (Settings::get(\"date_verify_reservation\") < $date_now ))\n\t{\n\t\t$res = grr_sql_query(\"select id from \".TABLE_PREFIX.\"_room where delais_option_reservation > 0\");\n\t\tif (!$res)\n\t\t{\n\t\t\t//fatal_error(0, grr_sql_error());\n\t\t\tinclude \"trailer.inc.php\";\n\t\t\texit;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\t$res2 = grr_sql_query(\"select id from \".TABLE_PREFIX.\"_entry where option_reservation < '\".$date_now.\"' and option_reservation != '-1' and room_id='\".$row[0].\"'\");\n\t\t\t\tif (!$res2)\n\t\t\t\t{\n\t\t\t\t\t//fatal_error(0, grr_sql_error());\n\t\t\t\t\tinclude \"trailer.inc.php\";\n\t\t\t\t\texit;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (Settings::get(\"automatic_mail\") == 'yes')\n\t\t\t\t\t\t\t$_SESSION['session_message_error'] = send_mail($row2[0],4,$dformat);\n\t\t\t\t\t\t// On efface la r\u00c3\u0110servation\n\t\t\t\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_entry WHERE id=\" . $row2[0]);\n\t\t\t\t\t\t// On efface le cas \u00c3\u0110cheant \u00c3\u0110galement  dans \".TABLE_PREFIX.\"_entry_moderate\n\t\t\t\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_entry_moderate WHERE id=\" . $row2[0]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!Settings::set(\"date_verify_reservation\", $date_now))\n\t\t{\n\t\t\techo \"Erreur lors de l'enregistrement de date_verify_reservation !<br />\";\n\t\t\tdie();\n\t\t}\n\t}\n}\n// Cette fonction v\u00c3\u0110rifie une fois par jour si les r\u00c3\u0110servations devant \u00c3\u0160tre rendus ne sont pas\n// en retard\n// Si oui, les utilisateurs concern\u00c3\u0110es recoivent un mail automatique pour leur notifier.\nfunction verify_retard_reservation()\n{\n\tglobal $dformat;\n\t$day   = date(\"d\");\n\t$month = date(\"m\");\n\t$year  = date(\"Y\");\n\t$date_now = mktime(0, 0, 0, $month, $day, $year);\n\tif (((Settings::get(\"date_verify_reservation2\") == \"\") || (Settings::get(\"date_verify_reservation2\") < $date_now )) && (Settings::get(\"automatic_mail\") == 'yes'))\n\t{\n\t\t$res = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_room\");\n\t\tif (! $res)\n\t\t{\n\t\t\tinclude \"trailer.inc.php\";\n\t\t\texit;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t\t{\n\t\t\t\t$res2 = grr_sql_query(\"SELECT id from \".TABLE_PREFIX.\"_entry WHERE statut_entry='e' AND end_time < '\".$date_now.\"' AND room_id='\".$row[0].\"'\");\n\t\t\t\tif (!$res2)\n\t\t\t\t{\n\t\t\t\t\tinclude \"trailer.inc.php\";\n\t\t\t\t\texit;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tfor ($j = 0; ($row2 = grr_sql_row($res2, $j)); $j++)\n\t\t\t\t\t\t$_SESSION['session_message_error'] = send_mail($row2[0], 7, $dformat);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!Settings::set(\"date_verify_reservation2\", $date_now))\n\t\t{\n\t\t\techo \"Erreur lors de l'enregistrement de date_verify_reservation2 !<br />\";\n\t\t\tdie();\n\t\t}\n\t}\n}\n/*\n* @param integer $delai : nombre de jours de r\u00c3\u0110tention des logs de connexion\n* nettoieLogConnexion efface les entr\u00c3\u0110es de la table _log ant\u00c3\u0110rieures au jour courant moins le d\u00c3\u0110lai\n*/\nfunction nettoieLogConnexion($delai){\n    // est-ce un administrateur ?\n    if (authGetUserLevel(getUserName(), -1) >= 6){\n        $dateMax = new DateTime('NOW');\n        $dateMax->sub(new DateInterval('P'.$delai.'D'));\n        $dateMax = $dateMax->format('Y-m-d H:i:s');\n        $sql = \"DELETE FROM \".TABLE_PREFIX.\"_log WHERE START < '\" . $dateMax . \"';\";\n        grr_sql_query($sql);\n    }\n}\n/**\n * @param integer $time\n */\nfunction est_hors_reservation($time,$area=\"-1\")\n{\n\t// Premier test : s'agit-il d'un jour du calendrier \"hors r\u00c3\u0110servation\" ?\n\t$test = grr_sql_query1(\"SELECT DAY FROM \".TABLE_PREFIX.\"_calendar where DAY = '\".$time.\"'\");\n\tif ($test != -1)\n\t\treturn true;\n\t// 2\u00c3\u013bme test : s'agit-il d'une journ\u00c3\u0110e qui n'est pas affich\u00c3\u0110e pour le domaine consid\u00c3\u0110r\u00c3\u0110 ?\n\tif ($area!=-1)\n\t{\n\t\t$sql = \"SELECT display_days FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($area).\"'\";\n\t\t$result = grr_sql_query1($sql);\n\t\t$jour_semaine = date(\"w\",$time);\n\t\tif (substr($result,$jour_semaine,1) == 'n')\n\t\t\treturn true;\n\t}\n\treturn false;\n}\nfunction resa_est_hors_reservation($start_time,$end_time)\n{\n\t// On teste si la r\u00c3\u0110servation est dans le calendrier \"hors r\u00c3\u0110servations\"\n\t$test = grr_sql_query1(\"select DAY from \".TABLE_PREFIX.\"_calendar where DAY = '\".$start_time.\"' or DAY = '\".$end_time.\"'\");\n\tif ($test != -1)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\nfunction resa_est_hors_reservation2($start_time,$end_time,$area)\n{\n\t// S'agit-il d'une journ\u00c3\u0110e qui n'est pas affich\u00c3\u0110e pour le domaine consid\u00c3\u0110r\u00c3\u0110 ?\n\t$sql = \"SELECT display_days FROM \".TABLE_PREFIX.\"_area WHERE id = '\".protect_data_sql($area).\"'\";\n\t$result = grr_sql_query1($sql);\n\t$jour_semaine = date(\"w\",$start_time);\n\tif (substr($result, $jour_semaine, 1) == 'n')\n\t\treturn true;\n\t$jour_semaine = date(\"w\",$end_time);\n\tif (substr($result, $jour_semaine, 1) == 'n')\n\t\treturn true;\n\treturn false;\n}\n// trouve les utilisateurs gestionnaires de ressource\nfunction find_user_room ($id_room)\n{\n\t$emails = array ();\n\t$sql = \"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_user_room\n\twhere \".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_user_room.login and id_room='\".$id_room.\"'\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (validate_email($row[0]))\n\t\t\t\t$emails[] = $row[0];\n\t\t}\n\t}\n\t// Si la table des emails des gestionnaires de la ressource est vide, on avertit les administrateurs du domaine\n\tif (count($emails) == 0)\n\t{\n\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_area\n\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_area.login and \".TABLE_PREFIX.\"_j_useradmin_area.id_area='\".$id_area.\"'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs du domaines est vide, on avertit les administrateurs des sites\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\t\tif (count($emails) == 0)\n\t\t{\n\t\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t\t$id_site = mrbsGetAreaSite($id_area);\n\t\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_site\n\t\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_site.login and \".TABLE_PREFIX.\"_j_useradmin_site.id_site='\".$id_site.\"'\");\n\t\t\tif ($sql_admin)\n\t\t\t{\n\t\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t\t{\n\t\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t\t$emails[] = $row[0];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs des sites est vide, on avertit les administrateurs g\u00c3\u0110n\u00c3\u0110raux\n\tif (count($emails) == 0)\n\t{\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs where statut = 'administrateur'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\treturn $emails;\n}\n// trouve les utilisateurs actifs gestionnaires de ressource\nfunction find_active_user_room ($id_room)\n{\n\t$emails = array ();\n\t$sql = \"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_user_room\n\twhere \".TABLE_PREFIX.\"_utilisateurs.etat = 'actif' AND \n\t\".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_user_room.login and \n\tid_room='\".$id_room.\"'\";\n\t$res = grr_sql_query($sql);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\tif (validate_email($row[0]))\n\t\t\t\t$emails[] = $row[0];\n\t\t}\n\t}\n\t// Si la table des emails des gestionnaires de la ressource est vide, on avertit les administrateurs du domaine\n\tif (count($emails) == 0)\n\t{\n\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_area\n\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.etat = 'actif' AND\n\t\t\t\".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_area.login and \".TABLE_PREFIX.\"_j_useradmin_area.id_area='\".$id_area.\"'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs du domaines est vide, on avertit les administrateurs des sites\n\tif (Settings::get(\"module_multisite\") == \"Oui\")\n\t{\n\t\tif (count($emails) == 0)\n\t\t{\n\t\t\t$id_area = mrbsGetAreaIdFromRoomId($id_room);\n\t\t\t$id_site = mrbsGetAreaSite($id_area);\n\t\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs, \".TABLE_PREFIX.\"_j_useradmin_site\n\t\t\t\twhere \".TABLE_PREFIX.\"_utilisateurs.etat = 'actif' AND\n\t\t\t\t\".TABLE_PREFIX.\"_utilisateurs.login = \".TABLE_PREFIX.\"_j_useradmin_site.login and \".TABLE_PREFIX.\"_j_useradmin_site.id_site='\".$id_site.\"'\");\n\t\t\tif ($sql_admin)\n\t\t\t{\n\t\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t\t{\n\t\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t\t$emails[] = $row[0];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t// Si la table des emails des administrateurs des sites est vide, on avertit les administrateurs g\u00c3\u0110n\u00c3\u0110raux\n\tif (count($emails) == 0)\n\t{\n\t\t$sql_admin = grr_sql_query(\"select email from \".TABLE_PREFIX.\"_utilisateurs where etat = 'actif' AND statut = 'administrateur'\");\n\t\tif ($sql_admin)\n\t\t{\n\t\t\tfor ($i = 0; ($row = grr_sql_row($sql_admin, $i)); $i++)\n\t\t\t{\n\t\t\t\tif (validate_email($row[0]))\n\t\t\t\t\t$emails[] = $row[0];\n\t\t\t}\n\t\t}\n\t}\n\treturn $emails;\n}\n/** validate_email ($email)\n * D\u00c3\u0110termine si l'adresse mail en param\u00c3\u013btre est syntaxiquement valable\n * Rend un bool\u00c3\u0110en\n*/\nfunction validate_email ($email)\n{\n\t$atom   = '[-a-z0-9!#$%&\\'*+\\\\/=?^_`{|}~]';\n\t\t// caract\u00c3\u013bres autoris\u00c3\u0110s avant l'arobase\n\t$domain = '([a-z0-9]([-a-z0-9]*[a-z0-9]+)?)';\n\t\t// caract\u00c3\u013bres autoris\u00c3\u0110s apr\u00c3\u013bs l'arobase (nom de domaine)\n\t$regex = '/^' . $atom . '+' . '(\\.' . $atom . '+)*' . '@' . '(' . $domain . '{1,63}\\.)+' . $domain . '{2,63}$/i';\n\tif (preg_match($regex, $email))\n\t\treturn true;\n\telse {\n        $regex2 = '/^' . $atom . '+' . '(\\.' . $atom . '+)*' . '@' . 'localhost/i';\n        return preg_match($regex2, $email);\n    }\n}\n/** grrDelOverloadFromEntries()\n * Supprime les donn\u00c3\u0110es du champ $id_field de toutes les r\u00c3\u0110servations\n */\nfunction grrDelOverloadFromEntries($id_field)\n{\n\t$begin_string = \"<\".$id_field.\">\";\n\t$end_string = \"</\".$id_field.\">\";\n\t// On cherche \u00c3\u00a0 quel domaine est rattach\u00c3\u0110 le champ additionnel\n\t$id_area = grr_sql_query1(\"SELECT id_area FROM \".TABLE_PREFIX.\"_overload WHERE id='\".$id_field.\"'\");\n\tif ($id_area == -1)\n\t\tfatal_error(0, get_vocab('error_area') . $id_field . get_vocab('not_found'));\n\t// On cherche toutes les ressources du domaine\n\t$call_rooms = grr_sql_query(\"SELECT id FROM \".TABLE_PREFIX.\"_room WHERE area_id = '\".$id_area.\"'\");\n\tif (!$call_rooms)\n\t\tfatal_error(0, get_vocab('error_room') . $id_area . get_vocab('not_found'));\n\tfor ($i = 0; ($row = grr_sql_row($call_rooms, $i)); $i++)\n\t{\n\t\t// On cherche toutes les resas de cette resources\n\t\t$call_resa = grr_sql_query(\"SELECT id, overload_desc FROM \".TABLE_PREFIX.\"_entry WHERE room_id ='\".$row[0].\"'\");\n\t\tif (! $call_resa)\n\t\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t\tfor ($j = 0; ($row2 = grr_sql_row($call_resa, $j)); $j++)\n\t\t{\n\t\t\t$overload_desc = $row2[1];\n\t\t\t$begin_pos = strpos($overload_desc,$begin_string);\n\t\t\t$end_pos = strpos($overload_desc,$end_string);\n\t\t\tif ( $begin_pos !== false && $end_pos !== false )\n\t\t\t{\n\t\t\t\t$endpos = $end_pos + 1 + strlen($begin_string);\n\t\t\t\t$debut_new_chaine = substr($overload_desc,0,$begin_pos);\n\t\t\t\t$fin_new_chaine = substr($overload_desc,$endpos);\n\t\t\t\t$new_chaine = $debut_new_chaine.$fin_new_chaine;\n\t\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_entry SET overload_desc = '\".$new_chaine.\"' WHERE id = '\".$row2[0].\"'\");\n\t\t\t}\n\t\t}\n\t\t// On cherche toutes les resas de cette ressource\n\t\t$call_resa = grr_sql_query(\"SELECT id, overload_desc FROM \".TABLE_PREFIX.\"_repeat WHERE room_id ='\".$row[0].\"'\");\n\t\tif (!$call_resa)\n\t\t\tfatal_error(0, get_vocab('invalid_entry_id'));\n\t\tfor ($j = 0; ($row2 = grr_sql_row($call_resa, $j)); $j++)\n\t\t{\n\t\t\t$overload_desc = $row2[1];\n\t\t\t$begin_pos = strpos($overload_desc,$begin_string);\n\t\t\t$end_pos = strpos($overload_desc,$end_string);\n\t\t\tif ($begin_pos !== false && $end_pos !== false)\n\t\t\t{\n\t\t\t\t$endpos = $end_pos + 1 + strlen($begin_string);\n\t\t\t\t$debut_new_chaine = substr($overload_desc,0,$begin_pos);\n\t\t\t\t$fin_new_chaine = substr($overload_desc,$endpos);\n\t\t\t\t$new_chaine = $debut_new_chaine.$fin_new_chaine;\n\t\t\t\tgrr_sql_command(\"UPDATE \".TABLE_PREFIX.\"_repeat SET overload_desc = '\".$new_chaine.\"' WHERE id = '\".$row2[0].\"'\");\n\t\t\t}\n\t\t}\n\t}\n}\nfunction traite_grr_url($grr_script_name = \"\", $force_use_grr_url = \"n\")\n{\n\t// Dans certaines configuration (reverse proxy, ...) les variables $_SERVER[\"SCRIPT_NAME\"] ou $_SERVER['PHP_SELF']\n\t// sont mal interpr\u00c3\u0110t\u00c3\u0110es entra\u00c3\u016anant des liens erron\u00c3\u0110s sur certaines pages.\n\tif (((Settings::get(\"use_grr_url\") == \"y\") && (Settings::get(\"grr_url\") != \"\")) || ($force_use_grr_url == \"y\"))\n\t{\n\t\tif (substr(Settings::get(\"grr_url\"), -1) != \"/\")\n\t\t\t$ad_signe = \"/\";\n\t\telse\n\t\t\t$ad_signe = \"\";\n\t\treturn Settings::get(\"grr_url\").$ad_signe.$grr_script_name;\n\t}\n\telse\n\t\treturn $_SERVER['PHP_SELF'];\n}\n// Pour les Jours/Cycles\n//Cr\u00c3\u0110e le calendrier Jours/Cycles\nfunction cree_calendrier_date_valide($n, $i)\n{\n\tif ($i <= Settings::get(\"nombre_jours_Jours/Cycles\"))\n\t{\n\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_calendrier_jours_cycle SET DAY='\".$n.\"', Jours = $i\";\n\t\tif (grr_sql_command($sql) < 0)\n\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t$i++;\n\t}\n\telse\n\t{\n\t\t$i = 1;\n\t\t$sql = \"INSERT INTO \".TABLE_PREFIX.\"_calendrier_jours_cycle set DAY='\".$n.\"', Jours = $i\";\n\t\tif (grr_sql_command($sql) < 0)\n\t\t\tfatal_error(1, \"<p>\" . grr_sql_error());\n\t\t$i++;\n\t}\n\treturn $i;\n}\n/*\nConstruit les informations \u00c3\u00a0 afficher sur les plannings\n*/\nfunction affichage_lien_resa_planning($breve_description, $id_resa)\n{\n\tif ((Settings::get(\"display_short_description\") == 1) && ($breve_description != \"\"))\n\t\t$affichage = $breve_description;\n\telse\n\t\t$affichage = get_vocab(\"entryid\").$id_resa;\n\treturn bbCode(htmlspecialchars($affichage,ENT_NOQUOTES),'titre');\n}\n/*\nConstruit les informations \u00c3\u00a0 afficher sur les plannings\n*/\nfunction affichage_resa_planning($_description, $id_resa)\n{\n\t$affichage = \"\";\n\tif (Settings::get(\"display_full_description\") == 1)\n\t\t$affichage = htmlspecialchars($_description,ENT_NOQUOTES);\n    // la ressource associ\u00c3\u0110e \u00c3\u00a0 la r\u00c3\u0110servation :\n    $res = mrbsGetEntryInfo($id_resa);\n    $room = (!$res) ? -1 : $res[\"room_id\"]; \n\t// Les champs add :\n\t$overload_data = mrbsEntryGetOverloadDesc($id_resa);\n\tforeach ($overload_data as $fieldname=>$field)\n\t{\n\t\tif (((authGetUserLevel(getUserName(), $room) >= 4) ||($field[\"affichage\"] == 'y')) and ($field[\"valeur\"]!=\"\"))\n\t\t{\n\t\t\tif ($affichage != \"\")\n\t\t\t\t$affichage .= \"<br />\";\n\t\t\t$affichage .= htmlspecialchars($fieldname,ENT_NOQUOTES).get_vocab(\"deux_points\").htmlspecialchars($field[\"valeur\"],ENT_NOQUOTES|ENT_SUBSTITUTE);\n\t\t}\n\t}\n\treturn $affichage;\n}\n/*\nConstruit les informations \u00c3\u00a0 afficher sur les plannings\n*/\nfunction affichage_champ_add_mails($id_resa)\n{\n\t$affichage = \"\";\n\t// Les champs add :\n\t$overload_data = mrbsEntryGetOverloadDesc($id_resa);\n\tforeach ($overload_data as $fieldname=>$field)\n\t{\n\t\tif (($field[\"overload_mail\"] == 'y') && ($field[\"valeur\"] != \"\"))\n\t\t\t$affichage .= bbcode(htmlspecialchars($fieldname).get_vocab(\"deux_points\").htmlspecialchars($field[\"valeur\"]),'nobbcode').\"\\n\";;\n\t}\n\treturn $affichage;\n}\n/*\nAffiche un message pop-up\n$type_affichage = \"user\" -> Affichage des \"pop-up\" de confirmation apr\u00c3\u013bs la cr\u00c3\u0110ation/modification/suppression d'une r\u00c3\u0110servation\nDans ce cas, l'affichage n'a lieu que si $_SESSION['displ_msg']='yes'\n$type_affichage = \"admin\" -> Affichage des \"pop-up\" de confirmation dans les menus d'administration\n$type_affichage = \"force\" -> On force l'affichage du pop-up m\u00c3\u0160me si javascript_info_admin_disabled est true\n*/\nfunction affiche_pop_up($msg = \"\",$type_affichage = \"user\")\n{\n\t// Si $_SESSION[\"msg_a_afficher\"] est d\u00c3\u0110fini, on l'affiche, sinon, on affiche $msg pass\u00c3\u0110 en variable\n\tif ((isset($_SESSION[\"msg_a_afficher\"])) and ($_SESSION[\"msg_a_afficher\"] != \"\"))\n\t\t$msg = $_SESSION[\"msg_a_afficher\"];\n\tif ($msg != \"\")\n\t{\n\t\tif ($type_affichage == \"user\")\n\t\t{\n\t\t\tif (!(Settings::get(\"javascript_info_disabled\")))\n\t\t\t{\n\t\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\t\tif ((isset($_SESSION['displ_msg'])) && ($_SESSION['displ_msg'] == 'yes'))\n\t\t\t\t\techo \" alert(\\\"\".$msg.\"\\\")\";\n\t\t\t\techo \"</script>\";\n\t\t\t}\n\t\t}\n\t\telse if ($type_affichage == \"admin\")\n\t\t{\n\t\t\tif (!(Settings::get(\"javascript_info_admin_disabled\")))\n\t\t\t{\n\t\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\t\techo \"<!--\\n\";\n\t\t\t\techo \" alert(\\\"\".$msg.\"\\\")\";\n\t\t\t\techo \"//-->\";\n\t\t\t\techo \"</script>\";\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\techo \"<script type=\\\"text/javascript\\\">\";\n\t\t\techo \"<!--\\n\";\n\t\t\techo \" alert(\\\"\".$msg.\"\\\")\";\n\t\t\techo \"//-->\";\n\t\t\techo \"</script>\";\n\t\t}\n\t}\n\t$_SESSION['displ_msg'] = \"\";\n\t$_SESSION[\"msg_a_afficher\"] = \"\";\n}\n/*\nRetourne un tableau contenant les nom et pr\u00c3\u0110nom et l'email de $_beneficiaire\n*/\nfunction donne_nom_email($_beneficiaire)\n{\n\t$tab_benef = array();\n\t$tab_benef[\"nom\"] = \"\";\n\t$tab_benef[\"email\"] = \"\";\n\tif ($_beneficiaire == \"\")\n\t\treturn $tab_benef;\n\t$temp = explode(\"|\",$_beneficiaire);\n\tif (isset($temp[0]))\n\t\t$tab_benef[\"nom\"] = $temp[0];\n\tif (isset($temp[1]))\n\t\t$tab_benef[\"email\"] = $temp[1];\n\treturn $tab_benef;\n}\n/*\nRetourne une chaine concat\u00c3\u0110n\u00c3\u0110e des nom et pr\u00c3\u0110nom et l'email\n*/\nfunction concat_nom_email($_nom, $_email)\n{\n\t// On supprime les caract\u00c3\u013bres | de $_nom\n\t$_nom = trim(str_replace(\"|\",\"\",$_nom));\n\tif ($_nom == \"\")\n\t\treturn \"-1\";\n\t$_email = trim($_email);\n\tif ($_email != \"\")\n\t{\n\t\tif (strstr($_email,\"|\"))\n\t\t\treturn \"-2\";\n\t}\n\t$chaine = $_nom.\"|\".$_email;\n\treturn $chaine;\n}\n/*\nFormate les noms, pr\u00c3\u0110nom et email du b\u00c3\u0110n\u00c3\u0110ficiaire ou du b\u00c3\u0110n\u00c3\u0110ficiaire ext\u00c3\u0110rieur\n$type = nomail -> on affiche les pr\u00c3\u0110nom et nom sans le mail.\n$type = withmail -> on affiche un lien avec le mail sur les pr\u00c3\u0110nom et nom.\n$type = formail -> on formate en utf8 pour l'envoi par mail (utilis\u00c3\u0110 dans l'envoi de mails automatiques)\n$type = onlymail -> on affiche uniquement le mail (utilis\u00c3\u0110 dans l'envoi de mails automatiques)\n*/\n/**\n * @return string\n */\nfunction affiche_nom_prenom_email($_beneficiaire, $_beneficiaire_ext, $type = \"nomail\")\n{\n\tif ($_beneficiaire != \"\")\n\t{\n\t\t$sql_beneficiaire = \"SELECT prenom, nom, email FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login = '\".$_beneficiaire.\"'\";\n\t\t$res_beneficiaire = grr_sql_query($sql_beneficiaire);\n\t\tif ($res_beneficiaire)\n\t\t{\n\t\t\t$nb_result = grr_sql_count($res_beneficiaire);\n\t\t\tif ($nb_result == 0){\n\t\t\t\t$chaine = get_vocab(\"utilisateur_inconnu\").$_beneficiaire;\n\t\t\t} else\n\t\t\t{\n\t\t\t\t$row_user = grr_sql_row($res_beneficiaire, 0);\n\t\t\t\tif ($type == \"formail\")\n\t\t\t\t{\n\t\t\t\t\t$chaine = removeMailUnicode($row_user[0]).\" \".removeMailUnicode($row_user[1]);\n\t\t\t\t\tif ($row_user[2] != \"\")\n\t\t\t\t\t\t$chaine .= \" (\".$row_user[2].\")\";\n\t\t\t\t}\n\t\t\t\telse if ($type == \"onlymail\")\n\t\t\t\t{\n\t\t\t\t\t// Cas o\u00c3\u0111 en envoie uniquement le mail\n\t\t\t\t\t$chaine = grr_sql_query1(\"select email from \".TABLE_PREFIX.\"_utilisateurs where login='$_beneficiaire'\");\n\t\t\t\t}\n\t\t\t\telse if (($type == \"withmail\") and ($row_user[2] != \"\"))\n\t\t\t\t{\n\t\t\t\t\t// Cas o\u00c3\u0111 en envoie les noms, pr\u00c3\u0110noms et mail\n\t\t\t\t\t$chaine = affiche_lien_contact($_beneficiaire,\"identifiant:oui\",\"afficher_toujours\");\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// Cas o\u00c3\u0111 en envoie les noms, pr\u00c3\u0110noms sans le mail\n\t\t\t\t\t$chaine = $row_user[0].\" \".$row_user[1];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn $chaine;\n\t\t}\n\t\telse\n\t\t\treturn \"\";\n\t}\n\telse\n\t{\n\t\t// cas d'un b\u00c3\u0110n\u00c3\u0110ficiaire ext\u00c3\u0110rieur\n\t\t// On r\u00c3\u0110cup\u00c3\u013bre le tableau des nom et emails\n\t\t$tab_benef = donne_nom_email($_beneficiaire_ext);\n\t\t// Cas o\u00c3\u0111 en envoie uniquement le mail\n\t\tif ($type == \"onlymail\")\n\t\t{\n\t\t\t$chaine = $tab_benef[\"email\"];\n\t\t\t// Cas o\u00c3\u0111 en envoie les noms, pr\u00c3\u0110noms et mail\n\t\t}\n\t\telse if (($type == \"withmail\") && ($tab_benef[\"email\"] != \"\"))\n\t\t{\n\t\t\t$email = explode('@',$tab_benef[\"email\"]);\n\t\t\t$person = $email[0];\n\t\t\tif (isset($email[1]))\n\t\t\t{\n\t\t\t\t$domain = $email[1];\n\t\t\t\t$chaine = \"<script type=\\\"text/javascript\\\">encode_adresse('\".$person.\"','\".$domain.\"','\".AddSlashes($tab_benef[\"nom\"]).\"',1);</script>\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$chaine = $tab_benef[\"nom\"];\n\t\t}\n\t\telse\n\t\t{\n\t\t// Cas o\u00c3\u0111 en envoie les noms, pr\u00c3\u0110noms sans le mail\n\t\t\t$chaine = $tab_benef[\"nom\"];\n\t\t}\n\t\treturn $chaine;\n\t}\n}\n/*\n Fonction permettant d'effectuer une correspondance entre\n le profil lu sous LDAP et les statuts existants dans GRR\n*/\n function effectuer_correspondance_profil_statut($codefonction, $libellefonction) {\n\t\t# On r\u00c3\u0110cup\u00c3\u013bre le statut par d\u00c3\u0110faut des utilisateurs CAS\n \t$sso = Settings::get(\"sso_statut\");\n \tif ($sso == \"cas_visiteur\")\n \t\t$_statut = \"visiteur\";\n \telse if ($sso == \"cas_utilisateur\")\n \t\t$_statut = \"utilisateur\";\n\t\t# Le code fonction est d\u00c3\u0110fini\n \tif ($codefonction != \"\")\n \t{\n \t\t$sql = grr_sql_query1(\"SELECT statut_grr from \".TABLE_PREFIX.\"_correspondance_statut where code_fonction='\".$codefonction.\"'\");\n \t\tif ($sql != -1)\n \t\t{\n\t\t\t// Si la fonction existe dans la table de correspondance, on retourne le statut_grr associ\u00c3\u0110\n \t\t\treturn $sql;\n \t\t}\n \t\telse\n \t\t{\n\t\t\t// Le code n'existe pas dans la base, alors on l'ins\u00c3\u013bre en lui attribuant le statut par d\u00c3\u0110faut.\n \t\t\t$libellefonction = protect_data_sql($libellefonction);\n \t\t\tgrr_sql_command(\"INSERT INTO grr_correspondance_statut(code_fonction,libelle_fonction,statut_grr) VALUES ('$codefonction', '$libellefonction', '$_statut')\");\n \t\t\treturn $_statut;\n \t\t}\n\t\t//Le code fonction n'est pas d\u00c3\u0110fini, alors on retourne le statut par d\u00c3\u0110faut.\n \t}\n \telse\n \t\treturn $_statut;\n }\n\n\tfunction jQuery_DatePicker($typeDate){\n\n\t\tif (@file_exists('../include/connect.inc.php')){\n\t\t\t$racine = \"../\";\n\t\t} else{\n\t\t\t$racine = \"./\";\n\t\t}\n\n\t\tif ($typeDate == 'rep_end' && isset($_GET['id'])){\n\t\t\t$res = grr_sql_query(\"SELECT repeat_id FROM \".TABLE_PREFIX.\"_entry WHERE id=\".$_GET['id'].\";\");\n\t\t\tif (!$res){\n\t\t\t\tfatal_error(0, grr_sql_error());\n\t\t\t}\n\t\t\t$repeat_id = implode('', grr_sql_row($res, 0));\n\t\t\t$res = grr_sql_query(\"SELECT rep_type, end_date, rep_opt, rep_num_weeks, start_time, end_time FROM \".TABLE_PREFIX.\"_repeat WHERE id=$repeat_id\");\n\t\t\tif (!$res){\n\t\t\t\tfatal_error(0, grr_sql_error());\n\t\t\t}\n\t\t\tif (grr_sql_count($res) == 1){\n\t\t\t\t$row6 = grr_sql_row($res, 0);\n\t\t\t\t$date = date_parse(date(\"Y-m-d H:i:s\",$row6[1]));\n\t\t\t\t$day = $date['day'];\n\t\t\t\t$month = $date['month'];\n\t\t\t\t$year = $date['year'];\n\t\t\t} else{\n\t\t\t\tif (isset ($_GET['day']))\n\t\t\t\t\t$day = $_GET['day'];\n\t\t\t\telse\n\t\t\t\t\t$day = date(\"d\");\n\t\t\t\tif (isset ($_GET['month']))\n\t\t\t\t\t$month = $_GET['month'];\n\t\t\t\telse\n\t\t\t\t\t$month = date(\"m\");\n\t\t\t\tif (isset ($_GET['year']))\n\t\t\t\t\t$year = $_GET['year'];\n\t\t\t\telse\n\t\t\t\t\t$year = date(\"Y\");\n\t\t\t}\n\t\t} else{\n\t\t\tglobal $start_day, $start_month, $start_year, $end_day, $end_month, $end_year;\n\n\t\t\tif (isset ($_GET['day'])){\n\t\t\t\t$day = $_GET['day'];\n\t\t\t} else{\n\t\t\t\t$day = date(\"d\");\n\t\t\t}\n\n\t\t\tif (isset($start_day) && $typeDate=='start'){\n\t\t\t\t$day = $start_day;\n\t\t\t} elseif (isset($end_day) && $typeDate=='end'){\n\t\t\t\t$day = $end_day;\n\t\t\t}\n\n\t\t\tif (isset ($_GET['month'])){\n\t\t\t\t$month = $_GET['month'];\n\t\t\t} else{\n\t\t\t\t$month = date(\"m\");\n\t\t\t}\n\n\t\t\tif (isset($start_month) && $typeDate=='start'){\n\t\t\t\t$month = $start_month;\n\t\t\t} elseif (isset($end_month) && $typeDate=='end'){\n\t\t\t\t$month = $end_month;\n\t\t\t}\n\n\t\t\tif(isset ($_GET['year'])){\n\t\t\t\t$year = $_GET['year'];\n\t\t\t} else{\n\t\t\t\t$year = date(\"Y\");\n\t\t\t}\n\n\t\t\tif (isset($start_year) && $typeDate=='start'){\n\t\t\t\t$year = $start_year;\n\t\t\t} elseif (isset($end_year) && $typeDate=='end'){\n\t\t\t\t$year = $end_year;\n\t\t\t}\n \t}\n \tgenDateSelector(\"\".$typeDate.\"_\", \"$day\", \"$month\", \"$year\",\"\");\n \techo '<input type=\"hidden\" disabled=\"disabled\" id=\"mydate_' .$typeDate. '\">'.PHP_EOL;\n \techo '<script>'.PHP_EOL;\n \techo '\t$(function() {'.PHP_EOL;\n \t\techo '$.datepicker.setDefaults( $.datepicker.regional[\\'fr\\'] );'.PHP_EOL;\n \t\techo '\t$(\\'#mydate_' .$typeDate. '\\').datepicker({'.PHP_EOL;\n \t\t\techo '\t\tbeforeShow: readSelected, onSelect: updateSelected,'.PHP_EOL;\n \t\t\techo '\t\tshowOn: \\'both\\', buttonImageOnly: true, buttonImage: \\'img_grr/calendar.png\\',buttonText: \"Choisir la date\"});'.PHP_EOL;\necho '\t\tfunction readSelected()'.PHP_EOL;\necho '\t\t{'.PHP_EOL;\necho '\t\t\t$(\\'#mydate_' .$typeDate. '\\').val($(\\'#' .$typeDate. '_day\\').val() + \\'/\\' +'.PHP_EOL;\n\techo '\t\t\t$(\\'#' .$typeDate. '_month\\').val() + \\'/\\' + $(\\'#' .$typeDate. '_year\\').val());'.PHP_EOL;\necho '\t\t\treturn {};'.PHP_EOL;\necho '\t\t}'.PHP_EOL;\necho '\t\tfunction updateSelected(date)'.PHP_EOL;\necho '\t\t{'.PHP_EOL;\necho '\t\t\t$(\\'#' .$typeDate. '_day\\').val(date.substring(0, 2));'.PHP_EOL;\necho '\t\t\t$(\\'#' .$typeDate. '_month\\').val(date.substring(3, 5));'.PHP_EOL;\necho '\t\t\t$(\\'#' .$typeDate. '_year\\').val(date.substring(6, 10));'.PHP_EOL;\necho '\t\t}'.PHP_EOL;\necho '\t});'.PHP_EOL;\necho '</script>'.PHP_EOL;\n}\n\nfunction jQuery_TimePicker($typeTime, $start_hour, $start_min,$dureepardefaultsec)\n{\n\tif (isset ($_GET['id']))\n\t{\n\t\tif (isset($start_hour) && isset($start_min))\n\t\t{\n\t\t\t$hour = $start_hour;\n\t\t\t$minute = $start_min;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$hour = date(\"h\");\n\t\t\t$minute = date(\"m\");\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (isset ($_GET['hour']))\n\t\t\t$hour = $_GET['hour'];\n\t\telse\n\t\t\t$hour = date(\"h\");\n\t\tif (isset ($_GET['minute']))\n\t\t\t$minute = $_GET['minute'];\n\t\telse\n\t\t\t$minute = date(\"m\");\n\t\t\t\n\t\tif ($typeTime == 'end_'){\n\t\t$dureepardefautmin = $dureepardefaultsec/60;\n\t\tif ($dureepardefautmin == 60){\n\t\t\t$ajout = 1;\n\t\t\t$hour = $_GET['hour'] + $ajout;\n\t\t\t$minute =\"00\";\n\t\t}\n\t\tif ($dureepardefautmin < 60){\n\t\t\t$hour = $_GET['hour'];\n\t\t\t$minute =$dureepardefautmin;\n\t\t}\n\t\tif ($dureepardefautmin > 60){\n            $dureepardefautheure = $dureepardefautmin/60;\n        //\tif (($dureepardefautheure % 60)!=0){\n\t//\t\t$hour = $_GET['hour']+ $dureepardefautheure;\n            $hour = ($_GET['hour']+ $dureepardefautheure)%24; // Modulo 24\n            $hour = str_pad($hour, 2, 0, STR_PAD_LEFT); // Affichage heure sur 2 digits \n\t\t\tif ($_GET['minute'] == 30){\n\t\t\t\t$minute =30;\n\t\t\t}else{\n\t\t\t\t $minute = \"00\";\n\t\t\t\t};\n\t//\t\t}\n\t\t}\n\t};\n\n\t}\n\tif ($minute == 0)\n\t\t$minute = '00';\n\t// MAJ\n\techo '<div class=\"input-group clockpicker\">\n\t<input name=\"' .$typeTime. '\" type=\"text\" class=\"form-control\" value=\"' .$hour. ':' .$minute. '\">\n\t<span class=\"input-group-addon\">\n\t\t<span class=\"glyphicon glyphicon-time\"></span>\n\t</span>\n</div>';\necho '<script type=\"text/javascript\">\n$(\\'.clockpicker\\').clockpicker({\n\talign: \\'left\\',\n\tplacement: \\'top\\',\n\tdonetext: \\'Valider\\'\n});\n</script>';\n}\nfunction jQuery_TimePicker2($typeTime, $start_hour, $start_min,$dureepardefaultsec)\n{\n\tif (isset ($_GET['id']))\n\t{\n\t\tif (isset($start_hour) && isset($start_min))\n\t\t{\n\t\t\t$hour = $start_hour;\n\t\t\t$minute = $start_min;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$hour = date(\"h\");\n\t\t\t$minute = date(\"m\");\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (isset ($_GET['hour']))\n\t\t\t$hour = $_GET['hour'];\n\t\telse\n\t\t\t$hour = date(\"h\");\n\t\tif (isset ($_GET['minute']))\n\t\t\t$minute = $_GET['minute'];\n\t\telse\n\t\t\t$minute = date(\"m\");\n\t\t\t\n\t\tif ($typeTime == 'end_')\n        {\n            $dureepardefautmin = $dureepardefaultsec/60;\n            if ($dureepardefautmin == 60){\n                $ajout = 1;\n                $hour = $_GET['hour'] + $ajout;\n                $minute =\"00\";\n            }\n            if ($dureepardefautmin < 60){\n                $hour = $_GET['hour'];\n                $minute =$dureepardefautmin;\n            }\n            if ($dureepardefautmin > 60)\n            {\n                $dureepardefautheure = $dureepardefautmin/60;\n                if (($dureepardefautheure % 60)!=0)\n                {\n                    $hour = $_GET['hour']+ $dureepardefautheure;\n                    if ($_GET['minute'] == 30){$minute =30;}\n                    else{$minute = \"00\";}\n                }\n            }\n        }\n\t}\n\tif ($minute == 0)\n\t\t$minute = '00';\n\t// MAJ\n\techo '<div class=\"input-group\">\n\t<input id=\"'.$typeTime.'\" name=\"' .$typeTime. '\" type=\"text\" class=\"time\" >\n\t</div>';\n    echo '<script type=\"text/javascript\">\n        $(\\'#'.$typeTime.'\\').timepicker({\n            \\'step\\': '.($dureepardefaultsec/60).',\n            \\'scrollDefault\\': \\''.$hour.':'.$minute.'\\',\n            \\'timeFormat\\': \"H:i\",\n            \\'forceRoundTime\\': true,\n        });\n        </script>';\n}\n\nfunction spinner ($duration)\n{\n\techo \"<input class=\\\"form-control\\\" name=\\\"duration\\\" value=\\\"\" .$duration. \"\\\" id=\\\"spinner\\\" />\";\n\techo \"<script type=\\\"text/javascript\\\" src=\\\"js/jquery.mousewheel.js\\\"></script>\";\n\techo \"<script>$(function() {\n\t\t$('#spinner').spinner({\n\t\t\tmin: 1,\n\t\t\tpage: 10,\n\t\t});});\n</script>\";\n}\n/** supprimerReservationsUtilisateursEXT()\n *\n * Supprime les r\u00c3\u0110servations des membres qui proviennent d'une source \"EXT\"\n *\n *\n * Returns:\n *   0        - An error occured\n *   non-zero - The entries were deleted\n */\nfunction supprimerReservationsUtilisateursEXT($avec_resa,$avec_privileges)\n{\n\t// R\u00c3\u0110cup\u00c3\u0110ration de tous les utilisateurs de la source EXT\n\t$requete_users_ext = \"SELECT login FROM \".TABLE_PREFIX.\"_utilisateurs WHERE source='ext' and statut<>'administrateur'\";\n\t$res = grr_sql_query($requete_users_ext);\n\t$logins = array();\n\t$logins_liaison  = array();\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$logins[]=$row[0];\n\t\t}\n\t}\n\t// Construction des requ\u00c3\u0160tes de suppression \u00c3\u00a0 partir des diff\u00c3\u0110rents utilisateurs \u00c3\u00a0 supprimer\n\tif ($avec_resa == 'y')\n\t{\n\t\t// Pour chaque utilisateur, on supprime les r\u00c3\u0110servations qu'il a cr\u00c3\u0110\u00c3\u0110es et celles dont il est b\u00c3\u0110n\u00c3\u0110ficiaire\n\t\t// Table grr_entry\n\t\t$req_suppr_table_entry = \"DELETE FROM \".TABLE_PREFIX.\"_entry WHERE create_by = \";\n\t\t$first = 1;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif ($first == 1)\n\t\t\t{\n\t\t\t\t$req_suppr_table_entry .= \"'$log' OR beneficiaire='$log'\";\n\t\t\t\t$first = 0;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$req_suppr_table_entry .= \" OR create_by = '$log' OR beneficiaire = '$log' \";\n\t\t}\n\t\t// Pour chaque utilisateur, on supprime les r\u00c3\u0110servations p\u00c3\u0110riodiques qu'il a cr\u00c3\u0110\u00c3\u0110es et celles dont il est b\u00c3\u0110n\u00c3\u0110ficiaire\n\t\t// Table grr_repeat\n\t\t$req_suppr_table_repeat = \"DELETE FROM \".TABLE_PREFIX.\"_repeat WHERE create_by = \";\n\t\t$first = 1;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif ($first == 1)\n\t\t\t{\n\t\t\t\t$req_suppr_table_repeat .= \"'$log' OR beneficiaire='$log'\";\n\t\t\t\t$first = 0;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$req_suppr_table_repeat .= \" OR create_by = '$log' OR beneficiaire = '$log' \";\n\t\t}\n\t\t// Pour chaque utilisateur, on supprime les r\u00c3\u0110servations p\u00c3\u0110riodiques qu'il a cr\u00c3\u0110\u00c3\u0110es et celles dont il est b\u00c3\u0110n\u00c3\u0110ficiaire\n\t\t// Table grr_entry_moderate\n\t\t$req_suppr_table_entry_moderate = \"DELETE FROM \".TABLE_PREFIX.\"_entry_moderate WHERE create_by = \";\n\t\t$first = 1;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif ($first == 1)\n\t\t\t{\n\t\t\t\t$req_suppr_table_entry_moderate .= \"'$log' OR beneficiaire='$log'\";\n\t\t\t\t$first = 0;\n\t\t\t}\n\t\t\telse\n\t\t\t\t$req_suppr_table_entry_moderate .= \" OR create_by = '$log' OR beneficiaire = '$log' \";\n\t\t}\n\t}\n\t$req_j_mailuser_room = \"\";\n\t$req_j_user_area = \"\";\n\t$req_j_user_room = \"\";\n\t$req_j_useradmin_area = \"\";\n\t$req_j_useradmin_site = \"\";\n\tforeach ($logins as $log)\n\t{\n\t\t// Table grr_j_mailuser_room\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_mailuser_room WHERE login='\".$log.\"'\");\n\t\tif ($test >=1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_mailuser_room == \"\")\n\t\t\t\t\t$req_j_mailuser_room = \"DELETE FROM \".TABLE_PREFIX.\"_j_mailuser_room WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_mailuser_room .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_user_area\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_user_area WHERE login='\".$log.\"'\");\n\t\tif ($test >=1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_user_area == \"\")\n\t\t\t\t\t$req_j_user_area = \"DELETE FROM \".TABLE_PREFIX.\"_j_user_area WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_user_area .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_user_room\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_user_room WHERE login='\".$log.\"'\");\n\t\tif ($test >= 1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_user_room == \"\")\n\t\t\t\t\t$req_j_user_room = \"DELETE FROM \".TABLE_PREFIX.\"_j_user_room WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_user_room .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_useradmin_area\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_useradmin_area WHERE login='\".$log.\"'\");\n\t\tif ($test >= 1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_useradmin_area == \"\")\n\t\t\t\t\t$req_j_useradmin_area = \"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_area WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_useradmin_area .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t\t// Table grr_j_useradmin_site\n\t\t$test = grr_sql_query1(\"SELECT count(login) FROM \".TABLE_PREFIX.\"_j_useradmin_site WHERE login='\".$log.\"'\");\n\t\tif ($test >= 1)\n\t\t{\n\t\t\tif ($avec_privileges == \"y\")\n\t\t\t{\n\t\t\t\tif ($req_j_useradmin_site == \"\")\n\t\t\t\t\t$req_j_useradmin_site = \"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_site WHERE login='\".$log.\"'\";\n\t\t\t\telse\n\t\t\t\t\t$req_j_useradmin_site .= \" OR login = '\".$log.\"'\";\n\t\t\t}\n\t\t\telse\n\t\t\t\t$logins_liaison[] = strtolower($log);\n\t\t}\n\t}\n\t\t// Suppression effective\n\techo \"<hr />\\n\";\n\tif ($avec_resa == 'y')\n\t{\n\t\t$nb = 0;\n\t\t$s = grr_sql_command($req_suppr_table_entry);\n\t\tif ($s != -1)\n\t\t\t$nb += $s;\n\t\t$s = grr_sql_command($req_suppr_table_repeat);\n\t\tif ($s != -1)\n\t\t\t$nb += $s;\n\t\t$s = grr_sql_command($req_suppr_table_entry_moderate);\n\t\tif ($s != -1)\n\t\t\t$nb += $s;\n\t\techo \"<p class='avertissement'>\".get_vocab(\"tables_reservations\").get_vocab(\"deux_points\").$nb.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\t}\n\t$nb = 0;\n\tif ($avec_privileges == \"y\")\n\t{\n\t\tif ($req_j_mailuser_room != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_mailuser_room);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_user_area != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_user_area);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_user_room != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_user_room);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_useradmin_area != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_useradmin_area);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t\tif ($req_j_useradmin_site != \"\")\n\t\t{\n\t\t\t$s = grr_sql_command($req_j_useradmin_site);\n\t\t\tif ($s != -1)\n\t\t\t\t$nb += $s;\n\t\t}\n\t}\n\techo \"<p class='avertissement'>\".get_vocab(\"tables_liaison\").get_vocab(\"deux_points\").$nb.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\tif ($avec_privileges == \"y\")\n\t{\n\t\t// Enfin, suppression des utilisateurs de la source EXT qui ne sont pas administrateur\n\t\t$requete_suppr_users_ext = \"DELETE FROM \".TABLE_PREFIX.\"_utilisateurs WHERE source='ext' and statut<>'administrateur'\";\n\t\t$s = grr_sql_command($requete_suppr_users_ext);\n\t\tif ($s == -1)\n\t\t\t$s = 0;\n\t\techo \"<p class='avertissement'>\".get_vocab(\"table_utilisateurs\").get_vocab(\"deux_points\").$s.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\t}\n\telse\n\t{\n\t\t$n = 0;\n\t\tforeach ($logins as $log)\n\t\t{\n\t\t\tif (!in_array(strtolower($log), $logins_liaison))\n\t\t\t{\n\t\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_utilisateurs WHERE login='\".$log.\"'\");\n\t\t\t\t$n++;\n\t\t\t}\n\t\t}\n\t\techo \"<p class='avertissement'>\".get_vocab(\"table_utilisateurs\").get_vocab(\"deux_points\").$n.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n\t}\n}\n/** NettoyerTablesJointure()\n *\n * Supprime les lignes inutiles dans les tables de liaison\n *\n */\nfunction NettoyerTablesJointure()\n{\n\t$nb = 0;\n\t// Table grr_j_mailuser_room\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_mailuser_room j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"delete from \".TABLE_PREFIX.\"_j_mailuser_room where login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_user_area\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_user_area j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"delete from \".TABLE_PREFIX.\"_j_user_area where login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_user_room\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_user_room j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_j_user_room WHERE login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_useradmin_area\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_useradmin_area j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_area WHERE login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Table grr_j_useradmin_site\n\t$req = \"SELECT j.login FROM \".TABLE_PREFIX.\"_j_useradmin_site j\n\tLEFT JOIN \".TABLE_PREFIX.\"_utilisateurs u on u.login=j.login\n\tWHERE (u.login  IS NULL)\";\n\t$res = grr_sql_query($req);\n\tif ($res)\n\t{\n\t\tfor ($i = 0; ($row = grr_sql_row($res, $i)); $i++)\n\t\t{\n\t\t\t$nb++;\n\t\t\tgrr_sql_command(\"DELETE FROM \".TABLE_PREFIX.\"_j_useradmin_site WHERE login='\".$row[0].\"'\");\n\t\t}\n\t}\n\t// Suppression effective\n\techo \"<hr />\\n\";\n\techo \"<p class='avertissement'>\".get_vocab(\"tables_liaison\").get_vocab(\"deux_points\").$nb.get_vocab(\"entres_supprimees\").\"</p>\\n\";\n}\nif (!function_exists('htmlspecialchars_decode'))\n{\n\tfunction htmlspecialchars_decode($text)\n\t{\n\t\treturn strtr($text, array_flip(get_html_translation_table(HTML_SPECIALCHARS)));\n\t}\n}\n// suggestions pour reformuler les pages plannings\nfunction pageHead2($title, $page = \"with_session\") \n{\n\tif ($page == \"with_session\")\n\t{\n\t\tif (isset($_SESSION['default_style']))\n\t\t\t$sheetcss = 'themes/'.$_SESSION['default_style'].'/css';\n\n\t\telse {\n            if (Settings::get(\"default_css\"))\n\t\t\t$sheetcss = 'themes/'.Settings::get(\"default_css\").'/css'; // th\u00c3\u013bme global par d\u00c3\u0110faut\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css'; // utilise le th\u00c3\u013bme par d\u00c3\u0110faut s'il n'a pas \u00c3\u0110t\u00c3\u0110 d\u00c3\u0110fini\n        }\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\telse\n\t{\n\t\tif (Settings::get(\"default_css\"))\n\t\t\t$sheetcss = 'themes/'.Settings::get(\"default_css\").'/css';\n\t\telse\n\t\t\t$sheetcss = 'themes/default/css';\n\t\tif (isset($_GET['default_language']))\n\t\t{\n\t\t\t$_SESSION['default_language'] = $_GET['default_language'];\n\t\t\tif (isset($_SESSION['chemin_retour']) && ($_SESSION['chemin_retour'] != ''))\n\t\t\t\theader(\"Location: \".$_SESSION['chemin_retour']);\n\t\t\telse\n\t\t\t\theader(\"Location: \".traite_grr_url());\n\t\t\tdie();\n\t\t}\n\t}\n\tglobal $vocab, $charset_html, $unicode_encoding, $clock_file, $use_select2, $use_admin;\n\theader('Content-Type: text/html; charset=utf-8');\n\tif (!isset($_COOKIE['open']))\n\t{\n\t\tsetcookie(\"open\", \"true\", time()+3600);\n\t}\n    // code de la partie <head> \n\t$a  = '<head>'.PHP_EOL;\n\t$a .= '<meta charset=\"utf-8\">'.PHP_EOL;\n\t$a .= '<meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">'.PHP_EOL;\n\t$a .= '<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">'.PHP_EOL;\n\t$a .= '<meta name=\"Robots\" content=\"noindex\" />'.PHP_EOL;\n\t$a .= '<title>'.$title.'</title>'.PHP_EOL;\n\n\tif (@file_exists('admin_accueil.php') || @file_exists('install_mysql.php')){ // Si on est dans l'administration ou en initialisation\n\n        $a .= '<link rel=\"shortcut icon\" href=\"../favicon.ico\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../include/admin_grr.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/default/css/style.css\" />'.PHP_EOL; // le style par d\u00c3\u0110faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\u00c3\u0110\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/default/css/types.css\" />'.PHP_EOL; // les couleurs des types de r\u00c3\u0110servation\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"../themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/html2canvas.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/menu.js\"></script>'.PHP_EOL;        \n        $a .= '<script type=\"text/javascript\" src=\"../js/jquery.floatThead.min.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"../js/planning2Thead.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/functions.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"../js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"../js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"../js/'.$clock_file.'\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"../js/jscolor.js\"></script>';\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n\t} \n    else {\n        $a .= '<link rel=\"shortcut icon\" href=\"./favicon.ico\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap.min.css\" />'.PHP_EOL;\n\t    if (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/select2-bootstrap.css\" />'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-multiselect.css\">'.PHP_EOL;\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/bootstrap-clockpicker.min.css\">'.PHP_EOL;\n\t\t}\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui.css\" />'.PHP_EOL;\n\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"bootstrap/css/jquery-ui-timepicker-addon.css\" >'.PHP_EOL;\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/default/css/style.css\" />'.PHP_EOL; // le style par d\u00c3\u0110faut\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"'.$sheetcss.'/style.css\" />'.PHP_EOL; // le style personnalis\u00c3\u0110\n        $a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/default/css/types.css\" />'.PHP_EOL; // les couleurs des types de r\u00c3\u0110servation        \n\t\tif (isset($use_admin))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"include/admin_grr.css\" />'.PHP_EOL;\n\t\tif ((isset($_GET['pview'])) && ($_GET['pview'] == 1))\n\t\t\t$a .= '<link rel=\"stylesheet\" type=\"text/css\" href=\"themes/print/css/style.css\" />'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-2.1.1.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery.validate.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jquery-ui-timepicker-addon.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"bootstrap/js/bootstrap.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/html2canvas.js\"></script>'.PHP_EOL;\n        $a .= '<script type=\"text/javascript\" src=\"js/jquery.floatThead.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/menu.js\"></script>'.PHP_EOL;     \n        $a .= '<script type=\"text/javascript\" src=\"js/planning2Thead.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/jspdf.min.js\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/pdf.js\" ></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/popup.js\" charset=\"utf-8\"></script>'.PHP_EOL;\n\t\t$a .= '<script type=\"text/javascript\" src=\"js/functions.js\" ></script>'.PHP_EOL;\n\t\tif (isset($use_select2))\n\t\t{\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-clockpicker.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/bootstrap-multiselect.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2.js\"></script>'.PHP_EOL;\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/select2_locale_fr.js\"></script>'.PHP_EOL;\n\t\t}\n\t\tif (isset($use_tooltip_js))\n\t\t\techo '<script type=\"text/javascript\" src=\"./js/tooltip.js\"></script>'.PHP_EOL;\n\t\tif (!isset($_SESSION['selection']))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/selection.js\" ></script>'.PHP_EOL;\n\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t$a .= '<script type=\"text/javascript\" src=\"js/'.$clock_file.'\"></script>'.PHP_EOL;\n\t\tif (substr(phpversion(), 0, 1) == 3)\n\t\t\t$a .= get_vocab('not_php3');\n\t}\n\n\t$a .= '</head>'.PHP_EOL;\n\treturn $a;\n}\n\n/*\n** Fonction qui affiche le header\n*/\nfunction pageHeader2($day = '', $month = '', $year = '', $type_session = 'with_session', $adm=0)\n{\n\tglobal $vocab, $search_str, $grrSettings, $clock_file, $desactive_VerifNomPrenomUser, $grr_script_name, $racine, $racineAd;\n\tglobal $use_prototype, $use_admin, $use_tooltip_js, $desactive_bandeau_sup, $id_site, $use_select2;\n        $parametres_url = htmlspecialchars($_SERVER['QUERY_STRING']).\"&amp;\";\n        \n\tHook::Appel(\"hookHeader2\");\n\t// Si nous ne sommes pas dans un format imprimable\n\tif ((!isset($_GET['pview'])) || ($_GET['pview'] != 1))\n\t{\n\t\t// If we dont know the right date then make it up\n\t\tif (!isset($day) || !isset($month) || !isset($year) || ($day == '') || ($month == '') || ($year == ''))\n\t\t{\n\t\t\t$date_now = time();\n\t\t\tif ($date_now < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_now > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\telse\n\t\t\t\t$date_ = $date_now;\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t}\n\t\tif (!(isset($search_str)))\n\t\t\t$search_str = get_vocab(\"search_for\");\n\t\tif (empty($search_str))\n\t\t\t$search_str = \"\";\n\t\tif (!(isset($desactive_bandeau_sup) && ($desactive_bandeau_sup == 1) && ($type_session != 'with_session')))\n\t\t{\n\n\t\t\t// HOOK\n\t\t\tHook::Appel(\"hookHeader1\");\n\n\t\t\t// G\u00c3\u0110n\u00c3\u0110ration XML\n\t\t\t$generationXML = 1;\n\t\t\tif ((Settings::get(\"export_xml_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude $racine.\"include/generationxml.php\";\n\t\t\t}\n\t\t\tif ((Settings::get(\"export_xml_plus_actif\") == \"Oui\") && ($adm == 0)){\n\t\t\t\tinclude $racine.\"include/generationxmlplus.php\";\n\t\t\t}\n\n\t\t\t// On fabrique une date valide pour la r\u00c3\u0110servation si ce n'est pas le cas\n\t\t\t$date_ = mktime(0, 0, 0, $month, $day, $year);\n\t\t\tif ($date_ < Settings::get(\"begin_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"begin_bookings\");\n\t\t\telse if ($date_ > Settings::get(\"end_bookings\"))\n\t\t\t\t$date_ = Settings::get(\"end_bookings\");\n\t\t\t$day   = date(\"d\",$date_);\n\t\t\t$month = date(\"m\",$date_);\n\t\t\t$year  = date(\"Y\",$date_);\n\t\t\t// echo '<div id=\"toppanel\">'.PHP_EOL;\n\t\t\techo '<div id=\"panel\">'.PHP_EOL;\n\t\t\t// echo '<table id=\"header\">'.PHP_EOL;\n\t\t\t// echo '<tr>'.PHP_EOL;\n\t\t\t//Logo\n\t\t\t$nom_picture = $racine.\"images/\".Settings::get(\"logo\");\n\t\t\tif ((Settings::get(\"logo\") != '') && (@file_exists($nom_picture)))\n\t\t\t\techo '<div class=\"logo\" height=\"100\">'.PHP_EOL.'<a href=\"'.$racine.page_accueil('yes').'day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\"><img src=\"'.$nom_picture.'\" alt=\"logo\"/></a>'.PHP_EOL.'</div>'.PHP_EOL;\n\t\t\t//Accueil\n\t\t\techo '<div class=\"accueil \">',PHP_EOL,'<h2>',PHP_EOL,'<a href=\"'.$racine.page_accueil('yes'),'day=',$day,'&amp;year=',$year,'&amp;month=',$month,'\">',Settings::get(\"company\"),'</a>',PHP_EOL,'</h2>',PHP_EOL, Settings::get('message_accueil'),'</div>',PHP_EOL;\n\t\t\t//Mail r\u00c3\u0110servation\n\t\t\t$sql = \"SELECT value FROM \".TABLE_PREFIX.\"_setting WHERE name='mail_etat_destinataire'\";\n\t\t\t$res = grr_sql_query1($sql);\n\t\t\tgrr_sql_free($res);\n\n\t\t\tif ( ( $res == 1 && $type_session == \"no_session\" ) || ( ( $res == 1 || $res == 2) && $type_session == \"with_session\" && (authGetUserLevel(getUserName(), -1, 'area')) == 1  ) )\n\t\t\t{\n\t\t\t\techo '<div class=\"contactformulaire\">',PHP_EOL,'<input class=\"btn btn-default\" type=\"submit\" rel=\"popup_name\" value=\"R\u00c3\u0110server\" onClick=\"javascript:location.href=\\'contactFormulaire.php?day=',$day,'&amp;month=',$month,'&amp;year=',$year,'\\'\" >',PHP_EOL,'</div>',PHP_EOL;\n\t\t\t}\n\t\t\t// Administration\n\t\t\tif ($type_session == \"with_session\")\n\t\t\t{\n                $user_name = getUserName();\n                $resaAModerer = resaToModerate($user_name);\n                $nbResaAModerer = count($resaAModerer);\n                $mess_resa = '';\n                if ($nbResaAModerer > 1){$mess_resa = $nbResaAModerer.get_vocab('resasToModerate');}\n                if ($nbResaAModerer == 1){$mess_resa = $nbResaAModerer.get_vocab('resaToModerate');}\n\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1))// || ($mess_resa != '')) trop large ? YN le 06/01/19\n\t\t\t\t{\n\t\t\t\t\techo '<div class=\"administration\">'.PHP_EOL;\n\t\t\t\t\tif ((authGetUserLevel($user_name, -1, 'area') >= 4) || (authGetUserLevel($user_name, -1, 'user') == 1))\n                        echo \"<br><a href='{$racineAd}admin_accueil.php?day={$day}&amp;month={$month}&amp;year={$year}'>\".get_vocab('admin').\"</a>\".PHP_EOL;\n\t\t\t\t\tif (authGetUserLevel(getUserName(), -1, 'area') >= 6)\n\t\t\t\t\t{\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\t\thow_many_connected();\n                        echo \"<br />\";\n\t\t\t\t\t}\n                    echo \"<p class='avertissement'><a href='\".$racine.\"admin/admin_accueil.php?\".$parametres_url.\"' class='avertissement' >\".$mess_resa.\"</a></p>\";\n\t\t\t\t\techo '</div>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($type_session != \"with_session\")\n\t\t\t\techo '<script>selection()</script>'.PHP_EOL;\n\t\t\techo '<div class=\"configuration\" >'.PHP_EOL;\n\t\t\tif (@file_exists('js/'.$clock_file))\n\t\t\t{\n\t\t\t\techo '<div class=\"clock\">'.PHP_EOL;\n\t\t\t\techo '<div id=\"Date\">'.PHP_EOL;\n\t\t\t\techo '&nbsp;<span id=\"hours\"></span>'.PHP_EOL;\n\t\t\t\techo 'h'.PHP_EOL;\n\t\t\t\techo '<span id=\"min\"></span>'.PHP_EOL;\n\t\t\t\techo '</div></div>'.PHP_EOL;\n\t\t\t}\n\t\t\t$_SESSION['chemin_retour'] = '';\n\t\t\tif (isset($_SERVER['QUERY_STRING']) && ($_SERVER['QUERY_STRING'] != ''))\n\t\t\t{\n\t\t\t\t//$parametres_url = htmlspecialchars($_SERVER['QUERY_STRING']).\"&amp;\";\n\t\t\t\t$_SESSION['chemin_retour'] = traite_grr_url($grr_script_name).\"?\". $_SERVER['QUERY_STRING'];\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=fr\"><img src=\"'.$racine.'img_grr/fr_dp.png\" alt=\"France\" title=\"france\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=de\"><img src=\"'.$racine.'img_grr/de_dp.png\" alt=\"Deutch\" title=\"deutch\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=en\"><img src=\"'.$racine.'img_grr/en_dp.png\" alt=\"English\" title=\"English\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=it\"><img src=\"'.$racine.'img_grr/it_dp.png\" alt=\"Italiano\" title=\"Italiano\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t\techo '<a onclick=\"charger();\" href=\"'.traite_grr_url($grr_script_name).'?'.$parametres_url.'default_language=es\"><img src=\"'.$racine.'img_grr/es_dp.png\" alt=\"Spanish\" title=\"Spanish\" width=\"20\" height=\"13\" class=\"image\" /></a>'.PHP_EOL;\n\t\t\t}\n\t\t\tif ($type_session == 'no_session')\n\t\t\t{\n\t\t\t\tif ((Settings::get('sso_statut') == 'cas_visiteur') || (Settings::get('sso_statut') == 'cas_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br /> <a href=\"index.php?force_authentification=y\">'.get_vocab(\"authentification\").'</a>'.PHP_EOL;\n\t\t\t\t\techo '<br /> <small><i><a href=\"login.php\">'.get_vocab(\"connect_local\").'</a></i></small>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\techo '<br /> <a href=\"login.php\">'.get_vocab(\"connect\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif( strlen(htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom'])) > 40 )\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['nom']);\n\t\t\t\telse\n\t\t\t\t\t$nomAffichage =  htmlspecialchars($_SESSION['prenom']).' '.htmlspecialchars($_SESSION['nom']);\n\t\t\t\n\t\t\t\techo '<br /><a href=\"'.$racine.'my_account.php?day='.$day.'&amp;year='.$year.'&amp;month='.$month.'\">'. $nomAffichage .' - '.get_vocab(\"manage_my_account\").'</a>'.PHP_EOL;\n\t\t\t\tif (verif_access_search(getUserName()))\n\t\t\t\t\techo '<br/><a href=\"'.$racine.'report.php\">'.get_vocab(\"report\").'</a>'.PHP_EOL;\n\t\t\t\t$disconnect_link = false;\n\t\t\t\tif (!((Settings::get(\"cacher_lien_deconnecter\") == 'y') && (isset($_SESSION['est_authentifie_sso']))))\n\t\t\t\t{\n\t\t\t\t\t$disconnect_link = true;\n\t\t\t\t\tif (Settings::get(\"authentification_obli\") == 1)\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br /> <a href=\"'.$racine.'logout.php?auto=0&amp;redirect_page_accueil=yes\" >'.get_vocab('disconnect').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get(\"Url_portail_sso\") != '') && (isset($_SESSION['est_authentifie_sso'])))\n\t\t\t\t{\n\t\t\t\t\tif ($disconnect_link)\n\t\t\t\t\t\techo ' - '.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<br />'.PHP_EOL;\n\t\t\t\t\techo '<a href=\"'.Settings::get(\"Url_portail_sso\").'\">'.get_vocab(\"Portail_accueil\").'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t\tif ((Settings::get('sso_statut') == 'lasso_visiteur') || (Settings::get('sso_statut') == 'lasso_utilisateur'))\n\t\t\t\t{\n\t\t\t\t\techo '<br />';\n\t\t\t\t\tif ($_SESSION['lasso_nameid'] == NULL)\n\t\t\t\t\t\techo '<a href=\"lasso/federate.php\">'.get_vocab('lasso_federate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t\telse\n\t\t\t\t\t\techo '<a href=\"lasso/defederate.php\">'.get_vocab('lasso_defederate_this_account').'</a>'.PHP_EOL;\n\t\t\t\t}\n\t\t\t}\n\t\t\techo '</div>'.PHP_EOL;\n\t\t\t// echo '</tr>'.PHP_EOL;\n\t\t\t// echo '</table>'.PHP_EOL;\n\t\t\techo '</div>'.PHP_EOL;\n\t\t\techo '<a id=\"open\" class=\"open\" href=\"#\"><span class=\"glyphicon glyphicon-arrow-up\"><span class=\"glyphicon glyphicon-arrow-down\"></span></span></a>'.PHP_EOL;\n            // echo '<a href=\"#\" onClick=\"menuHaut()\"><span class=\"glyphicon glyphicon-arrow-up\"><span class=\"glyphicon glyphicon-arrow-down\"></span></span></a>'.PHP_EOL;\n\t\t\t// echo '</div>'.PHP_EOL;\n\t\t}\n\t}\n}\n/*\n** Fonction qui affiche le d\u00c3\u0110but d'une page avec ent\u00c3\u0160te et balise <section>\n*/\nfunction start_page_w_header($day = '', $month = '', $year = '', $type_session = 'with_session')\n{\n    global $racine,$racineAd;\n    // pour le traitement des modules\n    if (@file_exists('./admin_access_area.php')){\n        $adm = 1;\n        $racine = \"../\";\n        $racineAd = \"./\";\n    }\n    else{\n        $adm = 0;\n        $racine = \"./\";\n        $racineAd = \"./admin/\";\n    }\n    include $racine.\"/include/hook.class.php\";\n    // code HTML\n    echo '<!DOCTYPE html>'.PHP_EOL;\n    echo '<html lang=\"fr\">'.PHP_EOL;\n    // section <head>\n    if ($type_session == \"with_session\")\n        echo pageHead2(Settings::get(\"company\"),\"with_session\");\n    else\n        echo pageHead2(Settings::get(\"company\"),\"no_session\");\n    // section <body>\n    echo \"<body>\";\n    // Menu du haut = section <header>\n    echo \"<header>\";\n    pageHeader2($day, $month, $year, $type_session, $adm);\n    echo \"</header>\";\n    // Debut de la page\n    echo '<section>'.PHP_EOL;\n    // doit \u00c3\u0160tre ferm\u00c3\u0110 par la fonction end_page\n}   \n/*\n** Fonction qui affiche le d\u00c3\u0110but d'une page sans ent\u00c3\u0160te et avec une balise <section>\n*/\nfunction start_page_wo_header($titre, $type_session = 'with_session')\n{\n    // pour le traitement des modules\n    if (@file_exists('./admin_access_area.php')){\n        $adm = 1;\n        $racine = \"../\";\n        $racineAd = \"./\";\n    }\n    else{\n        $adm = 0;\n        $racine = \"./\";\n        $racineAd = \"./admin/\";\n    }\n    include $racine.\"/include/hook.class.php\";\n    // code HTML\n    echo '<!DOCTYPE html>'.PHP_EOL;\n    echo '<html lang=\"fr\">'.PHP_EOL;\n    // section <head>\n    if ($type_session == \"with_session\")\n        echo pageHead2(Settings::get(\"company\"),\"with_session\");\n    else\n        echo pageHead2(Settings::get(\"company\"),\"no_session\");\n    // section <body>\n    echo \"<body>\";\n    // Debut de la page\n    echo '<section>'.PHP_EOL;\n    // doit \u00c3\u0160tre ferm\u00c3\u0110 par la fonction end_page\n} \n/* Fonction qui ferme les balises rest\u00c3\u0110es ouvertes dans les pr\u00c3\u0110c\u00c3\u0110dentes */\nfunction end_page()\n{\n    echo '</section></body></html>';\n}\n    \n// Les lignes suivantes permettent la compatibilit\u00c3\u0110 de GRR avec la variable register_global \u00c3\u00a0 off\nunset($day);\nif (isset($_GET[\"day\"]))\n{\n\t$day = $_GET[\"day\"];\n\tsettype($day,\"integer\");\n\tif ($day < 1)\n\t\t$day = 1;\n\tif ($day > 31)\n\t\t$day = 31;\n}\nunset($month);\nif (isset($_GET[\"month\"]))\n{\n\t$month = $_GET[\"month\"];\n\tsettype($month,\"integer\");\n\tif ($month < 1)\n\t\t$month = 1;\n\tif ($month > 12)\n\t\t$month = 12;\n}\nunset($year);\nif (isset($_GET[\"year\"]))\n{\n\t$year = $_GET[\"year\"];\n\tsettype($year,\"integer\");\n\tif ($year < 1900)\n\t\t$year = 1900;\n\tif ($year > 2100)\n\t\t$year = 2100;\n}\n?>\n", "<?php\n/**\n * misc.inc.php\n * fichier de variables diverses\n * Derni\u00e8re modification : $Date: 2020-03-13 13:15$\n * @author    JeromeB & Laurent Delineau & Yan Naessens\n * @copyright Copyright 2003-2020 Team DEVOME - JeromeB\n * @link      http://www.gnu.org/licenses/licenses.html\n *\n * This file is part of GRR.\n *\n * GRR is free software; you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation; either version 2 of the License, or\n * (at your option) any later version.\n */\n\n\n################################\n# Development information\n#################################\n$grr_devel_email = \"support@devome.com\";\n$grr_devel_url = \"http://grr.devome.com/\";\n// Num\u00e9ro de version actuel\n$version_grr = \"3.4.1\";\n// Num\u00e9ro de sous-version actuel (a, b, ...)\n// Utilisez cette variable pour des versions qui corrigent la la version finale sans toucher \u00e0 la base.\n$sous_version_grr = \"c\"; // a, b, c, ...\n// Num\u00e9ro de la release candidate (doit \u00eatre strictement inf\u00e9rieure \u00e0 9). Laisser vide s'il s'agit de la version stable.\n$version_grr_RC = \"\";\n// Version repository (GitHub)\n$versionReposite = \"\";\n\n# Liste des tables\n$liste_tables = array(\n\t\"_area\",\n\t\"_area_periodes\",\n\t\"_calendar\",\n    \"_calendrier_feries\",\n\t\"_calendrier_jours_cycle\",\n\t\"_calendrier_vacances\",\n\t\"_entry\",\n\t\"_entry_moderate\",\n\t\"_type_area\",\n\t\"_j_type_area\",\n\t\"_j_mailuser_room\",\n\t\"_j_user_area\",\n\t\"_j_user_room\",\n\t\"_log\",\n\t\"_repeat\",\n\t\"_room\",\n\t\"_setting\",\n\t\"_utilisateurs\",\n\t\"_j_useradmin_area\",\n\t\"_overload\",\n\t\"_site\",\n\t\"_j_useradmin_site\",\n\t\"_j_site_area\",\n\t\"_correspondance_statut\",\n\t\"_page\",\n\t\"_modulesext\",\n\t);\n\n# Liste des feuilles de style\n$liste_themes = array(\n\t\"default\",\n    \"grand_bleu\",\n\t\"vert\",\n\t\"violet\",\n\t\"orange\",\n\t\"bleu\",\n\t\"rouge\",\n\t\"rose\",\n\t\"fluo\",\n    \"perso\"\n\t);\n\n# Liste des noms des styles\n$liste_name_themes = array(\n    \"Defaut\",\n\t\"Grand bleu\",\n\t\"Verdoyant\",\n\t\"Violeta\",\n\t\"Orange Talmont\",\n\t\"Bleu Talmont\",\n\t\"Rouge Feu\",\n\t\"Roseline\",\n\t\"Jaune Fluo\",\n    \"Perso\"\n\t);\n\n# Liste des langues\n$liste_language = array(\n\t\"fr\",\n\t\"de\",\n\t\"en\",\n\t\"it\",\n\t\"es\"\n\t);\n\n# Liste des noms des langues\n$liste_name_language = array(\n\t\"Fran\u00e7ais\",\n\t\"Deutsch\",\n\t\"English\",\n\t\"Italiano\",\n\t\"Spanish\"\n\t);\n\n# Compatibilit\u00e9 avec les version inf\u00e9rieures \u00e0 1.9.6\nif ((!isset($table_prefix)) or ($table_prefix==''))\n\t$table_prefix=\"grr\";\n# D\u00e9finition de TABLE_PREFIX\ndefine(\"TABLE_PREFIX\",$table_prefix);\n\n\n################################################\n# Configuration du planning : valeurs par d\u00e9faut\n# Une interface en ligne permet une configuration domaine par domaine de ces valeurs\n################################################\n# Resolution - quel bloc peut \u00eatre r\u00e9serv\u00e9, en secondes\n# remarque : 1800 secondes = 1/2 heure.\n$resolution = 1800;\n\n# Dur\u00e9e maximale de r\u00e9servation, en minutes\n# -1 : d\u00e9sactivation de la limite\n$duree_max_resa = -1 ;\n\n# D\u00e9but et fin d'une journ\u00e9e : valeur enti\u00e8res uniquement de 0 \u00e0 23\n# morningstarts doit \u00eatre inf\u00e9rieur \u00e0  < eveningends.\n$morningstarts = 8;\n$eveningends   = 19;\n\n# Minutes \u00e0 ajouter \u00e0 l'heure $eveningends pour avoir la fin r\u00e9elle d'une journ\u00e9e.\n# Examples: pour que le dernier bloc r\u00e9servable de la journ\u00e9e soit 16:30-17:00, mettre :\n# eveningends=16 et eveningends_minutes=30.\n# Pour avoir une journ\u00e9e de 24 heures avec un pas de 15 minutes mettre :\n# morningstarts=0; eveningends=23;\n# eveningends_minutes=45; et resolution=900.\n$eveningends_minutes = 0;\n\n# D\u00e9but de la semaine: 0 pour dimanche, 1 pour lundi, etc.\n$weekstarts = 1;\n\n# Format d'affichage du temps : valeur 0 pour un affichage \u00ab\u00a012 heures\u00a0\u00bb et valeur 1 pour un affichage  \u00ab\u00a024 heures\u00a0\u00bb.\n$twentyfourhour_format = 1;\n\n# Ci-dessous des fonctions non officielles (non document\u00e9es) de GRR\n# En attendant qu'elles soient impl\u00e9ment\u00e9es dans GRR avec une interface en ligne\n\n# Vous pouvez indiquer ci-dessous les identifiant de plusieurs ressources qui seront r\u00e9servables, m\u00eame par un simple visiteur\n# Par exemple la ligne suivante autorise les simples visiteurs \u00e0 r\u00e9server les ressoures 8, 4 et 5 :\n# $id_room_autorise = array(\"8\", \"4\", \"5\");\n$id_room_autorise = array();\n\n# Possibilit\u00e9 de d\u00e9sactiver le bandeau sup\u00e9rieur dans le cas de simples visiteurs\n# Pour se connecter il est alors n\u00e9cessaire de se rendre directement \u00e0 l'adresse du type http://mon-site.fr/grr/login.php\n# Mettre ci-dessous $desactive_bandeau_sup = 1;  pour d\u00e9sactiver le bandeau sup\u00e9rieur pour les simples visiteurs.\n# Mettre ci-dessous $desactive_bandeau_sup = 0;  pour ne pas d\u00e9sactiver le bandeau sup\u00e9rieur pour les simples visiteurs.\n$desactive_bandeau_sup = 0;\n?>\n"], "filenames": ["CHANGELOG", "admin/admin_edit_room.php", "frmcontactlist.php", "frmcontactrange.php", "include/functions.inc.php", "include/misc.inc.php"], "buggy_code_start_loc": [32, 6, 6, 6, 4, 5], "buggy_code_end_loc": [32, 1056, 27, 27, 5577, 29], "fixing_code_start_loc": [33, 6, 6, 6, 4, 5], "fixing_code_end_loc": [36, 1099, 28, 29, 5577, 29], "type": "CWE-434", "message": "An issue was discovered in DEVOME GRR before 3.4.1c. admin_edit_room.php mishandles file uploads.", "other": {"cve": {"id": "CVE-2020-10562", "sourceIdentifier": "cve@mitre.org", "published": "2020-03-13T21:15:12.017", "lastModified": "2020-03-18T19:31:15.853", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "An issue was discovered in DEVOME GRR before 3.4.1c. admin_edit_room.php mishandles file uploads."}, {"lang": "es", "value": "Se detect\u00f3 un problema en DEVOME GRR versiones anteriores a 3.4.1c. El archivo admin_edit_room.php maneja inapropiadamente cargas de archivos."}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "HIGH", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 7.2, "baseSeverity": "HIGH"}, "exploitabilityScore": 1.2, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:S/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "SINGLE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 6.5}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-434"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:devome:grr:*:*:*:*:*:*:*:*", "versionEndExcluding": "3.4.1c", "matchCriteriaId": "6E45B6AC-1D7C-4E13-A6F6-1909A6125E3E"}]}]}], "references": [{"url": "https://github.com/JeromeDevome/GRR/commit/2c6edacd9e15c75a0c2ef472470481ffb6edc7d8", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/JeromeDevome/GRR/releases/tag/v3.4.1c", "source": "cve@mitre.org", "tags": ["Release Notes", "Third Party Advisory"]}, {"url": "https://github.com/skr0x/CVE/tree/master/CVE-2020-10562", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/JeromeDevome/GRR/commit/2c6edacd9e15c75a0c2ef472470481ffb6edc7d8"}}