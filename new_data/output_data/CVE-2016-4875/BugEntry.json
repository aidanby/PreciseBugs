{"buggy_code": ["<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | DataBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | \u81ea\u52d5\u30bf\u30b0\u304a\u3088\u3073 DataBox \u5c02\u7528\u95a2\u6570\n// +---------------------------------------------------------------------------+\n// $Id: plugins/databox/functions_autotag.inc\n//20101008 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n//20120416 databox_category {data_edit}\n\nif (strpos ($_SERVER['PHP_SELF'], 'functions_autotag.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n//=====\u81ea\u52d5\u30bf\u30b0=================================================================\nfunction plugin_autotags_databox (\n    $op\n    , $content = ''\n    , $autotag = ''\n)\n// +---------------------------------------------------------------------------+\n// | \u81ea\u52d5\u30bf\u30b0\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    global $LANG_DATABOX_autotag_desc;\n\n    //Option Display\n    if ($op == 'tagname' ) {\n        $tagname[]='databox';\n        return $tagname;\n    } elseif ($op == 'permission' || $op == 'nopermission') {\n        if ($op == 'permission') {\n            $flag = true;\n        } else {\n            $flag = false;\n        }\n\n        if (isset($_GROUPS['DataBox Admin'])) {\n            $group_id = $_GROUPS['DataBox Admin'];\n        } else {\n            $group_id = DB_getItem($_TABLES['groups'], 'grp_id',\n                                   \"grp_name = 'DataBox Admin'\");\n        }\n        $owner_id = SEC_getDefaultRootUser();\n\n        if (COM_getPermTag(\n            $owner_id\n            , $group_id\n            , $_DATABOX_CONF['autotag_permissions_databox'][0]\n            , $_DATABOX_CONF['autotag_permissions_databox'][1]\n            , $_DATABOX_CONF['autotag_permissions_databox'][2]\n            , $_DATABOX_CONF['autotag_permissions_databox'][3]) == $flag) {\n            return $tagname;\n        }\n    } elseif ($op == 'description') {\n        return $LANG_DATABOX_autotag_desc;\n    } else if ($op == 'parse') {\n        //\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n        $p1 = COM_applyFilter ($autotag['parm1']);\n        $p2 = COM_applyFilter ($autotag['parm2']);\n        $tag = COM_applyFilter ($autotag['tag']);\n        $tagstr = COM_applyFilter ($autotag['tagstr']);\n        \n        $parm2_ary[]=\"category_id\";\n        $parm2_ary[]=\"category_code\";\n        $parm2_ary[]=\"mode\";\n        $parm2_ary[]=\"rss_file\";\n        $parm2_ary[]=\"title_trim_length\";\n        $parm2_ary[]=\"intervalday\";\n        $parm2_ary[]=\"limitcnt\";\n        $parm2_ary[]=\"newmarkday\";\n        $parm2_ary[]=\"templatedir\";\n        $parm2_ary[]=\"id\";\n        $parm2_ary[]=\"code\";\n        $parm2_ary[]=\"nohitmsg\";\n        $parm2_ary[]=\"perpage\";\n        $parm2_ary[]=\"page\";\n        $parm2_ary[]=\"order\";\n        $parm2_ary[]=\"templatesetvar\";\n        $parm2_ary[]=\"value\";\n        $parm2_ary[]=\"field_id\";\n        $parm2_ary[]=\"expired\";\n        $parm2_ary[]=\"type_id\";\n        $parm2_ary[]=\"group_id\";\n        $parm2_ary[]=\"group_code\";\n        $parm2_ary[]=\"iname\";\n        $parm2_ary[]=\"without_code\";\n        $parm2_ary[]=\"without_id\";\n        $parm2_ary[]=\"field_code\";\n        $parm2_ary[]=\"option\";\n        $parm2_ary[]=\"method\";\n        $parm2_ary[]=\"roundprecision\";\n        $parm2_ary[]=\"numberformat\";\n        $parm2_ary[]=\"permission\";\n        $p=databox_parm2($p2,$parm2_ary);\n        //\u5404\u51e6\u7406\n        switch( $tag ) {\n            case 'databox' :\n                switch($p1) {\n                    case 'count':\n                        $rt= databox_count(\n                            $p['category_id']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n                    case 'newlist':\n                            if ($p['category_id']<>\"\"){\n                                $m=\"id\";\n                                $categories=$p['category_id'];\n                            }elseif ($p['category_code']<>\"\") {\n                                $m=\"code\";\n                                $categories=$p['category_code'];\n                            }else{\n                                $m=\"ALL\";\n                                $categories=\"\";\n                            }\n                            $rt= databox_newlist(\n                            $m\n                            ,$categories\n                            ,$p['rss_file']\n                            ,$p['title_trim_length']\n                            ,$p['intervalday']\n                            ,$p['limitcnt']\n                            ,$p['newmarkday']\n                            ,$p['templatedir']\n                            );\n                        break;\n                    case 'data':\n                        $w= databox_data(\n                            $p['id']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,\"\"\n                            ,$p['code']\n                            );\n                        $rt=$w['display'];\n                        break;\n                    case 'category':\n                        $rt= databox_category(\n                            \"autotag\"\n                            ,$p['category_id']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['expired']\n                            ,$p['without_code']\n                            ,$p['without_id']\n                        );\n                        break;\n                    case 'attributedatacount':\n                        $rt=DATABOX_count_each_afield(\n                            \"databox\"\n                            ,$p['templatesetvar']\n       \t                    ,$p['value']\n                            ,$p['type_id']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n\n                    case 'lastmodified':\n                        $rt= databox_grp(\n                            \"modified\"\n                            ,\"max\"\n                            ,\"lastmodified\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                        break;\n                    case 'lastcreated':\n                        $rt= databox_grp(\n                            \"created\"\n                            ,\"max\"\n                            ,\"lastcreated\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                        break;\n                    case 'attribute':\n                        $rt= databox_field(\n                            \"autotag\"\n                            ,$p['field_id']\n                            ,$p['value']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['field_code']\n                        );\n                        break;\n                    case 'datalink':\n                        $rt= databox_datalink(\n                            $p['id']\n                            ,$p['code']\n                            ,$p['lastparm2']\n                        );\n                        break;\n                    case 'mydataentrylink':\n                    case 'mydataentry':\n                        $rt= databox_mydataentrylink(\n                            $p['type_id']\n                            ,$p['templatedir']\n                            ,$p['lastparm2']\n                        );\n                        break;\n                    case 'mydata':\n                        $rt= databox_mydata(\n                             $p['templatedir']\n                            ,$p['lastparm2']\n                        );\n                        break;\n                    case 'categorycount':\n                        $rt= DATABOX_categorycount(\n                             \"databox\"\n                            ,$p['group_id']\n                            ,$p['group_code']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                        );\n                        break;\n                    case 'categorycheck':\n                          $rt= DATABOX_getcheckList(\n                             \"categorygroup\"\n                            ,\"\"\n                            ,\"databox\"\n                            ,$p['group_id']\n                            ,$p['iname']\n                        );\n                        break;\n                    case 'mastercheck':\n                        if  ($p['field_id']<>\"\"){\n                            $kind=COM_applyFilter(\n                                DB_getItem($_TABLES['DATABOX_def_field'] \n                                    ,\"selectlist\",\"field_id={$p['field_id']}\"));\n                            if  ($kind<>\"\"){\n                                  $rt= DATABOX_getcheckList(\n                                     $kind\n                                     ,\"\"\n                                     ,\"databox\"\n                                     ,\"\"\n                                     ,$p['iname']\n                                  );\n                            }\n                        }\n                        break;\n                    case 'search':\n                        $argary=databox_searcharg(\"autotag\",$p['lastparm2']);\n                        $rt=databox_search(\"autotag\",$argary);\n                        break;\n                    case 'attributevalue':\n                        $rt=DATABOX_fieldvalue(\n                                \"databox\"\n                                ,$p['id']\n                                ,$p['code']\n                                ,$p['field_id']\n                                ,$p['field_code']\n                                ,$p['option']\n                            );\n                        break;\n                    case 'math':\n                        $rt=DATABOX_math(\n                                \"databox\"\n                                ,$p['method']\n                                ,$p['templatesetvar']\n                                ,$p['type_id']\n                                ,$p['category_id']\n                                ,$p['category_code']\n                                ,$p['mode']\n                                ,$p['roundprecision']\n                                ,$p['numberformat']\n                                ,$p['permission']\n                            );\n                        break;\n                }\n\n                $content = str_replace ($autotag['tagstr'], $rt, $content);\n                return $content;\n                break;\n\n        }\n    }\n}\n\n//\u7b2c\u4e8c\u5f15\u6570\u5206\u5272\nfunction databox_parm2 ($p2,$parm2_ary)\n{\n    $ary=array();\n    $px = explode (' ', trim ($p2));\n    if (is_array ($px)) {\n        foreach ($px as $part) {\n            $a = explode (':', $part);\n            if (in_array($a[0],$parm2_ary)){\n                $ary[\"{$a[0]}\"]=$a[1];\n                $skip++;            \n            }\n        }\n        \n        if (count ($px) > $skip) {\n            for ($i = 0; $i < $skip; $i++) {\n                array_shift ($px);\n            }\n            $ary[\"lastparm2\"] = trim(implode (' ', $px));\n        }\n\n    }else{\n        $ary[\"lastparm2\"]=trim($p2);\n    }\n    \n    return $ary;\n\n}\n//=====\u30d6\u30ed\u30c3\u30af\u95a2\u6570============================================================\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740data\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f phpblock_shownewdatabox()                                            |\n// +---------------------------------------------------------------------------+\nfunction phpblock_shownewdatabox()\n{\n    return databox_newlist();\n}\n\n//=====\u5c02\u7528\u95a2\u6570============================================================\n//\nfunction databox_category(\n    $autotag\n    ,$category_id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$category_code=null\n    ,$mode=''\n    ,$expired=''\n    ,$without_code=''\n    ,$without_id=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f  databox_category($id,$template,\"yes\",\"page\",$perpage)\n// | \u66f8\u5f0f  databox_category($p['category_id'],$p['thtml'],$p['nohitmsg']\n// | \u66f8\u5f0f                    ,\"\",$p['perpage'],$p['order'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $autotag:notautotag\u306e\u6642\u30d8\u30c3\u30c0\u3092\u8868\u793a\u3057\u306a\u3044\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $page            :\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $category_code :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// +---------------------------------------------------------------------------+\n// | public_html/category.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:category list\n// +---------------------------------------------------------------------------+\n{\n    $pi_name=\"databox\";\n    \n    global $_CONF;\n    global $_TABLES;\n    \n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >1) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n\n    }\n    //-----\u30c6\u30fc\u30d6\u30eb\n    $tbl1=$_TABLES['DATABOX_category'] ;\n    $tbl2=$_TABLES['DATABOX_base'] ;\n    $tbl3=$_TABLES['DATABOX_addition'] ;\n    //\n    $tbl5=$_TABLES['DATABOX_def_category'] ;\n    \n    $tbl6=$_TABLES['DATABOX_stats'];\n\n    //\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\u3001\u516c\u958b\u65e5\uff09\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_DATABOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,'DATABOX_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    \n    //--CATEGORY\n    $category_name=\"\";\n    $defaulttemplatesdirectory = \"\";\n    if (count($idsary)<>0){\n        \n        for ($i = 0; $i < count($idsary); $i++) {\n            $sql = \"SELECT \";\n            $sql .= \" name \".LB;\n            $sql .= \" ,code \".LB;\n            $sql .= \" ,description \".LB;\n            $sql .= \" ,defaulttemplatesdirectory\".LB;\n            $sql .= \" FROM \".LB;\n            $sql .= \" {$tbl5} AS t5 \".LB;\n            $sql .= \" WHERE \".LB;\n            $sql .= \" t5.category_id =\".$idsary[$i].LB;\n        \n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n            if ($numrows > 0) {\n                $A = DB_fetchArray ($result);\n                $category_name.=COM_applyFilter($A['name']).\" \";\n                $category_description.=COM_applyFilter($A['description']).\" \";\n                if ($i==0){\n                    $defaulttemplatesdirectory=COM_applyFilter($A['defaulttemplatesdirectory']);\n                }\n            }\n        }\n    }\n\n    if (is_null($template) or ($template===\"\")){\n        if ($defaulttemplatesdirectory===\"\"){\n            $template=\"default\";\n        }else{\n            $template=$defaulttemplatesdirectory;\n        }\n    }\n    \n    //\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_DATABOX_CONF['perpage'];\n    }\n    //\n    $w=databox_orderby($datefield,$order,$orderby,$addfieldorder,$field_id);\n    //\n    if (is_null($expired) or ($expired===\"\")){\n        $expired=\"no\";\n    }\n    //-----\n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.title \".LB;\n    $sql .= \" ,t2.code \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.fieldset_id \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n\n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n    \n    //--FROM\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n\n    //if ($category_id<>0){\n    //    $sql .= \" ,{$tbl1} AS t1 \".LB;\n    //}\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n    \n    //--WHERE\n    $sql .= \" WHERE \".LB;\n    \n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t1.category_id\";\n                $w.=\" FROM {$tbl1} AS t1 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t2.id = t1.id AND t1.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t2.id IN (SELECT id FROM {$tbl1} AS t1 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t1.category_id = t5.category_id AND t5.allow_display<2 AND t1.category_id IN ({$ids})) \";\n        }\n        $sql.=\" ({$w})\".LB;\n    }else{\n        $sql.=\" 1=1\".LB;\n    }\n    \n    if ($addfieldorder){\n    \n        $sql .= \" AND t3.field_id=\".$field_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //20110529 Del\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    if  (strtoupper($expired)==\"NO\"){\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    if  ($without_code<>\"\"){\n        $sql .= \" AND (t2.code<>'$without_code')\";\n    }\n    if  ($without_id<>\"\"){\n        $sql .= \" AND (t2.id<>$without_id)\";\n    }\n    \n    //--ORDER\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n\n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $category_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $category_name);\n        }\n        \n        // Meta Tags\n        $headercode=DATABOX_getheadercode(\n            \"category\"\n            ,$template\n            ,$pi_name\n            ,$category_id\n            ,$category_name\n            ,$category_description\n            ,$category_name\n            ,$category_description);\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode) ;\n    }\n    \n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        \n        $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            ));\n\n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n\n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_DATABOX['home']);\n        \n        $templates->set_var ('lang_category_list_h2',$LANG_DATABOX['category_list_h2']);\n\n        $templates->set_var ('category_name',$category_name);\n        $templates->set_var ('category_code',$category_code);\n        $templates->set_var ('category_description',$category_description);\n\n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_DATABOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        //\n        $templates->set_var ('lang_title', $LANG_DATABOX_ADMIN['title']);\n        $templates->set_var ('lang_code', $LANG_DATABOX_ADMIN['code']);\n        $templates->set_var ('lang_id', $LANG_DATABOX_ADMIN['id']);\n        $templates->set_var ('lang_description', $LANG_DATABOX_ADMIN['description']);\n        $templates->set_var ('lang_date', $LANG_DATABOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_DATABOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        // \u8ffd\u52a0\u9805\u76ee\u306e\u30d8\u30c3\u30c0\n        $addition_def=DATABOX_getadditiondef($pi_name);\n        \n        //\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $title=$A['title'];\n            $description=$A['description'];\n            $code=COM_applyFilter($A['code']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{\n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n\n            \n            $value=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n\n            $rt= databox_detail_link($id,$code,$title);\n\n            $templates->set_var ('data_link', $rt['link']);\n            $templates->set_var ('data_title', $title);\n            $templates->set_var ('data_code', $code);\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $rt['url']);\n\n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $value);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_date', strftime( $_CONF['date'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_daytime', strftime( $_CONF['daytime'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_dateonly', strftime( $_CONF['dateonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_timeonly', strftime( $_CONF['timeonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_b', strftime( \"%b\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_B', strftime( \"%B\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_d', strftime( \"%d\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_e', strftime( \"%e\" , $A['datefield_un']));\n            \n            $templates->set_var ('data_released', $released_ary[0]);\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            $hits=COM_applyFilter(DB_getItem( $tbl6 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            \n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/databox/data.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/mydata/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n                \n            }\n\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'databox', $templates );\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"databox/category.php\";\n        }\n        $url.=\"?\";\n        if ($category_code<>\"\"){\n            $url.=\"code=\".$category_code;\n            $url.=\"&amp;m=code\";\n        }else{\n            $url .= \"id=\".$category_id;\n            $url .= \"&amp;m=id\";\n        }    \n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;order=\";\n        \n        //-----order navigation\n        databox_order ($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            $templates->set_var ('home',$LANG_DATABOX['home']);\n            \n            $url=$_CONF['site_url'].\"/databox/category.php\";\n            $category_top=\"<a href='\".$url.\"'>\".$LANG_DATABOX['category_top'].\"</a>\";\n            $templates->set_var ('category_top',$category_top);\n\n            $templates->set_var ('category_name',$category_name);\n            $templates->set_var ('category_code',$category_code);\n            $templates->set_var ('category_description',$category_description);\n            \n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n\n        }\n        \n        \n        \n        \n        \n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    return $retval;\n}\n\nfunction databox_count(\n    $category_id =null\n    ,$category_code =null\n    ,$mode=''\n    ,$permission=''\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u4ef6\u6570\u8868\u793a                                                          |\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_count()\n// | \u66f8\u5f0f  databox_count(1)\n// | \u66f8\u5f0f  databox_count(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    \n    //-----\n    $tbl1=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['DATABOX_category'] ;\n\n    //\u30ab\u30c6\u30b4\u30ea\u306e\u6307\u5b9a\u304c\u306a\u3051\u308c\u3070\u5168\u4ef6\u3001\u3042\u308c\u3070\u30ab\u30c6\u30b4\u30ea\u6bce\n    $exp=\"\";\n    if (is_null($category_id) AND is_null($category_code) ){\n    }else{\n        $ids=\"\";\n        $idsary=array();\n        if (is_null($category_id) OR $category_id==0){\n            if (is_null($category_code)){\n            }else{\n                $w=explode(\"|\",$category_code);\n                foreach( $w as $val ){\n                    if ($ids<>\"\"){\n                        $ids.=\",\";\n                    }\n                    $w_id=DATABOX_codetoid($val,'DATABOX_def_category',\"category_id\");\n                    $idsary[]=$w_id;\n                    $ids.=$w_id;\n                }\n            }\n        }else{\n            $ids=$category_id;\n            $idsary[]=$category_id;\n        }\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT category_id\";\n                $w.=\" FROM {$tbl2} AS t2 \";\n                $w.=\" WHERE t2.id = t1.id)\";\n            }\n        }else{\n            $w= \"id IN (SELECT id FROM {$tbl2} \";\n            $w.=\"WHERE category_id IN ({$ids})) \";\n        }\n        $exp=$w.LB;\n    }\n    \n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" distinct t1.id \".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    $sql .= \" WHERE \".LB;\n    \n    if ($exp<>\"\"){\n        $sql .= $exp. \" AND \";\n    }\n\n    //@@@@@@@@@--------->\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@<---------\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    \n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n    \n    return $rt;\n\n}\n\nfunction databox_field(\n    $autotag\n    ,$field_id=null\n    ,$value=\"\"\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$field_code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $autotag:notautotag\u306e\u6642\u30d8\u30c3\u30c0\u3092\u8868\u793a\u3057\u306a\u3044\n// | \u5f15\u6570 $field_id:\u8ffd\u52a0\u5c5e\u6027id\n// | \u5f15\u6570 $value:\u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u5024\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $page           :\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $field_code    :\n// +---------------------------------------------------------------------------+\n// | public_html/attribute.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:attribute list\n// +---------------------------------------------------------------------------+\n{\n\n    $pi_name=\"databox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $LANG_DATABOX_NOYES;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n    global $_PLUGINS;\n    global $_MAPS_CONF;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >1) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n\n    }\n    //-----table assign\n    $tbl1=$_TABLES['DATABOX_addition'] ;\n    $tbl2=$_TABLES['DATABOX_base'] ;\n    $tbl3=$_TABLES['DATABOX_addition'] ;\n    $tbl5=$_TABLES['DATABOX_stats'];\n\n    //\u65e5\u4ed8\u95a2\u9023\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\u3001\u516c\u958b\u65e5\uff09\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_DATABOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($value) OR $value===\"\") {\n        return;\n    }\n    if (is_null($field_id)){\n        if ($field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,'DATABOX_def_field',\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return;\n    }\n    if ($field_code===\"\"){\n        $field_code=DB_getItem( $_TABLES['DATABOX_def_field']\n                 ,\"templatesetvar\",\"field_id={$field_id}\");\n    }\n    \n    $field_def=DATABOX_getadditiondef($pi_name);\n    $type=$field_def[$field_id]['type'];\n    $w = array(0,2,3,4,7,8,9,16);\n    if (in_array ($type,$w)){\n    }else{\n        return;\n    }\n\n    //\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_DATABOX_CONF['perpage'];\n    }\n    \n    $w=databox_orderby($datefield,$order,$orderby,$addfieldorder,$orderfield_id);\n    \n    $field_def[$field_id]['name'];\n    $field_name=$field_def[$field_id]['name'];\n    $field_templatesetvar=$field_def[$field_id]['templatesetvar'];\n    $field_description=$field_def[$field_id]['description'];\n\n    $fieldvalue=DATABOX_getfieldvalue(\n          $value\n         ,$field_def[$field_id]['type']\n         ,$field_def[$field_id]['selectionary']\n         ,$LANG_DATABOX_NOYES\n         ,$field_def[$field_id]['selectlist']\n         ,$pi_name\n          );\n\n\n    if (is_null($template) or ($template===\"\")){\n        $template=\"default\";\n    }\n\n\n    $sql = \"SELECT DISTINCT\";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.title \".LB;\n    $sql .= \" ,t2.code \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n    \n    $sql .= \" ,t2.fieldset_id \".LB;\n    \n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl1} AS t1 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.field_id = \".$field_id.LB;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t1.value = \\\"\".$value.\"\\\"\".LB;\n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$orderfield_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n    \n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n\n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $field_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $field_name);\n        }\n        $headercode=DATABOX_getheadercode(    \n            \"attribute\"\n            ,$template\n            ,$pi_name\n            ,$field_id\n            ,$field_name\n            ,$field_description\n            ,$field_name\n            ,$field_description);\n\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode);\n    }\n\n    \n    //\n    $addition_def=DATABOX_getadditiondef($pi_name);\n    //\n    $url=$_CONF['site_url'].\"/databox/attribute.php\";\n    $attribute_top=\"<a href='\".$url.\"'>\".$LANG_DATABOX['attribute_top'].\"</a>\";\n    $url=$_CONF['site_url'].\"/databox/attribute.php?\";\n    $url.=\"m=id&amp;id=\".$field_id;\n    $field_top=\"<a href='\".$url.\"'>\".$field_name.$LANG_DATABOX['countlist'].\"</a>\";\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            ));\n        \n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n\n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_DATABOX['home']);\n        $templates->set_var ('attribute_top',$attribute_top);\n        $templates->set_var ('field_top',$field_top);\n        \n        $templates->set_var ('field_name',$field_name);\n        $templates->set_var ('field_templatesetvar',$field_templatesetvar);\n        $templates->set_var ('field_description',$field_description);\n        \n        $templates->set_var ('fieldvalue',$fieldvalue);\n\n        $templates->set_var ('addition_name',$additon_name);\n        $templates->set_var ('addition_code',$additon_code);\n\n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_DATABOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        $templates->set_var ('lang_code', $LANG_DATABOX_ADMIN['code']);\n        $templates->set_var ('lang_id', $LANG_DATABOX_ADMIN['id']);\n\n        //\n        $templates->set_var ('lang_date', $LANG_DATABOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_title', $LANG_DATABOX_ADMIN['title']);\n        $templates->set_var ('lang_description', $LANG_DATABOX_ADMIN['description']);\n        $templates->set_var ('lang_released', $LANG_DATABOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        \n        //$_DATABOX_CONF\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n        $mkids=\"\";\n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $title=COM_applyFilter($A['title']);\n            $description=COM_applyFilter($A['description']);\n            $code=COM_applyFilter($A['code']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n            \n            $sortvalue=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            \n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n\n            $rt=databox_detail_link($id,$code,$title);\n            \n            $templates->set_var ('data_link', $rt['link']);\n            $templates->set_var ('data_title', $title);\n            $templates->set_var ('data_code', $code);\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $rt['url']);\n            \n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $sortvalue);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_date', strftime( $_CONF['date'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_daytime', strftime( $_CONF['daytime'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_dateonly', strftime( $_CONF['dateonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_timeonly', strftime( $_CONF['timeonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_b', strftime( \"%b\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_B', strftime( \"%B\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_d', strftime( \"%d\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_e', strftime( \"%e\" , $A['datefield_un']));\n            \n            $templates->set_var ('data_released', $released_ary[0]);//@@@@@@\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            \n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            \n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            \n            $hits=COM_applyFilter(DB_getItem( $tbl5 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n\n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $group_id = stripslashes($A['group_id']);\n            $owner_id = stripslashes($A['owner_id']);\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/databox/data.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/mydata/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n                \n            }\n            //maps plugin link\n            $mkid=\"\";\n            if (in_array(\"maps\", $_PLUGINS)){\n                if ($code<>\"\"){\n                    $mkid=DB_getItem($_TABLES['maps_markers'],\"mkid\",\"item_10='$code'\");\n                    $mkids.=$mkid.\" \";\n                }\n            }\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        $mkids=rtrim($mkids,\" \");\n        $mkidary=array();\n        $mkid_ary=split(\" \" , $mkids);\n        $selectedMarkers=\"\";\n        if (function_exists(\"MAPS_selectedMarkers\") AND $mkids<>\"\") {\n            $selectedMarkers=MAPS_selectedMarkers(\n              $_MAPS_CONF['map_width']\n             ,$_MAPS_CONF['map_height']\n             ,$_MAPS_CONF['map_zoom']\n             ,$mkid_ary);\n        }\n        $templates->set_var ('mkids', $mkids);\n        $templates->set_var ('selectedMarkers', $selectedMarkers);\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"databox/attribute.php\";\n        }\n        $url .= \"?m=id\";\n        $url .= \"&amp;id=\".$field_id;\n        $url .= \"&amp;value=\".$value;\n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;perpage=\".$perpage;\n        $url .= \"&amp;order=\";\n\n        //-----order navigation\n        databox_order($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'databox', $templates );\n\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            //bread\n            $templates->set_var ('home',$LANG_DATABOX['home']);\n            $templates->set_var ('attribute_top',$attribute_top);\n            $templates->set_var ('field_top',$field_top);\n            \n            $templates->set_var ('field_name',$field_name);\n            $templates->set_var ('field_templatesetvar',$templatesetvar);\n            $templates->set_var ('field_description',$field_description);\n            \n            $templates->set_var ('fieldvalue',$fieldvalue);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n\n        }\n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    return $retval;\n}\nfunction databox_orderby(\n    $datefield\n    ,&$order\n    ,&$orderby\n    ,&$addfieldorder\n    ,&$field_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  order orderby addfieldorder $field_id \u3092\u7de8\u96c6\n// | \u66f8\u5f0f  databox_orderby($order,$orderby,$addfieldorder,$field_id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $datefield\n// | \u5f15\u6570\u623b\u5024 $order\n// | \u5f15\u6570\u623b\u5024 $orderby\n// | \u5f15\u6570\u623b\u5024 $addfieldorder\n// | \u5f15\u6570\u623b\u5024 $field_id\n// +---------------------------------------------------------------------------+\n\n{\n\n    global $_TABLES;\n\n    $orderby=\"\";\n    $addfieldorder=false;\n    switch($order){\n        case \"random\":\n            $orderby =\" RAND()\";\n            break;\n        case \"\":\n        case \"date\":\n            $order=\"date\";\n            $orderby = $datefield .\" DESC\";\n            break;\n        case \"released\":\n            $orderby = \" released DESC\";\n            break;\n        case \"orderno\":\n        case \"code\":\n        case \"title\":\n        case \"description\":\n        case \"id\":\n            $orderby = \" t2.\".$order;\n            break;\n        default:\n            $sql=\"SELECT \";\n            $sql.= \" field_id \";\n            $sql.= \",name \";\n            $sql.=\" FROM\";\n            $sql.=\" {$_TABLES['DATABOX_def_field']} \";\n            $sql.=\" WHERE templatesetvar='\".$order.\"'\";\n\n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n\n            if ($numrows>0){\n                $A = DB_fetchArray ($result);\n                $field_id=COM_stripslashes($A['field_id']);\n                $addfield_name=COM_stripslashes($A['name']);\n                $orderby = \" t3.value IS NULL ASC ,cast(t3.value as DECIMAL) ASC \";\n                $addfieldorder=true;\n            }else{\n                $order=\"date\";\n                $orderby = $datefield .\" DESC\";\n            }\n    }\n\n    return ;\n\n}\n\n\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u96c6\u8a08\u8868\u793a(max min sum)\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_grp()\n// | \u66f8\u5f0f  databox_grp(1)\n// | \u66f8\u5f0f  databox_grp(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $field:\u9805\u76ee\u3000\u30c7\u30d5\u30a9\u30eb\u30c8modified\n// | \u5f15\u6570 $function:\u95a2\u6570\u3000\u30c7\u30d5\u30a9\u30eb\u30c8max\n// | \u5f15\u6570 $format:\u66f8\u5f0f\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n\nfunction databox_grp(\n    $field=null\n    ,$function=null\n    ,$format=null\n    ,$category_id =null\n    ,$category_code =null\n)\n{\n    global $_TABLES;\n    global $LANG_DATABOX;\n\n    $rt=\"\";\n\n    if (is_null($field) ){\n        $field=\"id\";\n    }\n    if (is_null($function) ){\n        $function=\"max\";\n    }\n\n    if (is_null($category_id) AND is_null($category_code) ){\n        $m=\"ALL\";\n    }else{\n        if (is_null($category_id) ){\n            $category_id=DATABOX_codetoid($category_code,'DATABOX_def_category',\"category_id\");\n        }\n        $m=\"CATEGORY\";\n    }\n    //-----\n    $tbl1=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['DATABOX_category'] ;\n\n    //-----\n    $sql=LB;\n    $sql .= \"SELECT \".LB;\n\n    $sql .= \" {$function}(t1.{$field}) AS rt\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@--------->\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND').LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@<---------\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" AND t1.id = t2.id \".LB;\n        $sql .= \" AND t2.category_id= \".$category_id .LB;\n    }\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n\n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n\n        $rt=$A['rt'];\n        if ($rt<>\"\"){\n            switch($format){\n                case \"lastmodified\":// '%Y\u5e74%m%e\u65e5\u66f4\u65b0';\n                case \"lastcreated\"://'%Y\u5e74%m%e\u65e5\u8ffd\u52a0';\n                    $fm=$LANG_DATABOX[$format];\n                    $rt=strftime($fm,strtotime($rt));\n                    break;\n                default:\n                    break;\n            }\n        }\n    }\n\n    return $rt;\n\n}\n\n\n\nfunction databox_data(\n    $id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$m=\"\"\n    ,$code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u500b\u5225\u30c7\u30fc\u30bf\u8868\u793a\n// | \u66f8\u5f0f  databox_data($id,$template,\"yes\",\"page\")\n// | \u66f8\u5f0f  databox_data($p['id'],$p['thtml'],$p['nohitmsg'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id            :\n// | \u5f15\u6570 $template      :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306edirectory\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $m             :\"page\"\u306e\u6642\u306f\u3000\u30ec\u30a4\u30a2\u30a6\u30c8\u8a2d\u5b9a\n// | \u5f15\u6570 $code          :\n// +---------------------------------------------------------------------------+\n// | public_html/data.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u76f4\u8fd1\u306b\u5909\u66f4\u307e\u305f\u306f\u8ffd\u52a0\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u8fd4\u3057\u307e\u3059\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:data\n// +---------------------------------------------------------------------------+\n{\n\n    $pi_name=\"databox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $_IMAGE_TYPE;\n    global $_USER;\n    global $LANG_ACCESS;\n    global $LANG_confignames;\n    global $_PLUGINS;\n    \n    $layout=$_DATABOX_CONF['layout'];\n    \n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >0) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n\n    }\n\n    //-----\n\n    if (is_null($id)  OR ($id==0)){\n        if ($code<>\"\"){\n            if (substr($code,0,4)===\"@fb_\"){\n                if (function_exists('assistfb_getNestAutotag')) {\n                    $code=assistfb_getNestAutotag(substr($code,4));\n                }\n            }    \n        }\n        if ($code<>\"\"){\n            $id=DATABOX_codetoid($code,'DATABOX_base',\"id\");\n        }\n    }\n\t\n    //-----\n    $display = '';\n\n    $tbl=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['users'] ;\n    $tbl4=$_TABLES['DATABOX_def_fieldset'];\n    $tbl5=$_TABLES['DATABOX_stats'];\n    \n    $addition_def=DATABOX_getadditiondef($pi_name);\n\n    //-----\n    $sql = \"SELECT t.* \";\n    \n    $sql .= \" ,UNIX_TIMESTAMP(t.modified) AS modified_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.released) AS released_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.comment_expire) AS comment_expire_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.expired) AS expired_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.created) AS created_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.udatetime) AS udatetime_un\";\n    \n    $sql .= \" ,t.fieldset_id\";\n    \n    $sql .= \" ,t2.username AS owner_name\";\n    $sql .= \" ,t3.username AS last_modify_name\";\n    $sql .= \" ,t3.fullname AS last_modify_fullname\";\n    \n    $sql .= \" ,t4.name AS set_name\";\n    $sql .= \" ,t4.description AS set_description\";\n    $sql .= \" ,t4.defaulttemplatesdirectory AS set_defaulttemplatesdirectory\";\n    $sql .= \" ,t4.layout AS set_layout\";\n    \n    $sql .= \" ,t5.hits\";\n    \n    $sql .= \" FROM \";\n    $sql .= \" {$tbl} AS t \";//base\n    $sql .= \" JOIN {$tbl4} AS t4       ON t.fieldset_id=t4.fieldset_id\";\n    $sql .= \" JOIN {$tbl2} AS t2       ON t.owner_id=t2.uid\";//owner\n    $sql .= \" LEFT JOIN {$tbl5} AS t5  ON t.id=t5.id\";\n    $sql .= \" LEFT JOIN  {$tbl2} AS t3 ON t.uuid=t3.uid\";//last_updateowner\n\n    $sql .= \" WHERE \";\n    if (is_null($id)){//@@@@@\n        $sql .= \"1=1\";\n    }else{\n        $sql .= \" t.id=\".$id;\n    }\n\n\n    //\u7ba1\u7406\u8005\u306e\u6642\n    if ( SEC_hasRights('databox.admin') OR $m===\"view\") {\n    }else{\n        //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND t.draft_flag=0\".LB;\n        //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (released <= NOW())\";\n        //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    \n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n    \n\n    if (is_null($id)){\n        $sql .= \" ORDER BY \".$_DATABOX_CONF['datefield'] . \" DESC \";\n        $sql .= \" LIMIT 0 , 1\";\n    }\n    \n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    \n    if  ($m===\"page\"  OR  $m===\"view\"){\n        if ($numrows <= 0) {\n            COM_handle404();\n            exit;\n        }\n    }\n\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\n        $cache_time=$A['cache_time'];\n        $cache=false;\n        if  ($cache_time===0){\n        }else{\n            if  ($m===\"page\"){\n                $cacheInstance = 'databox__' . $id .'__' . CACHE_security_hash();\n                $rt = CACHE_check_instance($cacheInstance.\"_title\");\n                if ($rt  AND $cache_time == -1) {\n                    $cache=true;\n                } elseif ($cache AND $cache_time > 0) {        \n                    $lu = CACHE_get_instance_update($cacheInstance.\"_title\");\n                    $now = time();\n                    if (($now - $lu) < $cache_time ){\n                         $cache=true;\n                    }\n                }\n            }\n        }\n        \n        \n        if  ($cache){\n            $display = CACHE_check_instance($cacheInstance.\"_display\",$display);\n            $layout = CACHE_check_instance($cacheInstance.\"_layout\",$layout);\n            $headercode = CACHE_check_instance($cacheInstance.\"_headercode\",$headercode);\n            $title = CACHE_check_instance($cacheInstance.\"_title\",$title);\n        }else{\n            if (is_null($template) or ($template===\"\")){\n                if ($A['defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['defaulttemplatesdirectory'];\n                }elseif  ($A['set_defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['set_defaulttemplatesdirectory'];\n                }else{\n                    $template=\"default\";\n                }\n            }\n\n            $code=$A['code'];\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n        \n            $fieldset_id= $A['fieldset_id'];\n            //\n            if ($m===\"view\"){    \n                $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n            }else{\n                $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            }\n\n            $id=$A['id'];\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n\n            //\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af start.............\n            if ($m===\"page\"){\n                if  ($A['set_layout']<>\"0\") {\n                    $layout=$A['set_layout'];\n                }\n                // Meta Tags\n                $headercode=DATABOX_getheadercode(    \n                    \"data\"\n                    ,$template\n                    ,$pi_name\n                    ,$A['id']\n                    ,$A['title']\n                    ,$A['meta_description']\n                    ,$A['meta_keywords']\n                    ,$A['description']\n                    ,$additionfields \n                    ,$addition_def \n                    ,$chk_user \n                    ,$fieldset_id \n                    );\n            \n                if  ($A['page_title']<>\"\"){\n                    $title = $A['page_title'] ;\n                }else{    \n                    $title = $A['title'] ;\n                }\n            }\n\n\n            $tmplfld=DATABOX_templatePath('data',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                    'list' => 'list_detail.thtml',\n                    'row'   => 'row.thtml',\n                    'col'   => \"col_detail.thtml\",\n                    ));\n        \n            $languageid=COM_getLanguageId();\n            $language= COM_getLanguage();\n            $templates->set_var ('languageid', $languageid);\n            $templates->set_var ('language', $language);\n            if ($languageid<>\"\") {\n                $templates->set_var ('_languageid', \"_\".$languageid);\n            }else{\n                $templates->set_var ('_languageid', \"\");\n            }\n        \n            $templates->set_var ('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var ('site_url',$_CONF['site_url']);\n            //\n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n        \n            $templates->set_var ('site_name', $_CONF['site_name']);\n            $templates->set_var ('site_mail', $_CONF['site_mail']);\n        \n            $currenturl= COM_getCurrentURL();\n            $templates->set_var ('currenturl', $currenturl);\n            //facebook\n            $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n            $templates->set_var ('facebook_consumer_key', $facebook_consumer_key);\n            //\n        \n            //daft_flag\u7ba1\u7406\u8005\u306e\u6642\n            if ($A['draft_flag']==1){\n                $templates->set_var ('draft', \"draft!\");\n            }else{\n                $templates->set_var ('draft', \"\");\n            }\n            //------------\n\n            //id\n            $templates->set_var('lang_id', $LANG_DATABOX_ADMIN['id']);\n            $templates->set_var ('id', $A['id']);\n\n            $templates->set_var('lang_fields', $LANG_DATABOX_ADMIN['fields']);\n            $templates->set_var('lang_field', $LANG_DATABOX_ADMIN['field']);\n            $templates->set_var('lang_templatesetvar', $LANG_DATABOX_ADMIN['templatesetvar']);\n            $templates->set_var('lang_content', $LANG_DATABOX_ADMIN['content']);\n            $templates->set_var('lang_type', $LANG_DATABOX_ADMIN['type']);\n            $templates->set_var('lang_byusingid', $LANG_DATABOX_ADMIN['byusingid']);\n            $templates->set_var('lang_byusingcode', $LANG_DATABOX_ADMIN['byusingcode']);\n            $templates->set_var('lang_byusingtemplatesetvar', $LANG_DATABOX_ADMIN['byusingtemplatesetvar']);\n            $templates->set_var('lang_group', $LANG_DATABOX_ADMIN['group']);\n            $templates->set_var('lang_withlink', $LANG_DATABOX_ADMIN['withlink']);\n            $templates->set_var('lang_groupbygroup', $LANG_DATABOX_ADMIN['groupbygroup']);\n        \n            //$_DATABOX_CONF\n            $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n            $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n            $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n            $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n            $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n            $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n            //\u57fa\u672c\u9805\u76ee\n            $templates->set_var('lang_basicfields', $LANG_DATABOX_ADMIN['basicfields']);\n            //\u30b3\u30fc\u30c9\uff06\u30bf\u30a4\u30c8\u30eb\uff06\u8aac\u660e\n            $templates->set_var('lang_code', $LANG_DATABOX_ADMIN['code']);\n            $templates->set_var ('code', $A['code']);\n            $templates->set_var('lang_title', $LANG_DATABOX_ADMIN['title']);\n            $templates->set_var ('title',$A['title']);\n            $templates->set_var('lang_description', $LANG_DATABOX_ADMIN['description']);\n            $templates->set_var ('description',$A['description']);\n\n            //@@@@@\n            $templates->set_var('lang_owner', $LANG_ACCESS['owner']);\n            $templates->set_var ('owner_name',$A['owner_name']);\n            $templates->set_var ('owner_id',$A['owner_id']);\n\n            //hits\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var ('hits', $A['hits']);\n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $templates->set_var('lang_additionfields', $LANG_DATABOX_ADMIN['additionfields']);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n\n            //\u7de8\u96c6\u65e5\u4ed8\n            $templates->set_var('lang_modified', $LANG_DATABOX_ADMIN['modified']);\n            $wary = COM_getUserDateTimeFormat($A['modified_un']);\n            $templates->set_var ('modified',$wary[0]);\n            $templates->set_var ('modified_shortdate', strftime( $_CONF['shortdate'], $A['modified_un'] ));\n            $templates->set_var ('modified_date', strftime( $_CONF['date'], $A['modified_un'] ));\n            $templates->set_var ('modified_daytime', strftime( $_CONF['daytime'], $A['modified_un'] ));\n            $templates->set_var ('modified_dateonly', strftime( $_CONF['dateonly'], $A['modified_un'] ));\n            $templates->set_var ('modified_timeonly', strftime( $_CONF['timeonly'], $A['modified_un'] ));\n            $templates->set_var ('modified_b', strftime( \"%b\" , $A['modified_un']));\n            $templates->set_var ('modified_B', strftime( \"%B\" , $A['modified_un']));\n            $templates->set_var ('modified_d', strftime( \"%d\" , $A['modified_un']));\n            $templates->set_var ('modified_e', strftime( \"%e\" , $A['modified_un']));\n            //\u4f5c\u6210\u65e5\u4ed8\n            $templates->set_var('lang_created', $LANG_DATABOX_ADMIN['created']);\n            $wary = COM_getUserDateTimeFormat($A['created_un']);\n            $templates->set_var ('created', $wary[0]);\n            $templates->set_var ('created_shortdate', strftime( $_CONF['shortdate'], $A['created_un'] ));\n            $templates->set_var ('created_date', strftime( $_CONF['date'], $A['created_un'] ));\n            $templates->set_var ('created_daytime', strftime( $_CONF['daytime'], $A['created_un'] ));\n            $templates->set_var ('created_dateonly', strftime( $_CONF['dateonly'], $A['created_un'] ));\n            $templates->set_var ('created_timeonly', strftime( $_CONF['timeonly'], $A['created_un'] ));\n            $templates->set_var ('created_b', strftime( \"%b\" , $A['created_un']));\n            $templates->set_var ('created_B', strftime( \"%B\" , $A['created_un']));\n            $templates->set_var ('created_d', strftime( \"%d\" , $A['created_un']));\n            $templates->set_var ('created_e', strftime( \"%e\" , $A['created_un']));\n            //\u516c\u958b\u65e5\n            $templates->set_var('lang_released', $LANG_DATABOX_ADMIN['released']);\n            $wary = COM_getUserDateTimeFormat($A['released_un']);\n            $templates->set_var ('released', $wary[0]);\n            $templates->set_var ('released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('released_e', strftime( \"%e\" , $A['released_un']));\n            //\u516c\u958b\u7d42\u4e86\u65e5\n            $templates->set_var('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('expired', \"\");\n                $templates->set_var ('expired_shortdate', \"\" );\n                $templates->set_var ('expired_date', \"\" );\n                $templates->set_var ('expired_daytime', \"\" );\n                $templates->set_var ('expired_dateonly', \"\" );\n                $templates->set_var ('expired_timeonly', \"\" );\n                $templates->set_var ('expired_b', \"\" );\n                $templates->set_var ('expired_B', \"\" );\n                $templates->set_var ('expired_d', \"\" );\n                $templates->set_var ('expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('expired', $wary[0]);\n                $templates->set_var ('expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('expired_e', strftime( \"%e\" , $A['expired_un']));\n             }\n        \n            $templates->set_var ('lang_uuid', $LANG_DATABOX_ADMIN['uuid']);\n            $templates->set_var ('uuid', $uuid);\n        \n            $templates->set_var ('lang_udatetime', $LANG_DATABOX_ADMIN['udatetime']);\n            $wary = COM_getUserDateTimeFormat($A['udatetime_un']);\n            $templates->set_var ('udatetime', $wary[0]);\n            $templates->set_var ('last_modify_uid', $A['uuid']);\n        \n            $templates->set_var ('last_modify_name', $A['last_modify_name']);\n            $templates->set_var ('last_modify_fullname', $A['last_modify_fullname']);\n        \n            //maps plugin link\n            $mkid=\"\";\n            $marker=\"\";\n            if (in_array(\"maps\", $_PLUGINS)){\n                $mkid=DB_getItem($_TABLES['maps_markers'],\"mkid\",\"item_10='$code'\");\n                if (! empty($mkid)) {\n                    $sql = \"SELECT * FROM {$_TABLES['maps_markers']} WHERE mkid = {$mkid} LIMIT 1\";\n                    $res = DB_query($sql, 0);\n                    $AM = DB_fetchArray($res);\n                    if (!SEC_hasAccess2($AM)) {\n                    } else {\n                         $marker = MAPS_getMarkerDetail($AM['mid'], $mkid);\n                    }\n                }\n            }\n            $templates->set_var ('mkid', $mkid);\n            $templates->set_var ('marker', $marker);\n        \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ($m<>\"view\"){\n                if ( SEC_hasRights('databox.admin')) {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $A['title'].\" \".$LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                    $attr = array('class' => 'editlink', 'title' => $A['title'].\" \".$LANG_DATABOX_ADMIN['edit']);\n                    $url = $_CONF['site_admin_url'];\n                    $url .= '/plugins/databox/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                    $templates->set_var ('edit', $icon);\n                }else{\n                    $rt=databox_chk_loaddata($id);\n                    //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                    if ( $rt===\"OK\") {\n                        $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                        $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                        $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                        $attr = array('class' => 'editlink', 'title' => $A['title'].\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                        $url = $_CONF['site_url'];\n                        $url .= '/databox/mydata/data.php';\n                        $url .= '?mode=edit';\n                        $url .= '&amp;'.\"id={$id}\";\n\n                        $icon = '&nbsp;' ;\n                        $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                        $templates->set_var ('edit', $icon);\n                    }else{\n                        $templates->set_var ('edit', \"\");\n                    }\n                }\n            } \n            // Call to plugins to set template variables in the databox\n            PLG_templateSetVars( 'databox', $templates );\n\n            if (function_exists('databox_custom_templateSetVars')) {\n                databox_custom_templateSetVars(\"data\", $templates);\n            }\n        \n            //------------\n            $templates->parse ('output', 'list');\n\n            $databox_content = $templates->finish ($templates->get_var ('output'));\n            $display=$databox_content;\n\n            if ($A['draft_flag']!==1){\n                if (!SEC_hasRights('databox.admin')) {\n                    $id=$A['id'];\n                    $hits=DB_getItem($_TABLES['DATABOX_stats'],\"hits\",\"id={$id}\");\n                    if (empty($hits)) {\n                        $hits=0;\n                    }\n                    $fields.=\"id,hits \";\n                    $values.=\"$id,$hits + 1\";\n                    DB_save($_TABLES['DATABOX_stats'],$fields,$values);\n                }\n            }\n        } \n    }else{\n        $cache_time=0;\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('data',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n\n            $templates->parse ('output', 'list');\n            $databox_content = $templates->finish ($templates->get_var ('output'));\n            $display=$databox_content;\n        }\n    }\n    $display =PLG_replacetags ($display);\n    \n    if  (($cache_time > 0 OR $cache_time == -1)  AND  $m===\"page\" ){\n        CACHE_create_instance($cacheInstance.\"_display\", $display); \n        CACHE_create_instance($cacheInstance.\"_layout\", $layout); \n        CACHE_create_instance($cacheInstance.\"_headercode\", $headercode); \n        CACHE_create_instance($cacheInstance.\"_title\", $title); \n    }\n    \n    $retval['display']=$display;\n    $retval['layout']=$layout;\n    $retval['headercode']=$headercode;\n    $retval['title']=$title;\n    \n    return $retval;\n}\n\n//\nfunction databox_chk_loaddata(\n    $id\n){\n    $pi_name=\"databox\";\n\n    global $_TABLES;\n    global $LANG_DATABOX_ADMIN;\n\n\n    $rt=\"\";\n\n    $sql = \"SELECT \";\n    $sql .= \" id\";\n\n    $sql .= \" ,owner_id\";\n    $sql .= \" ,group_id\";\n    $sql .= \" ,perm_owner\";\n    $sql .= \" ,perm_group\";\n    $sql .= \" ,perm_members\";\n    $sql .= \" ,perm_anon\";\n\n    $sql .= \" FROM \";\n    $sql .= \" {$_TABLES['DATABOX_base']} AS t\";\n    $sql .= \" WHERE \";\n\n    $sql .= \" id=\".$id;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows>0){\n\n        $A = DB_fetchArray($result);\n\n        if (!isset($A['owner_id'])) {\n             $A['owner_id'] = 1;\n        }\n\n\n        $access = SEC_hasAccess(\n                            $A['owner_id']\n                            , $A['group_id']\n                            , $A['perm_owner']\n                            , $A['perm_group']\n                            , $A['perm_members']\n                            , $A['perm_anon']);\n        if ($access >2) {\n            $rt=\"OK\";\n        }else{\n            $rt=$LANG_DATABOX_ADMIN['err_permission_denied'];\n        }\n    }else{\n        $rt=$LANG_DATABOX_ADMIN['err_invalid'];\n    }\n\n\n    return $rt;\n}    \n//$rt=databox_createdatabycode(\"aaa\");\nfunction databox_createdatabycode(\n    $code\n    ,$title=\"\"\n){\n    $pi_name=\"databox\";\n\n    global $_TABLES;\n    global $LANG_DATABOX_ADMIN;\n    global $_DATABOX_CONF;\n    global $_USER;\n    \n    $rt=array();\n    $rt['st']=\"\";\n    $rt['id']=0;\n    \n    $id=DB_getItem($_TABLES['DATABOX_base'],\"id\",\"code='{$code}'\");\n    if ($id<>\"\"){\n        $rt['st']=\"ok\";\n        $rt['id']=$id;\n        return $rt;\n    };\n\n    if ($_DATABOX_CONF['allow_data_insert'] \n            OR SEC_hasRights('databox.submit')){\n    }else{\n         $rt['st']=$LANG_DATABOX_ADMIN['err_permission_denied'];\n         return $rt;\n    }\n\n    $uuid=$_USER['uid'];    \n    if ($uuid===\"\"){\n        $uuid=0;\n    }\n    $uid=$_USER['uid'];\n\n\n    $w=DB_getItem($_TABLES['DATABOX_base'],\"max(id)\",\"1=1\");\n    if ($w==\"\") {\n        $w=0;\n    }\n    $id=$w+1;\n    if  ($title==\"\"){\n        $title=$code;\n    }\n    $group_id =$_DATABOX_CONF['grp_id_default'];//@@@@@20110613\n\n    $array = array();\n    SEC_setDefaultPermissions($array, $_DATABOX_CONF['default_perm']);\n    $perm_owner = $array['perm_owner'];\n    $perm_group = $array['perm_group'];\n    $perm_anon = $array['perm_anon'];\n    $perm_members = $array['perm_members'];\n\n    $sql=LB;\n    $sql.=\"INSERT INTO {$_TABLES['DATABOX_base']} (\".LB;\n    $sql.=\" `id`,`owner_id`,`modified`,`created`,`released`\".LB;\n    $sql.=\" ,`uuid`\".LB;\n    $sql.=\" ,`group_id`,`perm_owner`,`perm_group`,`perm_anon`,`perm_members`\".LB;\n    $sql.=\" ,`code`,`title`\".LB;\n    $sql.=\")\".LB;\n\n    $sql .= \" VALUES (\".LB;\n    $sql .= \"'{$id}','{$uid}',NOW( ),NOW( ),NOW( )\".LB;\n    $sql.=\" ,\".$uuid .LB;\n    $sql.=\" ,\".$group_id.LB ;\n    $sql.=\" ,\".$perm_owner.LB ;\n    $sql.=\" ,\".$perm_group.LB ;\n    $sql.=\" ,\".$perm_anon.LB ;\n    $sql.=\" ,\".$perm_members.LB ;\n    $sql.=\" ,'{$code}','{$title}'\".LB ;\n    \n    $sql .= \")\";\n    DB_query ($sql);\n\n    //\u30ab\u30c6\u30b4\u30ea\n    //\u8ffd\u52a0\u9805\u76ee\n    $sql = \"SELECT \";\n    $sql .= \" field_id\";\n    $sql .= \" ,type\";\n    $sql .= \" ,selection\";\n\n    $sql .= \" FROM \";\n    $sql .= $_TABLES['DATABOX_def_field'];\n    $sql .= \" order by field_id \";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows > 0) {\n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n\n            $field_id=$A['field_id'];\n            $type=$A['type'];\n            $selection=$A['selection'];\n\n            $sql2=\"INSERT INTO \".$_TABLES['DATABOX_addition'].LB;\n            $sql2.=\" (`id`,`field_id`,`value`)\".LB;\n            $sql2.=\" VALUES (\";\n            $sql2.=\" \".$id;\n            $sql2.=\" ,\".$field_id;\n            //7 = '\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8';\n            //8 = '\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8';\n            if (($type==7 OR $type==8) AND ($selection<>\"\")){\n                $sql2.=\",'0' \";\n            }else{\n                $sql2.=\",'' \";\n            }\n            $sql2.=\" )\";\n\n            DB_query($sql2);\n        }\n\n    }\n\n\n    $rt['st']=\"created\";\n    $rt['id']=$id;\n        \n    return $rt;\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740data\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f databox_newlist                                                      |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $m             :\u7701\u7565\u6642'ALL' id=id\u6307\u5b9a\u3067\u9078\u629e code\u6307\u5b9a\u3067\u9078\u629e           |\n// | \u5f15\u6570 $categories    :\u9078\u629e\u30c8\u30d4\u30c3\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or'ALL'                     |\n// | \u5f15\u6570 $rss_file      :RSS_file     \u7701\u7565\u6642\"\"                                |\n// | \u5f15\u6570 $title_trim_length :\u30bf\u30a4\u30c8\u30eb\u9577\u306e\u5236\u9650 \u7701\u7565\u6642\u8a2d\u5b9a\u5024or20                |\n// | \u5f15\u6570 $intervalday   :\u65b0\u7740\u8a18\u4e8b\u306e\u671f\u9593 \u5358\u4f4d\u65e5  \u7701\u7565\u6642\u8a2d\u5b9a\u5024or90              |\n// |                      0\u306e\u6642\u3000\u5168\u4ef6                                          |\n// | \u5f15\u6570 $limitcnt      :\u8868\u793a\u4ef6\u6570   \u7701\u7565\u6642\u8a2d\u5b9a\u5024or10                          |\n// | \u5f15\u6570 $newmarkday    :\u65b0\u7740\u30de\u30fc\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or3                           |\n// | \u5f15\u6570 $thtml         :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d5\u30a9\u30eb\u30c0  layout/\u30c6\u30fc\u30de/XXXX/  |\n// |                      \u7701\u7565\u6642\u306f\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u5185\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8                 |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u65b0\u7740data\u4e00\u89a7                                                   |\n// +---------------------------------------------------------------------------+\n// 2009/04/02\u3000\u5f15\u6570 $thtml\u8ffd\u52a0\n// 2009/04/02\u3000\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u5909\u6570 class \u8ffd\u52a0\n// 2009/04/02\u3000$intervalday=0\u306e\u6642\u5168\u4ef6\n// update20110128\nfunction databox_newlist(\n     $m=\"ALL\"\n    ,$categories=\"\"\n    ,$rss_file=\"\"\n    ,$title_trim_length=\"\"\n    ,$intervalday=\"\"\n    ,$limitcnt=\"\"\n    ,$newmarkday=\"\"\n    ,$thtml=null\n)\n{\n\n    $pi_name=\"databox\";\n\n    global $_USER;\n    global $_TABLES;\n    global $_CONF;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n\n    //\n    if ($title_trim_length==\"\"){\n        $title_trim_length=$_DATABOX_CONF['title_trim_length'];\n        if ($title_trim_length==\"\"){\n            $title_trim_length=20;\n        }\n    }\n    //\n    if ($intervalday==\"\"){\n        $intervalday=$_DATABOX_CONF['intervalday'];\n        if ($intervalday==\"\"){\n            $intervalday=90;\n        }\n    }\n    //\n    if ($limitcnt==\"\"){\n        $limitcnt=$_DATABOX_CONF['limitcnt'];\n        if ($limitcnt==\"\"){\n            $limitcnt=10;\n        }\n    }\n    if ($newmarkday==\"\"){\n        $newmarkday=$_DATABOX_CONF['newmarkday'];\n        if ($newmarkday==\"\"){\n            $newmarkday=3;\n        }\n    }\n\n    if ($m===\"\"){\n        $categories=\"ALL\";\n    }else{\n        if ($categories==\"\"){\n            $categories=$_DATABOX_CONF['categories'];\n            if ($categories==\"\"){\n                $categories=\"ALL\";\n            }\n        }elseif (strpos($categories,\",\")==\"\") {\n            $categories=\"'$categories'\";\n        }else{\n            $ary=explode(\",\",$categories);\n            $b=\"\";\n            for ($i = 1; $i <= count($ary); $i++) {\n                if ($m===\"code\"){\n                    $b.=\"'\".current($ary).\"',\";\n                }else{\n                    $b.=current($ary).\",\";\n                }\n                next($ary);\n            }\n            $categories=rtrim($b,\",\");\n        }\n    }\n\n    //\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $rss_img=$_DATABOX_CONF['rss_img'];\n    if ($rss_img==\"\") {\n        $rss_img=\"[RSS]\";\n    }\n\n    if (is_null($thtml)){\n        $thtml=\"default\";\n    }\n\n//-------------------------------------------\n    $retval=\"\";\n\n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath('newlist',$thtml,$pi_name);\n\n    $list = new Template($tmplfld);\n    $list->set_file (array (\n        'list' => 'list.thtml',\n        'col'   => 'list_col.thtml'\n    ));\n\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n\n    //-----\n    $tbl1=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['DATABOX_category'] ;\n    $tbl3=$_TABLES['DATABOX_def_category'] ;\n\n\n    $sql=\"SELECT \".LB;\n    $sql.=\" t1.title\".LB;\n    $sql.=\" , UNIX_TIMESTAMP(t1.\".$datefield .\") AS day\".LB;\n    $sql.=\" , t1.id\".LB;\n    $sql.=\" , t1.code\".LB;\n    $sql.=\" , t1.description\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    if ($categories!==\"ALL\" ){\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql.=\" WHERE\";\n    if ($categories===\"ALL\" ){\n        $sql.=\" 1=1\";\n    }else{\n        $sql.= \" t1.id = t2.id \".LB;\n        $sql.= \" AND t2.category_id = t3.category_id \".LB;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t1.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND').LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n\n    if ($intervalday<>0){\n        $sql.=\" AND (\".$datefield .\" >= (date_sub(NOW(), INTERVAL $intervalday day)))\".LB;\n    }\n\n    if ($categories!==\"ALL\" ){\n        if ($m===\"id\") {\n            $sql.=\" AND t2.category_id IN ($categories)\";\n        }else{\n            $sql.=\" AND t3.code IN ($categories)\";\n        }\n    }\n\n    $sql .= COM_getLangSQL ('code', 'AND', 't1').LB;\n\n    $sql.=\" ORDER BY \".$datefield .\" DESC\";\n    $sql.=\" LIMIT $limitcnt\";\n\n    $result = DB_query ($sql);\n\n    $i=0;\n\n    while( $A = DB_fetchArray( $result ) )    {\n        $A = array_map('stripslashes', $A);\n\n        $title= COM_truncate( $A['title'], $title_trim_length,'...' );\n        $description = $A['description'];\n        $id = $A['id'];\n        $code = $A['code'];\n\n        $rt= databox_detail_link($id,$code,$title);\n\n        $list->set_var ('site_url', $_CONF['site_url']);\n\n        $list->set_var ('day', strftime($LANG_DATABOX['day'],$A['day']));\n\n        $chkday=strtotime(\"- $newmarkday days\",time());\n        if (date(\"Ymd\",$A['day']) >= date(\"Ymd\",$chkday)){\n            $list->set_var ('new_img', $new_img);\n        }else{\n            $list->set_var ('new_img', '');\n        }\n        $list->set_var ('link', $rt['link']);//@@@@@\n\n        $list->set_var ('url', $rt['url']);\n        $list->set_var ('title', $title);\n\n        $list->set_var ('description', $description);\n\n        $n=($i%2)+1;\n        $class='class=\"row'.$n.'\"';\n        $list->set_var ('class', 'class=\"row'.$n.'\"');\n\n        //\u30ab\u30c6\u30b4\u30ea\n        DATABOX_getcategoriesDisp($A['id'],$list,$chk_user,0,$pi_name);\n\n        $list->parse ('list_col', 'col', true);\n\n        $i++;\n    }\n\n    $list->set_var ('site_url', $_CONF['site_url']);\n    $list->set_var ('day', strftime($LANG_DATABOX['day'],$A['day']));\n\n    //\n    if ($rss_file<>\"\"){\n        $list->set_var ('rss_url', $_CONF['site_url'] . '/backend/'.$rss_file);\n        $list->set_var ('rss_title', $rss_img);\n    }\n    //\n    $more_title=$LANG_DATABOX['more'];\n    if ($categories===\"ALL\" OR strpos($categories,\",\")<>\"\") {\n        $more_url=COM_buildUrl($_CONF['site_url'] . '/databox/index.php');//\n    }else{\n        //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n        if ($m=\"code\"){\n            $more_url.=\"m=code\";\n            $more_url.=\"&amp;code=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }else{\n            $more_url.=\"m=id\";\n            $more_url.=\"&amp;id=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }\n        $more_url=$_CONF['site_url'] . \"/databox/index.php\".$more_url;//@@@@@\n    }\n\n    $more_url = COM_buildUrl( $more_url );\n    $more_link= COM_createLink($title, $more_url);\n    $list->set_var ('more_url', $more_url);\n    $list->set_var ('more_title', $more_title);\n\n    $list->parse ('output', 'list');\n    $retval .= $list->finish ($list->get_var ('output'));\n\n\n    return $retval;\n}\n\n\n// | \u66f8\u5f0f databox_order ($url, $templates, $order)\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd ORDER\u6307\u5b9aLINK\u51fa\u529b\n// | \u66f8\u5f0f databox_order()\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $url:\n// | \u5f15\u6570 $templates\n// | \u5f15\u6570 $cur_order:\n// +---------------------------------------------------------------------------+\nfunction databox_order(\n    $url=\"\"\n    ,$templates\n    ,$cur_order=\"id\"\n\n)\n{\nglobal $LANG_DATABOX_ORDER;\nglobal $_TABLES;\n\n    $templates->set_var('cur_order',$cur_order);\n\n\n    $order_ary=array();\n    $order_ary[]='random';\n    $order_ary[]='date';\n    $order_ary[]='orderno';\n    $order_ary[]='code';\n    $order_ary[]='title';\n    $order_ary[]='description';\n    $order_ary[]='id';\n    $order_ary[]='released';\n\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",templatesetvar\";\n    $sql.=\" FROM\";\n    $sql.=\" {$_TABLES['DATABOX_def_field']} \";\n    $sql.=\" where allow_display=0\";\n\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $addfield_ary=array();\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=COM_stripslashes($A['field_id']);\n        $addfield_ary[$field_id]['name']=COM_stripslashes($A['name']);\n        $addfield_ary[$field_id]['templatesetvar']=COM_stripslashes($A['templatesetvar']);\n        $order_ary[]=\"addfield\".$field_id;\n    }\n\n    for ($i = 1; $i <= count($order_ary); $i++) {\n        $c=current($order_ary);\n\n        if (substr($c,0,8)===\"addfield\"){\n            $field_id=substr($c,8);\n            $order=$addfield_ary[$field_id]['templatesetvar'];\n            $order_name=$addfield_ary[$field_id]['name'];\n            $order_name.=$LANG_DATABOX_ORDER['order'];\n        }else{\n            $order=$c;\n            $order_name=$LANG_DATABOX_ORDER[$c];\n        }\n\n        $order_url=$url;\n        $order_url.=$order;\n        //$order_url = COM_buildUrl( $order_url );\n        $rt= COM_createLink($order_name, $order_url);\n\n        $templates->set_var('order_'.$order,$rt);\n\n        next($order_ary);\n    }\n\n\n    return ;\n\n\n}\n\nfunction databox_datalink(\n    $id\n    ,$code\n    ,$linktext\n)\n{\n    global $_CONF;\n    global $_TABLES;\n    \n    $url=\"\";\n    if ($id<>\"\") {\n        $url=$_CONF['site_url'].\"/databox/data.php?\";\n        $url.=\"m=id&amp;id=\".$id;\n        if  ($linktext==\"\"){\n            $linktext = stripslashes(DB_getItem($_TABLES['DATABOX_base'],'title', \"id = '$id'\"));\n        }\n    }else if ($code<>\"\"){\n        $code=DATABOX_swichlang($code);\n        $url=$_CONF['site_url'].\"/databox/data.php?\";\n        $url.=\"code=\".$code;\n        $url.=\"&amp;m=code\";\n        if  ($linktext==\"\"){\n            $linktext = stripslashes(DB_getItem($_TABLES['DATABOX_base'],'title', \"code = '$code'\"));\n        }\n    }\n    if  ($url<>\"\"){\n        $url = COM_buildUrl($url);\n        $url = COM_createLink($linktext, $url);\n    }\n    return $url;\n}\n\nfunction databox_mydataentrylink(\n    $fieldset_id = \"\"\n    ,$templatedir =\"\"\n    ,$linktext =\"\"\n)\n{\n    global $_CONF;\n    global $_TABLES;\n    global $LANG_DATABOX_ADMIN;\n    global $_DATABOX_CONF;\n    \n    $url=\"\";\n    //\u30e6\u30fc\u30b6\u306b\u66f4\u65b0\u3068\u65b0\u898f\u767b\u9332\u3092\u8a31\u53ef\u3059\u308b\u304b\u307e\u305f\u306f\u3001\u65b0\u898f\u767b\u9332\u6a29\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u306e\u5834\u5408\n    if ($_DATABOX_CONF['allow_data_update'] AND $_DATABOX_CONF['allow_data_insert'] OR\n        SEC_hasRights('databox.submit')){\n        if ($fieldset_id==\"\" OR $fieldset_id==0) {\n            $url=$_CONF['site_url'].\"/databox/mydata/data.php?\";\n            $url.=\"mode=new\";\n            if  ($templatedir){\n                $url.=\"&amp;template=\".$templatedir;\n            }\n            if  ($linktext==\"\"){\n                $linktext = $LANG_DATABOX_ADMIN[\"new\"];\n            }\n        }else{\n            if (DB_getItem($_TABLES['DATABOX_def_fieldset'],'fieldset_id', \"fieldset_id = '$fieldset_id'\")==$fieldset_id){\n                $url=$_CONF['site_url'].\"/databox/mydata/data.php?\";\n                $url.=\"type_id=\".$fieldset_id;\n                if  ($templatedir){\n                    $url.=\"&amp;template=\".$templatedir;\n                }\n                if  ($linktext==\"\"){\n                    $linktext = stripslashes(DB_getItem($_TABLES['DATABOX_def_fieldset'],'name', \"fieldset_id = '$fieldset_id'\"));\n                }\n            }\n        }\n        $url = COM_createLink($linktext, $url);\n    }\n    return $url;\n}\nfunction databox_mydata(\n    $templatedir =\"\"\n    ,$linktext =\"\"\n)\n{\n    global $_CONF;\n    global $_TABLES;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    $url=\"\";\n    //\u30e6\u30fc\u30b6\u306b\u66f4\u65b0\u3092\u8a31\u53ef\u3059\u308b\u304b\u307e\u305f\u306f\u3001\u66f4\u65b0\u6a29\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u306e\u5834\u5408\n    if ($_DATABOX_CONF['allow_data_update'] OR SEC_hasRights('databox.edit')){\n        $url=$_CONF['site_url'].\"/databox/mydata/data.php?\";\n        if  ($templatedir){\n            $url.=\"&amp;template=\".$templatedir;\n        }\n        if  ($linktext==\"\"){\n            $linktext = $LANG_DATABOX['mydata'];\n        }\n        $url = COM_createLink($linktext, $url);\n    }\n    return $url;\n}\nfunction databox_Comment(\n    $id\n    ,$code\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u30b3\u30e1\u30f3\u30c8\u8868\u793a\n// | \u66f8\u5f0f databox_Comment($id,$code)\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n    //    \n    $order = '';\n    if (isset ($_REQUEST['order'])) {\n        $order = COM_applyFilter ($_REQUEST['order']);\n    }\n    $mode = '';\n    if (isset ($_REQUEST['mode'])) {\n        $mode = COM_applyFilter ($_POST['mode']);\n    }\n    \n    $page = 1;\n    if (isset ($_REQUEST['cpage'])) {\n        $page = COM_applyFilter ($_REQUEST['cpage']);\n    }\n    //\n    \n    $tbl=$_TABLES['DATABOX_base'] ;\n\n    //-----\n    $sql = \"SELECT \";\n    \n    $sql .= \"commentcode \"; \n    $sql .= \",owner_id\";\n    $sql .= \",group_id\";\n    $sql .= \",perm_owner\";\n    $sql .= \",perm_group\";\n    $sql .= \",perm_members\";\n    $sql .= \",perm_anon\";\n    $sql .= \",title\";\n    $sql .= \",id\";\n\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl} AS t \";//base\n    $sql .= \" WHERE \";\n    if   ($id<>0) {\n        $sql .= \" id=\".$id;\n    }else{\n        $sql .= \" code='\".$code.\"'\";\n    }\n    $sql .= \" AND t.draft_flag=0\".LB;\n    \n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\";\n\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    //\n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    \n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n        if  ($A['commentcode']>=0){\n            $delete_option = (SEC_hasRights('databox.edit') &&\n                    SEC_hasAccess($A['owner_id'], $A['group_id'],\n                    $A['perm_owner'], $A['perm_group'], $A['perm_members'],\n                    $A['perm_anon']) == 3 ? true : false);\n    \n            require_once $_CONF['path_system'] . 'lib-comment.php';\n            $retval .= CMT_userComments(\n                            $A['id']\n                            , $A['title']\n                            , 'databox'\n                            , $order\n                            , $mode\n                            , 0\n                            , $page\n                            , false\n                            , $delete_option\n                            , $A['commentcode']\n                            );\n        }\n    }\n    \n\n    return $retval;\n}\n\nfunction databox_detail_link(\n    $id\n    ,$code\n    ,$title\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u500b\u5225\u30c7\u30fc\u30bflink\n// | \u66f8\u5f0f  databox_detail_link($id,$code,$title);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id            :\n// | \u5f15\u6570 $code          :\n// | \u5f15\u6570 $title         :\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:$return['link'] $return['url']\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_DATABOX_CONF;\n    \n    $return['link']=\"\" ;\n    $return['url']=\"\" ;\n    \n    if  ($id==0  AND $code==\"\"){\n        return $return;\n    }\n    if  ($_DATABOX_CONF['detail']==\"\"){\n        $prg=\"data.php\";\n    }else{\n        $prg=$_DATABOX_CONF['detail'];\n    }\n    \n    $url=$_CONF['site_url'] . \"/databox/\".$_DATABOX_CONF['detail'];\n    $url.=\"?\";\n    \n    if  ($prg==\"data.php\"){\n        if ($_DATABOX_CONF['datacode'] OR $id==0){\n            $url.=\"code=\".$code;\n            $url.=\"&amp;m=code\";\n        }else{\n            $url.=\"id=\".$id; \n            $url.=\"&amp;m=id\";\n        }\n    }else{\n        if  ($code<>\"\"){\n            $url.=\"code=\".$code;\n        }\n\t}\n    $return['url']=  COM_buildUrl( $url );\n    $return['link']= COM_createLink($title, $return['url']);\n    return $return;\n}\n\nfunction databox_search(\n    $autotag\n    ,$argary\n)\n{\n\n    $pi_name=\"databox\";\n    \n    global $_CONF;\n    global $_TABLES;\n    \n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n    global $_PLUGINS;\n    global $_MAPS_CONF;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >1) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n    }\n          \n          \n          \n    //-----\u30c6\u30fc\u30d6\u30eb\n    $tbl1=$_TABLES['DATABOX_category'] ;\n    $tbl2=$_TABLES['DATABOX_base'] ;\n    $tbl3=$_TABLES['DATABOX_addition'] ;\n    //\n    $tbl5=$_TABLES['DATABOX_def_category'] ;\n    \n    $tbl6=$_TABLES['DATABOX_stats'];\n    $tbl7=$_TABLES['DATABOX_def_fieldset'];\n\n    //\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\u3001\u516c\u958b\u65e5\uff09\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_DATABOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n    \n    //-----Argument checking\u3000\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    $arg_sv=\"\";//---Argument save \u5f15\u6570\u9000\u907f\u3000order page \u3092\u9664\u304f\n    foreach((array)$argary as $key => $value) {\n        if (is_array($value)){\n            $ary=$value;\n            foreach($ary as $key2 => $value2){\n                if  ($arg_sv<>\"\"){\n                    $arg_sv.=\"&amp;\";\n                }\n                $arg_sv.=$key.\"[]=\".$value2;\n            }\n        }else{\n            if  ($key==\"order\"  OR $key==\"page\"){\n            }else{\n                if  ($arg_sv<>\"\"){\n                    $arg_sv.=\"&amp;\";\n                }\n                $arg_sv.=$key.\"=\".$value;\n            }\n        }\n    }\n    if  ($argary['fieldset_id']==\"\"){\n        $argary['fieldset_id']=0;\n    }\n    $fieldset_name=COM_applyFilter(DB_getItem( $tbl7 ,\"name\",\"fieldset_id={$argary['fieldset_id']}\"));\n\n    if ($argary['perpage']===0 OR is_null($argary['perpage'])){\n        $argary['perpage']=$_DATABOX_CONF['perpage'];\n    }\n    if ($argary['page']===0 OR is_null($argary['page'])){\n        $argary['page']=1;\n    }\n    if (is_null($argary['nohitmsg'])){\n        $argary['nohitmsg']=\"yes\";\n    }\n    if (is_null($argary['expired'])){\n        $argary['expired']=\"no\";\n    }\n    if (is_null($argary['order'])){\n        $argary['order']=\"date\";\n    }\n    //============\n    $cary=array();\n    $acnt=0;\n    $afield=array();\n    $afile=array();\n    $awhere=array();\n          \n    foreach((array)$argary as $key => $value) {\n        if (is_array($value)){\n            $k = explode ('_', $key);\n            $ids=\"\";\n            $ary=$value;\n            if  ($k[0]==\"gor\"){\n                foreach($ary as $key2 => $value2){\n                    $w= COM_applyFilter($value2);\n                    if  ($w<>\"\"){\n                        if ($ids<>\"\"){\n                            $ids.=\",\";\n                        }\n                        $ids.= COM_applyFilter($value2);\n                    }\n                }\n                if  ($ids<>\"\"){\n                    $cary[]= \"(t2.id IN (SELECT id FROM {$tbl1}\"\n                           .\" WHERE t2.id=id AND category_id IN ({$ids})) )\";\n                }\n            }else if ($k[0]==\"gand\"){\n                foreach($ary as $key2 => $value2){\n                    $w= COM_applyFilter($value2);\n                    if  ($w<>\"\"){\n                        if ($ids<>\"\"){\n                            $ids.=\" AND \";\n                        }\n                        $ids.= $w;\n                        $ids.= \" IN (SELECT category_id\";\n                        $ids.=\" FROM {$tbl1}  \";\n                        $ids.=\" WHERE t2.id = id )\";\n                    }\n                }\n                if  ($ids<>\"\"){\n                    $cary[]= \" (\" .$ids.\" ) \";\n                }\n            }else if ($k[0]==\"ams\"){\n                foreach($ary as $key2 => $value2){\n                    $w= COM_applyFilter($value2);\n                    if  ($w<>\"\"){\n                        if ($ids<>\"\"){\n                            $ids.=\",\";\n                        }\n                        $ids.= COM_applyFilter($value2);\n                    }\n                }\n                if  ($ids<>\"\"){\n                    $dummy= databox_searchfield($k[0],COM_applyFilter($k[1]),$ids,$acnt,$afield,$afile,$awhere);\n                }\n            }\n        }else if  ( substr($key,0,3)==\"aeq\" OR substr($key,0,3)==\"afr\" \n                              OR substr($key,0,3)==\"ato\" OR substr($key,0,1)==\"a\") {\n            $k = explode ('_', $key);\n\n            if  ($value<>\"\"){\n                $dummy= databox_searchfield($k[0],COM_applyFilter($k[1]),$value,$acnt,$afield,$afile,$awhere);\n            }\n        }\n    }\n\n    $dummy=databox_orderby($datefield,$argary['order'],$orderby,$addfieldorder,$field_id);\n\n    //-----\n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.title \".LB;\n    $sql .= \" ,t2.code \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.fieldset_id \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\".LB;\n    $sql .= \" ,t2.owner_id\".LB;\n          \n    if  ($acnt>0){\n        for ($i = 1; $i <= $acnt; $i++) {\n             $sql .= $afield[$i].LB;\n        }\n    }\n          \n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n    \n    //--FROM\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n          \n    if  ($acnt>0){\n        for ($i = 1; $i <= $acnt; $i++) {\n             $sql .= $afile[$i].LB;\n        }\n    }\n    \n    //--WHERE\n    $sql .= \" WHERE \".LB;\n                \n    //\u30bf\u30a4\u30d7\n    $sql .= \" t2.fieldset_id=\".$argary['fieldset_id'].LB;\n          //additionfield \u8ffd\u52a0\u9805\u76ee\u3067sort \u3059\u308b\u6642\n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$field_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n\n    //\u6761\u4ef6\n    if  ($argary['teq']<>\"\"){\n        $sql .= \" AND (title=\".\"'\".$argary['teq'].\"')\".LB;\n    }\n    if  ($argary['t']<>\"\"){\n        $sql .= \" AND (title LIKE '%\".$argary['t'].\"%')\".LB;\n    }\n    foreach((array)$cary as $value) {\n        $sql .= \" AND \".$value.LB;\n    }\n    if  ($acnt>0){\n        for ($i = 1; $i <= $acnt; $i++) {\n            $sql .= \" AND \".$awhere[$i].LB;\n        }\n    }\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u3092\u9664\u304f\n    $sql .= \" AND t2.draft_flag=0\".LB;\n\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    if  (strtoupper($argary['expired'])==\"NO\"){\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    //--ORDER\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n\n//echo \"sql=\".$sql.\"<br>\";    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($argary['perpage'] > 0) {\n        $pages = ceil($cnt / $argary['perpage']);\n    }\n    $offset = ($argary['page'] - 1) * $argary['perpage'];\n    $sql .= \" LIMIT $offset, \".$argary['perpage'];\n          \n          \n          \n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n\n        if ($argary['page'] > 1) {\n            $page_title = sprintf ('%s (%d)', $LANG_DATABOX_ADMIN['piname'], $argary['page']);\n        } else {\n            $page_title = sprintf ('%s ', $LANG_DATABOX_ADMIN['piname']);\n        }\n        // Meta Tags\n        $title=$_CONF['site_name'] .\"-\". $fieldset_name;//og_title\n        $description=$_CONF['meta_description'];//og_description\n        $keywords=$_CONF['meta_keywords'];//og_description\n        //meta \n        $headercode=DATABOX_getheadercode(          \n           \"search\"\n            ,$argary['templatedir']\n            ,$pi_name\n            ,\"\"\n            ,$title\n            ,$description\n            ,$keywords\n            ,$description\n            ,\"\"\n            ,\"\"\n            ,\"\"\n            ,$argary['fieldset_id']\n            ,$fieldset_name\n                    );\n          }\n          \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n\n    if ($numrows > 0) {\n        $tmplfld=DATABOX_templatePath('search',$argary['templatedir'],$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'arg'   => 'argument.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            ));\n        \n        $dummy=databox_searchargedit($argary,$templates);\n        \n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n\n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_DATABOX['home']);\n        \n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$argary['perpage'] - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_DATABOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        //\n        $templates->set_var ('lang_title', $LANG_DATABOX_ADMIN['title']);\n        $templates->set_var ('lang_code', $LANG_DATABOX_ADMIN['code']);\n        $templates->set_var ('lang_id', $LANG_DATABOX_ADMIN['id']);\n        $templates->set_var ('lang_description', $LANG_DATABOX_ADMIN['description']);\n        $templates->set_var ('lang_date', $LANG_DATABOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_DATABOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        // \u8ffd\u52a0\u9805\u76ee\u306e\u30d8\u30c3\u30c0\n        $addition_def=DATABOX_getadditiondef($pi_name);\n        \n        //\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n        $referer =$_SERVER['HTTP_REFERER'];\n        $templates->set_var ('referer', $referer);\n        $templates->set_var ('lang_referer',$LANG_DATABOX['return']);\n        $templates->set_var ('fieldset_name',$fieldset_name);\n        $mkids=\"\";\n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $title=$A['title'];\n            $description=$A['description'];\n            $code=COM_applyFilter($A['code']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n\n            \n            $value=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n\n            $url=$_CONF['site_url'] . \"/databox/data.php\";\n            $url.=\"?\";\n            //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n            if ($_DATABOX_CONF['datacode']){\n                $url.=\"code=\".$code;\n                $url.=\"&amp;m=code\";\n            }else{\n                $url.=\"id=\".$id;\n                $url.=\"&amp;m=id\";\n            }\n            $url = COM_buildUrl( $url );\n            $link= COM_createLink($title, $url);\n\n            $templates->set_var ('data_link', $link);\n            $templates->set_var ('data_title', $title);\n            $templates->set_var ('data_code', $code);\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $url);\n\n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $value);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_date', strftime( $_CONF['date'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_daytime', strftime( $_CONF['daytime'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_dateonly', strftime( $_CONF['dateonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_timeonly', strftime( $_CONF['timeonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_b', strftime( \"%b\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_B', strftime( \"%B\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_d', strftime( \"%d\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_e', strftime( \"%e\" , $A['datefield_un']));\n            \n            $templates->set_var ('data_released', $released_ary[0]);\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            $hits=COM_applyFilter(DB_getItem( $tbl6 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            \n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/databox/data.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/mydata/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n             }\n             //maps plugin link\n             $mkid=\"\";\n             if (in_array(\"maps\", $_PLUGINS)){\n                 if ($code<>\"\"){\n                     $mkid=DB_getItem($_TABLES['maps_markers'],\"mkid\",\"item_10='$code'\");\n                     if  ($mkid<>\"\"){\n                         $mkids.=$mkid.\" \";\n                     }\n                 }\n             }\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        $mkids=rtrim($mkids,\" \");\n        $mkidary=array();\n        $mkid_ary=split(\" \" , $mkids);\n        $selectedMarkers=\"\";\n        if (function_exists(\"MAPS_selectedMarkers\") AND $mkids<>\"\") {\n            $selectedMarkers=MAPS_selectedMarkers(\n              $_MAPS_CONF['map_width']\n             ,$_MAPS_CONF['map_height']\n             ,$_MAPS_CONF['map_zoom']\n             ,$mkid_ary);\n        }\n        $templates->set_var ('mkids', $mkids);\n        $templates->set_var ('selectedMarkers', $selectedMarkers);\n\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'databox', $templates );\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        $url.=THIS_SCRIPT;\n        $url.=\"?\";\n        $url.=$arg_sv;\n        $url .= \"&amp;order=\";\n        //-----order navigation\n        $dummy=databox_order ($url, $templates, $argary['order']) ;\n        //-----page navigation\n        $url .= $argary['order'];\n        $templates->set_var ('page_navigation',\n        COM_printPageNavigation ($url,$argary['page'], $pages));\n        $templates->set_var ( 'pagenavinone', '' );\n        //------------\n        $templates->parse ('arg_var', 'arg', true);\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n\n    }else{\n        if ($argary['nohitmsg']===\"yes\"){\n            $tmplfld=DATABOX_templatePath('search',$argary['templatedir'],$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n                'arg'   => 'argument.thtml',\n            ));\n\n            $dummy=databox_searchargedit($argary,$templates);\n            \n            $templates->set_var ('home',$LANG_DATABOX['home']);\n            $referer =$_SERVER['HTTP_REFERER'];\n            $templates->set_var ('referer', $referer);\n            $templates->set_var ('lang_referer',$LANG_DATABOX['return']);\n            $templates->set_var ('fieldset_name',$fieldset_name);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n\n            $templates->parse ('arg_var', 'arg', true);\n            \n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n        }\n    }\n\n    if ($autotag===\"notautotag\"){\n\n        $retval[\"pagetitle\"] =$pagetitle;\n        $retval[\"headercode\"] =$headercode;\n        $retval[\"display\"] =PLG_replacetags ($content);\n          }else{\n        $retval=PLG_replacetags ($content);\n          }\n    return $retval;\n} \n\n\nfunction databox_searcharg(\n    $autotag\n    ,$arg\n)\n{\n    if ($autotag===\"notautotag\"){\n        foreach((array)$arg as $key => $value){\n            $key=COM_applyFilter($key);\n            if  ($key<>\"\"){\n                if  (is_array($value)  ) {\n                    foreach($value as $key2 => $value2){\n                       $argary[$key][]=COM_applyFilter($value2);\n                    }\n                }else{\n                    if  ($key==\"fieldset\") {\n                        $argary['fieldset_id']=COM_applyFilter($value);\n                    }\n                    $argary[$key]=COM_applyFilter($value);\n                }\n            }\n        }\n    }else{\n        $ary = explode ('&', $arg);\n        $argary = array();\n        foreach($ary as $key => $value){\n            $k = explode ('=', $value);\n            $k0= COM_applyFilter($k[0]);\n            $k1= COM_applyFilter($k[1]);\n            if  ($k0<>\"\"){\n                if  ($k0==\"fieldset\") {\n                    $argary['fieldset']=$k1;\n                    $argary['fieldset_id']=$k1;\n                }else if  ( substr($k0,0,3)==\"gor\" OR substr($k0,0,4)==\"gand\" OR substr($k0,0,3)==\"ams\" ) {\n                    $argary[$k0][]=$k1;\n                }else {\n                    $argary[$k0]=$k1;\n                }\n            }\n        }\n    }\n\n    return $argary;\n}\n\n\nfunction databox_searchfield(\n    $operate\n    ,$field_id\n    ,$value\n    ,&$acnt\n    ,&$afield\n    ,&$afile\n    ,&$awhere\n\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u306e\u6761\u4ef6 \u3092\u7de8\u96c6\n// | \u66f8\u5f0f  databox_searchfield($operate,$field_id,$value,$acnt,$afield,$afile,$awhere);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $operate\n// | \u5f15\u6570 $field_id\n// | \u5f15\u6570\u623b\u5024 $acnt\n// | \u5f15\u6570\u623b\u5024 $afield\n// | \u5f15\u6570\u623b\u5024 $afile\n// | \u5f15\u6570\u623b\u5024 $awhire\n// +---------------------------------------------------------------------------+\n\n{\n    global $_TABLES;\n          \n    $return=false;\n          \n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",type \";\n    $sql.=\" FROM\";\n    $sql.=\" {$_TABLES['DATABOX_def_field']} \";\n    $sql.=\" WHERE field_id=\".$field_id;\n    // \u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u307f\n    $sql.=\" AND allow_display='0'\";\n    if  ($operate==\"ams\"){\n        //9:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n        //16:\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n        //18:\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n        $sql.=\" AND type IN (9,16,18)\";\n    }else{\n        //0: \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        //1: \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        //20:HTML  10:TinyMCE 19:CKEditor\n        //15:\u6570\u5024  21:\u901a\u8ca8\n        $sql.=\" AND type IN (0,1,10,19,20,15,21)\";\n    }\n          \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows>0){\n       $A = DB_fetchArray ($result);\n       $acnt=$acnt+1;\n       $afield[$acnt]=\" ,a\".$acnt.\".value AS value\".$acnt;\n       $afile[$acnt]=\" ,{$_TABLES['DATABOX_addition']} AS a\".$acnt;\n       $w=\"a\".$acnt.\".field_id=\".$field_id;\n       $w.=\" AND a\".$acnt.\".id=t2.id\";\n       if  ($operate==\"aeq\"){\n           $w.=\" AND a\".$acnt.\".value='\".$value.\"'\";\n       }else if ($operate==\"a\"){\n            $w.=\" AND a\".$acnt.\".value LIKE '%\".$value.\"%'\";\n       }else if ($operate==\"afr\"){\n           if  ($A['type']==15  OR $A['type']==21){\n                $w.=\" AND (a\".$acnt.\".value + 0) >='\".$value.\"'\";\n           }else{\n                $w.=\" AND a\".$acnt.\".value>='\".$value.\"'\";\n           }\n       }else if ($operate==\"ato\"){\n           if  ($A['type']==15  OR $A['type']==21){\n               $w.=\" AND (a\".$acnt.\".value + 0) <='\".$value.\"'\";\n           }else{\n               $w.=\" AND a\".$acnt.\".value<='\".$value.\"'\";\n           }\n       }else if ($operate==\"ams\"){\n            $w.=\" AND a\".$acnt.\".value  IN  ({$value})\";\n       }\n       $awhere[$acnt]=$w;\n       $return=true;\n    }\n\n    return ;\n\n}\nfunction databox_searchargedit(\n    $arg\n    ,&$templates\n)\n{\n    global $LANG_DATABOX;\n    global $_CONF;\n    global $_TABLES;\n    \n    $rt=\"\";\n    $templates->set_var ('site_url',$_CONF['site_url']);\n    $templates->set_var ('this_script',THIS_SCRIPT);\n    $templates->set_var (\"lang_search\",$LANG_DATABOX['search']);\n    foreach((array)$arg as $key => $value) {\n        if (is_array($value)){\n            $k = explode ('_', $key);\n            $ary=$value;\n            if  ($k[0]==\"gor\"  OR  $k[0]==\"gand\"){\n                $wnames=\"\";\n                foreach($ary as $key2 => $value2){\n                    $key2p1=$key2+1;\n                    $w= COM_applyFilter($value2);\n                    $ary[$key2]=$w;\n                    $templates->set_var ($key.\"_\".$key2p1.\"_id\",$w);\n                    if  ($w<>\"\"){\n                        $wname=COM_applyFilter(\n                        DB_getItem($_TABLES['DATABOX_def_category'] \n                            ,\"name\",\"category_id={$w}\"));\n                            $wnames.=$wname.\" \";\n                    }else{\n                        $wname=\"\";\n                    }\n                    $templates->set_var ($key.\"_\".$key2p1.\"_name\",$wname);\n                }\n                $checklist=DATABOX_getcheckList (\"categorygroup\",$ary,\"databox\",$k[1],$key);\n                $templates->set_var ($key,$checklist);\n                $templates->set_var ($key.\"_names\",$wnames);\n            }else if  ($k[0]==\"ams\" ){\n                $kind=COM_applyFilter(\n                DB_getItem($_TABLES['DATABOX_def_field'] \n                     ,\"selectlist\",\"field_id={$k[1]}\"));\n                $wnames=\"\";\n                foreach($ary as $key2 => $value2){\n                    $key2p1=$key2+1;\n                    $w= COM_applyFilter($value2);\n                    $ary[$key2]=$w;\n                    $templates->set_var ($key.\"_\".$key2p1.\"_no\",$w);\n                    if  ($w<>\"\"){\n                         $wname=COM_applyFilter(\n                         DB_getItem($_TABLES['DATABOX_mst'] \n                             ,\"value\",\"kind='{$kind}' AND no={$w}\"));\n                                                            $wnames.=$wname.\" \";\n                     }else{\n                         $wname=\"\";\n                     }\n                     $templates->set_var ($key.\"_\".$key2p1.\"_name\",$wname);\n                }\n                $checklist=DATABOX_getcheckList ($kind,$ary,\"databox\",$k[1],$key);\n                $templates->set_var ($key,$checklist);\n                $templates->set_var ($key.\"_names\",$wnames);\n            }\n        }else if ($value<>\"\"){\n            $w=COM_applyFilter($value);\n            $templates->set_var ($key,$w);\n        }\n    }\n\n    return ;\n}\n\n?>\n", "<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | DataBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | Box \u30b7\u30ea\u30fc\u30ba\u5171\u901a\n// +---------------------------------------------------------------------------+\n// $Id: plugins/databox/lib/databox_functions.inc\n//20100818 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n\nif (strpos ($_SERVER['PHP_SELF'], 'databox_functions.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n\n//==============================================================================\nfunction DATABOX_nl2br (\n    $text\n) \n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u6539\u884c\u3092BR\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_nl2br ($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text:\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6539\u884c\u3092BR\u306b\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u6539\u884c\u3092BR\u306b\u5909\u63db\"\n{\n    return PLG_replacetags ( str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '<br'.XHTML.'>', $text) );\n\n}\n\nfunction DATABOX_autolink (\n    $text\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd url\u3092\u30ea\u30f3\u30af\u5909\u63db\n// | \u66f8\u5f0f DATABOX_autolink($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text         :\u6587\u5b57\u5217                                                |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:url\u3092\u30ea\u30f3\u30af\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217                                       |\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u81ea\u52d5\u30ea\u30f3\u30af\u3092\n{\n    $patterns = array(\"/(https?|ftp)(:\\/\\/[[:alnum:]\\+\\$\\;\\?\\.%,!#~*\\/:@&=_-]+)/i\");\n    $replacements = array(\"<a href=\\\"\\\\1\\\\2\\\" target=\\\"_blank\\\">\\\\1\\\\2</a>\");\n    return preg_replace($patterns, $replacements, $text);\n}\n\nfunction DATABOX_codetoid(\n    $code\n    ,$table\n    ,$idname = \"id\"\n    ,$codename = \"code\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u3092id\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_codetoid($code,'DATABOX_base')\n// | \u66f8\u5f0f DATABOX_codetoid($code,'users',\"uid\",\"username\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $table\n// | \u5f15\u6570 $idname\n// | \u5f15\u6570 $codename\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:id\n// +---------------------------------------------------------------------------+\n//update20101125\n{\n    global $_TABLES;\n    $retval=DB_getItem( $_TABLES[$table]   ,$idname,$codename.\"='{$code}'\");\n    if (empty($retval)){\n        $retval=0;\n    }\n    return $retval;\n}\n\nfunction DATABOX_swichlang(\n\t$code\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u591a\u8a00\u8a9e\u5bfe\u5fdc\u5909\u63db\n// | \u66f8\u5f0f DATABOX_swichlang($code)\n// |      xxxx_(\u8a00\u8a9eid) \u591a\u8a00\u8a9e\u30e2\u30fc\u30c9\u306e\u6642\u306b\u5fc5\u8981\u304c\u3042\u308c\u3070\u8a00\u8a9eid\u3092\u73fe\u5728\u306e\u8a00\u8a9eid\u306b\u5909\u63db\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u5909\u63db\u5f8c\u306e\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n{\n    \n    global $_CONF;\n    $newlanguageid = COM_getLanguageId();\n    if  ($newlanguageid<>\"\"){\n        if  ($code<>\"\"){\n            $lang_len = strlen($newlanguageid);\n            $oldlanguageid=substr($code,-($lang_len));\n            if  (array_key_exists($oldlanguageid, $_CONF['language_files'])){\n                $code = substr_replace($code, $newlanguageid, -$lang_len);\n            }\n        }\n    }\n    return $code;\n}\n\n\nfunction DATABOX_templatePath (\n    $kind = 'data'\n    ,$template ='default'\n    ,$pi_name= 'databox'\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\u3092\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_templatePath('data','default','databox')\n// | \u66f8\u5f0f DATABOX_templatePath($kind,$template,$pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:'data' 'category' ''newlist' 'admin'\n// | \u5f15\u6570 $template:  'default'\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\n// +---------------------------------------------------------------------------+\n// 20101115\n{\n\n    global $_CONF;\n\n    if (is_null($template) OR ($template===\"\")){\n        $template=\"default\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    if ($kind===\"admin\"){\n        $conf_templates=$box_conf[\"templates_admin\"];\n    }else{\n        $conf_templates=$box_conf[\"templates\"];\n    }\n\n    //\"standard\";//\u6a19\u6e96\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"custom\";//\u30ab\u30b9\u30bf\u30e0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"theme\";//\u30c6\u30fc\u30de\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    if  ($conf_templates===\"theme\"){\n\n        $tmplfld=$_CONF['path_layout'] .$box_conf['themespath'].$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n        }\n        if (is_dir($tmplfld)) {\n\n        } else if ( SEC_hasRights($adminrights)) {\n\n            $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/templates/'.$kind;\n            if ($kind<>\"admin\"){\n                $tmplfld.=\"/default\";\n            }\n\n        } else {\n            COM_handle404();\n            exit;\n        }\n    }else if  ($conf_templates===\"custom\"){\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/custom/templates/'.$kind;\n\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n\n        }\n\n        if (is_dir($tmplfld)){\n\n        } else if ( SEC_hasRights($adminrights)) {\n            $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/templates/'.$kind;\n            if ($kind<>\"admin\"){\n\n                $tmplfld.=\"/default\";\n\n            }\n\n        }else{\n            COM_handle404();\n            exit;\n        }\n    }else{\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/templates/'.$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/default\";\n        }\n    }\n\n\n    return $tmplfld;\n}\n\nfunction DATABOX_siteHeader (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$page_title = ''\n    ,$headercode = ''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d8\u30c3\u30c0\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title,$headercode)\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $pagetitle:\n// | \u5f15\u6570 $headercode:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30d8\u30c3\u30c0\n// +---------------------------------------------------------------------------+\n// 20120910\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    $display=\"\";\n    \n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n            $display=COM_siteHeader ('menu', $page_title,$headercode);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'noblocks':\n            $display=COM_siteHeader ('none', $page_title,$headercode);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n\n\n    return $display;\n}\n\n\nfunction DATABOX_siteFooter (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$custom=''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30c3\u30bf\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name,'_admin',$custom)\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $custom:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 : \u30d5\u30c3\u30bf\n// +---------------------------------------------------------------------------+\n// 20110119\n{\n    global $_CONF;\n\n    if (is_null($pi_name)){\n        $pi_name=\"databox\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $display=\"\";\n\n    $layout=$box_conf['layout'.$kind];\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        $display .= COM_siteFooter(false,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n            $display .= COM_siteFooter(true,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        // \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u5e38\u6642\u8868\u793a\u3059\u308b\u8a2d\u5b9a\u3067\u3042\u3063\u3066\u3082\u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3055\u305b\u306a\u3044\n        case 'noblocks':\n            $_CONF['show_right_blocks']=0;\n            $_CONF['left_blocks_in_footer']=0;\n            $display .= COM_siteFooter(false,$custom);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n    return $display;\n}\n\n\n//$retval = SP_returnStaticpage($page, $display_mode, $comment_order, $comment_mode, $comment_page, $msg, $query);\n\nfunction DATABOX_displaypage (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$display = ''\n    ,$information = ''\n)\n//$information\n// 'what'  'none' no left blocks are returned\n//         'menu' (default)  right blocks are returned\n// 'pagetitle'     Optional content for the page's <title>\n// 'breadcrumbs'   Optional content for the page's <title>\n// 'headercode'    Optional code to go into the page's <head>\n// 'rightblock'    \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3059\u308b\u304b\u3069\u3046\u304b\u3000 default is no (-1)\n// 'custom'        An array defining custom function to be used to \n\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    \n    //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n    if  ($layout=='blankpage'){\n        \n    }else{\n        switch ($layout) {\n            // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n            case 'standard':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(false,$custom);\n                $information['what']='menu';\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n            case 'leftrightblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(true,$custom);\n                $information['what']='menu';\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'leftblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                $information['what']='menu';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'rightblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                //$display .= COM_siteFooter(true,$custom);\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'noblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n        }\n        \n        //FOR GL2.0.0 \n        if (COM_versionCompare(VERSION, \"2.0.0\",  '>=')){\n            $display = COM_createHTMLDocument($display,$information);\n        }else{\n            $display = COM_siteHeader ($information['what'], $information['pagetitle']).$display;\n            $display .= COM_siteFooter($information['rightblock']);\n        }\n    }\n\n\n    return $display;\n}\n\n\nfunction DATABOX_getcheckList(\n    $kind\n    ,$selected\n    ,$pi_name\n    ,$group_id=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcheckList($kind,$selected = \"\")\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name)\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"categorygroup\",\"\",$pi_name,1,\"ch1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:fieldset\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox' \n// | \u5f15\u6570 $group_id\u3000\u30de\u30b9\u30bf\u30fc\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n// \u30ab\u30c6\u30b4\u30ea\u4ee5\u5916\u3067\u4f7f\u3063\u3066\u3044\u308b\u304b\u78ba\u8a8d\u306e\u3053\u3068 --> category \u306f DATABOX_getcategoriesinp\n//20140624 fieldset\u3000\u8ffd\u52a0\n{\nglobal $_TABLES;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n\n    $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n    $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    $table_def_fieldset=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n    $retval = '';\n    if ($kind==\"categorygroup\"){\n        $sql = \"SELECT \";\n        $sql .= \" m1.category_id\".LB;\n        $sql .= \",m1.name\".LB;\n        $sql .= \",m1.orderno\".LB;\n        $sql .= \",m2.group_id\".LB;\n        $sql .= \",m2.name AS group_name\".LB;\n        $sql .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql .= \" , {$table_def_group} AS m2\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m1.allow_display<2 \".LB;\n        $sql .= \" AND m1.categorygroup_id =\".$group_id.LB;\n        $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n        $sql .= \" ORDER BY m1.orderno\".LB;\n    }else if ($kind==\"fieldset\"){\n        $sql = \"SELECT \";\n        $sql .= \" fieldset_id\".LB;\n        $sql .= \",name\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_def_fieldset} \".LB;\n        $sql .= \" ORDER BY fieldset_id\".LB;\n    }else{\n        $sql = \"SELECT \".LB;\n        $sql .= \" no\".LB;\n        $sql .= \",value\".LB;\n        $sql .= \",orderno\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_mst}\".LB;\n        $sql .= \" WHERE kind='{$kind}'\".LB;\n        $sql .= \" ORDER BY orderno\".LB;\n    }\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    $old_group_id=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fname . '[]\" value=\"' . $A[0] ;\n        $retval .= '\"';\n        for( $x = 0; $x < sizeof( $S ); $x++ )            {\n            if( $A[0] == $S[$x] )                {\n                $retval .= ' checked=\"checked\"';\n            }\n        }\n        $retval .= '>' . stripslashes( $A[1] ) . '</span>' . LB;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getdatas(\n    $fld\n    ,$tbl\n    ,$where\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u8aad\u8fbc                                                      |\n// | \u66f8\u5f0f DATABOX_getdatas($fld,$tbl,$where)                                   |\n// | $rt=DATABOX_getdatas(                                                     |\n// |      \"category_id\",$_TABLES['DATABOX_category'],\"id=$id\");                |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $where:\u6761\u4ef6\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8907\u6570\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    $sql=\"SELECT {$fld} FROM {$tbl} WHERE {$where}\";\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $selected=\"\";\n    for ($i = 0; $i < $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $selected.= $A[$fld].\" \";\n    }\n    $selcted=rtrim($selected,\" \");\n    return $selected;\n\n}\n\n\nfunction DATABOX_savedatas(\n    $fld\n    ,$tbl\n    ,$id\n    ,$fldary=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc\n// | \u66f8\u5f0f DATABOX_savedatas($fld,$tbl,$id,$fldary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    global $_TABLES;\n\n    $rt=DB_delete($tbl,\"id\",$id);\n\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$tbl} (\";\n            $sql.=\"id, {$fld}\";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id}, {$val}\";\n            $sql.=\")\";\n            DB_query($sql);\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\nfunction DATABOX_savecategorydatas(\n    $id\n    ,$fldary\n    ,$pi_name=\"\"\n    ,$mydata=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc(\u30ab\u30c6\u30b4\u30ea)\n// | \u66f8\u5f0f DATABOX_savecategorydatas($id,$category,'databox','mydata')\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update20100824\n{\n\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_category=$_TABLES['DATABOX_category'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\t\n\tif  ($mydata==\"\"){\n        $rt=DB_delete($table_category,\"id\",$id);\n\t}else{\n\t\t$categories=COM_applyFilter($_POST['categories']);\n\t\tif  ($categories==\"\" ){\n\t\t}else{\n            $categories=str_replace(\"|\", ',', $categories);\n\t\t    $sql=\"DELETE FROM {$table_category} WHERE \";\n\t        $sql .=\"  id = \".$id ;\n\t        $sql .=\"  AND category_id IN (\".$categories.\")\";\n\t\t    DB_query($sql);\n\t\t}\n\t}\n\t\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$table_category} (\".LB;\n            $sql.=\"id, category_id\".LB;\n            $sql.=\") VALUES (\".LB;\n            $sql.=\"{$id}, {$val}\".LB;\n            $sql.=\")\".LB;\n            DB_query($sql);\n            /////parent_id \u304c0\u306b\u306a\u308b\u307e\u3067insert\n            $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$val}\");\n            while ($parent_id<>0) {\n                $category_id=$parent_id;\n                $seq=DB_getItem( $table_category   ,\"seq\",\"id={$id} AND category_id={$category_id} \");\n                if (is_null($seq)) {\n                    $sql=\"INSERT INTO {$table_category} (\".LB;\n                    $sql.=\"id, category_id\".LB;\n                    $sql.=\") VALUES (\".LB;\n                    $sql.=\"{$id}, {$category_id}\".LB;\n                    $sql.=\")\".LB;\n                    DB_query($sql);\n                }\n                $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$category_id}\");\n            }\n            /////\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\n//==============================================================================\nfunction DATABOX_chkuser(\n        $group_id\n        ,$owner_id\n        ,$adminrights=\"databox.admin\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e6\u30fc\u30b6\u30c1\u30a7\u30c3\u30af\n// | \u66f8\u5f0f $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $group_id\n// | \u5f15\u6570 $owner_id\n// | \u5f15\u6570 $adminrights\u3000databox.admin\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024\n// |    0 guest\n// |   10 guest and allusers\n// | 1000 user\n// | 1010 group\u3000(owner \u542b\u3080)\n// | 1011 owner\n// | 1100 admin\n// | 1110 group and admin\n// | 1101 owner and admin\n// | 1111 group owner and admin\n// +---------------------------------------------------------------------------+\n//update20101004 group_id\n{\n    global $_USER;\n\n    $chk_user=0;\n    if (isset($_USER['uid']) && $_USER['uid'] > 1) {\n        $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n    }\n    if ( SEC_hasRights($adminrights)) {\n        $chk_user=$chk_user+100;//admin\n    }\n    //group \u306b\u5c5e\u3057\u3066\u3044\u308b\u4eba\n    $usergroups=SEC_getUserGroups();\n\n    if ( in_array($group_id, $usergroups)){\n        $chk_user=$chk_user+10;//group\n    }\n\n    if ($owner_id===$_USER['uid']){\n        $chk_user=$chk_user+1;//owner\n    }\n\n    return $chk_user;\n}\n\n\n\nfunction DATABOX_getadditiondef(\n    $pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_def_field'];\n        $table2=$_TABLES['DATABOX_mst'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n        $table2=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n\n    $rt=array();\n\t$fieldgroupno_old=\"\";\n\t\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",description\";\n    $sql.= \",type\";\n    //$sql.= \",fieldgroup_id AS group_id\";\n    $sql.= \",selection\";\n    $sql.= \",selectlist\";\n    $sql.= \",checkrequried\";\n    $sql.= \",size\";\n    $sql.= \",maxlength\";\n    $sql.= \",rows\";\n    $sql.= \",br\";\n    $sql.= \",templatesetvar\";\n\n    $sql.= \",allow_display\";\n    $sql.= \",allow_edit\";\n\n    $sql.= \",textcheck\";\n    $sql.= \",textconv\";\n    $sql.= \",searchtarget\";\n    \n    $sql.= \",initial_value\";\n    $sql.= \",range_start\";\n    $sql.= \",range_end\";\n    $sql.= \",dfid\";\n    $sql.= \",description2\";\n    $sql.= \",fieldgroupno\";\n\t\n    $sql.=\" FROM\";\n    $sql.=\" {$table}  AS m\";\n    $sql.= \" ORDER BY orderno,field_id\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $rt[$field_id]['name'] = COM_stripslashes($A['name']);\n        $rt[$field_id]['checkrequried'] = COM_stripslashes($A['checkrequried']);\n        $rt[$field_id]['description'] = COM_stripslashes($A['description']);\n        $rt[$field_id]['allow_display'] = COM_stripslashes($A['allow_display']);\n        $rt[$field_id]['allow_edit'] = COM_stripslashes($A['allow_edit']);\n        $rt[$field_id]['textcheck'] = COM_stripslashes($A['textcheck']);\n        $rt[$field_id]['textconv'] = COM_stripslashes($A['textconv']);\n        $rt[$field_id]['searchtarget'] = COM_stripslashes($A['searchtarget']);\n        \n        $rt[$field_id]['type'] = COM_stripslashes($A['type']);\n        //$rt[$field_id]['group_id'] = COM_stripslashes($A['group_id']);\n        $rt[$field_id]['selection'] = COM_stripslashes($A['selection']);\n\n        $rt[$field_id]['size'] = COM_stripslashes($A['size']);\n        if ($rt[$field_id]['size']==0){\n            $rt[$field_id]['size']=60;\n        }\n        $rt[$field_id]['maxlength'] = COM_stripslashes($A['maxlength']);\n        if ($rt[$field_id]['maxlength']==0){\n            $rt[$field_id]['maxlength']=160;\n        }\n\n        $rt[$field_id]['rows'] = COM_stripslashes($A['rows']);\n        if ($rt[$field_id]['rows']==0){\n            $rt[$field_id]['rows']=2;\n        }\n        $rt[$field_id]['br'] = COM_stripslashes($A['br']);\n\n        $rt[$field_id]['selectlist'] = COM_stripslashes($A['selectlist']);\n        $rt[$field_id]['templatesetvar'] = COM_stripslashes($A['templatesetvar']);\n\n        $selection= COM_stripslashes($A['selection']);\n        $rt[$field_id]['selectionary']=DATABOX_getselectionary($selection);\n\n        $rt[$field_id]['initial_value']= COM_stripslashes($A['initial_value']);\n        $rt[$field_id]['range_start']= COM_stripslashes($A['range_start']);\n        $rt[$field_id]['range_end']= COM_stripslashes($A['range_end']);\n        $dfid= COM_stripslashes($A['dfid']);\n        $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n        if( empty( $format )) {\n            $rt[$field_id]['format'] = $_CONF['date'];\n        }else{\n            $rt[$field_id]['format'] = $format;\n        }\n\n        $rt[$field_id]['description2']= COM_stripslashes($A['description2']);\n        $fieldgroupno=COM_stripslashes($A['fieldgroupno']);\n        if  ($fieldgroupno_old==$fieldgroupno){\n\t\t}else{\n            $fieldgroup_name=DB_getItem($table2,\"value\",\"kind='fieldgroup' AND no=\".$fieldgroupno);\n            $fieldgroupno_old=$fieldgroupno;\n        }\n        $rt[$field_id]['fieldgroup_name']=$fieldgroup_name;\n        $rt[$field_id]['fieldgroupno']= $fieldgroupno;\n\n    }\n    return $rt;\n\n}\nfunction DATABOX_getselectionary(\n    $selection\n)\n{\n    $selectionary=array();\n    $ary=array();\n    $ary=split(\"\\r\" , $selection);\n\n    $j=0;\n    for ($ii = 0; $ii < count($ary); $ii++) {\n        if ($ary[$ii]<>\"\"){\n            $selectionary[$j]=$ary[$ii];\n            $j=$j+1;\n        }\n    }\n    return $selectionary;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u691c\u7d22\u7528\u5f15\u6570\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getadditionsearchdef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 \u914d\u5217\n// |    $rt[\"sql1\"]: \",{$_TABLES['DATABOX_addition']} AS ad1\"\n// |    $rt[\"sql2\"]: \" AND t1.id=ad1.id AND ad1.field_id=1 \"\n// |    $rt[\"columns\"][]: 'ad1.value '\n// +---------------------------------------------------------------------------+\nfunction DATABOX_getadditionsearchdef(\n    $pi_name=\"\"\n)\n{\n    global $_TABLES;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    \n    if ($box_conf['additionsearch']==0){\n        return;\n    }\n    $lmt=$box_conf['additionsearch'];\n    \n    $retval=array();\n\n    $rt=array();\n    $sql3=\"\";\n    $columns=array();\n\n    $sql=LB;\n    $sql.=\"SELECT \";\n    $sql.= \" field_id \";\n    \n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n\n    // \u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u307f\n    $sql.=\" WHERE\";\n    $sql.=\" allow_display='0'\";\n    //0: \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //1: \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //20:HTML  10:TinyMCE 19:CKEditor\n    //15:\u6570\u5024  21:\u901a\u8ca8\n    $sql.=\" AND type IN (0,1,10,19,20,15,21)\";\n    \n    //\u691c\u7d22\u5bfe\u8c61\u306b\u3059\u308b=\u306f\u3044\n    $sql.=\" AND searchtarget='1'\";\n    \n    $sql.=\" ORDER  BY  orderno,field_id\";\n    $sql.=\" LIMIT 0 ,\".$lmt;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $type = COM_stripslashes($A['type']);\n        $selection= COM_stripslashes($A['selection']);\n        $selectionary=DATABOX_getselectionary($selection);\n\n        $columns[]= \"ad{$field_id}.value \";\n\n        $sql3 .= \" JOIN {$table_addition} AS ad{$field_id}\";\n        $sql3 .= \" ON t1.id=ad{$field_id}.id \";\n        $sql3 .= \" AND ad{$field_id}.field_id={$field_id} \".LB;\n        \n    }\n\n    $rt[\"sql3\"]=$sql3;\n    $rt[\"columns\"]=$columns;\n    \n    return $rt;\n\n}\n\n\n\nfunction DATABOX_getadditiondatas(\n    $id\n    ,$pi_name=\"\"\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondatas($id)\n// | $array=DATABOX_getaddtuindatas($id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u30ea\u30b9\u30c8                                                 |\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_addition=$_TABLES['DATABOX_addition'];\n        $table_def_field=$_TABLES['DATABOX_def_field'];\n    }else{\n        $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n        $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }\n\n    $rt=array();\n    \n    $sql=\"SELECT \";\n    $sql.=\" m.field_id\";\n    $sql.=\" ,m.fieldgroupno\";\n    if ($id==0){\n        $sql.=\",initial_value AS value  \";\n    }else{\n        $sql.=\", ( SELECT VALUE \";\n        $sql.=\" FROM\";\n        $sql.=\" {$table_addition}  AS t\";\n        $sql.=\" where\";\n        $sql.=\" t.id={$id}\";\n        $sql.=\" AND t.field_id=m.field_id\";\n        $sql.=\" ) AS value \";\n    }\n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n    $sql.=\" order by m.fieldgroupno,m.orderno ,m.field_id\";\n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=$A['field_id'];\n        $value=$A['value'];\n        $rt[$field_id]=COM_stripslashes($value);\n    }\n    return $rt;\n\n}\n\n\nfunction DATABOX_getaddtionfieldsEdit(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name=\"\"\n    ,$fields_fnm=\"\"\n    ,$fields_del=\"\"\n    ,$fieldset_id=0\n    ,$fields_date=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsEdit\n//          ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fields_fnm:\n// | \u5f15\u6570 $fields_del:\n// | \u5f15\u6570 $fieldset_id:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n// 20101206 \u65e5\u4ed8\n{\n    global $_TABLES;\n    global $_SCRIPTS;\n    global $_CONF;\n    global $MESSAGE;\n\t\n    if ($pi_name==\"\"){\n        $pi_name=\"databox\";\n    }\n    $lang_admin_x=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_admin;\n    global $$lang_noyes;\n    $lang_admin=$$lang_admin;\n    $lang_noyes=$$lang_noyes;\n    \n    $langCode = COM_getLangIso639Code();\n    $toolTip  = $MESSAGE[118];\n    $imgUrl   = $_CONF['site_url'] . '/images/calendar.png';\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n    $fieldgroup_old=\"\";\n    foreach( $S as $fid => $fvalue ){\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $description=$addition_def[$fid]['description'];\n        $description2=$addition_def[$fid]['description2'];\n        $fieldgroup_name=$addition_def[$fid]['fieldgroup_name'];\n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if (in_array($fid,$fieldsetfields )) {\n            \n            if ($chk_user===9999){\n                $chk=true;\n                $disabled=\"\";\n            }else{\n                //\u7de8\u96c6\u53ef\u80fd\n                if  ($addition_def[$fid]['allow_edit']==='0') {\n                    $chk=true;\n                    $disabled=\"\";\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n                }else if ($addition_def[$fid]['allow_edit']==='2'){\n                    if  ($chk_user>=1010) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='3'){\n                    if  ($chk_user>=1011) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='4'){\n                    $chk=true;\n                }\n            }\n        }\n    \n        if ($chk) {\n\n            $fieldhtml=\"\";\n            switch ($type) {\n                case 12:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml12\n                            ($fid,$fvalue,$fvalue_del,$size,$maxlength);\n                    break;\n                case 11:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml\n                            ($fid,$fvalue,$fvalue_del);\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_filehtml\n                            ($pi_name,$fid,$fvalue,$fvalue_del);\n                    break;\n\n\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                     if ($disabled===\"\"){\n                        $cntname=\"afieldcnt\".$fid;\n                        $fieldhtml .= \"<textarea \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"width:95%\\\"\";\n                        $fieldhtml .= \" rows=\\\"\".$rows.\"\\\"\";\n                        $fieldhtml .= \" id=\\\"DATABOX_afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" \".$disabled.\" \";\n                        $fieldhtml .= \" onKeyup=\\\"var n=\".$maxlength;\n                        $fieldhtml .=\"-this.value.length;var \";\n                        $fieldhtml .=\"s=document.getElementById\";\n                        $fieldhtml .=\"('\".$cntname.\"');s.innerHTML='('+n+')';\\\"\";\n                        if  ($type==20){\n                            $fieldhtml .= \" class=\\\"tinymce_enabled\\\"\";\n                        }\n                        if  ($type==19){\n                            $fieldhtml .= \" class=\\\"wide\\\"\";\n                        }\n                        $fieldhtml .= \">\";\n                        $fieldhtml .= $fvalue;\n                        $fieldhtml .= \"</textarea>\";\n                        $fieldhtml .=\"<br \".XHTML.\"><strong>\";\n                        $fieldhtml .=\"<span id='\".$cntname.\"'></span></strong>\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044 \n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist\n                            ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n                    }else{\n                        $fieldhtml= $lang_noyes[$fvalue];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n\t\t\t\t\t\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                 case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getcheckboxary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                       $fieldhtml=DATABOX_getoptionlist(\"selectlist_mst\",$fvalue,0,$pi_name,\"\",0,$selectlist,\"afield[\".$fid.\"]\");\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist ($selectionary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getradiolist ($mstary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getoptionlistary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\uff08date picker\u5bfe\u5fdc\uff09\n                if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.datepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"date\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 4://\u65e5\u6642\uff08datetime picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.hour_mode = {$_CONF['hour_mode']};\"\n                            . \"  geeklog.datetimepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n\t\t\t\t\t\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"datetime\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 26://\u6642\u523b\uff08UI time picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                         $fvalue_time=DATABOX_getTimeformat($fvalue);\n                         $filedname=\"afield\".$fid;\n                         \n                         $wk =  \" <input \";\n                         $wk .= \" type=\\\"hidden\\\"\";\n                         $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                         $wk .= \" \".XHTML.\">\";\n                         $fieldhtml.=$wk;\n\n                         $fieldhtml .= \"        <input \";\n                         $fieldhtml .= \" data-uk-timepicker=\\\"{format:'\".$_CONF['hour_mode'].\"h'\";\n                         if  ($addition_def[$fid]['range_start']==\"\"){\n                         }else{\n                             $fieldhtml .= \",start:\".$addition_def[$fid]['range_start'] ;\n                         }\n                         if  ($addition_def[$fid]['range_end']==\"\"){\n                         }else{\n                             $fieldhtml .= \",end:\".$addition_def[$fid]['range_end'] ;\n                         }\n                         $fieldhtml .= \" }\\\"\";\n                         $fieldhtml .= \" class=\\\"uk-form-width-small\\\"\";\n                         $fieldhtml .= \" type=\\\"text\\\"\";\n                         $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                         $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                         $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                         $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                         $fieldhtml .= \" value=\\\"\". $fvalue_time.\"\\\"\";\n                         $fieldhtml .= \" \".XHTML.\">\";\n                     }else{\n                        $fieldhtml .=$fvalue;\n                     }\n                     break;\n                case 22://\u65e5\u4ed8\n                if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n\n                        $_SCRIPTS->setJavaScript(\n                            \"$(function() {\n                            $( \\\"#afield\".$fid.\"\\\" ).datepicker();\n                            });\"\n                            , TRUE, TRUE\n                            );\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                        \n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 23://\u65e5\u4ed8\n                    if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n                        \n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" data-uk-datepicker=\\\"{format:'YYYY/MM/DD'}\\\"\";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\". $fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 17://\u30d5\u30e9\u30b0\n                    if ($disabled===\"\"){\n                        $wk =\" <input \";\n                        $wk .= \" type=\\\"checkbox\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"1\\\"\";\n                        if  ($fvalue==1) {\n                            $wk .= \" checked=checked\";\n                        }\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml=$wk;\n                    }else{\n                        $fieldhtml= $fvalue;\n                    }\n                    break;\n\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                default:\n                    if ($disabled===\"\"){\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n            }\n\n\n            if ($checkrequried==1){//\u5fc5\u9808\n                $must= $lang_admin['must'];\n            }else{\n                $must=\"\";\n            }\n            $templates->set_var('lang_must_additionfield', $must);\n\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield_templatesetvar', \"&#123;\".$templatesetvar.\"&#125;\");\n\n            $addisionfields .= $fieldhtml;\n            $templates->set_var('additionfield_value', $fieldhtml);\n\n            $templates->set_var('additionfield_description', $description);\n            $templates->set_var('additionfield_description2', $description2);\n            $templates->set_var('fieldgroup_name', $fieldgroup_name);\n\t\t\tif  ($fieldgroup_old==$fieldgroup_name){\n                $templates->set_var('fieldgroup', \"\");\n            }else{\n                $templates->set_var('fieldgroup', $fieldgroup_name);\n                $fieldgroup_old=$fieldgroup_name;\n            }\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n        }\n    }\n\n    return $retval;\n}\n\n//\nfunction DATABOX_figurehtml(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n\n//    $retval .= \" value=\\\"\".$fvalue_fnm.\"\\\"\";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .=\"<img src=\\\"data:image/jpg;base64,\";\n        $retval .=\"{$fvalue}\\\"\";\n        $retval .=\"width=100 height=100\";\n        $retval .=\" \".XHTML.\">\".LB;\n        //\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n//  $photo_x = USER_getPhoto ($uid, $photo, $email, -1);\n\n    return $retval;\n}\nfunction DATABOX_filehtml(\n    $pi_name\n    ,$fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $lang_box_admin['deletemsg_check'];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\n\nfunction DATABOX_figurehtml12(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n    ,$size\n    ,$maxlength\n)\n{\n\n    global $LANG04;\n    \n    $a=explode(\"|\",$fvalue);\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .= \"<input \";\n    $retval .= \" type=\\\"text\\\"\";\n    $retval .= \" size=\\\"\".$size.\"\\\"\";\n    $retval .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n    $retval .= \" name=\\\"afield_alt[\".$fid.\"]\\\" \";\n    $retval .= \" style=\\\"max-width:95%\\\"\";\n    $retval .= \" value=\\\"\".$a[1].\"\\\"\";\n    $retval .= \" \".XHTML.\">\";\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_imagehtml(\n    $name\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"\".$name.\"\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    if ($fvalue==\"\"){\n\n        $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n        $retval .= \" id=\\\"\".$name.\"\\\" \";\n        $retval .= \" name=\\\"\".$name.\"\\\" \";\n\n        $retval .=\"size=\\\"30\\\"\";\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }else{\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"\".$name.\"_del\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_getaddtionfieldsText(\n    $fields\n    ,$addition_def\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeTEXT\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsText\n// |        ($additionfields,$addition_def,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76eetext\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_CONF;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n    \n    $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n\n        $chk=false;\n        $disabled=\"disabled\";\n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($addition_def[$fid]['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n\n        if (in_array($fid,$fieldsetfields )) {\n            if ($chk) {\n                $retval.=$name.\":\";\n\n                switch ($type) {\n                    case 11://\u56f3\n                        $retval .= \"\";\n                        break;\n                    case 2://\u3044\u3044\u3048/\u306f\u3044\n                        $retval .= $lang_noyes[$fvalue];\n                        break;\n                    case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 8://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                        $retval .= $selectionary[$fvalue];\n                        break;\n                    case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $wk.=$selectionary[$wkary[$x]].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                        $retval .= $mstitems['value'];\n                        break;\n                    case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                            $wk.=$mstitems['value'].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 4://\u65e5\u6642\n                        $w=COM_getUserDateTimeFormat($fvalue);\n                        $retval .= $w[0];\n                        break;\n                    case 22://\u65e5\u4ed8\n                    case 23://\u65e5\u4ed8\n                    case 3://\u65e5\u4ed8\n                        if  ($fvalue<>\"\"){\n                            $retval .=strftime( $_CONF['shortdate'], $fvalue );\n                        }\n                        break;\n                    case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                    case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                    case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                    case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                    default:\n                        $retval .= $fvalue;\n                }\n                $retval.=LB;\n            }\n        }\n    }\n    return $retval;\n}\n\n\n\nfunction DATABOX_getaddtionfieldsDisp(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u4f5c\u6210                                              |\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsDisp\n// |        ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n//update 20101012 $chk_user\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    \n    $noimage=\"lib/noimage.jpg\";\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n\n        $name=$addition_def[$fid]['name'];\n        $description=$addition_def[$fid]['description'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n        $format=$addition_def[$fid]['format'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $chk=false;\n        if (in_array($fid,$fieldsetfields )) {\n            //\u8868\u793a\u3059\u308b\n            if  ($addition_def[$fid]['allow_display']==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_display']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n                //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n        }\n        if ($chk) {\n            $fieldhtml=\"\";//\u5916\u753b\u50cf\u306e\u5834\u5408\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtml_tn=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtmldisp=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtmldisp_tn=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtml_noimage=\"\";\n            $fieldhtml_tn_noimage=\"\";\n\t\t\t$fieldhtml_tn_image=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\n\t\t\t$fieldhtml_readfile=\"\";//\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30ebreadfile\n            $mstitems=array();\n            $fieldhtml_yes=\"\";\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\uff08\u6e96\u5099\u4e2d\uff09\n                    $a=explode(\"|\",$fvalue);\n                    $fieldhtml=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                    $fieldhtml_noimage=$a[0];\n                    //\n                    if  ($fvalue===\"\"){\n                        $fieldhtml_noimage=$noimage;\n                        $fieldhtml_tn_noimage=$noimage;\n                    }else{\n\n                        $fieldurl= $_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n                        $fieldurl.= $a[0] ;\n\n                        $fieldhtmldisp .=\"<img \";\n                        $fieldhtmldisp .=\" src=\\\"{$fieldurl}\\\"\";\n                        $fieldhtmldisp .=\" border=\\\"0\\\"\";\n                        $fieldhtmldisp .=\" alt=\\\"{$a[1]}\\\"\";\n                        $fieldhtmldisp .=\" \".HTML.\">\";\n                    \n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\n                        $filename = substr($fvalue, 0, strrpos($fvalue,\".\"));\n                        $thum_filename = $filename . \"-small.jpg\";\n                        $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    \n                        if(file_exists($imgfld_thmb.$thum_filename)) {\n                            $fieldhtml_tn=$thum_filename;\n                            $fieldhtml_tn_noimage=$thum_filename;\n                            //\n                            $fieldurl_tn= $_CONF['site_url']   .\"/\".$box_conf['imgfile_thumb_frd'] ;\n                            $fieldurl_tn.= $thum_filename ;\n                            //\n                            $fieldhtml_tn_image .=\"<a href=\\\"{$fieldurl}\\\" target=\\\"_blank\\\">\";\n                            $fieldhtml_tn_image .=\"<img \";\n                            $fieldhtml_tn_image .=\" src=\\\"{$fieldurl_tn}\\\"\";\n                            $fieldhtml_tn_image .=\" border=\\\"0\\\"\";\n                            $fieldhtml_tn_image .=\" alt=\\\"{$a[1]}\\\"\";\n                            $fieldhtml_tn_image .=\" \".XHTML.\">\";\n                            $fieldhtml_tn_image .=\" </a>\";\n                        \n                        }else{\n                            $fieldhtml_tn_noimage=$noimage;\n                        }\n                        \n                    }\n\n                    break;\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $a=explode(\"|\",$fvalue);\n                        $fieldhtml .= $a[1];\n                        $fieldhtml_readfile = $a[0];\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $fieldhtml .=\"<img src=\\\"data:image/jpg;base64,\";\n                        $fieldhtml .=\"{$fvalue}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $fieldhtml .= $lang_noyes[$fvalue];\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@@\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@\n                    $fieldhtml .= $selectionary[$fvalue];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($fvalue);\n                    $w=DATABOX_autolink($w);\n                    $fieldhtml .= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                    $fieldhtml .= $mstitems['value'];\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    \n                    $mstitems['value2'] = rtrim($wk_value2,$separater);\n                    $mstitems['disp'] = rtrim($wk_disp,$separater);\n                    $mstitems['no'] =$fvalue;\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($fvalue<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($fvalue,$format);\n                        $fieldhtml .= $w[0];\n                    }\n                    break;\n                case 26://\u6642\u523b\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .= DATABOX_getTimeformat($fvalue);\n                    }\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                case 3://\u65e5\u4ed8\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .=strftime( $_CONF['shortdate'], $fvalue );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $fieldhtml .= number_format( (float)$fvalue, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $fieldhtml .= $fvalue;\n            }\n            $templates->set_var('field_id', $fid);\n            $templates->set_var('field_type', $type);\n            \n            //\u9805\u76ee\u540d\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield'.$fid.\"_name\", $name);\n            $templates->set_var($templatesetvar.\"_name\", $name);\n            \n            //\u8aac\u660e\n            $templates->set_var('additionfield'.$fid.\"_description\", $description);\n            $templates->set_var($templatesetvar.\"_description\", $description);\n            \n            //\u767b\u9332\u3057\u305f\u30c6\u30fc\u30de\u5909\u6570\u540d\n            $templates->set_var('additionfield_templatesetvar', $templatesetvar);\n            \n            //\n            $templates->set_var('additionfield_value', $fieldhtml);\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n            $templates->set_var('additionfield_fvalue', $fvalue);\n            $templates->set_var('additionfield'.$fid.\"_value\", $fvalue);\n            $templates->set_var($templatesetvar.\"_value\", $fvalue);\n            \n            if  ($type==12){\n                $templates->set_var('display_a', 'display:');\n            }else{\n                $templates->set_var('display_a', 'display:none');\n            }\n            //(a_1)_tn \u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $templates->set_var('additionfield_value_tn', $fieldhtml_tn);\n            $templates->set_var('additionfield'.$fid.\"_tn\", $fieldhtml_tn);\n            $templates->set_var($templatesetvar.\"_tn\", $fieldhtml_tn);\n            \n            //(a_2)_noimage\n            $templates->set_var('additionfield_value_noimage', $fieldhtml_noimage);\n            $templates->set_var('additionfield'.$fid.\"_noimage\", $fieldhtml_noimage);\n            $templates->set_var($templatesetvar.\"_noimage\", $fieldhtml_noimage);\n            \n            //(a_3)_tn_image \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_image', $fieldhtml_tn_image);\n            $templates->set_var('additionfield'.$fid.\"_tn_image\", $fieldhtml_tn_image);\n            $templates->set_var($templatesetvar.\"_tn_image\", $fieldhtml_tn_image);\n            \n            //(a_4)_tn_noimage \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_noimage', $fieldhtml_tn_noimage);\n            $templates->set_var('additionfield'.$fid.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            $templates->set_var($templatesetvar.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            \n            //(a_5)disp \u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\u8868\u793a\n            $templates->set_var('additionfield_value_disp', $fieldhtmldisp);\n            $templates->set_var('additionfield'.$fid.\"_disp\", $fieldhtmldisp);\n            $templates->set_var($templatesetvar.\"_disp\", $fieldhtmldisp);\n            \n            if  ( $type==9 OR $type==16 OR $type==18 ){\n                $templates->set_var('display_b', 'display:');\n            }else{\n                $templates->set_var('display_b', 'display:none');\n            }\n            //(b_1)\u30de\u30b9\u30bf\u30fc\u306evalue2\n            $templates->set_var('additionfield_value_mst_value2', $mstitems['value2']);\n            $templates->set_var('additionfield'.$fid.\"_mst_value2\", $mstitems['value2']);\n            $templates->set_var($templatesetvar.\"_mst_value2\", $mstitems['value2']);\n            \n            //(b_2)\u30de\u30b9\u30bf\u30fc\u306edisp\n            $templates->set_var('additionfield_value_mst_disp', $mstitems['disp']);\n            $templates->set_var('additionfield'.$fid.\"_mst_disp\", $mstitems['disp']);\n            $templates->set_var($templatesetvar.\"_mst_disp\", $mstitems['disp']);\n            \n            //(b_3)\u30de\u30b9\u30bf\u30fc\u306eno\n            $templates->set_var('additionfield_value_mst_no', $mstitems['no']);\n            $templates->set_var('additionfield'.$fid.\"_mst_no\", $mstitems['no']);\n            $templates->set_var($templatesetvar.\"_mst_no\", $mstitems['no']);\n            \n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var('additionfield'.$fid.\"_disptn\", $fieldhtmldisp_tn);\n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var($templatesetvar.\"_disptn\", $fieldhtmldisp_tn);\n\t\t\t\n            if  ( $type==13  ){\n                $templates->set_var('display_c', 'display:');\n            }else{\n                $templates->set_var('display_c', 'display:none');\n            }\n\t\t\t//(c)\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u61b6\u30d5\u30a1\u30a4\u30eb\u540d(templatesetvar_(id)_(readfile))\n            $templates->set_var('additionfield_value_readfile', $fieldhtml_readfile);\n            $templates->set_var('additionfield'.$fid.\"_readfile\", $fieldhtml_readfile);\n            $templates->set_var($templatesetvar.\"_readfile\", $fieldhtml_readfile);\n\t\t\t\n\t\t\t//\u5fc5\u9808\u30c1\u30a7\u30c3\u30af(templatesetvar_(id)_(requied))\n            $templates->set_var('additionfield'.$fid.\"_requried\", $checkrequried);\n            $templates->set_var($templatesetvar.\"_requried\", $checkrequried);\n\t\t\t\n            //\u6587\u8a00\n            $templates->set_var('lang_download', $lang_box['download']);\n            $templates->set_var('lang_downloadrequired', $lang_box['downloadrequired']);\n            $templates->set_var('lang_display', $lang_box['display']);\n            $templates->set_var('lang_displayrequired', $lang_box['displayrequired']);\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n    }\n\n\n    return $retval;\n}\n\n//\nfunction DATABOX_getMstItems(\n    $selectlist\n    ,$id\n    ,$pi_name\n//DATABOX_getMstItems($id,$pi_name);\n){\n    if ($id==\"\"){\n        return array();\n    }\n    global $_TABLES;\n    \n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n\n    $sql=\"SELECT * FROM  {$table_mst} WHERE kind='{$selectlist}' AND no={$id}\";\n    \n    $result = DB_query($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows > 0) {\n        $A = DB_fetchArray($result, true);\n        $A = array_map('stripslashes', $A);\n    }else{\n        $A=array();\n    }\n    return $A;\n}\n\n\nfunction DATABOX_getcategoriesText(\n    $id\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u30e1\u30fc\u30eb\u9001\u4fe1\u7528\u30c6\u30ad\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesText\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u30c6\u30ad\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n{\n    global $_TABLES;\n    global $_CONF;\n\n\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $lang_box_admin=\"LANG_DATABOX_ADMIN\";\n\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater_text'];\n\n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    $categories_group =\"\";\n    $rt=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n                $categories_group=rtrim($categories_group,$separater);\n                $rt.=$categories_group.LB;\n            }\n            $categories_group =\"\";\n            $old_group_id=$A['group_id'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n\n    }\n\n    $categories=rtrim($categories,$separater);\n    $categories_group=rtrim($categories_group,$separater);\n    $rt.=$categories_group.LB;\n\n    $retval.=$lang_box_admin['category'].\": \".$categories.LB;\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesDisp(\n    $id\n    ,$templates\n    ,$chk_user\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30eaHRML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesDisp\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u8868\u793a\u7528HTML\n// +---------------------------------------------------------------------------+\n//20101129\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $box_conf=\"_DATABOX_CONF\";\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    $sql = \"SELECT \";\n    $sql .= \" group_id\".LB;\n    $sql .= \" ,code\".LB;\n    $sql .= \" FROM \";\n    $sql .= \" {$table_def_group} \".LB;\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    \n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $gid=$A['group_id'];\n        $gcode=$A['code'];\n        $templates->set_var('group_'.$gid, \"\");\n        $templates->set_var('group_'.$gcode, \"\");\n        $templates->set_var('group_'.$gid.\"_code\", \"\");\n        $templates->set_var('group_'.$gcode.\"_code\", \"\");\n                \n        $templates->set_var('grouplink_'.$gid, \"\");\n        $templates->set_var('grouplink_'.$gid.\"_code\", \"\");\n\n        $templates->set_var('grouplink_'.$gcode, \"\");\n        $templates->set_var('grouplink_'.$gcode.\"_code\", \"\");\n    }\n    \n    \n    \n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    $sql .= \",m1.allow_display\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno,m1.category_id\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater'];\n    $separater_code=$lang_box['category_separater_code'];\n    $separater_pipeline=\"|\";\n    \n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    \n    $categories_group =\"\";\n    $categories_link_id_group =\"\";\n    $categories_link_code_group =\"\";\n    \n    $categories_group2 =\"\";\n    $categories_link_id_group2 =\"\";\n    $categories_link_code_group2 =\"\";\n    \n    $categories_group_pipeline =\"\";\n    \n    //group_id2, group_code2, grouplinkid2, grouplinkcode2,\n    //group_id \u304c\u30ab\u30c6\u30b4\u30ea\u306e\u540d\u79f0\u3092\u8868\u793a\u3059\u308b\u306e\u306b\u5bfe\u3057\u3001\n    //group_id2\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group $categories_link_id_group $categories_link_code_group\n    //group_pipeline\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u533a\u5207\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group_pipeline\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $chk=false;\n        //\u8868\u793a\u3059\u308b\n        if  ($A['allow_display']==='0') {\n            $chk=true;\n        //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n        }else if ($A['allow_display']==='1'){\n            if  ($chk_user>=1000) {\n                $chk=true;\n            }\n        //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n        }else if ($A['allow_display']==='2'){\n            if  ($chk_user>=1010) {\n                $chk=true;\n            }\n        //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='3'){\n            if  ($chk_user>=1011) {\n                $chk=true;\n            }\n        //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='4'){\n            if  ($chk_user>=1100) {\n                $chk=true;\n            }\n        }\n        \n        if  ($chk==false){\n            continue;\n        }\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n\n                $categories_group=rtrim($categories_group,$separater);\n                $templates->set_var('group_'.$old_group_id, $categories_group);\n                $templates->set_var('group_'.$old_group_code, $categories_group);\n                $categories_group2=rtrim($categories_group2,$separater_code);\n                $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n                $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n                $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n                $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n                $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n                \n                $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n                $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);\n\n                $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n                $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);\n\n            }\n            $categories_group =\"\";\n            $categories_link_id_group =\"\";\n            $categories_link_code_group =\"\";\n            $categories_group2 =\"\";\n            $categories_link_id_group2 =\"\";\n            $categories_link_code_group2 =\"\";\n            $categories_group_pipeline=\"\";//@@\n            \n            $old_group_id=$A['group_id'];\n            $old_group_code=$A['group_code'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n        $categories_group2.=$A['category_code'].$separater_code;\n        $categories_group_pipeline.=$A['category_code'].$separater_pipeline;\n        \n\n        $name=$A['category_name'];\n        $code=COM_applyFilter($A['category_code']);\n        $url=$_CONF['site_url'] .\"/\".$pi_name.\"/category.php\";\n        $url_code=$url;\n        $url_code.=\"?code=\".$A['category_code'];\n        $url_code.=\"&m=code\";\n        $url_code = COM_buildUrl( $url_code );\n        $url_id=$url;\n        $url_id.=\"?id=\".$A['category_id'];\n        $url_id.=\"&m=id\";\n        $url_id= COM_buildUrl( $url_id );\n        $category_link_id= COM_createLink($name, $url_id);\n        $category_link_code= COM_createLink($name, $url_code);\n        $category_link_id2= COM_createLink($code, $url_id);\n        $category_link_code2= COM_createLink($code, $url_code);\n\n        $categories_link_id.=$category_link_id.$separater;\n        $categories_link_id_group.=$category_link_id.$separater;\n        $categories_link_id_group2.=$category_link_id2.$separater_code;//@@\n        $categories_link_code.=$category_link_code.$separater;\n        $categories_link_code_group.=$category_link_code.$separater;\n        $categories_link_code_group2.=$category_link_code2.$separater_code;//@@\n    }\n\n    $categories=rtrim($categories,$separater);\n    $templates->set_var('categories', $categories);\n\n\n    $categories_link_code=rtrim($categories_link_code,$separater);\n    $categories_link_id=rtrim($categories_link_id,$separater);\n\n\n    if ($box_conf['categoriescode']){\n        $categorieslink=$categories_link_code;\n    }else{\n        $categorieslink=$categories_link_id;\n    }\n    $templates->set_var('categorieslink', $categorieslink);\n\n\n    $templates->set_var('categorieslinkcode', $categories_link_code);\n    $templates->set_var('categorieslinkid', $categories_link_id);\n\n    $categories_group=rtrim($categories_group,$separater);\n    $categories_group2=rtrim($categories_group2,$separater_code);\n    $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n\n    $templates->set_var('group_'.$old_group_id, $categories_group);\n    $templates->set_var('group_'.$old_group_code, $categories_group);\n    $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n    $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n\n    $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n    \n    $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);//@@\n    \n    $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n    \n    $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);//@@\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesinp(\n    $selected = \"\"\n    ,$fieldset_id=\"\"\n    ,$pi_name=\"\"\n    ,$chk_user=9999\n)\n{\nglobal $_TABLES;\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_def_fieldset_group=$_TABLES['DATABOX_def_fieldset_group'];\n        $table_mst=$_TABLES['DATABOX_mst'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_def_fieldset_group=$_TABLES[strtoupper($pi_name).'_def_fieldset_group'];\n        $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n    \n    //\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    \n    //\n    $retval = '';\n\n    $sql = \"SELECT \";\n    $sql .= \"m2.group_id\".LB;\n    $sql .= \",m2.name AS group_name\".LB;\n    $sql .= \",m2.input_type\".LB;\n    $sql .= \",m2.allow_edit\".LB;\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_def_group} AS m2\".LB;\n    if  ($fieldset_id<>0){\n        $sql .= \" ,{$table_def_fieldset_group} AS m3\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m2.group_id = m3.group_id\".LB;\n        $sql .= \" AND m3.fieldset_id = \".$fieldset_id .LB;\n    }\n    \n    \n    $sql .= \" ORDER BY m2.orderno\".LB;\n        \n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $categoryids=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        \n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($A['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($A['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($A['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($A['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n        if ($chk==false) {\n            continue;\n        }\n\t\t\n        $sql2 = \"SELECT \";\n        $sql2 .= \" m1.category_id\".LB;\n        $sql2 .= \",m1.name\".LB;\n        $sql2 .= \",m1.orderno\".LB;\n        $sql2 .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql2 .= \" WHERE \".LB;\n        $sql2 .= \" m1.categorygroup_id=\".$A['group_id'].LB;\n        \n        $sql2 .= \" ORDER BY m1.orderno\".LB;\n        \n        $result2 = DB_query( $sql2 );\n        $nrows2 = DB_numRows( $result2 );\n        \n        if ($nrows2>0){\n            $retval .=\"<div class=\\\"databox_admin_data_title\\\">\";\n            $retval .=$A['group_name'];\n            $retval .=\"</div>\".LB;\n        \n            if  ($A['input_type']==1){\n                $retval .='<select name=\"category[]\" multiple style=\"height:10em\" '.$disabled.' >'.LB;\n            }else if ($A['input_type']==3){\n                $retval .='<select name=\"category[]\" '. $disabled .' >'.LB;\n            }\n            \n            for( $i2 = 0; $i2 < $nrows2; $i2++ )    {\n\n                $A2 = DB_fetchArray( $result2, true );\n                \n\t\t\t\tif  ($disabled==\"\"){\n\t\t\t\t\t$categoryids.=$A2['category_id'].\"|\";\n                }\n                \n                $checked=\" \";\n                for( $x = 0; $x < sizeof( $S ); $x++ )            {\n                    if( $A2['category_id'] == $S[$x] )                {\n                        if  ($A['input_type']==0 OR $A['input_type']==2){\n                            $checked= ' checked=\"checked\" ';\n                        }else{\n                            $checked= ' selected ';\n                        }\n                    }\n                }\n            \n                if  ($A['input_type']==0){\n                    $retval .= '<span style=\"white-space:nowrap\">';\n                    $retval .= '<input type=\"checkbox\" name=\"category[]\" value=\"' . $A2['category_id'] ;\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= $disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==1){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }else  if  ($A['input_type']==2){\n                    $retval .= '<input type=\"radio\" name=\"category[]\" value=\"' . $A2['category_id'];\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= ' '.$disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==3){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }\n            }\n        \n            if  ($A['input_type']==1  OR  $A['input_type']==3  ){\n                $retval .='</select>';\n            }\n        }\n        \n\t}\n\tif  ($categoryids==\"\"){\n\t}else{\n\t\t$categoryids=substr($categoryids,0,strlen($categoryids)-1);\n        $retval .= \"  <input type='hidden' name='categories' value='{$categoryids}'>\";\n    }\n    return $retval;\n}\nfunction DATABOX_getaddtionfields(\n    $id\n    ,$addition_def\n    ,$pi_name\n    ,$field_id=0\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getadditionfields($id,$addition_def,$tbl_prefix,$field_id)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\u306e\u914d\u5217\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n\n    global $_TABLES;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $retval=array();\n\n    $sql = \"SELECT \";\n    $sql .= \" value\";\n    $sql .= \",t.field_id\";\n\n    $sql .= \" FROM {$table_addition} AS t\";\n    $sql .= \" , {$table_def_field} AS m\";\n    $sql .= \" WHERE \";\n    $sql .= \" t.id={$id}\";\n    $sql .= \" AND t.field_id=m.field_id\";\n    if ($field_id<>0){\n        $sql .= \" AND t.field_id=\".$field_id;\n    }\n\n    $sql .= \" ORDER BY m.orderno\";\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n\n        $fid=$A[\"field_id\"];\n        $value=$A[\"value\"];\n\n        $fieldvalue=DATABOX_getfieldvalue(\n            $value\n            ,$addition_def[$fid]['type']\n            ,$addition_def[$fid]['selectionary']\n            ,$lang_noyes\n            ,$addition_def[$fid]['selectlist']\n            ,$pi_name\n            );\n        $retval[$fid]=$fieldvalue;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getfieldvalue(\n    $value\n    ,$type\n    ,$selectionary\n    ,$lang_noyes\n    ,$selectlist\n    ,$pi_name\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getfieldvalue($value,$type,$selectionary,$lang_noyes)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $value:\n// | \u5f15\u6570 $type:\n// | \u5f15\u6570 $selectionary:\n// | \u5f15\u6570 $lang_noyes:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    switch ($type) {\n\n        case 2://\u3044\u3044\u3048/\u306f\u3044\n            $fieldvalue = $lang_noyes[$value];\n            break;\n        case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n        case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n            $fieldvalue= $selectionary[$value];\n            break;\n        case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n        case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n            if  ($value==\"\"){\n                $fieldvalue=\"\";\n            }else{\n                $fieldvalue=DB_getItem($_TABLES[strtoupper($pi_name).'_mst'] \n                    ,\"value\"\n                    ,\"kind='{$selectlist}' AND no={$value}\");\n            }\n            break;\n        case 4://\u65e5\u6642\n            $w=COM_getUserDateTimeFormat($value);\n            $fieldvalue= $w[0];\n            break;\n        case 3://\u65e5\u4ed8\n            $fieldvalue=strftime( $_CONF['shortdate'], $value );\n            break;\n        case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n        case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n        case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n        case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n        case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n        default:\n            $fieldvalue = $value;\n        }\n\n    return $fieldvalue;\n}\n\n\nfunction DATABOX_saveaddtiondatas(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc                                                        |\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n    \n    $rt=DB_delete($table,\"id\",$id);\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            $sql=\"INSERT INTO {$table} (\";\n            $sql.=\"id, field_id,value \";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id},{$field_id}\";\n            if  ($value<>\"\") {\n                $sql.=\", '{$value}'\";\n            }else{\n                $sql.=\", NULL\";\n            }\n            $sql.=\")\";\n            DB_query($sql);\n        }\n    }\n    return ;\n\n}\n\nfunction DATABOX_saveaddtiondatas_update(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc user\u7528\n// | \u66f8\u5f0f $rt=DATABOX_saveaddtiondatas_update\n// |               ($id,$additionfields,$addition_def,$pi_name);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //if ($addition_def[$field_id]['type']=11){\n            $sql=\"UPDATE \".$table .\" SET \";\n            if  ($value<>\"\") {\n                $sql.=\" value ='\".$value.\"'\";\n            }else{\n                $sql.=\" value =NULL\";\n            }\n            $sql.=\" WHERE id=\".$id.\" AND field_id=\".$field_id;\n            DB_query($sql);\n        }\n    }\n\n\n    return ;\n\n}\n\nfunction DATABOX_cleanaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,&$fnmary\n    ,&$delary\n    ,&$dateary\n    ,&$altary\n    ,$addslash = true\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeclean\n// | \u66f8\u5f0f DATABOX_cleanadditiondatas($fldary,$typeary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def\n// | \u5f15\u6570 $fnmary\n// | \u5f15\u6570 $delary\n// | \u5f15\u6570 $addslash \n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update 20131022 12\n{\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            $type=$addition_def[$field_id]['type'];\n            $textconv=$addition_def[$field_id]['textconv'];\n            $textcheck=$addition_def[$field_id]['textcheck'];\n            $wk=$value;\n            //\u5165\u529b\u5024\u5909\u63db\n            switch ($type) {\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK TinyMCE)\n                if  (($textconv==10)\n                        OR ($textcheck>=11 AND $textcheck<=14)){ //\u534a\u89d2\u30c1\u30a7\u30c3\u30af;\n                        $wk = mb_convert_kana($wk,\"ak\");\n                    }else if ($textconv==20){ //\u5168\u89d2\u306b\u5909\u63db\u3059\u308b';\n                        $wk = mb_convert_kana($wk,\"AKV\");\n                }\n                break;\n            }\n            //\n            switch ($type) {\n                case 11:// \u56f3\n                    break;\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\n                case 10://\u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\n                    $wk=COM_stripslashes($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 1://HTML\n                case 20://TinyMCE\n                case 19://CKEditor\n                    $wk=COM_stripslashes($wk);\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $wk=COM_applyFilter($wk,true);\n                    break;\n                case 3://\u65e5\u4ed8\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day;\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                    $ary_wk=date_parse( $wk);\n                    if  ($ary_wk[error_count]==0){\n                        $dateary[$field_id]['month']= $ary_wk[month];\n                        $dateary[$field_id]['day']= $ary_wk[day];\n                        $dateary[$field_id]['year']= $ary_wk[year];\n                    }else{\n                        $wk=\"\";\n                        $dateary[$field_id]['month']= \"\";\n                        $dateary[$field_id]['day']= \"\";\n                        $dateary[$field_id]['year']= \"\";\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk_hour=$_POST['afield'.$field_id.'_hour'];\n                    $wk_minute=$_POST['afield'.$field_id.'_minute'];\n                    $wk_ampm=$_POST['afield'.$field_id.'_ampm'];\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    $dateary[$field_id]['hour']=$wk_hour;//@@@@@\n                    $dateary[$field_id]['minute']=$wk_minute;//@@@@@\n                    $dateary[$field_id]['ampm']=$wk_ampm;//@@@@@\n                    if ($wk_ampm == 'pm') {\n                        if ($wk_hour < 12) {\n                            $wk_hour = $wk_hour + 12;\n                        }\n                    }\n                    if ($wk_ampm == 'am' AND $wk_hour == 12) {\n                        $wk_hour = '00';\n                    }\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day .\" \".$wk_hour.\":\".$wk_minute;\n                    break;\n                case 26://\u6642\u523b\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wk=implode ($wk,\":\");\n                    break;\n                case 12:// \u753b\u50cf\uff08\u30d5\u30a1\u30a4\u30eb\u4fdd\u5b58\uff09\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($altary[$field_id]);\n                    $wk2=COM_checkHTML (COM_checkWords ($wk2));\n                    $altary[$field_id]=$wk2;\n                    $a=explode(\"|\",$wk);\n                    $wk=$a[0].\"|\".$wk2;\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($delary[$field_id]);\n                    $delary[$field_id]=COM_checkHTML (COM_checkWords ($wk2));\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                default:\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n            }\n            if ($addslash){\n                $wk=addslashes ($wk);\n            }\n            $fldary[$field_id] =$wk;\n        }\n    }\n\n    return $fldary;\n\n}\n\nfunction DATABOX_checkaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u8ffd\u52a0\u9805\u76eecheck\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($fldary,$typeary,$pi_data)\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n    \n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //\u5fc5\u9808\n            if ($addition_def[$field_id]['checkrequried']==1){\n                if ($value ===\"\"){\n                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_checkrequried'] ;\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                }\n                //url email date\n            }\n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                 $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld_thmb.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $imgfld )){\n                    $rt.=$imgfld.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if  ($imgfld<>$imgfld_thmb){\n                    if (!is_writable ( $imgfld_thmb )){\n                        $rt.=$imgfld_thmb.\": \".$lang_box_admin['err_writable'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                     //$fldary[$field_id]=\"\";\n                     //$fldary_fnm[$field_id]=\"\";\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($imgfile<>\"\"){\n                            $imgerr=\"\";\n                            if ($box_conf['imgfile_size2']<>\"\" AND $imgsize>$box_conf['imgfile_size2']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $imgerr=1;\n                            }\n                            if (count($box_conf['imgfile_type2'])>0){\n                                if  (in_array($imgtype,$box_conf['imgfile_type2'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type2']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $imgerr=1;\n                                }\n                            }\n                        \n                            //$imgname=sanitize\n                            // \u554f\u984c\u6587\u5b57\u3092\u9664\u304f\n                            //$filename = str_replace(\"&\",\"\",$filename);\n                            //$filename = str_replace(\"'\",\"\",$filename);\n                            //$filename = str_replace(\"/\",\"\",$filename);\n                            //$filename = str_replace(\".JPG\",\".jpg\",$filename);\n                            //\u91cd\u8907\u30c1\u30a7\u30c3\u30af\n                            if  ($imgerr===\"\"){\n                                $fldary[$field_id]=$imgname.\"|\".fldary_alt;//@@@@@@@!!!!\n                            }\n                        }\n                    }else{\n                        \n                    }    \n                 }\n            }\n\n\n\n            //\u56f3 DB\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==11){//\u56f3\n\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                        $fldary[$field_id]=\"\";\n                        $fldary_fnm[$field_id]=\"\";\n                 }else{\n                    //$figure = $_FILES[$w];\n                    // $imgfile=$figure[ 'tmp_name' ];\n\n\n                     $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                     $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                     $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                     if  ($imgfile<>\"\"){\n                          $imgerr=\"\";\n                          if ($box_conf['imgfile_size']<>\"\" AND $imgsize>$box_conf['imgfile_size']){\n                              $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                              $rt.=\"<br \".XHTML.\">\".LB;\n                              $imgerr=1;\n                          }\n                          if (count($box_conf['imgfile_type'])>0){\n                              if  (in_array($imgtype,$box_conf['imgfile_type'])){\n                              }else{\n                                  $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                  .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                  $rt.=\"<br \".XHTML.\">\".LB;\n                                 $imgerr=1;\n                              }\n                          }\n                          if  ($imgerr===\"\"){\n                              $imgbinary = fread ( fopen ( $imgfile , \"r\" ), filesize ( $imgfile ));\n                              $fldary[$field_id]=base64_encode($imgbinary);\n                          }\n                     }\n                 }\n            }\n\n            //\u65e5\u4ed8 \u65e5\u6642\n            if ($addition_def[$field_id]['type']==3 OR $addition_def[$field_id]['type']==4\n                     OR $addition_def[$field_id]['type']==22 OR $addition_def[$field_id]['type']==23){//\u65e5\u4ed8\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime($value);\n                    \n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime($addition_def[$field_id]['range_start']);\n                        $w_end=strtotime($addition_def[$field_id]['range_end']);\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    \n                    if ($w==\"\"){\n                        $w_chk=false;\n                    }else{\n                        $w_year=date('Y', $w);\n                        $w_month=date('m', $w);\n                        $w_day=date('d', $w);\n                        $w_chk=checkdate($w_month, $w_day, $w_year);\n                    }\n                    if ($w_chk==false) {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_date'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_date=date(\"Y-m-d\",$w);\n                        if ($addition_def[$field_id]['type']==3){\n                            $w_time=\"\";\n                        }else{\n                            $w_time=date(\"H:i\",$w).\"::00\";\n                        }\n                        $fldary[$field_id]=COM_convertDate2Timestamp($w_date,$w_time);\n                    }\n                }\n            }\n            //\u6642\u523b\n            if ($addition_def[$field_id]['type']==26){\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime(\"1970-1-1 \".$value);\n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_start'].\":00\");\n                        $w_end=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_end'].\":00\");\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    if ($w==\"\") {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_time'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_time=date(\"H:i\",$w).\"::00\";\n                        $fldary[$field_id]=COM_convertDate2Timestamp(\"1970-1-1\",$w_time);\n                    }\n                }\n            }\n            //\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n            if ($addition_def[$field_id]['type']==5){\n                if ($value ===\"\"){\n                }else{\n                    if (COM_isEmail ($value)==false) {\n                        $rt.=$addition_def[$field_id]['name'].$LANG04[18];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //url\n            if ($addition_def[$field_id]['type']==6){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (preg_match('/^(https?|ftp)(:\\/\\/[-_.!~*\\'()a-zA-Z0-9;\\/?:\\@&=+\\$,%#]+)$/', $value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_url'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //numeric\n            if ($addition_def[$field_id]['type']==15 OR $addition_def[$field_id]['type']==21){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (is_numeric($value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_numeric'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n           //text field\n            if (($addition_def[$field_id]['type']==0)\n                    OR ($addition_def[$field_id]['type']==1)\n                    OR ($addition_def[$field_id]['type']==10) ){\n                if ($value ===\"\"){\n                }else{\n                    if  ($addition_def[$field_id]['textcheck']==11){ //'\u534a\u89d2\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text1'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==12){//\u534a\u89d2\u82f1\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[a-zA-Z0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text2'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==13){//\u6a19\u6e96ID\u306e\u7bc4\u56f2\u5185';\n                        $value=rtrim(ltrim($value));\n                        $newvalue=COM_sanitizeID($value);\n                        if  ($value<>$newvalue){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text3'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                        $fldary[$field_id]=$value;\n                    }else if ($addition_def[$field_id]['textcheck']==14){//\u534a\u89d2\u82f1\u6570\u5b57\u8a18\u53f7\u306e\u307f';\n                        if  (!preg_match(\"/^[!-~]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text4'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                }\n            }\n            \n            \n            //textarea\n            if ($addition_def[$field_id]['type']==1 \n                    OR $addition_def[$field_id]['type']==10\n                    OR $addition_def[$field_id]['type']==20\n                    ){\n                if ($value ===\"\"){\n                }else{\n                    if (mb_strlen($value, 'UTF-8')>$addition_def[$field_id]['maxlength']) {\n                        $rt.=$addition_def[$field_id]['name']\n                            .$addition_def[$field_id]['maxlength']\n                            .\": \".$lang_box_admin['err_maxlength'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                 $file_path=$box_conf['file_path'];\n                 if  ( $box_conf['file_subdir']==1){\n                    $file_path.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $file_path )){\n                    $rt.=$file_path.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $filename=$_FILES['afield_fnm']['name'][$field_id];\n                        $filetmpname=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $filesize=$_FILES['afield_fnm']['size'][$field_id];\n                        $filetype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($filetmpname<>\"\"){\n\t\t\t\t\t\t\t$err=\"\";\n                            if ($box_conf['file_size']<>\"\" AND $filesize>$box_conf['file_size']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $err=1;\n                            }\n\t\t\t\t\t\t\tif (count($box_conf['file_type'])>0){\n                                if  (in_array($filetype,$box_conf['file_type'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$filetype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $err=1;\n                                }\n                            }\n                            //\u30c1\u30a7\u30c3\u30afOK\n                            if  ($err===\"\"){\n                                $fldary[$field_id]=$filename;\n                            }\n                        }\n                    }else{\n                        \n                    }\n                 }\n            }\n\n            //range check \u7bc4\u56f2\u30c1\u30a7\u30c3\u30af\n            if  ($addition_def[$field_id]['range_start']==\"\" AND $addition_def[$field_id]['range_end']==\"\" ){\n            }else{\n                if (($addition_def[$field_id]['type']==0)\n                     OR ($addition_def[$field_id]['type']==1)\n                     OR ($addition_def[$field_id]['type']==15) \n                     OR ($addition_def[$field_id]['type']==21) ){\n                    if  ($value <$addition_def[$field_id]['range_start'] \n                        OR $value >$addition_def[$field_id]['range_end']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                .\"(\".$addition_def[$field_id]['range_start'] \n                                .\"-\".$addition_def[$field_id]['range_end'].\")\";\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n                \n            }\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_uploadaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                        }\n\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];//@@@@@@@!!!!\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                            //$fldary_fnm[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\t\t\t\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                        }\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);//\u62e1\u5f35\u5b50\u3092\u5c0f\u6587\u5b57\u306b\u3059\u308b\n                        if  ( $box_conf['file_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\n\t\t}\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_uploadaddtiondatas_cpy(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload  for copy\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                //$filename=$fldary[$field_id];\n                //$filename_old=$fldary_old[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                \n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['imgfile_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $cpyfrom =$imgfld_thmb.$thumbname;\n                            $thumbname=DATABOX_getthumbname($newfilename);\n                            $cpyto =$imgfld_thmb.$thumbname;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                        }\n                    }\n                }\n\t\t\t}\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                $imgname_old=$a[1];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['file_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname_old;\n                        }\n                    }\n                }\n            }\n\n        }\n    }\n\n    return $rt;\n\n}\n\n//update\nfunction DATABOX_uploadaddtiondatas_xml(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n)\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            if ($fldary[$field_id]<>\"\"){\n                \n                //\u56f3 \u5916\u8a18\u61b6\n                if ($addition_def[$field_id]['type']==12){//\u56f3\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    //\n                    if  ($box_conf['imgfile_subdir']==1){\n                        $imgname=$addition_def[$field_id]['templatesetvar'].\"/\";\n                    }\n                    $imgname.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".jpg\";\n                    $imgsrc=$fldary[$field_id];\n                    if (DATABOX_uploadImageFile_xml($imgname,$imgsrc,$imgfld)){\n                        $fldary[$field_id]=$imgname;\n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                        if($box_conf['imgfile_thumb_ok']===\"1\" && function_exists('ImageCreate')) {\n                            $srcfile=$imgfld.$imgname;\n                            $rt=DATABOX_createthumb(\n                                $imgname\n                                ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                ,$imgfld_thmb,$imgfld);\n                        }\n                    }else{\n                        $fldary[$field_id]=\"\";\n                    }\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_deleteaddtionfiles(\n    $fldary\n    ,$addition_def\n    ,$pi_name\n){\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\n//\nfunction DATABOX_deleteaddtionfiles_def(\n    $field_id\n    ,$pi_name\n){\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n    \n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    //\n    $sql=\"SELECT value  \";\n    $sql.=\" FROM\";\n    $sql.=\" {$table_addition} \";\n    $sql.=\" where\";\n    $sql.=\" field_id=\".$field_id;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $filename = COM_stripslashes($A['value']);\n        if ($filename<>\"\"){\n            $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n            $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n            $rt=DATABOX_deleteFile($imgfld.$filename);\n            $thumbname=DATABOX_getthumbname($filename);\n            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_deleteaddtionfiles_all(\n    $fld\n    ,$pi_name\n){\n    \n    \n    \n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if( is_dir( $fld)){\n        $fd = opendir( $fld );\n        while(( $file = @readdir( $fd )) == TRUE )    {\n            if( !is_dir( $fd1 . $file)\n                    && $dir <> '.'\n                    && $dir <> '..'\n                    && $dir <> 'CVS'\n                    && substr( $dir, 0 , 1 ) <> '.' ) {\n                clearstatcache();\n                $rt=DATABOX_deleteFile($fld.$file);\n            }\n        }\n    }\n\n    return $rt;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeuploadfile delete\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($filename)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filename:\u30d5\u30a9\u30eb\u30c0/\u30d5\u30a1\u30a4\u30eb\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\nfunction DATABOX_deleteFile (\n    $filename\n)\n{\n    $rt=false;\n    if (file_exists ($filename)) {\n        if (!@unlink ($filename)) {\n            COM_errorLog (\"Unable to remove file $filename\");\n        }else{\n            $rt=true;\n            COM_errorLog (\"remove file $filename\");\n        }        \n    }else{\n            COM_errorLog (\"Unable to remove file $filename not exist\");\n    }\n    return $rt;\n}\n\nfunction DATABOX_uploadImageFile (\n     $imgname\n    ,$imgfile\n    ,$imgsize\n    ,$imgtype\n    ,$imgfld\n    ,$newfilename\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  upload Image File\n// | \u66f8\u5f0f DATABOX_uploadImageFile($imgname,$imgfile,$imgsize, $imgtype,$imgfld)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    $FilePermissions = (int) 0755;\n\n    if (is_uploaded_file ($imgfile)) {\n        //$newfile=$imgfld.$imgname;\n        $newfile=$imgfld.$newfilename;\n        if(!file_exists($newfile)) {\n            $returnMove = move_uploaded_file($imgfile, $newfile); \n            if (!$returnMove) {\n                $logmsg=\"DataBox File upload error: \".$tmp.\" to \".$name;\n                COM_errorLOG($logmsg);\n                return false;\n             } else {\n                $chown =@chmod ($newfile,$FilePermissions);\n                $logmsg=\"DataBox File upload sucsess: \".$imgname;\n                COM_errorLOG($logmsg);\n                return true;\n             }\n         }else{\n            COM_errorLOG(\"DataBox upload error: Temporary file does not exist: '\".$tmp .\"'\");\n            return false;\n         }\n    }\n}\n//\nfunction DATABOX_uploadImageFile_xml (\n    $imgname\n    ,$imgsrc\n    ,$imgfld\n)\n{\n    $FilePermissions = (int) 0755;\n\n    $newfile=$imgfld.$imgname;\n    //\n    $fp = fopen($newfile, \"w\");\n    $imgsrc=base64_decode($imgsrc);\n    fputs($fp, $imgsrc);\n    fclose($fp);\n    \n    if(!file_exists($newfile)) {\n        $logmsg=\"DataBox ImageFile upload error: \".$tmp.\" to \".$name;\n        COM_errorLOG($logmsg);\n        return false;\n    } else {\n        $chown =@chmod ($newfile,$FilePermissions);\n        $logmsg=\"DataBox ImageFile upload sucsess: \".$imgname;\n        COM_errorLOG($logmsg);\n        return true;\n    }\n}\n\nfunction DATABOX_createthumb(\n    $filename\n    , $W\n    , $H\n    , $W2\n    , $H2\n    , $imgfld_thmb\n    , $imgfld\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd uploadfile \u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_createthumb($srcfile,$W,$H,$W2,$H2, $thumb_dir,$tmp_dir)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $srcfile=$imgfld.$filename;\n    // \u753b\u50cf\u306e\u5e45\u3068\u9ad8\u3055\u3068\u30bf\u30a4\u30d7\u3092\u53d6\u5f97\n    $imagesize = GetImageSize($srcfile);\n    $srcfile_w=$imagesize['0'];\n    $srcfile_h=$imagesize['1'];\n    $srcfile_type=$imagesize['2'];\n    //\u5bfe\u8c61\u30bf\u30a4\u30d7\u306e\u78ba\u8a8d\n    switch ($srcfile_type) {\n        case 1 : //gif\n             return false;\n             break;\n        case 2 : //jpg\n             $srcimage = @ImageCreateFromJPEG($srcfile);\n             break;\n        case 3 : //png\n             $srcimage = @ImageCreateFromPNG($srcfile);\n             break;\n    }\n    if (!$srcimage) {\n        return false;\n    }\n    \n    $logmsg=\"size=(w)\".$srcfile_w.\" > \".$w.\" (h)\".$srcfile_h.\" > \".$h;\n    COM_errorLog ($logmsg);\n\n    //\u5bfe\u8c61\u30b5\u30a4\u30ba\u306e\u78ba\u8a8d\n    if ($srcfile_w > $w || $srcfile_h > $h) {\n    }else{\n        return false;\n    }\n        \n    // \u30ea\u30b5\u30a4\u30ba\n    if ($srcfile_w > $W || $srcfile_h > $H) {\n        $key_w = $W / $srcfile_w;\n        $key_h = $H / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n    } else {\n        $out_w = $srcfile_w;\n        $out_h = $srcfile_h;\n    }\n\n    // \u51fa\u529b\u753b\u50cf\uff08\u30b5\u30e0\u30cd\u30a4\u30eb\uff09\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    $outimage = ImageCreateTrueColor($out_w, $out_h);\n    $resize = ImageCopyResampled(\n            $outimage, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n    // \u30b5\u30e0\u30cd\u30a4\u30eb\u753b\u50cf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u51fa\u529b\u3001\u4fdd\u5b58\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $thum_filename = DATABOX_getthumbname($filename);\n       $filename = substr($filename, 0, strrpos($filename,\".\"));\n    touch($imgfld_thmb.$thum_filename);\n    ImageJPEG($outimage, $imgfld_thmb.$thum_filename);\n        \n    // \u51fa\u529b\u753b\u50cf\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    // \u30ea\u30f3\u30af\u5148\u306e\u30b5\u30a4\u30ba\u304c\u8a2d\u5b9a\u5024\u3088\u308a\u5927\u304d\u3044\u6642\u30ea\u30f3\u30af\u5148\u3082\u7e2e\u5c0f\u3059\u308b<-----\n    if ($srcfile_w > $W2 || $srcfile_h > $H2) {\n        $rt = rename($imgfld.$filename.\".jpg\",$imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"rename err!\";\n        }\n\n        $key_w = $W2 / $srcfile_w;\n        $key_h = $H2 / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n        $outimage2 = ImageCreateTrueColor($out_w, $out_h);\n        $resize = ImageCopyResampled(\n            $outimage2, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n        touch($imgfld.$filename.\".jpg\");\n        ImageJPEG($outimage2, $imgfld.$filename.\".jpg\"); \n\n        ImageDestroy($outimage2);\n        $rt=unlink($imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"delete err!\";\n        }\n\n   }\n    \n    // \u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u7834\u68c4\n    ImageDestroy($srcimage);\n    ImageDestroy($outimage);\n\n    return $thum_filename;\n\n}\n//\nfunction DATABOX_getthumbname(\n    $filename\n)\n{\n    $rt=\"\";\n    if ($filename<>\"\"){\n        $filename = substr($filename, 0, strrpos($filename,\".\"));\n        $rt = $filename . \"-small.jpg\";\n    }\n    return $rt;\n}\n//==============================================================================\n\nfunction DATABOX_getradiolist(\n    $ary\n    ,$fld\n    ,$selected = 0\n    ,$br=\"\"\n    ,$disabled=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e9\u30b8\u30f2\u30dc\u30bf\u30f3\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getradiolist\n// |                ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\u5024\u914d\u5217\n// | \u5f15\u6570 $fld:field name\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $br:blank 0 \u6539\u884c\u3057\u306a\u3044 1\u301c9 \u6307\u5b9a\u6570\u6bce\u306b\u6539\u884c\n// | \u5f15\u6570 $disabled:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30e9\u30b8\u30f2\u30dc\u30bf\u30f3                                                   |\n// +---------------------------------------------------------------------------+\n//update 20130704\n{\n    \n    $retval = '';\n    if  ($br===\"\" ) {\n        $br=0;\n    }\n    $cnt=0;\n    foreach( $ary as $id => $value ){\n\n        //echo \"ary\".$i.\"=\".$ary[$i].\"<br>\";\n        $retval .= \"<input type='radio' NAME='$fld' $disabled VALUE='$id'\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( $id == $selected ){\n                $retval .= \" CHECKED=CHECKED \";\n            }\n        }\n        $retval .= \">$ary[$id]&nbsp\";\n        \n        if   ($br<>0){\n            $cnt++;\n            if  ($cnt==$br){\n                $retval .=\"<br\".XHTML.\">\";\n                $cnt=0;\n            }\n        }\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_getoptionlistary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    if  ($type==14 OR $type==18){\n        //$selectedary=array[];\n        $selectedary=explode(\":\",$selected);\n    }\n    if  ($size==\"\" OR $size==0){\n        $size=1;\n    }\n    $retval = '';\n\n    $retval .= \"<select \";\n    if ($type==14 OR $type==18){\n        $retval .= ' name=\"'.$fld.'[]\" ';\n        $retval .= ' multiple=\"multiple\" ';\n        $retval .= ' size=\"'.$size.'\"';\n    }else{\n        $retval .= ' name=\"'.$fld.'\"';\n    }\n    $retval .= $disabled.\">\".LB;\n    \n\tif  ($type==7 ){\n\t\tif  ($ary[0]==\"\"){\n        }else{\n            $retval .= \"<option value=''>{$lang_box['selectit']}</option>\".LB;\n        }\n\t}\n    \n    foreach($ary as $k => $v) {\n        $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n\t\t//echo \"k=\".$k.\"sa=\".$selectedary.\"s=\".$selected.\"<br>\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if  ($type==14 OR $type==18){\n                if( in_array($k,$selectedary) ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t    }else{\n                if( $k == $selected ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t\t}\n\t\t}\n\t\t$retval .= \">\";\n\n        $retval .= $v;\n        $retval .= \"</option>\".LB;\n\n    }\n\n    $retval .= '</select>';\n    \n    return $retval;\n}\n\n\n\nfunction DATABOX_getoptionlist(\n    $kind\n    ,$selected = 0\n    ,$relno=0\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$selectit=true\n    ,$selectlist=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getoptionlist($kind)\n// |      DATABOX_getoptionlist(\"fieldset\",$fieldset_id,0,$pi_name,\"\",0 );\n// |      DATABOX_getoptionlist(\"group\",$categorygroup_id,0,$pi_name,\"\",0 );\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:\u9805\u76ee\u7a2e\u985e\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $relno\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled\n// | \u5f15\u6570 $selectit\n// | \u5f15\u6570 $selectlist\u3000\u65e2\u5b9a\u30ea\u30b9\u30c8\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n//update 20101122,20110613,20120525,20140724\n{\nglobal $_CONF;\nglobal $_TABLES;\nglobal $LANG_configselects;\n    \n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n    \n    \n    $retval = '';\n\n    $retval .= \"<select name='$fname' $disabled>\".LB;\n    if ($selectit===\"all\"){\n        $retval .= \"<option value=\\\"all\\\">{$lang_box['selectall']}</option>\".LB;\n    }elseif ($selectit){\n        $retval .= \"<option value=0>{$lang_box['selectit']}</option>\".LB;\n    }\n    \n    \n    if ($kind==\"layout\"){\n        $retval .= \"<option value=0>{$lang_box['byconfig']}</option>\".LB;\n        $ary=$LANG_configselects[strtolower($pi_name)][22];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$v.\"\\\"\";\n            if( $v == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $k;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else if ($kind==\"language_id\"){\n        $retval .= \"<option value=0> </option>\".LB;\n        $ary=$_CONF['languages'];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n            if( $k == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $v;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else{\n        if ($kind==\"group\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_group'];\n            $fields= 'group_id,name,orderno';\n        }else if ($kind==\"parent\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_category'];\n            $fields= 'category_id,name,orderno';\n        }else if ($kind==\"fieldset\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n            $fields= 'fieldset_id,name,fieldset_id';\n        }else if ($kind==\"selectlist\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT kind,kind,kind';\n        }else if ($kind==\"selectlist_mst\"){\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$selectlist}'\";\n            if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }else if ($kind==\"fieldgroupno\"){\n            $where=\"kind='fieldgroup'\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT no,value,no';\n        }else if ($kind==\"csvsel\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_csv_sel'];\n            $fields= 'csv_sel_id,name,csv_sel_id*-1';\n        }else{\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$kind}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }\n        $retval .= COM_optionList (\n            $table\n            , $fields\n            , $selected,2,$where);\n    }\n    \n    \n    $retval .= '</select>';\n\n    if ($disabled===\"disabled\"){\n        $retval .= \"  <input type='hidden' name='{$fname}' value='{$selected}'>\";\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_dltbldt(\n    $filenm\n    ,$fld\n    ,$tbl\n    ,$where=\"\"\n    ,$order=\"\"\n    ,$pi_name=\"\"\n    ,$addition=false\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30fc\u30d6\u30eb\u306e\u30c7\u30fc\u30bf\u3092CSV\u5f62\u5f0f\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\n// | \u66f8\u5f0f DATABOX_dltbldt($filenm,$fld,$tbl,$where,$order,$type,$pi_name,false);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filenm :\n// | \u5f15\u6570 $fld :\n// | \u5f15\u6570 $tbl :\n// | \u5f15\u6570 $where :\n// | \u5f15\u6570 $order :\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $addition:false=\u8ffd\u52a0\u9805\u76ee\u306a\u3057\u3001 true=\u8ffd\u52a0\u9805\u76ee\u3042\u308a\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//20100910\n//@@@@@ \u8ffd\u52a0\u4e88\u5b9a\u3000\u30ab\u30c6\u30b4\u30ea\u3082\n{\n    global $_CONF;\n\n    $dm=\",\";//\u533a\u5207\u308a\u6587\u5b57\n    $ec=\"`\";//\u30d5\u30a3\u30fc\u30eb\u30c9\u56f2\u307f\u6587\u5b57\n\n    if ($addition){\n        $addition_def=DATABOX_getadditiondef($pi_name);\n    }\n\n    $retval=\"\";\n\n    //file output open\n    $curdatetime = date(\"Y_m_d_H_i_s\");\n    //$outfile = tempnam($_CONF['path_data'] .\"tmp\", $filenm);\n    $outfile = $_CONF['path_data'] . $filenm.\"_\".$curdatetime;\n    $file = @fopen( $outfile, 'w' );\n    if ( $file === false ) {\n        $retval .= \"ERR! \".$outfile .\" is not writable!<br \".XHTML.\">\" . LB;\n        return $retval;\n    }\n\n    //-----\n    $sql = \"SELECT DISTINCT \";\n    foreach($fld as $k => $v) {\n        $sql .=$k.\",\";\n    }\n    $sql=rtrim($sql,\",\");\n    $sql.= \" FROM \".$tbl;\n    if (!empty($where)) {\n        $sql.=\" WHERE \".$where;\n    }\n    if (!empty($order)) {\n        $sql.=\" ORDER BY \".$order;\n    }\n    //-----\n    $result = DB_query ($sql);\n    //-----1\u884c\u76ee\u30d8\u30c3\u30c0\n    $w='';\n    foreach($fld as $k => $v) {\n        $w .=$ec.$k.$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$s[$k1]['templatesetvar'].$ec.$dm;\n            }\n        }\n    }\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n\n    //-----2\u884c\u76ee\u30d8\u30c3\u30c0\n    $w=\"\";\n    foreach($fld as $k => $v) {\n        $w .=$ec.$v['name'].$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$addition_def[$k1]['name'].$ec.$dm;\n            }\n        }\n    }\n\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n    //-----3\u884c\u76ee\u4ee5\u964d\n    while( $A = DB_fetchArray( $result ) )    {\n\n        $w=\"\";\n        foreach($fld as $k => $v) {\n            $w .=$ec.$A[$k].$ec.$dm;\n        }\n//\n        if ($addition){\n            $wkary=DATABOX_getaddtionfields($A[\"id\"],$addition_def,$pi_name);\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                //echo \"k1=\".$k1.\"<br \".XHTML.\">\";\n\n\n                if (isset($wkary[$k1])) {\n                //echo \"wkary=\".$wkary[$k1].\"<br>\";\n                    $w .=$ec.$wkary[$k1].$ec.$dm;\n                }else{\n                //echo \"DD<br>\";\n                    $w .=$ec.$ec.$dm;\n                }\n            }\n        }\n        $w=rtrim($w,$dm);\n\n        $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n        fputs( $file, $w.LB);\n\n    }\n    fclose($file);\n    \n    $filename=basename($outfile).\".csv\";\n    $dir=dirname($outfile);\n\n    header (\"Content-Disposition: attachment; filename=$filename\");\n    header (\"Content-type: application/x-csv\");\n    readfile ($outfile);\n    flush();\n    \n    $rt=unlink($outfile);\n    \n    return \"\";\n}\n\nfunction DATABOX_getfeaturedimage(\n    $id\n    ,$pi_name\n    ,$mode=\"imgsrc\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  featuredimage\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_getfeaturedimage($id,$pi_name)\n// | typw14(\u5916\u753b\u50cf)\u8868\u793a\u3059\u308b\u5148\u982d\uff08\u9806\u756a\u304c\u82e5\u3044\uff09\u8ffd\u52a0\u9805\u76ee\u3092featuredimage\u3068\u3057\u3066\u53d6\u5f97\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:featuredimage\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $tbl1=$_TABLES[strtoupper($pi_name).'_addition'];\n    $tbl2=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $rt=\"\";\n\n    $sql = \"SELECT t1.value\";\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl1} AS t1\";\n    $sql .= \"  ,{$tbl2} AS t2\";\n    $sql .= \"  WHERE t1.id=\".$id;\n    $sql .= \"  AND t1.field_id =t2.field_id\";\n    $sql .= \"  AND t2.type=12\";\n    $sql .= \"  AND allow_display=0\";\n    $sql .= \"  ORDER BY orderno\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n        $value=$A['value'];\n        if  ($value<>\"\"){\n            $url=$_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n            $url.= $value ;\n            if  ($mode==\"imgsrc\"){\n                $rt='<img src=\"'.$url.'\" />';\n            }else{\n                $rt=$url;\n            }\n        }\n    }\n\n    return $rt;\n}\n\nfunction DATABOX_getheadercode(\n    $kind\n    ,$template\n    ,$pi_name\n    ,$id\n    ,$title\n    ,$meta_description\n    ,$meta_keywords\n    ,$description\n    ,$additionfields=\"\"\n    ,$addition_def=\"\"\n    ,$chk_user=\"\"\n    ,$fieldset_id=\"\"\n    ,$fieldset_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd HEADERCODE \u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_getheadercode(\"data\",$template,$pi_name,$A['id'],$A['title']\n// |         ,$A['meta_description'],$A['meta_keyword'],$A['description']);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570  $kind        \"data\",\"category\"\n// | \u5f15\u6570  $template\n// | \u5f15\u6570  $pi_name\n// | \u5f15\u6570  $id\n// | \u5f15\u6570  $title\n// | \u5f15\u6570  $meta_description\n// | \u5f15\u6570  $meta_keywords\n// | \u5f15\u6570  $description\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:HEADERCODE\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n    global $_IMAGE_TYPE;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $retval=\"\";\n    \n    $currenturl= COM_getCurrentURL();\n    $site_logo= $_CONF['layout_url'] . '/images/logo.' . $_IMAGE_TYPE ;\n\n    $og_type=\"article\";\n    $og_title=$title;\n    \n    if ($box_conf['meta_tags'] > 0) {\n         $retval .= COM_createMetaTags($meta_description, $meta_keywords);\n    }\n\n    if ($_CONF['meta_tags']==0 OR $meta_description==\"\") {\n        $og_description = $description;\n    }else{\n        $og_description = $meta_description;\n    }\n    $og_description= COM_getTextContent(PLG_replaceTags($og_description));\n        \n    \n    if ($kind===\"data\"){\n        $og_image =DATABOX_getfeaturedimage($id,$pi_name,\"url\");\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }else{\n        $og_image =$box_conf[\"default_img_url\"];\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }\n    \n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath($kind,$template,$pi_name);\n    if (file_exists ($tmplfld.\"/headercode.thtml\")) {\n        $tpl = new Template($tmplfld);\n        $tpl->set_file (array (\n            'tpl' => 'headercode.thtml',\n            ));\n    \n        $tpl->set_var('xhtml', XHTML);\n        $tpl->set_var('site_url', $_CONF['site_url']);\n        $tpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n        $tpl->set_var('layout_url', $_CONF['layout_url']);\n        \n        $tpl->set_var ('currenturl', $currenturl);\n        \n        $tpl->set_var ('site_name', $_CONF['site_name']);\n        $tpl->set_var ('site_mail', $_CONF['site_mail']);\n        \n        $tpl->set_var ('og_title', $og_title);\n        $tpl->set_var ('og_image', $og_image);\n        $tpl->set_var ('og_description', $og_description);\n        $tpl->set_var ('og_type', $og_type);\n        $tpl->set_var ('fieldset_name', $fieldset_name);\n        \n        //facebook\n        $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n        $tpl->set_var ('facebook_consumer_key', $facebook_consumer_key);\n        \n        if ($kind===\"data\"){\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$tpl,$chk_user,$pi_name,$fieldset_id);\n        }\n    \n        $tpl->parse ('output', 'tpl');\n        $retval .= $tpl->finish ($tpl->get_var ('output'));\n    }\n    return $retval;\n}\n\nfunction DATABOX_getfields(\n    $pi_name\n    , $fieldset_id\n)\n{\n    global $_TABLES;\n    \n    if ($fieldset_id==0){\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    }\n    $fields = array();\n\n    // Get a list of additionfields in the selected field\n    $sql  = \"SELECT DISTINCT field_id \";\n    $sql  .= \" FROM {$table}\";\n    \n    if ($fieldset_id<>0){\n        $sql  .= \" WHERE  \";\n        $sql  .= \" fieldset_id = $fieldset_id\";\n    }\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    \n    if ($num<>0){\n        while ($A = DB_fetchArray($result)) {\n            $fields[] = $A['field_id'];\n        }\n    }\n    \n    return $fields;\n}\n\n\nfunction DATABOX_getAry(\n    $kind\n    ,$relno=0\n    ,$selectlist\n    ,$pi_name=\"\"\n)\n{\n    global $_TABLES;\n\n//    if ($kind==\"selectlist_mst\"){\n        $table=$_TABLES[strtoupper($pi_name).'_mst'];\n        $where=\" WHERE kind='{$selectlist}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n        $fields= 'no,value';\n        $order=\" ORDER BY orderno\"; \n//    }\n\n    $ary=array();\n    $sql = \"SELECT \";\n    $sql .= $fields ;\n    $sql .= \" FROM \" ;\n    $sql .= $table ;\n    $sql .= $where ;\n    $sql .= $order ;\n\n    $result = DB_query($sql);\n    $nrows = DB_numRows($result);\n    for( $i=0; $i < $nrows; $i++) {\n         $A = DB_fetchArray($result, true);\n         $ary[$A[0]] = $A[1];\n    }\n    return $ary;\n}\n\nfunction DATABOX_categorycount(\n    $pi_name\n    ,$categorygroup_id \n    ,$categorygroup_code \n    ,$permission=\"\"\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_categorycount()\n// | \u66f8\u5f0f  databox_categorycount(1)\n// | \u66f8\u5f0f  databox_count(\"\",\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $group_id:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// | \u5f15\u6570 $group_code:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\n// | \u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id \u3082\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\u3082\u6307\u5b9a\u306a\u3044\u5834\u5408\u306f\n// | \u89aa\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u306a\u3057\u306e\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\n// | \uff08\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u3042\u308b\u30c7\u30fc\u30bf\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u306a\u3044\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\u306f\u542b\u307f\u307e\u305b\u3093\uff09\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    //-----\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n    $tbl1=$_TABLES[strtoupper($pi_name).'_category'] ;\n    $tbl4=$_TABLES[strtoupper($pi_name).'_def_group'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_base'] ;\n    if ($categorygroup_id ==\"\" AND $categorygroup_code==\"\") {\n        $categorygroup_id=0;\n    }else{\n        if  ($categorygroup_id==\"\"){\n            $categorygroup_id=DATABOX_codetoid(    $categorygroup_code,strtoupper($pi_name).'_def_group',\"group_id\");\n            if  ($categorygroup_id==0){\n                return 0;\n            }\n        }\n    }\n    \n\n    //-----\n    $sql = \"SELECT \".LB;\n    $sql .= \" t1.category_id\".LB;\n    //$sql .= \" ,Count(t1.id) AS count\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.id = t2.id \".LB;\n    $sql .= \" AND t1.category_id = t3.category_id \".LB;\n    $sql .= \" AND t3.categorygroup_id = \".$categorygroup_id.LB;\n    $sql .= \" AND t3.categorygroup_id = t4.group_id \".LB;\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND',0,2,\"t2\").LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    \n    $sql .= \" GROUP BY \".LB;\n    $sql .= \" t1.category_id\".LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_Confirmation(\n    $pi_name\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u78ba\u8a8d\u753b\u9762\n// | \u66f8\u5f0f Con_firmation(\"databox\")\n//   fnc_Confirmation proversion\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $mode:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $LANG_ADMIN;\n\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $tmpl = new Template ($_CONF['path'] . \"plugins/\".THIS_PLUGIN.\"/templates/admin/\");\n    $tmpl->set_file(array('confirm' => 'confirmation.thtml'));\n\n\n    $tmpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n    $tmpl->set_var('gltoken_name', CSRF_TOKEN);\n    $tmpl->set_var('gltoken', SEC_createToken());\n    $tmpl->set_var ( 'xhtml', XHTML );\n\n    //\n    $actionname=$lang_box_admin[$mode];\n    $actionprg=\"{$_CONF['site_admin_url']}/plugins/\".THIS_SCRIPT.\"?mode={$mode}exec\";\n\n    $tmpl->set_var('actionname', $actionname);\n    $tmpl->set_var('actionprg', $actionprg);\n    \n    $tmpl->set_var('help', $lang_box_admin[$mode.'msg']);\n    $btn_value=$LANG_ADMIN['submit'];\n    $confirm_value=$lang_box_admin['confirm'];\n    $btn2=\"\";\n    $btn3=\"\";\n    if ($mode===\"datadelete\"){\n        $tmpl->set_var('lang_checklist', $lang_box_admin['fieldset'].\":\");\n        $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name);\n        $tmpl->set_var('checklist', $checklist);\n        $btn_value=$lang_box_admin['delete1'];\n        $confirm_value=$lang_box_admin['delete1'].\" \".$lang_box_admin['confirm'];\n        $confirm_value2=$lang_box_admin['delete2'].\" \".$lang_box_admin['confirm'];\n        $confirm_value3=$lang_box_admin['delete3'].\" \".$lang_box_admin['confirm'];\n        $btn2=\"<input type='submit' name='action' value='{$lang_box_admin['delete2']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value2}');\\\"\".xhtml.\">\".LB;\n        $btn3=\"<input type='submit' name='action' value='{$lang_box_admin['delete3']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value3}');\\\"\".xhtml.\">\".LB;\n    }\n\n    // SAVE\u3001CANCEL \u30dc\u30bf\u30f3\n    $tmpl->set_var('lang_confirm', $confirm_value);\n    $tmpl->set_var('lang_submit', $btn_value);\n    $tmpl->set_var('btn2', $btn2);\n    $tmpl->set_var('btn3', $btn3);\n    $tmpl->set_var('lang_cancel', $LANG_ADMIN['cancel']);\n    $tmpl->set_var('mode', $mode.\"exec\");\n\n    $tmpl->parse ('output', 'confirm');\n    $comfirm = $tmpl->finish ($tmpl->get_var ('output'));\n\n    $retval = $comfirm;\n\n\n    return $retval;\n}\n\n//==============================================================================\n//lib_datetimeedit.php \u2192\nfunction DATABOX_datetimeedit(\n    $datetime_value\n    ,$lang\n    ,$datetime_name=\"datetime\"\n    ,$mode=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    if ($datetime_value==\"\"){\n        $datetime_year = date('Y');\n        $datetime_month = date('m');\n        $datetime_day = date('d');\n        //\n        $datetime_hour = date ('H');\n        $datetime_minute = date ('i') ;\n    }else{\n        $datetime_year = date('Y', $datetime_value);\n        $datetime_month = date('m', $datetime_value);\n        $datetime_day = date('d', $datetime_value);\n        //\n        $datetime_hour = date ('H', $datetime_value);\n        $datetime_minute = date ('i', $datetime_value) ;\n    }\n    \n    $rt=\"\";\n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_year);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_month);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_day);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($mode===\"datetime\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_hour, 24);\n        }else{\n            $datetime_hour_wk=$datetime_hour;\n            if ($datetime_hour_wk >= 12) {\n                if ($datetime_hour_wk > 12) {\n                    $datetime_hour_wk = $datetime_hour_wk - 12;\n                }\n                $ampm = 'pm';\n            } else {\n                $ampm = 'am';\n            }\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $ampm);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_hour_wk);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_minute);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_datetimeedit_R(\n    $datetime_ary\n    ,$lang\n    ,$datetime_name=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    \n    if  (!is_array($datetime_ary)){\n        return \"\";\n    }\n    \n    $rt=\"\";\n    \n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_ary['year']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_ary['month']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_ary['day']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($datetime_ary['hour']<>\"\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour'], 24);\n        }else{\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $datetime_ary['ampm']);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour']);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_ary['minute']);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n//==============================================================================\n//lib_outlog.php \u2192\n//log \u51fa\u529b\u30e2\u30fc\u30c9\u8a2d\u5b9a\u30000:\u4f5c\u6210\u3057\u306a\u3044,1:\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b 2:\u753b\u9762\u306b\u3082\u51fa\u529b\n//$logmode =2;\n//$logfile = $_CONF['path_log'] . \"profile_point.log\";\n\n//echo OutLog( \"----- photomailcheck.php start\",$logmode);\n\n\n// \u30ed\u30b0\u51fa\u529b\u51e6\u7406\nfunction DATABOX_OutLog( $logentry ,$logfile,$logmode=1)\n{\n    global $_CONF,$LANG01;\n\n    $retval = '';\n\n    if (!empty($logmode)) {\n        if( !empty( $logentry )) {\n            $logentry = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),\n                                     $logentry );\n\n            $timestamp = strftime( '%c' );\n\n            if (!file_exists($logfile)) {\n                echo $logfile .\"  doesn't exist. \";\n                exit();\n            }\n            if (!is_writable($logfile)) {\n                echo $logfile .\" cannot be written. \";\n                exit();\n            }\n\n            $file = fopen( $logfile, 'a' );\n\n            if( empty($file)) {\n                $retval .= $LANG01[33] . ' ' . $logfile . ' (' . $timestamp . ')<br/><br/>' . LB;\n            } else {\n                fputs( $file, \"$timestamp - $logentry\\n\" );\n            }\n\n            if ($logmode ==2){\n                $retval .=\"$timestamp - $logentry<br/>\" . LB;\n            }\n        }\n    }\n\n    return $retval;\n}\n//==============================================================================\n//lib_getfilelist.php \u2192\n// \u6307\u5b9a\u30d5\u30a9\u30eb\u30c0\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u89a7\u3092\u53d6\u5f97\nfunction DATABOX_getfilelist(\n    $fd\n    ,$exte =\"\"\n)\n{\n    $fary= array();\n    $dir=opendir($fd);\n    while(($ent = readdir()) !==FALSE){\n        if  ($exte==\"\") {\n           $fary[$i] = $ent;\n           $i++;\n        }else{\n            $w=explode('.',$ent);\n            if (strtolower($w[1])===$exte){\n               $fary[$i] = $ent;\n               $i++;\n            }\n        }\n    }\n    return $fary;\n\n}\nfunction DATABOX_getDateTimeFormat( $date,$format )\n{\n    if( empty( $date ))    {\n        $stamp = time();\n    } else if( is_numeric( $date )){\n        $stamp = $date;\n    }else{\n        $stamp = strtotime( $date );\n    }\n    $date = strftime( $format, $stamp );\n    return array( $date, $stamp );\n}\nfunction DATABOX_getTimeFormat( $value )\n{\n    $rt=\"\";\n    if  ($value==\"\"){\n        $rt=\"\";\n    }else{\n        if  ($_CONF['hour_mode']=='24'){\n            $rt=date('H:i', $value );\n        }else{\n            $rt=date('h:i', $value );\n            if  (date('H',$value)>=12){\n                $rt.=\" PM\";\n            }else{\n                $rt.=\" AM\";\n            }\n        }\n    }\n    return $rt;\n}\n\nfunction DATABOX_fieldvalue(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$option = \"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_fieldvalue($pi_name,$id,$code,$field_id,$field_code,$option)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $option:'','name','description','yes','value2','disp','no'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    global $_PLUGINS;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"\";\n    }\n    if (is_null($field_id)){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"\";\n        }\n    }\n          \n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.type \".LB;\n    $sql  .= \" ,m.name \".LB;\n    $sql  .= \" ,m.description \".LB;\n    $sql  .= \" ,m.selection \".LB;\n    $sql  .= \" ,m.selectlist \".LB;\n    $sql  .= \" ,m.dfid \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.allow_display = 0 \".LB;\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n        if  ($option==\"name\"){\n            $rt=$A['name'];\n        }else if ($option==\"description\"){\n            $rt=$A['description'];\n        }else if ($option==\"datatitle\"){\n            if (in_array('databox', $_PLUGINS)) {\n                $rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"title\",\"code='{$A['value']}'\"));\n            }\n        }else if ($option==\"datadescription\"){\n            if (in_array('databox', $_PLUGINS)) {\n\t\t\t\t$rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"description\",\"code='{$A['value']}'\"));\n            }\n        }else{\n            $selectionary=DATABOX_getselectionary($A['selection']);\n            $selectlist=$A['selectlist'];\n            $type=$A['type'];\n            $value=$A['value'];\n            $dfid= $A['dfid'];\n            $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n            if( empty( $format )) {\n                $format = $_CONF['date'];\n            }\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($value===\"\"){\n                    }else{\n                        list($readfile,$rt)=explode(\"|\",$value);\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($value===\"\"){\n                    }else{\n                        $rt=\"<img src=\\\"data:image/jpg;base64,\";\n                        $rt .=\"{$value}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    if  ($option==\"yes\"){\n                        if  ($value==1){\n                            $rt=1;\n                        }\n                    }else{\n                        $rt= $lang_noyes[$value];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $rt= $selectionary[$value];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $rt= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($value);\n                    $w=DATABOX_autolink($w);\n                    $rt= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$value,$pi_name);\n                    $rt= $mstitems['value'];\n                    if  ($option==\"value2\"){\n                        $rt= $mstitems['value2'];\n                    }else if  ($option==\"disp\"){\n                        $rt= $mstitems['disp'];\n                    }else if  ($option==\"no\"){\n                        $rt= $mstitems['no'];\n                    }else{\n                        $rt= $mstitems['value'];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    $wk_no=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                        $wk_no.=$mstitems['no'].$separater;\n                    }\n                    if  ($option==\"value2\"){\n                        $rt= rtrim($wk_value2,$separater);\n                    }else if  ($option==\"disp\"){\n                        $rt= rtrim($wk_disp,$separater);\n                    }else if  ($option==\"no\"){\n                        $rt= rtrim($wk_no,$separater);\n                    }else{\n                        $rt= rtrim($wk,$separater);\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($value<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($value,$format);\n                        $rt= $w[0];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\n                    if  ($value<>\"\"){\n                        $rt=strftime( $_CONF['shortdate'], $value );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $rt= number_format( (float)$value, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $rt= $value;\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_fieldownload(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30a1\u30a4\u30eb\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9 \n// | \u66f8\u5f0f DATABOX_fieldownload($pi_name,$id,$code,$field_id,$field_code)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $mode \u30ca\u30b7\u3001display\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n     \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)  OR $id===\"\"){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"download argument error id\";\n    }\n    if (is_null($field_id) OR $field_id===\"\"){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"download Argument error field_id\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"download drgument error id field_id\";\n        }\n\t}\n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.allow_display \".LB;\n    $sql  .= \" ,d.group_id \".LB;\n    $sql  .= \" ,d.owner_id \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    $sql  .= \" , {$table_base} AS d\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.type = 13 \".LB;\n    $sql  .= \" AND d.id = {$id} \".LB;\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND d.draft_flag=0\".LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\";\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n\t$result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"Target file is not found\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\t\t$value=$A['value'];\n        $group_id = $A['group_id'];\n\t\t$owner_id = $A['owner_id'];\n\t\t$allow_display= $A['allow_display'];\n        $chk_user=DATABOX_chkuser($group_id,$owner_id,$pi_name.\".admin\");\n\t\tif  ($value<>\"\"){\n\t\t\t\n            $chk=false;\n            //\u8868\u793a\u3059\u308b\n            if  ($allow_display==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($allow_display==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($allow_display==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n            //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n\t\t\tif ($chk) {\n\t\t\t\tlist($readfile,$filename)=explode(\"|\",$value);\n\t\t        list($dummy,$extention)=explode(\".\",$filename);\n\t\t        $filetype=DATABOX_getFileTypeAry($extention );\n\t\t        if  ($filetype<>\"\"){\n                    $path=$box_conf['file_path'];\n                    if  (file_exists($path.$readfile)){\n                        if  ($mode==\"display\"){\n                            if  ($extention==\"pdf\"){\n                                header('Content-Type: '.$filetype);\n                                header('Content-Disposition: inline; filename=\"'.$filename.'\"');\n                                readfile($path.$readfile);\n                                //download log\n                                //download count\n                                exit;\n                            }\n                        }else{\n                            header('Content-Type: '.$filetype);\n                            header('Content-Disposition: attachment; filename=\"'.$filename.'\"');\n                            readfile($path.$readfile);\n                            //download log\n                            //download count\n                            exit;\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    return $rt;\n\n}\nfunction DATABOX_getFileTypeAry(\n    $extension \n)\n{\n    $ary=array();\n    $ary['odt']=\"application/vnd.oasis.opendocument.text\";//open office writer*\n    $ary['doc']=\"application/msword\";//Microsoft Word\n    $ary['docx']=\"application/vnd.openxmlformats\";// Microsoft Office Word 2007*\n    $ary['html']=\"text/html\";\n    $ary['odb']=\"application/octet-stream \";//OpenOffice Base*\n    $ary['odf']=\"application/vnd.oasis.opendocument.formula\";//OpenOffice Calc*\n    $ary['odg']=\"application/vnd.oasis.opendocument.graphics\";//OpenOffice Draw*\n    $ary['odm']=\"application/vnd.oasis.opendocument.text-master\";// OpenOffice Writer*\n    $ary['odp']=\"application/vnd.oasis.opendocument.presentation\";//OpenOffice Impress*\n    $ary['ods']=\"application/vnd.oasis.opendocument.spreadsheet\";//OpenOffice Calc*\n    $ary['otg']=\"application/vnd.oasis.opendocument.graphics-template\";//OpenOffice Draw*\n    $ary['oth']=\"application/octet-stream\";// OpenOffice.org Writer*\n    $ary['otp']=\"application/vnd.oasis.opendocument.presentation-template\";//OpenOffice Impress*\n    $ary['ots']=\"application/octet-stream\";//OtsAV*\n    $ary['ott']=\"application/vnd.oasis.opendocument.formula-template \";//OpenOffice Writer*\n    $ary['oxt']=\"application/vnd.openofficeorg.extension\";//OpenOffice *\n    $ary['pdf']=\"application/pdf\";\n    $ary['ppt']=\"application/mspowerpoint\";//Microsoft PowerPoint*\n    $ary['pptx']=\"application/vnd.openxmlformats\";//Microsoft Office PowerPoint 2007*\n    $ary['txt']=\"text/plain\";\n    $ary['xls']=\"application/vnd.ms-excel\";//Microsoft Excel*\n    $ary['xlsx']=\"application/vnd.openxmlformats \";//Microsoft Office Excel 2007*\n    $ary['xml']=\"text/xml\";\n\tif  ($extention===\"\"){\n\t\t$rt= $ary;\n\t}else{\n\t\t$rt= $ary[$extension];\n\t}\n\treturn $rt;\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_count_each_afield(\"class\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n\nfunction DATABOX_count_each_afield(\n    $pi_name=\"databox\"\n    ,$templatesetvar=\"\"\n    ,$value=\"\"\n    ,$type_id=0\n    ,$permission=''\n    ,$numberformat=''\n)\n{\n    global $_TABLES;\n\n    if ($templatesetvar==\"\" OR $value==\"\" ){\n        return \"\";\n    }\n\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n    \n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" t1.id\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    $sql .= \" AND fieldset_id = \".$type_id.LB;\n\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\n    $sql .= \" AND t2.value='\". $value .\"'\".LB;\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_math(\n    $pi_name= 'databox'\n    ,$method= 'count'\n    ,$templatesetvar=\"\"\n    ,$type_id=\"\"\n    ,$category_id=null\n    ,$category_code=null\n    ,$mode=''\n    ,$roundprecision=''\n    ,$numberformat=''\n    ,$permission=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306e\u6307\u5b9a\u5024\uff08count average max min sum\uff09\u3092\u53d6\u5f97\u3059\u308b\n// |       \u8907\u6570\u30ab\u30c6\u30b4\u30ea\u6761\u4ef6\u9078\u629e\u304c\u53ef\u80fd\uff08OR \u3068 AND\uff09\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_math(\"databox\",\"count\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $method:count average avg max min sum\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $category_code :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// | \u5f15\u6570 $roundprecision:\u301c-3,-2,-1,0,1,2,3\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u5024\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($templatesetvar==\"\" ){\n        return \"\";\n    }\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n\t\n\t$method=strtoupper($method);\n    if  ($method==\"MAX\" OR $method==\"MIN\" OR $method==\"SUM\" OR $method==\"AVG\" OR $method==\"COUNT\" ){\n    }else if  ($method==\"AVERAGE\" ){\n\t    $method=\"AVG\";\n\t}else{\n\t    $method=\"COUNT\";\n\t}\n    //-----category check\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,strtoupper($pi_name).'_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $tbl4=$_TABLES[strtoupper($pi_name).'_category'] ;\n\t$tbl5=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n\t\n    $type=DB_getItem( $tbl3   ,\"type\",\"templatesetvar='{$templatesetvar}'\");\n\t\n    //-----\n    $sql = \"SELECT \".LB;\n    \n    if  ($type==15  OR $type==21 OR strtoupper($numberformat)==\"YES\") {\n        $sql .= $method .\"(t2.value + 0) AS rt\".LB;\n    }else{\n        $sql .= $method .\"(t2.value) AS rt\".LB;\n    }\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    \n    $sql .= \" AND fieldset_id=\".$type_id;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\t\n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t4.category_id\";\n                $w.=\" FROM {$tbl4} AS t4 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t1.id = t4.id AND t4.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t1.id IN (SELECT id FROM {$tbl4} AS t4 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t4.category_id = t5.category_id AND t5.allow_display<2 AND t4.category_id IN ({$ids})) \";\n        }\n        $sql.=\" AND ({$w})\".LB;\n    }\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\t\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n\t\t$A = array_map('stripslashes', $A);\n\t\t$rt=$A['rt'];;\n\t}else{\n\t\tif  ($method==\"COUNT\"){\n\t\t\t$rt=0;\n\t\t}else{\n\t\t\t$rt=\"\";\n\t\t}\n\t}\n\t\n    if ( is_numeric($rt) ) {\n        if  (!is_numeric($roundprecision)){\n            $roundprecision=0;\n        }\n        $rt=round($rt,$roundprecision);\n        if  (strtoupper($numberformat)==\"YES\"){\n            $rt=number_format( $rt, \n                $roundprecision, $_CONF['decimal_separator'], $_CONF['thousand_separator'] );\n        }\n    }\n    return $rt;\n\t\n\t\n}\nfunction DATABOX_getcheckboxary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\t\n    $selectedary=explode(\":\",$selected);\n\t\n\t$retval = '';\n\t\n    foreach($ary as $k => $v) {\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fld . '[]\" value=\"' . $k ;\n        $retval .= '\"';\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( in_array($k,$selectedary) ){//@@@@@\n                $retval .= ' checked=\"checked\"';\n\t\t\t}\n\t\t}\n        $retval .= '>' . stripslashes( $v ) . '</span>' . LB;\n\n    }\n    return $retval;\n}\n\n?>", "<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | UserBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | \u81ea\u52d5\u30bf\u30b0\u304a\u3088\u3073 UserBox \u5c02\u7528\u95a2\u6570\n// +---------------------------------------------------------------------------+\n// $Id: plugins/userbox/functions_autotag.inc\n//20101223 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n//20120416 userbox_category {data_edit}\n\nif (strpos ($_SERVER['PHP_SELF'], 'functions_autotag.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n\n//=====\u81ea\u52d5\u30bf\u30b0=================================================================\nfunction plugin_autotags_userbox (\n    $op\n    , $content = ''\n    , $autotag = '')\n// +---------------------------------------------------------------------------+\n// | \u81ea\u52d5\u30bf\u30b0\n// | \u66f8\u5f0f plugin_autotags_userbox ($op, $content, $autotag)\n// +---------------------------------------------------------------------------+\n// 20101229\n{\n    global $_TABLES;\n    global $_CONF;\n    global $LANG_USERBOX_autotag_desc;\n         \n    //Option Display\n    if ($op == 'tagname' ) {\n        $tagname[]='userbox';\n        return $tagname;\n    } elseif ($op == 'permission' || $op == 'nopermission') {\n        if ($op == 'permission') {\n            $flag = true;\n        } else {\n            $flag = false;\n        }\n\n        if (isset($_GROUPS['UserBox Admin'])) {\n            $group_id = $_GROUPS['UserBox Admin'];\n        } else {\n            $group_id = DB_getItem($_TABLES['groups'], 'grp_id',\n                                   \"grp_name = 'UserBox Admin'\");\n        }\n        $owner_id = SEC_getDefaultRootUser();\n\n        if (COM_getPermTag(\n            $owner_id\n            , $group_id\n            , $_USERBOX_CONF['autotag_permissions_userbox'][0]\n            , $_USERBOX_CONF['autotag_permissions_userbox'][1]\n            , $_USERBOX_CONF['autotag_permissions_userbox'][2]\n            , $_USERBOX_CONF['autotag_permissions_userbox'][3]) == $flag) {\n            return $tagname;\n        }\n\n    } elseif ($op == 'description') {\n        return $LANG_USERBOX_autotag_desc;\n    } else if ($op == 'parse') {\n        //\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n        $p1 = COM_applyFilter ($autotag['parm1']);\n        $p2 = COM_applyFilter ($autotag['parm2']);\n        $tag = COM_applyFilter ($autotag['tag']);\n        $tagstr = COM_applyFilter ($autotag['tagstr']);\n        \n        $parm2_ary[]=\"category_id\";\n        $parm2_ary[]=\"category_code\";\n        $parm2_ary[]=\"mode\";\n        $parm2_ary[]=\"rss_file\";\n        $parm2_ary[]=\"title_trim_length\";\n        $parm2_ary[]=\"intervalday\";\n        $parm2_ary[]=\"limitcnt\";\n        $parm2_ary[]=\"newmarkday\";\n        $parm2_ary[]=\"templatedir\";\n        $parm2_ary[]=\"id\";\n        $parm2_ary[]=\"uid\";\n        $parm2_ary[]=\"username\";\n        $parm2_ary[]=\"code\";\n        $parm2_ary[]=\"nohitmsg\";\n        $parm2_ary[]=\"perpage\";\n        $parm2_ary[]=\"page\";\n        $parm2_ary[]=\"order\";\n        $parm2_ary[]=\"templatesetvar\";\n        $parm2_ary[]=\"value\";\n        $parm2_ary[]=\"field_id\";\n        $parm2_ary[]=\"expired\";\n        $parm2_ary[]=\"group_id\";\n        $parm2_ary[]=\"group_code\";\n        $parm2_ary[]=\"field_code\";\n        $parm2_ary[]=\"option\";\n        $parm2_ary[]=\"method\";\n        $parm2_ary[]=\"roundprecision\";\n        $parm2_ary[]=\"numberformat\";\n        $parm2_ary[]=\"permission\";\n        $p=userbox_parm2($p2,$parm2_ary);\n\n        //\u5404\u51e6\u7406\n        switch( $tag ) {\n            case 'userbox' :\n                switch($p1) {\n                    case 'count':\n                        $rt= userbox_count(\n                            $p['category_id']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n                    case 'newlist':\n                            if ($p['category_id']<>\"\"){\n                                $m=\"id\";\n                                $categories=$p['category_id'];\n                            }elseif ($p['category_code']<>\"\") {\n                                $m=\"code\";\n                                $categories=$p['category_code'];\n                            }else{\n                                $m=\"ALL\";\n                                $categories=\"\";\n                            }\n                            $rt= userbox_newlist(\n                            $m\n                            ,$categories\n                            ,$p['rss_file']\n                            ,$p['title_trim_length']\n                            ,$p['intervalday']\n                            ,$p['limitcnt']\n                            ,$p['newmarkday']\n                            ,$p['templatedir']\n                            );\n                        break;\n\n                    case 'profile':\n                        $w= userbox_profile(\n                            $p['uid']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,\"\"\n                            ,$p['username']\n                            );\n                        $rt=$w['display'];\n                        break;\n                    case 'category':\n                        $rt= userbox_category(\n                            \"autotag\"\n                            ,$p['category_id']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['expired']\n                        );\n                        break;\n                    case 'attributedatacount':\n                        $rt=DATABOX_count_each_afield(\n                            \"userbox\"\n                            ,$p['templatesetvar']\n       \t                    ,$p['value']\n                            ,$p['type_id']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n                    case 'lastmodified':\n                        $rt= userbox_grp(\n                            \"modified\"\n                            ,\"max\"\n                            ,\"lastmodified\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                        break;\n                    case 'lastcreated':\n                        $rt= userbox_grp(\n                            \"created\"\n                            ,\"max\"\n                            ,\"lastcreated\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                            break;\n                    case 'attribute':\n                        $rt= userbox_field(\n                            \"autotag\"\n                            ,$p['field_id']\n                            ,$p['value']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['field_code']\n                        );\n                        break;\n                    case 'msg':\n                        $rt=userbox_msg($p['for']) ;\n                        break;\n                    case 'categorycount':\n                        $rt= DATABOX_categorycount(\n                             \"userbox\"\n                            ,$p['group_id']\n                            ,$p['group_code']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                        );\n                        break;\n                    case 'attributevalue':\n                        $rt=DATABOX_fieldvalue(\n                                \"userbox\"\n                                ,$p['id']\n                                ,$p['code']\n                                ,$p['field_id']\n                                ,$p['field_code']\n                                ,$p['option']\n                            );\n                        break;\n                    case 'math':\n                        $rt=DATABOX_math(\n                                \"userbox\"\n                                ,$p['method']\n                                ,$p['templatesetvar']\n                                ,$p['type_id']\n                                ,$p['category_id']\n                                ,$p['category_code']\n                                ,$p['mode']\n                                ,$p['roundprecision']\n                                ,$p['numberformat']\n                                ,$p['permission']\n                            );\n                        break;\n                }\n\n                $content = str_replace ($autotag['tagstr'], $rt, $content);\n                return $content;\n        }\n    }\n}\n\n \n\n//\u7b2c\u4e8c\u5f15\u6570\u5206\u5272\nfunction userbox_parm2 ($p2,$parm2_ary)\n{\n    $ary=array();\n    $px = explode (' ', trim ($p2));\n    if (is_array ($px)) {\n        foreach ($px as $part) {\n            $a = explode (':', $part);\n            if (in_array($a[0],$parm2_ary)){\n                $ary[\"{$a[0]}\"]=$a[1];\n                $skip++;            \n            }\n        }\n        \n        if (count ($px) > $skip) {\n            for ($i = 0; $i < $skip; $i++) {\n                array_shift ($px);\n            }\n            $ary[\"lastparm2\"] = trim(implode (' ', $px));\n        }\n\n    }else{\n        $ary[\"lastparm2\"]=trim($p2);\n    }\n    \n    return $ary;\n\n}\n//=====\u30d6\u30ed\u30c3\u30af\u95a2\u6570============================================================\nfunction phpblock_shownewuserbox()\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740data\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f phpblock_shownewuserbox()                                            |\n// +---------------------------------------------------------------------------+\n{\n    return userbox_newlist();\n}\n//=====\u5c02\u7528\u95a2\u6570============================================================\n//\nfunction userbox_category(\n    $autotag\n    ,$category_id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$category_code=null\n    ,$mode=''\n    ,$expired=''\n)\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f  userbox_category($id,$template,\"yes\",\"page\",$perpage)\n// | \u66f8\u5f0f  userbox_category($p['category_id'],$p['thtml'],$p['nohitmsg']\n// | \u66f8\u5f0f                    ,\"\",$p['perpage'],$p['order'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $m             :\"page\"\u306e\u6642\u30d8\u30c3\u30c0\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $code          :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// +---------------------------------------------------------------------------+\n// | public_html/category.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:category list\n// +---------------------------------------------------------------------------+\n{\n    $pi_name=\"userbox\";\n\n    global $_CONF;\n    global $_TABLES;\n\n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n    global $LANG_USERBOX_ADMIN;\n    global $LANG28;\n    global $_USER;\n    \n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n\n    \n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_USERBOX_CONF['loginrequired'] >1) ){\n            return $LANG_USERBOX['loginrequired'];\n        }\n\n    }\n\n    //-----\u30c6\u30fc\u30d6\u30eb\n    $tbl1=$_TABLES['USERBOX_category'] ;\n    $tbl2=$_TABLES['USERBOX_base'] ;\n    $tbl3=$_TABLES['USERBOX_addition'] ;\n    $tbl4=$_TABLES['users'] ;\n    //\n    $tbl5=$_TABLES['USERBOX_def_category'] ;\n    \n    $tbl6=$_TABLES['USERBOX_stats'];\n    \n    $datefield=$_USERBOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n    $new_img=$_USERBOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_USERBOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,'USERBOX_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    \n    //--CATEGORY\n    $category_name=\"\";\n    $defaulttemplatesdirectory = \"\";\n    if (count($idsary)<>0){\n        \n        for ($i = 0; $i < count($idsary); $i++) {\n            $sql = \"SELECT \";\n            $sql .= \" name \".LB;\n            $sql .= \" ,code \".LB;\n            $sql .= \" ,description \".LB;\n            $sql .= \" ,defaulttemplatesdirectory\".LB;\n            $sql .= \" FROM \".LB;\n            $sql .= \" {$tbl5} AS t5 \".LB;\n            $sql .= \" WHERE \".LB;\n            $sql .= \" t5.category_id =\".$idsary[$i].LB;\n        \n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n            if ($numrows > 0) {\n                $A = DB_fetchArray ($result);\n                $category_name.=COM_applyFilter($A['name']).\" \";\n                $category_description.=COM_applyFilter($A['description']).\" \";\n                if ($i==0){\n                    $defaulttemplatesdirectory=COM_applyFilter($A['defaulttemplatesdirectory']);\n                }\n            }\n        }\n    }\n\n    if (is_null($template) or ($template===\"\")){\n        if ($defaulttemplatesdirectory===\"\"){\n            $template=\"default\";\n        }else{\n            $template=$defaulttemplatesdirectory;\n        }\n    }\n    \n    //\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_USERBOX_CONF['perpage'];\n    }\n    //\n    $w=userbox_orderby($datefield,$order,$orderby,$addfieldorder,$field_id);\n\n    //-----    \n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.fieldset_id \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n\n    $sql .= \" ,t4.username\";\n    $sql .= \" ,t4.fullname\";\n    $sql .= \" ,t4.photo\";\n    $sql .= \" ,t4.email\";\n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n    \n    //--FROM\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n    \n    //--WHERE\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t2.id=t4.uid \".LB;\n\n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t1.category_id\";\n                $w.=\" FROM {$tbl1} AS t1 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t2.id = t1.id AND t1.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t2.id IN (SELECT id FROM {$tbl1} AS t1 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t1.category_id = t5.category_id AND t5.allow_display<2 AND t1.category_id IN ({$ids})) \";\n        }\n        $sql.=\" AND ({$w})\".LB;\n    }\n    \n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$field_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND t2.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    if  (strtoupper($expired)==\"NO\"){\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    \n    //--ORDER\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n    \n    //\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n     if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n\n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $category_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $category_name);\n        }\n        // Meta Tags\n        $headercode=DATABOX_getheadercode(    \n            \"category\"\n            ,$template\n            ,$pi_name\n            ,$category_id\n            ,$category_name\n            ,$category_description\n            ,$category_name\n            ,$category_description);\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode) ;\n    }\n\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        \n        $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            'pagenav'  => 'pagenavigation.thtml'\n            ));\n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n        \n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_USERBOX['home']);\n\n        $url=$_CONF['site_url'].\"/userbox/category.php\";\n        $category_top=\"<a href='\".$url.\"'>\".$LANG_USERBOX['category_top'].\"</a>\";\n        $templates->set_var ('category_top',$category_top);\n\n        $templates->set_var ('lang_category_list_h2',$LANG_USERBOX['category_list_h2']);\n\n        $templates->set_var ('category_name',$category_name);\n        $templates->set_var ('category_code',$category_code);\n        $templates->set_var ('category_description',$category_description);\n    \n\n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_USERBOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        $templates->set_var ('lang_name', $LANG_USERBOX_ADMIN['name']);\n\n        $templates->set_var ('lang_username', $LANG_USERBOX_ADMIN['username']);\n        $templates->set_var ('lang_id', $LANG_USERBOX_ADMIN['id']);\n        $templates->set_var ('lang_uid', $LANG28[2]);\n        $templates->set_var ('lang_username', $LANG28[3]);\n        $templates->set_var ('lang_fullname',$LANG28[4]);\n\n        //\n        $templates->set_var ('lang_date', $LANG_USERBOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_USERBOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_USERBOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_USERBOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_description', $LANG_USERBOX_ADMIN['description']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        // \u8ffd\u52a0\u9805\u76ee\u306e\u30d8\u30c3\u30c0\n        $addition_def=DATABOX_getadditiondef($pi_name);\n        //\n\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['userbox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['userbox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_USERBOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n            \n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $description=COM_applyFilter($A['description']);\n            $username=COM_applyFilter($A['username']);\n            $fullname=COM_applyFilter($A['fullname']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n\n            $value=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n\n            $url=$_CONF['site_url'] . \"/userbox/profile.php\";\n            $url.=\"?\";\n            //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n            if ($_USERBOX_CONF['datacode']){\n                $url.=\"code=\".$A['username'];\n                $url.=\"&amp;m=code\";\n            }else{\n                $url.=\"id=\".$A['id'];\n                $url.=\"&amp;m=id\";\n            }\n            $url = COM_buildUrl( $url );\n            $link= COM_createLink($username, $url);\n\n\n            $templates->set_var ('data_link', $link);\n\n            $templates->set_var ('data_fullname', $A['fullname']);\n            $templates->set_var ('data_title', $A['fullname']);\n\n            $templates->set_var ('data_username', $username);\n            $templates->set_var ('data_code', $username);\n\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $url);\n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $value);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_released', $released_ary[0]);\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            \n            //\n            if (isset($A['photo']) && empty($A['photo'])) {\n                $A['photo'] = '(none)'; // user does not have a photo\n                $templates->set_var('data_photo', \"\");\n            }else{\n                $templates->set_var('data_photo', $A['photo']);\n            }\n            $photo = USER_getPhoto($uid, $A['photo'], $A['email'], -1);\n            $templates->set_var('data_user_photo', $photo);\n\n            $hits=COM_applyFilter(DB_getItem( $tbl6 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_USERBOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            \n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_USERBOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"userbox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            $templates->set_var ('data_edit', \"\");\n            if ( SEC_hasRights('userbox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $username.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                $attr = array('class' => 'editlink', 'title' => $username.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/userbox/profile.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                if ($id===$_USER['uid']){\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_USERBOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                    $attr = array('class' => 'editlink', 'title' => $username.\" \".$LANG_USERBOX_ADMIN['edit']);\n                    $url = $_CONF['site_url'];\n                    $url .= '/userbox/myprofile/profile.php';\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                    $templates->set_var ('data_edit', $icon);\n                }\n            }\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'userbox', $templates );\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"userbox/category.php\";\n        }\n        $url .= \"?\";\n        if ($category_code<>\"\"){\n            $url .= \"code=\".$category_code;\n            $url .= \"&amp;m=code\";\n        }else{\n            $url .= \"id=\".$category_id;\n            $url .= \"&amp;m=id\";\n        }\n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;order=\";\n        //-----order navigation\n        userbox_order ($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('blockfooter',COM_endBlock());\n\n        $templates->set_var ('msg', \"\");\n        //@@@@@@@@$templates->set_var ('search_link', $LANG_USERBOX['search_link']);\n        //@@@@@@@@$templates->set_var ('search_var',\"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            $templates->set_var ('home',$LANG_USERBOX['home']);\n            \n            $url=$_CONF['site_url'].\"/userbox/category.php\";\n            $category_top=\"<a href='\".$url.\"'>\".$LANG_USERBOX['category_top'].\"</a>\";\n            $templates->set_var ('category_top',$category_top);\n\n            $templates->set_var ('category_name',$category_name);\n            $templates->set_var ('category_code',$category_code);\n            $templates->set_var ('category_description',$category_description);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_USERBOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n        }\n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    //return $dbg.$retval;\n    return $retval;\n}\n\n\n\n\n\nfunction userbox_count(\n    $category_id =null\n    ,$category_code =null\n    ,$mode=''\n    ,$permission=\"\"\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  userbox_count()\n// | \u66f8\u5f0f  userbox_count(1)\n// | \u66f8\u5f0f  userbox_count(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n\n    //-----\n    $tbl1=$_TABLES['USERBOX_base'] ;\n    $tbl2=$_TABLES['USERBOX_category'] ;\n    \n    //\u30ab\u30c6\u30b4\u30ea\u306e\u6307\u5b9a\u304c\u306a\u3051\u308c\u3070\u5168\u4ef6\u3001\u3042\u308c\u3070\u30ab\u30c6\u30b4\u30ea\u6bce\n    $exp=\"\";\n    if (is_null($category_id) AND is_null($category_code) ){\n    }else{\n        $ids=\"\";\n        $idsary=array();\n        if (is_null($category_id) OR $category_id==0){\n            if (is_null($category_code)){\n            }else{\n                $w=explode(\"|\",$category_code);\n                foreach( $w as $val ){\n                    if ($ids<>\"\"){\n                        $ids.=\",\";\n                    }\n                    $w_id=DATABOX_codetoid($val,'USERBOX_def_category',\"category_id\");\n                    $idsary[]=$w_id;\n                    $ids.=$w_id;\n                }\n            }\n        }else{\n            $ids=$category_id;\n            $idsary[]=$category_id;\n        }\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT category_id\";\n                $w.=\" FROM {$tbl2} AS t2 \";\n                $w.=\" WHERE t2.id = t1.id)\";\n            }\n        }else{\n            $w= \"id IN (SELECT id FROM {$tbl2} \";\n            $w.=\"WHERE category_id IN ({$ids})) \";\n        }\n        $exp=$w.LB;\n    }\n\n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" distinct t1.id \".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n\n    $sql .= \" WHERE \".LB;\n    \n    if ($exp<>\"\"){\n        $sql .= $exp. \" AND \";\n    }\n    \n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\n\n\nfunction userbox_grp(\n    $field=null\n    ,$function=null\n    ,$format=null\n    ,$category_id =null\n    ,$category_code =null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u96c6\u8a08\u8868\u793a(max min sum)\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  userbox_grp()\n// | \u66f8\u5f0f  userbox_grp(1)\n// | \u66f8\u5f0f  userbox_grp(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $field:\u9805\u76ee\u3000\u30c7\u30d5\u30a9\u30eb\u30c8modified\n// | \u5f15\u6570 $function:\u95a2\u6570\u3000\u30c7\u30d5\u30a9\u30eb\u30c8max\n// | \u5f15\u6570 $format:\u66f8\u5f0f\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLEdS;\n    global $LANG_USERBOX;\n\n    $rt=\"\";\n\n    if (is_null($field) ){\n        $field=\"id\";\n    }\n    if (is_null($function) ){\n        $function=\"max\";\n    }\n\n    if (is_null($category_id) AND is_null($category_code) ){\n        $m=\"ALL\";\n    }else{\n        if (is_null($category_id) ){\n            $category_id=DATABOX_codetoid($category_code,'USERBOX_def_category',\"category_id\");\n        }\n        $m=\"CATEGORY\";\n    }\n    //-----\n    $tbl1=$_TABLES['USERBOX_base'] ;\n    $tbl2=$_TABLES['USERBOX_category'] ;\n\n    //-----\n    $sql=LB;\n    $sql .= \"SELECT \".LB;\n\n    $sql .= \" {$function}(t1.{$field}) AS rt\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@--------->\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND').LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@<---------\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" AND t1.id = t2.id \".LB;\n        $sql .= \" AND t2.category_id= \".$category_id .LB;\n    }\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n\n        $rt=$A['rt'];\n\n        if ($rt<>\"\"){\n            switch($format){\n                case \"lastmodified\":// '%Y\u5e74%m%e\u65e5\u66f4\u65b0';\n                case \"lastcreated\"://'%Y\u5e74%m%e\u65e5\u8ffd\u52a0';\n                    $fm=$LANG_USERBOX[$format];\n                    $rt=strftime($fm,strtotime($rt));\n                    break;\n                default:\n                    break;\n            }\n        }\n\n    }\n\n    return $rt;\n\n}\n\nfunction userbox_profile(\n    $id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$m=\"\"\n    ,$code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u500b\u5225\u30c7\u30fc\u30bf\u8868\u793a\n// | \u66f8\u5f0f  userbox_profile($id,$template,\"yes\",\"page\")\n// | \u66f8\u5f0f  userbox_profile($p['id'],$p['thtml'],$p['nohitmsg'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id            :\n// | \u5f15\u6570 $template      :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306edirectory\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $m             :\"page\"\u306e\u6642\u30d8\u30c3\u30c0\u8868\u793a\n// | \u5f15\u6570 $code          :\n// +---------------------------------------------------------------------------+\n// | public_html/profile.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u76f4\u8fd1\u306b\u5909\u66f4\u307e\u305f\u306f\u8ffd\u52a0\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u8fd4\u3057\u307e\u3059\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:profile\n// +---------------------------------------------------------------------------+\n// 20120125\n{\n    $pi_name=\"userbox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_IMAGE_TYPE;\n    global $_USER;\n\n    global $LANG28;\n    global $LANG04;\n    \n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n    global $LANG_USERBOX_ADMIN;\n    \n    global $LANG_confignames;\n    \n    $layout=$_DATABOX_CONF['layout'];\n    //-----\n    if (is_null($id) AND (is_null($code))){\n        $id=$_USER['uid'];\n    }\n\n    if (is_null($id)  OR ($id==0)){\n        if ($code<>\"\"){\n            $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n        }\n    }\n\n    //-----\n    $display = '';\n\n\n    $tbl=$_TABLES['USERBOX_base'] ;\n    $tbl1=$_TABLES['users'] ;\n    $tbl4=$_TABLES['USERBOX_def_fieldset'];\n    $tbl5=$_TABLES['USERBOX_stats'];\n\n    $addition_def=DATABOX_getadditiondef($pi_name);\n\n    //-----\n    $sql = \"SELECT t.* \";\n    \n    $sql .= \" ,UNIX_TIMESTAMP(t.modified) AS modified_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.released) AS released_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.comment_expire) AS comment_expire_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.expired) AS expired_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.created) AS created_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.udatetime) AS udatetime_un\";\n    \n    $sql .= \" ,t.fieldset_id\";\n\n    $sql .= \" ,t1.username \";\n    $sql .= \" ,t1.fullname \";\n    $sql .= \" ,t1.photo \";\n    $sql .= \" ,t1.email\";\n    $sql .= \" ,t3.username AS last_modify_name\";\n    $sql .= \" ,t3.fullname AS last_modify_fullname\";\n    \n    $sql .= \" ,t4.name AS set_name\";\n    $sql .= \" ,t4.description AS set_description\";\n    $sql .= \" ,t4.defaulttemplatesdirectory AS set_defaulttemplatesdirectory\";\n    $sql .= \" ,t4.layout AS set_layout\";\n    \n    $sql .= \" ,t5.hits\";\n\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl} AS t \";\n    $sql .= \" JOIN {$tbl4} AS t4       ON t.fieldset_id=t4.fieldset_id\";\n    $sql .= \" JOIN {$tbl1} AS t1       ON t.id=t1.uid\";//owner\n    $sql .= \" LEFT JOIN  {$tbl5} AS t5 ON t.id=t5.id\";\n    $sql .= \" LEFT JOIN  {$tbl1} AS t3 ON t.uuid=t3.uid\";//last_updateowner\n\n    $sql .= \" WHERE \";\n\n\n    if (is_null($id)){//@@@@@\n        $sql .= \"1=1\";\n    }else{\n        $sql .= \" t.id=\".$id;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\n    if ( SEC_hasRights('userbox.admin') OR $m===\"view\") {\n    }else{\n        //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n       $sql .= \" AND t.draft_flag=0\".LB;\n        //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (released <= NOW())\";\n\n        //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n\n    if (is_null($id)){\n        $sql .= \" ORDER BY \".$_USERBOX_CONF['datefield'] . \" DESC \";\n        $sql .= \" LIMIT 0 , 1\";\n    }\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    \n    if  ($m===\"page\"  OR  $m===\"view\"){\n        if ($numrows <= 0) {\n            COM_handle404();\n            exit;\n        }\n    }\n\n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\t\t\n\t\t$cache_time=$A['cache_time'];\n        $cache=false;\n\t\tif  ($cache_time===0){\n\t\t}else{\n\t\t    if  ($m===\"page\"){\n                if ($cache_time > -1 ) {\n                    // Don't need to cache per theme since not rendered in a block yet \n                    $cacheInstance = 'userbox__' . $id . '__' . CACHE_security_hash();\n                    $retval = CACHE_check_instance($cacheInstance);\n                    if ($retval AND $cache_time == -1) {\n                        return $retval;\n                    } elseif ($retval AND $cache_time > 0) {        \n                        $lu = CACHE_get_instance_update($cacheInstance);\n                        $now = time();\n                        if (($now - $lu) < $cache_time) {\n                            return $retval;\n                        } else {\n                            $retval = '';\n                        }\n                   }    \n                }\n            }\n\t    }\n        \n        if  ($cache){\n            $display = CACHE_check_instance($cacheInstance.\"_display\",$display);\n            $layout = CACHE_check_instance($cacheInstance.\"_layout\",$layout);\n            $headercode = CACHE_check_instance($cacheInstance.\"_headercode\",$headercode);\n            $title = CACHE_check_instance($cacheInstance.\"_title\",$title);\n        }else{\n\t\t\t\n            if (is_null($template) or ($template===\"\")){\n                if ($A['defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['defaulttemplatesdirectory'];\n                }elseif  ($A['set_defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['set_defaulttemplatesdirectory'];\n                }else{\n                    $template=\"default\";\n                }\n           }\n\n\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            $fieldset_id= $A['fieldset_id'];\n            if ($m===\"view\"){\n                $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n            }else{\n                $chk_user=DATABOX_chkuser($group_id,$owner_id,\"userbox.admin\");\n            }\n            //\n            $id=$A['id'];\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n\n            //\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af start.............\n            if ($m===\"page\"){\n                if  ($A['set_layout']<>\"0\") {\n                    $layout=$A['set_layout'];\n                }\n                $title= $A['page_title'];\n                if ($title===\"\"){\n                    $title =$A['username'];\n                }\n                // Meta Tags\n                $headercode=DATABOX_getheadercode(    \n                    \"profile\"\n                    ,$template\n                    ,$pi_name\n                    ,$A['id']\n                    ,$title\n                    ,$A['meta_description']\n                    ,$A['meta_keywords']\n                    ,$A['description']);\n            }\n\n            $tmplfld=DATABOX_templatePath('profile',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'list_detail.thtml',\n                'row'   => 'row.thtml',\n                'col'   => \"col_detail.thtml\",\n                ));\n            $languageid=COM_getLanguageId();\n            $language= COM_getLanguage();\n            $templates->set_var ('languageid', $languageid);\n            $templates->set_var ('language', $language);\n            if ($languageid<>\"\") {\n                $templates->set_var ('_languageid', \"_\".$languageid);\n            }else{\n                $templates->set_var ('_languageid', \"\");\n            }\n\n            $templates->set_var ('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var ('site_url',$_CONF['site_url']);\n        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n        \n            $templates->set_var ('site_name', $_CONF['site_name']);\n            $templates->set_var ('site_mail', $_CONF['site_mail']);\n        \n            $currenturl= COM_getCurrentURL();\n            $templates->set_var ('currenturl', $currenturl);\n            //facebook\n            $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n            $templates->set_var ('facebook_consumer_key', $facebook_consumer_key);\n            //\n\n            //daft_flag\u7ba1\u7406\u8005\u306e\u6642\n            if ($A['draft_flag']==1){\n                $templates->set_var ('draft', \"draft!\");\n            }else{\n                $templates->set_var ('draft', \"\");\n            }\n            //------------\n\n            //id\n            $templates->set_var('lang_id', $LANG_USERBOX_ADMIN['id']);\n            $templates->set_var ('id', $A['id']);\n\n            $templates->set_var('lang_fields', $LANG_USERBOX_ADMIN['fields']);\n            $templates->set_var('lang_field', $LANG_USERBOX_ADMIN['field']);\n            $templates->set_var('lang_templatesetvar', $LANG_USERBOX_ADMIN['templatesetvar']);\n            $templates->set_var('lang_content', $LANG_USERBOX_ADMIN['content']);\n            $templates->set_var('lang_type', $LANG_USERBOX_ADMIN['type']);\n            $templates->set_var('lang_byusingid', $LANG_USERBOX_ADMIN['byusingid']);\n            $templates->set_var('lang_byusingcode', $LANG_USERBOX_ADMIN['byusingcode']);\n            $templates->set_var('lang_byusingtemplatesetvar', $LANG_USERBOX_ADMIN['byusingtemplatesetvar']);\n            $templates->set_var('lang_group', $LANG_USERBOX_ADMIN['group']);\n            $templates->set_var('lang_withlink', $LANG_USERBOX_ADMIN['withlink']);\n            $templates->set_var('lang_groupbygroup', $LANG_USERBOX_ADMIN['groupbygroup']);\n\n            $templates->set_var('lang_uid', $LANG28['2']);\n            $templates->set_var('lang_username', $LANG28['3']);\n            $templates->set_var ('username', $A['username']);\n            $templates->set_var('lang_fullname', $LANG28['4']);\n            $templates->set_var ('fullname', $A['fullname']);\n        \n            $templates->set_var('lang_photo', $LANG04['77']);\n            if (isset($A['photo']) && empty($A['photo'])) {\n                $A['photo'] = '(none)'; // user does not have a photo\n                $templates->set_var('photo', \"\");\n            }else{\n                $templates->set_var('photo', $A['photo']);\n            }\n            //$photo = USER_getPhoto($A['id'], $A['photo'], $A['email'], -1);\n            //$templates->set_var('user_photo', $photo);\n        \n        \n            //$_USERBOX_CONF\n            $templates->set_var('lang_imgfile_frd', $LANG_confignames['userbox']['imgfile_frd']);\n            $templates->set_var ('imgfile_frd', $_USERBOX_CONF['imgfile_frd']);\n            $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_frd']);\n            $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['userbox']['imgfile_thumb_frd']);\n            $templates->set_var ('imgfile_thumb_frd', $_USERBOX_CONF['imgfile_thumb_frd']);\n            $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_thumb_frd']);\n\n            //\u57fa\u672c\u9805\u76ee\n            $templates->set_var('lang_basicfields', $LANG_USERBOX_ADMIN['basicfields']);\n            //\u30b3\u30fc\u30c9\uff06\u30bf\u30a4\u30c8\u30eb\uff06\u8aac\u660e\n            $templates->set_var('lang_code', $LANG_USERBOX_ADMIN['code']);\n            $templates->set_var ('code', $A['username']);\n            $templates->set_var('lang_title', $LANG_USERBOX_ADMIN['title']);\n            $templates->set_var ('title',$A['fullname']);\n\n            $templates->set_var('lang_description', $LANG_USERBOX_ADMIN['description']);\n            $templates->set_var ('description',$A['description']);\n        \n            $templates->set_var('lang_draft', $LANG_USERBOX_ADMIN['draft']);\n            if ($A['draft_flag']){\n                $templates->set_var ('draft',$LANG_USERBOX_ADMIN['draft']);\n            }else{\n                $templates->set_var ('draft',\"\");\n            }\n            //hits\n            $templates->set_var('lang_hits', $LANG_USERBOX_ADMIN['hits']);\n            $templates->set_var ('hits', $A['hits']);\n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_USERBOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $templates->set_var('lang_additionfields', $LANG_USERBOX_ADMIN['additionfields']);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n\n            //\u7de8\u96c6\u65e5\u4ed8\n            $templates->set_var('lang_modified', $LANG_USERBOX_ADMIN['modified']);\n            $wary = COM_getUserDateTimeFormat($A['modified_un']);\n            $templates->set_var ('modified',$wary[0]);\n            $templates->set_var ('modified_shortdate', strftime( $_CONF['shortdate'], $A['modified_un'] ));\n            //\u4f5c\u6210\u65e5\u4ed8\n            $templates->set_var('lang_created', $LANG_USERBOX_ADMIN['created']);\n            $wary = COM_getUserDateTimeFormat($A['created_un']);\n            $templates->set_var ('created', $wary[0]);\n            $templates->set_var ('created_shortdate', strftime( $_CONF['shortdate'], $A['created_un'] ));\n            //\u516c\u958b\u65e5\n            $templates->set_var('lang_released', $LANG_USERBOX_ADMIN['released']);\n            $wary = COM_getUserDateTimeFormat($A['released_un']);\n            $templates->set_var ('released', $wary[0]);\n            $templates->set_var ('released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            //\u516c\u958b\u7d42\u4e86\u65e5\n            $templates->set_var('lang_expired', $LANG_USERBOX_ADMIN['expired']);\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('expired', \"\");\n                $templates->set_var ('expired_shortdate', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('expired', $wary[0]);\n                $templates->set_var ('expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n            }\n\n            $templates->set_var ('lang_uuid', $LANG_USERBOX_ADMIN['uuid']);\n            $templates->set_var ('uuid', $uuid);\n\n            $templates->set_var ('lang_udatetime', $LANG_USERBOX_ADMIN['udatetime']);\n            $wary = COM_getUserDateTimeFormat($A['udatetime_un']);\n            $templates->set_var ('udatetime', $wary[0]);\n            $templates->set_var ('last_modify_uid', $A['uuid']);\n            $templates->set_var ('last_modify_name', $A['last_modify_name']);\n            $templates->set_var ('last_modify_fullname', $A['last_modify_fullname']);\n\n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            $templates->set_var ('edit', \"\");\n\n            if ($m<>\"view\"){\n\n                if ( SEC_hasRights('userbox.admin')) {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $A['username'].\" \".$LANG_USERBOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                    $attr = array('class' => 'editlink', 'title' => $A['username'].\" \".   $LANG_USERBOX_ADMIN['edit']);\n                    $url = $_CONF['site_admin_url'];\n                    $url .= '/plugins/userbox/profile.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                    $templates->set_var ('edit', $icon);\n                }else{\n                    if ($id===$_USER['uid']){\n                        $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                        $attr = array('title' => $LANG_USERBOX_ADMIN['edit']);\n                        $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                        $attr = array('class' => 'editlink', 'title' => $A['username'].\" \".$LANG_USERBOX_ADMIN['edit']);\n                        $url = $_CONF['site_url'];\n                        $url .= '/userbox/myprofile/profile.php';\n                        $icon = '&nbsp;' ;\n                        $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                        $templates->set_var ('edit', $icon);\n                    }\n                }\n            }\n            // Call to plugins to set template variables in the databox\n            PLG_templateSetVars( 'userbox', $templates );\n\n            //------------\n            $templates->parse ('output', 'list');\n\n            $userbox_content = $templates->finish ($templates->get_var ('output'));\n            $display=$userbox_content;\n\t\t\t\n            if ($A['draft_flag']!==1){\n                if (!SEC_hasRights('userbox.admin')) {\n                    $id=$A['id'];\n                    $hits=DB_getItem($_TABLES['USERBOX_stats'],\"hits\",\"id={$id}\");\n                    if (empty($hits)) {\n                        $hits=0;\n                    }\n                    $fields.=\"id,hits \";\n                    $values.=\"$id,$hits + 1\";\n                    DB_save($_TABLES['USERBOX_stats'],$fields,$values);\n                }\n            }\n        }\n    }else{\n        $cache_time=0;\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('profile',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            $templates->set_var ('lang_nohit', $LANG_USERBOX['nohit']);\n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n\n            $templates->parse ('output', 'list');\n            $databox_content = $templates->finish ($templates->get_var ('output'));\n            $display =$databox_content;\n            \n        }\n    }\n    $display =PLG_replacetags ($display);\n\t\t\n    if  (($cache_time > 0 OR $cache_time == -1)  AND  $m===\"page\" ){\n        CACHE_create_instance($cacheInstance.\"_display\", $display); \n        CACHE_create_instance($cacheInstance.\"_layout\", $layout); \n        CACHE_create_instance($cacheInstance.\"_headercode\", $headercode); \n        CACHE_create_instance($cacheInstance.\"_title\", $title); \n    }\n\n    $retval['display']=$display;\n    $retval['layout']=$layout;\n    $retval['headercode']=$headercode;\n    $retval['title']=$title;\n\n\n    return $retval;\n}\n\n\n\nfunction userbox_field(\n    $autotag\n    ,$field_id=null\n    ,$value=\"\"\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$field_code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $autotag:notautotag\u306e\u6642\u30d8\u30c3\u30c0\u3092\u8868\u793a\u3057\u306a\u3044\n// | \u5f15\u6570 $field_id:\u8ffd\u52a0\u5c5e\u6027id\n// | \u5f15\u6570 $value:\u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u5024\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $page           :\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $field_code    :\n// +---------------------------------------------------------------------------+\n// | public_html/attribute.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:category list\n// +---------------------------------------------------------------------------+\n{\n    $pi_name=\"userbox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n    global $LANG_USERBOX_ADMIN;\n    global $LANG_USERBOX_NOYES;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_USERBOX_CONF['loginrequired'] >1) ){\n            return $LANG_USERBOX['loginrequired'];\n        }\n\n    }\n    //-----table assign\n    $tbl1=$_TABLES['USERBOX_addition'] ;\n    $tbl2=$_TABLES['USERBOX_base'] ;\n    $tbl3=$_TABLES['USERBOX_addition'] ;\n    $tbl4=$_TABLES['users'] ;\n    $tbl5=$_TABLES['USERBOX_stats'];\n    \n    //\u65e5\u4ed8\u95a2\u9023\n    $datefield=$_USERBOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n    $new_img=$_USERBOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_USERBOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($value) OR $value===\"\") {\n        return;\n    }\n    if (is_null($field_id)){\n        if ($field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,'USERBOX_def_field',\"field_id\",\"templatesetvar\");\n\n        }\n    }\n    if ($field_id===0) {\n        return;\n    }\n    \n    if ($field_code===\"\"){\n        $field_code=DB_getItem( $_TABLES['USERBOX_def_field']\n                 ,\"templatesetvar\",\"field_id={$field_id}\");\n    }\n    $field_def=DATABOX_getadditiondef($pi_name);\n    $type=$field_def[$field_id]['type'];\n    $w = array(0,2,3,4,7,8,9,16);\n    if (in_array ($type,$w)){\n    }else{\n        return;\n    }\n\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_USERBOX_CONF['perpage'];\n    }\n\n\n    $w=userbox_orderby($datefield,$order,$orderby,$addfieldorder,$orderfield_id);\n    $field_def[$field_id]['name'];\n    $field_name=$field_def[$field_id]['name'];\n    $field_templatesetvar=$field_def[$field_id]['templatesetvar'];\n    $field_description=$field_def[$field_id]['description'];\n\n    $fieldvalue=DATABOX_getfieldvalue(\n          $value\n         ,$field_def[$field_id]['type']\n         ,$field_def[$field_id]['selectionary']\n         ,$LANG_USERBOX_NOYES\n         ,$field_def[$field_id]['selectlist']\n         ,$pi_name\n          );\n\n\n    if (is_null($template) or ($template===\"\")){\n        $template=\"default\";\n    }\n\n\n    //-----\n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n    $sql .= \" ,t2.fieldset_id \".LB;\n\n    $sql .= \" ,t4.username\";\n    $sql .= \" ,t4.fullname\";\n    $sql .= \" ,t4.photo\";\n    $sql .= \" ,t4.email\";\n    \n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.field_id = \".$field_id.LB;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t1.value = \\\"\".$value.\"\\\"\".LB;\n    $sql .= \" AND t2.id=t4.uid \".LB;\n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$orderfield_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('userbox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    \n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n    \n    //\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $field_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $field_name);\n        }\n        $headercode=DATABOX_getheadercode(    \n            \"attribute\"\n            ,$template\n            ,$pi_name\n            ,$field_id\n            ,$field_name\n            ,$field_description\n            ,$field_name\n            ,$field_description);\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode);\n    }\n    \n    $addition_def=DATABOX_getadditiondef($pi_name);\n    //\n    $url=$_CONF['site_url'].\"/userbox/attribute.php\";\n    $attribute_top=\"<a href='\".$url.\"'>\".$LANG_USERBOX['attribute_top'].\"</a>\";\n    $url=$_CONF['site_url'].\"/userbox/attribute.php\";\n    $url.=\"?\";\n    $url.=\"id=\".$field_id;\n    $url.=\"&amp;m=id\";\n    $field_top=\"<a href='\".$url.\"'>\".$field_name.$LANG_USERBOX['countlist'].\"</a>\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            'pagenav'  => 'pagenavigation.thtml'\n            ));\n        \n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n        \n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_USERBOX['home']);\n        $templates->set_var ('attribute_top',$addition_top);\n        $templates->set_var ('field_top',$field_top);\n        \n        $templates->set_var ('field_name',$field_name);\n        $templates->set_var ('field_templatesetvar',$field_templatesetvar);\n        $templates->set_var ('field_description',$field_description);\n\n        $templates->set_var ('fieldvalue',$fieldvalue);\n\n        //page\n        $offset = ($page - 1) * $perpage;\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_USERBOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        $templates->set_var ('lang_name', $LANG_USERBOX_ADMIN['name']);\n\n        $templates->set_var ('lang_username', $LANG_USERBOX_ADMIN['username']);\n        $templates->set_var ('lang_id', $LANG_USERBOX_ADMIN['id']);\n        $templates->set_var ('lang_uid', $LANG28[2]);\n        $templates->set_var ('lang_username', $LANG28[3]);\n        $templates->set_var ('lang_fullname',$LANG28[4]);\n\n        //\n        $templates->set_var ('lang_date', $LANG_USERBOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_USERBOX_ADMIN['released']);\n        $templates->set_var ('lang_description', $LANG_USERBOX_ADMIN['description']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        \n        //$_USERBOX_CONF\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['userbox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['userbox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_USERBOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n         for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $description=COM_applyFilter($A['description']);\n            $username=COM_applyFilter($A['username']);\n            $fullname=COM_applyFilter($A['fullname']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n            \n            $sortvalue=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            \n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n\n            $url=$_CONF['site_url'] . \"/userbox/profile.php\";\n            $url.=\"?\";\n            //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n            if ($_USERBOX_CONF['datacode']){\n                $url.=\"m=code\";\n                $url.=\"&amp;code=\".$A['username'];\n            }else{\n                $url.=\"id=\".$A['id'];\n                $url.=\"&amp;m=id\";\n            }\n            $url = COM_buildUrl( $url );\n            $link= COM_createLink($username, $url);\n\n\n            $templates->set_var ('data_link', $link);\n\n            $templates->set_var ('data_fullname', $fullname);\n            $templates->set_var ('data_title', $fullname);\n\n            $templates->set_var ('data_username', $username);\n            $templates->set_var ('data_code', $username);\n\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $url);\n            //data_released\n            $templates->set_var ('data_datefield', $datefield);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_value', $sortvalue);\n            \n            $templates->set_var ('data_released', $released_ary[0]);//@@@@@@\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n\n            if (isset($A['photo']) && empty($A['photo'])) {\n                $A['photo'] = '(none)'; // user does not have a photo\n                $templates->set_var('data_photo', \"\");\n            }else{\n                $templates->set_var('data_photo', $A['photo']);\n            }\n            $photo = USER_getPhoto($uid, $A['photo'], $A['email'], -1);\n            $templates->set_var('data_user_photo', $photo);\n\n            $hits=COM_applyFilter(DB_getItem( $tbl5 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_USERBOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            //\u30ab\u30c6\u30b4\u30ea categories \n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee fields\n            $group_id = stripslashes($A['group_id']);\n            $owner_id = stripslashes($A['owner_id']);\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"userbox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/userbox/profile.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyProfile\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_USERBOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_USERBOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/myprofile/profile.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n                \n            }\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"userbox/field.php\";\n        }\n        $url .=\"?\";\n        $url .= \"id=\".$field_id;\n        $url .= \"&amp;m=id\";\n        $url .= \"&amp;value=\".$value;\n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;perpage=\".$perpage;\n        $url .= \"&amp;order=\";\n        //-----order navigation\n        userbox_order ($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'userbox', $templates );\n\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            //bread\n            $templates->set_var ('home',$LANG_USERBOX['home']);\n            $templates->set_var ('attribute_top',$attribute_top);\n            $templates->set_var ('field_top',$field_top);\n            \n            $templates->set_var ('field_name',$field_name);\n            $templates->set_var ('field_templatesetvar',$templatesetvar);\n            $templates->set_var ('field_description',$field_description);\n            \n            $templates->set_var ('fieldvalue',$fieldvalue);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_USERBOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n        }\n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    return $retval;\n}\n\nfunction userbox_orderby(\n    $datefield\n    ,&$order\n    ,&$orderby\n    ,&$addfieldorder\n    ,&$field_id\n\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  order orderby addfieldorder $field_id \u3092\u7de8\u96c6\n// | \u66f8\u5f0f  userbox_orderby($datefield,$order,$orderby,$addfieldorder,$field_id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $datefield\n// | \u5f15\u6570\u623b\u5024 $order\n// | \u5f15\u6570\u623b\u5024 $orderby\n// | \u5f15\u6570\u623b\u5024 $addfieldorder\n// | \u5f15\u6570\u623b\u5024 $field_id\n// +---------------------------------------------------------------------------+\n{\n\n    global $_TABLES;\n\n    $orderby=\"\";\n    $addfieldorder=false;\n    switch($order){\n        case \"random\":\n            $orderby =\" RAND()\";\n            break;\n        case \"\":\n        case \"date\":\n            $order=\"date\";\n            $orderby = $datefield .\" DESC\";\n            break;\n        case \"released\":\n            $orderby = \" released DESC\";\n            break;\n        case \"orderno\":\n        case \"code\":\n        case \"title\":\n        case \"description\":\n        case \"id\":\n            $orderby = \" t2.\".$order;\n            break;\n        case \"username\":\n        case \"fullname\":\n            $orderby = \" t4.\".$order;\n            break;\n        default:\n            $sql=\"SELECT \";\n            $sql.= \" field_id \";\n            $sql.= \",name \";\n            $sql.=\" FROM\";\n            $sql.=\" {$_TABLES['USERBOX_def_field']} \";\n            $sql.=\" WHERE templatesetvar='\".$order.\"'\";\n\n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n\n            if ($numrows>0){\n                $A = DB_fetchArray ($result);\n                $field_id=COM_stripslashes($A['field_id']);\n                $addfield_name=COM_stripslashes($A['name']);\n                $orderby = \" t3.value IS NULL ASC ,cast(t3.value as DECIMAL) ASC \";\n                $addfieldorder=true;\n            }else{\n                $order=\"date\";\n                $orderby = $datefield .\" DESC\";\n            }\n    }\n\n    return ;\n\n}\n\n\nfunction userbox_newlist(\n     $m=\"ALL\"\n    ,$categories=\"\"\n    ,$rss_file=\"\"\n    ,$title_trim_length=\"\"\n    ,$intervalday=\"\"\n    ,$limitcnt=\"\"\n    ,$newmarkday=\"\"\n    ,$thtml=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740user\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f userbox_newlist                                                      |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $m             :\u7701\u7565\u6642'ALL' id=id\u6307\u5b9a\u3067\u9078\u629e code\u6307\u5b9a\u3067\u9078\u629e           |\n// | \u5f15\u6570 $categories    :\u9078\u629e\u30c8\u30d4\u30c3\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or'ALL'                     |\n// | \u5f15\u6570 $rss_file      :RSS_file     \u7701\u7565\u6642\"\"                                |\n// | \u5f15\u6570 $title_trim_length :\u30bf\u30a4\u30c8\u30eb\u9577\u306e\u5236\u9650 \u7701\u7565\u6642\u8a2d\u5b9a\u5024or20                |\n// | \u5f15\u6570 $intervalday   :\u65b0\u7740\u8a18\u4e8b\u306e\u671f\u9593 \u5358\u4f4d\u65e5  \u7701\u7565\u6642\u8a2d\u5b9a\u5024or90              |\n// |                      0\u306e\u6642\u3000\u5168\u4ef6                                          |\n// | \u5f15\u6570 $limitcnt      :\u8868\u793a\u4ef6\u6570   \u7701\u7565\u6642\u8a2d\u5b9a\u5024or10                          |\n// | \u5f15\u6570 $newmarkday    :\u65b0\u7740\u30de\u30fc\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or3                           |\n// | \u5f15\u6570 $thtml         :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d5\u30a9\u30eb\u30c0  layout/\u30c6\u30fc\u30de/XXXX/  |\n// |                      \u7701\u7565\u6642\u306f\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u5185\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8                 |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u65b0\u7740user\u4e00\u89a7                                                   |\n// +---------------------------------------------------------------------------+\n// update20101124\n{\n    $pi_name=\"userbox\";\n\n    global $_USER;\n    global $_TABLES;\n    global $_CONF;\n\n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n\n    //\n    if ($title_trim_length==\"\"){\n        $title_trim_length=$_USERBOX_CONF['title_trim_length'];\n        if ($title_trim_length==\"\"){\n            $title_trim_length=20;\n        }\n    }\n    //\n    if ($intervalday==\"\"){\n        $intervalday=$_USERBOX_CONF['intervalday'];\n        if ($intervalday==\"\"){\n            $intervalday=90;\n        }\n    }\n    //\n    if ($limitcnt==\"\"){\n        $limitcnt=$_USERBOX_CONF['limitcnt'];\n        if ($limitcnt==\"\"){\n            $limitcnt=10;\n        }\n    }\n    if ($newmarkday==\"\"){\n        $newmarkday=$_USERBOX_CONF['newmarkday'];\n        if ($newmarkday==\"\"){\n            $newmarkday=3;\n        }\n    }\n\n    if ($m===\"\"){\n        $categories=\"ALL\";\n    }else{\n        if ($categories==\"\"){\n            $categories=$_USERBOX_CONF['categories'];\n            if ($categories==\"\"){\n                $categories=\"ALL\";\n            }\n        }elseif (strpos($categories,\",\")==\"\") {\n            $categories=\"'$categories'\";\n        }else{\n            $ary=explode(\",\",$categories);\n            $b=\"\";\n            for ($i = 1; $i <= count($ary); $i++) {\n                if ($m===\"code\"){\n                    $b.=\"'\".current($ary).\"',\";\n                }else{\n                    $b.=current($ary).\",\";\n                }\n                next($ary);\n            }\n            $categories=rtrim($b,\",\");\n        }\n    }\n\n    //\n    $new_img=$_USERBOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $rss_img=$_USERBOX_CONF['rss_img'];\n    if ($rss_img==\"\") {\n        $rss_img=\"[RSS]\";\n    }\n\n    if (is_null($thtml)){\n        $thtml=\"default\";\n    }\n\n//-------------------------------------------\n    $retval=\"\";\n\n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath('newlist',$thtml,$pi_name);\n\n    $list = new Template($tmplfld);\n    $list->set_file (array (\n        'list' => 'list.thtml',\n        'col'   => 'list_col.thtml'\n    ));\n\n    $datefield=$_USERBOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n\n    //-----\n    $tbl1=$_TABLES['USERBOX_base'] ;\n    $tbl2=$_TABLES['USERBOX_category'] ;\n    $tbl3=$_TABLES['USERBOX_def_category'] ;\n    $tbl4=$_TABLES['users'] ;\n\n\n    $sql=\"SELECT \".LB;\n    $sql.=\" t4.fullname\".LB;\n    $sql.=\" , UNIX_TIMESTAMP(t1.\".$datefield .\") AS day\".LB;\n    $sql.=\" , t1.id\".LB;\n    $sql.=\" , t4.username\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" , {$tbl4} AS t4 \".LB;\n\n    if ($categories!==\"ALL\" ){\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql.=\" WHERE\";\n    if ($categories===\"ALL\" ){\n        $sql.=\" t1.id=t4.uid\".LB;\n    }else{\n        $sql.= \" t1.id = t4.id \".LB;\n        $sql.= \" AND t1.id=t2.uid\".LB;\n        $sql.= \" AND t2.category_id = t3.category_id \".LB;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('userbox.admin')) {\n    //}else{\n       $sql .= \" AND t1.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND').LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n\n    if ($intervalday<>0){\n        $sql.=\" AND (\".$datefield .\" >= (date_sub(NOW(), INTERVAL $intervalday day)))\".LB;\n    }\n\n    if ($categories!==\"ALL\" ){\n        if ($m===\"id\") {\n            $sql.=\" AND t2.category_id IN ($categories)\";\n        }else{\n            $sql.=\" AND t3.code IN ($categories)\";\n        }\n    }\n    $sql .= COM_getLangSQL ('username', 'AND', 't4').LB;\n\n    $sql.=\" ORDER BY \".$datefield .\" DESC\";\n    $sql.=\" LIMIT $limitcnt\";\n\n    $result = DB_query ($sql);\n\n    $i=0;\n\n    while( $A = DB_fetchArray( $result ) )    {\n\n        $title= COM_truncate( $A['username'], $title_trim_length,'...' );\n\n        $url=$_CONF['site_url'] . \"/userbox/profile.php\";\n        $url.=\"?\";\n        //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n        if ($_USERBOX_CONF['datacode']){\n            $url.=\"m=code\";\n            $url.=\"&code=\".$A['username'];\n        }else{\n            $url.=\"m=id\";\n            $url.=\"&id=\".$A['id'];\n        }\n        $url = COM_buildUrl( $url );\n        $link= COM_createLink($title, $url);\n\n\n        $list->set_var ('site_url', $_CONF['site_url']);\n\n        $list->set_var ('day', strftime($LANG_USERBOX['day'],$A['day']));\n\n        $chkday=strtotime(\"- $newmarkday days\",time());\n        if (date(\"Ymd\",$A['day']) >= date(\"Ymd\",$chkday)){\n            $list->set_var ('new_img', $new_img);\n        }else{\n            $list->set_var ('new_img', '');\n        }\n        $list->set_var ('link', $link);//@@@@@\n\n        $list->set_var ('url', $url);\n        $list->set_var ('title', $title);\n        $n=($i%2)+1;\n        $class='class=\"row'.$n.'\"';\n        $list->set_var ('class', 'class=\"row'.$n.'\"');\n        \n        //\u30ab\u30c6\u30b4\u30ea\n        DATABOX_getcategoriesDisp($A['id'],$list,$chk_user,0,$pi_name);\n\n        $list->parse ('list_col', 'col', true);\n\n        $i++;\n    }\n\n    $list->set_var ('site_url', $_CONF['site_url']);\n    $list->set_var ('day', strftime($LANG_USERBOXBOX['day'],$A['day']));\n\n    //\n    if ($rss_file<>\"\"){\n        $list->set_var ('rss_url', $_CONF['site_url'] . '/backend/'.$rss_file);\n        $list->set_var ('rss_title', $rss_img);\n    }\n    //\n    $more_title=$LANG_USERBOX['more'];\n    if ($categories===\"ALL\" OR strpos($categories,\",\")<>\"\") {\n        $more_url=COM_buildUrl($_CONF['site_url'] . '/userbox/index.php');//\n    }else{\n        //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n        if ($m=\"code\"){\n            $more_url.=\"m=code\";\n            $more_url.=\"&code=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }else{\n            $more_url.=\"m=id\";\n            $more_url.=\"&id=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }\n        $more_url=$_CONF['site_url'] . \"/userbox/index.php\".$more_url;//@@@@@\n    }\n\n    $more_url = COM_buildUrl( $more_url );\n    $more_link= COM_createLink($title, $more_url);\n    $list->set_var ('more_url', $more_url);\n    $list->set_var ('more_title', $more_title);\n\n    $list->parse ('output', 'list');\n    $retval .= $list->finish ($list->get_var ('output'));\n\n\n    return $retval;\n}\n\nfunction userbox_order(\n    $url=\"\"\n    ,$templates\n    ,$cur_order=\"id\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd ORDER\u6307\u5b9aLINK\u51fa\u529b\n// | \u66f8\u5f0f userbox_order()\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $url:\n// | \u5f15\u6570 $templates\n// | \u5f15\u6570 $cur_order:\n// +---------------------------------------------------------------------------+\n{\nglobal $LANG_USERBOX_ORDER;\nglobal $_TABLES;\n\n    $templates->set_var('cur_order',$cur_order);\n\n    $order_ary=array();\n    $order_ary[]='random';\n    $order_ary[]='date';\n    $order_ary[]='orderno';\n    $order_ary[]='username';\n    $order_ary[]='fullname';\n    $order_ary[]='description';\n    $order_ary[]='id';\n    $order_ary[]='released';\n\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",templatesetvar\";\n    $sql.=\" FROM\";\n    $sql.=\" {$_TABLES['USERBOX_def_field']} \";\n    $sql.=\" where allow_display=0\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $addfield_ary=array();\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=COM_stripslashes($A['field_id']);\n        $addfield_ary[$field_id]['name']=COM_stripslashes($A['name']);\n        $addfield_ary[$field_id]['templatesetvar']=COM_stripslashes($A['templatesetvar']);\n        $order_ary[]=\"addfield\".$field_id;\n    }\n\n\n    for ($i = 1; $i <= count($order_ary); $i++) {\n        $c=current($order_ary);\n\n        if (substr($c,0,8)===\"addfield\"){\n            $field_id=substr($c,8);\n            $order=$addfield_ary[$field_id]['templatesetvar'];\n            $order_name=$addfield_ary[$field_id]['name'];\n            $order_name.=$LANG_USERBOX_ORDER['order'];\n        }else{\n            $order=$c;\n            $order_name=$LANG_USERBOX_ORDER[$c];\n        }\n\n        if ($order<>\"random\" AND $order===$cur_order){\n            $rt=$order_name;\n        }else{\n            $order_url=$url;\n            $order_url.=$order;\n            //$order_url = COM_buildUrl( $order_url );\n            $rt= COM_createLink($order_name, $order_url);\n        }\n\n        $templates->set_var('order_'.$order,$rt);\n\n        next($order_ary);\n    }\n\n    return ;\n\n\n}\n\n\n\nfunction userbox_msg(\n    $for=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u30e1\u30c3\u30bb\u30fc\u30b8\u51fa\u529b\n// | \u66f8\u5f0f userbox_msg()\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $for:\u8ab0\u5b9b\n// +---------------------------------------------------------------------------+\n{\nglobal $LANG_USERBOX_MSG;\nglobal $_USER;\nglobal $_TABLES;\n    \n    $rt=\"\";\n    $uid=$_USER['uid'];\n    \n    switch ($for) {\n        case '':\n        case 'alluser':\n            $rt=$LANG_USERBOX_MSG['alluser'];\n            break;\n        case 'draftuser':\n            $draft_flag=DB_getItem($_TABLES['USERBOX_base'], 'draft_flag',\n                        \"id = '{$uid}'\");\n            if ($draft_flag==1){\n                $rt=$LANG_USERBOX_MSG['draftuser'];\n            }\n            break;\n        case 'descriptionempty':\n            if ($uid<>0){\n                if (userbox_descriptionemptycheck($uid)==false){\n                    $rt=$LANG_USERBOX_MSG['descriptionempty'];\n                }\n            }\n            break;\n        default:\n        \n    }\n    \n    return $rt;\n\n}\n\n\n?>\n", "<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | DataBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | Box \u30b7\u30ea\u30fc\u30ba\u5171\u901a\n// +---------------------------------------------------------------------------+\n// $Id: plugins/databox/lib/databox_functions.inc\n//20100818 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n\nif (strpos ($_SERVER['PHP_SELF'], 'databox_functions.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n\n//==============================================================================\nfunction DATABOX_nl2br (\n    $text\n) \n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u6539\u884c\u3092BR\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_nl2br ($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text:\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6539\u884c\u3092BR\u306b\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u6539\u884c\u3092BR\u306b\u5909\u63db\"\n{\n    return PLG_replacetags ( str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '<br'.XHTML.'>', $text) );\n\n}\n\nfunction DATABOX_autolink (\n    $text\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd url\u3092\u30ea\u30f3\u30af\u5909\u63db\n// | \u66f8\u5f0f DATABOX_autolink($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text         :\u6587\u5b57\u5217                                                |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:url\u3092\u30ea\u30f3\u30af\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217                                       |\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u81ea\u52d5\u30ea\u30f3\u30af\u3092\n{\n    $patterns = array(\"/(https?|ftp)(:\\/\\/[[:alnum:]\\+\\$\\;\\?\\.%,!#~*\\/:@&=_-]+)/i\");\n    $replacements = array(\"<a href=\\\"\\\\1\\\\2\\\" target=\\\"_blank\\\">\\\\1\\\\2</a>\");\n    return preg_replace($patterns, $replacements, $text);\n}\n\nfunction DATABOX_codetoid(\n    $code\n    ,$table\n    ,$idname = \"id\"\n    ,$codename = \"code\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u3092id\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_codetoid($code,'DATABOX_base')\n// | \u66f8\u5f0f DATABOX_codetoid($code,'users',\"uid\",\"username\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $table\n// | \u5f15\u6570 $idname\n// | \u5f15\u6570 $codename\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:id\n// +---------------------------------------------------------------------------+\n//update20101125\n{\n    global $_TABLES;\n    $retval=DB_getItem( $_TABLES[$table]   ,$idname,$codename.\"='{$code}'\");\n    if (empty($retval)){\n        $retval=0;\n    }\n    return $retval;\n}\n\nfunction DATABOX_swichlang(\n\t$code\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u591a\u8a00\u8a9e\u5bfe\u5fdc\u5909\u63db\n// | \u66f8\u5f0f DATABOX_swichlang($code)\n// |      xxxx_(\u8a00\u8a9eid) \u591a\u8a00\u8a9e\u30e2\u30fc\u30c9\u306e\u6642\u306b\u5fc5\u8981\u304c\u3042\u308c\u3070\u8a00\u8a9eid\u3092\u73fe\u5728\u306e\u8a00\u8a9eid\u306b\u5909\u63db\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u5909\u63db\u5f8c\u306e\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n{\n    \n    global $_CONF;\n    $newlanguageid = COM_getLanguageId();\n    if  ($newlanguageid<>\"\"){\n        if  ($code<>\"\"){\n            $lang_len = strlen($newlanguageid);\n            $oldlanguageid=substr($code,-($lang_len));\n            if  (array_key_exists($oldlanguageid, $_CONF['language_files'])){\n                $code = substr_replace($code, $newlanguageid, -$lang_len);\n            }\n        }\n    }\n    return $code;\n}\n\n\nfunction DATABOX_templatePath (\n    $kind = 'data'\n    ,$template ='default'\n    ,$pi_name= 'databox'\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\u3092\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_templatePath('data','default','databox')\n// | \u66f8\u5f0f DATABOX_templatePath($kind,$template,$pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:'data' 'category' ''newlist' 'admin'\n// | \u5f15\u6570 $template:  'default'\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\n// +---------------------------------------------------------------------------+\n// 20101115\n{\n\n    global $_CONF;\n\n    if (is_null($template) OR ($template===\"\")){\n        $template=\"default\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    if ($kind===\"admin\"){\n        $conf_templates=$box_conf[\"templates_admin\"];\n    }else{\n        $conf_templates=$box_conf[\"templates\"];\n    }\n\n    //\"standard\";//\u6a19\u6e96\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"custom\";//\u30ab\u30b9\u30bf\u30e0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"theme\";//\u30c6\u30fc\u30de\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    if  ($conf_templates===\"theme\"){\n\n        $tmplfld=$_CONF['path_layout'] .$box_conf['themespath'].$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n        }\n        if (is_dir($tmplfld)) {\n\n        }else{\n            COM_handle404();\n            exit;\n        }\n    }else if  ($conf_templates===\"custom\"){\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/custom/templates/'.$kind;\n\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n\n        }\n\n        if (is_dir($tmplfld)){\n\n        }else{\n            COM_handle404();\n            exit;\n        }\n    }else{\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/templates/'.$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/default\";\n        }\n    }\n\n\n    return $tmplfld;\n}\n\nfunction DATABOX_siteHeader (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$page_title = ''\n    ,$headercode = ''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d8\u30c3\u30c0\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title,$headercode)\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $pagetitle:\n// | \u5f15\u6570 $headercode:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30d8\u30c3\u30c0\n// +---------------------------------------------------------------------------+\n// 20120910\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    $display=\"\";\n    \n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n            $display=COM_siteHeader ('menu', $page_title,$headercode);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'noblocks':\n            $display=COM_siteHeader ('none', $page_title,$headercode);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n\n\n    return $display;\n}\n\n\nfunction DATABOX_siteFooter (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$custom=''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30c3\u30bf\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name,'_admin',$custom)\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $custom:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 : \u30d5\u30c3\u30bf\n// +---------------------------------------------------------------------------+\n// 20110119\n{\n    global $_CONF;\n\n    if (is_null($pi_name)){\n        $pi_name=\"databox\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $display=\"\";\n\n    $layout=$box_conf['layout'.$kind];\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        $display .= COM_siteFooter(false,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n            $display .= COM_siteFooter(true,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        // \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u5e38\u6642\u8868\u793a\u3059\u308b\u8a2d\u5b9a\u3067\u3042\u3063\u3066\u3082\u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3055\u305b\u306a\u3044\n        case 'noblocks':\n            $_CONF['show_right_blocks']=0;\n            $_CONF['left_blocks_in_footer']=0;\n            $display .= COM_siteFooter(false,$custom);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n    return $display;\n}\n\n\n//$retval = SP_returnStaticpage($page, $display_mode, $comment_order, $comment_mode, $comment_page, $msg, $query);\n\nfunction DATABOX_displaypage (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$display = ''\n    ,$information = ''\n)\n//$information\n// 'what'  'none' no left blocks are returned\n//         'menu' (default)  right blocks are returned\n// 'pagetitle'     Optional content for the page's <title>\n// 'breadcrumbs'   Optional content for the page's <title>\n// 'headercode'    Optional code to go into the page's <head>\n// 'rightblock'    \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3059\u308b\u304b\u3069\u3046\u304b\u3000 default is no (-1)\n// 'custom'        An array defining custom function to be used to \n\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    \n    //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n    if  ($layout=='blankpage'){\n        \n    }else{\n        switch ($layout) {\n            // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n            case 'standard':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(false,$custom);\n                $information['what']='menu';\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n            case 'leftrightblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(true,$custom);\n                $information['what']='menu';\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'leftblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                $information['what']='menu';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'rightblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                //$display .= COM_siteFooter(true,$custom);\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'noblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n        }\n        \n        //FOR GL2.0.0 \n        if (COM_versionCompare(VERSION, \"2.0.0\",  '>=')){\n            $display = COM_createHTMLDocument($display,$information);\n        }else{\n            $display = COM_siteHeader ($information['what'], $information['pagetitle']).$display;\n            $display .= COM_siteFooter($information['rightblock']);\n        }\n    }\n\n\n    return $display;\n}\n\n\nfunction DATABOX_getcheckList(\n    $kind\n    ,$selected\n    ,$pi_name\n    ,$group_id=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcheckList($kind,$selected = \"\")\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name)\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"categorygroup\",\"\",$pi_name,1,\"ch1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:fieldset\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox' \n// | \u5f15\u6570 $group_id\u3000\u30de\u30b9\u30bf\u30fc\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n// \u30ab\u30c6\u30b4\u30ea\u4ee5\u5916\u3067\u4f7f\u3063\u3066\u3044\u308b\u304b\u78ba\u8a8d\u306e\u3053\u3068 --> category \u306f DATABOX_getcategoriesinp\n//20140624 fieldset\u3000\u8ffd\u52a0\n{\nglobal $_TABLES;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n\n    $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n    $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    $table_def_fieldset=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n    $retval = '';\n    if ($kind==\"categorygroup\"){\n        $sql = \"SELECT \";\n        $sql .= \" m1.category_id\".LB;\n        $sql .= \",m1.name\".LB;\n        $sql .= \",m1.orderno\".LB;\n        $sql .= \",m2.group_id\".LB;\n        $sql .= \",m2.name AS group_name\".LB;\n        $sql .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql .= \" , {$table_def_group} AS m2\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m1.allow_display<2 \".LB;\n        $sql .= \" AND m1.categorygroup_id =\".$group_id.LB;\n        $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n        $sql .= \" ORDER BY m1.orderno\".LB;\n    }else if ($kind==\"fieldset\"){\n        $sql = \"SELECT \";\n        $sql .= \" fieldset_id\".LB;\n        $sql .= \",name\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_def_fieldset} \".LB;\n        $sql .= \" ORDER BY fieldset_id\".LB;\n    }else{\n        $sql = \"SELECT \".LB;\n        $sql .= \" no\".LB;\n        $sql .= \",value\".LB;\n        $sql .= \",orderno\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_mst}\".LB;\n        $sql .= \" WHERE kind='{$kind}'\".LB;\n        $sql .= \" ORDER BY orderno\".LB;\n    }\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    $old_group_id=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fname . '[]\" value=\"' . $A[0] ;\n        $retval .= '\"';\n        for( $x = 0; $x < sizeof( $S ); $x++ )            {\n            if( $A[0] == $S[$x] )                {\n                $retval .= ' checked=\"checked\"';\n            }\n        }\n        $retval .= '>' . stripslashes( $A[1] ) . '</span>' . LB;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getdatas(\n    $fld\n    ,$tbl\n    ,$where\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u8aad\u8fbc                                                      |\n// | \u66f8\u5f0f DATABOX_getdatas($fld,$tbl,$where)                                   |\n// | $rt=DATABOX_getdatas(                                                     |\n// |      \"category_id\",$_TABLES['DATABOX_category'],\"id=$id\");                |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $where:\u6761\u4ef6\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8907\u6570\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    $sql=\"SELECT {$fld} FROM {$tbl} WHERE {$where}\";\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $selected=\"\";\n    for ($i = 0; $i < $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $selected.= $A[$fld].\" \";\n    }\n    $selcted=rtrim($selected,\" \");\n    return $selected;\n\n}\n\n\nfunction DATABOX_savedatas(\n    $fld\n    ,$tbl\n    ,$id\n    ,$fldary=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc\n// | \u66f8\u5f0f DATABOX_savedatas($fld,$tbl,$id,$fldary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    global $_TABLES;\n\n    $rt=DB_delete($tbl,\"id\",$id);\n\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$tbl} (\";\n            $sql.=\"id, {$fld}\";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id}, {$val}\";\n            $sql.=\")\";\n            DB_query($sql);\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\nfunction DATABOX_savecategorydatas(\n    $id\n    ,$fldary\n    ,$pi_name=\"\"\n    ,$mydata=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc(\u30ab\u30c6\u30b4\u30ea)\n// | \u66f8\u5f0f DATABOX_savecategorydatas($id,$category,'databox','mydata')\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update20100824\n{\n\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_category=$_TABLES['DATABOX_category'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\t\n\tif  ($mydata==\"\"){\n        $rt=DB_delete($table_category,\"id\",$id);\n\t}else{\n\t\t$categories=COM_applyFilter($_POST['categories']);\n\t\tif  ($categories==\"\" ){\n\t\t}else{\n            $categories=str_replace(\"|\", ',', $categories);\n\t\t    $sql=\"DELETE FROM {$table_category} WHERE \";\n\t        $sql .=\"  id = \".$id ;\n\t        $sql .=\"  AND category_id IN (\".$categories.\")\";\n\t\t    DB_query($sql);\n\t\t}\n\t}\n\t\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$table_category} (\".LB;\n            $sql.=\"id, category_id\".LB;\n            $sql.=\") VALUES (\".LB;\n            $sql.=\"{$id}, {$val}\".LB;\n            $sql.=\")\".LB;\n            DB_query($sql);\n            /////parent_id \u304c0\u306b\u306a\u308b\u307e\u3067insert\n            $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$val}\");\n            while ($parent_id<>0) {\n                $category_id=$parent_id;\n                $seq=DB_getItem( $table_category   ,\"seq\",\"id={$id} AND category_id={$category_id} \");\n                if (is_null($seq)) {\n                    $sql=\"INSERT INTO {$table_category} (\".LB;\n                    $sql.=\"id, category_id\".LB;\n                    $sql.=\") VALUES (\".LB;\n                    $sql.=\"{$id}, {$category_id}\".LB;\n                    $sql.=\")\".LB;\n                    DB_query($sql);\n                }\n                $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$category_id}\");\n            }\n            /////\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\n//==============================================================================\nfunction DATABOX_chkuser(\n        $group_id\n        ,$owner_id\n        ,$adminrights=\"databox.admin\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e6\u30fc\u30b6\u30c1\u30a7\u30c3\u30af\n// | \u66f8\u5f0f $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $group_id\n// | \u5f15\u6570 $owner_id\n// | \u5f15\u6570 $adminrights\u3000databox.admin\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024\n// |    0 guest\n// |   10 guest and allusers\n// | 1000 user\n// | 1010 group\u3000(owner \u542b\u3080)\n// | 1011 owner\n// | 1100 admin\n// | 1110 group and admin\n// | 1101 owner and admin\n// | 1111 group owner and admin\n// +---------------------------------------------------------------------------+\n//update20101004 group_id\n{\n    global $_USER;\n\n    $chk_user=0;\n    if (isset($_USER['uid']) && $_USER['uid'] > 1) {\n        $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n    }\n    if ( SEC_hasRights($adminrights)) {\n        $chk_user=$chk_user+100;//admin\n    }\n    //group \u306b\u5c5e\u3057\u3066\u3044\u308b\u4eba\n    $usergroups=SEC_getUserGroups();\n\n    if ( in_array($group_id, $usergroups)){\n        $chk_user=$chk_user+10;//group\n    }\n\n    if ($owner_id===$_USER['uid']){\n        $chk_user=$chk_user+1;//owner\n    }\n\n    return $chk_user;\n}\n\n\n\nfunction DATABOX_getadditiondef(\n    $pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_def_field'];\n        $table2=$_TABLES['DATABOX_mst'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n        $table2=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n\n    $rt=array();\n\t$fieldgroupno_old=\"\";\n\t\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",description\";\n    $sql.= \",type\";\n    //$sql.= \",fieldgroup_id AS group_id\";\n    $sql.= \",selection\";\n    $sql.= \",selectlist\";\n    $sql.= \",checkrequried\";\n    $sql.= \",size\";\n    $sql.= \",maxlength\";\n    $sql.= \",rows\";\n    $sql.= \",br\";\n    $sql.= \",templatesetvar\";\n\n    $sql.= \",allow_display\";\n    $sql.= \",allow_edit\";\n\n    $sql.= \",textcheck\";\n    $sql.= \",textconv\";\n    $sql.= \",searchtarget\";\n    \n    $sql.= \",initial_value\";\n    $sql.= \",range_start\";\n    $sql.= \",range_end\";\n    $sql.= \",dfid\";\n    $sql.= \",description2\";\n    $sql.= \",fieldgroupno\";\n\t\n    $sql.=\" FROM\";\n    $sql.=\" {$table}  AS m\";\n    $sql.= \" ORDER BY orderno,field_id\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $rt[$field_id]['name'] = COM_stripslashes($A['name']);\n        $rt[$field_id]['checkrequried'] = COM_stripslashes($A['checkrequried']);\n        $rt[$field_id]['description'] = COM_stripslashes($A['description']);\n        $rt[$field_id]['allow_display'] = COM_stripslashes($A['allow_display']);\n        $rt[$field_id]['allow_edit'] = COM_stripslashes($A['allow_edit']);\n        $rt[$field_id]['textcheck'] = COM_stripslashes($A['textcheck']);\n        $rt[$field_id]['textconv'] = COM_stripslashes($A['textconv']);\n        $rt[$field_id]['searchtarget'] = COM_stripslashes($A['searchtarget']);\n        \n        $rt[$field_id]['type'] = COM_stripslashes($A['type']);\n        //$rt[$field_id]['group_id'] = COM_stripslashes($A['group_id']);\n        $rt[$field_id]['selection'] = COM_stripslashes($A['selection']);\n\n        $rt[$field_id]['size'] = COM_stripslashes($A['size']);\n        if ($rt[$field_id]['size']==0){\n            $rt[$field_id]['size']=60;\n        }\n        $rt[$field_id]['maxlength'] = COM_stripslashes($A['maxlength']);\n        if ($rt[$field_id]['maxlength']==0){\n            $rt[$field_id]['maxlength']=160;\n        }\n\n        $rt[$field_id]['rows'] = COM_stripslashes($A['rows']);\n        if ($rt[$field_id]['rows']==0){\n            $rt[$field_id]['rows']=2;\n        }\n        $rt[$field_id]['br'] = COM_stripslashes($A['br']);\n\n        $rt[$field_id]['selectlist'] = COM_stripslashes($A['selectlist']);\n        $rt[$field_id]['templatesetvar'] = COM_stripslashes($A['templatesetvar']);\n\n        $selection= COM_stripslashes($A['selection']);\n        $rt[$field_id]['selectionary']=DATABOX_getselectionary($selection);\n\n        $rt[$field_id]['initial_value']= COM_stripslashes($A['initial_value']);\n        $rt[$field_id]['range_start']= COM_stripslashes($A['range_start']);\n        $rt[$field_id]['range_end']= COM_stripslashes($A['range_end']);\n        $dfid= COM_stripslashes($A['dfid']);\n        $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n        if( empty( $format )) {\n            $rt[$field_id]['format'] = $_CONF['date'];\n        }else{\n            $rt[$field_id]['format'] = $format;\n        }\n\n        $rt[$field_id]['description2']= COM_stripslashes($A['description2']);\n        $fieldgroupno=COM_stripslashes($A['fieldgroupno']);\n        if  ($fieldgroupno_old==$fieldgroupno){\n\t\t}else{\n            $fieldgroup_name=DB_getItem($table2,\"value\",\"kind='fieldgroup' AND no=\".$fieldgroupno);\n            $fieldgroupno_old=$fieldgroupno;\n        }\n        $rt[$field_id]['fieldgroup_name']=$fieldgroup_name;\n        $rt[$field_id]['fieldgroupno']= $fieldgroupno;\n\n    }\n    return $rt;\n\n}\nfunction DATABOX_getselectionary(\n    $selection\n)\n{\n    $selectionary=array();\n    $ary=array();\n    $ary=split(\"\\r\" , $selection);\n\n    $j=0;\n    for ($ii = 0; $ii < count($ary); $ii++) {\n        if ($ary[$ii]<>\"\"){\n            $selectionary[$j]=$ary[$ii];\n            $j=$j+1;\n        }\n    }\n    return $selectionary;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u691c\u7d22\u7528\u5f15\u6570\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getadditionsearchdef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 \u914d\u5217\n// |    $rt[\"sql1\"]: \",{$_TABLES['DATABOX_addition']} AS ad1\"\n// |    $rt[\"sql2\"]: \" AND t1.id=ad1.id AND ad1.field_id=1 \"\n// |    $rt[\"columns\"][]: 'ad1.value '\n// +---------------------------------------------------------------------------+\nfunction DATABOX_getadditionsearchdef(\n    $pi_name=\"\"\n)\n{\n    global $_TABLES;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    \n    if ($box_conf['additionsearch']==0){\n        return;\n    }\n    $lmt=$box_conf['additionsearch'];\n    \n    $retval=array();\n\n    $rt=array();\n    $sql3=\"\";\n    $columns=array();\n\n    $sql=LB;\n    $sql.=\"SELECT \";\n    $sql.= \" field_id \";\n    \n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n\n    // \u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u307f\n    $sql.=\" WHERE\";\n    $sql.=\" allow_display='0'\";\n    //0: \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //1: \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //20:HTML  10:TinyMCE 19:CKEditor\n    //15:\u6570\u5024  21:\u901a\u8ca8\n    $sql.=\" AND type IN (0,1,10,19,20,15,21)\";\n    \n    //\u691c\u7d22\u5bfe\u8c61\u306b\u3059\u308b=\u306f\u3044\n    $sql.=\" AND searchtarget='1'\";\n    \n    $sql.=\" ORDER  BY  orderno,field_id\";\n    $sql.=\" LIMIT 0 ,\".$lmt;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $type = COM_stripslashes($A['type']);\n        $selection= COM_stripslashes($A['selection']);\n        $selectionary=DATABOX_getselectionary($selection);\n\n        $columns[]= \"ad{$field_id}.value \";\n\n        $sql3 .= \" JOIN {$table_addition} AS ad{$field_id}\";\n        $sql3 .= \" ON t1.id=ad{$field_id}.id \";\n        $sql3 .= \" AND ad{$field_id}.field_id={$field_id} \".LB;\n        \n    }\n\n    $rt[\"sql3\"]=$sql3;\n    $rt[\"columns\"]=$columns;\n    \n    return $rt;\n\n}\n\n\n\nfunction DATABOX_getadditiondatas(\n    $id\n    ,$pi_name=\"\"\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondatas($id)\n// | $array=DATABOX_getaddtuindatas($id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u30ea\u30b9\u30c8                                                 |\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_addition=$_TABLES['DATABOX_addition'];\n        $table_def_field=$_TABLES['DATABOX_def_field'];\n    }else{\n        $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n        $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }\n\n    $rt=array();\n    \n    $sql=\"SELECT \";\n    $sql.=\" m.field_id\";\n    $sql.=\" ,m.fieldgroupno\";\n    if ($id==0){\n        $sql.=\",initial_value AS value  \";\n    }else{\n        $sql.=\", ( SELECT VALUE \";\n        $sql.=\" FROM\";\n        $sql.=\" {$table_addition}  AS t\";\n        $sql.=\" where\";\n        $sql.=\" t.id={$id}\";\n        $sql.=\" AND t.field_id=m.field_id\";\n        $sql.=\" ) AS value \";\n    }\n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n    $sql.=\" order by m.fieldgroupno,m.orderno ,m.field_id\";\n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=$A['field_id'];\n        $value=$A['value'];\n        $rt[$field_id]=COM_stripslashes($value);\n    }\n    return $rt;\n\n}\n\n\nfunction DATABOX_getaddtionfieldsEdit(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name=\"\"\n    ,$fields_fnm=\"\"\n    ,$fields_del=\"\"\n    ,$fieldset_id=0\n    ,$fields_date=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsEdit\n//          ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fields_fnm:\n// | \u5f15\u6570 $fields_del:\n// | \u5f15\u6570 $fieldset_id:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n// 20101206 \u65e5\u4ed8\n{\n    global $_TABLES;\n    global $_SCRIPTS;\n    global $_CONF;\n    global $MESSAGE;\n\t\n    if ($pi_name==\"\"){\n        $pi_name=\"databox\";\n    }\n    $lang_admin_x=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_admin;\n    global $$lang_noyes;\n    $lang_admin=$$lang_admin;\n    $lang_noyes=$$lang_noyes;\n    \n    $langCode = COM_getLangIso639Code();\n    $toolTip  = $MESSAGE[118];\n    $imgUrl   = $_CONF['site_url'] . '/images/calendar.png';\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n    $fieldgroup_old=\"\";\n    foreach( $S as $fid => $fvalue ){\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $description=$addition_def[$fid]['description'];\n        $description2=$addition_def[$fid]['description2'];\n        $fieldgroup_name=$addition_def[$fid]['fieldgroup_name'];\n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if (in_array($fid,$fieldsetfields )) {\n            \n            if ($chk_user===9999){\n                $chk=true;\n                $disabled=\"\";\n            }else{\n                //\u7de8\u96c6\u53ef\u80fd\n                if  ($addition_def[$fid]['allow_edit']==='0') {\n                    $chk=true;\n                    $disabled=\"\";\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n                }else if ($addition_def[$fid]['allow_edit']==='2'){\n                    if  ($chk_user>=1010) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='3'){\n                    if  ($chk_user>=1011) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='4'){\n                    $chk=true;\n                }\n            }\n        }\n    \n        if ($chk) {\n\n            $fieldhtml=\"\";\n            switch ($type) {\n                case 12:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml12\n                            ($fid,$fvalue,$fvalue_del,$size,$maxlength);\n                    break;\n                case 11:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml\n                            ($fid,$fvalue,$fvalue_del);\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_filehtml\n                            ($pi_name,$fid,$fvalue,$fvalue_del);\n                    break;\n\n\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                     if ($disabled===\"\"){\n                        $cntname=\"afieldcnt\".$fid;\n                        $fieldhtml .= \"<textarea \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"width:95%\\\"\";\n                        $fieldhtml .= \" rows=\\\"\".$rows.\"\\\"\";\n                        $fieldhtml .= \" id=\\\"DATABOX_afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" \".$disabled.\" \";\n                        $fieldhtml .= \" onKeyup=\\\"var n=\".$maxlength;\n                        $fieldhtml .=\"-this.value.length;var \";\n                        $fieldhtml .=\"s=document.getElementById\";\n                        $fieldhtml .=\"('\".$cntname.\"');s.innerHTML='('+n+')';\\\"\";\n                        if  ($type==20){\n                            $fieldhtml .= \" class=\\\"tinymce_enabled\\\"\";\n                        }\n                        if  ($type==19){\n                            $fieldhtml .= \" class=\\\"wide\\\"\";\n                        }\n                        $fieldhtml .= \">\";\n                        $fieldhtml .= $fvalue;\n                        $fieldhtml .= \"</textarea>\";\n                        $fieldhtml .=\"<br \".XHTML.\"><strong>\";\n                        $fieldhtml .=\"<span id='\".$cntname.\"'></span></strong>\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044 \n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist\n                            ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n                    }else{\n                        $fieldhtml= $lang_noyes[$fvalue];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n\t\t\t\t\t\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                 case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getcheckboxary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                       $fieldhtml=DATABOX_getoptionlist(\"selectlist_mst\",$fvalue,0,$pi_name,\"\",0,$selectlist,\"afield[\".$fid.\"]\");\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist ($selectionary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getradiolist ($mstary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getoptionlistary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\uff08date picker\u5bfe\u5fdc\uff09\n                if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.datepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"date\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 4://\u65e5\u6642\uff08datetime picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.hour_mode = {$_CONF['hour_mode']};\"\n                            . \"  geeklog.datetimepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n\t\t\t\t\t\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"datetime\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 26://\u6642\u523b\uff08UI time picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                         $fvalue_time=DATABOX_getTimeformat($fvalue);\n                         $filedname=\"afield\".$fid;\n                         \n                         $wk =  \" <input \";\n                         $wk .= \" type=\\\"hidden\\\"\";\n                         $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                         $wk .= \" \".XHTML.\">\";\n                         $fieldhtml.=$wk;\n\n                         $fieldhtml .= \"        <input \";\n                         $fieldhtml .= \" data-uk-timepicker=\\\"{format:'\".$_CONF['hour_mode'].\"h'\";\n                         if  ($addition_def[$fid]['range_start']==\"\"){\n                         }else{\n                             $fieldhtml .= \",start:\".$addition_def[$fid]['range_start'] ;\n                         }\n                         if  ($addition_def[$fid]['range_end']==\"\"){\n                         }else{\n                             $fieldhtml .= \",end:\".$addition_def[$fid]['range_end'] ;\n                         }\n                         $fieldhtml .= \" }\\\"\";\n                         $fieldhtml .= \" class=\\\"uk-form-width-small\\\"\";\n                         $fieldhtml .= \" type=\\\"text\\\"\";\n                         $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                         $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                         $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                         $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                         $fieldhtml .= \" value=\\\"\". $fvalue_time.\"\\\"\";\n                         $fieldhtml .= \" \".XHTML.\">\";\n                     }else{\n                        $fieldhtml .=$fvalue;\n                     }\n                     break;\n                case 22://\u65e5\u4ed8\n                if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n\n                        $_SCRIPTS->setJavaScript(\n                            \"$(function() {\n                            $( \\\"#afield\".$fid.\"\\\" ).datepicker();\n                            });\"\n                            , TRUE, TRUE\n                            );\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                        \n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 23://\u65e5\u4ed8\n                    if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n                        \n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" data-uk-datepicker=\\\"{format:'YYYY/MM/DD'}\\\"\";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\". $fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 17://\u30d5\u30e9\u30b0\n                    if ($disabled===\"\"){\n                        $wk =\" <input \";\n                        $wk .= \" type=\\\"checkbox\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"1\\\"\";\n                        if  ($fvalue==1) {\n                            $wk .= \" checked=checked\";\n                        }\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml=$wk;\n                    }else{\n                        $fieldhtml= $fvalue;\n                    }\n                    break;\n\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                default:\n                    if ($disabled===\"\"){\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n            }\n\n\n            if ($checkrequried==1){//\u5fc5\u9808\n                $must= $lang_admin['must'];\n            }else{\n                $must=\"\";\n            }\n            $templates->set_var('lang_must_additionfield', $must);\n\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield_templatesetvar', \"&#123;\".$templatesetvar.\"&#125;\");\n\n            $addisionfields .= $fieldhtml;\n            $templates->set_var('additionfield_value', $fieldhtml);\n\n            $templates->set_var('additionfield_description', $description);\n            $templates->set_var('additionfield_description2', $description2);\n            $templates->set_var('fieldgroup_name', $fieldgroup_name);\n\t\t\tif  ($fieldgroup_old==$fieldgroup_name){\n                $templates->set_var('fieldgroup', \"\");\n            }else{\n                $templates->set_var('fieldgroup', $fieldgroup_name);\n                $fieldgroup_old=$fieldgroup_name;\n            }\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n        }\n    }\n\n    return $retval;\n}\n\n//\nfunction DATABOX_figurehtml(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n\n//    $retval .= \" value=\\\"\".$fvalue_fnm.\"\\\"\";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .=\"<img src=\\\"data:image/jpg;base64,\";\n        $retval .=\"{$fvalue}\\\"\";\n        $retval .=\"width=100 height=100\";\n        $retval .=\" \".XHTML.\">\".LB;\n        //\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n//  $photo_x = USER_getPhoto ($uid, $photo, $email, -1);\n\n    return $retval;\n}\nfunction DATABOX_filehtml(\n    $pi_name\n    ,$fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $lang_box_admin['deletemsg_check'];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\n\nfunction DATABOX_figurehtml12(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n    ,$size\n    ,$maxlength\n)\n{\n\n    global $LANG04;\n    \n    $a=explode(\"|\",$fvalue);\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .= \"<input \";\n    $retval .= \" type=\\\"text\\\"\";\n    $retval .= \" size=\\\"\".$size.\"\\\"\";\n    $retval .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n    $retval .= \" name=\\\"afield_alt[\".$fid.\"]\\\" \";\n    $retval .= \" style=\\\"max-width:95%\\\"\";\n    $retval .= \" value=\\\"\".$a[1].\"\\\"\";\n    $retval .= \" \".XHTML.\">\";\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_imagehtml(\n    $name\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"\".$name.\"\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    if ($fvalue==\"\"){\n\n        $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n        $retval .= \" id=\\\"\".$name.\"\\\" \";\n        $retval .= \" name=\\\"\".$name.\"\\\" \";\n\n        $retval .=\"size=\\\"30\\\"\";\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }else{\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"\".$name.\"_del\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_getaddtionfieldsText(\n    $fields\n    ,$addition_def\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeTEXT\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsText\n// |        ($additionfields,$addition_def,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76eetext\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_CONF;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n    \n    $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n\n        $chk=false;\n        $disabled=\"disabled\";\n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($addition_def[$fid]['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n\n        if (in_array($fid,$fieldsetfields )) {\n            if ($chk) {\n                $retval.=$name.\":\";\n\n                switch ($type) {\n                    case 11://\u56f3\n                        $retval .= \"\";\n                        break;\n                    case 2://\u3044\u3044\u3048/\u306f\u3044\n                        $retval .= $lang_noyes[$fvalue];\n                        break;\n                    case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 8://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                        $retval .= $selectionary[$fvalue];\n                        break;\n                    case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $wk.=$selectionary[$wkary[$x]].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                        $retval .= $mstitems['value'];\n                        break;\n                    case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                            $wk.=$mstitems['value'].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 4://\u65e5\u6642\n                        $w=COM_getUserDateTimeFormat($fvalue);\n                        $retval .= $w[0];\n                        break;\n                    case 22://\u65e5\u4ed8\n                    case 23://\u65e5\u4ed8\n                    case 3://\u65e5\u4ed8\n                        if  ($fvalue<>\"\"){\n                            $retval .=strftime( $_CONF['shortdate'], $fvalue );\n                        }\n                        break;\n                    case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                    case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                    case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                    case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                    default:\n                        $retval .= $fvalue;\n                }\n                $retval.=LB;\n            }\n        }\n    }\n    return $retval;\n}\n\n\n\nfunction DATABOX_getaddtionfieldsDisp(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u4f5c\u6210                                              |\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsDisp\n// |        ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n//update 20101012 $chk_user\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    \n    $noimage=\"lib/noimage.jpg\";\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n\n        $name=$addition_def[$fid]['name'];\n        $description=$addition_def[$fid]['description'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n        $format=$addition_def[$fid]['format'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $chk=false;\n        if (in_array($fid,$fieldsetfields )) {\n            //\u8868\u793a\u3059\u308b\n            if  ($addition_def[$fid]['allow_display']==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_display']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n                //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n        }\n        if ($chk) {\n            $fieldhtml=\"\";//\u5916\u753b\u50cf\u306e\u5834\u5408\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtml_tn=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtmldisp=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtmldisp_tn=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtml_noimage=\"\";\n            $fieldhtml_tn_noimage=\"\";\n\t\t\t$fieldhtml_tn_image=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\n\t\t\t$fieldhtml_readfile=\"\";//\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30ebreadfile\n            $mstitems=array();\n            $fieldhtml_yes=\"\";\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\uff08\u6e96\u5099\u4e2d\uff09\n                    $a=explode(\"|\",$fvalue);\n                    $fieldhtml=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                    $fieldhtml_noimage=$a[0];\n                    //\n                    if  ($fvalue===\"\"){\n                        $fieldhtml_noimage=$noimage;\n                        $fieldhtml_tn_noimage=$noimage;\n                    }else{\n\n                        $fieldurl= $_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n                        $fieldurl.= $a[0] ;\n\n                        $fieldhtmldisp .=\"<img \";\n                        $fieldhtmldisp .=\" src=\\\"{$fieldurl}\\\"\";\n                        $fieldhtmldisp .=\" border=\\\"0\\\"\";\n                        $fieldhtmldisp .=\" alt=\\\"{$a[1]}\\\"\";\n                        $fieldhtmldisp .=\" \".HTML.\">\";\n                    \n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\n                        $filename = substr($fvalue, 0, strrpos($fvalue,\".\"));\n                        $thum_filename = $filename . \"-small.jpg\";\n                        $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    \n                        if(file_exists($imgfld_thmb.$thum_filename)) {\n                            $fieldhtml_tn=$thum_filename;\n                            $fieldhtml_tn_noimage=$thum_filename;\n                            //\n                            $fieldurl_tn= $_CONF['site_url']   .\"/\".$box_conf['imgfile_thumb_frd'] ;\n                            $fieldurl_tn.= $thum_filename ;\n                            //\n                            $fieldhtml_tn_image .=\"<a href=\\\"{$fieldurl}\\\" target=\\\"_blank\\\">\";\n                            $fieldhtml_tn_image .=\"<img \";\n                            $fieldhtml_tn_image .=\" src=\\\"{$fieldurl_tn}\\\"\";\n                            $fieldhtml_tn_image .=\" border=\\\"0\\\"\";\n                            $fieldhtml_tn_image .=\" alt=\\\"{$a[1]}\\\"\";\n                            $fieldhtml_tn_image .=\" \".XHTML.\">\";\n                            $fieldhtml_tn_image .=\" </a>\";\n                        \n                        }else{\n                            $fieldhtml_tn_noimage=$noimage;\n                        }\n                        \n                    }\n\n                    break;\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $a=explode(\"|\",$fvalue);\n                        $fieldhtml .= $a[1];\n                        $fieldhtml_readfile = $a[0];\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $fieldhtml .=\"<img src=\\\"data:image/jpg;base64,\";\n                        $fieldhtml .=\"{$fvalue}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $fieldhtml .= $lang_noyes[$fvalue];\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@@\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@\n                    $fieldhtml .= $selectionary[$fvalue];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($fvalue);\n                    $w=DATABOX_autolink($w);\n                    $fieldhtml .= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                    $fieldhtml .= $mstitems['value'];\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    \n                    $mstitems['value2'] = rtrim($wk_value2,$separater);\n                    $mstitems['disp'] = rtrim($wk_disp,$separater);\n                    $mstitems['no'] =$fvalue;\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($fvalue<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($fvalue,$format);\n                        $fieldhtml .= $w[0];\n                    }\n                    break;\n                case 26://\u6642\u523b\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .= DATABOX_getTimeformat($fvalue);\n                    }\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                case 3://\u65e5\u4ed8\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .=strftime( $_CONF['shortdate'], $fvalue );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $fieldhtml .= number_format( (float)$fvalue, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $fieldhtml .= $fvalue;\n            }\n            $templates->set_var('field_id', $fid);\n            $templates->set_var('field_type', $type);\n            \n            //\u9805\u76ee\u540d\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield'.$fid.\"_name\", $name);\n            $templates->set_var($templatesetvar.\"_name\", $name);\n            \n            //\u8aac\u660e\n            $templates->set_var('additionfield'.$fid.\"_description\", $description);\n            $templates->set_var($templatesetvar.\"_description\", $description);\n            \n            //\u767b\u9332\u3057\u305f\u30c6\u30fc\u30de\u5909\u6570\u540d\n            $templates->set_var('additionfield_templatesetvar', $templatesetvar);\n            \n            //\n            $templates->set_var('additionfield_value', $fieldhtml);\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n            $templates->set_var('additionfield_fvalue', $fvalue);\n            $templates->set_var('additionfield'.$fid.\"_value\", $fvalue);\n            $templates->set_var($templatesetvar.\"_value\", $fvalue);\n            \n            if  ($type==12){\n                $templates->set_var('display_a', 'display:');\n            }else{\n                $templates->set_var('display_a', 'display:none');\n            }\n            //(a_1)_tn \u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $templates->set_var('additionfield_value_tn', $fieldhtml_tn);\n            $templates->set_var('additionfield'.$fid.\"_tn\", $fieldhtml_tn);\n            $templates->set_var($templatesetvar.\"_tn\", $fieldhtml_tn);\n            \n            //(a_2)_noimage\n            $templates->set_var('additionfield_value_noimage', $fieldhtml_noimage);\n            $templates->set_var('additionfield'.$fid.\"_noimage\", $fieldhtml_noimage);\n            $templates->set_var($templatesetvar.\"_noimage\", $fieldhtml_noimage);\n            \n            //(a_3)_tn_image \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_image', $fieldhtml_tn_image);\n            $templates->set_var('additionfield'.$fid.\"_tn_image\", $fieldhtml_tn_image);\n            $templates->set_var($templatesetvar.\"_tn_image\", $fieldhtml_tn_image);\n            \n            //(a_4)_tn_noimage \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_noimage', $fieldhtml_tn_noimage);\n            $templates->set_var('additionfield'.$fid.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            $templates->set_var($templatesetvar.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            \n            //(a_5)disp \u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\u8868\u793a\n            $templates->set_var('additionfield_value_disp', $fieldhtmldisp);\n            $templates->set_var('additionfield'.$fid.\"_disp\", $fieldhtmldisp);\n            $templates->set_var($templatesetvar.\"_disp\", $fieldhtmldisp);\n            \n            if  ( $type==9 OR $type==16 OR $type==18 ){\n                $templates->set_var('display_b', 'display:');\n            }else{\n                $templates->set_var('display_b', 'display:none');\n            }\n            //(b_1)\u30de\u30b9\u30bf\u30fc\u306evalue2\n            $templates->set_var('additionfield_value_mst_value2', $mstitems['value2']);\n            $templates->set_var('additionfield'.$fid.\"_mst_value2\", $mstitems['value2']);\n            $templates->set_var($templatesetvar.\"_mst_value2\", $mstitems['value2']);\n            \n            //(b_2)\u30de\u30b9\u30bf\u30fc\u306edisp\n            $templates->set_var('additionfield_value_mst_disp', $mstitems['disp']);\n            $templates->set_var('additionfield'.$fid.\"_mst_disp\", $mstitems['disp']);\n            $templates->set_var($templatesetvar.\"_mst_disp\", $mstitems['disp']);\n            \n            //(b_3)\u30de\u30b9\u30bf\u30fc\u306eno\n            $templates->set_var('additionfield_value_mst_no', $mstitems['no']);\n            $templates->set_var('additionfield'.$fid.\"_mst_no\", $mstitems['no']);\n            $templates->set_var($templatesetvar.\"_mst_no\", $mstitems['no']);\n            \n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var('additionfield'.$fid.\"_disptn\", $fieldhtmldisp_tn);\n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var($templatesetvar.\"_disptn\", $fieldhtmldisp_tn);\n\t\t\t\n            if  ( $type==13  ){\n                $templates->set_var('display_c', 'display:');\n            }else{\n                $templates->set_var('display_c', 'display:none');\n            }\n\t\t\t//(c)\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u61b6\u30d5\u30a1\u30a4\u30eb\u540d(templatesetvar_(id)_(readfile))\n            $templates->set_var('additionfield_value_readfile', $fieldhtml_readfile);\n            $templates->set_var('additionfield'.$fid.\"_readfile\", $fieldhtml_readfile);\n            $templates->set_var($templatesetvar.\"_readfile\", $fieldhtml_readfile);\n\t\t\t\n\t\t\t//\u5fc5\u9808\u30c1\u30a7\u30c3\u30af(templatesetvar_(id)_(requied))\n            $templates->set_var('additionfield'.$fid.\"_requried\", $checkrequried);\n            $templates->set_var($templatesetvar.\"_requried\", $checkrequried);\n\t\t\t\n            //\u6587\u8a00\n            $templates->set_var('lang_download', $lang_box['download']);\n            $templates->set_var('lang_downloadrequired', $lang_box['downloadrequired']);\n            $templates->set_var('lang_display', $lang_box['display']);\n            $templates->set_var('lang_displayrequired', $lang_box['displayrequired']);\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n    }\n\n\n    return $retval;\n}\n\n//\nfunction DATABOX_getMstItems(\n    $selectlist\n    ,$id\n    ,$pi_name\n//DATABOX_getMstItems($id,$pi_name);\n){\n    if ($id==\"\"){\n        return array();\n    }\n    global $_TABLES;\n    \n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n\n    $sql=\"SELECT * FROM  {$table_mst} WHERE kind='{$selectlist}' AND no={$id}\";\n    \n    $result = DB_query($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows > 0) {\n        $A = DB_fetchArray($result, true);\n        $A = array_map('stripslashes', $A);\n    }else{\n        $A=array();\n    }\n    return $A;\n}\n\n\nfunction DATABOX_getcategoriesText(\n    $id\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u30e1\u30fc\u30eb\u9001\u4fe1\u7528\u30c6\u30ad\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesText\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u30c6\u30ad\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n{\n    global $_TABLES;\n    global $_CONF;\n\n\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $lang_box_admin=\"LANG_DATABOX_ADMIN\";\n\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater_text'];\n\n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    $categories_group =\"\";\n    $rt=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n                $categories_group=rtrim($categories_group,$separater);\n                $rt.=$categories_group.LB;\n            }\n            $categories_group =\"\";\n            $old_group_id=$A['group_id'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n\n    }\n\n    $categories=rtrim($categories,$separater);\n    $categories_group=rtrim($categories_group,$separater);\n    $rt.=$categories_group.LB;\n\n    $retval.=$lang_box_admin['category'].\": \".$categories.LB;\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesDisp(\n    $id\n    ,$templates\n    ,$chk_user\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30eaHRML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesDisp\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u8868\u793a\u7528HTML\n// +---------------------------------------------------------------------------+\n//20101129\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $box_conf=\"_DATABOX_CONF\";\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    $sql = \"SELECT \";\n    $sql .= \" group_id\".LB;\n    $sql .= \" ,code\".LB;\n    $sql .= \" FROM \";\n    $sql .= \" {$table_def_group} \".LB;\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    \n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $gid=$A['group_id'];\n        $gcode=$A['code'];\n        $templates->set_var('group_'.$gid, \"\");\n        $templates->set_var('group_'.$gcode, \"\");\n        $templates->set_var('group_'.$gid.\"_code\", \"\");\n        $templates->set_var('group_'.$gcode.\"_code\", \"\");\n                \n        $templates->set_var('grouplink_'.$gid, \"\");\n        $templates->set_var('grouplink_'.$gid.\"_code\", \"\");\n\n        $templates->set_var('grouplink_'.$gcode, \"\");\n        $templates->set_var('grouplink_'.$gcode.\"_code\", \"\");\n    }\n    \n    \n    \n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    $sql .= \",m1.allow_display\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno,m1.category_id\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater'];\n    $separater_code=$lang_box['category_separater_code'];\n    $separater_pipeline=\"|\";\n    \n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    \n    $categories_group =\"\";\n    $categories_link_id_group =\"\";\n    $categories_link_code_group =\"\";\n    \n    $categories_group2 =\"\";\n    $categories_link_id_group2 =\"\";\n    $categories_link_code_group2 =\"\";\n    \n    $categories_group_pipeline =\"\";\n    \n    //group_id2, group_code2, grouplinkid2, grouplinkcode2,\n    //group_id \u304c\u30ab\u30c6\u30b4\u30ea\u306e\u540d\u79f0\u3092\u8868\u793a\u3059\u308b\u306e\u306b\u5bfe\u3057\u3001\n    //group_id2\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group $categories_link_id_group $categories_link_code_group\n    //group_pipeline\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u533a\u5207\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group_pipeline\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $chk=false;\n        //\u8868\u793a\u3059\u308b\n        if  ($A['allow_display']==='0') {\n            $chk=true;\n        //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n        }else if ($A['allow_display']==='1'){\n            if  ($chk_user>=1000) {\n                $chk=true;\n            }\n        //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n        }else if ($A['allow_display']==='2'){\n            if  ($chk_user>=1010) {\n                $chk=true;\n            }\n        //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='3'){\n            if  ($chk_user>=1011) {\n                $chk=true;\n            }\n        //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='4'){\n            if  ($chk_user>=1100) {\n                $chk=true;\n            }\n        }\n        \n        if  ($chk==false){\n            continue;\n        }\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n\n                $categories_group=rtrim($categories_group,$separater);\n                $templates->set_var('group_'.$old_group_id, $categories_group);\n                $templates->set_var('group_'.$old_group_code, $categories_group);\n                $categories_group2=rtrim($categories_group2,$separater_code);\n                $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n                $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n                $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n                $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n                $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n                \n                $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n                $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);\n\n                $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n                $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);\n\n            }\n            $categories_group =\"\";\n            $categories_link_id_group =\"\";\n            $categories_link_code_group =\"\";\n            $categories_group2 =\"\";\n            $categories_link_id_group2 =\"\";\n            $categories_link_code_group2 =\"\";\n            $categories_group_pipeline=\"\";//@@\n            \n            $old_group_id=$A['group_id'];\n            $old_group_code=$A['group_code'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n        $categories_group2.=$A['category_code'].$separater_code;\n        $categories_group_pipeline.=$A['category_code'].$separater_pipeline;\n        \n\n        $name=$A['category_name'];\n        $code=COM_applyFilter($A['category_code']);\n        $url=$_CONF['site_url'] .\"/\".$pi_name.\"/category.php\";\n        $url_code=$url;\n        $url_code.=\"?code=\".$A['category_code'];\n        $url_code.=\"&m=code\";\n        $url_code = COM_buildUrl( $url_code );\n        $url_id=$url;\n        $url_id.=\"?id=\".$A['category_id'];\n        $url_id.=\"&m=id\";\n        $url_id= COM_buildUrl( $url_id );\n        $category_link_id= COM_createLink($name, $url_id);\n        $category_link_code= COM_createLink($name, $url_code);\n        $category_link_id2= COM_createLink($code, $url_id);\n        $category_link_code2= COM_createLink($code, $url_code);\n\n        $categories_link_id.=$category_link_id.$separater;\n        $categories_link_id_group.=$category_link_id.$separater;\n        $categories_link_id_group2.=$category_link_id2.$separater_code;//@@\n        $categories_link_code.=$category_link_code.$separater;\n        $categories_link_code_group.=$category_link_code.$separater;\n        $categories_link_code_group2.=$category_link_code2.$separater_code;//@@\n    }\n\n    $categories=rtrim($categories,$separater);\n    $templates->set_var('categories', $categories);\n\n\n    $categories_link_code=rtrim($categories_link_code,$separater);\n    $categories_link_id=rtrim($categories_link_id,$separater);\n\n\n    if ($box_conf['categoriescode']){\n        $categorieslink=$categories_link_code;\n    }else{\n        $categorieslink=$categories_link_id;\n    }\n    $templates->set_var('categorieslink', $categorieslink);\n\n\n    $templates->set_var('categorieslinkcode', $categories_link_code);\n    $templates->set_var('categorieslinkid', $categories_link_id);\n\n    $categories_group=rtrim($categories_group,$separater);\n    $categories_group2=rtrim($categories_group2,$separater_code);\n    $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n\n    $templates->set_var('group_'.$old_group_id, $categories_group);\n    $templates->set_var('group_'.$old_group_code, $categories_group);\n    $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n    $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n\n    $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n    \n    $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);//@@\n    \n    $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n    \n    $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);//@@\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesinp(\n    $selected = \"\"\n    ,$fieldset_id=\"\"\n    ,$pi_name=\"\"\n    ,$chk_user=9999\n)\n{\nglobal $_TABLES;\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_def_fieldset_group=$_TABLES['DATABOX_def_fieldset_group'];\n        $table_mst=$_TABLES['DATABOX_mst'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_def_fieldset_group=$_TABLES[strtoupper($pi_name).'_def_fieldset_group'];\n        $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n    \n    //\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    \n    //\n    $retval = '';\n\n    $sql = \"SELECT \";\n    $sql .= \"m2.group_id\".LB;\n    $sql .= \",m2.name AS group_name\".LB;\n    $sql .= \",m2.input_type\".LB;\n    $sql .= \",m2.allow_edit\".LB;\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_def_group} AS m2\".LB;\n    if  ($fieldset_id<>0){\n        $sql .= \" ,{$table_def_fieldset_group} AS m3\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m2.group_id = m3.group_id\".LB;\n        $sql .= \" AND m3.fieldset_id = \".$fieldset_id .LB;\n    }\n    \n    \n    $sql .= \" ORDER BY m2.orderno\".LB;\n        \n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $categoryids=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        \n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($A['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($A['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($A['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($A['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n        if ($chk==false) {\n            continue;\n        }\n\t\t\n        $sql2 = \"SELECT \";\n        $sql2 .= \" m1.category_id\".LB;\n        $sql2 .= \",m1.name\".LB;\n        $sql2 .= \",m1.orderno\".LB;\n        $sql2 .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql2 .= \" WHERE \".LB;\n        $sql2 .= \" m1.categorygroup_id=\".$A['group_id'].LB;\n        \n        $sql2 .= \" ORDER BY m1.orderno\".LB;\n        \n        $result2 = DB_query( $sql2 );\n        $nrows2 = DB_numRows( $result2 );\n        \n        if ($nrows2>0){\n            $retval .=\"<div class=\\\"databox_admin_data_title\\\">\";\n            $retval .=$A['group_name'];\n            $retval .=\"</div>\".LB;\n        \n            if  ($A['input_type']==1){\n                $retval .='<select name=\"category[]\" multiple style=\"height:10em\" '.$disabled.' >'.LB;\n            }else if ($A['input_type']==3){\n                $retval .='<select name=\"category[]\" '. $disabled .' >'.LB;\n            }\n            \n            for( $i2 = 0; $i2 < $nrows2; $i2++ )    {\n\n                $A2 = DB_fetchArray( $result2, true );\n                \n\t\t\t\tif  ($disabled==\"\"){\n\t\t\t\t\t$categoryids.=$A2['category_id'].\"|\";\n                }\n                \n                $checked=\" \";\n                for( $x = 0; $x < sizeof( $S ); $x++ )            {\n                    if( $A2['category_id'] == $S[$x] )                {\n                        if  ($A['input_type']==0 OR $A['input_type']==2){\n                            $checked= ' checked=\"checked\" ';\n                        }else{\n                            $checked= ' selected ';\n                        }\n                    }\n                }\n            \n                if  ($A['input_type']==0){\n                    $retval .= '<span style=\"white-space:nowrap\">';\n                    $retval .= '<input type=\"checkbox\" name=\"category[]\" value=\"' . $A2['category_id'] ;\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= $disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==1){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }else  if  ($A['input_type']==2){\n                    $retval .= '<input type=\"radio\" name=\"category[]\" value=\"' . $A2['category_id'];\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= ' '.$disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==3){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }\n            }\n        \n            if  ($A['input_type']==1  OR  $A['input_type']==3  ){\n                $retval .='</select>';\n            }\n        }\n        \n\t}\n\tif  ($categoryids==\"\"){\n\t}else{\n\t\t$categoryids=substr($categoryids,0,strlen($categoryids)-1);\n        $retval .= \"  <input type='hidden' name='categories' value='{$categoryids}'>\";\n    }\n    return $retval;\n}\nfunction DATABOX_getaddtionfields(\n    $id\n    ,$addition_def\n    ,$pi_name\n    ,$field_id=0\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getadditionfields($id,$addition_def,$tbl_prefix,$field_id)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\u306e\u914d\u5217\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n\n    global $_TABLES;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $retval=array();\n\n    $sql = \"SELECT \";\n    $sql .= \" value\";\n    $sql .= \",t.field_id\";\n\n    $sql .= \" FROM {$table_addition} AS t\";\n    $sql .= \" , {$table_def_field} AS m\";\n    $sql .= \" WHERE \";\n    $sql .= \" t.id={$id}\";\n    $sql .= \" AND t.field_id=m.field_id\";\n    if ($field_id<>0){\n        $sql .= \" AND t.field_id=\".$field_id;\n    }\n\n    $sql .= \" ORDER BY m.orderno\";\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n\n        $fid=$A[\"field_id\"];\n        $value=$A[\"value\"];\n\n        $fieldvalue=DATABOX_getfieldvalue(\n            $value\n            ,$addition_def[$fid]['type']\n            ,$addition_def[$fid]['selectionary']\n            ,$lang_noyes\n            ,$addition_def[$fid]['selectlist']\n            ,$pi_name\n            );\n        $retval[$fid]=$fieldvalue;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getfieldvalue(\n    $value\n    ,$type\n    ,$selectionary\n    ,$lang_noyes\n    ,$selectlist\n    ,$pi_name\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getfieldvalue($value,$type,$selectionary,$lang_noyes)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $value:\n// | \u5f15\u6570 $type:\n// | \u5f15\u6570 $selectionary:\n// | \u5f15\u6570 $lang_noyes:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    switch ($type) {\n\n        case 2://\u3044\u3044\u3048/\u306f\u3044\n            $fieldvalue = $lang_noyes[$value];\n            break;\n        case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n        case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n            $fieldvalue= $selectionary[$value];\n            break;\n        case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n        case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n            if  ($value==\"\"){\n                $fieldvalue=\"\";\n            }else{\n                $fieldvalue=DB_getItem($_TABLES[strtoupper($pi_name).'_mst'] \n                    ,\"value\"\n                    ,\"kind='{$selectlist}' AND no={$value}\");\n            }\n            break;\n        case 4://\u65e5\u6642\n            $w=COM_getUserDateTimeFormat($value);\n            $fieldvalue= $w[0];\n            break;\n        case 3://\u65e5\u4ed8\n            $fieldvalue=strftime( $_CONF['shortdate'], $value );\n            break;\n        case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n        case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n        case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n        case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n        case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n        default:\n            $fieldvalue = $value;\n        }\n\n    return $fieldvalue;\n}\n\n\nfunction DATABOX_saveaddtiondatas(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc                                                        |\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n    \n    $rt=DB_delete($table,\"id\",$id);\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            $sql=\"INSERT INTO {$table} (\";\n            $sql.=\"id, field_id,value \";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id},{$field_id}\";\n            if  ($value<>\"\") {\n                $sql.=\", '{$value}'\";\n            }else{\n                $sql.=\", NULL\";\n            }\n            $sql.=\")\";\n            DB_query($sql);\n        }\n    }\n    return ;\n\n}\n\nfunction DATABOX_saveaddtiondatas_update(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc user\u7528\n// | \u66f8\u5f0f $rt=DATABOX_saveaddtiondatas_update\n// |               ($id,$additionfields,$addition_def,$pi_name);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //if ($addition_def[$field_id]['type']=11){\n            $sql=\"UPDATE \".$table .\" SET \";\n            if  ($value<>\"\") {\n                $sql.=\" value ='\".$value.\"'\";\n            }else{\n                $sql.=\" value =NULL\";\n            }\n            $sql.=\" WHERE id=\".$id.\" AND field_id=\".$field_id;\n            DB_query($sql);\n        }\n    }\n\n\n    return ;\n\n}\n\nfunction DATABOX_cleanaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,&$fnmary\n    ,&$delary\n    ,&$dateary\n    ,&$altary\n    ,$addslash = true\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeclean\n// | \u66f8\u5f0f DATABOX_cleanadditiondatas($fldary,$typeary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def\n// | \u5f15\u6570 $fnmary\n// | \u5f15\u6570 $delary\n// | \u5f15\u6570 $addslash \n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update 20131022 12\n{\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            $type=$addition_def[$field_id]['type'];\n            $textconv=$addition_def[$field_id]['textconv'];\n            $textcheck=$addition_def[$field_id]['textcheck'];\n            $wk=$value;\n            //\u5165\u529b\u5024\u5909\u63db\n            switch ($type) {\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK TinyMCE)\n                if  (($textconv==10)\n                        OR ($textcheck>=11 AND $textcheck<=14)){ //\u534a\u89d2\u30c1\u30a7\u30c3\u30af;\n                        $wk = mb_convert_kana($wk,\"ak\");\n                    }else if ($textconv==20){ //\u5168\u89d2\u306b\u5909\u63db\u3059\u308b';\n                        $wk = mb_convert_kana($wk,\"AKV\");\n                }\n                break;\n            }\n            //\n            switch ($type) {\n                case 11:// \u56f3\n                    break;\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\n                case 10://\u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\n                    $wk=COM_stripslashes($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 1://HTML\n                case 20://TinyMCE\n                case 19://CKEditor\n                    $wk=COM_stripslashes($wk);\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $wk=COM_applyFilter($wk,true);\n                    break;\n                case 3://\u65e5\u4ed8\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day;\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                    $ary_wk=date_parse( $wk);\n                    if  ($ary_wk[error_count]==0){\n                        $dateary[$field_id]['month']= $ary_wk[month];\n                        $dateary[$field_id]['day']= $ary_wk[day];\n                        $dateary[$field_id]['year']= $ary_wk[year];\n                    }else{\n                        $wk=\"\";\n                        $dateary[$field_id]['month']= \"\";\n                        $dateary[$field_id]['day']= \"\";\n                        $dateary[$field_id]['year']= \"\";\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk_hour=$_POST['afield'.$field_id.'_hour'];\n                    $wk_minute=$_POST['afield'.$field_id.'_minute'];\n                    $wk_ampm=$_POST['afield'.$field_id.'_ampm'];\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    $dateary[$field_id]['hour']=$wk_hour;//@@@@@\n                    $dateary[$field_id]['minute']=$wk_minute;//@@@@@\n                    $dateary[$field_id]['ampm']=$wk_ampm;//@@@@@\n                    if ($wk_ampm == 'pm') {\n                        if ($wk_hour < 12) {\n                            $wk_hour = $wk_hour + 12;\n                        }\n                    }\n                    if ($wk_ampm == 'am' AND $wk_hour == 12) {\n                        $wk_hour = '00';\n                    }\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day .\" \".$wk_hour.\":\".$wk_minute;\n                    break;\n                case 26://\u6642\u523b\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wk=implode ($wk,\":\");\n                    break;\n                case 12:// \u753b\u50cf\uff08\u30d5\u30a1\u30a4\u30eb\u4fdd\u5b58\uff09\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($altary[$field_id]);\n                    $wk2=COM_checkHTML (COM_checkWords ($wk2));\n                    $altary[$field_id]=$wk2;\n                    $a=explode(\"|\",$wk);\n                    $wk=$a[0].\"|\".$wk2;\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($delary[$field_id]);\n                    $delary[$field_id]=COM_checkHTML (COM_checkWords ($wk2));\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                default:\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n            }\n            if ($addslash){\n                $wk=addslashes ($wk);\n            }\n            $fldary[$field_id] =$wk;\n        }\n    }\n\n    return $fldary;\n\n}\n\nfunction DATABOX_checkaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u8ffd\u52a0\u9805\u76eecheck\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($fldary,$typeary,$pi_data)\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n    \n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //\u5fc5\u9808\n            if ($addition_def[$field_id]['checkrequried']==1){\n                if ($value ===\"\"){\n                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_checkrequried'] ;\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                }\n                //url email date\n            }\n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                 $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld_thmb.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $imgfld )){\n                    $rt.=$imgfld.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if  ($imgfld<>$imgfld_thmb){\n                    if (!is_writable ( $imgfld_thmb )){\n                        $rt.=$imgfld_thmb.\": \".$lang_box_admin['err_writable'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                     //$fldary[$field_id]=\"\";\n                     //$fldary_fnm[$field_id]=\"\";\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($imgfile<>\"\"){\n                            $imgerr=\"\";\n                            if ($box_conf['imgfile_size2']<>\"\" AND $imgsize>$box_conf['imgfile_size2']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $imgerr=1;\n                            }\n                            if (count($box_conf['imgfile_type2'])>0){\n                                if  (in_array($imgtype,$box_conf['imgfile_type2'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type2']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $imgerr=1;\n                                }\n                            }\n                        \n                            //$imgname=sanitize\n                            // \u554f\u984c\u6587\u5b57\u3092\u9664\u304f\n                            //$filename = str_replace(\"&\",\"\",$filename);\n                            //$filename = str_replace(\"'\",\"\",$filename);\n                            //$filename = str_replace(\"/\",\"\",$filename);\n                            //$filename = str_replace(\".JPG\",\".jpg\",$filename);\n                            //\u91cd\u8907\u30c1\u30a7\u30c3\u30af\n                            if  ($imgerr===\"\"){\n                                $fldary[$field_id]=$imgname.\"|\".fldary_alt;//@@@@@@@!!!!\n                            }\n                        }\n                    }else{\n                        \n                    }    \n                 }\n            }\n\n\n\n            //\u56f3 DB\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==11){//\u56f3\n\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                        $fldary[$field_id]=\"\";\n                        $fldary_fnm[$field_id]=\"\";\n                 }else{\n                    //$figure = $_FILES[$w];\n                    // $imgfile=$figure[ 'tmp_name' ];\n\n\n                     $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                     $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                     $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                     if  ($imgfile<>\"\"){\n                          $imgerr=\"\";\n                          if ($box_conf['imgfile_size']<>\"\" AND $imgsize>$box_conf['imgfile_size']){\n                              $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                              $rt.=\"<br \".XHTML.\">\".LB;\n                              $imgerr=1;\n                          }\n                          if (count($box_conf['imgfile_type'])>0){\n                              if  (in_array($imgtype,$box_conf['imgfile_type'])){\n                              }else{\n                                  $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                  .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                  $rt.=\"<br \".XHTML.\">\".LB;\n                                 $imgerr=1;\n                              }\n                          }\n                          if  ($imgerr===\"\"){\n                              $imgbinary = fread ( fopen ( $imgfile , \"r\" ), filesize ( $imgfile ));\n                              $fldary[$field_id]=base64_encode($imgbinary);\n                          }\n                     }\n                 }\n            }\n\n            //\u65e5\u4ed8 \u65e5\u6642\n            if ($addition_def[$field_id]['type']==3 OR $addition_def[$field_id]['type']==4\n                     OR $addition_def[$field_id]['type']==22 OR $addition_def[$field_id]['type']==23){//\u65e5\u4ed8\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime($value);\n                    \n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime($addition_def[$field_id]['range_start']);\n                        $w_end=strtotime($addition_def[$field_id]['range_end']);\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    \n                    if ($w==\"\"){\n                        $w_chk=false;\n                    }else{\n                        $w_year=date('Y', $w);\n                        $w_month=date('m', $w);\n                        $w_day=date('d', $w);\n                        $w_chk=checkdate($w_month, $w_day, $w_year);\n                    }\n                    if ($w_chk==false) {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_date'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_date=date(\"Y-m-d\",$w);\n                        if ($addition_def[$field_id]['type']==3){\n                            $w_time=\"\";\n                        }else{\n                            $w_time=date(\"H:i\",$w).\"::00\";\n                        }\n                        $fldary[$field_id]=COM_convertDate2Timestamp($w_date,$w_time);\n                    }\n                }\n            }\n            //\u6642\u523b\n            if ($addition_def[$field_id]['type']==26){\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime(\"1970-1-1 \".$value);\n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_start'].\":00\");\n                        $w_end=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_end'].\":00\");\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    if ($w==\"\") {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_time'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_time=date(\"H:i\",$w).\"::00\";\n                        $fldary[$field_id]=COM_convertDate2Timestamp(\"1970-1-1\",$w_time);\n                    }\n                }\n            }\n            //\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n            if ($addition_def[$field_id]['type']==5){\n                if ($value ===\"\"){\n                }else{\n                    if (COM_isEmail ($value)==false) {\n                        $rt.=$addition_def[$field_id]['name'].$LANG04[18];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //url\n            if ($addition_def[$field_id]['type']==6){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (preg_match('/^(https?|ftp)(:\\/\\/[-_.!~*\\'()a-zA-Z0-9;\\/?:\\@&=+\\$,%#]+)$/', $value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_url'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //numeric\n            if ($addition_def[$field_id]['type']==15 OR $addition_def[$field_id]['type']==21){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (is_numeric($value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_numeric'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n           //text field\n            if (($addition_def[$field_id]['type']==0)\n                    OR ($addition_def[$field_id]['type']==1)\n                    OR ($addition_def[$field_id]['type']==10) ){\n                if ($value ===\"\"){\n                }else{\n                    if  ($addition_def[$field_id]['textcheck']==11){ //'\u534a\u89d2\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text1'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==12){//\u534a\u89d2\u82f1\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[a-zA-Z0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text2'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==13){//\u6a19\u6e96ID\u306e\u7bc4\u56f2\u5185';\n                        $value=rtrim(ltrim($value));\n                        $newvalue=COM_sanitizeID($value);\n                        if  ($value<>$newvalue){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text3'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                        $fldary[$field_id]=$value;\n                    }else if ($addition_def[$field_id]['textcheck']==14){//\u534a\u89d2\u82f1\u6570\u5b57\u8a18\u53f7\u306e\u307f';\n                        if  (!preg_match(\"/^[!-~]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text4'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                }\n            }\n            \n            \n            //textarea\n            if ($addition_def[$field_id]['type']==1 \n                    OR $addition_def[$field_id]['type']==10\n                    OR $addition_def[$field_id]['type']==20\n                    ){\n                if ($value ===\"\"){\n                }else{\n                    if (mb_strlen($value, 'UTF-8')>$addition_def[$field_id]['maxlength']) {\n                        $rt.=$addition_def[$field_id]['name']\n                            .$addition_def[$field_id]['maxlength']\n                            .\": \".$lang_box_admin['err_maxlength'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                 $file_path=$box_conf['file_path'];\n                 if  ( $box_conf['file_subdir']==1){\n                    $file_path.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $file_path )){\n                    $rt.=$file_path.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $filename=$_FILES['afield_fnm']['name'][$field_id];\n                        $filetmpname=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $filesize=$_FILES['afield_fnm']['size'][$field_id];\n                        $filetype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($filetmpname<>\"\"){\n\t\t\t\t\t\t\t$err=\"\";\n                            if ($box_conf['file_size']<>\"\" AND $filesize>$box_conf['file_size']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $err=1;\n                            }\n\t\t\t\t\t\t\tif (count($box_conf['file_type'])>0){\n                                if  (in_array($filetype,$box_conf['file_type'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$filetype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $err=1;\n                                }\n                            }\n                            //\u30c1\u30a7\u30c3\u30afOK\n                            if  ($err===\"\"){\n                                $fldary[$field_id]=$filename;\n                            }\n                        }\n                    }else{\n                        \n                    }\n                 }\n            }\n\n            //range check \u7bc4\u56f2\u30c1\u30a7\u30c3\u30af\n            if  ($addition_def[$field_id]['range_start']==\"\" AND $addition_def[$field_id]['range_end']==\"\" ){\n            }else{\n                if (($addition_def[$field_id]['type']==0)\n                     OR ($addition_def[$field_id]['type']==1)\n                     OR ($addition_def[$field_id]['type']==15) \n                     OR ($addition_def[$field_id]['type']==21) ){\n                    if  ($value <$addition_def[$field_id]['range_start'] \n                        OR $value >$addition_def[$field_id]['range_end']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                .\"(\".$addition_def[$field_id]['range_start'] \n                                .\"-\".$addition_def[$field_id]['range_end'].\")\";\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n                \n            }\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_uploadaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                        }\n\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];//@@@@@@@!!!!\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                            //$fldary_fnm[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\t\t\t\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                        }\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);//\u62e1\u5f35\u5b50\u3092\u5c0f\u6587\u5b57\u306b\u3059\u308b\n                        if  ( $box_conf['file_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\n\t\t}\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_uploadaddtiondatas_cpy(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload  for copy\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                //$filename=$fldary[$field_id];\n                //$filename_old=$fldary_old[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                \n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['imgfile_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $cpyfrom =$imgfld_thmb.$thumbname;\n                            $thumbname=DATABOX_getthumbname($newfilename);\n                            $cpyto =$imgfld_thmb.$thumbname;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                        }\n                    }\n                }\n\t\t\t}\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                $imgname_old=$a[1];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['file_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname_old;\n                        }\n                    }\n                }\n            }\n\n        }\n    }\n\n    return $rt;\n\n}\n\n//update\nfunction DATABOX_uploadaddtiondatas_xml(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n)\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            if ($fldary[$field_id]<>\"\"){\n                \n                //\u56f3 \u5916\u8a18\u61b6\n                if ($addition_def[$field_id]['type']==12){//\u56f3\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    //\n                    if  ($box_conf['imgfile_subdir']==1){\n                        $imgname=$addition_def[$field_id]['templatesetvar'].\"/\";\n                    }\n                    $imgname.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".jpg\";\n                    $imgsrc=$fldary[$field_id];\n                    if (DATABOX_uploadImageFile_xml($imgname,$imgsrc,$imgfld)){\n                        $fldary[$field_id]=$imgname;\n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                        if($box_conf['imgfile_thumb_ok']===\"1\" && function_exists('ImageCreate')) {\n                            $srcfile=$imgfld.$imgname;\n                            $rt=DATABOX_createthumb(\n                                $imgname\n                                ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                ,$imgfld_thmb,$imgfld);\n                        }\n                    }else{\n                        $fldary[$field_id]=\"\";\n                    }\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_deleteaddtionfiles(\n    $fldary\n    ,$addition_def\n    ,$pi_name\n){\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\n//\nfunction DATABOX_deleteaddtionfiles_def(\n    $field_id\n    ,$pi_name\n){\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n    \n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    //\n    $sql=\"SELECT value  \";\n    $sql.=\" FROM\";\n    $sql.=\" {$table_addition} \";\n    $sql.=\" where\";\n    $sql.=\" field_id=\".$field_id;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $filename = COM_stripslashes($A['value']);\n        if ($filename<>\"\"){\n            $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n            $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n            $rt=DATABOX_deleteFile($imgfld.$filename);\n            $thumbname=DATABOX_getthumbname($filename);\n            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_deleteaddtionfiles_all(\n    $fld\n    ,$pi_name\n){\n    \n    \n    \n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if( is_dir( $fld)){\n        $fd = opendir( $fld );\n        while(( $file = @readdir( $fd )) == TRUE )    {\n            if( !is_dir( $fd1 . $file)\n                    && $dir <> '.'\n                    && $dir <> '..'\n                    && $dir <> 'CVS'\n                    && substr( $dir, 0 , 1 ) <> '.' ) {\n                clearstatcache();\n                $rt=DATABOX_deleteFile($fld.$file);\n            }\n        }\n    }\n\n    return $rt;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeuploadfile delete\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($filename)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filename:\u30d5\u30a9\u30eb\u30c0/\u30d5\u30a1\u30a4\u30eb\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\nfunction DATABOX_deleteFile (\n    $filename\n)\n{\n    $rt=false;\n    if (file_exists ($filename)) {\n        if (!@unlink ($filename)) {\n            COM_errorLog (\"Unable to remove file $filename\");\n        }else{\n            $rt=true;\n            COM_errorLog (\"remove file $filename\");\n        }        \n    }else{\n            COM_errorLog (\"Unable to remove file $filename not exist\");\n    }\n    return $rt;\n}\n\nfunction DATABOX_uploadImageFile (\n     $imgname\n    ,$imgfile\n    ,$imgsize\n    ,$imgtype\n    ,$imgfld\n    ,$newfilename\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  upload Image File\n// | \u66f8\u5f0f DATABOX_uploadImageFile($imgname,$imgfile,$imgsize, $imgtype,$imgfld)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    $FilePermissions = (int) 0755;\n\n    if (is_uploaded_file ($imgfile)) {\n        //$newfile=$imgfld.$imgname;\n        $newfile=$imgfld.$newfilename;\n        if(!file_exists($newfile)) {\n            $returnMove = move_uploaded_file($imgfile, $newfile); \n            if (!$returnMove) {\n                $logmsg=\"DataBox File upload error: \".$tmp.\" to \".$name;\n                COM_errorLOG($logmsg);\n                return false;\n             } else {\n                $chown =@chmod ($newfile,$FilePermissions);\n                $logmsg=\"DataBox File upload sucsess: \".$imgname;\n                COM_errorLOG($logmsg);\n                return true;\n             }\n         }else{\n            COM_errorLOG(\"DataBox upload error: Temporary file does not exist: '\".$tmp .\"'\");\n            return false;\n         }\n    }\n}\n//\nfunction DATABOX_uploadImageFile_xml (\n    $imgname\n    ,$imgsrc\n    ,$imgfld\n)\n{\n    $FilePermissions = (int) 0755;\n\n    $newfile=$imgfld.$imgname;\n    //\n    $fp = fopen($newfile, \"w\");\n    $imgsrc=base64_decode($imgsrc);\n    fputs($fp, $imgsrc);\n    fclose($fp);\n    \n    if(!file_exists($newfile)) {\n        $logmsg=\"DataBox ImageFile upload error: \".$tmp.\" to \".$name;\n        COM_errorLOG($logmsg);\n        return false;\n    } else {\n        $chown =@chmod ($newfile,$FilePermissions);\n        $logmsg=\"DataBox ImageFile upload sucsess: \".$imgname;\n        COM_errorLOG($logmsg);\n        return true;\n    }\n}\n\nfunction DATABOX_createthumb(\n    $filename\n    , $W\n    , $H\n    , $W2\n    , $H2\n    , $imgfld_thmb\n    , $imgfld\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd uploadfile \u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_createthumb($srcfile,$W,$H,$W2,$H2, $thumb_dir,$tmp_dir)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $srcfile=$imgfld.$filename;\n    // \u753b\u50cf\u306e\u5e45\u3068\u9ad8\u3055\u3068\u30bf\u30a4\u30d7\u3092\u53d6\u5f97\n    $imagesize = GetImageSize($srcfile);\n    $srcfile_w=$imagesize['0'];\n    $srcfile_h=$imagesize['1'];\n    $srcfile_type=$imagesize['2'];\n    //\u5bfe\u8c61\u30bf\u30a4\u30d7\u306e\u78ba\u8a8d\n    switch ($srcfile_type) {\n        case 1 : //gif\n             return false;\n             break;\n        case 2 : //jpg\n             $srcimage = @ImageCreateFromJPEG($srcfile);\n             break;\n        case 3 : //png\n             $srcimage = @ImageCreateFromPNG($srcfile);\n             break;\n    }\n    if (!$srcimage) {\n        return false;\n    }\n    \n    $logmsg=\"size=(w)\".$srcfile_w.\" > \".$w.\" (h)\".$srcfile_h.\" > \".$h;\n    COM_errorLog ($logmsg);\n\n    //\u5bfe\u8c61\u30b5\u30a4\u30ba\u306e\u78ba\u8a8d\n    if ($srcfile_w > $w || $srcfile_h > $h) {\n    }else{\n        return false;\n    }\n        \n    // \u30ea\u30b5\u30a4\u30ba\n    if ($srcfile_w > $W || $srcfile_h > $H) {\n        $key_w = $W / $srcfile_w;\n        $key_h = $H / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n    } else {\n        $out_w = $srcfile_w;\n        $out_h = $srcfile_h;\n    }\n\n    // \u51fa\u529b\u753b\u50cf\uff08\u30b5\u30e0\u30cd\u30a4\u30eb\uff09\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    $outimage = ImageCreateTrueColor($out_w, $out_h);\n    $resize = ImageCopyResampled(\n            $outimage, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n    // \u30b5\u30e0\u30cd\u30a4\u30eb\u753b\u50cf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u51fa\u529b\u3001\u4fdd\u5b58\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $thum_filename = DATABOX_getthumbname($filename);\n       $filename = substr($filename, 0, strrpos($filename,\".\"));\n    touch($imgfld_thmb.$thum_filename);\n    ImageJPEG($outimage, $imgfld_thmb.$thum_filename);\n        \n    // \u51fa\u529b\u753b\u50cf\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    // \u30ea\u30f3\u30af\u5148\u306e\u30b5\u30a4\u30ba\u304c\u8a2d\u5b9a\u5024\u3088\u308a\u5927\u304d\u3044\u6642\u30ea\u30f3\u30af\u5148\u3082\u7e2e\u5c0f\u3059\u308b<-----\n    if ($srcfile_w > $W2 || $srcfile_h > $H2) {\n        $rt = rename($imgfld.$filename.\".jpg\",$imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"rename err!\";\n        }\n\n        $key_w = $W2 / $srcfile_w;\n        $key_h = $H2 / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n        $outimage2 = ImageCreateTrueColor($out_w, $out_h);\n        $resize = ImageCopyResampled(\n            $outimage2, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n        touch($imgfld.$filename.\".jpg\");\n        ImageJPEG($outimage2, $imgfld.$filename.\".jpg\"); \n\n        ImageDestroy($outimage2);\n        $rt=unlink($imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"delete err!\";\n        }\n\n   }\n    \n    // \u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u7834\u68c4\n    ImageDestroy($srcimage);\n    ImageDestroy($outimage);\n\n    return $thum_filename;\n\n}\n//\nfunction DATABOX_getthumbname(\n    $filename\n)\n{\n    $rt=\"\";\n    if ($filename<>\"\"){\n        $filename = substr($filename, 0, strrpos($filename,\".\"));\n        $rt = $filename . \"-small.jpg\";\n    }\n    return $rt;\n}\n//==============================================================================\n\nfunction DATABOX_getradiolist(\n    $ary\n    ,$fld\n    ,$selected = 0\n    ,$br=\"\"\n    ,$disabled=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e9\u30b8\u30f2\u30dc\u30bf\u30f3\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getradiolist\n// |                ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\u5024\u914d\u5217\n// | \u5f15\u6570 $fld:field name\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $br:blank 0 \u6539\u884c\u3057\u306a\u3044 1\u301c9 \u6307\u5b9a\u6570\u6bce\u306b\u6539\u884c\n// | \u5f15\u6570 $disabled:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30e9\u30b8\u30f2\u30dc\u30bf\u30f3                                                   |\n// +---------------------------------------------------------------------------+\n//update 20130704\n{\n    \n    $retval = '';\n    if  ($br===\"\" ) {\n        $br=0;\n    }\n    $cnt=0;\n    foreach( $ary as $id => $value ){\n\n        //echo \"ary\".$i.\"=\".$ary[$i].\"<br>\";\n        $retval .= \"<input type='radio' NAME='$fld' $disabled VALUE='$id'\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( $id == $selected ){\n                $retval .= \" CHECKED=CHECKED \";\n            }\n        }\n        $retval .= \">$ary[$id]&nbsp\";\n        \n        if   ($br<>0){\n            $cnt++;\n            if  ($cnt==$br){\n                $retval .=\"<br\".XHTML.\">\";\n                $cnt=0;\n            }\n        }\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_getoptionlistary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    if  ($type==14 OR $type==18){\n        //$selectedary=array[];\n        $selectedary=explode(\":\",$selected);\n    }\n    if  ($size==\"\" OR $size==0){\n        $size=1;\n    }\n    $retval = '';\n\n    $retval .= \"<select \";\n    if ($type==14 OR $type==18){\n        $retval .= ' name=\"'.$fld.'[]\" ';\n        $retval .= ' multiple=\"multiple\" ';\n        $retval .= ' size=\"'.$size.'\"';\n    }else{\n        $retval .= ' name=\"'.$fld.'\"';\n    }\n    $retval .= $disabled.\">\".LB;\n    \n\tif  ($type==7 ){\n\t\tif  ($ary[0]==\"\"){\n        }else{\n            $retval .= \"<option value=''>{$lang_box['selectit']}</option>\".LB;\n        }\n\t}\n    \n    foreach($ary as $k => $v) {\n        $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n\t\t//echo \"k=\".$k.\"sa=\".$selectedary.\"s=\".$selected.\"<br>\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if  ($type==14 OR $type==18){\n                if( in_array($k,$selectedary) ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t    }else{\n                if( $k == $selected ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t\t}\n\t\t}\n\t\t$retval .= \">\";\n\n        $retval .= $v;\n        $retval .= \"</option>\".LB;\n\n    }\n\n    $retval .= '</select>';\n    \n    return $retval;\n}\n\n\n\nfunction DATABOX_getoptionlist(\n    $kind\n    ,$selected = 0\n    ,$relno=0\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$selectit=true\n    ,$selectlist=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getoptionlist($kind)\n// |      DATABOX_getoptionlist(\"fieldset\",$fieldset_id,0,$pi_name,\"\",0 );\n// |      DATABOX_getoptionlist(\"group\",$categorygroup_id,0,$pi_name,\"\",0 );\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:\u9805\u76ee\u7a2e\u985e\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $relno\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled\n// | \u5f15\u6570 $selectit\n// | \u5f15\u6570 $selectlist\u3000\u65e2\u5b9a\u30ea\u30b9\u30c8\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n//update 20101122,20110613,20120525,20140724\n{\nglobal $_CONF;\nglobal $_TABLES;\nglobal $LANG_configselects;\n    \n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n    \n    \n    $retval = '';\n\n    $retval .= \"<select name='$fname' $disabled>\".LB;\n    if ($selectit===\"all\"){\n        $retval .= \"<option value=\\\"all\\\">{$lang_box['selectall']}</option>\".LB;\n    }elseif ($selectit){\n        $retval .= \"<option value=0>{$lang_box['selectit']}</option>\".LB;\n    }\n    \n    \n    if ($kind==\"layout\"){\n        $retval .= \"<option value=0>{$lang_box['byconfig']}</option>\".LB;\n        $ary=$LANG_configselects[strtolower($pi_name)][22];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$v.\"\\\"\";\n            if( $v == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $k;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else if ($kind==\"language_id\"){\n        $retval .= \"<option value=0> </option>\".LB;\n        $ary=$_CONF['languages'];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n            if( $k == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $v;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else{\n        if ($kind==\"group\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_group'];\n            $fields= 'group_id,name,orderno';\n        }else if ($kind==\"parent\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_category'];\n            $fields= 'category_id,name,orderno';\n        }else if ($kind==\"fieldset\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n            $fields= 'fieldset_id,name,fieldset_id';\n        }else if ($kind==\"selectlist\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT kind,kind,kind';\n        }else if ($kind==\"selectlist_mst\"){\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$selectlist}'\";\n            if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }else if ($kind==\"fieldgroupno\"){\n            $where=\"kind='fieldgroup'\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT no,value,no';\n        }else if ($kind==\"csvsel\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_csv_sel'];\n            $fields= 'csv_sel_id,name,csv_sel_id*-1';\n        }else{\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$kind}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }\n        $retval .= COM_optionList (\n            $table\n            , $fields\n            , $selected,2,$where);\n    }\n    \n    \n    $retval .= '</select>';\n\n    if ($disabled===\"disabled\"){\n        $retval .= \"  <input type='hidden' name='{$fname}' value='{$selected}'>\";\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_dltbldt(\n    $filenm\n    ,$fld\n    ,$tbl\n    ,$where=\"\"\n    ,$order=\"\"\n    ,$pi_name=\"\"\n    ,$addition=false\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30fc\u30d6\u30eb\u306e\u30c7\u30fc\u30bf\u3092CSV\u5f62\u5f0f\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\n// | \u66f8\u5f0f DATABOX_dltbldt($filenm,$fld,$tbl,$where,$order,$type,$pi_name,false);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filenm :\n// | \u5f15\u6570 $fld :\n// | \u5f15\u6570 $tbl :\n// | \u5f15\u6570 $where :\n// | \u5f15\u6570 $order :\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $addition:false=\u8ffd\u52a0\u9805\u76ee\u306a\u3057\u3001 true=\u8ffd\u52a0\u9805\u76ee\u3042\u308a\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//20100910\n//@@@@@ \u8ffd\u52a0\u4e88\u5b9a\u3000\u30ab\u30c6\u30b4\u30ea\u3082\n{\n    global $_CONF;\n\n    $dm=\",\";//\u533a\u5207\u308a\u6587\u5b57\n    $ec=\"`\";//\u30d5\u30a3\u30fc\u30eb\u30c9\u56f2\u307f\u6587\u5b57\n\n    if ($addition){\n        $addition_def=DATABOX_getadditiondef($pi_name);\n    }\n\n    $retval=\"\";\n\n    //file output open\n    $curdatetime = date(\"Y_m_d_H_i_s\");\n    //$outfile = tempnam($_CONF['path_data'] .\"tmp\", $filenm);\n    $outfile = $_CONF['path_data'] . $filenm.\"_\".$curdatetime;\n    $file = @fopen( $outfile, 'w' );\n    if ( $file === false ) {\n        $retval .= \"ERR! \".$outfile .\" is not writable!<br \".XHTML.\">\" . LB;\n        return $retval;\n    }\n\n    //-----\n    $sql = \"SELECT DISTINCT \";\n    foreach($fld as $k => $v) {\n        $sql .=$k.\",\";\n    }\n    $sql=rtrim($sql,\",\");\n    $sql.= \" FROM \".$tbl;\n    if (!empty($where)) {\n        $sql.=\" WHERE \".$where;\n    }\n    if (!empty($order)) {\n        $sql.=\" ORDER BY \".$order;\n    }\n    //-----\n    $result = DB_query ($sql);\n    //-----1\u884c\u76ee\u30d8\u30c3\u30c0\n    $w='';\n    foreach($fld as $k => $v) {\n        $w .=$ec.$k.$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$s[$k1]['templatesetvar'].$ec.$dm;\n            }\n        }\n    }\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n\n    //-----2\u884c\u76ee\u30d8\u30c3\u30c0\n    $w=\"\";\n    foreach($fld as $k => $v) {\n        $w .=$ec.$v['name'].$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$addition_def[$k1]['name'].$ec.$dm;\n            }\n        }\n    }\n\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n    //-----3\u884c\u76ee\u4ee5\u964d\n    while( $A = DB_fetchArray( $result ) )    {\n\n        $w=\"\";\n        foreach($fld as $k => $v) {\n            $w .=$ec.$A[$k].$ec.$dm;\n        }\n//\n        if ($addition){\n            $wkary=DATABOX_getaddtionfields($A[\"id\"],$addition_def,$pi_name);\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                //echo \"k1=\".$k1.\"<br \".XHTML.\">\";\n\n\n                if (isset($wkary[$k1])) {\n                //echo \"wkary=\".$wkary[$k1].\"<br>\";\n                    $w .=$ec.$wkary[$k1].$ec.$dm;\n                }else{\n                //echo \"DD<br>\";\n                    $w .=$ec.$ec.$dm;\n                }\n            }\n        }\n        $w=rtrim($w,$dm);\n\n        $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n        fputs( $file, $w.LB);\n\n    }\n    fclose($file);\n    \n    $filename=basename($outfile).\".csv\";\n    $dir=dirname($outfile);\n\n    header (\"Content-Disposition: attachment; filename=$filename\");\n    header (\"Content-type: application/x-csv\");\n    readfile ($outfile);\n    flush();\n    \n    $rt=unlink($outfile);\n    \n    return \"\";\n}\n\nfunction DATABOX_getfeaturedimage(\n    $id\n    ,$pi_name\n    ,$mode=\"imgsrc\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  featuredimage\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_getfeaturedimage($id,$pi_name)\n// | typw14(\u5916\u753b\u50cf)\u8868\u793a\u3059\u308b\u5148\u982d\uff08\u9806\u756a\u304c\u82e5\u3044\uff09\u8ffd\u52a0\u9805\u76ee\u3092featuredimage\u3068\u3057\u3066\u53d6\u5f97\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:featuredimage\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $tbl1=$_TABLES[strtoupper($pi_name).'_addition'];\n    $tbl2=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $rt=\"\";\n\n    $sql = \"SELECT t1.value\";\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl1} AS t1\";\n    $sql .= \"  ,{$tbl2} AS t2\";\n    $sql .= \"  WHERE t1.id=\".$id;\n    $sql .= \"  AND t1.field_id =t2.field_id\";\n    $sql .= \"  AND t2.type=12\";\n    $sql .= \"  AND allow_display=0\";\n    $sql .= \"  ORDER BY orderno\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n        $value=$A['value'];\n        if  ($value<>\"\"){\n            $url=$_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n            $url.= $value ;\n            if  ($mode==\"imgsrc\"){\n                $rt='<img src=\"'.$url.'\" />';\n            }else{\n                $rt=$url;\n            }\n        }\n    }\n\n    return $rt;\n}\n\nfunction DATABOX_getheadercode(\n    $kind\n    ,$template\n    ,$pi_name\n    ,$id\n    ,$title\n    ,$meta_description\n    ,$meta_keywords\n    ,$description\n    ,$additionfields=\"\"\n    ,$addition_def=\"\"\n    ,$chk_user=\"\"\n    ,$fieldset_id=\"\"\n    ,$fieldset_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd HEADERCODE \u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_getheadercode(\"data\",$template,$pi_name,$A['id'],$A['title']\n// |         ,$A['meta_description'],$A['meta_keyword'],$A['description']);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570  $kind        \"data\",\"category\"\n// | \u5f15\u6570  $template\n// | \u5f15\u6570  $pi_name\n// | \u5f15\u6570  $id\n// | \u5f15\u6570  $title\n// | \u5f15\u6570  $meta_description\n// | \u5f15\u6570  $meta_keywords\n// | \u5f15\u6570  $description\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:HEADERCODE\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n    global $_IMAGE_TYPE;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $retval=\"\";\n    \n    $currenturl= COM_getCurrentURL();\n    $site_logo= $_CONF['layout_url'] . '/images/logo.' . $_IMAGE_TYPE ;\n\n    $og_type=\"article\";\n    $og_title=$title;\n    \n    if ($box_conf['meta_tags'] > 0) {\n         $retval .= COM_createMetaTags($meta_description, $meta_keywords);\n    }\n\n    if ($_CONF['meta_tags']==0 OR $meta_description==\"\") {\n        $og_description = $description;\n    }else{\n        $og_description = $meta_description;\n    }\n    $og_description= COM_getTextContent(PLG_replaceTags($og_description));\n        \n    \n    if ($kind===\"data\"){\n        $og_image =DATABOX_getfeaturedimage($id,$pi_name,\"url\");\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }else{\n        $og_image =$box_conf[\"default_img_url\"];\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }\n    \n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath($kind,$template,$pi_name);\n    if (file_exists ($tmplfld.\"/headercode.thtml\")) {\n        $tpl = new Template($tmplfld);\n        $tpl->set_file (array (\n            'tpl' => 'headercode.thtml',\n            ));\n    \n        $tpl->set_var('xhtml', XHTML);\n        $tpl->set_var('site_url', $_CONF['site_url']);\n        $tpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n        $tpl->set_var('layout_url', $_CONF['layout_url']);\n        \n        $tpl->set_var ('currenturl', $currenturl);\n        \n        $tpl->set_var ('site_name', $_CONF['site_name']);\n        $tpl->set_var ('site_mail', $_CONF['site_mail']);\n        \n        $tpl->set_var ('og_title', $og_title);\n        $tpl->set_var ('og_image', $og_image);\n        $tpl->set_var ('og_description', $og_description);\n        $tpl->set_var ('og_type', $og_type);\n        $tpl->set_var ('fieldset_name', $fieldset_name);\n        \n        //facebook\n        $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n        $tpl->set_var ('facebook_consumer_key', $facebook_consumer_key);\n        \n        if ($kind===\"data\"){\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$tpl,$chk_user,$pi_name,$fieldset_id);\n        }\n    \n        $tpl->parse ('output', 'tpl');\n        $retval .= $tpl->finish ($tpl->get_var ('output'));\n    }\n    return $retval;\n}\n\nfunction DATABOX_getfields(\n    $pi_name\n    , $fieldset_id\n)\n{\n    global $_TABLES;\n    \n    if ($fieldset_id==0){\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    }\n    $fields = array();\n\n    // Get a list of additionfields in the selected field\n    $sql  = \"SELECT DISTINCT field_id \";\n    $sql  .= \" FROM {$table}\";\n    \n    if ($fieldset_id<>0){\n        $sql  .= \" WHERE  \";\n        $sql  .= \" fieldset_id = $fieldset_id\";\n    }\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    \n    if ($num<>0){\n        while ($A = DB_fetchArray($result)) {\n            $fields[] = $A['field_id'];\n        }\n    }\n    \n    return $fields;\n}\n\n\nfunction DATABOX_getAry(\n    $kind\n    ,$relno=0\n    ,$selectlist\n    ,$pi_name=\"\"\n)\n{\n    global $_TABLES;\n\n//    if ($kind==\"selectlist_mst\"){\n        $table=$_TABLES[strtoupper($pi_name).'_mst'];\n        $where=\" WHERE kind='{$selectlist}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n        $fields= 'no,value';\n        $order=\" ORDER BY orderno\"; \n//    }\n\n    $ary=array();\n    $sql = \"SELECT \";\n    $sql .= $fields ;\n    $sql .= \" FROM \" ;\n    $sql .= $table ;\n    $sql .= $where ;\n    $sql .= $order ;\n\n    $result = DB_query($sql);\n    $nrows = DB_numRows($result);\n    for( $i=0; $i < $nrows; $i++) {\n         $A = DB_fetchArray($result, true);\n         $ary[$A[0]] = $A[1];\n    }\n    return $ary;\n}\n\nfunction DATABOX_categorycount(\n    $pi_name\n    ,$categorygroup_id \n    ,$categorygroup_code \n    ,$permission=\"\"\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_categorycount()\n// | \u66f8\u5f0f  databox_categorycount(1)\n// | \u66f8\u5f0f  databox_count(\"\",\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $group_id:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// | \u5f15\u6570 $group_code:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\n// | \u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id \u3082\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\u3082\u6307\u5b9a\u306a\u3044\u5834\u5408\u306f\n// | \u89aa\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u306a\u3057\u306e\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\n// | \uff08\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u3042\u308b\u30c7\u30fc\u30bf\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u306a\u3044\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\u306f\u542b\u307f\u307e\u305b\u3093\uff09\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    //-----\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n    $tbl1=$_TABLES[strtoupper($pi_name).'_category'] ;\n    $tbl4=$_TABLES[strtoupper($pi_name).'_def_group'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_base'] ;\n    if ($categorygroup_id ==\"\" AND $categorygroup_code==\"\") {\n        $categorygroup_id=0;\n    }else{\n        if  ($categorygroup_id==\"\"){\n            $categorygroup_id=DATABOX_codetoid(    $categorygroup_code,strtoupper($pi_name).'_def_group',\"group_id\");\n            if  ($categorygroup_id==0){\n                return 0;\n            }\n        }\n    }\n    \n\n    //-----\n    $sql = \"SELECT \".LB;\n    $sql .= \" t1.category_id\".LB;\n    //$sql .= \" ,Count(t1.id) AS count\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.id = t2.id \".LB;\n    $sql .= \" AND t1.category_id = t3.category_id \".LB;\n    $sql .= \" AND t3.categorygroup_id = \".$categorygroup_id.LB;\n    $sql .= \" AND t3.categorygroup_id = t4.group_id \".LB;\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND',0,2,\"t2\").LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    \n    $sql .= \" GROUP BY \".LB;\n    $sql .= \" t1.category_id\".LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_Confirmation(\n    $pi_name\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u78ba\u8a8d\u753b\u9762\n// | \u66f8\u5f0f Con_firmation(\"databox\")\n//   fnc_Confirmation proversion\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $mode:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $LANG_ADMIN;\n\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $tmpl = new Template ($_CONF['path'] . \"plugins/\".THIS_PLUGIN.\"/templates/admin/\");\n    $tmpl->set_file(array('confirm' => 'confirmation.thtml'));\n\n\n    $tmpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n    $tmpl->set_var('gltoken_name', CSRF_TOKEN);\n    $tmpl->set_var('gltoken', SEC_createToken());\n    $tmpl->set_var ( 'xhtml', XHTML );\n\n    //\n    $actionname=$lang_box_admin[$mode];\n    $actionprg=\"{$_CONF['site_admin_url']}/plugins/\".THIS_SCRIPT.\"?mode={$mode}exec\";\n\n    $tmpl->set_var('actionname', $actionname);\n    $tmpl->set_var('actionprg', $actionprg);\n    \n    $tmpl->set_var('help', $lang_box_admin[$mode.'msg']);\n    $btn_value=$LANG_ADMIN['submit'];\n    $confirm_value=$lang_box_admin['confirm'];\n    $btn2=\"\";\n    $btn3=\"\";\n    if ($mode===\"datadelete\"){\n        $tmpl->set_var('lang_checklist', $lang_box_admin['fieldset'].\":\");\n        $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name);\n        $tmpl->set_var('checklist', $checklist);\n        $btn_value=$lang_box_admin['delete1'];\n        $confirm_value=$lang_box_admin['delete1'].\" \".$lang_box_admin['confirm'];\n        $confirm_value2=$lang_box_admin['delete2'].\" \".$lang_box_admin['confirm'];\n        $confirm_value3=$lang_box_admin['delete3'].\" \".$lang_box_admin['confirm'];\n        $btn2=\"<input type='submit' name='action' value='{$lang_box_admin['delete2']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value2}');\\\"\".xhtml.\">\".LB;\n        $btn3=\"<input type='submit' name='action' value='{$lang_box_admin['delete3']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value3}');\\\"\".xhtml.\">\".LB;\n    }\n\n    // SAVE\u3001CANCEL \u30dc\u30bf\u30f3\n    $tmpl->set_var('lang_confirm', $confirm_value);\n    $tmpl->set_var('lang_submit', $btn_value);\n    $tmpl->set_var('btn2', $btn2);\n    $tmpl->set_var('btn3', $btn3);\n    $tmpl->set_var('lang_cancel', $LANG_ADMIN['cancel']);\n    $tmpl->set_var('mode', $mode.\"exec\");\n\n    $tmpl->parse ('output', 'confirm');\n    $comfirm = $tmpl->finish ($tmpl->get_var ('output'));\n\n    $retval = $comfirm;\n\n\n    return $retval;\n}\n\n//==============================================================================\n//lib_datetimeedit.php \u2192\nfunction DATABOX_datetimeedit(\n    $datetime_value\n    ,$lang\n    ,$datetime_name=\"datetime\"\n    ,$mode=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    if ($datetime_value==\"\"){\n        $datetime_year = date('Y');\n        $datetime_month = date('m');\n        $datetime_day = date('d');\n        //\n        $datetime_hour = date ('H');\n        $datetime_minute = date ('i') ;\n    }else{\n        $datetime_year = date('Y', $datetime_value);\n        $datetime_month = date('m', $datetime_value);\n        $datetime_day = date('d', $datetime_value);\n        //\n        $datetime_hour = date ('H', $datetime_value);\n        $datetime_minute = date ('i', $datetime_value) ;\n    }\n    \n    $rt=\"\";\n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_year);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_month);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_day);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($mode===\"datetime\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_hour, 24);\n        }else{\n            $datetime_hour_wk=$datetime_hour;\n            if ($datetime_hour_wk >= 12) {\n                if ($datetime_hour_wk > 12) {\n                    $datetime_hour_wk = $datetime_hour_wk - 12;\n                }\n                $ampm = 'pm';\n            } else {\n                $ampm = 'am';\n            }\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $ampm);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_hour_wk);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_minute);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_datetimeedit_R(\n    $datetime_ary\n    ,$lang\n    ,$datetime_name=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    \n    if  (!is_array($datetime_ary)){\n        return \"\";\n    }\n    \n    $rt=\"\";\n    \n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_ary['year']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_ary['month']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_ary['day']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($datetime_ary['hour']<>\"\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour'], 24);\n        }else{\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $datetime_ary['ampm']);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour']);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_ary['minute']);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n//==============================================================================\n//lib_outlog.php \u2192\n//log \u51fa\u529b\u30e2\u30fc\u30c9\u8a2d\u5b9a\u30000:\u4f5c\u6210\u3057\u306a\u3044,1:\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b 2:\u753b\u9762\u306b\u3082\u51fa\u529b\n//$logmode =2;\n//$logfile = $_CONF['path_log'] . \"profile_point.log\";\n\n//echo OutLog( \"----- photomailcheck.php start\",$logmode);\n\n\n// \u30ed\u30b0\u51fa\u529b\u51e6\u7406\nfunction DATABOX_OutLog( $logentry ,$logfile,$logmode=1)\n{\n    global $_CONF,$LANG01;\n\n    $retval = '';\n\n    if (!empty($logmode)) {\n        if( !empty( $logentry )) {\n            $logentry = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),\n                                     $logentry );\n\n            $timestamp = strftime( '%c' );\n\n            if (!file_exists($logfile)) {\n                echo $logfile .\"  doesn't exist. \";\n                exit();\n            }\n            if (!is_writable($logfile)) {\n                echo $logfile .\" cannot be written. \";\n                exit();\n            }\n\n            $file = fopen( $logfile, 'a' );\n\n            if( empty($file)) {\n                $retval .= $LANG01[33] . ' ' . $logfile . ' (' . $timestamp . ')<br/><br/>' . LB;\n            } else {\n                fputs( $file, \"$timestamp - $logentry\\n\" );\n            }\n\n            if ($logmode ==2){\n                $retval .=\"$timestamp - $logentry<br/>\" . LB;\n            }\n        }\n    }\n\n    return $retval;\n}\n//==============================================================================\n//lib_getfilelist.php \u2192\n// \u6307\u5b9a\u30d5\u30a9\u30eb\u30c0\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u89a7\u3092\u53d6\u5f97\nfunction DATABOX_getfilelist(\n    $fd\n    ,$exte =\"\"\n)\n{\n    $fary= array();\n    $dir=opendir($fd);\n    while(($ent = readdir()) !==FALSE){\n        if  ($exte==\"\") {\n           $fary[$i] = $ent;\n           $i++;\n        }else{\n            $w=explode('.',$ent);\n            if (strtolower($w[1])===$exte){\n               $fary[$i] = $ent;\n               $i++;\n            }\n        }\n    }\n    return $fary;\n\n}\nfunction DATABOX_getDateTimeFormat( $date,$format )\n{\n    if( empty( $date ))    {\n        $stamp = time();\n    } else if( is_numeric( $date )){\n        $stamp = $date;\n    }else{\n        $stamp = strtotime( $date );\n    }\n    $date = strftime( $format, $stamp );\n    return array( $date, $stamp );\n}\nfunction DATABOX_getTimeFormat( $value )\n{\n    $rt=\"\";\n    if  ($value==\"\"){\n        $rt=\"\";\n    }else{\n        if  ($_CONF['hour_mode']=='24'){\n            $rt=date('H:i', $value );\n        }else{\n            $rt=date('h:i', $value );\n            if  (date('H',$value)>=12){\n                $rt.=\" PM\";\n            }else{\n                $rt.=\" AM\";\n            }\n        }\n    }\n    return $rt;\n}\n\nfunction DATABOX_fieldvalue(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$option = \"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_fieldvalue($pi_name,$id,$code,$field_id,$field_code,$option)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $option:'','name','description','yes','value2','disp','no'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    global $_PLUGINS;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"\";\n    }\n    if (is_null($field_id)){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"\";\n        }\n    }\n          \n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.type \".LB;\n    $sql  .= \" ,m.name \".LB;\n    $sql  .= \" ,m.description \".LB;\n    $sql  .= \" ,m.selection \".LB;\n    $sql  .= \" ,m.selectlist \".LB;\n    $sql  .= \" ,m.dfid \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.allow_display = 0 \".LB;\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n        if  ($option==\"name\"){\n            $rt=$A['name'];\n        }else if ($option==\"description\"){\n            $rt=$A['description'];\n        }else if ($option==\"datatitle\"){\n            if (in_array('databox', $_PLUGINS)) {\n                $rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"title\",\"code='{$A['value']}'\"));\n            }\n        }else if ($option==\"datadescription\"){\n            if (in_array('databox', $_PLUGINS)) {\n\t\t\t\t$rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"description\",\"code='{$A['value']}'\"));\n            }\n        }else{\n            $selectionary=DATABOX_getselectionary($A['selection']);\n            $selectlist=$A['selectlist'];\n            $type=$A['type'];\n            $value=$A['value'];\n            $dfid= $A['dfid'];\n            $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n            if( empty( $format )) {\n                $format = $_CONF['date'];\n            }\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($value===\"\"){\n                    }else{\n                        list($readfile,$rt)=explode(\"|\",$value);\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($value===\"\"){\n                    }else{\n                        $rt=\"<img src=\\\"data:image/jpg;base64,\";\n                        $rt .=\"{$value}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    if  ($option==\"yes\"){\n                        if  ($value==1){\n                            $rt=1;\n                        }\n                    }else{\n                        $rt= $lang_noyes[$value];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $rt= $selectionary[$value];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $rt= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($value);\n                    $w=DATABOX_autolink($w);\n                    $rt= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$value,$pi_name);\n                    $rt= $mstitems['value'];\n                    if  ($option==\"value2\"){\n                        $rt= $mstitems['value2'];\n                    }else if  ($option==\"disp\"){\n                        $rt= $mstitems['disp'];\n                    }else if  ($option==\"no\"){\n                        $rt= $mstitems['no'];\n                    }else{\n                        $rt= $mstitems['value'];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    $wk_no=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                        $wk_no.=$mstitems['no'].$separater;\n                    }\n                    if  ($option==\"value2\"){\n                        $rt= rtrim($wk_value2,$separater);\n                    }else if  ($option==\"disp\"){\n                        $rt= rtrim($wk_disp,$separater);\n                    }else if  ($option==\"no\"){\n                        $rt= rtrim($wk_no,$separater);\n                    }else{\n                        $rt= rtrim($wk,$separater);\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($value<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($value,$format);\n                        $rt= $w[0];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\n                    if  ($value<>\"\"){\n                        $rt=strftime( $_CONF['shortdate'], $value );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $rt= number_format( (float)$value, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $rt= $value;\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_fieldownload(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30a1\u30a4\u30eb\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9 \n// | \u66f8\u5f0f DATABOX_fieldownload($pi_name,$id,$code,$field_id,$field_code)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $mode \u30ca\u30b7\u3001display\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n     \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)  OR $id===\"\"){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"download argument error id\";\n    }\n    if (is_null($field_id) OR $field_id===\"\"){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"download Argument error field_id\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"download drgument error id field_id\";\n        }\n\t}\n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.allow_display \".LB;\n    $sql  .= \" ,d.group_id \".LB;\n    $sql  .= \" ,d.owner_id \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    $sql  .= \" , {$table_base} AS d\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.type = 13 \".LB;\n    $sql  .= \" AND d.id = {$id} \".LB;\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND d.draft_flag=0\".LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\";\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n\t$result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"Target file is not found\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\t\t$value=$A['value'];\n        $group_id = $A['group_id'];\n\t\t$owner_id = $A['owner_id'];\n\t\t$allow_display= $A['allow_display'];\n        $chk_user=DATABOX_chkuser($group_id,$owner_id,$pi_name.\".admin\");\n\t\tif  ($value<>\"\"){\n\t\t\t\n            $chk=false;\n            //\u8868\u793a\u3059\u308b\n            if  ($allow_display==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($allow_display==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($allow_display==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n            //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n\t\t\tif ($chk) {\n\t\t\t\tlist($readfile,$filename)=explode(\"|\",$value);\n\t\t        list($dummy,$extention)=explode(\".\",$filename);\n\t\t        $filetype=DATABOX_getFileTypeAry($extention );\n\t\t        if  ($filetype<>\"\"){\n                    $path=$box_conf['file_path'];\n                    if  (file_exists($path.$readfile)){\n                        if  ($mode==\"display\"){\n                            if  ($extention==\"pdf\"){\n                                header('Content-Type: '.$filetype);\n                                header('Content-Disposition: inline; filename=\"'.$filename.'\"');\n                                readfile($path.$readfile);\n                                //download log\n                                //download count\n                                exit;\n                            }\n                        }else{\n                            header('Content-Type: '.$filetype);\n                            header('Content-Disposition: attachment; filename=\"'.$filename.'\"');\n                            readfile($path.$readfile);\n                            //download log\n                            //download count\n                            exit;\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    return $rt;\n\n}\nfunction DATABOX_getFileTypeAry(\n    $extension \n)\n{\n    $ary=array();\n    $ary['odt']=\"application/vnd.oasis.opendocument.text\";//open office writer*\n    $ary['doc']=\"application/msword\";//Microsoft Word\n    $ary['docx']=\"application/vnd.openxmlformats\";// Microsoft Office Word 2007*\n    $ary['html']=\"text/html\";\n    $ary['odb']=\"application/octet-stream \";//OpenOffice Base*\n    $ary['odf']=\"application/vnd.oasis.opendocument.formula\";//OpenOffice Calc*\n    $ary['odg']=\"application/vnd.oasis.opendocument.graphics\";//OpenOffice Draw*\n    $ary['odm']=\"application/vnd.oasis.opendocument.text-master\";// OpenOffice Writer*\n    $ary['odp']=\"application/vnd.oasis.opendocument.presentation\";//OpenOffice Impress*\n    $ary['ods']=\"application/vnd.oasis.opendocument.spreadsheet\";//OpenOffice Calc*\n    $ary['otg']=\"application/vnd.oasis.opendocument.graphics-template\";//OpenOffice Draw*\n    $ary['oth']=\"application/octet-stream\";// OpenOffice.org Writer*\n    $ary['otp']=\"application/vnd.oasis.opendocument.presentation-template\";//OpenOffice Impress*\n    $ary['ots']=\"application/octet-stream\";//OtsAV*\n    $ary['ott']=\"application/vnd.oasis.opendocument.formula-template \";//OpenOffice Writer*\n    $ary['oxt']=\"application/vnd.openofficeorg.extension\";//OpenOffice *\n    $ary['pdf']=\"application/pdf\";\n    $ary['ppt']=\"application/mspowerpoint\";//Microsoft PowerPoint*\n    $ary['pptx']=\"application/vnd.openxmlformats\";//Microsoft Office PowerPoint 2007*\n    $ary['txt']=\"text/plain\";\n    $ary['xls']=\"application/vnd.ms-excel\";//Microsoft Excel*\n    $ary['xlsx']=\"application/vnd.openxmlformats \";//Microsoft Office Excel 2007*\n    $ary['xml']=\"text/xml\";\n\tif  ($extention===\"\"){\n\t\t$rt= $ary;\n\t}else{\n\t\t$rt= $ary[$extension];\n\t}\n\treturn $rt;\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_count_each_afield(\"class\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n\nfunction DATABOX_count_each_afield(\n    $pi_name=\"databox\"\n    ,$templatesetvar=\"\"\n    ,$value=\"\"\n    ,$type_id=0\n    ,$permission=''\n    ,$numberformat=''\n)\n{\n    global $_TABLES;\n\n    if ($templatesetvar==\"\" OR $value==\"\" ){\n        return \"\";\n    }\n\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n    \n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" t1.id\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    $sql .= \" AND fieldset_id = \".$type_id.LB;\n\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\n    $sql .= \" AND t2.value='\". $value .\"'\".LB;\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_math(\n    $pi_name= 'databox'\n    ,$method= 'count'\n    ,$templatesetvar=\"\"\n    ,$type_id=\"\"\n    ,$category_id=null\n    ,$category_code=null\n    ,$mode=''\n    ,$roundprecision=''\n    ,$numberformat=''\n    ,$permission=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306e\u6307\u5b9a\u5024\uff08count average max min sum\uff09\u3092\u53d6\u5f97\u3059\u308b\n// |       \u8907\u6570\u30ab\u30c6\u30b4\u30ea\u6761\u4ef6\u9078\u629e\u304c\u53ef\u80fd\uff08OR \u3068 AND\uff09\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_math(\"databox\",\"count\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $method:count average avg max min sum\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $category_code :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// | \u5f15\u6570 $roundprecision:\u301c-3,-2,-1,0,1,2,3\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u5024\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($templatesetvar==\"\" ){\n        return \"\";\n    }\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n\t\n\t$method=strtoupper($method);\n    if  ($method==\"MAX\" OR $method==\"MIN\" OR $method==\"SUM\" OR $method==\"AVG\" OR $method==\"COUNT\" ){\n    }else if  ($method==\"AVERAGE\" ){\n\t    $method=\"AVG\";\n\t}else{\n\t    $method=\"COUNT\";\n\t}\n    //-----category check\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,strtoupper($pi_name).'_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $tbl4=$_TABLES[strtoupper($pi_name).'_category'] ;\n\t$tbl5=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n\t\n    $type=DB_getItem( $tbl3   ,\"type\",\"templatesetvar='{$templatesetvar}'\");\n\t\n    //-----\n    $sql = \"SELECT \".LB;\n    \n    if  ($type==15  OR $type==21 OR strtoupper($numberformat)==\"YES\") {\n        $sql .= $method .\"(t2.value + 0) AS rt\".LB;\n    }else{\n        $sql .= $method .\"(t2.value) AS rt\".LB;\n    }\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    \n    $sql .= \" AND fieldset_id=\".$type_id;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\t\n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t4.category_id\";\n                $w.=\" FROM {$tbl4} AS t4 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t1.id = t4.id AND t4.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t1.id IN (SELECT id FROM {$tbl4} AS t4 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t4.category_id = t5.category_id AND t5.allow_display<2 AND t4.category_id IN ({$ids})) \";\n        }\n        $sql.=\" AND ({$w})\".LB;\n    }\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\t\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n\t\t$A = array_map('stripslashes', $A);\n\t\t$rt=$A['rt'];;\n\t}else{\n\t\tif  ($method==\"COUNT\"){\n\t\t\t$rt=0;\n\t\t}else{\n\t\t\t$rt=\"\";\n\t\t}\n\t}\n\t\n    if ( is_numeric($rt) ) {\n        if  (!is_numeric($roundprecision)){\n            $roundprecision=0;\n        }\n        $rt=round($rt,$roundprecision);\n        if  (strtoupper($numberformat)==\"YES\"){\n            $rt=number_format( $rt, \n                $roundprecision, $_CONF['decimal_separator'], $_CONF['thousand_separator'] );\n        }\n    }\n    return $rt;\n\t\n\t\n}\nfunction DATABOX_getcheckboxary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\t\n    $selectedary=explode(\":\",$selected);\n\t\n\t$retval = '';\n\t\n    foreach($ary as $k => $v) {\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fld . '[]\" value=\"' . $k ;\n        $retval .= '\"';\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( in_array($k,$selectedary) ){//@@@@@\n                $retval .= ' checked=\"checked\"';\n\t\t\t}\n\t\t}\n        $retval .= '>' . stripslashes( $v ) . '</span>' . LB;\n\n    }\n    return $retval;\n}\n\n?>"], "fixing_code": ["<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | DataBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | \u81ea\u52d5\u30bf\u30b0\u304a\u3088\u3073 DataBox \u5c02\u7528\u95a2\u6570\n// +---------------------------------------------------------------------------+\n// $Id: plugins/databox/functions_autotag.inc\n//20101008 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n//20120416 databox_category {data_edit}\n\nif (strpos ($_SERVER['PHP_SELF'], 'functions_autotag.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n//=====\u81ea\u52d5\u30bf\u30b0=================================================================\nfunction plugin_autotags_databox (\n    $op\n    , $content = ''\n    , $autotag = ''\n)\n// +---------------------------------------------------------------------------+\n// | \u81ea\u52d5\u30bf\u30b0\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    global $LANG_DATABOX_autotag_desc;\n\n    //Option Display\n    if ($op == 'tagname' ) {\n        $tagname[]='databox';\n        return $tagname;\n    } elseif ($op == 'permission' || $op == 'nopermission') {\n        if ($op == 'permission') {\n            $flag = true;\n        } else {\n            $flag = false;\n        }\n\n        if (isset($_GROUPS['DataBox Admin'])) {\n            $group_id = $_GROUPS['DataBox Admin'];\n        } else {\n            $group_id = DB_getItem($_TABLES['groups'], 'grp_id',\n                                   \"grp_name = 'DataBox Admin'\");\n        }\n        $owner_id = SEC_getDefaultRootUser();\n\n        if (COM_getPermTag(\n            $owner_id\n            , $group_id\n            , $_DATABOX_CONF['autotag_permissions_databox'][0]\n            , $_DATABOX_CONF['autotag_permissions_databox'][1]\n            , $_DATABOX_CONF['autotag_permissions_databox'][2]\n            , $_DATABOX_CONF['autotag_permissions_databox'][3]) == $flag) {\n            return $tagname;\n        }\n    } elseif ($op == 'description') {\n        return $LANG_DATABOX_autotag_desc;\n    } else if ($op == 'parse') {\n        //\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n        $p1 = COM_applyFilter ($autotag['parm1']);\n        $p2 = COM_applyFilter ($autotag['parm2']);\n        $tag = COM_applyFilter ($autotag['tag']);\n        $tagstr = COM_applyFilter ($autotag['tagstr']);\n        \n        $parm2_ary[]=\"category_id\";\n        $parm2_ary[]=\"category_code\";\n        $parm2_ary[]=\"mode\";\n        $parm2_ary[]=\"rss_file\";\n        $parm2_ary[]=\"title_trim_length\";\n        $parm2_ary[]=\"intervalday\";\n        $parm2_ary[]=\"limitcnt\";\n        $parm2_ary[]=\"newmarkday\";\n        $parm2_ary[]=\"templatedir\";\n        $parm2_ary[]=\"id\";\n        $parm2_ary[]=\"code\";\n        $parm2_ary[]=\"nohitmsg\";\n        $parm2_ary[]=\"perpage\";\n        $parm2_ary[]=\"page\";\n        $parm2_ary[]=\"order\";\n        $parm2_ary[]=\"templatesetvar\";\n        $parm2_ary[]=\"value\";\n        $parm2_ary[]=\"field_id\";\n        $parm2_ary[]=\"expired\";\n        $parm2_ary[]=\"type_id\";\n        $parm2_ary[]=\"group_id\";\n        $parm2_ary[]=\"group_code\";\n        $parm2_ary[]=\"iname\";\n        $parm2_ary[]=\"without_code\";\n        $parm2_ary[]=\"without_id\";\n        $parm2_ary[]=\"field_code\";\n        $parm2_ary[]=\"option\";\n        $parm2_ary[]=\"method\";\n        $parm2_ary[]=\"roundprecision\";\n        $parm2_ary[]=\"numberformat\";\n        $parm2_ary[]=\"permission\";\n        $p=databox_parm2($p2,$parm2_ary);\n        //\u5404\u51e6\u7406\n        switch( $tag ) {\n            case 'databox' :\n                switch($p1) {\n                    case 'count':\n                        $rt= databox_count(\n                            $p['category_id']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n                    case 'newlist':\n                            if ($p['category_id']<>\"\"){\n                                $m=\"id\";\n                                $categories=$p['category_id'];\n                            }elseif ($p['category_code']<>\"\") {\n                                $m=\"code\";\n                                $categories=$p['category_code'];\n                            }else{\n                                $m=\"ALL\";\n                                $categories=\"\";\n                            }\n                            $rt= databox_newlist(\n                            $m\n                            ,$categories\n                            ,$p['rss_file']\n                            ,$p['title_trim_length']\n                            ,$p['intervalday']\n                            ,$p['limitcnt']\n                            ,$p['newmarkday']\n                            ,$p['templatedir']\n                            ,$p['permission']\n                            );\n                        break;\n                    case 'data':\n                        $w= databox_data(\n                            $p['id']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,\"\"\n                            ,$p['code']\n                            );\n                        $rt=$w['display'];\n                        break;\n                    case 'category':\n                        $rt= databox_category(\n                            \"autotag\"\n                            ,$p['category_id']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['expired']\n                            ,$p['without_code']\n                            ,$p['without_id']\n                        );\n                        break;\n                    case 'attributedatacount':\n                        $rt=DATABOX_count_each_afield(\n                            \"databox\"\n                            ,$p['templatesetvar']\n       \t                    ,$p['value']\n                            ,$p['type_id']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n\n                    case 'lastmodified':\n                        $rt= databox_grp(\n                            \"modified\"\n                            ,\"max\"\n                            ,\"lastmodified\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                        break;\n                    case 'lastcreated':\n                        $rt= databox_grp(\n                            \"created\"\n                            ,\"max\"\n                            ,\"lastcreated\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                        break;\n                    case 'attribute':\n                        $rt= databox_field(\n                            \"autotag\"\n                            ,$p['field_id']\n                            ,$p['value']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['field_code']\n                        );\n                        break;\n                    case 'datalink':\n                        $rt= databox_datalink(\n                            $p['id']\n                            ,$p['code']\n                            ,$p['lastparm2']\n                        );\n                        break;\n                    case 'mydataentrylink':\n                    case 'mydataentry':\n                        $rt= databox_mydataentrylink(\n                            $p['type_id']\n                            ,$p['templatedir']\n                            ,$p['lastparm2']\n                        );\n                        break;\n                    case 'mydata':\n                        $rt= databox_mydata(\n                             $p['templatedir']\n                            ,$p['lastparm2']\n                        );\n                        break;\n                    case 'categorycount':\n                        $rt= DATABOX_categorycount(\n                             \"databox\"\n                            ,$p['group_id']\n                            ,$p['group_code']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                        );\n                        break;\n                    case 'categorycheck':\n                          $rt= DATABOX_getcheckList(\n                             \"categorygroup\"\n                            ,\"\"\n                            ,\"databox\"\n                            ,$p['group_id']\n                            ,$p['iname']\n                        );\n                        break;\n                    case 'mastercheck':\n                        if  ($p['field_id']<>\"\"){\n                            $kind=COM_applyFilter(\n                                DB_getItem($_TABLES['DATABOX_def_field'] \n                                    ,\"selectlist\",\"field_id={$p['field_id']}\"));\n                            if  ($kind<>\"\"){\n                                  $rt= DATABOX_getcheckList(\n                                     $kind\n                                     ,\"\"\n                                     ,\"databox\"\n                                     ,\"\"\n                                     ,$p['iname']\n                                  );\n                            }\n                        }\n                        break;\n                    case 'search':\n                        $argary=databox_searcharg(\"autotag\",$p['lastparm2']);\n                        $rt=databox_search(\"autotag\",$argary);\n                        break;\n                    case 'attributevalue':\n                        $rt=DATABOX_fieldvalue(\n                                \"databox\"\n                                ,$p['id']\n                                ,$p['code']\n                                ,$p['field_id']\n                                ,$p['field_code']\n                                ,$p['option']\n                            );\n                        break;\n                    case 'math':\n                        $rt=DATABOX_math(\n                                \"databox\"\n                                ,$p['method']\n                                ,$p['templatesetvar']\n                                ,$p['type_id']\n                                ,$p['category_id']\n                                ,$p['category_code']\n                                ,$p['mode']\n                                ,$p['roundprecision']\n                                ,$p['numberformat']\n                                ,$p['permission']\n                            );\n                        break;\n                }\n\n                $content = str_replace ($autotag['tagstr'], $rt, $content);\n                return $content;\n                break;\n\n        }\n    }\n}\n\n//\u7b2c\u4e8c\u5f15\u6570\u5206\u5272\nfunction databox_parm2 ($p2,$parm2_ary)\n{\n    $ary=array();\n    $px = explode (' ', trim ($p2));\n    if (is_array ($px)) {\n        foreach ($px as $part) {\n            $a = explode (':', $part);\n            if (in_array($a[0],$parm2_ary)){\n                $ary[\"{$a[0]}\"]=$a[1];\n                $skip++;            \n            }\n        }\n        \n        if (count ($px) > $skip) {\n            for ($i = 0; $i < $skip; $i++) {\n                array_shift ($px);\n            }\n            $ary[\"lastparm2\"] = trim(implode (' ', $px));\n        }\n\n    }else{\n        $ary[\"lastparm2\"]=trim($p2);\n    }\n    \n    return $ary;\n\n}\n//=====\u30d6\u30ed\u30c3\u30af\u95a2\u6570============================================================\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740data\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f phpblock_shownewdatabox()                                            |\n// +---------------------------------------------------------------------------+\nfunction phpblock_shownewdatabox()\n{\n    return databox_newlist();\n}\n\n//=====\u5c02\u7528\u95a2\u6570============================================================\n//\nfunction databox_category(\n    $autotag\n    ,$category_id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$category_code=null\n    ,$mode=''\n    ,$expired=''\n    ,$without_code=''\n    ,$without_id=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f  databox_category($id,$template,\"yes\",\"page\",$perpage)\n// | \u66f8\u5f0f  databox_category($p['category_id'],$p['thtml'],$p['nohitmsg']\n// | \u66f8\u5f0f                    ,\"\",$p['perpage'],$p['order'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $autotag:notautotag\u306e\u6642\u30d8\u30c3\u30c0\u3092\u8868\u793a\u3057\u306a\u3044\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $page            :\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $category_code :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// +---------------------------------------------------------------------------+\n// | public_html/category.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:category list\n// +---------------------------------------------------------------------------+\n{\n    $pi_name=\"databox\";\n    \n    global $_CONF;\n    global $_TABLES;\n    \n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >1) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n\n    }\n    //-----\u30c6\u30fc\u30d6\u30eb\n    $tbl1=$_TABLES['DATABOX_category'] ;\n    $tbl2=$_TABLES['DATABOX_base'] ;\n    $tbl3=$_TABLES['DATABOX_addition'] ;\n    //\n    $tbl5=$_TABLES['DATABOX_def_category'] ;\n    \n    $tbl6=$_TABLES['DATABOX_stats'];\n\n    //\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\u3001\u516c\u958b\u65e5\uff09\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_DATABOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,'DATABOX_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    \n    //--CATEGORY\n    $category_name=\"\";\n    $defaulttemplatesdirectory = \"\";\n    if (count($idsary)<>0){\n        \n        for ($i = 0; $i < count($idsary); $i++) {\n            $sql = \"SELECT \";\n            $sql .= \" name \".LB;\n            $sql .= \" ,code \".LB;\n            $sql .= \" ,description \".LB;\n            $sql .= \" ,defaulttemplatesdirectory\".LB;\n            $sql .= \" FROM \".LB;\n            $sql .= \" {$tbl5} AS t5 \".LB;\n            $sql .= \" WHERE \".LB;\n            $sql .= \" t5.category_id =\".$idsary[$i].LB;\n        \n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n            if ($numrows > 0) {\n                $A = DB_fetchArray ($result);\n                $category_name.=COM_applyFilter($A['name']).\" \";\n                $category_description.=COM_applyFilter($A['description']).\" \";\n                if ($i==0){\n                    $defaulttemplatesdirectory=COM_applyFilter($A['defaulttemplatesdirectory']);\n                }\n            }\n        }\n    }\n\n    if (is_null($template) or ($template===\"\")){\n        if ($defaulttemplatesdirectory===\"\"){\n            $template=\"default\";\n        }else{\n            $template=$defaulttemplatesdirectory;\n        }\n    }\n    \n    //\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_DATABOX_CONF['perpage'];\n    }\n    //\n    $w=databox_orderby($datefield,$order,$orderby,$addfieldorder,$field_id);\n    //\n    if (is_null($expired) or ($expired===\"\")){\n        $expired=\"no\";\n    }\n    //-----\n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.title \".LB;\n    $sql .= \" ,t2.code \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.fieldset_id \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n\n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n    \n    //--FROM\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n\n    //if ($category_id<>0){\n    //    $sql .= \" ,{$tbl1} AS t1 \".LB;\n    //}\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n    \n    //--WHERE\n    $sql .= \" WHERE \".LB;\n    \n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t1.category_id\";\n                $w.=\" FROM {$tbl1} AS t1 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t2.id = t1.id AND t1.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t2.id IN (SELECT id FROM {$tbl1} AS t1 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t1.category_id = t5.category_id AND t5.allow_display<2 AND t1.category_id IN ({$ids})) \";\n        }\n        $sql.=\" ({$w})\".LB;\n    }else{\n        $sql.=\" 1=1\".LB;\n    }\n    \n    if ($addfieldorder){\n    \n        $sql .= \" AND t3.field_id=\".$field_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //20110529 Del\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    if  (strtoupper($expired)==\"NO\"){\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    if  ($without_code<>\"\"){\n        $sql .= \" AND (t2.code<>'$without_code')\";\n    }\n    if  ($without_id<>\"\"){\n        $sql .= \" AND (t2.id<>$without_id)\";\n    }\n    \n    //--ORDER\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n\n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $category_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $category_name);\n        }\n        \n        // Meta Tags\n        $headercode=DATABOX_getheadercode(\n            \"category\"\n            ,$template\n            ,$pi_name\n            ,$category_id\n            ,$category_name\n            ,$category_description\n            ,$category_name\n            ,$category_description);\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode) ;\n    }\n    \n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        \n        $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            ));\n\n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n\n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_DATABOX['home']);\n        \n        $templates->set_var ('lang_category_list_h2',$LANG_DATABOX['category_list_h2']);\n\n        $templates->set_var ('category_name',$category_name);\n        $templates->set_var ('category_code',$category_code);\n        $templates->set_var ('category_description',$category_description);\n\n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_DATABOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        //\n        $templates->set_var ('lang_title', $LANG_DATABOX_ADMIN['title']);\n        $templates->set_var ('lang_code', $LANG_DATABOX_ADMIN['code']);\n        $templates->set_var ('lang_id', $LANG_DATABOX_ADMIN['id']);\n        $templates->set_var ('lang_description', $LANG_DATABOX_ADMIN['description']);\n        $templates->set_var ('lang_date', $LANG_DATABOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_DATABOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        // \u8ffd\u52a0\u9805\u76ee\u306e\u30d8\u30c3\u30c0\n        $addition_def=DATABOX_getadditiondef($pi_name);\n        \n        //\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $title=$A['title'];\n            $description=$A['description'];\n            $code=COM_applyFilter($A['code']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{\n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n\n            \n            $value=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n\n            $rt= databox_detail_link($id,$code,$title);\n\n            $templates->set_var ('data_link', $rt['link']);\n            $templates->set_var ('data_title', $title);\n            $templates->set_var ('data_code', $code);\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $rt['url']);\n\n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $value);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_date', strftime( $_CONF['date'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_daytime', strftime( $_CONF['daytime'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_dateonly', strftime( $_CONF['dateonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_timeonly', strftime( $_CONF['timeonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_b', strftime( \"%b\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_B', strftime( \"%B\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_d', strftime( \"%d\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_e', strftime( \"%e\" , $A['datefield_un']));\n            \n            $templates->set_var ('data_released', $released_ary[0]);\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            $hits=COM_applyFilter(DB_getItem( $tbl6 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            \n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/databox/data.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/mydata/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n                \n            }\n\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'databox', $templates );\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"databox/category.php\";\n        }\n        $url.=\"?\";\n        if ($category_code<>\"\"){\n            $url.=\"code=\".$category_code;\n            $url.=\"&amp;m=code\";\n        }else{\n            $url .= \"id=\".$category_id;\n            $url .= \"&amp;m=id\";\n        }    \n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;order=\";\n        \n        //-----order navigation\n        databox_order ($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            $templates->set_var ('home',$LANG_DATABOX['home']);\n            \n            $url=$_CONF['site_url'].\"/databox/category.php\";\n            $category_top=\"<a href='\".$url.\"'>\".$LANG_DATABOX['category_top'].\"</a>\";\n            $templates->set_var ('category_top',$category_top);\n\n            $templates->set_var ('category_name',$category_name);\n            $templates->set_var ('category_code',$category_code);\n            $templates->set_var ('category_description',$category_description);\n            \n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n\n        }\n        \n        \n        \n        \n        \n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    return $retval;\n}\n\nfunction databox_count(\n    $category_id =null\n    ,$category_code =null\n    ,$mode=''\n    ,$permission=''\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u4ef6\u6570\u8868\u793a                                                          |\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_count()\n// | \u66f8\u5f0f  databox_count(1)\n// | \u66f8\u5f0f  databox_count(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    \n    //-----\n    $tbl1=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['DATABOX_category'] ;\n\n    //\u30ab\u30c6\u30b4\u30ea\u306e\u6307\u5b9a\u304c\u306a\u3051\u308c\u3070\u5168\u4ef6\u3001\u3042\u308c\u3070\u30ab\u30c6\u30b4\u30ea\u6bce\n    $exp=\"\";\n    if (is_null($category_id) AND is_null($category_code) ){\n    }else{\n        $ids=\"\";\n        $idsary=array();\n        if (is_null($category_id) OR $category_id==0){\n            if (is_null($category_code)){\n            }else{\n                $w=explode(\"|\",$category_code);\n                foreach( $w as $val ){\n                    if ($ids<>\"\"){\n                        $ids.=\",\";\n                    }\n                    $w_id=DATABOX_codetoid($val,'DATABOX_def_category',\"category_id\");\n                    $idsary[]=$w_id;\n                    $ids.=$w_id;\n                }\n            }\n        }else{\n            $ids=$category_id;\n            $idsary[]=$category_id;\n        }\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT category_id\";\n                $w.=\" FROM {$tbl2} AS t2 \";\n                $w.=\" WHERE t2.id = t1.id)\";\n            }\n        }else{\n            $w= \"id IN (SELECT id FROM {$tbl2} \";\n            $w.=\"WHERE category_id IN ({$ids})) \";\n        }\n        $exp=$w.LB;\n    }\n    \n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" distinct t1.id \".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    $sql .= \" WHERE \".LB;\n    \n    if ($exp<>\"\"){\n        $sql .= $exp. \" AND \";\n    }\n\n    //@@@@@@@@@--------->\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@<---------\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    \n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n    \n    return $rt;\n\n}\n\nfunction databox_field(\n    $autotag\n    ,$field_id=null\n    ,$value=\"\"\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$field_code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $autotag:notautotag\u306e\u6642\u30d8\u30c3\u30c0\u3092\u8868\u793a\u3057\u306a\u3044\n// | \u5f15\u6570 $field_id:\u8ffd\u52a0\u5c5e\u6027id\n// | \u5f15\u6570 $value:\u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u5024\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $page           :\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $field_code    :\n// +---------------------------------------------------------------------------+\n// | public_html/attribute.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:attribute list\n// +---------------------------------------------------------------------------+\n{\n\n    $pi_name=\"databox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $LANG_DATABOX_NOYES;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n    global $_PLUGINS;\n    global $_MAPS_CONF;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >1) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n\n    }\n    //-----table assign\n    $tbl1=$_TABLES['DATABOX_addition'] ;\n    $tbl2=$_TABLES['DATABOX_base'] ;\n    $tbl3=$_TABLES['DATABOX_addition'] ;\n    $tbl5=$_TABLES['DATABOX_stats'];\n\n    //\u65e5\u4ed8\u95a2\u9023\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\u3001\u516c\u958b\u65e5\uff09\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_DATABOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($value) OR $value===\"\") {\n        return;\n    }\n    if (is_null($field_id)){\n        if ($field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,'DATABOX_def_field',\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return;\n    }\n    if ($field_code===\"\"){\n        $field_code=DB_getItem( $_TABLES['DATABOX_def_field']\n                 ,\"templatesetvar\",\"field_id={$field_id}\");\n    }\n    \n    $field_def=DATABOX_getadditiondef($pi_name);\n    $type=$field_def[$field_id]['type'];\n    $w = array(0,2,3,4,7,8,9,16);\n    if (in_array ($type,$w)){\n    }else{\n        return;\n    }\n\n    //\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_DATABOX_CONF['perpage'];\n    }\n    \n    $w=databox_orderby($datefield,$order,$orderby,$addfieldorder,$orderfield_id);\n    \n    $field_def[$field_id]['name'];\n    $field_name=$field_def[$field_id]['name'];\n    $field_templatesetvar=$field_def[$field_id]['templatesetvar'];\n    $field_description=$field_def[$field_id]['description'];\n\n    $fieldvalue=DATABOX_getfieldvalue(\n          $value\n         ,$field_def[$field_id]['type']\n         ,$field_def[$field_id]['selectionary']\n         ,$LANG_DATABOX_NOYES\n         ,$field_def[$field_id]['selectlist']\n         ,$pi_name\n          );\n\n\n    if (is_null($template) or ($template===\"\")){\n        $template=\"default\";\n    }\n\n\n    $sql = \"SELECT DISTINCT\";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.title \".LB;\n    $sql .= \" ,t2.code \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n    \n    $sql .= \" ,t2.fieldset_id \".LB;\n    \n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl1} AS t1 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.field_id = \".$field_id.LB;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t1.value = \\\"\".$value.\"\\\"\".LB;\n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$orderfield_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n    \n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n\n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $field_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $field_name);\n        }\n        $headercode=DATABOX_getheadercode(    \n            \"attribute\"\n            ,$template\n            ,$pi_name\n            ,$field_id\n            ,$field_name\n            ,$field_description\n            ,$field_name\n            ,$field_description);\n\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode);\n    }\n\n    \n    //\n    $addition_def=DATABOX_getadditiondef($pi_name);\n    //\n    $url=$_CONF['site_url'].\"/databox/attribute.php\";\n    $attribute_top=\"<a href='\".$url.\"'>\".$LANG_DATABOX['attribute_top'].\"</a>\";\n    $url=$_CONF['site_url'].\"/databox/attribute.php?\";\n    $url.=\"m=id&amp;id=\".$field_id;\n    $field_top=\"<a href='\".$url.\"'>\".$field_name.$LANG_DATABOX['countlist'].\"</a>\";\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            ));\n        \n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n\n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_DATABOX['home']);\n        $templates->set_var ('attribute_top',$attribute_top);\n        $templates->set_var ('field_top',$field_top);\n        \n        $templates->set_var ('field_name',$field_name);\n        $templates->set_var ('field_templatesetvar',$field_templatesetvar);\n        $templates->set_var ('field_description',$field_description);\n        \n        $templates->set_var ('fieldvalue',$fieldvalue);\n\n        $templates->set_var ('addition_name',$additon_name);\n        $templates->set_var ('addition_code',$additon_code);\n\n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_DATABOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        $templates->set_var ('lang_code', $LANG_DATABOX_ADMIN['code']);\n        $templates->set_var ('lang_id', $LANG_DATABOX_ADMIN['id']);\n\n        //\n        $templates->set_var ('lang_date', $LANG_DATABOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_title', $LANG_DATABOX_ADMIN['title']);\n        $templates->set_var ('lang_description', $LANG_DATABOX_ADMIN['description']);\n        $templates->set_var ('lang_released', $LANG_DATABOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        \n        //$_DATABOX_CONF\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n        $mkids=\"\";\n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $title=COM_applyFilter($A['title']);\n            $description=COM_applyFilter($A['description']);\n            $code=COM_applyFilter($A['code']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n            \n            $sortvalue=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            \n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n\n            $rt=databox_detail_link($id,$code,$title);\n            \n            $templates->set_var ('data_link', $rt['link']);\n            $templates->set_var ('data_title', $title);\n            $templates->set_var ('data_code', $code);\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $rt['url']);\n            \n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $sortvalue);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_date', strftime( $_CONF['date'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_daytime', strftime( $_CONF['daytime'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_dateonly', strftime( $_CONF['dateonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_timeonly', strftime( $_CONF['timeonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_b', strftime( \"%b\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_B', strftime( \"%B\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_d', strftime( \"%d\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_e', strftime( \"%e\" , $A['datefield_un']));\n            \n            $templates->set_var ('data_released', $released_ary[0]);//@@@@@@\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            \n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            \n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            \n            $hits=COM_applyFilter(DB_getItem( $tbl5 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n\n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $group_id = stripslashes($A['group_id']);\n            $owner_id = stripslashes($A['owner_id']);\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/databox/data.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/mydata/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n                \n            }\n            //maps plugin link\n            $mkid=\"\";\n            if (in_array(\"maps\", $_PLUGINS)){\n                if ($code<>\"\"){\n                    $mkid=DB_getItem($_TABLES['maps_markers'],\"mkid\",\"item_10='$code'\");\n                    $mkids.=$mkid.\" \";\n                }\n            }\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        $mkids=rtrim($mkids,\" \");\n        $mkidary=array();\n        $mkid_ary=split(\" \" , $mkids);\n        $selectedMarkers=\"\";\n        if (function_exists(\"MAPS_selectedMarkers\") AND $mkids<>\"\") {\n            $selectedMarkers=MAPS_selectedMarkers(\n              $_MAPS_CONF['map_width']\n             ,$_MAPS_CONF['map_height']\n             ,$_MAPS_CONF['map_zoom']\n             ,$mkid_ary);\n        }\n        $templates->set_var ('mkids', $mkids);\n        $templates->set_var ('selectedMarkers', $selectedMarkers);\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"databox/attribute.php\";\n        }\n        $url .= \"?m=id\";\n        $url .= \"&amp;id=\".$field_id;\n        $url .= \"&amp;value=\".$value;\n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;perpage=\".$perpage;\n        $url .= \"&amp;order=\";\n\n        //-----order navigation\n        databox_order($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'databox', $templates );\n\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            //bread\n            $templates->set_var ('home',$LANG_DATABOX['home']);\n            $templates->set_var ('attribute_top',$attribute_top);\n            $templates->set_var ('field_top',$field_top);\n            \n            $templates->set_var ('field_name',$field_name);\n            $templates->set_var ('field_templatesetvar',$templatesetvar);\n            $templates->set_var ('field_description',$field_description);\n            \n            $templates->set_var ('fieldvalue',$fieldvalue);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n\n        }\n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    return $retval;\n}\nfunction databox_orderby(\n    $datefield\n    ,&$order\n    ,&$orderby\n    ,&$addfieldorder\n    ,&$field_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  order orderby addfieldorder $field_id \u3092\u7de8\u96c6\n// | \u66f8\u5f0f  databox_orderby($order,$orderby,$addfieldorder,$field_id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $datefield\n// | \u5f15\u6570\u623b\u5024 $order\n// | \u5f15\u6570\u623b\u5024 $orderby\n// | \u5f15\u6570\u623b\u5024 $addfieldorder\n// | \u5f15\u6570\u623b\u5024 $field_id\n// +---------------------------------------------------------------------------+\n\n{\n\n    global $_TABLES;\n\n    $orderby=\"\";\n    $addfieldorder=false;\n    switch($order){\n        case \"random\":\n            $orderby =\" RAND()\";\n            break;\n        case \"\":\n        case \"date\":\n            $order=\"date\";\n            $orderby = $datefield .\" DESC\";\n            break;\n        case \"released\":\n            $orderby = \" released DESC\";\n            break;\n        case \"orderno\":\n        case \"code\":\n        case \"title\":\n        case \"description\":\n        case \"id\":\n            $orderby = \" t2.\".$order;\n            break;\n        default:\n            $sql=\"SELECT \";\n            $sql.= \" field_id \";\n            $sql.= \",name \";\n            $sql.=\" FROM\";\n            $sql.=\" {$_TABLES['DATABOX_def_field']} \";\n            $sql.=\" WHERE templatesetvar='\".$order.\"'\";\n\n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n\n            if ($numrows>0){\n                $A = DB_fetchArray ($result);\n                $field_id=COM_stripslashes($A['field_id']);\n                $addfield_name=COM_stripslashes($A['name']);\n                $orderby = \" t3.value IS NULL ASC ,cast(t3.value as DECIMAL) ASC \";\n                $addfieldorder=true;\n            }else{\n                $order=\"date\";\n                $orderby = $datefield .\" DESC\";\n            }\n    }\n\n    return ;\n\n}\n\n\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u96c6\u8a08\u8868\u793a(max min sum)\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_grp()\n// | \u66f8\u5f0f  databox_grp(1)\n// | \u66f8\u5f0f  databox_grp(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $field:\u9805\u76ee\u3000\u30c7\u30d5\u30a9\u30eb\u30c8modified\n// | \u5f15\u6570 $function:\u95a2\u6570\u3000\u30c7\u30d5\u30a9\u30eb\u30c8max\n// | \u5f15\u6570 $format:\u66f8\u5f0f\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n\nfunction databox_grp(\n    $field=null\n    ,$function=null\n    ,$format=null\n    ,$category_id =null\n    ,$category_code =null\n)\n{\n    global $_TABLES;\n    global $LANG_DATABOX;\n\n    $rt=\"\";\n\n    if (is_null($field) ){\n        $field=\"id\";\n    }\n    if (is_null($function) ){\n        $function=\"max\";\n    }\n\n    if (is_null($category_id) AND is_null($category_code) ){\n        $m=\"ALL\";\n    }else{\n        if (is_null($category_id) ){\n            $category_id=DATABOX_codetoid($category_code,'DATABOX_def_category',\"category_id\");\n        }\n        $m=\"CATEGORY\";\n    }\n    //-----\n    $tbl1=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['DATABOX_category'] ;\n\n    //-----\n    $sql=LB;\n    $sql .= \"SELECT \".LB;\n\n    $sql .= \" {$function}(t1.{$field}) AS rt\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@--------->\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND').LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@<---------\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" AND t1.id = t2.id \".LB;\n        $sql .= \" AND t2.category_id= \".$category_id .LB;\n    }\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n\n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n\n        $rt=$A['rt'];\n        if ($rt<>\"\"){\n            switch($format){\n                case \"lastmodified\":// '%Y\u5e74%m%e\u65e5\u66f4\u65b0';\n                case \"lastcreated\"://'%Y\u5e74%m%e\u65e5\u8ffd\u52a0';\n                    $fm=$LANG_DATABOX[$format];\n                    $rt=strftime($fm,strtotime($rt));\n                    break;\n                default:\n                    break;\n            }\n        }\n    }\n\n    return $rt;\n\n}\n\n\n\nfunction databox_data(\n    $id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$m=\"\"\n    ,$code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u500b\u5225\u30c7\u30fc\u30bf\u8868\u793a\n// | \u66f8\u5f0f  databox_data($id,$template,\"yes\",\"page\")\n// | \u66f8\u5f0f  databox_data($p['id'],$p['thtml'],$p['nohitmsg'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id            :\n// | \u5f15\u6570 $template      :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306edirectory\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $m             :\"page\"\u306e\u6642\u306f\u3000\u30ec\u30a4\u30a2\u30a6\u30c8\u8a2d\u5b9a\n// | \u5f15\u6570 $code          :\n// +---------------------------------------------------------------------------+\n// | public_html/data.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u76f4\u8fd1\u306b\u5909\u66f4\u307e\u305f\u306f\u8ffd\u52a0\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u8fd4\u3057\u307e\u3059\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:data\n// +---------------------------------------------------------------------------+\n{\n\n    $pi_name=\"databox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $_IMAGE_TYPE;\n    global $_USER;\n    global $LANG_ACCESS;\n    global $LANG_confignames;\n    global $_PLUGINS;\n    \n    $layout=$_DATABOX_CONF['layout'];\n    \n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >0) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n\n    }\n\n    //-----\n\n    if (is_null($id)  OR ($id==0)){\n        if ($code<>\"\"){\n            if (substr($code,0,4)===\"@fb_\"){\n                if (function_exists('assistfb_getNestAutotag')) {\n                    $code=assistfb_getNestAutotag(substr($code,4));\n                }\n            }    \n        }\n        if ($code<>\"\"){\n            $id=DATABOX_codetoid($code,'DATABOX_base',\"id\");\n        }\n    }\n\t\n    //-----\n    $display = '';\n\n    $tbl=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['users'] ;\n    $tbl4=$_TABLES['DATABOX_def_fieldset'];\n    $tbl5=$_TABLES['DATABOX_stats'];\n    \n    $addition_def=DATABOX_getadditiondef($pi_name);\n\n    //-----\n    $sql = \"SELECT t.* \";\n    \n    $sql .= \" ,UNIX_TIMESTAMP(t.modified) AS modified_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.released) AS released_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.comment_expire) AS comment_expire_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.expired) AS expired_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.created) AS created_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.udatetime) AS udatetime_un\";\n    \n    $sql .= \" ,t.fieldset_id\";\n    \n    $sql .= \" ,t2.username AS owner_name\";\n    $sql .= \" ,t3.username AS last_modify_name\";\n    $sql .= \" ,t3.fullname AS last_modify_fullname\";\n    \n    $sql .= \" ,t4.name AS set_name\";\n    $sql .= \" ,t4.description AS set_description\";\n    $sql .= \" ,t4.defaulttemplatesdirectory AS set_defaulttemplatesdirectory\";\n    $sql .= \" ,t4.layout AS set_layout\";\n    \n    $sql .= \" ,t5.hits\";\n    \n    $sql .= \" FROM \";\n    $sql .= \" {$tbl} AS t \";//base\n    $sql .= \" JOIN {$tbl4} AS t4       ON t.fieldset_id=t4.fieldset_id\";\n    $sql .= \" JOIN {$tbl2} AS t2       ON t.owner_id=t2.uid\";//owner\n    $sql .= \" LEFT JOIN {$tbl5} AS t5  ON t.id=t5.id\";\n    $sql .= \" LEFT JOIN  {$tbl2} AS t3 ON t.uuid=t3.uid\";//last_updateowner\n\n    $sql .= \" WHERE \";\n    if (is_null($id)){//@@@@@\n        $sql .= \"1=1\";\n    }else{\n        $sql .= \" t.id=\".$id;\n    }\n\n\n    //\u7ba1\u7406\u8005\u306e\u6642\n    if ( SEC_hasRights('databox.admin') OR $m===\"view\") {\n    }else{\n        //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND t.draft_flag=0\".LB;\n        //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (released <= NOW())\";\n        //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    \n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n    \n\n    if (is_null($id)){\n        $sql .= \" ORDER BY \".$_DATABOX_CONF['datefield'] . \" DESC \";\n        $sql .= \" LIMIT 0 , 1\";\n    }\n    \n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    \n    if  ($m===\"page\"  OR  $m===\"view\"){\n        if ($numrows <= 0) {\n            COM_handle404();\n            exit;\n        }\n    }\n\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\n        $cache_time=$A['cache_time'];\n        $cache=false;\n        if  ($cache_time===0){\n        }else{\n            if  ($m===\"page\"){\n                $cacheInstance = 'databox__' . $id .'__' . CACHE_security_hash();\n                $rt = CACHE_check_instance($cacheInstance.\"_title\");\n                if ($rt  AND $cache_time == -1) {\n                    $cache=true;\n                } elseif ($cache AND $cache_time > 0) {        \n                    $lu = CACHE_get_instance_update($cacheInstance.\"_title\");\n                    $now = time();\n                    if (($now - $lu) < $cache_time ){\n                         $cache=true;\n                    }\n                }\n            }\n        }\n        \n        \n        if  ($cache){\n            $display = CACHE_check_instance($cacheInstance.\"_display\",$display);\n            $layout = CACHE_check_instance($cacheInstance.\"_layout\",$layout);\n            $headercode = CACHE_check_instance($cacheInstance.\"_headercode\",$headercode);\n            $title = CACHE_check_instance($cacheInstance.\"_title\",$title);\n        }else{\n            if (is_null($template) or ($template===\"\")){\n                if ($A['defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['defaulttemplatesdirectory'];\n                }elseif  ($A['set_defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['set_defaulttemplatesdirectory'];\n                }else{\n                    $template=\"default\";\n                }\n            }\n\n            $code=$A['code'];\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n        \n            $fieldset_id= $A['fieldset_id'];\n            //\n            if ($m===\"view\"){    \n                $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n            }else{\n                $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            }\n\n            $id=$A['id'];\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n\n            //\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af start.............\n            if ($m===\"page\"){\n                if  ($A['set_layout']<>\"0\") {\n                    $layout=$A['set_layout'];\n                }\n                // Meta Tags\n                $headercode=DATABOX_getheadercode(    \n                    \"data\"\n                    ,$template\n                    ,$pi_name\n                    ,$A['id']\n                    ,$A['title']\n                    ,$A['meta_description']\n                    ,$A['meta_keywords']\n                    ,$A['description']\n                    ,$additionfields \n                    ,$addition_def \n                    ,$chk_user \n                    ,$fieldset_id \n                    );\n            \n                if  ($A['page_title']<>\"\"){\n                    $title = $A['page_title'] ;\n                }else{    \n                    $title = $A['title'] ;\n                }\n            }\n\n\n            $tmplfld=DATABOX_templatePath('data',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                    'list' => 'list_detail.thtml',\n                    'row'   => 'row.thtml',\n                    'col'   => \"col_detail.thtml\",\n                    ));\n        \n            $languageid=COM_getLanguageId();\n            $language= COM_getLanguage();\n            $templates->set_var ('languageid', $languageid);\n            $templates->set_var ('language', $language);\n            if ($languageid<>\"\") {\n                $templates->set_var ('_languageid', \"_\".$languageid);\n            }else{\n                $templates->set_var ('_languageid', \"\");\n            }\n        \n            $templates->set_var ('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var ('site_url',$_CONF['site_url']);\n            //\n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n        \n            $templates->set_var ('site_name', $_CONF['site_name']);\n            $templates->set_var ('site_mail', $_CONF['site_mail']);\n        \n            $currenturl= COM_getCurrentURL();\n            $templates->set_var ('currenturl', htmlspecialchars($currenturl, ENT_QUOTES, 'UTF-8'));\n            //facebook\n            $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n            $templates->set_var ('facebook_consumer_key', $facebook_consumer_key);\n            //\n        \n            //daft_flag\u7ba1\u7406\u8005\u306e\u6642\n            if ($A['draft_flag']==1){\n                $templates->set_var ('draft', \"draft!\");\n            }else{\n                $templates->set_var ('draft', \"\");\n            }\n            //------------\n\n            //id\n            $templates->set_var('lang_id', $LANG_DATABOX_ADMIN['id']);\n            $templates->set_var ('id', $A['id']);\n\n            $templates->set_var('lang_fields', $LANG_DATABOX_ADMIN['fields']);\n            $templates->set_var('lang_field', $LANG_DATABOX_ADMIN['field']);\n            $templates->set_var('lang_templatesetvar', $LANG_DATABOX_ADMIN['templatesetvar']);\n            $templates->set_var('lang_content', $LANG_DATABOX_ADMIN['content']);\n            $templates->set_var('lang_type', $LANG_DATABOX_ADMIN['type']);\n            $templates->set_var('lang_byusingid', $LANG_DATABOX_ADMIN['byusingid']);\n            $templates->set_var('lang_byusingcode', $LANG_DATABOX_ADMIN['byusingcode']);\n            $templates->set_var('lang_byusingtemplatesetvar', $LANG_DATABOX_ADMIN['byusingtemplatesetvar']);\n            $templates->set_var('lang_group', $LANG_DATABOX_ADMIN['group']);\n            $templates->set_var('lang_withlink', $LANG_DATABOX_ADMIN['withlink']);\n            $templates->set_var('lang_groupbygroup', $LANG_DATABOX_ADMIN['groupbygroup']);\n        \n            //$_DATABOX_CONF\n            $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n            $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n            $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n            $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n            $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n            $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n            //\u57fa\u672c\u9805\u76ee\n            $templates->set_var('lang_basicfields', $LANG_DATABOX_ADMIN['basicfields']);\n            //\u30b3\u30fc\u30c9\uff06\u30bf\u30a4\u30c8\u30eb\uff06\u8aac\u660e\n            $templates->set_var('lang_code', $LANG_DATABOX_ADMIN['code']);\n            $templates->set_var ('code', $A['code']);\n            $templates->set_var('lang_title', $LANG_DATABOX_ADMIN['title']);\n            $templates->set_var ('title',$A['title']);\n            $templates->set_var('lang_description', $LANG_DATABOX_ADMIN['description']);\n            $templates->set_var ('description',$A['description']);\n\n            //@@@@@\n            $templates->set_var('lang_owner', $LANG_ACCESS['owner']);\n            $templates->set_var ('owner_name',$A['owner_name']);\n            $templates->set_var ('owner_id',$A['owner_id']);\n\n            //hits\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var ('hits', $A['hits']);\n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $templates->set_var('lang_additionfields', $LANG_DATABOX_ADMIN['additionfields']);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n\n            //\u7de8\u96c6\u65e5\u4ed8\n            $templates->set_var('lang_modified', $LANG_DATABOX_ADMIN['modified']);\n            $wary = COM_getUserDateTimeFormat($A['modified_un']);\n            $templates->set_var ('modified',$wary[0]);\n            $templates->set_var ('modified_shortdate', strftime( $_CONF['shortdate'], $A['modified_un'] ));\n            $templates->set_var ('modified_date', strftime( $_CONF['date'], $A['modified_un'] ));\n            $templates->set_var ('modified_daytime', strftime( $_CONF['daytime'], $A['modified_un'] ));\n            $templates->set_var ('modified_dateonly', strftime( $_CONF['dateonly'], $A['modified_un'] ));\n            $templates->set_var ('modified_timeonly', strftime( $_CONF['timeonly'], $A['modified_un'] ));\n            $templates->set_var ('modified_b', strftime( \"%b\" , $A['modified_un']));\n            $templates->set_var ('modified_B', strftime( \"%B\" , $A['modified_un']));\n            $templates->set_var ('modified_d', strftime( \"%d\" , $A['modified_un']));\n            $templates->set_var ('modified_e', strftime( \"%e\" , $A['modified_un']));\n            //\u4f5c\u6210\u65e5\u4ed8\n            $templates->set_var('lang_created', $LANG_DATABOX_ADMIN['created']);\n            $wary = COM_getUserDateTimeFormat($A['created_un']);\n            $templates->set_var ('created', $wary[0]);\n            $templates->set_var ('created_shortdate', strftime( $_CONF['shortdate'], $A['created_un'] ));\n            $templates->set_var ('created_date', strftime( $_CONF['date'], $A['created_un'] ));\n            $templates->set_var ('created_daytime', strftime( $_CONF['daytime'], $A['created_un'] ));\n            $templates->set_var ('created_dateonly', strftime( $_CONF['dateonly'], $A['created_un'] ));\n            $templates->set_var ('created_timeonly', strftime( $_CONF['timeonly'], $A['created_un'] ));\n            $templates->set_var ('created_b', strftime( \"%b\" , $A['created_un']));\n            $templates->set_var ('created_B', strftime( \"%B\" , $A['created_un']));\n            $templates->set_var ('created_d', strftime( \"%d\" , $A['created_un']));\n            $templates->set_var ('created_e', strftime( \"%e\" , $A['created_un']));\n            //\u516c\u958b\u65e5\n            $templates->set_var('lang_released', $LANG_DATABOX_ADMIN['released']);\n            $wary = COM_getUserDateTimeFormat($A['released_un']);\n            $templates->set_var ('released', $wary[0]);\n            $templates->set_var ('released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('released_e', strftime( \"%e\" , $A['released_un']));\n            //\u516c\u958b\u7d42\u4e86\u65e5\n            $templates->set_var('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('expired', \"\");\n                $templates->set_var ('expired_shortdate', \"\" );\n                $templates->set_var ('expired_date', \"\" );\n                $templates->set_var ('expired_daytime', \"\" );\n                $templates->set_var ('expired_dateonly', \"\" );\n                $templates->set_var ('expired_timeonly', \"\" );\n                $templates->set_var ('expired_b', \"\" );\n                $templates->set_var ('expired_B', \"\" );\n                $templates->set_var ('expired_d', \"\" );\n                $templates->set_var ('expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('expired', $wary[0]);\n                $templates->set_var ('expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('expired_e', strftime( \"%e\" , $A['expired_un']));\n             }\n        \n            $templates->set_var ('lang_uuid', $LANG_DATABOX_ADMIN['uuid']);\n            $templates->set_var ('uuid', $uuid);\n        \n            $templates->set_var ('lang_udatetime', $LANG_DATABOX_ADMIN['udatetime']);\n            $wary = COM_getUserDateTimeFormat($A['udatetime_un']);\n            $templates->set_var ('udatetime', $wary[0]);\n            $templates->set_var ('last_modify_uid', $A['uuid']);\n        \n            $templates->set_var ('last_modify_name', $A['last_modify_name']);\n            $templates->set_var ('last_modify_fullname', $A['last_modify_fullname']);\n        \n            //maps plugin link\n            $mkid=\"\";\n            $marker=\"\";\n            if (in_array(\"maps\", $_PLUGINS)){\n                $mkid=DB_getItem($_TABLES['maps_markers'],\"mkid\",\"item_10='$code'\");\n                if (! empty($mkid)) {\n                    $sql = \"SELECT * FROM {$_TABLES['maps_markers']} WHERE mkid = {$mkid} LIMIT 1\";\n                    $res = DB_query($sql, 0);\n                    $AM = DB_fetchArray($res);\n                    if (!SEC_hasAccess2($AM)) {\n                    } else {\n                         $marker = MAPS_getMarkerDetail($AM['mid'], $mkid);\n                    }\n                }\n            }\n            $templates->set_var ('mkid', $mkid);\n            $templates->set_var ('marker', $marker);\n        \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ($m<>\"view\"){\n                if ( SEC_hasRights('databox.admin')) {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $A['title'].\" \".$LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                    $attr = array('class' => 'editlink', 'title' => $A['title'].\" \".$LANG_DATABOX_ADMIN['edit']);\n                    $url = $_CONF['site_admin_url'];\n                    $url .= '/plugins/databox/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                    $templates->set_var ('edit', $icon);\n                }else{\n                    $rt=databox_chk_loaddata($id);\n                    //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                    if ( $rt===\"OK\") {\n                        $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                        $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                        $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                        $attr = array('class' => 'editlink', 'title' => $A['title'].\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                        $url = $_CONF['site_url'];\n                        $url .= '/databox/mydata/data.php';\n                        $url .= '?mode=edit';\n                        $url .= '&amp;'.\"id={$id}\";\n\n                        $icon = '&nbsp;' ;\n                        $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                        $templates->set_var ('edit', $icon);\n                    }else{\n                        $templates->set_var ('edit', \"\");\n                    }\n                }\n            } \n            // Call to plugins to set template variables in the databox\n            PLG_templateSetVars( 'databox', $templates );\n\n            if (function_exists('databox_custom_templateSetVars')) {\n                databox_custom_templateSetVars(\"data\", $templates);\n            }\n        \n            //------------\n            $templates->parse ('output', 'list');\n\n            $databox_content = $templates->finish ($templates->get_var ('output'));\n            $display=$databox_content;\n\n            if ($A['draft_flag']!==1){\n                if (!SEC_hasRights('databox.admin')) {\n                    $id=$A['id'];\n                    $hits=DB_getItem($_TABLES['DATABOX_stats'],\"hits\",\"id={$id}\");\n                    if (empty($hits)) {\n                        $hits=0;\n                    }\n                    $fields.=\"id,hits \";\n                    $values.=\"$id,$hits + 1\";\n                    DB_save($_TABLES['DATABOX_stats'],$fields,$values);\n                }\n            }\n        } \n    }else{\n        $cache_time=0;\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('data',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n\n            $templates->parse ('output', 'list');\n            $databox_content = $templates->finish ($templates->get_var ('output'));\n            $display=$databox_content;\n        }\n    }\n    $display =PLG_replacetags ($display);\n    \n    if  (($cache_time > 0 OR $cache_time == -1)  AND  $m===\"page\" ){\n        CACHE_create_instance($cacheInstance.\"_display\", $display); \n        CACHE_create_instance($cacheInstance.\"_layout\", $layout); \n        CACHE_create_instance($cacheInstance.\"_headercode\", $headercode); \n        CACHE_create_instance($cacheInstance.\"_title\", $title); \n    }\n    \n    $retval['display']=$display;\n    $retval['layout']=$layout;\n    $retval['headercode']=$headercode;\n    $retval['title']=$title;\n    \n    return $retval;\n}\n\n//\nfunction databox_chk_loaddata(\n    $id\n){\n    $pi_name=\"databox\";\n\n    global $_TABLES;\n    global $LANG_DATABOX_ADMIN;\n\n\n    $rt=\"\";\n\n    $sql = \"SELECT \";\n    $sql .= \" id\";\n\n    $sql .= \" ,owner_id\";\n    $sql .= \" ,group_id\";\n    $sql .= \" ,perm_owner\";\n    $sql .= \" ,perm_group\";\n    $sql .= \" ,perm_members\";\n    $sql .= \" ,perm_anon\";\n\n    $sql .= \" FROM \";\n    $sql .= \" {$_TABLES['DATABOX_base']} AS t\";\n    $sql .= \" WHERE \";\n\n    $sql .= \" id=\".$id;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows>0){\n\n        $A = DB_fetchArray($result);\n\n        if (!isset($A['owner_id'])) {\n             $A['owner_id'] = 1;\n        }\n\n\n        $access = SEC_hasAccess(\n                            $A['owner_id']\n                            , $A['group_id']\n                            , $A['perm_owner']\n                            , $A['perm_group']\n                            , $A['perm_members']\n                            , $A['perm_anon']);\n        if ($access >2) {\n            $rt=\"OK\";\n        }else{\n            $rt=$LANG_DATABOX_ADMIN['err_permission_denied'];\n        }\n    }else{\n        $rt=$LANG_DATABOX_ADMIN['err_invalid'];\n    }\n\n\n    return $rt;\n}    \n//$rt=databox_createdatabycode(\"aaa\");\nfunction databox_createdatabycode(\n    $code\n    ,$title=\"\"\n){\n    $pi_name=\"databox\";\n\n    global $_TABLES;\n    global $LANG_DATABOX_ADMIN;\n    global $_DATABOX_CONF;\n    global $_USER;\n    \n    $rt=array();\n    $rt['st']=\"\";\n    $rt['id']=0;\n    \n    $id=DB_getItem($_TABLES['DATABOX_base'],\"id\",\"code='{$code}'\");\n    if ($id<>\"\"){\n        $rt['st']=\"ok\";\n        $rt['id']=$id;\n        return $rt;\n    };\n\n    if ($_DATABOX_CONF['allow_data_insert'] \n            OR SEC_hasRights('databox.submit')){\n    }else{\n         $rt['st']=$LANG_DATABOX_ADMIN['err_permission_denied'];\n         return $rt;\n    }\n\n    $uuid=$_USER['uid'];    \n    if ($uuid===\"\"){\n        $uuid=0;\n    }\n    $uid=$_USER['uid'];\n\n\n    $w=DB_getItem($_TABLES['DATABOX_base'],\"max(id)\",\"1=1\");\n    if ($w==\"\") {\n        $w=0;\n    }\n    $id=$w+1;\n    if  ($title==\"\"){\n        $title=$code;\n    }\n    $group_id =$_DATABOX_CONF['grp_id_default'];//@@@@@20110613\n\n    $array = array();\n    SEC_setDefaultPermissions($array, $_DATABOX_CONF['default_perm']);\n    $perm_owner = $array['perm_owner'];\n    $perm_group = $array['perm_group'];\n    $perm_anon = $array['perm_anon'];\n    $perm_members = $array['perm_members'];\n\n    $sql=LB;\n    $sql.=\"INSERT INTO {$_TABLES['DATABOX_base']} (\".LB;\n    $sql.=\" `id`,`owner_id`,`modified`,`created`,`released`\".LB;\n    $sql.=\" ,`uuid`\".LB;\n    $sql.=\" ,`group_id`,`perm_owner`,`perm_group`,`perm_anon`,`perm_members`\".LB;\n    $sql.=\" ,`code`,`title`\".LB;\n    $sql.=\")\".LB;\n\n    $sql .= \" VALUES (\".LB;\n    $sql .= \"'{$id}','{$uid}',NOW( ),NOW( ),NOW( )\".LB;\n    $sql.=\" ,\".$uuid .LB;\n    $sql.=\" ,\".$group_id.LB ;\n    $sql.=\" ,\".$perm_owner.LB ;\n    $sql.=\" ,\".$perm_group.LB ;\n    $sql.=\" ,\".$perm_anon.LB ;\n    $sql.=\" ,\".$perm_members.LB ;\n    $sql.=\" ,'{$code}','{$title}'\".LB ;\n    \n    $sql .= \")\";\n    DB_query ($sql);\n\n    //\u30ab\u30c6\u30b4\u30ea\n    //\u8ffd\u52a0\u9805\u76ee\n    $sql = \"SELECT \";\n    $sql .= \" field_id\";\n    $sql .= \" ,type\";\n    $sql .= \" ,selection\";\n\n    $sql .= \" FROM \";\n    $sql .= $_TABLES['DATABOX_def_field'];\n    $sql .= \" order by field_id \";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows > 0) {\n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n\n            $field_id=$A['field_id'];\n            $type=$A['type'];\n            $selection=$A['selection'];\n\n            $sql2=\"INSERT INTO \".$_TABLES['DATABOX_addition'].LB;\n            $sql2.=\" (`id`,`field_id`,`value`)\".LB;\n            $sql2.=\" VALUES (\";\n            $sql2.=\" \".$id;\n            $sql2.=\" ,\".$field_id;\n            //7 = '\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8';\n            //8 = '\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8';\n            if (($type==7 OR $type==8) AND ($selection<>\"\")){\n                $sql2.=\",'0' \";\n            }else{\n                $sql2.=\",'' \";\n            }\n            $sql2.=\" )\";\n\n            DB_query($sql2);\n        }\n\n    }\n\n\n    $rt['st']=\"created\";\n    $rt['id']=$id;\n        \n    return $rt;\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740data\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f databox_newlist                                                      |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $m             :\u7701\u7565\u6642'ALL' id=id\u6307\u5b9a\u3067\u9078\u629e code\u6307\u5b9a\u3067\u9078\u629e           |\n// | \u5f15\u6570 $categories    :\u9078\u629e\u30c8\u30d4\u30c3\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or'ALL'                     |\n// | \u5f15\u6570 $rss_file      :RSS_file     \u7701\u7565\u6642\"\"                                |\n// | \u5f15\u6570 $title_trim_length :\u30bf\u30a4\u30c8\u30eb\u9577\u306e\u5236\u9650 \u7701\u7565\u6642\u8a2d\u5b9a\u5024or20                |\n// | \u5f15\u6570 $intervalday   :\u65b0\u7740\u8a18\u4e8b\u306e\u671f\u9593 \u5358\u4f4d\u65e5  \u7701\u7565\u6642\u8a2d\u5b9a\u5024or90              |\n// |                      0\u306e\u6642\u3000\u5168\u4ef6                                          |\n// | \u5f15\u6570 $limitcnt      :\u8868\u793a\u4ef6\u6570   \u7701\u7565\u6642\u8a2d\u5b9a\u5024or10                          |\n// | \u5f15\u6570 $newmarkday    :\u65b0\u7740\u30de\u30fc\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or3                           |\n// | \u5f15\u6570 $thtml         :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d5\u30a9\u30eb\u30c0  layout/\u30c6\u30fc\u30de/XXXX/  |\n// |                      \u7701\u7565\u6642\u306f\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u5185\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8                 |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u65b0\u7740data\u4e00\u89a7                                                   |\n// +---------------------------------------------------------------------------+\n// 2009/04/02\u3000\u5f15\u6570 $thtml\u8ffd\u52a0\n// 2009/04/02\u3000\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u5909\u6570 class \u8ffd\u52a0\n// 2009/04/02\u3000$intervalday=0\u306e\u6642\u5168\u4ef6\n// update20110128\nfunction databox_newlist(\n     $m=\"ALL\"\n    ,$categories=\"\"\n    ,$rss_file=\"\"\n    ,$title_trim_length=\"\"\n    ,$intervalday=\"\"\n    ,$limitcnt=\"\"\n    ,$newmarkday=\"\"\n    ,$thtml=null\n    ,$permission=null)\n{\n\n    $pi_name=\"databox\";\n\n    global $_USER;\n    global $_TABLES;\n    global $_CONF;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n\n    //\n    if ($title_trim_length==\"\"){\n        $title_trim_length=$_DATABOX_CONF['title_trim_length'];\n        if ($title_trim_length==\"\"){\n            $title_trim_length=20;\n        }\n    }\n    //\n    if ($intervalday==\"\"){\n        $intervalday=$_DATABOX_CONF['intervalday'];\n        if ($intervalday==\"\"){\n            $intervalday=90;\n        }\n    }\n    //\n    if ($limitcnt==\"\"){\n        $limitcnt=$_DATABOX_CONF['limitcnt'];\n        if ($limitcnt==\"\"){\n            $limitcnt=10;\n        }\n    }\n    if ($newmarkday==\"\"){\n        $newmarkday=$_DATABOX_CONF['newmarkday'];\n        if ($newmarkday==\"\"){\n            $newmarkday=3;\n        }\n    }\n\n    if ($m===\"\"){\n        $categories=\"ALL\";\n    }else{\n        if ($categories==\"\"){\n            $categories=$_DATABOX_CONF['categories'];\n            if ($categories==\"\"){\n                $categories=\"ALL\";\n            }\n        }elseif (strpos($categories,\",\")==\"\") {\n            $categories=\"'$categories'\";\n        }else{\n            $ary=explode(\",\",$categories);\n            $b=\"\";\n            for ($i = 1; $i <= count($ary); $i++) {\n                if ($m===\"code\"){\n                    $b.=\"'\".current($ary).\"',\";\n                }else{\n                    $b.=current($ary).\",\";\n                }\n                next($ary);\n            }\n            $categories=rtrim($b,\",\");\n        }\n    }\n\n    //\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $rss_img=$_DATABOX_CONF['rss_img'];\n    if ($rss_img==\"\") {\n        $rss_img=\"[RSS]\";\n    }\n\n    if (is_null($thtml)){\n        $thtml=\"default\";\n    }\n\n//-------------------------------------------\n    $retval=\"\";\n\n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath('newlist',$thtml,$pi_name);\n\n    $list = new Template($tmplfld);\n    $list->set_file (array (\n        'list' => 'list.thtml',\n        'col'   => 'list_col.thtml'\n    ));\n\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n\n    //-----\n    $tbl1=$_TABLES['DATABOX_base'] ;\n    $tbl2=$_TABLES['DATABOX_category'] ;\n    $tbl3=$_TABLES['DATABOX_def_category'] ;\n\n\n    $sql=\"SELECT \".LB;\n    $sql.=\" t1.title\".LB;\n    $sql.=\" , UNIX_TIMESTAMP(t1.\".$datefield .\") AS day\".LB;\n    $sql.=\" , t1.id\".LB;\n    $sql.=\" , t1.code\".LB;\n    $sql.=\" , t1.description\".LB;\n\n    $sql.=\" ,t1.owner_id\".LB;\n    $sql.=\" ,t1.group_id\".LB;\n    $sql.=\" ,t1.perm_owner\".LB;\n    $sql.=\" ,t1.perm_group\".LB;\n    $sql.=\" ,t1.perm_members\".LB;\n    $sql.=\" ,t1.perm_anon\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    if ($categories!==\"ALL\" ){\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql.=\" WHERE\";\n    if ($categories===\"ALL\" ){\n        $sql.=\" 1=1\";\n    }else{\n        $sql.= \" t1.id = t2.id \".LB;\n        $sql.= \" AND t2.category_id = t3.category_id \".LB;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t1.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  ($_DATABOX_CONF['disable_permission_ignore']==\"0\" AND strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n\n    if ($intervalday<>0){\n        $sql.=\" AND (\".$datefield .\" >= (date_sub(NOW(), INTERVAL $intervalday day)))\".LB;\n    }\n\n    if ($categories!==\"ALL\" ){\n        if ($m===\"id\") {\n            $sql.=\" AND t2.category_id IN ($categories)\";\n        }else{\n            $sql.=\" AND t3.code IN ($categories)\";\n        }\n    }\n\n    $sql .= COM_getLangSQL ('code', 'AND', 't1').LB;\n\n    $sql.=\" ORDER BY \".$datefield .\" DESC\";\n    $sql.=\" LIMIT $limitcnt\";\n\n    $result = DB_query ($sql);\n\n    $i=0;\n\n    while( $A = DB_fetchArray( $result ) )    {\n        $A = array_map('stripslashes', $A);\n\n        $title= COM_truncate( $A['title'], $title_trim_length,'...' );\n        $description = $A['description'];\n        $id = $A['id'];\n        $code = $A['code'];\n\n        $rt= databox_detail_link($id,$code,$title);\n\n        $list->set_var ('site_url', $_CONF['site_url']);\n\n        $list->set_var ('day', strftime($LANG_DATABOX['day'],$A['day']));\n\n        $chkday=strtotime(\"- $newmarkday days\",time());\n        if (date(\"Ymd\",$A['day']) >= date(\"Ymd\",$chkday)){\n            $list->set_var ('new_img', $new_img);\n        }else{\n            $list->set_var ('new_img', '');\n        }\n        $list->set_var ('link', $rt['link']);//@@@@@\n\n        $list->set_var ('url', $rt['url']);\n        $list->set_var ('title', $title);\n\n\t\t$list->set_var ('description', $description);\n\n        $permission=SEC_hasAccess2($A);\n        $list->set_var ('permission',$permission);\n        if  ($permission>=2){\n            $list->set_var ('class_a', 'class=\"gl-tooltip\"');\n            $list->set_var ('class_c', 'class=\"classic\"');\n        }else{\n            $list->set_var ('class_a', 'class=\"databox_nolink\"');\n            $list->set_var ('class_c', 'class=\"databox_displaynon\"');\n        }\n\n\n        $n=($i%2)+1;\n        $class='class=\"row'.$n.'\"';\n        $list->set_var ('class', 'class=\"row'.$n.'\"');\n\n        //\u30ab\u30c6\u30b4\u30ea\n        DATABOX_getcategoriesDisp($A['id'],$list,$chk_user,0,$pi_name);\n\n        $list->parse ('list_col', 'col', true);\n\n        $i++;\n    }\n\n    $list->set_var ('site_url', $_CONF['site_url']);\n    $list->set_var ('day', strftime($LANG_DATABOX['day'],$A['day']));\n\n    //\n    if ($rss_file<>\"\"){\n        $list->set_var ('rss_url', $_CONF['site_url'] . '/backend/'.$rss_file);\n        $list->set_var ('rss_title', $rss_img);\n    }\n    //\n    $more_title=$LANG_DATABOX['more'];\n    if ($categories===\"ALL\" OR strpos($categories,\",\")<>\"\") {\n        $more_url=COM_buildUrl($_CONF['site_url'] . '/databox/index.php');//\n    }else{\n        //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n        if ($m=\"code\"){\n            $more_url.=\"m=code\";\n            $more_url.=\"&amp;code=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }else{\n            $more_url.=\"m=id\";\n            $more_url.=\"&amp;id=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }\n        $more_url=$_CONF['site_url'] . \"/databox/index.php\".$more_url;//@@@@@\n    }\n\n    $more_url = COM_buildUrl( $more_url );\n    $more_link= COM_createLink($title, $more_url);\n    $list->set_var ('more_url', $more_url);\n    $list->set_var ('more_title', $more_title);\n\n    $list->parse ('output', 'list');\n    $retval .= $list->finish ($list->get_var ('output'));\n\n\n    return $retval;\n}\n\n\n// | \u66f8\u5f0f databox_order ($url, $templates, $order)\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd ORDER\u6307\u5b9aLINK\u51fa\u529b\n// | \u66f8\u5f0f databox_order()\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $url:\n// | \u5f15\u6570 $templates\n// | \u5f15\u6570 $cur_order:\n// +---------------------------------------------------------------------------+\nfunction databox_order(\n    $url=\"\"\n    ,$templates\n    ,$cur_order=\"id\"\n\n)\n{\nglobal $LANG_DATABOX_ORDER;\nglobal $_TABLES;\n\n    $templates->set_var('cur_order',$cur_order);\n\n\n    $order_ary=array();\n    $order_ary[]='random';\n    $order_ary[]='date';\n    $order_ary[]='orderno';\n    $order_ary[]='code';\n    $order_ary[]='title';\n    $order_ary[]='description';\n    $order_ary[]='id';\n    $order_ary[]='released';\n\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",templatesetvar\";\n    $sql.=\" FROM\";\n    $sql.=\" {$_TABLES['DATABOX_def_field']} \";\n    $sql.=\" where allow_display=0\";\n\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $addfield_ary=array();\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=COM_stripslashes($A['field_id']);\n        $addfield_ary[$field_id]['name']=COM_stripslashes($A['name']);\n        $addfield_ary[$field_id]['templatesetvar']=COM_stripslashes($A['templatesetvar']);\n        $order_ary[]=\"addfield\".$field_id;\n    }\n\n    for ($i = 1; $i <= count($order_ary); $i++) {\n        $c=current($order_ary);\n\n        if (substr($c,0,8)===\"addfield\"){\n            $field_id=substr($c,8);\n            $order=$addfield_ary[$field_id]['templatesetvar'];\n            $order_name=$addfield_ary[$field_id]['name'];\n            $order_name.=$LANG_DATABOX_ORDER['order'];\n        }else{\n            $order=$c;\n            $order_name=$LANG_DATABOX_ORDER[$c];\n        }\n\n        $order_url=$url;\n        $order_url.=$order;\n        //$order_url = COM_buildUrl( $order_url );\n        $rt= COM_createLink($order_name, $order_url);\n\n        $templates->set_var('order_'.$order,$rt);\n\n        next($order_ary);\n    }\n\n\n    return ;\n\n\n}\n\nfunction databox_datalink(\n    $id\n    ,$code\n    ,$linktext\n)\n{\n    global $_CONF;\n    global $_TABLES;\n    \n    $url=\"\";\n    if ($id<>\"\") {\n        $url=$_CONF['site_url'].\"/databox/data.php?\";\n        $url.=\"m=id&amp;id=\".$id;\n        if  ($linktext==\"\"){\n            $linktext = stripslashes(DB_getItem($_TABLES['DATABOX_base'],'title', \"id = '$id'\"));\n        }\n    }else if ($code<>\"\"){\n        $code=DATABOX_swichlang($code);\n        $url=$_CONF['site_url'].\"/databox/data.php?\";\n        $url.=\"code=\".$code;\n        $url.=\"&amp;m=code\";\n        if  ($linktext==\"\"){\n            $linktext = stripslashes(DB_getItem($_TABLES['DATABOX_base'],'title', \"code = '$code'\"));\n        }\n    }\n    if  ($url<>\"\"){\n        $url = COM_buildUrl($url);\n        $url = COM_createLink($linktext, $url);\n    }\n    return $url;\n}\n\nfunction databox_mydataentrylink(\n    $fieldset_id = \"\"\n    ,$templatedir =\"\"\n    ,$linktext =\"\"\n)\n{\n    global $_CONF;\n    global $_TABLES;\n    global $LANG_DATABOX_ADMIN;\n    global $_DATABOX_CONF;\n    \n    $url=\"\";\n    //\u30e6\u30fc\u30b6\u306b\u66f4\u65b0\u3068\u65b0\u898f\u767b\u9332\u3092\u8a31\u53ef\u3059\u308b\u304b\u307e\u305f\u306f\u3001\u65b0\u898f\u767b\u9332\u6a29\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u306e\u5834\u5408\n    if ($_DATABOX_CONF['allow_data_update'] AND $_DATABOX_CONF['allow_data_insert'] OR\n        SEC_hasRights('databox.submit')){\n        if ($fieldset_id==\"\" OR $fieldset_id==0) {\n            $url=$_CONF['site_url'].\"/databox/mydata/data.php?\";\n            $url.=\"mode=new\";\n            if  ($templatedir){\n                $url.=\"&amp;template=\".$templatedir;\n            }\n            if  ($linktext==\"\"){\n                $linktext = $LANG_DATABOX_ADMIN[\"new\"];\n            }\n        }else{\n            if (DB_getItem($_TABLES['DATABOX_def_fieldset'],'fieldset_id', \"fieldset_id = '$fieldset_id'\")==$fieldset_id){\n                $url=$_CONF['site_url'].\"/databox/mydata/data.php?\";\n                $url.=\"type_id=\".$fieldset_id;\n                if  ($templatedir){\n                    $url.=\"&amp;template=\".$templatedir;\n                }\n                if  ($linktext==\"\"){\n                    $linktext = stripslashes(DB_getItem($_TABLES['DATABOX_def_fieldset'],'name', \"fieldset_id = '$fieldset_id'\"));\n                }\n            }\n        }\n        $url = COM_createLink($linktext, $url);\n    }\n    return $url;\n}\nfunction databox_mydata(\n    $templatedir =\"\"\n    ,$linktext =\"\"\n)\n{\n    global $_CONF;\n    global $_TABLES;\n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    $url=\"\";\n    //\u30e6\u30fc\u30b6\u306b\u66f4\u65b0\u3092\u8a31\u53ef\u3059\u308b\u304b\u307e\u305f\u306f\u3001\u66f4\u65b0\u6a29\u3092\u6301\u3063\u305f\u30e6\u30fc\u30b6\u306e\u5834\u5408\n    if ($_DATABOX_CONF['allow_data_update'] OR SEC_hasRights('databox.edit')){\n        $url=$_CONF['site_url'].\"/databox/mydata/data.php?\";\n        if  ($templatedir){\n            $url.=\"&amp;template=\".$templatedir;\n        }\n        if  ($linktext==\"\"){\n            $linktext = $LANG_DATABOX['mydata'];\n        }\n        $url = COM_createLink($linktext, $url);\n    }\n    return $url;\n}\nfunction databox_Comment(\n    $id\n    ,$code\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u30b3\u30e1\u30f3\u30c8\u8868\u793a\n// | \u66f8\u5f0f databox_Comment($id,$code)\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n    //    \n    $order = '';\n    if (isset ($_REQUEST['order'])) {\n        $order = COM_applyFilter ($_REQUEST['order']);\n    }\n    $mode = '';\n    if (isset ($_REQUEST['mode'])) {\n        $mode = COM_applyFilter ($_POST['mode']);\n    }\n    \n    $page = 1;\n    if (isset ($_REQUEST['cpage'])) {\n        $page = COM_applyFilter ($_REQUEST['cpage']);\n    }\n    //\n    \n    $tbl=$_TABLES['DATABOX_base'] ;\n\n    //-----\n    $sql = \"SELECT \";\n    \n    $sql .= \"commentcode \"; \n    $sql .= \",owner_id\";\n    $sql .= \",group_id\";\n    $sql .= \",perm_owner\";\n    $sql .= \",perm_group\";\n    $sql .= \",perm_members\";\n    $sql .= \",perm_anon\";\n    $sql .= \",title\";\n    $sql .= \",id\";\n\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl} AS t \";//base\n    $sql .= \" WHERE \";\n    if   ($id<>0) {\n        $sql .= \" id=\".$id;\n    }else{\n        $sql .= \" code='\".$code.\"'\";\n    }\n    $sql .= \" AND t.draft_flag=0\".LB;\n    \n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\";\n\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    //\n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    \n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n        if  ($A['commentcode']>=0){\n            $delete_option = (SEC_hasRights('databox.edit') &&\n                    SEC_hasAccess($A['owner_id'], $A['group_id'],\n                    $A['perm_owner'], $A['perm_group'], $A['perm_members'],\n                    $A['perm_anon']) == 3 ? true : false);\n    \n            require_once $_CONF['path_system'] . 'lib-comment.php';\n            $retval .= CMT_userComments(\n                            $A['id']\n                            , $A['title']\n                            , 'databox'\n                            , $order\n                            , $mode\n                            , 0\n                            , $page\n                            , false\n                            , $delete_option\n                            , $A['commentcode']\n                            );\n        }\n    }\n    \n\n    return $retval;\n}\n\nfunction databox_detail_link(\n    $id\n    ,$code\n    ,$title\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u500b\u5225\u30c7\u30fc\u30bflink\n// | \u66f8\u5f0f  databox_detail_link($id,$code,$title);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id            :\n// | \u5f15\u6570 $code          :\n// | \u5f15\u6570 $title         :\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:$return['link'] $return['url']\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_DATABOX_CONF;\n    \n    $return['link']=\"\" ;\n    $return['url']=\"\" ;\n    \n    if  ($id==0  AND $code==\"\"){\n        return $return;\n    }\n    if  ($_DATABOX_CONF['detail']==\"\"){\n        $prg=\"data.php\";\n    }else{\n        $prg=$_DATABOX_CONF['detail'];\n    }\n    \n    $url=$_CONF['site_url'] . \"/databox/\".$_DATABOX_CONF['detail'];\n    $url.=\"?\";\n    \n    if  ($prg==\"data.php\"){\n        if ($_DATABOX_CONF['datacode'] OR $id==0){\n            $url.=\"code=\".$code;\n            $url.=\"&amp;m=code\";\n        }else{\n            $url.=\"id=\".$id; \n            $url.=\"&amp;m=id\";\n        }\n    }else{\n        if  ($code<>\"\"){\n            $url.=\"code=\".$code;\n        }\n\t}\n    $return['url']=  COM_buildUrl( $url );\n    $return['link']= COM_createLink($title, $return['url']);\n    return $return;\n}\n\nfunction databox_search(\n    $autotag\n    ,$argary\n)\n{\n\n    $pi_name=\"databox\";\n    \n    global $_CONF;\n    global $_TABLES;\n    \n    global $_DATABOX_CONF;\n    global $LANG_DATABOX;\n    global $LANG_DATABOX_ADMIN;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n    global $_PLUGINS;\n    global $_MAPS_CONF;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_DATABOX_CONF['loginrequired'] >1) ){\n            return $LANG_DATABOX['loginrequired'];\n        }\n    }\n          \n    if (! defined('THIS_SCRIPT')) {\n        define ('THIS_SCRIPT', 'databox/search.php');\n    }\n          \n    //-----\u30c6\u30fc\u30d6\u30eb\n    $tbl1=$_TABLES['DATABOX_category'] ;\n    $tbl2=$_TABLES['DATABOX_base'] ;\n    $tbl3=$_TABLES['DATABOX_addition'] ;\n    //\n    $tbl5=$_TABLES['DATABOX_def_category'] ;\n    \n    $tbl6=$_TABLES['DATABOX_stats'];\n    $tbl7=$_TABLES['DATABOX_def_fieldset'];\n\n    //\n    $datefield=$_DATABOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\u3001\u516c\u958b\u65e5\uff09\n    $new_img=$_DATABOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_DATABOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n    \n    //-----Argument checking\u3000\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    $arg_sv=\"\";//---Argument save \u5f15\u6570\u9000\u907f\u3000order page \u3092\u9664\u304f\n    foreach((array)$argary as $key => $value) {\n        if (is_array($value)){\n            $ary=$value;\n            foreach($ary as $key2 => $value2){\n                if  ($arg_sv<>\"\"){\n                    $arg_sv.=\"&amp;\";\n                }\n                $arg_sv.=$key.\"[]=\".$value2;\n            }\n        }else{\n            if  ($key==\"order\"  OR $key==\"page\"){\n            }else{\n                if  ($arg_sv<>\"\"){\n                    $arg_sv.=\"&amp;\";\n                }\n                $arg_sv.=$key.\"=\".$value;\n            }\n        }\n    }\n    if  ($argary['fieldset_id']==\"\"){\n        $argary['fieldset_id']=0;\n    }\n    $fieldset_name=COM_applyFilter(DB_getItem( $tbl7 ,\"name\",\"fieldset_id={$argary['fieldset_id']}\"));\n\n    if ($argary['perpage']===0 OR is_null($argary['perpage'])){\n        $argary['perpage']=$_DATABOX_CONF['perpage'];\n    }\n    if ($argary['page']===0 OR is_null($argary['page'])){\n        $argary['page']=1;\n    }\n    if (is_null($argary['nohitmsg'])){\n        $argary['nohitmsg']=\"yes\";\n    }\n    if (is_null($argary['expired'])){\n        $argary['expired']=\"no\";\n    }\n    if (is_null($argary['order'])){\n        $argary['order']=\"date\";\n    }\n    //============\n    $cary=array();\n    $acnt=0;\n    $afield=array();\n    $afile=array();\n    $awhere=array();\n          \n    foreach((array)$argary as $key => $value) {\n        if (is_array($value)){\n            $k = explode ('_', $key);\n            $ids=\"\";\n            $ary=$value;\n            if  ($k[0]==\"gor\"){\n                foreach($ary as $key2 => $value2){\n                    $w= COM_applyFilter($value2);\n                    if  ($w<>\"\"){\n                        if ($ids<>\"\"){\n                            $ids.=\",\";\n                        }\n                        $ids.= COM_applyFilter($value2);\n                    }\n                }\n                if  ($ids<>\"\"){\n                    $cary[]= \"(t2.id IN (SELECT id FROM {$tbl1}\"\n                           .\" WHERE t2.id=id AND category_id IN ({$ids})) )\";\n                }\n            }else if ($k[0]==\"gand\"){\n                foreach($ary as $key2 => $value2){\n                    $w= COM_applyFilter($value2);\n                    if  ($w<>\"\"){\n                        if ($ids<>\"\"){\n                            $ids.=\" AND \";\n                        }\n                        $ids.= $w;\n                        $ids.= \" IN (SELECT category_id\";\n                        $ids.=\" FROM {$tbl1}  \";\n                        $ids.=\" WHERE t2.id = id )\";\n                    }\n                }\n                if  ($ids<>\"\"){\n                    $cary[]= \" (\" .$ids.\" ) \";\n                }\n            }else if ($k[0]==\"ams\"){\n                foreach($ary as $key2 => $value2){\n                    $w= COM_applyFilter($value2);\n                    if  ($w<>\"\"){\n                        if ($ids<>\"\"){\n                            $ids.=\",\";\n                        }\n                        $ids.= COM_applyFilter($value2);\n                    }\n                }\n                if  ($ids<>\"\"){\n                    $dummy= databox_searchfield($k[0],COM_applyFilter($k[1]),$ids,$acnt,$afield,$afile,$awhere);\n                }\n            }\n        }else if  ( substr($key,0,3)==\"aeq\" OR substr($key,0,3)==\"afr\" \n                              OR substr($key,0,3)==\"ato\" OR substr($key,0,1)==\"a\") {\n            $k = explode ('_', $key);\n\n            if  ($value<>\"\"){\n                $dummy= databox_searchfield($k[0],COM_applyFilter($k[1]),$value,$acnt,$afield,$afile,$awhere);\n            }\n        }\n    }\n\n    $dummy=databox_orderby($datefield,$argary['order'],$orderby,$addfieldorder,$field_id);\n\n    //-----\n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.title \".LB;\n    $sql .= \" ,t2.code \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.fieldset_id \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\".LB;\n    $sql .= \" ,t2.owner_id\".LB;\n          \n    if  ($acnt>0){\n        for ($i = 1; $i <= $acnt; $i++) {\n             $sql .= $afield[$i].LB;\n        }\n    }\n          \n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n    \n    //--FROM\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n          \n    if  ($acnt>0){\n        for ($i = 1; $i <= $acnt; $i++) {\n             $sql .= $afile[$i].LB;\n        }\n    }\n    \n    //--WHERE\n    $sql .= \" WHERE \".LB;\n                \n    //\u30bf\u30a4\u30d7\n    $sql .= \" t2.fieldset_id=\".$argary['fieldset_id'].LB;\n          //additionfield \u8ffd\u52a0\u9805\u76ee\u3067sort \u3059\u308b\u6642\n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$field_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n\n    //\u6761\u4ef6\n    if  ($argary['teq']<>\"\"){\n        $sql .= \" AND (title=\".\"'\".$argary['teq'].\"')\".LB;\n    }\n    if  ($argary['t']<>\"\"){\n        $sql .= \" AND (title LIKE '%\".$argary['t'].\"%')\".LB;\n    }\n    foreach((array)$cary as $value) {\n        $sql .= \" AND \".$value.LB;\n    }\n    if  ($acnt>0){\n        for ($i = 1; $i <= $acnt; $i++) {\n            $sql .= \" AND \".$awhere[$i].LB;\n        }\n    }\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u3092\u9664\u304f\n    $sql .= \" AND t2.draft_flag=0\".LB;\n\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    if  (strtoupper($argary['expired'])==\"NO\"){\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    //--ORDER\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n\n//echo \"sql=\".$sql.\"<br>\";    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($argary['perpage'] > 0) {\n        $pages = ceil($cnt / $argary['perpage']);\n    }\n    $offset = ($argary['page'] - 1) * $argary['perpage'];\n    $sql .= \" LIMIT $offset, \".$argary['perpage'];\n          \n          \n          \n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n\n        if ($argary['page'] > 1) {\n            $page_title = sprintf ('%s (%d)', $LANG_DATABOX_ADMIN['piname'], $argary['page']);\n        } else {\n            $page_title = sprintf ('%s ', $LANG_DATABOX_ADMIN['piname']);\n        }\n        // Meta Tags\n        $title=$_CONF['site_name'] .\"-\". $fieldset_name;//og_title\n        $description=$_CONF['meta_description'];//og_description\n        $keywords=$_CONF['meta_keywords'];//og_description\n        //meta \n        $headercode=DATABOX_getheadercode(          \n           \"search\"\n            ,$argary['templatedir']\n            ,$pi_name\n            ,\"\"\n            ,$title\n            ,$description\n            ,$keywords\n            ,$description\n            ,\"\"\n            ,\"\"\n            ,\"\"\n            ,$argary['fieldset_id']\n            ,$fieldset_name\n                    );\n          }\n          \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n\n    if ($numrows > 0) {\n        $tmplfld=DATABOX_templatePath('search',$argary['templatedir'],$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'arg'   => 'argument.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            ));\n        \n        $dummy=databox_searchargedit($argary,$templates);\n        \n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n\n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_DATABOX['home']);\n        \n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$argary['perpage'] - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_DATABOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        //\n        $templates->set_var ('lang_title', $LANG_DATABOX_ADMIN['title']);\n        $templates->set_var ('lang_code', $LANG_DATABOX_ADMIN['code']);\n        $templates->set_var ('lang_id', $LANG_DATABOX_ADMIN['id']);\n        $templates->set_var ('lang_description', $LANG_DATABOX_ADMIN['description']);\n        $templates->set_var ('lang_date', $LANG_DATABOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_DATABOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        // \u8ffd\u52a0\u9805\u76ee\u306e\u30d8\u30c3\u30c0\n        $addition_def=DATABOX_getadditiondef($pi_name);\n        \n        //\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['databox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['databox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_DATABOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n        $referer =$_SERVER['HTTP_REFERER'];\n        $templates->set_var ('referer', $referer);\n        $templates->set_var ('lang_referer',$LANG_DATABOX['return']);\n        $templates->set_var ('fieldset_name',$fieldset_name);\n        $mkids=\"\";\n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $title=$A['title'];\n            $description=$A['description'];\n            $code=COM_applyFilter($A['code']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n\n            \n            $value=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n\n            $url=$_CONF['site_url'] . \"/databox/data.php\";\n            $url.=\"?\";\n            //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n            if ($_DATABOX_CONF['datacode']){\n                $url.=\"code=\".$code;\n                $url.=\"&amp;m=code\";\n            }else{\n                $url.=\"id=\".$id;\n                $url.=\"&amp;m=id\";\n            }\n            $url = COM_buildUrl( $url );\n            $link= COM_createLink($title, $url);\n\n            $templates->set_var ('data_link', $link);\n            $templates->set_var ('data_title', $title);\n            $templates->set_var ('data_code', $code);\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $url);\n\n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $value);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_date', strftime( $_CONF['date'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_daytime', strftime( $_CONF['daytime'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_dateonly', strftime( $_CONF['dateonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_timeonly', strftime( $_CONF['timeonly'], $A['datefield_un'] ));\n            $templates->set_var ('data_datefield_b', strftime( \"%b\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_B', strftime( \"%B\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_d', strftime( \"%d\" , $A['datefield_un']));\n            $templates->set_var ('data_datefield_e', strftime( \"%e\" , $A['datefield_un']));\n            \n            $templates->set_var ('data_released', $released_ary[0]);\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            $hits=COM_applyFilter(DB_getItem( $tbl6 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_DATABOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            \n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/databox/data.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyData\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_DATABOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_DATABOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_DATABOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/mydata/data.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n             }\n             //maps plugin link\n             $mkid=\"\";\n             if (in_array(\"maps\", $_PLUGINS)){\n                 if ($code<>\"\"){\n                     $mkid=DB_getItem($_TABLES['maps_markers'],\"mkid\",\"item_10='$code'\");\n                     if  ($mkid<>\"\"){\n                         $mkids.=$mkid.\" \";\n                     }\n                 }\n             }\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        $mkids=rtrim($mkids,\" \");\n        $mkidary=array();\n        $mkid_ary=split(\" \" , $mkids);\n        $selectedMarkers=\"\";\n        if (function_exists(\"MAPS_selectedMarkers\") AND $mkids<>\"\") {\n            $selectedMarkers=MAPS_selectedMarkers(\n              $_MAPS_CONF['map_width']\n             ,$_MAPS_CONF['map_height']\n             ,$_MAPS_CONF['map_zoom']\n             ,$mkid_ary);\n        }\n        $templates->set_var ('mkids', $mkids);\n        $templates->set_var ('selectedMarkers', $selectedMarkers);\n\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'databox', $templates );\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        $url.=THIS_SCRIPT;\n        $url.=\"?\";\n        $url.=$arg_sv;\n        $url .= \"&amp;order=\";\n        //-----order navigation\n        $dummy=databox_order ($url, $templates, $argary['order']) ;\n        //-----page navigation\n        $url .= $argary['order'];\n        $templates->set_var ('page_navigation',\n        COM_printPageNavigation ($url,$argary['page'], $pages));\n        $templates->set_var ( 'pagenavinone', '' );\n        //------------\n        $templates->parse ('arg_var', 'arg', true);\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n\n    }else{\n        if ($argary['nohitmsg']===\"yes\"){\n            $tmplfld=DATABOX_templatePath('search',$argary['templatedir'],$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n                'arg'   => 'argument.thtml',\n            ));\n\n            $dummy=databox_searchargedit($argary,$templates);\n            \n            $templates->set_var ('home',$LANG_DATABOX['home']);\n            $referer =$_SERVER['HTTP_REFERER'];\n            $templates->set_var ('referer', $referer);\n            $templates->set_var ('lang_referer',$LANG_DATABOX['return']);\n            $templates->set_var ('fieldset_name',$fieldset_name);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_DATABOX['nohit']);\n\n            $templates->parse ('arg_var', 'arg', true);\n            \n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n        }\n    }\n\n    if ($autotag===\"notautotag\"){\n\n        $retval[\"pagetitle\"] =$pagetitle;\n        $retval[\"headercode\"] =$headercode;\n        $retval[\"display\"] =PLG_replacetags ($content);\n          }else{\n        $retval=PLG_replacetags ($content);\n          }\n    return $retval;\n} \n\n\nfunction databox_searcharg(\n    $autotag\n    ,$arg\n)\n{\n    if ($autotag===\"notautotag\"){\n        foreach((array)$arg as $key => $value){\n            $key=COM_applyFilter($key);\n            if  ($key<>\"\"){\n                if  (is_array($value)  ) {\n                    foreach($value as $key2 => $value2){\n                       $argary[$key][]=COM_applyFilter($value2);\n                    }\n                }else{\n                    if  ($key==\"fieldset\") {\n                        $argary['fieldset_id']=COM_applyFilter($value);\n                    }\n                    $argary[$key]=COM_applyFilter($value);\n                }\n            }\n        }\n    }else{\n        $ary = explode ('&', $arg);\n        $argary = array();\n        foreach($ary as $key => $value){\n            $k = explode ('=', $value);\n            $k0= COM_applyFilter($k[0]);\n            $k1= COM_applyFilter($k[1]);\n            if  ($k0<>\"\"){\n                if  ($k0==\"fieldset\") {\n                    $argary['fieldset']=$k1;\n                    $argary['fieldset_id']=$k1;\n                }else if  ( substr($k0,0,3)==\"gor\" OR substr($k0,0,4)==\"gand\" OR substr($k0,0,3)==\"ams\" ) {\n                    $argary[$k0][]=$k1;\n                }else {\n                    $argary[$k0]=$k1;\n                }\n            }\n        }\n    }\n\n    return $argary;\n}\n\n\nfunction databox_searchfield(\n    $operate\n    ,$field_id\n    ,$value\n    ,&$acnt\n    ,&$afield\n    ,&$afile\n    ,&$awhere\n\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u306e\u6761\u4ef6 \u3092\u7de8\u96c6\n// | \u66f8\u5f0f  databox_searchfield($operate,$field_id,$value,$acnt,$afield,$afile,$awhere);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $operate\n// | \u5f15\u6570 $field_id\n// | \u5f15\u6570\u623b\u5024 $acnt\n// | \u5f15\u6570\u623b\u5024 $afield\n// | \u5f15\u6570\u623b\u5024 $afile\n// | \u5f15\u6570\u623b\u5024 $awhire\n// +---------------------------------------------------------------------------+\n\n{\n    global $_TABLES;\n          \n    $return=false;\n          \n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",type \";\n    $sql.=\" FROM\";\n    $sql.=\" {$_TABLES['DATABOX_def_field']} \";\n    $sql.=\" WHERE field_id=\".$field_id;\n    // \u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u307f\n    $sql.=\" AND allow_display='0'\";\n    if  ($operate==\"ams\"){\n        //9:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n        //16:\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n        //18:\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n        $sql.=\" AND type IN (9,16,18)\";\n    }else{\n        //0: \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        //1: \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        //20:HTML  10:TinyMCE 19:CKEditor\n        //15:\u6570\u5024  21:\u901a\u8ca8\n        $sql.=\" AND type IN (0,1,10,19,20,15,21)\";\n    }\n          \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows>0){\n       $A = DB_fetchArray ($result);\n       $acnt=$acnt+1;\n       $afield[$acnt]=\" ,a\".$acnt.\".value AS value\".$acnt;\n       $afile[$acnt]=\" ,{$_TABLES['DATABOX_addition']} AS a\".$acnt;\n       $w=\"a\".$acnt.\".field_id=\".$field_id;\n       $w.=\" AND a\".$acnt.\".id=t2.id\";\n       if  ($operate==\"aeq\"){\n           $w.=\" AND a\".$acnt.\".value='\".$value.\"'\";\n       }else if ($operate==\"a\"){\n            $w.=\" AND a\".$acnt.\".value LIKE '%\".$value.\"%'\";\n       }else if ($operate==\"afr\"){\n           if  ($A['type']==15  OR $A['type']==21){\n                $w.=\" AND (a\".$acnt.\".value + 0) >='\".$value.\"'\";\n           }else{\n                $w.=\" AND a\".$acnt.\".value>='\".$value.\"'\";\n           }\n       }else if ($operate==\"ato\"){\n           if  ($A['type']==15  OR $A['type']==21){\n               $w.=\" AND (a\".$acnt.\".value + 0) <='\".$value.\"'\";\n           }else{\n               $w.=\" AND a\".$acnt.\".value<='\".$value.\"'\";\n           }\n       }else if ($operate==\"ams\"){\n            $w.=\" AND a\".$acnt.\".value  IN  ({$value})\";\n       }\n       $awhere[$acnt]=$w;\n       $return=true;\n    }\n\n    return ;\n\n}\nfunction databox_searchargedit(\n    $arg\n    ,&$templates\n)\n{\n    global $LANG_DATABOX;\n    global $_CONF;\n    global $_TABLES;\n    \n    $rt=\"\";\n    $templates->set_var ('site_url',$_CONF['site_url']);\n    $templates->set_var ('this_script',THIS_SCRIPT);\n    $templates->set_var (\"lang_search\",$LANG_DATABOX['search']);\n    foreach((array)$arg as $key => $value) {\n        if (is_array($value)){\n            $k = explode ('_', $key);\n            $ary=$value;\n            if  ($k[0]==\"gor\"  OR  $k[0]==\"gand\"){\n                $wnames=\"\";\n                foreach($ary as $key2 => $value2){\n                    $key2p1=$key2+1;\n                    $w= COM_applyFilter($value2);\n                    $ary[$key2]=$w;\n                    $templates->set_var ($key.\"_\".$key2p1.\"_id\",$w);\n                    if  ($w<>\"\"){\n                        $wname=COM_applyFilter(\n                        DB_getItem($_TABLES['DATABOX_def_category'] \n                            ,\"name\",\"category_id={$w}\"));\n                            $wnames.=$wname.\" \";\n                    }else{\n                        $wname=\"\";\n                    }\n                    $templates->set_var ($key.\"_\".$key2p1.\"_name\",$wname);\n                }\n                $checklist=DATABOX_getcheckList (\"categorygroup\",$ary,\"databox\",$k[1],$key);\n                $templates->set_var ($key,$checklist);\n                $templates->set_var ($key.\"_names\",$wnames);\n            }else if  ($k[0]==\"ams\" ){\n                $kind=COM_applyFilter(\n                DB_getItem($_TABLES['DATABOX_def_field'] \n                     ,\"selectlist\",\"field_id={$k[1]}\"));\n                $wnames=\"\";\n                foreach($ary as $key2 => $value2){\n                    $key2p1=$key2+1;\n                    $w= COM_applyFilter($value2);\n                    $ary[$key2]=$w;\n                    $templates->set_var ($key.\"_\".$key2p1.\"_no\",$w);\n                    if  ($w<>\"\"){\n                         $wname=COM_applyFilter(\n                         DB_getItem($_TABLES['DATABOX_mst'] \n                             ,\"value\",\"kind='{$kind}' AND no={$w}\"));\n                                                            $wnames.=$wname.\" \";\n                     }else{\n                         $wname=\"\";\n                     }\n                     $templates->set_var ($key.\"_\".$key2p1.\"_name\",$wname);\n                }\n                $checklist=DATABOX_getcheckList ($kind,$ary,\"databox\",$k[1],$key);\n                $templates->set_var ($key,$checklist);\n                $templates->set_var ($key.\"_names\",$wnames);\n            }\n        }else if ($value<>\"\"){\n            $w=COM_applyFilter($value);\n            $templates->set_var ($key,$w);\n        }\n    }\n\n    return ;\n}\n\n?>\n", "<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | DataBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | Box \u30b7\u30ea\u30fc\u30ba\u5171\u901a\n// +---------------------------------------------------------------------------+\n// $Id: plugins/databox/lib/databox_functions.inc\n//20100818 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n\nif (strpos ($_SERVER['PHP_SELF'], 'databox_functions.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n\n//==============================================================================\nfunction DATABOX_nl2br (\n    $text\n) \n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u6539\u884c\u3092BR\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_nl2br ($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text:\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6539\u884c\u3092BR\u306b\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u6539\u884c\u3092BR\u306b\u5909\u63db\"\n{\n    return PLG_replacetags ( str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '<br'.XHTML.'>', $text) );\n\n}\n\nfunction DATABOX_autolink (\n    $text\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd url\u3092\u30ea\u30f3\u30af\u5909\u63db\n// | \u66f8\u5f0f DATABOX_autolink($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text         :\u6587\u5b57\u5217                                                |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:url\u3092\u30ea\u30f3\u30af\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217                                       |\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u81ea\u52d5\u30ea\u30f3\u30af\u3092\n{\n    $patterns = array(\"/(https?|ftp)(:\\/\\/[[:alnum:]\\+\\$\\;\\?\\.%,!#~*\\/:@&=_-]+)/i\");\n    $replacements = array(\"<a href=\\\"\\\\1\\\\2\\\" target=\\\"_blank\\\">\\\\1\\\\2</a>\");\n    return preg_replace($patterns, $replacements, $text);\n}\n\nfunction DATABOX_codetoid(\n    $code\n    ,$table\n    ,$idname = \"id\"\n    ,$codename = \"code\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u3092id\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_codetoid($code,'DATABOX_base')\n// | \u66f8\u5f0f DATABOX_codetoid($code,'users',\"uid\",\"username\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $table\n// | \u5f15\u6570 $idname\n// | \u5f15\u6570 $codename\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:id\n// +---------------------------------------------------------------------------+\n//update20101125\n{\n    global $_TABLES;\n    $retval=DB_getItem( $_TABLES[$table]   ,$idname,$codename.\"='{$code}'\");\n    if (empty($retval)){\n        $retval=0;\n    }\n    return $retval;\n}\n\nfunction DATABOX_swichlang(\n\t$code\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u591a\u8a00\u8a9e\u5bfe\u5fdc\u5909\u63db\n// | \u66f8\u5f0f DATABOX_swichlang($code)\n// |      xxxx_(\u8a00\u8a9eid) \u591a\u8a00\u8a9e\u30e2\u30fc\u30c9\u306e\u6642\u306b\u5fc5\u8981\u304c\u3042\u308c\u3070\u8a00\u8a9eid\u3092\u73fe\u5728\u306e\u8a00\u8a9eid\u306b\u5909\u63db\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u5909\u63db\u5f8c\u306e\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n{\n    \n    global $_CONF;\n    $newlanguageid = COM_getLanguageId();\n    if  ($newlanguageid<>\"\"){\n        if  ($code<>\"\"){\n            $lang_len = strlen($newlanguageid);\n            $oldlanguageid=substr($code,-($lang_len));\n            if  (array_key_exists($oldlanguageid, $_CONF['language_files'])){\n                $code = substr_replace($code, $newlanguageid, -$lang_len);\n            }\n        }\n    }\n    return $code;\n}\n\n\nfunction DATABOX_templatePath (\n    $kind = 'data'\n    ,$template ='default'\n    ,$pi_name= 'databox'\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\u3092\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_templatePath('data','default','databox')\n// | \u66f8\u5f0f DATABOX_templatePath($kind,$template,$pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:'data' 'category' ''newlist' 'admin'\n// | \u5f15\u6570 $template:  'default'\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\n// +---------------------------------------------------------------------------+\n// 20101115\n{\n\n    global $_CONF;\n\n    if (is_null($template) OR ($template===\"\")){\n        $template=\"default\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    if ($kind===\"admin\"){\n        $conf_templates=$box_conf[\"templates_admin\"];\n    }else{\n        $conf_templates=$box_conf[\"templates\"];\n    }\n\n    //\"standard\";//\u6a19\u6e96\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"custom\";//\u30ab\u30b9\u30bf\u30e0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"theme\";//\u30c6\u30fc\u30de\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    if  ($conf_templates===\"theme\"){\n\n        $tmplfld=$_CONF['path_layout'] .$box_conf['themespath'].$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n        }\n        if (is_dir($tmplfld)) {\n\n        }else{\n            COM_handle404();\n            exit;\n        }\n    }else if  ($conf_templates===\"custom\"){\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/custom/templates/'.$kind;\n\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n\n        }\n\n        if (is_dir($tmplfld)){\n\n        }else{\n            COM_handle404();\n            exit;\n        }\n    }else{\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/templates/'.$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/default\";\n        }\n    }\n\n\n    return $tmplfld;\n}\n\nfunction DATABOX_siteHeader (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$page_title = ''\n    ,$headercode = ''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d8\u30c3\u30c0\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title,$headercode)\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $pagetitle:\n// | \u5f15\u6570 $headercode:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30d8\u30c3\u30c0\n// +---------------------------------------------------------------------------+\n// 20120910\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    $display=\"\";\n    \n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n            $display=COM_siteHeader ('menu', $page_title,$headercode);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'noblocks':\n            $display=COM_siteHeader ('none', $page_title,$headercode);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n\n\n    return $display;\n}\n\n\nfunction DATABOX_siteFooter (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$custom=''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30c3\u30bf\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name,'_admin',$custom)\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $custom:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 : \u30d5\u30c3\u30bf\n// +---------------------------------------------------------------------------+\n// 20110119\n{\n    global $_CONF;\n\n    if (is_null($pi_name)){\n        $pi_name=\"databox\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $display=\"\";\n\n    $layout=$box_conf['layout'.$kind];\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        $display .= COM_siteFooter(false,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n            $display .= COM_siteFooter(true,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        // \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u5e38\u6642\u8868\u793a\u3059\u308b\u8a2d\u5b9a\u3067\u3042\u3063\u3066\u3082\u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3055\u305b\u306a\u3044\n        case 'noblocks':\n            $_CONF['show_right_blocks']=0;\n            $_CONF['left_blocks_in_footer']=0;\n            $display .= COM_siteFooter(false,$custom);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n    return $display;\n}\n\n\n//$retval = SP_returnStaticpage($page, $display_mode, $comment_order, $comment_mode, $comment_page, $msg, $query);\n\nfunction DATABOX_displaypage (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$display = ''\n    ,$information = ''\n)\n//$information\n// 'what'  'none' no left blocks are returned\n//         'menu' (default)  right blocks are returned\n// 'pagetitle'     Optional content for the page's <title>\n// 'breadcrumbs'   Optional content for the page's <title>\n// 'headercode'    Optional code to go into the page's <head>\n// 'rightblock'    \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3059\u308b\u304b\u3069\u3046\u304b\u3000 default is no (-1)\n// 'custom'        An array defining custom function to be used to \n\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    \n    //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n    if  ($layout=='blankpage'){\n        \n    }else{\n        switch ($layout) {\n            // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n            case 'standard':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(false,$custom);\n                $information['what']='menu';\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n            case 'leftrightblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(true,$custom);\n                $information['what']='menu';\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'leftblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                $information['what']='menu';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'rightblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                //$display .= COM_siteFooter(true,$custom);\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'noblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n        }\n        \n        //FOR GL2.0.0 \n        if (COM_versionCompare(VERSION, \"2.0.0\",  '>=')){\n            $display = COM_createHTMLDocument($display,$information);\n        }else{\n            $display = COM_siteHeader ($information['what'], $information['pagetitle']).$display;\n            $display .= COM_siteFooter($information['rightblock']);\n        }\n    }\n\n\n    return $display;\n}\n\n\nfunction DATABOX_getcheckList(\n    $kind\n    ,$selected\n    ,$pi_name\n    ,$group_id=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcheckList($kind,$selected = \"\")\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name)\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"categorygroup\",\"\",$pi_name,1,\"ch1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:fieldset\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox' \n// | \u5f15\u6570 $group_id\u3000\u30de\u30b9\u30bf\u30fc\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n// \u30ab\u30c6\u30b4\u30ea\u4ee5\u5916\u3067\u4f7f\u3063\u3066\u3044\u308b\u304b\u78ba\u8a8d\u306e\u3053\u3068 --> category \u306f DATABOX_getcategoriesinp\n//20140624 fieldset\u3000\u8ffd\u52a0\n{\nglobal $_TABLES;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n\n    $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n    $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    $table_def_fieldset=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n    $retval = '';\n    if ($kind==\"categorygroup\"){\n        $sql = \"SELECT \";\n        $sql .= \" m1.category_id\".LB;\n        $sql .= \",m1.name\".LB;\n        $sql .= \",m1.orderno\".LB;\n        $sql .= \",m2.group_id\".LB;\n        $sql .= \",m2.name AS group_name\".LB;\n        $sql .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql .= \" , {$table_def_group} AS m2\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m1.allow_display<2 \".LB;\n        $sql .= \" AND m1.categorygroup_id =\".$group_id.LB;\n        $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n        $sql .= \" ORDER BY m1.orderno\".LB;\n    }else if ($kind==\"fieldset\"){\n        $sql = \"SELECT \";\n        $sql .= \" fieldset_id\".LB;\n        $sql .= \",name\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_def_fieldset} \".LB;\n        $sql .= \" ORDER BY fieldset_id\".LB;\n    }else{\n        $sql = \"SELECT \".LB;\n        $sql .= \" no\".LB;\n        $sql .= \",value\".LB;\n        $sql .= \",orderno\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_mst}\".LB;\n        $sql .= \" WHERE kind='{$kind}'\".LB;\n        $sql .= \" ORDER BY orderno\".LB;\n    }\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    $old_group_id=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fname . '[]\" value=\"' . $A[0] ;\n        $retval .= '\"';\n        for( $x = 0; $x < sizeof( $S ); $x++ )            {\n            if( $A[0] == $S[$x] )                {\n                $retval .= ' checked=\"checked\"';\n            }\n        }\n        $retval .= '>' . stripslashes( $A[1] ) . '</span>' . LB;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getdatas(\n    $fld\n    ,$tbl\n    ,$where\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u8aad\u8fbc                                                      |\n// | \u66f8\u5f0f DATABOX_getdatas($fld,$tbl,$where)                                   |\n// | $rt=DATABOX_getdatas(                                                     |\n// |      \"category_id\",$_TABLES['DATABOX_category'],\"id=$id\");                |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $where:\u6761\u4ef6\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8907\u6570\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    $sql=\"SELECT {$fld} FROM {$tbl} WHERE {$where}\";\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $selected=\"\";\n    for ($i = 0; $i < $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $selected.= $A[$fld].\" \";\n    }\n    $selcted=rtrim($selected,\" \");\n    return $selected;\n\n}\n\n\nfunction DATABOX_savedatas(\n    $fld\n    ,$tbl\n    ,$id\n    ,$fldary=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc\n// | \u66f8\u5f0f DATABOX_savedatas($fld,$tbl,$id,$fldary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    global $_TABLES;\n\n    $rt=DB_delete($tbl,\"id\",$id);\n\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$tbl} (\";\n            $sql.=\"id, {$fld}\";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id}, {$val}\";\n            $sql.=\")\";\n            DB_query($sql);\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\nfunction DATABOX_savecategorydatas(\n    $id\n    ,$fldary\n    ,$pi_name=\"\"\n    ,$mydata=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc(\u30ab\u30c6\u30b4\u30ea)\n// | \u66f8\u5f0f DATABOX_savecategorydatas($id,$category,'databox','mydata')\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update20100824\n{\n\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_category=$_TABLES['DATABOX_category'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\t\n\tif  ($mydata==\"\"){\n        $rt=DB_delete($table_category,\"id\",$id);\n\t}else{\n\t\t$categories=COM_applyFilter($_POST['categories']);\n\t\tif  ($categories==\"\" ){\n\t\t}else{\n            $categories=str_replace(\"|\", ',', $categories);\n\t\t    $sql=\"DELETE FROM {$table_category} WHERE \";\n\t        $sql .=\"  id = \".$id ;\n\t        $sql .=\"  AND category_id IN (\".$categories.\")\";\n\t\t    DB_query($sql);\n\t\t}\n\t}\n\t\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$table_category} (\".LB;\n            $sql.=\"id, category_id\".LB;\n            $sql.=\") VALUES (\".LB;\n            $sql.=\"{$id}, {$val}\".LB;\n            $sql.=\")\".LB;\n            DB_query($sql);\n            /////parent_id \u304c0\u306b\u306a\u308b\u307e\u3067insert\n            $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$val}\");\n            while ($parent_id<>0) {\n                $category_id=$parent_id;\n                $seq=DB_getItem( $table_category   ,\"seq\",\"id={$id} AND category_id={$category_id} \");\n                if (is_null($seq)) {\n                    $sql=\"INSERT INTO {$table_category} (\".LB;\n                    $sql.=\"id, category_id\".LB;\n                    $sql.=\") VALUES (\".LB;\n                    $sql.=\"{$id}, {$category_id}\".LB;\n                    $sql.=\")\".LB;\n                    DB_query($sql);\n                }\n                $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$category_id}\");\n            }\n            /////\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\n//==============================================================================\nfunction DATABOX_chkuser(\n        $group_id\n        ,$owner_id\n        ,$adminrights=\"databox.admin\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e6\u30fc\u30b6\u30c1\u30a7\u30c3\u30af\n// | \u66f8\u5f0f $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $group_id\n// | \u5f15\u6570 $owner_id\n// | \u5f15\u6570 $adminrights\u3000databox.admin\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024\n// |    0 guest\n// |   10 guest and allusers\n// | 1000 user\n// | 1010 group\u3000(owner \u542b\u3080)\n// | 1011 owner\n// | 1100 admin\n// | 1110 group and admin\n// | 1101 owner and admin\n// | 1111 group owner and admin\n// +---------------------------------------------------------------------------+\n//update20101004 group_id\n{\n    global $_USER;\n\n    $chk_user=0;\n    if (isset($_USER['uid']) && $_USER['uid'] > 1) {\n        $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n    }\n    if ( SEC_hasRights($adminrights)) {\n        $chk_user=$chk_user+100;//admin\n    }\n    //group \u306b\u5c5e\u3057\u3066\u3044\u308b\u4eba\n    $usergroups=SEC_getUserGroups();\n\n    if ( in_array($group_id, $usergroups)){\n        $chk_user=$chk_user+10;//group\n    }\n\n    if ($owner_id===$_USER['uid']){\n        $chk_user=$chk_user+1;//owner\n    }\n\n    return $chk_user;\n}\n\n\n\nfunction DATABOX_getadditiondef(\n    $pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_def_field'];\n        $table2=$_TABLES['DATABOX_mst'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n        $table2=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n\n    $rt=array();\n\t$fieldgroupno_old=\"\";\n\t\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",description\";\n    $sql.= \",type\";\n    //$sql.= \",fieldgroup_id AS group_id\";\n    $sql.= \",selection\";\n    $sql.= \",selectlist\";\n    $sql.= \",checkrequried\";\n    $sql.= \",size\";\n    $sql.= \",maxlength\";\n    $sql.= \",rows\";\n    $sql.= \",br\";\n    $sql.= \",templatesetvar\";\n\n    $sql.= \",allow_display\";\n    $sql.= \",allow_edit\";\n\n    $sql.= \",textcheck\";\n    $sql.= \",textconv\";\n    $sql.= \",searchtarget\";\n    \n    $sql.= \",initial_value\";\n    $sql.= \",range_start\";\n    $sql.= \",range_end\";\n    $sql.= \",dfid\";\n    $sql.= \",description2\";\n    $sql.= \",fieldgroupno\";\n\t\n    $sql.=\" FROM\";\n    $sql.=\" {$table}  AS m\";\n    $sql.= \" ORDER BY orderno,field_id\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $rt[$field_id]['name'] = COM_stripslashes($A['name']);\n        $rt[$field_id]['checkrequried'] = COM_stripslashes($A['checkrequried']);\n        $rt[$field_id]['description'] = COM_stripslashes($A['description']);\n        $rt[$field_id]['allow_display'] = COM_stripslashes($A['allow_display']);\n        $rt[$field_id]['allow_edit'] = COM_stripslashes($A['allow_edit']);\n        $rt[$field_id]['textcheck'] = COM_stripslashes($A['textcheck']);\n        $rt[$field_id]['textconv'] = COM_stripslashes($A['textconv']);\n        $rt[$field_id]['searchtarget'] = COM_stripslashes($A['searchtarget']);\n        \n        $rt[$field_id]['type'] = COM_stripslashes($A['type']);\n        //$rt[$field_id]['group_id'] = COM_stripslashes($A['group_id']);\n        $rt[$field_id]['selection'] = COM_stripslashes($A['selection']);\n\n        $rt[$field_id]['size'] = COM_stripslashes($A['size']);\n        if ($rt[$field_id]['size']==0){\n            $rt[$field_id]['size']=60;\n        }\n        $rt[$field_id]['maxlength'] = COM_stripslashes($A['maxlength']);\n        if ($rt[$field_id]['maxlength']==0){\n            $rt[$field_id]['maxlength']=160;\n        }\n\n        $rt[$field_id]['rows'] = COM_stripslashes($A['rows']);\n        if ($rt[$field_id]['rows']==0){\n            $rt[$field_id]['rows']=2;\n        }\n        $rt[$field_id]['br'] = COM_stripslashes($A['br']);\n\n        $rt[$field_id]['selectlist'] = COM_stripslashes($A['selectlist']);\n        $rt[$field_id]['templatesetvar'] = COM_stripslashes($A['templatesetvar']);\n\n        $selection= COM_stripslashes($A['selection']);\n        $rt[$field_id]['selectionary']=DATABOX_getselectionary($selection);\n\n        $rt[$field_id]['initial_value']= COM_stripslashes($A['initial_value']);\n        $rt[$field_id]['range_start']= COM_stripslashes($A['range_start']);\n        $rt[$field_id]['range_end']= COM_stripslashes($A['range_end']);\n        $dfid= COM_stripslashes($A['dfid']);\n        $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n        if( empty( $format )) {\n            $rt[$field_id]['format'] = $_CONF['date'];\n        }else{\n            $rt[$field_id]['format'] = $format;\n        }\n\n        $rt[$field_id]['description2']= COM_stripslashes($A['description2']);\n        $fieldgroupno=COM_stripslashes($A['fieldgroupno']);\n        if  ($fieldgroupno_old==$fieldgroupno){\n\t\t}else{\n            $fieldgroup_name=DB_getItem($table2,\"value\",\"kind='fieldgroup' AND no=\".$fieldgroupno);\n            $fieldgroupno_old=$fieldgroupno;\n        }\n        $rt[$field_id]['fieldgroup_name']=$fieldgroup_name;\n        $rt[$field_id]['fieldgroupno']= $fieldgroupno;\n\n    }\n    return $rt;\n\n}\nfunction DATABOX_getselectionary(\n    $selection\n)\n{\n    $selectionary=array();\n    $ary=array();\n    $ary=split(\"\\r\" , $selection);\n\n    $j=0;\n    for ($ii = 0; $ii < count($ary); $ii++) {\n        if ($ary[$ii]<>\"\"){\n            $selectionary[$j]=$ary[$ii];\n            $j=$j+1;\n        }\n    }\n    return $selectionary;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u691c\u7d22\u7528\u5f15\u6570\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getadditionsearchdef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 \u914d\u5217\n// |    $rt[\"sql1\"]: \",{$_TABLES['DATABOX_addition']} AS ad1\"\n// |    $rt[\"sql2\"]: \" AND t1.id=ad1.id AND ad1.field_id=1 \"\n// |    $rt[\"columns\"][]: 'ad1.value '\n// +---------------------------------------------------------------------------+\nfunction DATABOX_getadditionsearchdef(\n    $pi_name=\"\"\n)\n{\n    global $_TABLES;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    \n    if ($box_conf['additionsearch']==0){\n        return;\n    }\n    $lmt=$box_conf['additionsearch'];\n    \n    $retval=array();\n\n    $rt=array();\n    $sql3=\"\";\n    $columns=array();\n\n    $sql=LB;\n    $sql.=\"SELECT \";\n    $sql.= \" field_id \";\n    \n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n\n    // \u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u307f\n    $sql.=\" WHERE\";\n    $sql.=\" allow_display='0'\";\n    //0: \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //1: \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //20:HTML  10:TinyMCE 19:CKEditor\n    //15:\u6570\u5024  21:\u901a\u8ca8\n    $sql.=\" AND type IN (0,1,10,19,20,15,21)\";\n    \n    //\u691c\u7d22\u5bfe\u8c61\u306b\u3059\u308b=\u306f\u3044\n    $sql.=\" AND searchtarget='1'\";\n    \n    $sql.=\" ORDER  BY  orderno,field_id\";\n    $sql.=\" LIMIT 0 ,\".$lmt;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $type = COM_stripslashes($A['type']);\n        $selection= COM_stripslashes($A['selection']);\n        $selectionary=DATABOX_getselectionary($selection);\n\n        $columns[]= \"ad{$field_id}.value \";\n\n        $sql3 .= \" JOIN {$table_addition} AS ad{$field_id}\";\n        $sql3 .= \" ON t1.id=ad{$field_id}.id \";\n        $sql3 .= \" AND ad{$field_id}.field_id={$field_id} \".LB;\n        \n    }\n\n    $rt[\"sql3\"]=$sql3;\n    $rt[\"columns\"]=$columns;\n    \n    return $rt;\n\n}\n\n\n\nfunction DATABOX_getadditiondatas(\n    $id\n    ,$pi_name=\"\"\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondatas($id)\n// | $array=DATABOX_getaddtuindatas($id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u30ea\u30b9\u30c8                                                 |\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_addition=$_TABLES['DATABOX_addition'];\n        $table_def_field=$_TABLES['DATABOX_def_field'];\n    }else{\n        $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n        $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }\n\n    $rt=array();\n    \n    $sql=\"SELECT \";\n    $sql.=\" m.field_id\";\n    $sql.=\" ,m.fieldgroupno\";\n    if ($id==0){\n        $sql.=\",initial_value AS value  \";\n    }else{\n        $sql.=\", ( SELECT VALUE \";\n        $sql.=\" FROM\";\n        $sql.=\" {$table_addition}  AS t\";\n        $sql.=\" where\";\n        $sql.=\" t.id={$id}\";\n        $sql.=\" AND t.field_id=m.field_id\";\n        $sql.=\" ) AS value \";\n    }\n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n    $sql.=\" order by m.fieldgroupno,m.orderno ,m.field_id\";\n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=$A['field_id'];\n        $value=$A['value'];\n        $rt[$field_id]=COM_stripslashes($value);\n    }\n    return $rt;\n\n}\n\n\nfunction DATABOX_getaddtionfieldsEdit(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name=\"\"\n    ,$fields_fnm=\"\"\n    ,$fields_del=\"\"\n    ,$fieldset_id=0\n    ,$fields_date=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsEdit\n//          ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fields_fnm:\n// | \u5f15\u6570 $fields_del:\n// | \u5f15\u6570 $fieldset_id:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n// 20101206 \u65e5\u4ed8\n{\n    global $_TABLES;\n    global $_SCRIPTS;\n    global $_CONF;\n    global $MESSAGE;\n\t\n    if ($pi_name==\"\"){\n        $pi_name=\"databox\";\n    }\n    $lang_admin_x=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_admin;\n    global $$lang_noyes;\n    $lang_admin=$$lang_admin;\n    $lang_noyes=$$lang_noyes;\n    \n    $langCode = COM_getLangIso639Code();\n    $toolTip  = $MESSAGE[118];\n    $imgUrl   = $_CONF['site_url'] . '/images/calendar.png';\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n    $fieldgroup_old=\"\";\n    foreach( $S as $fid => $fvalue ){\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $description=$addition_def[$fid]['description'];\n        $description2=$addition_def[$fid]['description2'];\n        $fieldgroup_name=$addition_def[$fid]['fieldgroup_name'];\n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if (in_array($fid,$fieldsetfields )) {\n            \n            if ($chk_user===9999){\n                $chk=true;\n                $disabled=\"\";\n            }else{\n                //\u7de8\u96c6\u53ef\u80fd\n                if  ($addition_def[$fid]['allow_edit']==='0') {\n                    $chk=true;\n                    $disabled=\"\";\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n                }else if ($addition_def[$fid]['allow_edit']==='2'){\n                    if  ($chk_user>=1010) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='3'){\n                    if  ($chk_user>=1011) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='4'){\n                    $chk=true;\n                }\n            }\n        }\n    \n        if ($chk) {\n\n            $fieldhtml=\"\";\n            switch ($type) {\n                case 12:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml12\n                            ($fid,$fvalue,$fvalue_del,$size,$maxlength);\n                    break;\n                case 11:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml\n                            ($fid,$fvalue,$fvalue_del);\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_filehtml\n                            ($pi_name,$fid,$fvalue,$fvalue_del);\n                    break;\n\n\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                     if ($disabled===\"\"){\n                        $cntname=\"afieldcnt\".$fid;\n                        $fieldhtml .= \"<textarea \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"width:95%\\\"\";\n                        $fieldhtml .= \" rows=\\\"\".$rows.\"\\\"\";\n                        $fieldhtml .= \" id=\\\"DATABOX_afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" \".$disabled.\" \";\n                        $fieldhtml .= \" onKeyup=\\\"var n=\".$maxlength;\n                        $fieldhtml .=\"-this.value.length;var \";\n                        $fieldhtml .=\"s=document.getElementById\";\n                        $fieldhtml .=\"('\".$cntname.\"');s.innerHTML='('+n+')';\\\"\";\n                        if  ($type==20){\n                            $fieldhtml .= \" class=\\\"tinymce_enabled\\\"\";\n                        }\n                        if  ($type==19){\n                            $fieldhtml .= \" class=\\\"wide\\\"\";\n                        }\n                        $fieldhtml .= \">\";\n                        $fieldhtml .= $fvalue;\n                        $fieldhtml .= \"</textarea>\";\n                        $fieldhtml .=\"<br \".XHTML.\"><strong>\";\n                        $fieldhtml .=\"<span id='\".$cntname.\"'></span></strong>\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044 \n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist\n                            ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n                    }else{\n                        $fieldhtml= $lang_noyes[$fvalue];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n\t\t\t\t\t\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                 case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getcheckboxary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                       $fieldhtml=DATABOX_getoptionlist(\"selectlist_mst\",$fvalue,0,$pi_name,\"\",0,$selectlist,\"afield[\".$fid.\"]\");\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist ($selectionary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getradiolist ($mstary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getoptionlistary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\uff08date picker\u5bfe\u5fdc\uff09\n                if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.datepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"date\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 4://\u65e5\u6642\uff08datetime picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.hour_mode = {$_CONF['hour_mode']};\"\n                            . \"  geeklog.datetimepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n\t\t\t\t\t\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"datetime\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 26://\u6642\u523b\uff08UI time picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                         $fvalue_time=DATABOX_getTimeformat($fvalue);\n                         $filedname=\"afield\".$fid;\n                         \n                         $wk =  \" <input \";\n                         $wk .= \" type=\\\"hidden\\\"\";\n                         $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                         $wk .= \" \".XHTML.\">\";\n                         $fieldhtml.=$wk;\n\n                         $fieldhtml .= \"        <input \";\n                         $fieldhtml .= \" data-uk-timepicker=\\\"{format:'\".$_CONF['hour_mode'].\"h'\";\n                         if  ($addition_def[$fid]['range_start']==\"\"){\n                         }else{\n                             $fieldhtml .= \",start:\".$addition_def[$fid]['range_start'] ;\n                         }\n                         if  ($addition_def[$fid]['range_end']==\"\"){\n                         }else{\n                             $fieldhtml .= \",end:\".$addition_def[$fid]['range_end'] ;\n                         }\n                         $fieldhtml .= \" }\\\"\";\n                         $fieldhtml .= \" class=\\\"uk-form-width-small\\\"\";\n                         $fieldhtml .= \" type=\\\"text\\\"\";\n                         $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                         $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                         $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                         $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                         $fieldhtml .= \" value=\\\"\". $fvalue_time.\"\\\"\";\n                         $fieldhtml .= \" \".XHTML.\">\";\n                     }else{\n                        $fieldhtml .=$fvalue;\n                     }\n                     break;\n                case 22://\u65e5\u4ed8\n                if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n\n                        $_SCRIPTS->setJavaScript(\n                            \"$(function() {\n                            $( \\\"#afield\".$fid.\"\\\" ).datepicker();\n                            });\"\n                            , TRUE, TRUE\n                            );\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                        \n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 23://\u65e5\u4ed8\n                    if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n                        \n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" data-uk-datepicker=\\\"{format:'YYYY/MM/DD'}\\\"\";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\". $fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 17://\u30d5\u30e9\u30b0\n                    if ($disabled===\"\"){\n                        $wk =\" <input \";\n                        $wk .= \" type=\\\"checkbox\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"1\\\"\";\n                        if  ($fvalue==1) {\n                            $wk .= \" checked=checked\";\n                        }\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml=$wk;\n                    }else{\n                        $fieldhtml= $fvalue;\n                    }\n                    break;\n\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                default:\n                    if ($disabled===\"\"){\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n            }\n\n\n            if ($checkrequried==1){//\u5fc5\u9808\n                $must= $lang_admin['must'];\n            }else{\n                $must=\"\";\n            }\n            $templates->set_var('lang_must_additionfield', $must);\n\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield_templatesetvar', \"&#123;\".$templatesetvar.\"&#125;\");\n\n            $addisionfields .= $fieldhtml;\n            $templates->set_var('additionfield_value', $fieldhtml);\n\n            $templates->set_var('additionfield_description', $description);\n            $templates->set_var('additionfield_description2', $description2);\n            $templates->set_var('fieldgroup_name', $fieldgroup_name);\n\t\t\tif  ($fieldgroup_old==$fieldgroup_name){\n                $templates->set_var('fieldgroup', \"\");\n            }else{\n                $templates->set_var('fieldgroup', $fieldgroup_name);\n                $fieldgroup_old=$fieldgroup_name;\n            }\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n        }\n    }\n\n    return $retval;\n}\n\n//\nfunction DATABOX_figurehtml(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n\n//    $retval .= \" value=\\\"\".$fvalue_fnm.\"\\\"\";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .=\"<img src=\\\"data:image/jpg;base64,\";\n        $retval .=\"{$fvalue}\\\"\";\n        $retval .=\"width=100 height=100\";\n        $retval .=\" \".XHTML.\">\".LB;\n        //\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n//  $photo_x = USER_getPhoto ($uid, $photo, $email, -1);\n\n    return $retval;\n}\nfunction DATABOX_filehtml(\n    $pi_name\n    ,$fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $lang_box_admin['deletemsg_check'];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\n\nfunction DATABOX_figurehtml12(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n    ,$size\n    ,$maxlength\n)\n{\n\n    global $LANG04;\n    \n    $a=explode(\"|\",$fvalue);\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .= \"<input \";\n    $retval .= \" type=\\\"text\\\"\";\n    $retval .= \" size=\\\"\".$size.\"\\\"\";\n    $retval .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n    $retval .= \" name=\\\"afield_alt[\".$fid.\"]\\\" \";\n    $retval .= \" style=\\\"max-width:95%\\\"\";\n    $retval .= \" value=\\\"\".$a[1].\"\\\"\";\n    $retval .= \" \".XHTML.\">\";\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_imagehtml(\n    $name\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"\".$name.\"\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    if ($fvalue==\"\"){\n\n        $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n        $retval .= \" id=\\\"\".$name.\"\\\" \";\n        $retval .= \" name=\\\"\".$name.\"\\\" \";\n\n        $retval .=\"size=\\\"30\\\"\";\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }else{\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"\".$name.\"_del\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_getaddtionfieldsText(\n    $fields\n    ,$addition_def\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeTEXT\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsText\n// |        ($additionfields,$addition_def,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76eetext\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_CONF;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n    \n    $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n\n        $chk=false;\n        $disabled=\"disabled\";\n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($addition_def[$fid]['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n\n        if (in_array($fid,$fieldsetfields )) {\n            if ($chk) {\n                $retval.=$name.\":\";\n\n                switch ($type) {\n                    case 11://\u56f3\n                        $retval .= \"\";\n                        break;\n                    case 2://\u3044\u3044\u3048/\u306f\u3044\n                        $retval .= $lang_noyes[$fvalue];\n                        break;\n                    case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 8://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                        $retval .= $selectionary[$fvalue];\n                        break;\n                    case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $wk.=$selectionary[$wkary[$x]].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                        $retval .= $mstitems['value'];\n                        break;\n                    case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                            $wk.=$mstitems['value'].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 4://\u65e5\u6642\n                        $w=COM_getUserDateTimeFormat($fvalue);\n                        $retval .= $w[0];\n                        break;\n                    case 22://\u65e5\u4ed8\n                    case 23://\u65e5\u4ed8\n                    case 3://\u65e5\u4ed8\n                        if  ($fvalue<>\"\"){\n                            $retval .=strftime( $_CONF['shortdate'], $fvalue );\n                        }\n                        break;\n                    case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                    case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                    case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                    case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                    default:\n                        $retval .= $fvalue;\n                }\n                $retval.=LB;\n            }\n        }\n    }\n    return $retval;\n}\n\n\n\nfunction DATABOX_getaddtionfieldsDisp(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u4f5c\u6210                                              |\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsDisp\n// |        ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n//update 20101012 $chk_user\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    \n    $noimage=\"lib/noimage.jpg\";\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n\n        $name=$addition_def[$fid]['name'];\n        $description=$addition_def[$fid]['description'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n        $format=$addition_def[$fid]['format'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $chk=false;\n        if (in_array($fid,$fieldsetfields )) {\n            //\u8868\u793a\u3059\u308b\n            if  ($addition_def[$fid]['allow_display']==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_display']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n                //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n        }\n        if ($chk) {\n            $fieldhtml=\"\";//\u5916\u753b\u50cf\u306e\u5834\u5408\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtml_tn=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtmldisp=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtmldisp_tn=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtml_noimage=\"\";\n            $fieldhtml_tn_noimage=\"\";\n\t\t\t$fieldhtml_tn_image=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\n\t\t\t$fieldhtml_readfile=\"\";//\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30ebreadfile\n            $mstitems=array();\n            $fieldhtml_yes=\"\";\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\uff08\u6e96\u5099\u4e2d\uff09\n                    $a=explode(\"|\",$fvalue);\n                    $fieldhtml=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                    $fieldhtml_noimage=$a[0];\n                    //\n                    if  ($fvalue===\"\"){\n                        $fieldhtml_noimage=$noimage;\n                        $fieldhtml_tn_noimage=$noimage;\n                    }else{\n\n                        $fieldurl= $_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n                        $fieldurl.= $a[0] ;\n\n                        $fieldhtmldisp .=\"<img \";\n                        $fieldhtmldisp .=\" src=\\\"{$fieldurl}\\\"\";\n                        $fieldhtmldisp .=\" border=\\\"0\\\"\";\n                        $fieldhtmldisp .=\" alt=\\\"{$a[1]}\\\"\";\n                        $fieldhtmldisp .=\" \".HTML.\">\";\n                    \n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\n                        $filename = substr($fvalue, 0, strrpos($fvalue,\".\"));\n                        $thum_filename = $filename . \"-small.jpg\";\n                        $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    \n                        if(file_exists($imgfld_thmb.$thum_filename)) {\n                            $fieldhtml_tn=$thum_filename;\n                            $fieldhtml_tn_noimage=$thum_filename;\n                            //\n                            $fieldurl_tn= $_CONF['site_url']   .\"/\".$box_conf['imgfile_thumb_frd'] ;\n                            $fieldurl_tn.= $thum_filename ;\n                            //\n                            $fieldhtml_tn_image .=\"<a href=\\\"{$fieldurl}\\\" target=\\\"_blank\\\">\";\n                            $fieldhtml_tn_image .=\"<img \";\n                            $fieldhtml_tn_image .=\" src=\\\"{$fieldurl_tn}\\\"\";\n                            $fieldhtml_tn_image .=\" border=\\\"0\\\"\";\n                            $fieldhtml_tn_image .=\" alt=\\\"{$a[1]}\\\"\";\n                            $fieldhtml_tn_image .=\" \".XHTML.\">\";\n                            $fieldhtml_tn_image .=\" </a>\";\n                        \n                        }else{\n                            $fieldhtml_tn_noimage=$noimage;\n                        }\n                        \n                    }\n\n                    break;\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $a=explode(\"|\",$fvalue);\n                        $fieldhtml .= $a[1];\n                        $fieldhtml_readfile = $a[0];\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $fieldhtml .=\"<img src=\\\"data:image/jpg;base64,\";\n                        $fieldhtml .=\"{$fvalue}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $fieldhtml .= $lang_noyes[$fvalue];\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@@\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@\n                    $fieldhtml .= $selectionary[$fvalue];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($fvalue);\n                    $w=DATABOX_autolink($w);\n                    $fieldhtml .= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                    $fieldhtml .= $mstitems['value'];\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    \n                    $mstitems['value2'] = rtrim($wk_value2,$separater);\n                    $mstitems['disp'] = rtrim($wk_disp,$separater);\n                    $mstitems['no'] =$fvalue;\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($fvalue<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($fvalue,$format);\n                        $fieldhtml .= $w[0];\n                    }\n                    break;\n                case 26://\u6642\u523b\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .= DATABOX_getTimeformat($fvalue);\n                    }\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                case 3://\u65e5\u4ed8\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .=strftime( $_CONF['shortdate'], $fvalue );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $fieldhtml .= number_format( (float)$fvalue, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $fieldhtml .= $fvalue;\n            }\n            $templates->set_var('field_id', $fid);\n            $templates->set_var('field_type', $type);\n            \n            //\u9805\u76ee\u540d\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield'.$fid.\"_name\", $name);\n            $templates->set_var($templatesetvar.\"_name\", $name);\n            \n            //\u8aac\u660e\n            $templates->set_var('additionfield'.$fid.\"_description\", $description);\n            $templates->set_var($templatesetvar.\"_description\", $description);\n            \n            //\u767b\u9332\u3057\u305f\u30c6\u30fc\u30de\u5909\u6570\u540d\n            $templates->set_var('additionfield_templatesetvar', $templatesetvar);\n            \n            //\n            $templates->set_var('additionfield_value', $fieldhtml);\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n            $templates->set_var('additionfield_fvalue', $fvalue);\n            $templates->set_var('additionfield'.$fid.\"_value\", $fvalue);\n            $templates->set_var($templatesetvar.\"_value\", $fvalue);\n            \n            if  ($type==12){\n                $templates->set_var('display_a', 'display:');\n            }else{\n                $templates->set_var('display_a', 'display:none');\n            }\n            //(a_1)_tn \u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $templates->set_var('additionfield_value_tn', $fieldhtml_tn);\n            $templates->set_var('additionfield'.$fid.\"_tn\", $fieldhtml_tn);\n            $templates->set_var($templatesetvar.\"_tn\", $fieldhtml_tn);\n            \n            //(a_2)_noimage\n            $templates->set_var('additionfield_value_noimage', $fieldhtml_noimage);\n            $templates->set_var('additionfield'.$fid.\"_noimage\", $fieldhtml_noimage);\n            $templates->set_var($templatesetvar.\"_noimage\", $fieldhtml_noimage);\n            \n            //(a_3)_tn_image \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_image', $fieldhtml_tn_image);\n            $templates->set_var('additionfield'.$fid.\"_tn_image\", $fieldhtml_tn_image);\n            $templates->set_var($templatesetvar.\"_tn_image\", $fieldhtml_tn_image);\n            \n            //(a_4)_tn_noimage \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_noimage', $fieldhtml_tn_noimage);\n            $templates->set_var('additionfield'.$fid.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            $templates->set_var($templatesetvar.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            \n            //(a_5)disp \u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\u8868\u793a\n            $templates->set_var('additionfield_value_disp', $fieldhtmldisp);\n            $templates->set_var('additionfield'.$fid.\"_disp\", $fieldhtmldisp);\n            $templates->set_var($templatesetvar.\"_disp\", $fieldhtmldisp);\n            \n            if  ( $type==9 OR $type==16 OR $type==18 ){\n                $templates->set_var('display_b', 'display:');\n            }else{\n                $templates->set_var('display_b', 'display:none');\n            }\n            //(b_1)\u30de\u30b9\u30bf\u30fc\u306evalue2\n            $templates->set_var('additionfield_value_mst_value2', $mstitems['value2']);\n            $templates->set_var('additionfield'.$fid.\"_mst_value2\", $mstitems['value2']);\n            $templates->set_var($templatesetvar.\"_mst_value2\", $mstitems['value2']);\n            \n            //(b_2)\u30de\u30b9\u30bf\u30fc\u306edisp\n            $templates->set_var('additionfield_value_mst_disp', $mstitems['disp']);\n            $templates->set_var('additionfield'.$fid.\"_mst_disp\", $mstitems['disp']);\n            $templates->set_var($templatesetvar.\"_mst_disp\", $mstitems['disp']);\n            \n            //(b_3)\u30de\u30b9\u30bf\u30fc\u306eno\n            $templates->set_var('additionfield_value_mst_no', $mstitems['no']);\n            $templates->set_var('additionfield'.$fid.\"_mst_no\", $mstitems['no']);\n            $templates->set_var($templatesetvar.\"_mst_no\", $mstitems['no']);\n            \n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var('additionfield'.$fid.\"_disptn\", $fieldhtmldisp_tn);\n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var($templatesetvar.\"_disptn\", $fieldhtmldisp_tn);\n\t\t\t\n            if  ( $type==13  ){\n                $templates->set_var('display_c', 'display:');\n            }else{\n                $templates->set_var('display_c', 'display:none');\n            }\n\t\t\t//(c)\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u61b6\u30d5\u30a1\u30a4\u30eb\u540d(templatesetvar_(id)_(readfile))\n            $templates->set_var('additionfield_value_readfile', $fieldhtml_readfile);\n            $templates->set_var('additionfield'.$fid.\"_readfile\", $fieldhtml_readfile);\n            $templates->set_var($templatesetvar.\"_readfile\", $fieldhtml_readfile);\n\t\t\t\n\t\t\t//\u5fc5\u9808\u30c1\u30a7\u30c3\u30af(templatesetvar_(id)_(requied))\n            $templates->set_var('additionfield'.$fid.\"_requried\", $checkrequried);\n            $templates->set_var($templatesetvar.\"_requried\", $checkrequried);\n\t\t\t\n            //\u6587\u8a00\n            $templates->set_var('lang_download', $lang_box['download']);\n            $templates->set_var('lang_downloadrequired', $lang_box['downloadrequired']);\n            $templates->set_var('lang_display', $lang_box['display']);\n            $templates->set_var('lang_displayrequired', $lang_box['displayrequired']);\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n    }\n\n\n    return $retval;\n}\n\n//\nfunction DATABOX_getMstItems(\n    $selectlist\n    ,$id\n    ,$pi_name\n//DATABOX_getMstItems($id,$pi_name);\n){\n    if ($id==\"\"){\n        return array();\n    }\n    global $_TABLES;\n    \n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n\n    $sql=\"SELECT * FROM  {$table_mst} WHERE kind='{$selectlist}' AND no={$id}\";\n    \n    $result = DB_query($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows > 0) {\n        $A = DB_fetchArray($result, true);\n        $A = array_map('stripslashes', $A);\n    }else{\n        $A=array();\n    }\n    return $A;\n}\n\n\nfunction DATABOX_getcategoriesText(\n    $id\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u30e1\u30fc\u30eb\u9001\u4fe1\u7528\u30c6\u30ad\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesText\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u30c6\u30ad\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n{\n    global $_TABLES;\n    global $_CONF;\n\n\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $lang_box_admin=\"LANG_DATABOX_ADMIN\";\n\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater_text'];\n\n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    $categories_group =\"\";\n    $rt=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n                $categories_group=rtrim($categories_group,$separater);\n                $rt.=$categories_group.LB;\n            }\n            $categories_group =\"\";\n            $old_group_id=$A['group_id'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n\n    }\n\n    $categories=rtrim($categories,$separater);\n    $categories_group=rtrim($categories_group,$separater);\n    $rt.=$categories_group.LB;\n\n    $retval.=$lang_box_admin['category'].\": \".$categories.LB;\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesDisp(\n    $id\n    ,$templates\n    ,$chk_user\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30eaHRML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesDisp\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u8868\u793a\u7528HTML\n// +---------------------------------------------------------------------------+\n//20101129\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $box_conf=\"_DATABOX_CONF\";\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    $sql = \"SELECT \";\n    $sql .= \" group_id\".LB;\n    $sql .= \" ,code\".LB;\n    $sql .= \" FROM \";\n    $sql .= \" {$table_def_group} \".LB;\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    \n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $gid=$A['group_id'];\n        $gcode=$A['code'];\n        $templates->set_var('group_'.$gid, \"\");\n        $templates->set_var('group_'.$gcode, \"\");\n        $templates->set_var('group_'.$gid.\"_code\", \"\");\n        $templates->set_var('group_'.$gcode.\"_code\", \"\");\n                \n        $templates->set_var('grouplink_'.$gid, \"\");\n        $templates->set_var('grouplink_'.$gid.\"_code\", \"\");\n\n        $templates->set_var('grouplink_'.$gcode, \"\");\n        $templates->set_var('grouplink_'.$gcode.\"_code\", \"\");\n    }\n    \n    \n    \n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    $sql .= \",m1.allow_display\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno,m1.category_id\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater'];\n    $separater_code=$lang_box['category_separater_code'];\n    $separater_pipeline=\"|\";\n    \n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    \n    $categories_group =\"\";\n    $categories_link_id_group =\"\";\n    $categories_link_code_group =\"\";\n    \n    $categories_group2 =\"\";\n    $categories_link_id_group2 =\"\";\n    $categories_link_code_group2 =\"\";\n    \n    $categories_group_pipeline =\"\";\n    \n    //group_id2, group_code2, grouplinkid2, grouplinkcode2,\n    //group_id \u304c\u30ab\u30c6\u30b4\u30ea\u306e\u540d\u79f0\u3092\u8868\u793a\u3059\u308b\u306e\u306b\u5bfe\u3057\u3001\n    //group_id2\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group $categories_link_id_group $categories_link_code_group\n    //group_pipeline\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u533a\u5207\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group_pipeline\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $chk=false;\n        //\u8868\u793a\u3059\u308b\n        if  ($A['allow_display']==='0') {\n            $chk=true;\n        //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n        }else if ($A['allow_display']==='1'){\n            if  ($chk_user>=1000) {\n                $chk=true;\n            }\n        //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n        }else if ($A['allow_display']==='2'){\n            if  ($chk_user>=1010) {\n                $chk=true;\n            }\n        //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='3'){\n            if  ($chk_user>=1011) {\n                $chk=true;\n            }\n        //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='4'){\n            if  ($chk_user>=1100) {\n                $chk=true;\n            }\n        }\n        \n        if  ($chk==false){\n            continue;\n        }\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n\n                $categories_group=rtrim($categories_group,$separater);\n                $templates->set_var('group_'.$old_group_id, $categories_group);\n                $templates->set_var('group_'.$old_group_code, $categories_group);\n                $categories_group2=rtrim($categories_group2,$separater_code);\n                $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n                $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n                $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n                $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n                $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n                \n                $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n                $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);\n\n                $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n                $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);\n\n            }\n            $categories_group =\"\";\n            $categories_link_id_group =\"\";\n            $categories_link_code_group =\"\";\n            $categories_group2 =\"\";\n            $categories_link_id_group2 =\"\";\n            $categories_link_code_group2 =\"\";\n            $categories_group_pipeline=\"\";//@@\n            \n            $old_group_id=$A['group_id'];\n            $old_group_code=$A['group_code'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n        $categories_group2.=$A['category_code'].$separater_code;\n        $categories_group_pipeline.=$A['category_code'].$separater_pipeline;\n        \n\n        $name=$A['category_name'];\n        $code=COM_applyFilter($A['category_code']);\n        $url=$_CONF['site_url'] .\"/\".$pi_name.\"/category.php\";\n        $url_code=$url;\n        $url_code.=\"?code=\".$A['category_code'];\n        $url_code.=\"&m=code\";\n        $url_code = COM_buildUrl( $url_code );\n        $url_id=$url;\n        $url_id.=\"?id=\".$A['category_id'];\n        $url_id.=\"&m=id\";\n        $url_id= COM_buildUrl( $url_id );\n        $category_link_id= COM_createLink($name, $url_id);\n        $category_link_code= COM_createLink($name, $url_code);\n        $category_link_id2= COM_createLink($code, $url_id);\n        $category_link_code2= COM_createLink($code, $url_code);\n\n        $categories_link_id.=$category_link_id.$separater;\n        $categories_link_id_group.=$category_link_id.$separater;\n        $categories_link_id_group2.=$category_link_id2.$separater_code;//@@\n        $categories_link_code.=$category_link_code.$separater;\n        $categories_link_code_group.=$category_link_code.$separater;\n        $categories_link_code_group2.=$category_link_code2.$separater_code;//@@\n    }\n\n    $categories=rtrim($categories,$separater);\n    $templates->set_var('categories', $categories);\n\n\n    $categories_link_code=rtrim($categories_link_code,$separater);\n    $categories_link_id=rtrim($categories_link_id,$separater);\n\n\n    if ($box_conf['categoriescode']){\n        $categorieslink=$categories_link_code;\n    }else{\n        $categorieslink=$categories_link_id;\n    }\n    $templates->set_var('categorieslink', $categorieslink);\n\n\n    $templates->set_var('categorieslinkcode', $categories_link_code);\n    $templates->set_var('categorieslinkid', $categories_link_id);\n\n    $categories_group=rtrim($categories_group,$separater);\n    $categories_group2=rtrim($categories_group2,$separater_code);\n    $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n\n    $templates->set_var('group_'.$old_group_id, $categories_group);\n    $templates->set_var('group_'.$old_group_code, $categories_group);\n    $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n    $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n\n    $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n    \n    $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);//@@\n    \n    $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n    \n    $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);//@@\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesinp(\n    $selected = \"\"\n    ,$fieldset_id=\"\"\n    ,$pi_name=\"\"\n    ,$chk_user=9999\n)\n{\nglobal $_TABLES;\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_def_fieldset_group=$_TABLES['DATABOX_def_fieldset_group'];\n        $table_mst=$_TABLES['DATABOX_mst'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_def_fieldset_group=$_TABLES[strtoupper($pi_name).'_def_fieldset_group'];\n        $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n    \n    //\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    \n    //\n    $retval = '';\n\n    $sql = \"SELECT \";\n    $sql .= \"m2.group_id\".LB;\n    $sql .= \",m2.name AS group_name\".LB;\n    $sql .= \",m2.input_type\".LB;\n    $sql .= \",m2.allow_edit\".LB;\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_def_group} AS m2\".LB;\n    if  ($fieldset_id<>0){\n        $sql .= \" ,{$table_def_fieldset_group} AS m3\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m2.group_id = m3.group_id\".LB;\n        $sql .= \" AND m3.fieldset_id = \".$fieldset_id .LB;\n    }\n    \n    \n    $sql .= \" ORDER BY m2.orderno\".LB;\n        \n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $categoryids=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        \n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($A['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($A['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($A['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($A['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n        if ($chk==false) {\n            continue;\n        }\n\t\t\n        $sql2 = \"SELECT \";\n        $sql2 .= \" m1.category_id\".LB;\n        $sql2 .= \",m1.name\".LB;\n        $sql2 .= \",m1.orderno\".LB;\n        $sql2 .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql2 .= \" WHERE \".LB;\n        $sql2 .= \" m1.categorygroup_id=\".$A['group_id'].LB;\n        \n        $sql2 .= \" ORDER BY m1.orderno\".LB;\n        \n        $result2 = DB_query( $sql2 );\n        $nrows2 = DB_numRows( $result2 );\n        \n        if ($nrows2>0){\n            $retval .=\"<div class=\\\"databox_admin_data_title\\\">\";\n            $retval .=$A['group_name'];\n            $retval .=\"</div>\".LB;\n        \n            if  ($A['input_type']==1){\n                $retval .='<select name=\"category[]\" multiple style=\"height:10em\" '.$disabled.' >'.LB;\n            }else if ($A['input_type']==3){\n                $retval .='<select name=\"category[]\" '. $disabled .' >'.LB;\n            }\n            \n            for( $i2 = 0; $i2 < $nrows2; $i2++ )    {\n\n                $A2 = DB_fetchArray( $result2, true );\n                \n\t\t\t\tif  ($disabled==\"\"){\n\t\t\t\t\t$categoryids.=$A2['category_id'].\"|\";\n                }\n                \n                $checked=\" \";\n                for( $x = 0; $x < sizeof( $S ); $x++ )            {\n                    if( $A2['category_id'] == $S[$x] )                {\n                        if  ($A['input_type']==0 OR $A['input_type']==2){\n                            $checked= ' checked=\"checked\" ';\n                        }else{\n                            $checked= ' selected ';\n                        }\n                    }\n                }\n            \n                if  ($A['input_type']==0){\n                    $retval .= '<span style=\"white-space:nowrap\">';\n                    $retval .= '<input type=\"checkbox\" name=\"category[]\" value=\"' . $A2['category_id'] ;\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= $disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==1){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }else  if  ($A['input_type']==2){\n                    $retval .= '<input type=\"radio\" name=\"category[]\" value=\"' . $A2['category_id'];\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= ' '.$disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==3){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }\n            }\n        \n            if  ($A['input_type']==1  OR  $A['input_type']==3  ){\n                $retval .='</select>';\n            }\n        }\n        \n\t}\n\tif  ($categoryids==\"\"){\n\t}else{\n\t\t$categoryids=substr($categoryids,0,strlen($categoryids)-1);\n        $retval .= \"  <input type='hidden' name='categories' value='{$categoryids}'>\";\n    }\n    return $retval;\n}\nfunction DATABOX_getaddtionfields(\n    $id\n    ,$addition_def\n    ,$pi_name\n    ,$field_id=0\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getadditionfields($id,$addition_def,$tbl_prefix,$field_id)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\u306e\u914d\u5217\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n\n    global $_TABLES;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $retval=array();\n\n    $sql = \"SELECT \";\n    $sql .= \" value\";\n    $sql .= \",t.field_id\";\n\n    $sql .= \" FROM {$table_addition} AS t\";\n    $sql .= \" , {$table_def_field} AS m\";\n    $sql .= \" WHERE \";\n    $sql .= \" t.id={$id}\";\n    $sql .= \" AND t.field_id=m.field_id\";\n    if ($field_id<>0){\n        $sql .= \" AND t.field_id=\".$field_id;\n    }\n\n    $sql .= \" ORDER BY m.orderno\";\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n\n        $fid=$A[\"field_id\"];\n        $value=$A[\"value\"];\n\n        $fieldvalue=DATABOX_getfieldvalue(\n            $value\n            ,$addition_def[$fid]['type']\n            ,$addition_def[$fid]['selectionary']\n            ,$lang_noyes\n            ,$addition_def[$fid]['selectlist']\n            ,$pi_name\n            );\n        $retval[$fid]=$fieldvalue;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getfieldvalue(\n    $value\n    ,$type\n    ,$selectionary\n    ,$lang_noyes\n    ,$selectlist\n    ,$pi_name\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getfieldvalue($value,$type,$selectionary,$lang_noyes)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $value:\n// | \u5f15\u6570 $type:\n// | \u5f15\u6570 $selectionary:\n// | \u5f15\u6570 $lang_noyes:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    switch ($type) {\n\n        case 2://\u3044\u3044\u3048/\u306f\u3044\n            $fieldvalue = $lang_noyes[$value];\n            break;\n        case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n        case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n            $fieldvalue= $selectionary[$value];\n            break;\n        case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n        case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n            if  ($value==\"\"){\n                $fieldvalue=\"\";\n            }else{\n                $fieldvalue=DB_getItem($_TABLES[strtoupper($pi_name).'_mst'] \n                    ,\"value\"\n                    ,\"kind='{$selectlist}' AND no={$value}\");\n            }\n            break;\n        case 4://\u65e5\u6642\n            $w=COM_getUserDateTimeFormat($value);\n            $fieldvalue= $w[0];\n            break;\n        case 3://\u65e5\u4ed8\n            $fieldvalue=strftime( $_CONF['shortdate'], $value );\n            break;\n        case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n        case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n        case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n        case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n        case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n        default:\n            $fieldvalue = $value;\n        }\n\n    return $fieldvalue;\n}\n\n\nfunction DATABOX_saveaddtiondatas(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc                                                        |\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n    \n    $rt=DB_delete($table,\"id\",$id);\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            $sql=\"INSERT INTO {$table} (\";\n            $sql.=\"id, field_id,value \";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id},{$field_id}\";\n            if  ($value<>\"\") {\n                $sql.=\", '{$value}'\";\n            }else{\n                $sql.=\", NULL\";\n            }\n            $sql.=\")\";\n            DB_query($sql);\n        }\n    }\n    return ;\n\n}\n\nfunction DATABOX_saveaddtiondatas_update(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc user\u7528\n// | \u66f8\u5f0f $rt=DATABOX_saveaddtiondatas_update\n// |               ($id,$additionfields,$addition_def,$pi_name);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //if ($addition_def[$field_id]['type']=11){\n            $sql=\"UPDATE \".$table .\" SET \";\n            if  ($value<>\"\") {\n                $sql.=\" value ='\".$value.\"'\";\n            }else{\n                $sql.=\" value =NULL\";\n            }\n            $sql.=\" WHERE id=\".$id.\" AND field_id=\".$field_id;\n            DB_query($sql);\n        }\n    }\n\n\n    return ;\n\n}\n\nfunction DATABOX_cleanaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,&$fnmary\n    ,&$delary\n    ,&$dateary\n    ,&$altary\n    ,$addslash = true\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeclean\n// | \u66f8\u5f0f DATABOX_cleanadditiondatas($fldary,$typeary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def\n// | \u5f15\u6570 $fnmary\n// | \u5f15\u6570 $delary\n// | \u5f15\u6570 $addslash \n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update 20131022 12\n{\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            $type=$addition_def[$field_id]['type'];\n            $textconv=$addition_def[$field_id]['textconv'];\n            $textcheck=$addition_def[$field_id]['textcheck'];\n            $wk=$value;\n            //\u5165\u529b\u5024\u5909\u63db\n            switch ($type) {\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK TinyMCE)\n                if  (($textconv==10)\n                        OR ($textcheck>=11 AND $textcheck<=14)){ //\u534a\u89d2\u30c1\u30a7\u30c3\u30af;\n                        $wk = mb_convert_kana($wk,\"ak\");\n                    }else if ($textconv==20){ //\u5168\u89d2\u306b\u5909\u63db\u3059\u308b';\n                        $wk = mb_convert_kana($wk,\"AKV\");\n                }\n                break;\n            }\n            //\n            switch ($type) {\n                case 11:// \u56f3\n                    break;\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\n                case 10://\u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\n                    $wk=COM_stripslashes($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 1://HTML\n                case 20://TinyMCE\n                case 19://CKEditor\n                    $wk=COM_stripslashes($wk);\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $wk=COM_applyFilter($wk,true);\n                    break;\n                case 3://\u65e5\u4ed8\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day;\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                    $ary_wk=date_parse( $wk);\n                    if  ($ary_wk[error_count]==0){\n                        $dateary[$field_id]['month']= $ary_wk[month];\n                        $dateary[$field_id]['day']= $ary_wk[day];\n                        $dateary[$field_id]['year']= $ary_wk[year];\n                    }else{\n                        $wk=\"\";\n                        $dateary[$field_id]['month']= \"\";\n                        $dateary[$field_id]['day']= \"\";\n                        $dateary[$field_id]['year']= \"\";\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk_hour=$_POST['afield'.$field_id.'_hour'];\n                    $wk_minute=$_POST['afield'.$field_id.'_minute'];\n                    $wk_ampm=$_POST['afield'.$field_id.'_ampm'];\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    $dateary[$field_id]['hour']=$wk_hour;//@@@@@\n                    $dateary[$field_id]['minute']=$wk_minute;//@@@@@\n                    $dateary[$field_id]['ampm']=$wk_ampm;//@@@@@\n                    if ($wk_ampm == 'pm') {\n                        if ($wk_hour < 12) {\n                            $wk_hour = $wk_hour + 12;\n                        }\n                    }\n                    if ($wk_ampm == 'am' AND $wk_hour == 12) {\n                        $wk_hour = '00';\n                    }\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day .\" \".$wk_hour.\":\".$wk_minute;\n                    break;\n                case 26://\u6642\u523b\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wk=implode ($wk,\":\");\n                    break;\n                case 12:// \u753b\u50cf\uff08\u30d5\u30a1\u30a4\u30eb\u4fdd\u5b58\uff09\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($altary[$field_id]);\n                    $wk2=COM_checkHTML (COM_checkWords ($wk2));\n                    $altary[$field_id]=$wk2;\n                    $a=explode(\"|\",$wk);\n                    $wk=$a[0].\"|\".$wk2;\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($delary[$field_id]);\n                    $delary[$field_id]=COM_checkHTML (COM_checkWords ($wk2));\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                default:\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n            }\n            if ($addslash){\n                $wk=addslashes ($wk);\n            }\n            $fldary[$field_id] =$wk;\n        }\n    }\n\n    return $fldary;\n\n}\n\nfunction DATABOX_checkaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u8ffd\u52a0\u9805\u76eecheck\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($fldary,$typeary,$pi_data)\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n    \n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //\u5fc5\u9808\n            if ($addition_def[$field_id]['checkrequried']==1){\n                if ($value ===\"\"){\n                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_checkrequried'] ;\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                }\n                //url email date\n            }\n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                 $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld_thmb.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $imgfld )){\n                    $rt.=$imgfld.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if  ($imgfld<>$imgfld_thmb){\n                    if (!is_writable ( $imgfld_thmb )){\n                        $rt.=$imgfld_thmb.\": \".$lang_box_admin['err_writable'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                     //$fldary[$field_id]=\"\";\n                     //$fldary_fnm[$field_id]=\"\";\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($imgfile<>\"\"){\n                            $imgerr=\"\";\n                            if ($box_conf['imgfile_size2']<>\"\" AND $imgsize>$box_conf['imgfile_size2']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $imgerr=1;\n                            }\n                            if (count($box_conf['imgfile_type2'])>0){\n                                if  (in_array($imgtype,$box_conf['imgfile_type2'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type2']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $imgerr=1;\n                                }\n                            }\n                        \n                            //$imgname=sanitize\n                            // \u554f\u984c\u6587\u5b57\u3092\u9664\u304f\n                            //$filename = str_replace(\"&\",\"\",$filename);\n                            //$filename = str_replace(\"'\",\"\",$filename);\n                            //$filename = str_replace(\"/\",\"\",$filename);\n                            //$filename = str_replace(\".JPG\",\".jpg\",$filename);\n                            //\u91cd\u8907\u30c1\u30a7\u30c3\u30af\n                            if  ($imgerr===\"\"){\n                                $fldary[$field_id]=$imgname.\"|\".fldary_alt;//@@@@@@@!!!!\n                            }\n                        }\n                    }else{\n                        \n                    }    \n                 }\n            }\n\n\n\n            //\u56f3 DB\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==11){//\u56f3\n\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                        $fldary[$field_id]=\"\";\n                        $fldary_fnm[$field_id]=\"\";\n                 }else{\n                    //$figure = $_FILES[$w];\n                    // $imgfile=$figure[ 'tmp_name' ];\n\n\n                     $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                     $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                     $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                     if  ($imgfile<>\"\"){\n                          $imgerr=\"\";\n                          if ($box_conf['imgfile_size']<>\"\" AND $imgsize>$box_conf['imgfile_size']){\n                              $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                              $rt.=\"<br \".XHTML.\">\".LB;\n                              $imgerr=1;\n                          }\n                          if (count($box_conf['imgfile_type'])>0){\n                              if  (in_array($imgtype,$box_conf['imgfile_type'])){\n                              }else{\n                                  $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                  .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                  $rt.=\"<br \".XHTML.\">\".LB;\n                                 $imgerr=1;\n                              }\n                          }\n                          if  ($imgerr===\"\"){\n                              $imgbinary = fread ( fopen ( $imgfile , \"r\" ), filesize ( $imgfile ));\n                              $fldary[$field_id]=base64_encode($imgbinary);\n                          }\n                     }\n                 }\n            }\n\n            //\u65e5\u4ed8 \u65e5\u6642\n            if ($addition_def[$field_id]['type']==3 OR $addition_def[$field_id]['type']==4\n                     OR $addition_def[$field_id]['type']==22 OR $addition_def[$field_id]['type']==23){//\u65e5\u4ed8\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime($value);\n                    \n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime($addition_def[$field_id]['range_start']);\n                        $w_end=strtotime($addition_def[$field_id]['range_end']);\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    \n                    if ($w==\"\"){\n                        $w_chk=false;\n                    }else{\n                        $w_year=date('Y', $w);\n                        $w_month=date('m', $w);\n                        $w_day=date('d', $w);\n                        $w_chk=checkdate($w_month, $w_day, $w_year);\n                    }\n                    if ($w_chk==false) {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_date'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_date=date(\"Y-m-d\",$w);\n                        if ($addition_def[$field_id]['type']==3){\n                            $w_time=\"\";\n                        }else{\n                            $w_time=date(\"H:i\",$w).\"::00\";\n                        }\n                        $fldary[$field_id]=COM_convertDate2Timestamp($w_date,$w_time);\n                    }\n                }\n            }\n            //\u6642\u523b\n            if ($addition_def[$field_id]['type']==26){\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime(\"1970-1-1 \".$value);\n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_start'].\":00\");\n                        $w_end=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_end'].\":00\");\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    if ($w==\"\") {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_time'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_time=date(\"H:i\",$w).\"::00\";\n                        $fldary[$field_id]=COM_convertDate2Timestamp(\"1970-1-1\",$w_time);\n                    }\n                }\n            }\n            //\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n            if ($addition_def[$field_id]['type']==5){\n                if ($value ===\"\"){\n                }else{\n                    if (COM_isEmail ($value)==false) {\n                        $rt.=$addition_def[$field_id]['name'].$LANG04[18];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //url\n            if ($addition_def[$field_id]['type']==6){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (preg_match('/^(https?|ftp)(:\\/\\/[-_.!~*\\'()a-zA-Z0-9;\\/?:\\@&=+\\$,%#]+)$/', $value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_url'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //numeric\n            if ($addition_def[$field_id]['type']==15 OR $addition_def[$field_id]['type']==21){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (is_numeric($value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_numeric'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n           //text field\n            if (($addition_def[$field_id]['type']==0)\n                    OR ($addition_def[$field_id]['type']==1)\n                    OR ($addition_def[$field_id]['type']==10) ){\n                if ($value ===\"\"){\n                }else{\n                    if  ($addition_def[$field_id]['textcheck']==11){ //'\u534a\u89d2\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text1'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==12){//\u534a\u89d2\u82f1\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[a-zA-Z0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text2'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==13){//\u6a19\u6e96ID\u306e\u7bc4\u56f2\u5185';\n                        $value=rtrim(ltrim($value));\n                        $newvalue=COM_sanitizeID($value);\n                        if  ($value<>$newvalue){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text3'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                        $fldary[$field_id]=$value;\n                    }else if ($addition_def[$field_id]['textcheck']==14){//\u534a\u89d2\u82f1\u6570\u5b57\u8a18\u53f7\u306e\u307f';\n                        if  (!preg_match(\"/^[!-~]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text4'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                }\n            }\n            \n            \n            //textarea\n            if ($addition_def[$field_id]['type']==1 \n                    OR $addition_def[$field_id]['type']==10\n                    OR $addition_def[$field_id]['type']==20\n                    ){\n                if ($value ===\"\"){\n                }else{\n                    if (mb_strlen($value, 'UTF-8')>$addition_def[$field_id]['maxlength']) {\n                        $rt.=$addition_def[$field_id]['name']\n                            .$addition_def[$field_id]['maxlength']\n                            .\": \".$lang_box_admin['err_maxlength'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                 $file_path=$box_conf['file_path'];\n                 if  ( $box_conf['file_subdir']==1){\n                    $file_path.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $file_path )){\n                    $rt.=$file_path.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $filename=$_FILES['afield_fnm']['name'][$field_id];\n                        $filetmpname=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $filesize=$_FILES['afield_fnm']['size'][$field_id];\n                        $filetype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($filetmpname<>\"\"){\n\t\t\t\t\t\t\t$err=\"\";\n                            if ($box_conf['file_size']<>\"\" AND $filesize>$box_conf['file_size']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $err=1;\n                            }\n\t\t\t\t\t\t\tif (count($box_conf['file_type'])>0){\n                                if  (in_array($filetype,$box_conf['file_type'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$filetype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $err=1;\n                                }\n                            }\n                            //\u30c1\u30a7\u30c3\u30afOK\n                            if  ($err===\"\"){\n                                $fldary[$field_id]=$filename;\n                            }\n                        }\n                    }else{\n                        \n                    }\n                 }\n            }\n\n            //range check \u7bc4\u56f2\u30c1\u30a7\u30c3\u30af\n            if  ($addition_def[$field_id]['range_start']==\"\" AND $addition_def[$field_id]['range_end']==\"\" ){\n            }else{\n                if (($addition_def[$field_id]['type']==0)\n                     OR ($addition_def[$field_id]['type']==1)\n                     OR ($addition_def[$field_id]['type']==15) \n                     OR ($addition_def[$field_id]['type']==21) ){\n                    if  ($value <$addition_def[$field_id]['range_start'] \n                        OR $value >$addition_def[$field_id]['range_end']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                .\"(\".$addition_def[$field_id]['range_start'] \n                                .\"-\".$addition_def[$field_id]['range_end'].\")\";\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n                \n            }\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_uploadaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                        }\n\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];//@@@@@@@!!!!\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                            //$fldary_fnm[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\t\t\t\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                        }\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);//\u62e1\u5f35\u5b50\u3092\u5c0f\u6587\u5b57\u306b\u3059\u308b\n                        if  ( $box_conf['file_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\n\t\t}\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_uploadaddtiondatas_cpy(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload  for copy\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                //$filename=$fldary[$field_id];\n                //$filename_old=$fldary_old[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                \n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['imgfile_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $cpyfrom =$imgfld_thmb.$thumbname;\n                            $thumbname=DATABOX_getthumbname($newfilename);\n                            $cpyto =$imgfld_thmb.$thumbname;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                        }\n                    }\n                }\n\t\t\t}\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                $imgname_old=$a[1];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['file_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname_old;\n                        }\n                    }\n                }\n            }\n\n        }\n    }\n\n    return $rt;\n\n}\n\n//update\nfunction DATABOX_uploadaddtiondatas_xml(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n)\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            if ($fldary[$field_id]<>\"\"){\n                \n                //\u56f3 \u5916\u8a18\u61b6\n                if ($addition_def[$field_id]['type']==12){//\u56f3\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    //\n                    if  ($box_conf['imgfile_subdir']==1){\n                        $imgname=$addition_def[$field_id]['templatesetvar'].\"/\";\n                    }\n                    $imgname.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".jpg\";\n                    $imgsrc=$fldary[$field_id];\n                    if (DATABOX_uploadImageFile_xml($imgname,$imgsrc,$imgfld)){\n                        $fldary[$field_id]=$imgname;\n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                        if($box_conf['imgfile_thumb_ok']===\"1\" && function_exists('ImageCreate')) {\n                            $srcfile=$imgfld.$imgname;\n                            $rt=DATABOX_createthumb(\n                                $imgname\n                                ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                ,$imgfld_thmb,$imgfld);\n                        }\n                    }else{\n                        $fldary[$field_id]=\"\";\n                    }\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_deleteaddtionfiles(\n    $fldary\n    ,$addition_def\n    ,$pi_name\n){\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\n//\nfunction DATABOX_deleteaddtionfiles_def(\n    $field_id\n    ,$pi_name\n){\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n    \n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    //\n    $sql=\"SELECT value  \";\n    $sql.=\" FROM\";\n    $sql.=\" {$table_addition} \";\n    $sql.=\" where\";\n    $sql.=\" field_id=\".$field_id;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $filename = COM_stripslashes($A['value']);\n        if ($filename<>\"\"){\n            $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n            $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n            $rt=DATABOX_deleteFile($imgfld.$filename);\n            $thumbname=DATABOX_getthumbname($filename);\n            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_deleteaddtionfiles_all(\n    $fld\n    ,$pi_name\n){\n    \n    \n    \n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if( is_dir( $fld)){\n        $fd = opendir( $fld );\n        while(( $file = @readdir( $fd )) == TRUE )    {\n            if( !is_dir( $fd1 . $file)\n                    && $dir <> '.'\n                    && $dir <> '..'\n                    && $dir <> 'CVS'\n                    && substr( $dir, 0 , 1 ) <> '.' ) {\n                clearstatcache();\n                $rt=DATABOX_deleteFile($fld.$file);\n            }\n        }\n    }\n\n    return $rt;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeuploadfile delete\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($filename)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filename:\u30d5\u30a9\u30eb\u30c0/\u30d5\u30a1\u30a4\u30eb\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\nfunction DATABOX_deleteFile (\n    $filename\n)\n{\n    $rt=false;\n    if (file_exists ($filename)) {\n        if (!@unlink ($filename)) {\n            COM_errorLog (\"Unable to remove file $filename\");\n        }else{\n            $rt=true;\n            COM_errorLog (\"remove file $filename\");\n        }        \n    }else{\n            COM_errorLog (\"Unable to remove file $filename not exist\");\n    }\n    return $rt;\n}\n\nfunction DATABOX_uploadImageFile (\n     $imgname\n    ,$imgfile\n    ,$imgsize\n    ,$imgtype\n    ,$imgfld\n    ,$newfilename\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  upload Image File\n// | \u66f8\u5f0f DATABOX_uploadImageFile($imgname,$imgfile,$imgsize, $imgtype,$imgfld)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    $FilePermissions = (int) 0755;\n\n    if (is_uploaded_file ($imgfile)) {\n        //$newfile=$imgfld.$imgname;\n        $newfile=$imgfld.$newfilename;\n        if(!file_exists($newfile)) {\n            $returnMove = move_uploaded_file($imgfile, $newfile); \n            if (!$returnMove) {\n                $logmsg=\"DataBox File upload error: \".$tmp.\" to \".$name;\n                COM_errorLOG($logmsg);\n                return false;\n             } else {\n                $chown =@chmod ($newfile,$FilePermissions);\n                $logmsg=\"DataBox File upload sucsess: \".$imgname;\n                COM_errorLOG($logmsg);\n                return true;\n             }\n         }else{\n            COM_errorLOG(\"DataBox upload error: Temporary file does not exist: '\".$tmp .\"'\");\n            return false;\n         }\n    }\n}\n//\nfunction DATABOX_uploadImageFile_xml (\n    $imgname\n    ,$imgsrc\n    ,$imgfld\n)\n{\n    $FilePermissions = (int) 0755;\n\n    $newfile=$imgfld.$imgname;\n    //\n    $fp = fopen($newfile, \"w\");\n    $imgsrc=base64_decode($imgsrc);\n    fputs($fp, $imgsrc);\n    fclose($fp);\n    \n    if(!file_exists($newfile)) {\n        $logmsg=\"DataBox ImageFile upload error: \".$tmp.\" to \".$name;\n        COM_errorLOG($logmsg);\n        return false;\n    } else {\n        $chown =@chmod ($newfile,$FilePermissions);\n        $logmsg=\"DataBox ImageFile upload sucsess: \".$imgname;\n        COM_errorLOG($logmsg);\n        return true;\n    }\n}\n\nfunction DATABOX_createthumb(\n    $filename\n    , $W\n    , $H\n    , $W2\n    , $H2\n    , $imgfld_thmb\n    , $imgfld\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd uploadfile \u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_createthumb($srcfile,$W,$H,$W2,$H2, $thumb_dir,$tmp_dir)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $srcfile=$imgfld.$filename;\n    // \u753b\u50cf\u306e\u5e45\u3068\u9ad8\u3055\u3068\u30bf\u30a4\u30d7\u3092\u53d6\u5f97\n    $imagesize = GetImageSize($srcfile);\n    $srcfile_w=$imagesize['0'];\n    $srcfile_h=$imagesize['1'];\n    $srcfile_type=$imagesize['2'];\n    //\u5bfe\u8c61\u30bf\u30a4\u30d7\u306e\u78ba\u8a8d\n    switch ($srcfile_type) {\n        case 1 : //gif\n             return false;\n             break;\n        case 2 : //jpg\n             $srcimage = @ImageCreateFromJPEG($srcfile);\n             break;\n        case 3 : //png\n             $srcimage = @ImageCreateFromPNG($srcfile);\n             break;\n    }\n    if (!$srcimage) {\n        return false;\n    }\n    \n    $logmsg=\"size=(w)\".$srcfile_w.\" > \".$w.\" (h)\".$srcfile_h.\" > \".$h;\n    COM_errorLog ($logmsg);\n\n    //\u5bfe\u8c61\u30b5\u30a4\u30ba\u306e\u78ba\u8a8d\n    if ($srcfile_w > $w || $srcfile_h > $h) {\n    }else{\n        return false;\n    }\n        \n    // \u30ea\u30b5\u30a4\u30ba\n    if ($srcfile_w > $W || $srcfile_h > $H) {\n        $key_w = $W / $srcfile_w;\n        $key_h = $H / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n    } else {\n        $out_w = $srcfile_w;\n        $out_h = $srcfile_h;\n    }\n\n    // \u51fa\u529b\u753b\u50cf\uff08\u30b5\u30e0\u30cd\u30a4\u30eb\uff09\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    $outimage = ImageCreateTrueColor($out_w, $out_h);\n    $resize = ImageCopyResampled(\n            $outimage, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n    // \u30b5\u30e0\u30cd\u30a4\u30eb\u753b\u50cf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u51fa\u529b\u3001\u4fdd\u5b58\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $thum_filename = DATABOX_getthumbname($filename);\n       $filename = substr($filename, 0, strrpos($filename,\".\"));\n    touch($imgfld_thmb.$thum_filename);\n    ImageJPEG($outimage, $imgfld_thmb.$thum_filename);\n        \n    // \u51fa\u529b\u753b\u50cf\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    // \u30ea\u30f3\u30af\u5148\u306e\u30b5\u30a4\u30ba\u304c\u8a2d\u5b9a\u5024\u3088\u308a\u5927\u304d\u3044\u6642\u30ea\u30f3\u30af\u5148\u3082\u7e2e\u5c0f\u3059\u308b<-----\n    if ($srcfile_w > $W2 || $srcfile_h > $H2) {\n        $rt = rename($imgfld.$filename.\".jpg\",$imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"rename err!\";\n        }\n\n        $key_w = $W2 / $srcfile_w;\n        $key_h = $H2 / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n        $outimage2 = ImageCreateTrueColor($out_w, $out_h);\n        $resize = ImageCopyResampled(\n            $outimage2, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n        touch($imgfld.$filename.\".jpg\");\n        ImageJPEG($outimage2, $imgfld.$filename.\".jpg\"); \n\n        ImageDestroy($outimage2);\n        $rt=unlink($imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"delete err!\";\n        }\n\n   }\n    \n    // \u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u7834\u68c4\n    ImageDestroy($srcimage);\n    ImageDestroy($outimage);\n\n    return $thum_filename;\n\n}\n//\nfunction DATABOX_getthumbname(\n    $filename\n)\n{\n    $rt=\"\";\n    if ($filename<>\"\"){\n        $filename = substr($filename, 0, strrpos($filename,\".\"));\n        $rt = $filename . \"-small.jpg\";\n    }\n    return $rt;\n}\n//==============================================================================\n\nfunction DATABOX_getradiolist(\n    $ary\n    ,$fld\n    ,$selected = 0\n    ,$br=\"\"\n    ,$disabled=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e9\u30b8\u30f2\u30dc\u30bf\u30f3\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getradiolist\n// |                ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\u5024\u914d\u5217\n// | \u5f15\u6570 $fld:field name\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $br:blank 0 \u6539\u884c\u3057\u306a\u3044 1\u301c9 \u6307\u5b9a\u6570\u6bce\u306b\u6539\u884c\n// | \u5f15\u6570 $disabled:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30e9\u30b8\u30f2\u30dc\u30bf\u30f3                                                   |\n// +---------------------------------------------------------------------------+\n//update 20130704\n{\n    \n    $retval = '';\n    if  ($br===\"\" ) {\n        $br=0;\n    }\n    $cnt=0;\n    foreach( $ary as $id => $value ){\n\n        //echo \"ary\".$i.\"=\".$ary[$i].\"<br>\";\n        $retval .= \"<input type='radio' NAME='$fld' $disabled VALUE='$id'\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( $id == $selected ){\n                $retval .= \" CHECKED=CHECKED \";\n            }\n        }\n        $retval .= \">$ary[$id]&nbsp\";\n        \n        if   ($br<>0){\n            $cnt++;\n            if  ($cnt==$br){\n                $retval .=\"<br\".XHTML.\">\";\n                $cnt=0;\n            }\n        }\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_getoptionlistary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    if  ($type==14 OR $type==18){\n        //$selectedary=array[];\n        $selectedary=explode(\":\",$selected);\n    }\n    if  ($size==\"\" OR $size==0){\n        $size=1;\n    }\n    $retval = '';\n\n    $retval .= \"<select \";\n    if ($type==14 OR $type==18){\n        $retval .= ' name=\"'.$fld.'[]\" ';\n        $retval .= ' multiple=\"multiple\" ';\n        $retval .= ' size=\"'.$size.'\"';\n    }else{\n        $retval .= ' name=\"'.$fld.'\"';\n    }\n    $retval .= $disabled.\">\".LB;\n    \n\tif  ($type==7 ){\n\t\tif  ($ary[0]==\"\"){\n        }else{\n            $retval .= \"<option value=''>{$lang_box['selectit']}</option>\".LB;\n        }\n\t}\n    \n    foreach($ary as $k => $v) {\n        $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n\t\t//echo \"k=\".$k.\"sa=\".$selectedary.\"s=\".$selected.\"<br>\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if  ($type==14 OR $type==18){\n                if( in_array($k,$selectedary) ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t    }else{\n                if( $k == $selected ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t\t}\n\t\t}\n\t\t$retval .= \">\";\n\n        $retval .= $v;\n        $retval .= \"</option>\".LB;\n\n    }\n\n    $retval .= '</select>';\n    \n    return $retval;\n}\n\n\n\nfunction DATABOX_getoptionlist(\n    $kind\n    ,$selected = 0\n    ,$relno=0\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$selectit=true\n    ,$selectlist=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getoptionlist($kind)\n// |      DATABOX_getoptionlist(\"fieldset\",$fieldset_id,0,$pi_name,\"\",0 );\n// |      DATABOX_getoptionlist(\"group\",$categorygroup_id,0,$pi_name,\"\",0 );\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:\u9805\u76ee\u7a2e\u985e\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $relno\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled\n// | \u5f15\u6570 $selectit\n// | \u5f15\u6570 $selectlist\u3000\u65e2\u5b9a\u30ea\u30b9\u30c8\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n//update 20101122,20110613,20120525,20140724\n{\nglobal $_CONF;\nglobal $_TABLES;\nglobal $LANG_configselects;\n    \n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n    \n    \n    $retval = '';\n\n    $retval .= \"<select name='$fname' $disabled>\".LB;\n    if ($selectit===\"all\"){\n        $retval .= \"<option value=\\\"all\\\">{$lang_box['selectall']}</option>\".LB;\n    }elseif ($selectit){\n        $retval .= \"<option value=0>{$lang_box['selectit']}</option>\".LB;\n    }\n    \n    \n    if ($kind==\"layout\"){\n        $retval .= \"<option value=0>{$lang_box['byconfig']}</option>\".LB;\n        $ary=$LANG_configselects[strtolower($pi_name)][22];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$v.\"\\\"\";\n            if( $v == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $k;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else if ($kind==\"language_id\"){\n        $retval .= \"<option value=0> </option>\".LB;\n        $ary=$_CONF['languages'];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n            if( $k == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $v;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else{\n        if ($kind==\"group\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_group'];\n            $fields= 'group_id,name,orderno';\n        }else if ($kind==\"parent\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_category'];\n            $fields= 'category_id,name,orderno';\n        }else if ($kind==\"fieldset\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n            $fields= 'fieldset_id,name,fieldset_id';\n        }else if ($kind==\"selectlist\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT kind,kind,kind';\n        }else if ($kind==\"selectlist_mst\"){\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$selectlist}'\";\n            if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }else if ($kind==\"fieldgroupno\"){\n            $where=\"kind='fieldgroup'\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT no,value,no';\n        }else if ($kind==\"csvsel\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_csv_sel'];\n            $fields= 'csv_sel_id,name,csv_sel_id*-1';\n        }else{\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$kind}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }\n        $retval .= COM_optionList (\n            $table\n            , $fields\n            , $selected,2,$where);\n    }\n    \n    \n    $retval .= '</select>';\n\n    if ($disabled===\"disabled\"){\n        $retval .= \"  <input type='hidden' name='{$fname}' value='{$selected}'>\";\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_dltbldt(\n    $filenm\n    ,$fld\n    ,$tbl\n    ,$where=\"\"\n    ,$order=\"\"\n    ,$pi_name=\"\"\n    ,$addition=false\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30fc\u30d6\u30eb\u306e\u30c7\u30fc\u30bf\u3092CSV\u5f62\u5f0f\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\n// | \u66f8\u5f0f DATABOX_dltbldt($filenm,$fld,$tbl,$where,$order,$type,$pi_name,false);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filenm :\n// | \u5f15\u6570 $fld :\n// | \u5f15\u6570 $tbl :\n// | \u5f15\u6570 $where :\n// | \u5f15\u6570 $order :\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $addition:false=\u8ffd\u52a0\u9805\u76ee\u306a\u3057\u3001 true=\u8ffd\u52a0\u9805\u76ee\u3042\u308a\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//20100910\n//@@@@@ \u8ffd\u52a0\u4e88\u5b9a\u3000\u30ab\u30c6\u30b4\u30ea\u3082\n{\n    global $_CONF;\n\n    $dm=\",\";//\u533a\u5207\u308a\u6587\u5b57\n    $ec=\"`\";//\u30d5\u30a3\u30fc\u30eb\u30c9\u56f2\u307f\u6587\u5b57\n\n    if ($addition){\n        $addition_def=DATABOX_getadditiondef($pi_name);\n    }\n\n    $retval=\"\";\n\n    //file output open\n    $curdatetime = date(\"Y_m_d_H_i_s\");\n    //$outfile = tempnam($_CONF['path_data'] .\"tmp\", $filenm);\n    $outfile = $_CONF['path_data'] . $filenm.\"_\".$curdatetime;\n    $file = @fopen( $outfile, 'w' );\n    if ( $file === false ) {\n        $retval .= \"ERR! \".$outfile .\" is not writable!<br \".XHTML.\">\" . LB;\n        return $retval;\n    }\n\n    //-----\n    $sql = \"SELECT DISTINCT \";\n    foreach($fld as $k => $v) {\n        $sql .=$k.\",\";\n    }\n    $sql=rtrim($sql,\",\");\n    $sql.= \" FROM \".$tbl;\n    if (!empty($where)) {\n        $sql.=\" WHERE \".$where;\n    }\n    if (!empty($order)) {\n        $sql.=\" ORDER BY \".$order;\n    }\n    //-----\n    $result = DB_query ($sql);\n    //-----1\u884c\u76ee\u30d8\u30c3\u30c0\n    $w='';\n    foreach($fld as $k => $v) {\n        $w .=$ec.$k.$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$s[$k1]['templatesetvar'].$ec.$dm;\n            }\n        }\n    }\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n\n    //-----2\u884c\u76ee\u30d8\u30c3\u30c0\n    $w=\"\";\n    foreach($fld as $k => $v) {\n        $w .=$ec.$v['name'].$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$addition_def[$k1]['name'].$ec.$dm;\n            }\n        }\n    }\n\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n    //-----3\u884c\u76ee\u4ee5\u964d\n    while( $A = DB_fetchArray( $result ) )    {\n\n        $w=\"\";\n        foreach($fld as $k => $v) {\n            $w .=$ec.$A[$k].$ec.$dm;\n        }\n//\n        if ($addition){\n            $wkary=DATABOX_getaddtionfields($A[\"id\"],$addition_def,$pi_name);\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                //echo \"k1=\".$k1.\"<br \".XHTML.\">\";\n\n\n                if (isset($wkary[$k1])) {\n                //echo \"wkary=\".$wkary[$k1].\"<br>\";\n                    $w .=$ec.$wkary[$k1].$ec.$dm;\n                }else{\n                //echo \"DD<br>\";\n                    $w .=$ec.$ec.$dm;\n                }\n            }\n        }\n        $w=rtrim($w,$dm);\n\n        $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n        fputs( $file, $w.LB);\n\n    }\n    fclose($file);\n    \n    $filename=basename($outfile).\".csv\";\n    $dir=dirname($outfile);\n\n    header (\"Content-Disposition: attachment; filename=$filename\");\n    header (\"Content-type: application/x-csv\");\n    readfile ($outfile);\n    flush();\n    \n    $rt=unlink($outfile);\n    \n    return \"\";\n}\n\nfunction DATABOX_getfeaturedimage(\n    $id\n    ,$pi_name\n    ,$mode=\"imgsrc\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  featuredimage\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_getfeaturedimage($id,$pi_name)\n// | typw14(\u5916\u753b\u50cf)\u8868\u793a\u3059\u308b\u5148\u982d\uff08\u9806\u756a\u304c\u82e5\u3044\uff09\u8ffd\u52a0\u9805\u76ee\u3092featuredimage\u3068\u3057\u3066\u53d6\u5f97\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:featuredimage\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $tbl1=$_TABLES[strtoupper($pi_name).'_addition'];\n    $tbl2=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $rt=\"\";\n\n    $sql = \"SELECT t1.value\";\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl1} AS t1\";\n    $sql .= \"  ,{$tbl2} AS t2\";\n    $sql .= \"  WHERE t1.id=\".$id;\n    $sql .= \"  AND t1.field_id =t2.field_id\";\n    $sql .= \"  AND t2.type=12\";\n    $sql .= \"  AND allow_display=0\";\n    $sql .= \"  ORDER BY orderno\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n        $value=$A['value'];\n        if  ($value<>\"\"){\n            $url=$_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n            $url.= $value ;\n            if  ($mode==\"imgsrc\"){\n                $rt='<img src=\"'.$url.'\" />';\n            }else{\n                $rt=$url;\n            }\n        }\n    }\n\n    return $rt;\n}\n\nfunction DATABOX_getheadercode(\n    $kind\n    ,$template\n    ,$pi_name\n    ,$id\n    ,$title\n    ,$meta_description\n    ,$meta_keywords\n    ,$description\n    ,$additionfields=\"\"\n    ,$addition_def=\"\"\n    ,$chk_user=\"\"\n    ,$fieldset_id=\"\"\n    ,$fieldset_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd HEADERCODE \u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_getheadercode(\"data\",$template,$pi_name,$A['id'],$A['title']\n// |         ,$A['meta_description'],$A['meta_keyword'],$A['description']);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570  $kind        \"data\",\"category\"\n// | \u5f15\u6570  $template\n// | \u5f15\u6570  $pi_name\n// | \u5f15\u6570  $id\n// | \u5f15\u6570  $title\n// | \u5f15\u6570  $meta_description\n// | \u5f15\u6570  $meta_keywords\n// | \u5f15\u6570  $description\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:HEADERCODE\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n    global $_IMAGE_TYPE;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $retval=\"\";\n    \n    $currenturl= COM_getCurrentURL();\n    $site_logo= $_CONF['layout_url'] . '/images/logo.' . $_IMAGE_TYPE ;\n\n    $og_type=\"article\";\n    $og_title=$title;\n    \n    if ($box_conf['meta_tags'] > 0) {\n         $retval .= COM_createMetaTags($meta_description, $meta_keywords);\n    }\n\n    if ($_CONF['meta_tags']==0 OR $meta_description==\"\") {\n        $og_description = $description;\n    }else{\n        $og_description = $meta_description;\n    }\n    $og_description= COM_getTextContent(PLG_replaceTags($og_description));\n        \n    \n    if ($kind===\"data\"){\n        $og_image =DATABOX_getfeaturedimage($id,$pi_name,\"url\");\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }else{\n        $og_image =$box_conf[\"default_img_url\"];\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }\n    \n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath($kind,$template,$pi_name);\n    if (file_exists ($tmplfld.\"/headercode.thtml\")) {\n        $tpl = new Template($tmplfld);\n        $tpl->set_file (array (\n            'tpl' => 'headercode.thtml',\n            ));\n    \n        $tpl->set_var('xhtml', XHTML);\n        $tpl->set_var('site_url', $_CONF['site_url']);\n        $tpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n        $tpl->set_var('layout_url', $_CONF['layout_url']);\n        \n        $tpl->set_var ('currenturl', htmlspecialchars($currenturl, ENT_QUOTES, 'UTF-8'));\n        \n        $tpl->set_var ('site_name', $_CONF['site_name']);\n        $tpl->set_var ('site_mail', $_CONF['site_mail']);\n        \n        $tpl->set_var ('og_title', $og_title);\n        $tpl->set_var ('og_image', $og_image);\n        $tpl->set_var ('og_description', $og_description);\n        $tpl->set_var ('og_type', $og_type);\n        $tpl->set_var ('fieldset_name', $fieldset_name);\n        \n        //facebook\n        $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n        $tpl->set_var ('facebook_consumer_key', $facebook_consumer_key);\n        \n        if ($kind===\"data\"){\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$tpl,$chk_user,$pi_name,$fieldset_id);\n        }\n    \n        $tpl->parse ('output', 'tpl');\n        $retval .= $tpl->finish ($tpl->get_var ('output'));\n    }\n    return $retval;\n}\n\nfunction DATABOX_getfields(\n    $pi_name\n    , $fieldset_id\n)\n{\n    global $_TABLES;\n    \n    if ($fieldset_id==0){\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    }\n    $fields = array();\n\n    // Get a list of additionfields in the selected field\n    $sql  = \"SELECT DISTINCT field_id \";\n    $sql  .= \" FROM {$table}\";\n    \n    if ($fieldset_id<>0){\n        $sql  .= \" WHERE  \";\n        $sql  .= \" fieldset_id = $fieldset_id\";\n    }\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    \n    if ($num<>0){\n        while ($A = DB_fetchArray($result)) {\n            $fields[] = $A['field_id'];\n        }\n    }\n    \n    return $fields;\n}\n\n\nfunction DATABOX_getAry(\n    $kind\n    ,$relno=0\n    ,$selectlist\n    ,$pi_name=\"\"\n)\n{\n    global $_TABLES;\n\n//    if ($kind==\"selectlist_mst\"){\n        $table=$_TABLES[strtoupper($pi_name).'_mst'];\n        $where=\" WHERE kind='{$selectlist}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n        $fields= 'no,value';\n        $order=\" ORDER BY orderno\"; \n//    }\n\n    $ary=array();\n    $sql = \"SELECT \";\n    $sql .= $fields ;\n    $sql .= \" FROM \" ;\n    $sql .= $table ;\n    $sql .= $where ;\n    $sql .= $order ;\n\n    $result = DB_query($sql);\n    $nrows = DB_numRows($result);\n    for( $i=0; $i < $nrows; $i++) {\n         $A = DB_fetchArray($result, true);\n         $ary[$A[0]] = $A[1];\n    }\n    return $ary;\n}\n\nfunction DATABOX_categorycount(\n    $pi_name\n    ,$categorygroup_id \n    ,$categorygroup_code \n    ,$permission=\"\"\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_categorycount()\n// | \u66f8\u5f0f  databox_categorycount(1)\n// | \u66f8\u5f0f  databox_count(\"\",\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $group_id:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// | \u5f15\u6570 $group_code:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\n// | \u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id \u3082\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\u3082\u6307\u5b9a\u306a\u3044\u5834\u5408\u306f\n// | \u89aa\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u306a\u3057\u306e\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\n// | \uff08\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u3042\u308b\u30c7\u30fc\u30bf\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u306a\u3044\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\u306f\u542b\u307f\u307e\u305b\u3093\uff09\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    //-----\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n    $tbl1=$_TABLES[strtoupper($pi_name).'_category'] ;\n    $tbl4=$_TABLES[strtoupper($pi_name).'_def_group'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_base'] ;\n    if ($categorygroup_id ==\"\" AND $categorygroup_code==\"\") {\n        $categorygroup_id=0;\n    }else{\n        if  ($categorygroup_id==\"\"){\n            $categorygroup_id=DATABOX_codetoid(    $categorygroup_code,strtoupper($pi_name).'_def_group',\"group_id\");\n            if  ($categorygroup_id==0){\n                return 0;\n            }\n        }\n    }\n    \n\n    //-----\n    $sql = \"SELECT \".LB;\n    $sql .= \" t1.category_id\".LB;\n    //$sql .= \" ,Count(t1.id) AS count\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.id = t2.id \".LB;\n    $sql .= \" AND t1.category_id = t3.category_id \".LB;\n    $sql .= \" AND t3.categorygroup_id = \".$categorygroup_id.LB;\n    $sql .= \" AND t3.categorygroup_id = t4.group_id \".LB;\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND',0,2,\"t2\").LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    \n    $sql .= \" GROUP BY \".LB;\n    $sql .= \" t1.category_id\".LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_Confirmation(\n    $pi_name\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u78ba\u8a8d\u753b\u9762\n// | \u66f8\u5f0f Con_firmation(\"databox\")\n//   fnc_Confirmation proversion\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $mode:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $LANG_ADMIN;\n\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $tmpl = new Template ($_CONF['path'] . \"plugins/\".THIS_PLUGIN.\"/templates/admin/\");\n    $tmpl->set_file(array('confirm' => 'confirmation.thtml'));\n\n\n    $tmpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n    $tmpl->set_var('gltoken_name', CSRF_TOKEN);\n    $tmpl->set_var('gltoken', SEC_createToken());\n    $tmpl->set_var ( 'xhtml', XHTML );\n\n    //\n    $actionname=$lang_box_admin[$mode];\n    $actionprg=\"{$_CONF['site_admin_url']}/plugins/\".THIS_SCRIPT.\"?mode={$mode}exec\";\n\n    $tmpl->set_var('actionname', $actionname);\n    $tmpl->set_var('actionprg', $actionprg);\n    \n    $tmpl->set_var('help', $lang_box_admin[$mode.'msg']);\n    $btn_value=$LANG_ADMIN['submit'];\n    $confirm_value=$lang_box_admin['confirm'];\n    $btn2=\"\";\n    $btn3=\"\";\n    if ($mode===\"datadelete\"){\n        $tmpl->set_var('lang_checklist', $lang_box_admin['fieldset'].\":\");\n        $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name);\n        $tmpl->set_var('checklist', $checklist);\n        $btn_value=$lang_box_admin['delete1'];\n        $confirm_value=$lang_box_admin['delete1'].\" \".$lang_box_admin['confirm'];\n        $confirm_value2=$lang_box_admin['delete2'].\" \".$lang_box_admin['confirm'];\n        $confirm_value3=$lang_box_admin['delete3'].\" \".$lang_box_admin['confirm'];\n        $btn2=\"<input type='submit' name='action' value='{$lang_box_admin['delete2']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value2}');\\\"\".xhtml.\">\".LB;\n        $btn3=\"<input type='submit' name='action' value='{$lang_box_admin['delete3']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value3}');\\\"\".xhtml.\">\".LB;\n    }\n\n    // SAVE\u3001CANCEL \u30dc\u30bf\u30f3\n    $tmpl->set_var('lang_confirm', $confirm_value);\n    $tmpl->set_var('lang_submit', $btn_value);\n    $tmpl->set_var('btn2', $btn2);\n    $tmpl->set_var('btn3', $btn3);\n    $tmpl->set_var('lang_cancel', $LANG_ADMIN['cancel']);\n    $tmpl->set_var('mode', $mode.\"exec\");\n\n    $tmpl->parse ('output', 'confirm');\n    $comfirm = $tmpl->finish ($tmpl->get_var ('output'));\n\n    $retval = $comfirm;\n\n\n    return $retval;\n}\n\n//==============================================================================\n//lib_datetimeedit.php \u2192\nfunction DATABOX_datetimeedit(\n    $datetime_value\n    ,$lang\n    ,$datetime_name=\"datetime\"\n    ,$mode=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    if ($datetime_value==\"\"){\n        $datetime_year = date('Y');\n        $datetime_month = date('m');\n        $datetime_day = date('d');\n        //\n        $datetime_hour = date ('H');\n        $datetime_minute = date ('i') ;\n    }else{\n        $datetime_year = date('Y', $datetime_value);\n        $datetime_month = date('m', $datetime_value);\n        $datetime_day = date('d', $datetime_value);\n        //\n        $datetime_hour = date ('H', $datetime_value);\n        $datetime_minute = date ('i', $datetime_value) ;\n    }\n    \n    $rt=\"\";\n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_year);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_month);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_day);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($mode===\"datetime\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_hour, 24);\n        }else{\n            $datetime_hour_wk=$datetime_hour;\n            if ($datetime_hour_wk >= 12) {\n                if ($datetime_hour_wk > 12) {\n                    $datetime_hour_wk = $datetime_hour_wk - 12;\n                }\n                $ampm = 'pm';\n            } else {\n                $ampm = 'am';\n            }\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $ampm);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_hour_wk);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_minute);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_datetimeedit_R(\n    $datetime_ary\n    ,$lang\n    ,$datetime_name=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    \n    if  (!is_array($datetime_ary)){\n        return \"\";\n    }\n    \n    $rt=\"\";\n    \n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_ary['year']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_ary['month']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_ary['day']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($datetime_ary['hour']<>\"\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour'], 24);\n        }else{\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $datetime_ary['ampm']);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour']);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_ary['minute']);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n//==============================================================================\n//lib_outlog.php \u2192\n//log \u51fa\u529b\u30e2\u30fc\u30c9\u8a2d\u5b9a\u30000:\u4f5c\u6210\u3057\u306a\u3044,1:\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b 2:\u753b\u9762\u306b\u3082\u51fa\u529b\n//$logmode =2;\n//$logfile = $_CONF['path_log'] . \"profile_point.log\";\n\n//echo OutLog( \"----- photomailcheck.php start\",$logmode);\n\n\n// \u30ed\u30b0\u51fa\u529b\u51e6\u7406\nfunction DATABOX_OutLog( $logentry ,$logfile,$logmode=1)\n{\n    global $_CONF,$LANG01;\n\n    $retval = '';\n\n    if (!empty($logmode)) {\n        if( !empty( $logentry )) {\n            $logentry = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),\n                                     $logentry );\n\n            $timestamp = strftime( '%c' );\n\n            if (!file_exists($logfile)) {\n                echo $logfile .\"  doesn't exist. \";\n                exit();\n            }\n            if (!is_writable($logfile)) {\n                echo $logfile .\" cannot be written. \";\n                exit();\n            }\n\n            $file = fopen( $logfile, 'a' );\n\n            if( empty($file)) {\n                $retval .= $LANG01[33] . ' ' . $logfile . ' (' . $timestamp . ')<br/><br/>' . LB;\n            } else {\n                fputs( $file, \"$timestamp - $logentry\\n\" );\n            }\n\n            if ($logmode ==2){\n                $retval .=\"$timestamp - $logentry<br/>\" . LB;\n            }\n        }\n    }\n\n    return $retval;\n}\n//==============================================================================\n//lib_getfilelist.php \u2192\n// \u6307\u5b9a\u30d5\u30a9\u30eb\u30c0\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u89a7\u3092\u53d6\u5f97\nfunction DATABOX_getfilelist(\n    $fd\n    ,$exte =\"\"\n)\n{\n    $fary= array();\n    $dir=opendir($fd);\n    while(($ent = readdir()) !==FALSE){\n        if  ($exte==\"\") {\n           $fary[$i] = $ent;\n           $i++;\n        }else{\n            $w=explode('.',$ent);\n            if (strtolower($w[1])===$exte){\n               $fary[$i] = $ent;\n               $i++;\n            }\n        }\n    }\n    return $fary;\n\n}\nfunction DATABOX_getDateTimeFormat( $date,$format )\n{\n    if( empty( $date ))    {\n        $stamp = time();\n    } else if( is_numeric( $date )){\n        $stamp = $date;\n    }else{\n        $stamp = strtotime( $date );\n    }\n    $date = strftime( $format, $stamp );\n    return array( $date, $stamp );\n}\nfunction DATABOX_getTimeFormat( $value )\n{\n    $rt=\"\";\n    if  ($value==\"\"){\n        $rt=\"\";\n    }else{\n        if  ($_CONF['hour_mode']=='24'){\n            $rt=date('H:i', $value );\n        }else{\n            $rt=date('h:i', $value );\n            if  (date('H',$value)>=12){\n                $rt.=\" PM\";\n            }else{\n                $rt.=\" AM\";\n            }\n        }\n    }\n    return $rt;\n}\n\nfunction DATABOX_fieldvalue(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$option = \"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_fieldvalue($pi_name,$id,$code,$field_id,$field_code,$option)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $option:'','name','description','yes','value2','disp','no'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    global $_PLUGINS;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"\";\n    }\n    if (is_null($field_id)){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"\";\n        }\n    }\n          \n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.type \".LB;\n    $sql  .= \" ,m.name \".LB;\n    $sql  .= \" ,m.description \".LB;\n    $sql  .= \" ,m.selection \".LB;\n    $sql  .= \" ,m.selectlist \".LB;\n    $sql  .= \" ,m.dfid \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.allow_display = 0 \".LB;\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n        if  ($option==\"name\"){\n            $rt=$A['name'];\n        }else if ($option==\"description\"){\n            $rt=$A['description'];\n        }else if ($option==\"datatitle\"){\n            if (in_array('databox', $_PLUGINS)) {\n                $rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"title\",\"code='{$A['value']}'\"));\n            }\n        }else if ($option==\"datadescription\"){\n            if (in_array('databox', $_PLUGINS)) {\n\t\t\t\t$rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"description\",\"code='{$A['value']}'\"));\n            }\n        }else{\n            $selectionary=DATABOX_getselectionary($A['selection']);\n            $selectlist=$A['selectlist'];\n            $type=$A['type'];\n            $value=$A['value'];\n            $dfid= $A['dfid'];\n            $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n            if( empty( $format )) {\n                $format = $_CONF['date'];\n            }\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($value===\"\"){\n                    }else{\n                        list($readfile,$rt)=explode(\"|\",$value);\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($value===\"\"){\n                    }else{\n                        $rt=\"<img src=\\\"data:image/jpg;base64,\";\n                        $rt .=\"{$value}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    if  ($option==\"yes\"){\n                        if  ($value==1){\n                            $rt=1;\n                        }\n                    }else{\n                        $rt= $lang_noyes[$value];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $rt= $selectionary[$value];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $rt= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($value);\n                    $w=DATABOX_autolink($w);\n                    $rt= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$value,$pi_name);\n                    $rt= $mstitems['value'];\n                    if  ($option==\"value2\"){\n                        $rt= $mstitems['value2'];\n                    }else if  ($option==\"disp\"){\n                        $rt= $mstitems['disp'];\n                    }else if  ($option==\"no\"){\n                        $rt= $mstitems['no'];\n                    }else{\n                        $rt= $mstitems['value'];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    $wk_no=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                        $wk_no.=$mstitems['no'].$separater;\n                    }\n                    if  ($option==\"value2\"){\n                        $rt= rtrim($wk_value2,$separater);\n                    }else if  ($option==\"disp\"){\n                        $rt= rtrim($wk_disp,$separater);\n                    }else if  ($option==\"no\"){\n                        $rt= rtrim($wk_no,$separater);\n                    }else{\n                        $rt= rtrim($wk,$separater);\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($value<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($value,$format);\n                        $rt= $w[0];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\n                    if  ($value<>\"\"){\n                        $rt=strftime( $_CONF['shortdate'], $value );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $rt= number_format( (float)$value, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $rt= $value;\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_fieldownload(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30a1\u30a4\u30eb\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9 \n// | \u66f8\u5f0f DATABOX_fieldownload($pi_name,$id,$code,$field_id,$field_code)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $mode \u30ca\u30b7\u3001display\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n     \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)  OR $id===\"\"){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"download argument error id\";\n    }\n    if (is_null($field_id) OR $field_id===\"\"){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"download Argument error field_id\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"download drgument error id field_id\";\n        }\n\t}\n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.allow_display \".LB;\n    $sql  .= \" ,d.group_id \".LB;\n    $sql  .= \" ,d.owner_id \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    $sql  .= \" , {$table_base} AS d\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.type = 13 \".LB;\n    $sql  .= \" AND d.id = {$id} \".LB;\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND d.draft_flag=0\".LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\";\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n\t$result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"Target file is not found\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\t\t$value=$A['value'];\n        $group_id = $A['group_id'];\n\t\t$owner_id = $A['owner_id'];\n\t\t$allow_display= $A['allow_display'];\n        $chk_user=DATABOX_chkuser($group_id,$owner_id,$pi_name.\".admin\");\n\t\tif  ($value<>\"\"){\n\t\t\t\n            $chk=false;\n            //\u8868\u793a\u3059\u308b\n            if  ($allow_display==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($allow_display==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($allow_display==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n            //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n\t\t\tif ($chk) {\n\t\t\t\tlist($readfile,$filename)=explode(\"|\",$value);\n\t\t        list($dummy,$extention)=explode(\".\",$filename);\n\t\t        $filetype=DATABOX_getFileTypeAry($extention );\n\t\t        if  ($filetype<>\"\"){\n                    $path=$box_conf['file_path'];\n                    if  (file_exists($path.$readfile)){\n                        if  ($mode==\"display\"){\n                            if  ($extention==\"pdf\"){\n                                header('Content-Type: '.$filetype);\n                                header('Content-Disposition: inline; filename=\"'.$filename.'\"');\n                                readfile($path.$readfile);\n                                //download log\n                                //download count\n                                exit;\n                            }\n                        }else{\n                            header('Content-Type: '.$filetype);\n                            header('Content-Disposition: attachment; filename=\"'.$filename.'\"');\n                            readfile($path.$readfile);\n                            //download log\n                            //download count\n                            exit;\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    return $rt;\n\n}\nfunction DATABOX_getFileTypeAry(\n    $extension \n)\n{\n    $ary=array();\n    $ary['odt']=\"application/vnd.oasis.opendocument.text\";//open office writer*\n    $ary['doc']=\"application/msword\";//Microsoft Word\n    $ary['docx']=\"application/vnd.openxmlformats\";// Microsoft Office Word 2007*\n    $ary['html']=\"text/html\";\n    $ary['odb']=\"application/octet-stream \";//OpenOffice Base*\n    $ary['odf']=\"application/vnd.oasis.opendocument.formula\";//OpenOffice Calc*\n    $ary['odg']=\"application/vnd.oasis.opendocument.graphics\";//OpenOffice Draw*\n    $ary['odm']=\"application/vnd.oasis.opendocument.text-master\";// OpenOffice Writer*\n    $ary['odp']=\"application/vnd.oasis.opendocument.presentation\";//OpenOffice Impress*\n    $ary['ods']=\"application/vnd.oasis.opendocument.spreadsheet\";//OpenOffice Calc*\n    $ary['otg']=\"application/vnd.oasis.opendocument.graphics-template\";//OpenOffice Draw*\n    $ary['oth']=\"application/octet-stream\";// OpenOffice.org Writer*\n    $ary['otp']=\"application/vnd.oasis.opendocument.presentation-template\";//OpenOffice Impress*\n    $ary['ots']=\"application/octet-stream\";//OtsAV*\n    $ary['ott']=\"application/vnd.oasis.opendocument.formula-template \";//OpenOffice Writer*\n    $ary['oxt']=\"application/vnd.openofficeorg.extension\";//OpenOffice *\n    $ary['pdf']=\"application/pdf\";\n    $ary['ppt']=\"application/mspowerpoint\";//Microsoft PowerPoint*\n    $ary['pptx']=\"application/vnd.openxmlformats\";//Microsoft Office PowerPoint 2007*\n    $ary['txt']=\"text/plain\";\n    $ary['xls']=\"application/vnd.ms-excel\";//Microsoft Excel*\n    $ary['xlsx']=\"application/vnd.openxmlformats \";//Microsoft Office Excel 2007*\n    $ary['xml']=\"text/xml\";\n\tif  ($extention===\"\"){\n\t\t$rt= $ary;\n\t}else{\n\t\t$rt= $ary[$extension];\n\t}\n\treturn $rt;\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_count_each_afield(\"class\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n\nfunction DATABOX_count_each_afield(\n    $pi_name=\"databox\"\n    ,$templatesetvar=\"\"\n    ,$value=\"\"\n    ,$type_id=0\n    ,$permission=''\n    ,$numberformat=''\n)\n{\n    global $_TABLES;\n\n    if ($templatesetvar==\"\" OR $value==\"\" ){\n        return \"\";\n    }\n\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n    \n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" t1.id\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    $sql .= \" AND fieldset_id = \".$type_id.LB;\n\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\n    $sql .= \" AND t2.value='\". $value .\"'\".LB;\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_math(\n    $pi_name= 'databox'\n    ,$method= 'count'\n    ,$templatesetvar=\"\"\n    ,$type_id=\"\"\n    ,$category_id=null\n    ,$category_code=null\n    ,$mode=''\n    ,$roundprecision=''\n    ,$numberformat=''\n    ,$permission=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306e\u6307\u5b9a\u5024\uff08count average max min sum\uff09\u3092\u53d6\u5f97\u3059\u308b\n// |       \u8907\u6570\u30ab\u30c6\u30b4\u30ea\u6761\u4ef6\u9078\u629e\u304c\u53ef\u80fd\uff08OR \u3068 AND\uff09\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_math(\"databox\",\"count\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $method:count average avg max min sum\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $category_code :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// | \u5f15\u6570 $roundprecision:\u301c-3,-2,-1,0,1,2,3\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u5024\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($templatesetvar==\"\" ){\n        return \"\";\n    }\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n\t\n\t$method=strtoupper($method);\n    if  ($method==\"MAX\" OR $method==\"MIN\" OR $method==\"SUM\" OR $method==\"AVG\" OR $method==\"COUNT\" ){\n    }else if  ($method==\"AVERAGE\" ){\n\t    $method=\"AVG\";\n\t}else{\n\t    $method=\"COUNT\";\n\t}\n    //-----category check\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,strtoupper($pi_name).'_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $tbl4=$_TABLES[strtoupper($pi_name).'_category'] ;\n\t$tbl5=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n\t\n    $type=DB_getItem( $tbl3   ,\"type\",\"templatesetvar='{$templatesetvar}'\");\n\t\n    //-----\n    $sql = \"SELECT \".LB;\n    \n    if  ($type==15  OR $type==21 OR strtoupper($numberformat)==\"YES\") {\n        $sql .= $method .\"(t2.value + 0) AS rt\".LB;\n    }else{\n        $sql .= $method .\"(t2.value) AS rt\".LB;\n    }\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    \n    $sql .= \" AND fieldset_id=\".$type_id;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\t\n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t4.category_id\";\n                $w.=\" FROM {$tbl4} AS t4 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t1.id = t4.id AND t4.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t1.id IN (SELECT id FROM {$tbl4} AS t4 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t4.category_id = t5.category_id AND t5.allow_display<2 AND t4.category_id IN ({$ids})) \";\n        }\n        $sql.=\" AND ({$w})\".LB;\n    }\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\t\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n\t\t$A = array_map('stripslashes', $A);\n\t\t$rt=$A['rt'];;\n\t}else{\n\t\tif  ($method==\"COUNT\"){\n\t\t\t$rt=0;\n\t\t}else{\n\t\t\t$rt=\"\";\n\t\t}\n\t}\n\t\n    if ( is_numeric($rt) ) {\n        if  (!is_numeric($roundprecision)){\n            $roundprecision=0;\n        }\n        $rt=round($rt,$roundprecision);\n        if  (strtoupper($numberformat)==\"YES\"){\n            $rt=number_format( $rt, \n                $roundprecision, $_CONF['decimal_separator'], $_CONF['thousand_separator'] );\n        }\n    }\n    return $rt;\n\t\n\t\n}\nfunction DATABOX_getcheckboxary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\t\n    $selectedary=explode(\":\",$selected);\n\t\n\t$retval = '';\n\t\n    foreach($ary as $k => $v) {\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fld . '[]\" value=\"' . $k ;\n        $retval .= '\"';\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( in_array($k,$selectedary) ){//@@@@@\n                $retval .= ' checked=\"checked\"';\n\t\t\t}\n\t\t}\n        $retval .= '>' . stripslashes( $v ) . '</span>' . LB;\n\n    }\n    return $retval;\n}\n\n?>", "<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | UserBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | \u81ea\u52d5\u30bf\u30b0\u304a\u3088\u3073 UserBox \u5c02\u7528\u95a2\u6570\n// +---------------------------------------------------------------------------+\n// $Id: plugins/userbox/functions_autotag.inc\n//20101223 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n//20120416 userbox_category {data_edit}\n\nif (strpos ($_SERVER['PHP_SELF'], 'functions_autotag.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n\n//=====\u81ea\u52d5\u30bf\u30b0=================================================================\nfunction plugin_autotags_userbox (\n    $op\n    , $content = ''\n    , $autotag = '')\n// +---------------------------------------------------------------------------+\n// | \u81ea\u52d5\u30bf\u30b0\n// | \u66f8\u5f0f plugin_autotags_userbox ($op, $content, $autotag)\n// +---------------------------------------------------------------------------+\n// 20101229\n{\n    global $_TABLES;\n    global $_CONF;\n    global $LANG_USERBOX_autotag_desc;\n         \n    //Option Display\n    if ($op == 'tagname' ) {\n        $tagname[]='userbox';\n        return $tagname;\n    } elseif ($op == 'permission' || $op == 'nopermission') {\n        if ($op == 'permission') {\n            $flag = true;\n        } else {\n            $flag = false;\n        }\n\n        if (isset($_GROUPS['UserBox Admin'])) {\n            $group_id = $_GROUPS['UserBox Admin'];\n        } else {\n            $group_id = DB_getItem($_TABLES['groups'], 'grp_id',\n                                   \"grp_name = 'UserBox Admin'\");\n        }\n        $owner_id = SEC_getDefaultRootUser();\n\n        if (COM_getPermTag(\n            $owner_id\n            , $group_id\n            , $_USERBOX_CONF['autotag_permissions_userbox'][0]\n            , $_USERBOX_CONF['autotag_permissions_userbox'][1]\n            , $_USERBOX_CONF['autotag_permissions_userbox'][2]\n            , $_USERBOX_CONF['autotag_permissions_userbox'][3]) == $flag) {\n            return $tagname;\n        }\n\n    } elseif ($op == 'description') {\n        return $LANG_USERBOX_autotag_desc;\n    } else if ($op == 'parse') {\n        //\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n        $p1 = COM_applyFilter ($autotag['parm1']);\n        $p2 = COM_applyFilter ($autotag['parm2']);\n        $tag = COM_applyFilter ($autotag['tag']);\n        $tagstr = COM_applyFilter ($autotag['tagstr']);\n        \n        $parm2_ary[]=\"category_id\";\n        $parm2_ary[]=\"category_code\";\n        $parm2_ary[]=\"mode\";\n        $parm2_ary[]=\"rss_file\";\n        $parm2_ary[]=\"title_trim_length\";\n        $parm2_ary[]=\"intervalday\";\n        $parm2_ary[]=\"limitcnt\";\n        $parm2_ary[]=\"newmarkday\";\n        $parm2_ary[]=\"templatedir\";\n        $parm2_ary[]=\"id\";\n        $parm2_ary[]=\"uid\";\n        $parm2_ary[]=\"username\";\n        $parm2_ary[]=\"code\";\n        $parm2_ary[]=\"nohitmsg\";\n        $parm2_ary[]=\"perpage\";\n        $parm2_ary[]=\"page\";\n        $parm2_ary[]=\"order\";\n        $parm2_ary[]=\"templatesetvar\";\n        $parm2_ary[]=\"value\";\n        $parm2_ary[]=\"field_id\";\n        $parm2_ary[]=\"expired\";\n        $parm2_ary[]=\"group_id\";\n        $parm2_ary[]=\"group_code\";\n        $parm2_ary[]=\"field_code\";\n        $parm2_ary[]=\"option\";\n        $parm2_ary[]=\"method\";\n        $parm2_ary[]=\"roundprecision\";\n        $parm2_ary[]=\"numberformat\";\n        $parm2_ary[]=\"permission\";\n        $p=userbox_parm2($p2,$parm2_ary);\n\n        //\u5404\u51e6\u7406\n        switch( $tag ) {\n            case 'userbox' :\n                switch($p1) {\n                    case 'count':\n                        $rt= userbox_count(\n                            $p['category_id']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n                    case 'newlist':\n                            if ($p['category_id']<>\"\"){\n                                $m=\"id\";\n                                $categories=$p['category_id'];\n                            }elseif ($p['category_code']<>\"\") {\n                                $m=\"code\";\n                                $categories=$p['category_code'];\n                            }else{\n                                $m=\"ALL\";\n                                $categories=\"\";\n                            }\n                            $rt= userbox_newlist(\n                            $m\n                            ,$categories\n                            ,$p['rss_file']\n                            ,$p['title_trim_length']\n                            ,$p['intervalday']\n                            ,$p['limitcnt']\n                            ,$p['newmarkday']\n                            ,$p['templatedir']\n                            ,$p['permission']\n                            );\n                        break;\n\n                    case 'profile':\n                        $w= userbox_profile(\n                            $p['uid']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,\"\"\n                            ,$p['username']\n                            );\n                        $rt=$w['display'];\n                        break;\n                    case 'category':\n                        $rt= userbox_category(\n                            \"autotag\"\n                            ,$p['category_id']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['category_code']\n                            ,$p['mode']\n                            ,$p['expired']\n                        );\n                        break;\n                    case 'attributedatacount':\n                        $rt=DATABOX_count_each_afield(\n                            \"userbox\"\n                            ,$p['templatesetvar']\n       \t                    ,$p['value']\n                            ,$p['type_id']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                            );\n                        break;\n                    case 'lastmodified':\n                        $rt= userbox_grp(\n                            \"modified\"\n                            ,\"max\"\n                            ,\"lastmodified\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                        break;\n                    case 'lastcreated':\n                        $rt= userbox_grp(\n                            \"created\"\n                            ,\"max\"\n                            ,\"lastcreated\"\n                            ,$p['category_id']\n                            ,$p['category_code']\n                            );\n                            break;\n                    case 'attribute':\n                        $rt= userbox_field(\n                            \"autotag\"\n                            ,$p['field_id']\n                            ,$p['value']\n                            ,$p['templatedir']\n                            ,$p['nohitmsg']\n                            ,$p['perpage']\n                            ,$p['page']\n                            ,$p['order']\n                            ,$p['field_code']\n                        );\n                        break;\n                    case 'msg':\n                        $rt=userbox_msg($p['for']) ;\n                        break;\n                    case 'categorycount':\n                        $rt= DATABOX_categorycount(\n                             \"userbox\"\n                            ,$p['group_id']\n                            ,$p['group_code']\n                            ,$p['permission']\n                            ,$p['numberformat']\n                        );\n                        break;\n                    case 'attributevalue':\n                        $rt=DATABOX_fieldvalue(\n                                \"userbox\"\n                                ,$p['id']\n                                ,$p['code']\n                                ,$p['field_id']\n                                ,$p['field_code']\n                                ,$p['option']\n                            );\n                        break;\n                    case 'math':\n                        $rt=DATABOX_math(\n                                \"userbox\"\n                                ,$p['method']\n                                ,$p['templatesetvar']\n                                ,$p['type_id']\n                                ,$p['category_id']\n                                ,$p['category_code']\n                                ,$p['mode']\n                                ,$p['roundprecision']\n                                ,$p['numberformat']\n                                ,$p['permission']\n                            );\n                        break;\n                }\n\n                $content = str_replace ($autotag['tagstr'], $rt, $content);\n                return $content;\n        }\n    }\n}\n\n \n\n//\u7b2c\u4e8c\u5f15\u6570\u5206\u5272\nfunction userbox_parm2 ($p2,$parm2_ary)\n{\n    $ary=array();\n    $px = explode (' ', trim ($p2));\n    if (is_array ($px)) {\n        foreach ($px as $part) {\n            $a = explode (':', $part);\n            if (in_array($a[0],$parm2_ary)){\n                $ary[\"{$a[0]}\"]=$a[1];\n                $skip++;            \n            }\n        }\n        \n        if (count ($px) > $skip) {\n            for ($i = 0; $i < $skip; $i++) {\n                array_shift ($px);\n            }\n            $ary[\"lastparm2\"] = trim(implode (' ', $px));\n        }\n\n    }else{\n        $ary[\"lastparm2\"]=trim($p2);\n    }\n    \n    return $ary;\n\n}\n//=====\u30d6\u30ed\u30c3\u30af\u95a2\u6570============================================================\nfunction phpblock_shownewuserbox()\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740data\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f phpblock_shownewuserbox()                                            |\n// +---------------------------------------------------------------------------+\n{\n    return userbox_newlist();\n}\n//=====\u5c02\u7528\u95a2\u6570============================================================\n//\nfunction userbox_category(\n    $autotag\n    ,$category_id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$category_code=null\n    ,$mode=''\n    ,$expired=''\n)\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f  userbox_category($id,$template,\"yes\",\"page\",$perpage)\n// | \u66f8\u5f0f  userbox_category($p['category_id'],$p['thtml'],$p['nohitmsg']\n// | \u66f8\u5f0f                    ,\"\",$p['perpage'],$p['order'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $m             :\"page\"\u306e\u6642\u30d8\u30c3\u30c0\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $code          :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// +---------------------------------------------------------------------------+\n// | public_html/category.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:category list\n// +---------------------------------------------------------------------------+\n{\n    $pi_name=\"userbox\";\n\n    global $_CONF;\n    global $_TABLES;\n\n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n    global $LANG_USERBOX_ADMIN;\n    global $LANG28;\n    global $_USER;\n    \n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n\n    \n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_USERBOX_CONF['loginrequired'] >1) ){\n            return $LANG_USERBOX['loginrequired'];\n        }\n\n    }\n\n    //-----\u30c6\u30fc\u30d6\u30eb\n    $tbl1=$_TABLES['USERBOX_category'] ;\n    $tbl2=$_TABLES['USERBOX_base'] ;\n    $tbl3=$_TABLES['USERBOX_addition'] ;\n    $tbl4=$_TABLES['users'] ;\n    //\n    $tbl5=$_TABLES['USERBOX_def_category'] ;\n    \n    $tbl6=$_TABLES['USERBOX_stats'];\n    \n    $datefield=$_USERBOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n    $new_img=$_USERBOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_USERBOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,'USERBOX_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    \n    //--CATEGORY\n    $category_name=\"\";\n    $defaulttemplatesdirectory = \"\";\n    if (count($idsary)<>0){\n        \n        for ($i = 0; $i < count($idsary); $i++) {\n            $sql = \"SELECT \";\n            $sql .= \" name \".LB;\n            $sql .= \" ,code \".LB;\n            $sql .= \" ,description \".LB;\n            $sql .= \" ,defaulttemplatesdirectory\".LB;\n            $sql .= \" FROM \".LB;\n            $sql .= \" {$tbl5} AS t5 \".LB;\n            $sql .= \" WHERE \".LB;\n            $sql .= \" t5.category_id =\".$idsary[$i].LB;\n        \n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n            if ($numrows > 0) {\n                $A = DB_fetchArray ($result);\n                $category_name.=COM_applyFilter($A['name']).\" \";\n                $category_description.=COM_applyFilter($A['description']).\" \";\n                if ($i==0){\n                    $defaulttemplatesdirectory=COM_applyFilter($A['defaulttemplatesdirectory']);\n                }\n            }\n        }\n    }\n\n    if (is_null($template) or ($template===\"\")){\n        if ($defaulttemplatesdirectory===\"\"){\n            $template=\"default\";\n        }else{\n            $template=$defaulttemplatesdirectory;\n        }\n    }\n    \n    //\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_USERBOX_CONF['perpage'];\n    }\n    //\n    $w=userbox_orderby($datefield,$order,$orderby,$addfieldorder,$field_id);\n\n    //-----    \n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.fieldset_id \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n\n    $sql .= \" ,t4.username\";\n    $sql .= \" ,t4.fullname\";\n    $sql .= \" ,t4.photo\";\n    $sql .= \" ,t4.email\";\n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n    \n    //--FROM\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n    \n    //--WHERE\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t2.id=t4.uid \".LB;\n\n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t1.category_id\";\n                $w.=\" FROM {$tbl1} AS t1 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t2.id = t1.id AND t1.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t2.id IN (SELECT id FROM {$tbl1} AS t1 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t1.category_id = t5.category_id AND t5.allow_display<2 AND t1.category_id IN ({$ids})) \";\n        }\n        $sql.=\" AND ({$w})\".LB;\n    }\n    \n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$field_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND t2.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    if  (strtoupper($expired)==\"NO\"){\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    \n    //--ORDER\n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n    \n    //\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n     if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n\n    //\u81ea\u52d5\u30bf\u30b0\u3067\u306a\u3044\u6642\u3000\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $category_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $category_name);\n        }\n        // Meta Tags\n        $headercode=DATABOX_getheadercode(    \n            \"category\"\n            ,$template\n            ,$pi_name\n            ,$category_id\n            ,$category_name\n            ,$category_description\n            ,$category_name\n            ,$category_description);\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode) ;\n    }\n\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        \n        $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            'pagenav'  => 'pagenavigation.thtml'\n            ));\n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n        \n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_USERBOX['home']);\n\n        $url=$_CONF['site_url'].\"/userbox/category.php\";\n        $category_top=\"<a href='\".$url.\"'>\".$LANG_USERBOX['category_top'].\"</a>\";\n        $templates->set_var ('category_top',$category_top);\n\n        $templates->set_var ('lang_category_list_h2',$LANG_USERBOX['category_list_h2']);\n\n        $templates->set_var ('category_name',$category_name);\n        $templates->set_var ('category_code',$category_code);\n        $templates->set_var ('category_description',$category_description);\n    \n\n        //page\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_USERBOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        $templates->set_var ('lang_name', $LANG_USERBOX_ADMIN['name']);\n\n        $templates->set_var ('lang_username', $LANG_USERBOX_ADMIN['username']);\n        $templates->set_var ('lang_id', $LANG_USERBOX_ADMIN['id']);\n        $templates->set_var ('lang_uid', $LANG28[2]);\n        $templates->set_var ('lang_username', $LANG28[3]);\n        $templates->set_var ('lang_fullname',$LANG28[4]);\n\n        //\n        $templates->set_var ('lang_date', $LANG_USERBOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_USERBOX_ADMIN['released']);\n        $templates->set_var ('lang_expired', $LANG_USERBOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_USERBOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_description', $LANG_USERBOX_ADMIN['description']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        // \u8ffd\u52a0\u9805\u76ee\u306e\u30d8\u30c3\u30c0\n        $addition_def=DATABOX_getadditiondef($pi_name);\n        //\n\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['userbox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['userbox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_USERBOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n            \n        for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $description=COM_applyFilter($A['description']);\n            $username=COM_applyFilter($A['username']);\n            $fullname=COM_applyFilter($A['fullname']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n\n            $value=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n\n            $url=$_CONF['site_url'] . \"/userbox/profile.php\";\n            $url.=\"?\";\n            //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n            if ($_USERBOX_CONF['datacode']){\n                $url.=\"code=\".$A['username'];\n                $url.=\"&amp;m=code\";\n            }else{\n                $url.=\"id=\".$A['id'];\n                $url.=\"&amp;m=id\";\n            }\n            $url = COM_buildUrl( $url );\n            $link= COM_createLink($username, $url);\n\n\n            $templates->set_var ('data_link', $link);\n\n            $templates->set_var ('data_fullname', $A['fullname']);\n            $templates->set_var ('data_title', $A['fullname']);\n\n            $templates->set_var ('data_username', $username);\n            $templates->set_var ('data_code', $username);\n\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $url);\n            $templates->set_var ('data_datefield', $datefield_ary[0]);\n            $templates->set_var ('data_value', $value);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_released', $released_ary[0]);\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            \n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n            \n            //\n            if (isset($A['photo']) && empty($A['photo'])) {\n                $A['photo'] = '(none)'; // user does not have a photo\n                $templates->set_var('data_photo', \"\");\n            }else{\n                $templates->set_var('data_photo', $A['photo']);\n            }\n            $photo = USER_getPhoto($uid, $A['photo'], $A['email'], -1);\n            $templates->set_var('data_user_photo', $photo);\n\n            $hits=COM_applyFilter(DB_getItem( $tbl6 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_USERBOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            \n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_USERBOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"userbox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            $templates->set_var ('data_edit', \"\");\n            if ( SEC_hasRights('userbox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $username.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                $attr = array('class' => 'editlink', 'title' => $username.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/userbox/profile.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                if ($id===$_USER['uid']){\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_USERBOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                    $attr = array('class' => 'editlink', 'title' => $username.\" \".$LANG_USERBOX_ADMIN['edit']);\n                    $url = $_CONF['site_url'];\n                    $url .= '/userbox/myprofile/profile.php';\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                    $templates->set_var ('data_edit', $icon);\n                }\n            }\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'userbox', $templates );\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"userbox/category.php\";\n        }\n        $url .= \"?\";\n        if ($category_code<>\"\"){\n            $url .= \"code=\".$category_code;\n            $url .= \"&amp;m=code\";\n        }else{\n            $url .= \"id=\".$category_id;\n            $url .= \"&amp;m=id\";\n        }\n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;order=\";\n        //-----order navigation\n        userbox_order ($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('blockfooter',COM_endBlock());\n\n        $templates->set_var ('msg', \"\");\n        //@@@@@@@@$templates->set_var ('search_link', $LANG_USERBOX['search_link']);\n        //@@@@@@@@$templates->set_var ('search_var',\"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('category',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            $templates->set_var ('home',$LANG_USERBOX['home']);\n            \n            $url=$_CONF['site_url'].\"/userbox/category.php\";\n            $category_top=\"<a href='\".$url.\"'>\".$LANG_USERBOX['category_top'].\"</a>\";\n            $templates->set_var ('category_top',$category_top);\n\n            $templates->set_var ('category_name',$category_name);\n            $templates->set_var ('category_code',$category_code);\n            $templates->set_var ('category_description',$category_description);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_USERBOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n        }\n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    //return $dbg.$retval;\n    return $retval;\n}\n\n\n\n\n\nfunction userbox_count(\n    $category_id =null\n    ,$category_code =null\n    ,$mode=''\n    ,$permission=\"\"\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  userbox_count()\n// | \u66f8\u5f0f  userbox_count(1)\n// | \u66f8\u5f0f  userbox_count(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n\n    //-----\n    $tbl1=$_TABLES['USERBOX_base'] ;\n    $tbl2=$_TABLES['USERBOX_category'] ;\n    \n    //\u30ab\u30c6\u30b4\u30ea\u306e\u6307\u5b9a\u304c\u306a\u3051\u308c\u3070\u5168\u4ef6\u3001\u3042\u308c\u3070\u30ab\u30c6\u30b4\u30ea\u6bce\n    $exp=\"\";\n    if (is_null($category_id) AND is_null($category_code) ){\n    }else{\n        $ids=\"\";\n        $idsary=array();\n        if (is_null($category_id) OR $category_id==0){\n            if (is_null($category_code)){\n            }else{\n                $w=explode(\"|\",$category_code);\n                foreach( $w as $val ){\n                    if ($ids<>\"\"){\n                        $ids.=\",\";\n                    }\n                    $w_id=DATABOX_codetoid($val,'USERBOX_def_category',\"category_id\");\n                    $idsary[]=$w_id;\n                    $ids.=$w_id;\n                }\n            }\n        }else{\n            $ids=$category_id;\n            $idsary[]=$category_id;\n        }\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT category_id\";\n                $w.=\" FROM {$tbl2} AS t2 \";\n                $w.=\" WHERE t2.id = t1.id)\";\n            }\n        }else{\n            $w= \"id IN (SELECT id FROM {$tbl2} \";\n            $w.=\"WHERE category_id IN ({$ids})) \";\n        }\n        $exp=$w.LB;\n    }\n\n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" distinct t1.id \".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n\n    $sql .= \" WHERE \".LB;\n    \n    if ($exp<>\"\"){\n        $sql .= $exp. \" AND \";\n    }\n    \n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\n\n\nfunction userbox_grp(\n    $field=null\n    ,$function=null\n    ,$format=null\n    ,$category_id =null\n    ,$category_code =null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u96c6\u8a08\u8868\u793a(max min sum)\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  userbox_grp()\n// | \u66f8\u5f0f  userbox_grp(1)\n// | \u66f8\u5f0f  userbox_grp(\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $field:\u9805\u76ee\u3000\u30c7\u30d5\u30a9\u30eb\u30c8modified\n// | \u5f15\u6570 $function:\u95a2\u6570\u3000\u30c7\u30d5\u30a9\u30eb\u30c8max\n// | \u5f15\u6570 $format:\u66f8\u5f0f\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\u3000\uff08\u512a\u5148\uff09\n// | \u5f15\u6570 $category_code:\u30ab\u30c6\u30b4\u30ea\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c7\u30fc\u30bf\u7dcf\u6570\u3001\u30ab\u30c6\u30b4\u30ea\u5225\u30c7\u30fc\u30bf\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLEdS;\n    global $LANG_USERBOX;\n\n    $rt=\"\";\n\n    if (is_null($field) ){\n        $field=\"id\";\n    }\n    if (is_null($function) ){\n        $function=\"max\";\n    }\n\n    if (is_null($category_id) AND is_null($category_code) ){\n        $m=\"ALL\";\n    }else{\n        if (is_null($category_id) ){\n            $category_id=DATABOX_codetoid($category_code,'USERBOX_def_category',\"category_id\");\n        }\n        $m=\"CATEGORY\";\n    }\n    //-----\n    $tbl1=$_TABLES['USERBOX_base'] ;\n    $tbl2=$_TABLES['USERBOX_category'] ;\n\n    //-----\n    $sql=LB;\n    $sql .= \"SELECT \".LB;\n\n    $sql .= \" {$function}(t1.{$field}) AS rt\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@--------->\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND').LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@<---------\n\n    if ($m===\"ALL\"){\n    }else{\n        $sql .= \" AND t1.id = t2.id \".LB;\n        $sql .= \" AND t2.category_id= \".$category_id .LB;\n    }\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n\n        $rt=$A['rt'];\n\n        if ($rt<>\"\"){\n            switch($format){\n                case \"lastmodified\":// '%Y\u5e74%m%e\u65e5\u66f4\u65b0';\n                case \"lastcreated\"://'%Y\u5e74%m%e\u65e5\u8ffd\u52a0';\n                    $fm=$LANG_USERBOX[$format];\n                    $rt=strftime($fm,strtotime($rt));\n                    break;\n                default:\n                    break;\n            }\n        }\n\n    }\n\n    return $rt;\n\n}\n\nfunction userbox_profile(\n    $id=null\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$m=\"\"\n    ,$code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u500b\u5225\u30c7\u30fc\u30bf\u8868\u793a\n// | \u66f8\u5f0f  userbox_profile($id,$template,\"yes\",\"page\")\n// | \u66f8\u5f0f  userbox_profile($p['id'],$p['thtml'],$p['nohitmsg'],$p['code']\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id            :\n// | \u5f15\u6570 $template      :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306edirectory\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $m             :\"page\"\u306e\u6642\u30d8\u30c3\u30c0\u8868\u793a\n// | \u5f15\u6570 $code          :\n// +---------------------------------------------------------------------------+\n// | public_html/profile.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u76f4\u8fd1\u306b\u5909\u66f4\u307e\u305f\u306f\u8ffd\u52a0\u3055\u308c\u305f\u30c7\u30fc\u30bf\u3092\u8fd4\u3057\u307e\u3059\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:profile\n// +---------------------------------------------------------------------------+\n// 20120125\n{\n    $pi_name=\"userbox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_IMAGE_TYPE;\n    global $_USER;\n\n    global $LANG28;\n    global $LANG04;\n    \n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n    global $LANG_USERBOX_ADMIN;\n    \n    global $LANG_confignames;\n    \n    $layout=$_DATABOX_CONF['layout'];\n    //-----\n    if (is_null($id) AND (is_null($code))){\n        $id=$_USER['uid'];\n    }\n\n    if (is_null($id)  OR ($id==0)){\n        if ($code<>\"\"){\n            $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n        }\n    }\n\n    //-----\n    $display = '';\n\n\n    $tbl=$_TABLES['USERBOX_base'] ;\n    $tbl1=$_TABLES['users'] ;\n    $tbl4=$_TABLES['USERBOX_def_fieldset'];\n    $tbl5=$_TABLES['USERBOX_stats'];\n\n    $addition_def=DATABOX_getadditiondef($pi_name);\n\n    //-----\n    $sql = \"SELECT t.* \";\n    \n    $sql .= \" ,UNIX_TIMESTAMP(t.modified) AS modified_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.released) AS released_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.comment_expire) AS comment_expire_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.expired) AS expired_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.created) AS created_un\";\n    $sql .= \" ,UNIX_TIMESTAMP(t.udatetime) AS udatetime_un\";\n    \n    $sql .= \" ,t.fieldset_id\";\n\n    $sql .= \" ,t1.username \";\n    $sql .= \" ,t1.fullname \";\n    $sql .= \" ,t1.photo \";\n    $sql .= \" ,t1.email\";\n    $sql .= \" ,t3.username AS last_modify_name\";\n    $sql .= \" ,t3.fullname AS last_modify_fullname\";\n    \n    $sql .= \" ,t4.name AS set_name\";\n    $sql .= \" ,t4.description AS set_description\";\n    $sql .= \" ,t4.defaulttemplatesdirectory AS set_defaulttemplatesdirectory\";\n    $sql .= \" ,t4.layout AS set_layout\";\n    \n    $sql .= \" ,t5.hits\";\n\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl} AS t \";\n    $sql .= \" JOIN {$tbl4} AS t4       ON t.fieldset_id=t4.fieldset_id\";\n    $sql .= \" JOIN {$tbl1} AS t1       ON t.id=t1.uid\";//owner\n    $sql .= \" LEFT JOIN  {$tbl5} AS t5 ON t.id=t5.id\";\n    $sql .= \" LEFT JOIN  {$tbl1} AS t3 ON t.uuid=t3.uid\";//last_updateowner\n\n    $sql .= \" WHERE \";\n\n\n    if (is_null($id)){//@@@@@\n        $sql .= \"1=1\";\n    }else{\n        $sql .= \" t.id=\".$id;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\n    if ( SEC_hasRights('userbox.admin') OR $m===\"view\") {\n    }else{\n        //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n       $sql .= \" AND t.draft_flag=0\".LB;\n        //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (released <= NOW())\";\n\n        //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n        $sql .= \" AND (expired=0 OR expired > NOW())\";\n    }\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n\n    if (is_null($id)){\n        $sql .= \" ORDER BY \".$_USERBOX_CONF['datefield'] . \" DESC \";\n        $sql .= \" LIMIT 0 , 1\";\n    }\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    \n    if  ($m===\"page\"  OR  $m===\"view\"){\n        if ($numrows <= 0) {\n            COM_handle404();\n            exit;\n        }\n    }\n\n    if ($numrows > 0) {\n\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\t\t\n\t\t$cache_time=$A['cache_time'];\n        $cache=false;\n\t\tif  ($cache_time===0){\n\t\t}else{\n\t\t    if  ($m===\"page\"){\n                if ($cache_time > -1 ) {\n                    // Don't need to cache per theme since not rendered in a block yet \n                    $cacheInstance = 'userbox__' . $id . '__' . CACHE_security_hash();\n                    $retval = CACHE_check_instance($cacheInstance);\n                    if ($retval AND $cache_time == -1) {\n                        return $retval;\n                    } elseif ($retval AND $cache_time > 0) {        \n                        $lu = CACHE_get_instance_update($cacheInstance);\n                        $now = time();\n                        if (($now - $lu) < $cache_time) {\n                            return $retval;\n                        } else {\n                            $retval = '';\n                        }\n                   }    \n                }\n            }\n\t    }\n        \n        if  ($cache){\n            $display = CACHE_check_instance($cacheInstance.\"_display\",$display);\n            $layout = CACHE_check_instance($cacheInstance.\"_layout\",$layout);\n            $headercode = CACHE_check_instance($cacheInstance.\"_headercode\",$headercode);\n            $title = CACHE_check_instance($cacheInstance.\"_title\",$title);\n        }else{\n\t\t\t\n            if (is_null($template) or ($template===\"\")){\n                if ($A['defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['defaulttemplatesdirectory'];\n                }elseif  ($A['set_defaulttemplatesdirectory']<>\"\"){\n                    $template=$A['set_defaulttemplatesdirectory'];\n                }else{\n                    $template=\"default\";\n                }\n           }\n\n\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            $fieldset_id= $A['fieldset_id'];\n            if ($m===\"view\"){\n                $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n            }else{\n                $chk_user=DATABOX_chkuser($group_id,$owner_id,\"userbox.admin\");\n            }\n            //\n            $id=$A['id'];\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n\n            //\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af start.............\n            if ($m===\"page\"){\n                if  ($A['set_layout']<>\"0\") {\n                    $layout=$A['set_layout'];\n                }\n                $title= $A['page_title'];\n                if ($title===\"\"){\n                    $title =$A['username'];\n                }\n                // Meta Tags\n                $headercode=DATABOX_getheadercode(    \n                    \"profile\"\n                    ,$template\n                    ,$pi_name\n                    ,$A['id']\n                    ,$title\n                    ,$A['meta_description']\n                    ,$A['meta_keywords']\n                    ,$A['description']);\n            }\n\n            $tmplfld=DATABOX_templatePath('profile',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'list_detail.thtml',\n                'row'   => 'row.thtml',\n                'col'   => \"col_detail.thtml\",\n                ));\n            $languageid=COM_getLanguageId();\n            $language= COM_getLanguage();\n            $templates->set_var ('languageid', $languageid);\n            $templates->set_var ('language', $language);\n            if ($languageid<>\"\") {\n                $templates->set_var ('_languageid', \"_\".$languageid);\n            }else{\n                $templates->set_var ('_languageid', \"\");\n            }\n\n            $templates->set_var ('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var ('site_url',$_CONF['site_url']);\n        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n        \n            $templates->set_var ('site_name', $_CONF['site_name']);\n            $templates->set_var ('site_mail', $_CONF['site_mail']);\n        \n            $currenturl= COM_getCurrentURL();\n            $templates->set_var ('currenturl', htmlspecialchars($currenturl, ENT_QUOTES, 'UTF-8'));\n            //facebook\n            $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n            $templates->set_var ('facebook_consumer_key', $facebook_consumer_key);\n            //\n\n            //daft_flag\u7ba1\u7406\u8005\u306e\u6642\n            if ($A['draft_flag']==1){\n                $templates->set_var ('draft', \"draft!\");\n            }else{\n                $templates->set_var ('draft', \"\");\n            }\n            //------------\n\n            //id\n            $templates->set_var('lang_id', $LANG_USERBOX_ADMIN['id']);\n            $templates->set_var ('id', $A['id']);\n\n            $templates->set_var('lang_fields', $LANG_USERBOX_ADMIN['fields']);\n            $templates->set_var('lang_field', $LANG_USERBOX_ADMIN['field']);\n            $templates->set_var('lang_templatesetvar', $LANG_USERBOX_ADMIN['templatesetvar']);\n            $templates->set_var('lang_content', $LANG_USERBOX_ADMIN['content']);\n            $templates->set_var('lang_type', $LANG_USERBOX_ADMIN['type']);\n            $templates->set_var('lang_byusingid', $LANG_USERBOX_ADMIN['byusingid']);\n            $templates->set_var('lang_byusingcode', $LANG_USERBOX_ADMIN['byusingcode']);\n            $templates->set_var('lang_byusingtemplatesetvar', $LANG_USERBOX_ADMIN['byusingtemplatesetvar']);\n            $templates->set_var('lang_group', $LANG_USERBOX_ADMIN['group']);\n            $templates->set_var('lang_withlink', $LANG_USERBOX_ADMIN['withlink']);\n            $templates->set_var('lang_groupbygroup', $LANG_USERBOX_ADMIN['groupbygroup']);\n\n            $templates->set_var('lang_uid', $LANG28['2']);\n            $templates->set_var('lang_username', $LANG28['3']);\n            $templates->set_var ('username', $A['username']);\n            $templates->set_var('lang_fullname', $LANG28['4']);\n            $templates->set_var ('fullname', $A['fullname']);\n        \n            $templates->set_var('lang_photo', $LANG04['77']);\n            if (isset($A['photo']) && empty($A['photo'])) {\n                $A['photo'] = '(none)'; // user does not have a photo\n                $templates->set_var('photo', \"\");\n            }else{\n                $templates->set_var('photo', $A['photo']);\n            }\n            //$photo = USER_getPhoto($A['id'], $A['photo'], $A['email'], -1);\n            //$templates->set_var('user_photo', $photo);\n        \n        \n            //$_USERBOX_CONF\n            $templates->set_var('lang_imgfile_frd', $LANG_confignames['userbox']['imgfile_frd']);\n            $templates->set_var ('imgfile_frd', $_USERBOX_CONF['imgfile_frd']);\n            $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_frd']);\n            $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['userbox']['imgfile_thumb_frd']);\n            $templates->set_var ('imgfile_thumb_frd', $_USERBOX_CONF['imgfile_thumb_frd']);\n            $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_thumb_frd']);\n\n            //\u57fa\u672c\u9805\u76ee\n            $templates->set_var('lang_basicfields', $LANG_USERBOX_ADMIN['basicfields']);\n            //\u30b3\u30fc\u30c9\uff06\u30bf\u30a4\u30c8\u30eb\uff06\u8aac\u660e\n            $templates->set_var('lang_code', $LANG_USERBOX_ADMIN['code']);\n            $templates->set_var ('code', $A['username']);\n            $templates->set_var('lang_title', $LANG_USERBOX_ADMIN['title']);\n            $templates->set_var ('title',$A['fullname']);\n\n            $templates->set_var('lang_description', $LANG_USERBOX_ADMIN['description']);\n            $templates->set_var ('description',$A['description']);\n        \n            $templates->set_var('lang_draft', $LANG_USERBOX_ADMIN['draft']);\n            if ($A['draft_flag']){\n                $templates->set_var ('draft',$LANG_USERBOX_ADMIN['draft']);\n            }else{\n                $templates->set_var ('draft',\"\");\n            }\n            //hits\n            $templates->set_var('lang_hits', $LANG_USERBOX_ADMIN['hits']);\n            $templates->set_var ('hits', $A['hits']);\n            //\u30ab\u30c6\u30b4\u30ea@@@@@\n            $templates->set_var('lang_category', $LANG_USERBOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee\n            $templates->set_var('lang_additionfields', $LANG_USERBOX_ADMIN['additionfields']);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n\n            //\u7de8\u96c6\u65e5\u4ed8\n            $templates->set_var('lang_modified', $LANG_USERBOX_ADMIN['modified']);\n            $wary = COM_getUserDateTimeFormat($A['modified_un']);\n            $templates->set_var ('modified',$wary[0]);\n            $templates->set_var ('modified_shortdate', strftime( $_CONF['shortdate'], $A['modified_un'] ));\n            $templates->set_var ('modified_date', strftime( $_CONF['date'], $A['modified_un'] ));\n            $templates->set_var ('modified_daytime', strftime( $_CONF['daytime'], $A['modified_un'] ));\n            $templates->set_var ('modified_dateonly', strftime( $_CONF['dateonly'], $A['modified_un'] ));\n            $templates->set_var ('modified_timeonly', strftime( $_CONF['timeonly'], $A['modified_un'] ));\n            $templates->set_var ('modified_b', strftime( \"%b\" , $A['modified_un']));\n            $templates->set_var ('modified_B', strftime( \"%B\" , $A['modified_un']));\n            $templates->set_var ('modified_d', strftime( \"%d\" , $A['modified_un']));\n            $templates->set_var ('modified_e', strftime( \"%e\" , $A['modified_un']));\n            //\u4f5c\u6210\u65e5\u4ed8\n            $templates->set_var('lang_created', $LANG_USERBOX_ADMIN['created']);\n            $wary = COM_getUserDateTimeFormat($A['created_un']);\n            $templates->set_var ('created', $wary[0]);\n            $templates->set_var ('created_shortdate', strftime( $_CONF['shortdate'], $A['created_un'] ));\n            $templates->set_var ('created_date', strftime( $_CONF['date'], $A['created_un'] ));\n            $templates->set_var ('created_daytime', strftime( $_CONF['daytime'], $A['created_un'] ));\n            $templates->set_var ('created_dateonly', strftime( $_CONF['dateonly'], $A['created_un'] ));\n            $templates->set_var ('created_timeonly', strftime( $_CONF['timeonly'], $A['created_un'] ));\n            $templates->set_var ('created_b', strftime( \"%b\" , $A['created_un']));\n            $templates->set_var ('created_B', strftime( \"%B\" , $A['created_un']));\n            $templates->set_var ('created_d', strftime( \"%d\" , $A['created_un']));\n            $templates->set_var ('created_e', strftime( \"%e\" , $A['created_un']));\n            //\u516c\u958b\u65e5\n            $templates->set_var('lang_released', $LANG_USERBOX_ADMIN['released']);\n            $wary = COM_getUserDateTimeFormat($A['released_un']);\n            $templates->set_var ('released', $wary[0]);\n            $templates->set_var ('released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('released_e', strftime( \"%e\" , $A['released_un']));\n             //\u516c\u958b\u7d42\u4e86\u65e5\n            $templates->set_var('lang_expired', $LANG_USERBOX_ADMIN['expired']);\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('expired', \"\");\n                $templates->set_var ('expired_shortdate', \"\" );\n                $templates->set_var ('expired_date', \"\" );\n                $templates->set_var ('expired_daytime', \"\" );\n                $templates->set_var ('expired_dateonly', \"\" );\n                $templates->set_var ('expired_timeonly', \"\" );\n                $templates->set_var ('expired_b', \"\" );\n                $templates->set_var ('expired_B', \"\" );\n                $templates->set_var ('expired_d', \"\" );\n                $templates->set_var ('expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('expired', $wary[0]);\n                $templates->set_var ('expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('expired_date', strftime( $_CONF['date'], $A['expired_un'] ));\n                $templates->set_var ('expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n\n            $templates->set_var ('lang_uuid', $LANG_USERBOX_ADMIN['uuid']);\n            $templates->set_var ('uuid', $A['uuid']);\n\n            $templates->set_var ('lang_udatetime', $LANG_USERBOX_ADMIN['udatetime']);\n            $wary = COM_getUserDateTimeFormat($A['udatetime_un']);\n            $templates->set_var ('udatetime', $wary[0]);\n            $templates->set_var ('last_modify_uid', $A['uuid']);\n            $templates->set_var ('last_modify_name', $A['last_modify_name']);\n            $templates->set_var ('last_modify_fullname', $A['last_modify_fullname']);\n\n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            $templates->set_var ('edit', \"\");\n\n            if ($m<>\"view\"){\n\n                if ( SEC_hasRights('userbox.admin')) {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $A['username'].\" \".$LANG_USERBOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                    $attr = array('class' => 'editlink', 'title' => $A['username'].\" \".   $LANG_USERBOX_ADMIN['edit']);\n                    $url = $_CONF['site_admin_url'];\n                    $url .= '/plugins/userbox/profile.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                    $templates->set_var ('edit', $icon);\n                }else{\n                    if ($id===$_USER['uid']){\n                        $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                        $attr = array('title' => $LANG_USERBOX_ADMIN['edit']);\n                        $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                        $attr = array('class' => 'editlink', 'title' => $A['username'].\" \".$LANG_USERBOX_ADMIN['edit']);\n                        $url = $_CONF['site_url'];\n                        $url .= '/userbox/myprofile/profile.php';\n                        $icon = '&nbsp;' ;\n                        $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                        $templates->set_var ('edit', $icon);\n                    }\n                }\n            }\n            // Call to plugins to set template variables in the databox\n            PLG_templateSetVars( 'userbox', $templates );\n\n            //------------\n            $templates->parse ('output', 'list');\n\n            $userbox_content = $templates->finish ($templates->get_var ('output'));\n            $display=$userbox_content;\n\t\t\t\n            if ($A['draft_flag']!==1){\n                if (!SEC_hasRights('userbox.admin')) {\n                    $id=$A['id'];\n                    $hits=DB_getItem($_TABLES['USERBOX_stats'],\"hits\",\"id={$id}\");\n                    if (empty($hits)) {\n                        $hits=0;\n                    }\n                    $fields.=\"id,hits \";\n                    $values.=\"$id,$hits + 1\";\n                    DB_save($_TABLES['USERBOX_stats'],$fields,$values);\n                }\n            }\n        }\n    }else{\n        $cache_time=0;\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('profile',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            $templates->set_var ('lang_nohit', $LANG_USERBOX['nohit']);\n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n\n            $templates->parse ('output', 'list');\n            $databox_content = $templates->finish ($templates->get_var ('output'));\n            $display =$databox_content;\n            \n        }\n    }\n    $display =PLG_replacetags ($display);\n\t\t\n    if  (($cache_time > 0 OR $cache_time == -1)  AND  $m===\"page\" ){\n        CACHE_create_instance($cacheInstance.\"_display\", $display); \n        CACHE_create_instance($cacheInstance.\"_layout\", $layout); \n        CACHE_create_instance($cacheInstance.\"_headercode\", $headercode); \n        CACHE_create_instance($cacheInstance.\"_title\", $title); \n    }\n\n    $retval['display']=$display;\n    $retval['layout']=$layout;\n    $retval['headercode']=$headercode;\n    $retval['title']=$title;\n\n\n    return $retval;\n}\n\n\n\nfunction userbox_field(\n    $autotag\n    ,$field_id=null\n    ,$value=\"\"\n    ,$template=null\n    ,$nohitmsg=\"\"\n    ,$perpage =0\n    ,$page=null\n    ,$order=null\n    ,$field_code=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u5225\u4e00\u89a7\u8868\u793a\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $autotag:notautotag\u306e\u6642\u30d8\u30c3\u30c0\u3092\u8868\u793a\u3057\u306a\u3044\n// | \u5f15\u6570 $field_id:\u8ffd\u52a0\u5c5e\u6027id\n// | \u5f15\u6570 $value:\u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u5024\n// | \u5f15\u6570 $template:\u4f7f\u7528\u3059\u308b\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u30d5\u30a9\u30eb\u30c0\u540d\n// | \u5f15\u6570 $nohitmsg      :\"yes\"\u306e\u6642nohit\u30e1\u30c3\u30bb\u30fc\u30b8\u8868\u793a\n// | \u5f15\u6570 $perpage       :1page\u3042\u305f\u308a\u306e\u4ef6\u6570\u30010\u306e\u6642\u6539\u30da\u30fc\u30b8\u306a\u3057\n// | \u5f15\u6570 $page           :\n// | \u5f15\u6570 $order         :\u9806\u5e8f\n// | \u5f15\u6570 $field_code    :\n// +---------------------------------------------------------------------------+\n// | public_html/attribute.php \u304a\u3088\u3073\u3000\u81ea\u52d5\u30bf\u30b0\u3067\u4f7f\u7528\n// | \u30d8\u30c3\u30c0\u306f\u30b3\u30f3\u30d5\u30a3\u30ae\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u306b\u3088\u308a\u8868\u793a\u3055\u308c\u306a\u3044\u5834\u5408\u304c\u3042\u308a\u307e\u3059\n// | id\u3082code\u3082\u6307\u5b9a\u3055\u308c\u306a\u3044\u5834\u5408\u306f\u3001\u5168\u30ab\u30c6\u30b4\u30ea\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:category list\n// +---------------------------------------------------------------------------+\n{\n    $pi_name=\"userbox\";\n\n    global $_CONF;\n    global $_TABLES;\n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n    global $LANG_USERBOX_ADMIN;\n    global $LANG_USERBOX_NOYES;\n    global $_IMAGE_TYPE;\n    global $LANG_confignames;\n\n    //\u30ed\u30b0\u30a4\u30f3\u8981\u5426\u30c1\u30a7\u30c3\u30af\n    if (COM_isAnonUser()){\n        if  ($_CONF['loginrequired']\n                OR ($_USERBOX_CONF['loginrequired'] >1) ){\n            return $LANG_USERBOX['loginrequired'];\n        }\n\n    }\n    //-----table assign\n    $tbl1=$_TABLES['USERBOX_addition'] ;\n    $tbl2=$_TABLES['USERBOX_base'] ;\n    $tbl3=$_TABLES['USERBOX_addition'] ;\n    $tbl4=$_TABLES['users'] ;\n    $tbl5=$_TABLES['USERBOX_stats'];\n    \n    //\u65e5\u4ed8\u95a2\u9023\n    $datefield=$_USERBOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n    $new_img=$_USERBOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $newmarkday=$_USERBOX_CONF['newmarkday'];\n    if ($newmarkday==\"\"){\n        $newmarkday=3;\n    }\n    $chkday=strtotime(\"- $newmarkday days\",time());\n\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($value) OR $value===\"\") {\n        return;\n    }\n    if (is_null($field_id)){\n        if ($field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,'USERBOX_def_field',\"field_id\",\"templatesetvar\");\n\n        }\n    }\n    if ($field_id===0) {\n        return;\n    }\n    \n    if ($field_code===\"\"){\n        $field_code=DB_getItem( $_TABLES['USERBOX_def_field']\n                 ,\"templatesetvar\",\"field_id={$field_id}\");\n    }\n    $field_def=DATABOX_getadditiondef($pi_name);\n    $type=$field_def[$field_id]['type'];\n    $w = array(0,2,3,4,7,8,9,16);\n    if (in_array ($type,$w)){\n    }else{\n        return;\n    }\n\n    if (is_null($page) OR !isset($page) OR $page == 0) {\n        $page = 1;\n    }\n\n    if ($perpage===0 OR is_null($perpage)){\n        $perpage=$_USERBOX_CONF['perpage'];\n    }\n\n\n    $w=userbox_orderby($datefield,$order,$orderby,$addfieldorder,$orderfield_id);\n    $field_def[$field_id]['name'];\n    $field_name=$field_def[$field_id]['name'];\n    $field_templatesetvar=$field_def[$field_id]['templatesetvar'];\n    $field_description=$field_def[$field_id]['description'];\n\n    $fieldvalue=DATABOX_getfieldvalue(\n          $value\n         ,$field_def[$field_id]['type']\n         ,$field_def[$field_id]['selectionary']\n         ,$LANG_USERBOX_NOYES\n         ,$field_def[$field_id]['selectlist']\n         ,$pi_name\n          );\n\n\n    if (is_null($template) or ($template===\"\")){\n        $template=\"default\";\n    }\n\n\n    //-----\n    $sql = \"SELECT \";\n\n    $sql .= \" t2.id \".LB;\n    $sql .= \" ,t2.description \".LB;\n    $sql .= \" ,t2.released \".LB;\n    $sql .= \" ,t2.\".$datefield.\" AS datefield \".LB;\n    $sql .= \" ,t2.expired \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.\".$datefield.\") AS datefield_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.released ) AS released_un \".LB;\n    $sql .= \" ,UNIX_TIMESTAMP(t2.expired ) AS expired_un \".LB;\n\n    $sql .= \" ,t2.group_id\";\n    $sql .= \" ,t2.owner_id\";\n    $sql .= \" ,t2.fieldset_id \".LB;\n\n    $sql .= \" ,t4.username\";\n    $sql .= \" ,t4.fullname\";\n    $sql .= \" ,t4.photo\";\n    $sql .= \" ,t4.email\";\n    \n    if ($addfieldorder){\n        $sql .= \" ,t3.value \".LB;\n    }\n\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n    if ($addfieldorder){\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.field_id = \".$field_id.LB;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t1.value = \\\"\".$value.\"\\\"\".LB;\n    $sql .= \" AND t2.id=t4.uid \".LB;\n    if ($addfieldorder){\n        $sql .= \" AND t3.field_id=\".$orderfield_id.LB;\n        $sql .= \" AND t3.id=t2.id\".LB;\n    }\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('userbox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND',0,2,\"t2\");\n\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    \n    $sql .= \" ORDER BY \".LB;\n    $sql .= $orderby.LB;\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n\n    $pages = 0;\n    if ($perpage > 0) {\n        $pages = ceil($cnt / $perpage);\n    }\n    $offset = ($page - 1) * $perpage;\n    $sql .= \" LIMIT $offset, $perpage\";\n    \n    //\u30d8\u30c3\u30c0\u3001\u5de6\u30d6\u30ed\u30c3\u30af\n    if ($autotag===\"notautotag\"){\n        if ($page > 1) {\n            $page_title = sprintf ('%s (%d)', $field_name, $page);\n        } else {\n            $page_title = sprintf ('%s ', $field_name);\n        }\n        $headercode=DATABOX_getheadercode(    \n            \"attribute\"\n            ,$template\n            ,$pi_name\n            ,$field_id\n            ,$field_name\n            ,$field_description\n            ,$field_name\n            ,$field_description);\n        $retval .= DATABOX_siteHeader($pi_name,'',$page_title,$headercode);\n    }\n    \n    $addition_def=DATABOX_getadditiondef($pi_name);\n    //\n    $url=$_CONF['site_url'].\"/userbox/attribute.php\";\n    $attribute_top=\"<a href='\".$url.\"'>\".$LANG_USERBOX['attribute_top'].\"</a>\";\n    $url=$_CONF['site_url'].\"/userbox/attribute.php\";\n    $url.=\"?\";\n    $url.=\"id=\".$field_id;\n    $url.=\"&amp;m=id\";\n    $field_top=\"<a href='\".$url.\"'>\".$field_name.$LANG_USERBOX['countlist'].\"</a>\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n        $templates = new Template($tmplfld);\n        $templates->set_file (array (\n            'list' => 'list_detail.thtml',\n            'nav'   => 'navigation_detail.thtml',\n            'row'   => 'row.thtml',\n            'col'   => \"col_detail.thtml\",\n            'pagenav'  => 'pagenavigation.thtml'\n            ));\n        \n        $languageid=COM_getLanguageId();\n        $language= COM_getLanguage();\n        $templates->set_var ('languageid', $languageid);\n        $templates->set_var ('language', $language);\n        if ($languageid<>\"\") {\n            $templates->set_var ('_languageid', \"_\".$languageid);\n        }else{\n            $templates->set_var ('_languageid', \"\");\n        }\n        \n        //\n        $templates->set_var ('site_url',$_CONF['site_url']);\n        $templates->set_var ('this_script',THIS_SCRIPT);\n\n        //bread\n        $templates->set_var ('home',$LANG_USERBOX['home']);\n        $templates->set_var ('attribute_top',$addition_top);\n        $templates->set_var ('field_top',$field_top);\n        \n        $templates->set_var ('field_name',$field_name);\n        $templates->set_var ('field_templatesetvar',$field_templatesetvar);\n        $templates->set_var ('field_description',$field_description);\n\n        $templates->set_var ('fieldvalue',$fieldvalue);\n\n        //page\n        $offset = ($page - 1) * $perpage;\n        $templates->set_var ('cnt', $cnt);\n        $lin1=$offset+1;\n        $lin2=$lin1+$perpage - 1;\n        if ($lin2>$cnt){\n            $lin2=$cnt;\n        }\n\n        //summary navigation\n        $templates->set_var ('lang_view', $LANG_USERBOX['view']);\n        $templates->set_var ('lin', $lin1.\"-\".($lin2));\n        $templates->set_var ('cnt', $cnt);\n\n        $templates->set_var ('lang_name', $LANG_USERBOX_ADMIN['name']);\n\n        $templates->set_var ('lang_username', $LANG_USERBOX_ADMIN['username']);\n        $templates->set_var ('lang_id', $LANG_USERBOX_ADMIN['id']);\n        $templates->set_var ('lang_uid', $LANG28[2]);\n        $templates->set_var ('lang_username', $LANG28[3]);\n        $templates->set_var ('lang_fullname',$LANG28[4]);\n\n        //\n        $templates->set_var ('lang_date', $LANG_USERBOX_ADMIN[$datefield]);\n        $templates->set_var ('lang_released', $LANG_USERBOX_ADMIN['released']);\n        $templates->set_var ('lang_description', $LANG_USERBOX_ADMIN['description']);\n        $templates->set_var ('lang_expired', $LANG_DATABOX_ADMIN['expired']);\n        $templates->set_var ('lang_remaingdays', $LANG_DATABOX_ADMIN['remaingdays']);\n        $templates->set_var ('lang_addfield', $addfield_name);\n        \n        //$_USERBOX_CONF\n        $templates->set_var('lang_imgfile_frd', $LANG_confignames['userbox']['imgfile_frd']);\n        $templates->set_var ('imgfile_frd', $_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var ('data_img_url', $_CONF['site_url'].\"/\".$_USERBOX_CONF['imgfile_frd']);\n        $templates->set_var('lang_imgfile_thumb_frd', $LANG_confignames['userbox']['imgfile_thumb_frd']);\n        $templates->set_var ('imgfile_thumb_frd', $_USERBOX_CONF['imgfile_thumb_frd']);\n        $templates->set_var ('data_thumb_img_url', $_CONF['site_url'].\"/\".$_DATABOX_CONF['imgfile_thumb_frd']);\n        \n         for ($i = 0; $i < $numrows; $i++) {\n            $A = DB_fetchArray ($result);\n            $A = array_map('stripslashes', $A);\n\n            $description=COM_applyFilter($A['description']);\n            $username=COM_applyFilter($A['username']);\n            $fullname=COM_applyFilter($A['fullname']);\n            $id=COM_applyFilter($A['id']);\n            $datefield=COM_applyFilter($A['datefield']);\n            $released=COM_applyFilter($A['released']);\n            $expired=COM_applyFilter($A['expired']);\n            $datefield_ary = COM_getUserDateTimeFormat($A['datefield_un']);\n            $released_ary = COM_getUserDateTimeFormat($A['released_un']);\n            if ($expired===\"0000-00-00 00:00:00\"){\n                $expired_ary=array();\n            }else{    \n                $expired_ary = COM_getUserDateTimeFormat($A['expired_un']);\n            }\n            $curdate_ary =  COM_getUserDateTimeFormat();\n            \n            $sortvalue=COM_applyFilter($A['value']);\n            $group_id = $A['group_id'];\n            $owner_id = $A['owner_id'];\n            \n            $fieldset_id=COM_applyFilter($A['fieldset_id']);\n\n            $url=$_CONF['site_url'] . \"/userbox/profile.php\";\n            $url.=\"?\";\n            //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n            if ($_USERBOX_CONF['datacode']){\n                $url.=\"m=code\";\n                $url.=\"&amp;code=\".$A['username'];\n            }else{\n                $url.=\"id=\".$A['id'];\n                $url.=\"&amp;m=id\";\n            }\n            $url = COM_buildUrl( $url );\n            $link= COM_createLink($username, $url);\n\n\n            $templates->set_var ('data_link', $link);\n\n            $templates->set_var ('data_fullname', $fullname);\n            $templates->set_var ('data_title', $fullname);\n\n            $templates->set_var ('data_username', $username);\n            $templates->set_var ('data_code', $username);\n\n            $templates->set_var ('data_description', $description);\n            $templates->set_var ('data_id', $id);\n            $templates->set_var ('data_url', $url);\n            //data_released\n            $templates->set_var ('data_datefield', $datefield);\n            $templates->set_var ('data_datefield_shortdate', strftime( $_CONF['shortdate'], $A['datefield_un'] ));\n            $templates->set_var ('data_value', $sortvalue);\n            \n            $templates->set_var ('data_released', $released_ary[0]);//@@@@@@\n            $templates->set_var ('data_released_shortdate', strftime( $_CONF['shortdate'], $A['released_un'] ));\n            $templates->set_var ('data_released_date', strftime( $_CONF['date'], $A['released_un'] ));\n            $templates->set_var ('data_released_daytime', strftime( $_CONF['daytime'], $A['released_un'] ));\n            $templates->set_var ('data_released_dateonly', strftime( $_CONF['dateonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_timeonly', strftime( $_CONF['timeonly'], $A['released_un'] ));\n            $templates->set_var ('data_released_b', strftime( \"%b\" , $A['released_un']));\n            $templates->set_var ('data_released_B', strftime( \"%B\" , $A['released_un']));\n            $templates->set_var ('data_released_d', strftime( \"%d\" , $A['released_un']));\n            $templates->set_var ('data_released_e', strftime( \"%e\" , $A['released_un']));\n            //\u516c\u958b\u7d42\u4e86\u65e5 Expired to publish\n            if ($A['expired'] ===\"0000-00-00 00:00:00\"){\n                $templates->set_var ('data_expired', \"\");\n                $templates->set_var ('data_expired_shortdate', \"\" );\n                $templates->set_var ('data_expired_date', \"\" );\n                $templates->set_var ('data_expired_daytime', \"\" );\n                $templates->set_var ('data_expired_dateonly', \"\" );\n                $templates->set_var ('data_expired_timeonly', \"\" );\n                $templates->set_var ('data_expired_b', \"\" );\n                $templates->set_var ('data_expired_B', \"\" );\n                $templates->set_var ('data_expired_d', \"\" );\n                $templates->set_var ('data_expired_e', \"\" );\n            }else{\n                $wary = COM_getUserDateTimeFormat($A['expired_un']);\n                $templates->set_var ('data_expired', $expired_ary[0]);\n                $templates->set_var ('data_expired_shortdate', strftime( $_CONF['shortdate'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_daytime', strftime( $_CONF['daytime'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_dateonly', strftime( $_CONF['dateonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_timeonly', strftime( $_CONF['timeonly'], $A['expired_un'] ));\n                $templates->set_var ('data_expired_b', strftime( \"%b\" , $A['expired_un']));\n                $templates->set_var ('data_expired_B', strftime( \"%B\" , $A['expired_un']));\n                $templates->set_var ('data_expired_d', strftime( \"%d\" , $A['expired_un']));\n                $templates->set_var ('data_expired_e', strftime( \"%e\" , $A['expired_un']));\n            }\n            $remaingdays=\"\";\n            if ($expired<>\"0000-00-00 00:00:00\") {\n                if  ($expired_ary[1]>=$curdate_ary[1]){\n                    $remaingdays=COM_dateDiff( \"d\", $expired_ary[1], $curdate_ary[1] ) + 1;\n                }\n            }\n            $templates->set_var ('data_remaingdays', $remaingdays);//@@@@@@\n\n            if (date(\"Ymd\",strtotime($datefield)) >= date(\"Ymd\",$chkday)){\n                $templates->set_var ('new_img', $new_img);\n            }else{\n                $templates->set_var ('new_img', '');\n            }\n\n            if (isset($A['photo']) && empty($A['photo'])) {\n                $A['photo'] = '(none)'; // user does not have a photo\n                $templates->set_var('data_photo', \"\");\n            }else{\n                $templates->set_var('data_photo', $A['photo']);\n            }\n            $photo = USER_getPhoto($uid, $A['photo'], $A['email'], -1);\n            $templates->set_var('data_user_photo', $photo);\n\n            $hits=COM_applyFilter(DB_getItem( $tbl5 ,\"hits\",\"id={$id}\"),true);\n            $templates->set_var('lang_hits', $LANG_USERBOX_ADMIN['hits']);\n            $templates->set_var('data_hits', $hits);\n            //\u30ab\u30c6\u30b4\u30ea categories \n            $templates->set_var('lang_category', $LANG_DATABOX_ADMIN['category']);\n            DATABOX_getcategoriesDisp($A['id'],$templates,$chk_user,0,$pi_name);\n\n            //\u8ffd\u52a0\u9805\u76ee fields\n            $group_id = stripslashes($A['group_id']);\n            $owner_id = stripslashes($A['owner_id']);\n            $chk_user=DATABOX_chkuser($group_id,$owner_id,\"userbox.admin\");\n            $additionfields = DATABOX_getadditiondatas($id,$pi_name);\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$templates,$chk_user,$pi_name,$fieldset_id);\n            \n            //\u7ba1\u7406\u8005\u306e\u6642\u300c\u7de8\u96c6\u300d\n            if ( SEC_hasRights('databox.admin')) {\n                $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                $attr = array('title' => $title.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n                \n                $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_USERBOX_ADMIN['edit']);\n                $url = $_CONF['site_admin_url'];\n                $url .= '/plugins/userbox/profile.php';\n                $url .= '?mode=edit';\n                $url .= '&amp;'.\"id={$id}\";\n                $icon = '&nbsp;' ;\n                $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n                $templates->set_var ('data_edit', $icon);\n            }else{\n                $rt=databox_chk_loaddata($id);\n                //\u7de8\u96c6\u6a29\u9650\u306e\u3042\u308bMyProfile\n                if ( $rt===\"OK\") {\n                    $icon_url = $_CONF['layout_url'] . '/images/edit.' . $_IMAGE_TYPE;\n                    $attr = array('title' => $LANG_USERBOX_ADMIN['edit']);\n                    $editiconhtml = COM_createImage($icon_url, $LANG_USERBOX_ADMIN['edit'], $attr);\n\n                    $attr = array('class' => 'editlink', 'title' => $title.\" \".$LANG_USERBOX_ADMIN['edit']);\n\n                    $url = $_CONF['site_url'];\n                    $url .= '/databox/myprofile/profile.php';\n                    $url .= '?mode=edit';\n                    $url .= '&amp;'.\"id={$id}\";\n\n                    $icon = '&nbsp;' ;\n                    $icon .=  COM_createLink( $editiconhtml,  $url,   $attr   );\n\n                    $templates->set_var ('data_edit', $icon);\n                }else{\n                    $templates->set_var ('data_edit', \"\");\n                }\n                \n            }\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('row_var', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n\n        //------------\n        //-----navigation\n        $url = $_CONF['site_url']  . '/';\n        if ($autotag===\"notautotag\"){\n            $url.=THIS_SCRIPT;\n        }else{\n            $url.=\"userbox/field.php\";\n        }\n        $url .=\"?\";\n        $url .= \"id=\".$field_id;\n        $url .= \"&amp;m=id\";\n        $url .= \"&amp;value=\".$value;\n        $url .= \"&amp;template=\".$template;\n        $url .= \"&amp;perpage=\".$perpage;\n        $url .= \"&amp;order=\";\n        //-----order navigation\n        userbox_order ($url, $templates, $order) ;\n        //-----page navigation\n        $url .= $order;\n        $templates->set_var ('page_navigation',\n                COM_printPageNavigation ($url, $page, $pages));\n        if ($order===\"random\"){\n            $templates->set_var ( 'pagenavinone', 'style=\"display:none;\"' );\n        }else{\n            $templates->set_var ( 'pagenavinone', '' );\n        }\n        // Call to plugins to set template variables in the databox\n        PLG_templateSetVars( 'userbox', $templates );\n\n        //------------\n        $templates->parse ('nav_var', 'nav', true);\n\n        $templates->set_var ('msg', \"\");\n\n        $templates->parse ('output', 'list');\n\n        $content = $templates->finish ($templates->get_var ('output'));\n        $retval .=$content;\n\n    }else{\n        if ($nohitmsg===\"yes\"){\n            $tmplfld=DATABOX_templatePath('attribute',$template,$pi_name);\n            $templates = new Template($tmplfld);\n            $templates->set_file (array (\n                'list' => 'nohit.thtml',\n            ));\n            \n            //bread\n            $templates->set_var ('home',$LANG_USERBOX['home']);\n            $templates->set_var ('attribute_top',$attribute_top);\n            $templates->set_var ('field_top',$field_top);\n            \n            $templates->set_var ('field_name',$field_name);\n            $templates->set_var ('field_templatesetvar',$templatesetvar);\n            $templates->set_var ('field_description',$field_description);\n            \n            $templates->set_var ('fieldvalue',$fieldvalue);\n                        \n            $templates->set_var('xhtml', XHTML);\n            $templates->set_var('site_url', $_CONF['site_url']);\n            $templates->set_var('site_admin_url', $_CONF['site_admin_url']);\n            $templates->set_var('layout_url', $_CONF['layout_url']);\n            \n            $templates->set_var ('lang_nohit', $LANG_USERBOX['nohit']);\n\n            $templates->parse ('output', 'list');\n            $content = $templates->finish ($templates->get_var ('output'));\n            $retval .=$content;\n        }\n    }\n\n    $retval =PLG_replacetags ($retval);\n\n    return $retval;\n}\n\nfunction userbox_orderby(\n    $datefield\n    ,&$order\n    ,&$orderby\n    ,&$addfieldorder\n    ,&$field_id\n\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  order orderby addfieldorder $field_id \u3092\u7de8\u96c6\n// | \u66f8\u5f0f  userbox_orderby($datefield,$order,$orderby,$addfieldorder,$field_id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $datefield\n// | \u5f15\u6570\u623b\u5024 $order\n// | \u5f15\u6570\u623b\u5024 $orderby\n// | \u5f15\u6570\u623b\u5024 $addfieldorder\n// | \u5f15\u6570\u623b\u5024 $field_id\n// +---------------------------------------------------------------------------+\n{\n\n    global $_TABLES;\n\n    $orderby=\"\";\n    $addfieldorder=false;\n    switch($order){\n        case \"random\":\n            $orderby =\" RAND()\";\n            break;\n        case \"\":\n        case \"date\":\n            $order=\"date\";\n            $orderby = $datefield .\" DESC\";\n            break;\n        case \"released\":\n            $orderby = \" released DESC\";\n            break;\n        case \"orderno\":\n        case \"code\":\n        case \"title\":\n        case \"description\":\n        case \"id\":\n            $orderby = \" t2.\".$order;\n            break;\n        case \"username\":\n        case \"fullname\":\n            $orderby = \" t4.\".$order;\n            break;\n        default:\n            $sql=\"SELECT \";\n            $sql.= \" field_id \";\n            $sql.= \",name \";\n            $sql.=\" FROM\";\n            $sql.=\" {$_TABLES['USERBOX_def_field']} \";\n            $sql.=\" WHERE templatesetvar='\".$order.\"'\";\n\n            $result = DB_query ($sql);\n            $numrows = DB_numRows ($result);\n\n            if ($numrows>0){\n                $A = DB_fetchArray ($result);\n                $field_id=COM_stripslashes($A['field_id']);\n                $addfield_name=COM_stripslashes($A['name']);\n                $orderby = \" t3.value IS NULL ASC ,cast(t3.value as DECIMAL) ASC \";\n                $addfieldorder=true;\n            }else{\n                $order=\"date\";\n                $orderby = $datefield .\" DESC\";\n            }\n    }\n\n    return ;\n\n}\n\n\nfunction userbox_newlist(\n     $m=\"ALL\"\n    ,$categories=\"\"\n    ,$rss_file=\"\"\n    ,$title_trim_length=\"\"\n    ,$intervalday=\"\"\n    ,$limitcnt=\"\"\n    ,$newmarkday=\"\"\n    ,$thtml=null\n    ,$permission=null\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d6\u30ed\u30c3\u30af\u7528 \u65b0\u7740user\u4e00\u89a7\u51fa\u529b                                         |\n// | \u66f8\u5f0f userbox_newlist                                                      |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $m             :\u7701\u7565\u6642'ALL' id=id\u6307\u5b9a\u3067\u9078\u629e code\u6307\u5b9a\u3067\u9078\u629e           |\n// | \u5f15\u6570 $categories    :\u9078\u629e\u30c8\u30d4\u30c3\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or'ALL'                     |\n// | \u5f15\u6570 $rss_file      :RSS_file     \u7701\u7565\u6642\"\"                                |\n// | \u5f15\u6570 $title_trim_length :\u30bf\u30a4\u30c8\u30eb\u9577\u306e\u5236\u9650 \u7701\u7565\u6642\u8a2d\u5b9a\u5024or20                |\n// | \u5f15\u6570 $intervalday   :\u65b0\u7740\u8a18\u4e8b\u306e\u671f\u9593 \u5358\u4f4d\u65e5  \u7701\u7565\u6642\u8a2d\u5b9a\u5024or90              |\n// |                      0\u306e\u6642\u3000\u5168\u4ef6                                          |\n// | \u5f15\u6570 $limitcnt      :\u8868\u793a\u4ef6\u6570   \u7701\u7565\u6642\u8a2d\u5b9a\u5024or10                          |\n// | \u5f15\u6570 $newmarkday    :\u65b0\u7740\u30de\u30fc\u30af \u7701\u7565\u6642\u8a2d\u5b9a\u5024or3                           |\n// | \u5f15\u6570 $thtml         :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a1\u30a4\u30eb\u306e\u30d5\u30a9\u30eb\u30c0  layout/\u30c6\u30fc\u30de/XXXX/  |\n// |                      \u7701\u7565\u6642\u306f\u3001\u30d7\u30e9\u30b0\u30a4\u30f3\u5185\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8                 |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u65b0\u7740user\u4e00\u89a7                                                   |\n// +---------------------------------------------------------------------------+\n// update20101124\n{\n    $pi_name=\"userbox\";\n\n    global $_USER;\n    global $_TABLES;\n    global $_CONF;\n\n    global $_USERBOX_CONF;\n    global $LANG_USERBOX;\n\n    //\n    if ($title_trim_length==\"\"){\n        $title_trim_length=$_USERBOX_CONF['title_trim_length'];\n        if ($title_trim_length==\"\"){\n            $title_trim_length=20;\n        }\n    }\n    //\n    if ($intervalday==\"\"){\n        $intervalday=$_USERBOX_CONF['intervalday'];\n        if ($intervalday==\"\"){\n            $intervalday=90;\n        }\n    }\n    //\n    if ($limitcnt==\"\"){\n        $limitcnt=$_USERBOX_CONF['limitcnt'];\n        if ($limitcnt==\"\"){\n            $limitcnt=10;\n        }\n    }\n    if ($newmarkday==\"\"){\n        $newmarkday=$_USERBOX_CONF['newmarkday'];\n        if ($newmarkday==\"\"){\n            $newmarkday=3;\n        }\n    }\n\n    if ($m===\"\"){\n        $categories=\"ALL\";\n    }else{\n        if ($categories==\"\"){\n            $categories=$_USERBOX_CONF['categories'];\n            if ($categories==\"\"){\n                $categories=\"ALL\";\n            }\n        }elseif (strpos($categories,\",\")==\"\") {\n            $categories=\"'$categories'\";\n        }else{\n            $ary=explode(\",\",$categories);\n            $b=\"\";\n            for ($i = 1; $i <= count($ary); $i++) {\n                if ($m===\"code\"){\n                    $b.=\"'\".current($ary).\"',\";\n                }else{\n                    $b.=current($ary).\",\";\n                }\n                next($ary);\n            }\n            $categories=rtrim($b,\",\");\n        }\n    }\n\n    //\n    $new_img=$_USERBOX_CONF['new_img'];\n    if ($new_img==\"\"){\n        $new_img=\"New!\";\n    }\n    $rss_img=$_USERBOX_CONF['rss_img'];\n    if ($rss_img==\"\") {\n        $rss_img=\"[RSS]\";\n    }\n\n    if (is_null($thtml)){\n        $thtml=\"default\";\n    }\n\n//-------------------------------------------\n    $retval=\"\";\n\n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath('newlist',$thtml,$pi_name);\n\n    $list = new Template($tmplfld);\n    $list->set_file (array (\n        'list' => 'list.thtml',\n        'col'   => 'list_col.thtml'\n    ));\n\n    $datefield=$_USERBOX_CONF['datefield'];//\u4f7f\u7528\u3059\u308b\u65e5\u4ed8\uff08\u7de8\u96c6\u65e5\u4ed8\u3001\u4f5c\u6210\u65e5\u4ed8\uff09\n\n    //-----\n    $tbl1=$_TABLES['USERBOX_base'] ;\n    $tbl2=$_TABLES['USERBOX_category'] ;\n    $tbl3=$_TABLES['USERBOX_def_category'] ;\n    $tbl4=$_TABLES['users'] ;\n\n\n    $sql=\"SELECT \".LB;\n    $sql.=\" t4.fullname\".LB;\n    $sql.=\" , UNIX_TIMESTAMP(t1.\".$datefield .\") AS day\".LB;\n    $sql.=\" , t1.id\".LB;\n\t$sql.=\" , t4.username\".LB;\n\n    $sql.=\" ,t1.owner_id\".LB;\n    $sql.=\" ,t1.group_id\".LB;\n    $sql.=\" ,t1.perm_owner\".LB;\n    $sql.=\" ,t1.perm_group\".LB;\n    $sql.=\" ,t1.perm_members\".LB;\n    $sql.=\" ,t1.perm_anon\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" , {$tbl4} AS t4 \".LB;\n\n    if ($categories!==\"ALL\" ){\n        $sql .= \" ,{$tbl2} AS t2 \".LB;\n        $sql .= \" ,{$tbl3} AS t3 \".LB;\n    }\n\n    $sql.=\" WHERE\";\n    if ($categories===\"ALL\" ){\n        $sql.=\" t1.id=t4.uid\".LB;\n    }else{\n        $sql.= \" t1.id = t4.id \".LB;\n        $sql.= \" AND t1.id=t2.uid\".LB;\n        $sql.= \" AND t2.category_id = t3.category_id \".LB;\n    }\n\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('userbox.admin')) {\n    //}else{\n       $sql .= \" AND t1.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  ($_USERBOX_CONF['disable_permission_ignore']==\"0\" AND strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n\n    if ($intervalday<>0){\n        $sql.=\" AND (\".$datefield .\" >= (date_sub(NOW(), INTERVAL $intervalday day)))\".LB;\n    }\n\n    if ($categories!==\"ALL\" ){\n        if ($m===\"id\") {\n            $sql.=\" AND t2.category_id IN ($categories)\";\n        }else{\n            $sql.=\" AND t3.code IN ($categories)\";\n        }\n    }\n    $sql .= COM_getLangSQL ('username', 'AND', 't4').LB;\n\n    $sql.=\" ORDER BY \".$datefield .\" DESC\";\n    $sql.=\" LIMIT $limitcnt\";\n\n    $result = DB_query ($sql);\n\n    $i=0;\n\n    while( $A = DB_fetchArray( $result ) )    {\n\n        $title= COM_truncate( $A['username'], $title_trim_length,'...' );\n\n        $url=$_CONF['site_url'] . \"/userbox/profile.php\";\n        $url.=\"?\";\n        //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n        if ($_USERBOX_CONF['datacode']){\n            $url.=\"m=code\";\n            $url.=\"&code=\".$A['username'];\n        }else{\n            $url.=\"m=id\";\n            $url.=\"&id=\".$A['id'];\n        }\n        $url = COM_buildUrl( $url );\n        $link= COM_createLink($title, $url);\n\n\n        $list->set_var ('site_url', $_CONF['site_url']);\n\n        $list->set_var ('day', strftime($LANG_USERBOX['day'],$A['day']));\n\n        $chkday=strtotime(\"- $newmarkday days\",time());\n        if (date(\"Ymd\",$A['day']) >= date(\"Ymd\",$chkday)){\n            $list->set_var ('new_img', $new_img);\n        }else{\n            $list->set_var ('new_img', '');\n        }\n        $list->set_var ('link', $link);//@@@@@\n\n        $list->set_var ('url', $url);\n\t\t$list->set_var ('title', $title);\n\n        $permission=SEC_hasAccess2($A);\n        $list->set_var ('permission',$permission);\n        if  ($permission>=2){\n            $list->set_var ('class_a', 'class=\"gl-tooltip\"');\n            $list->set_var ('class_c', 'class=\"classic\"');\n        }else{\n            $list->set_var ('class_a', 'class=\"userbox_nolink\"');\n            $list->set_var ('class_c', 'class=\"userbox_displaynon\"');\n        }\n\n        $n=($i%2)+1;\n        $class='class=\"row'.$n.'\"';\n        $list->set_var ('class', 'class=\"row'.$n.'\"');\n        \n        //\u30ab\u30c6\u30b4\u30ea\n        DATABOX_getcategoriesDisp($A['id'],$list,$chk_user,0,$pi_name);\n\n        $list->parse ('list_col', 'col', true);\n\n        $i++;\n    }\n\n    $list->set_var ('site_url', $_CONF['site_url']);\n    $list->set_var ('day', strftime($LANG_USERBOXBOX['day'],$A['day']));\n\n    //\n    if ($rss_file<>\"\"){\n        $list->set_var ('rss_url', $_CONF['site_url'] . '/backend/'.$rss_file);\n        $list->set_var ('rss_title', $rss_img);\n    }\n    //\n    $more_title=$LANG_USERBOX['more'];\n    if ($categories===\"ALL\" OR strpos($categories,\",\")<>\"\") {\n        $more_url=COM_buildUrl($_CONF['site_url'] . '/userbox/index.php');//\n    }else{\n        //\u30b3\u30fc\u30c9\u4f7f\u7528\u306e\u6642\n        if ($m=\"code\"){\n            $more_url.=\"m=code\";\n            $more_url.=\"&code=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }else{\n            $more_url.=\"m=id\";\n            $more_url.=\"&id=\".ltrim(rtrim($categories,\"'\"),\"'\");\n        }\n        $more_url=$_CONF['site_url'] . \"/userbox/index.php\".$more_url;//@@@@@\n    }\n\n    $more_url = COM_buildUrl( $more_url );\n    $more_link= COM_createLink($title, $more_url);\n    $list->set_var ('more_url', $more_url);\n    $list->set_var ('more_title', $more_title);\n\n    $list->parse ('output', 'list');\n    $retval .= $list->finish ($list->get_var ('output'));\n\n\n    return $retval;\n}\n\nfunction userbox_order(\n    $url=\"\"\n    ,$templates\n    ,$cur_order=\"id\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd ORDER\u6307\u5b9aLINK\u51fa\u529b\n// | \u66f8\u5f0f userbox_order()\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $url:\n// | \u5f15\u6570 $templates\n// | \u5f15\u6570 $cur_order:\n// +---------------------------------------------------------------------------+\n{\nglobal $LANG_USERBOX_ORDER;\nglobal $_TABLES;\n\n    $templates->set_var('cur_order',$cur_order);\n\n    $order_ary=array();\n    $order_ary[]='random';\n    $order_ary[]='date';\n    $order_ary[]='orderno';\n    $order_ary[]='username';\n    $order_ary[]='fullname';\n    $order_ary[]='description';\n    $order_ary[]='id';\n    $order_ary[]='released';\n\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",templatesetvar\";\n    $sql.=\" FROM\";\n    $sql.=\" {$_TABLES['USERBOX_def_field']} \";\n    $sql.=\" where allow_display=0\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $addfield_ary=array();\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=COM_stripslashes($A['field_id']);\n        $addfield_ary[$field_id]['name']=COM_stripslashes($A['name']);\n        $addfield_ary[$field_id]['templatesetvar']=COM_stripslashes($A['templatesetvar']);\n        $order_ary[]=\"addfield\".$field_id;\n    }\n\n\n    for ($i = 1; $i <= count($order_ary); $i++) {\n        $c=current($order_ary);\n\n        if (substr($c,0,8)===\"addfield\"){\n            $field_id=substr($c,8);\n            $order=$addfield_ary[$field_id]['templatesetvar'];\n            $order_name=$addfield_ary[$field_id]['name'];\n            $order_name.=$LANG_USERBOX_ORDER['order'];\n        }else{\n            $order=$c;\n            $order_name=$LANG_USERBOX_ORDER[$c];\n        }\n\n        if ($order<>\"random\" AND $order===$cur_order){\n            $rt=$order_name;\n        }else{\n            $order_url=$url;\n            $order_url.=$order;\n            //$order_url = COM_buildUrl( $order_url );\n            $rt= COM_createLink($order_name, $order_url);\n        }\n\n        $templates->set_var('order_'.$order,$rt);\n\n        next($order_ary);\n    }\n\n    return ;\n\n\n}\n\n\n\nfunction userbox_msg(\n    $for=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u30e1\u30c3\u30bb\u30fc\u30b8\u51fa\u529b\n// | \u66f8\u5f0f userbox_msg()\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $for:\u8ab0\u5b9b\n// +---------------------------------------------------------------------------+\n{\nglobal $LANG_USERBOX_MSG;\nglobal $_USER;\nglobal $_TABLES;\n    \n    $rt=\"\";\n    $uid=$_USER['uid'];\n    \n    switch ($for) {\n        case '':\n        case 'alluser':\n            $rt=$LANG_USERBOX_MSG['alluser'];\n            break;\n        case 'draftuser':\n            $draft_flag=DB_getItem($_TABLES['USERBOX_base'], 'draft_flag',\n                        \"id = '{$uid}'\");\n            if ($draft_flag==1){\n                $rt=$LANG_USERBOX_MSG['draftuser'];\n            }\n            break;\n        case 'descriptionempty':\n            if ($uid<>0){\n                if (userbox_descriptionemptycheck($uid)==false){\n                    $rt=$LANG_USERBOX_MSG['descriptionempty'];\n                }\n            }\n            break;\n        default:\n        \n    }\n    \n    return $rt;\n\n}\n\n\n?>\n", "<?php\n/* Reminder: always indent with 4 spaces (no tabs). */\n// +---------------------------------------------------------------------------+\n// | DataBox \u30d7\u30e9\u30b0\u30a4\u30f3   function.inc \u304b\u3089require\n// | Box \u30b7\u30ea\u30fc\u30ba\u5171\u901a\n// +---------------------------------------------------------------------------+\n// $Id: plugins/databox/lib/databox_functions.inc\n//20100818 tsuchitani AT ivywe DOT co DOT jp http://www.ivywe.co.jp/\n\nif (strpos ($_SERVER['PHP_SELF'], 'databox_functions.inc') !== false) {\n    die ('This file can not be used on its own.');\n}\n\n//==============================================================================\nfunction DATABOX_nl2br (\n    $text\n) \n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u6539\u884c\u3092BR\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_nl2br ($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text:\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6539\u884c\u3092BR\u306b\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u6539\u884c\u3092BR\u306b\u5909\u63db\"\n{\n    return PLG_replacetags ( str_replace(array(\"\\r\\n\",\"\\r\",\"\\n\"), '<br'.XHTML.'>', $text) );\n\n}\n\nfunction DATABOX_autolink (\n    $text\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd url\u3092\u30ea\u30f3\u30af\u5909\u63db\n// | \u66f8\u5f0f DATABOX_autolink($text)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $text         :\u6587\u5b57\u5217                                                |\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:url\u3092\u30ea\u30f3\u30af\u5909\u63db\u5f8c\u306e\u6587\u5b57\u5217                                       |\n// +---------------------------------------------------------------------------+\n// copy20100803 from  \"hiroron - \u81ea\u52d5\u30ea\u30f3\u30af\u3092\n{\n    $patterns = array(\"/(https?|ftp)(:\\/\\/[[:alnum:]\\+\\$\\;\\?\\.%,!#~*\\/:@&=_-]+)/i\");\n    $replacements = array(\"<a href=\\\"\\\\1\\\\2\\\" target=\\\"_blank\\\">\\\\1\\\\2</a>\");\n    return preg_replace($patterns, $replacements, $text);\n}\n\nfunction DATABOX_codetoid(\n    $code\n    ,$table\n    ,$idname = \"id\"\n    ,$codename = \"code\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u3092id\u306b\u5909\u63db\n// | \u66f8\u5f0f DATABOX_codetoid($code,'DATABOX_base')\n// | \u66f8\u5f0f DATABOX_codetoid($code,'users',\"uid\",\"username\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// | \u5f15\u6570 $table\n// | \u5f15\u6570 $idname\n// | \u5f15\u6570 $codename\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:id\n// +---------------------------------------------------------------------------+\n//update20101125\n{\n    global $_TABLES;\n    $retval=DB_getItem( $_TABLES[$table]   ,$idname,$codename.\"='{$code}'\");\n    if (empty($retval)){\n        $retval=0;\n    }\n    return $retval;\n}\n\nfunction DATABOX_swichlang(\n\t$code\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30b3\u30fc\u30c9\u591a\u8a00\u8a9e\u5bfe\u5fdc\u5909\u63db\n// | \u66f8\u5f0f DATABOX_swichlang($code)\n// |      xxxx_(\u8a00\u8a9eid) \u591a\u8a00\u8a9e\u30e2\u30fc\u30c9\u306e\u6642\u306b\u5fc5\u8981\u304c\u3042\u308c\u3070\u8a00\u8a9eid\u3092\u73fe\u5728\u306e\u8a00\u8a9eid\u306b\u5909\u63db\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $code:\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u5909\u63db\u5f8c\u306e\u30b3\u30fc\u30c9\n// +---------------------------------------------------------------------------+\n{\n    \n    global $_CONF;\n    $newlanguageid = COM_getLanguageId();\n    if  ($newlanguageid<>\"\"){\n        if  ($code<>\"\"){\n            $lang_len = strlen($newlanguageid);\n            $oldlanguageid=substr($code,-($lang_len));\n            if  (array_key_exists($oldlanguageid, $_CONF['language_files'])){\n                $code = substr_replace($code, $newlanguageid, -$lang_len);\n            }\n        }\n    }\n    return $code;\n}\n\n\nfunction DATABOX_templatePath (\n    $kind = 'data'\n    ,$template ='default'\n    ,$pi_name= 'databox'\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\u3092\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_templatePath('data','default','databox')\n// | \u66f8\u5f0f DATABOX_templatePath($kind,$template,$pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:'data' 'category' ''newlist' 'admin'\n// | \u5f15\u6570 $template:  'default'\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u30d1\u30b9\n// +---------------------------------------------------------------------------+\n// 20101115\n{\n\n    global $_CONF;\n\n    if (is_null($template) OR ($template===\"\")){\n        $template=\"default\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    if ($kind===\"admin\"){\n        $conf_templates=$box_conf[\"templates_admin\"];\n    }else{\n        $conf_templates=$box_conf[\"templates\"];\n    }\n\n    //\"standard\";//\u6a19\u6e96\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"custom\";//\u30ab\u30b9\u30bf\u30e0\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    //\"theme\";//\u30c6\u30fc\u30de\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\n    if  ($conf_templates===\"theme\"){\n\n        $tmplfld=$_CONF['path_layout'] .$box_conf['themespath'].$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n        }\n        if (is_dir($tmplfld)) {\n\n        }else{\n            COM_handle404();\n            exit;\n        }\n    }else if  ($conf_templates===\"custom\"){\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/custom/templates/'.$kind;\n\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/\".$template;\n\n        }\n\n        if (is_dir($tmplfld)){\n\n        }else{\n            COM_handle404();\n            exit;\n        }\n    }else{\n\n        $tmplfld=$_CONF['path'] .'plugins/'.$pi_name.'/templates/'.$kind;\n        if ($kind<>\"admin\"){\n\n            $tmplfld.=\"/default\";\n        }\n    }\n\n\n    return $tmplfld;\n}\n\nfunction DATABOX_siteHeader (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$page_title = ''\n    ,$headercode = ''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d8\u30c3\u30c0\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title,$headercode)\n// | \u66f8\u5f0f DATABOX_siteHeader($pi_name,'_admin',$page_title)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $pagetitle:\n// | \u5f15\u6570 $headercode:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 :\u30d8\u30c3\u30c0\n// +---------------------------------------------------------------------------+\n// 20120910\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n\n    $display=\"\";\n    \n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n            $display=COM_siteHeader ('menu', $page_title,$headercode);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'noblocks':\n            $display=COM_siteHeader ('none', $page_title,$headercode);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n\n\n    return $display;\n}\n\n\nfunction DATABOX_siteFooter (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$custom=''\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30c3\u30bf\u3092\u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name,'_admin',$custom)\n// | \u66f8\u5f0f DATABOX_siteFooter($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $kind:'' '_admin'\n// | \u5f15\u6570 $custom:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 : \u30d5\u30c3\u30bf\n// +---------------------------------------------------------------------------+\n// 20110119\n{\n    global $_CONF;\n\n    if (is_null($pi_name)){\n        $pi_name=\"databox\";\n    }\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $display=\"\";\n\n    $layout=$box_conf['layout'.$kind];\n    switch ($layout) {\n        // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n        case 'standard':\n        $display .= COM_siteFooter(false,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n        case 'leftrightblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'rightblocks':\n            $display .= COM_siteFooter(true,$custom);\n            break;\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'leftblocks':\n        //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        // \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u5e38\u6642\u8868\u793a\u3059\u308b\u8a2d\u5b9a\u3067\u3042\u3063\u3066\u3082\u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3055\u305b\u306a\u3044\n        case 'noblocks':\n            $_CONF['show_right_blocks']=0;\n            $_CONF['left_blocks_in_footer']=0;\n            $display .= COM_siteFooter(false,$custom);\n            break;\n\n        //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n        case 'blankpage':\n            break;\n\n        default:\n\n    }\n\n    return $display;\n}\n\n\n//$retval = SP_returnStaticpage($page, $display_mode, $comment_order, $comment_mode, $comment_page, $msg, $query);\n\nfunction DATABOX_displaypage (\n    $pi_name= 'databox'\n    ,$kind = ''\n    ,$display = ''\n    ,$information = ''\n)\n//$information\n// 'what'  'none' no left blocks are returned\n//         'menu' (default)  right blocks are returned\n// 'pagetitle'     Optional content for the page's <title>\n// 'breadcrumbs'   Optional content for the page's <title>\n// 'headercode'    Optional code to go into the page's <head>\n// 'rightblock'    \u53f3\u30d6\u30ed\u30c3\u30af\u3092\u8868\u793a\u3059\u308b\u304b\u3069\u3046\u304b\u3000 default is no (-1)\n// 'custom'        An array defining custom function to be used to \n\n{\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    if  ($kind==\"_admin\" OR $kind==\"\"){\n        $layout=$box_conf['layout'.$kind];\n    }else{\n        $layout=$kind;\n    }\n    \n    //\u5168\u753b\u9762\u8868\u793a\uff08\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n    if  ($layout=='blankpage'){\n        \n    }else{\n        switch ($layout) {\n            // \u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306f\u30c6\u30fc\u30de\u8a2d\u5b9a\u306b\u3088\u308b\uff09\n            case 'standard':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(false,$custom);\n                $information['what']='menu';\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\n            case 'leftrightblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                //$display .= COM_siteFooter(true,$custom);\n                $information['what']='menu';\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u5de6\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u53f3\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'leftblocks':\n                //$display=COM_siteHeader ('menu', $page_title,$headercode);\n                $information['what']='menu';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u30fb\u53f3\u30d6\u30ed\u30c3\u30af\u3042\u308a\uff08\u5de6\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'rightblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                //$display .= COM_siteFooter(true,$custom);\n                $information['rightblock']=true;\n                break;\n            //\u30d8\u30c3\u30c0\u30fb\u30d5\u30c3\u30bf\u3042\u308a\uff08\u30d6\u30ed\u30c3\u30af\u306a\u3057\uff09\n            case 'noblocks':\n                //$display=COM_siteHeader ('none', $page_title,$headercode);\n                $information['what']='none';\n                $_CONF['show_right_blocks']=0;\n                $_CONF['left_blocks_in_footer']=0;\n                //$display .= COM_siteFooter(false,$custom);\n                $information['rightblock']=false;\n                break;\n        }\n        \n        //FOR GL2.0.0 \n        if (COM_versionCompare(VERSION, \"2.0.0\",  '>=')){\n            $display = COM_createHTMLDocument($display,$information);\n        }else{\n            $display = COM_siteHeader ($information['what'], $information['pagetitle']).$display;\n            $display .= COM_siteFooter($information['rightblock']);\n        }\n    }\n\n\n    return $display;\n}\n\n\nfunction DATABOX_getcheckList(\n    $kind\n    ,$selected\n    ,$pi_name\n    ,$group_id=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcheckList($kind,$selected = \"\")\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name)\n// | \u66f8\u5f0f $checklist=DATABOX_getcheckList (\"categorygroup\",\"\",$pi_name,1,\"ch1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:fieldset\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox' \n// | \u5f15\u6570 $group_id\u3000\u30de\u30b9\u30bf\u30fc\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n// \u30ab\u30c6\u30b4\u30ea\u4ee5\u5916\u3067\u4f7f\u3063\u3066\u3044\u308b\u304b\u78ba\u8a8d\u306e\u3053\u3068 --> category \u306f DATABOX_getcategoriesinp\n//20140624 fieldset\u3000\u8ffd\u52a0\n{\nglobal $_TABLES;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n\n    $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n    $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    $table_def_fieldset=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n    $retval = '';\n    if ($kind==\"categorygroup\"){\n        $sql = \"SELECT \";\n        $sql .= \" m1.category_id\".LB;\n        $sql .= \",m1.name\".LB;\n        $sql .= \",m1.orderno\".LB;\n        $sql .= \",m2.group_id\".LB;\n        $sql .= \",m2.name AS group_name\".LB;\n        $sql .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql .= \" , {$table_def_group} AS m2\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m1.allow_display<2 \".LB;\n        $sql .= \" AND m1.categorygroup_id =\".$group_id.LB;\n        $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n        $sql .= \" ORDER BY m1.orderno\".LB;\n    }else if ($kind==\"fieldset\"){\n        $sql = \"SELECT \";\n        $sql .= \" fieldset_id\".LB;\n        $sql .= \",name\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_def_fieldset} \".LB;\n        $sql .= \" ORDER BY fieldset_id\".LB;\n    }else{\n        $sql = \"SELECT \".LB;\n        $sql .= \" no\".LB;\n        $sql .= \",value\".LB;\n        $sql .= \",orderno\".LB;\n        $sql .= \",'1' AS group_id\".LB;\n        $sql .= \" FROM {$table_mst}\".LB;\n        $sql .= \" WHERE kind='{$kind}'\".LB;\n        $sql .= \" ORDER BY orderno\".LB;\n    }\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    $old_group_id=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fname . '[]\" value=\"' . $A[0] ;\n        $retval .= '\"';\n        for( $x = 0; $x < sizeof( $S ); $x++ )            {\n            if( $A[0] == $S[$x] )                {\n                $retval .= ' checked=\"checked\"';\n            }\n        }\n        $retval .= '>' . stripslashes( $A[1] ) . '</span>' . LB;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getdatas(\n    $fld\n    ,$tbl\n    ,$where\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u8aad\u8fbc                                                      |\n// | \u66f8\u5f0f DATABOX_getdatas($fld,$tbl,$where)                                   |\n// | $rt=DATABOX_getdatas(                                                     |\n// |      \"category_id\",$_TABLES['DATABOX_category'],\"id=$id\");                |\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $where:\u6761\u4ef6\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8907\u6570\u30c7\u30fc\u30bf\u30ea\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    $sql=\"SELECT {$fld} FROM {$tbl} WHERE {$where}\";\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    $selected=\"\";\n    for ($i = 0; $i < $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $selected.= $A[$fld].\" \";\n    }\n    $selcted=rtrim($selected,\" \");\n    return $selected;\n\n}\n\n\nfunction DATABOX_savedatas(\n    $fld\n    ,$tbl\n    ,$id\n    ,$fldary=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc\n// | \u66f8\u5f0f DATABOX_savedatas($fld,$tbl,$id,$fldary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fld:\u9805\u76ee\n// | \u5f15\u6570 $tbl:\u30c6\u30fc\u30d6\u30eb\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//update20100420\n{\n\n    global $_TABLES;\n\n    $rt=DB_delete($tbl,\"id\",$id);\n\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$tbl} (\";\n            $sql.=\"id, {$fld}\";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id}, {$val}\";\n            $sql.=\")\";\n            DB_query($sql);\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\nfunction DATABOX_savecategorydatas(\n    $id\n    ,$fldary\n    ,$pi_name=\"\"\n    ,$mydata=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8907\u6570\u30c7\u30fc\u30bf\u66f8\u8fbc(\u30ab\u30c6\u30b4\u30ea)\n// | \u66f8\u5f0f DATABOX_savecategorydatas($id,$category,'databox','mydata')\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $fldary:\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update20100824\n{\n\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_category=$_TABLES['DATABOX_category'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\t\n\tif  ($mydata==\"\"){\n        $rt=DB_delete($table_category,\"id\",$id);\n\t}else{\n\t\t$categories=COM_applyFilter($_POST['categories']);\n\t\tif  ($categories==\"\" ){\n\t\t}else{\n            $categories=str_replace(\"|\", ',', $categories);\n\t\t    $sql=\"DELETE FROM {$table_category} WHERE \";\n\t        $sql .=\"  id = \".$id ;\n\t        $sql .=\"  AND category_id IN (\".$categories.\")\";\n\t\t    DB_query($sql);\n\t\t}\n\t}\n\t\n    if (is_array($fldary)){\n        for ($i = 1; $i <= count($fldary); $i++) {\n            $val=current($fldary);\n            $sql=\"INSERT INTO {$table_category} (\".LB;\n            $sql.=\"id, category_id\".LB;\n            $sql.=\") VALUES (\".LB;\n            $sql.=\"{$id}, {$val}\".LB;\n            $sql.=\")\".LB;\n            DB_query($sql);\n            /////parent_id \u304c0\u306b\u306a\u308b\u307e\u3067insert\n            $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$val}\");\n            while ($parent_id<>0) {\n                $category_id=$parent_id;\n                $seq=DB_getItem( $table_category   ,\"seq\",\"id={$id} AND category_id={$category_id} \");\n                if (is_null($seq)) {\n                    $sql=\"INSERT INTO {$table_category} (\".LB;\n                    $sql.=\"id, category_id\".LB;\n                    $sql.=\") VALUES (\".LB;\n                    $sql.=\"{$id}, {$category_id}\".LB;\n                    $sql.=\")\".LB;\n                    DB_query($sql);\n                }\n                $parent_id=DB_getItem( $table_def_category   ,\"parent_id\",\"category_id={$category_id}\");\n            }\n            /////\n            next($fldary);\n        }\n    }\n\n    return ;\n\n}\n//==============================================================================\nfunction DATABOX_chkuser(\n        $group_id\n        ,$owner_id\n        ,$adminrights=\"databox.admin\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e6\u30fc\u30b6\u30c1\u30a7\u30c3\u30af\n// | \u66f8\u5f0f $chk_user=DATABOX_chkuser($group_id,$owner_id,\"databox.admin\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $group_id\n// | \u5f15\u6570 $owner_id\n// | \u5f15\u6570 $adminrights\u3000databox.admin\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024\n// |    0 guest\n// |   10 guest and allusers\n// | 1000 user\n// | 1010 group\u3000(owner \u542b\u3080)\n// | 1011 owner\n// | 1100 admin\n// | 1110 group and admin\n// | 1101 owner and admin\n// | 1111 group owner and admin\n// +---------------------------------------------------------------------------+\n//update20101004 group_id\n{\n    global $_USER;\n\n    $chk_user=0;\n    if (isset($_USER['uid']) && $_USER['uid'] > 1) {\n        $chk_user=1000;//\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\n    }\n    if ( SEC_hasRights($adminrights)) {\n        $chk_user=$chk_user+100;//admin\n    }\n    //group \u306b\u5c5e\u3057\u3066\u3044\u308b\u4eba\n    $usergroups=SEC_getUserGroups();\n\n    if ( in_array($group_id, $usergroups)){\n        $chk_user=$chk_user+10;//group\n    }\n\n    if ($owner_id===$_USER['uid']){\n        $chk_user=$chk_user+1;//owner\n    }\n\n    return $chk_user;\n}\n\n\n\nfunction DATABOX_getadditiondef(\n    $pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_def_field'];\n        $table2=$_TABLES['DATABOX_mst'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n        $table2=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n\n    $rt=array();\n\t$fieldgroupno_old=\"\";\n\t\n    $sql=\"SELECT \";\n    $sql.= \" field_id \";\n    $sql.= \",name \";\n    $sql.= \",description\";\n    $sql.= \",type\";\n    //$sql.= \",fieldgroup_id AS group_id\";\n    $sql.= \",selection\";\n    $sql.= \",selectlist\";\n    $sql.= \",checkrequried\";\n    $sql.= \",size\";\n    $sql.= \",maxlength\";\n    $sql.= \",rows\";\n    $sql.= \",br\";\n    $sql.= \",templatesetvar\";\n\n    $sql.= \",allow_display\";\n    $sql.= \",allow_edit\";\n\n    $sql.= \",textcheck\";\n    $sql.= \",textconv\";\n    $sql.= \",searchtarget\";\n    \n    $sql.= \",initial_value\";\n    $sql.= \",range_start\";\n    $sql.= \",range_end\";\n    $sql.= \",dfid\";\n    $sql.= \",description2\";\n    $sql.= \",fieldgroupno\";\n\t\n    $sql.=\" FROM\";\n    $sql.=\" {$table}  AS m\";\n    $sql.= \" ORDER BY orderno,field_id\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $rt[$field_id]['name'] = COM_stripslashes($A['name']);\n        $rt[$field_id]['checkrequried'] = COM_stripslashes($A['checkrequried']);\n        $rt[$field_id]['description'] = COM_stripslashes($A['description']);\n        $rt[$field_id]['allow_display'] = COM_stripslashes($A['allow_display']);\n        $rt[$field_id]['allow_edit'] = COM_stripslashes($A['allow_edit']);\n        $rt[$field_id]['textcheck'] = COM_stripslashes($A['textcheck']);\n        $rt[$field_id]['textconv'] = COM_stripslashes($A['textconv']);\n        $rt[$field_id]['searchtarget'] = COM_stripslashes($A['searchtarget']);\n        \n        $rt[$field_id]['type'] = COM_stripslashes($A['type']);\n        //$rt[$field_id]['group_id'] = COM_stripslashes($A['group_id']);\n        $rt[$field_id]['selection'] = COM_stripslashes($A['selection']);\n\n        $rt[$field_id]['size'] = COM_stripslashes($A['size']);\n        if ($rt[$field_id]['size']==0){\n            $rt[$field_id]['size']=60;\n        }\n        $rt[$field_id]['maxlength'] = COM_stripslashes($A['maxlength']);\n        if ($rt[$field_id]['maxlength']==0){\n            $rt[$field_id]['maxlength']=160;\n        }\n\n        $rt[$field_id]['rows'] = COM_stripslashes($A['rows']);\n        if ($rt[$field_id]['rows']==0){\n            $rt[$field_id]['rows']=2;\n        }\n        $rt[$field_id]['br'] = COM_stripslashes($A['br']);\n\n        $rt[$field_id]['selectlist'] = COM_stripslashes($A['selectlist']);\n        $rt[$field_id]['templatesetvar'] = COM_stripslashes($A['templatesetvar']);\n\n        $selection= COM_stripslashes($A['selection']);\n        $rt[$field_id]['selectionary']=DATABOX_getselectionary($selection);\n\n        $rt[$field_id]['initial_value']= COM_stripslashes($A['initial_value']);\n        $rt[$field_id]['range_start']= COM_stripslashes($A['range_start']);\n        $rt[$field_id]['range_end']= COM_stripslashes($A['range_end']);\n        $dfid= COM_stripslashes($A['dfid']);\n        $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n        if( empty( $format )) {\n            $rt[$field_id]['format'] = $_CONF['date'];\n        }else{\n            $rt[$field_id]['format'] = $format;\n        }\n\n        $rt[$field_id]['description2']= COM_stripslashes($A['description2']);\n        $fieldgroupno=COM_stripslashes($A['fieldgroupno']);\n        if  ($fieldgroupno_old==$fieldgroupno){\n\t\t}else{\n            $fieldgroup_name=DB_getItem($table2,\"value\",\"kind='fieldgroup' AND no=\".$fieldgroupno);\n            $fieldgroupno_old=$fieldgroupno;\n        }\n        $rt[$field_id]['fieldgroup_name']=$fieldgroup_name;\n        $rt[$field_id]['fieldgroupno']= $fieldgroupno;\n\n    }\n    return $rt;\n\n}\nfunction DATABOX_getselectionary(\n    $selection\n)\n{\n    $selectionary=array();\n    $ary=array();\n    $ary=split(\"\\r\" , $selection);\n\n    $j=0;\n    for ($ii = 0; $ii < count($ary); $ii++) {\n        if ($ary[$ii]<>\"\"){\n            $selectionary[$j]=$ary[$ii];\n            $j=$j+1;\n        }\n    }\n    return $selectionary;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u691c\u7d22\u7528\u5f15\u6570\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getadditionsearchdef($pi_name)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 \u914d\u5217\n// |    $rt[\"sql1\"]: \",{$_TABLES['DATABOX_addition']} AS ad1\"\n// |    $rt[\"sql2\"]: \" AND t1.id=ad1.id AND ad1.field_id=1 \"\n// |    $rt[\"columns\"][]: 'ad1.value '\n// +---------------------------------------------------------------------------+\nfunction DATABOX_getadditionsearchdef(\n    $pi_name=\"\"\n)\n{\n    global $_TABLES;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    \n    if ($box_conf['additionsearch']==0){\n        return;\n    }\n    $lmt=$box_conf['additionsearch'];\n    \n    $retval=array();\n\n    $rt=array();\n    $sql3=\"\";\n    $columns=array();\n\n    $sql=LB;\n    $sql.=\"SELECT \";\n    $sql.= \" field_id \";\n    \n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n\n    // \u8868\u793a\u3059\u308b\u9805\u76ee\u306e\u307f\n    $sql.=\" WHERE\";\n    $sql.=\" allow_display='0'\";\n    //0: \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //1: \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n    //20:HTML  10:TinyMCE 19:CKEditor\n    //15:\u6570\u5024  21:\u901a\u8ca8\n    $sql.=\" AND type IN (0,1,10,19,20,15,21)\";\n    \n    //\u691c\u7d22\u5bfe\u8c61\u306b\u3059\u308b=\u306f\u3044\n    $sql.=\" AND searchtarget='1'\";\n    \n    $sql.=\" ORDER  BY  orderno,field_id\";\n    $sql.=\" LIMIT 0 ,\".$lmt;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id = COM_stripslashes($A['field_id']);\n        $type = COM_stripslashes($A['type']);\n        $selection= COM_stripslashes($A['selection']);\n        $selectionary=DATABOX_getselectionary($selection);\n\n        $columns[]= \"ad{$field_id}.value \";\n\n        $sql3 .= \" JOIN {$table_addition} AS ad{$field_id}\";\n        $sql3 .= \" ON t1.id=ad{$field_id}.id \";\n        $sql3 .= \" AND ad{$field_id}.field_id={$field_id} \".LB;\n        \n    }\n\n    $rt[\"sql3\"]=$sql3;\n    $rt[\"columns\"]=$columns;\n    \n    return $rt;\n\n}\n\n\n\nfunction DATABOX_getadditiondatas(\n    $id\n    ,$pi_name=\"\"\n    )\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8aad\u8fbc\n// | \u66f8\u5f0f DATABOX_getadditiondatas($id)\n// | $array=DATABOX_getaddtuindatas($id);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u30ea\u30b9\u30c8                                                 |\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table_addition=$_TABLES['DATABOX_addition'];\n        $table_def_field=$_TABLES['DATABOX_def_field'];\n    }else{\n        $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n        $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }\n\n    $rt=array();\n    \n    $sql=\"SELECT \";\n    $sql.=\" m.field_id\";\n    $sql.=\" ,m.fieldgroupno\";\n    if ($id==0){\n        $sql.=\",initial_value AS value  \";\n    }else{\n        $sql.=\", ( SELECT VALUE \";\n        $sql.=\" FROM\";\n        $sql.=\" {$table_addition}  AS t\";\n        $sql.=\" where\";\n        $sql.=\" t.id={$id}\";\n        $sql.=\" AND t.field_id=m.field_id\";\n        $sql.=\" ) AS value \";\n    }\n    $sql.=\" FROM\";\n    $sql.=\" {$table_def_field}  AS m\";\n    $sql.=\" order by m.fieldgroupno,m.orderno ,m.field_id\";\n    \n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $field_id=$A['field_id'];\n        $value=$A['value'];\n        $rt[$field_id]=COM_stripslashes($value);\n    }\n    return $rt;\n\n}\n\n\nfunction DATABOX_getaddtionfieldsEdit(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name=\"\"\n    ,$fields_fnm=\"\"\n    ,$fields_del=\"\"\n    ,$fieldset_id=0\n    ,$fields_date=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsEdit\n//          ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fields_fnm:\n// | \u5f15\u6570 $fields_del:\n// | \u5f15\u6570 $fieldset_id:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5165\u529b\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n// 20101206 \u65e5\u4ed8\n{\n    global $_TABLES;\n    global $_SCRIPTS;\n    global $_CONF;\n    global $MESSAGE;\n\t\n    if ($pi_name==\"\"){\n        $pi_name=\"databox\";\n    }\n    $lang_admin_x=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_admin;\n    global $$lang_noyes;\n    $lang_admin=$$lang_admin;\n    $lang_noyes=$$lang_noyes;\n    \n    $langCode = COM_getLangIso639Code();\n    $toolTip  = $MESSAGE[118];\n    $imgUrl   = $_CONF['site_url'] . '/images/calendar.png';\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n    $fieldgroup_old=\"\";\n    foreach( $S as $fid => $fvalue ){\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $description=$addition_def[$fid]['description'];\n        $description2=$addition_def[$fid]['description2'];\n        $fieldgroup_name=$addition_def[$fid]['fieldgroup_name'];\n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if (in_array($fid,$fieldsetfields )) {\n            \n            if ($chk_user===9999){\n                $chk=true;\n                $disabled=\"\";\n            }else{\n                //\u7de8\u96c6\u53ef\u80fd\n                if  ($addition_def[$fid]['allow_edit']==='0') {\n                    $chk=true;\n                    $disabled=\"\";\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n                }else if ($addition_def[$fid]['allow_edit']==='2'){\n                    if  ($chk_user>=1010) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='3'){\n                    if  ($chk_user>=1011) {\n                        $chk=true;\n                        $disabled=\"\";\n                    }\n                //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n                }else if ($addition_def[$fid]['allow_edit']==='4'){\n                    $chk=true;\n                }\n            }\n        }\n    \n        if ($chk) {\n\n            $fieldhtml=\"\";\n            switch ($type) {\n                case 12:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml12\n                            ($fid,$fvalue,$fvalue_del,$size,$maxlength);\n                    break;\n                case 11:// \u56f3\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_figurehtml\n                            ($fid,$fvalue,$fvalue_del);\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                        $fvalue_fnm=$fields_fnm[$fid];\n                        $fvalue_del=$fields_del[$fid];\n                        $fieldhtml .=DATABOX_filehtml\n                            ($pi_name,$fid,$fvalue,$fvalue_del);\n                    break;\n\n\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                     if ($disabled===\"\"){\n                        $cntname=\"afieldcnt\".$fid;\n                        $fieldhtml .= \"<textarea \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"width:95%\\\"\";\n                        $fieldhtml .= \" rows=\\\"\".$rows.\"\\\"\";\n                        $fieldhtml .= \" id=\\\"DATABOX_afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" \".$disabled.\" \";\n                        $fieldhtml .= \" onKeyup=\\\"var n=\".$maxlength;\n                        $fieldhtml .=\"-this.value.length;var \";\n                        $fieldhtml .=\"s=document.getElementById\";\n                        $fieldhtml .=\"('\".$cntname.\"');s.innerHTML='('+n+')';\\\"\";\n                        if  ($type==20){\n                            $fieldhtml .= \" class=\\\"tinymce_enabled\\\"\";\n                        }\n                        if  ($type==19){\n                            $fieldhtml .= \" class=\\\"wide\\\"\";\n                        }\n                        $fieldhtml .= \">\";\n                        $fieldhtml .= $fvalue;\n                        $fieldhtml .= \"</textarea>\";\n                        $fieldhtml .=\"<br \".XHTML.\"><strong>\";\n                        $fieldhtml .=\"<span id='\".$cntname.\"'></span></strong>\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044 \n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist\n                            ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n                    }else{\n                        $fieldhtml= $lang_noyes[$fvalue];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n\t\t\t\t\t\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                 case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getcheckboxary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    if ($disabled===\"\"){\n                       $fieldhtml=DATABOX_getoptionlist(\"selectlist_mst\",$fvalue,0,$pi_name,\"\",0,$selectlist,\"afield[\".$fid.\"]\");\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    if ($disabled===\"\"){\n                        $fieldhtml=DATABOX_getradiolist ($selectionary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getradiolist ($mstary,\"afield[\".$fid.\"]\",$fvalue,$br,$disabled,$type);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09//@@@@@\n                    if ($disabled===\"\"){\n                        $mstary=DATABOX_getAry(\"selectlist_mst\",0,$selectlist,$pi_name);\n                        $fieldhtml=DATABOX_getoptionlistary($mstary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type,$size);\n                    }else{\n                        $selectionary[$fvalue];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\uff08date picker\u5bfe\u5fdc\uff09\n                if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.datepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"date\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 4://\u65e5\u6642\uff08datetime picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                        //$filedname=\"afield[\".$fid.\"]\";\n                        $filedname=\"afield\".$fid;\n                    \n                        $_SCRIPTS->setJavaScript(\n                        \"jQuery(function () {\"\n                            . \"  geeklog.hour_mode = {$_CONF['hour_mode']};\"\n                            . \"  geeklog.datetimepicker.set('{$filedname}', '{$langCode}', '{$toolTip}', '{$imgUrl}');\"\n                            . \"});\", TRUE, TRUE\n                            );\n\t\t\t\t\t\n                        if  (is_array($fields_date)){\n                            $fieldhtml.=DATABOX_datetimeedit_R($fields_date[$fid],$lang_admin_x,$filedname);\n                        }else{\n                            $fieldhtml.=DATABOX_datetimeedit($fvalue,$lang_admin_x,$filedname,\"datetime\");\n                        }\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 26://\u6642\u523b\uff08UI time picker\u5bfe\u5fdc\uff09\n                    if ($disabled===\"\"){\n                         $fvalue_time=DATABOX_getTimeformat($fvalue);\n                         $filedname=\"afield\".$fid;\n                         \n                         $wk =  \" <input \";\n                         $wk .= \" type=\\\"hidden\\\"\";\n                         $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                         $wk .= \" \".XHTML.\">\";\n                         $fieldhtml.=$wk;\n\n                         $fieldhtml .= \"        <input \";\n                         $fieldhtml .= \" data-uk-timepicker=\\\"{format:'\".$_CONF['hour_mode'].\"h'\";\n                         if  ($addition_def[$fid]['range_start']==\"\"){\n                         }else{\n                             $fieldhtml .= \",start:\".$addition_def[$fid]['range_start'] ;\n                         }\n                         if  ($addition_def[$fid]['range_end']==\"\"){\n                         }else{\n                             $fieldhtml .= \",end:\".$addition_def[$fid]['range_end'] ;\n                         }\n                         $fieldhtml .= \" }\\\"\";\n                         $fieldhtml .= \" class=\\\"uk-form-width-small\\\"\";\n                         $fieldhtml .= \" type=\\\"text\\\"\";\n                         $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                         $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                         $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                         $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                         $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                         $fieldhtml .= \" value=\\\"\". $fvalue_time.\"\\\"\";\n                         $fieldhtml .= \" \".XHTML.\">\";\n                     }else{\n                        $fieldhtml .=$fvalue;\n                     }\n                     break;\n                case 22://\u65e5\u4ed8\n                if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n\n                        $_SCRIPTS->setJavaScript(\n                            \"$(function() {\n                            $( \\\"#afield\".$fid.\"\\\" ).datepicker();\n                            });\"\n                            , TRUE, TRUE\n                            );\n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n                        \n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 23://\u65e5\u4ed8\n                    if ($disabled===\"\"){\n                        if  ($fvalue==\"\")  {\n                            $fvalue_date=\"\";\n                        }else{\n                            $fvalue_date=date( $box_conf['dateformat'], $fvalue );\n                        }\n                        $filedname=\"afield\".$fid;\n                        \n                        $wk =  \" <input \";\n                        $wk .= \" type=\\\"hidden\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml.=$wk;\n\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" data-uk-datepicker=\\\"{format:'YYYY/MM/DD'}\\\"\";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \"  id=\\\"afield\".$fid.\"\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\". $fvalue_date.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n                    break;\n                case 17://\u30d5\u30e9\u30b0\n                    if ($disabled===\"\"){\n                        $wk =\" <input \";\n                        $wk .= \" type=\\\"checkbox\\\"\";\n                        $wk .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $wk .= \" value=\\\"1\\\"\";\n                        if  ($fvalue==1) {\n                            $wk .= \" checked=checked\";\n                        }\n                        $wk .= \" \".XHTML.\">\";\n                        $fieldhtml=$wk;\n                    }else{\n                        $fieldhtml= $fvalue;\n                    }\n                    break;\n\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                default:\n                    if ($disabled===\"\"){\n                        $fieldhtml .= \"        <input \";\n                        $fieldhtml .= \" type=\\\"text\\\"\";\n                        $fieldhtml .= \" size=\\\"\".$size.\"\\\"\";\n                        $fieldhtml .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n                        $fieldhtml .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n                        $fieldhtml .= \" style=\\\"max-width:95%\\\"\";\n                        $fieldhtml .= \" value=\\\"\".$fvalue.\"\\\"\";\n                        $fieldhtml .= \" \".XHTML.\">\";\n                    }else{\n                        $fieldhtml .=$fvalue;\n                    }\n            }\n\n\n            if ($checkrequried==1){//\u5fc5\u9808\n                $must= $lang_admin['must'];\n            }else{\n                $must=\"\";\n            }\n            $templates->set_var('lang_must_additionfield', $must);\n\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield_templatesetvar', \"&#123;\".$templatesetvar.\"&#125;\");\n\n            $addisionfields .= $fieldhtml;\n            $templates->set_var('additionfield_value', $fieldhtml);\n\n            $templates->set_var('additionfield_description', $description);\n            $templates->set_var('additionfield_description2', $description2);\n            $templates->set_var('fieldgroup_name', $fieldgroup_name);\n\t\t\tif  ($fieldgroup_old==$fieldgroup_name){\n                $templates->set_var('fieldgroup', \"\");\n            }else{\n                $templates->set_var('fieldgroup', $fieldgroup_name);\n                $fieldgroup_old=$fieldgroup_name;\n            }\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n\n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n        }\n    }\n\n    return $retval;\n}\n\n//\nfunction DATABOX_figurehtml(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n\n//    $retval .= \" value=\\\"\".$fvalue_fnm.\"\\\"\";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .=\"<img src=\\\"data:image/jpg;base64,\";\n        $retval .=\"{$fvalue}\\\"\";\n        $retval .=\"width=100 height=100\";\n        $retval .=\" \".XHTML.\">\".LB;\n        //\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n//  $photo_x = USER_getPhoto ($uid, $photo, $email, -1);\n\n    return $retval;\n}\nfunction DATABOX_filehtml(\n    $pi_name\n    ,$fid\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $lang_box_admin['deletemsg_check'];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\n\nfunction DATABOX_figurehtml12(\n    $fid\n    ,$fvalue\n    ,$fvalue_del\n    ,$size\n    ,$maxlength\n)\n{\n\n    global $LANG04;\n    \n    $a=explode(\"|\",$fvalue);\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"afield[\".$fid.\"]\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n\n    $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n    $retval .= \" id=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .= \" name=\\\"afield_fnm[\".$fid.\"]\\\" \";\n    $retval .=\"size=\\\"30\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    $retval .= \"<input \";\n    $retval .= \" type=\\\"text\\\"\";\n    $retval .= \" size=\\\"\".$size.\"\\\"\";\n    $retval .= \" maxlength=\\\"\".$maxlength.\"\\\" \";\n    $retval .= \" name=\\\"afield_alt[\".$fid.\"]\\\" \";\n    $retval .= \" style=\\\"max-width:95%\\\"\";\n    $retval .= \" value=\\\"\".$a[1].\"\\\"\";\n    $retval .= \" \".XHTML.\">\";\n\n    if ($fvalue<>\"\"){\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"afield_del[\".$fid.\"]\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_imagehtml(\n    $name\n    ,$fvalue\n    ,$fvalue_del\n)\n{\n\n    global $LANG04;\n\n    //\n    $retval .= \"        <input \";\n    $retval .= \" type=\\\"hidden\\\"\";\n    $retval .= \" name=\\\"\".$name.\"\\\" \";\n    $retval .= \" value=\\\"\".$fvalue.\"\\\"\";\n    $retval .= \" \".XHTML.\">\".LB;\n    \n    if ($fvalue==\"\"){\n\n        $retval .=\"<input type=\\\"file\\\" dir=\\\"ltr\\\"\";\n\n        $retval .= \" id=\\\"\".$name.\"\\\" \";\n        $retval .= \" name=\\\"\".$name.\"\\\" \";\n\n        $retval .=\"size=\\\"30\\\"\";\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }else{\n\n        $retval .=\"{$fvalue}\";\n        $retval .= '<br' . XHTML . '>' ;\n        $retval .= $LANG04[79];\n        $retval .= \"<input type=\\\"checkbox\\\"\";\n        $retval .= \" name=\\\"\".$name.\"_del\\\" \";\n        if ($fvalue_del){\n            $retval .= \" checked \";\n        }\n        $retval .= \" \".XHTML.\">\".LB;\n\n    }\n\n\n    return $retval;\n}\n\nfunction DATABOX_getaddtionfieldsText(\n    $fields\n    ,$addition_def\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeTEXT\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsText\n// |        ($additionfields,$addition_def,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76eetext\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_CONF;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n    \n    $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n        $name=$addition_def[$fid]['name'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n\n        $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n\n        $chk=false;\n        $disabled=\"disabled\";\n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($addition_def[$fid]['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($addition_def[$fid]['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n\n        if (in_array($fid,$fieldsetfields )) {\n            if ($chk) {\n                $retval.=$name.\":\";\n\n                switch ($type) {\n                    case 11://\u56f3\n                        $retval .= \"\";\n                        break;\n                    case 2://\u3044\u3044\u3048/\u306f\u3044\n                        $retval .= $lang_noyes[$fvalue];\n                        break;\n                    case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 8://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                        $retval .= $selectionary[$fvalue];\n                        break;\n                    case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $wk.=$selectionary[$wkary[$x]].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                        $retval .= $mstitems['value'];\n                        break;\n                    case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                        $wkary=explode(\":\",$fvalue);\n                        $wk=\"\";\n                        for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                            $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                            $wk.=$mstitems['value'].$separater;\n                        }\n                        $retval .= rtrim($wk,$separater);\n                        break;\n                    case 4://\u65e5\u6642\n                        $w=COM_getUserDateTimeFormat($fvalue);\n                        $retval .= $w[0];\n                        break;\n                    case 22://\u65e5\u4ed8\n                    case 23://\u65e5\u4ed8\n                    case 3://\u65e5\u4ed8\n                        if  ($fvalue<>\"\"){\n                            $retval .=strftime( $_CONF['shortdate'], $fvalue );\n                        }\n                        break;\n                    case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n                    case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                    case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                    case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)//@@@@@\n                    case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)//@@@@@\n                    default:\n                        $retval .= $fvalue;\n                }\n                $retval.=LB;\n            }\n        }\n    }\n    return $retval;\n}\n\n\n\nfunction DATABOX_getaddtionfieldsDisp(\n    $fields\n    ,$addition_def\n    ,$templates\n    ,$chk_user\n    ,$pi_name\n    ,$fieldset_id\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u4f5c\u6210                                              |\n// | \u66f8\u5f0f DATABOX_getaddtionfieldsDisp\n// |        ($additionfields,$addition_def,$templates,$chk_user)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fields:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $chk_user:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $fieldset_id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528HTML\u3000                                           |\n// +---------------------------------------------------------------------------+\n//update 20101012 $chk_user\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    \n    $noimage=\"lib/noimage.jpg\";\n    \n    $fieldsetfields=DATABOX_getfields($pi_name, $fieldset_id);\n    \n    $retval = '';\n\n    if (is_array($fields)){\n            $S = $fields;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $fields );\n        }else {\n            $S = array();\n        }\n    }\n\n    foreach( $S as $fid => $fvalue ){\n\n\n        $name=$addition_def[$fid]['name'];\n        $description=$addition_def[$fid]['description'];\n        $checkrequried=$addition_def[$fid]['checkrequried'];\n        $type=$addition_def[$fid]['type'];\n        $selectionary=$addition_def[$fid]['selectionary'];\n        $selectlist=$addition_def[$fid]['selectlist'];\n\n        $size=$addition_def[$fid]['size'];\n        $maxlength=$addition_def[$fid]['maxlength'];\n        $rows=$addition_def[$fid]['rows'];\n        $br=$addition_def[$fid]['br'];\n        $format=$addition_def[$fid]['format'];\n\n        $templatesetvar=$addition_def[$fid]['templatesetvar'];\n\n        $chk=false;\n        if (in_array($fid,$fieldsetfields )) {\n            //\u8868\u793a\u3059\u308b\n            if  ($addition_def[$fid]['allow_display']==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n                //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($addition_def[$fid]['allow_display']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n                //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($addition_def[$fid]['allow_display']==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n        }\n        if ($chk) {\n            $fieldhtml=\"\";//\u5916\u753b\u50cf\u306e\u5834\u5408\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtml_tn=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $fieldhtmldisp=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtmldisp_tn=\"\";//\u5916\u753b\u50cf\u3000\u753b\u50cf\u8868\u793a\u3000\uff08\u6e96\u5099\u4e2d\uff09\n            $fieldhtml_noimage=\"\";\n            $fieldhtml_tn_noimage=\"\";\n\t\t\t$fieldhtml_tn_image=\"\";//\u30b5\u30e0\u30cd\u30a4\u30eb\n\t\t\t$fieldhtml_readfile=\"\";//\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30ebreadfile\n            $mstitems=array();\n            $fieldhtml_yes=\"\";\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\uff08\u6e96\u5099\u4e2d\uff09\n                    $a=explode(\"|\",$fvalue);\n                    $fieldhtml=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                    $fieldhtml_noimage=$a[0];\n                    //\n                    if  ($fvalue===\"\"){\n                        $fieldhtml_noimage=$noimage;\n                        $fieldhtml_tn_noimage=$noimage;\n                    }else{\n\n                        $fieldurl= $_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n                        $fieldurl.= $a[0] ;\n\n                        $fieldhtmldisp .=\"<img \";\n                        $fieldhtmldisp .=\" src=\\\"{$fieldurl}\\\"\";\n                        $fieldhtmldisp .=\" border=\\\"0\\\"\";\n                        $fieldhtmldisp .=\" alt=\\\"{$a[1]}\\\"\";\n                        $fieldhtmldisp .=\" \".HTML.\">\";\n                    \n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\n                        $filename = substr($fvalue, 0, strrpos($fvalue,\".\"));\n                        $thum_filename = $filename . \"-small.jpg\";\n                        $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    \n                        if(file_exists($imgfld_thmb.$thum_filename)) {\n                            $fieldhtml_tn=$thum_filename;\n                            $fieldhtml_tn_noimage=$thum_filename;\n                            //\n                            $fieldurl_tn= $_CONF['site_url']   .\"/\".$box_conf['imgfile_thumb_frd'] ;\n                            $fieldurl_tn.= $thum_filename ;\n                            //\n                            $fieldhtml_tn_image .=\"<a href=\\\"{$fieldurl}\\\" target=\\\"_blank\\\">\";\n                            $fieldhtml_tn_image .=\"<img \";\n                            $fieldhtml_tn_image .=\" src=\\\"{$fieldurl_tn}\\\"\";\n                            $fieldhtml_tn_image .=\" border=\\\"0\\\"\";\n                            $fieldhtml_tn_image .=\" alt=\\\"{$a[1]}\\\"\";\n                            $fieldhtml_tn_image .=\" \".XHTML.\">\";\n                            $fieldhtml_tn_image .=\" </a>\";\n                        \n                        }else{\n                            $fieldhtml_tn_noimage=$noimage;\n                        }\n                        \n                    }\n\n                    break;\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $a=explode(\"|\",$fvalue);\n                        $fieldhtml .= $a[1];\n                        $fieldhtml_readfile = $a[0];\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($fvalue==\"\"){\n                    }else{\n                        $fieldhtml .=\"<img src=\\\"data:image/jpg;base64,\";\n                        $fieldhtml .=\"{$fvalue}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $fieldhtml .= $lang_noyes[$fvalue];\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@@\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09//@@@@@\n                    $fieldhtml .= $selectionary[$fvalue];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($fvalue);\n                    $w=DATABOX_autolink($w);\n                    $fieldhtml .= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$fvalue,$pi_name);\n                    $fieldhtml .= $mstitems['value'];\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$fvalue);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ )            {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                    }\n                    $fieldhtml .= rtrim($wk,$separater);\n                    \n                    $mstitems['value2'] = rtrim($wk_value2,$separater);\n                    $mstitems['disp'] = rtrim($wk_disp,$separater);\n                    $mstitems['no'] =$fvalue;\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($fvalue<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($fvalue,$format);\n                        $fieldhtml .= $w[0];\n                    }\n                    break;\n                case 26://\u6642\u523b\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .= DATABOX_getTimeformat($fvalue);\n                    }\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                case 3://\u65e5\u4ed8\n                    if  ($fvalue<>\"\"){\n                        $fieldhtml .=strftime( $_CONF['shortdate'], $fvalue );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $fieldhtml .= number_format( (float)$fvalue, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $fieldhtml .= $fvalue;\n            }\n            $templates->set_var('field_id', $fid);\n            $templates->set_var('field_type', $type);\n            \n            //\u9805\u76ee\u540d\n            $templates->set_var('additionfield_name', $name);\n            $templates->set_var('additionfield'.$fid.\"_name\", $name);\n            $templates->set_var($templatesetvar.\"_name\", $name);\n            \n            //\u8aac\u660e\n            $templates->set_var('additionfield'.$fid.\"_description\", $description);\n            $templates->set_var($templatesetvar.\"_description\", $description);\n            \n            //\u767b\u9332\u3057\u305f\u30c6\u30fc\u30de\u5909\u6570\u540d\n            $templates->set_var('additionfield_templatesetvar', $templatesetvar);\n            \n            //\n            $templates->set_var('additionfield_value', $fieldhtml);\n            $templates->set_var('additionfield'.$fid, $fieldhtml);\n            $templates->set_var($templatesetvar, $fieldhtml);\n            $templates->set_var('additionfield_fvalue', $fvalue);\n            $templates->set_var('additionfield'.$fid.\"_value\", $fvalue);\n            $templates->set_var($templatesetvar.\"_value\", $fvalue);\n            \n            if  ($type==12){\n                $templates->set_var('display_a', 'display:');\n            }else{\n                $templates->set_var('display_a', 'display:none');\n            }\n            //(a_1)_tn \u30b5\u30e0\u30cd\u30a4\u30eb\u30d5\u30a1\u30a4\u30eb\u540d\n            $templates->set_var('additionfield_value_tn', $fieldhtml_tn);\n            $templates->set_var('additionfield'.$fid.\"_tn\", $fieldhtml_tn);\n            $templates->set_var($templatesetvar.\"_tn\", $fieldhtml_tn);\n            \n            //(a_2)_noimage\n            $templates->set_var('additionfield_value_noimage', $fieldhtml_noimage);\n            $templates->set_var('additionfield'.$fid.\"_noimage\", $fieldhtml_noimage);\n            $templates->set_var($templatesetvar.\"_noimage\", $fieldhtml_noimage);\n            \n            //(a_3)_tn_image \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_image', $fieldhtml_tn_image);\n            $templates->set_var('additionfield'.$fid.\"_tn_image\", $fieldhtml_tn_image);\n            $templates->set_var($templatesetvar.\"_tn_image\", $fieldhtml_tn_image);\n            \n            //(a_4)_tn_noimage \u30b5\u30e0\u30cd\u30a4\u30eb\u30a4\u30e1\u30fc\u30b8\n            $templates->set_var('additionfield_value_tn_noimage', $fieldhtml_tn_noimage);\n            $templates->set_var('additionfield'.$fid.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            $templates->set_var($templatesetvar.\"_tn_noimage\", $fieldhtml_tn_noimage);\n            \n            //(a_5)disp \u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\u8868\u793a\n            $templates->set_var('additionfield_value_disp', $fieldhtmldisp);\n            $templates->set_var('additionfield'.$fid.\"_disp\", $fieldhtmldisp);\n            $templates->set_var($templatesetvar.\"_disp\", $fieldhtmldisp);\n            \n            if  ( $type==9 OR $type==16 OR $type==18 ){\n                $templates->set_var('display_b', 'display:');\n            }else{\n                $templates->set_var('display_b', 'display:none');\n            }\n            //(b_1)\u30de\u30b9\u30bf\u30fc\u306evalue2\n            $templates->set_var('additionfield_value_mst_value2', $mstitems['value2']);\n            $templates->set_var('additionfield'.$fid.\"_mst_value2\", $mstitems['value2']);\n            $templates->set_var($templatesetvar.\"_mst_value2\", $mstitems['value2']);\n            \n            //(b_2)\u30de\u30b9\u30bf\u30fc\u306edisp\n            $templates->set_var('additionfield_value_mst_disp', $mstitems['disp']);\n            $templates->set_var('additionfield'.$fid.\"_mst_disp\", $mstitems['disp']);\n            $templates->set_var($templatesetvar.\"_mst_disp\", $mstitems['disp']);\n            \n            //(b_3)\u30de\u30b9\u30bf\u30fc\u306eno\n            $templates->set_var('additionfield_value_mst_no', $mstitems['no']);\n            $templates->set_var('additionfield'.$fid.\"_mst_no\", $mstitems['no']);\n            $templates->set_var($templatesetvar.\"_mst_no\", $mstitems['no']);\n            \n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var('additionfield'.$fid.\"_disptn\", $fieldhtmldisp_tn);\n            //@@@@@ \u6e96\u5099\u4e2d\u3000$templates->set_var($templatesetvar.\"_disptn\", $fieldhtmldisp_tn);\n\t\t\t\n            if  ( $type==13  ){\n                $templates->set_var('display_c', 'display:');\n            }else{\n                $templates->set_var('display_c', 'display:none');\n            }\n\t\t\t//(c)\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\u306e\u8a18\u61b6\u30d5\u30a1\u30a4\u30eb\u540d(templatesetvar_(id)_(readfile))\n            $templates->set_var('additionfield_value_readfile', $fieldhtml_readfile);\n            $templates->set_var('additionfield'.$fid.\"_readfile\", $fieldhtml_readfile);\n            $templates->set_var($templatesetvar.\"_readfile\", $fieldhtml_readfile);\n\t\t\t\n\t\t\t//\u5fc5\u9808\u30c1\u30a7\u30c3\u30af(templatesetvar_(id)_(requied))\n            $templates->set_var('additionfield'.$fid.\"_requried\", $checkrequried);\n            $templates->set_var($templatesetvar.\"_requried\", $checkrequried);\n\t\t\t\n            //\u6587\u8a00\n            $templates->set_var('lang_download', $lang_box['download']);\n            $templates->set_var('lang_downloadrequired', $lang_box['downloadrequired']);\n            $templates->set_var('lang_display', $lang_box['display']);\n            $templates->set_var('lang_displayrequired', $lang_box['displayrequired']);\n            \n            //=====\n            $templates->parse ('col_var', 'col', true);\n            $templates->parse ('additionfields', 'row', true);\n\n            $templates->set_var ('col_var', '');\n\n        }\n    }\n\n\n    return $retval;\n}\n\n//\nfunction DATABOX_getMstItems(\n    $selectlist\n    ,$id\n    ,$pi_name\n//DATABOX_getMstItems($id,$pi_name);\n){\n    if ($id==\"\"){\n        return array();\n    }\n    global $_TABLES;\n    \n    $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n\n    $sql=\"SELECT * FROM  {$table_mst} WHERE kind='{$selectlist}' AND no={$id}\";\n    \n    $result = DB_query($sql);\n    $numrows = DB_numRows ($result);\n    if ($numrows > 0) {\n        $A = DB_fetchArray($result, true);\n        $A = array_map('stripslashes', $A);\n    }else{\n        $A=array();\n    }\n    return $A;\n}\n\n\nfunction DATABOX_getcategoriesText(\n    $id\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u30e1\u30fc\u30eb\u9001\u4fe1\u7528\u30c6\u30ad\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesText\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u30c6\u30ad\u30b9\u30c8\n// +---------------------------------------------------------------------------+\n//20101116\n{\n    global $_TABLES;\n    global $_CONF;\n\n\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $lang_box_admin=\"LANG_DATABOX_ADMIN\";\n\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater_text'];\n\n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    $categories_group =\"\";\n    $rt=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n                $categories_group=rtrim($categories_group,$separater);\n                $rt.=$categories_group.LB;\n            }\n            $categories_group =\"\";\n            $old_group_id=$A['group_id'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n\n    }\n\n    $categories=rtrim($categories,$separater);\n    $categories_group=rtrim($categories_group,$separater);\n    $rt.=$categories_group.LB;\n\n    $retval.=$lang_box_admin['category'].\": \".$categories.LB;\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesDisp(\n    $id\n    ,$templates\n    ,$chk_user\n    ,$group_id=0\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30eaHRML\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getcategoriesDisp\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $templates:\n// | \u5f15\u6570 $group_id:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u8868\u793a\u7528HTML\n// +---------------------------------------------------------------------------+\n//20101129\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n        $box_conf=\"_DATABOX_CONF\";\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_category=$_TABLES['DATABOX_category'];\n\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n        $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_category=$_TABLES[strtoupper($pi_name).'_category'];\n    }\n\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    $sql = \"SELECT \";\n    $sql .= \" group_id\".LB;\n    $sql .= \" ,code\".LB;\n    $sql .= \" FROM \";\n    $sql .= \" {$table_def_group} \".LB;\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n    \n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $gid=$A['group_id'];\n        $gcode=$A['code'];\n        $templates->set_var('group_'.$gid, \"\");\n        $templates->set_var('group_'.$gcode, \"\");\n        $templates->set_var('group_'.$gid.\"_code\", \"\");\n        $templates->set_var('group_'.$gcode.\"_code\", \"\");\n                \n        $templates->set_var('grouplink_'.$gid, \"\");\n        $templates->set_var('grouplink_'.$gid.\"_code\", \"\");\n\n        $templates->set_var('grouplink_'.$gcode, \"\");\n        $templates->set_var('grouplink_'.$gcode.\"_code\", \"\");\n    }\n    \n    \n    \n    $retval = '';\n\n    $sql = \"SELECT \".LB;\n    $sql .= \" m1.category_id\".LB;\n    $sql .= \",m1.name AS category_name\".LB;\n    $sql .= \",m1.code AS category_code\".LB;\n    //$sql .= \",m1.orderno\";\n    $sql .= \",m1.categorygroup_id\".LB;\n    $sql .= \",m1.allow_display\".LB;\n    //$sql .= \",m2.name AS group\";\n    $sql .= \",m2.code AS group_code\".LB;\n    $sql .= \",m2.group_id\".LB;//@@@@@@\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_category} AS t\".LB;\n    $sql .= \" , {$table_def_category} AS m1\".LB;\n    $sql .= \" , {$table_def_group} AS m2\".LB;\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t.id = \".$id.LB;\n\n    if ($group_id<>0){\n        $sql .= \" AND m1.categorygroup_id=\".$group_id.LB;\n    }\n    $sql .= \" AND m1.category_id = t.category_id\".LB;\n    $sql .= \" AND m2.group_id = m1.categorygroup_id\".LB;\n\n    $sql .= \" ORDER by m1.categorygroup_id, m2.orderno, m1.orderno,m1.category_id\".LB;\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $separater=$lang_box['category_separater'];\n    $separater_code=$lang_box['category_separater_code'];\n    $separater_pipeline=\"|\";\n    \n    $categpries=\"\";\n\n\n    $old_group_id=\"\";\n    $old_group_code=\"\";\n    \n    $categories_group =\"\";\n    $categories_link_id_group =\"\";\n    $categories_link_code_group =\"\";\n    \n    $categories_group2 =\"\";\n    $categories_link_id_group2 =\"\";\n    $categories_link_code_group2 =\"\";\n    \n    $categories_group_pipeline =\"\";\n    \n    //group_id2, group_code2, grouplinkid2, grouplinkcode2,\n    //group_id \u304c\u30ab\u30c6\u30b4\u30ea\u306e\u540d\u79f0\u3092\u8868\u793a\u3059\u308b\u306e\u306b\u5bfe\u3057\u3001\n    //group_id2\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group $categories_link_id_group $categories_link_code_group\n    //group_pipeline\u306f\u30ab\u30c6\u30b4\u30ea\u306e\u30b3\u30fc\u30c9\u30d1\u30a4\u30d7\u30e9\u30a4\u30f3\u533a\u5207\u3092\u8868\u793a\u3059\u308b\u3002\n    //$categories_group_pipeline\n    for( $i = 0; $i < $nrows; $i++ )    {\n        $A = DB_fetchArray( $result, true );\n        $A = array_map('stripslashes', $A);\n        $chk=false;\n        //\u8868\u793a\u3059\u308b\n        if  ($A['allow_display']==='0') {\n            $chk=true;\n        //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n        }else if ($A['allow_display']==='1'){\n            if  ($chk_user>=1000) {\n                $chk=true;\n            }\n        //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n        }else if ($A['allow_display']==='2'){\n            if  ($chk_user>=1010) {\n                $chk=true;\n            }\n        //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='3'){\n            if  ($chk_user>=1011) {\n                $chk=true;\n            }\n        //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n        }else if ($A['allow_display']==='4'){\n            if  ($chk_user>=1100) {\n                $chk=true;\n            }\n        }\n        \n        if  ($chk==false){\n            continue;\n        }\n        if ($old_group_id<>$A['group_id']){\n            if ($categories_group<>\"\"){\n\n                $categories_group=rtrim($categories_group,$separater);\n                $templates->set_var('group_'.$old_group_id, $categories_group);\n                $templates->set_var('group_'.$old_group_code, $categories_group);\n                $categories_group2=rtrim($categories_group2,$separater_code);\n                $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n                $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n                $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n                $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n                $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n                \n                $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n                $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);\n\n                $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n                $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n                $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);\n                $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);\n\n            }\n            $categories_group =\"\";\n            $categories_link_id_group =\"\";\n            $categories_link_code_group =\"\";\n            $categories_group2 =\"\";\n            $categories_link_id_group2 =\"\";\n            $categories_link_code_group2 =\"\";\n            $categories_group_pipeline=\"\";//@@\n            \n            $old_group_id=$A['group_id'];\n            $old_group_code=$A['group_code'];\n        }\n        $categories.=$A['category_name'].$separater;\n        $categories_group.=$A['category_name'].$separater;\n        $categories_group2.=$A['category_code'].$separater_code;\n        $categories_group_pipeline.=$A['category_code'].$separater_pipeline;\n        \n\n        $name=$A['category_name'];\n        $code=COM_applyFilter($A['category_code']);\n        $url=$_CONF['site_url'] .\"/\".$pi_name.\"/category.php\";\n        $url_code=$url;\n        $url_code.=\"?code=\".$A['category_code'];\n        $url_code.=\"&m=code\";\n        $url_code = COM_buildUrl( $url_code );\n        $url_id=$url;\n        $url_id.=\"?id=\".$A['category_id'];\n        $url_id.=\"&m=id\";\n        $url_id= COM_buildUrl( $url_id );\n        $category_link_id= COM_createLink($name, $url_id);\n        $category_link_code= COM_createLink($name, $url_code);\n        $category_link_id2= COM_createLink($code, $url_id);\n        $category_link_code2= COM_createLink($code, $url_code);\n\n        $categories_link_id.=$category_link_id.$separater;\n        $categories_link_id_group.=$category_link_id.$separater;\n        $categories_link_id_group2.=$category_link_id2.$separater_code;//@@\n        $categories_link_code.=$category_link_code.$separater;\n        $categories_link_code_group.=$category_link_code.$separater;\n        $categories_link_code_group2.=$category_link_code2.$separater_code;//@@\n    }\n\n    $categories=rtrim($categories,$separater);\n    $templates->set_var('categories', $categories);\n\n\n    $categories_link_code=rtrim($categories_link_code,$separater);\n    $categories_link_id=rtrim($categories_link_id,$separater);\n\n\n    if ($box_conf['categoriescode']){\n        $categorieslink=$categories_link_code;\n    }else{\n        $categorieslink=$categories_link_id;\n    }\n    $templates->set_var('categorieslink', $categorieslink);\n\n\n    $templates->set_var('categorieslinkcode', $categories_link_code);\n    $templates->set_var('categorieslinkid', $categories_link_id);\n\n    $categories_group=rtrim($categories_group,$separater);\n    $categories_group2=rtrim($categories_group2,$separater_code);\n    $categories_group_pipeline=rtrim($categories_group_pipeline,$separater_pipeline);//@@\n\n    $templates->set_var('group_'.$old_group_id, $categories_group);\n    $templates->set_var('group_'.$old_group_code, $categories_group);\n    $templates->set_var('group_'.$old_group_id.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_code.\"_code\", $categories_group2);\n    $templates->set_var('group_'.$old_group_id.\"_pipeline\", $categories_group_pipeline);//@@\n    $templates->set_var('group_'.$old_group_code.\"_pipeline\", $categories_group_pipeline);//@@\n\n    $categories_link_id_group=rtrim($categories_link_id_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_id, $categories_link_id_group);\n    \n    $categories_link_id_group2=rtrim($categories_link_id_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_id.\"_code\", $categories_link_id_group2);//@@\n    \n    $categories_link_code_group=rtrim($categories_link_code_group,$separater);\n    $templates->set_var('grouplink_'.$old_group_code, $categories_link_code_group);\n    \n    $categories_link_code_group2=rtrim($categories_link_code_group2,$separater_code);//@@\n    $templates->set_var('grouplink_'.$old_group_code.\"_code\", $categories_link_code_group2);//@@\n\n    return $retval;\n}\n\nfunction DATABOX_getcategoriesinp(\n    $selected = \"\"\n    ,$fieldset_id=\"\"\n    ,$pi_name=\"\"\n    ,$chk_user=9999\n)\n{\nglobal $_TABLES;\n    if ($pi_name==\"\"){\n        $table_def_category=$_TABLES['DATABOX_def_category'];\n        $table_def_group=$_TABLES['DATABOX_def_group'];\n        $table_def_fieldset_group=$_TABLES['DATABOX_def_fieldset_group'];\n        $table_mst=$_TABLES['DATABOX_mst'];\n    }else{\n        $table_def_category=$_TABLES[strtoupper($pi_name).'_def_category'];\n        $table_def_group=$_TABLES[strtoupper($pi_name).'_def_group'];\n        $table_def_fieldset_group=$_TABLES[strtoupper($pi_name).'_def_fieldset_group'];\n        $table_mst=$_TABLES[strtoupper($pi_name).'_mst'];\n    }\n    \n    //\n    if (is_array($selected)){\n            $S = $selected;\n    }else{\n        if( !empty( $selected ))    {\n            $S = explode( ' ', $selected );\n        }else {\n            $S = array();\n        }\n    }\n    \n    //\n    $retval = '';\n\n    $sql = \"SELECT \";\n    $sql .= \"m2.group_id\".LB;\n    $sql .= \",m2.name AS group_name\".LB;\n    $sql .= \",m2.input_type\".LB;\n    $sql .= \",m2.allow_edit\".LB;\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$table_def_group} AS m2\".LB;\n    if  ($fieldset_id<>0){\n        $sql .= \" ,{$table_def_fieldset_group} AS m3\".LB;\n        $sql .= \" WHERE \".LB;\n        $sql .= \" m2.group_id = m3.group_id\".LB;\n        $sql .= \" AND m3.fieldset_id = \".$fieldset_id .LB;\n    }\n    \n    \n    $sql .= \" ORDER BY m2.orderno\".LB;\n        \n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    $categoryids=\"\";\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n        \n        $chk=false;\n        $disabled=\"disabled\";\n        \n        if ($chk_user===9999){\n            $chk=true;\n            $disabled=\"\";\n        }else{\n            //\u7de8\u96c6\u53ef\u80fd\n            if  ($A['allow_edit']==='0') {\n                $chk=true;\n                $disabled=\"\";\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($A['allow_edit']==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n                //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($A['allow_edit']==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                    $disabled=\"\";\n                }\n            //\u7de8\u96c6\u4e0d\u53ef\u8868\u793a\u306e\u307f\n            }else if ($A['allow_edit']==='4'){\n                $chk=true;\n            }\n        }\n        if ($chk==false) {\n            continue;\n        }\n\t\t\n        $sql2 = \"SELECT \";\n        $sql2 .= \" m1.category_id\".LB;\n        $sql2 .= \",m1.name\".LB;\n        $sql2 .= \",m1.orderno\".LB;\n        $sql2 .= \" FROM {$table_def_category} AS m1\".LB;\n        $sql2 .= \" WHERE \".LB;\n        $sql2 .= \" m1.categorygroup_id=\".$A['group_id'].LB;\n        \n        $sql2 .= \" ORDER BY m1.orderno\".LB;\n        \n        $result2 = DB_query( $sql2 );\n        $nrows2 = DB_numRows( $result2 );\n        \n        if ($nrows2>0){\n            $retval .=\"<div class=\\\"databox_admin_data_title\\\">\";\n            $retval .=$A['group_name'];\n            $retval .=\"</div>\".LB;\n        \n            if  ($A['input_type']==1){\n                $retval .='<select name=\"category[]\" multiple style=\"height:10em\" '.$disabled.' >'.LB;\n            }else if ($A['input_type']==3){\n                $retval .='<select name=\"category[]\" '. $disabled .' >'.LB;\n            }\n            \n            for( $i2 = 0; $i2 < $nrows2; $i2++ )    {\n\n                $A2 = DB_fetchArray( $result2, true );\n                \n\t\t\t\tif  ($disabled==\"\"){\n\t\t\t\t\t$categoryids.=$A2['category_id'].\"|\";\n                }\n                \n                $checked=\" \";\n                for( $x = 0; $x < sizeof( $S ); $x++ )            {\n                    if( $A2['category_id'] == $S[$x] )                {\n                        if  ($A['input_type']==0 OR $A['input_type']==2){\n                            $checked= ' checked=\"checked\" ';\n                        }else{\n                            $checked= ' selected ';\n                        }\n                    }\n                }\n            \n                if  ($A['input_type']==0){\n                    $retval .= '<span style=\"white-space:nowrap\">';\n                    $retval .= '<input type=\"checkbox\" name=\"category[]\" value=\"' . $A2['category_id'] ;\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= $disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==1){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }else  if  ($A['input_type']==2){\n                    $retval .= '<input type=\"radio\" name=\"category[]\" value=\"' . $A2['category_id'];\n                    $retval .= '\"';\n                    $retval .= $checked;\n                    $retval .= ' '.$disabled.' >' . stripslashes( $A2['name'] ) . '</span>' . LB;\n                }else  if  ($A['input_type']==3){\n                    $retval .= '<option value=\"' . $A2['category_id'] . '\"';\n                    $retval .= $checked;\n                    $retval .= ' >' . stripslashes( $A2['name'] ) ;\n                    $retval .= '</option>' . LB;\n                }\n            }\n        \n            if  ($A['input_type']==1  OR  $A['input_type']==3  ){\n                $retval .='</select>';\n            }\n        }\n        \n\t}\n\tif  ($categoryids==\"\"){\n\t}else{\n\t\t$categoryids=substr($categoryids,0,strlen($categoryids)-1);\n        $retval .= \"  <input type='hidden' name='categories' value='{$categoryids}'>\";\n    }\n    return $retval;\n}\nfunction DATABOX_getaddtionfields(\n    $id\n    ,$addition_def\n    ,$pi_name\n    ,$field_id=0\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getadditionfields($id,$addition_def,$tbl_prefix,$field_id)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\u306e\u914d\u5217\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n\n    global $_TABLES;\n\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n\n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n\n    $retval=array();\n\n    $sql = \"SELECT \";\n    $sql .= \" value\";\n    $sql .= \",t.field_id\";\n\n    $sql .= \" FROM {$table_addition} AS t\";\n    $sql .= \" , {$table_def_field} AS m\";\n    $sql .= \" WHERE \";\n    $sql .= \" t.id={$id}\";\n    $sql .= \" AND t.field_id=m.field_id\";\n    if ($field_id<>0){\n        $sql .= \" AND t.field_id=\".$field_id;\n    }\n\n    $sql .= \" ORDER BY m.orderno\";\n\n    $result = DB_query( $sql );\n    $nrows = DB_numRows( $result );\n\n    for( $i = 0; $i < $nrows; $i++ )    {\n\n        $A = DB_fetchArray( $result, true );\n\n        $fid=$A[\"field_id\"];\n        $value=$A[\"value\"];\n\n        $fieldvalue=DATABOX_getfieldvalue(\n            $value\n            ,$addition_def[$fid]['type']\n            ,$addition_def[$fid]['selectionary']\n            ,$lang_noyes\n            ,$addition_def[$fid]['selectlist']\n            ,$pi_name\n            );\n        $retval[$fid]=$fieldvalue;\n    }\n\n    return $retval;\n}\n\nfunction DATABOX_getfieldvalue(\n    $value\n    ,$type\n    ,$selectionary\n    ,$lang_noyes\n    ,$selectlist\n    ,$pi_name\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u5024\u3092\u8fd4\u3059\u3000\u3000\u3000\u3000                                            |\n// | \u66f8\u5f0f DATABOX_getfieldvalue($value,$type,$selectionary,$lang_noyes)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $value:\n// | \u5f15\u6570 $type:\n// | \u5f15\u6570 $selectionary:\n// | \u5f15\u6570 $lang_noyes:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u5024\n// +---------------------------------------------------------------------------+\n//update 20110204\n{\n    global $_TABLES;\n    global $_CONF;\n    \n    switch ($type) {\n\n        case 2://\u3044\u3044\u3048/\u306f\u3044\n            $fieldvalue = $lang_noyes[$value];\n            break;\n        case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n        case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n            $fieldvalue= $selectionary[$value];\n            break;\n        case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n        case 16://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n            if  ($value==\"\"){\n                $fieldvalue=\"\";\n            }else{\n                $fieldvalue=DB_getItem($_TABLES[strtoupper($pi_name).'_mst'] \n                    ,\"value\"\n                    ,\"kind='{$selectlist}' AND no={$value}\");\n            }\n            break;\n        case 4://\u65e5\u6642\n            $w=COM_getUserDateTimeFormat($value);\n            $fieldvalue= $w[0];\n            break;\n        case 3://\u65e5\u4ed8\n            $fieldvalue=strftime( $_CONF['shortdate'], $value );\n            break;\n        case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n        case 6://url\u3000\uff08\u6e96\u5099\u4e2d\uff09';\n\n        case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n        case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n        case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n        case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n        default:\n            $fieldvalue = $value;\n        }\n\n    return $fieldvalue;\n}\n\n\nfunction DATABOX_saveaddtiondatas(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc                                                        |\n// | \u66f8\u5f0f\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n    \n    $rt=DB_delete($table,\"id\",$id);\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            $sql=\"INSERT INTO {$table} (\";\n            $sql.=\"id, field_id,value \";\n            $sql.=\") VALUES (\";\n            $sql.=\"{$id},{$field_id}\";\n            if  ($value<>\"\") {\n                $sql.=\", '{$value}'\";\n            }else{\n                $sql.=\", NULL\";\n            }\n            $sql.=\")\";\n            DB_query($sql);\n        }\n    }\n    return ;\n\n}\n\nfunction DATABOX_saveaddtiondatas_update(\n    $id\n    ,$fldary = \"\"\n    ,$addition_def=\"\"\n    ,$pi_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u66f8\u8fbc user\u7528\n// | \u66f8\u5f0f $rt=DATABOX_saveaddtiondatas_update\n// |               ($id,$additionfields,$addition_def,$pi_name);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ide:\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def:\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//\n{\n    global $_TABLES;\n\n    if ($pi_name==\"\"){\n        $table=$_TABLES['DATABOX_addition'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_addition'];\n    }\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //if ($addition_def[$field_id]['type']=11){\n            $sql=\"UPDATE \".$table .\" SET \";\n            if  ($value<>\"\") {\n                $sql.=\" value ='\".$value.\"'\";\n            }else{\n                $sql.=\" value =NULL\";\n            }\n            $sql.=\" WHERE id=\".$id.\" AND field_id=\".$field_id;\n            DB_query($sql);\n        }\n    }\n\n\n    return ;\n\n}\n\nfunction DATABOX_cleanaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,&$fnmary\n    ,&$delary\n    ,&$dateary\n    ,&$altary\n    ,$addslash = true\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeclean\n// | \u66f8\u5f0f DATABOX_cleanadditiondatas($fldary,$typeary)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\n// | \u5f15\u6570 $addition_def\n// | \u5f15\u6570 $fnmary\n// | \u5f15\u6570 $delary\n// | \u5f15\u6570 $addslash \n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:                                                               |\n// +---------------------------------------------------------------------------+\n//update 20131022 12\n{\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            $type=$addition_def[$field_id]['type'];\n            $textconv=$addition_def[$field_id]['textconv'];\n            $textcheck=$addition_def[$field_id]['textcheck'];\n            $wk=$value;\n            //\u5165\u529b\u5024\u5909\u63db\n            switch ($type) {\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK TinyMCE)\n                if  (($textconv==10)\n                        OR ($textcheck>=11 AND $textcheck<=14)){ //\u534a\u89d2\u30c1\u30a7\u30c3\u30af;\n                        $wk = mb_convert_kana($wk,\"ak\");\n                    }else if ($textconv==20){ //\u5168\u89d2\u306b\u5909\u63db\u3059\u308b';\n                        $wk = mb_convert_kana($wk,\"AKV\");\n                }\n                break;\n            }\n            //\n            switch ($type) {\n                case 11:// \u56f3\n                    break;\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\n                case 10://\u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\n                    $wk=COM_stripslashes($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 1://HTML\n                case 20://TinyMCE\n                case 19://CKEditor\n                    $wk=COM_stripslashes($wk);\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    $wk=COM_applyFilter($wk,true);\n                    break;\n                case 3://\u65e5\u4ed8\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day;\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    break;\n                case 22://\u65e5\u4ed8\n                case 23://\u65e5\u4ed8\n                    $ary_wk=date_parse( $wk);\n                    if  ($ary_wk[error_count]==0){\n                        $dateary[$field_id]['month']= $ary_wk[month];\n                        $dateary[$field_id]['day']= $ary_wk[day];\n                        $dateary[$field_id]['year']= $ary_wk[year];\n                    }else{\n                        $wk=\"\";\n                        $dateary[$field_id]['month']= \"\";\n                        $dateary[$field_id]['day']= \"\";\n                        $dateary[$field_id]['year']= \"\";\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    $wk_year=$_POST['afield'.$field_id.'_year'];\n                    $wk_month=$_POST['afield'.$field_id.'_month'];\n                    $wk_day=$_POST['afield'.$field_id.'_day'];\n                    $wk_hour=$_POST['afield'.$field_id.'_hour'];\n                    $wk_minute=$_POST['afield'.$field_id.'_minute'];\n                    $wk_ampm=$_POST['afield'.$field_id.'_ampm'];\n                    $dateary[$field_id]['year']=$wk_year;//@@@@@\n                    $dateary[$field_id]['month']=$wk_month;//@@@@@\n                    $dateary[$field_id]['day']=$wk_day;//@@@@@\n                    $dateary[$field_id]['hour']=$wk_hour;//@@@@@\n                    $dateary[$field_id]['minute']=$wk_minute;//@@@@@\n                    $dateary[$field_id]['ampm']=$wk_ampm;//@@@@@\n                    if ($wk_ampm == 'pm') {\n                        if ($wk_hour < 12) {\n                            $wk_hour = $wk_hour + 12;\n                        }\n                    }\n                    if ($wk_ampm == 'am' AND $wk_hour == 12) {\n                        $wk_hour = '00';\n                    }\n                    $wk=$wk_year.\"-\".$wk_month.\"-\".$wk_day .\" \".$wk_hour.\":\".$wk_minute;\n                    break;\n                case 26://\u6642\u523b\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    break;\n                case 24://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u9078\u629e\u80a2\uff09\n                case 25://\u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wk=implode ($wk,\":\");\n                    break;\n                case 12:// \u753b\u50cf\uff08\u30d5\u30a1\u30a4\u30eb\u4fdd\u5b58\uff09\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($altary[$field_id]);\n                    $wk2=COM_checkHTML (COM_checkWords ($wk2));\n                    $altary[$field_id]=$wk2;\n                    $a=explode(\"|\",$wk);\n                    $wk=$a[0].\"|\".$wk2;\n                    break;\n                case 13:// \u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    $fnmary[$field_id]=COM_applyFilter($fnmary[$field_id]);\n                    $delary[$field_id]=COM_applyFilter($delary[$field_id]);\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n                    $wk2=COM_applyFilter($delary[$field_id]);\n                    $delary[$field_id]=COM_checkHTML (COM_checkWords ($wk2));\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09';\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9';\n                case 6://url';\n                default:\n                    $wk=COM_applyFilter($wk);\n                    $wk=COM_checkHTML (COM_checkWords ($wk));\n            }\n            if ($addslash){\n                $wk=addslashes ($wk);\n            }\n            $fldary[$field_id] =$wk;\n        }\n    }\n\n    return $fldary;\n\n}\n\nfunction DATABOX_checkaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u8ffd\u52a0\u9805\u76eecheck\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($fldary,$typeary,$pi_data)\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n    \n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            //\u5fc5\u9808\n            if ($addition_def[$field_id]['checkrequried']==1){\n                if ($value ===\"\"){\n                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_checkrequried'] ;\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                }\n                //url email date\n            }\n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                 $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                 if  ( $box_conf['imgfile_subdir']==1){\n                    $imgfld_thmb.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $imgfld )){\n                    $rt.=$imgfld.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if  ($imgfld<>$imgfld_thmb){\n                    if (!is_writable ( $imgfld_thmb )){\n                        $rt.=$imgfld_thmb.\": \".$lang_box_admin['err_writable'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                     //$fldary[$field_id]=\"\";\n                     //$fldary_fnm[$field_id]=\"\";\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($imgfile<>\"\"){\n                            $imgerr=\"\";\n                            if ($box_conf['imgfile_size2']<>\"\" AND $imgsize>$box_conf['imgfile_size2']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $imgerr=1;\n                            }\n                            if (count($box_conf['imgfile_type2'])>0){\n                                if  (in_array($imgtype,$box_conf['imgfile_type2'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type2']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $imgerr=1;\n                                }\n                            }\n                        \n                            //$imgname=sanitize\n                            // \u554f\u984c\u6587\u5b57\u3092\u9664\u304f\n                            //$filename = str_replace(\"&\",\"\",$filename);\n                            //$filename = str_replace(\"'\",\"\",$filename);\n                            //$filename = str_replace(\"/\",\"\",$filename);\n                            //$filename = str_replace(\".JPG\",\".jpg\",$filename);\n                            //\u91cd\u8907\u30c1\u30a7\u30c3\u30af\n                            if  ($imgerr===\"\"){\n                                $fldary[$field_id]=$imgname.\"|\".fldary_alt;//@@@@@@@!!!!\n                            }\n                        }\n                    }else{\n                        \n                    }    \n                 }\n            }\n\n\n\n            //\u56f3 DB\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==11){//\u56f3\n\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                        $fldary[$field_id]=\"\";\n                        $fldary_fnm[$field_id]=\"\";\n                 }else{\n                    //$figure = $_FILES[$w];\n                    // $imgfile=$figure[ 'tmp_name' ];\n\n\n                     $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                     $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                     $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n\n                     if  ($imgfile<>\"\"){\n                          $imgerr=\"\";\n                          if ($box_conf['imgfile_size']<>\"\" AND $imgsize>$box_conf['imgfile_size']){\n                              $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                              $rt.=\"<br \".XHTML.\">\".LB;\n                              $imgerr=1;\n                          }\n                          if (count($box_conf['imgfile_type'])>0){\n                              if  (in_array($imgtype,$box_conf['imgfile_type'])){\n                              }else{\n                                  $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                  .$_FILES['afield_fnm']['name'][$field_id].\"(\".$imgtype.\")\";\n                                  $rt.=\"<br \".XHTML.\">\".LB;\n                                 $imgerr=1;\n                              }\n                          }\n                          if  ($imgerr===\"\"){\n                              $imgbinary = fread ( fopen ( $imgfile , \"r\" ), filesize ( $imgfile ));\n                              $fldary[$field_id]=base64_encode($imgbinary);\n                          }\n                     }\n                 }\n            }\n\n            //\u65e5\u4ed8 \u65e5\u6642\n            if ($addition_def[$field_id]['type']==3 OR $addition_def[$field_id]['type']==4\n                     OR $addition_def[$field_id]['type']==22 OR $addition_def[$field_id]['type']==23){//\u65e5\u4ed8\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime($value);\n                    \n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime($addition_def[$field_id]['range_start']);\n                        $w_end=strtotime($addition_def[$field_id]['range_end']);\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    \n                    if ($w==\"\"){\n                        $w_chk=false;\n                    }else{\n                        $w_year=date('Y', $w);\n                        $w_month=date('m', $w);\n                        $w_day=date('d', $w);\n                        $w_chk=checkdate($w_month, $w_day, $w_year);\n                    }\n                    if ($w_chk==false) {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_date'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_date=date(\"Y-m-d\",$w);\n                        if ($addition_def[$field_id]['type']==3){\n                            $w_time=\"\";\n                        }else{\n                            $w_time=date(\"H:i\",$w).\"::00\";\n                        }\n                        $fldary[$field_id]=COM_convertDate2Timestamp($w_date,$w_time);\n                    }\n                }\n            }\n            //\u6642\u523b\n            if ($addition_def[$field_id]['type']==26){\n                if ($value ===\"\"){\n                }else{\n                    $w=strtotime(\"1970-1-1 \".$value);\n                    if  ($addition_def[$field_id]['range_start']==\"\" \n                         AND $addition_def[$field_id]['range_end']==\"\" ){\n                    }else{\n                        $w_start=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_start'].\":00\");\n                        $w_end=strtotime(\"1970-1-1 \".$addition_def[$field_id]['range_end'].\":00\");\n                        if  ($w <$w_start OR $w >$w_end){\n                                 $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                  .\"(\".$addition_def[$field_id]['range_start'] \n                                  .\"-\".$addition_def[$field_id]['range_end'].\")\" ;\n                                 $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                    if ($w==\"\") {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_time'] ;\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }else{\n                        $w_time=date(\"H:i\",$w).\"::00\";\n                        $fldary[$field_id]=COM_convertDate2Timestamp(\"1970-1-1\",$w_time);\n                    }\n                }\n            }\n            //\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n            if ($addition_def[$field_id]['type']==5){\n                if ($value ===\"\"){\n                }else{\n                    if (COM_isEmail ($value)==false) {\n                        $rt.=$addition_def[$field_id]['name'].$LANG04[18];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //url\n            if ($addition_def[$field_id]['type']==6){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (preg_match('/^(https?|ftp)(:\\/\\/[-_.!~*\\'()a-zA-Z0-9;\\/?:\\@&=+\\$,%#]+)$/', $value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_url'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //numeric\n            if ($addition_def[$field_id]['type']==15 OR $addition_def[$field_id]['type']==21){\n                if ($value ===\"\"){\n                }else{\n                    \n                    if (is_numeric($value)) {\n                    } else {\n                        $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_numeric'];\n                        $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n           //text field\n            if (($addition_def[$field_id]['type']==0)\n                    OR ($addition_def[$field_id]['type']==1)\n                    OR ($addition_def[$field_id]['type']==10) ){\n                if ($value ===\"\"){\n                }else{\n                    if  ($addition_def[$field_id]['textcheck']==11){ //'\u534a\u89d2\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text1'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==12){//\u534a\u89d2\u82f1\u6570\u5b57\u306e\u307f';\n                        if  (!preg_match(\"/^[a-zA-Z0-9]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text2'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }else if ($addition_def[$field_id]['textcheck']==13){//\u6a19\u6e96ID\u306e\u7bc4\u56f2\u5185';\n                        $value=rtrim(ltrim($value));\n                        $newvalue=COM_sanitizeID($value);\n                        if  ($value<>$newvalue){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text3'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                        $fldary[$field_id]=$value;\n                    }else if ($addition_def[$field_id]['textcheck']==14){//\u534a\u89d2\u82f1\u6570\u5b57\u8a18\u53f7\u306e\u307f';\n                        if  (!preg_match(\"/^[!-~]+$/\", $value)){\n                            $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_text4'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                        }\n                    }\n                }\n            }\n            \n            \n            //textarea\n            if ($addition_def[$field_id]['type']==1 \n                    OR $addition_def[$field_id]['type']==10\n                    OR $addition_def[$field_id]['type']==20\n                    ){\n                if ($value ===\"\"){\n                }else{\n                    if (mb_strlen($value, 'UTF-8')>$addition_def[$field_id]['maxlength']) {\n                        $rt.=$addition_def[$field_id]['name']\n                            .$addition_def[$field_id]['maxlength']\n                            .\": \".$lang_box_admin['err_maxlength'];\n                            $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                 $file_path=$box_conf['file_path'];\n                 if  ( $box_conf['file_subdir']==1){\n                    $file_path.=$addition_def[$field_id]['templatesetvar'];\n                 }\n                 if (!is_writable ( $file_path )){\n                    $rt.=$file_path.\": \".$lang_box_admin['err_writable'];\n                    $rt.=\"<br \".XHTML.\">\".LB;\n                 }\n                 if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                 }else{\n                    if (is_array($fldary_fnm)){\n                        $filename=$_FILES['afield_fnm']['name'][$field_id];\n                        $filetmpname=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $filesize=$_FILES['afield_fnm']['size'][$field_id];\n                        $filetype=$_FILES['afield_fnm']['type'][$field_id];\n\n                        if  ($filetmpname<>\"\"){\n\t\t\t\t\t\t\t$err=\"\";\n                            if ($box_conf['file_size']<>\"\" AND $filesize>$box_conf['file_size']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_size'];\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                                $err=1;\n                            }\n\t\t\t\t\t\t\tif (count($box_conf['file_type'])>0){\n                                if  (in_array($filetype,$box_conf['file_type'])){\n                                }else{\n                                    $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_type']\n                                        .$_FILES['afield_fnm']['name'][$field_id].\"(\".$filetype.\")\";\n                                    $rt.=\"<br \".XHTML.\">\".LB;\n                                    $err=1;\n                                }\n                            }\n                            //\u30c1\u30a7\u30c3\u30afOK\n                            if  ($err===\"\"){\n                                $fldary[$field_id]=$filename;\n                            }\n                        }\n                    }else{\n                        \n                    }\n                 }\n            }\n\n            //range check \u7bc4\u56f2\u30c1\u30a7\u30c3\u30af\n            if  ($addition_def[$field_id]['range_start']==\"\" AND $addition_def[$field_id]['range_end']==\"\" ){\n            }else{\n                if (($addition_def[$field_id]['type']==0)\n                     OR ($addition_def[$field_id]['type']==1)\n                     OR ($addition_def[$field_id]['type']==15) \n                     OR ($addition_def[$field_id]['type']==21) ){\n                    if  ($value <$addition_def[$field_id]['range_start'] \n                        OR $value >$addition_def[$field_id]['range_end']){\n                                $rt.=$addition_def[$field_id]['name'].\": \".$lang_box_admin['err_range']\n                                .\"(\".$addition_def[$field_id]['range_start'] \n                                .\"-\".$addition_def[$field_id]['range_end'].\")\";\n                                $rt.=\"<br \".XHTML.\">\".LB;\n                    }\n                }\n                \n            }\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_uploadaddtiondatas(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                        }\n\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];//@@@@@@@!!!!\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                            //$fldary_fnm[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\t\t\t\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    \n                    if ($imgname<>\"\"){\n                        if  ($filename_old<>\"\"){\n                            $rt=DATABOX_deleteFile($imgfld.$filename_old);\n                        }\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);//\u62e1\u5f35\u5b50\u3092\u5c0f\u6587\u5b57\u306b\u3059\u308b\n                        if  ( $box_conf['file_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }\n                }\n            }\n\n\t\t}\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_uploadaddtiondatas_cpy(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n    ,$fldary_fnm=\"\"\n    ,$fldary_del=\"\"\n    ,$fldary_old=\"\"\n    ,$fldary_alt=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeupload  for copy\n// | \u66f8\u5f0f DATABOX_uploadaddtiondatas($additionfields,$addition_def,$pi_name\n// |                                 ,$additionfields_fnm,$additionfields_del)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $fldary:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\n// | \u5f15\u6570 $addition_def:\u8ffd\u52a0\u9805\u76ee\u5b9a\u7fa9\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// +-----\n// | \u5f15\u6570 $fldary_fnm:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u540d\n// | \u5f15\u6570 $fldary_del:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u30d5\u30a1\u30a4\u30eb\u524a\u9664\n// | \u5f15\u6570 $fldary_old:\u8ffd\u52a0\u9805\u76ee\u30c7\u30fc\u30bf\u914d\u5217\u3000OLD\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                //$filename=$fldary[$field_id];\n                //$filename_old=$fldary_old[$field_id];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];//\u30d5\u30a1\u30a4\u30eb\u540d\n                \n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        //$newfilename=$imgname;\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                            //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                            if($box_conf['imgfile_thumb_ok'] && function_exists('ImageCreate')) {\n                                $rt=DATABOX_createthumb(\n                                    $newfilename\n                                    ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                    ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                    ,$imgfld_thmb,$imgfld);\n                            }\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['imgfile_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $thumbname=DATABOX_getthumbname($filename_old);\n                            $cpyfrom =$imgfld_thmb.$thumbname;\n                            $thumbname=DATABOX_getthumbname($newfilename);\n                            $cpyto =$imgfld_thmb.$thumbname;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$fldary_alt[$field_id];\n                        }\n                    }\n                }\n\t\t\t}\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $filename=$fldary[$field_id];\n                $a=explode(\"|\",$fldary_old[$field_id]);\n                $filename_old=$a[0];\n                $imgname_old=$a[1];\n                if (is_array($fldary_del) AND $fldary_del[$field_id]){\n                    $fldary[$field_id]=\"\";\n                }else{\n                    $imgname=$_FILES['afield_fnm']['name'][$field_id];\n                    if ($imgname<>\"\"){\n                        $imgfile=$_FILES['afield_fnm']['tmp_name'][$field_id];\n                        $imgsize=$_FILES['afield_fnm']['size'][$field_id];\n                        $imgtype=$_FILES['afield_fnm']['type'][$field_id];\n                        $a=explode(\".\",$imgname);\n                        $a[1]=strtolower($a[1]);\n                        if  ( $box_conf['imgfile_subdir']==1){\n                            $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                        }else{\n                            $newfilename=\"\";\n                        }\n                        $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                        if (DATABOX_uploadImageFile\n                                ($imgname,$imgfile,$imgsize, $imgtype,$imgfld,$newfilename)){\n                            $fldary[$field_id]=$newfilename;\n                        }else{\n                            $fldary[$field_id]=\"\";\n                        }\n                    }else{\n                        if  ($filename_old<>\"\"){\n                            $cpyfrom=$imgfld.$filename_old;\n                            $a=explode(\".\",$filename_old);\n                            $a[1]=strtolower($a[1]);\n                            if  ( $box_conf['file_subdir']==1){\n                                $newfilename=$addition_def[$field_id]['templatesetvar'].\"/\";\n                            }else{\n                                $newfilename=\"\";\n                            }\n                            $newfilename.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".\".$a[1];\n                            $cpyto=$imgfld.$newfilename;\n                            $rt=copy( $cpyfrom, $cpyto );\n                            //\n                            $fldary[$field_id]=$newfilename.\"|\".$imgname_old;\n                        }\n                    }\n                }\n            }\n\n        }\n    }\n\n    return $rt;\n\n}\n\n//update\nfunction DATABOX_uploadaddtiondatas_xml(\n    &$fldary\n    ,$addition_def\n    ,$pi_name\n    ,$id\n)\n{\n    global $_CONF;\n    global $LANG04;\n    global $_FILES;\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            if ($fldary[$field_id]<>\"\"){\n                \n                //\u56f3 \u5916\u8a18\u61b6\n                if ($addition_def[$field_id]['type']==12){//\u56f3\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    //\n                    if  ($box_conf['imgfile_subdir']==1){\n                        $imgname=$addition_def[$field_id]['templatesetvar'].\"/\";\n                    }\n                    $imgname.=$addition_def[$field_id]['templatesetvar'].\"_\".$id.\"_\".time().\".jpg\";\n                    $imgsrc=$fldary[$field_id];\n                    if (DATABOX_uploadImageFile_xml($imgname,$imgsrc,$imgfld)){\n                        $fldary[$field_id]=$imgname;\n                        //\u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\u3059\u308b\u5834\u5408\n                        if($box_conf['imgfile_thumb_ok']===\"1\" && function_exists('ImageCreate')) {\n                            $srcfile=$imgfld.$imgname;\n                            $rt=DATABOX_createthumb(\n                                $imgname\n                                ,$box_conf['imgfile_thumb_w'] ,$box_conf['imgfile_thumb_h'] \n                                ,$box_conf['imgfile_thumb_w2'] ,$box_conf['imgfile_thumb_h2'] \n                                ,$imgfld_thmb,$imgfld);\n                        }\n                    }else{\n                        $fldary[$field_id]=\"\";\n                    }\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_deleteaddtionfiles(\n    $fldary\n    ,$addition_def\n    ,$pi_name\n){\n    global $_CONF;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if (is_array($fldary)){\n        foreach( $fldary as $field_id => $value ){\n            \n            //\u56f3 \u5916\u8a18\u61b6\n            if ($addition_def[$field_id]['type']==12){//\u56f3\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n                    $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                    $thumbname=DATABOX_getthumbname($filename);\n                    $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n                }\n            }\n            //\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n            if ($addition_def[$field_id]['type']==13){\n                $imgfld=$box_conf['file_path'];\n                $a=explode(\"|\",$fldary[$field_id]);\n                $filename=$a[0];\n                if ($filename<>\"\"){\n                    $rt=DATABOX_deleteFile($imgfld.$filename);\n                }\n            }\n        }\n    }\n\n    return $rt;\n\n}\n//\nfunction DATABOX_deleteaddtionfiles_def(\n    $field_id\n    ,$pi_name\n){\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n    \n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    //\n    $sql=\"SELECT value  \";\n    $sql.=\" FROM\";\n    $sql.=\" {$table_addition} \";\n    $sql.=\" where\";\n    $sql.=\" field_id=\".$field_id;\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n    for ($i = 1; $i <= $numrows; $i++) {\n        $A = DB_fetchArray ($result);\n        $filename = COM_stripslashes($A['value']);\n        if ($filename<>\"\"){\n            $imgfld=$_CONF['path_html'].$box_conf['imgfile_frd'];\n            $imgfld_thmb=$_CONF['path_html'].$box_conf['imgfile_thumb_frd'];\n            $rt=DATABOX_deleteFile($imgfld.$filename);\n            $thumbname=DATABOX_getthumbname($filename);\n            $rt=DATABOX_deleteFile($imgfld_thmb.$thumbname);\n        }\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_deleteaddtionfiles_all(\n    $fld\n    ,$pi_name\n){\n    \n    \n    \n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $rt=\"\";\n\n    if( is_dir( $fld)){\n        $fd = opendir( $fld );\n        while(( $file = @readdir( $fd )) == TRUE )    {\n            if( !is_dir( $fd1 . $file)\n                    && $dir <> '.'\n                    && $dir <> '..'\n                    && $dir <> 'CVS'\n                    && substr( $dir, 0 , 1 ) <> '.' ) {\n                clearstatcache();\n                $rt=DATABOX_deleteFile($fld.$file);\n            }\n        }\n    }\n\n    return $rt;\n\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76eeuploadfile delete\n// | \u66f8\u5f0f DATABOX_checkdditiondatas($filename)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filename:\u30d5\u30a9\u30eb\u30c0/\u30d5\u30a1\u30a4\u30eb\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\nfunction DATABOX_deleteFile (\n    $filename\n)\n{\n    $rt=false;\n    if (file_exists ($filename)) {\n        if (!@unlink ($filename)) {\n            COM_errorLog (\"Unable to remove file $filename\");\n        }else{\n            $rt=true;\n            COM_errorLog (\"remove file $filename\");\n        }        \n    }else{\n            COM_errorLog (\"Unable to remove file $filename not exist\");\n    }\n    return $rt;\n}\n\nfunction DATABOX_uploadImageFile (\n     $imgname\n    ,$imgfile\n    ,$imgsize\n    ,$imgtype\n    ,$imgfld\n    ,$newfilename\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  upload Image File\n// | \u66f8\u5f0f DATABOX_uploadImageFile($imgname,$imgfile,$imgsize, $imgtype,$imgfld)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    $FilePermissions = (int) 0755;\n\n    if (is_uploaded_file ($imgfile)) {\n        //$newfile=$imgfld.$imgname;\n        $newfile=$imgfld.$newfilename;\n        if(!file_exists($newfile)) {\n            $returnMove = move_uploaded_file($imgfile, $newfile); \n            if (!$returnMove) {\n                $logmsg=\"DataBox File upload error: \".$tmp.\" to \".$name;\n                COM_errorLOG($logmsg);\n                return false;\n             } else {\n                $chown =@chmod ($newfile,$FilePermissions);\n                $logmsg=\"DataBox File upload sucsess: \".$imgname;\n                COM_errorLOG($logmsg);\n                return true;\n             }\n         }else{\n            COM_errorLOG(\"DataBox upload error: Temporary file does not exist: '\".$tmp .\"'\");\n            return false;\n         }\n    }\n}\n//\nfunction DATABOX_uploadImageFile_xml (\n    $imgname\n    ,$imgsrc\n    ,$imgfld\n)\n{\n    $FilePermissions = (int) 0755;\n\n    $newfile=$imgfld.$imgname;\n    //\n    $fp = fopen($newfile, \"w\");\n    $imgsrc=base64_decode($imgsrc);\n    fputs($fp, $imgsrc);\n    fclose($fp);\n    \n    if(!file_exists($newfile)) {\n        $logmsg=\"DataBox ImageFile upload error: \".$tmp.\" to \".$name;\n        COM_errorLOG($logmsg);\n        return false;\n    } else {\n        $chown =@chmod ($newfile,$FilePermissions);\n        $logmsg=\"DataBox ImageFile upload sucsess: \".$imgname;\n        COM_errorLOG($logmsg);\n        return true;\n    }\n}\n\nfunction DATABOX_createthumb(\n    $filename\n    , $W\n    , $H\n    , $W2\n    , $H2\n    , $imgfld_thmb\n    , $imgfld\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd uploadfile \u30b5\u30e0\u30cd\u30a4\u30eb\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_createthumb($srcfile,$W,$H,$W2,$H2, $thumb_dir,$tmp_dir)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $imgname:\n// | \u5f15\u6570 $imgfile:\n// | \u5f15\u6570 $imgsize:\n// | \u5f15\u6570 $imgtype:\n// | \u5f15\u6570 $imgfld:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:  \n// +---------------------------------------------------------------------------+\n//update\n{\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $srcfile=$imgfld.$filename;\n    // \u753b\u50cf\u306e\u5e45\u3068\u9ad8\u3055\u3068\u30bf\u30a4\u30d7\u3092\u53d6\u5f97\n    $imagesize = GetImageSize($srcfile);\n    $srcfile_w=$imagesize['0'];\n    $srcfile_h=$imagesize['1'];\n    $srcfile_type=$imagesize['2'];\n    //\u5bfe\u8c61\u30bf\u30a4\u30d7\u306e\u78ba\u8a8d\n    switch ($srcfile_type) {\n        case 1 : //gif\n             return false;\n             break;\n        case 2 : //jpg\n             $srcimage = @ImageCreateFromJPEG($srcfile);\n             break;\n        case 3 : //png\n             $srcimage = @ImageCreateFromPNG($srcfile);\n             break;\n    }\n    if (!$srcimage) {\n        return false;\n    }\n    \n    $logmsg=\"size=(w)\".$srcfile_w.\" > \".$w.\" (h)\".$srcfile_h.\" > \".$h;\n    COM_errorLog ($logmsg);\n\n    //\u5bfe\u8c61\u30b5\u30a4\u30ba\u306e\u78ba\u8a8d\n    if ($srcfile_w > $w || $srcfile_h > $h) {\n    }else{\n        return false;\n    }\n        \n    // \u30ea\u30b5\u30a4\u30ba\n    if ($srcfile_w > $W || $srcfile_h > $H) {\n        $key_w = $W / $srcfile_w;\n        $key_h = $H / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n    } else {\n        $out_w = $srcfile_w;\n        $out_h = $srcfile_h;\n    }\n\n    // \u51fa\u529b\u753b\u50cf\uff08\u30b5\u30e0\u30cd\u30a4\u30eb\uff09\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    $outimage = ImageCreateTrueColor($out_w, $out_h);\n    $resize = ImageCopyResampled(\n            $outimage, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n    // \u30b5\u30e0\u30cd\u30a4\u30eb\u753b\u50cf\u3092\u30d6\u30e9\u30a6\u30b6\u306b\u51fa\u529b\u3001\u4fdd\u5b58\n    //$filename = substr($srcfile, strrpos($srcfile,\"/\")+1);\n    $thum_filename = DATABOX_getthumbname($filename);\n       $filename = substr($filename, 0, strrpos($filename,\".\"));\n    touch($imgfld_thmb.$thum_filename);\n    ImageJPEG($outimage, $imgfld_thmb.$thum_filename);\n        \n    // \u51fa\u529b\u753b\u50cf\u306e\u30a4\u30e1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u3001\u5143\u753b\u50cf\u3092\u30b3\u30d4\u30fc\u3057\u307e\u3059\u3002(GD2.0\u7528)\n    // \u30ea\u30f3\u30af\u5148\u306e\u30b5\u30a4\u30ba\u304c\u8a2d\u5b9a\u5024\u3088\u308a\u5927\u304d\u3044\u6642\u30ea\u30f3\u30af\u5148\u3082\u7e2e\u5c0f\u3059\u308b<-----\n    if ($srcfile_w > $W2 || $srcfile_h > $H2) {\n        $rt = rename($imgfld.$filename.\".jpg\",$imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"rename err!\";\n        }\n\n        $key_w = $W2 / $srcfile_w;\n        $key_h = $H2 / $srcfile_h;\n        ($key_w < $key_h) ? $keys = $key_w : $keys = $key_h;\n        $out_w = $srcfile_w * $keys;\n        $out_h = $srcfile_h * $keys;\n        $outimage2 = ImageCreateTrueColor($out_w, $out_h);\n        $resize = ImageCopyResampled(\n            $outimage2, $srcimage, 0, 0, 0, 0\n            , $out_w, $out_h, $srcfile_w, $srcfile_h);\n\n        touch($imgfld.$filename.\".jpg\");\n        ImageJPEG($outimage2, $imgfld.$filename.\".jpg\"); \n\n        ImageDestroy($outimage2);\n        $rt=unlink($imgfld.$filename.\"-bak.jpg\");\n        if (!$rt) {\n            echo \"delete err!\";\n        }\n\n   }\n    \n    // \u4f5c\u6210\u3057\u305f\u30a4\u30e1\u30fc\u30b8\u3092\u7834\u68c4\n    ImageDestroy($srcimage);\n    ImageDestroy($outimage);\n\n    return $thum_filename;\n\n}\n//\nfunction DATABOX_getthumbname(\n    $filename\n)\n{\n    $rt=\"\";\n    if ($filename<>\"\"){\n        $filename = substr($filename, 0, strrpos($filename,\".\"));\n        $rt = $filename . \"-small.jpg\";\n    }\n    return $rt;\n}\n//==============================================================================\n\nfunction DATABOX_getradiolist(\n    $ary\n    ,$fld\n    ,$selected = 0\n    ,$br=\"\"\n    ,$disabled=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30e9\u30b8\u30f2\u30dc\u30bf\u30f3\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getradiolist\n// |                ($lang_noyes,\"afield[\".$fid.\"]\",$fvalue,$br ,$disabled);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\u5024\u914d\u5217\n// | \u5f15\u6570 $fld:field name\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $br:blank 0 \u6539\u884c\u3057\u306a\u3044 1\u301c9 \u6307\u5b9a\u6570\u6bce\u306b\u6539\u884c\n// | \u5f15\u6570 $disabled:\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30e9\u30b8\u30f2\u30dc\u30bf\u30f3                                                   |\n// +---------------------------------------------------------------------------+\n//update 20130704\n{\n    \n    $retval = '';\n    if  ($br===\"\" ) {\n        $br=0;\n    }\n    $cnt=0;\n    foreach( $ary as $id => $value ){\n\n        //echo \"ary\".$i.\"=\".$ary[$i].\"<br>\";\n        $retval .= \"<input type='radio' NAME='$fld' $disabled VALUE='$id'\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( $id == $selected ){\n                $retval .= \" CHECKED=CHECKED \";\n            }\n        }\n        $retval .= \">$ary[$id]&nbsp\";\n        \n        if   ($br<>0){\n            $cnt++;\n            if  ($cnt==$br){\n                $retval .=\"<br\".XHTML.\">\";\n                $cnt=0;\n            }\n        }\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_getoptionlistary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getoptionlistary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\n    if  ($type==14 OR $type==18){\n        //$selectedary=array[];\n        $selectedary=explode(\":\",$selected);\n    }\n    if  ($size==\"\" OR $size==0){\n        $size=1;\n    }\n    $retval = '';\n\n    $retval .= \"<select \";\n    if ($type==14 OR $type==18){\n        $retval .= ' name=\"'.$fld.'[]\" ';\n        $retval .= ' multiple=\"multiple\" ';\n        $retval .= ' size=\"'.$size.'\"';\n    }else{\n        $retval .= ' name=\"'.$fld.'\"';\n    }\n    $retval .= $disabled.\">\".LB;\n    \n\tif  ($type==7 ){\n\t\tif  ($ary[0]==\"\"){\n        }else{\n            $retval .= \"<option value=''>{$lang_box['selectit']}</option>\".LB;\n        }\n\t}\n    \n    foreach($ary as $k => $v) {\n        $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n\t\t//echo \"k=\".$k.\"sa=\".$selectedary.\"s=\".$selected.\"<br>\";\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if  ($type==14 OR $type==18){\n                if( in_array($k,$selectedary) ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t    }else{\n                if( $k == $selected ){//@@@@@\n                    $retval .= \" selected=\\\"selected\\\" \";\n                }\n\t\t\t}\n\t\t}\n\t\t$retval .= \">\";\n\n        $retval .= $v;\n        $retval .= \"</option>\".LB;\n\n    }\n\n    $retval .= '</select>';\n    \n    return $retval;\n}\n\n\n\nfunction DATABOX_getoptionlist(\n    $kind\n    ,$selected = 0\n    ,$relno=0\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$selectit=true\n    ,$selectlist=\"\"\n    ,$fname=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\u4f5c\u6210\n// | \u66f8\u5f0f DATABOX_getoptionlist($kind)\n// |      DATABOX_getoptionlist(\"fieldset\",$fieldset_id,0,$pi_name,\"\",0 );\n// |      DATABOX_getoptionlist(\"group\",$categorygroup_id,0,$pi_name,\"\",0 );\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $kind:\u9805\u76ee\u7a2e\u985e\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\n// | \u5f15\u6570 $relno\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled\n// | \u5f15\u6570 $selectit\n// | \u5f15\u6570 $selectlist\u3000\u65e2\u5b9a\u30ea\u30b9\u30c8\u306e\u6642\u65e2\u5b9a\u30ea\u30b9\u30c8\u540d\n// | \u5f15\u6570 $fname \u30d5\u30a3\u30fc\u30eb\u30c9\u540d\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n//update 20101122,20110613,20120525,20140724\n{\nglobal $_CONF;\nglobal $_TABLES;\nglobal $LANG_configselects;\n    \n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    \n    if ($fname==\"\"){\n        $fname=$kind;\n    }\n    \n    \n    $retval = '';\n\n    $retval .= \"<select name='$fname' $disabled>\".LB;\n    if ($selectit===\"all\"){\n        $retval .= \"<option value=\\\"all\\\">{$lang_box['selectall']}</option>\".LB;\n    }elseif ($selectit){\n        $retval .= \"<option value=0>{$lang_box['selectit']}</option>\".LB;\n    }\n    \n    \n    if ($kind==\"layout\"){\n        $retval .= \"<option value=0>{$lang_box['byconfig']}</option>\".LB;\n        $ary=$LANG_configselects[strtolower($pi_name)][22];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$v.\"\\\"\";\n            if( $v == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $k;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else if ($kind==\"language_id\"){\n        $retval .= \"<option value=0> </option>\".LB;\n        $ary=$_CONF['languages'];\n        foreach($ary as $k => $v) {\n            $retval .= \"<option value=\\\"\".$k.\"\\\"\";\n            if( $k == $selected ){//@@@@@\n                $retval .= \" selected=\\\"selected\\\" \";\n            }\n            $retval .= \">\";\n\n            $retval .= $v;\n            $retval .= \"</option>\".LB;\n            next($ary);\n        }\n    }else{\n        if ($kind==\"group\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_group'];\n            $fields= 'group_id,name,orderno';\n        }else if ($kind==\"parent\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_category'];\n            $fields= 'category_id,name,orderno';\n        }else if ($kind==\"fieldset\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_fieldset'];\n            $fields= 'fieldset_id,name,fieldset_id';\n        }else if ($kind==\"selectlist\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT kind,kind,kind';\n        }else if ($kind==\"selectlist_mst\"){\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$selectlist}'\";\n            if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }else if ($kind==\"fieldgroupno\"){\n            $where=\"kind='fieldgroup'\";\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $fields= 'DISTINCT no,value,no';\n        }else if ($kind==\"csvsel\"){\n            $where=\"\";\n            $table=$_TABLES[strtoupper($pi_name).'_def_csv_sel'];\n            $fields= 'csv_sel_id,name,csv_sel_id*-1';\n        }else{\n            $table=$_TABLES[strtoupper($pi_name).'_mst'];\n            $where=\"kind='{$kind}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n            $fields= 'no,value,orderno';\n        }\n        $retval .= COM_optionList (\n            $table\n            , $fields\n            , $selected,2,$where);\n    }\n    \n    \n    $retval .= '</select>';\n\n    if ($disabled===\"disabled\"){\n        $retval .= \"  <input type='hidden' name='{$fname}' value='{$selected}'>\";\n    }\n\n    return $retval;\n}\n\n\nfunction DATABOX_dltbldt(\n    $filenm\n    ,$fld\n    ,$tbl\n    ,$where=\"\"\n    ,$order=\"\"\n    ,$pi_name=\"\"\n    ,$addition=false\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c6\u30fc\u30d6\u30eb\u306e\u30c7\u30fc\u30bf\u3092CSV\u5f62\u5f0f\u3067\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3059\u308b\n// | \u66f8\u5f0f DATABOX_dltbldt($filenm,$fld,$tbl,$where,$order,$type,$pi_name,false);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $filenm :\n// | \u5f15\u6570 $fld :\n// | \u5f15\u6570 $tbl :\n// | \u5f15\u6570 $where :\n// | \u5f15\u6570 $order :\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $addition:false=\u8ffd\u52a0\u9805\u76ee\u306a\u3057\u3001 true=\u8ffd\u52a0\u9805\u76ee\u3042\u308a\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n//20100910\n//@@@@@ \u8ffd\u52a0\u4e88\u5b9a\u3000\u30ab\u30c6\u30b4\u30ea\u3082\n{\n    global $_CONF;\n\n    $dm=\",\";//\u533a\u5207\u308a\u6587\u5b57\n    $ec=\"`\";//\u30d5\u30a3\u30fc\u30eb\u30c9\u56f2\u307f\u6587\u5b57\n\n    if ($addition){\n        $addition_def=DATABOX_getadditiondef($pi_name);\n    }\n\n    $retval=\"\";\n\n    //file output open\n    $curdatetime = date(\"Y_m_d_H_i_s\");\n    //$outfile = tempnam($_CONF['path_data'] .\"tmp\", $filenm);\n    $outfile = $_CONF['path_data'] . $filenm.\"_\".$curdatetime;\n    $file = @fopen( $outfile, 'w' );\n    if ( $file === false ) {\n        $retval .= \"ERR! \".$outfile .\" is not writable!<br \".XHTML.\">\" . LB;\n        return $retval;\n    }\n\n    //-----\n    $sql = \"SELECT DISTINCT \";\n    foreach($fld as $k => $v) {\n        $sql .=$k.\",\";\n    }\n    $sql=rtrim($sql,\",\");\n    $sql.= \" FROM \".$tbl;\n    if (!empty($where)) {\n        $sql.=\" WHERE \".$where;\n    }\n    if (!empty($order)) {\n        $sql.=\" ORDER BY \".$order;\n    }\n    //-----\n    $result = DB_query ($sql);\n    //-----1\u884c\u76ee\u30d8\u30c3\u30c0\n    $w='';\n    foreach($fld as $k => $v) {\n        $w .=$ec.$k.$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$s[$k1]['templatesetvar'].$ec.$dm;\n            }\n        }\n    }\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n\n    //-----2\u884c\u76ee\u30d8\u30c3\u30c0\n    $w=\"\";\n    foreach($fld as $k => $v) {\n        $w .=$ec.$v['name'].$ec.$dm;\n    }\n    //addition field\n    if ($addition){\n        if ($addition_def<>\"\"){\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                $w .=$ec.$addition_def[$k1]['name'].$ec.$dm;\n            }\n        }\n    }\n\n    $w=rtrim($w,$dm);\n\n    $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n    fputs( $file, $w.LB);\n    //-----3\u884c\u76ee\u4ee5\u964d\n    while( $A = DB_fetchArray( $result ) )    {\n\n        $w=\"\";\n        foreach($fld as $k => $v) {\n            $w .=$ec.$A[$k].$ec.$dm;\n        }\n//\n        if ($addition){\n            $wkary=DATABOX_getaddtionfields($A[\"id\"],$addition_def,$pi_name);\n            $s=$addition_def;\n            foreach($s as $k1 =>$v1){\n                //echo \"k1=\".$k1.\"<br \".XHTML.\">\";\n\n\n                if (isset($wkary[$k1])) {\n                //echo \"wkary=\".$wkary[$k1].\"<br>\";\n                    $w .=$ec.$wkary[$k1].$ec.$dm;\n                }else{\n                //echo \"DD<br>\";\n                    $w .=$ec.$ec.$dm;\n                }\n            }\n        }\n        $w=rtrim($w,$dm);\n\n        $w = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),$w );\n        fputs( $file, $w.LB);\n\n    }\n    fclose($file);\n    \n    $filename=basename($outfile).\".csv\";\n    $dir=dirname($outfile);\n\n    header (\"Content-Disposition: attachment; filename=$filename\");\n    header (\"Content-type: application/x-csv\");\n    readfile ($outfile);\n    flush();\n    \n    $rt=unlink($outfile);\n    \n    return \"\";\n}\n\nfunction DATABOX_getfeaturedimage(\n    $id\n    ,$pi_name\n    ,$mode=\"imgsrc\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  featuredimage\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_getfeaturedimage($id,$pi_name)\n// | typw14(\u5916\u753b\u50cf)\u8868\u793a\u3059\u308b\u5148\u982d\uff08\u9806\u756a\u304c\u82e5\u3044\uff09\u8ffd\u52a0\u9805\u76ee\u3092featuredimage\u3068\u3057\u3066\u53d6\u5f97\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:featuredimage\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n\n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n\n    $tbl1=$_TABLES[strtoupper($pi_name).'_addition'];\n    $tbl2=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    $rt=\"\";\n\n    $sql = \"SELECT t1.value\";\n    $sql .= \" FROM \";\n    $sql .= \" {$tbl1} AS t1\";\n    $sql .= \"  ,{$tbl2} AS t2\";\n    $sql .= \"  WHERE t1.id=\".$id;\n    $sql .= \"  AND t1.field_id =t2.field_id\";\n    $sql .= \"  AND t2.type=12\";\n    $sql .= \"  AND allow_display=0\";\n    $sql .= \"  ORDER BY orderno\";\n\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n        $value=$A['value'];\n        if  ($value<>\"\"){\n            $url=$_CONF['site_url']   .\"/\".$box_conf['imgfile_frd'] ;\n            $url.= $value ;\n            if  ($mode==\"imgsrc\"){\n                $rt='<img src=\"'.$url.'\" />';\n            }else{\n                $rt=$url;\n            }\n        }\n    }\n\n    return $rt;\n}\n\nfunction DATABOX_getheadercode(\n    $kind\n    ,$template\n    ,$pi_name\n    ,$id\n    ,$title\n    ,$meta_description\n    ,$meta_keywords\n    ,$description\n    ,$additionfields=\"\"\n    ,$addition_def=\"\"\n    ,$chk_user=\"\"\n    ,$fieldset_id=\"\"\n    ,$fieldset_name=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd HEADERCODE \u7de8\u96c6\n// | \u66f8\u5f0f DATABOX_getheadercode(\"data\",$template,$pi_name,$A['id'],$A['title']\n// |         ,$A['meta_description'],$A['meta_keyword'],$A['description']);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570  $kind        \"data\",\"category\"\n// | \u5f15\u6570  $template\n// | \u5f15\u6570  $pi_name\n// | \u5f15\u6570  $id\n// | \u5f15\u6570  $title\n// | \u5f15\u6570  $meta_description\n// | \u5f15\u6570  $meta_keywords\n// | \u5f15\u6570  $description\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:HEADERCODE\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $_TABLES;\n    global $_IMAGE_TYPE;\n    \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n    \n    $retval=\"\";\n    \n    $currenturl= COM_getCurrentURL();\n    $site_logo= $_CONF['layout_url'] . '/images/logo.' . $_IMAGE_TYPE ;\n\n    $og_type=\"article\";\n    $og_title=$title;\n    \n    if ($box_conf['meta_tags'] > 0) {\n         $retval .= COM_createMetaTags($meta_description, $meta_keywords);\n    }\n\n    if ($_CONF['meta_tags']==0 OR $meta_description==\"\") {\n        $og_description = $description;\n    }else{\n        $og_description = $meta_description;\n    }\n    $og_description= COM_getTextContent(PLG_replaceTags($og_description));\n        \n    \n    if ($kind===\"data\"){\n        $og_image =DATABOX_getfeaturedimage($id,$pi_name,\"url\");\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }else{\n        $og_image =$box_conf[\"default_img_url\"];\n        if ($og_image===\"\"){\n            $og_image=$site_logo;\n        }\n    }\n    \n    //\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30d5\u30a9\u30eb\u30c0\u306e\u8a2d\u5b9a\n    $tmplfld=DATABOX_templatePath($kind,$template,$pi_name);\n    if (file_exists ($tmplfld.\"/headercode.thtml\")) {\n        $tpl = new Template($tmplfld);\n        $tpl->set_file (array (\n            'tpl' => 'headercode.thtml',\n            ));\n    \n        $tpl->set_var('xhtml', XHTML);\n        $tpl->set_var('site_url', $_CONF['site_url']);\n        $tpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n        $tpl->set_var('layout_url', $_CONF['layout_url']);\n        \n        $tpl->set_var ('currenturl', htmlspecialchars($currenturl, ENT_QUOTES, 'UTF-8'));\n        \n        $tpl->set_var ('site_name', $_CONF['site_name']);\n        $tpl->set_var ('site_mail', $_CONF['site_mail']);\n        \n        $tpl->set_var ('og_title', $og_title);\n        $tpl->set_var ('og_image', $og_image);\n        $tpl->set_var ('og_description', $og_description);\n        $tpl->set_var ('og_type', $og_type);\n        $tpl->set_var ('fieldset_name', $fieldset_name);\n        \n        //facebook\n        $facebook_consumer_key = trim($_CONF['facebook_consumer_key']);\n        $tpl->set_var ('facebook_consumer_key', $facebook_consumer_key);\n        \n        if ($kind===\"data\"){\n            DATABOX_getaddtionfieldsDisp($additionfields,$addition_def,$tpl,$chk_user,$pi_name,$fieldset_id);\n        }\n    \n        $tpl->parse ('output', 'tpl');\n        $retval .= $tpl->finish ($tpl->get_var ('output'));\n    }\n    return $retval;\n}\n\nfunction DATABOX_getfields(\n    $pi_name\n    , $fieldset_id\n)\n{\n    global $_TABLES;\n    \n    if ($fieldset_id==0){\n        $table=$_TABLES[strtoupper($pi_name).'_def_field'];\n    }else{\n        $table=$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    }\n    $fields = array();\n\n    // Get a list of additionfields in the selected field\n    $sql  = \"SELECT DISTINCT field_id \";\n    $sql  .= \" FROM {$table}\";\n    \n    if ($fieldset_id<>0){\n        $sql  .= \" WHERE  \";\n        $sql  .= \" fieldset_id = $fieldset_id\";\n    }\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    \n    if ($num<>0){\n        while ($A = DB_fetchArray($result)) {\n            $fields[] = $A['field_id'];\n        }\n    }\n    \n    return $fields;\n}\n\n\nfunction DATABOX_getAry(\n    $kind\n    ,$relno=0\n    ,$selectlist\n    ,$pi_name=\"\"\n)\n{\n    global $_TABLES;\n\n//    if ($kind==\"selectlist_mst\"){\n        $table=$_TABLES[strtoupper($pi_name).'_mst'];\n        $where=\" WHERE kind='{$selectlist}'\";\n        if ($relno<>0) $where.=\" AND relno='{$relno}'\";\n        $fields= 'no,value';\n        $order=\" ORDER BY orderno\"; \n//    }\n\n    $ary=array();\n    $sql = \"SELECT \";\n    $sql .= $fields ;\n    $sql .= \" FROM \" ;\n    $sql .= $table ;\n    $sql .= $where ;\n    $sql .= $order ;\n\n    $result = DB_query($sql);\n    $nrows = DB_numRows($result);\n    for( $i=0; $i < $nrows; $i++) {\n         $A = DB_fetchArray($result, true);\n         $ary[$A[0]] = $A[1];\n    }\n    return $ary;\n}\n\nfunction DATABOX_categorycount(\n    $pi_name\n    ,$categorygroup_id \n    ,$categorygroup_code \n    ,$permission=\"\"\n    ,$numberformat=''\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  databox_categorycount()\n// | \u66f8\u5f0f  databox_categorycount(1)\n// | \u66f8\u5f0f  databox_count(\"\",\"japan\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $group_id:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// | \u5f15\u6570 $group_code:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\n// | \u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id \u3082\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u30b3\u30fc\u30c9\u3082\u6307\u5b9a\u306a\u3044\u5834\u5408\u306f\n// | \u89aa\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7\u306a\u3057\u306e\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30ab\u30c6\u30b4\u30ea\u4ef6\u6570\n// | \uff08\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u3042\u308b\u30c7\u30fc\u30bf\u304c\u767b\u9332\u3055\u308c\u3066\u3044\u306a\u3044\u30ab\u30c6\u30b4\u30ea\u306e\u4ef6\u6570\u306f\u542b\u307f\u307e\u305b\u3093\uff09\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    //-----\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n    $tbl1=$_TABLES[strtoupper($pi_name).'_category'] ;\n    $tbl4=$_TABLES[strtoupper($pi_name).'_def_group'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_base'] ;\n    if ($categorygroup_id ==\"\" AND $categorygroup_code==\"\") {\n        $categorygroup_id=0;\n    }else{\n        if  ($categorygroup_id==\"\"){\n            $categorygroup_id=DATABOX_codetoid(    $categorygroup_code,strtoupper($pi_name).'_def_group',\"group_id\");\n            if  ($categorygroup_id==0){\n                return 0;\n            }\n        }\n    }\n    \n\n    //-----\n    $sql = \"SELECT \".LB;\n    $sql .= \" t1.category_id\".LB;\n    //$sql .= \" ,Count(t1.id) AS count\".LB;\n\n    $sql .= \" FROM \".LB;\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n    $sql .= \" ,{$tbl4} AS t4 \".LB;\n\n    $sql .= \" WHERE \".LB;\n    $sql .= \" t1.id = t2.id \".LB;\n    $sql .= \" AND t1.category_id = t3.category_id \".LB;\n    $sql .= \" AND t3.categorygroup_id = \".$categorygroup_id.LB;\n    $sql .= \" AND t3.categorygroup_id = t4.group_id \".LB;\n    //\u7ba1\u7406\u8005\u306e\u6642,\u4e0b\u66f8\u30c7\u30fc\u30bf\u3082\u542b\u3080\n    //if ( SEC_hasRights('databox.admin')) {\n    //}else{\n       $sql .= \" AND t2.draft_flag=0\".LB;\n    //}\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND',0,2,\"t2\").LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    \n    $sql .= \" GROUP BY \".LB;\n    $sql .= \" t1.category_id\".LB;\n    \n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_Confirmation(\n    $pi_name\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd \u78ba\u8a8d\u753b\u9762\n// | \u66f8\u5f0f Con_firmation(\"databox\")\n//   fnc_Confirmation proversion\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin\u540d\n// | \u5f15\u6570 $mode:\u30ab\u30c6\u30b4\u30ea\u30b0\u30eb\u30fc\u30d7id\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_CONF;\n    global $LANG_ADMIN;\n\n\n    $lang_box_admin=\"LANG_\".strtoupper($pi_name).\"_ADMIN\";\n    global $$lang_box_admin;\n    $lang_box_admin=$$lang_box_admin;\n\n    $tmpl = new Template ($_CONF['path'] . \"plugins/\".THIS_PLUGIN.\"/templates/admin/\");\n    $tmpl->set_file(array('confirm' => 'confirmation.thtml'));\n\n\n    $tmpl->set_var('site_admin_url', $_CONF['site_admin_url']);\n    $tmpl->set_var('gltoken_name', CSRF_TOKEN);\n    $tmpl->set_var('gltoken', SEC_createToken());\n    $tmpl->set_var ( 'xhtml', XHTML );\n\n    //\n    $actionname=$lang_box_admin[$mode];\n    $actionprg=\"{$_CONF['site_admin_url']}/plugins/\".THIS_SCRIPT.\"?mode={$mode}exec\";\n\n    $tmpl->set_var('actionname', $actionname);\n    $tmpl->set_var('actionprg', $actionprg);\n    \n    $tmpl->set_var('help', $lang_box_admin[$mode.'msg']);\n    $btn_value=$LANG_ADMIN['submit'];\n    $confirm_value=$lang_box_admin['confirm'];\n    $btn2=\"\";\n    $btn3=\"\";\n    if ($mode===\"datadelete\"){\n        $tmpl->set_var('lang_checklist', $lang_box_admin['fieldset'].\":\");\n        $checklist=DATABOX_getcheckList (\"fieldset\",\"\",$pi_name);\n        $tmpl->set_var('checklist', $checklist);\n        $btn_value=$lang_box_admin['delete1'];\n        $confirm_value=$lang_box_admin['delete1'].\" \".$lang_box_admin['confirm'];\n        $confirm_value2=$lang_box_admin['delete2'].\" \".$lang_box_admin['confirm'];\n        $confirm_value3=$lang_box_admin['delete3'].\" \".$lang_box_admin['confirm'];\n        $btn2=\"<input type='submit' name='action' value='{$lang_box_admin['delete2']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value2}');\\\"\".xhtml.\">\".LB;\n        $btn3=\"<input type='submit' name='action' value='{$lang_box_admin['delete3']}'\" \n             .\" onclick=\\\"return confirm('{$confirm_value3}');\\\"\".xhtml.\">\".LB;\n    }\n\n    // SAVE\u3001CANCEL \u30dc\u30bf\u30f3\n    $tmpl->set_var('lang_confirm', $confirm_value);\n    $tmpl->set_var('lang_submit', $btn_value);\n    $tmpl->set_var('btn2', $btn2);\n    $tmpl->set_var('btn3', $btn3);\n    $tmpl->set_var('lang_cancel', $LANG_ADMIN['cancel']);\n    $tmpl->set_var('mode', $mode.\"exec\");\n\n    $tmpl->parse ('output', 'confirm');\n    $comfirm = $tmpl->finish ($tmpl->get_var ('output'));\n\n    $retval = $comfirm;\n\n\n    return $retval;\n}\n\n//==============================================================================\n//lib_datetimeedit.php \u2192\nfunction DATABOX_datetimeedit(\n    $datetime_value\n    ,$lang\n    ,$datetime_name=\"datetime\"\n    ,$mode=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    if ($datetime_value==\"\"){\n        $datetime_year = date('Y');\n        $datetime_month = date('m');\n        $datetime_day = date('d');\n        //\n        $datetime_hour = date ('H');\n        $datetime_minute = date ('i') ;\n    }else{\n        $datetime_year = date('Y', $datetime_value);\n        $datetime_month = date('m', $datetime_value);\n        $datetime_day = date('d', $datetime_value);\n        //\n        $datetime_hour = date ('H', $datetime_value);\n        $datetime_minute = date ('i', $datetime_value) ;\n    }\n    \n    $rt=\"\";\n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_year);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_month);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_day);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($mode===\"datetime\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_hour, 24);\n        }else{\n            $datetime_hour_wk=$datetime_hour;\n            if ($datetime_hour_wk >= 12) {\n                if ($datetime_hour_wk > 12) {\n                    $datetime_hour_wk = $datetime_hour_wk - 12;\n                }\n                $ampm = 'pm';\n            } else {\n                $ampm = 'am';\n            }\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $ampm);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_hour_wk);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_minute);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n\nfunction DATABOX_datetimeedit_R(\n    $datetime_ary\n    ,$lang\n    ,$datetime_name=\"datetime\"\n) {\n    global $_CONF;\n\n    $var = $lang;\n    global $$var;\n    $lang_ary=$$var;\n    \n    if  (!is_array($datetime_ary)){\n        return \"\";\n    }\n    \n    $rt=\"\";\n    \n    //Year\n    $year_options = COM_getYearFormOptions ($datetime_ary['year']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_year\\\">\".LB;\n    $rt.=$year_options.LB;\n    $rt.=\"</select>\".$lang_ary['yy'].LB;\n\n    //month\n    $month_options = COM_getMonthFormOptions ($datetime_ary['month']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_month\\\">\".LB;\n    $rt.=$month_options.LB;\n    $rt.=\"</select>\".$lang_ary['mm'].LB;\n\n    //day\n    $day_options = COM_getDayFormOptions ($datetime_ary['day']);\n    $rt.=\"<select name=\\\"\".$datetime_name.\"_day\\\">\".LB;\n    $rt.=$day_options.LB;\n    $rt.=\"</select>\".$lang_ary['dd'].LB;\n\n    //hour\n    if ($datetime_ary['hour']<>\"\"){\n        if ($_CONF['hour_mode'] == 24) {\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour'], 24);\n        }else{\n            $ampm_select = COM_getAmPmFormSelection ($datetime_name.'_ampm', $datetime_ary['ampm']);\n            if (empty ($ampm_select)) {\n                $ampm_select = '<input type=\"hidden\" name=\"cmt_close_ampm\" value=\"\"' . XHTML . '>';\n            }\n            $rt.=$ampm_select;\n            $hour_options = COM_getHourFormOptions ($datetime_ary['hour']);\n        }\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_hour\\\">\".LB;\n        $rt.=$hour_options.LB;\n        $rt.=\"</select>:\".LB;\n\n        //minute\n        $minute_options = COM_getMinuteFormOptions ($datetime_ary['minute']);\n\n        $rt.=\"<select name=\\\"\".$datetime_name.\"_minute\\\">\".LB;\n        $rt.=$minute_options.LB;\n        $rt.=\"</select>\".LB;\n\n    }\n\n    return $rt;\n\n}\n//==============================================================================\n//lib_outlog.php \u2192\n//log \u51fa\u529b\u30e2\u30fc\u30c9\u8a2d\u5b9a\u30000:\u4f5c\u6210\u3057\u306a\u3044,1:\u30d5\u30a1\u30a4\u30eb\u306b\u51fa\u529b 2:\u753b\u9762\u306b\u3082\u51fa\u529b\n//$logmode =2;\n//$logfile = $_CONF['path_log'] . \"profile_point.log\";\n\n//echo OutLog( \"----- photomailcheck.php start\",$logmode);\n\n\n// \u30ed\u30b0\u51fa\u529b\u51e6\u7406\nfunction DATABOX_OutLog( $logentry ,$logfile,$logmode=1)\n{\n    global $_CONF,$LANG01;\n\n    $retval = '';\n\n    if (!empty($logmode)) {\n        if( !empty( $logentry )) {\n            $logentry = str_replace( array( '<?', '?>' ), array( '(@', '@)' ),\n                                     $logentry );\n\n            $timestamp = strftime( '%c' );\n\n            if (!file_exists($logfile)) {\n                echo $logfile .\"  doesn't exist. \";\n                exit();\n            }\n            if (!is_writable($logfile)) {\n                echo $logfile .\" cannot be written. \";\n                exit();\n            }\n\n            $file = fopen( $logfile, 'a' );\n\n            if( empty($file)) {\n                $retval .= $LANG01[33] . ' ' . $logfile . ' (' . $timestamp . ')<br/><br/>' . LB;\n            } else {\n                fputs( $file, \"$timestamp - $logentry\\n\" );\n            }\n\n            if ($logmode ==2){\n                $retval .=\"$timestamp - $logentry<br/>\" . LB;\n            }\n        }\n    }\n\n    return $retval;\n}\n//==============================================================================\n//lib_getfilelist.php \u2192\n// \u6307\u5b9a\u30d5\u30a9\u30eb\u30c0\u306e\u30d5\u30a1\u30a4\u30eb\u306e\u4e00\u89a7\u3092\u53d6\u5f97\nfunction DATABOX_getfilelist(\n    $fd\n    ,$exte =\"\"\n)\n{\n    $fary= array();\n    $dir=opendir($fd);\n    while(($ent = readdir()) !==FALSE){\n        if  ($exte==\"\") {\n           $fary[$i] = $ent;\n           $i++;\n        }else{\n            $w=explode('.',$ent);\n            if (strtolower($w[1])===$exte){\n               $fary[$i] = $ent;\n               $i++;\n            }\n        }\n    }\n    return $fary;\n\n}\nfunction DATABOX_getDateTimeFormat( $date,$format )\n{\n    if( empty( $date ))    {\n        $stamp = time();\n    } else if( is_numeric( $date )){\n        $stamp = $date;\n    }else{\n        $stamp = strtotime( $date );\n    }\n    $date = strftime( $format, $stamp );\n    return array( $date, $stamp );\n}\nfunction DATABOX_getTimeFormat( $value )\n{\n    $rt=\"\";\n    if  ($value==\"\"){\n        $rt=\"\";\n    }else{\n        if  ($_CONF['hour_mode']=='24'){\n            $rt=date('H:i', $value );\n        }else{\n            $rt=date('h:i', $value );\n            if  (date('H',$value)>=12){\n                $rt.=\" PM\";\n            }else{\n                $rt.=\" AM\";\n            }\n        }\n    }\n    return $rt;\n}\n\nfunction DATABOX_fieldvalue(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$option = \"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\u53d6\u5f97\n// | \u66f8\u5f0f DATABOX_fieldvalue($pi_name,$id,$code,$field_id,$field_code,$option)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $option:'','name','description','yes','value2','disp','no'\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u8ffd\u52a0\u9805\u76ee\u8868\u793a\u7528\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n    global $_PLUGINS;\n    \n    $lang_noyes=\"LANG_\".strtoupper($pi_name).\"_NOYES\";\n    global $$lang_noyes;\n    $lang_noyes=$$lang_noyes;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"\";\n    }\n    if (is_null($field_id)){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"\";\n        }\n    }\n          \n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.type \".LB;\n    $sql  .= \" ,m.name \".LB;\n    $sql  .= \" ,m.description \".LB;\n    $sql  .= \" ,m.selection \".LB;\n    $sql  .= \" ,m.selectlist \".LB;\n    $sql  .= \" ,m.dfid \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.allow_display = 0 \".LB;\n    \n    $result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n        if  ($option==\"name\"){\n            $rt=$A['name'];\n        }else if ($option==\"description\"){\n            $rt=$A['description'];\n        }else if ($option==\"datatitle\"){\n            if (in_array('databox', $_PLUGINS)) {\n                $rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"title\",\"code='{$A['value']}'\"));\n            }\n        }else if ($option==\"datadescription\"){\n            if (in_array('databox', $_PLUGINS)) {\n\t\t\t\t$rt=COM_applyFilter(DB_getItem( $_TABLES['DATABOX_base'] ,\"description\",\"code='{$A['value']}'\"));\n            }\n        }else{\n            $selectionary=DATABOX_getselectionary($A['selection']);\n            $selectlist=$A['selectlist'];\n            $type=$A['type'];\n            $value=$A['value'];\n            $dfid= $A['dfid'];\n            $format = DB_getItem($_TABLES['dateformats'], \"format\", \"dfid = $dfid\");\n            if( empty( $format )) {\n                $format = $_CONF['date'];\n            }\n            switch ($type) {\n                case 12://\u753b\u50cf\uff08\u5916\u8a18\u61b6\uff09\n                case 13://\u6dfb\u4ed8\u30d5\u30a1\u30a4\u30eb\n                    if  ($value===\"\"){\n                    }else{\n                        list($readfile,$rt)=explode(\"|\",$value);\n                    }\n                    break;\n                case 11://\u753b\u50cf\uff08DB\u8a18\u61b6)\n                    if  ($value===\"\"){\n                    }else{\n                        $rt=\"<img src=\\\"data:image/jpg;base64,\";\n                        $rt .=\"{$value}\\\"\".XHTML.\">\";\n                    }\n                    break;\n                case 2://\u3044\u3044\u3048/\u306f\u3044\n                    if  ($option==\"yes\"){\n                        if  ($value==1){\n                            $rt=1;\n                        }\n                    }else{\n                        $rt= $lang_noyes[$value];\n                    }\n                    break;\n                case 7://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                case 8://\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $rt= $selectionary[$value];\n                    break;\n                case 14://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u9078\u629e\u80a2\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $wk.=$selectionary[$wkary[$x]].$separater;\n                    }\n                    $rt= rtrim($wk,$separater);\n                    break;\n                case 10:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML NG)\n                    $w=DATABOX_nl2br($value);\n                    $w=DATABOX_autolink($w);\n                    $rt= $w;\n                    break;\n                case 9://\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                case 16: //\u30e9\u30b8\u30aa\u30dc\u30bf\u30f3\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $mstitems=DATABOX_getMstItems($selectlist,$value,$pi_name);\n                    $rt= $mstitems['value'];\n                    if  ($option==\"value2\"){\n                        $rt= $mstitems['value2'];\n                    }else if  ($option==\"disp\"){\n                        $rt= $mstitems['disp'];\n                    }else if  ($option==\"no\"){\n                        $rt= $mstitems['no'];\n                    }else{\n                        $rt= $mstitems['value'];\n                    }\n                    break;\n                case 18://\u30de\u30eb\u30c1\u30bb\u30ec\u30af\u30c8\u30ea\u30b9\u30c8\uff08\u30de\u30b9\u30bf\u30fc\uff09\n                    $wkary=explode(\":\",$value);\n                    $wk=\"\";\n                    $wk_value2=\"\";\n                    $wk_disp=\"\";\n                    $wk_no=\"\";\n                    for( $x = 0; $x < sizeof( $wkary ); $x++ ) {\n                        $mstitems=DATABOX_getMstItems($selectlist,$wkary[$x],$pi_name);\n                        $wk.=$mstitems['value'].$separater;\n                        $wk_value2.=$mstitems['value2'].$separater;\n                        $wk_disp.=$mstitems['disp'].$separater;\n                        $wk_no.=$mstitems['no'].$separater;\n                    }\n                    if  ($option==\"value2\"){\n                        $rt= rtrim($wk_value2,$separater);\n                    }else if  ($option==\"disp\"){\n                        $rt= rtrim($wk_disp,$separater);\n                    }else if  ($option==\"no\"){\n                        $rt= rtrim($wk_no,$separater);\n                    }else{\n                        $rt= rtrim($wk,$separater);\n                    }\n                    break;\n                case 4://\u65e5\u6642\n                    if  ($value<>\"\"){\n                        $w=DATABOX_getDateTimeFormat($value,$format);\n                        $rt= $w[0];\n                    }\n                    break;\n                case 3://\u65e5\u4ed8\n                    if  ($value<>\"\"){\n                        $rt=strftime( $_CONF['shortdate'], $value );\n                    }\n                    break;\n                case 21://money \u901a\u8ca8;\n                    $dc = $_CONF['decimal_count'];\n                    $ts = $_CONF['thousand_separator'];\n                    $ds = $_CONF['decimal_separator'];\n                    $rt= number_format( (float)$value, $dc, $ds, $ts );\n                    break;\n                case 5://\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\n                case 6://url';\n                case 0:// \u4e00\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9\n                case 1:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK)\n                case 20:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  TinyMCE)\n                case 19:// \u8907\u6570\u884c\u30c6\u30ad\u30b9\u30c8\u30d5\u30a3\u30fc\u30eb\u30c9(HTML OK  CKEditor)\n                default:\n                    $rt= $value;\n            }\n        }\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_fieldownload(\n    $pi_name\n    ,$id\n    ,$code\n    ,$field_id\n    ,$field_code\n    ,$mode\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30d5\u30a1\u30a4\u30eb\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9 \n// | \u66f8\u5f0f DATABOX_fieldownload($pi_name,$id,$code,$field_id,$field_code)\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $id:\n// | \u5f15\u6570 $code:\n// | \u5f15\u6570 $field_id:\n// | \u5f15\u6570 $field_code:\n// | \u5f15\u6570 $mode \u30ca\u30b7\u3001display\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n     \n    $box_conf=\"_\".strtoupper($pi_name).\"_CONF\";\n    global $$box_conf;\n    $box_conf=$$box_conf;\n          \n    $lang_box=\"LANG_\".strtoupper($pi_name);\n    global $$lang_box;\n    $lang_box=$$lang_box;\n    $separater=$lang_box['field_separater'];\n\n    $table_base=$_TABLES[strtoupper($pi_name).'_base'];\n    $table_def_field=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $table_addition=$_TABLES[strtoupper($pi_name).'_addition'];\n    $table_def_fieldset_assignments\n        =$_TABLES[strtoupper($pi_name).'_def_fieldset_assignments'];\n    //-----\u5f15\u6570\u30c1\u30a7\u30c3\u30af\n    if (is_null($id)  OR $id===\"\"){\n        if (is_null($code) OR $code===\"\"){\n            $id=0;\n        }else{\n            if ($pi_name==\"userbox\"){\n                $id=DATABOX_codetoid($code,'users',\"uid\",\"username\");\n            }else{\n                $id=DATABOX_codetoid($code,strtoupper($pi_name).'_base');\n            }\n        }\n\t}\n    if ($id===0) {\n        return \"download argument error id\";\n    }\n    if (is_null($field_id) OR $field_id===\"\"){\n        if (is_null($field_code) OR $field_code===\"\"){\n            $field_id=0;\n        }else{\n            $field_id=DATABOX_codetoid($field_code,strtoupper($pi_name).'_def_field'\n                     ,\"field_id\",\"templatesetvar\");\n        }\n    }\n    if ($field_id===0) {\n        return \"download Argument error field_id\";\n    }\n    $fieldset_id=DB_getItem( $table_base,\"fieldset_id\",\"id=\".$id  );\n    if  ($fieldset_id==0){\n    }else{\n        $w=DB_getItem( $table_def_fieldset_assignments\n             ,\"fieldset_id\",\"fieldset_id=$fieldset_id AND field_id=\".$field_id );\n        if  ($w==\"\"){\n            return \"download drgument error id field_id\";\n        }\n\t}\n    //\n    $sql  = \"SELECT DISTINCT \".LB;\n    $sql  .= \" t.value \".LB;\n    $sql  .= \" ,m.allow_display \".LB;\n    $sql  .= \" ,d.group_id \".LB;\n    $sql  .= \" ,d.owner_id \".LB;\n    $sql  .= \" FROM \".LB;\n    $sql  .= \"{$table_addition} AS t\".LB;\n    $sql  .= \" , {$table_def_field} AS m\".LB;\n    $sql  .= \" , {$table_base} AS d\".LB;\n    \n    $sql  .= \" WHERE  \".LB;\n    $sql  .= \" t.id = {$id} AND t.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.field_id = {$field_id} \".LB;\n    $sql  .= \" AND m.type = 13 \".LB;\n    $sql  .= \" AND d.id = {$id} \".LB;\n    //\u4e0b\u66f8\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND d.draft_flag=0\".LB;\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\";\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\";\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    $sql .= COM_getPermSql('AND');\n\t$result = DB_query ($sql);\n    $num = DB_numRows ($result);\n    $rt=\"Target file is not found\";\n    if ($num<>0){\n        $A = DB_fetchArray ($result);\n        $A = array_map('stripslashes', $A);\n\t\t$value=$A['value'];\n        $group_id = $A['group_id'];\n\t\t$owner_id = $A['owner_id'];\n\t\t$allow_display= $A['allow_display'];\n        $chk_user=DATABOX_chkuser($group_id,$owner_id,$pi_name.\".admin\");\n\t\tif  ($value<>\"\"){\n\t\t\t\n            $chk=false;\n            //\u8868\u793a\u3059\u308b\n            if  ($allow_display==='0') {\n                $chk=true;\n                //\u30ed\u30b0\u30a4\u30f3\u30e6\u30fc\u30b6\u306e\u307f\n            }else if ($allow_display==='1'){\n                if  ($chk_user>=1000) {\n                    $chk=true;\n                }\n            //\u30b0\u30eb\u30fc\u30d7\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\u8868\u793a\n            }else if ($allow_display==='2'){\n                if  ($chk_user>=1010) {\n                    $chk=true;\n                }\n            //\u6240\u6709\u8005\u3068admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='3'){\n                if  ($chk_user>=1011) {\n                    $chk=true;\n                }\n            //admin\u6a29\u306e\u3042\u308b\u4eba\u306e\u307f\n            }else if ($allow_display==='4'){\n                if  ($chk_user>=1100) {\n                    $chk=true;\n                }\n            }\n\t\t\tif ($chk) {\n\t\t\t\tlist($readfile,$filename)=explode(\"|\",$value);\n\t\t        list($dummy,$extention)=explode(\".\",$filename);\n\t\t        $filetype=DATABOX_getFileTypeAry($extention );\n\t\t        if  ($filetype<>\"\"){\n                    $path=$box_conf['file_path'];\n                    if  (file_exists($path.$readfile)){\n                        if  ($mode==\"display\"){\n                            if  ($extention==\"pdf\"){\n                                header('Content-Type: '.$filetype);\n                                header('Content-Disposition: inline; filename=\"'.$filename.'\"');\n                                readfile($path.$readfile);\n                                //download log\n                                //download count\n                                exit;\n                            }\n                        }else{\n                            header('Content-Type: '.$filetype);\n                            header('Content-Disposition: attachment; filename=\"'.$filename.'\"');\n                            readfile($path.$readfile);\n                            //download log\n                            //download count\n                            exit;\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    return $rt;\n\n}\nfunction DATABOX_getFileTypeAry(\n    $extension \n)\n{\n    $ary=array();\n    $ary['odt']=\"application/vnd.oasis.opendocument.text\";//open office writer*\n    $ary['doc']=\"application/msword\";//Microsoft Word\n    $ary['docx']=\"application/vnd.openxmlformats\";// Microsoft Office Word 2007*\n    $ary['html']=\"text/html\";\n    $ary['odb']=\"application/octet-stream \";//OpenOffice Base*\n    $ary['odf']=\"application/vnd.oasis.opendocument.formula\";//OpenOffice Calc*\n    $ary['odg']=\"application/vnd.oasis.opendocument.graphics\";//OpenOffice Draw*\n    $ary['odm']=\"application/vnd.oasis.opendocument.text-master\";// OpenOffice Writer*\n    $ary['odp']=\"application/vnd.oasis.opendocument.presentation\";//OpenOffice Impress*\n    $ary['ods']=\"application/vnd.oasis.opendocument.spreadsheet\";//OpenOffice Calc*\n    $ary['otg']=\"application/vnd.oasis.opendocument.graphics-template\";//OpenOffice Draw*\n    $ary['oth']=\"application/octet-stream\";// OpenOffice.org Writer*\n    $ary['otp']=\"application/vnd.oasis.opendocument.presentation-template\";//OpenOffice Impress*\n    $ary['ots']=\"application/octet-stream\";//OtsAV*\n    $ary['ott']=\"application/vnd.oasis.opendocument.formula-template \";//OpenOffice Writer*\n    $ary['oxt']=\"application/vnd.openofficeorg.extension\";//OpenOffice *\n    $ary['pdf']=\"application/pdf\";\n    $ary['ppt']=\"application/mspowerpoint\";//Microsoft PowerPoint*\n    $ary['pptx']=\"application/vnd.openxmlformats\";//Microsoft Office PowerPoint 2007*\n    $ary['txt']=\"text/plain\";\n    $ary['xls']=\"application/vnd.ms-excel\";//Microsoft Excel*\n    $ary['xlsx']=\"application/vnd.openxmlformats \";//Microsoft Office Excel 2007*\n    $ary['xml']=\"text/xml\";\n\tif  ($extention===\"\"){\n\t\t$rt= $ary;\n\t}else{\n\t\t$rt= $ary[$extension];\n\t}\n\treturn $rt;\n}\n\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\u8868\u793a\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_count_each_afield(\"class\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $permission    :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000ignore\n// | \u5f15\u6570 $numberformat  :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u8ffd\u52a0\u9805\u76ee\u306e\u6307\u5b9a\u30c7\u30fc\u30bf\u306b\u4e00\u81f4\u3059\u308b\u4ef6\u6570\n// +---------------------------------------------------------------------------+\n\nfunction DATABOX_count_each_afield(\n    $pi_name=\"databox\"\n    ,$templatesetvar=\"\"\n    ,$value=\"\"\n    ,$type_id=0\n    ,$permission=''\n    ,$numberformat=''\n)\n{\n    global $_TABLES;\n\n    if ($templatesetvar==\"\" OR $value==\"\" ){\n        return \"\";\n    }\n\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n    \n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n\n    //-----\n    $sql = \"SELECT \".LB;\n\n    $sql .= \" t1.id\".LB;\n\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    $sql .= \" AND fieldset_id = \".$type_id.LB;\n\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\n    $sql .= \" AND t2.value='\". $value .\"'\".LB;\n\n    $result = DB_query ($sql);\n    $cnt = DB_numRows ($result);\n    if  (strtoupper($numberformat)==\"YES\"){\n        $rt=COM_NumberFormat($cnt);\n    }else{\n        $rt=$cnt;\n    }\n\n    return $rt;\n\n}\nfunction DATABOX_math(\n    $pi_name= 'databox'\n    ,$method= 'count'\n    ,$templatesetvar=\"\"\n    ,$type_id=\"\"\n    ,$category_id=null\n    ,$category_code=null\n    ,$mode=''\n    ,$roundprecision=''\n    ,$numberformat=''\n    ,$permission=\"\"\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u6307\u5b9a\u30a2\u30c8\u30ea\u30d3\u30e5\u30fc\u30c8\u306e\u6307\u5b9a\u5024\uff08count average max min sum\uff09\u3092\u53d6\u5f97\u3059\u308b\n// |       \u8907\u6570\u30ab\u30c6\u30b4\u30ea\u6761\u4ef6\u9078\u629e\u304c\u53ef\u80fd\uff08OR \u3068 AND\uff09\n// +---------------------------------------------------------------------------+\n// | \u66f8\u5f0f  DATABOX_math(\"databox\",\"count\",\"1\")\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $pi_name:plugin name 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $method:count average avg max min sum\n// | \u5f15\u6570 $templatesetvar:\u8ffd\u52a0\u9805\u76ee\u306e\u30c6\u30fc\u30de\u5909\u6570\n// | \u5f15\u6570 $value:\u6307\u5b9a\u30c7\u30fc\u30bf\u5024\n// | \u5f15\u6570 $type_id:\u30bf\u30a4\u30d7ID\n// | \u5f15\u6570 $category_id:\u30ab\u30c6\u30b4\u30eaid\n// | \u5f15\u6570 $category_code :\n// | \u5f15\u6570 $mode          :\u30d6\u30e9\u30f3\u30af\u3000\u307e\u305f\u306f\u3000AND\n// | \u5f15\u6570 $roundprecision:\u301c-3,-2,-1,0,1,2,3\n// | \u5f15\u6570 $numberformat  :yes\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u6307\u5b9a\u5024\n// +---------------------------------------------------------------------------+\n{\n    global $_TABLES;\n    global $_CONF;\n\n    if ($templatesetvar==\"\" ){\n        return \"\";\n    }\n    if  ($type_id==\"\" OR  $type_id==NULL){\n        $type_id=0;\n    }\n\t\n\t$method=strtoupper($method);\n    if  ($method==\"MAX\" OR $method==\"MIN\" OR $method==\"SUM\" OR $method==\"AVG\" OR $method==\"COUNT\" ){\n    }else if  ($method==\"AVERAGE\" ){\n\t    $method=\"AVG\";\n\t}else{\n\t    $method=\"COUNT\";\n\t}\n    //-----category check\n    $ids=\"\";\n    $idsary=array();\n    if (is_null($category_id) OR $category_id==0){\n        if (is_null($category_code)){\n        }else{\n            $w=explode(\"|\",$category_code);\n            foreach( $w as $val ){\n                if ($ids<>\"\"){\n                    $ids.=\",\";\n                }\n                $w_id=DATABOX_codetoid($val,strtoupper($pi_name).'_def_category',\"category_id\");\n                $idsary[]=$w_id;\n                $ids.=$w_id;\n            }\n        }\n    }else{\n        $ids=$category_id;\n        $idsary[]=$category_id;\n    }\n    //-----\n    $tbl1=$_TABLES[strtoupper($pi_name).'_base'] ;\n    $tbl2=$_TABLES[strtoupper($pi_name).'_addition'] ;\n    $tbl3=$_TABLES[strtoupper($pi_name).'_def_field'];\n    $tbl4=$_TABLES[strtoupper($pi_name).'_category'] ;\n\t$tbl5=$_TABLES[strtoupper($pi_name).'_def_category'] ;\n\t\n    $type=DB_getItem( $tbl3   ,\"type\",\"templatesetvar='{$templatesetvar}'\");\n\t\n    //-----\n    $sql = \"SELECT \".LB;\n    \n    if  ($type==15  OR $type==21 OR strtoupper($numberformat)==\"YES\") {\n        $sql .= $method .\"(t2.value + 0) AS rt\".LB;\n    }else{\n        $sql .= $method .\"(t2.value) AS rt\".LB;\n    }\n    $sql .= \" FROM \".LB;\n\n    $sql .= \" {$tbl1} AS t1 \".LB;\n    $sql .= \" ,{$tbl2} AS t2 \".LB;\n    $sql .= \" ,{$tbl3} AS t3 \".LB;\n\n    $sql .= \" WHERE \".LB;\n\n    //@@@@@@@@@@@------>\n    //\u4e0b\u66f8\u306f\u306e\u305e\u304f\n    $sql .= \" t1.draft_flag=0\".LB;\n    //\u30a2\u30af\u30bb\u30b9\u6a29\u306e\u306a\u3044\u30c7\u30fc\u30bf \u306f\u306e\u305e\u304f\n    if  (strtoupper($permission)==\"IGNORE\"){\n    }else{\n        $sql .= COM_getPermSql('AND').LB;\n    }\n    //\u516c\u958b\u65e5\u4ee5\u524d\u306e\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (released <= NOW())\".LB;\n    //\u516c\u958b\u7d42\u4e86\u65e5\u3092\u904e\u304e\u305f\u30c7\u30fc\u30bf\u306f\u306e\u305e\u304f\n    $sql .= \" AND (expired=0 OR expired > NOW())\".LB;\n    //@@@@@@@@@@@<------\n    \n    $sql .= \" AND fieldset_id=\".$type_id;\n    $sql .= \" AND t1.id = t2.id \".LB;\n    $sql .= \" AND t2.field_id= t3.field_id\" .LB;\n    $sql .= \" AND t3.templatesetvar='\". $templatesetvar .\"'\".LB;\n\t\n    if (count($idsary)<>0){\n        if (strtoupper($mode)==\"AND\"){\n            $w=\"\";\n            foreach( $idsary as $val ){\n                if ($w<>\"\"){\n                    $w.=\" AND \";\n                }\n                $w.=$val.\" IN (SELECT t4.category_id\";\n                $w.=\" FROM {$tbl4} AS t4 ,{$tbl5} AS t5\";\n                $w.=\" WHERE t1.id = t4.id AND t4.category_id = t5.category_id AND t5.allow_display<2)\";\n            }\n        }else{\n            $w= \"t1.id IN (SELECT id FROM {$tbl4} AS t4 ,{$tbl5} AS t5 \";\n            $w.=\"WHERE t4.category_id = t5.category_id AND t5.allow_display<2 AND t4.category_id IN ({$ids})) \";\n        }\n        $sql.=\" AND ({$w})\".LB;\n    }\n    $result = DB_query ($sql);\n    $numrows = DB_numRows ($result);\n\t\n    if ($numrows > 0) {\n        $A = DB_fetchArray ($result);\n\t\t$A = array_map('stripslashes', $A);\n\t\t$rt=$A['rt'];;\n\t}else{\n\t\tif  ($method==\"COUNT\"){\n\t\t\t$rt=0;\n\t\t}else{\n\t\t\t$rt=\"\";\n\t\t}\n\t}\n\t\n    if ( is_numeric($rt) ) {\n        if  (!is_numeric($roundprecision)){\n            $roundprecision=0;\n        }\n        $rt=round($rt,$roundprecision);\n        if  (strtoupper($numberformat)==\"YES\"){\n            $rt=number_format( $rt, \n                $roundprecision, $_CONF['decimal_separator'], $_CONF['thousand_separator'] );\n        }\n    }\n    return $rt;\n\t\n\t\n}\nfunction DATABOX_getcheckboxary(\n    $ary\n    ,$fld\n    ,$selected = \"\"\n    ,$pi_name=\"\"\n    ,$disabled=\"\"\n    ,$type=\"\"\n    ,$size=1\n)\n// +---------------------------------------------------------------------------+\n// | \u6a5f\u80fd  \u30c1\u30a7\u30c3\u30af\u30dc\u30c3\u30af\u30b9\u4f5c\u6210\uff08\u914d\u5217\u3088\u308a\uff09\n// | \u66f8\u5f0f DATABOX_getcheckboxary($selectionary,\"afield[\".$fid.\"]\",$fvalue,$pi_name, $disabled,$type);\n// +---------------------------------------------------------------------------+\n// | \u5f15\u6570 $ary:\n// | \u5f15\u6570 $fld:\n// | \u5f15\u6570 $selected:\u9078\u629e\u5024\u3000\u7701\u7565\u6642\n// | \u5f15\u6570 $pi_name: 'databox' 'userbox' 'formbox'\n// | \u5f15\u6570 $disabled:defalt=\"\" \n// | \u5f15\u6570 $type:defalt=\"\" 14=multiselect\n// +---------------------------------------------------------------------------+\n// | \u623b\u5024 nomal:\u30aa\u30d7\u30b7\u30e7\u30f3\u30ea\u30b9\u30c8                                               |\n// +---------------------------------------------------------------------------+\n{\n\n    if ($pi_name==\"\"){\n        $lang_box=\"LANG_DATABOX\";\n    }else{\n        $lang_box=\"LANG_\".strtoupper($pi_name);\n    }\n    global $$lang_box;\n    $lang_box=$$lang_box;\n\t\n    $selectedary=explode(\":\",$selected);\n\t\n\t$retval = '';\n\t\n    foreach($ary as $k => $v) {\n        $retval .= '<span style=\"white-space:nowrap\">';\n        $retval .= '<input type=\"checkbox\" name=\"' . $fld . '[]\" value=\"' . $k ;\n        $retval .= '\"';\n\t\tif  ($selected==\"\"){\n\t\t}else{\n            if( in_array($k,$selectedary) ){//@@@@@\n                $retval .= ' checked=\"checked\"';\n\t\t\t}\n\t\t}\n        $retval .= '>' . stripslashes( $v ) . '</span>' . LB;\n\n    }\n    return $retval;\n}\n\n?>"], "filenames": ["extended/plugins/databox/functions_autotag.inc", "extended/plugins/databox/lib/databox_functions.inc", "extended/plugins/userbox/functions_autotag.inc", "extended/plugins/userbox/lib/databox_functions.inc"], "buggy_code_start_loc": [129, 155, 131, 4780], "buggy_code_end_loc": [3074, 4796, 2334, 4781], "fixing_code_start_loc": [130, 155, 132, 4780], "fixing_code_end_loc": [3098, 4781, 2445, 4781], "type": "CWE-79", "message": "Multiple cross-site scripting (XSS) vulnerabilities in the IVYWE (1) Assist plugin before 1.1.2.test20160906, (2) dataBox plugin before 0.0.0.20160906, and (3) userBox plugin before 0.0.0.20160906 for Geeklog allow remote attackers to inject arbitrary web script or HTML via unspecified vectors.", "other": {"cve": {"id": "CVE-2016-4875", "sourceIdentifier": "vultures@jpcert.or.jp", "published": "2017-04-14T18:59:00.343", "lastModified": "2017-04-21T17:42:17.267", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "Multiple cross-site scripting (XSS) vulnerabilities in the IVYWE (1) Assist plugin before 1.1.2.test20160906, (2) dataBox plugin before 0.0.0.20160906, and (3) userBox plugin before 0.0.0.20160906 for Geeklog allow remote attackers to inject arbitrary web script or HTML via unspecified vectors."}, {"lang": "es", "value": "M\u00faltiples vulnerabilidades XSS en el plugin IVYWE (1) Assist en versiones anteriores a 1.1.2.test20160906, (2) DataBox plugin en versiones anteriores a 0.0.020160906, y (3) plugin userBox en versiones anteriores a 0.0.0.20160906 para Geeklog permite a los atacantes remotos a inyectar secuencias de comandos web o HTML a trav\u00e9s de vectores no especificados."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "REQUIRED", "scope": "CHANGED", "confidentialityImpact": "LOW", "integrityImpact": "LOW", "availabilityImpact": "NONE", "baseScore": 6.1, "baseSeverity": "MEDIUM"}, "exploitabilityScore": 2.8, "impactScore": 2.7}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:M/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "MEDIUM", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 4.3}, "baseSeverity": "MEDIUM", "exploitabilityScore": 8.6, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": true}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-79"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:assist_project:assist_plugin:*:*:*:*:*:geeklog:*:*", "versionEndIncluding": "1.1.0", "matchCriteriaId": "2E4A1694-64AC-4EBB-B6D7-F9FB582B64E8"}, {"vulnerable": true, "criteria": "cpe:2.3:a:databox_project:databox_plugin:*:*:*:*:*:geeklog:*:*", "versionEndIncluding": "0..0.0.20150609", "matchCriteriaId": "7552DE20-C4A4-433E-8C3B-BB5EB2F123A5"}, {"vulnerable": true, "criteria": "cpe:2.3:a:userbox_project:userbox_plugin:*:*:*:*:*:geeklog:*:*", "versionEndIncluding": "0.0.0.20150918", "matchCriteriaId": "0D0F790A-CF08-4DEA-A519-27B2ECE74FFB"}]}]}], "references": [{"url": "http://jvn.jp/en/jp/JVN46087986/index.html", "source": "vultures@jpcert.or.jp", "tags": ["Third Party Advisory", "VDB Entry"]}, {"url": "http://jvndb.jvn.jp/en/contents/2016/JVNDB-2016-000167.html", "source": "vultures@jpcert.or.jp", "tags": ["Third Party Advisory", "VDB Entry"]}, {"url": "http://www.securityfocus.com/bid/93123", "source": "vultures@jpcert.or.jp", "tags": ["Third Party Advisory", "VDB Entry"]}, {"url": "https://github.com/ivywe/geeklog-ivywe/commit/3cdb4ebca5746ff1e02b7e434d5722044d1d09d1", "source": "vultures@jpcert.or.jp", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/ivywe/geeklog-ivywe/commit/fe20a1bccdfec96125ab3d8dbee6ccbd0767c0be", "source": "vultures@jpcert.or.jp", "tags": ["Patch", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/ivywe/geeklog-ivywe/commit/3cdb4ebca5746ff1e02b7e434d5722044d1d09d1"}}