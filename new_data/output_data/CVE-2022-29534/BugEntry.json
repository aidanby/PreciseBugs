{"buggy_code": ["<?php\nApp::uses('AppController', 'Controller');\n\n/**\n * @property User $User\n */\nclass UsersController extends AppController\n{\n    public $newkey;\n\n    public $components = array(\n        'RequestHandler'\n    );\n\n    public $paginate = array(\n        'limit' => 60,\n        'recursive' => -1,\n        'order' => array(\n                'Organisation.name' => 'ASC'\n        ),\n        'contain' => array(\n            'Organisation' => array('id', 'uuid', 'name'),\n            'Role' => array('id', 'name', 'perm_auth', 'perm_site_admin')\n        )\n    );\n\n    public $toggleableFields = ['disabled', 'autoalert'];\n\n    public function beforeFilter()\n    {\n        parent::beforeFilter();\n\n        // what pages are allowed for non-logged-in users\n        $allowedActions = array('login', 'logout', 'getGpgPublicKey');\n        if(!empty(Configure::read('Security.email_otp_enabled'))) {\n          $allowedActions[] = 'email_otp';\n        }\n        if (!empty(Configure::read('Security.allow_self_registration'))) {\n            $allowedActions[] = 'register';\n        }\n        $this->Auth->allow($allowedActions);\n    }\n\n    public function view($id = null)\n    {\n        if (\"me\" === $id) {\n            $id = $this->Auth->user('id');\n        }\n        if (!$this->_isSiteAdmin() && $this->Auth->user('id') != $id) {\n            throw new NotFoundException(__('Invalid user or not authorised.'));\n        }\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $id),\n            'contain' => array(\n                'UserSetting',\n                'Role',\n                'Organisation'\n            )\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n            unset($user['User']['authkey']);\n        }\n        if (!empty($user['User']['gpgkey'])) {\n            $pgpDetails = $this->User->verifySingleGPG($user);\n            $user['User']['pgp_status'] = isset($pgpDetails[2]) ? $pgpDetails[2] : 'OK';\n            $user['User']['fingerprint'] = !empty($pgpDetails[4]) ? $pgpDetails[4] : 'N/A';\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($this->__massageUserObject($user), $this->response->type());\n        } else {\n            $this->set('user', $user);\n            $this->set('admin_view', false);\n        }\n    }\n\n    /**\n     * @param array $user\n     * @return array\n     */\n    private function __massageUserObject(array $user)\n    {\n        $user['UserSetting'] = array_column($user['UserSetting'], 'value', 'setting');\n        unset($user['User']['server_id']);\n        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n            unset($user['User']['authkey']);\n        }\n        $user['User']['password'] = '*****';\n        $temp = [];\n        $objectsToInclude = array('User', 'Role', 'UserSetting', 'Organisation');\n        foreach ($objectsToInclude as $objectToInclude) {\n            if (isset($user[$objectToInclude])) {\n                $temp[$objectToInclude] = $user[$objectToInclude];\n            }\n        }\n        return $temp;\n    }\n\n    public function request_API()\n    {\n        if (Configure::read('MISP.disable_emailing')) {\n            return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'API access request failed. E-mailing is currently disabled on this instance.')), 'status'=>200, 'type' => 'json'));\n        }\n        $responsibleAdmin = $this->User->findAdminsResponsibleForUser($this->Auth->user());\n        if (isset($responsibleAdmin['email']) && !empty($responsibleAdmin['email'])) {\n            $subject = \"[MISP \" . Configure::read('MISP.org') . \"] User requesting API access\";\n            $body = \"A user (\" . $this->Auth->user('email') . \") has sent you a request to enable his/her API key access.\" . PHP_EOL;\n            $body .= \"You can edit the user's profile at \" . Configure::read('MISP.baseurl') . '/admin/users/edit/' . $this->Auth->user('id');\n            $user = $this->User->find('first', array('conditions' => array('User.id' => $responsibleAdmin['id'])));\n            $result = $this->User->sendEmail($user, $body, false, $subject);\n            if ($result) {\n                return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'API access requested.')), 'status'=>200, 'type' => 'json'));\n            }\n        }\n        return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'Something went wrong, please try again later.')), 'status'=>200, 'type' => 'json'));\n    }\n\n    public function edit()\n    {\n        $currentUser = $this->User->find('first', array(\n            'conditions' => array('User.id' => $this->Auth->user('id')),\n            'recursive' => -1\n        ));\n        if (empty($currentUser)) {\n            throw new NotFoundException('Something went wrong. Your user account could not be accessed.');\n        }\n        $id = $currentUser['User']['id'];\n        if ($this->request->is('post') || $this->request->is('put')) {\n            if (empty($this->request->data['User'])) {\n                $this->request->data = array('User' => $this->request->data);\n            }\n            $abortPost = false;\n            if (!empty($this->request->data['User']['email']) && !$this->_isSiteAdmin()) {\n                $organisation = $this->User->Organisation->find('first', array(\n                    'conditions' => array('Organisation.id' => $this->Auth->user('org_id')),\n                    'recursive' => -1\n                ));\n                if (!empty($organisation['Organisation']['restricted_to_domain'])) {\n                    $abortPost = true;\n                    foreach ($organisation['Organisation']['restricted_to_domain'] as $restriction) {\n                        if (\n                            strlen($this->request->data['User']['email']) > strlen($restriction) &&\n                            substr($this->request->data['User']['email'], (-1 * strlen($restriction))) === $restriction &&\n                            in_array($this->request->data['User']['email'][strlen($this->request->data['User']['email']) - strlen($restriction) -1], array('@', '.'))\n                        ) {\n                            $abortPost = false;\n                        }\n                    }\n                    if ($abortPost) {\n                        $message = __('Invalid e-mail domain. Your user is restricted to creating users for the following domain(s): ') . implode(', ', $organisation['Organisation']['restricted_to_domain']);\n                    }\n                }\n            }\n            if (!$abortPost && !$this->_isRest()) {\n                if (Configure::read('Security.require_password_confirmation')) {\n                    if (!empty($this->request->data['User']['current_password'])) {\n                        $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['current_password']);\n                        if (!$hashed) {\n                            $abortPost = true;\n                            $this->Flash->error('Invalid password. Please enter your current password to continue.');\n                        }\n                        unset($this->request->data['User']['current_password']);\n                    } else {\n                        $abortPost = true;\n                        $this->Flash->info('Please enter your current password to continue.');\n                    }\n                }\n            }\n            if (!$abortPost) {\n                // What fields should be saved (allowed to be saved)\n                $fieldList = array('autoalert', 'gpgkey', 'certif_public', 'nids_sid', 'contactalert', 'disabled', 'date_modified');\n                if ($this->__canChangeLogin()) {\n                    $fieldList[] = 'email';\n                }\n                if ($this->__canChangePassword() && !empty($this->request->data['User']['password'])) {\n                    $fieldList[] = 'password';\n                    $fieldList[] = 'confirm_password';\n                }\n                foreach ($this->request->data['User'] as $k => $v) {\n                    $currentUser['User'][$k] = $v;\n                }\n                // Save the data\n                if ($this->_isRest()) {\n                    if (!empty($this->request->data['User']['password'])) {\n                        if ($this->request->data['User']['password'] === '*****') {\n                            unset($this->request->data['User']['password']);\n                        } else {\n                            $currentUser['User']['confirm_password'] = $this->request->data['User']['password'];\n                        }\n                    }\n                }\n                if ($this->User->save($currentUser, true, $fieldList)) {\n                    if ($this->_isRest()) {\n                        $user = $this->User->find('first', array(\n                            'conditions' => array('User.id' => $id),\n                            'recursive' => -1,\n                            'contain' => array(\n                                'Organisation',\n                                'Role',\n                                'UserSetting'\n                            )\n                        ));\n                        return $this->RestResponse->viewData($this->__massageUserObject($user), $this->response->type());\n                    } else {\n                        $this->Flash->success(__('The profile has been updated'));\n                        $this->redirect(array('action' => 'view', $id));\n                    }\n                } else {\n                    $message = __('The profile could not be updated. Please, try again.');\n                    $abortPost = true;\n                }\n            }\n            if ($abortPost) {\n                $this->request->data['User']['password'] = '';\n                $this->request->data['User']['confirm_password'] = '';\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveFailResponse('Users', 'edit', $id, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                }\n            }\n        } else {\n            $this->User->data = $currentUser;\n            $this->User->set('password', '');\n            $this->request->data = $this->User->data;\n        }\n        $this->loadModel('Server');\n        $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n        $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n        $roles = $this->User->Role->find('list');\n        $this->set('roles', $roles);\n        $this->set('id', $id);\n        $this->set('canChangePassword', $this->__canChangePassword());\n        $this->set('canChangeLogin', $this->__canChangeLogin());\n    }\n\n    public function change_pw()\n    {\n        $id = $this->Auth->user('id');\n        $user = $this->User->find('first', array(\n            'conditions' => array('User.id' => $id),\n            'recursive' => -1\n        ));\n        if ($this->request->is('post') || $this->request->is('put')) {\n            if (!isset($this->request->data['User'])) {\n                $this->request->data = array('User' => $this->request->data);\n            }\n            $abortPost = false;\n            if (Configure::read('Security.require_password_confirmation')) {\n                if (!empty($this->request->data['User']['current_password'])) {\n                    $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['current_password']);\n                    if (!$hashed) {\n                        $message = __('Invalid password. Please enter your current password to continue.');\n                        if ($this->_isRest()) {\n                            return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                        }\n                        $abortPost = true;\n                        $this->Flash->error($message);\n                    }\n                    unset($this->request->data['User']['current_password']);\n                } else if (!$this->_isRest()) {\n                    $message = __('Please enter your current password to continue.');\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                    }\n                    $abortPost = true;\n                    $this->Flash->info($message);\n                }\n            }\n            $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['password']);\n            if ($hashed) {\n                $message = __('Submitted new password cannot be the same as the current one');\n                $abortPost = true;\n            }\n            if (!$abortPost) {\n                // What fields should be saved (allowed to be saved)\n                $user['User']['change_pw'] = 0;\n                $user['User']['password'] = $this->request->data['User']['password'];\n                if ($this->_isRest()) {\n                    $user['User']['confirm_password'] = $this->request->data['User']['password'];\n                } else {\n                    $user['User']['confirm_password'] = $this->request->data['User']['confirm_password'];\n                }\n                $temp = $user['User']['password'];\n                // Save the data\n                if ($this->User->save($user)) {\n                    $message = __('Password Changed.');\n                    $this->User->extralog($this->Auth->user(), \"change_pw\", null, null, $user);\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveSuccessResponse('User', 'change_pw', false, $this->response->type(), $message);\n                    }\n                    $this->Flash->success($message);\n                    $this->redirect(array('action' => 'view', $id));\n                } else {\n                    $message = __('The password could not be updated. Make sure you meet the minimum password length / complexity requirements.');\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                    }\n                    $this->Flash->error($message);\n                }\n            } else {\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                }\n            }\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->describe('Users', 'change_pw', false, $this->response->type());\n        }\n        $this->loadModel('Server');\n        $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n        $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n        $this->User->recursive = 0;\n        $this->User->read(null, $id);\n        $this->User->set('password', '');\n        $this->request->data = $this->User->data;\n        $roles = $this->User->Role->find('list');\n        $this->set('roles', $roles);\n    }\n\n    public function admin_index()\n    {\n        $this->User->virtualFields['org_ci'] = 'UPPER(Organisation.name)';\n        $urlParams = \"\";\n        $passedArgsArray = array();\n        $booleanFields = array('autoalert', 'contactalert', 'termsaccepted', 'disabled');\n        $textFields = array('role', 'email', 'all', 'authkey');\n        // org admins can't see users of other orgs\n        if ($this->_isSiteAdmin()) {\n            $textFields[] = 'org';\n        }\n        $this->set('passedArgs', json_encode($this->passedArgs));\n        // check each of the passed arguments whether they're a filter (could also be a sort for example) and if yes, add it to the pagination conditions\n        if (!empty($this->passedArgs['value'])) {\n            $this->passedArgs['searchall'] = $this->passedArgs['value'];\n        }\n        foreach ($this->passedArgs as $k => $v) {\n            if (substr($k, 0, 6) === 'search') {\n                if ($v != \"\") {\n                    if ($urlParams != \"\") {\n                        $urlParams .= \"/\";\n                    }\n                    $urlParams .= $k . \":\" . $v;\n                }\n                $searchTerm = substr($k, 6);\n                if (in_array($searchTerm, $booleanFields)) {\n                    if ($v != \"\") {\n                        $this->paginate['conditions'][] = array('User.' . $searchTerm => $v);\n                    }\n                } elseif (in_array($searchTerm, $textFields)) {\n                    if ($v != \"\") {\n                        if ($searchTerm == \"role\") {\n                            $searchTerm = \"role_id\";\n                        }\n                        $pieces = explode('|', $v);\n                        $test = array();\n                        foreach ($pieces as $piece) {\n                            if ($piece[0] == '!') {\n                                if ($searchTerm == 'email') {\n                                    $this->paginate['conditions']['AND'][] = array('LOWER(User.' . $searchTerm . ') NOT LIKE' => '%' . strtolower(substr($piece, 1)) . '%');\n                                } elseif ($searchTerm == 'org') {\n                                    $this->paginate['conditions']['AND'][] = array('User.org_id !=' => substr($piece, 1));\n                                } else {\n                                    $this->paginate['conditions']['AND'][] = array('User.' . $searchTerm => substr($piece, 1));\n                                }\n                            } else {\n                                if ($searchTerm == 'email') {\n                                    $test['OR'][] = array('LOWER(User.' . $searchTerm . ') LIKE' => '%' . strtolower($piece) . '%');\n                                } elseif ($searchTerm == 'org') {\n                                    $this->paginate['conditions']['OR'][] = array('User.org_id' => $piece);\n                                } elseif ($searchTerm == 'all') {\n                                    $this->paginate['conditions']['AND'][] = array(\n                                            'OR' => array(\n                                                    'UPPER(User.email) LIKE' => '%' . strtoupper($piece) . '%',\n                                                    'UPPER(Organisation.name) LIKE' => '%' . strtoupper($piece) . '%',\n                                                    'UPPER(Role.name) LIKE' => '%' . strtoupper($piece) . '%',\n                                                    'UPPER(User.authkey) LIKE' => '%' . strtoupper($piece) . '%'\n                                            ),\n                                    );\n                                } else {\n                                    $test['OR'][] = array('User.' . $searchTerm => $piece);\n                                }\n                            }\n                        }\n                        if (!empty($test)) {\n                            $this->paginate['conditions']['AND'][] = $test;\n                        }\n                    }\n                }\n                $passedArgsArray[$searchTerm] = $v;\n            }\n        }\n        $redis = $this->User->setupRedis();\n        if ($this->_isRest()) {\n            $conditions = array();\n            if (isset($this->paginate['conditions'])) {\n                $conditions = $this->paginate['conditions'];\n            }\n            if (!$this->_isSiteAdmin()) {\n                $conditions['User.org_id'] = $this->Auth->user('org_id');\n            }\n            $users = $this->User->find('all', array(\n                    'conditions' => $conditions,\n                    'recursive' => -1,\n                    'fields' => array(\n                        'id',\n            'org_id',\n            'server_id',\n            'email',\n            'autoalert',\n            'authkey',\n            'invited_by',\n            'gpgkey',\n            'certif_public',\n            'nids_sid',\n            'termsaccepted',\n            'newsread',\n            'role_id',\n            'change_pw',\n            'contactalert',\n            'disabled',\n            'expiration',\n            'current_login',\n            'last_login',\n            'force_logout',\n            'date_created',\n            'date_modified'\n                    ),\n                    'contain' => array(\n                            'Organisation' => array('id', 'name'),\n                            'Role' => array('id', 'name', 'perm_auth', 'perm_site_admin')\n                    )\n            ));\n            foreach ($users as $key => $value) {\n                if (empty($this->Auth->user('Role')['perm_site_admin'])) {\n                    if ($value['Role']['perm_site_admin']) {\n                        $users[$key]['User']['authkey'] = __('Redacted');\n                    }\n                } else if (!empty(Configure::read('Security.user_monitoring_enabled'))) {\n                    $users[$key]['User']['monitored'] = $redis->sismember('misp:monitored_users', $value['User']['id']);\n                }\n                unset($users[$key]['User']['password']);\n            }\n            return $this->RestResponse->viewData($users, $this->response->type());\n        } else {\n            $this->set('urlparams', $urlParams);\n            $this->set('passedArgsArray', $passedArgsArray);\n            $conditions = array();\n            if ($this->_isSiteAdmin()) {\n                $users = $this->paginate();\n                if (!empty(Configure::read('Security.user_monitoring_enabled'))) {\n                    foreach ($users as $key => $value) {\n                        $users[$key]['User']['monitored'] = $redis->sismember('misp:monitored_users', $users[$key]['User']['id']);\n                    }\n                }\n                $this->set('users', $users);\n            } else {\n                $conditions['User.org_id'] = $this->Auth->user('org_id');\n                $this->paginate['conditions']['AND'][] = $conditions;\n                $users = $this->paginate();\n                foreach ($users as $key => $value) {\n                    if ($value['Role']['perm_site_admin']) {\n                        $users[$key]['User']['authkey'] = __('Redacted');\n                    }\n                }\n                $this->set('users', $users);\n            }\n        }\n    }\n\n    public function admin_filterUserIndex()\n    {\n        $passedArgsArray = array();\n        $booleanFields = array('autoalert', 'contactalert', 'termsaccepted', 'disabled');\n        $textFields = array('role', 'email');\n        if (empty(Configure::read('Security.advanced_authkeys'))) {\n            $textFields[] = 'authkey';\n        }\n        $showOrg = 0;\n        // org admins can't see users of other orgs\n        if ($this->_isSiteAdmin()) {\n            $textFields[] = 'org';\n            $showOrg = 1;\n        }\n        $this->set('differentFilters', $booleanFields);\n        $this->set('simpleFilters', $textFields);\n        $rules = array_merge($booleanFields, $textFields);\n        $this->set('showorg', $showOrg);\n\n        $filtering = array();\n        foreach ($booleanFields as $b) {\n            $filtering[$b] = '';\n        }\n        foreach ($textFields as $t) {\n            $filtering[$t] = array('OR' => array(), 'NOT' => array());\n        }\n\n        foreach ($this->passedArgs as $k => $v) {\n            if (substr($k, 0, 6) === 'search') {\n                $searchTerm = substr($k, 6);\n                if (in_array($searchTerm, $booleanFields)) {\n                    $filtering[$searchTerm] = $v;\n                } elseif (in_array($searchTerm, $textFields)) {\n                    $pieces = explode('|', $v);\n                    foreach ($pieces as $piece) {\n                        if ($piece[0] == '!') {\n                            $filtering[$searchTerm]['NOT'][] = substr($piece, 1);\n                        } else {\n                            $filtering[$searchTerm]['OR'][] = $piece;\n                        }\n                    }\n                }\n                $passedArgsArray[$searchTerm] = $v;\n            }\n        }\n        $this->set('filtering', json_encode($filtering));\n\n        $roles = $this->User->Role->find('all', array('recursive' => -1));\n        $roleNames = array();\n        $roleJSON = array();\n        foreach ($roles as $k => $v) {\n            $roleNames[$v['Role']['id']] = $v['Role']['name'];\n            $roleJSON[] = array('id' => $v['Role']['id'], 'value' => $v['Role']['name']);\n        }\n        if ($showOrg) {\n            $orgs = $this->User->Organisation->find('list', array(\n                'conditions' => array('local' => 1),\n                'recursive' => -1,\n                'fields' => array('id', 'name'),\n                'order' => array('LOWER(name) ASC')\n            ));\n            $this->set('orgs', $orgs);\n        }\n        $this->set('roles', $roleNames);\n        $this->set('roleJSON', json_encode($roleJSON));\n        $rules = $this->_arrayToValuesIndexArray($rules);\n        $this->set('rules', $rules);\n        $this->set('baseurl', Configure::read('MISP.baseurl'));\n        $this->layout = 'ajax';\n    }\n\n    public function admin_view($id = null)\n    {\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $id),\n            'contain' => [\n                'UserSetting',\n                'Role',\n                'Organisation'\n            ]\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        if (!$this->_isSiteAdmin() && !($this->_isAdmin() && $this->Auth->user('org_id') == $user['User']['org_id'])) {\n            throw new MethodNotAllowedException();\n        }\n        if (!empty($user['User']['gpgkey'])) {\n            $pgpDetails = $this->User->verifySingleGPG($user);\n            $user['User']['pgp_status'] = isset($pgpDetails[2]) ? $pgpDetails[2] : 'OK';\n            $user['User']['fingerprint'] = !empty($pgpDetails[4]) ? $pgpDetails[4] : 'N/A';\n        }\n        $user['User']['orgAdmins'] = $this->User->getOrgAdminsForOrg($user['User']['org_id'], $user['User']['id']);\n        if (empty($this->Auth->user('Role')['perm_site_admin']) && !(empty($user['Role']['perm_site_admin']))) {\n            $user['User']['authkey'] = __('Redacted');\n        }\n        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n            unset($user['User']['authkey']);\n        }\n        if ($this->_isRest()) {\n            $user['User']['password'] = '*****';\n            $temp = array();\n            foreach ($user['UserSetting'] as $k => $v) {\n                $temp[$v['setting']] = $v['value'];\n            }\n            $user['UserSetting'] = $temp;\n            return $this->RestResponse->viewData(array(\n                'User' => $user['User'],\n                'Role' => $user['Role'],\n                'UserSetting' => $user['UserSetting']\n            ), $this->response->type());\n        }\n        $this->set('user', $user);\n        $user2 = $this->User->find('first', array('conditions' => array('User.id' => $user['User']['invited_by']), 'recursive' => -1));\n        $this->set('id', $id);\n        $this->set('user2', $user2);\n        $this->set('admin_view', true);\n        $this->render('view');\n    }\n\n    public function admin_add()\n    {\n        $params = null;\n        if (!$this->_isSiteAdmin()) {\n            $params = array('conditions' => array('perm_site_admin !=' => 1, 'perm_sync !=' => 1, 'perm_regexp_access !=' => 1));\n        }\n        $this->loadModel('AdminSetting');\n        $default_role_id = $this->AdminSetting->getSetting('default_role');\n        $roles = $this->User->Role->find('list', $params);\n        $syncRoles = $this->User->Role->find('list', array('conditions' => array('perm_sync' => 1), 'recursive' => -1));\n        if ($this->request->is('post')) {\n            // In case we don't get the data encapsulated in a User object\n            if ($this->_isRest()) {\n                if (!isset($this->request->data['User'])) {\n                    $this->request->data = array('User' => $this->request->data);\n                }\n                if (isset($this->request->data['User']['id'])) {\n                    unset($this->request->data['User']['id']);\n                }\n                $required_fields = array('role_id', 'email');\n                foreach ($required_fields as $field) {\n                    $set_field_via_other_means = false;\n                    if (empty($this->request->data['User'][$field])) {\n                        if ($field === 'role_id') {\n                            if (!empty($default_role_id)) {\n                                $this->request->data['User'][$field] = $default_role_id;\n                                $set_field_via_other_means = true;\n                            }\n                        }\n                        if (!$set_field_via_other_means) {\n                            return $this->RestResponse->saveFailResponse('Users', 'admin_add', false, array($field => 'Mandatory field not set.'), $this->response->type());\n                        }\n                    }\n                }\n                if (isset($this->request->data['User']['password'])) {\n                    $this->request->data['User']['confirm_password'] = $this->request->data['User']['password'];\n                }\n                $default_publish_alert = Configure::check('MISP.default_publish_alert') ? Configure::read('MISP.default_publish_alert') : 0;\n                $defaults = array(\n                        'external_auth_required' => 0,\n                        'external_auth_key' => '',\n                        'server_id' => 0,\n                        'gpgkey' => '',\n                        'certif_public' => '',\n                        'autoalert' => $default_publish_alert,\n                        'contactalert' => 0,\n                        'disabled' => 0,\n                        'newsread' => 0,\n                        'change_pw' => 1,\n                        'authkey' => (new RandomTool())->random_str(true, 40),\n                        'termsaccepted' => 0,\n                        'org_id' => $this->Auth->user('org_id')\n                );\n                foreach ($defaults as $key => $value) {\n                    if (!isset($this->request->data['User'][$key])) {\n                        $this->request->data['User'][$key] = $value;\n                    }\n                }\n            }\n            $this->request->data['User']['date_created'] = time();\n            $this->request->data['User']['date_modified'] = time();\n            if (!array_key_exists($this->request->data['User']['role_id'], $syncRoles)) {\n                $this->request->data['User']['server_id'] = 0;\n            }\n            $this->User->create();\n            // set invited by\n            $this->loadModel('Role');\n            $this->Role->recursive = -1;\n            $chosenRole = $this->Role->findById($this->request->data['User']['role_id']);\n            if (empty($chosenRole)) {\n                throw new MethodNotAllowedException('Invalid role');\n            }\n            $this->request->data['User']['invited_by'] = $this->Auth->user('id');\n            if (!$this->_isRest()) {\n                if ($chosenRole['Role']['perm_sync']) {\n                    $this->request->data['User']['change_pw'] = 0;\n                    $this->request->data['User']['termsaccepted'] = 1;\n                } else {\n                    $this->request->data['User']['change_pw'] = 1;\n                    $this->request->data['User']['termsaccepted'] = 0;\n                }\n            }\n            if (!isset($this->request->data['User']['disabled'])) {\n                $this->request->data['User']['disabled'] = false;\n            }\n            $this->request->data['User']['newsread'] = 0;\n            if (!$this->_isSiteAdmin()) {\n                $this->request->data['User']['org_id'] = $this->Auth->user('org_id');\n                $this->loadModel('Role');\n                $this->Role->recursive = -1;\n                $chosenRole = $this->Role->findById($this->request->data['User']['role_id']);\n                if (\n                    $chosenRole['Role']['perm_site_admin'] == 1 ||\n                    $chosenRole['Role']['perm_regexp_access'] == 1 ||\n                    $chosenRole['Role']['perm_sync'] == 1 ||\n                    $chosenRole['Role']['restricted_to_site_admin'] == 1\n                ) {\n                    throw new Exception('You are not authorised to assign that role to a user.');\n                }\n            }\n            $organisation = $this->User->Organisation->find('first', array(\n                'conditions' => array('Organisation.id' => $this->request->data['User']['org_id']),\n                'recursive' => -1\n            ));\n            $fail = false;\n            if (!$this->_isSiteAdmin()) {\n                if (!empty($organisation['Organisation']['restricted_to_domain'])) {\n                    $fail = true;\n                    foreach ($organisation['Organisation']['restricted_to_domain'] as $restriction) {\n                        if (\n                            strlen($this->request->data['User']['email']) > strlen($restriction) &&\n                            substr($this->request->data['User']['email'], (-1 * strlen($restriction))) === $restriction &&\n                            in_array($this->request->data['User']['email'][strlen($this->request->data['User']['email']) - strlen($restriction) -1], array('@', '.'))\n                        ) {\n                            $fail = false;\n                        }\n                    }\n                    if ($fail) {\n                        $this->Flash->error(__('Invalid e-mail domain. Your user is restricted to creating users for the following domain(s): ') . implode(', ', $organisation['Organisation']['restricted_to_domain']));\n                    }\n                }\n            }\n            if (!$fail) {\n                if (empty($organisation)) {\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'admin_add', false, array('Invalid organisation'), $this->response->type());\n                    } else {\n                        // reset auth key for a new user\n                        $this->set('authkey', $this->newkey);\n                        $this->Flash->error(__('The user could not be saved. Invalid organisation.'));\n                    }\n                } else {\n                    $fieldList = array('password', 'email', 'external_auth_required', 'external_auth_key', 'enable_password', 'confirm_password', 'org_id', 'role_id', 'authkey', 'nids_sid', 'server_id', 'gpgkey', 'certif_public', 'autoalert', 'contactalert', 'disabled', 'invited_by', 'change_pw', 'termsaccepted', 'newsread', 'date_created', 'date_modified');\n                    if ($this->User->save($this->request->data, true, $fieldList)) {\n                        $notification_message = '';\n                        if (!empty($this->request->data['User']['notify'])) {\n                            $user = $this->User->find('first', array('conditions' => array('User.id' => $this->User->id), 'recursive' => -1));\n                            $password = isset($this->request->data['User']['password']) ? $this->request->data['User']['password'] : false;\n                            $result = $this->User->initiatePasswordReset($user, true, true, $password);\n                            if ($result && empty(Configure::read('MISP.disable_emailing'))) {\n                                $notification_message .= ' ' . __('User notified of new credentials.');\n                            } else {\n                                $notification_message .= ' ' . __('User notification of new credentials could not be send.');\n                            }\n                        }\n                        if (!empty(Configure::read('Security.advanced_authkeys')) && $this->_isRest()) {\n                            $this->loadModel('AuthKey');\n                            $newKey = $this->AuthKey->createnewkey($this->User->id);\n                        }\n                        if ($this->_isRest()) {\n                            $user = $this->User->find('first', array(\n                                    'conditions' => array('User.id' => $this->User->id),\n                                    'recursive' => -1\n                            ));\n                            $user['User']['password'] = '******';\n                            if (!empty(Configure::read('Security.advanced_authkeys'))) {\n                                $user['User']['authkey'] = $newKey;\n                            }\n                            return $this->RestResponse->viewData($user, $this->response->type());\n                        } else {\n                            $this->Flash->success(__('The user has been saved.') . $notification_message);\n                            $this->redirect(array('action' => 'index'));\n                        }\n                    } else {\n                        if ($this->_isRest()) {\n                            return $this->RestResponse->saveFailResponse('Users', 'admin_add', false, $this->User->validationErrors, $this->response->type());\n                        } else {\n                            // reset auth key for a new user\n                            $this->set('authkey', $this->newkey);\n                            $this->Flash->error(__('The user could not be saved. Please, try again.'));\n                        }\n                    }\n                }\n            }\n        }\n        if (!$this->_isRest()) {\n            $this->newkey = $this->User->generateAuthKey();\n            $this->set('authkey', $this->newkey);\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->describe('Users', 'admin_add', false, $this->response->type());\n        } else {\n            $orgs = $this->User->Organisation->find('list', array(\n                    'conditions' => array('local' => 1),\n                    'order' => array('lower(name) asc')\n            ));\n            $this->set('orgs', $orgs);\n            // generate auth key for a new user\n            $this->loadModel('Server');\n            $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n            $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n            $conditions = array();\n            if (!$this->_isSiteAdmin()) {\n                $conditions['Server.org_id LIKE'] = $this->Auth->user('org_id');\n            }\n            $temp = $this->Server->find('all', array('conditions' => $conditions, 'recursive' => -1, 'fields' => array('id', 'name', 'url')));\n            $servers = array(0 => 'Not bound to a server');\n            if (!empty($temp)) {\n                foreach ($temp as $t) {\n                    if (!empty($t['Server']['name'])) {\n                        $servers[$t['Server']['id']] = $t['Server']['name'];\n                    } else {\n                        $servers[$t['Server']['id']] = $t['Server']['url'];\n                    }\n                }\n            }\n            $this->set('currentOrg', $this->Auth->user('org_id'));\n            $this->set('isSiteAdmin', $this->_isSiteAdmin());\n            $this->set('default_role_id', $default_role_id);\n            $this->set('servers', $servers);\n            $this->set(compact('roles'));\n            $this->set(compact('syncRoles'));\n        }\n    }\n\n    public function admin_edit($id = null)\n    {\n        $this->set('currentOrg', $this->Auth->user('org_id'));\n        $this->User->id = $id;\n        $params = array();\n        $allowedRole = '';\n        $userToEdit = $this->User->find('first', array(\n            'conditions' => array('User.id' => $id),\n            'recursive' => -1,\n            'fields' => array('User.id', 'User.role_id', 'User.email', 'User.org_id', 'Role.perm_site_admin'),\n            'contain' => array('Role')\n        ));\n        if (empty($userToEdit)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        if (!$this->_isSiteAdmin()) {\n            // Org admins should be able to select the role that is already assigned to an org user when editing them.\n            // What happened previously:\n            // Org admin edits another org admin of the same org\n            // Org admin is not allowed to set privileged access roles (site_admin/sync/regex)\n            // MISP automatically chooses the first available option for the user as the selected setting (usually user)\n            // Org admin is downgraded to a user\n            // Now we make an exception for the already assigned role, both in the form and the actual edit.\n            if ($userToEdit['User']['org_id'] != $this->Auth->user('org_id') || !empty($userToEdit['Role']['perm_site_admin'])) {\n                throw new NotFoundException(__('Invalid user'));\n            }\n            $allowedRole = $userToEdit['User']['role_id'];\n            $params = array('conditions' => array(\n                    'OR' => array(\n                            'AND' => array(\n                                'perm_site_admin' => 0, 'perm_sync' => 0, 'perm_regexp_access' => 0, 'restricted_to_site_admin' => 0\n                            ),\n                            'id' => $allowedRole,\n                    )\n            ));\n        }\n        $roles = $this->User->Role->find('list', $params);\n        $syncRoles = $this->User->Role->find('list', array('conditions' => array('perm_sync' => 1), 'recursive' => -1));\n        $this->set('currentId', $id);\n        if ($this->request->is('post') || $this->request->is('put')) {\n            if (!isset($this->request->data['User'])) {\n                $this->request->data['User'] = $this->request->data;\n            }\n            $abortPost = false;\n            if (!$this->_isRest()) {\n                if (Configure::read('Security.require_password_confirmation')) {\n                    if (!empty($this->request->data['User']['current_password'])) {\n                        $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['current_password']);\n                        if (!$hashed) {\n                            $abortPost = true;\n                            $this->Flash->error('Invalid password. Please enter your current password to continue.');\n                        }\n                        unset($this->request->data['User']['current_password']);\n                    } else {\n                        $abortPost = true;\n                        $this->Flash->info('Please enter your current password to continue.');\n                    }\n                }\n            }\n            if (!$this->_isSiteAdmin() && !$abortPost) {\n                $organisation = $this->User->Organisation->find('first', array(\n                    'conditions' => array('Organisation.id' => $userToEdit['User']['org_id']),\n                    'recursive' => -1\n                ));\n                if (!empty($organisation['Organisation']['restricted_to_domain'])) {\n                    $abortPost = true;\n                    foreach ($organisation['Organisation']['restricted_to_domain'] as $restriction) {\n                        if (\n                            strlen($this->request->data['User']['email']) > strlen($restriction) &&\n                            substr($this->request->data['User']['email'], (-1 * strlen($restriction))) === $restriction &&\n                            in_array($this->request->data['User']['email'][strlen($this->request->data['User']['email']) - strlen($restriction) -1], array('@', '.'))\n                        ) {\n                            $abortPost = false;\n                        }\n                    }\n                    if ($abortPost) {\n                        $this->Flash->error(__('Invalid e-mail domain. Your user is restricted to creating users for the following domain(s): ') . implode(', ', $organisation['Organisation']['restricted_to_domain']));\n                    }\n                }\n            }\n            if (!$abortPost) {\n                $this->request->data['User']['id'] = $id;\n                if (!isset($this->request->data['User']['email'])) {\n                    $this->request->data['User']['email'] = $userToEdit['User']['email'];\n                }\n                if (isset($this->request->data['User']['role_id']) && !array_key_exists($this->request->data['User']['role_id'], $syncRoles)) {\n                    $this->request->data['User']['server_id'] = 0;\n                }\n                $fields = [];\n                $blockedFields = array('id', 'invited_by', 'date_modified');\n                if (!$this->_isSiteAdmin()) {\n                    $blockedFields[] = 'org_id';\n                }\n                if (!$this->__canChangeLogin()) {\n                    $blockedFields[] = 'email';\n                }\n                if (!$this->__canChangePassword()) {\n                    $blockedFields[] = 'enable_password';\n                    $blockedFields[] = 'change_pw';\n                }\n                foreach (array_keys($this->request->data['User']) as $field) {\n                    if (in_array($field, $blockedFields)) {\n                        continue;\n                    }\n                    if ($field != 'password') {\n                        $fields[] = $field;\n                    }\n                }\n                if (\n                    (!empty($this->request->data['User']['enable_password']) || $this->_isRest()) &&\n                    !empty($this->request->data['User']['password']) &&\n                    $this->__canChangePassword()\n                ) {\n                    $fields[] = 'password';\n                    if ($this->_isRest() && !isset($this->request->data['User']['confirm_password'])) {\n                        $this->request->data['User']['confirm_password'] = $this->request->data['User']['password'];\n                        $fields[] = 'confirm_password';\n                    }\n                }\n                if (!$this->_isRest()) {\n                    $fields[] = 'role_id';\n                }\n                if (!$this->_isSiteAdmin() && isset($this->request->data['User']['role_id'])) {\n                    $this->loadModel('Role');\n                    $this->Role->recursive = -1;\n                    $chosenRole = $this->Role->findById($this->request->data['User']['role_id']);\n                    if (empty($chosenRole) || (($chosenRole['Role']['id'] != $allowedRole) && ($chosenRole['Role']['perm_site_admin'] == 1 || $chosenRole['Role']['perm_regexp_access'] == 1 || $chosenRole['Role']['perm_sync'] == 1))) {\n                        throw new Exception('You are not authorised to assign that role to a user.');\n                    }\n                }\n                $fields[] = 'date_modified'; // time will be inserted in `beforeSave` action\n\n                $fieldsOldValues = $this->User->find('first', [\n                    'recursive' => -1,\n                    'conditions' => ['id' => $id],\n                ])['User'];\n\n                if ($this->User->save($this->request->data, true, $fields)) {\n                    // newValues to array\n                    $fieldsNewValues = array();\n                    foreach ($fields as $field) {\n                        if ($field === 'date_modified') {\n                            continue;\n                        }\n                        if ($field !== 'confirm_password') {\n                            $newValue = $this->data['User'][$field];\n                            if (is_array($newValue)) {\n                                $newValueStr = '';\n                                $cP = 0;\n                                foreach ($newValue as $newValuePart) {\n                                    if ($cP < 2) {\n                                        $newValueStr .= '-' . $newValuePart;\n                                    } else {\n                                        $newValueStr = $newValuePart . $newValueStr;\n                                    }\n                                    $cP++;\n                                }\n                                $fieldsNewValues[$field] = $newValueStr;\n                            } else {\n                                $fieldsNewValues[$field] = $newValue;\n                            }\n                        } else {\n                            $fieldsNewValues[$field] = $this->data['User']['password'];\n                        }\n                    }\n                    // compare\n                    $fieldsResult = array();\n                    foreach ($fields as $field) {\n                        if ($field === 'date_modified') {\n                            continue;\n                        }\n                        if (isset($fieldsOldValues[$field]) && $fieldsOldValues[$field] != $fieldsNewValues[$field]) {\n                            if ($field != 'confirm_password' && $field != 'enable_password') {\n                                $fieldsResult[$field] = array($fieldsOldValues[$field], $fieldsNewValues[$field]);\n                            }\n                        }\n                    }\n                    $user = $this->User->find('first', array(\n                        'recursive' => -1,\n                        'conditions' => array('User.id' => $this->User->id)\n                    ));\n                    $this->User->extralog($this->Auth->user(), \"edit\", \"user\", $fieldsResult, $user);\n                    if ($this->_isRest()) {\n                        $user['User']['password'] = '******';\n                        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n                            unset($user['User']['authkey']);\n                        }\n                        return $this->RestResponse->viewData($user, $this->response->type());\n                    } else {\n                        $this->Flash->success(__('The user has been saved'));\n                        $this->redirect(array('action' => 'index'));\n                    }\n                } else {\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'admin_edit', $id, $this->User->validationErrors, $this->response->type());\n                    } else {\n                        $this->Flash->error(__('The user could not be saved. Please, try again.'));\n                    }\n                }\n            }\n        } else {\n            if ($this->_isRest()) {\n                return $this->RestResponse->describe('Users', 'admin_edit', $id, $this->response->type());\n            }\n            $this->User->read(null, $id);\n            if (!$this->_isSiteAdmin() && $this->Auth->user('org_id') != $this->User->data['User']['org_id']) {\n                $this->redirect(array('controller' => 'users', 'action' => 'index', 'admin' => true));\n            }\n            $this->User->set('password', '');\n            $this->request->data = $this->User->data;\n        }\n        if ($this->_isSiteAdmin()) {\n            $orgs = $this->User->Organisation->find('list', array(\n                    'conditions' => array('local' => 1),\n                    'order' => array('lower(name) asc')\n            ));\n        } else {\n            $orgs = array();\n        }\n        $this->loadModel('Server');\n        $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n        $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n        $conditions = array();\n        if (!$this->_isSiteAdmin()) {\n            $conditions['Server.org_id LIKE'] = $this->Auth->user('org_id');\n        }\n        $temp = $this->Server->find('all', array('conditions' => $conditions, 'recursive' => -1, 'fields' => array('id', 'name', 'url')));\n        $servers = array(0 => 'Not bound to a server');\n        foreach ($temp as $t) {\n            if (!empty($t['Server']['name'])) {\n                $servers[$t['Server']['id']] = $t['Server']['name'];\n            } else {\n                $servers[$t['Server']['id']] = $t['Server']['url'];\n            }\n        }\n        $this->set('servers', $servers);\n        $this->set('orgs', $orgs);\n        $this->set('id', $id);\n        $this->set(compact('roles'));\n        $this->set(compact('syncRoles'));\n        $this->set('canChangeLogin', $this->__canChangeLogin());\n        $this->set('canChangePassword', $this->__canChangePassword());\n    }\n\n    public function admin_delete($id = null)\n    {\n        if (!$this->request->is('post') && !$this->request->is('delete')) {\n            throw new MethodNotAllowedException(__('Action not allowed, post or delete request expected.'));\n        }\n        if (!$this->_isAdmin()) {\n            throw new Exception('Administrators only.');\n        }\n        $this->User->id = $id;\n        $conditions = array('User.id' => $id);\n        if (!$this->_isSiteAdmin()) {\n            $conditions['org_id'] = $this->Auth->user('org_id');\n        }\n        $user = $this->User->find('first', array(\n                'conditions' => $conditions,\n                'recursive' => -1\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        $fieldsDescrStr = 'User (' . $id . '): ' . $user['User']['email'];\n        if ($this->User->delete($id)) {\n            $this->User->extralog($this->Auth->user(), \"delete\", $fieldsDescrStr, '');\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveSuccessResponse('User', 'admin_delete', $id, $this->response->type(), 'User deleted.');\n            } else {\n                $this->Flash->success(__('User deleted'));\n                $this->redirect(array('action' => 'index'));\n            }\n        }\n        $this->Flash->error(__('User was not deleted'));\n        $this->redirect(array('action' => 'index'));\n    }\n\n    public function admin_massToggleField($fieldName, $enabled)\n    {\n        if (!in_array($fieldName, $this->toggleableFields)) {\n            throw new MethodNotAllowedException(__('The field `%s` cannot be toggled', $fieldName));\n        }\n        if (!$this->_isAdmin()) {\n            throw new UnauthorizedException(__('Administrators only'));\n        }\n        if ($this->request->is('post') || $this->request->is('put')) {\n            $jsonIds = $this->request->data['User']['user_ids'];\n            $ids = $this->User->jsonDecode($jsonIds);\n            $conditions = ['User.id' => $ids];\n            if (!$this->_isSiteAdmin()) {\n                $conditions['User.org_id'] = $this->Auth->user('org_id');\n            }\n            $users = $this->User->find('all', [\n                    'conditions' => $conditions,\n                    'recursive' => -1\n            ]);\n            if (empty($users)) {\n                throw new NotFoundException(__('Invalid users'));\n            }\n            $count = 0;\n            foreach ($users as $user) {\n                if ($user['User'][$fieldName] != $enabled) {\n                    $this->User->id = $user['User']['id'];\n                    $this->User->saveField($fieldName, $enabled);\n                    $count++;\n                }\n            }\n            if ($count > 0) {\n                $message = __('%s users got their field `%s` %s', $count, $fieldName, $enabled ? __('enabled') : __('disabled'));\n            } else {\n                $message = __('All users have already their field `%s` %s', $fieldName, $enabled ? __('enabled') : __('disabled'));\n            }\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveSuccessResponse('User', 'admin_massToggleField', 'selected', $this->response->type(), $message);\n            } else {\n                if ($count > 0) {\n                    $this->Flash->success($message);\n                } else {\n                    $this->Flash->info($message);\n                }\n                $this->redirect('/admin/users/index');\n            }\n        }\n    }\n\n    public function updateLoginTime()\n    {\n        if (!$this->request->is('post')) {\n            throw new MethodNotAllowedException('This feature is only accessible via POST requests');\n        }\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $this->Auth->user('id'))\n        ));\n        $this->User->id = $this->Auth->user('id');\n        $this->User->saveField('last_login', time());\n        $this->User->saveField('current_login', time());\n        $user = $this->User->getAuthUser($user['User']['id']);\n        $this->Auth->login($user);\n        $this->redirect(array('Controller' => 'User', 'action' => 'dashboard'));\n    }\n\n    public function login()\n    {\n        $oldHash = false;\n        if ($this->request->is('post') || $this->request->is('put')) {\n            $this->Bruteforce = ClassRegistry::init('Bruteforce');\n            if (!empty($this->request->data['User']['email'])) {\n                if ($this->Bruteforce->isBlocklisted($_SERVER['REMOTE_ADDR'], $this->request->data['User']['email'])) {\n                    $expire = Configure::check('SecureAuth.expire') ? Configure::read('SecureAuth.expire') : 300;\n                    throw new ForbiddenException('You have reached the maximum number of login attempts. Please wait ' . $expire . ' seconds and try again.');\n                }\n            }\n            // Check the length of the user's authkey match old format. This can be removed in future.\n            $userPass = $this->User->find('first', [\n                'conditions' => ['User.email' => $this->request->data['User']['email']],\n                'fields' => ['User.password'],\n                'recursive' => -1,\n            ]);\n            if (!empty($userPass) && strlen($userPass['User']['password']) === 40) {\n                $oldHash = true;\n                unset($this->Auth->authenticate['Form']['passwordHasher']); // use default password hasher\n                $this->Auth->constructAuthenticate();\n            }\n        }\n        if ($this->request->is('post') && Configure::read('Security.email_otp_enabled')) {\n            $user = $this->Auth->identify($this->request, $this->response);\n            if ($user && !$user['disabled']) {\n              $this->Session->write('email_otp_user', $user);\n              return $this->redirect('email_otp');\n            }\n        }\n        $formLoginEnabled = isset($this->Auth->authenticate['Form']);\n        $this->set('formLoginEnabled', $formLoginEnabled);\n\n        if ($this->Auth->login()) {\n            if ($oldHash) {\n                // Convert old style password hash to blowfish\n                $passwordToSave = $this->request->data['User']['password'];\n                // Password is converted to hashed form automatically\n                $this->User->save(['id' => $this->Auth->user('id'), 'password' => $passwordToSave], false, ['password']);\n            }\n            $this->_postlogin();\n        } else {\n            $dataSourceConfig = ConnectionManager::getDataSource('default')->config;\n            $dataSource = $dataSourceConfig['datasource'];\n            // don't display authError before first login attempt\n            if (str_replace(\"//\", \"/\", $this->webroot . $this->Session->read('Auth.redirect')) == $this->webroot && $this->Session->read('Message.auth.message') == $this->Auth->authError) {\n                $this->Session->delete('Message.auth');\n            }\n            // don't display \"invalid user\" before first login attempt\n            if ($this->request->is('post') || $this->request->is('put')) {\n                $this->Flash->error(__('Invalid username or password, try again'));\n                if (isset($this->request->data['User']['email'])) {\n                    $this->Bruteforce->insert($_SERVER['REMOTE_ADDR'], $this->request->data['User']['email']);\n                }\n            }\n            // populate the DB with the first role (site admin) if it's empty\n            if (!$this->User->Role->hasAny()) {\n                $siteAdmin = array('Role' => array(\n                    'id' => 1,\n                    'name' => 'Site Admin',\n                    'permission' => 3,\n                    'perm_add' => 1,\n                    'perm_modify' => 1,\n                    'perm_modify_org' => 1,\n                    'perm_publish' => 1,\n                    'perm_sync' => 1,\n                    'perm_admin' => 1,\n                    'perm_audit' => 1,\n                    'perm_auth' => 1,\n                    'perm_site_admin' => 1,\n                    'perm_regexp_access' => 1,\n                    'perm_sharing_group' => 1,\n                    'perm_template' => 1,\n                    'perm_tagger' => 1,\n                ));\n                $this->User->Role->save($siteAdmin);\n                // PostgreSQL: update value of auto incremented serial primary key after setting the column by force\n                if ($dataSource === 'Database/Postgres') {\n                    $sql = \"SELECT setval('roles_id_seq', (SELECT MAX(id) FROM roles));\";\n                    $this->User->Role->query($sql);\n                }\n            }\n            if (!$this->User->Organisation->hasAny(array('Organisation.local' => true))) {\n                $this->User->runUpdates();\n                $date = date('Y-m-d H:i:s');\n                $org = array('Organisation' => array(\n                        'id' => 1,\n                        'name' => !empty(Configure::read('MISP.org')) ? Configure::read('MISP.org') : 'ADMIN',\n                        'description' => 'Automatically generated admin organisation',\n                        'type' => 'ADMIN',\n                        'uuid' => CakeText::uuid(),\n                        'local' => 1,\n                        'date_created' => $date,\n                        'sector' => '',\n                        'nationality' => ''\n                ));\n                $this->User->Organisation->save($org);\n                // PostgreSQL: update value of auto incremented serial primary key after setting the column by force\n                if ($dataSource === 'Database/Postgres') {\n                    $sql = \"SELECT setval('organisations_id_seq', (SELECT MAX(id) FROM organisations));\";\n                    $this->User->Organisation->query($sql);\n                }\n                $org_id = $this->User->Organisation->id;\n            }\n\n            // populate the DB with the first user if it's empty\n            if (!$this->User->hasAny()) {\n                if (!isset($org_id)) {\n                    $hostOrg = $this->User->Organisation->find('first', array('conditions' => array('Organisation.name' => Configure::read('MISP.org'), 'Organisation.local' => true), 'recursive' => -1));\n                    if (!empty($hostOrg)) {\n                        $org_id = $hostOrg['Organisation']['id'];\n                    } else {\n                        $firstOrg = $this->User->Organisation->find('first', array('conditions' => array('Organisation.local' => true), 'order' => 'Organisation.id ASC'));\n                        $org_id = $firstOrg['Organisation']['id'];\n                    }\n                }\n\n                $this->User->runUpdates();\n                $this->User->createInitialUser($org_id);\n            }\n        }\n    }\n\n    private function _postlogin()\n    {\n      $this->User->extralog($this->Auth->user(), \"login\");\n      $this->User->Behaviors->disable('SysLogLogable.SysLogLogable');\n      $this->User->id = $this->Auth->user('id');\n      $user = $this->User->find('first', array(\n          'conditions' => array(\n              'User.id' => $this->Auth->user('id')\n          ),\n          'recursive' => -1\n      ));\n      unset($user['User']['password']);\n      $this->User->updateLoginTimes($user['User']);\n      $lastUserLogin = $user['User']['last_login'];\n      $this->User->Behaviors->enable('SysLogLogable.SysLogLogable');\n      if ($lastUserLogin) {\n          $readableDatetime = (new DateTime())->setTimestamp($lastUserLogin)->format('D, d M y H:i:s O'); // RFC822\n          $this->Flash->info(__('Welcome! Last login was on %s', $readableDatetime));\n      }\n      // no state changes are ever done via GET requests, so it is safe to return to the original page:\n      $this->redirect($this->Auth->redirectUrl());\n    }\n\n    public function routeafterlogin()\n    {\n        // Events list\n        $url = $this->Session->consume('pre_login_requested_url');\n        if (!empty(Configure::read('MISP.forceHTTPSforPreLoginRequestedURL')) && !empty($url)) {\n            if (substr($url, 0, 7) === \"http://\") {\n                $url = sprintf('https://%s', substr($url, 7));\n            }\n        }\n        if (empty($url)) {\n            $homepage = $this->User->UserSetting->getValueForUser($this->Auth->user('id'), 'homepage');\n            if (!empty($homepage)) {\n                $url = $homepage['path'];\n            } else {\n                $url = array('controller' => 'events', 'action' => 'index');\n            }\n        }\n        $this->redirect($url);\n    }\n\n    public function logout()\n    {\n        if ($this->Session->check('Auth.User')) {\n            $this->User->extralog($this->Auth->user(), \"logout\");\n        }\n        if (!Configure::read('Plugin.CustomAuth_custom_logout')) {\n            $this->Flash->info(__('Good-Bye'));\n        }\n        $user = $this->User->find('first', array(\n            'conditions' => array(\n                'User.id' => $this->Auth->user('id')\n            ),\n            'recursive' => -1\n        ));\n        unset($user['User']['password']);\n        $user['User']['action'] = 'logout';\n        $this->User->save($user['User'], true, array('id'));\n        $this->redirect($this->Auth->logout());\n    }\n\n    public function resetauthkey($id = null, $alert = false)\n    {\n        if (!$this->request->is('post') && !$this->request->is('put')) {\n            throw new MethodNotAllowedException(__('This functionality is only accessible via POST requests.'));\n        }\n        if ($id === 'me') {\n            $id = $this->Auth->user('id');\n            // Reset just current auth key\n            $keyId = isset($this->Auth->user()['authkey_id']) ? $this->Auth->user()['authkey_id'] : null;\n        } else {\n            $keyId = null;\n        }\n        $newkey = $this->User->resetauthkey($this->Auth->user(), $id, $alert, $keyId);\n        if ($newkey === false) {\n            throw new MethodNotAllowedException(__('Invalid user.'));\n        }\n        if (!$this->_isRest()) {\n            $this->Flash->success(__('New authkey generated.'));\n            $this->redirect($this->referer());\n        } else {\n            return $this->RestResponse->saveSuccessResponse('User', 'resetauthkey', $id, $this->response->type(), 'Authkey updated: ' . $newkey);\n        }\n    }\n\n    public function resetAllSyncAuthKeys()\n    {\n        if (!$this->request->is('post')) {\n            throw new MethodNotAllowedException(__('This functionality is only accessible via POST requests.'));\n        }\n        $results = $this->User->resetAllSyncAuthKeysRouter($this->Auth->user());\n        if ($results === true) {\n            $message = __('Job initiated.');\n        } else {\n            $message = __('%s authkeys reset, %s could not be reset.', $results['success'], $results['fails']);\n        }\n        if (!$this->_isRest()) {\n            $this->Flash->info($message);\n            $this->redirect($this->referer());\n        } else {\n            return $this->RestResponse->saveSuccessResponse('User', 'resetAllSyncAuthKeys', false, $this->response->type(), $message);\n        }\n    }\n\n    public function histogram($selected = null)\n    {\n        //if (!$this->request->is('ajax') && !$this->_isRest()) throw new MethodNotAllowedException('This function can only be accessed via AJAX or the API.');\n        if ($selected == '[]') {\n            $selected = null;\n        }\n        $selectedTypes = array();\n        if ($selected) {\n            $selectedTypes = json_decode($selected);\n        }\n        if (!$this->_isSiteAdmin() && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n            $org_ids = array($this->Auth->user('org_id'));\n        } else {\n            $org_ids = $this->User->Event->find('column', array(\n                'fields' => array('Event.orgc_id'),\n                'unique' => true,\n            ));\n        }\n        $orgs_temp = $this->User->Organisation->find('list', array(\n            'fields' => array('Organisation.id', 'Organisation.name'),\n            'conditions' => array('Organisation.id' => $org_ids)\n        ));\n        $orgs = array(0 => 'All organisations');\n        foreach ($org_ids as $v) {\n            if (!empty($orgs_temp[$v])) {\n                $orgs[$v] = $orgs_temp[$v];\n            }\n        }\n        $data = array();\n        $max = 1;\n        foreach ($orgs as $org_id => $org_name) {\n            $conditions = array('Attribute.deleted' => 0);\n            if ($selected) {\n                $conditions['Attribute.type'] = $selectedTypes;\n            }\n            if ($org_id != 0) {\n                $conditions['Event.orgc_id'] = $org_id;\n            }\n            $params = array(\n                'recursive' => -1,\n                'fields' => array('Attribute.type', 'COUNT(*) as num_types'),\n                'group' => array('Attribute.type'),\n                'joins' => array(\n                    array(\n                        'table' => 'events',\n                        'alias' => 'Event',\n                        'type' => 'LEFT',\n                        'conditions' => array(\n                            'Attribute.event_id = Event.id'\n                        )\n                    )\n                ),\n                //'order' => array('num_types DESC'),\n                'conditions' => $conditions,\n                'order' => false\n            );\n            if ($org_id == 0) {\n                unset($params['joins']);\n            }\n            $temp = $this->User->Event->Attribute->find('all', $params);\n            $temp = Hash::combine($temp, '{n}.Attribute.type', '{n}.0.num_types');\n            $total = 0;\n            foreach ($temp as $v) {\n                $v = (int) $v;\n                if ($v > $max) {\n                    $max = $v;\n                }\n                $total += $v;\n            }\n            $data[$org_id] = [\n                'data' => $temp,\n                'org_name' => $org_name,\n                'total' => $total,\n            ];\n        }\n        uasort($data, function ($a, $b) {\n            return $b['total'] - $a['total'];\n        });\n        $data = array_values($data);\n\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($data, $this->response->type());\n        }\n\n        $this->set('data', $data);\n        $this->set('max', $max);\n        $this->set('selectedTypes', $selectedTypes);\n\n        // Nice graphical histogram\n        $sigTypes = array_keys($this->User->Event->Attribute->typeDefinitions);\n        App::uses('ColourPaletteTool', 'Tools');\n        $paletteTool = new ColourPaletteTool();\n        $colours = $paletteTool->createColourPalette(count($sigTypes));\n        $typeDb = array();\n        foreach ($sigTypes as $k => $type) {\n            $typeDb[$type] = $colours[$k];\n        }\n\n        $this->set('typeDb', $typeDb);\n        $this->set('sigTypes', $sigTypes);\n        $this->layout = 'ajax';\n    }\n\n    public function terms()\n    {\n        if ($this->request->is('post') || $this->request->is('put')) {\n            $this->User->updateField($this->Auth->user(), 'termsaccepted', true);\n            $this->Flash->success(__('You accepted the Terms and Conditions.'));\n            $this->redirect(array('action' => 'routeafterlogin'));\n        }\n        $this->set('termsaccepted', $this->Auth->user('termsaccepted'));\n    }\n\n    public function downloadTerms()\n    {\n        if (!Configure::read('MISP.terms_file')) {\n            $termsFile = APP .\"View/Users/terms\";\n        } else {\n            $termsFile = APP . 'files' . DS . 'terms' . DS .  Configure::read('MISP.terms_file');\n        }\n        $this->response->file($termsFile, array('download' => true, 'name' => Configure::read('MISP.terms_file')));\n        return $this->response;\n    }\n\n    public function checkAndCorrectPgps()\n    {\n        if (!self::_isAdmin()) {\n            throw new NotFoundException();\n        }\n        $this->set('fails', $this->User->checkAndCorrectPgps());\n    }\n\n    public function admin_quickEmail($user_id)\n    {\n        if (!$this->_isAdmin()) {\n            throw new MethodNotAllowedException();\n        }\n        $conditions = array('User.id' => $user_id);\n        if (!$this->_isSiteAdmin()) {\n            $conditions['User.org_id'] = $this->Auth->user('org_id');\n        }\n        $user = $this->User->find('first', array(\n            'conditions' => $conditions,\n            'recursive' => -1\n        ));\n        $error = false;\n        if (empty($user)) {\n            $error = 'Invalid user.';\n        }\n        if (!$error && $user['User']['disabled']) {\n            $error = 'Cannot send an e-mail to this user as the account is disabled.';\n        }\n        $encryption = false;\n        if (!$error && !empty($user['User']['gpgkey'])) {\n            $encryption = 'PGP';\n        } elseif (!$error && !empty($user['User']['certif_public'])) {\n            $encryption = 'SMIME';\n        }\n        $this->set('encryption', $encryption);\n        if (!$error && !$encryption && (Configure::read('GnuPG.onlyencrypted') || Configure::read('GnuPG.bodyonlyencrypted'))) {\n            $error = 'No encryption key found for the user and the instance posture blocks non encrypted e-mails from being sent.';\n        }\n        if ($error) {\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveFailResponse('Users', 'admin_quickEmail', false, $error, $this->response->type());\n            } else {\n                $this->Flash->error($error);\n                $this->redirect('/admin/users/view/' . $user_id);\n            }\n        }\n        if ($this->request->is('post')) {\n            if (!isset($this->request->data['User'])) {\n                $this->request->data['User'] = $this->request->data;\n            }\n            if (empty($this->request->data['User']['subject']) || empty($this->request->data['User']['body'])) {\n                $message = 'Both the subject and the body have to be set.';\n                if ($this->_isRest()) {\n                    throw new MethodNotAllowedException($message);\n                } else {\n                    $this->Flash->error($message);\n                    $this->redirect('/admin/users/quickEmail/' . $user_id);\n                }\n            }\n            $result = $this->User->sendEmail($user, $this->request->data['User']['body'], false, $this->request->data['User']['subject']);\n            if ($this->_isRest()) {\n                if ($result) {\n                    return $this->RestResponse->saveSuccessResponse('User', 'admin_quickEmail', $id, $this->response->type(), 'User deleted.');\n                } else {\n                    return $this->RestResponse->saveFailResponse('Users', 'admin_quickEmail', false, $this->User->validationErrors, $this->response->type());\n                }\n            } else {\n                if ($result) {\n                    $this->Flash->success('Email sent.');\n                } else {\n                    $this->Flash->error('Could not send e-mail.');\n                }\n                $this->redirect('/admin/users/view/' . $user_id);\n            }\n        } elseif ($this->_isRest()) {\n            return $this->RestResponse->describe('Users', 'admin_quickEmail', false, $this->response->type());\n        }\n        $this->set('encryption', $encryption);\n        $this->set('user', $user);\n    }\n\n    public function admin_email($isPreview=false)\n    {\n        if (!$this->_isAdmin()) {\n            throw new MethodNotAllowedException();\n        }\n        $isPostOrPut = $this->request->is('post') || $this->request->is('put');\n        $conditions = array();\n        if (!$this->_isSiteAdmin()) {\n            $conditions = array('org_id' => $this->Auth->user('org_id'));\n        }\n\n        // harvest parameters\n        if ($isPostOrPut) {\n            $recipient = $this->request->data['User']['recipient'];\n        } else {\n            $recipient = isset($this->params['named']['recipient']) ? $this->params['named']['recipient'] : null;\n        }\n        if ($isPostOrPut) {\n            $recipientEmailList = $this->request->data['User']['recipientEmailList'];\n        } else {\n            $recipientEmailList = isset($this->params['named']['recipientEmailList']) ? $this->params['named']['recipientEmailList'] : null;\n        }\n        if ($isPostOrPut) {\n            $orgNameList = $this->request->data['User']['orgNameList'];\n        } else {\n            $orgNameList = isset($this->params['named']['orgNameList']) ? $this->params['named']['orgNameList'] : null;\n        }\n\n        if (!is_null($recipient) && $recipient == 0) {\n            if (is_null($recipientEmailList)) {\n                throw new NotFoundException(__('Recipient email not provided'));\n            }\n            $conditions['id'] = $recipientEmailList;\n        } elseif (!is_null($recipient) && $recipient == 2) {\n            if (is_null($orgNameList)) {\n                throw new NotFoundException(__('Recipient organisation not provided'));\n            }\n            $conditions['org_id'] = $orgNameList;\n        }\n        $conditions['AND'][] = array('User.disabled' => 0);\n\n        // Allow to mimic real form post\n        if ($isPreview) {\n            $users = $this->User->find('list', array('recursive' => -1, 'order' => array('email ASC'), 'conditions' => $conditions, 'fields' => array('email')));\n            $this->set('emails', $users);\n            $this->set('emailsCount', count($users));\n            $this->render('ajax/emailConfirmTemplate');\n        } else {\n            $users = $this->User->find('all', array('recursive' => -1, 'order' => array('email ASC'), 'conditions' => $conditions));\n            // User has filled in his contact form, send out the email.\n            if ($isPostOrPut) {\n                $this->request->data['User']['message'] = $this->User->adminMessageResolve($this->request->data['User']['message']);\n                $failures = '';\n                foreach ($users as $user) {\n                    $password = $this->User->generateRandomPassword();\n                    $body = str_replace('$password', $password, $this->request->data['User']['message']);\n                    $body = str_replace('$username', $user['User']['email'], $body);\n                    $result = $this->User->sendEmail($user, $body, false, $this->request->data['User']['subject']);\n                    // if sending successful and action was a password change, update the user's password.\n                    if ($result && $this->request->data['User']['action'] != '0') {\n                        $this->User->id = $user['User']['id'];\n                        $this->User->saveField('password', $password);\n                        $this->User->saveField('change_pw', '1');\n                    }\n                    if (!$result) {\n                        if ($failures != '') {\n                            $failures .= ', ';\n                        }\n                        $failures .= $user['User']['email'];\n                    }\n                }\n                if ($failures != '') {\n                    $this->Flash->success(__('E-mails sent, but failed to deliver the messages to the following recipients: ' . $failures));\n                } else {\n                    $this->Flash->success(__('E-mails sent.'));\n                }\n            }\n            $conditions = array();\n            if (!$this->_isSiteAdmin()) {\n                $conditions = array('org_id' => $this->Auth->user('org_id'));\n            }\n            $conditions['User.disabled'] = 0;\n            $temp = $this->User->find('all', array('recursive' => -1, 'fields' => array('id', 'email', 'Organisation.name'), 'order' => array('email ASC'), 'conditions' => $conditions, 'contain' => array('Organisation')));\n            $emails = array();\n            $orgName = array();\n            // save all the emails of the users and set it for the dropdown list in the form\n            foreach ($temp as $user) {\n                $emails[$user['User']['id']] = $user['User']['email'];\n                $orgName[$user['Organisation']['id']] = $user['Organisation']['name'];\n            }\n\n            $this->set('users', $temp);\n            $this->set('recipientEmail', $emails);\n            $this->set('orgName', $orgName);\n            $this->set('org', Configure::read('MISP.org'));\n            $textsToFetch = array('newUserText', 'passwordResetText');\n            $this->loadModel('Server');\n            foreach ($textsToFetch as $text) {\n                ${$text} = Configure::read('MISP.' . $text);\n                if (!${$text}) {\n                    ${$text} = $this->Server->serverSettings['MISP'][$text]['value'];\n                }\n                $this->set($text, ${$text});\n            }\n        }\n    }\n\n    public function initiatePasswordReset($id, $firstTime = false)\n    {\n        if (!$this->_isAdmin()) {\n            throw new MethodNotAllowedException('You are not authorised to do that.');\n        }\n        $user = $this->User->find('first', array(\n            'conditions' => array('id' => $id),\n            'recursive' => -1\n        ));\n        if (!$this->_isSiteAdmin() && $this->Auth->user('org_id') != $user['User']['org_id']) {\n            throw new MethodNotAllowedException('You are not authorised to do that.');\n        }\n        if ($this->request->is('post')) {\n            if (isset($this->request->data['User']['firstTime'])) {\n                $firstTime = $this->request->data['User']['firstTime'];\n            }\n            return new CakeResponse($this->User->initiatePasswordReset($user, $firstTime));\n        } else {\n            $error = false;\n            $encryption = false;\n            if (!empty($user['User']['gpgkey'])) {\n                $encryption = 'PGP';\n            } elseif (!$error && !empty($user['User']['certif_public'])) {\n                $encryption = 'SMIME';\n            }\n            $this->set('encryption', $encryption);\n            if (!$encryption && (Configure::read('GnuPG.onlyencrypted') || Configure::read('GnuPG.bodyonlyencrypted'))) {\n                $error = 'No encryption key found for the user and the instance posture blocks non encrypted e-mails from being sent.';\n            }\n            $this->set('error', $error);\n            $this->layout = 'ajax';\n            $this->set('user', $user);\n            $this->set('firstTime', $firstTime);\n            $this->render('ajax/passwordResetConfirmationForm');\n        }\n    }\n\n    public function email_otp()\n    {\n        $user = $this->Session->read('email_otp_user');\n        if (empty($user)) {\n            $this->redirect('login');\n        }\n        $redis = $this->User->setupRedisWithException();\n        $user_id = $user['id'];\n\n        if ($this->request->is('post') && isset($this->request->data['User']['otp'])) {\n            $stored_otp = $redis->get('misp:otp:' . $user_id);\n            if (!empty($stored_otp) && trim($this->request->data['User']['otp']) == $stored_otp) {\n                // we invalidate the previously generated OTP\n                $redis->del('misp:otp:' . $user_id);\n                // We login the user with CakePHP\n                $this->Auth->login($user);\n                $this->_postlogin();\n            } else {\n                $this->Flash->error(__(\"The OTP is incorrect or has expired\"));\n            }\n        } else {\n            // GET Request\n\n            // We check for exceptions\n            $exception_list = Configure::read('Security.email_otp_exceptions');\n            if (!empty($exception_list)) {\n                $exceptions = explode(\",\", $exception_list);\n                foreach ($exceptions as $exception) {\n                    if ($user['email'] === trim($exception)) {\n                        // We login the user with CakePHP\n                        $this->Auth->login($user);\n                        $this->_postlogin();\n                    }\n                }\n            }\n            $this->loadModel('Server');\n\n            // Generating the OTP\n            $digits = Configure::read('Security.email_otp_length') ?: $this->Server->serverSettings['Security']['email_otp_length']['value'];\n            $otp = \"\";\n            for ($i = 0; $i < $digits; $i++) {\n                $otp .= random_int(0, 9);\n            }\n            // We use Redis to cache the OTP\n            $redis->set('misp:otp:' . $user_id, $otp);\n            $validity = Configure::read('Security.email_otp_validity') ?: $this->Server->serverSettings['Security']['email_otp_validity']['value'];\n            $redis->expire('misp:otp:' . $user_id, (int)$validity * 60);\n\n            // Email construction\n            $body = Configure::read('Security.email_otp_text') ?: $this->Server->serverSettings['Security']['email_otp_text']['value'];\n            $body = str_replace('$misp', Configure::read('MISP.baseurl'), $body);\n            $body = str_replace('$org', Configure::read('MISP.org'), $body);\n            $body = str_replace('$contact', Configure::read('MISP.contact'), $body);\n            $body = str_replace('$validity', $validity, $body);\n            $body = str_replace('$otp', $otp, $body);\n            $body = str_replace('$ip', $this->__getClientIP(), $body);\n            $body = str_replace('$username', $user['email'], $body);\n\n            // Fetch user that contains also PGP or S/MIME keys for e-mail encryption\n            $userForSendMail = $this->User->getUserById($user_id);\n            $body = str_replace('\\n', PHP_EOL, $body);\n            $result = $this->User->sendEmail($userForSendMail, $body, false, \"[\" . Configure::read('MISP.org') . \" MISP] Email OTP\");\n\n            if ($result) {\n                $this->Flash->success(__(\"An email containing a OTP has been sent.\"));\n            } else {\n                $this->Flash->error(__(\"The email couldn't be sent, please reach out to your administrator.\"));\n            }\n        }\n    }\n\n    /**\n    * Helper function to determine the IP of a client (proxy aware)\n    */\n    private function __getClientIP() {\n      $x_forwarded = filter_input(INPUT_SERVER, 'HTTP_X_FORWARDED_FOR', FILTER_SANITIZE_STRING);\n      $client_ip = filter_input(INPUT_SERVER, 'HTTP_CLIENT_IP', FILTER_SANITIZE_STRING);\n      if (!empty($x_forwarded)) {\n        $x_forwarded = explode(\",\", $x_forwarded);\n        return $x_forwarded[0];\n      } elseif(!empty($client_ip)){\n        return $client_ip;\n      } else {\n        return filter_input(INPUT_SERVER, 'REMOTE_ADDR', FILTER_SANITIZE_STRING);\n      }\n    }\n\n    // shows some statistics about the instance\n    public function statistics($page = 'data')\n    {\n        $user = $this->Auth->user();\n        @session_write_close(); // loading this page can take long time, so we can close session\n\n        if (!$this->_isRest()) {\n            $pages = [\n                'data' => __('Usage data'),\n                'orgs' => __('Organisations'),\n                'users' => __('User and Organisation statistics'),\n                'tags' => __('Tags'),\n                'attributehistogram' => __('Attribute histogram'),\n                'sightings' => __('Sightings toplists'),\n                'galaxyMatrix' => __('Galaxy Matrix')\n            ];\n            if (!$this->_isSiteAdmin() && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n                unset($pages['orgs']);\n            }\n\n            $this->set('page', $page);\n            $this->set('pages', $pages);\n        }\n\n        if ($page === 'data') {\n            $result = $this->__statisticsData($user, $this->params['named']);\n        } elseif ($page === 'orgs') {\n            if (!$this->_isSiteAdmin() && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n                throw new MethodNotAllowedException('This feature is currently disabled.');\n            }\n            $result = $this->__statisticsOrgs($this->params['named']);\n        } elseif ($page === 'users') {\n            $result = $this->__statisticsUsers($this->params['named']);\n        } elseif ($page === 'tags') {\n            $result = $this->__statisticsTags($this->params['named']);\n        } elseif ($page === 'attributehistogram') {\n            if ($this->_isRest()) {\n                return $this->histogram($selected = null);\n            } else {\n                $this->render('statistics_histogram');\n            }\n        } elseif ($page === 'sightings') {\n            $result = $this->__statisticsSightings($user, $this->params['named']);\n        } elseif ($page === 'galaxyMatrix') {\n            $result = $this->__statisticsGalaxyMatrix($user, $this->params['named']);\n        } else {\n            throw new NotFoundException(\"Invalid page\");\n        }\n\n        if ($this->_isRest()) {\n            return $result;\n        }\n    }\n\n    private function __statisticsData(array $user, $params = array())\n    {\n        // set all of the data up for the heatmaps\n        $params = array(\n            'fields' => array('id', 'name'),\n            'recursive' => -1,\n            'conditions' => array(),\n            'order' => ['name'],\n        );\n        if (!$user['Role']['perm_site_admin'] && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n            $params['conditions'] = array('Organisation.id' => $user['org_id']);\n        }\n        $orgs = $this->User->Organisation->find('list', $params);\n\n        $local_orgs_params = $params;\n        $local_orgs_params['conditions']['Organisation.local'] = 1;\n        $local_orgs_count = $this->User->Organisation->find('count', $local_orgs_params);\n\n        $this->loadModel('Log');\n        $year = date('Y');\n        $month = date('n');\n        $month = $month - 5;\n        if ($month < 1) {\n            $year--;\n            $month = 12 + $month;\n        }\n        // Some additional statistics\n        $this_month = strtotime('first day of this month');\n        $stats['event_count'] = $this->User->Event->find('count', array('recursive' => -1));\n        $stats['event_count_month'] = $this->User->Event->find('count', array('conditions' => array('Event.timestamp >' => $this_month), 'recursive' => -1));\n\n        $stats['attribute_count'] = $this->User->Event->Attribute->find('count', array('conditions' => array('Attribute.deleted' => 0), 'recursive' => -1));\n        $stats['attribute_count_month'] = $this->User->Event->Attribute->find('count', array('conditions' => array('Attribute.timestamp >' => $this_month, 'Attribute.deleted' => 0), 'recursive' => -1));\n        $stats['attributes_per_event'] = round($stats['attribute_count'] / $stats['event_count']);\n\n        $stats['correlation_count'] = $this->User->Event->Attribute->Correlation->find('count', array('recursive' => -1));\n        $stats['correlation_count'] = $stats['correlation_count'] / 2;\n\n        $stats['proposal_count'] = $this->User->Event->ShadowAttribute->find('count', array('recursive' => -1, 'conditions' => array('deleted' => 0)));\n\n        $stats['user_count'] = $this->User->find('count', array('recursive' => -1));\n        $stats['user_count_pgp'] = $this->User->find('count', array('recursive' => -1, 'conditions' => array('User.gpgkey !=' => '')));\n        $stats['org_count'] = count($orgs);\n        $stats['local_org_count'] = $local_orgs_count;\n        $stats['contributing_org_count'] = $this->User->Event->find('count', array('recursive' => -1, 'group' => array('Event.orgc_id')));\n        $stats['average_user_per_org'] = round($stats['user_count'] / $stats['local_org_count'], 1);\n\n        $this->loadModel('Thread');\n        $stats['thread_count'] = $this->Thread->find('count', array('conditions' => array('Thread.post_count >' => 0), 'recursive' => -1));\n        $stats['thread_count_month'] = $this->Thread->find('count', array('conditions' => array('Thread.date_created >' => date(\"Y-m-d H:i:s\", $this_month), 'Thread.post_count >' => 0), 'recursive' => -1));\n\n        $stats['post_count'] = $this->Thread->Post->find('count', array('recursive' => -1));\n        $stats['post_count_month'] = $this->Thread->Post->find('count', array('conditions' => array('Post.date_created >' => date(\"Y-m-d H:i:s\", $this_month)), 'recursive' => -1));\n\n        if ($this->_isRest()) {\n            $data = array(\n                'stats' => $stats\n            );\n            return $this->RestResponse->viewData($data, $this->response->type());\n        }\n\n        $this->set('stats', $stats);\n        $this->set('orgs', $orgs);\n        $this->set('start', strtotime(date('Y-m-d H:i:s') . ' -5 months'));\n        $this->set('end', strtotime(date('Y-m-d H:i:s')));\n        $this->set('startDateCal', $year . ', ' . $month . ', 01');\n        $range = '[5, 10, 50, 100]';\n        $this->set('range', $range);\n        $this->set('activityUrl', $this->baseurl . (Configure::read('MISP.log_new_audit') ? '/audit_logs' : '/logs') . '/returnDates');\n        $this->render('statistics_data');\n    }\n\n    private function __statisticsSightings(array $user, $params = array())\n    {\n        $this->loadModel('Sighting');\n        $conditions = ['Sighting.org_id' => $user['org_id']];\n        if (isset($params['timestamp'])) {\n            $conditions['Sighting.date_sighting >'] = $params['timestamp'];\n        }\n        $sightings = $this->Sighting->find('all', array(\n            'conditions' => $conditions,\n            'fields' => ['Sighting.type', 'Sighting.source', 'Sighting.event_id'],\n        ));\n        $data = array();\n        $toplist = array();\n        $eventids = array();\n        foreach ($sightings as $v) {\n            if ($v['Sighting']['source'] == '') {\n                $v['Sighting']['source'] = 'Undefined';\n            }\n            $type = array('sighting', 'false-positive', 'expiration')[$v['Sighting']['type']];\n            if (isset($data[$v['Sighting']['source']][$type])) {\n                $data[$v['Sighting']['source']][$type]++;\n            } else {\n                $data[$v['Sighting']['source']][$type] = 1;\n            }\n            if (!isset($toplist[$v['Sighting']['source']])) {\n                $toplist[$v['Sighting']['source']] = 1;\n            } else {\n                $toplist[$v['Sighting']['source']]++;\n            }\n            if (!isset($eventids[$v['Sighting']['source']][$type])) {\n                $eventids[$v['Sighting']['source']][$type] = [];\n            }\n            if (!in_array($v['Sighting']['event_id'], $eventids[$v['Sighting']['source']][$type])) {\n                $eventids[$v['Sighting']['source']][$v['Sighting']['type']][] = $type;\n            }\n        }\n        arsort($toplist);\n        if ($this->_isRest()) {\n            $data = array(\n                'toplist' => $toplist,\n                'eventids' => $eventids\n            );\n            return $this->RestResponse->viewData($data, $this->response->type());\n        } else {\n            $this->set('eventids', $eventids);\n            $this->set('toplist', $toplist);\n            $this->set('data', $data);\n            $this->render('statistics_sightings');\n        }\n    }\n\n    private function __statisticsOrgs($params = array())\n    {\n        $conditions = array();\n        if (!isset($params['scope']) || $params['scope'] == 'local') {\n            $params['scope'] = 'local';\n            $conditions['Organisation.local'] = 1;\n        } elseif ($params['scope'] == 'external') {\n            $conditions['Organisation.local'] = 0;\n        }\n        $orgs = $this->User->Organisation->find('all', array(\n            'recursive' => -1,\n            'conditions' => $conditions,\n            'fields' => array('id', 'name', 'description', 'local', 'contacts', 'type', 'sector', 'nationality'),\n        ));\n        $orgs = array_column(array_column($orgs, 'Organisation'), null, 'id');\n        $users = $this->User->find('all', array(\n            'group' => 'User.org_id',\n            'conditions' => array('User.org_id' => array_keys($orgs)),\n            'recursive' => -1,\n            'fields' => array('org_id', 'count(*)')\n        ));\n        foreach ($users as $user) {\n            $orgs[$user['User']['org_id']]['userCount'] = $user[0]['count(*)'];\n        }\n        unset($users);\n        $events = $this->User->Event->find('all', array(\n            'group' => 'Event.orgc_id',\n            'conditions' => array('Event.orgc_id' => array_keys($orgs)),\n            'recursive' => -1,\n            'fields' => array('Event.orgc_id', 'count(*)', 'sum(Event.attribute_count) as attributeCount')\n        ));\n        foreach ($events as $event) {\n            $orgs[$event['Event']['orgc_id']]['eventCount'] = $event[0]['count(*)'];\n            $orgs[$event['Event']['orgc_id']]['attributeCount'] = $event[0]['attributeCount'];\n            $orgs[$event['Event']['orgc_id']]['orgActivity'] = $this->User->getOrgActivity($event['Event']['orgc_id'], array('event_timestamp' => '365d'));\n        }\n        unset($events);\n        $orgs = Set::combine($orgs, '{n}.name', '{n}');\n        // f*** php\n        uksort($orgs, 'strcasecmp');\n        foreach ($orgs as $k => $value) {\n            if (file_exists(APP . 'webroot' . DS . 'img' . DS . 'orgs' . DS . $k . '.png')) {\n                $orgs[$k]['logo'] = true;\n            }\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($orgs, $this->response->type());\n        } else {\n            $this->set('scope', $params['scope']);\n            $this->set('orgs', $orgs);\n            $this->render('statistics_orgs');\n        }\n    }\n\n    private function __statisticsUsers($params = array())\n    {\n        $this->loadModel('Organisation');\n        $this->loadModel('User');\n        $this_month = strtotime(date('Y/m') . '/01');\n        $this_year = strtotime(date('Y') . '/01/01');\n        $ranges = array(\n            'total' => null,\n            'month' => $this_month,\n            'year' => $this_year\n        );\n        $scopes = array(\n            'user' => array(\n                'conditions' => array(),\n                'model' => 'User',\n                'date_created' => 'timestamp'\n            ),\n            'org_local' => array(\n                'conditions' => array('Organisation.local' => 1),\n                'model' => 'Organisation',\n                'date_created' => 'datetime'\n            ),\n            'org_external' => array(\n                'conditions' => array('Organisation.local' => 0),\n                'model' => 'Organisation',\n                'date_created' => 'datetime'\n            )\n        );\n        $statistics = array();\n        foreach ($scopes as $scope => $scope_data) {\n            foreach ($ranges as $range => $condition) {\n                $params = array(\n                    'recursive' => -1\n                );\n                $filter = array();\n                if (!empty($condition)) {\n                    if ($scope_data['date_created'] === 'datetime') {\n                        $condition = date('Y-m-d H:i:s', $condition);\n                    }\n                    $filter = array($scope_data['model'] . '.date_created >=' => $condition);\n                }\n                $params['conditions'] = array_merge($scopes[$scope]['conditions'], $filter);\n                $statistics[$scope]['data'][$range] = $this->{$scope_data['model']}->find('count', $params);\n            }\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($statistics, $this->response->type());\n        } else {\n            $this->set('statistics', $statistics);\n            $this->render('statistics_users');\n        }\n    }\n\n    public function tagStatisticsGraph()\n    {\n        $this->loadModel('EventTag');\n        $tags = $this->EventTag->getSortedTagList();\n        $this->loadModel('Taxonomy');\n        $taxonomies = $this->Taxonomy->find('list', array(\n                'conditions' => array('enabled' => true),\n                'fields' => array('Taxonomy.namespace')\n        ));\n        $flatData = array();\n        $tagIds = $this->EventTag->Tag->find('list', array('fields' => array('Tag.name', 'Tag.id')));\n        $this->set('tagIds', $tagIds);\n        foreach ($tags as $key => $value) {\n            $name = explode(':', $value['name']);\n            $tags[$key]['taxonomy'] = 'custom';\n            if (count($name) > 1) {\n                if (in_array($name[0], $taxonomies)) {\n                    $tags[$key]['taxonomy'] = $name[0];\n                }\n            }\n            $flatData[$tags[$key]['taxonomy']][$value['name']] = array('name' => $value['name'], 'size' => $value['eventCount']);\n        }\n        $treemap = array(\n                'name' => 'tags',\n                'children' => array()\n        );\n\n        foreach ($flatData as $key => $value) {\n            $newElement = array(\n                'name' => $key,\n                'children' => array()\n            );\n            foreach ($value as $tag) {\n                $newElement['children'][] = array('name' => $tag['name'], 'size' => $tag['size']);\n            }\n            $treemap['children'][] = $newElement;\n        }\n        $taxonomyColourCodes = array();\n        $taxonomies = array_merge(array('custom'), $taxonomies);\n        if ($this->_isRest()) {\n            $data = array(\n                'flatData' => $flatData,\n                'treemap' => $treemap\n            );\n            return $this->RestResponse->viewData($data, $this->response->type());\n        } else {\n            $this->set('taxonomyColourCodes', $taxonomyColourCodes);\n            $this->set('taxonomies', $taxonomies);\n            $this->set('flatData', $flatData);\n            $this->set('treemap', $treemap);\n            $this->set('tags', $tags);\n            $this->layout = 'treemap';\n            $this->render('ajax/tag_statistics_graph');\n        }\n    }\n\n    private function __statisticsTags($params = array())\n    {\n        if ($this->_isRest()) {\n            return $this->tagStatisticsGraph();\n        } else {\n            $this->render('statistics_tags');\n        }\n    }\n\n    private function __statisticsGalaxyMatrix(array $user, $params = array())\n    {\n        $this->loadModel('Event');\n        $this->loadModel('Galaxy');\n        $mitre_galaxy_id = $this->Galaxy->getMitreAttackGalaxyId();\n        if (isset($params['galaxy_id'])) {\n            $galaxy_id = $params['galaxy_id'];\n        } else {\n            $galaxy_id = $mitre_galaxy_id;\n        }\n\n        $organisations = $this->User->Organisation->find('list', array(\n            'recursive' => -1,\n            'fields' => ['id', 'name'],\n        ));\n        foreach ($organisations as $id => $foo) {\n            if (!$this->User->Organisation->canSee($user, $id)) {\n                unset($organisations[$id]);\n            }\n        }\n        $organisations = [0 => __('All')] + $organisations;\n        $this->set('organisations', $organisations);\n\n        if (isset($params['organisation']) && $params['organisation'] != 0) {\n            if (isset($organisations[$params['organisation']])) {\n                $this->set('picked_organisation_id', $params['organisation']);\n            } else {\n                throw new NotFoundException(__(\"Invalid organisation\"));\n            }\n        } else {\n            $this->set('picked_organisation_id', -1);\n        }\n\n        $rest_response_empty = true;\n        $ignore_score = false;\n        if (\n            isset($params['dateFrom'])\n            || isset($params['dateTo'])\n            || isset($params['organisation']) && $params['organisation'] != 0\n        ) { // use restSearch\n            $ignore_score = true;\n            $filters = array();\n            if (isset($params['dateFrom'])) {\n                $filters['from'] = $params['dateFrom'];\n                $this->set('dateFrom', $params['dateFrom']);\n            }\n            if (isset($params['dateTo'])) {\n                $filters['to'] = $params['dateTo'];\n                $this->set('dateTo', $params['dateTo']);\n            }\n            if (isset($params['organisation'])) {\n                $filters['org'] = $params['organisation'];\n            }\n            $elementCounter = 0;\n            $renderView = '';\n            $final = $this->Event->restSearch($user, 'attack', $filters, false, false, $elementCounter, $renderView);\n\n            $final = json_decode($final, true);\n            if (!empty($final)) {\n                $rest_response_empty = false;\n                foreach ($final as $key => $data) {\n                    $this->set($key, $data);\n                }\n            }\n        }\n\n        // No need for restSearch or result is empty\n        if ($rest_response_empty) {\n            $matrixData = $this->Galaxy->getMatrix($galaxy_id);\n            $tabs = $matrixData['tabs'];\n            $matrixTags = $matrixData['matrixTags'];\n            $killChainOrders = $matrixData['killChain'];\n            $instanceUUID = $matrixData['instance-uuid'];\n            if ($ignore_score) {\n                $scores_uniform = array('scores' => array(), 'maxScore' => 0);\n            } else {\n                $scores_uniform = $this->Event->EventTag->getTagScoresUniform(0, $matrixTags);\n            }\n            $scores = $scores_uniform['scores'];\n            $maxScore = $scores_uniform['maxScore'];\n            // FIXME: temporary fix: add the score of deprecated mitre galaxies to the new one (for the stats)\n            if ($matrixData['galaxy']['id'] == $mitre_galaxy_id) {\n                $mergedScore = array();\n                foreach ($scores as $tag => $v) {\n                    $predicateValue = explode(':', $tag, 2)[1];\n                    $predicateValue = explode('=', $predicateValue, 2);\n                    $predicate = $predicateValue[0];\n                    $clusterValue = $predicateValue[1];\n                    $mappedTag = '';\n                    $mappingWithoutExternalId = array();\n                    if ($predicate == 'mitre-attack-pattern') {\n                        $mappedTag = $tag;\n                        $name = explode(\" \", $tag);\n                        $name = join(\" \", array_slice($name, 0, -2)); // remove \" - external_id\"\n                        $mappingWithoutExternalId[$name] = $tag;\n                    } else {\n                        $name = explode(\" \", $clusterValue);\n                        $name = join(\" \", array_slice($name, 0, -2)); // remove \" - external_id\"\n                        if (isset($mappingWithoutExternalId[$name])) {\n                            $mappedTag = $mappingWithoutExternalId[$name];\n                        } else {\n                            $adjustedTagName = $this->Galaxy->GalaxyCluster->find('list', array(\n                                'group' => array('GalaxyCluster.id', 'GalaxyCluster.tag_name'),\n                                'conditions' => array('GalaxyCluster.tag_name LIKE' => 'misp-galaxy:mitre-attack-pattern=' . $name . '% T%'),\n                                'fields' => array('GalaxyCluster.tag_name')\n                            ));\n                            if (!empty($adjustedTagName)) {\n                                $adjustedTagName = array_values($adjustedTagName)[0];\n                                $mappingWithoutExternalId[$name] = $adjustedTagName;\n                                $mappedTag = $mappingWithoutExternalId[$name];\n                            }\n                        }\n                    }\n                    if (isset($mergedScore[$mappedTag])) {\n                        $mergedScore[$mappedTag] += $v;\n                    } else {\n                        $mergedScore[$mappedTag] = $v;\n                    }\n                }\n                $scores = $mergedScore;\n                $maxScore = !empty($mergedScore) ? max(array_values($mergedScore)) : 0;\n            }\n            // end FIXME\n\n            $this->Galaxy->sortMatrixByScore($tabs, $scores);\n            if ($this->_isRest()) {\n                $json = array('matrix' => $tabs, 'scores' => $scores, 'instance-uuid' => $instanceUUID);\n                return $this->RestResponse->viewData($json, $this->response->type());\n            } else {\n                App::uses('ColourGradientTool', 'Tools');\n                $gradientTool = new ColourGradientTool();\n                $colours = $gradientTool->createGradientFromValues($scores);\n\n                $this->set('target_type', 'attribute');\n                $this->set('columnOrders', $killChainOrders);\n                $this->set('tabs', $tabs);\n                $this->set('scores', $scores);\n                $this->set('maxScore', $maxScore);\n                if (!empty($colours)) {\n                    $this->set('colours', $colours['mapping']);\n                    $this->set('interpolation', $colours['interpolation']);\n                }\n                $this->set('pickingMode', false);\n                if ($matrixData['galaxy']['id'] == $mitre_galaxy_id) {\n                    $this->set('defaultTabName', \"mitre-attack\");\n                    $this->set('removeTrailling', 2);\n                }\n\n                $this->set('galaxyName', $matrixData['galaxy']['name']);\n                $this->set('galaxyId', $matrixData['galaxy']['id']);\n                $matrixGalaxies = $this->Galaxy->getAllowedMatrixGalaxies();\n                $this->set('matrixGalaxies', $matrixGalaxies);\n            }\n        }\n        $this->render('statistics_galaxymatrix');\n    }\n\n    public function verifyGPG($full = false)\n    {\n        $user_results = $this->User->verifyGPG($full);\n        $this->set('users', $user_results);\n    }\n\n    public function verifyCertificate()\n    {\n        $user_results = $this->User->verifyCertificate();\n        $this->set('users', $user_results);\n    }\n\n    public function searchGpgKey($email = false)\n    {\n        if (!$email) {\n            throw new NotFoundException('No email provided.');\n        }\n        $keys = $this->User->searchGpgKey($email);\n        if (empty($keys)) {\n            throw new NotFoundException('No keys found for given email at keyserver.');\n        }\n        $this->set('keys', $keys);\n        $this->autorender = false;\n        $this->layout = false;\n        $this->render('ajax/fetchpgpkey');\n    }\n\n    public function fetchGpgKey($fingerprint = null)\n    {\n        if (!$fingerprint) {\n            throw new NotFoundException('No fingerprint provided.');\n        }\n        $key = $this->User->fetchGpgKey($fingerprint);\n        if (!$key) {\n            throw new NotFoundException('No key with given fingerprint found.');\n        }\n        return new CakeResponse(array('body' => $key));\n    }\n\n    public function getGpgPublicKey()\n    {\n        if (!Configure::read(\"MISP.download_gpg_from_homedir\")) {\n            throw new MethodNotAllowedException(\"Downloading GPG public key from homedir is not allowed.\");\n        }\n\n        $key = $this->User->getGpgPublicKey();\n        if (!$key) {\n            throw new NotFoundException(\"Public key not found.\");\n        }\n\n        list($fingeprint, $publicKey) = $key;\n        $response = new CakeResponse(array(\n            'body' => $publicKey,\n            'type' => 'text/plain',\n        ));\n        $response->download($fingeprint . '.asc');\n        return $response;\n    }\n\n    public function checkIfLoggedIn()\n    {\n        return new CakeResponse(array('body'=> 'OK','status' => 200));\n    }\n\n    public function admin_monitor($id)\n    {\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $id),\n            'fields' => array('User.id')\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user.'));\n        }\n        $redis = $this->User->setupRedis();\n        $alreadyMonitored = $redis->sismember('misp:monitored_users', $id);\n        if ($this->request->is('post')) {\n            if (isset($this->request->data['User'])) {\n                $this->request->data = $this->request->data['User'];\n            }\n            if (isset($this->request->data['value'])) {\n                $this->request->data = $this->request->data['value'];\n            }\n            if (empty($this->request->data)) {\n                $redis->srem('misp:monitored_users', $id);\n            } else {\n                $redis->sadd('misp:monitored_users', $id);\n            }\n            return $this->RestResponse->viewData($alreadyMonitored ? 0 : 1, $this->response->type());\n        } else {\n            if ($this->_isRest()) {\n                return $this->RestResponse->viewData($alreadyMonitored ? 0 : 1, $this->response->type());\n            } else {\n                $this->set('data', $alreadyMonitored);\n                $this->layout = false;\n                $this->render('/Elements/genericElements/toggleForm');\n            }\n        }\n    }\n\n    public function register()\n    {\n        $fieldToValidate = array('email', 'gpgkey');\n        if (empty(Configure::read('Security.allow_self_registration'))) {\n            throw new MethodNotAllowedException(__('Self registration is not enabled on this instance.'));\n        }\n        $message = Configure::read('Security.self_registration_message');\n        if (empty($message)) {\n            $this->loadModel('Server');\n            $message = $this->Server->serverSettings['Security']['self_registration_message']['value'];\n        }\n        $this->set('message', $message);\n        if ($this->request->is('post')) {\n            if (isset($this->request->data['User'])) {\n                $this->request->data = $this->request->data['User'];\n            }\n            $validKeys = array(\n                'email',\n                'org_name',\n                'org_uuid',\n                'message',\n                'custom_perms',\n                'perm_sync',\n                'perm_publish',\n                'perm_admin'\n            );\n            $requestObject = array();\n            foreach ($validKeys as $key) {\n                if (isset($this->request->data[$key])) {\n                    $requestObject[$key] = trim($this->request->data[$key]);\n                }\n            }\n            if (!isset($requestObject['message'])) {\n                $requestObject['message'] = '';\n            }\n            if (empty($requestObject['email'])) {\n                throw new BadRequestException(__('We require at least the email field to be filled.'));\n            }\n            $this->User->set($requestObject);\n            unset($this->User->validate['email']['unique']);\n            if (!$this->User->validates(array('fieldList' => $fieldToValidate))) {\n                $errors = $this->User->validationErrors;\n                $message = __('Request could not be created.');\n                if ($this->_isRest()) {\n                    $message .= __('Errors: %s', json_encode($errors));\n                    return $this->RestResponse->saveFailResponse('Users', 'register', false, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                    return;\n                }\n            }\n            $this->loadModel('Inbox');\n            $this->Inbox->create();\n            $data = array(\n                'Inbox' => array(\n                    'title' => __('User registration for %s.', $requestObject['email']),\n                    'type' => 'registration',\n                    'comment' => $requestObject['message'],\n                    'data' => json_encode($requestObject)\n                )\n            );\n            $result = $this->Inbox->save($data);\n            if (empty($result)) {\n                $message = __('Request could not be created. Make sure that the email and org name fields are filled.');\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveFailResponse('Users', 'register', false, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                }\n            } else {\n                $message = __('Request sent. The administrators of this community have been notified.');\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveSuccessResponse('User', 'register', false, $this->response->type(), $message);\n                } else {\n                    $this->Flash->success($message);\n                    $this->redirect('/');\n                }\n            }\n        }\n    }\n\n    public function registrations()\n    {\n        $this->loadModel('Inbox');\n        $params = array(\n            'recursive' => -1,\n            'conditions' => array(\n                'deleted' => 0,\n                'type' => 'registration'\n            ),\n            'order' => array(\n                'timestamp desc'\n            )\n        );\n        $passedArgs = $this->passedArgs;\n        if (!empty($passedArgs['value'])) {\n            $lookup = strtolower($passedArgs['value']);\n            $allSearchFields = array('data', 'user_agent', 'ip');\n            foreach ($allSearchFields as $field) {\n                $params['conditions']['AND']['OR'][] = array('LOWER(Inbox.' . $field . ') LIKE' => '%' . $lookup . '%');\n            }\n        }\n        $this->set('passedArgs', json_encode($passedArgs));\n        if ($this->_isRest()) {\n            $data = $this->Inbox->find('all', array(\n                'recursive' => -1,\n                'conditions' => $params['conditions']\n            ));\n            foreach ($data as $k => $v) {\n                $data[$k]['Inbox']['data'] = json_decode($data[$k]['Inbox']['data'], true);\n            }\n            return $this->RestResponse->viewData($data, $this->response->type());\n        } else {\n            $this->paginate = $params;\n            $data = $this->paginate('Inbox');\n            foreach ($data as $k => $message) {\n                $data[$k]['Inbox']['data'] = json_decode($data[$k]['Inbox']['data'], true);\n                $data[$k]['Inbox']['requested_role'] = __('default');\n                if (!empty($data[$k]['Inbox']['data']['custom_perms'])) {\n                    $data[$k]['Inbox']['requested_role'] = array(\n                        'perm_publish' => !empty($data[$k]['Inbox']['data']['perm_publish']) ? __('Yes') : __('No'),\n                        'perm_sync' => !empty($data[$k]['Inbox']['data']['perm_sync']) ? __('Yes') : __('No'),\n                        'perm_admin' => !empty($data[$k]['Inbox']['data']['perm_admin']) ? __('Yes') : __('No')\n                    );\n                }\n            }\n            $this->set('data', $data);\n        }\n    }\n\n    public function discardRegistrations($id = false)\n    {\n        if (!$this->request->is('post') && !$this->request->is('delete')) {\n            $this->set('id', $id);\n            $this->set('type', 'discardRegistrations');\n            $this->render('ajax/discardRegistrations');\n        } else {\n            if (empty($id) && !empty($this->params['named']['id'])) {\n                $id = $this->params['named']['id'];\n            }\n            $this->loadModel('Inbox');\n            if (!is_array($id)) {\n                $id = array($id);\n            }\n            foreach ($id as $k => $v) {\n                if (Validation::uuid($v)) {\n                    $id[$k] = $this->Toolbox->findIdByUuid($this->Inbox, $v);\n                }\n            }\n            $registrations = $this->Inbox->find('all', array(\n                'recursive' => -1,\n                'conditions' => array(\n                    'deleted' => 0,\n                    'type' => 'registration',\n                    'id' => $id\n                )\n            ));\n            foreach ($registrations as $registration) {\n                $this->Inbox->delete($registration['Inbox']['id']);\n            }\n            $message = sprintf(\n                '%s registration(s) discarded.',\n                count($registrations)\n            );\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveSuccessResponse('User', 'discardRegistrations', false, $this->response->type(), $message);\n            } else {\n                $this->Log = ClassRegistry::init('Log');\n                $this->Log->create();\n                $this->Log->save(array(\n                    'org' => $this->Auth->user('Organisation')['name'],\n                    'model' => 'User',\n                    'model_id' => 0,\n                    'email' => $this->Auth->user('email'),\n                    'action' => 'discardRegistrations',\n                    'title' => $message,\n                    'change' => ''\n                ));\n                $this->Flash->success($message);\n                $this->redirect(array('controller' => 'users', 'action' => 'registrations'));\n            }\n        }\n    }\n\n    public function acceptRegistrations($id = false)\n    {\n        if (empty($id) && !empty($this->params['named']['id'])) {\n            $id = $this->params['named']['id'];\n        }\n        $this->loadModel('Inbox');\n        if (Validation::uuid($id)) {\n            $id = $this->Toolbox->findIdByUuid($this->Inbox, $id);\n        }\n        $registrations = $this->Inbox->find('all', array(\n            'recursive' => -1,\n            'conditions' => array(\n                'deleted' => 0,\n                'type' => 'registration',\n                'id' => $id\n            )\n        ));\n        $suggestedOrg = null;\n        $suggestedRole = null;\n        $orgCache = array();\n        foreach ($registrations as $k => $v) {\n            $registrations[$k]['Inbox']['data'] = json_decode($registrations[$k]['Inbox']['data'], true);\n            $roleRequirements = array();\n            if ($this->request->is('get')) {\n                $suggestedOrg = $this->User->Organisation->checkDesiredOrg($suggestedOrg, $registrations[$k]);\n                $suggestedRole = $this->User->Role->checkDesiredRole($suggestedRole, $registrations[$k]);\n            }\n        }\n        $default_role = $this->User->Role->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('Role.default_role' => 1),\n            'fields' => array('Role.id')\n        ));\n        if ($this->request->is('get')) {\n            if (!is_array($id)) {\n                $id = array($id);\n            }\n            foreach ($id as $k => $v) {\n                $id[$k] = 'id[]:' . intval($v);\n            }\n            $roles_raw = $this->User->Role->find('all', array(\n                'recursive' => -1\n            ));\n            //roles = id => name\n            $roles = array();\n            $role_perms = array();\n            foreach ($roles_raw as $role) {\n                $roles[$role['Role']['id']] = $role['Role']['name'];\n                $role_perms[$role['Role']['id']] = array(\n                    'perm_publish' => $role['Role']['perm_publish'],\n                    'perm_sync' => $role['Role']['perm_sync'],\n                    'perm_admin' => $role['Role']['perm_admin']\n                );\n            }\n            if (empty($this->request->data['User'])) {\n                $this->request->data = array('User' => $this->request->data);\n            }\n            if (!empty($default_role)) {\n                $this->request->data['User']['role_id'] = $default_role['Role']['id'];\n            }\n            $this->set('roles', $roles);\n            $this->set('role_perms', $role_perms);\n            $orgConditions = array('OR' => array('local' => 1));\n            if (!empty($suggestedOrg)) {\n                $orgConditions['OR'][] = array('Organisation.id' => $suggestedOrg[0]);\n            }\n            $this->set('orgs', $this->User->Organisation->find('list', array(\n                'fields' => array('id', 'name'),\n                'recursive' => -1,\n                'conditions' => $orgConditions\n            )));\n            $this->set('registration', $registrations[$k]);\n            $this->set('suggestedOrg', $suggestedOrg);\n            $this->set('suggestedRole', $suggestedRole);\n            $id = implode('/', $id);\n            $this->set('id', $id);\n            $this->layout = false;\n        } else {\n            $results = array('successes' => 0, 'fails' => 0);\n            if (!isset($this->request->data['User']['role_id'])) {\n                if (!empty($default_role)) {\n                    $this->request->data['User']['role_id'] = $default_role['Role']['id'];\n                } else {\n                    throw new BadRequestException(__('Role ID not provided and no default role exist on the instance'));\n                }\n            }\n            if (!isset($this->request->data['User']['org_id'])) {\n                throw new BadRequestException(__('No organisation selected. Supply an Organisation ID'));\n            } else {\n                if (Validation::uuid($this->request->data['User']['org_id'])) {\n                    $id = $this->Toolbox->findIdByUuid($this->User->Organisation, $this->request->data['User']['org_id']);\n                    $this->request->data['User']['org_id'] = $id;\n                }\n            }\n            foreach ($registrations as $registration) {\n                $result = $this->User->registerUser(\n                    $this->Auth->user(),\n                    $registration['Inbox'],\n                    $this->request->data['User']['org_id'],\n                    $this->request->data['User']['role_id']\n                );\n                $results[($result ? 'successes' : 'fails')] += 1;\n            }\n            $message = array();\n            if (!empty($results['successes'])) {\n                $message[] = __('Added %s user(s).', $results['successes']);\n            }\n            if (!empty($results['fails'])) {\n                $message[] = __('Could not add %s user(s), reasons for the failure have been logged.', $results['fails']);\n            }\n            if (empty($message)) {\n                $message[] = __('No new users added - there was nothing to add.');\n            }\n            $message = implode(' ', $message);\n            if ($this->_isRest()) {\n                if (empty($results['fails']) && !empty($results['successes'])) {\n                    return $this->RestResponse->saveSuccessResponse('User', 'acceptRegistrations', false, $this->response->type(), $message);\n                } else {\n                    return $this->RestResponse->saveFailResponse('Users', 'acceptRegistrations', false, $message, $this->response->type());\n                }\n            } else {\n                if (empty($results['fails']) && !empty($results['successes'])) {\n                    return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => $message)), 'status'=>200, 'type' => 'json'));\n                } else {\n                    return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $message)), 'status'=>200, 'type' => 'json'));\n                }\n            }\n        }\n    }\n\n    public function updateToAdvancedAuthKeys()\n    {\n        if (!$this->request->is('post')) {\n            throw new MethodNotAllowedException(__('This endpoint can only be triggered via POST requests.'));\n        }\n        $updated = $this->User->updateToAdvancedAuthKeys();\n        $message = __('The upgrade process is complete, %s authkey(s) generated.', $updated);\n        if ($this->_isRest()) {\n            return $this->RestResponse->saveSuccessResponse('User', 'acceptRegistrations', false, $this->response->type(), $message);\n        } else {\n            $this->Flash->success($message);\n            $this->redirect($this->referer());\n        }\n    }\n\n    private function __canChangePassword()\n    {\n        return $this->ACL->canUserAccess($this->Auth->user(), 'users', 'change_pw');\n    }\n\n    private function __canChangeLogin()\n    {\n        if ($this->_isSiteAdmin()) {\n            return true;\n        }\n        return !Configure::read('MISP.disable_user_login_change');\n    }\n}\n"], "fixing_code": ["<?php\nApp::uses('AppController', 'Controller');\n\n/**\n * @property User $User\n */\nclass UsersController extends AppController\n{\n    public $newkey;\n\n    public $components = array(\n        'RequestHandler'\n    );\n\n    public $paginate = array(\n        'limit' => 60,\n        'recursive' => -1,\n        'order' => array(\n                'Organisation.name' => 'ASC'\n        ),\n        'contain' => array(\n            'Organisation' => array('id', 'uuid', 'name'),\n            'Role' => array('id', 'name', 'perm_auth', 'perm_site_admin')\n        )\n    );\n\n    public $toggleableFields = ['disabled', 'autoalert'];\n\n    public function beforeFilter()\n    {\n        parent::beforeFilter();\n\n        // what pages are allowed for non-logged-in users\n        $allowedActions = array('login', 'logout', 'getGpgPublicKey');\n        if(!empty(Configure::read('Security.email_otp_enabled'))) {\n          $allowedActions[] = 'email_otp';\n        }\n        if (!empty(Configure::read('Security.allow_self_registration'))) {\n            $allowedActions[] = 'register';\n        }\n        $this->Auth->allow($allowedActions);\n    }\n\n    public function view($id = null)\n    {\n        if (\"me\" === $id) {\n            $id = $this->Auth->user('id');\n        }\n        if (!$this->_isSiteAdmin() && $this->Auth->user('id') != $id) {\n            throw new NotFoundException(__('Invalid user or not authorised.'));\n        }\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $id),\n            'contain' => array(\n                'UserSetting',\n                'Role',\n                'Organisation'\n            )\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n            unset($user['User']['authkey']);\n        }\n        if (!empty($user['User']['gpgkey'])) {\n            $pgpDetails = $this->User->verifySingleGPG($user);\n            $user['User']['pgp_status'] = isset($pgpDetails[2]) ? $pgpDetails[2] : 'OK';\n            $user['User']['fingerprint'] = !empty($pgpDetails[4]) ? $pgpDetails[4] : 'N/A';\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($this->__massageUserObject($user), $this->response->type());\n        } else {\n            $this->set('user', $user);\n            $this->set('admin_view', false);\n        }\n    }\n\n    /**\n     * @param array $user\n     * @return array\n     */\n    private function __massageUserObject(array $user)\n    {\n        $user['UserSetting'] = array_column($user['UserSetting'], 'value', 'setting');\n        unset($user['User']['server_id']);\n        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n            unset($user['User']['authkey']);\n        }\n        $user['User']['password'] = '*****';\n        $temp = [];\n        $objectsToInclude = array('User', 'Role', 'UserSetting', 'Organisation');\n        foreach ($objectsToInclude as $objectToInclude) {\n            if (isset($user[$objectToInclude])) {\n                $temp[$objectToInclude] = $user[$objectToInclude];\n            }\n        }\n        return $temp;\n    }\n\n    public function request_API()\n    {\n        if (Configure::read('MISP.disable_emailing')) {\n            return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'API access request failed. E-mailing is currently disabled on this instance.')), 'status'=>200, 'type' => 'json'));\n        }\n        $responsibleAdmin = $this->User->findAdminsResponsibleForUser($this->Auth->user());\n        if (isset($responsibleAdmin['email']) && !empty($responsibleAdmin['email'])) {\n            $subject = \"[MISP \" . Configure::read('MISP.org') . \"] User requesting API access\";\n            $body = \"A user (\" . $this->Auth->user('email') . \") has sent you a request to enable his/her API key access.\" . PHP_EOL;\n            $body .= \"You can edit the user's profile at \" . Configure::read('MISP.baseurl') . '/admin/users/edit/' . $this->Auth->user('id');\n            $user = $this->User->find('first', array('conditions' => array('User.id' => $responsibleAdmin['id'])));\n            $result = $this->User->sendEmail($user, $body, false, $subject);\n            if ($result) {\n                return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => 'API access requested.')), 'status'=>200, 'type' => 'json'));\n            }\n        }\n        return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => 'Something went wrong, please try again later.')), 'status'=>200, 'type' => 'json'));\n    }\n\n    public function edit()\n    {\n        $currentUser = $this->User->find('first', array(\n            'conditions' => array('User.id' => $this->Auth->user('id')),\n            'recursive' => -1\n        ));\n        if (empty($currentUser)) {\n            throw new NotFoundException('Something went wrong. Your user account could not be accessed.');\n        }\n        $id = $currentUser['User']['id'];\n        if ($this->request->is('post') || $this->request->is('put')) {\n            if (empty($this->request->data['User'])) {\n                $this->request->data = array('User' => $this->request->data);\n            }\n            $abortPost = false;\n            if (!empty($this->request->data['User']['email']) && !$this->_isSiteAdmin()) {\n                $organisation = $this->User->Organisation->find('first', array(\n                    'conditions' => array('Organisation.id' => $this->Auth->user('org_id')),\n                    'recursive' => -1\n                ));\n                if (!empty($organisation['Organisation']['restricted_to_domain'])) {\n                    $abortPost = true;\n                    foreach ($organisation['Organisation']['restricted_to_domain'] as $restriction) {\n                        if (\n                            strlen($this->request->data['User']['email']) > strlen($restriction) &&\n                            substr($this->request->data['User']['email'], (-1 * strlen($restriction))) === $restriction &&\n                            in_array($this->request->data['User']['email'][strlen($this->request->data['User']['email']) - strlen($restriction) -1], array('@', '.'))\n                        ) {\n                            $abortPost = false;\n                        }\n                    }\n                    if ($abortPost) {\n                        $message = __('Invalid e-mail domain. Your user is restricted to creating users for the following domain(s): ') . implode(', ', $organisation['Organisation']['restricted_to_domain']);\n                    }\n                }\n            }\n            if (!$abortPost && (!$this->_isRest() || empty($this->request->header('Authorization')))) {\n                if (Configure::read('Security.require_password_confirmation')) {\n                    if (!empty($this->request->data['User']['current_password'])) {\n                        $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['current_password']);\n                        if (!$hashed) {\n                            $abortPost = true;\n                            $this->Flash->error('Invalid password. Please enter your current password to continue.');\n                        }\n                        unset($this->request->data['User']['current_password']);\n                    } else {\n                        $abortPost = true;\n                        $this->Flash->info('Please enter your current password to continue.');\n                    }\n                }\n            }\n            if (!$abortPost) {\n                // What fields should be saved (allowed to be saved)\n                $fieldList = array('autoalert', 'gpgkey', 'certif_public', 'nids_sid', 'contactalert', 'disabled', 'date_modified');\n                if ($this->__canChangeLogin()) {\n                    $fieldList[] = 'email';\n                }\n                if ($this->__canChangePassword() && !empty($this->request->data['User']['password'])) {\n                    $fieldList[] = 'password';\n                    $fieldList[] = 'confirm_password';\n                }\n                foreach ($this->request->data['User'] as $k => $v) {\n                    $currentUser['User'][$k] = $v;\n                }\n                // Save the data\n                if ($this->_isRest()) {\n                    if (!empty($this->request->data['User']['password'])) {\n                        if ($this->request->data['User']['password'] === '*****') {\n                            unset($this->request->data['User']['password']);\n                        } else {\n                            $currentUser['User']['confirm_password'] = $this->request->data['User']['password'];\n                        }\n                    }\n                }\n                if ($this->User->save($currentUser, true, $fieldList)) {\n                    if ($this->_isRest()) {\n                        $user = $this->User->find('first', array(\n                            'conditions' => array('User.id' => $id),\n                            'recursive' => -1,\n                            'contain' => array(\n                                'Organisation',\n                                'Role',\n                                'UserSetting'\n                            )\n                        ));\n                        return $this->RestResponse->viewData($this->__massageUserObject($user), $this->response->type());\n                    } else {\n                        $this->Flash->success(__('The profile has been updated'));\n                        $this->redirect(array('action' => 'view', $id));\n                    }\n                } else {\n                    $message = __('The profile could not be updated. Please, try again.');\n                    $abortPost = true;\n                }\n            }\n            if ($abortPost) {\n                $this->request->data['User']['password'] = '';\n                $this->request->data['User']['confirm_password'] = '';\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveFailResponse('Users', 'edit', $id, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                }\n            }\n        } else {\n            $this->User->data = $currentUser;\n            $this->User->set('password', '');\n            $this->request->data = $this->User->data;\n        }\n        $this->loadModel('Server');\n        $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n        $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n        $roles = $this->User->Role->find('list');\n        $this->set('roles', $roles);\n        $this->set('id', $id);\n        $this->set('canChangePassword', $this->__canChangePassword());\n        $this->set('canChangeLogin', $this->__canChangeLogin());\n    }\n\n    public function change_pw()\n    {\n        $id = $this->Auth->user('id');\n        $user = $this->User->find('first', array(\n            'conditions' => array('User.id' => $id),\n            'recursive' => -1\n        ));\n        if ($this->request->is('post') || $this->request->is('put')) {\n            if (!isset($this->request->data['User'])) {\n                $this->request->data = array('User' => $this->request->data);\n            }\n            $abortPost = false;\n            if (Configure::read('Security.require_password_confirmation')) {\n                if (!empty($this->request->data['User']['current_password'])) {\n                    $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['current_password']);\n                    if (!$hashed) {\n                        $message = __('Invalid password. Please enter your current password to continue.');\n                        if ($this->_isRest()) {\n                            return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                        }\n                        $abortPost = true;\n                        $this->Flash->error($message);\n                    }\n                    unset($this->request->data['User']['current_password']);\n                } else if (!$this->_isRest()) {\n                    $message = __('Please enter your current password to continue.');\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                    }\n                    $abortPost = true;\n                    $this->Flash->info($message);\n                }\n            }\n            $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['password']);\n            if ($hashed) {\n                $message = __('Submitted new password cannot be the same as the current one');\n                $abortPost = true;\n            }\n            if (!$abortPost) {\n                // What fields should be saved (allowed to be saved)\n                $user['User']['change_pw'] = 0;\n                $user['User']['password'] = $this->request->data['User']['password'];\n                if ($this->_isRest()) {\n                    $user['User']['confirm_password'] = $this->request->data['User']['password'];\n                } else {\n                    $user['User']['confirm_password'] = $this->request->data['User']['confirm_password'];\n                }\n                $temp = $user['User']['password'];\n                // Save the data\n                if ($this->User->save($user)) {\n                    $message = __('Password Changed.');\n                    $this->User->extralog($this->Auth->user(), \"change_pw\", null, null, $user);\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveSuccessResponse('User', 'change_pw', false, $this->response->type(), $message);\n                    }\n                    $this->Flash->success($message);\n                    $this->redirect(array('action' => 'view', $id));\n                } else {\n                    $message = __('The password could not be updated. Make sure you meet the minimum password length / complexity requirements.');\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                    }\n                    $this->Flash->error($message);\n                }\n            } else {\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveFailResponse('Users', 'change_pw', false, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                }\n            }\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->describe('Users', 'change_pw', false, $this->response->type());\n        }\n        $this->loadModel('Server');\n        $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n        $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n        $this->User->recursive = 0;\n        $this->User->read(null, $id);\n        $this->User->set('password', '');\n        $this->request->data = $this->User->data;\n        $roles = $this->User->Role->find('list');\n        $this->set('roles', $roles);\n    }\n\n    public function admin_index()\n    {\n        $this->User->virtualFields['org_ci'] = 'UPPER(Organisation.name)';\n        $urlParams = \"\";\n        $passedArgsArray = array();\n        $booleanFields = array('autoalert', 'contactalert', 'termsaccepted', 'disabled');\n        $textFields = array('role', 'email', 'all', 'authkey');\n        // org admins can't see users of other orgs\n        if ($this->_isSiteAdmin()) {\n            $textFields[] = 'org';\n        }\n        $this->set('passedArgs', json_encode($this->passedArgs));\n        // check each of the passed arguments whether they're a filter (could also be a sort for example) and if yes, add it to the pagination conditions\n        if (!empty($this->passedArgs['value'])) {\n            $this->passedArgs['searchall'] = $this->passedArgs['value'];\n        }\n        foreach ($this->passedArgs as $k => $v) {\n            if (substr($k, 0, 6) === 'search') {\n                if ($v != \"\") {\n                    if ($urlParams != \"\") {\n                        $urlParams .= \"/\";\n                    }\n                    $urlParams .= $k . \":\" . $v;\n                }\n                $searchTerm = substr($k, 6);\n                if (in_array($searchTerm, $booleanFields)) {\n                    if ($v != \"\") {\n                        $this->paginate['conditions'][] = array('User.' . $searchTerm => $v);\n                    }\n                } elseif (in_array($searchTerm, $textFields)) {\n                    if ($v != \"\") {\n                        if ($searchTerm == \"role\") {\n                            $searchTerm = \"role_id\";\n                        }\n                        $pieces = explode('|', $v);\n                        $test = array();\n                        foreach ($pieces as $piece) {\n                            if ($piece[0] == '!') {\n                                if ($searchTerm == 'email') {\n                                    $this->paginate['conditions']['AND'][] = array('LOWER(User.' . $searchTerm . ') NOT LIKE' => '%' . strtolower(substr($piece, 1)) . '%');\n                                } elseif ($searchTerm == 'org') {\n                                    $this->paginate['conditions']['AND'][] = array('User.org_id !=' => substr($piece, 1));\n                                } else {\n                                    $this->paginate['conditions']['AND'][] = array('User.' . $searchTerm => substr($piece, 1));\n                                }\n                            } else {\n                                if ($searchTerm == 'email') {\n                                    $test['OR'][] = array('LOWER(User.' . $searchTerm . ') LIKE' => '%' . strtolower($piece) . '%');\n                                } elseif ($searchTerm == 'org') {\n                                    $this->paginate['conditions']['OR'][] = array('User.org_id' => $piece);\n                                } elseif ($searchTerm == 'all') {\n                                    $this->paginate['conditions']['AND'][] = array(\n                                            'OR' => array(\n                                                    'UPPER(User.email) LIKE' => '%' . strtoupper($piece) . '%',\n                                                    'UPPER(Organisation.name) LIKE' => '%' . strtoupper($piece) . '%',\n                                                    'UPPER(Role.name) LIKE' => '%' . strtoupper($piece) . '%',\n                                                    'UPPER(User.authkey) LIKE' => '%' . strtoupper($piece) . '%'\n                                            ),\n                                    );\n                                } else {\n                                    $test['OR'][] = array('User.' . $searchTerm => $piece);\n                                }\n                            }\n                        }\n                        if (!empty($test)) {\n                            $this->paginate['conditions']['AND'][] = $test;\n                        }\n                    }\n                }\n                $passedArgsArray[$searchTerm] = $v;\n            }\n        }\n        $redis = $this->User->setupRedis();\n        if ($this->_isRest()) {\n            $conditions = array();\n            if (isset($this->paginate['conditions'])) {\n                $conditions = $this->paginate['conditions'];\n            }\n            if (!$this->_isSiteAdmin()) {\n                $conditions['User.org_id'] = $this->Auth->user('org_id');\n            }\n            $users = $this->User->find('all', array(\n                    'conditions' => $conditions,\n                    'recursive' => -1,\n                    'fields' => array(\n                        'id',\n            'org_id',\n            'server_id',\n            'email',\n            'autoalert',\n            'authkey',\n            'invited_by',\n            'gpgkey',\n            'certif_public',\n            'nids_sid',\n            'termsaccepted',\n            'newsread',\n            'role_id',\n            'change_pw',\n            'contactalert',\n            'disabled',\n            'expiration',\n            'current_login',\n            'last_login',\n            'force_logout',\n            'date_created',\n            'date_modified'\n                    ),\n                    'contain' => array(\n                            'Organisation' => array('id', 'name'),\n                            'Role' => array('id', 'name', 'perm_auth', 'perm_site_admin')\n                    )\n            ));\n            foreach ($users as $key => $value) {\n                if (empty($this->Auth->user('Role')['perm_site_admin'])) {\n                    if ($value['Role']['perm_site_admin']) {\n                        $users[$key]['User']['authkey'] = __('Redacted');\n                    }\n                } else if (!empty(Configure::read('Security.user_monitoring_enabled'))) {\n                    $users[$key]['User']['monitored'] = $redis->sismember('misp:monitored_users', $value['User']['id']);\n                }\n                unset($users[$key]['User']['password']);\n            }\n            return $this->RestResponse->viewData($users, $this->response->type());\n        } else {\n            $this->set('urlparams', $urlParams);\n            $this->set('passedArgsArray', $passedArgsArray);\n            $conditions = array();\n            if ($this->_isSiteAdmin()) {\n                $users = $this->paginate();\n                if (!empty(Configure::read('Security.user_monitoring_enabled'))) {\n                    foreach ($users as $key => $value) {\n                        $users[$key]['User']['monitored'] = $redis->sismember('misp:monitored_users', $users[$key]['User']['id']);\n                    }\n                }\n                $this->set('users', $users);\n            } else {\n                $conditions['User.org_id'] = $this->Auth->user('org_id');\n                $this->paginate['conditions']['AND'][] = $conditions;\n                $users = $this->paginate();\n                foreach ($users as $key => $value) {\n                    if ($value['Role']['perm_site_admin']) {\n                        $users[$key]['User']['authkey'] = __('Redacted');\n                    }\n                }\n                $this->set('users', $users);\n            }\n        }\n    }\n\n    public function admin_filterUserIndex()\n    {\n        $passedArgsArray = array();\n        $booleanFields = array('autoalert', 'contactalert', 'termsaccepted', 'disabled');\n        $textFields = array('role', 'email');\n        if (empty(Configure::read('Security.advanced_authkeys'))) {\n            $textFields[] = 'authkey';\n        }\n        $showOrg = 0;\n        // org admins can't see users of other orgs\n        if ($this->_isSiteAdmin()) {\n            $textFields[] = 'org';\n            $showOrg = 1;\n        }\n        $this->set('differentFilters', $booleanFields);\n        $this->set('simpleFilters', $textFields);\n        $rules = array_merge($booleanFields, $textFields);\n        $this->set('showorg', $showOrg);\n\n        $filtering = array();\n        foreach ($booleanFields as $b) {\n            $filtering[$b] = '';\n        }\n        foreach ($textFields as $t) {\n            $filtering[$t] = array('OR' => array(), 'NOT' => array());\n        }\n\n        foreach ($this->passedArgs as $k => $v) {\n            if (substr($k, 0, 6) === 'search') {\n                $searchTerm = substr($k, 6);\n                if (in_array($searchTerm, $booleanFields)) {\n                    $filtering[$searchTerm] = $v;\n                } elseif (in_array($searchTerm, $textFields)) {\n                    $pieces = explode('|', $v);\n                    foreach ($pieces as $piece) {\n                        if ($piece[0] == '!') {\n                            $filtering[$searchTerm]['NOT'][] = substr($piece, 1);\n                        } else {\n                            $filtering[$searchTerm]['OR'][] = $piece;\n                        }\n                    }\n                }\n                $passedArgsArray[$searchTerm] = $v;\n            }\n        }\n        $this->set('filtering', json_encode($filtering));\n\n        $roles = $this->User->Role->find('all', array('recursive' => -1));\n        $roleNames = array();\n        $roleJSON = array();\n        foreach ($roles as $k => $v) {\n            $roleNames[$v['Role']['id']] = $v['Role']['name'];\n            $roleJSON[] = array('id' => $v['Role']['id'], 'value' => $v['Role']['name']);\n        }\n        if ($showOrg) {\n            $orgs = $this->User->Organisation->find('list', array(\n                'conditions' => array('local' => 1),\n                'recursive' => -1,\n                'fields' => array('id', 'name'),\n                'order' => array('LOWER(name) ASC')\n            ));\n            $this->set('orgs', $orgs);\n        }\n        $this->set('roles', $roleNames);\n        $this->set('roleJSON', json_encode($roleJSON));\n        $rules = $this->_arrayToValuesIndexArray($rules);\n        $this->set('rules', $rules);\n        $this->set('baseurl', Configure::read('MISP.baseurl'));\n        $this->layout = 'ajax';\n    }\n\n    public function admin_view($id = null)\n    {\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $id),\n            'contain' => [\n                'UserSetting',\n                'Role',\n                'Organisation'\n            ]\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        if (!$this->_isSiteAdmin() && !($this->_isAdmin() && $this->Auth->user('org_id') == $user['User']['org_id'])) {\n            throw new MethodNotAllowedException();\n        }\n        if (!empty($user['User']['gpgkey'])) {\n            $pgpDetails = $this->User->verifySingleGPG($user);\n            $user['User']['pgp_status'] = isset($pgpDetails[2]) ? $pgpDetails[2] : 'OK';\n            $user['User']['fingerprint'] = !empty($pgpDetails[4]) ? $pgpDetails[4] : 'N/A';\n        }\n        $user['User']['orgAdmins'] = $this->User->getOrgAdminsForOrg($user['User']['org_id'], $user['User']['id']);\n        if (empty($this->Auth->user('Role')['perm_site_admin']) && !(empty($user['Role']['perm_site_admin']))) {\n            $user['User']['authkey'] = __('Redacted');\n        }\n        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n            unset($user['User']['authkey']);\n        }\n        if ($this->_isRest()) {\n            $user['User']['password'] = '*****';\n            $temp = array();\n            foreach ($user['UserSetting'] as $k => $v) {\n                $temp[$v['setting']] = $v['value'];\n            }\n            $user['UserSetting'] = $temp;\n            return $this->RestResponse->viewData(array(\n                'User' => $user['User'],\n                'Role' => $user['Role'],\n                'UserSetting' => $user['UserSetting']\n            ), $this->response->type());\n        }\n        $this->set('user', $user);\n        $user2 = $this->User->find('first', array('conditions' => array('User.id' => $user['User']['invited_by']), 'recursive' => -1));\n        $this->set('id', $id);\n        $this->set('user2', $user2);\n        $this->set('admin_view', true);\n        $this->render('view');\n    }\n\n    public function admin_add()\n    {\n        $params = null;\n        if (!$this->_isSiteAdmin()) {\n            $params = array('conditions' => array('perm_site_admin !=' => 1, 'perm_sync !=' => 1, 'perm_regexp_access !=' => 1));\n        }\n        $this->loadModel('AdminSetting');\n        $default_role_id = $this->AdminSetting->getSetting('default_role');\n        $roles = $this->User->Role->find('list', $params);\n        $syncRoles = $this->User->Role->find('list', array('conditions' => array('perm_sync' => 1), 'recursive' => -1));\n        if ($this->request->is('post')) {\n            // In case we don't get the data encapsulated in a User object\n            if ($this->_isRest()) {\n                if (!isset($this->request->data['User'])) {\n                    $this->request->data = array('User' => $this->request->data);\n                }\n                if (isset($this->request->data['User']['id'])) {\n                    unset($this->request->data['User']['id']);\n                }\n                $required_fields = array('role_id', 'email');\n                foreach ($required_fields as $field) {\n                    $set_field_via_other_means = false;\n                    if (empty($this->request->data['User'][$field])) {\n                        if ($field === 'role_id') {\n                            if (!empty($default_role_id)) {\n                                $this->request->data['User'][$field] = $default_role_id;\n                                $set_field_via_other_means = true;\n                            }\n                        }\n                        if (!$set_field_via_other_means) {\n                            return $this->RestResponse->saveFailResponse('Users', 'admin_add', false, array($field => 'Mandatory field not set.'), $this->response->type());\n                        }\n                    }\n                }\n                if (isset($this->request->data['User']['password'])) {\n                    $this->request->data['User']['confirm_password'] = $this->request->data['User']['password'];\n                }\n                $default_publish_alert = Configure::check('MISP.default_publish_alert') ? Configure::read('MISP.default_publish_alert') : 0;\n                $defaults = array(\n                        'external_auth_required' => 0,\n                        'external_auth_key' => '',\n                        'server_id' => 0,\n                        'gpgkey' => '',\n                        'certif_public' => '',\n                        'autoalert' => $default_publish_alert,\n                        'contactalert' => 0,\n                        'disabled' => 0,\n                        'newsread' => 0,\n                        'change_pw' => 1,\n                        'authkey' => (new RandomTool())->random_str(true, 40),\n                        'termsaccepted' => 0,\n                        'org_id' => $this->Auth->user('org_id')\n                );\n                foreach ($defaults as $key => $value) {\n                    if (!isset($this->request->data['User'][$key])) {\n                        $this->request->data['User'][$key] = $value;\n                    }\n                }\n            }\n            $this->request->data['User']['date_created'] = time();\n            $this->request->data['User']['date_modified'] = time();\n            if (!array_key_exists($this->request->data['User']['role_id'], $syncRoles)) {\n                $this->request->data['User']['server_id'] = 0;\n            }\n            $this->User->create();\n            // set invited by\n            $this->loadModel('Role');\n            $this->Role->recursive = -1;\n            $chosenRole = $this->Role->findById($this->request->data['User']['role_id']);\n            if (empty($chosenRole)) {\n                throw new MethodNotAllowedException('Invalid role');\n            }\n            $this->request->data['User']['invited_by'] = $this->Auth->user('id');\n            if (!$this->_isRest()) {\n                if ($chosenRole['Role']['perm_sync']) {\n                    $this->request->data['User']['change_pw'] = 0;\n                    $this->request->data['User']['termsaccepted'] = 1;\n                } else {\n                    $this->request->data['User']['change_pw'] = 1;\n                    $this->request->data['User']['termsaccepted'] = 0;\n                }\n            }\n            if (!isset($this->request->data['User']['disabled'])) {\n                $this->request->data['User']['disabled'] = false;\n            }\n            $this->request->data['User']['newsread'] = 0;\n            if (!$this->_isSiteAdmin()) {\n                $this->request->data['User']['org_id'] = $this->Auth->user('org_id');\n                $this->loadModel('Role');\n                $this->Role->recursive = -1;\n                $chosenRole = $this->Role->findById($this->request->data['User']['role_id']);\n                if (\n                    $chosenRole['Role']['perm_site_admin'] == 1 ||\n                    $chosenRole['Role']['perm_regexp_access'] == 1 ||\n                    $chosenRole['Role']['perm_sync'] == 1 ||\n                    $chosenRole['Role']['restricted_to_site_admin'] == 1\n                ) {\n                    throw new Exception('You are not authorised to assign that role to a user.');\n                }\n            }\n            $organisation = $this->User->Organisation->find('first', array(\n                'conditions' => array('Organisation.id' => $this->request->data['User']['org_id']),\n                'recursive' => -1\n            ));\n            $fail = false;\n            if (!$this->_isSiteAdmin()) {\n                if (!empty($organisation['Organisation']['restricted_to_domain'])) {\n                    $fail = true;\n                    foreach ($organisation['Organisation']['restricted_to_domain'] as $restriction) {\n                        if (\n                            strlen($this->request->data['User']['email']) > strlen($restriction) &&\n                            substr($this->request->data['User']['email'], (-1 * strlen($restriction))) === $restriction &&\n                            in_array($this->request->data['User']['email'][strlen($this->request->data['User']['email']) - strlen($restriction) -1], array('@', '.'))\n                        ) {\n                            $fail = false;\n                        }\n                    }\n                    if ($fail) {\n                        $this->Flash->error(__('Invalid e-mail domain. Your user is restricted to creating users for the following domain(s): ') . implode(', ', $organisation['Organisation']['restricted_to_domain']));\n                    }\n                }\n            }\n            if (!$fail) {\n                if (empty($organisation)) {\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'admin_add', false, array('Invalid organisation'), $this->response->type());\n                    } else {\n                        // reset auth key for a new user\n                        $this->set('authkey', $this->newkey);\n                        $this->Flash->error(__('The user could not be saved. Invalid organisation.'));\n                    }\n                } else {\n                    $fieldList = array('password', 'email', 'external_auth_required', 'external_auth_key', 'enable_password', 'confirm_password', 'org_id', 'role_id', 'authkey', 'nids_sid', 'server_id', 'gpgkey', 'certif_public', 'autoalert', 'contactalert', 'disabled', 'invited_by', 'change_pw', 'termsaccepted', 'newsread', 'date_created', 'date_modified');\n                    if ($this->User->save($this->request->data, true, $fieldList)) {\n                        $notification_message = '';\n                        if (!empty($this->request->data['User']['notify'])) {\n                            $user = $this->User->find('first', array('conditions' => array('User.id' => $this->User->id), 'recursive' => -1));\n                            $password = isset($this->request->data['User']['password']) ? $this->request->data['User']['password'] : false;\n                            $result = $this->User->initiatePasswordReset($user, true, true, $password);\n                            if ($result && empty(Configure::read('MISP.disable_emailing'))) {\n                                $notification_message .= ' ' . __('User notified of new credentials.');\n                            } else {\n                                $notification_message .= ' ' . __('User notification of new credentials could not be send.');\n                            }\n                        }\n                        if (!empty(Configure::read('Security.advanced_authkeys')) && $this->_isRest()) {\n                            $this->loadModel('AuthKey');\n                            $newKey = $this->AuthKey->createnewkey($this->User->id);\n                        }\n                        if ($this->_isRest()) {\n                            $user = $this->User->find('first', array(\n                                    'conditions' => array('User.id' => $this->User->id),\n                                    'recursive' => -1\n                            ));\n                            $user['User']['password'] = '******';\n                            if (!empty(Configure::read('Security.advanced_authkeys'))) {\n                                $user['User']['authkey'] = $newKey;\n                            }\n                            return $this->RestResponse->viewData($user, $this->response->type());\n                        } else {\n                            $this->Flash->success(__('The user has been saved.') . $notification_message);\n                            $this->redirect(array('action' => 'index'));\n                        }\n                    } else {\n                        if ($this->_isRest()) {\n                            return $this->RestResponse->saveFailResponse('Users', 'admin_add', false, $this->User->validationErrors, $this->response->type());\n                        } else {\n                            // reset auth key for a new user\n                            $this->set('authkey', $this->newkey);\n                            $this->Flash->error(__('The user could not be saved. Please, try again.'));\n                        }\n                    }\n                }\n            }\n        }\n        if (!$this->_isRest()) {\n            $this->newkey = $this->User->generateAuthKey();\n            $this->set('authkey', $this->newkey);\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->describe('Users', 'admin_add', false, $this->response->type());\n        } else {\n            $orgs = $this->User->Organisation->find('list', array(\n                    'conditions' => array('local' => 1),\n                    'order' => array('lower(name) asc')\n            ));\n            $this->set('orgs', $orgs);\n            // generate auth key for a new user\n            $this->loadModel('Server');\n            $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n            $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n            $conditions = array();\n            if (!$this->_isSiteAdmin()) {\n                $conditions['Server.org_id LIKE'] = $this->Auth->user('org_id');\n            }\n            $temp = $this->Server->find('all', array('conditions' => $conditions, 'recursive' => -1, 'fields' => array('id', 'name', 'url')));\n            $servers = array(0 => 'Not bound to a server');\n            if (!empty($temp)) {\n                foreach ($temp as $t) {\n                    if (!empty($t['Server']['name'])) {\n                        $servers[$t['Server']['id']] = $t['Server']['name'];\n                    } else {\n                        $servers[$t['Server']['id']] = $t['Server']['url'];\n                    }\n                }\n            }\n            $this->set('currentOrg', $this->Auth->user('org_id'));\n            $this->set('isSiteAdmin', $this->_isSiteAdmin());\n            $this->set('default_role_id', $default_role_id);\n            $this->set('servers', $servers);\n            $this->set(compact('roles'));\n            $this->set(compact('syncRoles'));\n        }\n    }\n\n    public function admin_edit($id = null)\n    {\n        $this->set('currentOrg', $this->Auth->user('org_id'));\n        $this->User->id = $id;\n        $params = array();\n        $allowedRole = '';\n        $userToEdit = $this->User->find('first', array(\n            'conditions' => array('User.id' => $id),\n            'recursive' => -1,\n            'fields' => array('User.id', 'User.role_id', 'User.email', 'User.org_id', 'Role.perm_site_admin'),\n            'contain' => array('Role')\n        ));\n        if (empty($userToEdit)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        if (!$this->_isSiteAdmin()) {\n            // Org admins should be able to select the role that is already assigned to an org user when editing them.\n            // What happened previously:\n            // Org admin edits another org admin of the same org\n            // Org admin is not allowed to set privileged access roles (site_admin/sync/regex)\n            // MISP automatically chooses the first available option for the user as the selected setting (usually user)\n            // Org admin is downgraded to a user\n            // Now we make an exception for the already assigned role, both in the form and the actual edit.\n            if ($userToEdit['User']['org_id'] != $this->Auth->user('org_id') || !empty($userToEdit['Role']['perm_site_admin'])) {\n                throw new NotFoundException(__('Invalid user'));\n            }\n            $allowedRole = $userToEdit['User']['role_id'];\n            $params = array('conditions' => array(\n                    'OR' => array(\n                            'AND' => array(\n                                'perm_site_admin' => 0, 'perm_sync' => 0, 'perm_regexp_access' => 0, 'restricted_to_site_admin' => 0\n                            ),\n                            'id' => $allowedRole,\n                    )\n            ));\n        }\n        $roles = $this->User->Role->find('list', $params);\n        $syncRoles = $this->User->Role->find('list', array('conditions' => array('perm_sync' => 1), 'recursive' => -1));\n        $this->set('currentId', $id);\n        if ($this->request->is('post') || $this->request->is('put')) {\n            if (!isset($this->request->data['User'])) {\n                $this->request->data['User'] = $this->request->data;\n            }\n            $abortPost = false;\n            if (!$this->_isRest() || empty($this->request->header('Authorization'))) {\n                if (Configure::read('Security.require_password_confirmation')) {\n                    if (!empty($this->request->data['User']['current_password'])) {\n                        $hashed = $this->User->verifyPassword($this->Auth->user('id'), $this->request->data['User']['current_password']);\n                        if (!$hashed) {\n                            $abortPost = true;\n                            $this->Flash->error('Invalid password. Please enter your current password to continue.');\n                        }\n                        unset($this->request->data['User']['current_password']);\n                    } else {\n                        $abortPost = true;\n                        $this->Flash->info('Please enter your current password to continue.');\n                    }\n                }\n            }\n            if (!$this->_isSiteAdmin() && !$abortPost) {\n                $organisation = $this->User->Organisation->find('first', array(\n                    'conditions' => array('Organisation.id' => $userToEdit['User']['org_id']),\n                    'recursive' => -1\n                ));\n                if (!empty($organisation['Organisation']['restricted_to_domain'])) {\n                    $abortPost = true;\n                    foreach ($organisation['Organisation']['restricted_to_domain'] as $restriction) {\n                        if (\n                            strlen($this->request->data['User']['email']) > strlen($restriction) &&\n                            substr($this->request->data['User']['email'], (-1 * strlen($restriction))) === $restriction &&\n                            in_array($this->request->data['User']['email'][strlen($this->request->data['User']['email']) - strlen($restriction) -1], array('@', '.'))\n                        ) {\n                            $abortPost = false;\n                        }\n                    }\n                    if ($abortPost) {\n                        $this->Flash->error(__('Invalid e-mail domain. Your user is restricted to creating users for the following domain(s): ') . implode(', ', $organisation['Organisation']['restricted_to_domain']));\n                    }\n                }\n            }\n            if (!$abortPost) {\n                $this->request->data['User']['id'] = $id;\n                if (!isset($this->request->data['User']['email'])) {\n                    $this->request->data['User']['email'] = $userToEdit['User']['email'];\n                }\n                if (isset($this->request->data['User']['role_id']) && !array_key_exists($this->request->data['User']['role_id'], $syncRoles)) {\n                    $this->request->data['User']['server_id'] = 0;\n                }\n                $fields = [];\n                $blockedFields = array('id', 'invited_by', 'date_modified');\n                if (!$this->_isSiteAdmin()) {\n                    $blockedFields[] = 'org_id';\n                }\n                if (!$this->__canChangeLogin()) {\n                    $blockedFields[] = 'email';\n                }\n                if (!$this->__canChangePassword()) {\n                    $blockedFields[] = 'enable_password';\n                    $blockedFields[] = 'change_pw';\n                }\n                foreach (array_keys($this->request->data['User']) as $field) {\n                    if (in_array($field, $blockedFields)) {\n                        continue;\n                    }\n                    if ($field != 'password') {\n                        $fields[] = $field;\n                    }\n                }\n                if (\n                    (!empty($this->request->data['User']['enable_password']) || $this->_isRest()) &&\n                    !empty($this->request->data['User']['password']) &&\n                    $this->__canChangePassword()\n                ) {\n                    $fields[] = 'password';\n                    if ($this->_isRest() && !isset($this->request->data['User']['confirm_password'])) {\n                        $this->request->data['User']['confirm_password'] = $this->request->data['User']['password'];\n                        $fields[] = 'confirm_password';\n                    }\n                }\n                if (!$this->_isRest()) {\n                    $fields[] = 'role_id';\n                }\n                if (!$this->_isSiteAdmin() && isset($this->request->data['User']['role_id'])) {\n                    $this->loadModel('Role');\n                    $this->Role->recursive = -1;\n                    $chosenRole = $this->Role->findById($this->request->data['User']['role_id']);\n                    if (empty($chosenRole) || (($chosenRole['Role']['id'] != $allowedRole) && ($chosenRole['Role']['perm_site_admin'] == 1 || $chosenRole['Role']['perm_regexp_access'] == 1 || $chosenRole['Role']['perm_sync'] == 1))) {\n                        throw new Exception('You are not authorised to assign that role to a user.');\n                    }\n                }\n                $fields[] = 'date_modified'; // time will be inserted in `beforeSave` action\n\n                $fieldsOldValues = $this->User->find('first', [\n                    'recursive' => -1,\n                    'conditions' => ['id' => $id],\n                ])['User'];\n\n                if ($this->User->save($this->request->data, true, $fields)) {\n                    // newValues to array\n                    $fieldsNewValues = array();\n                    foreach ($fields as $field) {\n                        if ($field === 'date_modified') {\n                            continue;\n                        }\n                        if ($field !== 'confirm_password') {\n                            $newValue = $this->data['User'][$field];\n                            if (is_array($newValue)) {\n                                $newValueStr = '';\n                                $cP = 0;\n                                foreach ($newValue as $newValuePart) {\n                                    if ($cP < 2) {\n                                        $newValueStr .= '-' . $newValuePart;\n                                    } else {\n                                        $newValueStr = $newValuePart . $newValueStr;\n                                    }\n                                    $cP++;\n                                }\n                                $fieldsNewValues[$field] = $newValueStr;\n                            } else {\n                                $fieldsNewValues[$field] = $newValue;\n                            }\n                        } else {\n                            $fieldsNewValues[$field] = $this->data['User']['password'];\n                        }\n                    }\n                    // compare\n                    $fieldsResult = array();\n                    foreach ($fields as $field) {\n                        if ($field === 'date_modified') {\n                            continue;\n                        }\n                        if (isset($fieldsOldValues[$field]) && $fieldsOldValues[$field] != $fieldsNewValues[$field]) {\n                            if ($field != 'confirm_password' && $field != 'enable_password') {\n                                $fieldsResult[$field] = array($fieldsOldValues[$field], $fieldsNewValues[$field]);\n                            }\n                        }\n                    }\n                    $user = $this->User->find('first', array(\n                        'recursive' => -1,\n                        'conditions' => array('User.id' => $this->User->id)\n                    ));\n                    $this->User->extralog($this->Auth->user(), \"edit\", \"user\", $fieldsResult, $user);\n                    if ($this->_isRest()) {\n                        $user['User']['password'] = '******';\n                        if (!empty(Configure::read('Security.advanced_authkeys'))) {\n                            unset($user['User']['authkey']);\n                        }\n                        return $this->RestResponse->viewData($user, $this->response->type());\n                    } else {\n                        $this->Flash->success(__('The user has been saved'));\n                        $this->redirect(array('action' => 'index'));\n                    }\n                } else {\n                    if ($this->_isRest()) {\n                        return $this->RestResponse->saveFailResponse('Users', 'admin_edit', $id, $this->User->validationErrors, $this->response->type());\n                    } else {\n                        $this->Flash->error(__('The user could not be saved. Please, try again.'));\n                    }\n                }\n            }\n        } else {\n            if ($this->_isRest()) {\n                return $this->RestResponse->describe('Users', 'admin_edit', $id, $this->response->type());\n            }\n            $this->User->read(null, $id);\n            if (!$this->_isSiteAdmin() && $this->Auth->user('org_id') != $this->User->data['User']['org_id']) {\n                $this->redirect(array('controller' => 'users', 'action' => 'index', 'admin' => true));\n            }\n            $this->User->set('password', '');\n            $this->request->data = $this->User->data;\n        }\n        if ($this->_isSiteAdmin()) {\n            $orgs = $this->User->Organisation->find('list', array(\n                    'conditions' => array('local' => 1),\n                    'order' => array('lower(name) asc')\n            ));\n        } else {\n            $orgs = array();\n        }\n        $this->loadModel('Server');\n        $this->set('complexity', !empty(Configure::read('Security.password_policy_complexity')) ? Configure::read('Security.password_policy_complexity') : $this->Server->serverSettings['Security']['password_policy_complexity']['value']);\n        $this->set('length', !empty(Configure::read('Security.password_policy_length')) ? Configure::read('Security.password_policy_length') : $this->Server->serverSettings['Security']['password_policy_length']['value']);\n        $conditions = array();\n        if (!$this->_isSiteAdmin()) {\n            $conditions['Server.org_id LIKE'] = $this->Auth->user('org_id');\n        }\n        $temp = $this->Server->find('all', array('conditions' => $conditions, 'recursive' => -1, 'fields' => array('id', 'name', 'url')));\n        $servers = array(0 => 'Not bound to a server');\n        foreach ($temp as $t) {\n            if (!empty($t['Server']['name'])) {\n                $servers[$t['Server']['id']] = $t['Server']['name'];\n            } else {\n                $servers[$t['Server']['id']] = $t['Server']['url'];\n            }\n        }\n        $this->set('servers', $servers);\n        $this->set('orgs', $orgs);\n        $this->set('id', $id);\n        $this->set(compact('roles'));\n        $this->set(compact('syncRoles'));\n        $this->set('canChangeLogin', $this->__canChangeLogin());\n        $this->set('canChangePassword', $this->__canChangePassword());\n    }\n\n    public function admin_delete($id = null)\n    {\n        if (!$this->request->is('post') && !$this->request->is('delete')) {\n            throw new MethodNotAllowedException(__('Action not allowed, post or delete request expected.'));\n        }\n        if (!$this->_isAdmin()) {\n            throw new Exception('Administrators only.');\n        }\n        $this->User->id = $id;\n        $conditions = array('User.id' => $id);\n        if (!$this->_isSiteAdmin()) {\n            $conditions['org_id'] = $this->Auth->user('org_id');\n        }\n        $user = $this->User->find('first', array(\n                'conditions' => $conditions,\n                'recursive' => -1\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user'));\n        }\n        $fieldsDescrStr = 'User (' . $id . '): ' . $user['User']['email'];\n        if ($this->User->delete($id)) {\n            $this->User->extralog($this->Auth->user(), \"delete\", $fieldsDescrStr, '');\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveSuccessResponse('User', 'admin_delete', $id, $this->response->type(), 'User deleted.');\n            } else {\n                $this->Flash->success(__('User deleted'));\n                $this->redirect(array('action' => 'index'));\n            }\n        }\n        $this->Flash->error(__('User was not deleted'));\n        $this->redirect(array('action' => 'index'));\n    }\n\n    public function admin_massToggleField($fieldName, $enabled)\n    {\n        if (!in_array($fieldName, $this->toggleableFields)) {\n            throw new MethodNotAllowedException(__('The field `%s` cannot be toggled', $fieldName));\n        }\n        if (!$this->_isAdmin()) {\n            throw new UnauthorizedException(__('Administrators only'));\n        }\n        if ($this->request->is('post') || $this->request->is('put')) {\n            $jsonIds = $this->request->data['User']['user_ids'];\n            $ids = $this->User->jsonDecode($jsonIds);\n            $conditions = ['User.id' => $ids];\n            if (!$this->_isSiteAdmin()) {\n                $conditions['User.org_id'] = $this->Auth->user('org_id');\n            }\n            $users = $this->User->find('all', [\n                    'conditions' => $conditions,\n                    'recursive' => -1\n            ]);\n            if (empty($users)) {\n                throw new NotFoundException(__('Invalid users'));\n            }\n            $count = 0;\n            foreach ($users as $user) {\n                if ($user['User'][$fieldName] != $enabled) {\n                    $this->User->id = $user['User']['id'];\n                    $this->User->saveField($fieldName, $enabled);\n                    $count++;\n                }\n            }\n            if ($count > 0) {\n                $message = __('%s users got their field `%s` %s', $count, $fieldName, $enabled ? __('enabled') : __('disabled'));\n            } else {\n                $message = __('All users have already their field `%s` %s', $fieldName, $enabled ? __('enabled') : __('disabled'));\n            }\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveSuccessResponse('User', 'admin_massToggleField', 'selected', $this->response->type(), $message);\n            } else {\n                if ($count > 0) {\n                    $this->Flash->success($message);\n                } else {\n                    $this->Flash->info($message);\n                }\n                $this->redirect('/admin/users/index');\n            }\n        }\n    }\n\n    public function updateLoginTime()\n    {\n        if (!$this->request->is('post')) {\n            throw new MethodNotAllowedException('This feature is only accessible via POST requests');\n        }\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $this->Auth->user('id'))\n        ));\n        $this->User->id = $this->Auth->user('id');\n        $this->User->saveField('last_login', time());\n        $this->User->saveField('current_login', time());\n        $user = $this->User->getAuthUser($user['User']['id']);\n        $this->Auth->login($user);\n        $this->redirect(array('Controller' => 'User', 'action' => 'dashboard'));\n    }\n\n    public function login()\n    {\n        $oldHash = false;\n        if ($this->request->is('post') || $this->request->is('put')) {\n            $this->Bruteforce = ClassRegistry::init('Bruteforce');\n            if (!empty($this->request->data['User']['email'])) {\n                if ($this->Bruteforce->isBlocklisted($_SERVER['REMOTE_ADDR'], $this->request->data['User']['email'])) {\n                    $expire = Configure::check('SecureAuth.expire') ? Configure::read('SecureAuth.expire') : 300;\n                    throw new ForbiddenException('You have reached the maximum number of login attempts. Please wait ' . $expire . ' seconds and try again.');\n                }\n            }\n            // Check the length of the user's authkey match old format. This can be removed in future.\n            $userPass = $this->User->find('first', [\n                'conditions' => ['User.email' => $this->request->data['User']['email']],\n                'fields' => ['User.password'],\n                'recursive' => -1,\n            ]);\n            if (!empty($userPass) && strlen($userPass['User']['password']) === 40) {\n                $oldHash = true;\n                unset($this->Auth->authenticate['Form']['passwordHasher']); // use default password hasher\n                $this->Auth->constructAuthenticate();\n            }\n        }\n        if ($this->request->is('post') && Configure::read('Security.email_otp_enabled')) {\n            $user = $this->Auth->identify($this->request, $this->response);\n            if ($user && !$user['disabled']) {\n              $this->Session->write('email_otp_user', $user);\n              return $this->redirect('email_otp');\n            }\n        }\n        $formLoginEnabled = isset($this->Auth->authenticate['Form']);\n        $this->set('formLoginEnabled', $formLoginEnabled);\n\n        if ($this->Auth->login()) {\n            if ($oldHash) {\n                // Convert old style password hash to blowfish\n                $passwordToSave = $this->request->data['User']['password'];\n                // Password is converted to hashed form automatically\n                $this->User->save(['id' => $this->Auth->user('id'), 'password' => $passwordToSave], false, ['password']);\n            }\n            $this->_postlogin();\n        } else {\n            $dataSourceConfig = ConnectionManager::getDataSource('default')->config;\n            $dataSource = $dataSourceConfig['datasource'];\n            // don't display authError before first login attempt\n            if (str_replace(\"//\", \"/\", $this->webroot . $this->Session->read('Auth.redirect')) == $this->webroot && $this->Session->read('Message.auth.message') == $this->Auth->authError) {\n                $this->Session->delete('Message.auth');\n            }\n            // don't display \"invalid user\" before first login attempt\n            if ($this->request->is('post') || $this->request->is('put')) {\n                $this->Flash->error(__('Invalid username or password, try again'));\n                if (isset($this->request->data['User']['email'])) {\n                    $this->Bruteforce->insert($_SERVER['REMOTE_ADDR'], $this->request->data['User']['email']);\n                }\n            }\n            // populate the DB with the first role (site admin) if it's empty\n            if (!$this->User->Role->hasAny()) {\n                $siteAdmin = array('Role' => array(\n                    'id' => 1,\n                    'name' => 'Site Admin',\n                    'permission' => 3,\n                    'perm_add' => 1,\n                    'perm_modify' => 1,\n                    'perm_modify_org' => 1,\n                    'perm_publish' => 1,\n                    'perm_sync' => 1,\n                    'perm_admin' => 1,\n                    'perm_audit' => 1,\n                    'perm_auth' => 1,\n                    'perm_site_admin' => 1,\n                    'perm_regexp_access' => 1,\n                    'perm_sharing_group' => 1,\n                    'perm_template' => 1,\n                    'perm_tagger' => 1,\n                ));\n                $this->User->Role->save($siteAdmin);\n                // PostgreSQL: update value of auto incremented serial primary key after setting the column by force\n                if ($dataSource === 'Database/Postgres') {\n                    $sql = \"SELECT setval('roles_id_seq', (SELECT MAX(id) FROM roles));\";\n                    $this->User->Role->query($sql);\n                }\n            }\n            if (!$this->User->Organisation->hasAny(array('Organisation.local' => true))) {\n                $this->User->runUpdates();\n                $date = date('Y-m-d H:i:s');\n                $org = array('Organisation' => array(\n                        'id' => 1,\n                        'name' => !empty(Configure::read('MISP.org')) ? Configure::read('MISP.org') : 'ADMIN',\n                        'description' => 'Automatically generated admin organisation',\n                        'type' => 'ADMIN',\n                        'uuid' => CakeText::uuid(),\n                        'local' => 1,\n                        'date_created' => $date,\n                        'sector' => '',\n                        'nationality' => ''\n                ));\n                $this->User->Organisation->save($org);\n                // PostgreSQL: update value of auto incremented serial primary key after setting the column by force\n                if ($dataSource === 'Database/Postgres') {\n                    $sql = \"SELECT setval('organisations_id_seq', (SELECT MAX(id) FROM organisations));\";\n                    $this->User->Organisation->query($sql);\n                }\n                $org_id = $this->User->Organisation->id;\n            }\n\n            // populate the DB with the first user if it's empty\n            if (!$this->User->hasAny()) {\n                if (!isset($org_id)) {\n                    $hostOrg = $this->User->Organisation->find('first', array('conditions' => array('Organisation.name' => Configure::read('MISP.org'), 'Organisation.local' => true), 'recursive' => -1));\n                    if (!empty($hostOrg)) {\n                        $org_id = $hostOrg['Organisation']['id'];\n                    } else {\n                        $firstOrg = $this->User->Organisation->find('first', array('conditions' => array('Organisation.local' => true), 'order' => 'Organisation.id ASC'));\n                        $org_id = $firstOrg['Organisation']['id'];\n                    }\n                }\n\n                $this->User->runUpdates();\n                $this->User->createInitialUser($org_id);\n            }\n        }\n    }\n\n    private function _postlogin()\n    {\n      $this->User->extralog($this->Auth->user(), \"login\");\n      $this->User->Behaviors->disable('SysLogLogable.SysLogLogable');\n      $this->User->id = $this->Auth->user('id');\n      $user = $this->User->find('first', array(\n          'conditions' => array(\n              'User.id' => $this->Auth->user('id')\n          ),\n          'recursive' => -1\n      ));\n      unset($user['User']['password']);\n      $this->User->updateLoginTimes($user['User']);\n      $lastUserLogin = $user['User']['last_login'];\n      $this->User->Behaviors->enable('SysLogLogable.SysLogLogable');\n      if ($lastUserLogin) {\n          $readableDatetime = (new DateTime())->setTimestamp($lastUserLogin)->format('D, d M y H:i:s O'); // RFC822\n          $this->Flash->info(__('Welcome! Last login was on %s', $readableDatetime));\n      }\n      // no state changes are ever done via GET requests, so it is safe to return to the original page:\n      $this->redirect($this->Auth->redirectUrl());\n    }\n\n    public function routeafterlogin()\n    {\n        // Events list\n        $url = $this->Session->consume('pre_login_requested_url');\n        if (!empty(Configure::read('MISP.forceHTTPSforPreLoginRequestedURL')) && !empty($url)) {\n            if (substr($url, 0, 7) === \"http://\") {\n                $url = sprintf('https://%s', substr($url, 7));\n            }\n        }\n        if (empty($url)) {\n            $homepage = $this->User->UserSetting->getValueForUser($this->Auth->user('id'), 'homepage');\n            if (!empty($homepage)) {\n                $url = $homepage['path'];\n            } else {\n                $url = array('controller' => 'events', 'action' => 'index');\n            }\n        }\n        $this->redirect($url);\n    }\n\n    public function logout()\n    {\n        if ($this->Session->check('Auth.User')) {\n            $this->User->extralog($this->Auth->user(), \"logout\");\n        }\n        if (!Configure::read('Plugin.CustomAuth_custom_logout')) {\n            $this->Flash->info(__('Good-Bye'));\n        }\n        $user = $this->User->find('first', array(\n            'conditions' => array(\n                'User.id' => $this->Auth->user('id')\n            ),\n            'recursive' => -1\n        ));\n        unset($user['User']['password']);\n        $user['User']['action'] = 'logout';\n        $this->User->save($user['User'], true, array('id'));\n        $this->redirect($this->Auth->logout());\n    }\n\n    public function resetauthkey($id = null, $alert = false)\n    {\n        if (!$this->request->is('post') && !$this->request->is('put')) {\n            throw new MethodNotAllowedException(__('This functionality is only accessible via POST requests.'));\n        }\n        if ($id === 'me') {\n            $id = $this->Auth->user('id');\n            // Reset just current auth key\n            $keyId = isset($this->Auth->user()['authkey_id']) ? $this->Auth->user()['authkey_id'] : null;\n        } else {\n            $keyId = null;\n        }\n        $newkey = $this->User->resetauthkey($this->Auth->user(), $id, $alert, $keyId);\n        if ($newkey === false) {\n            throw new MethodNotAllowedException(__('Invalid user.'));\n        }\n        if (!$this->_isRest()) {\n            $this->Flash->success(__('New authkey generated.'));\n            $this->redirect($this->referer());\n        } else {\n            return $this->RestResponse->saveSuccessResponse('User', 'resetauthkey', $id, $this->response->type(), 'Authkey updated: ' . $newkey);\n        }\n    }\n\n    public function resetAllSyncAuthKeys()\n    {\n        if (!$this->request->is('post')) {\n            throw new MethodNotAllowedException(__('This functionality is only accessible via POST requests.'));\n        }\n        $results = $this->User->resetAllSyncAuthKeysRouter($this->Auth->user());\n        if ($results === true) {\n            $message = __('Job initiated.');\n        } else {\n            $message = __('%s authkeys reset, %s could not be reset.', $results['success'], $results['fails']);\n        }\n        if (!$this->_isRest()) {\n            $this->Flash->info($message);\n            $this->redirect($this->referer());\n        } else {\n            return $this->RestResponse->saveSuccessResponse('User', 'resetAllSyncAuthKeys', false, $this->response->type(), $message);\n        }\n    }\n\n    public function histogram($selected = null)\n    {\n        //if (!$this->request->is('ajax') && !$this->_isRest()) throw new MethodNotAllowedException('This function can only be accessed via AJAX or the API.');\n        if ($selected == '[]') {\n            $selected = null;\n        }\n        $selectedTypes = array();\n        if ($selected) {\n            $selectedTypes = json_decode($selected);\n        }\n        if (!$this->_isSiteAdmin() && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n            $org_ids = array($this->Auth->user('org_id'));\n        } else {\n            $org_ids = $this->User->Event->find('column', array(\n                'fields' => array('Event.orgc_id'),\n                'unique' => true,\n            ));\n        }\n        $orgs_temp = $this->User->Organisation->find('list', array(\n            'fields' => array('Organisation.id', 'Organisation.name'),\n            'conditions' => array('Organisation.id' => $org_ids)\n        ));\n        $orgs = array(0 => 'All organisations');\n        foreach ($org_ids as $v) {\n            if (!empty($orgs_temp[$v])) {\n                $orgs[$v] = $orgs_temp[$v];\n            }\n        }\n        $data = array();\n        $max = 1;\n        foreach ($orgs as $org_id => $org_name) {\n            $conditions = array('Attribute.deleted' => 0);\n            if ($selected) {\n                $conditions['Attribute.type'] = $selectedTypes;\n            }\n            if ($org_id != 0) {\n                $conditions['Event.orgc_id'] = $org_id;\n            }\n            $params = array(\n                'recursive' => -1,\n                'fields' => array('Attribute.type', 'COUNT(*) as num_types'),\n                'group' => array('Attribute.type'),\n                'joins' => array(\n                    array(\n                        'table' => 'events',\n                        'alias' => 'Event',\n                        'type' => 'LEFT',\n                        'conditions' => array(\n                            'Attribute.event_id = Event.id'\n                        )\n                    )\n                ),\n                //'order' => array('num_types DESC'),\n                'conditions' => $conditions,\n                'order' => false\n            );\n            if ($org_id == 0) {\n                unset($params['joins']);\n            }\n            $temp = $this->User->Event->Attribute->find('all', $params);\n            $temp = Hash::combine($temp, '{n}.Attribute.type', '{n}.0.num_types');\n            $total = 0;\n            foreach ($temp as $v) {\n                $v = (int) $v;\n                if ($v > $max) {\n                    $max = $v;\n                }\n                $total += $v;\n            }\n            $data[$org_id] = [\n                'data' => $temp,\n                'org_name' => $org_name,\n                'total' => $total,\n            ];\n        }\n        uasort($data, function ($a, $b) {\n            return $b['total'] - $a['total'];\n        });\n        $data = array_values($data);\n\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($data, $this->response->type());\n        }\n\n        $this->set('data', $data);\n        $this->set('max', $max);\n        $this->set('selectedTypes', $selectedTypes);\n\n        // Nice graphical histogram\n        $sigTypes = array_keys($this->User->Event->Attribute->typeDefinitions);\n        App::uses('ColourPaletteTool', 'Tools');\n        $paletteTool = new ColourPaletteTool();\n        $colours = $paletteTool->createColourPalette(count($sigTypes));\n        $typeDb = array();\n        foreach ($sigTypes as $k => $type) {\n            $typeDb[$type] = $colours[$k];\n        }\n\n        $this->set('typeDb', $typeDb);\n        $this->set('sigTypes', $sigTypes);\n        $this->layout = 'ajax';\n    }\n\n    public function terms()\n    {\n        if ($this->request->is('post') || $this->request->is('put')) {\n            $this->User->updateField($this->Auth->user(), 'termsaccepted', true);\n            $this->Flash->success(__('You accepted the Terms and Conditions.'));\n            $this->redirect(array('action' => 'routeafterlogin'));\n        }\n        $this->set('termsaccepted', $this->Auth->user('termsaccepted'));\n    }\n\n    public function downloadTerms()\n    {\n        if (!Configure::read('MISP.terms_file')) {\n            $termsFile = APP .\"View/Users/terms\";\n        } else {\n            $termsFile = APP . 'files' . DS . 'terms' . DS .  Configure::read('MISP.terms_file');\n        }\n        $this->response->file($termsFile, array('download' => true, 'name' => Configure::read('MISP.terms_file')));\n        return $this->response;\n    }\n\n    public function checkAndCorrectPgps()\n    {\n        if (!self::_isAdmin()) {\n            throw new NotFoundException();\n        }\n        $this->set('fails', $this->User->checkAndCorrectPgps());\n    }\n\n    public function admin_quickEmail($user_id)\n    {\n        if (!$this->_isAdmin()) {\n            throw new MethodNotAllowedException();\n        }\n        $conditions = array('User.id' => $user_id);\n        if (!$this->_isSiteAdmin()) {\n            $conditions['User.org_id'] = $this->Auth->user('org_id');\n        }\n        $user = $this->User->find('first', array(\n            'conditions' => $conditions,\n            'recursive' => -1\n        ));\n        $error = false;\n        if (empty($user)) {\n            $error = 'Invalid user.';\n        }\n        if (!$error && $user['User']['disabled']) {\n            $error = 'Cannot send an e-mail to this user as the account is disabled.';\n        }\n        $encryption = false;\n        if (!$error && !empty($user['User']['gpgkey'])) {\n            $encryption = 'PGP';\n        } elseif (!$error && !empty($user['User']['certif_public'])) {\n            $encryption = 'SMIME';\n        }\n        $this->set('encryption', $encryption);\n        if (!$error && !$encryption && (Configure::read('GnuPG.onlyencrypted') || Configure::read('GnuPG.bodyonlyencrypted'))) {\n            $error = 'No encryption key found for the user and the instance posture blocks non encrypted e-mails from being sent.';\n        }\n        if ($error) {\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveFailResponse('Users', 'admin_quickEmail', false, $error, $this->response->type());\n            } else {\n                $this->Flash->error($error);\n                $this->redirect('/admin/users/view/' . $user_id);\n            }\n        }\n        if ($this->request->is('post')) {\n            if (!isset($this->request->data['User'])) {\n                $this->request->data['User'] = $this->request->data;\n            }\n            if (empty($this->request->data['User']['subject']) || empty($this->request->data['User']['body'])) {\n                $message = 'Both the subject and the body have to be set.';\n                if ($this->_isRest()) {\n                    throw new MethodNotAllowedException($message);\n                } else {\n                    $this->Flash->error($message);\n                    $this->redirect('/admin/users/quickEmail/' . $user_id);\n                }\n            }\n            $result = $this->User->sendEmail($user, $this->request->data['User']['body'], false, $this->request->data['User']['subject']);\n            if ($this->_isRest()) {\n                if ($result) {\n                    return $this->RestResponse->saveSuccessResponse('User', 'admin_quickEmail', $id, $this->response->type(), 'User deleted.');\n                } else {\n                    return $this->RestResponse->saveFailResponse('Users', 'admin_quickEmail', false, $this->User->validationErrors, $this->response->type());\n                }\n            } else {\n                if ($result) {\n                    $this->Flash->success('Email sent.');\n                } else {\n                    $this->Flash->error('Could not send e-mail.');\n                }\n                $this->redirect('/admin/users/view/' . $user_id);\n            }\n        } elseif ($this->_isRest()) {\n            return $this->RestResponse->describe('Users', 'admin_quickEmail', false, $this->response->type());\n        }\n        $this->set('encryption', $encryption);\n        $this->set('user', $user);\n    }\n\n    public function admin_email($isPreview=false)\n    {\n        if (!$this->_isAdmin()) {\n            throw new MethodNotAllowedException();\n        }\n        $isPostOrPut = $this->request->is('post') || $this->request->is('put');\n        $conditions = array();\n        if (!$this->_isSiteAdmin()) {\n            $conditions = array('org_id' => $this->Auth->user('org_id'));\n        }\n\n        // harvest parameters\n        if ($isPostOrPut) {\n            $recipient = $this->request->data['User']['recipient'];\n        } else {\n            $recipient = isset($this->params['named']['recipient']) ? $this->params['named']['recipient'] : null;\n        }\n        if ($isPostOrPut) {\n            $recipientEmailList = $this->request->data['User']['recipientEmailList'];\n        } else {\n            $recipientEmailList = isset($this->params['named']['recipientEmailList']) ? $this->params['named']['recipientEmailList'] : null;\n        }\n        if ($isPostOrPut) {\n            $orgNameList = $this->request->data['User']['orgNameList'];\n        } else {\n            $orgNameList = isset($this->params['named']['orgNameList']) ? $this->params['named']['orgNameList'] : null;\n        }\n\n        if (!is_null($recipient) && $recipient == 0) {\n            if (is_null($recipientEmailList)) {\n                throw new NotFoundException(__('Recipient email not provided'));\n            }\n            $conditions['id'] = $recipientEmailList;\n        } elseif (!is_null($recipient) && $recipient == 2) {\n            if (is_null($orgNameList)) {\n                throw new NotFoundException(__('Recipient organisation not provided'));\n            }\n            $conditions['org_id'] = $orgNameList;\n        }\n        $conditions['AND'][] = array('User.disabled' => 0);\n\n        // Allow to mimic real form post\n        if ($isPreview) {\n            $users = $this->User->find('list', array('recursive' => -1, 'order' => array('email ASC'), 'conditions' => $conditions, 'fields' => array('email')));\n            $this->set('emails', $users);\n            $this->set('emailsCount', count($users));\n            $this->render('ajax/emailConfirmTemplate');\n        } else {\n            $users = $this->User->find('all', array('recursive' => -1, 'order' => array('email ASC'), 'conditions' => $conditions));\n            // User has filled in his contact form, send out the email.\n            if ($isPostOrPut) {\n                $this->request->data['User']['message'] = $this->User->adminMessageResolve($this->request->data['User']['message']);\n                $failures = '';\n                foreach ($users as $user) {\n                    $password = $this->User->generateRandomPassword();\n                    $body = str_replace('$password', $password, $this->request->data['User']['message']);\n                    $body = str_replace('$username', $user['User']['email'], $body);\n                    $result = $this->User->sendEmail($user, $body, false, $this->request->data['User']['subject']);\n                    // if sending successful and action was a password change, update the user's password.\n                    if ($result && $this->request->data['User']['action'] != '0') {\n                        $this->User->id = $user['User']['id'];\n                        $this->User->saveField('password', $password);\n                        $this->User->saveField('change_pw', '1');\n                    }\n                    if (!$result) {\n                        if ($failures != '') {\n                            $failures .= ', ';\n                        }\n                        $failures .= $user['User']['email'];\n                    }\n                }\n                if ($failures != '') {\n                    $this->Flash->success(__('E-mails sent, but failed to deliver the messages to the following recipients: ' . $failures));\n                } else {\n                    $this->Flash->success(__('E-mails sent.'));\n                }\n            }\n            $conditions = array();\n            if (!$this->_isSiteAdmin()) {\n                $conditions = array('org_id' => $this->Auth->user('org_id'));\n            }\n            $conditions['User.disabled'] = 0;\n            $temp = $this->User->find('all', array('recursive' => -1, 'fields' => array('id', 'email', 'Organisation.name'), 'order' => array('email ASC'), 'conditions' => $conditions, 'contain' => array('Organisation')));\n            $emails = array();\n            $orgName = array();\n            // save all the emails of the users and set it for the dropdown list in the form\n            foreach ($temp as $user) {\n                $emails[$user['User']['id']] = $user['User']['email'];\n                $orgName[$user['Organisation']['id']] = $user['Organisation']['name'];\n            }\n\n            $this->set('users', $temp);\n            $this->set('recipientEmail', $emails);\n            $this->set('orgName', $orgName);\n            $this->set('org', Configure::read('MISP.org'));\n            $textsToFetch = array('newUserText', 'passwordResetText');\n            $this->loadModel('Server');\n            foreach ($textsToFetch as $text) {\n                ${$text} = Configure::read('MISP.' . $text);\n                if (!${$text}) {\n                    ${$text} = $this->Server->serverSettings['MISP'][$text]['value'];\n                }\n                $this->set($text, ${$text});\n            }\n        }\n    }\n\n    public function initiatePasswordReset($id, $firstTime = false)\n    {\n        if (!$this->_isAdmin()) {\n            throw new MethodNotAllowedException('You are not authorised to do that.');\n        }\n        $user = $this->User->find('first', array(\n            'conditions' => array('id' => $id),\n            'recursive' => -1\n        ));\n        if (!$this->_isSiteAdmin() && $this->Auth->user('org_id') != $user['User']['org_id']) {\n            throw new MethodNotAllowedException('You are not authorised to do that.');\n        }\n        if ($this->request->is('post')) {\n            if (isset($this->request->data['User']['firstTime'])) {\n                $firstTime = $this->request->data['User']['firstTime'];\n            }\n            return new CakeResponse($this->User->initiatePasswordReset($user, $firstTime));\n        } else {\n            $error = false;\n            $encryption = false;\n            if (!empty($user['User']['gpgkey'])) {\n                $encryption = 'PGP';\n            } elseif (!$error && !empty($user['User']['certif_public'])) {\n                $encryption = 'SMIME';\n            }\n            $this->set('encryption', $encryption);\n            if (!$encryption && (Configure::read('GnuPG.onlyencrypted') || Configure::read('GnuPG.bodyonlyencrypted'))) {\n                $error = 'No encryption key found for the user and the instance posture blocks non encrypted e-mails from being sent.';\n            }\n            $this->set('error', $error);\n            $this->layout = 'ajax';\n            $this->set('user', $user);\n            $this->set('firstTime', $firstTime);\n            $this->render('ajax/passwordResetConfirmationForm');\n        }\n    }\n\n    public function email_otp()\n    {\n        $user = $this->Session->read('email_otp_user');\n        if (empty($user)) {\n            $this->redirect('login');\n        }\n        $redis = $this->User->setupRedisWithException();\n        $user_id = $user['id'];\n\n        if ($this->request->is('post') && isset($this->request->data['User']['otp'])) {\n            $stored_otp = $redis->get('misp:otp:' . $user_id);\n            if (!empty($stored_otp) && trim($this->request->data['User']['otp']) == $stored_otp) {\n                // we invalidate the previously generated OTP\n                $redis->del('misp:otp:' . $user_id);\n                // We login the user with CakePHP\n                $this->Auth->login($user);\n                $this->_postlogin();\n            } else {\n                $this->Flash->error(__(\"The OTP is incorrect or has expired\"));\n            }\n        } else {\n            // GET Request\n\n            // We check for exceptions\n            $exception_list = Configure::read('Security.email_otp_exceptions');\n            if (!empty($exception_list)) {\n                $exceptions = explode(\",\", $exception_list);\n                foreach ($exceptions as $exception) {\n                    if ($user['email'] === trim($exception)) {\n                        // We login the user with CakePHP\n                        $this->Auth->login($user);\n                        $this->_postlogin();\n                    }\n                }\n            }\n            $this->loadModel('Server');\n\n            // Generating the OTP\n            $digits = Configure::read('Security.email_otp_length') ?: $this->Server->serverSettings['Security']['email_otp_length']['value'];\n            $otp = \"\";\n            for ($i = 0; $i < $digits; $i++) {\n                $otp .= random_int(0, 9);\n            }\n            // We use Redis to cache the OTP\n            $redis->set('misp:otp:' . $user_id, $otp);\n            $validity = Configure::read('Security.email_otp_validity') ?: $this->Server->serverSettings['Security']['email_otp_validity']['value'];\n            $redis->expire('misp:otp:' . $user_id, (int)$validity * 60);\n\n            // Email construction\n            $body = Configure::read('Security.email_otp_text') ?: $this->Server->serverSettings['Security']['email_otp_text']['value'];\n            $body = str_replace('$misp', Configure::read('MISP.baseurl'), $body);\n            $body = str_replace('$org', Configure::read('MISP.org'), $body);\n            $body = str_replace('$contact', Configure::read('MISP.contact'), $body);\n            $body = str_replace('$validity', $validity, $body);\n            $body = str_replace('$otp', $otp, $body);\n            $body = str_replace('$ip', $this->__getClientIP(), $body);\n            $body = str_replace('$username', $user['email'], $body);\n\n            // Fetch user that contains also PGP or S/MIME keys for e-mail encryption\n            $userForSendMail = $this->User->getUserById($user_id);\n            $body = str_replace('\\n', PHP_EOL, $body);\n            $result = $this->User->sendEmail($userForSendMail, $body, false, \"[\" . Configure::read('MISP.org') . \" MISP] Email OTP\");\n\n            if ($result) {\n                $this->Flash->success(__(\"An email containing a OTP has been sent.\"));\n            } else {\n                $this->Flash->error(__(\"The email couldn't be sent, please reach out to your administrator.\"));\n            }\n        }\n    }\n\n    /**\n    * Helper function to determine the IP of a client (proxy aware)\n    */\n    private function __getClientIP() {\n      $x_forwarded = filter_input(INPUT_SERVER, 'HTTP_X_FORWARDED_FOR', FILTER_SANITIZE_STRING);\n      $client_ip = filter_input(INPUT_SERVER, 'HTTP_CLIENT_IP', FILTER_SANITIZE_STRING);\n      if (!empty($x_forwarded)) {\n        $x_forwarded = explode(\",\", $x_forwarded);\n        return $x_forwarded[0];\n      } elseif(!empty($client_ip)){\n        return $client_ip;\n      } else {\n        return filter_input(INPUT_SERVER, 'REMOTE_ADDR', FILTER_SANITIZE_STRING);\n      }\n    }\n\n    // shows some statistics about the instance\n    public function statistics($page = 'data')\n    {\n        $user = $this->Auth->user();\n        @session_write_close(); // loading this page can take long time, so we can close session\n\n        if (!$this->_isRest()) {\n            $pages = [\n                'data' => __('Usage data'),\n                'orgs' => __('Organisations'),\n                'users' => __('User and Organisation statistics'),\n                'tags' => __('Tags'),\n                'attributehistogram' => __('Attribute histogram'),\n                'sightings' => __('Sightings toplists'),\n                'galaxyMatrix' => __('Galaxy Matrix')\n            ];\n            if (!$this->_isSiteAdmin() && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n                unset($pages['orgs']);\n            }\n\n            $this->set('page', $page);\n            $this->set('pages', $pages);\n        }\n\n        if ($page === 'data') {\n            $result = $this->__statisticsData($user, $this->params['named']);\n        } elseif ($page === 'orgs') {\n            if (!$this->_isSiteAdmin() && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n                throw new MethodNotAllowedException('This feature is currently disabled.');\n            }\n            $result = $this->__statisticsOrgs($this->params['named']);\n        } elseif ($page === 'users') {\n            $result = $this->__statisticsUsers($this->params['named']);\n        } elseif ($page === 'tags') {\n            $result = $this->__statisticsTags($this->params['named']);\n        } elseif ($page === 'attributehistogram') {\n            if ($this->_isRest()) {\n                return $this->histogram($selected = null);\n            } else {\n                $this->render('statistics_histogram');\n            }\n        } elseif ($page === 'sightings') {\n            $result = $this->__statisticsSightings($user, $this->params['named']);\n        } elseif ($page === 'galaxyMatrix') {\n            $result = $this->__statisticsGalaxyMatrix($user, $this->params['named']);\n        } else {\n            throw new NotFoundException(\"Invalid page\");\n        }\n\n        if ($this->_isRest()) {\n            return $result;\n        }\n    }\n\n    private function __statisticsData(array $user, $params = array())\n    {\n        // set all of the data up for the heatmaps\n        $params = array(\n            'fields' => array('id', 'name'),\n            'recursive' => -1,\n            'conditions' => array(),\n            'order' => ['name'],\n        );\n        if (!$user['Role']['perm_site_admin'] && !empty(Configure::read('Security.hide_organisation_index_from_users'))) {\n            $params['conditions'] = array('Organisation.id' => $user['org_id']);\n        }\n        $orgs = $this->User->Organisation->find('list', $params);\n\n        $local_orgs_params = $params;\n        $local_orgs_params['conditions']['Organisation.local'] = 1;\n        $local_orgs_count = $this->User->Organisation->find('count', $local_orgs_params);\n\n        $this->loadModel('Log');\n        $year = date('Y');\n        $month = date('n');\n        $month = $month - 5;\n        if ($month < 1) {\n            $year--;\n            $month = 12 + $month;\n        }\n        // Some additional statistics\n        $this_month = strtotime('first day of this month');\n        $stats['event_count'] = $this->User->Event->find('count', array('recursive' => -1));\n        $stats['event_count_month'] = $this->User->Event->find('count', array('conditions' => array('Event.timestamp >' => $this_month), 'recursive' => -1));\n\n        $stats['attribute_count'] = $this->User->Event->Attribute->find('count', array('conditions' => array('Attribute.deleted' => 0), 'recursive' => -1));\n        $stats['attribute_count_month'] = $this->User->Event->Attribute->find('count', array('conditions' => array('Attribute.timestamp >' => $this_month, 'Attribute.deleted' => 0), 'recursive' => -1));\n        $stats['attributes_per_event'] = round($stats['attribute_count'] / $stats['event_count']);\n\n        $stats['correlation_count'] = $this->User->Event->Attribute->Correlation->find('count', array('recursive' => -1));\n        $stats['correlation_count'] = $stats['correlation_count'] / 2;\n\n        $stats['proposal_count'] = $this->User->Event->ShadowAttribute->find('count', array('recursive' => -1, 'conditions' => array('deleted' => 0)));\n\n        $stats['user_count'] = $this->User->find('count', array('recursive' => -1));\n        $stats['user_count_pgp'] = $this->User->find('count', array('recursive' => -1, 'conditions' => array('User.gpgkey !=' => '')));\n        $stats['org_count'] = count($orgs);\n        $stats['local_org_count'] = $local_orgs_count;\n        $stats['contributing_org_count'] = $this->User->Event->find('count', array('recursive' => -1, 'group' => array('Event.orgc_id')));\n        $stats['average_user_per_org'] = round($stats['user_count'] / $stats['local_org_count'], 1);\n\n        $this->loadModel('Thread');\n        $stats['thread_count'] = $this->Thread->find('count', array('conditions' => array('Thread.post_count >' => 0), 'recursive' => -1));\n        $stats['thread_count_month'] = $this->Thread->find('count', array('conditions' => array('Thread.date_created >' => date(\"Y-m-d H:i:s\", $this_month), 'Thread.post_count >' => 0), 'recursive' => -1));\n\n        $stats['post_count'] = $this->Thread->Post->find('count', array('recursive' => -1));\n        $stats['post_count_month'] = $this->Thread->Post->find('count', array('conditions' => array('Post.date_created >' => date(\"Y-m-d H:i:s\", $this_month)), 'recursive' => -1));\n\n        if ($this->_isRest()) {\n            $data = array(\n                'stats' => $stats\n            );\n            return $this->RestResponse->viewData($data, $this->response->type());\n        }\n\n        $this->set('stats', $stats);\n        $this->set('orgs', $orgs);\n        $this->set('start', strtotime(date('Y-m-d H:i:s') . ' -5 months'));\n        $this->set('end', strtotime(date('Y-m-d H:i:s')));\n        $this->set('startDateCal', $year . ', ' . $month . ', 01');\n        $range = '[5, 10, 50, 100]';\n        $this->set('range', $range);\n        $this->set('activityUrl', $this->baseurl . (Configure::read('MISP.log_new_audit') ? '/audit_logs' : '/logs') . '/returnDates');\n        $this->render('statistics_data');\n    }\n\n    private function __statisticsSightings(array $user, $params = array())\n    {\n        $this->loadModel('Sighting');\n        $conditions = ['Sighting.org_id' => $user['org_id']];\n        if (isset($params['timestamp'])) {\n            $conditions['Sighting.date_sighting >'] = $params['timestamp'];\n        }\n        $sightings = $this->Sighting->find('all', array(\n            'conditions' => $conditions,\n            'fields' => ['Sighting.type', 'Sighting.source', 'Sighting.event_id'],\n        ));\n        $data = array();\n        $toplist = array();\n        $eventids = array();\n        foreach ($sightings as $v) {\n            if ($v['Sighting']['source'] == '') {\n                $v['Sighting']['source'] = 'Undefined';\n            }\n            $type = array('sighting', 'false-positive', 'expiration')[$v['Sighting']['type']];\n            if (isset($data[$v['Sighting']['source']][$type])) {\n                $data[$v['Sighting']['source']][$type]++;\n            } else {\n                $data[$v['Sighting']['source']][$type] = 1;\n            }\n            if (!isset($toplist[$v['Sighting']['source']])) {\n                $toplist[$v['Sighting']['source']] = 1;\n            } else {\n                $toplist[$v['Sighting']['source']]++;\n            }\n            if (!isset($eventids[$v['Sighting']['source']][$type])) {\n                $eventids[$v['Sighting']['source']][$type] = [];\n            }\n            if (!in_array($v['Sighting']['event_id'], $eventids[$v['Sighting']['source']][$type])) {\n                $eventids[$v['Sighting']['source']][$v['Sighting']['type']][] = $type;\n            }\n        }\n        arsort($toplist);\n        if ($this->_isRest()) {\n            $data = array(\n                'toplist' => $toplist,\n                'eventids' => $eventids\n            );\n            return $this->RestResponse->viewData($data, $this->response->type());\n        } else {\n            $this->set('eventids', $eventids);\n            $this->set('toplist', $toplist);\n            $this->set('data', $data);\n            $this->render('statistics_sightings');\n        }\n    }\n\n    private function __statisticsOrgs($params = array())\n    {\n        $conditions = array();\n        if (!isset($params['scope']) || $params['scope'] == 'local') {\n            $params['scope'] = 'local';\n            $conditions['Organisation.local'] = 1;\n        } elseif ($params['scope'] == 'external') {\n            $conditions['Organisation.local'] = 0;\n        }\n        $orgs = $this->User->Organisation->find('all', array(\n            'recursive' => -1,\n            'conditions' => $conditions,\n            'fields' => array('id', 'name', 'description', 'local', 'contacts', 'type', 'sector', 'nationality'),\n        ));\n        $orgs = array_column(array_column($orgs, 'Organisation'), null, 'id');\n        $users = $this->User->find('all', array(\n            'group' => 'User.org_id',\n            'conditions' => array('User.org_id' => array_keys($orgs)),\n            'recursive' => -1,\n            'fields' => array('org_id', 'count(*)')\n        ));\n        foreach ($users as $user) {\n            $orgs[$user['User']['org_id']]['userCount'] = $user[0]['count(*)'];\n        }\n        unset($users);\n        $events = $this->User->Event->find('all', array(\n            'group' => 'Event.orgc_id',\n            'conditions' => array('Event.orgc_id' => array_keys($orgs)),\n            'recursive' => -1,\n            'fields' => array('Event.orgc_id', 'count(*)', 'sum(Event.attribute_count) as attributeCount')\n        ));\n        foreach ($events as $event) {\n            $orgs[$event['Event']['orgc_id']]['eventCount'] = $event[0]['count(*)'];\n            $orgs[$event['Event']['orgc_id']]['attributeCount'] = $event[0]['attributeCount'];\n            $orgs[$event['Event']['orgc_id']]['orgActivity'] = $this->User->getOrgActivity($event['Event']['orgc_id'], array('event_timestamp' => '365d'));\n        }\n        unset($events);\n        $orgs = Set::combine($orgs, '{n}.name', '{n}');\n        // f*** php\n        uksort($orgs, 'strcasecmp');\n        foreach ($orgs as $k => $value) {\n            if (file_exists(APP . 'webroot' . DS . 'img' . DS . 'orgs' . DS . $k . '.png')) {\n                $orgs[$k]['logo'] = true;\n            }\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($orgs, $this->response->type());\n        } else {\n            $this->set('scope', $params['scope']);\n            $this->set('orgs', $orgs);\n            $this->render('statistics_orgs');\n        }\n    }\n\n    private function __statisticsUsers($params = array())\n    {\n        $this->loadModel('Organisation');\n        $this->loadModel('User');\n        $this_month = strtotime(date('Y/m') . '/01');\n        $this_year = strtotime(date('Y') . '/01/01');\n        $ranges = array(\n            'total' => null,\n            'month' => $this_month,\n            'year' => $this_year\n        );\n        $scopes = array(\n            'user' => array(\n                'conditions' => array(),\n                'model' => 'User',\n                'date_created' => 'timestamp'\n            ),\n            'org_local' => array(\n                'conditions' => array('Organisation.local' => 1),\n                'model' => 'Organisation',\n                'date_created' => 'datetime'\n            ),\n            'org_external' => array(\n                'conditions' => array('Organisation.local' => 0),\n                'model' => 'Organisation',\n                'date_created' => 'datetime'\n            )\n        );\n        $statistics = array();\n        foreach ($scopes as $scope => $scope_data) {\n            foreach ($ranges as $range => $condition) {\n                $params = array(\n                    'recursive' => -1\n                );\n                $filter = array();\n                if (!empty($condition)) {\n                    if ($scope_data['date_created'] === 'datetime') {\n                        $condition = date('Y-m-d H:i:s', $condition);\n                    }\n                    $filter = array($scope_data['model'] . '.date_created >=' => $condition);\n                }\n                $params['conditions'] = array_merge($scopes[$scope]['conditions'], $filter);\n                $statistics[$scope]['data'][$range] = $this->{$scope_data['model']}->find('count', $params);\n            }\n        }\n        if ($this->_isRest()) {\n            return $this->RestResponse->viewData($statistics, $this->response->type());\n        } else {\n            $this->set('statistics', $statistics);\n            $this->render('statistics_users');\n        }\n    }\n\n    public function tagStatisticsGraph()\n    {\n        $this->loadModel('EventTag');\n        $tags = $this->EventTag->getSortedTagList();\n        $this->loadModel('Taxonomy');\n        $taxonomies = $this->Taxonomy->find('list', array(\n                'conditions' => array('enabled' => true),\n                'fields' => array('Taxonomy.namespace')\n        ));\n        $flatData = array();\n        $tagIds = $this->EventTag->Tag->find('list', array('fields' => array('Tag.name', 'Tag.id')));\n        $this->set('tagIds', $tagIds);\n        foreach ($tags as $key => $value) {\n            $name = explode(':', $value['name']);\n            $tags[$key]['taxonomy'] = 'custom';\n            if (count($name) > 1) {\n                if (in_array($name[0], $taxonomies)) {\n                    $tags[$key]['taxonomy'] = $name[0];\n                }\n            }\n            $flatData[$tags[$key]['taxonomy']][$value['name']] = array('name' => $value['name'], 'size' => $value['eventCount']);\n        }\n        $treemap = array(\n                'name' => 'tags',\n                'children' => array()\n        );\n\n        foreach ($flatData as $key => $value) {\n            $newElement = array(\n                'name' => $key,\n                'children' => array()\n            );\n            foreach ($value as $tag) {\n                $newElement['children'][] = array('name' => $tag['name'], 'size' => $tag['size']);\n            }\n            $treemap['children'][] = $newElement;\n        }\n        $taxonomyColourCodes = array();\n        $taxonomies = array_merge(array('custom'), $taxonomies);\n        if ($this->_isRest()) {\n            $data = array(\n                'flatData' => $flatData,\n                'treemap' => $treemap\n            );\n            return $this->RestResponse->viewData($data, $this->response->type());\n        } else {\n            $this->set('taxonomyColourCodes', $taxonomyColourCodes);\n            $this->set('taxonomies', $taxonomies);\n            $this->set('flatData', $flatData);\n            $this->set('treemap', $treemap);\n            $this->set('tags', $tags);\n            $this->layout = 'treemap';\n            $this->render('ajax/tag_statistics_graph');\n        }\n    }\n\n    private function __statisticsTags($params = array())\n    {\n        if ($this->_isRest()) {\n            return $this->tagStatisticsGraph();\n        } else {\n            $this->render('statistics_tags');\n        }\n    }\n\n    private function __statisticsGalaxyMatrix(array $user, $params = array())\n    {\n        $this->loadModel('Event');\n        $this->loadModel('Galaxy');\n        $mitre_galaxy_id = $this->Galaxy->getMitreAttackGalaxyId();\n        if (isset($params['galaxy_id'])) {\n            $galaxy_id = $params['galaxy_id'];\n        } else {\n            $galaxy_id = $mitre_galaxy_id;\n        }\n\n        $organisations = $this->User->Organisation->find('list', array(\n            'recursive' => -1,\n            'fields' => ['id', 'name'],\n        ));\n        foreach ($organisations as $id => $foo) {\n            if (!$this->User->Organisation->canSee($user, $id)) {\n                unset($organisations[$id]);\n            }\n        }\n        $organisations = [0 => __('All')] + $organisations;\n        $this->set('organisations', $organisations);\n\n        if (isset($params['organisation']) && $params['organisation'] != 0) {\n            if (isset($organisations[$params['organisation']])) {\n                $this->set('picked_organisation_id', $params['organisation']);\n            } else {\n                throw new NotFoundException(__(\"Invalid organisation\"));\n            }\n        } else {\n            $this->set('picked_organisation_id', -1);\n        }\n\n        $rest_response_empty = true;\n        $ignore_score = false;\n        if (\n            isset($params['dateFrom'])\n            || isset($params['dateTo'])\n            || isset($params['organisation']) && $params['organisation'] != 0\n        ) { // use restSearch\n            $ignore_score = true;\n            $filters = array();\n            if (isset($params['dateFrom'])) {\n                $filters['from'] = $params['dateFrom'];\n                $this->set('dateFrom', $params['dateFrom']);\n            }\n            if (isset($params['dateTo'])) {\n                $filters['to'] = $params['dateTo'];\n                $this->set('dateTo', $params['dateTo']);\n            }\n            if (isset($params['organisation'])) {\n                $filters['org'] = $params['organisation'];\n            }\n            $elementCounter = 0;\n            $renderView = '';\n            $final = $this->Event->restSearch($user, 'attack', $filters, false, false, $elementCounter, $renderView);\n\n            $final = json_decode($final, true);\n            if (!empty($final)) {\n                $rest_response_empty = false;\n                foreach ($final as $key => $data) {\n                    $this->set($key, $data);\n                }\n            }\n        }\n\n        // No need for restSearch or result is empty\n        if ($rest_response_empty) {\n            $matrixData = $this->Galaxy->getMatrix($galaxy_id);\n            $tabs = $matrixData['tabs'];\n            $matrixTags = $matrixData['matrixTags'];\n            $killChainOrders = $matrixData['killChain'];\n            $instanceUUID = $matrixData['instance-uuid'];\n            if ($ignore_score) {\n                $scores_uniform = array('scores' => array(), 'maxScore' => 0);\n            } else {\n                $scores_uniform = $this->Event->EventTag->getTagScoresUniform(0, $matrixTags);\n            }\n            $scores = $scores_uniform['scores'];\n            $maxScore = $scores_uniform['maxScore'];\n            // FIXME: temporary fix: add the score of deprecated mitre galaxies to the new one (for the stats)\n            if ($matrixData['galaxy']['id'] == $mitre_galaxy_id) {\n                $mergedScore = array();\n                foreach ($scores as $tag => $v) {\n                    $predicateValue = explode(':', $tag, 2)[1];\n                    $predicateValue = explode('=', $predicateValue, 2);\n                    $predicate = $predicateValue[0];\n                    $clusterValue = $predicateValue[1];\n                    $mappedTag = '';\n                    $mappingWithoutExternalId = array();\n                    if ($predicate == 'mitre-attack-pattern') {\n                        $mappedTag = $tag;\n                        $name = explode(\" \", $tag);\n                        $name = join(\" \", array_slice($name, 0, -2)); // remove \" - external_id\"\n                        $mappingWithoutExternalId[$name] = $tag;\n                    } else {\n                        $name = explode(\" \", $clusterValue);\n                        $name = join(\" \", array_slice($name, 0, -2)); // remove \" - external_id\"\n                        if (isset($mappingWithoutExternalId[$name])) {\n                            $mappedTag = $mappingWithoutExternalId[$name];\n                        } else {\n                            $adjustedTagName = $this->Galaxy->GalaxyCluster->find('list', array(\n                                'group' => array('GalaxyCluster.id', 'GalaxyCluster.tag_name'),\n                                'conditions' => array('GalaxyCluster.tag_name LIKE' => 'misp-galaxy:mitre-attack-pattern=' . $name . '% T%'),\n                                'fields' => array('GalaxyCluster.tag_name')\n                            ));\n                            if (!empty($adjustedTagName)) {\n                                $adjustedTagName = array_values($adjustedTagName)[0];\n                                $mappingWithoutExternalId[$name] = $adjustedTagName;\n                                $mappedTag = $mappingWithoutExternalId[$name];\n                            }\n                        }\n                    }\n                    if (isset($mergedScore[$mappedTag])) {\n                        $mergedScore[$mappedTag] += $v;\n                    } else {\n                        $mergedScore[$mappedTag] = $v;\n                    }\n                }\n                $scores = $mergedScore;\n                $maxScore = !empty($mergedScore) ? max(array_values($mergedScore)) : 0;\n            }\n            // end FIXME\n\n            $this->Galaxy->sortMatrixByScore($tabs, $scores);\n            if ($this->_isRest()) {\n                $json = array('matrix' => $tabs, 'scores' => $scores, 'instance-uuid' => $instanceUUID);\n                return $this->RestResponse->viewData($json, $this->response->type());\n            } else {\n                App::uses('ColourGradientTool', 'Tools');\n                $gradientTool = new ColourGradientTool();\n                $colours = $gradientTool->createGradientFromValues($scores);\n\n                $this->set('target_type', 'attribute');\n                $this->set('columnOrders', $killChainOrders);\n                $this->set('tabs', $tabs);\n                $this->set('scores', $scores);\n                $this->set('maxScore', $maxScore);\n                if (!empty($colours)) {\n                    $this->set('colours', $colours['mapping']);\n                    $this->set('interpolation', $colours['interpolation']);\n                }\n                $this->set('pickingMode', false);\n                if ($matrixData['galaxy']['id'] == $mitre_galaxy_id) {\n                    $this->set('defaultTabName', \"mitre-attack\");\n                    $this->set('removeTrailling', 2);\n                }\n\n                $this->set('galaxyName', $matrixData['galaxy']['name']);\n                $this->set('galaxyId', $matrixData['galaxy']['id']);\n                $matrixGalaxies = $this->Galaxy->getAllowedMatrixGalaxies();\n                $this->set('matrixGalaxies', $matrixGalaxies);\n            }\n        }\n        $this->render('statistics_galaxymatrix');\n    }\n\n    public function verifyGPG($full = false)\n    {\n        $user_results = $this->User->verifyGPG($full);\n        $this->set('users', $user_results);\n    }\n\n    public function verifyCertificate()\n    {\n        $user_results = $this->User->verifyCertificate();\n        $this->set('users', $user_results);\n    }\n\n    public function searchGpgKey($email = false)\n    {\n        if (!$email) {\n            throw new NotFoundException('No email provided.');\n        }\n        $keys = $this->User->searchGpgKey($email);\n        if (empty($keys)) {\n            throw new NotFoundException('No keys found for given email at keyserver.');\n        }\n        $this->set('keys', $keys);\n        $this->autorender = false;\n        $this->layout = false;\n        $this->render('ajax/fetchpgpkey');\n    }\n\n    public function fetchGpgKey($fingerprint = null)\n    {\n        if (!$fingerprint) {\n            throw new NotFoundException('No fingerprint provided.');\n        }\n        $key = $this->User->fetchGpgKey($fingerprint);\n        if (!$key) {\n            throw new NotFoundException('No key with given fingerprint found.');\n        }\n        return new CakeResponse(array('body' => $key));\n    }\n\n    public function getGpgPublicKey()\n    {\n        if (!Configure::read(\"MISP.download_gpg_from_homedir\")) {\n            throw new MethodNotAllowedException(\"Downloading GPG public key from homedir is not allowed.\");\n        }\n\n        $key = $this->User->getGpgPublicKey();\n        if (!$key) {\n            throw new NotFoundException(\"Public key not found.\");\n        }\n\n        list($fingeprint, $publicKey) = $key;\n        $response = new CakeResponse(array(\n            'body' => $publicKey,\n            'type' => 'text/plain',\n        ));\n        $response->download($fingeprint . '.asc');\n        return $response;\n    }\n\n    public function checkIfLoggedIn()\n    {\n        return new CakeResponse(array('body'=> 'OK','status' => 200));\n    }\n\n    public function admin_monitor($id)\n    {\n        $user = $this->User->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('User.id' => $id),\n            'fields' => array('User.id')\n        ));\n        if (empty($user)) {\n            throw new NotFoundException(__('Invalid user.'));\n        }\n        $redis = $this->User->setupRedis();\n        $alreadyMonitored = $redis->sismember('misp:monitored_users', $id);\n        if ($this->request->is('post')) {\n            if (isset($this->request->data['User'])) {\n                $this->request->data = $this->request->data['User'];\n            }\n            if (isset($this->request->data['value'])) {\n                $this->request->data = $this->request->data['value'];\n            }\n            if (empty($this->request->data)) {\n                $redis->srem('misp:monitored_users', $id);\n            } else {\n                $redis->sadd('misp:monitored_users', $id);\n            }\n            return $this->RestResponse->viewData($alreadyMonitored ? 0 : 1, $this->response->type());\n        } else {\n            if ($this->_isRest()) {\n                return $this->RestResponse->viewData($alreadyMonitored ? 0 : 1, $this->response->type());\n            } else {\n                $this->set('data', $alreadyMonitored);\n                $this->layout = false;\n                $this->render('/Elements/genericElements/toggleForm');\n            }\n        }\n    }\n\n    public function register()\n    {\n        $fieldToValidate = array('email', 'gpgkey');\n        if (empty(Configure::read('Security.allow_self_registration'))) {\n            throw new MethodNotAllowedException(__('Self registration is not enabled on this instance.'));\n        }\n        $message = Configure::read('Security.self_registration_message');\n        if (empty($message)) {\n            $this->loadModel('Server');\n            $message = $this->Server->serverSettings['Security']['self_registration_message']['value'];\n        }\n        $this->set('message', $message);\n        if ($this->request->is('post')) {\n            if (isset($this->request->data['User'])) {\n                $this->request->data = $this->request->data['User'];\n            }\n            $validKeys = array(\n                'email',\n                'org_name',\n                'org_uuid',\n                'message',\n                'custom_perms',\n                'perm_sync',\n                'perm_publish',\n                'perm_admin'\n            );\n            $requestObject = array();\n            foreach ($validKeys as $key) {\n                if (isset($this->request->data[$key])) {\n                    $requestObject[$key] = trim($this->request->data[$key]);\n                }\n            }\n            if (!isset($requestObject['message'])) {\n                $requestObject['message'] = '';\n            }\n            if (empty($requestObject['email'])) {\n                throw new BadRequestException(__('We require at least the email field to be filled.'));\n            }\n            $this->User->set($requestObject);\n            unset($this->User->validate['email']['unique']);\n            if (!$this->User->validates(array('fieldList' => $fieldToValidate))) {\n                $errors = $this->User->validationErrors;\n                $message = __('Request could not be created.');\n                if ($this->_isRest()) {\n                    $message .= __('Errors: %s', json_encode($errors));\n                    return $this->RestResponse->saveFailResponse('Users', 'register', false, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                    return;\n                }\n            }\n            $this->loadModel('Inbox');\n            $this->Inbox->create();\n            $data = array(\n                'Inbox' => array(\n                    'title' => __('User registration for %s.', $requestObject['email']),\n                    'type' => 'registration',\n                    'comment' => $requestObject['message'],\n                    'data' => json_encode($requestObject)\n                )\n            );\n            $result = $this->Inbox->save($data);\n            if (empty($result)) {\n                $message = __('Request could not be created. Make sure that the email and org name fields are filled.');\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveFailResponse('Users', 'register', false, $message, $this->response->type());\n                } else {\n                    $this->Flash->error($message);\n                }\n            } else {\n                $message = __('Request sent. The administrators of this community have been notified.');\n                if ($this->_isRest()) {\n                    return $this->RestResponse->saveSuccessResponse('User', 'register', false, $this->response->type(), $message);\n                } else {\n                    $this->Flash->success($message);\n                    $this->redirect('/');\n                }\n            }\n        }\n    }\n\n    public function registrations()\n    {\n        $this->loadModel('Inbox');\n        $params = array(\n            'recursive' => -1,\n            'conditions' => array(\n                'deleted' => 0,\n                'type' => 'registration'\n            ),\n            'order' => array(\n                'timestamp desc'\n            )\n        );\n        $passedArgs = $this->passedArgs;\n        if (!empty($passedArgs['value'])) {\n            $lookup = strtolower($passedArgs['value']);\n            $allSearchFields = array('data', 'user_agent', 'ip');\n            foreach ($allSearchFields as $field) {\n                $params['conditions']['AND']['OR'][] = array('LOWER(Inbox.' . $field . ') LIKE' => '%' . $lookup . '%');\n            }\n        }\n        $this->set('passedArgs', json_encode($passedArgs));\n        if ($this->_isRest()) {\n            $data = $this->Inbox->find('all', array(\n                'recursive' => -1,\n                'conditions' => $params['conditions']\n            ));\n            foreach ($data as $k => $v) {\n                $data[$k]['Inbox']['data'] = json_decode($data[$k]['Inbox']['data'], true);\n            }\n            return $this->RestResponse->viewData($data, $this->response->type());\n        } else {\n            $this->paginate = $params;\n            $data = $this->paginate('Inbox');\n            foreach ($data as $k => $message) {\n                $data[$k]['Inbox']['data'] = json_decode($data[$k]['Inbox']['data'], true);\n                $data[$k]['Inbox']['requested_role'] = __('default');\n                if (!empty($data[$k]['Inbox']['data']['custom_perms'])) {\n                    $data[$k]['Inbox']['requested_role'] = array(\n                        'perm_publish' => !empty($data[$k]['Inbox']['data']['perm_publish']) ? __('Yes') : __('No'),\n                        'perm_sync' => !empty($data[$k]['Inbox']['data']['perm_sync']) ? __('Yes') : __('No'),\n                        'perm_admin' => !empty($data[$k]['Inbox']['data']['perm_admin']) ? __('Yes') : __('No')\n                    );\n                }\n            }\n            $this->set('data', $data);\n        }\n    }\n\n    public function discardRegistrations($id = false)\n    {\n        if (!$this->request->is('post') && !$this->request->is('delete')) {\n            $this->set('id', $id);\n            $this->set('type', 'discardRegistrations');\n            $this->render('ajax/discardRegistrations');\n        } else {\n            if (empty($id) && !empty($this->params['named']['id'])) {\n                $id = $this->params['named']['id'];\n            }\n            $this->loadModel('Inbox');\n            if (!is_array($id)) {\n                $id = array($id);\n            }\n            foreach ($id as $k => $v) {\n                if (Validation::uuid($v)) {\n                    $id[$k] = $this->Toolbox->findIdByUuid($this->Inbox, $v);\n                }\n            }\n            $registrations = $this->Inbox->find('all', array(\n                'recursive' => -1,\n                'conditions' => array(\n                    'deleted' => 0,\n                    'type' => 'registration',\n                    'id' => $id\n                )\n            ));\n            foreach ($registrations as $registration) {\n                $this->Inbox->delete($registration['Inbox']['id']);\n            }\n            $message = sprintf(\n                '%s registration(s) discarded.',\n                count($registrations)\n            );\n            if ($this->_isRest()) {\n                return $this->RestResponse->saveSuccessResponse('User', 'discardRegistrations', false, $this->response->type(), $message);\n            } else {\n                $this->Log = ClassRegistry::init('Log');\n                $this->Log->create();\n                $this->Log->save(array(\n                    'org' => $this->Auth->user('Organisation')['name'],\n                    'model' => 'User',\n                    'model_id' => 0,\n                    'email' => $this->Auth->user('email'),\n                    'action' => 'discardRegistrations',\n                    'title' => $message,\n                    'change' => ''\n                ));\n                $this->Flash->success($message);\n                $this->redirect(array('controller' => 'users', 'action' => 'registrations'));\n            }\n        }\n    }\n\n    public function acceptRegistrations($id = false)\n    {\n        if (empty($id) && !empty($this->params['named']['id'])) {\n            $id = $this->params['named']['id'];\n        }\n        $this->loadModel('Inbox');\n        if (Validation::uuid($id)) {\n            $id = $this->Toolbox->findIdByUuid($this->Inbox, $id);\n        }\n        $registrations = $this->Inbox->find('all', array(\n            'recursive' => -1,\n            'conditions' => array(\n                'deleted' => 0,\n                'type' => 'registration',\n                'id' => $id\n            )\n        ));\n        $suggestedOrg = null;\n        $suggestedRole = null;\n        $orgCache = array();\n        foreach ($registrations as $k => $v) {\n            $registrations[$k]['Inbox']['data'] = json_decode($registrations[$k]['Inbox']['data'], true);\n            $roleRequirements = array();\n            if ($this->request->is('get')) {\n                $suggestedOrg = $this->User->Organisation->checkDesiredOrg($suggestedOrg, $registrations[$k]);\n                $suggestedRole = $this->User->Role->checkDesiredRole($suggestedRole, $registrations[$k]);\n            }\n        }\n        $default_role = $this->User->Role->find('first', array(\n            'recursive' => -1,\n            'conditions' => array('Role.default_role' => 1),\n            'fields' => array('Role.id')\n        ));\n        if ($this->request->is('get')) {\n            if (!is_array($id)) {\n                $id = array($id);\n            }\n            foreach ($id as $k => $v) {\n                $id[$k] = 'id[]:' . intval($v);\n            }\n            $roles_raw = $this->User->Role->find('all', array(\n                'recursive' => -1\n            ));\n            //roles = id => name\n            $roles = array();\n            $role_perms = array();\n            foreach ($roles_raw as $role) {\n                $roles[$role['Role']['id']] = $role['Role']['name'];\n                $role_perms[$role['Role']['id']] = array(\n                    'perm_publish' => $role['Role']['perm_publish'],\n                    'perm_sync' => $role['Role']['perm_sync'],\n                    'perm_admin' => $role['Role']['perm_admin']\n                );\n            }\n            if (empty($this->request->data['User'])) {\n                $this->request->data = array('User' => $this->request->data);\n            }\n            if (!empty($default_role)) {\n                $this->request->data['User']['role_id'] = $default_role['Role']['id'];\n            }\n            $this->set('roles', $roles);\n            $this->set('role_perms', $role_perms);\n            $orgConditions = array('OR' => array('local' => 1));\n            if (!empty($suggestedOrg)) {\n                $orgConditions['OR'][] = array('Organisation.id' => $suggestedOrg[0]);\n            }\n            $this->set('orgs', $this->User->Organisation->find('list', array(\n                'fields' => array('id', 'name'),\n                'recursive' => -1,\n                'conditions' => $orgConditions\n            )));\n            $this->set('registration', $registrations[$k]);\n            $this->set('suggestedOrg', $suggestedOrg);\n            $this->set('suggestedRole', $suggestedRole);\n            $id = implode('/', $id);\n            $this->set('id', $id);\n            $this->layout = false;\n        } else {\n            $results = array('successes' => 0, 'fails' => 0);\n            if (!isset($this->request->data['User']['role_id'])) {\n                if (!empty($default_role)) {\n                    $this->request->data['User']['role_id'] = $default_role['Role']['id'];\n                } else {\n                    throw new BadRequestException(__('Role ID not provided and no default role exist on the instance'));\n                }\n            }\n            if (!isset($this->request->data['User']['org_id'])) {\n                throw new BadRequestException(__('No organisation selected. Supply an Organisation ID'));\n            } else {\n                if (Validation::uuid($this->request->data['User']['org_id'])) {\n                    $id = $this->Toolbox->findIdByUuid($this->User->Organisation, $this->request->data['User']['org_id']);\n                    $this->request->data['User']['org_id'] = $id;\n                }\n            }\n            foreach ($registrations as $registration) {\n                $result = $this->User->registerUser(\n                    $this->Auth->user(),\n                    $registration['Inbox'],\n                    $this->request->data['User']['org_id'],\n                    $this->request->data['User']['role_id']\n                );\n                $results[($result ? 'successes' : 'fails')] += 1;\n            }\n            $message = array();\n            if (!empty($results['successes'])) {\n                $message[] = __('Added %s user(s).', $results['successes']);\n            }\n            if (!empty($results['fails'])) {\n                $message[] = __('Could not add %s user(s), reasons for the failure have been logged.', $results['fails']);\n            }\n            if (empty($message)) {\n                $message[] = __('No new users added - there was nothing to add.');\n            }\n            $message = implode(' ', $message);\n            if ($this->_isRest()) {\n                if (empty($results['fails']) && !empty($results['successes'])) {\n                    return $this->RestResponse->saveSuccessResponse('User', 'acceptRegistrations', false, $this->response->type(), $message);\n                } else {\n                    return $this->RestResponse->saveFailResponse('Users', 'acceptRegistrations', false, $message, $this->response->type());\n                }\n            } else {\n                if (empty($results['fails']) && !empty($results['successes'])) {\n                    return new CakeResponse(array('body'=> json_encode(array('saved' => true, 'success' => $message)), 'status'=>200, 'type' => 'json'));\n                } else {\n                    return new CakeResponse(array('body'=> json_encode(array('saved' => false, 'errors' => $message)), 'status'=>200, 'type' => 'json'));\n                }\n            }\n        }\n    }\n\n    public function updateToAdvancedAuthKeys()\n    {\n        if (!$this->request->is('post')) {\n            throw new MethodNotAllowedException(__('This endpoint can only be triggered via POST requests.'));\n        }\n        $updated = $this->User->updateToAdvancedAuthKeys();\n        $message = __('The upgrade process is complete, %s authkey(s) generated.', $updated);\n        if ($this->_isRest()) {\n            return $this->RestResponse->saveSuccessResponse('User', 'acceptRegistrations', false, $this->response->type(), $message);\n        } else {\n            $this->Flash->success($message);\n            $this->redirect($this->referer());\n        }\n    }\n\n    private function __canChangePassword()\n    {\n        return $this->ACL->canUserAccess($this->Auth->user(), 'users', 'change_pw');\n    }\n\n    private function __canChangeLogin()\n    {\n        if ($this->_isSiteAdmin()) {\n            return true;\n        }\n        return !Configure::read('MISP.disable_user_login_change');\n    }\n}\n"], "filenames": ["app/Controller/UsersController.php"], "buggy_code_start_loc": [157], "buggy_code_end_loc": [857], "fixing_code_start_loc": [157], "fixing_code_end_loc": [857], "type": "CWE-287", "message": "An issue was discovered in MISP before 2.4.158. In UsersController.php, password confirmation can be bypassed via vectors involving an \"Accept: application/json\" header.", "other": {"cve": {"id": "CVE-2022-29534", "sourceIdentifier": "cve@mitre.org", "published": "2022-04-20T23:15:08.687", "lastModified": "2022-04-27T03:55:50.343", "vulnStatus": "Analyzed", "descriptions": [{"lang": "en", "value": "An issue was discovered in MISP before 2.4.158. In UsersController.php, password confirmation can be bypassed via vectors involving an \"Accept: application/json\" header."}, {"lang": "es", "value": "Se ha detectado un problema en MISP versiones anteriores a 2.4.158. En el archivo UsersController.php, la confirmaci\u00f3n de la contrase\u00f1a puede omitirse por medio de vectores que implican un encabezado \"Accept: application/json\""}], "metrics": {"cvssMetricV31": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.1", "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "NONE", "integrityImpact": "HIGH", "availabilityImpact": "NONE", "baseScore": 7.5, "baseSeverity": "HIGH"}, "exploitabilityScore": 3.9, "impactScore": 3.6}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:N/I:P/A:N", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "NONE", "integrityImpact": "PARTIAL", "availabilityImpact": "NONE", "baseScore": 5.0}, "baseSeverity": "MEDIUM", "exploitabilityScore": 10.0, "impactScore": 2.9, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-287"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:misp:misp:*:*:*:*:*:*:*:*", "versionEndExcluding": "2.4.158", "matchCriteriaId": "C6216C19-9CB8-451D-AC18-0D849429EE09"}]}]}], "references": [{"url": "https://github.com/MISP/MISP/commit/01120163a6b4d905029d416e7305575df31df8af", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/MISP/MISP/compare/v2.4.157...v2.4.158", "source": "cve@mitre.org", "tags": ["Release Notes", "Third Party Advisory"]}]}, "github_commit_url": "https://github.com/MISP/MISP/commit/01120163a6b4d905029d416e7305575df31df8af"}}